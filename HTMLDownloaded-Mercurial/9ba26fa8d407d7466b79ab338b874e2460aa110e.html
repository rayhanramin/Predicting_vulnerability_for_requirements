<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28048:9ba26fa8d407d7466b79ab338b874e2460aa110e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9ba26fa8d407d7466b79ab338b874e2460aa110e" />
<meta property="og:url" content="/comm-central/rev/9ba26fa8d407d7466b79ab338b874e2460aa110e" />
<meta property="og:description" content="Backed out changeset faa7e3cc7838 (bug 1562313) for various issues missed in review. a=backout" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9ba26fa8d407d7466b79ab338b874e2460aa110e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9ba26fa8d407d7466b79ab338b874e2460aa110e">shortlog</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9ba26fa8d407d7466b79ab338b874e2460aa110e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e">files</a> |
changeset |
<a href="/comm-central/raw-rev/9ba26fa8d407d7466b79ab338b874e2460aa110e">raw</a>  | <a href="/comm-central/archive/9ba26fa8d407d7466b79ab338b874e2460aa110e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Backed out changeset faa7e3cc7838 (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">bug 1562313</a>) for various issues missed in review. a=backout
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 29 Oct 2019 11:07:44 -0400</td></tr>

<tr>
 <td>changeset 28048</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9ba26fa8d407d7466b79ab338b874e2460aa110e">9ba26fa8d407d7466b79ab338b874e2460aa110e</a></td>
</tr>



<tr>
<td>parent 28047</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b78bf453b765f4bcab77372f8b6a559f62b48c26">b78bf453b765f4bcab77372f8b6a559f62b48c26</a>
</td>
</tr>

<tr>
<td>child 28049</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5f93ed1690ab1ca2af7dd435d9db1d4310ba77ad">5f93ed1690ab1ca2af7dd435d9db1d4310ba77ad</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9ba26fa8d407d7466b79ab338b874e2460aa110e">16624</a></td></tr>
<tr><td>push user</td><td>clokep@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 29 Oct 2019 15:10:53 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9ba26fa8d407 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9ba26fa8d407d7466b79ab338b874e2460aa110e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9ba26fa8d407d7466b79ab338b874e2460aa110e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&newProject=comm-central&newRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&newProject=comm-central&newRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&newProject=comm-central&newRevision=9ba26fa8d407d7466b79ab338b874e2460aa110e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28backout%29&revcount=50">backout</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">1562313</a></td></tr>

<tr><td>backs out</td><td><a style="font-family: monospace" href="/comm-central/rev/faa7e3cc7838eea5d26bb4cb93ee0b940e6acbff">faa7e3cc7838eea5d26bb4cb93ee0b940e6acbff</a></td></tr>


</table></div>

<div class="page_body description">Backed out changeset faa7e3cc7838 (<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1562313">bug 1562313</a>) for various issues missed in review. a=backout</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMAccounts.jsm">chat/components/src/IMAccounts.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMAccounts.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMAccounts.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMAccounts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCommands.jsm">chat/components/src/IMCommands.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCommands.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCommands.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMContacts.jsm">chat/components/src/IMContacts.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMContacts.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMContacts.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMContacts.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMConversations.jsm">chat/components/src/IMConversations.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMConversations.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMConversations.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMConversations.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCore.jsm">chat/components/src/IMCore.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCore.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCore.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/IMCore.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/Logger.jsm">chat/components/src/Logger.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/Logger.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/Logger.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/Logger.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/SmileProtocolHandler.jsm">chat/components/src/SmileProtocolHandler.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/SmileProtocolHandler.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/SmileProtocolHandler.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/SmileProtocolHandler.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/components.conf">chat/components/src/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">chat/components/src/imAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">chat/components/src/imAccounts.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imAccounts.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">chat/components/src/imCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">chat/components/src/imCommands.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCommands.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">chat/components/src/imContacts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">chat/components/src/imContacts.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imContacts.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">chat/components/src/imConversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">chat/components/src/imConversations.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imConversations.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">chat/components/src/imCore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">chat/components/src/imCore.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/imCore.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">chat/components/src/logger.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/logger.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">chat/components/src/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">chat/components/src/smileProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">chat/components/src/smileProtocolHandler.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/smileProtocolHandler.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">chat/components/src/test/test_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">chat/components/src/test/test_conversations.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_conversations.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">chat/components/src/test/test_logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/components/src/test/test_logger.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/Facebook.jsm">chat/protocols/facebook/Facebook.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/Facebook.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/Facebook.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/Facebook.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/components.conf">chat/protocols/facebook/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">chat/protocols/facebook/facebook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">chat/protocols/facebook/facebook.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/facebook.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">chat/protocols/facebook/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/facebook/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/Gtalk.jsm">chat/protocols/gtalk/Gtalk.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/Gtalk.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/Gtalk.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/Gtalk.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/components.conf">chat/protocols/gtalk/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">chat/protocols/gtalk/gtalk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">chat/protocols/gtalk/gtalk.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/gtalk.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">chat/protocols/gtalk/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/gtalk/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/IRC.jsm">chat/protocols/irc/IRC.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/IRC.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/IRC.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/IRC.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/components.conf">chat/protocols/irc/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">chat/protocols/irc/irc.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/irc.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">chat/protocols/irc/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">chat/protocols/irc/test/test_ctcpQuote.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ctcpQuote.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">chat/protocols/irc/test/test_ircCAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCAP.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">chat/protocols/irc/test/test_ircCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">chat/protocols/irc/test/test_ircMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircMessage.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">chat/protocols/irc/test/test_ircNonStandard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircNonStandard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">chat/protocols/irc/test/test_ircServerTime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_ircServerTime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">chat/protocols/irc/test/test_sendBufferedCommand.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_sendBufferedCommand.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">chat/protocols/irc/test/test_setMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_setMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">chat/protocols/irc/test/test_splitLongMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_splitLongMessages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">chat/protocols/irc/test/test_tryNewNick.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/irc/test/test_tryNewNick.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/JSTestProtocol.jsm">chat/protocols/jsTest/JSTestProtocol.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/JSTestProtocol.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/JSTestProtocol.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/JSTestProtocol.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/components.conf">chat/protocols/jsTest/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">chat/protocols/jsTest/jsTestProtocol.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">chat/protocols/jsTest/jsTestProtocol.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/jsTestProtocol.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">chat/protocols/jsTest/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/jsTest/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/Matrix.jsm">chat/protocols/matrix/Matrix.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/Matrix.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/Matrix.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/Matrix.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/components.conf">chat/protocols/matrix/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">chat/protocols/matrix/matrix.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">chat/protocols/matrix/matrix.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/matrix.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">chat/protocols/matrix/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/matrix/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/Odnoklassniki.jsm">chat/protocols/odnoklassniki/Odnoklassniki.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/Odnoklassniki.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/Odnoklassniki.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/Odnoklassniki.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/components.conf">chat/protocols/odnoklassniki/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">chat/protocols/odnoklassniki/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">chat/protocols/odnoklassniki/odnoklassniki.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">chat/protocols/odnoklassniki/odnoklassniki.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/odnoklassniki/odnoklassniki.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/Skype.jsm">chat/protocols/skype/Skype.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/Skype.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/Skype.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/Skype.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/components.conf">chat/protocols/skype/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">chat/protocols/skype/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">chat/protocols/skype/skype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">chat/protocols/skype/skype.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/skype.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">chat/protocols/skype/test/test_MagicSha256.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_MagicSha256.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">chat/protocols/skype/test/test_contactUrlToName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/skype/test/test_contactUrlToName.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/Twitter.jsm">chat/protocols/twitter/Twitter.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/Twitter.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/Twitter.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/Twitter.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/components.conf">chat/protocols/twitter/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">chat/protocols/twitter/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">chat/protocols/twitter/twitter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">chat/protocols/twitter/twitter.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/twitter/twitter.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/XMPPProtocol.jsm">chat/protocols/xmpp/XMPPProtocol.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/XMPPProtocol.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/XMPPProtocol.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/XMPPProtocol.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/components.conf">chat/protocols/xmpp/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/components.conf">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">chat/protocols/xmpp/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">chat/protocols/xmpp/xmpp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">chat/protocols/xmpp/xmpp.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/xmpp/xmpp.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/Yahoo.jsm">chat/protocols/yahoo/Yahoo.jsm</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/Yahoo.jsm">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/Yahoo.jsm">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/Yahoo.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/components.conf">chat/protocols/yahoo/components.conf</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/components.conf">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/components.conf">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/components.conf">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">chat/protocols/yahoo/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">chat/protocols/yahoo/yahoo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">chat/protocols/yahoo/yahoo.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/chat/protocols/yahoo/yahoo.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/9ba26fa8d407d7466b79ab338b874e2460aa110e/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">deleted file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- a/chat/components/src/IMAccounts.jsm</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ /dev/null</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -1,1300 +0,0 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineminus">-</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;AccountsService&quot;];</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineminus">-</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineminus">-var {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  ClassInfo,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-  setTimeout,</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-  clearTimeout,</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-  executeSoon,</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-  l10nHelper,</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-var {</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-  GenericAccountBuddyPrototype,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineminus">-var kPrefAutologinPending = &quot;messenger.accounts.autoLoginPending&quot;;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineminus">-var kPrefMessengerAccounts = &quot;messenger.accounts&quot;;</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineminus">-var kPrefAccountPrefix = &quot;messenger.account.&quot;;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-var kAccountKeyPrefix = &quot;account&quot;;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-var kAccountOptionPrefPrefix = &quot;options.&quot;;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineminus">-var kPrefAccountName = &quot;name&quot;;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineminus">-var kPrefAccountPrpl = &quot;prpl&quot;;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineminus">-var kPrefAccountAutoLogin = &quot;autoLogin&quot;;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineminus">-var kPrefAccountAutoJoin = &quot;autoJoin&quot;;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-var kPrefAccountAlias = &quot;alias&quot;;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineminus">-var kPrefAccountFirstConnectionState = &quot;firstConnectionState&quot;;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-var kPrefConvertOldPasswords = &quot;messenger.accounts.convertOldPasswords&quot;;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-var kPrefAccountPassword = &quot;password&quot;;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/accounts.properties&quot;)</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-);</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_maxDebugMessages&quot;, () =&gt;</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-  Services.prefs.getIntPref(&quot;messenger.accounts.maxDebugMessages&quot;)</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-  this,</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-  &quot;HttpProtocolHandler&quot;,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-  &quot;@mozilla.org/network/protocol;1?name=http&quot;,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-  &quot;nsIHttpProtocolHandler&quot;</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineminus">-);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineminus">-</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-var gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineminus">-var gConvertingOldPasswords = false;</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineminus">-</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineminus">-var SavePrefTimer = {</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineminus">-  saveNow() {</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-    if (this._timer) {</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-      clearTimeout(this._timer);</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-      this._timer = null;</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineminus">-    }</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineminus">-    Services.prefs.savePrefFile(null);</span>
<a href="#l1.67"></a><span id="l1.67" class="difflineminus">-  },</span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  _timer: null,</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineminus">-  unInitTimer() {</span>
<a href="#l1.70"></a><span id="l1.70" class="difflineminus">-    if (this._timer) {</span>
<a href="#l1.71"></a><span id="l1.71" class="difflineminus">-      this.saveNow();</span>
<a href="#l1.72"></a><span id="l1.72" class="difflineminus">-    }</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-  },</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-  initTimer() {</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-    if (!this._timer) {</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-      this._timer = setTimeout(this.saveNow.bind(this), 5000);</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    }</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  },</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-};</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-var AutoLoginCounter = {</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-  _count: 0,</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineminus">-  startAutoLogin() {</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineminus">-    ++this._count;</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineminus">-    if (this._count != 1) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      return;</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-    }</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-    Services.prefs.setIntPref(kPrefAutologinPending, Date.now() / 1000);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-    SavePrefTimer.saveNow();</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-  },</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-  finishedAutoLogin() {</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineminus">-    --this._count;</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineminus">-    if (this._count != 0) {</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineminus">-      return;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineminus">-    }</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineminus">-    Services.prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-    SavePrefTimer.initTimer();</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-  },</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-};</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-function UnknownProtocol(aPrplId) {</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-  this.id = aPrplId;</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-}</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-UnknownProtocol.prototype = {</span>
<a href="#l1.105"></a><span id="l1.105" class="difflineminus">-  __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Unknown protocol&quot;),</span>
<a href="#l1.106"></a><span id="l1.106" class="difflineminus">-  get name() {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineminus">-  },</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  get normalizedName() {</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-    return this.name;</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  },</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    return &quot;chrome://chat/skin/prpl-unknown/&quot;;</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-  },</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-  getOptions() {</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    return EmptyEnumerator;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-  },</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-  getUsernameSplit() {</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    return EmptyEnumerator;</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-  },</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-  get usernameEmptyText() {</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-  },</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineminus">-</span>
<a href="#l1.125"></a><span id="l1.125" class="difflineminus">-  getAccount(aKey, aName) {</span>
<a href="#l1.126"></a><span id="l1.126" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.127"></a><span id="l1.127" class="difflineminus">-  },</span>
<a href="#l1.128"></a><span id="l1.128" class="difflineminus">-  accountExists() {</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.130"></a><span id="l1.130" class="difflineminus">-  },</span>
<a href="#l1.131"></a><span id="l1.131" class="difflineminus">-</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-  // false seems an acceptable default for all options</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineminus">-  // (they should never be called anyway).</span>
<a href="#l1.134"></a><span id="l1.134" class="difflineminus">-  get uniqueChatName() {</span>
<a href="#l1.135"></a><span id="l1.135" class="difflineminus">-    return false;</span>
<a href="#l1.136"></a><span id="l1.136" class="difflineminus">-  },</span>
<a href="#l1.137"></a><span id="l1.137" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    return false;</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-  },</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  get noPassword() {</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-    return false;</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-  },</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineminus">-  get newMailNotification() {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-    return false;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-  },</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  get imagesInIM() {</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-    return false;</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineminus">-  },</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineminus">-  get passwordOptional() {</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineminus">-    return true;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineminus">-  },</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineminus">-  get usePointSize() {</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineminus">-    return true;</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineminus">-  },</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineminus">-  get registerNoScreenName() {</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineminus">-    return false;</span>
<a href="#l1.157"></a><span id="l1.157" class="difflineminus">-  },</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineminus">-  get slashCommandsNative() {</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    return false;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineminus">-  },</span>
<a href="#l1.161"></a><span id="l1.161" class="difflineminus">-  get usePurpleProxy() {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-    return false;</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-  },</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-};</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-// An unknown prplIAccount.</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-function UnknownAccount(aAccount) {</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineminus">-  this._init(aAccount.protocol, aAccount);</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-}</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-UnknownAccount.prototype = GenericAccountPrototype;</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineminus">-</span>
<a href="#l1.172"></a><span id="l1.172" class="difflineminus">-function UnknownAccountBuddy(aAccount, aBuddy, aTag) {</span>
<a href="#l1.173"></a><span id="l1.173" class="difflineminus">-  this._init(new UnknownAccount(aAccount), aBuddy, aTag);</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-}</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-UnknownAccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l1.176"></a><span id="l1.176" class="difflineminus">-</span>
<a href="#l1.177"></a><span id="l1.177" class="difflineminus">-// aName and aPrplId are provided as parameter only if this is a new</span>
<a href="#l1.178"></a><span id="l1.178" class="difflineminus">-// account that doesn't exist in the preferences. In this case, these</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-// 2 values should be stored.</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-function imAccount(aKey, aName, aPrplId) {</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-  if (!aKey.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-    throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-  }</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-</span>
<a href="#l1.185"></a><span id="l1.185" class="difflineminus">-  this.id = aKey;</span>
<a href="#l1.186"></a><span id="l1.186" class="difflineminus">-  this.numericId = parseInt(aKey.substr(kAccountKeyPrefix.length));</span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-  gAccountsService._keepAccount(this);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  this.prefBranch = Services.prefs.getBranch(kPrefAccountPrefix + aKey + &quot;.&quot;);</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineminus">-</span>
<a href="#l1.190"></a><span id="l1.190" class="difflineminus">-  if (aName) {</span>
<a href="#l1.191"></a><span id="l1.191" class="difflineminus">-    this.name = aName;</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-    this.prefBranch.setStringPref(kPrefAccountName, aName);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineminus">-</span>
<a href="#l1.194"></a><span id="l1.194" class="difflineminus">-    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l1.195"></a><span id="l1.195" class="difflineminus">-  } else {</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-    this.name = this.prefBranch.getStringPref(kPrefAccountName);</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-  }</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-  let prplId = aPrplId;</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-  if (prplId) {</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-    this.prefBranch.setCharPref(kPrefAccountPrpl, prplId);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-  } else {</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    prplId = this.prefBranch.getCharPref(kPrefAccountPrpl);</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-  }</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineminus">-</span>
<a href="#l1.206"></a><span id="l1.206" class="difflineminus">-  // Get the protocol plugin, or fallback to an UnknownProtocol instance.</span>
<a href="#l1.207"></a><span id="l1.207" class="difflineminus">-  this.protocol = Services.core.getProtocolById(prplId);</span>
<a href="#l1.208"></a><span id="l1.208" class="difflineminus">-  if (!this.protocol) {</span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-    this.protocol = new UnknownProtocol(prplId);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-    this._connectionErrorReason = Ci.imIAccount.ERROR_UNKNOWN_PRPL;</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-    return;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-  }</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineminus">-</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-  // Ensure the account is correctly stored in blist.sqlite.</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-  Services.contacts.storeAccount(this.numericId, this.name, prplId);</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-  // Get the prplIAccount from the protocol plugin.</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-  this.prplAccount = this.protocol.getAccount(this);</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-  // Send status change notifications to the account.</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-  this.observedStatusInfo = null; // (To execute the setter).</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-  // If we have never finished the first connection attempt for this account,</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  // mark the account as having caused a crash.</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-  if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_CRASHED;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-  }</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-  Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-    // Try to convert old passwords stored in the preferences.</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-    // Don't try too hard if the user has canceled a master password prompt:</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-    // we don't want to display several of theses prompts at startup.</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-    if (gConvertingOldPasswords &amp;&amp; !this.protocol.noPassword) {</span>
<a href="#l1.234"></a><span id="l1.234" class="difflineminus">-      try {</span>
<a href="#l1.235"></a><span id="l1.235" class="difflineminus">-        let password = this.prefBranch.getStringPref(kPrefAccountPassword);</span>
<a href="#l1.236"></a><span id="l1.236" class="difflineminus">-        if (password &amp;&amp; !this.password) {</span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-          this.password = password;</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-        }</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-      } catch (e) {</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-        /* No password saved in the prefs for this account. */</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineminus">-      }</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineminus">-    }</span>
<a href="#l1.243"></a><span id="l1.243" class="difflineminus">-</span>
<a href="#l1.244"></a><span id="l1.244" class="difflineminus">-    // Check for errors that should prevent connection attempts.</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-    if (this._passwordRequired &amp;&amp; !this.password) {</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-      this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-    } else if (</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-      this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-    ) {</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineminus">-      this._connectionErrorReason = Ci.imIAccount.ERROR_CRASHED;</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-    }</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-  });</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-}</span>
<a href="#l1.254"></a><span id="l1.254" class="difflineminus">-</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-imAccount.prototype = {</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-  __proto__: ClassInfo([&quot;imIAccount&quot;, &quot;prplIAccount&quot;], &quot;im account object&quot;),</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineminus">-</span>
<a href="#l1.258"></a><span id="l1.258" class="difflineminus">-  name: &quot;&quot;,</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineminus">-  id: &quot;&quot;,</span>
<a href="#l1.260"></a><span id="l1.260" class="difflineminus">-  numericId: 0,</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  protocol: null,</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-  prplAccount: null,</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineminus">-  connectionState: Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l1.264"></a><span id="l1.264" class="difflineminus">-  connectionStateMsg: &quot;&quot;,</span>
<a href="#l1.265"></a><span id="l1.265" class="difflineminus">-  connectionErrorMessage: &quot;&quot;,</span>
<a href="#l1.266"></a><span id="l1.266" class="difflineminus">-  _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l1.267"></a><span id="l1.267" class="difflineminus">-  get connectionErrorReason() {</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineminus">-    if (</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineminus">-      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineminus">-      (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-        !this._password)</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-    ) {</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-      return this._connectionErrorReason;</span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-    }</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-    return this.prplAccount.connectionErrorReason;</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-  },</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-    if (aTopic == &quot;account-connect-progress&quot;) {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-      this.connectionStateMsg = aData;</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-    } else if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-      if (this.prplAccount.connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-        delete this.connectionErrorMessage;</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-        if (this.timeOfNextReconnect - Date.now() &gt; 1000) {</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-          // This is a manual reconnection, reset the auto-reconnect stuff</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-          this.timeOfLastConnect = 0;</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-          this._cancelReconnection();</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-        }</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      }</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_PENDING;</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-      }</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-      this.connectionState = Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-    } else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-      this.connectionState = Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-      this._finishedAutoLogin();</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-      this.timeOfLastConnect = Date.now();</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-      }</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-      delete this.connectionStateMsg;</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-      if (</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-        this.canJoinChat &amp;&amp;</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-        this.prefBranch.prefHasUserValue(kPrefAccountAutoJoin)</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-      ) {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-        let autojoin = this.prefBranch.getStringPref(kPrefAccountAutoJoin);</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-        if (autojoin) {</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-          for (let room of autojoin.trim().split(/,\s*/)) {</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-            if (room) {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-              this.joinChat(this.getChatRoomDefaultFieldValues(room));</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-            }</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-          }</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-        }</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-      }</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-      this.connectionState = Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-      this.connectionErrorMessage = aData;</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-      delete this.connectionStateMsg;</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-      this._finishedAutoLogin();</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-      let firstConnectionState = this.firstConnectionState;</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-      if (</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK &amp;&amp;</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-      ) {</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-      }</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-      let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-      if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-        if (</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-          connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-          connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-        ) {</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-          this._startReconnectTimer();</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-        }</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-        this._sendNotification(&quot;account-connect-error&quot;);</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-      }</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-    } else if (aTopic == &quot;account-disconnected&quot;) {</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-      this.connectionState = Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-      let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-      if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-        // If the account was disconnected with an error, save the debug messages.</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-        this._omittedDebugMessagesBeforeError += this._omittedDebugMessages;</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-        if (this._debugMessagesBeforeError) {</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-          this._omittedDebugMessagesBeforeError += this._debugMessagesBeforeError.length;</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-        }</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-        this._debugMessagesBeforeError = this._debugMessages;</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-      } else {</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-        // After a clean disconnection, drop the debug messages that</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-        // could have been left by a previous error.</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-        delete this._omittedDebugMessagesBeforeError;</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-        delete this._debugMessagesBeforeError;</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-      }</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-      delete this._omittedDebugMessages;</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-      delete this._debugMessages;</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-      if (</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-        this._statusObserver &amp;&amp;</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-        connectionErrorReason == Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-        this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-      ) {</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-        // If the status changed back to online while an account was still</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-        // disconnecting, it was not reconnected automatically at that point,</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-        // so we must do it now. (This happens for protocols like IRC where</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-        // disconnection is not immediate.)</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-        this._sendNotification(aTopic, aData);</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-        this.connect();</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-        return;</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-      }</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-    } else {</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-    }</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-    this._sendNotification(aTopic, aData);</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-  },</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-  _debugMessages: null,</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-  _omittedDebugMessages: 0,</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-  _debugMessagesBeforeError: null,</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-  _omittedDebugMessagesBeforeError: 0,</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-  logDebugMessage(aMessage, aLevel) {</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-    if (!this._debugMessages) {</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-      this._debugMessages = [];</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-    }</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-    if (_maxDebugMessages &amp;&amp; this._debugMessages.length &gt;= _maxDebugMessages) {</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-      this._debugMessages.shift();</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-      ++this._omittedDebugMessages;</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-    }</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-    this._debugMessages.push({ logLevel: aLevel, message: aMessage });</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-  },</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-  _createDebugMessage(aMessage) {</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-    let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-      Ci.nsIScriptError</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-    );</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-    scriptError.init(</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-      aMessage,</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-      0,</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-      null,</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-      Ci.nsIScriptError.warningFlag,</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-      &quot;component javascript&quot;</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-    );</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-    return { logLevel: 0, message: scriptError };</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineminus">-  },</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-  getDebugMessages() {</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineminus">-    let messages = [];</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-    if (this._omittedDebugMessagesBeforeError) {</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-      let text = this._omittedDebugMessagesBeforeError + &quot; messages omitted&quot;;</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineminus">-      messages.push(this._createDebugMessage(text));</span>
<a href="#l1.411"></a><span id="l1.411" class="difflineminus">-    }</span>
<a href="#l1.412"></a><span id="l1.412" class="difflineminus">-    if (this._debugMessagesBeforeError) {</span>
<a href="#l1.413"></a><span id="l1.413" class="difflineminus">-      messages = messages.concat(this._debugMessagesBeforeError);</span>
<a href="#l1.414"></a><span id="l1.414" class="difflineminus">-    }</span>
<a href="#l1.415"></a><span id="l1.415" class="difflineminus">-    if (this._omittedDebugMessages) {</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineminus">-      let text = this._omittedDebugMessages + &quot; messages omitted&quot;;</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-      messages.push(this._createDebugMessage(text));</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineminus">-    }</span>
<a href="#l1.419"></a><span id="l1.419" class="difflineminus">-    if (this._debugMessages) {</span>
<a href="#l1.420"></a><span id="l1.420" class="difflineminus">-      messages = messages.concat(this._debugMessages);</span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-    }</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-    if (messages.length) {</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-      let appInfo = Services.appinfo;</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-      let header =</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-        `${appInfo.name} ${appInfo.version} (${appInfo.appBuildID}), ` +</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineminus">-        `Gecko ${appInfo.platformVersion} (${appInfo.platformBuildID}) ` +</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineminus">-        `on ${HttpProtocolHandler.oscpu}`;</span>
<a href="#l1.428"></a><span id="l1.428" class="difflineminus">-      messages.unshift(this._createDebugMessage(header));</span>
<a href="#l1.429"></a><span id="l1.429" class="difflineminus">-    }</span>
<a href="#l1.430"></a><span id="l1.430" class="difflineminus">-</span>
<a href="#l1.431"></a><span id="l1.431" class="difflineminus">-    return messages;</span>
<a href="#l1.432"></a><span id="l1.432" class="difflineminus">-  },</span>
<a href="#l1.433"></a><span id="l1.433" class="difflineminus">-</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineminus">-  _observedStatusInfo: null,</span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-  get observedStatusInfo() {</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-    return this._observedStatusInfo;</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineminus">-  },</span>
<a href="#l1.438"></a><span id="l1.438" class="difflineminus">-  _statusObserver: null,</span>
<a href="#l1.439"></a><span id="l1.439" class="difflineminus">-  set observedStatusInfo(aUserStatusInfo) {</span>
<a href="#l1.440"></a><span id="l1.440" class="difflineminus">-    if (!this.prplAccount) {</span>
<a href="#l1.441"></a><span id="l1.441" class="difflineminus">-      return;</span>
<a href="#l1.442"></a><span id="l1.442" class="difflineminus">-    }</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-    if (this._statusObserver) {</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-      this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineminus">-    }</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineminus">-    this._observedStatusInfo = aUserStatusInfo;</span>
<a href="#l1.447"></a><span id="l1.447" class="difflineminus">-    if (this._statusObserver) {</span>
<a href="#l1.448"></a><span id="l1.448" class="difflineminus">-      this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l1.449"></a><span id="l1.449" class="difflineminus">-    }</span>
<a href="#l1.450"></a><span id="l1.450" class="difflineminus">-  },</span>
<a href="#l1.451"></a><span id="l1.451" class="difflineminus">-  _removeStatusObserver() {</span>
<a href="#l1.452"></a><span id="l1.452" class="difflineminus">-    if (this._statusObserver) {</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineminus">-      this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l1.454"></a><span id="l1.454" class="difflineminus">-      delete this._statusObserver;</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-    }</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-  },</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineminus">-  get statusInfo() {</span>
<a href="#l1.458"></a><span id="l1.458" class="difflineminus">-    return this._observedStatusInfo || Services.core.globalUserStatus;</span>
<a href="#l1.459"></a><span id="l1.459" class="difflineminus">-  },</span>
<a href="#l1.460"></a><span id="l1.460" class="difflineminus">-</span>
<a href="#l1.461"></a><span id="l1.461" class="difflineminus">-  reconnectAttempt: 0,</span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-  timeOfLastConnect: 0,</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-  timeOfNextReconnect: 0,</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-  _reconnectTimer: null,</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-  _startReconnectTimer() {</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-    if (Services.io.offline) {</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-      Cu.reportError(&quot;_startReconnectTimer called while offline&quot;);</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-      return;</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-    }</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineminus">-</span>
<a href="#l1.471"></a><span id="l1.471" class="difflineminus">-    /* If the last successful connection is older than 10 seconds, reset the</span>
<a href="#l1.472"></a><span id="l1.472" class="difflineminus">-       number of reconnection attempts. */</span>
<a href="#l1.473"></a><span id="l1.473" class="difflineminus">-    const kTimeBeforeSuccessfulConnection = 10;</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineminus">-    if (</span>
<a href="#l1.475"></a><span id="l1.475" class="difflineminus">-      this.timeOfLastConnect &amp;&amp;</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-      this.timeOfLastConnect + kTimeBeforeSuccessfulConnection * 1000 &lt;</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineminus">-        Date.now()</span>
<a href="#l1.478"></a><span id="l1.478" class="difflineminus">-    ) {</span>
<a href="#l1.479"></a><span id="l1.479" class="difflineminus">-      delete this.reconnectAttempt;</span>
<a href="#l1.480"></a><span id="l1.480" class="difflineminus">-      delete this.timeOfLastConnect;</span>
<a href="#l1.481"></a><span id="l1.481" class="difflineminus">-    }</span>
<a href="#l1.482"></a><span id="l1.482" class="difflineminus">-</span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-    let timers = Services.prefs</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-      .getCharPref(&quot;messenger.accounts.reconnectTimer&quot;)</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-      .split(&quot;,&quot;);</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-    let delay = timers[Math.min(this.reconnectAttempt, timers.length - 1)];</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-    let msDelay = parseInt(delay) * 1000;</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-    ++this.reconnectAttempt;</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-    this.timeOfNextReconnect = Date.now() + msDelay;</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-    this._reconnectTimer = setTimeout(this.connect.bind(this), msDelay);</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-  },</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-  _sendNotification(aTopic, aData) {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-    Services.obs.notifyObservers(this, aTopic, aData);</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-  },</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-  get firstConnectionState() {</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-    try {</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-      return this.prefBranch.getIntPref(kPrefAccountFirstConnectionState);</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-      return Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-    }</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-  },</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-  set firstConnectionState(aState) {</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-    if (aState == Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-      this.prefBranch.deleteBranch(kPrefAccountFirstConnectionState);</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-    } else {</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-      this.prefBranch.setIntPref(kPrefAccountFirstConnectionState, aState);</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-      // We want to save this pref immediately when trying to connect.</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-      if (aState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-        SavePrefTimer.saveNow();</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-      } else {</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-        SavePrefTimer.initTimer();</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-      }</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-    }</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-  },</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-  _pendingReconnectForConnectionInfoChange: false,</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-  _connectionInfoChanged() {</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-    // The next connection will be the first connection with these parameters.</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-    // We want to attempt to reconnect with the new settings only if a</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-    // previous attempt failed or a connection attempt is currently</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-    // pending (so we can return early if the account is currently</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineminus">-    // connected or disconnected without error).</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-    // The code doing the reconnection attempt is wrapped within an</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-    // executeSoon call so that when multiple settings are changed at</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-    // once we don't attempt to reconnect until they are all saved.</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-    // If a reconnect attempt is already scheduled, we can also return early.</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-    if (</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-      this._pendingReconnectForConnectionInfoChange ||</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-      this.connected ||</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-      (this.disconnected &amp;&amp;</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-        this.connectionErrorReason == Ci.prplIAccount.NO_ERROR)</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-    ) {</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-      return;</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-    }</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-    this._pendingReconnectForConnectionInfoChange = true;</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-    executeSoon(</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-      function() {</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-        delete this._pendingReconnectForConnectionInfoChange;</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-        // If the connection parameters have changed while we were</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-        // trying to connect, cancel the ongoing connection attempt and</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-        // try again with the new parameters.</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-        if (this.connecting) {</span>
<a href="#l1.548"></a><span id="l1.548" class="difflineminus">-          this.disconnect();</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-          this.connect();</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-          return;</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineminus">-        }</span>
<a href="#l1.552"></a><span id="l1.552" class="difflineminus">-        // If the account was disconnected because of a non-fatal</span>
<a href="#l1.553"></a><span id="l1.553" class="difflineminus">-        // connection error, retry now that we have new parameters.</span>
<a href="#l1.554"></a><span id="l1.554" class="difflineminus">-        let errorReason = this.connectionErrorReason;</span>
<a href="#l1.555"></a><span id="l1.555" class="difflineminus">-        if (</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-          this.disconnected &amp;&amp;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-          errorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineminus">-          errorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD &amp;&amp;</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineminus">-          errorReason != Ci.imIAccount.ERROR_CRASHED &amp;&amp;</span>
<a href="#l1.560"></a><span id="l1.560" class="difflineminus">-          errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL</span>
<a href="#l1.561"></a><span id="l1.561" class="difflineminus">-        ) {</span>
<a href="#l1.562"></a><span id="l1.562" class="difflineminus">-          this.connect();</span>
<a href="#l1.563"></a><span id="l1.563" class="difflineminus">-        }</span>
<a href="#l1.564"></a><span id="l1.564" class="difflineminus">-      }.bind(this)</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-    );</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-  },</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-  // If the protocol plugin is missing, we can't access the normalizedName,</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-  // but in lots of cases this.name is equivalent.</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-  get normalizedName() {</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-    return this.prplAccount ? this.prplAccount.normalizedName : this.name;</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-  },</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-  normalize(aName) {</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-    return this.prplAccount ? this.prplAccount.normalize(aName) : aName;</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-  },</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-  _sendUpdateNotification() {</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-    this._sendNotification(&quot;account-updated&quot;);</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-  },</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-  set alias(val) {</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-    if (val) {</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-      this.prefBranch.setStringPref(kPrefAccountAlias, val);</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-    } else {</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-      this.prefBranch.deleteBranch(kPrefAccountAlias);</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-    }</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-    this._sendUpdateNotification();</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-  },</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-  get alias() {</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-    try {</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-      return this.prefBranch.getStringPref(kPrefAccountAlias);</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-    }</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-  },</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-  _password: &quot;&quot;,</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-  get password() {</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-    if (this._password) {</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-      return this._password;</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-    }</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-    // Avoid prompting the user for the master password more than once at startup.</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-    }</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-    let logins;</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-    try {</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-      logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-      this._handleMasterPasswordException(e);</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-    }</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-    let normalizedName = this.normalizedName;</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-    for (let login of logins) {</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-      if (login.username == normalizedName) {</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-        this._password = login.password;</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-        if (</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-          this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-        ) {</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-          // We have found a password for an account marked as missing password,</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-          // re-check all others accounts missing a password. But first,</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-          // remove the error on our own account to avoid re-checking it.</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-          delete this._connectionErrorReason;</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-          gAccountsService._checkIfPasswordStillMissing();</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-        }</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-        return this._password;</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-      }</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-    }</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-  },</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-  _checkIfPasswordStillMissing() {</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-    if (</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-      this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-      !this.password</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-    ) {</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-      return;</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-    }</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-    delete this._connectionErrorReason;</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-    this._sendUpdateNotification();</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-  },</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-  get _passwordRequired() {</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-    return !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional;</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-  },</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-  set password(aPassword) {</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-    this._password = aPassword;</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-      return;</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-    }</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-    let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-      Ci.nsILoginInfo</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-    );</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-    newLogin.init(</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-      passwordURI,</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-      null,</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-      passwordURI,</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-      this.normalizedName,</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-      aPassword,</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-      &quot;&quot;,</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-      &quot;&quot;</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-    );</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-    try {</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-      let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-      let saved = false;</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-      for (let login of logins) {</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-        if (newLogin.matches(login, true)) {</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-          if (aPassword) {</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-            Services.logins.modifyLogin(login, newLogin);</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-          } else {</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-            Services.logins.removeLogin(login);</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-          }</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-          saved = true;</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-          break;</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-        }</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-      }</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-      if (!saved &amp;&amp; aPassword) {</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-        Services.logins.addLogin(newLogin);</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-      }</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-      this._handleMasterPasswordException(e);</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-    }</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-    this._connectionInfoChanged();</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-    if (</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-      aPassword &amp;&amp;</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-      this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-    ) {</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-      this._connectionErrorReason = Ci.imIAccount.NO_ERROR;</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-    } else if (!aPassword &amp;&amp; this._passwordRequired) {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-      this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-    }</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-    this._sendUpdateNotification();</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-  },</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-  _handleMasterPasswordException(aException) {</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-    if (aException.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-      throw aException;</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-    }</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-    gUserCanceledMasterPasswordPrompt = true;</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-    executeSoon(function() {</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-      gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-    });</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-  },</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-</span>
<a href="#l1.709"></a><span id="l1.709" class="difflineminus">-  get autoLogin() {</span>
<a href="#l1.710"></a><span id="l1.710" class="difflineminus">-    return this.prefBranch.getBoolPref(kPrefAccountAutoLogin, true);</span>
<a href="#l1.711"></a><span id="l1.711" class="difflineminus">-  },</span>
<a href="#l1.712"></a><span id="l1.712" class="difflineminus">-  set autoLogin(val) {</span>
<a href="#l1.713"></a><span id="l1.713" class="difflineminus">-    this.prefBranch.setBoolPref(kPrefAccountAutoLogin, val);</span>
<a href="#l1.714"></a><span id="l1.714" class="difflineminus">-    SavePrefTimer.initTimer();</span>
<a href="#l1.715"></a><span id="l1.715" class="difflineminus">-    this._sendUpdateNotification();</span>
<a href="#l1.716"></a><span id="l1.716" class="difflineminus">-  },</span>
<a href="#l1.717"></a><span id="l1.717" class="difflineminus">-  _autoLoginPending: false,</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-  checkAutoLogin() {</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-    // No auto-login if: the account has an error at the imIAccount level</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-    // (unknown protocol, missing password, first connection crashed),</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineminus">-    // the account is already connected or connecting, or autoLogin is off.</span>
<a href="#l1.722"></a><span id="l1.722" class="difflineminus">-    if (</span>
<a href="#l1.723"></a><span id="l1.723" class="difflineminus">-      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l1.724"></a><span id="l1.724" class="difflineminus">-      this.connecting ||</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-      this.connected ||</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-      !this.autoLogin</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-    ) {</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineminus">-      return;</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineminus">-    }</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineminus">-</span>
<a href="#l1.731"></a><span id="l1.731" class="difflineminus">-    this._autoLoginPending = true;</span>
<a href="#l1.732"></a><span id="l1.732" class="difflineminus">-    AutoLoginCounter.startAutoLogin();</span>
<a href="#l1.733"></a><span id="l1.733" class="difflineminus">-    try {</span>
<a href="#l1.734"></a><span id="l1.734" class="difflineminus">-      this.connect();</span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineminus">-      Cu.reportError(e);</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-      this._finishedAutoLogin();</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-    }</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-  },</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineminus">-  _finishedAutoLogin() {</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_autoLoginPending&quot;)) {</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineminus">-      return;</span>
<a href="#l1.743"></a><span id="l1.743" class="difflineminus">-    }</span>
<a href="#l1.744"></a><span id="l1.744" class="difflineminus">-    delete this._autoLoginPending;</span>
<a href="#l1.745"></a><span id="l1.745" class="difflineminus">-    AutoLoginCounter.finishedAutoLogin();</span>
<a href="#l1.746"></a><span id="l1.746" class="difflineminus">-  },</span>
<a href="#l1.747"></a><span id="l1.747" class="difflineminus">-</span>
<a href="#l1.748"></a><span id="l1.748" class="difflineminus">-  // Delete the account (from the preferences, mozStorage, and call unInit).</span>
<a href="#l1.749"></a><span id="l1.749" class="difflineminus">-  remove() {</span>
<a href="#l1.750"></a><span id="l1.750" class="difflineminus">-    let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l1.751"></a><span id="l1.751" class="difflineminus">-      Ci.nsILoginInfo</span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-    );</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-    // Note: the normalizedName may not be exactly right if the</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-    // protocol plugin is missing.</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineminus">-    login.init(passwordURI, null, passwordURI, this.normalizedName, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l1.757"></a><span id="l1.757" class="difflineminus">-    let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l1.758"></a><span id="l1.758" class="difflineminus">-    for (let l of logins) {</span>
<a href="#l1.759"></a><span id="l1.759" class="difflineminus">-      if (login.matches(l, true)) {</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineminus">-        Services.logins.removeLogin(l);</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineminus">-        break;</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-      }</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-    }</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-    if (this.connected || this.connecting) {</span>
<a href="#l1.765"></a><span id="l1.765" class="difflineminus">-      this.disconnect();</span>
<a href="#l1.766"></a><span id="l1.766" class="difflineminus">-    }</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-      this.prplAccount.remove();</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-    }</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineminus">-    this.unInit();</span>
<a href="#l1.771"></a><span id="l1.771" class="difflineminus">-    Services.contacts.forgetAccount(this.numericId);</span>
<a href="#l1.772"></a><span id="l1.772" class="difflineminus">-    this.prefBranch.deleteBranch(&quot;&quot;);</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-  },</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-  unInit() {</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-    // remove any pending reconnection timer.</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-    this._cancelReconnection();</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-    // Keeping a status observer could cause an immediate reconnection.</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-    this._removeStatusObserver();</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-    // remove any pending autologin preference used for crash detection.</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-    this._finishedAutoLogin();</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-    // If the first connection was pending on quit, we set it back to unknown.</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-    if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-      this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-    }</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-    // and make sure we cleanup the save pref timer.</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-    SavePrefTimer.unInitTimer();</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-      this.prplAccount.unInit();</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-    }</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-    delete this.protocol;</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-    delete this.prplAccount;</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-  },</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-  get _ensurePrplAccount() {</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-      return this.prplAccount;</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-    }</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-  },</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-  connect() {</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-    if (!this.prplAccount) {</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-      throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-    }</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-    if (this._passwordRequired) {</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-      // If the previous connection attempt failed because we have a wrong password,</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-      // clear the passwor cache so that if there's no password in the password</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-      // manager the user gets prompted again.</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-      if (</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-        this.connectionErrorReason ==</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-        Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-      ) {</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-        delete this._password;</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-      }</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-      let password = this.password;</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-      if (!password) {</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-        let prompts = Services.prompt;</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-        let shouldSave = { value: false };</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-        password = { value: &quot;&quot; };</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-        if (</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-          !prompts.promptPassword(</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-            null,</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-            _(&quot;passwordPromptTitle&quot;, this.name),</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-            _(&quot;passwordPromptText&quot;, this.name),</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-            password,</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-            _(&quot;passwordPromptSaveCheckbox&quot;),</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-            shouldSave</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-          )</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-        ) {</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-          return;</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-        }</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">-</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-        if (shouldSave.value) {</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-          this.password = password.value;</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-        } else {</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineminus">-          this._password = password.value;</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineminus">-        }</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-      }</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-    }</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-    if (!this._statusObserver) {</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-      this._statusObserver = {</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineminus">-        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineminus">-          // Disconnect or reconnect the account automatically, otherwise notify</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineminus">-          // the prplAccount instance.</span>
<a href="#l1.853"></a><span id="l1.853" class="difflineminus">-          let statusType = aSubject.statusType;</span>
<a href="#l1.854"></a><span id="l1.854" class="difflineminus">-          let connectionErrorReason = this.connectionErrorReason;</span>
<a href="#l1.855"></a><span id="l1.855" class="difflineminus">-          if (statusType == Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l1.856"></a><span id="l1.856" class="difflineminus">-            if (this.connected || this.connecting) {</span>
<a href="#l1.857"></a><span id="l1.857" class="difflineminus">-              this.prplAccount.disconnect();</span>
<a href="#l1.858"></a><span id="l1.858" class="difflineminus">-            }</span>
<a href="#l1.859"></a><span id="l1.859" class="difflineminus">-            this._cancelReconnection();</span>
<a href="#l1.860"></a><span id="l1.860" class="difflineminus">-          } else if (</span>
<a href="#l1.861"></a><span id="l1.861" class="difflineminus">-            statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l1.862"></a><span id="l1.862" class="difflineminus">-            this.disconnected &amp;&amp;</span>
<a href="#l1.863"></a><span id="l1.863" class="difflineminus">-            (connectionErrorReason == Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-              connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-              connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR)</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-          ) {</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-            this.prplAccount.connect();</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-          } else if (this.connected) {</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-            this.prplAccount.observe(aSubject, aTopic, aData);</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-          }</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-        }.bind(this),</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-      };</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-      this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-    }</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-    if (</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-      !Services.io.offline &amp;&amp;</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-      this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-      this.disconnected</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-    ) {</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-      this.prplAccount.connect();</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-    }</span>
<a href="#l1.884"></a><span id="l1.884" class="difflineminus">-  },</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-  disconnect() {</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-    this._removeStatusObserver();</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineminus">-    if (!this.disconnected) {</span>
<a href="#l1.888"></a><span id="l1.888" class="difflineminus">-      this._ensurePrplAccount.disconnect();</span>
<a href="#l1.889"></a><span id="l1.889" class="difflineminus">-    }</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-  },</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineminus">-  get disconnected() {</span>
<a href="#l1.893"></a><span id="l1.893" class="difflineminus">-    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l1.894"></a><span id="l1.894" class="difflineminus">-  },</span>
<a href="#l1.895"></a><span id="l1.895" class="difflineminus">-  get connected() {</span>
<a href="#l1.896"></a><span id="l1.896" class="difflineminus">-    return this.connectionState == Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineminus">-  },</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-  get connecting() {</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineminus">-    return this.connectionState == Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l1.900"></a><span id="l1.900" class="difflineminus">-  },</span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-  get disconnecting() {</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-  },</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-  _cancelReconnection() {</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-    if (this._reconnectTimer) {</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-      clearTimeout(this._reconnectTimer);</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-      delete this._reconnectTimer;</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-    }</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-    delete this.reconnectAttempt;</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-    delete this.timeOfNextReconnect;</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-  },</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-  cancelReconnection() {</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-    if (!this.disconnected) {</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-    }</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-    // Ensure we don't keep a status observer that could re-enable the</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-    // auto-reconnect timers.</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-    this.disconnect();</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-    this._cancelReconnection();</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-  },</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-    return this._ensurePrplAccount.createConversation(aName);</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-  },</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-  addBuddy(aTag, aName) {</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-    this._ensurePrplAccount.addBuddy(aTag, aName);</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineminus">-  },</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-  loadBuddy(aBuddy, aTag) {</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-      return this.prplAccount.loadBuddy(aBuddy, aTag);</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-    }</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-    // Generate dummy account buddies for unknown protocols.</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-    return new UnknownAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-  },</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-  requestBuddyInfo(aBuddyName) {</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-    this._ensurePrplAccount.requestBuddyInfo(aBuddyName);</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-  },</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-  getChatRoomFields() {</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-    return this._ensurePrplAccount.getChatRoomFields();</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-  },</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-  getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-    return this._ensurePrplAccount.getChatRoomDefaultFieldValues(</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-      aDefaultChatName</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-    );</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-  },</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-    return this.prplAccount ? this.prplAccount.canJoinChat : false;</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-  },</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-  joinChat(aComponents) {</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-    this._ensurePrplAccount.joinChat(aComponents);</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-  },</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-  setBool(aName, aVal) {</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-    this.prefBranch.setBoolPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-    this._connectionInfoChanged();</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-      this.prplAccount.setBool(aName, aVal);</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-    }</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-    SavePrefTimer.initTimer();</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-  },</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-  setInt(aName, aVal) {</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-    this.prefBranch.setIntPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-    this._connectionInfoChanged();</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineminus">-      this.prplAccount.setInt(aName, aVal);</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineminus">-    }</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-    SavePrefTimer.initTimer();</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-  },</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-  setString(aName, aVal) {</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-    this.prefBranch.setStringPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-    this._connectionInfoChanged();</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineminus">-    if (this.prplAccount) {</span>
<a href="#l1.974"></a><span id="l1.974" class="difflineminus">-      this.prplAccount.setString(aName, aVal);</span>
<a href="#l1.975"></a><span id="l1.975" class="difflineminus">-    }</span>
<a href="#l1.976"></a><span id="l1.976" class="difflineminus">-    SavePrefTimer.initTimer();</span>
<a href="#l1.977"></a><span id="l1.977" class="difflineminus">-  },</span>
<a href="#l1.978"></a><span id="l1.978" class="difflineminus">-  save() {</span>
<a href="#l1.979"></a><span id="l1.979" class="difflineminus">-    SavePrefTimer.saveNow();</span>
<a href="#l1.980"></a><span id="l1.980" class="difflineminus">-  },</span>
<a href="#l1.981"></a><span id="l1.981" class="difflineminus">-</span>
<a href="#l1.982"></a><span id="l1.982" class="difflineminus">-  get HTMLEnabled() {</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-    return this._ensurePrplAccount.HTMLEnabled;</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-  },</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineminus">-  get HTMLEscapePlainText() {</span>
<a href="#l1.986"></a><span id="l1.986" class="difflineminus">-    return this._ensurePrplAccount.HTMLEscapePlainText;</span>
<a href="#l1.987"></a><span id="l1.987" class="difflineminus">-  },</span>
<a href="#l1.988"></a><span id="l1.988" class="difflineminus">-  get noBackgroundColors() {</span>
<a href="#l1.989"></a><span id="l1.989" class="difflineminus">-    return this._ensurePrplAccount.noBackgroundColors;</span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-  },</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-  get autoResponses() {</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-    return this._ensurePrplAccount.autoResponses;</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-  },</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-  get singleFormatting() {</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-    return this._ensurePrplAccount.singleFormatting;</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-  },</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-  get noFontSizes() {</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-    return this._ensurePrplAccount.noFontSizes;</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-  },</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-  get noUrlDesc() {</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-    return this._ensurePrplAccount.noUrlDesc;</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-  },</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-  get noImages() {</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-    return this._ensurePrplAccount.noImages;</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-  },</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-};</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineminus">-</span>
<a href="#l1.1008"></a><span id="l1.1008" class="difflineminus">-var gAccountsService = null;</span>
<a href="#l1.1009"></a><span id="l1.1009" class="difflineminus">-</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineminus">-function AccountsService() {}</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineminus">-AccountsService.prototype = {</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineminus">-  initAccounts() {</span>
<a href="#l1.1013"></a><span id="l1.1013" class="difflineminus">-    this._initAutoLoginStatus();</span>
<a href="#l1.1014"></a><span id="l1.1014" class="difflineminus">-    this._accounts = [];</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineminus">-    this._accountsById = {};</span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineminus">-    gAccountsService = this;</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineminus">-    gConvertingOldPasswords = Services.prefs.getBoolPref(</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineminus">-      kPrefConvertOldPasswords</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineminus">-    );</span>
<a href="#l1.1020"></a><span id="l1.1020" class="difflineminus">-    let accountList = this._accountList;</span>
<a href="#l1.1021"></a><span id="l1.1021" class="difflineminus">-    for (let account of accountList ? accountList.split(&quot;,&quot;) : []) {</span>
<a href="#l1.1022"></a><span id="l1.1022" class="difflineminus">-      try {</span>
<a href="#l1.1023"></a><span id="l1.1023" class="difflineminus">-        account.trim();</span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-        if (!account) {</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-          throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-        }</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-        new imAccount(account);</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-      } catch (e) {</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-        dump(e + &quot; &quot; + e.toSource() + &quot;\n&quot;);</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineminus">-      }</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineminus">-    }</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-    // If the user has canceled a master password prompt, we haven't</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-    // been able to save any password, so the old password conversion</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-    // still needs to happen.</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-    if (gConvertingOldPasswords &amp;&amp; !gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-      Services.prefs.setBoolPref(kPrefConvertOldPasswords, false);</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineminus">-    }</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineminus">-</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-    this._prefObserver = this.observe.bind(this);</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineminus">-    Services.prefs.addObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-  },</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-  _observingAccountListChange: true,</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-  _prefObserver: null,</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-    if (</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-      aTopic != &quot;nsPref:changed&quot; ||</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineminus">-      aData != kPrefMessengerAccounts ||</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineminus">-      !this._observingAccountListChange</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineminus">-    ) {</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-      return;</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineminus">-    }</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-    this._accounts = this._accountList</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-      .split(&quot;,&quot;)</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-      .map(account =&gt; account.trim())</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-      .filter(k =&gt; k.startsWith(kAccountKeyPrefix))</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-      .map(k =&gt; parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-      .map(this.getAccountByNumericId, this)</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-      .filter(a =&gt; a);</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;account-list-updated&quot;);</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineminus">-  },</span>
<a href="#l1.1065"></a><span id="l1.1065" class="difflineminus">-</span>
<a href="#l1.1066"></a><span id="l1.1066" class="difflineminus">-  get _accountList() {</span>
<a href="#l1.1067"></a><span id="l1.1067" class="difflineminus">-    return Services.prefs.getCharPref(kPrefMessengerAccounts);</span>
<a href="#l1.1068"></a><span id="l1.1068" class="difflineminus">-  },</span>
<a href="#l1.1069"></a><span id="l1.1069" class="difflineminus">-  set _accountList(aNewList) {</span>
<a href="#l1.1070"></a><span id="l1.1070" class="difflineminus">-    this._observingAccountListChange = false;</span>
<a href="#l1.1071"></a><span id="l1.1071" class="difflineminus">-    Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l1.1072"></a><span id="l1.1072" class="difflineminus">-    delete this._observingAccountListChange;</span>
<a href="#l1.1073"></a><span id="l1.1073" class="difflineminus">-  },</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-  unInitAccounts() {</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineminus">-    for (let account of this._accounts) {</span>
<a href="#l1.1077"></a><span id="l1.1077" class="difflineminus">-      account.unInit();</span>
<a href="#l1.1078"></a><span id="l1.1078" class="difflineminus">-    }</span>
<a href="#l1.1079"></a><span id="l1.1079" class="difflineminus">-    gAccountsService = null;</span>
<a href="#l1.1080"></a><span id="l1.1080" class="difflineminus">-    delete this._accounts;</span>
<a href="#l1.1081"></a><span id="l1.1081" class="difflineminus">-    delete this._accountsById;</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineminus">-    Services.prefs.removeObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineminus">-    delete this._prefObserver;</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineminus">-  },</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineminus">-</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineminus">-  autoLoginStatus: Ci.imIAccountsService.AUTOLOGIN_ENABLED,</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineminus">-  _initAutoLoginStatus() {</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineminus">-    /* If auto-login is already disabled, do nothing */</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineminus">-    if (this.autoLoginStatus != Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineminus">-      return;</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineminus">-    }</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineminus">-</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineminus">-    let prefs = Services.prefs;</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineminus">-    if (!prefs.getIntPref(&quot;messenger.startup.action&quot;)) {</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineminus">-      // the value 0 means that we start without connecting the accounts</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineminus">-      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineminus">-      return;</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineminus">-    }</span>
<a href="#l1.1099"></a><span id="l1.1099" class="difflineminus">-</span>
<a href="#l1.1100"></a><span id="l1.1100" class="difflineminus">-    /* Disable auto-login if we are running in safe mode */</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineminus">-    if (Services.appinfo.inSafeMode) {</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineminus">-      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_SAFE_MODE;</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineminus">-      return;</span>
<a href="#l1.1104"></a><span id="l1.1104" class="difflineminus">-    }</span>
<a href="#l1.1105"></a><span id="l1.1105" class="difflineminus">-</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineminus">-    /* Check if we crashed at the last startup during autologin */</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineminus">-    let autoLoginPending;</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineminus">-    if (</span>
<a href="#l1.1109"></a><span id="l1.1109" class="difflineminus">-      prefs.getPrefType(kPrefAutologinPending) == prefs.PREF_INVALID ||</span>
<a href="#l1.1110"></a><span id="l1.1110" class="difflineminus">-      !(autoLoginPending = prefs.getIntPref(kPrefAutologinPending))</span>
<a href="#l1.1111"></a><span id="l1.1111" class="difflineminus">-    ) {</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineminus">-      // if the pref isn't set, then we haven't crashed: keep autologin enabled</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineminus">-      return;</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineminus">-    }</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineminus">-</span>
<a href="#l1.1116"></a><span id="l1.1116" class="difflineminus">-    // Last autologin hasn't finished properly.</span>
<a href="#l1.1117"></a><span id="l1.1117" class="difflineminus">-    // For now, assume it's because of a crash.</span>
<a href="#l1.1118"></a><span id="l1.1118" class="difflineminus">-    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_CRASH;</span>
<a href="#l1.1119"></a><span id="l1.1119" class="difflineminus">-    prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineminus">-</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineminus">-    // If the crash reporter isn't built, we can't know anything more.</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-    if (!(&quot;nsICrashReporter&quot; in Ci)) {</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineminus">-      return;</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineminus">-    }</span>
<a href="#l1.1125"></a><span id="l1.1125" class="difflineminus">-</span>
<a href="#l1.1126"></a><span id="l1.1126" class="difflineminus">-    try {</span>
<a href="#l1.1127"></a><span id="l1.1127" class="difflineminus">-      // Try to get more info with breakpad</span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineminus">-      let lastCrashTime = 0;</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineminus">-</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineminus">-      /* Locate the LastCrash file */</span>
<a href="#l1.1131"></a><span id="l1.1131" class="difflineminus">-      let lastCrash = Services.dirsvc.get(&quot;UAppData&quot;, Ci.nsIFile);</span>
<a href="#l1.1132"></a><span id="l1.1132" class="difflineminus">-      lastCrash.append(&quot;Crash Reports&quot;);</span>
<a href="#l1.1133"></a><span id="l1.1133" class="difflineminus">-      lastCrash.append(&quot;LastCrash&quot;);</span>
<a href="#l1.1134"></a><span id="l1.1134" class="difflineminus">-      if (lastCrash.exists()) {</span>
<a href="#l1.1135"></a><span id="l1.1135" class="difflineminus">-        /* Ok, the file exists, now let's try to read it */</span>
<a href="#l1.1136"></a><span id="l1.1136" class="difflineminus">-        let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l1.1137"></a><span id="l1.1137" class="difflineminus">-          Ci.nsIFileInputStream</span>
<a href="#l1.1138"></a><span id="l1.1138" class="difflineminus">-        );</span>
<a href="#l1.1139"></a><span id="l1.1139" class="difflineminus">-        let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l1.1140"></a><span id="l1.1140" class="difflineminus">-          Ci.nsIScriptableInputStream</span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineminus">-        );</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineminus">-        is.init(lastCrash, -1, 0, 0);</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineminus">-        sis.init(sis);</span>
<a href="#l1.1144"></a><span id="l1.1144" class="difflineminus">-</span>
<a href="#l1.1145"></a><span id="l1.1145" class="difflineminus">-        lastCrashTime = parseInt(sis.read(lastCrash.fileSize));</span>
<a href="#l1.1146"></a><span id="l1.1146" class="difflineminus">-</span>
<a href="#l1.1147"></a><span id="l1.1147" class="difflineminus">-        sis.close();</span>
<a href="#l1.1148"></a><span id="l1.1148" class="difflineminus">-      }</span>
<a href="#l1.1149"></a><span id="l1.1149" class="difflineminus">-      // The file not existing is totally acceptable, it just means that</span>
<a href="#l1.1150"></a><span id="l1.1150" class="difflineminus">-      // either we never crashed or breakpad is not enabled.</span>
<a href="#l1.1151"></a><span id="l1.1151" class="difflineminus">-      // In this case, lastCrashTime will keep its 0 initialization value.</span>
<a href="#l1.1152"></a><span id="l1.1152" class="difflineminus">-</span>
<a href="#l1.1153"></a><span id="l1.1153" class="difflineminus">-      /* dump(&quot;autoLoginPending = &quot; + autoLoginPending +</span>
<a href="#l1.1154"></a><span id="l1.1154" class="difflineminus">-              &quot;, lastCrash = &quot; + lastCrashTime +</span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineminus">-              &quot;, difference = &quot; + lastCrashTime - autoLoginPending + &quot;\n&quot;);*/</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineminus">-</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-      if (lastCrashTime &lt; autoLoginPending) {</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-        // the last crash caught by breakpad is older than our last autologin</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-        // attempt.</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineminus">-        // If breakpad is currently enabled, we can be confident that</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineminus">-        // autologin was interrupted for an exterior reason</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineminus">-        // (application killed by the user, power outage, ...)</span>
<a href="#l1.1163"></a><span id="l1.1163" class="difflineminus">-        try {</span>
<a href="#l1.1164"></a><span id="l1.1164" class="difflineminus">-          Services.appinfo</span>
<a href="#l1.1165"></a><span id="l1.1165" class="difflineminus">-            .QueryInterface(Ci.nsICrashReporter)</span>
<a href="#l1.1166"></a><span id="l1.1166" class="difflineminus">-            .annotateCrashReport(&quot;=&quot;, &quot;&quot;);</span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineminus">-        } catch (e) {</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineminus">-          // This should fail with NS_ERROR_INVALID_ARG if breakpad is enabled,</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineminus">-          // and NS_ERROR_NOT_INITIALIZED if it is not.</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineminus">-          if (e.result != Cr.NS_ERROR_NOT_INITIALIZED) {</span>
<a href="#l1.1171"></a><span id="l1.1171" class="difflineminus">-            this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l1.1172"></a><span id="l1.1172" class="difflineminus">-          }</span>
<a href="#l1.1173"></a><span id="l1.1173" class="difflineminus">-        }</span>
<a href="#l1.1174"></a><span id="l1.1174" class="difflineminus">-      }</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineminus">-      // if we failed to get the last crash time, then keep the</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineminus">-      // AUTOLOGIN_CRASH value in mAutoLoginStatus and return.</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineminus">-    }</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineminus">-  },</span>
<a href="#l1.1180"></a><span id="l1.1180" class="difflineminus">-</span>
<a href="#l1.1181"></a><span id="l1.1181" class="difflineminus">-  processAutoLogin() {</span>
<a href="#l1.1182"></a><span id="l1.1182" class="difflineminus">-    if (!this._accounts) {</span>
<a href="#l1.1183"></a><span id="l1.1183" class="difflineminus">-      // if we're already shutting down</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineminus">-      return;</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineminus">-    }</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineminus">-</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineminus">-    for (let account of this._accounts) {</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineminus">-      account.checkAutoLogin();</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineminus">-    }</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineminus">-</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineminus">-    // Make sure autologin is now enabled, so that we don't display a</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineminus">-    // message stating that it is disabled and asking the user if it</span>
<a href="#l1.1193"></a><span id="l1.1193" class="difflineminus">-    // should be processed now.</span>
<a href="#l1.1194"></a><span id="l1.1194" class="difflineminus">-    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l1.1195"></a><span id="l1.1195" class="difflineminus">-</span>
<a href="#l1.1196"></a><span id="l1.1196" class="difflineminus">-    // Notify observers so that any message stating that autologin is</span>
<a href="#l1.1197"></a><span id="l1.1197" class="difflineminus">-    // disabled can be removed</span>
<a href="#l1.1198"></a><span id="l1.1198" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;autologin-processed&quot;);</span>
<a href="#l1.1199"></a><span id="l1.1199" class="difflineminus">-  },</span>
<a href="#l1.1200"></a><span id="l1.1200" class="difflineminus">-</span>
<a href="#l1.1201"></a><span id="l1.1201" class="difflineminus">-  _checkingIfPasswordStillMissing: false,</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-  _checkIfPasswordStillMissing() {</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-    // Avoid recursion.</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineminus">-    if (this._checkingIfPasswordStillMissing) {</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineminus">-      return;</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineminus">-    }</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineminus">-</span>
<a href="#l1.1208"></a><span id="l1.1208" class="difflineminus">-    this._checkingIfPasswordStillMissing = true;</span>
<a href="#l1.1209"></a><span id="l1.1209" class="difflineminus">-    for (let account of this._accounts) {</span>
<a href="#l1.1210"></a><span id="l1.1210" class="difflineminus">-      account._checkIfPasswordStillMissing();</span>
<a href="#l1.1211"></a><span id="l1.1211" class="difflineminus">-    }</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-    delete this._checkingIfPasswordStillMissing;</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineminus">-  },</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineminus">-</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineminus">-  getAccountById(aAccountId) {</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineminus">-    if (!aAccountId.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.1218"></a><span id="l1.1218" class="difflineminus">-    }</span>
<a href="#l1.1219"></a><span id="l1.1219" class="difflineminus">-</span>
<a href="#l1.1220"></a><span id="l1.1220" class="difflineminus">-    let id = parseInt(aAccountId.substr(kAccountKeyPrefix.length));</span>
<a href="#l1.1221"></a><span id="l1.1221" class="difflineminus">-    return this.getAccountByNumericId(id);</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineminus">-  },</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineminus">-  _keepAccount(aAccount) {</span>
<a href="#l1.1225"></a><span id="l1.1225" class="difflineminus">-    this._accounts.push(aAccount);</span>
<a href="#l1.1226"></a><span id="l1.1226" class="difflineminus">-    this._accountsById[aAccount.numericId] = aAccount;</span>
<a href="#l1.1227"></a><span id="l1.1227" class="difflineminus">-  },</span>
<a href="#l1.1228"></a><span id="l1.1228" class="difflineminus">-  getAccountByNumericId(aAccountId) {</span>
<a href="#l1.1229"></a><span id="l1.1229" class="difflineminus">-    return this._accountsById[aAccountId];</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineminus">-  },</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineminus">-  getAccounts() {</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineminus">-    return new nsSimpleEnumerator(this._accounts);</span>
<a href="#l1.1233"></a><span id="l1.1233" class="difflineminus">-  },</span>
<a href="#l1.1234"></a><span id="l1.1234" class="difflineminus">-</span>
<a href="#l1.1235"></a><span id="l1.1235" class="difflineminus">-  createAccount(aName, aPrpl) {</span>
<a href="#l1.1236"></a><span id="l1.1236" class="difflineminus">-    // Ensure an account with the same name and protocol doesn't already exist.</span>
<a href="#l1.1237"></a><span id="l1.1237" class="difflineminus">-    let prpl = Services.core.getProtocolById(aPrpl);</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-    if (!prpl) {</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineminus">-    }</span>
<a href="#l1.1241"></a><span id="l1.1241" class="difflineminus">-    if (prpl.accountExists(aName)) {</span>
<a href="#l1.1242"></a><span id="l1.1242" class="difflineminus">-      Cu.reportError(&quot;Attempted to create a duplicate account!&quot;);</span>
<a href="#l1.1243"></a><span id="l1.1243" class="difflineminus">-      throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l1.1244"></a><span id="l1.1244" class="difflineminus">-    }</span>
<a href="#l1.1245"></a><span id="l1.1245" class="difflineminus">-</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineminus">-    /* First get a unique id for the new account. */</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineminus">-    let id;</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineminus">-    for (id = 1; ; ++id) {</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineminus">-      if (this._accountsById.hasOwnProperty(id)) {</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineminus">-        continue;</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineminus">-      }</span>
<a href="#l1.1252"></a><span id="l1.1252" class="difflineminus">-</span>
<a href="#l1.1253"></a><span id="l1.1253" class="difflineminus">-      /* id isn't used by a known account, double check it isn't</span>
<a href="#l1.1254"></a><span id="l1.1254" class="difflineminus">-       already used in the sqlite database. This should never</span>
<a href="#l1.1255"></a><span id="l1.1255" class="difflineminus">-       happen, except if we have a corrupted profile. */</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineminus">-      if (!Services.contacts.accountIdExists(id)) {</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineminus">-        break;</span>
<a href="#l1.1258"></a><span id="l1.1258" class="difflineminus">-      }</span>
<a href="#l1.1259"></a><span id="l1.1259" class="difflineminus">-      Services.console.logStringMessage(</span>
<a href="#l1.1260"></a><span id="l1.1260" class="difflineminus">-        &quot;No account &quot; +</span>
<a href="#l1.1261"></a><span id="l1.1261" class="difflineminus">-          id +</span>
<a href="#l1.1262"></a><span id="l1.1262" class="difflineminus">-          &quot; but there is some data in the buddy list for an account with this number. Your profile may be corrupted.&quot;</span>
<a href="#l1.1263"></a><span id="l1.1263" class="difflineminus">-      );</span>
<a href="#l1.1264"></a><span id="l1.1264" class="difflineminus">-    }</span>
<a href="#l1.1265"></a><span id="l1.1265" class="difflineminus">-</span>
<a href="#l1.1266"></a><span id="l1.1266" class="difflineminus">-    /* Actually create the new account. */</span>
<a href="#l1.1267"></a><span id="l1.1267" class="difflineminus">-    let key = kAccountKeyPrefix + id;</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-    let account = new imAccount(key, aName, aPrpl);</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineminus">-</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineminus">-    /* Save the account list pref. */</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineminus">-    let list = this._accountList;</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineminus">-    this._accountList = list ? list + &quot;,&quot; + key : key;</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineminus">-</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineminus">-    Services.obs.notifyObservers(account, &quot;account-added&quot;);</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineminus">-    return account;</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineminus">-  },</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineminus">-</span>
<a href="#l1.1278"></a><span id="l1.1278" class="difflineminus">-  deleteAccount(aAccountId) {</span>
<a href="#l1.1279"></a><span id="l1.1279" class="difflineminus">-    let account = this.getAccountById(aAccountId);</span>
<a href="#l1.1280"></a><span id="l1.1280" class="difflineminus">-    if (!account) {</span>
<a href="#l1.1281"></a><span id="l1.1281" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l1.1282"></a><span id="l1.1282" class="difflineminus">-    }</span>
<a href="#l1.1283"></a><span id="l1.1283" class="difflineminus">-</span>
<a href="#l1.1284"></a><span id="l1.1284" class="difflineminus">-    let index = this._accounts.indexOf(account);</span>
<a href="#l1.1285"></a><span id="l1.1285" class="difflineminus">-    if (index == -1) {</span>
<a href="#l1.1286"></a><span id="l1.1286" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-    }</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineminus">-</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineminus">-    let id = account.numericId;</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineminus">-    account.remove();</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineminus">-    this._accounts.splice(index, 1);</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineminus">-    delete this._accountsById[id];</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineminus">-    Services.obs.notifyObservers(account, &quot;account-removed&quot;);</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineminus">-</span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineminus">-    /* Update the account list pref. */</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineminus">-    let list = this._accountList;</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineminus">-    this._accountList = list</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineminus">-      .split(&quot;,&quot;)</span>
<a href="#l1.1299"></a><span id="l1.1299" class="difflineminus">-      .filter(k =&gt; k.trim() != aAccountId)</span>
<a href="#l1.1300"></a><span id="l1.1300" class="difflineminus">-      .join(&quot;,&quot;);</span>
<a href="#l1.1301"></a><span id="l1.1301" class="difflineminus">-  },</span>
<a href="#l1.1302"></a><span id="l1.1302" class="difflineminus">-</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/chat/components/src/IMCommands.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,289 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;IMCommands&quot;];</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-function IMCommands() {}</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-IMCommands.prototype = {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  initCommands() {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    this._commands = {};</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    // The say command is directly implemented in the UI layer, but has a</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    // dummy command registered here so it shows up as a command (e.g. when</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    // using the /help command).</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-    this.registerCommand({</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-      name: &quot;say&quot;,</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-      get helpString() {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-        return _(&quot;sayHelpString&quot;);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-      },</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-      priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-      run(aMsg, aConv) {</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-      },</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-    });</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    this.registerCommand({</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-      name: &quot;raw&quot;,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-      get helpString() {</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-        return _(&quot;rawHelpString&quot;);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-      },</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-      priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-      run(aMsg, aConv) {</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-        let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-        if (!conv) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-          return false;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-        }</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-        conv.sendMsg(aMsg);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        return true;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      },</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-    });</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    this.registerCommand({</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      // Reference the command service so we can use the internal properties</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-      // directly.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-      cmdSrv: this,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-      name: &quot;help&quot;,</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      get helpString() {</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-        return _(&quot;helpHelpString&quot;);</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-      },</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-      priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-      run(aMsg, aConv) {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-        aMsg = aMsg.trim();</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-        let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-        if (!conv) {</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-          return false;</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-        }</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-        // Handle when no command is given, list all possible commands that are</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-        // available for this conversation (alphabetically).</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-        if (!aMsg) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-          let commands = this.cmdSrv.listCommandsForConversation(aConv);</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-          if (!commands.length) {</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-            return false;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-          }</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-          // Concatenate the command names (separated by a comma and space).</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-          let cmds = commands</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-            .map(aCmd =&gt; aCmd.name)</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-            .sort()</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-            .join(&quot;, &quot;);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-          let message = _(&quot;commands&quot;, cmds);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-          // Display the message</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-          conv.systemMessage(message);</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-          return true;</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        }</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-        // A command name was given, find the commands that match.</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-        let cmdArray = this.cmdSrv._findCommands(aConv, aMsg);</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-        if (!cmdArray.length) {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-          // No command that matches.</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-          let message = _(&quot;noCommand&quot;, aMsg);</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-          conv.systemMessage(message);</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-          return true;</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-        }</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-        // Only show the help for the one of the highest priority.</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-        let cmd = cmdArray[0];</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-        let text = cmd.helpString;</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-        if (!text) {</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-          text = _(&quot;noHelp&quot;, cmd.name);</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-        }</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-        // Display the message.</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-        conv.systemMessage(text);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-        return true;</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-      },</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-    });</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    // Status commands</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-    let status = {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-      back: &quot;AVAILABLE&quot;,</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-      away: &quot;AWAY&quot;,</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-      busy: &quot;UNAVAILABLE&quot;,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      dnd: &quot;UNAVAILABLE&quot;,</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      offline: &quot;OFFLINE&quot;,</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    };</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    for (let cmd in status) {</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-      let statusValue = Ci.imIStatusInfo[&quot;STATUS_&quot; + status[cmd]];</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-      this.registerCommand({</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-        name: cmd,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-        get helpString() {</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-          return _(&quot;statusCommand&quot;, this.name, _(this.name));</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-        },</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-        usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-        priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-        run(aMsg) {</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-          Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-          return true;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-        },</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-      });</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    }</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  },</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  unInitCommands() {</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-    delete this._commands;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-  },</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-  registerCommand(aCommand, aPrplId) {</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    let name = aCommand.name;</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-    if (!name) {</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    }</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    if (!this._commands.hasOwnProperty(name)) {</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-      this._commands[name] = {};</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-    }</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-    this._commands[name][aPrplId || &quot;&quot;] = aCommand;</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-  },</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  unregisterCommand(aCommandName, aPrplId) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    if (this._commands.hasOwnProperty(aCommandName)) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-      let prplId = aPrplId || &quot;&quot;;</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-      let commands = this._commands[aCommandName];</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-      if (commands.hasOwnProperty(prplId)) {</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-        delete commands[prplId];</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-      }</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-      if (!Object.keys(commands).length) {</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-        delete this._commands[aCommandName];</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-      }</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    }</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-  },</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-  listCommandsForConversation(aConversation) {</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    let result = [];</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    let prplId = aConversation &amp;&amp; aConversation.account.protocol.id;</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    for (let name in this._commands) {</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-      let commands = this._commands[name];</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-        result.push(commands[&quot;&quot;]);</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-      }</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-        result.push(commands[prplId]);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-      }</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    }</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-    if (aConversation) {</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-      result = result.filter(this._usageContextFilter(aConversation));</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-    }</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-    return result;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-  },</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-  // List only the commands for a protocol (excluding the global commands).</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-  listCommandsForProtocol(aPrplId) {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-    if (!aPrplId) {</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-      throw new Error(&quot;You must provide a prpl ID.&quot;);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-    }</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-    let result = [];</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    for (let name in this._commands) {</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-      let commands = this._commands[name];</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-      if (commands.hasOwnProperty(aPrplId)) {</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-        result.push(commands[aPrplId]);</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-      }</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-    }</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-    return result;</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-  },</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-  _usageContextFilter(aConversation) {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-    let usageContext =</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-      Ci.imICommand[&quot;CMD_CONTEXT_&quot; + (aConversation.isChat ? &quot;CHAT&quot; : &quot;IM&quot;)];</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    return c =&gt; c.usageContext &amp; usageContext;</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-  },</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-  _findCommands(aConversation, aName) {</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-    let prplId = null;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    if (aConversation) {</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-      let account = aConversation.account;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-      if (account.connected) {</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-        prplId = account.protocol.id;</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      }</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    }</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    let commandNames;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    // If there is an exact match for the given command name,</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    // don't look at any other commands.</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    if (this._commands.hasOwnProperty(aName)) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-      commandNames = [aName];</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-    } else {</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-      // Otherwise, check if there is a partial match.</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-      commandNames = Object.keys(this._commands).filter(command =&gt;</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-        command.startsWith(aName)</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-      );</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-    }</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-    // If a single full command name matches the given (partial)</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-    // command name, return the results for that command name. Otherwise,</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    // return an empty array (don't assume a certain command).</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    let cmdArray = [];</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    for (let commandName of commandNames) {</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-      let matches = [];</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      // Get the 2 possible commands (the global and the proto specific).</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-      let commands = this._commands[commandName];</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-        matches.push(commands[&quot;&quot;]);</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-      }</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-        matches.push(commands[prplId]);</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-      }</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-      // Remove the commands that can't apply in this context.</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-      if (aConversation) {</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-        matches = matches.filter(this._usageContextFilter(aConversation));</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-      }</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-      if (!matches.length) {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-        continue;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-      }</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-      // If we have found a second matching command name, return the empty array.</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-      if (cmdArray.length) {</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        return [];</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-      }</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-      cmdArray = matches;</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    // Sort the matching commands by priority before returning the array.</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    return cmdArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-  },</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-  executeCommand(aMessage, aConversation, aReturnedConv) {</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    if (!aMessage) {</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    }</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-    let matchResult;</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    if (</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-      aMessage[0] != &quot;/&quot; ||</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-      !(matchResult = /^\/([a-z0-9]+)(?: |$)([\s\S]*)/.exec(aMessage))</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    ) {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-      return false;</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-    }</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-    let [, name, args] = matchResult;</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-    let cmdArray = this._findCommands(aConversation, name);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-    if (!cmdArray.length) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-      return false;</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-    }</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-    // cmdArray contains commands sorted by priority, attempt to apply</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-    // them in order until one succeeds.</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-    if (!cmdArray.some(aCmd =&gt; aCmd.run(args, aConversation, aReturnedConv))) {</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-      // If they all failed, print help message.</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-      this.executeCommand(&quot;/help &quot; + name, aConversation);</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-    }</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-    return true;</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-  },</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imICommandsService]),</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">deleted file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- a/chat/components/src/IMContacts.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ /dev/null</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -1,1801 +0,0 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineminus">-</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;TagsService&quot;, &quot;ContactsService&quot;];</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineminus">-</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var { XPCOMUtils, executeSoon, ClassInfo, l10nHelper } = ChromeUtils.import(</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/contacts.properties&quot;)</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-var gDBConnection = null;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-function executeAsyncThenFinalize(statement) {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  statement.executeAsync();</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  statement.finalize();</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-}</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-function getDBConnection() {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-  const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-  let dbFile = Services.dirsvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-  dbFile.append(&quot;blist.sqlite&quot;);</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-  let conn = Services.storage.openDatabase(dbFile);</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-  if (!conn.connectionReady) {</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  }</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  // Grow blist db in 512KB increments.</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-  try {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-    conn.setGrowthIncrement(512 * 1024, &quot;&quot;);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-  } catch (e) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    if (e.result == Cr.NS_ERROR_FILE_TOO_BIG) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-      Services.console.logStringMessage(</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-        &quot;Not setting growth increment on &quot; +</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-          &quot;blist.sqlite because the available &quot; +</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-          &quot;disk space is limited&quot;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      );</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-    } else {</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-      throw e;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-    }</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-  }</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  // Create tables and indexes.</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  [</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS accounts (&quot; +</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-      &quot;name VARCHAR, &quot; +</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-      &quot;prpl VARCHAR)&quot;,</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS contacts (&quot; +</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-      &quot;firstname VARCHAR, &quot; +</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-      &quot;lastname VARCHAR, &quot; +</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-      &quot;alias VARCHAR)&quot;,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS buddies (&quot; +</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-      &quot;key VARCHAR NOT NULL, &quot; +</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-      &quot;name VARCHAR NOT NULL, &quot; +</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-      &quot;srv_alias VARCHAR, &quot; +</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-      &quot;position INTEGER, &quot; +</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-      &quot;icon BLOB, &quot; +</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-      &quot;contact_id INTEGER)&quot;,</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-    &quot;CREATE INDEX IF NOT EXISTS buddies_contactindex &quot; +</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-      &quot;ON buddies (contact_id)&quot;,</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS tags (&quot; +</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      &quot;name VARCHAR UNIQUE NOT NULL, &quot; +</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-      &quot;position INTEGER)&quot;,</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS contact_tag (&quot; +</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-      &quot;contact_id INTEGER NOT NULL, &quot; +</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-      &quot;tag_id INTEGER NOT NULL)&quot;,</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-    &quot;CREATE INDEX IF NOT EXISTS contact_tag_contactindex &quot; +</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-      &quot;ON contact_tag (contact_id)&quot;,</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    &quot;CREATE INDEX IF NOT EXISTS contact_tag_tagindex &quot; +</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-      &quot;ON contact_tag (tag_id)&quot;,</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-    &quot;CREATE TABLE IF NOT EXISTS account_buddy (&quot; +</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      &quot;account_id INTEGER NOT NULL, &quot; +</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-      &quot;buddy_id INTEGER NOT NULL, &quot; +</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-      &quot;status VARCHAR, &quot; +</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-      &quot;tag_id INTEGER)&quot;,</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-    &quot;CREATE INDEX IF NOT EXISTS account_buddy_accountindex &quot; +</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      &quot;ON account_buddy (account_id)&quot;,</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-    &quot;CREATE INDEX IF NOT EXISTS account_buddy_buddyindex &quot; +</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-      &quot;ON account_buddy (buddy_id)&quot;,</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-  ].forEach(conn.executeSimpleSQL);</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-  return conn;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-}</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-// Wrap all the usage of DBConn inside a transaction that will be</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-// committed automatically at the end of the event loop spin so that</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-// we flush buddy list data to disk only once per event loop spin.</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-var gDBConnWithPendingTransaction = null;</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-Object.defineProperty(this, &quot;DBConn&quot;, {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-  configurable: true,</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-  enumerable: true,</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-  get() {</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    if (gDBConnWithPendingTransaction) {</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-      return gDBConnWithPendingTransaction;</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    }</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-    if (!gDBConnection) {</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-      gDBConnection = getDBConnection();</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-      Services.obs.addObserver(function dbClose(aSubject, aTopic, aData) {</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-        Services.obs.removeObserver(dbClose, aTopic);</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-        if (gDBConnection) {</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-          gDBConnection.asyncClose();</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineminus">-          gDBConnection = null;</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineminus">-        }</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineminus">-      }, &quot;profile-before-change&quot;);</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineminus">-    }</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineminus">-    gDBConnWithPendingTransaction = gDBConnection;</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-    gDBConnection.beginTransaction();</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-    executeSoon(function() {</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-      gDBConnWithPendingTransaction.commitTransaction();</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-      gDBConnWithPendingTransaction = null;</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-    });</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineminus">-    return gDBConnection;</span>
<a href="#l3.133"></a><span id="l3.133" class="difflineminus">-  },</span>
<a href="#l3.134"></a><span id="l3.134" class="difflineminus">-});</span>
<a href="#l3.135"></a><span id="l3.135" class="difflineminus">-</span>
<a href="#l3.136"></a><span id="l3.136" class="difflineminus">-function TagsService() {}</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-TagsService.prototype = {</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-  get wrappedJSObject() {</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    return this;</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-  },</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-  get defaultTag() {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-    return this.createTag(_(&quot;defaultGroup&quot;));</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-  },</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-  createTag(aName) {</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-    // If the tag already exists, we don't want to create a duplicate.</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-    let tag = this.getTagByName(aName);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-    if (tag) {</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-      return tag;</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    }</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-      &quot;INSERT INTO tags (name, position) VALUES(:name, 0)&quot;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-    );</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-    try {</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-      statement.params.name = aName;</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-      statement.executeStep();</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-    } finally {</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-    }</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-    tag = new Tag(DBConn.lastInsertRowID, aName);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-    Tags.push(tag);</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-    return tag;</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-  },</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-  // Get an existing tag by (numeric) id. Returns null if not found.</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-  getTagById: aId =&gt; TagsById[aId],</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-  // Get an existing tag by name (will do an SQL query). Returns null</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-  // if not found.</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-  getTagByName(aName) {</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-      &quot;SELECT id FROM tags where name = :name&quot;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-    );</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-    statement.params.name = aName;</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-    try {</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-      if (!statement.executeStep()) {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-        return null;</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-      }</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-      return this.getTagById(statement.row.id);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-    } finally {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-    }</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-  },</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  // Get an array of all existing tags.</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-  getTags() {</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    if (Tags.length) {</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-      Tags.sort((a, b) =&gt;</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-        a.name.toLowerCase().localeCompare(b.name.toLowerCase())</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-      );</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-    } else {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-      this.defaultTag;</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-    }</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-    return Tags;</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-  },</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-  isTagHidden: aTag =&gt; aTag.id in otherContactsTag._hiddenTags,</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-  hideTag(aTag) {</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-    otherContactsTag.hideTag(aTag);</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-  },</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-  showTag(aTag) {</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-    otherContactsTag.showTag(aTag);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  },</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-  get otherContactsTag() {</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-    otherContactsTag._initContacts();</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-    return otherContactsTag;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-  },</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imITagsService]),</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-};</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-// TODO move into the tagsService</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-var Tags = [];</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-var TagsById = {};</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-function Tag(aId, aName) {</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-  this._id = aId;</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-  this._name = aName;</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-  this._contacts = [];</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  this._observers = [];</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-  TagsById[this.id] = this;</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-}</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-Tag.prototype = {</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-  __proto__: ClassInfo(&quot;imITag&quot;, &quot;Tag&quot;),</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineminus">-  get id() {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineminus">-    return this._id;</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineminus">-  },</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineminus">-  get name() {</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineminus">-    return this._name;</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineminus">-  },</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineminus">-  set name(aNewName) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-      &quot;UPDATE tags SET name = :name WHERE id = :id&quot;</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-    );</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineminus">-    try {</span>
<a href="#l3.236"></a><span id="l3.236" class="difflineminus">-      statement.params.name = aNewName;</span>
<a href="#l3.237"></a><span id="l3.237" class="difflineminus">-      statement.params.id = this._id;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineminus">-      statement.execute();</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-    } finally {</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-    }</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-    // FIXME move the account buddies if some use this tag as their group</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-    return aNewName;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-  },</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-  getContacts() {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-    return this._contacts.filter(c =&gt; !c._empty);</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  },</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-  _addContact(aContact) {</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-    this._contacts.push(aContact);</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-  },</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-  _removeContact(aContact) {</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-    let index = this._contacts.indexOf(aContact);</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-    if (index != -1) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-      this._contacts.splice(index, 1);</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-    }</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-  },</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineminus">-    }</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-  },</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-  },</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineminus">-      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineminus">-    }</span>
<a href="#l3.271"></a><span id="l3.271" class="difflineminus">-  },</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineminus">-};</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-var otherContactsTag = {</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-  __proto__: ClassInfo([&quot;nsIObserver&quot;, &quot;imITag&quot;], &quot;Other Contacts Tag&quot;),</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  hiddenTagsPref: &quot;messenger.buddies.hiddenTags&quot;,</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-  _hiddenTags: {},</span>
<a href="#l3.278"></a><span id="l3.278" class="difflineminus">-  _contactsInitialized: false,</span>
<a href="#l3.279"></a><span id="l3.279" class="difflineminus">-  _saveHiddenTagsPref() {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-    Services.prefs.setCharPref(</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineminus">-      this.hiddenTagsPref,</span>
<a href="#l3.282"></a><span id="l3.282" class="difflineminus">-      Object.keys(this._hiddenTags).join(&quot;,&quot;)</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    );</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-  },</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-  showTag(aTag) {</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    let id = aTag.id;</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-    delete this._hiddenTags[id];</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-    let contacts = Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    for (let contact of contacts) {</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-      if (contact.getTags().some(t =&gt; t.id == id)) {</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-        this._removeContact(contact);</span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-      }</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-    }</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineminus">-</span>
<a href="#l3.295"></a><span id="l3.295" class="difflineminus">-    aTag.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineminus">-    Services.obs.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l3.297"></a><span id="l3.297" class="difflineminus">-    this._saveHiddenTagsPref();</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-  },</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-  hideTag(aTag) {</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineminus">-    if (aTag.id &lt; 0 || aTag.id in otherContactsTag._hiddenTags) {</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineminus">-      return;</span>
<a href="#l3.302"></a><span id="l3.302" class="difflineminus">-    }</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineminus">-</span>
<a href="#l3.304"></a><span id="l3.304" class="difflineminus">-    this._hiddenTags[aTag.id] = aTag;</span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-    if (this._contactsInitialized) {</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineminus">-      this._hideTag(aTag);</span>
<a href="#l3.307"></a><span id="l3.307" class="difflineminus">-    }</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-</span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-    aTag.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l3.310"></a><span id="l3.310" class="difflineminus">-    Services.obs.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineminus">-    this._saveHiddenTagsPref();</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-  },</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-  _hideTag(aTag) {</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-    for (let contact of aTag.getContacts()) {</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-      if (</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-        !(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-        contact.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-      ) {</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-        this._addContact(contact);</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-      }</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-    }</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineminus">-  },</span>
<a href="#l3.323"></a><span id="l3.323" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-    aSubject.QueryInterface(Ci.imIContact);</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-    if (aTopic == &quot;contact-tag-removed&quot; || aTopic == &quot;contact-added&quot;) {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-      if (</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-        !(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-        !(parseInt(aData) in this._hiddenTags) &amp;&amp;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-        aSubject.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-      ) {</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineminus">-        this._addContact(aSubject);</span>
<a href="#l3.332"></a><span id="l3.332" class="difflineminus">-      }</span>
<a href="#l3.333"></a><span id="l3.333" class="difflineminus">-    } else if (</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineminus">-      aSubject.id in this._contacts &amp;&amp;</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineminus">-      (aTopic == &quot;contact-removed&quot; ||</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineminus">-        (aTopic == &quot;contact-tag-added&quot; &amp;&amp;</span>
<a href="#l3.337"></a><span id="l3.337" class="difflineminus">-          !(parseInt(aData) in this._hiddenTags)))</span>
<a href="#l3.338"></a><span id="l3.338" class="difflineminus">-    ) {</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineminus">-      this._removeContact(aSubject);</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineminus">-    }</span>
<a href="#l3.341"></a><span id="l3.341" class="difflineminus">-  },</span>
<a href="#l3.342"></a><span id="l3.342" class="difflineminus">-</span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-  _initHiddenTags() {</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineminus">-    let pref = Services.prefs.getCharPref(this.hiddenTagsPref);</span>
<a href="#l3.345"></a><span id="l3.345" class="difflineminus">-    if (!pref) {</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-      return;</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-    }</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-    for (let tagId of pref.split(&quot;,&quot;)) {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-      this._hiddenTags[tagId] = TagsById[tagId];</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-    }</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-  },</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-  _initContacts() {</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-    if (this._contactsInitialized) {</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-      return;</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-    }</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-    this._observers = [];</span>
<a href="#l3.357"></a><span id="l3.357" class="difflineminus">-    this._observer = {</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-      self: this,</span>
<a href="#l3.359"></a><span id="l3.359" class="difflineminus">-      observe(aSubject, aTopic, aData) {</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-        if (aTopic == &quot;contact-moved-in&quot; &amp;&amp; !(aSubject instanceof Contact)) {</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-          return;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-        }</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineminus">-</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-        this.self.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-      },</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-    };</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    this._contacts = {};</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineminus">-    this._contactsInitialized = true;</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineminus">-    for (let id in this._hiddenTags) {</span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-      let tag = this._hiddenTags[id];</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-      this._hideTag(tag);</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-    }</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-    Services.obs.addObserver(this, &quot;contact-tag-added&quot;);</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-    Services.obs.addObserver(this, &quot;contact-tag-removed&quot;);</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-    Services.obs.addObserver(this, &quot;contact-added&quot;);</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-    Services.obs.addObserver(this, &quot;contact-removed&quot;);</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-  },</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-  // imITag implementation</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-  get id() {</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-    return -1;</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-  },</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-  get name() {</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-    return &quot;__others__&quot;;</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  },</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-  set name(aNewName) {</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineminus">-  },</span>
<a href="#l3.389"></a><span id="l3.389" class="difflineminus">-  getContacts() {</span>
<a href="#l3.390"></a><span id="l3.390" class="difflineminus">-    return Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l3.391"></a><span id="l3.391" class="difflineminus">-  },</span>
<a href="#l3.392"></a><span id="l3.392" class="difflineminus">-  _addContact(aContact) {</span>
<a href="#l3.393"></a><span id="l3.393" class="difflineminus">-    this._contacts[aContact.id] = aContact;</span>
<a href="#l3.394"></a><span id="l3.394" class="difflineminus">-    this.notifyObservers(aContact, &quot;contact-moved-in&quot;);</span>
<a href="#l3.395"></a><span id="l3.395" class="difflineminus">-    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-      observer.observe(this, &quot;contact-moved-in&quot;, null);</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-    }</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineminus">-    aContact.addObserver(this._observer);</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-  },</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-  _removeContact(aContact) {</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-    delete this._contacts[aContact.id];</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-    aContact.removeObserver(this._observer);</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineminus">-    this.notifyObservers(aContact, &quot;contact-moved-out&quot;);</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineminus">-    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-      observer.observe(this, &quot;contact-moved-out&quot;, null);</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-    }</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-  },</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-    }</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-  },</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-  },</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-    }</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-  },</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-};</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-var ContactsById = {};</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-var LastDummyContactId = 0;</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-function Contact(aId, aAlias) {</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-  // Assign a negative id to dummy contacts that have a single buddy</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-  this._id = aId || --LastDummyContactId;</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-  this._alias = aAlias;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-  this._tags = [];</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-  this._buddies = [];</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-  this._observers = [];</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-  ContactsById[this._id] = this;</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-}</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-Contact.prototype = {</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-  __proto__: ClassInfo(&quot;imIContact&quot;, &quot;Contact&quot;),</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-  _id: 0,</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-  get id() {</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-    return this._id;</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-  },</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-  get alias() {</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-    return this._alias;</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-  },</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-  set alias(aNewAlias) {</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-    this._ensureNotDummy();</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-      &quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-    );</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-    statement.params.alias = aNewAlias;</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-    statement.params.id = this._id;</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-    executeAsyncThenFinalize(statement);</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-    let oldDisplayName = this.displayName;</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-    this._alias = aNewAlias;</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-    this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-    for (let buddy of this._buddies) {</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineminus">-      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineminus">-        accountBuddy.serverAlias = aNewAlias;</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineminus">-      }</span>
<a href="#l3.462"></a><span id="l3.462" class="difflineminus">-    }</span>
<a href="#l3.463"></a><span id="l3.463" class="difflineminus">-    return aNewAlias;</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-  },</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineminus">-  _ensureNotDummy() {</span>
<a href="#l3.466"></a><span id="l3.466" class="difflineminus">-    if (this._id &gt;= 0) {</span>
<a href="#l3.467"></a><span id="l3.467" class="difflineminus">-      return;</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-    }</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-    // Create a real contact for this dummy contact</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineminus">-      &quot;INSERT INTO contacts DEFAULT VALUES&quot;</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-    );</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-    try {</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-      statement.execute();</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-    } finally {</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineminus">-    }</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineminus">-    delete ContactsById[this._id];</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-    let oldId = this._id;</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-    this._id = DBConn.lastInsertRowID;</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineminus">-    ContactsById[this._id] = this;</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineminus">-    this._notifyObservers(&quot;no-longer-dummy&quot;, oldId.toString());</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineminus">-    // Update the contact_id for the single existing buddy of this contact</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-      &quot;UPDATE buddies SET contact_id = :id WHERE id = :buddy_id&quot;</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-    );</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineminus">-    statement.params.id = this._id;</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineminus">-    statement.params.buddy_id = this._buddies[0].id;</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineminus">-    executeAsyncThenFinalize(statement);</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineminus">-  },</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineminus">-</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineminus">-  getTags() {</span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-    return this._tags;</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-  },</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-  addTag(aTag, aInherited) {</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-    if (this.hasTag(aTag)) {</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-      return;</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-    }</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-</span>
<a href="#l3.501"></a><span id="l3.501" class="difflineminus">-    if (!aInherited) {</span>
<a href="#l3.502"></a><span id="l3.502" class="difflineminus">-      this._ensureNotDummy();</span>
<a href="#l3.503"></a><span id="l3.503" class="difflineminus">-      let statement = DBConn.createStatement(</span>
<a href="#l3.504"></a><span id="l3.504" class="difflineminus">-        &quot;INSERT INTO contact_tag (contact_id, tag_id) &quot; +</span>
<a href="#l3.505"></a><span id="l3.505" class="difflineminus">-          &quot;VALUES(:contactId, :tagId)&quot;</span>
<a href="#l3.506"></a><span id="l3.506" class="difflineminus">-      );</span>
<a href="#l3.507"></a><span id="l3.507" class="difflineminus">-      statement.params.contactId = this.id;</span>
<a href="#l3.508"></a><span id="l3.508" class="difflineminus">-      statement.params.tagId = aTag.id;</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineminus">-      executeAsyncThenFinalize(statement);</span>
<a href="#l3.510"></a><span id="l3.510" class="difflineminus">-    }</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineminus">-    aTag = TagsById[aTag.id];</span>
<a href="#l3.513"></a><span id="l3.513" class="difflineminus">-    this._tags.push(aTag);</span>
<a href="#l3.514"></a><span id="l3.514" class="difflineminus">-    aTag._addContact(this);</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineminus">-    aTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l3.517"></a><span id="l3.517" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-      observer.observe(aTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-    }</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aTag.id);</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  },</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  /* Remove a tag from the local tags of the contact. */</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-  _removeTag(aTag) {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-    if (!this.hasTag(aTag) || this._isTagInherited(aTag)) {</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-      return;</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-    }</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-    this._removeContactTagRow(aTag);</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-    this._tags = this._tags.filter(tag =&gt; tag.id != aTag.id);</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-    aTag = TagsById[aTag.id];</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    aTag._removeContact(this);</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-    aTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l3.536"></a><span id="l3.536" class="difflineminus">-      observer.observe(aTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-    }</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aTag.id);</span>
<a href="#l3.539"></a><span id="l3.539" class="difflineminus">-  },</span>
<a href="#l3.540"></a><span id="l3.540" class="difflineminus">-  _removeContactTagRow(aTag) {</span>
<a href="#l3.541"></a><span id="l3.541" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-      &quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineminus">-        &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineminus">-        &quot;AND tag_id = :tagId&quot;</span>
<a href="#l3.545"></a><span id="l3.545" class="difflineminus">-    );</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-    statement.params.contactId = this.id;</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineminus">-    statement.params.tagId = aTag.id;</span>
<a href="#l3.548"></a><span id="l3.548" class="difflineminus">-    executeAsyncThenFinalize(statement);</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-  },</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineminus">-  hasTag(aTag) {</span>
<a href="#l3.551"></a><span id="l3.551" class="difflineminus">-    return this._tags.some(t =&gt; t.id == aTag.id);</span>
<a href="#l3.552"></a><span id="l3.552" class="difflineminus">-  },</span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-  _massMove: false,</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  removeTag(aTag) {</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-    if (!this.hasTag(aTag)) {</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-      throw new Error(</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-        &quot;Attempting to remove a tag that the contact doesn't have&quot;</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-      );</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-    }</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-    if (this._tags.length == 1) {</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-      throw new Error(&quot;Attempting to remove the last tag of a contact&quot;);</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-    }</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-    this._massMove = true;</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-    let hasTag = this.hasTag.bind(this);</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-    let newTag = this._tags[this._tags[0].id != aTag.id ? 0 : 1];</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-    let moved = false;</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-    this._buddies.forEach(function(aBuddy) {</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-      aBuddy._accounts.forEach(function(aAccountBuddy) {</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-        if (aAccountBuddy.tag.id == aTag.id) {</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-          if (</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-            aBuddy._accounts.some(</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-              ab =&gt;</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-                ab.account.numericId == aAccountBuddy.account.numericId &amp;&amp;</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-                ab.tag.id != aTag.id &amp;&amp;</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-                hasTag(ab.tag)</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-            )</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-          ) {</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-            // A buddy that already has an accountBuddy of the same</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-            // account with another tag of the contact shouldn't be</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-            // moved to newTag, just remove the accountBuddy</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-            // associated to the tag we are removing.</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-            aAccountBuddy.remove();</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-            moved = true;</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-          } else {</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-            try {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-              aAccountBuddy.tag = newTag;</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-              moved = true;</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-            } catch (e) {</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-              // Ignore failures. Some protocol plugins may not implement this.</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-            }</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-          }</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-        }</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-      });</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-    });</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-    this._massMove = false;</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-    if (moved) {</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-      this._moved(aTag, newTag);</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-    } else {</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-      // If we are here, the old tag is not inherited from a buddy, so</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-      // just remove the local tag.</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-      this._removeTag(aTag);</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-    }</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-  },</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-  _isTagInherited(aTag) {</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-    for (let buddy of this._buddies) {</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-        if (accountBuddy.tag.id == aTag.id) {</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-          return true;</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-        }</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-      }</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-    }</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-    return false;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-  },</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-  _moved(aOldTag, aNewTag) {</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-    if (this._massMove) {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-      return;</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-    }</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-    // Avoid xpconnect wrappers.</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-    aNewTag = aNewTag &amp;&amp; TagsById[aNewTag.id];</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-    aOldTag = aOldTag &amp;&amp; TagsById[aOldTag.id];</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-    // Decide what we need to do. Return early if nothing to do.</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-    let shouldRemove =</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-      aOldTag &amp;&amp; this.hasTag(aOldTag) &amp;&amp; !this._isTagInherited(aOldTag);</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-    let shouldAdd =</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-      aNewTag &amp;&amp; !this.hasTag(aNewTag) &amp;&amp; this._isTagInherited(aNewTag);</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-    if (!shouldRemove &amp;&amp; !shouldAdd) {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-      return;</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-    }</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-    // Apply the changes.</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-    let tags = this._tags;</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-    if (shouldRemove) {</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-      tags = tags.filter(aTag =&gt; aTag.id != aOldTag.id);</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-      aOldTag._removeContact(this);</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-    }</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-    if (shouldAdd) {</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-      tags.push(aNewTag);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-      aNewTag._addContact(this);</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-    }</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-    this._tags = tags;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-    // Finally, notify of the changes.</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-    if (shouldRemove) {</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-      aOldTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-      for (let observer of this._observers) {</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-        observer.observe(aOldTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-      }</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-      Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aOldTag.id);</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-    }</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-    if (shouldAdd) {</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-      aNewTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-      for (let observer of this._observers) {</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-        observer.observe(aNewTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-      }</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-      Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aNewTag.id);</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-    }</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;contact-moved&quot;);</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-  },</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-  getBuddies() {</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-    return this._buddies;</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-  },</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-  get _empty() {</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-    return this._buddies.length == 0 || this._buddies.every(b =&gt; b._empty);</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-  },</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-  mergeContact(aContact) {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-    // Avoid merging the contact with itself or merging into an</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-    // already removed contact.</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-    if (aContact.id == this.id || !(this.id in ContactsById)) {</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-    }</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-    this._ensureNotDummy();</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-    let contact = ContactsById[aContact.id]; // remove XPConnect wrapper</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-    // Copy all the contact-only tags first, otherwise they would be lost.</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-    for (let tag of contact.getTags()) {</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-      if (!contact._isTagInherited(tag)) {</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-        this.addTag(tag);</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-      }</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-    }</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-    // Adopt each buddy. Removing the last one will delete the contact.</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-    for (let buddy of contact.getBuddies()) {</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-      buddy.contact = this;</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-    }</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-    this._updatePreferredBuddy();</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-  },</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-  moveBuddyBefore(aBuddy, aBeforeBuddy) {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-    let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-    let oldPosition = this._buddies.indexOf(buddy);</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-    if (oldPosition == -1) {</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-      throw new Error(&quot;aBuddy isn't attached to this contact&quot;);</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-    }</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-    let newPosition = -1;</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-    if (aBeforeBuddy) {</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-      newPosition = this._buddies.indexOf(BuddiesById[aBeforeBuddy.id]);</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-    }</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-    if (newPosition == -1) {</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-      newPosition = this._buddies.length - 1;</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-    }</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-    if (oldPosition == newPosition) {</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-      return;</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-    }</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-    this._buddies.splice(oldPosition, 1);</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-    this._buddies.splice(newPosition, 0, buddy);</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-    this._updatePositions(</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-      Math.min(oldPosition, newPosition),</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-      Math.max(oldPosition, newPosition)</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-    );</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-    buddy._notifyObservers(&quot;position-changed&quot;, String(newPosition));</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-    this._updatePreferredBuddy(buddy);</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-  },</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-  adoptBuddy(aBuddy) {</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-    if (aBuddy.contact.id == this.id) {</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-    }</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-    let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-    buddy.contact = this;</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-    this._updatePreferredBuddy(buddy);</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-  },</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-  _massRemove: false,</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-  _removeBuddy(aBuddy) {</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-    if (this._buddies.length == 1) {</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-      if (this._id &gt; 0) {</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-        let statement = DBConn.createStatement(</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-          &quot;DELETE FROM contacts WHERE id = :id&quot;</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-        );</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-        statement.params.id = this._id;</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-        executeAsyncThenFinalize(statement);</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-      }</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-      this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-      delete ContactsById[this._id];</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-      for (let tag of this._tags) {</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-        tag._removeContact(this);</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-      }</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-      let statement = DBConn.createStatement(</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-        &quot;DELETE FROM contact_tag WHERE contact_id = :id&quot;</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-      );</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-      statement.params.id = this._id;</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-      executeAsyncThenFinalize(statement);</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-      delete this._tags;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-      delete this._buddies;</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-      delete this._observers;</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-    } else {</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-      let index = this._buddies.indexOf(aBuddy);</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-      if (index == -1) {</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-        throw new Error(&quot;Removing an unknown buddy from contact &quot; + this._id);</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-      }</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-      this._buddies = this._buddies.filter(b =&gt; b !== aBuddy);</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-      // If we are actually removing the whole contact, don't bother updating</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-      // the positions or the preferred buddy.</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-      if (this._massRemove) {</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-        return;</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-      }</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-      // No position to update if the removed buddy is at the last position.</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-      if (index &lt; this._buddies.length) {</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-        this._updatePositions(index);</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-      }</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-      if (this._preferredBuddy.id == aBuddy.id) {</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-        this._updatePreferredBuddy();</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-      }</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-    }</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-  },</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-  _updatePositions(aIndexBegin, aIndexEnd) {</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-    if (aIndexEnd === undefined) {</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-      aIndexEnd = this._buddies.length - 1;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-    }</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-    if (aIndexBegin &gt; aIndexEnd) {</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-      throw new Error(&quot;_updatePositions: Invalid indexes&quot;);</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-    }</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-      &quot;UPDATE buddies SET position = :position WHERE id = :buddyId&quot;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-    );</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-    for (let i = aIndexBegin; i &lt;= aIndexEnd; ++i) {</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-      statement.params.position = i;</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-      statement.params.buddyId = this._buddies[i].id;</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-      statement.executeAsync();</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-    }</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-    statement.finalize();</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-  },</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-  detachBuddy(aBuddy) {</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-    // Should return a new contact with the same list of tags.</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-    let buddy = BuddiesById[aBuddy.id];</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-    if (buddy.contact.id != this.id) {</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-    }</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-    if (buddy.contact._buddies.length == 1) {</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-    }</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-    // Save the list of tags, it may be destoyed if the buddy was the last one.</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-    let tags = buddy.contact.getTags();</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-    // Create a new dummy contact and use it for the detached buddy.</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-    buddy.contact = new Contact();</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-    buddy.contact._notifyObservers(&quot;added&quot;);</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-    // The first tag was inherited during the contact setter.</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-    // This will copy the remaining tags.</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-    for (let tag of tags) {</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-      buddy.contact.addTag(tag);</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-    }</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-    return buddy.contact;</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-  },</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-  remove() {</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-    this._massRemove = true;</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-    for (let buddy of this._buddies) {</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-      buddy.remove();</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-    }</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-  },</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-  // imIStatusInfo implementation</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-  _preferredBuddy: null,</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-  get preferredBuddy() {</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-    if (!this._preferredBuddy) {</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-      this._updatePreferredBuddy();</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-    }</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineminus">-    return this._preferredBuddy;</span>
<a href="#l3.837"></a><span id="l3.837" class="difflineminus">-  },</span>
<a href="#l3.838"></a><span id="l3.838" class="difflineminus">-  set preferredBuddy(aBuddy) {</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-    let shouldNotify = this._preferredBuddy != null;</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineminus">-    let oldDisplayName =</span>
<a href="#l3.841"></a><span id="l3.841" class="difflineminus">-      this._preferredBuddy &amp;&amp; this._preferredBuddy.displayName;</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-    this._preferredBuddy = aBuddy;</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineminus">-    if (shouldNotify) {</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineminus">-      this._notifyObservers(&quot;preferred-buddy-changed&quot;);</span>
<a href="#l3.845"></a><span id="l3.845" class="difflineminus">-    }</span>
<a href="#l3.846"></a><span id="l3.846" class="difflineminus">-    if (oldDisplayName &amp;&amp; this._preferredBuddy.displayName != oldDisplayName) {</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-      this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineminus">-    }</span>
<a href="#l3.849"></a><span id="l3.849" class="difflineminus">-    this._updateStatus();</span>
<a href="#l3.850"></a><span id="l3.850" class="difflineminus">-  },</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-  // aBuddy indicate which buddy's availability has changed.</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineminus">-  _updatePreferredBuddy(aBuddy) {</span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-    if (aBuddy) {</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-      aBuddy = BuddiesById[aBuddy.id]; // remove potential XPConnect wrapper</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-      if (!this._preferredBuddy) {</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-        this.preferredBuddy = aBuddy;</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-        return;</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-      }</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-      if (aBuddy.id == this._preferredBuddy.id) {</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-        // The suggested buddy is already preferred, check if its</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-        // availability has changed.</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-        if (</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-            aBuddy.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-        ) {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-          // keep the currently preferred buddy, only update the status.</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-          this._updateStatus();</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-          return;</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-        }</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-        // We aren't sure that the currently preferred buddy should</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-        // still be preferred. Let's go through the list!</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-      } else {</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-        // The suggested buddy is not currently preferred. If it is</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-        // more available or at a better position, prefer it!</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-        if (</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-            (aBuddy.availabilityDetails &gt; this._availabilityDetails ||</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-              (aBuddy.availabilityDetails == this._availabilityDetails &amp;&amp;</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-                this._buddies.indexOf(aBuddy) &lt;</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-                  this._buddies.indexOf(this.preferredBuddy))))</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-        ) {</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-          this.preferredBuddy = aBuddy;</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-        }</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-        return;</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-      }</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-    }</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-    let preferred;</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-    // |this._buddies| is ordered by user preference, so in case of</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-    // equal availability, keep the current value of |preferred|.</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-    for (let buddy of this._buddies) {</span>
<a href="#l3.896"></a><span id="l3.896" class="difflineminus">-      if (</span>
<a href="#l3.897"></a><span id="l3.897" class="difflineminus">-        !preferred ||</span>
<a href="#l3.898"></a><span id="l3.898" class="difflineminus">-        preferred.statusType &lt; buddy.statusType ||</span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-        (preferred.statusType == buddy.statusType &amp;&amp;</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineminus">-          preferred.availabilityDetails &lt; buddy.availabilityDetails)</span>
<a href="#l3.901"></a><span id="l3.901" class="difflineminus">-      ) {</span>
<a href="#l3.902"></a><span id="l3.902" class="difflineminus">-        preferred = buddy;</span>
<a href="#l3.903"></a><span id="l3.903" class="difflineminus">-      }</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineminus">-    }</span>
<a href="#l3.905"></a><span id="l3.905" class="difflineminus">-    if (</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-      preferred &amp;&amp;</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineminus">-      (!this._preferredBuddy || preferred.id != this._preferredBuddy.id)</span>
<a href="#l3.908"></a><span id="l3.908" class="difflineminus">-    ) {</span>
<a href="#l3.909"></a><span id="l3.909" class="difflineminus">-      this.preferredBuddy = preferred;</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-    }</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineminus">-  },</span>
<a href="#l3.912"></a><span id="l3.912" class="difflineminus">-  _updateStatus() {</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-    let buddy = this._preferredBuddy; // for convenience</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-    // Decide which notifications should be fired.</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-    let notifications = [];</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-    if (</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-      this._statusType != buddy.statusType ||</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-      this._availabilityDetails != buddy.availabilityDetails</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineminus">-    ) {</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineminus">-      notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineminus">-    }</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineminus">-    if (</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-      this._statusType != buddy.statusType ||</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-      this._statusText != buddy.statusText</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-    ) {</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">-      notifications.push(&quot;status-changed&quot;);</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-      if (this.online &amp;&amp; buddy.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-        notifications.push(&quot;signed-off&quot;);</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-      }</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-      if (!this.online &amp;&amp; buddy.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-        notifications.push(&quot;signed-on&quot;);</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-      }</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-    }</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-    // Actually change the stored status.</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-      buddy.statusType,</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-      buddy.statusText,</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-      buddy.availabilityDetails,</span>
<a href="#l3.941"></a><span id="l3.941" class="difflineminus">-    ];</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineminus">-    // Fire the notifications.</span>
<a href="#l3.944"></a><span id="l3.944" class="difflineminus">-    notifications.forEach(function(aTopic) {</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-      this._notifyObservers(aTopic);</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineminus">-    }, this);</span>
<a href="#l3.947"></a><span id="l3.947" class="difflineminus">-  },</span>
<a href="#l3.948"></a><span id="l3.948" class="difflineminus">-  get displayName() {</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineminus">-    return this._alias || this.preferredBuddy.displayName;</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-  },</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineminus">-  get buddyIconFilename() {</span>
<a href="#l3.952"></a><span id="l3.952" class="difflineminus">-    return this.preferredBuddy.buddyIconFilename;</span>
<a href="#l3.953"></a><span id="l3.953" class="difflineminus">-  },</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-  _statusType: 0,</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineminus">-  get statusType() {</span>
<a href="#l3.956"></a><span id="l3.956" class="difflineminus">-    return this._statusType;</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-  },</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-  get online() {</span>
<a href="#l3.959"></a><span id="l3.959" class="difflineminus">-    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l3.960"></a><span id="l3.960" class="difflineminus">-  },</span>
<a href="#l3.961"></a><span id="l3.961" class="difflineminus">-  get available() {</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineminus">-  },</span>
<a href="#l3.964"></a><span id="l3.964" class="difflineminus">-  get idle() {</span>
<a href="#l3.965"></a><span id="l3.965" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.966"></a><span id="l3.966" class="difflineminus">-  },</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-  get mobile() {</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l3.969"></a><span id="l3.969" class="difflineminus">-  },</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-  _statusText: &quot;&quot;,</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineminus">-  get statusText() {</span>
<a href="#l3.972"></a><span id="l3.972" class="difflineminus">-    return this._statusText;</span>
<a href="#l3.973"></a><span id="l3.973" class="difflineminus">-  },</span>
<a href="#l3.974"></a><span id="l3.974" class="difflineminus">-  _availabilityDetails: 0,</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-  get availabilityDetails() {</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-    return this._availabilityDetails;</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-  },</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-  get canSendMessage() {</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-    return this.preferredBuddy.canSendMessage;</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-  },</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-  // XXX should we list the buddies in the tooltip?</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-  getTooltipInfo() {</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    return this.preferredBuddy.getTooltipInfo();</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-  },</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-  createConversation() {</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-    let uiConv = Services.conversations.getUIConversationByContactId(this.id);</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-    if (uiConv) {</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-      return uiConv.target;</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-    }</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-    return this.preferredBuddy.createConversation();</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-  },</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-    }</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-  },</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_observers&quot;)) {</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-      return;</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-    }</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-  },</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-  // internal calls + calls from add-ons</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-      if (&quot;observe&quot; in observer) {</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-        // avoid failing on destructed XBL bindings...</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-        observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-      }</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-    }</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-    for (let tag of this._tags) {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-      tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-    }</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-    Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-  },</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-  _notifyObservers(aTopic, aData) {</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-    this.notifyObservers(this, &quot;contact-&quot; + aTopic, aData);</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-  },</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-  // This is called by the imIBuddy implementations.</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-  _observe(aSubject, aTopic, aData) {</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-    // Forward the notification.</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-    let isPreferredBuddy =</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-      aSubject instanceof Buddy &amp;&amp; aSubject.id == this.preferredBuddy.id;</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-    switch (aTopic) {</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-      case &quot;buddy-availability-changed&quot;:</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-        this._updatePreferredBuddy(aSubject);</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-        break;</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-      case &quot;buddy-status-changed&quot;:</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-        if (isPreferredBuddy) {</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-          this._updateStatus();</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-        }</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-        break;</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-      case &quot;buddy-display-name-changed&quot;:</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-        if (isPreferredBuddy &amp;&amp; !this._alias) {</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-          this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-        }</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-        break;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-      case &quot;buddy-icon-changed&quot;:</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-        if (isPreferredBuddy) {</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-          this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-        }</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-        break;</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-      case &quot;buddy-added&quot;:</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-        // Currently buddies are always added in dummy empty contacts,</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-        // later we may want to check this._buddies.length == 1.</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-        this._notifyObservers(&quot;added&quot;);</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-        break;</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-      case &quot;buddy-removed&quot;:</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-        this._removeBuddy(aSubject);</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-    }</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-  },</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-};</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-var BuddiesById = {};</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-function Buddy(aId, aKey, aName, aSrvAlias, aContactId) {</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-  this._id = aId;</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineminus">-  this._key = aKey;</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineminus">-  this._name = aName;</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-  if (aSrvAlias) {</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-    this._srvAlias = aSrvAlias;</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-  }</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-  this._accounts = [];</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-  this._observers = [];</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-  if (aContactId) {</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-    this._contact = ContactsById[aContactId];</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-  }</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-  // Avoid failure if aContactId was invalid.</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-  if (!this._contact) {</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-    this._contact = new Contact(null, null);</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-  }</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-  this._contact._buddies.push(this);</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-  BuddiesById[this._id] = this;</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-}</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-Buddy.prototype = {</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-  __proto__: ClassInfo(&quot;imIBuddy&quot;, &quot;Buddy&quot;),</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-  get id() {</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-    return this._id;</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-  },</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-  destroy() {</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-    for (let ab of this._accounts) {</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-      ab.unInit();</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-    }</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-    delete this._accounts;</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-    delete this._observers;</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineminus">-    delete this._preferredAccount;</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineminus">-  },</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-  get protocol() {</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-    return this._accounts[0].account.protocol;</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-  },</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineminus">-  get userName() {</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineminus">-    return this._name;</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineminus">-  },</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineminus">-  get normalizedName() {</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-    return this._key;</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-  },</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-  _srvAlias: &quot;&quot;,</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-  _contact: null,</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-  get contact() {</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-    return this._contact;</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-  },</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-  set contact(aContact) /* not in imIBuddy */ {</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-    if (aContact.id == this._contact.id) {</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineminus">-    }</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineminus">-</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-    this._notifyObservers(&quot;moved-out-of-contact&quot;);</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-    this._contact._removeBuddy(this);</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineminus">-</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineminus">-    this._contact = aContact;</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-    this._contact._buddies.push(this);</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">-</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineminus">-    // Ensure all the inherited tags are in the new contact.</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineminus">-    for (let accountBuddy of this._accounts) {</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">-      this._contact.addTag(TagsById[accountBuddy.tag.id], true);</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineminus">-    }</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineminus">-</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-      &quot;UPDATE buddies SET contact_id = :contactId, &quot; +</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineminus">-        &quot;position = :position &quot; +</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-        &quot;WHERE id = :buddyId&quot;</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-    );</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-    statement.params.contactId = aContact.id &gt; 0 ? aContact.id : 0;</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-    statement.params.position = aContact._buddies.length - 1;</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineminus">-    statement.params.buddyId = this.id;</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-    executeAsyncThenFinalize(statement);</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-    this._notifyObservers(&quot;moved-into-contact&quot;);</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-    return aContact;</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-  },</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-  _hasAccountBuddy(aAccountId, aTagId) {</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineminus">-    for (let ab of this._accounts) {</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineminus">-      if (ab.account.numericId == aAccountId &amp;&amp; ab.tag.id == aTagId) {</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-        return true;</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-      }</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-    }</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-    return false;</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-  },</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-  getAccountBuddies() {</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineminus">-    return this._accounts;</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-  },</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineminus">-  _addAccount(aAccountBuddy, aTag) {</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-    this._accounts.push(aAccountBuddy);</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineminus">-    let contact = this._contact;</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-    if (!this._contact._tags.includes(aTag)) {</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineminus">-      this._contact._tags.push(aTag);</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineminus">-      aTag._addContact(contact);</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-    }</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineminus">-</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-    if (!this._preferredAccount) {</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-      this._preferredAccount = aAccountBuddy;</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-    }</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-  },</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-  get _empty() {</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-    return this._accounts.length == 0;</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-  },</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-  remove() {</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineminus">-    for (let account of this._accounts) {</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-      account.remove();</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-    }</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-  },</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-  // imIStatusInfo implementation</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-  _preferredAccount: null,</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-  get preferredAccountBuddy() {</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-    return this._preferredAccount;</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineminus">-  },</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineminus">-  _isPreferredAccount(aAccountBuddy) {</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-    if (</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineminus">-      aAccountBuddy.account.numericId !=</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineminus">-      this._preferredAccount.account.numericId</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-    ) {</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineminus">-      return false;</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineminus">-    }</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineminus">-    // In case we have more than one accountBuddy for the same buddy</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineminus">-    // and account (possible if the buddy is in several groups on the</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-    // server), the protocol plugin may be broken and not update all</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineminus">-    // instances, so ensure we handle the notifications on the instance</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-    // that is currently being notified of a change:</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineminus">-    this._preferredAccount = aAccountBuddy;</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-    return true;</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-  },</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineminus">-  set preferredAccount(aAccount) {</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-    let oldDisplayName =</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">-      this._preferredAccount &amp;&amp; this._preferredAccount.displayName;</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">-    this._preferredAccount = aAccount;</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-    this._notifyObservers(&quot;preferred-account-changed&quot;);</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-    if (</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-      oldDisplayName &amp;&amp;</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-      this._preferredAccount.displayName != oldDisplayName</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineminus">-    ) {</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineminus">-      this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineminus">-    }</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineminus">-    this._updateStatus();</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-  },</span>
<a href="#l3.1207"></a><span id="l3.1207" class="difflineminus">-  // aAccount indicate which account's availability has changed.</span>
<a href="#l3.1208"></a><span id="l3.1208" class="difflineminus">-  _updatePreferredAccount(aAccount) {</span>
<a href="#l3.1209"></a><span id="l3.1209" class="difflineminus">-    if (aAccount) {</span>
<a href="#l3.1210"></a><span id="l3.1210" class="difflineminus">-      if (</span>
<a href="#l3.1211"></a><span id="l3.1211" class="difflineminus">-        aAccount.account.numericId == this._preferredAccount.account.numericId</span>
<a href="#l3.1212"></a><span id="l3.1212" class="difflineminus">-      ) {</span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-        // The suggested account is already preferred, check if its</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-        // availability has changed.</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineminus">-        if (</span>
<a href="#l3.1216"></a><span id="l3.1216" class="difflineminus">-          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l3.1217"></a><span id="l3.1217" class="difflineminus">-          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l3.1218"></a><span id="l3.1218" class="difflineminus">-            aAccount.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l3.1219"></a><span id="l3.1219" class="difflineminus">-        ) {</span>
<a href="#l3.1220"></a><span id="l3.1220" class="difflineminus">-          // keep the currently preferred account, only update the status.</span>
<a href="#l3.1221"></a><span id="l3.1221" class="difflineminus">-          this._updateStatus();</span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineminus">-          return;</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-        }</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineminus">-        // We aren't sure that the currently preferred account should</span>
<a href="#l3.1225"></a><span id="l3.1225" class="difflineminus">-        // still be preferred. Let's go through the list!</span>
<a href="#l3.1226"></a><span id="l3.1226" class="difflineminus">-      } else {</span>
<a href="#l3.1227"></a><span id="l3.1227" class="difflineminus">-        // The suggested account is not currently preferred. If it is</span>
<a href="#l3.1228"></a><span id="l3.1228" class="difflineminus">-        // more available, prefer it!</span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineminus">-        if (</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineminus">-          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l3.1232"></a><span id="l3.1232" class="difflineminus">-            aAccount.availabilityDetails &gt; this._availabilityDetails)</span>
<a href="#l3.1233"></a><span id="l3.1233" class="difflineminus">-        ) {</span>
<a href="#l3.1234"></a><span id="l3.1234" class="difflineminus">-          this.preferredAccount = aAccount;</span>
<a href="#l3.1235"></a><span id="l3.1235" class="difflineminus">-        }</span>
<a href="#l3.1236"></a><span id="l3.1236" class="difflineminus">-        return;</span>
<a href="#l3.1237"></a><span id="l3.1237" class="difflineminus">-      }</span>
<a href="#l3.1238"></a><span id="l3.1238" class="difflineminus">-    }</span>
<a href="#l3.1239"></a><span id="l3.1239" class="difflineminus">-</span>
<a href="#l3.1240"></a><span id="l3.1240" class="difflineminus">-    let preferred;</span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-    // TODO take into account the order of the account-manager list.</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineminus">-    for (let account of this._accounts) {</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineminus">-      if (</span>
<a href="#l3.1244"></a><span id="l3.1244" class="difflineminus">-        !preferred ||</span>
<a href="#l3.1245"></a><span id="l3.1245" class="difflineminus">-        preferred.statusType &lt; account.statusType ||</span>
<a href="#l3.1246"></a><span id="l3.1246" class="difflineminus">-        (preferred.statusType == account.statusType &amp;&amp;</span>
<a href="#l3.1247"></a><span id="l3.1247" class="difflineminus">-          preferred.availabilityDetails &lt; account.availabilityDetails)</span>
<a href="#l3.1248"></a><span id="l3.1248" class="difflineminus">-      ) {</span>
<a href="#l3.1249"></a><span id="l3.1249" class="difflineminus">-        preferred = account;</span>
<a href="#l3.1250"></a><span id="l3.1250" class="difflineminus">-      }</span>
<a href="#l3.1251"></a><span id="l3.1251" class="difflineminus">-    }</span>
<a href="#l3.1252"></a><span id="l3.1252" class="difflineminus">-    if (!this._preferredAccount) {</span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-      if (preferred) {</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineminus">-        this.preferredAccount = preferred;</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineminus">-      }</span>
<a href="#l3.1256"></a><span id="l3.1256" class="difflineminus">-      return;</span>
<a href="#l3.1257"></a><span id="l3.1257" class="difflineminus">-    }</span>
<a href="#l3.1258"></a><span id="l3.1258" class="difflineminus">-    if (</span>
<a href="#l3.1259"></a><span id="l3.1259" class="difflineminus">-      preferred.account.numericId != this._preferredAccount.account.numericId</span>
<a href="#l3.1260"></a><span id="l3.1260" class="difflineminus">-    ) {</span>
<a href="#l3.1261"></a><span id="l3.1261" class="difflineminus">-      this.preferredAccount = preferred;</span>
<a href="#l3.1262"></a><span id="l3.1262" class="difflineminus">-    } else {</span>
<a href="#l3.1263"></a><span id="l3.1263" class="difflineminus">-      this._updateStatus();</span>
<a href="#l3.1264"></a><span id="l3.1264" class="difflineminus">-    }</span>
<a href="#l3.1265"></a><span id="l3.1265" class="difflineminus">-  },</span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">-  _updateStatus() {</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-    let account = this._preferredAccount; // for convenience</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineminus">-</span>
<a href="#l3.1269"></a><span id="l3.1269" class="difflineminus">-    // Decide which notifications should be fired.</span>
<a href="#l3.1270"></a><span id="l3.1270" class="difflineminus">-    let notifications = [];</span>
<a href="#l3.1271"></a><span id="l3.1271" class="difflineminus">-    if (</span>
<a href="#l3.1272"></a><span id="l3.1272" class="difflineminus">-      this._statusType != account.statusType ||</span>
<a href="#l3.1273"></a><span id="l3.1273" class="difflineminus">-      this._availabilityDetails != account.availabilityDetails</span>
<a href="#l3.1274"></a><span id="l3.1274" class="difflineminus">-    ) {</span>
<a href="#l3.1275"></a><span id="l3.1275" class="difflineminus">-      notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-    }</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-    if (</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineminus">-      this._statusType != account.statusType ||</span>
<a href="#l3.1279"></a><span id="l3.1279" class="difflineminus">-      this._statusText != account.statusText</span>
<a href="#l3.1280"></a><span id="l3.1280" class="difflineminus">-    ) {</span>
<a href="#l3.1281"></a><span id="l3.1281" class="difflineminus">-      notifications.push(&quot;status-changed&quot;);</span>
<a href="#l3.1282"></a><span id="l3.1282" class="difflineminus">-      if (</span>
<a href="#l3.1283"></a><span id="l3.1283" class="difflineminus">-        this.online &amp;&amp;</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-        account.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineminus">-      ) {</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineminus">-        notifications.push(&quot;signed-off&quot;);</span>
<a href="#l3.1287"></a><span id="l3.1287" class="difflineminus">-      }</span>
<a href="#l3.1288"></a><span id="l3.1288" class="difflineminus">-      if (</span>
<a href="#l3.1289"></a><span id="l3.1289" class="difflineminus">-        !this.online &amp;&amp;</span>
<a href="#l3.1290"></a><span id="l3.1290" class="difflineminus">-        account.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l3.1291"></a><span id="l3.1291" class="difflineminus">-      ) {</span>
<a href="#l3.1292"></a><span id="l3.1292" class="difflineminus">-        notifications.push(&quot;signed-on&quot;);</span>
<a href="#l3.1293"></a><span id="l3.1293" class="difflineminus">-      }</span>
<a href="#l3.1294"></a><span id="l3.1294" class="difflineminus">-    }</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineminus">-</span>
<a href="#l3.1296"></a><span id="l3.1296" class="difflineminus">-    // Actually change the stored status.</span>
<a href="#l3.1297"></a><span id="l3.1297" class="difflineminus">-    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l3.1298"></a><span id="l3.1298" class="difflineminus">-      account.statusType,</span>
<a href="#l3.1299"></a><span id="l3.1299" class="difflineminus">-      account.statusText,</span>
<a href="#l3.1300"></a><span id="l3.1300" class="difflineminus">-      account.availabilityDetails,</span>
<a href="#l3.1301"></a><span id="l3.1301" class="difflineminus">-    ];</span>
<a href="#l3.1302"></a><span id="l3.1302" class="difflineminus">-</span>
<a href="#l3.1303"></a><span id="l3.1303" class="difflineminus">-    // Fire the notifications.</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineminus">-    notifications.forEach(function(aTopic) {</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineminus">-      this._notifyObservers(aTopic);</span>
<a href="#l3.1306"></a><span id="l3.1306" class="difflineminus">-    }, this);</span>
<a href="#l3.1307"></a><span id="l3.1307" class="difflineminus">-  },</span>
<a href="#l3.1308"></a><span id="l3.1308" class="difflineminus">-  get displayName() {</span>
<a href="#l3.1309"></a><span id="l3.1309" class="difflineminus">-    return (</span>
<a href="#l3.1310"></a><span id="l3.1310" class="difflineminus">-      (this._preferredAccount &amp;&amp; this._preferredAccount.displayName) ||</span>
<a href="#l3.1311"></a><span id="l3.1311" class="difflineminus">-      this._srvAlias ||</span>
<a href="#l3.1312"></a><span id="l3.1312" class="difflineminus">-      this._name</span>
<a href="#l3.1313"></a><span id="l3.1313" class="difflineminus">-    );</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineminus">-  },</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineminus">-  get buddyIconFilename() {</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineminus">-    return this._preferredAccount.buddyIconFilename;</span>
<a href="#l3.1317"></a><span id="l3.1317" class="difflineminus">-  },</span>
<a href="#l3.1318"></a><span id="l3.1318" class="difflineminus">-  _statusType: 0,</span>
<a href="#l3.1319"></a><span id="l3.1319" class="difflineminus">-  get statusType() {</span>
<a href="#l3.1320"></a><span id="l3.1320" class="difflineminus">-    return this._statusType;</span>
<a href="#l3.1321"></a><span id="l3.1321" class="difflineminus">-  },</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineminus">-  get online() {</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineminus">-    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineminus">-  },</span>
<a href="#l3.1325"></a><span id="l3.1325" class="difflineminus">-  get available() {</span>
<a href="#l3.1326"></a><span id="l3.1326" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l3.1327"></a><span id="l3.1327" class="difflineminus">-  },</span>
<a href="#l3.1328"></a><span id="l3.1328" class="difflineminus">-  get idle() {</span>
<a href="#l3.1329"></a><span id="l3.1329" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l3.1330"></a><span id="l3.1330" class="difflineminus">-  },</span>
<a href="#l3.1331"></a><span id="l3.1331" class="difflineminus">-  get mobile() {</span>
<a href="#l3.1332"></a><span id="l3.1332" class="difflineminus">-    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l3.1333"></a><span id="l3.1333" class="difflineminus">-  },</span>
<a href="#l3.1334"></a><span id="l3.1334" class="difflineminus">-  _statusText: &quot;&quot;,</span>
<a href="#l3.1335"></a><span id="l3.1335" class="difflineminus">-  get statusText() {</span>
<a href="#l3.1336"></a><span id="l3.1336" class="difflineminus">-    return this._statusText;</span>
<a href="#l3.1337"></a><span id="l3.1337" class="difflineminus">-  },</span>
<a href="#l3.1338"></a><span id="l3.1338" class="difflineminus">-  _availabilityDetails: 0,</span>
<a href="#l3.1339"></a><span id="l3.1339" class="difflineminus">-  get availabilityDetails() {</span>
<a href="#l3.1340"></a><span id="l3.1340" class="difflineminus">-    return this._availabilityDetails;</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-  },</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-  get canSendMessage() {</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineminus">-    return this._preferredAccount.canSendMessage;</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineminus">-  },</span>
<a href="#l3.1345"></a><span id="l3.1345" class="difflineminus">-  // XXX should we list the accounts in the tooltip?</span>
<a href="#l3.1346"></a><span id="l3.1346" class="difflineminus">-  getTooltipInfo() {</span>
<a href="#l3.1347"></a><span id="l3.1347" class="difflineminus">-    return this._preferredAccount.getTooltipInfo();</span>
<a href="#l3.1348"></a><span id="l3.1348" class="difflineminus">-  },</span>
<a href="#l3.1349"></a><span id="l3.1349" class="difflineminus">-  createConversation() {</span>
<a href="#l3.1350"></a><span id="l3.1350" class="difflineminus">-    return this._preferredAccount.createConversation();</span>
<a href="#l3.1351"></a><span id="l3.1351" class="difflineminus">-  },</span>
<a href="#l3.1352"></a><span id="l3.1352" class="difflineminus">-</span>
<a href="#l3.1353"></a><span id="l3.1353" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l3.1354"></a><span id="l3.1354" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l3.1355"></a><span id="l3.1355" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-    }</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineminus">-  },</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l3.1359"></a><span id="l3.1359" class="difflineminus">-    if (!this._observers) {</span>
<a href="#l3.1360"></a><span id="l3.1360" class="difflineminus">-      return;</span>
<a href="#l3.1361"></a><span id="l3.1361" class="difflineminus">-    }</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineminus">-  },</span>
<a href="#l3.1364"></a><span id="l3.1364" class="difflineminus">-  // internal calls + calls from add-ons</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineminus">-    try {</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineminus">-      for (let observer of this._observers) {</span>
<a href="#l3.1368"></a><span id="l3.1368" class="difflineminus">-        observer.observe(aSubject, aTopic, aData);</span>
<a href="#l3.1369"></a><span id="l3.1369" class="difflineminus">-      }</span>
<a href="#l3.1370"></a><span id="l3.1370" class="difflineminus">-      this._contact._observe(aSubject, aTopic, aData);</span>
<a href="#l3.1371"></a><span id="l3.1371" class="difflineminus">-    } catch (e) {</span>
<a href="#l3.1372"></a><span id="l3.1372" class="difflineminus">-      Cu.reportError(e);</span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-    }</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineminus">-  },</span>
<a href="#l3.1375"></a><span id="l3.1375" class="difflineminus">-  _notifyObservers(aTopic, aData) {</span>
<a href="#l3.1376"></a><span id="l3.1376" class="difflineminus">-    this.notifyObservers(this, &quot;buddy-&quot; + aTopic, aData);</span>
<a href="#l3.1377"></a><span id="l3.1377" class="difflineminus">-  },</span>
<a href="#l3.1378"></a><span id="l3.1378" class="difflineminus">-</span>
<a href="#l3.1379"></a><span id="l3.1379" class="difflineminus">-  // This is called by the prplIAccountBuddy implementations.</span>
<a href="#l3.1380"></a><span id="l3.1380" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.1381"></a><span id="l3.1381" class="difflineminus">-    // Forward the notification.</span>
<a href="#l3.1382"></a><span id="l3.1382" class="difflineminus">-    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l3.1383"></a><span id="l3.1383" class="difflineminus">-</span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineminus">-    switch (aTopic) {</span>
<a href="#l3.1385"></a><span id="l3.1385" class="difflineminus">-      case &quot;account-buddy-availability-changed&quot;:</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineminus">-        this._updatePreferredAccount(aSubject);</span>
<a href="#l3.1387"></a><span id="l3.1387" class="difflineminus">-        break;</span>
<a href="#l3.1388"></a><span id="l3.1388" class="difflineminus">-      case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l3.1389"></a><span id="l3.1389" class="difflineminus">-        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-          this._updateStatus();</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">-        }</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">-        break;</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">-      case &quot;account-buddy-display-name-changed&quot;:</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineminus">-        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineminus">-          this._srvAlias =</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineminus">-            this.displayName != this.userName ? this.displayName : &quot;&quot;;</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineminus">-          let statement = DBConn.createStatement(</span>
<a href="#l3.1398"></a><span id="l3.1398" class="difflineminus">-            &quot;UPDATE buddies SET srv_alias = :srvAlias WHERE id = :buddyId&quot;</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">-          );</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineminus">-          statement.params.buddyId = this.id;</span>
<a href="#l3.1401"></a><span id="l3.1401" class="difflineminus">-          statement.params.srvAlias = this._srvAlias;</span>
<a href="#l3.1402"></a><span id="l3.1402" class="difflineminus">-          executeAsyncThenFinalize(statement);</span>
<a href="#l3.1403"></a><span id="l3.1403" class="difflineminus">-          this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l3.1404"></a><span id="l3.1404" class="difflineminus">-        }</span>
<a href="#l3.1405"></a><span id="l3.1405" class="difflineminus">-        break;</span>
<a href="#l3.1406"></a><span id="l3.1406" class="difflineminus">-      case &quot;account-buddy-icon-changed&quot;:</span>
<a href="#l3.1407"></a><span id="l3.1407" class="difflineminus">-        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l3.1408"></a><span id="l3.1408" class="difflineminus">-          this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l3.1409"></a><span id="l3.1409" class="difflineminus">-        }</span>
<a href="#l3.1410"></a><span id="l3.1410" class="difflineminus">-        break;</span>
<a href="#l3.1411"></a><span id="l3.1411" class="difflineminus">-      case &quot;account-buddy-added&quot;:</span>
<a href="#l3.1412"></a><span id="l3.1412" class="difflineminus">-        if (this._accounts.length == 0) {</span>
<a href="#l3.1413"></a><span id="l3.1413" class="difflineminus">-          // Add the new account in the empty buddy instance.</span>
<a href="#l3.1414"></a><span id="l3.1414" class="difflineminus">-          // The TagsById hack is to bypass the xpconnect wrapper.</span>
<a href="#l3.1415"></a><span id="l3.1415" class="difflineminus">-          this._addAccount(aSubject, TagsById[aSubject.tag.id]);</span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineminus">-          this._updateStatus();</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-          this._notifyObservers(&quot;added&quot;);</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineminus">-        } else {</span>
<a href="#l3.1419"></a><span id="l3.1419" class="difflineminus">-          this._accounts.push(aSubject);</span>
<a href="#l3.1420"></a><span id="l3.1420" class="difflineminus">-          this.contact._moved(null, aSubject.tag);</span>
<a href="#l3.1421"></a><span id="l3.1421" class="difflineminus">-          this._updatePreferredAccount(aSubject);</span>
<a href="#l3.1422"></a><span id="l3.1422" class="difflineminus">-        }</span>
<a href="#l3.1423"></a><span id="l3.1423" class="difflineminus">-        break;</span>
<a href="#l3.1424"></a><span id="l3.1424" class="difflineminus">-      case &quot;account-buddy-removed&quot;:</span>
<a href="#l3.1425"></a><span id="l3.1425" class="difflineminus">-        if (this._accounts.length == 1) {</span>
<a href="#l3.1426"></a><span id="l3.1426" class="difflineminus">-          let statement = DBConn.createStatement(</span>
<a href="#l3.1427"></a><span id="l3.1427" class="difflineminus">-            &quot;DELETE FROM buddies WHERE id = :id&quot;</span>
<a href="#l3.1428"></a><span id="l3.1428" class="difflineminus">-          );</span>
<a href="#l3.1429"></a><span id="l3.1429" class="difflineminus">-          try {</span>
<a href="#l3.1430"></a><span id="l3.1430" class="difflineminus">-            statement.params.id = this.id;</span>
<a href="#l3.1431"></a><span id="l3.1431" class="difflineminus">-            statement.execute();</span>
<a href="#l3.1432"></a><span id="l3.1432" class="difflineminus">-          } finally {</span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineminus">-            statement.finalize();</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-          }</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineminus">-          this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l3.1436"></a><span id="l3.1436" class="difflineminus">-</span>
<a href="#l3.1437"></a><span id="l3.1437" class="difflineminus">-          delete BuddiesById[this._id];</span>
<a href="#l3.1438"></a><span id="l3.1438" class="difflineminus">-          this.destroy();</span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineminus">-        } else {</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-          this._accounts = this._accounts.filter(function(ab) {</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineminus">-            return (</span>
<a href="#l3.1442"></a><span id="l3.1442" class="difflineminus">-              ab.account.numericId != aSubject.account.numericId ||</span>
<a href="#l3.1443"></a><span id="l3.1443" class="difflineminus">-              ab.tag.id != aSubject.tag.id</span>
<a href="#l3.1444"></a><span id="l3.1444" class="difflineminus">-            );</span>
<a href="#l3.1445"></a><span id="l3.1445" class="difflineminus">-          });</span>
<a href="#l3.1446"></a><span id="l3.1446" class="difflineminus">-          if (</span>
<a href="#l3.1447"></a><span id="l3.1447" class="difflineminus">-            this._preferredAccount.account.numericId ==</span>
<a href="#l3.1448"></a><span id="l3.1448" class="difflineminus">-              aSubject.account.numericId &amp;&amp;</span>
<a href="#l3.1449"></a><span id="l3.1449" class="difflineminus">-            this._preferredAccount.tag.id == aSubject.tag.id</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineminus">-          ) {</span>
<a href="#l3.1451"></a><span id="l3.1451" class="difflineminus">-            this._preferredAccount = null;</span>
<a href="#l3.1452"></a><span id="l3.1452" class="difflineminus">-            this._updatePreferredAccount();</span>
<a href="#l3.1453"></a><span id="l3.1453" class="difflineminus">-          }</span>
<a href="#l3.1454"></a><span id="l3.1454" class="difflineminus">-          this.contact._moved(aSubject.tag);</span>
<a href="#l3.1455"></a><span id="l3.1455" class="difflineminus">-        }</span>
<a href="#l3.1456"></a><span id="l3.1456" class="difflineminus">-        break;</span>
<a href="#l3.1457"></a><span id="l3.1457" class="difflineminus">-    }</span>
<a href="#l3.1458"></a><span id="l3.1458" class="difflineminus">-  },</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-};</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineminus">-</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineminus">-function ContactsService() {}</span>
<a href="#l3.1462"></a><span id="l3.1462" class="difflineminus">-ContactsService.prototype = {</span>
<a href="#l3.1463"></a><span id="l3.1463" class="difflineminus">-  initContacts() {</span>
<a href="#l3.1464"></a><span id="l3.1464" class="difflineminus">-    let statement = DBConn.createStatement(&quot;SELECT id, name FROM tags&quot;);</span>
<a href="#l3.1465"></a><span id="l3.1465" class="difflineminus">-    try {</span>
<a href="#l3.1466"></a><span id="l3.1466" class="difflineminus">-      while (statement.executeStep()) {</span>
<a href="#l3.1467"></a><span id="l3.1467" class="difflineminus">-        Tags.push(new Tag(statement.getInt32(0), statement.getUTF8String(1)));</span>
<a href="#l3.1468"></a><span id="l3.1468" class="difflineminus">-      }</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">-    } finally {</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineminus">-    }</span>
<a href="#l3.1472"></a><span id="l3.1472" class="difflineminus">-</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineminus">-    statement = DBConn.createStatement(&quot;SELECT id, alias FROM contacts&quot;);</span>
<a href="#l3.1474"></a><span id="l3.1474" class="difflineminus">-    try {</span>
<a href="#l3.1475"></a><span id="l3.1475" class="difflineminus">-      while (statement.executeStep()) {</span>
<a href="#l3.1476"></a><span id="l3.1476" class="difflineminus">-        new Contact(statement.getInt32(0), statement.getUTF8String(1));</span>
<a href="#l3.1477"></a><span id="l3.1477" class="difflineminus">-      }</span>
<a href="#l3.1478"></a><span id="l3.1478" class="difflineminus">-    } finally {</span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-    }</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineminus">-</span>
<a href="#l3.1482"></a><span id="l3.1482" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.1483"></a><span id="l3.1483" class="difflineminus">-      &quot;SELECT contact_id, tag_id FROM contact_tag&quot;</span>
<a href="#l3.1484"></a><span id="l3.1484" class="difflineminus">-    );</span>
<a href="#l3.1485"></a><span id="l3.1485" class="difflineminus">-    try {</span>
<a href="#l3.1486"></a><span id="l3.1486" class="difflineminus">-      while (statement.executeStep()) {</span>
<a href="#l3.1487"></a><span id="l3.1487" class="difflineminus">-        let contact = ContactsById[statement.getInt32(0)];</span>
<a href="#l3.1488"></a><span id="l3.1488" class="difflineminus">-        let tag = TagsById[statement.getInt32(1)];</span>
<a href="#l3.1489"></a><span id="l3.1489" class="difflineminus">-        contact._tags.push(tag);</span>
<a href="#l3.1490"></a><span id="l3.1490" class="difflineminus">-        tag._addContact(contact);</span>
<a href="#l3.1491"></a><span id="l3.1491" class="difflineminus">-      }</span>
<a href="#l3.1492"></a><span id="l3.1492" class="difflineminus">-    } finally {</span>
<a href="#l3.1493"></a><span id="l3.1493" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1494"></a><span id="l3.1494" class="difflineminus">-    }</span>
<a href="#l3.1495"></a><span id="l3.1495" class="difflineminus">-</span>
<a href="#l3.1496"></a><span id="l3.1496" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.1497"></a><span id="l3.1497" class="difflineminus">-      &quot;SELECT id, key, name, srv_alias, contact_id FROM buddies ORDER BY position&quot;</span>
<a href="#l3.1498"></a><span id="l3.1498" class="difflineminus">-    );</span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineminus">-    try {</span>
<a href="#l3.1500"></a><span id="l3.1500" class="difflineminus">-      while (statement.executeStep()) {</span>
<a href="#l3.1501"></a><span id="l3.1501" class="difflineminus">-        new Buddy(</span>
<a href="#l3.1502"></a><span id="l3.1502" class="difflineminus">-          statement.getInt32(0),</span>
<a href="#l3.1503"></a><span id="l3.1503" class="difflineminus">-          statement.getUTF8String(1),</span>
<a href="#l3.1504"></a><span id="l3.1504" class="difflineminus">-          statement.getUTF8String(2),</span>
<a href="#l3.1505"></a><span id="l3.1505" class="difflineminus">-          statement.getUTF8String(3),</span>
<a href="#l3.1506"></a><span id="l3.1506" class="difflineminus">-          statement.getInt32(4)</span>
<a href="#l3.1507"></a><span id="l3.1507" class="difflineminus">-        );</span>
<a href="#l3.1508"></a><span id="l3.1508" class="difflineminus">-        // FIXME is there a way to enforce that all AccountBuddies of a Buddy have the same protocol?</span>
<a href="#l3.1509"></a><span id="l3.1509" class="difflineminus">-      }</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineminus">-    } finally {</span>
<a href="#l3.1511"></a><span id="l3.1511" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1512"></a><span id="l3.1512" class="difflineminus">-    }</span>
<a href="#l3.1513"></a><span id="l3.1513" class="difflineminus">-</span>
<a href="#l3.1514"></a><span id="l3.1514" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.1515"></a><span id="l3.1515" class="difflineminus">-      &quot;SELECT account_id, buddy_id, tag_id FROM account_buddy&quot;</span>
<a href="#l3.1516"></a><span id="l3.1516" class="difflineminus">-    );</span>
<a href="#l3.1517"></a><span id="l3.1517" class="difflineminus">-    try {</span>
<a href="#l3.1518"></a><span id="l3.1518" class="difflineminus">-      while (statement.executeStep()) {</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-        let accountId = statement.getInt32(0);</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineminus">-        let buddyId = statement.getInt32(1);</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineminus">-        let tagId = statement.getInt32(2);</span>
<a href="#l3.1522"></a><span id="l3.1522" class="difflineminus">-</span>
<a href="#l3.1523"></a><span id="l3.1523" class="difflineminus">-        if (!BuddiesById.hasOwnProperty(buddyId)) {</span>
<a href="#l3.1524"></a><span id="l3.1524" class="difflineminus">-          Cu.reportError(</span>
<a href="#l3.1525"></a><span id="l3.1525" class="difflineminus">-            &quot;Corrupted database: account_buddy entry for account &quot; +</span>
<a href="#l3.1526"></a><span id="l3.1526" class="difflineminus">-              accountId +</span>
<a href="#l3.1527"></a><span id="l3.1527" class="difflineminus">-              &quot; and tag &quot; +</span>
<a href="#l3.1528"></a><span id="l3.1528" class="difflineminus">-              tagId +</span>
<a href="#l3.1529"></a><span id="l3.1529" class="difflineminus">-              &quot; references unknown buddy with id &quot; +</span>
<a href="#l3.1530"></a><span id="l3.1530" class="difflineminus">-              buddyId</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineminus">-          );</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineminus">-          continue;</span>
<a href="#l3.1533"></a><span id="l3.1533" class="difflineminus">-        }</span>
<a href="#l3.1534"></a><span id="l3.1534" class="difflineminus">-</span>
<a href="#l3.1535"></a><span id="l3.1535" class="difflineminus">-        let buddy = BuddiesById[buddyId];</span>
<a href="#l3.1536"></a><span id="l3.1536" class="difflineminus">-        if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l3.1537"></a><span id="l3.1537" class="difflineminus">-          Cu.reportError(</span>
<a href="#l3.1538"></a><span id="l3.1538" class="difflineminus">-            &quot;Corrupted database: duplicated account_buddy entry: &quot; +</span>
<a href="#l3.1539"></a><span id="l3.1539" class="difflineminus">-              &quot;account_id = &quot; +</span>
<a href="#l3.1540"></a><span id="l3.1540" class="difflineminus">-              accountId +</span>
<a href="#l3.1541"></a><span id="l3.1541" class="difflineminus">-              &quot;, buddy_id = &quot; +</span>
<a href="#l3.1542"></a><span id="l3.1542" class="difflineminus">-              buddyId +</span>
<a href="#l3.1543"></a><span id="l3.1543" class="difflineminus">-              &quot;, tag_id = &quot; +</span>
<a href="#l3.1544"></a><span id="l3.1544" class="difflineminus">-              tagId</span>
<a href="#l3.1545"></a><span id="l3.1545" class="difflineminus">-          );</span>
<a href="#l3.1546"></a><span id="l3.1546" class="difflineminus">-          continue;</span>
<a href="#l3.1547"></a><span id="l3.1547" class="difflineminus">-        }</span>
<a href="#l3.1548"></a><span id="l3.1548" class="difflineminus">-</span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineminus">-        let account = Services.accounts.getAccountByNumericId(accountId);</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineminus">-        let tag = TagsById[tagId];</span>
<a href="#l3.1551"></a><span id="l3.1551" class="difflineminus">-        try {</span>
<a href="#l3.1552"></a><span id="l3.1552" class="difflineminus">-          buddy._addAccount(account.loadBuddy(buddy, tag), tag);</span>
<a href="#l3.1553"></a><span id="l3.1553" class="difflineminus">-        } catch (e) {</span>
<a href="#l3.1554"></a><span id="l3.1554" class="difflineminus">-          Cu.reportError(e);</span>
<a href="#l3.1555"></a><span id="l3.1555" class="difflineminus">-          dump(e + &quot;\n&quot;);</span>
<a href="#l3.1556"></a><span id="l3.1556" class="difflineminus">-        }</span>
<a href="#l3.1557"></a><span id="l3.1557" class="difflineminus">-      }</span>
<a href="#l3.1558"></a><span id="l3.1558" class="difflineminus">-    } finally {</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1560"></a><span id="l3.1560" class="difflineminus">-    }</span>
<a href="#l3.1561"></a><span id="l3.1561" class="difflineminus">-    otherContactsTag._initHiddenTags();</span>
<a href="#l3.1562"></a><span id="l3.1562" class="difflineminus">-  },</span>
<a href="#l3.1563"></a><span id="l3.1563" class="difflineminus">-  unInitContacts() {</span>
<a href="#l3.1564"></a><span id="l3.1564" class="difflineminus">-    Tags = [];</span>
<a href="#l3.1565"></a><span id="l3.1565" class="difflineminus">-    TagsById = {};</span>
<a href="#l3.1566"></a><span id="l3.1566" class="difflineminus">-    // Avoid shutdown leaks caused by references to native components</span>
<a href="#l3.1567"></a><span id="l3.1567" class="difflineminus">-    // implementing prplIAccountBuddy.</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineminus">-    for (let buddyId in BuddiesById) {</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineminus">-      let buddy = BuddiesById[buddyId];</span>
<a href="#l3.1570"></a><span id="l3.1570" class="difflineminus">-      buddy.destroy();</span>
<a href="#l3.1571"></a><span id="l3.1571" class="difflineminus">-    }</span>
<a href="#l3.1572"></a><span id="l3.1572" class="difflineminus">-    BuddiesById = {};</span>
<a href="#l3.1573"></a><span id="l3.1573" class="difflineminus">-    ContactsById = {};</span>
<a href="#l3.1574"></a><span id="l3.1574" class="difflineminus">-  },</span>
<a href="#l3.1575"></a><span id="l3.1575" class="difflineminus">-</span>
<a href="#l3.1576"></a><span id="l3.1576" class="difflineminus">-  getContactById: aId =&gt; ContactsById[aId],</span>
<a href="#l3.1577"></a><span id="l3.1577" class="difflineminus">-  // Get an array of all existing contacts.</span>
<a href="#l3.1578"></a><span id="l3.1578" class="difflineminus">-  getContacts() {</span>
<a href="#l3.1579"></a><span id="l3.1579" class="difflineminus">-    return Object.keys(ContactsById)</span>
<a href="#l3.1580"></a><span id="l3.1580" class="difflineminus">-      .filter(id =&gt; !ContactsById[id]._empty)</span>
<a href="#l3.1581"></a><span id="l3.1581" class="difflineminus">-      .map(id =&gt; ContactsById[id]);</span>
<a href="#l3.1582"></a><span id="l3.1582" class="difflineminus">-  },</span>
<a href="#l3.1583"></a><span id="l3.1583" class="difflineminus">-  getBuddyById: aId =&gt; BuddiesById[aId],</span>
<a href="#l3.1584"></a><span id="l3.1584" class="difflineminus">-  getBuddyByNameAndProtocol(aNormalizedName, aPrpl) {</span>
<a href="#l3.1585"></a><span id="l3.1585" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1586"></a><span id="l3.1586" class="difflineminus">-      &quot;SELECT b.id FROM buddies b &quot; +</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineminus">-        &quot;JOIN account_buddy ab ON buddy_id = b.id &quot; +</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineminus">-        &quot;JOIN accounts a ON account_id = a.id &quot; +</span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineminus">-        &quot;WHERE b.key = :buddyName and a.prpl = :prplId&quot;</span>
<a href="#l3.1590"></a><span id="l3.1590" class="difflineminus">-    );</span>
<a href="#l3.1591"></a><span id="l3.1591" class="difflineminus">-    statement.params.buddyName = aNormalizedName;</span>
<a href="#l3.1592"></a><span id="l3.1592" class="difflineminus">-    statement.params.prplId = aPrpl.id;</span>
<a href="#l3.1593"></a><span id="l3.1593" class="difflineminus">-    try {</span>
<a href="#l3.1594"></a><span id="l3.1594" class="difflineminus">-      if (!statement.executeStep()) {</span>
<a href="#l3.1595"></a><span id="l3.1595" class="difflineminus">-        return null;</span>
<a href="#l3.1596"></a><span id="l3.1596" class="difflineminus">-      }</span>
<a href="#l3.1597"></a><span id="l3.1597" class="difflineminus">-      return BuddiesById[statement.row.id];</span>
<a href="#l3.1598"></a><span id="l3.1598" class="difflineminus">-    } finally {</span>
<a href="#l3.1599"></a><span id="l3.1599" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1600"></a><span id="l3.1600" class="difflineminus">-    }</span>
<a href="#l3.1601"></a><span id="l3.1601" class="difflineminus">-  },</span>
<a href="#l3.1602"></a><span id="l3.1602" class="difflineminus">-  getAccountBuddyByNameAndAccount(aNormalizedName, aAccount) {</span>
<a href="#l3.1603"></a><span id="l3.1603" class="difflineminus">-    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l3.1604"></a><span id="l3.1604" class="difflineminus">-      aNormalizedName,</span>
<a href="#l3.1605"></a><span id="l3.1605" class="difflineminus">-      aAccount.protocol</span>
<a href="#l3.1606"></a><span id="l3.1606" class="difflineminus">-    );</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineminus">-    if (buddy) {</span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineminus">-      let id = aAccount.id;</span>
<a href="#l3.1609"></a><span id="l3.1609" class="difflineminus">-      for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l3.1610"></a><span id="l3.1610" class="difflineminus">-        if (accountBuddy.account.id == id) {</span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineminus">-          return accountBuddy;</span>
<a href="#l3.1612"></a><span id="l3.1612" class="difflineminus">-        }</span>
<a href="#l3.1613"></a><span id="l3.1613" class="difflineminus">-      }</span>
<a href="#l3.1614"></a><span id="l3.1614" class="difflineminus">-    }</span>
<a href="#l3.1615"></a><span id="l3.1615" class="difflineminus">-    return null;</span>
<a href="#l3.1616"></a><span id="l3.1616" class="difflineminus">-  },</span>
<a href="#l3.1617"></a><span id="l3.1617" class="difflineminus">-</span>
<a href="#l3.1618"></a><span id="l3.1618" class="difflineminus">-  accountBuddyAdded(aAccountBuddy) {</span>
<a href="#l3.1619"></a><span id="l3.1619" class="difflineminus">-    let account = aAccountBuddy.account;</span>
<a href="#l3.1620"></a><span id="l3.1620" class="difflineminus">-    let normalizedName = aAccountBuddy.normalizedName;</span>
<a href="#l3.1621"></a><span id="l3.1621" class="difflineminus">-    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineminus">-      normalizedName,</span>
<a href="#l3.1623"></a><span id="l3.1623" class="difflineminus">-      account.protocol</span>
<a href="#l3.1624"></a><span id="l3.1624" class="difflineminus">-    );</span>
<a href="#l3.1625"></a><span id="l3.1625" class="difflineminus">-    if (!buddy) {</span>
<a href="#l3.1626"></a><span id="l3.1626" class="difflineminus">-      let statement = DBConn.createStatement(</span>
<a href="#l3.1627"></a><span id="l3.1627" class="difflineminus">-        &quot;INSERT INTO buddies &quot; +</span>
<a href="#l3.1628"></a><span id="l3.1628" class="difflineminus">-          &quot;(key, name, srv_alias, position) &quot; +</span>
<a href="#l3.1629"></a><span id="l3.1629" class="difflineminus">-          &quot;VALUES(:key, :name, :srvAlias, 0)&quot;</span>
<a href="#l3.1630"></a><span id="l3.1630" class="difflineminus">-      );</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineminus">-      try {</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineminus">-        let name = aAccountBuddy.userName;</span>
<a href="#l3.1633"></a><span id="l3.1633" class="difflineminus">-        let srvAlias = aAccountBuddy.serverAlias;</span>
<a href="#l3.1634"></a><span id="l3.1634" class="difflineminus">-        statement.params.key = normalizedName;</span>
<a href="#l3.1635"></a><span id="l3.1635" class="difflineminus">-        statement.params.name = name;</span>
<a href="#l3.1636"></a><span id="l3.1636" class="difflineminus">-        statement.params.srvAlias = srvAlias;</span>
<a href="#l3.1637"></a><span id="l3.1637" class="difflineminus">-        statement.execute();</span>
<a href="#l3.1638"></a><span id="l3.1638" class="difflineminus">-        buddy = new Buddy(</span>
<a href="#l3.1639"></a><span id="l3.1639" class="difflineminus">-          DBConn.lastInsertRowID,</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-          normalizedName,</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineminus">-          name,</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineminus">-          srvAlias,</span>
<a href="#l3.1643"></a><span id="l3.1643" class="difflineminus">-          0</span>
<a href="#l3.1644"></a><span id="l3.1644" class="difflineminus">-        );</span>
<a href="#l3.1645"></a><span id="l3.1645" class="difflineminus">-      } finally {</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineminus">-        statement.finalize();</span>
<a href="#l3.1647"></a><span id="l3.1647" class="difflineminus">-      }</span>
<a href="#l3.1648"></a><span id="l3.1648" class="difflineminus">-    }</span>
<a href="#l3.1649"></a><span id="l3.1649" class="difflineminus">-</span>
<a href="#l3.1650"></a><span id="l3.1650" class="difflineminus">-    // Initialize the 'buddy' field of the prplIAccountBuddy instance.</span>
<a href="#l3.1651"></a><span id="l3.1651" class="difflineminus">-    aAccountBuddy.buddy = buddy;</span>
<a href="#l3.1652"></a><span id="l3.1652" class="difflineminus">-</span>
<a href="#l3.1653"></a><span id="l3.1653" class="difflineminus">-    // Ensure we aren't storing a duplicate entry.</span>
<a href="#l3.1654"></a><span id="l3.1654" class="difflineminus">-    let accountId = account.numericId;</span>
<a href="#l3.1655"></a><span id="l3.1655" class="difflineminus">-    let tagId = aAccountBuddy.tag.id;</span>
<a href="#l3.1656"></a><span id="l3.1656" class="difflineminus">-    if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l3.1657"></a><span id="l3.1657" class="difflineminus">-      Cu.reportError(</span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineminus">-        &quot;Attempting to store a duplicate account buddy &quot; +</span>
<a href="#l3.1659"></a><span id="l3.1659" class="difflineminus">-          normalizedName +</span>
<a href="#l3.1660"></a><span id="l3.1660" class="difflineminus">-          &quot;, account id = &quot; +</span>
<a href="#l3.1661"></a><span id="l3.1661" class="difflineminus">-          accountId +</span>
<a href="#l3.1662"></a><span id="l3.1662" class="difflineminus">-          &quot;, tag id = &quot; +</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineminus">-          tagId</span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineminus">-      );</span>
<a href="#l3.1665"></a><span id="l3.1665" class="difflineminus">-      return;</span>
<a href="#l3.1666"></a><span id="l3.1666" class="difflineminus">-    }</span>
<a href="#l3.1667"></a><span id="l3.1667" class="difflineminus">-</span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-    // Store the new account buddy.</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineminus">-      &quot;INSERT INTO account_buddy &quot; +</span>
<a href="#l3.1671"></a><span id="l3.1671" class="difflineminus">-        &quot;(account_id, buddy_id, tag_id) &quot; +</span>
<a href="#l3.1672"></a><span id="l3.1672" class="difflineminus">-        &quot;VALUES(:accountId, :buddyId, :tagId)&quot;</span>
<a href="#l3.1673"></a><span id="l3.1673" class="difflineminus">-    );</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineminus">-    try {</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineminus">-      statement.params.accountId = accountId;</span>
<a href="#l3.1676"></a><span id="l3.1676" class="difflineminus">-      statement.params.buddyId = buddy.id;</span>
<a href="#l3.1677"></a><span id="l3.1677" class="difflineminus">-      statement.params.tagId = tagId;</span>
<a href="#l3.1678"></a><span id="l3.1678" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineminus">-    } finally {</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineminus">-    }</span>
<a href="#l3.1682"></a><span id="l3.1682" class="difflineminus">-</span>
<a href="#l3.1683"></a><span id="l3.1683" class="difflineminus">-    // Fire the notifications.</span>
<a href="#l3.1684"></a><span id="l3.1684" class="difflineminus">-    buddy.observe(aAccountBuddy, &quot;account-buddy-added&quot;);</span>
<a href="#l3.1685"></a><span id="l3.1685" class="difflineminus">-  },</span>
<a href="#l3.1686"></a><span id="l3.1686" class="difflineminus">-  accountBuddyRemoved(aAccountBuddy) {</span>
<a href="#l3.1687"></a><span id="l3.1687" class="difflineminus">-    let buddy = aAccountBuddy.buddy;</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineminus">-      &quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l3.1690"></a><span id="l3.1690" class="difflineminus">-        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l3.1691"></a><span id="l3.1691" class="difflineminus">-        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l3.1692"></a><span id="l3.1692" class="difflineminus">-        &quot;tag_id = :tagId&quot;</span>
<a href="#l3.1693"></a><span id="l3.1693" class="difflineminus">-    );</span>
<a href="#l3.1694"></a><span id="l3.1694" class="difflineminus">-    try {</span>
<a href="#l3.1695"></a><span id="l3.1695" class="difflineminus">-      statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l3.1696"></a><span id="l3.1696" class="difflineminus">-      statement.params.buddyId = buddy.id;</span>
<a href="#l3.1697"></a><span id="l3.1697" class="difflineminus">-      statement.params.tagId = aAccountBuddy.tag.id;</span>
<a href="#l3.1698"></a><span id="l3.1698" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1699"></a><span id="l3.1699" class="difflineminus">-    } finally {</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineminus">-    }</span>
<a href="#l3.1702"></a><span id="l3.1702" class="difflineminus">-</span>
<a href="#l3.1703"></a><span id="l3.1703" class="difflineminus">-    buddy.observe(aAccountBuddy, &quot;account-buddy-removed&quot;);</span>
<a href="#l3.1704"></a><span id="l3.1704" class="difflineminus">-  },</span>
<a href="#l3.1705"></a><span id="l3.1705" class="difflineminus">-</span>
<a href="#l3.1706"></a><span id="l3.1706" class="difflineminus">-  accountBuddyMoved(aAccountBuddy, aOldTag, aNewTag) {</span>
<a href="#l3.1707"></a><span id="l3.1707" class="difflineminus">-    let buddy = aAccountBuddy.buddy;</span>
<a href="#l3.1708"></a><span id="l3.1708" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1709"></a><span id="l3.1709" class="difflineminus">-      &quot;UPDATE account_buddy &quot; +</span>
<a href="#l3.1710"></a><span id="l3.1710" class="difflineminus">-        &quot;SET tag_id = :newTagId &quot; +</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineminus">-        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l3.1712"></a><span id="l3.1712" class="difflineminus">-        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l3.1713"></a><span id="l3.1713" class="difflineminus">-        &quot;tag_id = :oldTagId&quot;</span>
<a href="#l3.1714"></a><span id="l3.1714" class="difflineminus">-    );</span>
<a href="#l3.1715"></a><span id="l3.1715" class="difflineminus">-    try {</span>
<a href="#l3.1716"></a><span id="l3.1716" class="difflineminus">-      statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l3.1717"></a><span id="l3.1717" class="difflineminus">-      statement.params.buddyId = buddy.id;</span>
<a href="#l3.1718"></a><span id="l3.1718" class="difflineminus">-      statement.params.oldTagId = aOldTag.id;</span>
<a href="#l3.1719"></a><span id="l3.1719" class="difflineminus">-      statement.params.newTagId = aNewTag.id;</span>
<a href="#l3.1720"></a><span id="l3.1720" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1721"></a><span id="l3.1721" class="difflineminus">-    } finally {</span>
<a href="#l3.1722"></a><span id="l3.1722" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1723"></a><span id="l3.1723" class="difflineminus">-    }</span>
<a href="#l3.1724"></a><span id="l3.1724" class="difflineminus">-</span>
<a href="#l3.1725"></a><span id="l3.1725" class="difflineminus">-    let contact = ContactsById[buddy.contact.id];</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineminus">-</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineminus">-    // aNewTag is now inherited by the contact from an account buddy, so avoid</span>
<a href="#l3.1728"></a><span id="l3.1728" class="difflineminus">-    // keeping direct tag &lt;-&gt; contact links in the contact_tag table.</span>
<a href="#l3.1729"></a><span id="l3.1729" class="difflineminus">-    contact._removeContactTagRow(aNewTag);</span>
<a href="#l3.1730"></a><span id="l3.1730" class="difflineminus">-</span>
<a href="#l3.1731"></a><span id="l3.1731" class="difflineminus">-    buddy.observe(aAccountBuddy, &quot;account-buddy-moved&quot;);</span>
<a href="#l3.1732"></a><span id="l3.1732" class="difflineminus">-    contact._moved(aOldTag, aNewTag);</span>
<a href="#l3.1733"></a><span id="l3.1733" class="difflineminus">-  },</span>
<a href="#l3.1734"></a><span id="l3.1734" class="difflineminus">-</span>
<a href="#l3.1735"></a><span id="l3.1735" class="difflineminus">-  storeAccount(aId, aUserName, aPrplId) {</span>
<a href="#l3.1736"></a><span id="l3.1736" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineminus">-      &quot;SELECT name, prpl FROM accounts WHERE id = :id&quot;</span>
<a href="#l3.1738"></a><span id="l3.1738" class="difflineminus">-    );</span>
<a href="#l3.1739"></a><span id="l3.1739" class="difflineminus">-    statement.params.id = aId;</span>
<a href="#l3.1740"></a><span id="l3.1740" class="difflineminus">-    try {</span>
<a href="#l3.1741"></a><span id="l3.1741" class="difflineminus">-      if (statement.executeStep()) {</span>
<a href="#l3.1742"></a><span id="l3.1742" class="difflineminus">-        if (</span>
<a href="#l3.1743"></a><span id="l3.1743" class="difflineminus">-          statement.getUTF8String(0) == aUserName &amp;&amp;</span>
<a href="#l3.1744"></a><span id="l3.1744" class="difflineminus">-          statement.getUTF8String(1) == aPrplId</span>
<a href="#l3.1745"></a><span id="l3.1745" class="difflineminus">-        ) {</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineminus">-          // The account is already stored correctly.</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-          return;</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineminus">-        }</span>
<a href="#l3.1749"></a><span id="l3.1749" class="difflineminus">-        throw Cr.NS_ERROR_UNEXPECTED; // Corrupted database?!?</span>
<a href="#l3.1750"></a><span id="l3.1750" class="difflineminus">-      }</span>
<a href="#l3.1751"></a><span id="l3.1751" class="difflineminus">-    } finally {</span>
<a href="#l3.1752"></a><span id="l3.1752" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1753"></a><span id="l3.1753" class="difflineminus">-    }</span>
<a href="#l3.1754"></a><span id="l3.1754" class="difflineminus">-</span>
<a href="#l3.1755"></a><span id="l3.1755" class="difflineminus">-    // Actually store the account.</span>
<a href="#l3.1756"></a><span id="l3.1756" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.1757"></a><span id="l3.1757" class="difflineminus">-      &quot;INSERT INTO accounts (id, name, prpl) &quot; +</span>
<a href="#l3.1758"></a><span id="l3.1758" class="difflineminus">-        &quot;VALUES(:id, :userName, :prplId)&quot;</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineminus">-    );</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineminus">-    try {</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineminus">-      statement.params.id = aId;</span>
<a href="#l3.1762"></a><span id="l3.1762" class="difflineminus">-      statement.params.userName = aUserName;</span>
<a href="#l3.1763"></a><span id="l3.1763" class="difflineminus">-      statement.params.prplId = aPrplId;</span>
<a href="#l3.1764"></a><span id="l3.1764" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1765"></a><span id="l3.1765" class="difflineminus">-    } finally {</span>
<a href="#l3.1766"></a><span id="l3.1766" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1767"></a><span id="l3.1767" class="difflineminus">-    }</span>
<a href="#l3.1768"></a><span id="l3.1768" class="difflineminus">-  },</span>
<a href="#l3.1769"></a><span id="l3.1769" class="difflineminus">-  accountIdExists(aId) {</span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1771"></a><span id="l3.1771" class="difflineminus">-      &quot;SELECT id FROM accounts WHERE id = :id&quot;</span>
<a href="#l3.1772"></a><span id="l3.1772" class="difflineminus">-    );</span>
<a href="#l3.1773"></a><span id="l3.1773" class="difflineminus">-    try {</span>
<a href="#l3.1774"></a><span id="l3.1774" class="difflineminus">-      statement.params.id = aId;</span>
<a href="#l3.1775"></a><span id="l3.1775" class="difflineminus">-      return statement.executeStep();</span>
<a href="#l3.1776"></a><span id="l3.1776" class="difflineminus">-    } finally {</span>
<a href="#l3.1777"></a><span id="l3.1777" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1778"></a><span id="l3.1778" class="difflineminus">-    }</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineminus">-  },</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineminus">-  forgetAccount(aId) {</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineminus">-    let statement = DBConn.createStatement(</span>
<a href="#l3.1782"></a><span id="l3.1782" class="difflineminus">-      &quot;DELETE FROM accounts WHERE id = :accountId&quot;</span>
<a href="#l3.1783"></a><span id="l3.1783" class="difflineminus">-    );</span>
<a href="#l3.1784"></a><span id="l3.1784" class="difflineminus">-    try {</span>
<a href="#l3.1785"></a><span id="l3.1785" class="difflineminus">-      statement.params.accountId = aId;</span>
<a href="#l3.1786"></a><span id="l3.1786" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1787"></a><span id="l3.1787" class="difflineminus">-    } finally {</span>
<a href="#l3.1788"></a><span id="l3.1788" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1789"></a><span id="l3.1789" class="difflineminus">-    }</span>
<a href="#l3.1790"></a><span id="l3.1790" class="difflineminus">-</span>
<a href="#l3.1791"></a><span id="l3.1791" class="difflineminus">-    // removing the account from the accounts table is not enough,</span>
<a href="#l3.1792"></a><span id="l3.1792" class="difflineminus">-    // we need to remove all the associated account_buddy entries too</span>
<a href="#l3.1793"></a><span id="l3.1793" class="difflineminus">-    statement = DBConn.createStatement(</span>
<a href="#l3.1794"></a><span id="l3.1794" class="difflineminus">-      &quot;DELETE FROM account_buddy WHERE account_id = :accountId&quot;</span>
<a href="#l3.1795"></a><span id="l3.1795" class="difflineminus">-    );</span>
<a href="#l3.1796"></a><span id="l3.1796" class="difflineminus">-    try {</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineminus">-      statement.params.accountId = aId;</span>
<a href="#l3.1798"></a><span id="l3.1798" class="difflineminus">-      statement.execute();</span>
<a href="#l3.1799"></a><span id="l3.1799" class="difflineminus">-    } finally {</span>
<a href="#l3.1800"></a><span id="l3.1800" class="difflineminus">-      statement.finalize();</span>
<a href="#l3.1801"></a><span id="l3.1801" class="difflineminus">-    }</span>
<a href="#l3.1802"></a><span id="l3.1802" class="difflineminus">-  },</span>
<a href="#l3.1803"></a><span id="l3.1803" class="difflineminus">-</span>
<a href="#l3.1804"></a><span id="l3.1804" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imIContactsService]),</span>
<a href="#l3.1805"></a><span id="l3.1805" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">deleted file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- a/chat/components/src/IMConversations.jsm</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ /dev/null</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -1,836 +0,0 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineminus">-</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;ConversationsService&quot;, &quot;IMMessage&quot;, &quot;UIConversation&quot;];</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-var { XPCOMUtils, nsSimpleEnumerator, ClassInfo } = ChromeUtils.import(</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-);</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-var { Message } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-var gLastUIConvId = 0;</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineminus">-var gLastPrplConvId = 0;</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, () =&gt;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  Services.strings.createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-);</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineminus">-function OutgoingMessage(aMsg, aConversation) {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-  this.message = aMsg;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  this.conversation = aConversation;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-}</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineminus">-OutgoingMessage.prototype = {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineminus">-  __proto__: ClassInfo(&quot;imIOutgoingMessage&quot;, &quot;Outgoing Message&quot;),</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  cancelled: false,</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-  action: false,</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-};</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-function IMMessage(aPrplMessage) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  this.prplMessage = aPrplMessage;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-}</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-IMMessage.prototype = {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  __proto__: ClassInfo([&quot;imIMessage&quot;, &quot;prplIMessage&quot;], &quot;IM Message&quot;),</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-  cancelled: false,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-  color: &quot;&quot;,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  _displayMessage: null,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  encrypted: false,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-  get displayMessage() {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-    // Explicitly test for null so that blank messages don't fall back to</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-    // the original. Especially problematic in encryption extensions like OTR.</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-    return this._displayMessage !== null</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineminus">-      ? this._displayMessage</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-      : this.prplMessage.originalMessage;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineminus">-  },</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-  set displayMessage(aMsg) {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-    this._displayMessage = aMsg;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  },</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  get message() {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-    return this.prplMessage.message;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-  },</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-  set message(aMsg) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-    this.prplMessage.message = aMsg;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-  },</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineminus">-</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineminus">-  // from prplIMessage</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineminus">-  get who() {</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-    return this.prplMessage.who;</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineminus">-  },</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-  get time() {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-    return this.prplMessage.time;</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineminus">-  },</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineminus">-  get id() {</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    return this.prplMessage.id;</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  },</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineminus">-  get alias() {</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    return this.prplMessage.alias;</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-  },</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-  get iconURL() {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    return this.prplMessage.iconURL;</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-  },</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-  get conversation() {</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-    return this.prplMessage.conversation;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-  },</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-  set conversation(aConv) {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-    this.prplMessage.conversation = aConv;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-  },</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-  get outgoing() {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineminus">-    return this.prplMessage.outgoing;</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-  },</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-  get incoming() {</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-    return this.prplMessage.incoming;</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineminus">-  },</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  get system() {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    return this.prplMessage.system;</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  },</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  get autoResponse() {</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    return this.prplMessage.autoResponse;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineminus">-  },</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-  get containsNick() {</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-    return this.prplMessage.containsNick;</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  },</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-  get noLog() {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-    return this.prplMessage.noLog;</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineminus">-  },</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineminus">-  get error() {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineminus">-    return this.prplMessage.error;</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineminus">-  },</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-  get delayed() {</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    return this.prplMessage.delayed;</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-  },</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineminus">-  get noFormat() {</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineminus">-    return this.prplMessage.noFormat;</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineminus">-  },</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineminus">-  get containsImages() {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-    return this.prplMessage.containsImages;</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineminus">-  },</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  get notification() {</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    return this.prplMessage.notification;</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-  },</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-  get noLinkification() {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-    return this.prplMessage.noLinkification;</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-  },</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-  get originalMessage() {</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    return this.prplMessage.originalMessage;</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineminus">-  },</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-  getActions() {</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-    return this.prplMessage.getActions();</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-  },</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-};</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineminus">-</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineminus">-function UIConversation(aPrplConversation) {</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-  this._prplConv = {};</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineminus">-  this.id = ++gLastUIConvId;</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineminus">-  this._observers = [];</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineminus">-  this._messages = [];</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineminus">-  this.changeTargetTo(aPrplConversation);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-  let iface = Ci[&quot;prplIConv&quot; + (aPrplConversation.isChat ? &quot;Chat&quot; : &quot;IM&quot;)];</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineminus">-  this._interfaces = this._interfaces.concat(iface);</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-  // XPConnect will create a wrapper around 'this' after here,</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineminus">-  // so the list of exposed interfaces shouldn't change anymore.</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineminus">-  this.updateContactObserver();</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineminus">-  Services.obs.notifyObservers(this, &quot;new-ui-conversation&quot;);</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineminus">-}</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-UIConversation.prototype = {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-  __proto__: ClassInfo(</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-    [&quot;imIConversation&quot;, &quot;prplIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-    &quot;UI conversation&quot;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  ),</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-  _observedContact: null,</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineminus">-  get contact() {</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineminus">-    let target = this.target;</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-    if (!target.isChat &amp;&amp; target.buddy) {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-      return target.buddy.buddy.contact;</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-    }</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-    return null;</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-  },</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-  updateContactObserver() {</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-    let contact = this.contact;</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineminus">-    if (contact &amp;&amp; !this._observedContact) {</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineminus">-      contact.addObserver(this);</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineminus">-      this._observedContact = contact;</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineminus">-    } else if (!contact &amp;&amp; this.observedContact) {</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineminus">-      this._observedContact.removeObserver(this);</span>
<a href="#l4.163"></a><span id="l4.163" class="difflineminus">-      delete this._observedContact;</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineminus">-    }</span>
<a href="#l4.165"></a><span id="l4.165" class="difflineminus">-  },</span>
<a href="#l4.166"></a><span id="l4.166" class="difflineminus">-  get target() {</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-    return this._prplConv[this._currentTargetId];</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-  },</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-  set target(aPrplConversation) {</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-    this.changeTargetTo(aPrplConversation);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineminus">-  },</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineminus">-  get hasMultipleTargets() {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-    return Object.keys(this._prplConv).length &gt; 1;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-  },</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-  getTargetByAccount(aAccount) {</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-    let accountId = aAccount.id;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-    for (let id in this._prplConv) {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-      let prplConv = this._prplConv[id];</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-      if (prplConv.account.id == accountId) {</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-        return prplConv;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-      }</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-    }</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-    return null;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineminus">-  },</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineminus">-  _currentTargetId: 0,</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineminus">-  changeTargetTo(aPrplConversation) {</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineminus">-    let id = aPrplConversation.id;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineminus">-    if (this._currentTargetId == id) {</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineminus">-      return;</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineminus">-    }</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-    if (!(id in this._prplConv)) {</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-      this._prplConv[id] = aPrplConversation;</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-      aPrplConversation.addObserver(this.observeConv.bind(this, id));</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-    }</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-    let shouldNotify = this._currentTargetId;</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-    this._currentTargetId = id;</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-    if (!this.isChat) {</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-      let buddy = this.buddy;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-      if (buddy) {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-        ({ statusType: this.statusType, statusText: this.statusText } = buddy);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-      }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-    }</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-    if (shouldNotify) {</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-      this.notifyObservers(this, &quot;target-prpl-conversation-changed&quot;);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineminus">-      let target = this.target;</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineminus">-      let params = [target.title, target.account.protocol.name];</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineminus">-      this.systemMessage(bundle.formatStringFromName(&quot;targetChanged&quot;, params));</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineminus">-    }</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-  },</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-  // Returns a boolean indicating if the ui-conversation was closed.</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineminus">-  // If the conversation was closed, aContactId.value is set to the contact id</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineminus">-  // or 0 if no contact was associated with the conversation.</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineminus">-  removeTarget(aPrplConversation, aContactId) {</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineminus">-    let id = aPrplConversation.id;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-    if (!(id in this._prplConv)) {</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineminus">-      throw new Error(&quot;unknown prpl conversation&quot;);</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-    }</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineminus">-</span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-    delete this._prplConv[id];</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-    if (this._currentTargetId != id) {</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-      return false;</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-    }</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-    for (let newId in this._prplConv) {</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-      this.changeTargetTo(this._prplConv[newId]);</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-      return false;</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-    }</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-    if (this._observedContact) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-      this._observedContact.removeObserver(this);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-      aContactId.value = this._observedContact.id;</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-      delete this._observedContact;</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-    } else {</span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-      aContactId.value = 0;</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-    }</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-    delete this._currentTargetId;</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-    this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-    return true;</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-  },</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-  _unreadMessageCount: 0,</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-  get unreadMessageCount() {</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-    return this._unreadMessageCount;</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-  },</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-  _unreadTargetedMessageCount: 0,</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-  get unreadTargetedMessageCount() {</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    return this._unreadTargetedMessageCount;</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-  },</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-  _unreadIncomingMessageCount: 0,</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-  get unreadIncomingMessageCount() {</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-    return this._unreadIncomingMessageCount;</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-  },</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-  markAsRead() {</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-    delete this._unreadMessageCount;</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-    delete this._unreadTargetedMessageCount;</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-    delete this._unreadIncomingMessageCount;</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineminus">-    this._notifyUnreadCountChanged();</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineminus">-  },</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineminus">-  _lastNotifiedUnreadCount: 0,</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineminus">-  _notifyUnreadCountChanged() {</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-    if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount) {</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineminus">-      return;</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-    }</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineminus">-    this._lastNotifiedUnreadCount = this._unreadIncomingMessageCount;</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineminus">-      observer.observe(</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineminus">-        this,</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-        &quot;unread-message-count-changed&quot;,</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineminus">-        this._unreadIncomingMessageCount.toString()</span>
<a href="#l4.274"></a><span id="l4.274" class="difflineminus">-      );</span>
<a href="#l4.275"></a><span id="l4.275" class="difflineminus">-    }</span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-  },</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-  getMessages() {</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-    return this._messages;</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-  },</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineminus">-  checkClose() {</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineminus">-    if (!this._currentTargetId) {</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineminus">-      // Already closed.</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-      return true;</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineminus">-    }</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineminus">-</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineminus">-    if (</span>
<a href="#l4.287"></a><span id="l4.287" class="difflineminus">-      !Services.prefs.getBoolPref(&quot;messenger.conversations.alwaysClose&quot;) &amp;&amp;</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-      ((this.isChat &amp;&amp; !this.left) ||</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-        (!this.isChat &amp;&amp;</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineminus">-          (this.unreadIncomingMessageCount != 0 ||</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-            Services.prefs.getBoolPref(</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-              &quot;messenger.conversations.holdByDefault&quot;</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-            ))))</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineminus">-    ) {</span>
<a href="#l4.295"></a><span id="l4.295" class="difflineminus">-      return false;</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineminus">-    }</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineminus">-</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineminus">-    this.close();</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-    return true;</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-  },</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-    if (aTopic == &quot;contact-no-longer-dummy&quot;) {</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-      let oldId = parseInt(aData);</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-      // gConversationsService is ugly... :(</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-      delete gConversationsService._uiConvByContactId[oldId];</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-      gConversationsService._uiConvByContactId[aSubject.id] = this;</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-    } else if (aTopic == &quot;account-buddy-status-changed&quot;) {</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-      if (</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineminus">-        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineminus">-        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineminus">-      ) {</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineminus">-        this._statusUpdatePending = true;</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineminus">-        Services.tm.mainThread.dispatch(</span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-          this.updateBuddyStatus.bind(this),</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-        );</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-      }</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineminus">-    } else if (aTopic == &quot;account-buddy-icon-changed&quot;) {</span>
<a href="#l4.321"></a><span id="l4.321" class="difflineminus">-      if (</span>
<a href="#l4.322"></a><span id="l4.322" class="difflineminus">-        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l4.323"></a><span id="l4.323" class="difflineminus">-        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-      ) {</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineminus">-        this._iconUpdatePending = true;</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-        Services.tm.mainThread.dispatch(</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-          this.updateIcon.bind(this),</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-        );</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-      }</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-    } else if (</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-      aTopic == &quot;account-buddy-display-name-changed&quot; &amp;&amp;</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-      aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-      aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-    ) {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-      this.notifyObservers(this, &quot;update-buddy-display-name&quot;);</span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-    }</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-  },</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-  _iconUpdatePending: false,</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-  updateIcon() {</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-    delete this._iconUpdatePending;</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineminus">-    this.notifyObservers(this, &quot;update-buddy-icon&quot;);</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineminus">-  },</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-  _statusUpdatePending: false,</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-  updateBuddyStatus() {</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-    delete this._statusUpdatePending;</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineminus">-    let { statusType: statusType, statusText: statusText } = this.buddy;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineminus">-</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineminus">-    if (</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineminus">-      &quot;statusType&quot; in this &amp;&amp;</span>
<a href="#l4.354"></a><span id="l4.354" class="difflineminus">-      this.statusType == statusType &amp;&amp;</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-      this.statusText == statusText</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-    ) {</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-      return;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-    }</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineminus">-    let wasUnknown = this.statusType == Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineminus">-    this.statusType = statusType;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineminus">-    this.statusText = statusText;</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineminus">-</span>
<a href="#l4.364"></a><span id="l4.364" class="difflineminus">-    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-    let msg;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-    if (statusType == Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-      msg = bundle.formatStringFromName(&quot;statusUnknown&quot;, [this.title]);</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineminus">-    } else {</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineminus">-      let status = Status.toLabel(statusType);</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineminus">-      let stringId = wasUnknown ? &quot;statusChangedFromUnknown&quot; : &quot;statusChanged&quot;;</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineminus">-      if (this._justReconnected) {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineminus">-        stringId = &quot;statusKnown&quot;;</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineminus">-        delete this._justReconnected;</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-      }</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-      if (statusText) {</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-        msg = bundle.formatStringFromName(stringId + &quot;WithStatusText&quot;, [</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-          this.title,</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-          status,</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-          statusText,</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-        ]);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineminus">-      } else {</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-        msg = bundle.formatStringFromName(stringId, [this.title, status]);</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-      }</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineminus">-    }</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineminus">-    this.systemMessage(msg);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineminus">-  },</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineminus">-</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineminus">-  _disconnected: false,</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineminus">-  disconnecting() {</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineminus">-    if (this._disconnected) {</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineminus">-      return;</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineminus">-    }</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-    this._disconnected = true;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-    if (this.contact) {</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-      // Handled by the contact observer.</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-      return;</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-    }</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-    if (this.isChat &amp;&amp; this.left) {</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-      this._wasLeft = true;</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineminus">-    } else {</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineminus">-      this.systemMessage(bundle.GetStringFromName(&quot;accountDisconnected&quot;));</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineminus">-    }</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineminus">-    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineminus">-  },</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineminus">-  connected() {</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineminus">-    if (this._disconnected) {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineminus">-      delete this._disconnected;</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineminus">-      let msg = bundle.GetStringFromName(&quot;accountReconnected&quot;);</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineminus">-      if (this.isChat) {</span>
<a href="#l4.413"></a><span id="l4.413" class="difflineminus">-        if (!this._wasLeft) {</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-          this.systemMessage(msg);</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineminus">-          // Reconnect chat if possible.</span>
<a href="#l4.416"></a><span id="l4.416" class="difflineminus">-          let chatRoomFields = this.target.chatRoomFields;</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-          if (chatRoomFields) {</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-            this.account.joinChat(chatRoomFields);</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-          }</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-        }</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-        delete this._wasLeft;</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-      } else {</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-        this._justReconnected = true;</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineminus">-        // Exclude convs with contacts, these receive presence info updates</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineminus">-        // (and therefore a reconnected message).</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-        if (!this.contact) {</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-          this.systemMessage(msg);</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-        }</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-      }</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-    }</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-  },</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-  observeConv(aTargetId, aSubject, aTopic, aData) {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-    if (</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineminus">-      aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-      (aTopic == &quot;new-text&quot; ||</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-        (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-          this._prplConv[aTargetId].typingState == Ci.prplIConvIM.TYPING))</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-    ) {</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-      this.target = this._prplConv[aTargetId];</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-    }</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-  },</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-  systemMessage(aText, aIsError) {</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-    let flags = { system: true, noLog: true, error: !!aIsError };</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-    new Message(&quot;system&quot;, aText, flags).conversation = this;</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-  },</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-  // prplIConversation</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-  get isChat() {</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-    return this.target.isChat;</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-  },</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-  get account() {</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-    return this.target.account;</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineminus">-  },</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-  get name() {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-    return this.target.name;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-  },</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-  get normalizedName() {</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-    return this.target.normalizedName;</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-  },</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-  get title() {</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-    return this.target.title;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-  },</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-  get startDate() {</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-    return this.target.startDate;</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-  },</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-    // Add-ons (eg. pastebin) have an opportunity to cancel the message at this</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-    // point, or change the text content of the message.</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-    // If an add-on wants to split a message, it should truncate the first</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-    // message, and insert new messages using the conversation's sendMsg method.</span>
<a href="#l4.476"></a><span id="l4.476" class="difflineminus">-    let om = new OutgoingMessage(aMsg, this);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineminus">-    this.notifyObservers(om, &quot;preparing-message&quot;);</span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-    if (om.cancelled) {</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-      return;</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-    }</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineminus">-    // Protocols have an opportunity here to preprocess messages before they are</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineminus">-    // sent (eg. split long messages). If a message is split here, the split</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineminus">-    // will be visible in the UI.</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineminus">-    let messages = this.target.prepareForSending(om);</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-    // Protocols can return null if they don't need to make any changes.</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineminus">-    // (nb. passing null with retval array results in an empty array)</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-    if (!messages || !messages.length) {</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-      messages = [om.message];</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-    }</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineminus">-    for (let msg of messages) {</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineminus">-      // Add-ons (eg. OTR) have an opportunity to tweak or cancel the message</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-      // at this point.</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-      om = new OutgoingMessage(msg, this.target);</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-      this.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-      if (om.cancelled) {</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-        continue;</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-      }</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-      this.target.sendMsg(om.message);</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-    }</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-  },</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-  unInit() {</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    for (let id in this._prplConv) {</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-      let conv = this._prplConv[id];</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-      gConversationsService.forgetConversation(conv);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-    }</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-    if (this._observedContact) {</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-      this._observedContact.removeObserver(this);</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-      delete this._observedContact;</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-    }</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-    this._prplConv = {}; // Prevent .close from failing.</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-    delete this._currentTargetId;</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-    this.notifyObservers(this, &quot;ui-conversation-destroyed&quot;);</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-  },</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-  close() {</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-    for (let id in this._prplConv) {</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-      let conv = this._prplConv[id];</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-      conv.close();</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-    }</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-    if (!this.hasOwnProperty(&quot;_currentTargetId&quot;)) {</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-      return;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-    }</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-    delete this._currentTargetId;</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-    this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-  },</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-    }</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-  },</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineminus">-  },</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineminus">-  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-      aSubject = new IMMessage(aSubject);</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineminus">-      this.notifyObservers(aSubject, &quot;received-message&quot;);</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineminus">-      if (aSubject.cancelled) {</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-        return;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineminus">-      }</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineminus">-      if (!aSubject.system) {</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineminus">-        aSubject.conversation.prepareForDisplaying(aSubject);</span>
<a href="#l4.546"></a><span id="l4.546" class="difflineminus">-      }</span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-      this._messages.push(aSubject);</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineminus">-      ++this._unreadMessageCount;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-      if (aSubject.incoming &amp;&amp; !aSubject.system) {</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-        ++this._unreadIncomingMessageCount;</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineminus">-        if (!this.isChat || aSubject.containsNick) {</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-          ++this._unreadTargetedMessageCount;</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-        }</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-      }</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-    }</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-      if (!observer.observe &amp;&amp; !this._observers.includes(observer)) {</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-        // Observer removed by a previous call to another observer.</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-        continue;</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-      }</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-    }</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineminus">-    this._notifyUnreadCountChanged();</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-      Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineminus">-      if (</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-        aSubject.incoming &amp;&amp;</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineminus">-        !aSubject.system &amp;&amp;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineminus">-        (!this.isChat || aSubject.containsNick)</span>
<a href="#l4.573"></a><span id="l4.573" class="difflineminus">-      ) {</span>
<a href="#l4.574"></a><span id="l4.574" class="difflineminus">-        this.notifyObservers(aSubject, &quot;new-directed-incoming-message&quot;, aData);</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineminus">-        Services.obs.notifyObservers(</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-          aSubject,</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-          &quot;new-directed-incoming-message&quot;,</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-          aData</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-        );</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-      }</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-    }</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-  },</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-  // Used above when notifying of new-texts originating in the</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-  // UIConversation. This happens when this.systemMessage() is called. The</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-  // conversation for the message is set as the UIConversation.</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-  prepareForDisplaying(aMsg) {},</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineminus">-</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-  // prplIConvIM</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-  get buddy() {</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-    return this.target.buddy;</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-  },</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-  get typingState() {</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-    return this.target.typingState;</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-  },</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-  sendTyping(aString) {</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-    return this.target.sendTyping(aString);</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-  },</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-  // Chat only</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-  getParticipants() {</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-    return this.target.getParticipants();</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-  },</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-  get topic() {</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineminus">-    return this.target.topic;</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-  },</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-  set topic(aTopic) {</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-    this.target.topic = aTopic;</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-  },</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-  get topicSetter() {</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineminus">-    return this.target.topicSetter;</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-  },</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-  get topicSettable() {</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-    return this.target.topicSettable;</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-  },</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-  get noTopicString() {</span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-    return bundle.GetStringFromName(&quot;noTopic&quot;);</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-  },</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-  get nick() {</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineminus">-    return this.target.nick;</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineminus">-  },</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-  get left() {</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-    return this.target.left;</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineminus">-  },</span>
<a href="#l4.625"></a><span id="l4.625" class="difflineminus">-  get joining() {</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineminus">-    return this.target.joining;</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineminus">-  },</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineminus">-};</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineminus">-</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineminus">-var gConversationsService;</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineminus">-function ConversationsService() {</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-  gConversationsService = this;</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-}</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineminus">-ConversationsService.prototype = {</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineminus">-  get wrappedJSObject() {</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineminus">-    return this;</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineminus">-  },</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineminus">-</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-  initConversations() {</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-    this._uiConv = {};</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-    this._uiConvByContactId = {};</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-    this._prplConversations = [];</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-    Services.obs.addObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineminus">-    Services.obs.addObserver(this, &quot;account-connected&quot;);</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-    Services.obs.addObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-    Services.obs.addObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineminus">-  },</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineminus">-</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-  unInitConversations() {</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-    let UIConvs = this.getUIConversations();</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-    for (let UIConv of UIConvs) {</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-      UIConv.unInit();</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-    }</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineminus">-    delete this._uiConv;</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineminus">-    delete this._uiConvByContactId;</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-    // This should already be empty, but just to be sure...</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-    for (let prplConv of this._prplConversations) {</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-      prplConv.unInit();</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineminus">-    }</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineminus">-    delete this._prplConversations;</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-    Services.obs.removeObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-    Services.obs.removeObserver(this, &quot;account-connected&quot;);</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-    Services.obs.removeObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-    Services.obs.removeObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-  },</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-    if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-      for (let id in this._uiConv) {</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-        let conv = this._uiConv[id];</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-        if (conv.account.id == aSubject.id) {</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-          conv.connected();</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-        }</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-      }</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-      for (let id in this._uiConv) {</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineminus">-        let conv = this._uiConv[id];</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineminus">-        if (conv.account.id == aSubject.id) {</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineminus">-          conv.disconnecting();</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineminus">-        }</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineminus">-      }</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineminus">-    } else if (aTopic == &quot;account-buddy-added&quot;) {</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-      let accountBuddy = aSubject;</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-      let prplConversation = this.getConversationByNameAndAccount(</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineminus">-        accountBuddy.normalizedName,</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineminus">-        accountBuddy.account,</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineminus">-        false</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineminus">-      );</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineminus">-      if (!prplConversation) {</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-        return;</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineminus">-      }</span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-      let uiConv = this.getUIConversation(prplConversation);</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineminus">-      let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineminus">-      if (contactId in this._uiConvByContactId) {</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineminus">-        // Trouble! There is an existing uiConv for this contact.</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineminus">-        // We should avoid having two uiConvs with the same contact.</span>
<a href="#l4.698"></a><span id="l4.698" class="difflineminus">-        // This is ugly UX, but at least can only happen if there is</span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-        // already an accountBuddy with the same name for the same</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-        // protocol on a different account, which should be rare.</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-        this.removeConversation(prplConversation);</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineminus">-        return;</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-      }</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-      // Link the existing uiConv to the contact.</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineminus">-      this._uiConvByContactId[contactId] = uiConv;</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineminus">-      uiConv.updateContactObserver();</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-      uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-    } else if (aTopic == &quot;account-buddy-removed&quot;) {</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineminus">-      let accountBuddy = aSubject;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineminus">-      let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineminus">-      if (!(contactId in this._uiConvByContactId)) {</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-        return;</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-      }</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-      let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-      // If there is more than one target on the uiConv, close the</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-      // prplConv as we can't dissociate the uiConv from the contact.</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-      // The conversation with the contact will continue with a different</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-      // target.</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineminus">-      if (uiConv.hasMultipleTargets) {</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineminus">-        let prplConversation = uiConv.getTargetByAccount(accountBuddy.account);</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineminus">-        if (prplConversation) {</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineminus">-          this.removeConversation(prplConversation);</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineminus">-        }</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineminus">-        return;</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineminus">-      }</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineminus">-</span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-      delete this._uiConvByContactId[contactId];</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-      uiConv.updateContactObserver();</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-      uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineminus">-    }</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineminus">-  },</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineminus">-</span>
<a href="#l4.734"></a><span id="l4.734" class="difflineminus">-  addConversation(aPrplConversation) {</span>
<a href="#l4.735"></a><span id="l4.735" class="difflineminus">-    // Give an id to the new conversation.</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineminus">-    aPrplConversation.id = ++gLastPrplConvId;</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineminus">-    this._prplConversations.push(aPrplConversation);</span>
<a href="#l4.738"></a><span id="l4.738" class="difflineminus">-</span>
<a href="#l4.739"></a><span id="l4.739" class="difflineminus">-    // Notify observers.</span>
<a href="#l4.740"></a><span id="l4.740" class="difflineminus">-    Services.obs.notifyObservers(aPrplConversation, &quot;new-conversation&quot;);</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineminus">-</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineminus">-    // Update or create the corresponding UI conversation.</span>
<a href="#l4.743"></a><span id="l4.743" class="difflineminus">-    let contactId;</span>
<a href="#l4.744"></a><span id="l4.744" class="difflineminus">-    if (!aPrplConversation.isChat) {</span>
<a href="#l4.745"></a><span id="l4.745" class="difflineminus">-      let accountBuddy = aPrplConversation.buddy;</span>
<a href="#l4.746"></a><span id="l4.746" class="difflineminus">-      if (accountBuddy) {</span>
<a href="#l4.747"></a><span id="l4.747" class="difflineminus">-        contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l4.748"></a><span id="l4.748" class="difflineminus">-      }</span>
<a href="#l4.749"></a><span id="l4.749" class="difflineminus">-    }</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineminus">-</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-    if (contactId) {</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineminus">-      if (contactId in this._uiConvByContactId) {</span>
<a href="#l4.753"></a><span id="l4.753" class="difflineminus">-        let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l4.754"></a><span id="l4.754" class="difflineminus">-        uiConv.target = aPrplConversation;</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineminus">-        this._uiConv[aPrplConversation.id] = uiConv;</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineminus">-        return;</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineminus">-      }</span>
<a href="#l4.758"></a><span id="l4.758" class="difflineminus">-    }</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineminus">-</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineminus">-    let newUIConv = new UIConversation(aPrplConversation);</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineminus">-    this._uiConv[aPrplConversation.id] = newUIConv;</span>
<a href="#l4.762"></a><span id="l4.762" class="difflineminus">-    if (contactId) {</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineminus">-      this._uiConvByContactId[contactId] = newUIConv;</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineminus">-    }</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineminus">-  },</span>
<a href="#l4.766"></a><span id="l4.766" class="difflineminus">-  removeConversation(aPrplConversation) {</span>
<a href="#l4.767"></a><span id="l4.767" class="difflineminus">-    Services.obs.notifyObservers(aPrplConversation, &quot;conversation-closed&quot;);</span>
<a href="#l4.768"></a><span id="l4.768" class="difflineminus">-</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineminus">-    let uiConv = this.getUIConversation(aPrplConversation);</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineminus">-    delete this._uiConv[aPrplConversation.id];</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineminus">-    let contactId = {};</span>
<a href="#l4.772"></a><span id="l4.772" class="difflineminus">-    if (uiConv.removeTarget(aPrplConversation, contactId)) {</span>
<a href="#l4.773"></a><span id="l4.773" class="difflineminus">-      if (contactId.value) {</span>
<a href="#l4.774"></a><span id="l4.774" class="difflineminus">-        delete this._uiConvByContactId[contactId.value];</span>
<a href="#l4.775"></a><span id="l4.775" class="difflineminus">-      }</span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-      Services.obs.notifyObservers(uiConv, &quot;ui-conversation-closed&quot;);</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineminus">-    }</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineminus">-    this.forgetConversation(aPrplConversation);</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-  },</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineminus">-  forgetConversation(aPrplConversation) {</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-    aPrplConversation.unInit();</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-    this._prplConversations = this._prplConversations.filter(</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineminus">-      c =&gt; c !== aPrplConversation</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineminus">-    );</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineminus">-  },</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineminus">-</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineminus">-  getUIConversations() {</span>
<a href="#l4.789"></a><span id="l4.789" class="difflineminus">-    let rv = [];</span>
<a href="#l4.790"></a><span id="l4.790" class="difflineminus">-    if (this._uiConv) {</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineminus">-      for (let prplConvId in this._uiConv) {</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineminus">-        // Since an UIConversation may be linked to multiple prplConversations,</span>
<a href="#l4.793"></a><span id="l4.793" class="difflineminus">-        // we must ensure we don't return the same UIConversation twice,</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineminus">-        // by checking the id matches that of the active prplConversation.</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineminus">-        let uiConv = this._uiConv[prplConvId];</span>
<a href="#l4.796"></a><span id="l4.796" class="difflineminus">-        if (prplConvId == uiConv.target.id) {</span>
<a href="#l4.797"></a><span id="l4.797" class="difflineminus">-          rv.push(uiConv);</span>
<a href="#l4.798"></a><span id="l4.798" class="difflineminus">-        }</span>
<a href="#l4.799"></a><span id="l4.799" class="difflineminus">-      }</span>
<a href="#l4.800"></a><span id="l4.800" class="difflineminus">-    }</span>
<a href="#l4.801"></a><span id="l4.801" class="difflineminus">-    return rv;</span>
<a href="#l4.802"></a><span id="l4.802" class="difflineminus">-  },</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-  getUIConversation(aPrplConversation) {</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-    let id = aPrplConversation.id;</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-    if (this._uiConv &amp;&amp; id in this._uiConv) {</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineminus">-      return this._uiConv[id];</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineminus">-    }</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineminus">-    throw new Error(&quot;Unknown conversation&quot;);</span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-  },</span>
<a href="#l4.810"></a><span id="l4.810" class="difflineminus">-  getUIConversationByContactId(aId) {</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineminus">-    return aId in this._uiConvByContactId ? this._uiConvByContactId[aId] : null;</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-  },</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-  getConversations() {</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineminus">-    return new nsSimpleEnumerator(this._prplConversations);</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineminus">-  },</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineminus">-  getConversationById(aId) {</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-    for (let conv of this._prplConversations) {</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-      if (conv.id == aId) {</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-        return conv;</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-      }</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-    }</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-    return null;</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-  },</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineminus">-  getConversationByNameAndAccount(aName, aAccount, aIsChat) {</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-    let normalizedName = aAccount.normalize(aName);</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-    for (let conv of this._prplConversations) {</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-      if (</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-        aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineminus">-        aAccount.numericId == conv.account.numericId &amp;&amp;</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineminus">-        conv.isChat == aIsChat</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineminus">-      ) {</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-        return conv;</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-      }</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineminus">-    }</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineminus">-    return null;</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineminus">-  },</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineminus">-</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">deleted file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- a/chat/components/src/IMCore.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ /dev/null</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -1,414 +0,0 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;IMCore&quot;];</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">-</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-  ClassInfo,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  initLogModule,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  this,</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-  &quot;categoryManager&quot;,</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-  &quot;nsICategoryManager&quot;</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-);</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-var kQuitApplicationGranted = &quot;quit-application-granted&quot;;</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-var kProtocolPluginCategory = &quot;im-protocol-plugin&quot;;</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-var kPrefReportIdle = &quot;messenger.status.reportIdle&quot;;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-var kPrefUserIconFilename = &quot;messenger.status.userIconFileName&quot;;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-var kPrefUserDisplayname = &quot;messenger.status.userDisplayName&quot;;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-var kPrefTimeBeforeIdle = &quot;messenger.status.timeBeforeIdle&quot;;</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-var kPrefAwayWhenIdle = &quot;messenger.status.awayWhenIdle&quot;;</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-var kPrefDefaultMessage = &quot;messenger.status.defaultIdleAwayMessage&quot;;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineminus">-var NS_IOSERVICE_GOING_OFFLINE_TOPIC = &quot;network:offline-about-to-go-offline&quot;;</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-var NS_IOSERVICE_OFFLINE_STATUS_TOPIC = &quot;network:offline-status-changed&quot;;</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-function UserStatus() {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-  this._observers = [];</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-  if (Services.prefs.getBoolPref(kPrefReportIdle)) {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-    this._addIdleObserver();</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  }</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-  Services.prefs.addObserver(kPrefReportIdle, this);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  if (Services.io.offline) {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  }</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  Services.obs.addObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineminus">-  Services.obs.addObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineminus">-}</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-UserStatus.prototype = {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  __proto__: ClassInfo(&quot;imIUserStatusInfo&quot;, &quot;User status info&quot;),</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineminus">-</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-  unInit() {</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    this._observers = [];</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    Services.prefs.removeObserver(kPrefReportIdle, this);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    if (this._observingIdleness) {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-      this._removeIdleObserver();</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    }</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    Services.obs.removeObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-    Services.obs.removeObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-  },</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-  _observingIdleness: false,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-  _addIdleObserver() {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-    this._observingIdleness = true;</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-    this._idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-      Ci.nsIIdleService</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    );</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    Services.obs.addObserver(this, &quot;im-sent&quot;);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-    this._timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-    if (this._timeBeforeIdle &lt; 0) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-      this._timeBeforeIdle = 0;</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    }</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    Services.prefs.addObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-    if (this._timeBeforeIdle) {</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-      this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    }</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineminus">-  },</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineminus">-  _removeIdleObserver() {</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-    if (this._timeBeforeIdle) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineminus">-      this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineminus">-    }</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-    Services.prefs.removeObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-    delete this._timeBeforeIdle;</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineminus">-</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-    Services.obs.removeObserver(this, &quot;im-sent&quot;);</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineminus">-    delete this._idleService;</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-    delete this._observingIdleness;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  },</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-      if (aData == kPrefReportIdle) {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-        let reportIdle = Services.prefs.getBoolPref(kPrefReportIdle);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-        if (reportIdle &amp;&amp; !this._observingIdleness) {</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-          this._addIdleObserver();</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-        } else if (!reportIdle &amp;&amp; this._observingIdleness) {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-          this._removeIdleObserver();</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-        }</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-      } else if (aData == kPrefTimeBeforeIdle) {</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-        let timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-        if (timeBeforeIdle != this._timeBeforeIdle) {</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineminus">-          if (this._timeBeforeIdle) {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-            this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineminus">-          }</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-          this._timeBeforeIdle = timeBeforeIdle;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-          if (this._timeBeforeIdle) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-            this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-          }</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-        }</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-      } else {</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-      }</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-    } else if (aTopic == NS_IOSERVICE_GOING_OFFLINE_TOPIC) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-      this.offline = true;</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-    } else if (</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-      aTopic == NS_IOSERVICE_OFFLINE_STATUS_TOPIC &amp;&amp;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineminus">-      aData == &quot;online&quot;</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-    ) {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-      this.offline = false;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-    } else {</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-      this._checkIdle();</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-    }</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  },</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  _offlineStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-  set offline(aOffline) {</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineminus">-    let statusType = this.statusType;</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-    let statusText = this.statusText;</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineminus">-    if (aOffline) {</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-      this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-    } else {</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineminus">-      delete this._offlineStatusType;</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-    }</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineminus">-    }</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineminus">-  },</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineminus">-</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-  _idleTime: 0,</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-  get idleTime() {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-    return this._idleTime;</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-  },</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-  set idleTime(aIdleTime) {</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-    this._idleTime = aIdleTime;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-    this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-  },</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-  _idle: false,</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-  _idleStatusText: &quot;&quot;,</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-  _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-  _checkIdle() {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    let idleTime = Math.floor(this._idleService.idleTime / 1000);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-    let idle = this._timeBeforeIdle &amp;&amp; idleTime &gt;= this._timeBeforeIdle;</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-    if (idle == this._idle) {</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-      return;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineminus">-    }</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineminus">-</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    let statusType = this.statusType;</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-    let statusText = this.statusText;</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-    this._idle = idle;</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-    if (idle) {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-      this.idleTime = idleTime;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-      if (Services.prefs.getBoolPref(kPrefAwayWhenIdle)) {</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-        this._idleStatusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-        this._idleStatusText = Services.prefs.getComplexValue(</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-          kPrefDefaultMessage,</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-          Ci.nsIPrefLocalizedString</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-        ).data;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-      }</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    } else {</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-      this.idleTime = 0;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-      delete this._idleStatusType;</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-      delete this._idleStatusText;</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-    }</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-    }</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineminus">-  },</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineminus">-</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineminus">-  _statusText: &quot;&quot;,</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineminus">-  get statusText() {</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineminus">-    return this._statusText || this._idleStatusText;</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-  },</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-  _statusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-  get statusType() {</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-    return Math.min(</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-      this._statusType,</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineminus">-      this._idleStatusType,</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineminus">-      this._offlineStatusType</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    );</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-  },</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-  setStatus(aStatus, aMessage) {</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-    if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-      this._statusType = aStatus;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-    }</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineminus">-    if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineminus">-      this._statusText = aMessage;</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineminus">-    }</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-    this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-  },</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-  _getProfileDir: () =&gt; Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  setUserIcon(aIconFile) {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-    let folder = this._getProfileDir();</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-    let newName = &quot;&quot;;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-    if (aIconFile) {</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-      // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-      let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-      // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-      newName = &quot;userIcon-&quot; + Math.floor(Date.now() / 1000) + ext;</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-      // Copy the new icon file to newName in the profile folder.</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-      aIconFile.copyTo(folder, newName);</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-    }</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-    // Get the previous file name before saving the new file name.</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-    let oldFileName = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-    Services.prefs.setCharPref(kPrefUserIconFilename, newName);</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-    // Now that the new icon has been copied to the profile directory</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-    // and the pref value changed, we can remove the old icon. Ignore</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    // failures so that we always fire the user-icon-changed notification.</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-    try {</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-      if (oldFileName) {</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-        folder.append(oldFileName);</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-        if (folder.exists()) {</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-          folder.remove(false);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-        }</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-      }</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-      Cu.reportError(e);</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-    }</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-    this._notifyObservers(&quot;user-icon-changed&quot;, newName);</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-  },</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-  getUserIcon() {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-    let filename = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-    if (!filename) {</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-      // No icon has been set.</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-      return null;</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-    }</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-    let file = this._getProfileDir();</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-    file.append(filename);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-    if (!file.exists()) {</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineminus">-      Services.console.logStringMessage(&quot;Invalid userIconFileName preference&quot;);</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-      return null;</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-    }</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineminus">-</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineminus">-    return Services.io.newFileURI(file);</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineminus">-  },</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineminus">-</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineminus">-  get displayName() {</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-    return Services.prefs.getStringPref(kPrefUserDisplayname);</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-  },</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineminus">-  set displayName(aDisplayName) {</span>
<a href="#l5.263"></a><span id="l5.263" class="difflineminus">-    Services.prefs.setStringPref(kPrefUserDisplayname, aDisplayName);</span>
<a href="#l5.264"></a><span id="l5.264" class="difflineminus">-    this._notifyObservers(&quot;user-display-name-changed&quot;, aDisplayName);</span>
<a href="#l5.265"></a><span id="l5.265" class="difflineminus">-  },</span>
<a href="#l5.266"></a><span id="l5.266" class="difflineminus">-</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-  addObserver(aObserver) {</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-    if (!this._observers.includes(aObserver)) {</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineminus">-      this._observers.push(aObserver);</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineminus">-    }</span>
<a href="#l5.271"></a><span id="l5.271" class="difflineminus">-  },</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-  removeObserver(aObserver) {</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineminus">-  },</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineminus">-  _notifyObservers(aTopic, aData) {</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineminus">-    for (let observer of this._observers) {</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineminus">-      observer.observe(this, aTopic, aData);</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineminus">-    }</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-  },</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-};</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineminus">-</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineminus">-function IMCore() {}</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-IMCore.prototype = {</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineminus">-  globalUserStatus: null,</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineminus">-</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineminus">-  _initialized: false,</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineminus">-  get initialized() {</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineminus">-    return this._initialized;</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineminus">-  },</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineminus">-  init() {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineminus">-    if (this._initialized) {</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-      return;</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineminus">-    }</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineminus">-</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineminus">-    initLogModule(&quot;core&quot;, this);</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineminus">-</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineminus">-    Services.obs.addObserver(this, kQuitApplicationGranted);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineminus">-    this._initialized = true;</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineminus">-</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineminus">-    Services.cmd.initCommands();</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineminus">-    this._protos = {};</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineminus">-    this.globalUserStatus = new UserStatus();</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineminus">-    this.globalUserStatus.addObserver({</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineminus">-      observe(aSubject, aTopic, aData) {</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineminus">-        Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineminus">-      },</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineminus">-    });</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineminus">-</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineminus">-    let accounts = Services.accounts;</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-    accounts.initAccounts();</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineminus">-    Services.contacts.initContacts();</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineminus">-    Services.conversations.initConversations();</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;prpl-init&quot;);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-    // Wait with automatic connections until the password service</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-    // is available.</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-    if (accounts.autoLoginStatus == Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-      Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-        Services.accounts.processAutoLogin();</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-      });</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-    }</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-  },</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-  observe(aObject, aTopic, aData) {</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-    if (aTopic == kQuitApplicationGranted) {</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-      this.quit();</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-    }</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineminus">-  },</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineminus">-  quit() {</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-    if (!this._initialized) {</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-    }</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-    Services.obs.removeObserver(this, kQuitApplicationGranted);</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-    Services.obs.notifyObservers(this, &quot;prpl-quit&quot;);</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineminus">-    Services.conversations.unInitConversations();</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineminus">-    Services.accounts.unInitAccounts();</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineminus">-    Services.contacts.unInitContacts();</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineminus">-    Services.cmd.unInitCommands();</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineminus">-</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineminus">-    this.globalUserStatus.unInit();</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-    delete this.globalUserStatus;</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-    delete this._protos;</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-    delete this._initialized;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineminus">-  },</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineminus">-</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineminus">-  getProtocols() {</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineminus">-    if (!this._initialized) {</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineminus">-      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-    }</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineminus">-    let protocols = [];</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineminus">-    let entries = categoryManager.enumerateCategory(kProtocolPluginCategory);</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineminus">-    while (entries.hasMoreElements()) {</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineminus">-      let id = entries.getNext().QueryInterface(Ci.nsISupportsCString).data;</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineminus">-</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineminus">-      // If the preference is set to disable this prpl, don't show it in the</span>
<a href="#l5.359"></a><span id="l5.359" class="difflineminus">-      // full list of protocols.</span>
<a href="#l5.360"></a><span id="l5.360" class="difflineminus">-      let pref = &quot;chat.prpls.&quot; + id + &quot;.disable&quot;;</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-      if (</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-        Services.prefs.getPrefType(pref) == Services.prefs.PREF_BOOL &amp;&amp;</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-        Services.prefs.getBoolPref(pref)</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineminus">-      ) {</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineminus">-        this.LOG(&quot;Disabling prpl: &quot; + id);</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineminus">-        continue;</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineminus">-      }</span>
<a href="#l5.368"></a><span id="l5.368" class="difflineminus">-</span>
<a href="#l5.369"></a><span id="l5.369" class="difflineminus">-      let proto = this.getProtocolById(id);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-      if (proto) {</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-        protocols.push(proto);</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-      }</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineminus">-    }</span>
<a href="#l5.374"></a><span id="l5.374" class="difflineminus">-    return new nsSimpleEnumerator(protocols);</span>
<a href="#l5.375"></a><span id="l5.375" class="difflineminus">-  },</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineminus">-</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineminus">-  getProtocolById(aPrplId) {</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineminus">-    if (!this._initialized) {</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineminus">-      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineminus">-    }</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineminus">-</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineminus">-    if (this._protos.hasOwnProperty(aPrplId)) {</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineminus">-      return this._protos[aPrplId];</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineminus">-    }</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineminus">-</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineminus">-    let cid;</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-    try {</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-      cid = categoryManager.getCategoryEntry(kProtocolPluginCategory, aPrplId);</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineminus">-      return null; // no protocol registered for this id.</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-    }</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineminus">-    let proto = null;</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineminus">-    try {</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineminus">-      proto = Cc[cid].createInstance(Ci.prplIProtocol);</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-      // This is a real error, the protocol is registered and failed to init.</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-      let error = &quot;failed to create an instance of &quot; + cid + &quot;: &quot; + e;</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineminus">-      dump(error + &quot;\n&quot;);</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineminus">-      Cu.reportError(error);</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-    }</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineminus">-    if (!proto) {</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineminus">-      return null;</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineminus">-    }</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineminus">-</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineminus">-    try {</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineminus">-      proto.init(aPrplId);</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineminus">-      Cu.reportError(&quot;Could not initialize protocol &quot; + aPrplId + &quot;: &quot; + e);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineminus">-      return null;</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineminus">-    }</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineminus">-    this._protos[aPrplId] = proto;</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineminus">-    return proto;</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineminus">-  },</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineminus">-</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.imICoreService]),</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/chat/components/src/Logger.jsm</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,1144 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-var EXPORTED_SYMBOLS = [</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-  &quot;Logger&quot;,</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-  &quot;encodeName&quot;,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  &quot;convIsRealMUC&quot;,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  &quot;getLogFolderPathForAccount&quot;,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  &quot;getLogFilePathForConversation&quot;,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineminus">-  &quot;getNewLogFileName&quot;,</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  &quot;queueFileOperation&quot;,</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  &quot;fileOperations&quot;,</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-  &quot;appendToFile&quot;,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-  &quot;getLogWriter&quot;,</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineminus">-  &quot;closeLogWriter&quot;,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-];</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-var { EmptyEnumerator, l10nHelper, XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-var { GenericMessagePrototype } = ChromeUtils.import(</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l6.29"></a><span id="l6.29" class="difflineminus">-);</span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-var { ClassInfo } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-var { ToLocaleFormat } = ChromeUtils.import(</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  &quot;resource:///modules/ToLocaleFormat.jsm&quot;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-);</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineminus">-var { getHiddenHTMLWindow } = ChromeUtils.import(</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-  &quot;resource:///modules/hiddenWindow.jsm&quot;</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-);</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-);</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineminus">-var kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l6.44"></a><span id="l6.44" class="difflineminus">-</span>
<a href="#l6.45"></a><span id="l6.45" class="difflineminus">-/*</span>
<a href="#l6.46"></a><span id="l6.46" class="difflineminus">- * Maps file paths to promises returned by ongoing OS.File operations on them.</span>
<a href="#l6.47"></a><span id="l6.47" class="difflineminus">- * This is so that a file can be read after a pending write operation completes</span>
<a href="#l6.48"></a><span id="l6.48" class="difflineminus">- * and vice versa (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l6.49"></a><span id="l6.49" class="difflineminus">- */</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineminus">-var fileOperations = new Map();</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-// Uses above map to queue operations on a file.</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-function queueFileOperation(aPath, aOperation) {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-  // Ensure the operation is queued regardless of whether the last one succeeded.</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  // This is safe since the promise is returned and consumers are expected to</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  // handle any errors. If there's no promise existing for the given path already,</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-  // queue the operation on a dummy pre-resolved promise.</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  let promise = (fileOperations.get(aPath) || Promise.resolve()).then(</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineminus">-    aOperation,</span>
<a href="#l6.60"></a><span id="l6.60" class="difflineminus">-    aOperation</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-  );</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-  fileOperations.set(aPath, promise);</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineminus">-  let cleanup = () =&gt; {</span>
<a href="#l6.65"></a><span id="l6.65" class="difflineminus">-    // If no further operations have been queued, remove the reference from the map.</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-    if (fileOperations.get(aPath) === promise) {</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-      fileOperations.delete(aPath);</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineminus">-    }</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineminus">-  };</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineminus">-  // Ensure we clear unused promises whether they resolved or rejected.</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  promise.then(cleanup, cleanup);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  return promise;</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineminus">-}</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineminus">-/*</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineminus">- * Convenience method to append to a file using the above queue system. If any of</span>
<a href="#l6.78"></a><span id="l6.78" class="difflineminus">- * the I/O operations reject, the returned promise will reject with the same reason.</span>
<a href="#l6.79"></a><span id="l6.79" class="difflineminus">- * We open the file, append, and close it immediately. The alternative is to keep</span>
<a href="#l6.80"></a><span id="l6.80" class="difflineminus">- * it open and append as required, but we want to make sure we don't open a file</span>
<a href="#l6.81"></a><span id="l6.81" class="difflineminus">- * for reading while it's already open for writing, so we close it every time</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineminus">- * (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l6.83"></a><span id="l6.83" class="difflineminus">- * Note: This function creates parent directories if required.</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">- */</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineminus">-function appendToFile(aPath, aEncodedString, aCreate) {</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  return queueFileOperation(aPath, async function() {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-    await OS.File.makeDir(OS.Path.dirname(aPath), {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineminus">-      ignoreExisting: true,</span>
<a href="#l6.89"></a><span id="l6.89" class="difflineminus">-      from: OS.Constants.Path.profileDir,</span>
<a href="#l6.90"></a><span id="l6.90" class="difflineminus">-    });</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">-    let file = await OS.File.open(aPath, { write: true, create: aCreate });</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-    try {</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-      await file.write(aEncodedString);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-    } finally {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-      /*</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-       * If both the write() above and the close() below throw, and we don't</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-       * handle the close error here, the promise will be rejected with the close</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-       * error and the write error will be dropped. To avoid this, we log any</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-       * close error here so that any write error will be propagated.</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineminus">-       */</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineminus">-      await file.close().catch(Cu.reportError);</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-    }</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineminus">-  });</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-}</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineminus">-</span>
<a href="#l6.106"></a><span id="l6.106" class="difflineminus">-OS.File.profileBeforeChange.addBlocker(</span>
<a href="#l6.107"></a><span id="l6.107" class="difflineminus">-  &quot;Chat logger: writing all pending messages&quot;,</span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-  async function() {</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-    for (let promise of fileOperations.values()) {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-      try {</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-        await promise;</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-      } catch (aError) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineminus">-        // Ignore the error, whatever queued the operation will take care of it.</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineminus">-      }</span>
<a href="#l6.115"></a><span id="l6.115" class="difflineminus">-    }</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-  }</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-);</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-// This function checks names against OS naming conventions and alters them</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-// accordingly so that they can be used as file/folder names.</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-function encodeName(aName) {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineminus">-  // Reserved device names by Windows (prefixing &quot;%&quot;).</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineminus">-  let reservedNames = /^(CON|PRN|AUX|NUL|COM\d|LPT\d)$/i;</span>
<a href="#l6.124"></a><span id="l6.124" class="difflineminus">-  if (reservedNames.test(aName)) {</span>
<a href="#l6.125"></a><span id="l6.125" class="difflineminus">-    return &quot;%&quot; + aName;</span>
<a href="#l6.126"></a><span id="l6.126" class="difflineminus">-  }</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-  // &quot;.&quot; and &quot; &quot; must not be at the end of a file or folder name (appending &quot;_&quot;).</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-  if (/[\. _]/.test(aName.slice(-1))) {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineminus">-    aName += &quot;_&quot;;</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-  }</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineminus">-</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  // Reserved characters are replaced by %[hex value]. encodeURIComponent() is</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  // not sufficient, nevertheless decodeURIComponent() can be used to decode.</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-  function encodeReservedChars(match) {</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-    return &quot;%&quot; + match.charCodeAt(0).toString(16);</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-  }</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-  return aName.replace(/[&lt;&gt;:&quot;\/\\|?*&amp;%]/g, encodeReservedChars);</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-}</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-function getLogFolderPathForAccount(aAccount) {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-  return OS.Path.join(</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineminus">-    OS.Constants.Path.profileDir,</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineminus">-    &quot;logs&quot;,</span>
<a href="#l6.145"></a><span id="l6.145" class="difflineminus">-    aAccount.protocol.normalizedName,</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-    encodeName(aAccount.normalizedName)</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineminus">-  );</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-}</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineminus">-function getLogFilePathForConversation(aConv, aFormat, aStartTime) {</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineminus">-  if (!aStartTime) {</span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-    aStartTime = aConv.startDate / 1000;</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-  }</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-  let path = getLogFolderPathForAccount(aConv.account);</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-  let name = aConv.normalizedName;</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineminus">-  if (convIsRealMUC(aConv)) {</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineminus">-    name += &quot;.chat&quot;;</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-  }</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-  return OS.Path.join(</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineminus">-    path,</span>
<a href="#l6.161"></a><span id="l6.161" class="difflineminus">-    encodeName(name),</span>
<a href="#l6.162"></a><span id="l6.162" class="difflineminus">-    getNewLogFileName(aFormat, aStartTime)</span>
<a href="#l6.163"></a><span id="l6.163" class="difflineminus">-  );</span>
<a href="#l6.164"></a><span id="l6.164" class="difflineminus">-}</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineminus">-</span>
<a href="#l6.166"></a><span id="l6.166" class="difflineminus">-function getNewLogFileName(aFormat, aStartTime) {</span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-  let date = aStartTime ? new Date(aStartTime) : new Date();</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineminus">-  let dateTime = ToLocaleFormat(&quot;%Y-%m-%d.%H%M%S&quot;, date);</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  let offset = date.getTimezoneOffset();</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineminus">-  if (offset &lt; 0) {</span>
<a href="#l6.171"></a><span id="l6.171" class="difflineminus">-    dateTime += &quot;+&quot;;</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-    offset *= -1;</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  } else {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-    dateTime += &quot;-&quot;;</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineminus">-  }</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineminus">-  let minutes = offset % 60;</span>
<a href="#l6.177"></a><span id="l6.177" class="difflineminus">-  offset = (offset - minutes) / 60;</span>
<a href="#l6.178"></a><span id="l6.178" class="difflineminus">-  function twoDigits(aNumber) {</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineminus">-    if (aNumber == 0) {</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-      return &quot;00&quot;;</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    }</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-    return aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  }</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  if (!aFormat) {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    aFormat = &quot;txt&quot;;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-  }</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-  return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-}</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-// One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-// a log file and appends to it as required.</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-function LogWriter(aConversation) {</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-  this._conv = aConversation;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-  if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;) {</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    this.format = &quot;json&quot;;</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-  }</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  this.paths = [];</span>
<a href="#l6.198"></a><span id="l6.198" class="difflineminus">-  this.startNewFile(this._conv.startDate / 1000);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineminus">-}</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineminus">-LogWriter.prototype = {</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-  // All log file paths used by this LogWriter.</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-  paths: [],</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-  // Path of the log file that is currently being written to.</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineminus">-  get currentPath() {</span>
<a href="#l6.205"></a><span id="l6.205" class="difflineminus">-    return this.paths[this.paths.length - 1];</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineminus">-  },</span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineminus">-  // has been written.</span>
<a href="#l6.209"></a><span id="l6.209" class="difflineminus">-  _initialized: null,</span>
<a href="#l6.210"></a><span id="l6.210" class="difflineminus">-  _startTime: null,</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-  _lastMessageTime: null,</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-  _messageCount: 0,</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineminus">-  format: &quot;txt&quot;,</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-  encoder: new TextEncoder(),</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-  startNewFile(aStartTime, aContinuedSession) {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-    // We start a new log file every 1000 messages. The start time of this new</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-    // log file is the time of the next message. Since message times are in seconds,</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-    // if we receive 1000 messages within a second after starting the new file,</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-    // we will create another file, using the same start time - and so the same</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-    // file name. To avoid this, ensure the new start time is at least one second</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineminus">-    // greater than the current one. This is ugly, but should rarely be needed.</span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-    aStartTime = Math.max(aStartTime, this._startTime + 1000);</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineminus">-    this._startTime = this._lastMessageTime = aStartTime;</span>
<a href="#l6.224"></a><span id="l6.224" class="difflineminus">-    this._messageCount = 0;</span>
<a href="#l6.225"></a><span id="l6.225" class="difflineminus">-    this.paths.push(</span>
<a href="#l6.226"></a><span id="l6.226" class="difflineminus">-      getLogFilePathForConversation(this._conv, this.format, aStartTime)</span>
<a href="#l6.227"></a><span id="l6.227" class="difflineminus">-    );</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineminus">-    let account = this._conv.account;</span>
<a href="#l6.229"></a><span id="l6.229" class="difflineminus">-    let header;</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineminus">-    if (this.format == &quot;json&quot;) {</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-      header = {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineminus">-        date: new Date(this._startTime),</span>
<a href="#l6.233"></a><span id="l6.233" class="difflineminus">-        name: this._conv.name,</span>
<a href="#l6.234"></a><span id="l6.234" class="difflineminus">-        title: this._conv.title,</span>
<a href="#l6.235"></a><span id="l6.235" class="difflineminus">-        account: account.normalizedName,</span>
<a href="#l6.236"></a><span id="l6.236" class="difflineminus">-        protocol: account.protocol.normalizedName,</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-        isChat: this._conv.isChat,</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-        normalizedName: this._conv.normalizedName,</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-      };</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-      if (aContinuedSession) {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-        header.continuedSession = true;</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineminus">-      }</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-      header = JSON.stringify(header) + &quot;\n&quot;;</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-    } else {</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-      const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineminus">-        dateStyle: &quot;full&quot;,</span>
<a href="#l6.247"></a><span id="l6.247" class="difflineminus">-        timeStyle: &quot;long&quot;,</span>
<a href="#l6.248"></a><span id="l6.248" class="difflineminus">-      });</span>
<a href="#l6.249"></a><span id="l6.249" class="difflineminus">-      header =</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-        &quot;Conversation with &quot; +</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-        this._conv.name +</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-        &quot; at &quot; +</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-        dateTimeFormatter.format(new Date(this._conv.startDate / 1000)) +</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-        &quot; on &quot; +</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-        account.name +</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-        &quot; (&quot; +</span>
<a href="#l6.257"></a><span id="l6.257" class="difflineminus">-        account.protocol.normalizedName +</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-        &quot;)&quot; +</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-        kLineBreak;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-    }</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineminus">-    this._initialized = appendToFile(</span>
<a href="#l6.262"></a><span id="l6.262" class="difflineminus">-      this.currentPath,</span>
<a href="#l6.263"></a><span id="l6.263" class="difflineminus">-      this.encoder.encode(header),</span>
<a href="#l6.264"></a><span id="l6.264" class="difflineminus">-      true</span>
<a href="#l6.265"></a><span id="l6.265" class="difflineminus">-    );</span>
<a href="#l6.266"></a><span id="l6.266" class="difflineminus">-    // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l6.267"></a><span id="l6.267" class="difflineminus">-    // writing the header failed.</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-    this._initialized.catch(aError =&gt;</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-      Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError)</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-    );</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineminus">-  },</span>
<a href="#l6.272"></a><span id="l6.272" class="difflineminus">-  _serialize(aString) {</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-    // TODO cleanup once bug 102699 is fixed</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineminus">-    let doc = getHiddenHTMLWindow().document;</span>
<a href="#l6.275"></a><span id="l6.275" class="difflineminus">-    let div = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;div&quot;);</span>
<a href="#l6.276"></a><span id="l6.276" class="difflineminus">-    // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-    div.innerHTML = aString</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineminus">-      .replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;)</span>
<a href="#l6.279"></a><span id="l6.279" class="difflineminus">-      .replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-    const type = &quot;text/plain&quot;;</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineminus">-    let encoder = Cu.createDocumentEncoder(type);</span>
<a href="#l6.282"></a><span id="l6.282" class="difflineminus">-    encoder.init(doc, type, 0);</span>
<a href="#l6.283"></a><span id="l6.283" class="difflineminus">-    encoder.setContainerNode(div);</span>
<a href="#l6.284"></a><span id="l6.284" class="difflineminus">-    encoder.setNodeFixup({</span>
<a href="#l6.285"></a><span id="l6.285" class="difflineminus">-      fixupNode(aNode, aSerializeKids) {</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-        if (aNode.localName == &quot;a&quot; &amp;&amp; aNode.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-          let url = aNode.getAttribute(&quot;href&quot;);</span>
<a href="#l6.288"></a><span id="l6.288" class="difflineminus">-          let content = aNode.textContent;</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-          if (url != content) {</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-            aNode.textContent = content + &quot; (&quot; + url + &quot;)&quot;;</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineminus">-          }</span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-        }</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineminus">-        return null;</span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-      },</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-    });</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineminus">-    return encoder.encodeToString();</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineminus">-  },</span>
<a href="#l6.298"></a><span id="l6.298" class="difflineminus">-  // We start a new log file in the following cases:</span>
<a href="#l6.299"></a><span id="l6.299" class="difflineminus">-  // - If it has been 30 minutes since the last message.</span>
<a href="#l6.300"></a><span id="l6.300" class="difflineminus">-  kInactivityLimit: 30 * 60 * 1000,</span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-  // - If at midnight, it's been longer than 3 hours since we started the file.</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineminus">-  kDayOverlapLimit: 3 * 60 * 60 * 1000,</span>
<a href="#l6.303"></a><span id="l6.303" class="difflineminus">-  // - After every 1000 messages.</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  kMessageCountLimit: 1000,</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-  logMessage(aMessage) {</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-    // aMessage.time is in seconds, we need it in milliseconds.</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineminus">-    let messageTime = aMessage.time * 1000;</span>
<a href="#l6.308"></a><span id="l6.308" class="difflineminus">-    let messageMidnight = new Date(messageTime).setHours(0, 0, 0, 0);</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-    let inactivityLimitExceeded =</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-      !aMessage.delayed &amp;&amp;</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineminus">-      messageTime - this._lastMessageTime &gt; this.kInactivityLimit;</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineminus">-    let dayOverlapLimitExceeded =</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineminus">-      !aMessage.delayed &amp;&amp;</span>
<a href="#l6.315"></a><span id="l6.315" class="difflineminus">-      messageMidnight - this._startTime &gt; this.kDayOverlapLimit;</span>
<a href="#l6.316"></a><span id="l6.316" class="difflineminus">-</span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-    if (</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineminus">-      inactivityLimitExceeded ||</span>
<a href="#l6.319"></a><span id="l6.319" class="difflineminus">-      dayOverlapLimitExceeded ||</span>
<a href="#l6.320"></a><span id="l6.320" class="difflineminus">-      this._messageCount == this.kMessageCountLimit</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-    ) {</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-      // We start a new session if the inactivity limit was exceeded.</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-      this.startNewFile(messageTime, !inactivityLimitExceeded);</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-    }</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-    ++this._messageCount;</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineminus">-</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineminus">-    if (!aMessage.delayed) {</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineminus">-      this._lastMessageTime = messageTime;</span>
<a href="#l6.329"></a><span id="l6.329" class="difflineminus">-    }</span>
<a href="#l6.330"></a><span id="l6.330" class="difflineminus">-</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-    let lineToWrite;</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-    if (this.format == &quot;json&quot;) {</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-      let msg = {</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineminus">-        date: new Date(messageTime),</span>
<a href="#l6.335"></a><span id="l6.335" class="difflineminus">-        who: aMessage.who,</span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-        text: aMessage.displayMessage,</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineminus">-        flags: [</span>
<a href="#l6.338"></a><span id="l6.338" class="difflineminus">-          &quot;outgoing&quot;,</span>
<a href="#l6.339"></a><span id="l6.339" class="difflineminus">-          &quot;incoming&quot;,</span>
<a href="#l6.340"></a><span id="l6.340" class="difflineminus">-          &quot;system&quot;,</span>
<a href="#l6.341"></a><span id="l6.341" class="difflineminus">-          &quot;autoResponse&quot;,</span>
<a href="#l6.342"></a><span id="l6.342" class="difflineminus">-          &quot;containsNick&quot;,</span>
<a href="#l6.343"></a><span id="l6.343" class="difflineminus">-          &quot;error&quot;,</span>
<a href="#l6.344"></a><span id="l6.344" class="difflineminus">-          &quot;delayed&quot;,</span>
<a href="#l6.345"></a><span id="l6.345" class="difflineminus">-          &quot;noFormat&quot;,</span>
<a href="#l6.346"></a><span id="l6.346" class="difflineminus">-          &quot;containsImages&quot;,</span>
<a href="#l6.347"></a><span id="l6.347" class="difflineminus">-          &quot;notification&quot;,</span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-          &quot;noLinkification&quot;,</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-        ].filter(f =&gt; aMessage[f]),</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-      };</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-      let alias = aMessage.alias;</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-      if (alias &amp;&amp; alias != msg.who) {</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineminus">-        msg.alias = alias;</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-      }</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineminus">-      lineToWrite = JSON.stringify(msg) + &quot;\n&quot;;</span>
<a href="#l6.356"></a><span id="l6.356" class="difflineminus">-    } else {</span>
<a href="#l6.357"></a><span id="l6.357" class="difflineminus">-      // Text log.</span>
<a href="#l6.358"></a><span id="l6.358" class="difflineminus">-      let date = new Date(messageTime);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-      let line = &quot;(&quot; + date.toLocaleTimeString() + &quot;) &quot;;</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-      let msg = this._serialize(aMessage.displayMessage);</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-      if (aMessage.system) {</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-        line += msg;</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineminus">-      } else {</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-        let sender = aMessage.alias || aMessage.who;</span>
<a href="#l6.365"></a><span id="l6.365" class="difflineminus">-        if (aMessage.autoResponse) {</span>
<a href="#l6.366"></a><span id="l6.366" class="difflineminus">-          line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l6.367"></a><span id="l6.367" class="difflineminus">-        } else if (msg.startsWith(&quot;/me &quot;)) {</span>
<a href="#l6.368"></a><span id="l6.368" class="difflineminus">-          line += &quot;***&quot; + sender + &quot; &quot; + msg.substr(4);</span>
<a href="#l6.369"></a><span id="l6.369" class="difflineminus">-        } else {</span>
<a href="#l6.370"></a><span id="l6.370" class="difflineminus">-          line += sender + &quot;: &quot; + msg;</span>
<a href="#l6.371"></a><span id="l6.371" class="difflineminus">-        }</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineminus">-      }</span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-      lineToWrite = line + kLineBreak;</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-    }</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineminus">-    lineToWrite = this.encoder.encode(lineToWrite);</span>
<a href="#l6.376"></a><span id="l6.376" class="difflineminus">-    this._initialized.then(() =&gt; {</span>
<a href="#l6.377"></a><span id="l6.377" class="difflineminus">-      appendToFile(this.currentPath, lineToWrite).catch(aError =&gt;</span>
<a href="#l6.378"></a><span id="l6.378" class="difflineminus">-        Cu.reportError(&quot;Failed to log message:\n&quot; + aError)</span>
<a href="#l6.379"></a><span id="l6.379" class="difflineminus">-      );</span>
<a href="#l6.380"></a><span id="l6.380" class="difflineminus">-    });</span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-  },</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineminus">-};</span>
<a href="#l6.383"></a><span id="l6.383" class="difflineminus">-</span>
<a href="#l6.384"></a><span id="l6.384" class="difflineminus">-var dummyLogWriter = {</span>
<a href="#l6.385"></a><span id="l6.385" class="difflineminus">-  paths: null,</span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-  currentPath: null,</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineminus">-  logMessage() {},</span>
<a href="#l6.388"></a><span id="l6.388" class="difflineminus">-};</span>
<a href="#l6.389"></a><span id="l6.389" class="difflineminus">-</span>
<a href="#l6.390"></a><span id="l6.390" class="difflineminus">-var gLogWritersById = new Map();</span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-function getLogWriter(aConversation) {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineminus">-  let id = aConversation.id;</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-  if (!gLogWritersById.has(id)) {</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-    let prefName =</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineminus">-      &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l6.396"></a><span id="l6.396" class="difflineminus">-    if (Services.prefs.getBoolPref(prefName)) {</span>
<a href="#l6.397"></a><span id="l6.397" class="difflineminus">-      gLogWritersById.set(id, new LogWriter(aConversation));</span>
<a href="#l6.398"></a><span id="l6.398" class="difflineminus">-    } else {</span>
<a href="#l6.399"></a><span id="l6.399" class="difflineminus">-      gLogWritersById.set(id, dummyLogWriter);</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-    }</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  }</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineminus">-  return gLogWritersById.get(id);</span>
<a href="#l6.403"></a><span id="l6.403" class="difflineminus">-}</span>
<a href="#l6.404"></a><span id="l6.404" class="difflineminus">-</span>
<a href="#l6.405"></a><span id="l6.405" class="difflineminus">-function closeLogWriter(aConversation) {</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-  gLogWritersById.delete(aConversation.id);</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-}</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-// LogWriter for system logs.</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineminus">-function SystemLogWriter(aAccount) {</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineminus">-  this.path = OS.Path.join(</span>
<a href="#l6.413"></a><span id="l6.413" class="difflineminus">-    getLogFolderPathForAccount(aAccount),</span>
<a href="#l6.414"></a><span id="l6.414" class="difflineminus">-    &quot;.system&quot;,</span>
<a href="#l6.415"></a><span id="l6.415" class="difflineminus">-    getNewLogFileName()</span>
<a href="#l6.416"></a><span id="l6.416" class="difflineminus">-  );</span>
<a href="#l6.417"></a><span id="l6.417" class="difflineminus">-  const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l6.418"></a><span id="l6.418" class="difflineminus">-    dateStyle: &quot;full&quot;,</span>
<a href="#l6.419"></a><span id="l6.419" class="difflineminus">-    timeStyle: &quot;long&quot;,</span>
<a href="#l6.420"></a><span id="l6.420" class="difflineminus">-  });</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineminus">-  let header =</span>
<a href="#l6.422"></a><span id="l6.422" class="difflineminus">-    &quot;System log for account &quot; +</span>
<a href="#l6.423"></a><span id="l6.423" class="difflineminus">-    aAccount.name +</span>
<a href="#l6.424"></a><span id="l6.424" class="difflineminus">-    &quot; (&quot; +</span>
<a href="#l6.425"></a><span id="l6.425" class="difflineminus">-    aAccount.protocol.normalizedName +</span>
<a href="#l6.426"></a><span id="l6.426" class="difflineminus">-    &quot;) connected at &quot; +</span>
<a href="#l6.427"></a><span id="l6.427" class="difflineminus">-    dateTimeFormatter.format(new Date()) +</span>
<a href="#l6.428"></a><span id="l6.428" class="difflineminus">-    kLineBreak;</span>
<a href="#l6.429"></a><span id="l6.429" class="difflineminus">-  this._initialized = appendToFile(</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-    this.path,</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-    this.encoder.encode(header),</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineminus">-    true</span>
<a href="#l6.433"></a><span id="l6.433" class="difflineminus">-  );</span>
<a href="#l6.434"></a><span id="l6.434" class="difflineminus">-  // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineminus">-  // writing the header failed.</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineminus">-  this._initialized.catch(aError =&gt;</span>
<a href="#l6.437"></a><span id="l6.437" class="difflineminus">-    Cu.reportError(&quot;Error initializing system log:\n&quot; + aError)</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-  );</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-}</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-SystemLogWriter.prototype = {</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineminus">-  encoder: new TextEncoder(),</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineminus">-  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l6.443"></a><span id="l6.443" class="difflineminus">-  // has been written.</span>
<a href="#l6.444"></a><span id="l6.444" class="difflineminus">-  _initialized: null,</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-  path: null,</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-  logEvent(aString) {</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineminus">-    let date = ToLocaleFormat(&quot;%x %X&quot;, new Date());</span>
<a href="#l6.448"></a><span id="l6.448" class="difflineminus">-    let lineToWrite = this.encoder.encode(</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-      &quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-    );</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineminus">-    this._initialized.then(() =&gt; {</span>
<a href="#l6.452"></a><span id="l6.452" class="difflineminus">-      appendToFile(this.path, lineToWrite).catch(aError =&gt;</span>
<a href="#l6.453"></a><span id="l6.453" class="difflineminus">-        Cu.reportError(&quot;Failed to log event:\n&quot; + aError)</span>
<a href="#l6.454"></a><span id="l6.454" class="difflineminus">-      );</span>
<a href="#l6.455"></a><span id="l6.455" class="difflineminus">-    });</span>
<a href="#l6.456"></a><span id="l6.456" class="difflineminus">-  },</span>
<a href="#l6.457"></a><span id="l6.457" class="difflineminus">-};</span>
<a href="#l6.458"></a><span id="l6.458" class="difflineminus">-</span>
<a href="#l6.459"></a><span id="l6.459" class="difflineminus">-var dummySystemLogWriter = {</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineminus">-  path: null,</span>
<a href="#l6.461"></a><span id="l6.461" class="difflineminus">-  logEvent() {},</span>
<a href="#l6.462"></a><span id="l6.462" class="difflineminus">-};</span>
<a href="#l6.463"></a><span id="l6.463" class="difflineminus">-</span>
<a href="#l6.464"></a><span id="l6.464" class="difflineminus">-var gSystemLogWritersById = new Map();</span>
<a href="#l6.465"></a><span id="l6.465" class="difflineminus">-function getSystemLogWriter(aAccount, aCreate) {</span>
<a href="#l6.466"></a><span id="l6.466" class="difflineminus">-  let id = aAccount.id;</span>
<a href="#l6.467"></a><span id="l6.467" class="difflineminus">-  if (aCreate) {</span>
<a href="#l6.468"></a><span id="l6.468" class="difflineminus">-    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;)) {</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-      return dummySystemLogWriter;</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineminus">-    }</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineminus">-    let writer = new SystemLogWriter(aAccount);</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineminus">-    gSystemLogWritersById.set(id, writer);</span>
<a href="#l6.473"></a><span id="l6.473" class="difflineminus">-    return writer;</span>
<a href="#l6.474"></a><span id="l6.474" class="difflineminus">-  }</span>
<a href="#l6.475"></a><span id="l6.475" class="difflineminus">-</span>
<a href="#l6.476"></a><span id="l6.476" class="difflineminus">-  return (</span>
<a href="#l6.477"></a><span id="l6.477" class="difflineminus">-    (gSystemLogWritersById.has(id) &amp;&amp; gSystemLogWritersById.get(id)) ||</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-    dummySystemLogWriter</span>
<a href="#l6.479"></a><span id="l6.479" class="difflineminus">-  );</span>
<a href="#l6.480"></a><span id="l6.480" class="difflineminus">-}</span>
<a href="#l6.481"></a><span id="l6.481" class="difflineminus">-</span>
<a href="#l6.482"></a><span id="l6.482" class="difflineminus">-function closeSystemLogWriter(aAccount) {</span>
<a href="#l6.483"></a><span id="l6.483" class="difflineminus">-  gSystemLogWritersById.delete(aAccount.id);</span>
<a href="#l6.484"></a><span id="l6.484" class="difflineminus">-}</span>
<a href="#l6.485"></a><span id="l6.485" class="difflineminus">-</span>
<a href="#l6.486"></a><span id="l6.486" class="difflineminus">-/**</span>
<a href="#l6.487"></a><span id="l6.487" class="difflineminus">- * Takes a properly formatted log file name and extracts the date information</span>
<a href="#l6.488"></a><span id="l6.488" class="difflineminus">- * and filetype, returning the results as an Array.</span>
<a href="#l6.489"></a><span id="l6.489" class="difflineminus">- *</span>
<a href="#l6.490"></a><span id="l6.490" class="difflineminus">- * Filenames are expected to be formatted as:</span>
<a href="#l6.491"></a><span id="l6.491" class="difflineminus">- *</span>
<a href="#l6.492"></a><span id="l6.492" class="difflineminus">- * YYYY-MM-DD.HHmmSS+ZZzz.format</span>
<a href="#l6.493"></a><span id="l6.493" class="difflineminus">- *</span>
<a href="#l6.494"></a><span id="l6.494" class="difflineminus">- * @param aFilename the name of the file</span>
<a href="#l6.495"></a><span id="l6.495" class="difflineminus">- * @returns an Array, where the first element is a Date object for the date</span>
<a href="#l6.496"></a><span id="l6.496" class="difflineminus">- *          that the log file represents, and the file type as a string.</span>
<a href="#l6.497"></a><span id="l6.497" class="difflineminus">- */</span>
<a href="#l6.498"></a><span id="l6.498" class="difflineminus">-function getDateFromFilename(aFilename) {</span>
<a href="#l6.499"></a><span id="l6.499" class="difflineminus">-  const kRegExp = /([\d]{4})-([\d]{2})-([\d]{2}).([\d]{2})([\d]{2})([\d]{2})([+-])([\d]{2})([\d]{2}).*\.([A-Za-z]+)$/;</span>
<a href="#l6.500"></a><span id="l6.500" class="difflineminus">-</span>
<a href="#l6.501"></a><span id="l6.501" class="difflineminus">-  let r = aFilename.match(kRegExp);</span>
<a href="#l6.502"></a><span id="l6.502" class="difflineminus">-  if (!r) {</span>
<a href="#l6.503"></a><span id="l6.503" class="difflineminus">-    Cu.reportError(</span>
<a href="#l6.504"></a><span id="l6.504" class="difflineminus">-      &quot;Found log file with name not matching YYYY-MM-DD.HHmmSS+ZZzz.format: &quot; +</span>
<a href="#l6.505"></a><span id="l6.505" class="difflineminus">-        aFilename</span>
<a href="#l6.506"></a><span id="l6.506" class="difflineminus">-    );</span>
<a href="#l6.507"></a><span id="l6.507" class="difflineminus">-    return [];</span>
<a href="#l6.508"></a><span id="l6.508" class="difflineminus">-  }</span>
<a href="#l6.509"></a><span id="l6.509" class="difflineminus">-</span>
<a href="#l6.510"></a><span id="l6.510" class="difflineminus">-  // We ignore the timezone offset for now (FIXME)</span>
<a href="#l6.511"></a><span id="l6.511" class="difflineminus">-  return [new Date(r[1], r[2] - 1, r[3], r[4], r[5], r[6]), r[10]];</span>
<a href="#l6.512"></a><span id="l6.512" class="difflineminus">-}</span>
<a href="#l6.513"></a><span id="l6.513" class="difflineminus">-</span>
<a href="#l6.514"></a><span id="l6.514" class="difflineminus">-/**</span>
<a href="#l6.515"></a><span id="l6.515" class="difflineminus">- * Returns true if a Conversation is both a chat conversation, and not</span>
<a href="#l6.516"></a><span id="l6.516" class="difflineminus">- * a Twitter conversation.</span>
<a href="#l6.517"></a><span id="l6.517" class="difflineminus">- */</span>
<a href="#l6.518"></a><span id="l6.518" class="difflineminus">-function convIsRealMUC(aConversation) {</span>
<a href="#l6.519"></a><span id="l6.519" class="difflineminus">-  return (</span>
<a href="#l6.520"></a><span id="l6.520" class="difflineminus">-    aConversation.isChat &amp;&amp; aConversation.account.protocol.id != &quot;prpl-twitter&quot;</span>
<a href="#l6.521"></a><span id="l6.521" class="difflineminus">-  );</span>
<a href="#l6.522"></a><span id="l6.522" class="difflineminus">-}</span>
<a href="#l6.523"></a><span id="l6.523" class="difflineminus">-</span>
<a href="#l6.524"></a><span id="l6.524" class="difflineminus">-function LogMessage(aData, aConversation) {</span>
<a href="#l6.525"></a><span id="l6.525" class="difflineminus">-  this._init(aData.who, aData.text);</span>
<a href="#l6.526"></a><span id="l6.526" class="difflineminus">-  this._conversation = aConversation;</span>
<a href="#l6.527"></a><span id="l6.527" class="difflineminus">-  this.time = Math.round(new Date(aData.date) / 1000);</span>
<a href="#l6.528"></a><span id="l6.528" class="difflineminus">-  if (&quot;alias&quot; in aData) {</span>
<a href="#l6.529"></a><span id="l6.529" class="difflineminus">-    this._alias = aData.alias;</span>
<a href="#l6.530"></a><span id="l6.530" class="difflineminus">-  }</span>
<a href="#l6.531"></a><span id="l6.531" class="difflineminus">-  for (let flag of aData.flags) {</span>
<a href="#l6.532"></a><span id="l6.532" class="difflineminus">-    this[flag] = true;</span>
<a href="#l6.533"></a><span id="l6.533" class="difflineminus">-  }</span>
<a href="#l6.534"></a><span id="l6.534" class="difflineminus">-}</span>
<a href="#l6.535"></a><span id="l6.535" class="difflineminus">-</span>
<a href="#l6.536"></a><span id="l6.536" class="difflineminus">-LogMessage.prototype = {</span>
<a href="#l6.537"></a><span id="l6.537" class="difflineminus">-  __proto__: GenericMessagePrototype,</span>
<a href="#l6.538"></a><span id="l6.538" class="difflineminus">-  _interfaces: [Ci.imIMessage, Ci.prplIMessage],</span>
<a href="#l6.539"></a><span id="l6.539" class="difflineminus">-  get displayMessage() {</span>
<a href="#l6.540"></a><span id="l6.540" class="difflineminus">-    return this.originalMessage;</span>
<a href="#l6.541"></a><span id="l6.541" class="difflineminus">-  },</span>
<a href="#l6.542"></a><span id="l6.542" class="difflineminus">-};</span>
<a href="#l6.543"></a><span id="l6.543" class="difflineminus">-</span>
<a href="#l6.544"></a><span id="l6.544" class="difflineminus">-function LogConversation(aMessages, aProperties) {</span>
<a href="#l6.545"></a><span id="l6.545" class="difflineminus">-  this._messages = aMessages;</span>
<a href="#l6.546"></a><span id="l6.546" class="difflineminus">-  for (let property in aProperties) {</span>
<a href="#l6.547"></a><span id="l6.547" class="difflineminus">-    this[property] = aProperties[property];</span>
<a href="#l6.548"></a><span id="l6.548" class="difflineminus">-  }</span>
<a href="#l6.549"></a><span id="l6.549" class="difflineminus">-}</span>
<a href="#l6.550"></a><span id="l6.550" class="difflineminus">-LogConversation.prototype = {</span>
<a href="#l6.551"></a><span id="l6.551" class="difflineminus">-  __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l6.552"></a><span id="l6.552" class="difflineminus">-  get isChat() {</span>
<a href="#l6.553"></a><span id="l6.553" class="difflineminus">-    return this._isChat;</span>
<a href="#l6.554"></a><span id="l6.554" class="difflineminus">-  },</span>
<a href="#l6.555"></a><span id="l6.555" class="difflineminus">-  get buddy() {</span>
<a href="#l6.556"></a><span id="l6.556" class="difflineminus">-    return null;</span>
<a href="#l6.557"></a><span id="l6.557" class="difflineminus">-  },</span>
<a href="#l6.558"></a><span id="l6.558" class="difflineminus">-  get account() {</span>
<a href="#l6.559"></a><span id="l6.559" class="difflineminus">-    return {</span>
<a href="#l6.560"></a><span id="l6.560" class="difflineminus">-      alias: &quot;&quot;,</span>
<a href="#l6.561"></a><span id="l6.561" class="difflineminus">-      name: this._accountName,</span>
<a href="#l6.562"></a><span id="l6.562" class="difflineminus">-      normalizedName: this._accountName,</span>
<a href="#l6.563"></a><span id="l6.563" class="difflineminus">-      protocol: { name: this._protocolName },</span>
<a href="#l6.564"></a><span id="l6.564" class="difflineminus">-      statusInfo: Services.core.globalUserStatus,</span>
<a href="#l6.565"></a><span id="l6.565" class="difflineminus">-    };</span>
<a href="#l6.566"></a><span id="l6.566" class="difflineminus">-  },</span>
<a href="#l6.567"></a><span id="l6.567" class="difflineminus">-  getMessages() {</span>
<a href="#l6.568"></a><span id="l6.568" class="difflineminus">-    return this._messages.map(m =&gt; new LogMessage(m, this));</span>
<a href="#l6.569"></a><span id="l6.569" class="difflineminus">-  },</span>
<a href="#l6.570"></a><span id="l6.570" class="difflineminus">-  getMessagesEnumerator(aMessageCount) {</span>
<a href="#l6.571"></a><span id="l6.571" class="difflineminus">-    if (aMessageCount) {</span>
<a href="#l6.572"></a><span id="l6.572" class="difflineminus">-      aMessageCount.value = this._messages.length;</span>
<a href="#l6.573"></a><span id="l6.573" class="difflineminus">-    }</span>
<a href="#l6.574"></a><span id="l6.574" class="difflineminus">-    let enumerator = {</span>
<a href="#l6.575"></a><span id="l6.575" class="difflineminus">-      _index: 0,</span>
<a href="#l6.576"></a><span id="l6.576" class="difflineminus">-      _conv: this,</span>
<a href="#l6.577"></a><span id="l6.577" class="difflineminus">-      _messages: this._messages,</span>
<a href="#l6.578"></a><span id="l6.578" class="difflineminus">-      hasMoreElements() {</span>
<a href="#l6.579"></a><span id="l6.579" class="difflineminus">-        return this._index &lt; this._messages.length;</span>
<a href="#l6.580"></a><span id="l6.580" class="difflineminus">-      },</span>
<a href="#l6.581"></a><span id="l6.581" class="difflineminus">-      getNext() {</span>
<a href="#l6.582"></a><span id="l6.582" class="difflineminus">-        return new LogMessage(this._messages[this._index++], this._conv);</span>
<a href="#l6.583"></a><span id="l6.583" class="difflineminus">-      },</span>
<a href="#l6.584"></a><span id="l6.584" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l6.585"></a><span id="l6.585" class="difflineminus">-      *[Symbol.iterator]() {</span>
<a href="#l6.586"></a><span id="l6.586" class="difflineminus">-        while (this.hasMoreElements()) {</span>
<a href="#l6.587"></a><span id="l6.587" class="difflineminus">-          yield this.getNext();</span>
<a href="#l6.588"></a><span id="l6.588" class="difflineminus">-        }</span>
<a href="#l6.589"></a><span id="l6.589" class="difflineminus">-      },</span>
<a href="#l6.590"></a><span id="l6.590" class="difflineminus">-    };</span>
<a href="#l6.591"></a><span id="l6.591" class="difflineminus">-    return enumerator;</span>
<a href="#l6.592"></a><span id="l6.592" class="difflineminus">-  },</span>
<a href="#l6.593"></a><span id="l6.593" class="difflineminus">-};</span>
<a href="#l6.594"></a><span id="l6.594" class="difflineminus">-</span>
<a href="#l6.595"></a><span id="l6.595" class="difflineminus">-/**</span>
<a href="#l6.596"></a><span id="l6.596" class="difflineminus">- * A Log object represents one or more log files. The constructor expects one</span>
<a href="#l6.597"></a><span id="l6.597" class="difflineminus">- * argument, which is either a single path to a (json or txt) log file or an</span>
<a href="#l6.598"></a><span id="l6.598" class="difflineminus">- * array of objects each having two properties:</span>
<a href="#l6.599"></a><span id="l6.599" class="difflineminus">- *   path: The full path of the (json only) log file it represents.</span>
<a href="#l6.600"></a><span id="l6.600" class="difflineminus">- *   time: The Date object extracted from the filename of the logfile.</span>
<a href="#l6.601"></a><span id="l6.601" class="difflineminus">- *</span>
<a href="#l6.602"></a><span id="l6.602" class="difflineminus">- * The returned Log object's time property will be:</span>
<a href="#l6.603"></a><span id="l6.603" class="difflineminus">- *   For a single file - exact time extracted from the name of the log file.</span>
<a href="#l6.604"></a><span id="l6.604" class="difflineminus">- *   For a set of files - the time extracted, reduced to the day.</span>
<a href="#l6.605"></a><span id="l6.605" class="difflineminus">- */</span>
<a href="#l6.606"></a><span id="l6.606" class="difflineminus">-function Log(aEntries) {</span>
<a href="#l6.607"></a><span id="l6.607" class="difflineminus">-  if (typeof aEntries == &quot;string&quot;) {</span>
<a href="#l6.608"></a><span id="l6.608" class="difflineminus">-    // Assume that aEntries is a single path.</span>
<a href="#l6.609"></a><span id="l6.609" class="difflineminus">-    let path = aEntries;</span>
<a href="#l6.610"></a><span id="l6.610" class="difflineminus">-    this.path = path;</span>
<a href="#l6.611"></a><span id="l6.611" class="difflineminus">-    let [date, format] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l6.612"></a><span id="l6.612" class="difflineminus">-    if (!date || !format) {</span>
<a href="#l6.613"></a><span id="l6.613" class="difflineminus">-      this.format = &quot;invalid&quot;;</span>
<a href="#l6.614"></a><span id="l6.614" class="difflineminus">-      this.time = 0;</span>
<a href="#l6.615"></a><span id="l6.615" class="difflineminus">-      return;</span>
<a href="#l6.616"></a><span id="l6.616" class="difflineminus">-    }</span>
<a href="#l6.617"></a><span id="l6.617" class="difflineminus">-    this.time = date.valueOf() / 1000;</span>
<a href="#l6.618"></a><span id="l6.618" class="difflineminus">-    this.format = format;</span>
<a href="#l6.619"></a><span id="l6.619" class="difflineminus">-    // Wrap the path in an array</span>
<a href="#l6.620"></a><span id="l6.620" class="difflineminus">-    this._entryPaths = [path];</span>
<a href="#l6.621"></a><span id="l6.621" class="difflineminus">-    return;</span>
<a href="#l6.622"></a><span id="l6.622" class="difflineminus">-  }</span>
<a href="#l6.623"></a><span id="l6.623" class="difflineminus">-</span>
<a href="#l6.624"></a><span id="l6.624" class="difflineminus">-  if (!aEntries.length) {</span>
<a href="#l6.625"></a><span id="l6.625" class="difflineminus">-    throw new Error(</span>
<a href="#l6.626"></a><span id="l6.626" class="difflineminus">-      &quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l6.627"></a><span id="l6.627" class="difflineminus">-        &quot;expected a non-empty array or a string.&quot;</span>
<a href="#l6.628"></a><span id="l6.628" class="difflineminus">-    );</span>
<a href="#l6.629"></a><span id="l6.629" class="difflineminus">-  }</span>
<a href="#l6.630"></a><span id="l6.630" class="difflineminus">-</span>
<a href="#l6.631"></a><span id="l6.631" class="difflineminus">-  // Assume aEntries is an array of objects.</span>
<a href="#l6.632"></a><span id="l6.632" class="difflineminus">-  // Sort our list of entries for this day in increasing order.</span>
<a href="#l6.633"></a><span id="l6.633" class="difflineminus">-  aEntries.sort((aLeft, aRight) =&gt; aLeft.time - aRight.time);</span>
<a href="#l6.634"></a><span id="l6.634" class="difflineminus">-</span>
<a href="#l6.635"></a><span id="l6.635" class="difflineminus">-  this._entryPaths = aEntries.map(entry =&gt; entry.path);</span>
<a href="#l6.636"></a><span id="l6.636" class="difflineminus">-  // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l6.637"></a><span id="l6.637" class="difflineminus">-  let timestamp = new Date(aEntries[0].time);</span>
<a href="#l6.638"></a><span id="l6.638" class="difflineminus">-  timestamp.setHours(0);</span>
<a href="#l6.639"></a><span id="l6.639" class="difflineminus">-  timestamp.setMinutes(0);</span>
<a href="#l6.640"></a><span id="l6.640" class="difflineminus">-  timestamp.setSeconds(0);</span>
<a href="#l6.641"></a><span id="l6.641" class="difflineminus">-  this.time = timestamp.valueOf() / 1000;</span>
<a href="#l6.642"></a><span id="l6.642" class="difflineminus">-  // Path is used to uniquely identify a Log, and sometimes used to</span>
<a href="#l6.643"></a><span id="l6.643" class="difflineminus">-  // quickly determine which directory a log file is from.  We'll use</span>
<a href="#l6.644"></a><span id="l6.644" class="difflineminus">-  // the first file's path.</span>
<a href="#l6.645"></a><span id="l6.645" class="difflineminus">-  this.path = aEntries[0].path;</span>
<a href="#l6.646"></a><span id="l6.646" class="difflineminus">-}</span>
<a href="#l6.647"></a><span id="l6.647" class="difflineminus">-Log.prototype = {</span>
<a href="#l6.648"></a><span id="l6.648" class="difflineminus">-  __proto__: ClassInfo(&quot;imILog&quot;, &quot;Log object&quot;),</span>
<a href="#l6.649"></a><span id="l6.649" class="difflineminus">-  _entryPaths: null,</span>
<a href="#l6.650"></a><span id="l6.650" class="difflineminus">-  format: &quot;json&quot;,</span>
<a href="#l6.651"></a><span id="l6.651" class="difflineminus">-  async getConversation() {</span>
<a href="#l6.652"></a><span id="l6.652" class="difflineminus">-    /*</span>
<a href="#l6.653"></a><span id="l6.653" class="difflineminus">-     * Read the set of log files asynchronously and return a promise that</span>
<a href="#l6.654"></a><span id="l6.654" class="difflineminus">-     * resolves to a LogConversation instance. Even if a file contains some</span>
<a href="#l6.655"></a><span id="l6.655" class="difflineminus">-     * junk (invalid JSON), messages that are valid will be read. If the first</span>
<a href="#l6.656"></a><span id="l6.656" class="difflineminus">-     * line of metadata is corrupt however, the data isn't useful and the</span>
<a href="#l6.657"></a><span id="l6.657" class="difflineminus">-     * promise will resolve to null.</span>
<a href="#l6.658"></a><span id="l6.658" class="difflineminus">-     */</span>
<a href="#l6.659"></a><span id="l6.659" class="difflineminus">-    if (this.format != &quot;json&quot;) {</span>
<a href="#l6.660"></a><span id="l6.660" class="difflineminus">-      return null;</span>
<a href="#l6.661"></a><span id="l6.661" class="difflineminus">-    }</span>
<a href="#l6.662"></a><span id="l6.662" class="difflineminus">-    let messages = [];</span>
<a href="#l6.663"></a><span id="l6.663" class="difflineminus">-    let properties = {};</span>
<a href="#l6.664"></a><span id="l6.664" class="difflineminus">-    let firstFile = true;</span>
<a href="#l6.665"></a><span id="l6.665" class="difflineminus">-    let decoder = new TextDecoder();</span>
<a href="#l6.666"></a><span id="l6.666" class="difflineminus">-    for (let path of this._entryPaths) {</span>
<a href="#l6.667"></a><span id="l6.667" class="difflineminus">-      let lines;</span>
<a href="#l6.668"></a><span id="l6.668" class="difflineminus">-      try {</span>
<a href="#l6.669"></a><span id="l6.669" class="difflineminus">-        let contents = await queueFileOperation(path, () =&gt; OS.File.read(path));</span>
<a href="#l6.670"></a><span id="l6.670" class="difflineminus">-        lines = decoder.decode(contents).split(&quot;\n&quot;);</span>
<a href="#l6.671"></a><span id="l6.671" class="difflineminus">-      } catch (aError) {</span>
<a href="#l6.672"></a><span id="l6.672" class="difflineminus">-        Cu.reportError('Error reading log file &quot;' + path + '&quot;:\n' + aError);</span>
<a href="#l6.673"></a><span id="l6.673" class="difflineminus">-        continue;</span>
<a href="#l6.674"></a><span id="l6.674" class="difflineminus">-      }</span>
<a href="#l6.675"></a><span id="l6.675" class="difflineminus">-      let nextLine = lines.shift();</span>
<a href="#l6.676"></a><span id="l6.676" class="difflineminus">-      let filename = OS.Path.basename(path);</span>
<a href="#l6.677"></a><span id="l6.677" class="difflineminus">-</span>
<a href="#l6.678"></a><span id="l6.678" class="difflineminus">-      let data;</span>
<a href="#l6.679"></a><span id="l6.679" class="difflineminus">-      try {</span>
<a href="#l6.680"></a><span id="l6.680" class="difflineminus">-        // This will fail if either nextLine is undefined, or not valid JSON.</span>
<a href="#l6.681"></a><span id="l6.681" class="difflineminus">-        data = JSON.parse(nextLine);</span>
<a href="#l6.682"></a><span id="l6.682" class="difflineminus">-      } catch (aError) {</span>
<a href="#l6.683"></a><span id="l6.683" class="difflineminus">-        messages.push({</span>
<a href="#l6.684"></a><span id="l6.684" class="difflineminus">-          who: &quot;sessionstart&quot;,</span>
<a href="#l6.685"></a><span id="l6.685" class="difflineminus">-          date: getDateFromFilename(filename)[0],</span>
<a href="#l6.686"></a><span id="l6.686" class="difflineminus">-          text: _(&quot;badLogfile&quot;, filename),</span>
<a href="#l6.687"></a><span id="l6.687" class="difflineminus">-          flags: [&quot;noLog&quot;, &quot;notification&quot;, &quot;error&quot;, &quot;system&quot;],</span>
<a href="#l6.688"></a><span id="l6.688" class="difflineminus">-        });</span>
<a href="#l6.689"></a><span id="l6.689" class="difflineminus">-        continue;</span>
<a href="#l6.690"></a><span id="l6.690" class="difflineminus">-      }</span>
<a href="#l6.691"></a><span id="l6.691" class="difflineminus">-</span>
<a href="#l6.692"></a><span id="l6.692" class="difflineminus">-      if (firstFile || !data.continuedSession) {</span>
<a href="#l6.693"></a><span id="l6.693" class="difflineminus">-        messages.push({</span>
<a href="#l6.694"></a><span id="l6.694" class="difflineminus">-          who: &quot;sessionstart&quot;,</span>
<a href="#l6.695"></a><span id="l6.695" class="difflineminus">-          date: getDateFromFilename(filename)[0],</span>
<a href="#l6.696"></a><span id="l6.696" class="difflineminus">-          text: &quot;&quot;,</span>
<a href="#l6.697"></a><span id="l6.697" class="difflineminus">-          flags: [&quot;noLog&quot;, &quot;notification&quot;],</span>
<a href="#l6.698"></a><span id="l6.698" class="difflineminus">-        });</span>
<a href="#l6.699"></a><span id="l6.699" class="difflineminus">-      }</span>
<a href="#l6.700"></a><span id="l6.700" class="difflineminus">-</span>
<a href="#l6.701"></a><span id="l6.701" class="difflineminus">-      if (firstFile) {</span>
<a href="#l6.702"></a><span id="l6.702" class="difflineminus">-        properties.startDate = new Date(data.date) * 1000;</span>
<a href="#l6.703"></a><span id="l6.703" class="difflineminus">-        properties.name = data.name;</span>
<a href="#l6.704"></a><span id="l6.704" class="difflineminus">-        properties.title = data.title;</span>
<a href="#l6.705"></a><span id="l6.705" class="difflineminus">-        properties._accountName = data.account;</span>
<a href="#l6.706"></a><span id="l6.706" class="difflineminus">-        properties._protocolName = data.protocol;</span>
<a href="#l6.707"></a><span id="l6.707" class="difflineminus">-        properties._isChat = data.isChat;</span>
<a href="#l6.708"></a><span id="l6.708" class="difflineminus">-        properties.normalizedName = data.normalizedName;</span>
<a href="#l6.709"></a><span id="l6.709" class="difflineminus">-        firstFile = false;</span>
<a href="#l6.710"></a><span id="l6.710" class="difflineminus">-      }</span>
<a href="#l6.711"></a><span id="l6.711" class="difflineminus">-</span>
<a href="#l6.712"></a><span id="l6.712" class="difflineminus">-      while (lines.length) {</span>
<a href="#l6.713"></a><span id="l6.713" class="difflineminus">-        nextLine = lines.shift();</span>
<a href="#l6.714"></a><span id="l6.714" class="difflineminus">-        if (!nextLine) {</span>
<a href="#l6.715"></a><span id="l6.715" class="difflineminus">-          break;</span>
<a href="#l6.716"></a><span id="l6.716" class="difflineminus">-        }</span>
<a href="#l6.717"></a><span id="l6.717" class="difflineminus">-        try {</span>
<a href="#l6.718"></a><span id="l6.718" class="difflineminus">-          messages.push(JSON.parse(nextLine));</span>
<a href="#l6.719"></a><span id="l6.719" class="difflineminus">-        } catch (e) {</span>
<a href="#l6.720"></a><span id="l6.720" class="difflineminus">-          // If a message line contains junk, just ignore the error and</span>
<a href="#l6.721"></a><span id="l6.721" class="difflineminus">-          // continue reading the conversation.</span>
<a href="#l6.722"></a><span id="l6.722" class="difflineminus">-        }</span>
<a href="#l6.723"></a><span id="l6.723" class="difflineminus">-      }</span>
<a href="#l6.724"></a><span id="l6.724" class="difflineminus">-    }</span>
<a href="#l6.725"></a><span id="l6.725" class="difflineminus">-</span>
<a href="#l6.726"></a><span id="l6.726" class="difflineminus">-    if (firstFile) {</span>
<a href="#l6.727"></a><span id="l6.727" class="difflineminus">-      // All selected log files are invalid.</span>
<a href="#l6.728"></a><span id="l6.728" class="difflineminus">-      return null;</span>
<a href="#l6.729"></a><span id="l6.729" class="difflineminus">-    }</span>
<a href="#l6.730"></a><span id="l6.730" class="difflineminus">-</span>
<a href="#l6.731"></a><span id="l6.731" class="difflineminus">-    return new LogConversation(messages, properties);</span>
<a href="#l6.732"></a><span id="l6.732" class="difflineminus">-  },</span>
<a href="#l6.733"></a><span id="l6.733" class="difflineminus">-};</span>
<a href="#l6.734"></a><span id="l6.734" class="difflineminus">-</span>
<a href="#l6.735"></a><span id="l6.735" class="difflineminus">-/**</span>
<a href="#l6.736"></a><span id="l6.736" class="difflineminus">- * Log enumerators provide lists of log files (&quot;entries&quot;). aEntries is an array</span>
<a href="#l6.737"></a><span id="l6.737" class="difflineminus">- * of the OS.File.DirectoryIterator.Entry instances which represent the log</span>
<a href="#l6.738"></a><span id="l6.738" class="difflineminus">- * files to be parsed.</span>
<a href="#l6.739"></a><span id="l6.739" class="difflineminus">- *</span>
<a href="#l6.740"></a><span id="l6.740" class="difflineminus">- * DailyLogEnumerator organizes entries by date, and enumerates them in order.</span>
<a href="#l6.741"></a><span id="l6.741" class="difflineminus">- * LogEnumerator enumerates logs in the same order as the input array.</span>
<a href="#l6.742"></a><span id="l6.742" class="difflineminus">- */</span>
<a href="#l6.743"></a><span id="l6.743" class="difflineminus">-function DailyLogEnumerator(aEntries) {</span>
<a href="#l6.744"></a><span id="l6.744" class="difflineminus">-  this._entries = {};</span>
<a href="#l6.745"></a><span id="l6.745" class="difflineminus">-</span>
<a href="#l6.746"></a><span id="l6.746" class="difflineminus">-  for (let entry of aEntries) {</span>
<a href="#l6.747"></a><span id="l6.747" class="difflineminus">-    let path = entry.path;</span>
<a href="#l6.748"></a><span id="l6.748" class="difflineminus">-</span>
<a href="#l6.749"></a><span id="l6.749" class="difflineminus">-    let [logDate, logFormat] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l6.750"></a><span id="l6.750" class="difflineminus">-    if (!logDate) {</span>
<a href="#l6.751"></a><span id="l6.751" class="difflineminus">-      // We'll skip this one, since it's got a busted filename.</span>
<a href="#l6.752"></a><span id="l6.752" class="difflineminus">-      continue;</span>
<a href="#l6.753"></a><span id="l6.753" class="difflineminus">-    }</span>
<a href="#l6.754"></a><span id="l6.754" class="difflineminus">-</span>
<a href="#l6.755"></a><span id="l6.755" class="difflineminus">-    let dateForID = new Date(logDate);</span>
<a href="#l6.756"></a><span id="l6.756" class="difflineminus">-    let dayID;</span>
<a href="#l6.757"></a><span id="l6.757" class="difflineminus">-    if (logFormat == &quot;json&quot;) {</span>
<a href="#l6.758"></a><span id="l6.758" class="difflineminus">-      // We want to cluster all of the logs that occur on the same day</span>
<a href="#l6.759"></a><span id="l6.759" class="difflineminus">-      // into the same Arrays. We clone the date for the log, reset it to</span>
<a href="#l6.760"></a><span id="l6.760" class="difflineminus">-      // the 0th hour/minute/second, and use that to construct an ID for the</span>
<a href="#l6.761"></a><span id="l6.761" class="difflineminus">-      // Array we'll put the log in.</span>
<a href="#l6.762"></a><span id="l6.762" class="difflineminus">-      dateForID.setHours(0);</span>
<a href="#l6.763"></a><span id="l6.763" class="difflineminus">-      dateForID.setMinutes(0);</span>
<a href="#l6.764"></a><span id="l6.764" class="difflineminus">-      dateForID.setSeconds(0);</span>
<a href="#l6.765"></a><span id="l6.765" class="difflineminus">-      dayID = dateForID.toISOString();</span>
<a href="#l6.766"></a><span id="l6.766" class="difflineminus">-</span>
<a href="#l6.767"></a><span id="l6.767" class="difflineminus">-      if (!(dayID in this._entries)) {</span>
<a href="#l6.768"></a><span id="l6.768" class="difflineminus">-        this._entries[dayID] = [];</span>
<a href="#l6.769"></a><span id="l6.769" class="difflineminus">-      }</span>
<a href="#l6.770"></a><span id="l6.770" class="difflineminus">-</span>
<a href="#l6.771"></a><span id="l6.771" class="difflineminus">-      this._entries[dayID].push({</span>
<a href="#l6.772"></a><span id="l6.772" class="difflineminus">-        path,</span>
<a href="#l6.773"></a><span id="l6.773" class="difflineminus">-        time: logDate,</span>
<a href="#l6.774"></a><span id="l6.774" class="difflineminus">-      });</span>
<a href="#l6.775"></a><span id="l6.775" class="difflineminus">-    } else {</span>
<a href="#l6.776"></a><span id="l6.776" class="difflineminus">-      // Add legacy text logs as individual paths.</span>
<a href="#l6.777"></a><span id="l6.777" class="difflineminus">-      dayID = dateForID.toISOString() + &quot;txt&quot;;</span>
<a href="#l6.778"></a><span id="l6.778" class="difflineminus">-      this._entries[dayID] = path;</span>
<a href="#l6.779"></a><span id="l6.779" class="difflineminus">-    }</span>
<a href="#l6.780"></a><span id="l6.780" class="difflineminus">-  }</span>
<a href="#l6.781"></a><span id="l6.781" class="difflineminus">-</span>
<a href="#l6.782"></a><span id="l6.782" class="difflineminus">-  this._days = Object.keys(this._entries).sort();</span>
<a href="#l6.783"></a><span id="l6.783" class="difflineminus">-  this._index = 0;</span>
<a href="#l6.784"></a><span id="l6.784" class="difflineminus">-}</span>
<a href="#l6.785"></a><span id="l6.785" class="difflineminus">-DailyLogEnumerator.prototype = {</span>
<a href="#l6.786"></a><span id="l6.786" class="difflineminus">-  _entries: {},</span>
<a href="#l6.787"></a><span id="l6.787" class="difflineminus">-  _days: [],</span>
<a href="#l6.788"></a><span id="l6.788" class="difflineminus">-  _index: 0,</span>
<a href="#l6.789"></a><span id="l6.789" class="difflineminus">-  hasMoreElements() {</span>
<a href="#l6.790"></a><span id="l6.790" class="difflineminus">-    return this._index &lt; this._days.length;</span>
<a href="#l6.791"></a><span id="l6.791" class="difflineminus">-  },</span>
<a href="#l6.792"></a><span id="l6.792" class="difflineminus">-  getNext() {</span>
<a href="#l6.793"></a><span id="l6.793" class="difflineminus">-    let dayID = this._days[this._index++];</span>
<a href="#l6.794"></a><span id="l6.794" class="difflineminus">-    return new Log(this._entries[dayID]);</span>
<a href="#l6.795"></a><span id="l6.795" class="difflineminus">-  },</span>
<a href="#l6.796"></a><span id="l6.796" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l6.797"></a><span id="l6.797" class="difflineminus">-  *[Symbol.iterator]() {</span>
<a href="#l6.798"></a><span id="l6.798" class="difflineminus">-    while (this.hasMoreElements()) {</span>
<a href="#l6.799"></a><span id="l6.799" class="difflineminus">-      yield this.getNext();</span>
<a href="#l6.800"></a><span id="l6.800" class="difflineminus">-    }</span>
<a href="#l6.801"></a><span id="l6.801" class="difflineminus">-  },</span>
<a href="#l6.802"></a><span id="l6.802" class="difflineminus">-};</span>
<a href="#l6.803"></a><span id="l6.803" class="difflineminus">-</span>
<a href="#l6.804"></a><span id="l6.804" class="difflineminus">-function LogEnumerator(aEntries) {</span>
<a href="#l6.805"></a><span id="l6.805" class="difflineminus">-  this._entries = aEntries;</span>
<a href="#l6.806"></a><span id="l6.806" class="difflineminus">-  this._entries.sort((a, b) =&gt; a.name &gt; b.name);</span>
<a href="#l6.807"></a><span id="l6.807" class="difflineminus">-}</span>
<a href="#l6.808"></a><span id="l6.808" class="difflineminus">-LogEnumerator.prototype = {</span>
<a href="#l6.809"></a><span id="l6.809" class="difflineminus">-  _entries: [],</span>
<a href="#l6.810"></a><span id="l6.810" class="difflineminus">-  hasMoreElements() {</span>
<a href="#l6.811"></a><span id="l6.811" class="difflineminus">-    return this._entries.length &gt; 0;</span>
<a href="#l6.812"></a><span id="l6.812" class="difflineminus">-  },</span>
<a href="#l6.813"></a><span id="l6.813" class="difflineminus">-  getNext() {</span>
<a href="#l6.814"></a><span id="l6.814" class="difflineminus">-    // Create and return a log from the first entry.</span>
<a href="#l6.815"></a><span id="l6.815" class="difflineminus">-    return new Log(this._entries.shift().path);</span>
<a href="#l6.816"></a><span id="l6.816" class="difflineminus">-  },</span>
<a href="#l6.817"></a><span id="l6.817" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l6.818"></a><span id="l6.818" class="difflineminus">-  *[Symbol.iterator]() {</span>
<a href="#l6.819"></a><span id="l6.819" class="difflineminus">-    while (this.hasMoreElements()) {</span>
<a href="#l6.820"></a><span id="l6.820" class="difflineminus">-      yield this.getNext();</span>
<a href="#l6.821"></a><span id="l6.821" class="difflineminus">-    }</span>
<a href="#l6.822"></a><span id="l6.822" class="difflineminus">-  },</span>
<a href="#l6.823"></a><span id="l6.823" class="difflineminus">-};</span>
<a href="#l6.824"></a><span id="l6.824" class="difflineminus">-</span>
<a href="#l6.825"></a><span id="l6.825" class="difflineminus">-function Logger() {}</span>
<a href="#l6.826"></a><span id="l6.826" class="difflineminus">-Logger.prototype = {</span>
<a href="#l6.827"></a><span id="l6.827" class="difflineminus">-  // Returned Promise resolves to an array of entries for the</span>
<a href="#l6.828"></a><span id="l6.828" class="difflineminus">-  // log folder if it exists, otherwise null.</span>
<a href="#l6.829"></a><span id="l6.829" class="difflineminus">-  async _getLogArray(aAccount, aNormalizedName) {</span>
<a href="#l6.830"></a><span id="l6.830" class="difflineminus">-    let iterator, path;</span>
<a href="#l6.831"></a><span id="l6.831" class="difflineminus">-    try {</span>
<a href="#l6.832"></a><span id="l6.832" class="difflineminus">-      path = OS.Path.join(</span>
<a href="#l6.833"></a><span id="l6.833" class="difflineminus">-        getLogFolderPathForAccount(aAccount),</span>
<a href="#l6.834"></a><span id="l6.834" class="difflineminus">-        encodeName(aNormalizedName)</span>
<a href="#l6.835"></a><span id="l6.835" class="difflineminus">-      );</span>
<a href="#l6.836"></a><span id="l6.836" class="difflineminus">-      if (await queueFileOperation(path, () =&gt; OS.File.exists(path))) {</span>
<a href="#l6.837"></a><span id="l6.837" class="difflineminus">-        iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l6.838"></a><span id="l6.838" class="difflineminus">-        let entries = await iterator.nextBatch();</span>
<a href="#l6.839"></a><span id="l6.839" class="difflineminus">-        iterator.close();</span>
<a href="#l6.840"></a><span id="l6.840" class="difflineminus">-        return entries;</span>
<a href="#l6.841"></a><span id="l6.841" class="difflineminus">-      }</span>
<a href="#l6.842"></a><span id="l6.842" class="difflineminus">-    } catch (aError) {</span>
<a href="#l6.843"></a><span id="l6.843" class="difflineminus">-      if (iterator) {</span>
<a href="#l6.844"></a><span id="l6.844" class="difflineminus">-        iterator.close();</span>
<a href="#l6.845"></a><span id="l6.845" class="difflineminus">-      }</span>
<a href="#l6.846"></a><span id="l6.846" class="difflineminus">-      Cu.reportError(</span>
<a href="#l6.847"></a><span id="l6.847" class="difflineminus">-        'Error getting directory entries for &quot;' + path + '&quot;:\n' + aError</span>
<a href="#l6.848"></a><span id="l6.848" class="difflineminus">-      );</span>
<a href="#l6.849"></a><span id="l6.849" class="difflineminus">-    }</span>
<a href="#l6.850"></a><span id="l6.850" class="difflineminus">-    return [];</span>
<a href="#l6.851"></a><span id="l6.851" class="difflineminus">-  },</span>
<a href="#l6.852"></a><span id="l6.852" class="difflineminus">-  getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l6.853"></a><span id="l6.853" class="difflineminus">-    if (!aGroupByDay) {</span>
<a href="#l6.854"></a><span id="l6.854" class="difflineminus">-      return Promise.resolve(new Log(aFilePath));</span>
<a href="#l6.855"></a><span id="l6.855" class="difflineminus">-    }</span>
<a href="#l6.856"></a><span id="l6.856" class="difflineminus">-    let [targetDate] = getDateFromFilename(OS.Path.basename(aFilePath));</span>
<a href="#l6.857"></a><span id="l6.857" class="difflineminus">-    if (!targetDate) {</span>
<a href="#l6.858"></a><span id="l6.858" class="difflineminus">-      return null;</span>
<a href="#l6.859"></a><span id="l6.859" class="difflineminus">-    }</span>
<a href="#l6.860"></a><span id="l6.860" class="difflineminus">-</span>
<a href="#l6.861"></a><span id="l6.861" class="difflineminus">-    targetDate = targetDate.toDateString();</span>
<a href="#l6.862"></a><span id="l6.862" class="difflineminus">-</span>
<a href="#l6.863"></a><span id="l6.863" class="difflineminus">-    // We'll assume that the files relevant to our interests are</span>
<a href="#l6.864"></a><span id="l6.864" class="difflineminus">-    // in the same folder as the one provided.</span>
<a href="#l6.865"></a><span id="l6.865" class="difflineminus">-    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aFilePath));</span>
<a href="#l6.866"></a><span id="l6.866" class="difflineminus">-    let relevantEntries = [];</span>
<a href="#l6.867"></a><span id="l6.867" class="difflineminus">-    return iterator</span>
<a href="#l6.868"></a><span id="l6.868" class="difflineminus">-      .forEach(function(aEntry) {</span>
<a href="#l6.869"></a><span id="l6.869" class="difflineminus">-        if (aEntry.isDir) {</span>
<a href="#l6.870"></a><span id="l6.870" class="difflineminus">-          return;</span>
<a href="#l6.871"></a><span id="l6.871" class="difflineminus">-        }</span>
<a href="#l6.872"></a><span id="l6.872" class="difflineminus">-        let path = aEntry.path;</span>
<a href="#l6.873"></a><span id="l6.873" class="difflineminus">-        let [logTime] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l6.874"></a><span id="l6.874" class="difflineminus">-</span>
<a href="#l6.875"></a><span id="l6.875" class="difflineminus">-        // If someone placed a 'foreign' file into the logs directory,</span>
<a href="#l6.876"></a><span id="l6.876" class="difflineminus">-        // pattern matching fails and getDateFromFilename() returns [].</span>
<a href="#l6.877"></a><span id="l6.877" class="difflineminus">-        if (logTime &amp;&amp; targetDate == logTime.toDateString()) {</span>
<a href="#l6.878"></a><span id="l6.878" class="difflineminus">-          relevantEntries.push({</span>
<a href="#l6.879"></a><span id="l6.879" class="difflineminus">-            path,</span>
<a href="#l6.880"></a><span id="l6.880" class="difflineminus">-            time: logTime,</span>
<a href="#l6.881"></a><span id="l6.881" class="difflineminus">-          });</span>
<a href="#l6.882"></a><span id="l6.882" class="difflineminus">-        }</span>
<a href="#l6.883"></a><span id="l6.883" class="difflineminus">-      })</span>
<a href="#l6.884"></a><span id="l6.884" class="difflineminus">-      .then(</span>
<a href="#l6.885"></a><span id="l6.885" class="difflineminus">-        () =&gt; {</span>
<a href="#l6.886"></a><span id="l6.886" class="difflineminus">-          iterator.close();</span>
<a href="#l6.887"></a><span id="l6.887" class="difflineminus">-          return new Log(relevantEntries);</span>
<a href="#l6.888"></a><span id="l6.888" class="difflineminus">-        },</span>
<a href="#l6.889"></a><span id="l6.889" class="difflineminus">-        aError =&gt; {</span>
<a href="#l6.890"></a><span id="l6.890" class="difflineminus">-          iterator.close();</span>
<a href="#l6.891"></a><span id="l6.891" class="difflineminus">-          throw aError;</span>
<a href="#l6.892"></a><span id="l6.892" class="difflineminus">-        }</span>
<a href="#l6.893"></a><span id="l6.893" class="difflineminus">-      );</span>
<a href="#l6.894"></a><span id="l6.894" class="difflineminus">-  },</span>
<a href="#l6.895"></a><span id="l6.895" class="difflineminus">-  // Creates and returns the appropriate LogEnumerator for the given log array</span>
<a href="#l6.896"></a><span id="l6.896" class="difflineminus">-  // depending on aGroupByDay, or an EmptyEnumerator if the input array is empty.</span>
<a href="#l6.897"></a><span id="l6.897" class="difflineminus">-  _getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l6.898"></a><span id="l6.898" class="difflineminus">-    let enumerator = aGroupByDay ? DailyLogEnumerator : LogEnumerator;</span>
<a href="#l6.899"></a><span id="l6.899" class="difflineminus">-    return aLogArray.length ? new enumerator(aLogArray) : EmptyEnumerator;</span>
<a href="#l6.900"></a><span id="l6.900" class="difflineminus">-  },</span>
<a href="#l6.901"></a><span id="l6.901" class="difflineminus">-  async getLogPathsForConversation(aConversation) {</span>
<a href="#l6.902"></a><span id="l6.902" class="difflineminus">-    let writer = gLogWritersById.get(aConversation.id);</span>
<a href="#l6.903"></a><span id="l6.903" class="difflineminus">-    // Resolve to null if we haven't created a LogWriter yet for this conv, or</span>
<a href="#l6.904"></a><span id="l6.904" class="difflineminus">-    // if logging is disabled (paths will be null).</span>
<a href="#l6.905"></a><span id="l6.905" class="difflineminus">-    if (!writer || !writer.paths) {</span>
<a href="#l6.906"></a><span id="l6.906" class="difflineminus">-      return null;</span>
<a href="#l6.907"></a><span id="l6.907" class="difflineminus">-    }</span>
<a href="#l6.908"></a><span id="l6.908" class="difflineminus">-    let paths = writer.paths;</span>
<a href="#l6.909"></a><span id="l6.909" class="difflineminus">-    // Wait for any pending file operations to finish, then resolve to the paths</span>
<a href="#l6.910"></a><span id="l6.910" class="difflineminus">-    // regardless of whether these operations succeeded.</span>
<a href="#l6.911"></a><span id="l6.911" class="difflineminus">-    for (let path of paths) {</span>
<a href="#l6.912"></a><span id="l6.912" class="difflineminus">-      await fileOperations.get(path);</span>
<a href="#l6.913"></a><span id="l6.913" class="difflineminus">-    }</span>
<a href="#l6.914"></a><span id="l6.914" class="difflineminus">-    return paths;</span>
<a href="#l6.915"></a><span id="l6.915" class="difflineminus">-  },</span>
<a href="#l6.916"></a><span id="l6.916" class="difflineminus">-  getLogsForAccountAndName(aAccount, aNormalizedName, aGroupByDay) {</span>
<a href="#l6.917"></a><span id="l6.917" class="difflineminus">-    return this._getLogArray(aAccount, aNormalizedName).then(aEntries =&gt;</span>
<a href="#l6.918"></a><span id="l6.918" class="difflineminus">-      this._getEnumerator(aEntries, aGroupByDay)</span>
<a href="#l6.919"></a><span id="l6.919" class="difflineminus">-    );</span>
<a href="#l6.920"></a><span id="l6.920" class="difflineminus">-  },</span>
<a href="#l6.921"></a><span id="l6.921" class="difflineminus">-  getLogsForAccountBuddy(aAccountBuddy, aGroupByDay) {</span>
<a href="#l6.922"></a><span id="l6.922" class="difflineminus">-    return this.getLogsForAccountAndName(</span>
<a href="#l6.923"></a><span id="l6.923" class="difflineminus">-      aAccountBuddy.account,</span>
<a href="#l6.924"></a><span id="l6.924" class="difflineminus">-      aAccountBuddy.normalizedName,</span>
<a href="#l6.925"></a><span id="l6.925" class="difflineminus">-      aGroupByDay</span>
<a href="#l6.926"></a><span id="l6.926" class="difflineminus">-    );</span>
<a href="#l6.927"></a><span id="l6.927" class="difflineminus">-  },</span>
<a href="#l6.928"></a><span id="l6.928" class="difflineminus">-  async getLogsForBuddy(aBuddy, aGroupByDay) {</span>
<a href="#l6.929"></a><span id="l6.929" class="difflineminus">-    let entries = [];</span>
<a href="#l6.930"></a><span id="l6.930" class="difflineminus">-    for (let accountBuddy of aBuddy.getAccountBuddies()) {</span>
<a href="#l6.931"></a><span id="l6.931" class="difflineminus">-      entries = entries.concat(</span>
<a href="#l6.932"></a><span id="l6.932" class="difflineminus">-        await this._getLogArray(</span>
<a href="#l6.933"></a><span id="l6.933" class="difflineminus">-          accountBuddy.account,</span>
<a href="#l6.934"></a><span id="l6.934" class="difflineminus">-          accountBuddy.normalizedName</span>
<a href="#l6.935"></a><span id="l6.935" class="difflineminus">-        )</span>
<a href="#l6.936"></a><span id="l6.936" class="difflineminus">-      );</span>
<a href="#l6.937"></a><span id="l6.937" class="difflineminus">-    }</span>
<a href="#l6.938"></a><span id="l6.938" class="difflineminus">-    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l6.939"></a><span id="l6.939" class="difflineminus">-  },</span>
<a href="#l6.940"></a><span id="l6.940" class="difflineminus">-  async getLogsForContact(aContact, aGroupByDay) {</span>
<a href="#l6.941"></a><span id="l6.941" class="difflineminus">-    let entries = [];</span>
<a href="#l6.942"></a><span id="l6.942" class="difflineminus">-    for (let buddy of aContact.getBuddies()) {</span>
<a href="#l6.943"></a><span id="l6.943" class="difflineminus">-      for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l6.944"></a><span id="l6.944" class="difflineminus">-        entries = entries.concat(</span>
<a href="#l6.945"></a><span id="l6.945" class="difflineminus">-          await this._getLogArray(</span>
<a href="#l6.946"></a><span id="l6.946" class="difflineminus">-            accountBuddy.account,</span>
<a href="#l6.947"></a><span id="l6.947" class="difflineminus">-            accountBuddy.normalizedName</span>
<a href="#l6.948"></a><span id="l6.948" class="difflineminus">-          )</span>
<a href="#l6.949"></a><span id="l6.949" class="difflineminus">-        );</span>
<a href="#l6.950"></a><span id="l6.950" class="difflineminus">-      }</span>
<a href="#l6.951"></a><span id="l6.951" class="difflineminus">-    }</span>
<a href="#l6.952"></a><span id="l6.952" class="difflineminus">-    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l6.953"></a><span id="l6.953" class="difflineminus">-  },</span>
<a href="#l6.954"></a><span id="l6.954" class="difflineminus">-  getLogsForConversation(aConversation, aGroupByDay) {</span>
<a href="#l6.955"></a><span id="l6.955" class="difflineminus">-    let name = aConversation.normalizedName;</span>
<a href="#l6.956"></a><span id="l6.956" class="difflineminus">-    if (convIsRealMUC(aConversation)) {</span>
<a href="#l6.957"></a><span id="l6.957" class="difflineminus">-      name += &quot;.chat&quot;;</span>
<a href="#l6.958"></a><span id="l6.958" class="difflineminus">-    }</span>
<a href="#l6.959"></a><span id="l6.959" class="difflineminus">-    return this.getLogsForAccountAndName(</span>
<a href="#l6.960"></a><span id="l6.960" class="difflineminus">-      aConversation.account,</span>
<a href="#l6.961"></a><span id="l6.961" class="difflineminus">-      name,</span>
<a href="#l6.962"></a><span id="l6.962" class="difflineminus">-      aGroupByDay</span>
<a href="#l6.963"></a><span id="l6.963" class="difflineminus">-    );</span>
<a href="#l6.964"></a><span id="l6.964" class="difflineminus">-  },</span>
<a href="#l6.965"></a><span id="l6.965" class="difflineminus">-  getSystemLogsForAccount(aAccount) {</span>
<a href="#l6.966"></a><span id="l6.966" class="difflineminus">-    return this.getLogsForAccountAndName(aAccount, &quot;.system&quot;);</span>
<a href="#l6.967"></a><span id="l6.967" class="difflineminus">-  },</span>
<a href="#l6.968"></a><span id="l6.968" class="difflineminus">-  async getSimilarLogs(aLog, aGroupByDay) {</span>
<a href="#l6.969"></a><span id="l6.969" class="difflineminus">-    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l6.970"></a><span id="l6.970" class="difflineminus">-    let entries;</span>
<a href="#l6.971"></a><span id="l6.971" class="difflineminus">-    try {</span>
<a href="#l6.972"></a><span id="l6.972" class="difflineminus">-      entries = await iterator.nextBatch();</span>
<a href="#l6.973"></a><span id="l6.973" class="difflineminus">-    } catch (aError) {</span>
<a href="#l6.974"></a><span id="l6.974" class="difflineminus">-      Cu.reportError(</span>
<a href="#l6.975"></a><span id="l6.975" class="difflineminus">-        'Error getting similar logs for &quot;' + aLog.path + '&quot;:\n' + aError</span>
<a href="#l6.976"></a><span id="l6.976" class="difflineminus">-      );</span>
<a href="#l6.977"></a><span id="l6.977" class="difflineminus">-    }</span>
<a href="#l6.978"></a><span id="l6.978" class="difflineminus">-    // If there was an error, this will return an EmptyEnumerator.</span>
<a href="#l6.979"></a><span id="l6.979" class="difflineminus">-    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l6.980"></a><span id="l6.980" class="difflineminus">-  },</span>
<a href="#l6.981"></a><span id="l6.981" class="difflineminus">-</span>
<a href="#l6.982"></a><span id="l6.982" class="difflineminus">-  getLogFolderPathForAccount(aAccount) {</span>
<a href="#l6.983"></a><span id="l6.983" class="difflineminus">-    return getLogFolderPathForAccount(aAccount);</span>
<a href="#l6.984"></a><span id="l6.984" class="difflineminus">-  },</span>
<a href="#l6.985"></a><span id="l6.985" class="difflineminus">-</span>
<a href="#l6.986"></a><span id="l6.986" class="difflineminus">-  deleteLogFolderForAccount(aAccount) {</span>
<a href="#l6.987"></a><span id="l6.987" class="difflineminus">-    if (!aAccount.disconnecting &amp;&amp; !aAccount.disconnected) {</span>
<a href="#l6.988"></a><span id="l6.988" class="difflineminus">-      throw new Error(</span>
<a href="#l6.989"></a><span id="l6.989" class="difflineminus">-        &quot;Account must be disconnected first before deleting logs.&quot;</span>
<a href="#l6.990"></a><span id="l6.990" class="difflineminus">-      );</span>
<a href="#l6.991"></a><span id="l6.991" class="difflineminus">-    }</span>
<a href="#l6.992"></a><span id="l6.992" class="difflineminus">-</span>
<a href="#l6.993"></a><span id="l6.993" class="difflineminus">-    if (aAccount.disconnecting) {</span>
<a href="#l6.994"></a><span id="l6.994" class="difflineminus">-      Cu.reportError(</span>
<a href="#l6.995"></a><span id="l6.995" class="difflineminus">-        &quot;Account is still disconnecting while we attempt to remove logs.&quot;</span>
<a href="#l6.996"></a><span id="l6.996" class="difflineminus">-      );</span>
<a href="#l6.997"></a><span id="l6.997" class="difflineminus">-    }</span>
<a href="#l6.998"></a><span id="l6.998" class="difflineminus">-</span>
<a href="#l6.999"></a><span id="l6.999" class="difflineminus">-    let logPath = this.getLogFolderPathForAccount(aAccount);</span>
<a href="#l6.1000"></a><span id="l6.1000" class="difflineminus">-    // Find all operations on files inside the log folder.</span>
<a href="#l6.1001"></a><span id="l6.1001" class="difflineminus">-    let pendingPromises = [];</span>
<a href="#l6.1002"></a><span id="l6.1002" class="difflineminus">-    function checkLogFiles(promiseOperation, filePath) {</span>
<a href="#l6.1003"></a><span id="l6.1003" class="difflineminus">-      if (filePath.startsWith(logPath)) {</span>
<a href="#l6.1004"></a><span id="l6.1004" class="difflineminus">-        pendingPromises.push(promiseOperation);</span>
<a href="#l6.1005"></a><span id="l6.1005" class="difflineminus">-      }</span>
<a href="#l6.1006"></a><span id="l6.1006" class="difflineminus">-    }</span>
<a href="#l6.1007"></a><span id="l6.1007" class="difflineminus">-    fileOperations.forEach(checkLogFiles);</span>
<a href="#l6.1008"></a><span id="l6.1008" class="difflineminus">-    // After all operations finish, remove the whole log folder.</span>
<a href="#l6.1009"></a><span id="l6.1009" class="difflineminus">-    return Promise.all(pendingPromises)</span>
<a href="#l6.1010"></a><span id="l6.1010" class="difflineminus">-      .then(values =&gt; {</span>
<a href="#l6.1011"></a><span id="l6.1011" class="difflineminus">-        OS.File.removeDir(logPath, { ignoreAbsent: true });</span>
<a href="#l6.1012"></a><span id="l6.1012" class="difflineminus">-      })</span>
<a href="#l6.1013"></a><span id="l6.1013" class="difflineminus">-      .catch(aError =&gt;</span>
<a href="#l6.1014"></a><span id="l6.1014" class="difflineminus">-        Cu.reportError(&quot;Failed to remove log folders:\n&quot; + aError)</span>
<a href="#l6.1015"></a><span id="l6.1015" class="difflineminus">-      );</span>
<a href="#l6.1016"></a><span id="l6.1016" class="difflineminus">-  },</span>
<a href="#l6.1017"></a><span id="l6.1017" class="difflineminus">-</span>
<a href="#l6.1018"></a><span id="l6.1018" class="difflineminus">-  async forEach(aCallback) {</span>
<a href="#l6.1019"></a><span id="l6.1019" class="difflineminus">-    let getAllSubdirs = async function(aPaths, aErrorMsg) {</span>
<a href="#l6.1020"></a><span id="l6.1020" class="difflineminus">-      let entries = [];</span>
<a href="#l6.1021"></a><span id="l6.1021" class="difflineminus">-      for (let path of aPaths) {</span>
<a href="#l6.1022"></a><span id="l6.1022" class="difflineminus">-        let iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l6.1023"></a><span id="l6.1023" class="difflineminus">-        try {</span>
<a href="#l6.1024"></a><span id="l6.1024" class="difflineminus">-          entries = entries.concat(await iterator.nextBatch());</span>
<a href="#l6.1025"></a><span id="l6.1025" class="difflineminus">-        } catch (aError) {</span>
<a href="#l6.1026"></a><span id="l6.1026" class="difflineminus">-          if (aErrorMsg) {</span>
<a href="#l6.1027"></a><span id="l6.1027" class="difflineminus">-            Cu.reportError(aErrorMsg + &quot;\n&quot; + aError);</span>
<a href="#l6.1028"></a><span id="l6.1028" class="difflineminus">-          }</span>
<a href="#l6.1029"></a><span id="l6.1029" class="difflineminus">-        } finally {</span>
<a href="#l6.1030"></a><span id="l6.1030" class="difflineminus">-          iterator.close();</span>
<a href="#l6.1031"></a><span id="l6.1031" class="difflineminus">-        }</span>
<a href="#l6.1032"></a><span id="l6.1032" class="difflineminus">-      }</span>
<a href="#l6.1033"></a><span id="l6.1033" class="difflineminus">-      entries = entries</span>
<a href="#l6.1034"></a><span id="l6.1034" class="difflineminus">-        .filter(aEntry =&gt; aEntry.isDir)</span>
<a href="#l6.1035"></a><span id="l6.1035" class="difflineminus">-        .map(aEntry =&gt; aEntry.path);</span>
<a href="#l6.1036"></a><span id="l6.1036" class="difflineminus">-      return entries;</span>
<a href="#l6.1037"></a><span id="l6.1037" class="difflineminus">-    };</span>
<a href="#l6.1038"></a><span id="l6.1038" class="difflineminus">-</span>
<a href="#l6.1039"></a><span id="l6.1039" class="difflineminus">-    let logsPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l6.1040"></a><span id="l6.1040" class="difflineminus">-    let prpls = await getAllSubdirs([logsPath]);</span>
<a href="#l6.1041"></a><span id="l6.1041" class="difflineminus">-    let accounts = await getAllSubdirs(</span>
<a href="#l6.1042"></a><span id="l6.1042" class="difflineminus">-      prpls,</span>
<a href="#l6.1043"></a><span id="l6.1043" class="difflineminus">-      &quot;Error while sweeping prpl folder:&quot;</span>
<a href="#l6.1044"></a><span id="l6.1044" class="difflineminus">-    );</span>
<a href="#l6.1045"></a><span id="l6.1045" class="difflineminus">-    let logFolders = await getAllSubdirs(</span>
<a href="#l6.1046"></a><span id="l6.1046" class="difflineminus">-      accounts,</span>
<a href="#l6.1047"></a><span id="l6.1047" class="difflineminus">-      &quot;Error while sweeping account folder:&quot;</span>
<a href="#l6.1048"></a><span id="l6.1048" class="difflineminus">-    );</span>
<a href="#l6.1049"></a><span id="l6.1049" class="difflineminus">-    for (let folder of logFolders) {</span>
<a href="#l6.1050"></a><span id="l6.1050" class="difflineminus">-      let iterator = new OS.File.DirectoryIterator(folder);</span>
<a href="#l6.1051"></a><span id="l6.1051" class="difflineminus">-      try {</span>
<a href="#l6.1052"></a><span id="l6.1052" class="difflineminus">-        await iterator.forEach(aEntry =&gt; {</span>
<a href="#l6.1053"></a><span id="l6.1053" class="difflineminus">-          if (aEntry.isDir || !aEntry.name.endsWith(&quot;.json&quot;)) {</span>
<a href="#l6.1054"></a><span id="l6.1054" class="difflineminus">-            return null;</span>
<a href="#l6.1055"></a><span id="l6.1055" class="difflineminus">-          }</span>
<a href="#l6.1056"></a><span id="l6.1056" class="difflineminus">-          return aCallback.processLog(aEntry.path);</span>
<a href="#l6.1057"></a><span id="l6.1057" class="difflineminus">-        });</span>
<a href="#l6.1058"></a><span id="l6.1058" class="difflineminus">-      } catch (aError) {</span>
<a href="#l6.1059"></a><span id="l6.1059" class="difflineminus">-        // If the callback threw, reject the promise and let the caller handle it.</span>
<a href="#l6.1060"></a><span id="l6.1060" class="difflineminus">-        if (!(aError instanceof OS.File.Error)) {</span>
<a href="#l6.1061"></a><span id="l6.1061" class="difflineminus">-          throw aError;</span>
<a href="#l6.1062"></a><span id="l6.1062" class="difflineminus">-        }</span>
<a href="#l6.1063"></a><span id="l6.1063" class="difflineminus">-        Cu.reportError(&quot;Error sweeping log folder:\n&quot; + aError);</span>
<a href="#l6.1064"></a><span id="l6.1064" class="difflineminus">-      } finally {</span>
<a href="#l6.1065"></a><span id="l6.1065" class="difflineminus">-        iterator.close();</span>
<a href="#l6.1066"></a><span id="l6.1066" class="difflineminus">-      }</span>
<a href="#l6.1067"></a><span id="l6.1067" class="difflineminus">-    }</span>
<a href="#l6.1068"></a><span id="l6.1068" class="difflineminus">-  },</span>
<a href="#l6.1069"></a><span id="l6.1069" class="difflineminus">-</span>
<a href="#l6.1070"></a><span id="l6.1070" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l6.1071"></a><span id="l6.1071" class="difflineminus">-    switch (aTopic) {</span>
<a href="#l6.1072"></a><span id="l6.1072" class="difflineminus">-      case &quot;profile-after-change&quot;:</span>
<a href="#l6.1073"></a><span id="l6.1073" class="difflineminus">-        Services.obs.addObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l6.1074"></a><span id="l6.1074" class="difflineminus">-        break;</span>
<a href="#l6.1075"></a><span id="l6.1075" class="difflineminus">-      case &quot;final-ui-startup&quot;:</span>
<a href="#l6.1076"></a><span id="l6.1076" class="difflineminus">-        Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l6.1077"></a><span id="l6.1077" class="difflineminus">-        [</span>
<a href="#l6.1078"></a><span id="l6.1078" class="difflineminus">-          &quot;new-text&quot;,</span>
<a href="#l6.1079"></a><span id="l6.1079" class="difflineminus">-          &quot;conversation-closed&quot;,</span>
<a href="#l6.1080"></a><span id="l6.1080" class="difflineminus">-          &quot;conversation-left-chat&quot;,</span>
<a href="#l6.1081"></a><span id="l6.1081" class="difflineminus">-          &quot;account-connected&quot;,</span>
<a href="#l6.1082"></a><span id="l6.1082" class="difflineminus">-          &quot;account-disconnected&quot;,</span>
<a href="#l6.1083"></a><span id="l6.1083" class="difflineminus">-          &quot;account-buddy-status-changed&quot;,</span>
<a href="#l6.1084"></a><span id="l6.1084" class="difflineminus">-        ].forEach(function(aEvent) {</span>
<a href="#l6.1085"></a><span id="l6.1085" class="difflineminus">-          Services.obs.addObserver(this, aEvent);</span>
<a href="#l6.1086"></a><span id="l6.1086" class="difflineminus">-        }, this);</span>
<a href="#l6.1087"></a><span id="l6.1087" class="difflineminus">-        break;</span>
<a href="#l6.1088"></a><span id="l6.1088" class="difflineminus">-      case &quot;new-text&quot;:</span>
<a href="#l6.1089"></a><span id="l6.1089" class="difflineminus">-        let excludeBecauseEncrypted = false;</span>
<a href="#l6.1090"></a><span id="l6.1090" class="difflineminus">-        if (aSubject.encrypted) {</span>
<a href="#l6.1091"></a><span id="l6.1091" class="difflineminus">-          excludeBecauseEncrypted = !Services.prefs.getBoolPref(</span>
<a href="#l6.1092"></a><span id="l6.1092" class="difflineminus">-            &quot;messenger.account.&quot; +</span>
<a href="#l6.1093"></a><span id="l6.1093" class="difflineminus">-              aSubject.conversation.account.id +</span>
<a href="#l6.1094"></a><span id="l6.1094" class="difflineminus">-              &quot;.options.otrAllowMsgLog&quot;,</span>
<a href="#l6.1095"></a><span id="l6.1095" class="difflineminus">-            Services.prefs.getBoolPref(&quot;chat.otr.default.allowMsgLog&quot;)</span>
<a href="#l6.1096"></a><span id="l6.1096" class="difflineminus">-          );</span>
<a href="#l6.1097"></a><span id="l6.1097" class="difflineminus">-        }</span>
<a href="#l6.1098"></a><span id="l6.1098" class="difflineminus">-        if (!aSubject.noLog &amp;&amp; !excludeBecauseEncrypted) {</span>
<a href="#l6.1099"></a><span id="l6.1099" class="difflineminus">-          let log = getLogWriter(aSubject.conversation);</span>
<a href="#l6.1100"></a><span id="l6.1100" class="difflineminus">-          log.logMessage(aSubject);</span>
<a href="#l6.1101"></a><span id="l6.1101" class="difflineminus">-        }</span>
<a href="#l6.1102"></a><span id="l6.1102" class="difflineminus">-        break;</span>
<a href="#l6.1103"></a><span id="l6.1103" class="difflineminus">-      case &quot;conversation-closed&quot;:</span>
<a href="#l6.1104"></a><span id="l6.1104" class="difflineminus">-      case &quot;conversation-left-chat&quot;:</span>
<a href="#l6.1105"></a><span id="l6.1105" class="difflineminus">-        closeLogWriter(aSubject);</span>
<a href="#l6.1106"></a><span id="l6.1106" class="difflineminus">-        break;</span>
<a href="#l6.1107"></a><span id="l6.1107" class="difflineminus">-      case &quot;account-connected&quot;:</span>
<a href="#l6.1108"></a><span id="l6.1108" class="difflineminus">-        getSystemLogWriter(aSubject, true).logEvent(</span>
<a href="#l6.1109"></a><span id="l6.1109" class="difflineminus">-          &quot;+++ &quot; + aSubject.name + &quot; signed on&quot;</span>
<a href="#l6.1110"></a><span id="l6.1110" class="difflineminus">-        );</span>
<a href="#l6.1111"></a><span id="l6.1111" class="difflineminus">-        break;</span>
<a href="#l6.1112"></a><span id="l6.1112" class="difflineminus">-      case &quot;account-disconnected&quot;:</span>
<a href="#l6.1113"></a><span id="l6.1113" class="difflineminus">-        getSystemLogWriter(aSubject).logEvent(</span>
<a href="#l6.1114"></a><span id="l6.1114" class="difflineminus">-          &quot;+++ &quot; + aSubject.name + &quot; signed off&quot;</span>
<a href="#l6.1115"></a><span id="l6.1115" class="difflineminus">-        );</span>
<a href="#l6.1116"></a><span id="l6.1116" class="difflineminus">-        closeSystemLogWriter(aSubject);</span>
<a href="#l6.1117"></a><span id="l6.1117" class="difflineminus">-        break;</span>
<a href="#l6.1118"></a><span id="l6.1118" class="difflineminus">-      case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l6.1119"></a><span id="l6.1119" class="difflineminus">-        let status;</span>
<a href="#l6.1120"></a><span id="l6.1120" class="difflineminus">-        if (!aSubject.online) {</span>
<a href="#l6.1121"></a><span id="l6.1121" class="difflineminus">-          status = &quot;Offline&quot;;</span>
<a href="#l6.1122"></a><span id="l6.1122" class="difflineminus">-        } else if (aSubject.mobile) {</span>
<a href="#l6.1123"></a><span id="l6.1123" class="difflineminus">-          status = &quot;Mobile&quot;;</span>
<a href="#l6.1124"></a><span id="l6.1124" class="difflineminus">-        } else if (aSubject.idle) {</span>
<a href="#l6.1125"></a><span id="l6.1125" class="difflineminus">-          status = &quot;Idle&quot;;</span>
<a href="#l6.1126"></a><span id="l6.1126" class="difflineminus">-        } else if (aSubject.available) {</span>
<a href="#l6.1127"></a><span id="l6.1127" class="difflineminus">-          status = &quot;Available&quot;;</span>
<a href="#l6.1128"></a><span id="l6.1128" class="difflineminus">-        } else {</span>
<a href="#l6.1129"></a><span id="l6.1129" class="difflineminus">-          status = &quot;Unavailable&quot;;</span>
<a href="#l6.1130"></a><span id="l6.1130" class="difflineminus">-        }</span>
<a href="#l6.1131"></a><span id="l6.1131" class="difflineminus">-</span>
<a href="#l6.1132"></a><span id="l6.1132" class="difflineminus">-        let statusText = aSubject.statusText;</span>
<a href="#l6.1133"></a><span id="l6.1133" class="difflineminus">-        if (statusText) {</span>
<a href="#l6.1134"></a><span id="l6.1134" class="difflineminus">-          status += ' (&quot;' + statusText + '&quot;)';</span>
<a href="#l6.1135"></a><span id="l6.1135" class="difflineminus">-        }</span>
<a href="#l6.1136"></a><span id="l6.1136" class="difflineminus">-</span>
<a href="#l6.1137"></a><span id="l6.1137" class="difflineminus">-        let nameText = aSubject.displayName + &quot; (&quot; + aSubject.userName + &quot;)&quot;;</span>
<a href="#l6.1138"></a><span id="l6.1138" class="difflineminus">-        getSystemLogWriter(aSubject.account).logEvent(</span>
<a href="#l6.1139"></a><span id="l6.1139" class="difflineminus">-          nameText + &quot; is now &quot; + status</span>
<a href="#l6.1140"></a><span id="l6.1140" class="difflineminus">-        );</span>
<a href="#l6.1141"></a><span id="l6.1141" class="difflineminus">-        break;</span>
<a href="#l6.1142"></a><span id="l6.1142" class="difflineminus">-      default:</span>
<a href="#l6.1143"></a><span id="l6.1143" class="difflineminus">-        throw new Error(&quot;Unexpected notification &quot; + aTopic);</span>
<a href="#l6.1144"></a><span id="l6.1144" class="difflineminus">-    }</span>
<a href="#l6.1145"></a><span id="l6.1145" class="difflineminus">-  },</span>
<a href="#l6.1146"></a><span id="l6.1146" class="difflineminus">-</span>
<a href="#l6.1147"></a><span id="l6.1147" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver, Ci.imILogger]),</span>
<a href="#l6.1148"></a><span id="l6.1148" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/chat/components/src/SmileProtocolHandler.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,36 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SmileProtocolHandler&quot;];</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-var { getSmileRealURI } = ChromeUtils.import(</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  &quot;resource:///modules/imSmileys.jsm&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-var kSmileRegexp = /^smile:\/\//;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-function smileProtocolHandler() {}</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-smileProtocolHandler.prototype = {</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  scheme: &quot;smile&quot;,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  defaultPort: -1,</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-  protocolFlags:</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-    Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-    Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-    Ci.nsIProtocolHandler.URI_IS_UI_RESOURCE |</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-    Ci.nsIProtocolHandler.URI_IS_LOCAL_RESOURCE,</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-  newChannel(aURI, aLoadInfo) {</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-    let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-    let uri = Services.io.newURI(getSmileRealURI(smile));</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-    channel.originalURI = aURI;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineminus">-    return channel;</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineminus">-  },</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  allowPort(aPort, aScheme) {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineminus">-    return false;</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineminus">-  },</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">-</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/chat/components/src/components.conf</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,57 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-Classes = [</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    'cid': '{a94b5427-cd8d-40cf-b47e-b67671953e70}',</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/accounts-service;1'],</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-    'jsm': 'resource:///modules/IMAccounts.jsm',</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-    'constructor': 'AccountsService',</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-  },</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineminus">-  {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-    'cid': '{7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}',</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/commands-service;1'],</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineminus">-    'jsm': 'resource:///modules/IMCommands.jsm',</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-    'constructor': 'IMCommands',</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineminus">-  },</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-  {</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineminus">-    'cid': '{8c3725dd-ee26-489d-8135-736015af8c7f}',</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/contacts-service;1'],</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-    'jsm': 'resource:///modules/IMContacts.jsm',</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineminus">-    'constructor': 'ContactsService',</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineminus">-  },</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineminus">-  {</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    'cid': '{1fa92237-4303-4384-b8ac-4e65b50810a5}',</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/tags-service;1'],</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-    'jsm': 'resource:///modules/IMContacts.jsm',</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineminus">-    'constructor': 'TagsService',</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineminus">-  },</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineminus">-  {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-    'cid': '{b2397cd5-c76d-4618-8410-f344c7c6443a}',</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/conversations-service;1'],</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-    'jsm': 'resource:///modules/IMConversations.jsm',</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-    'constructor': 'ConversationsService',</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  },</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineminus">-  {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-    'cid': '{073f5953-853c-4a38-bd81-255510c31c2e}',</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/core-service;1'],</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-    'jsm': 'resource:///modules/IMCore.jsm',</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-    'constructor': 'IMCore',</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-  },</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-    'cid': '{fb0dc220-2c7a-4216-9f19-6b8f3480eae9}',</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/logger;1'],</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-    'jsm': 'resource:///modules/Logger.jsm',</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-    'constructor': 'Logger',</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-    'categories': {'profile-after-change': 'Logger'},</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-  },</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-  {</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    'cid': '{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}',</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    'contract_ids': ['@mozilla.org/network/protocol;1?name=smile'],</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    'jsm': 'resource:///modules/SmileProtocolHandler.jsm',</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-    'constructor': 'SmileProtocolHandler',</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-  },</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/chat/components/src/imAccounts.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,1302 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+var {</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+  ClassInfo,</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+  EmptyEnumerator,</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+  nsSimpleEnumerator,</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  setTimeout,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  clearTimeout,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+  executeSoon,</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  l10nHelper,</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+var {</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  GenericAccountBuddyPrototype,</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+var kPrefAutologinPending = &quot;messenger.accounts.autoLoginPending&quot;;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+var kPrefMessengerAccounts = &quot;messenger.accounts&quot;;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+var kPrefAccountPrefix = &quot;messenger.account.&quot;;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+var kAccountKeyPrefix = &quot;account&quot;;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+var kAccountOptionPrefPrefix = &quot;options.&quot;;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+var kPrefAccountName = &quot;name&quot;;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+var kPrefAccountPrpl = &quot;prpl&quot;;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+var kPrefAccountAutoLogin = &quot;autoLogin&quot;;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+var kPrefAccountAutoJoin = &quot;autoJoin&quot;;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+var kPrefAccountAlias = &quot;alias&quot;;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+var kPrefAccountFirstConnectionState = &quot;firstConnectionState&quot;;</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+var kPrefConvertOldPasswords = &quot;messenger.accounts.convertOldPasswords&quot;;</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+var kPrefAccountPassword = &quot;password&quot;;</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/accounts.properties&quot;)</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+);</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_maxDebugMessages&quot;, () =&gt;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+  Services.prefs.getIntPref(&quot;messenger.accounts.maxDebugMessages&quot;)</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+);</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  this,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+  &quot;HttpProtocolHandler&quot;,</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  &quot;@mozilla.org/network/protocol;1?name=http&quot;,</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+  &quot;nsIHttpProtocolHandler&quot;</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+);</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+var gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+var gConvertingOldPasswords = false;</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+var SavePrefTimer = {</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  saveNow() {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+    if (this._timer) {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+      clearTimeout(this._timer);</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+      this._timer = null;</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    }</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+  },</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+  _timer: null,</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+  unInitTimer() {</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+    if (this._timer) {</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+      this.saveNow();</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+    }</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  },</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+  initTimer() {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+    if (!this._timer) {</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+      this._timer = setTimeout(this.saveNow.bind(this), 5000);</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+    }</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  },</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+};</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+var AutoLoginCounter = {</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+  _count: 0,</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+  startAutoLogin() {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    ++this._count;</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+    if (this._count != 1) {</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+      return;</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+    }</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+    Services.prefs.setIntPref(kPrefAutologinPending, Date.now() / 1000);</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    SavePrefTimer.saveNow();</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+  },</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineplus">+  finishedAutoLogin() {</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineplus">+    --this._count;</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+    if (this._count != 0) {</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineplus">+      return;</span>
<a href="#l9.92"></a><span id="l9.92" class="difflineplus">+    }</span>
<a href="#l9.93"></a><span id="l9.93" class="difflineplus">+    Services.prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l9.94"></a><span id="l9.94" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineplus">+  },</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+};</span>
<a href="#l9.97"></a><span id="l9.97" class="difflineplus">+</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineplus">+function UnknownProtocol(aPrplId) {</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+  this.id = aPrplId;</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+}</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+UnknownProtocol.prototype = {</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIProtocol&quot;, &quot;Unknown protocol&quot;),</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+  get name() {</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  },</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+  get normalizedName() {</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+    return this.name;</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+  },</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l9.110"></a><span id="l9.110" class="difflineplus">+    return &quot;chrome://chat/skin/prpl-unknown/&quot;;</span>
<a href="#l9.111"></a><span id="l9.111" class="difflineplus">+  },</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineplus">+  getOptions() {</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+    return EmptyEnumerator;</span>
<a href="#l9.114"></a><span id="l9.114" class="difflineplus">+  },</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineplus">+  getUsernameSplit() {</span>
<a href="#l9.116"></a><span id="l9.116" class="difflineplus">+    return EmptyEnumerator;</span>
<a href="#l9.117"></a><span id="l9.117" class="difflineplus">+  },</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l9.119"></a><span id="l9.119" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l9.120"></a><span id="l9.120" class="difflineplus">+  },</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineplus">+  getAccount(aKey, aName) {</span>
<a href="#l9.123"></a><span id="l9.123" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineplus">+  },</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineplus">+  accountExists() {</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.127"></a><span id="l9.127" class="difflineplus">+  },</span>
<a href="#l9.128"></a><span id="l9.128" class="difflineplus">+</span>
<a href="#l9.129"></a><span id="l9.129" class="difflineplus">+  // false seems an acceptable default for all options</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+  // (they should never be called anyway).</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineplus">+  get uniqueChatName() {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    return false;</span>
<a href="#l9.133"></a><span id="l9.133" class="difflineplus">+  },</span>
<a href="#l9.134"></a><span id="l9.134" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineplus">+    return false;</span>
<a href="#l9.136"></a><span id="l9.136" class="difflineplus">+  },</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+  get noPassword() {</span>
<a href="#l9.138"></a><span id="l9.138" class="difflineplus">+    return false;</span>
<a href="#l9.139"></a><span id="l9.139" class="difflineplus">+  },</span>
<a href="#l9.140"></a><span id="l9.140" class="difflineplus">+  get newMailNotification() {</span>
<a href="#l9.141"></a><span id="l9.141" class="difflineplus">+    return false;</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineplus">+  },</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+  get imagesInIM() {</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineplus">+    return false;</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineplus">+  },</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l9.147"></a><span id="l9.147" class="difflineplus">+    return true;</span>
<a href="#l9.148"></a><span id="l9.148" class="difflineplus">+  },</span>
<a href="#l9.149"></a><span id="l9.149" class="difflineplus">+  get usePointSize() {</span>
<a href="#l9.150"></a><span id="l9.150" class="difflineplus">+    return true;</span>
<a href="#l9.151"></a><span id="l9.151" class="difflineplus">+  },</span>
<a href="#l9.152"></a><span id="l9.152" class="difflineplus">+  get registerNoScreenName() {</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineplus">+    return false;</span>
<a href="#l9.154"></a><span id="l9.154" class="difflineplus">+  },</span>
<a href="#l9.155"></a><span id="l9.155" class="difflineplus">+  get slashCommandsNative() {</span>
<a href="#l9.156"></a><span id="l9.156" class="difflineplus">+    return false;</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+  },</span>
<a href="#l9.158"></a><span id="l9.158" class="difflineplus">+  get usePurpleProxy() {</span>
<a href="#l9.159"></a><span id="l9.159" class="difflineplus">+    return false;</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+  },</span>
<a href="#l9.161"></a><span id="l9.161" class="difflineplus">+};</span>
<a href="#l9.162"></a><span id="l9.162" class="difflineplus">+</span>
<a href="#l9.163"></a><span id="l9.163" class="difflineplus">+// An unknown prplIAccount.</span>
<a href="#l9.164"></a><span id="l9.164" class="difflineplus">+function UnknownAccount(aAccount) {</span>
<a href="#l9.165"></a><span id="l9.165" class="difflineplus">+  this._init(aAccount.protocol, aAccount);</span>
<a href="#l9.166"></a><span id="l9.166" class="difflineplus">+}</span>
<a href="#l9.167"></a><span id="l9.167" class="difflineplus">+UnknownAccount.prototype = GenericAccountPrototype;</span>
<a href="#l9.168"></a><span id="l9.168" class="difflineplus">+</span>
<a href="#l9.169"></a><span id="l9.169" class="difflineplus">+function UnknownAccountBuddy(aAccount, aBuddy, aTag) {</span>
<a href="#l9.170"></a><span id="l9.170" class="difflineplus">+  this._init(new UnknownAccount(aAccount), aBuddy, aTag);</span>
<a href="#l9.171"></a><span id="l9.171" class="difflineplus">+}</span>
<a href="#l9.172"></a><span id="l9.172" class="difflineplus">+UnknownAccountBuddy.prototype = GenericAccountBuddyPrototype;</span>
<a href="#l9.173"></a><span id="l9.173" class="difflineplus">+</span>
<a href="#l9.174"></a><span id="l9.174" class="difflineplus">+// aName and aPrplId are provided as parameter only if this is a new</span>
<a href="#l9.175"></a><span id="l9.175" class="difflineplus">+// account that doesn't exist in the preferences. In this case, these</span>
<a href="#l9.176"></a><span id="l9.176" class="difflineplus">+// 2 values should be stored.</span>
<a href="#l9.177"></a><span id="l9.177" class="difflineplus">+function imAccount(aKey, aName, aPrplId) {</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineplus">+  if (!aKey.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+    throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l9.180"></a><span id="l9.180" class="difflineplus">+  }</span>
<a href="#l9.181"></a><span id="l9.181" class="difflineplus">+</span>
<a href="#l9.182"></a><span id="l9.182" class="difflineplus">+  this.id = aKey;</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+  this.numericId = parseInt(aKey.substr(kAccountKeyPrefix.length));</span>
<a href="#l9.184"></a><span id="l9.184" class="difflineplus">+  gAccountsService._keepAccount(this);</span>
<a href="#l9.185"></a><span id="l9.185" class="difflineplus">+  this.prefBranch = Services.prefs.getBranch(kPrefAccountPrefix + aKey + &quot;.&quot;);</span>
<a href="#l9.186"></a><span id="l9.186" class="difflineplus">+</span>
<a href="#l9.187"></a><span id="l9.187" class="difflineplus">+  if (aName) {</span>
<a href="#l9.188"></a><span id="l9.188" class="difflineplus">+    this.name = aName;</span>
<a href="#l9.189"></a><span id="l9.189" class="difflineplus">+    this.prefBranch.setStringPref(kPrefAccountName, aName);</span>
<a href="#l9.190"></a><span id="l9.190" class="difflineplus">+</span>
<a href="#l9.191"></a><span id="l9.191" class="difflineplus">+    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l9.192"></a><span id="l9.192" class="difflineplus">+  } else {</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+    this.name = this.prefBranch.getStringPref(kPrefAccountName);</span>
<a href="#l9.194"></a><span id="l9.194" class="difflineplus">+  }</span>
<a href="#l9.195"></a><span id="l9.195" class="difflineplus">+</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineplus">+  let prplId = aPrplId;</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineplus">+  if (prplId) {</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+    this.prefBranch.setCharPref(kPrefAccountPrpl, prplId);</span>
<a href="#l9.199"></a><span id="l9.199" class="difflineplus">+  } else {</span>
<a href="#l9.200"></a><span id="l9.200" class="difflineplus">+    prplId = this.prefBranch.getCharPref(kPrefAccountPrpl);</span>
<a href="#l9.201"></a><span id="l9.201" class="difflineplus">+  }</span>
<a href="#l9.202"></a><span id="l9.202" class="difflineplus">+</span>
<a href="#l9.203"></a><span id="l9.203" class="difflineplus">+  // Get the protocol plugin, or fallback to an UnknownProtocol instance.</span>
<a href="#l9.204"></a><span id="l9.204" class="difflineplus">+  this.protocol = Services.core.getProtocolById(prplId);</span>
<a href="#l9.205"></a><span id="l9.205" class="difflineplus">+  if (!this.protocol) {</span>
<a href="#l9.206"></a><span id="l9.206" class="difflineplus">+    this.protocol = new UnknownProtocol(prplId);</span>
<a href="#l9.207"></a><span id="l9.207" class="difflineplus">+    this._connectionErrorReason = Ci.imIAccount.ERROR_UNKNOWN_PRPL;</span>
<a href="#l9.208"></a><span id="l9.208" class="difflineplus">+    return;</span>
<a href="#l9.209"></a><span id="l9.209" class="difflineplus">+  }</span>
<a href="#l9.210"></a><span id="l9.210" class="difflineplus">+</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineplus">+  // Ensure the account is correctly stored in blist.sqlite.</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineplus">+  Services.contacts.storeAccount(this.numericId, this.name, prplId);</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+</span>
<a href="#l9.214"></a><span id="l9.214" class="difflineplus">+  // Get the prplIAccount from the protocol plugin.</span>
<a href="#l9.215"></a><span id="l9.215" class="difflineplus">+  this.prplAccount = this.protocol.getAccount(this);</span>
<a href="#l9.216"></a><span id="l9.216" class="difflineplus">+</span>
<a href="#l9.217"></a><span id="l9.217" class="difflineplus">+  // Send status change notifications to the account.</span>
<a href="#l9.218"></a><span id="l9.218" class="difflineplus">+  this.observedStatusInfo = null; // (To execute the setter).</span>
<a href="#l9.219"></a><span id="l9.219" class="difflineplus">+</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineplus">+  // If we have never finished the first connection attempt for this account,</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineplus">+  // mark the account as having caused a crash.</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+  if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l9.223"></a><span id="l9.223" class="difflineplus">+    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_CRASHED;</span>
<a href="#l9.224"></a><span id="l9.224" class="difflineplus">+  }</span>
<a href="#l9.225"></a><span id="l9.225" class="difflineplus">+</span>
<a href="#l9.226"></a><span id="l9.226" class="difflineplus">+  Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l9.227"></a><span id="l9.227" class="difflineplus">+    // Try to convert old passwords stored in the preferences.</span>
<a href="#l9.228"></a><span id="l9.228" class="difflineplus">+    // Don't try too hard if the user has canceled a master password prompt:</span>
<a href="#l9.229"></a><span id="l9.229" class="difflineplus">+    // we don't want to display several of theses prompts at startup.</span>
<a href="#l9.230"></a><span id="l9.230" class="difflineplus">+    if (gConvertingOldPasswords &amp;&amp; !this.protocol.noPassword) {</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineplus">+      try {</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineplus">+        let password = this.prefBranch.getStringPref(kPrefAccountPassword);</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+        if (password &amp;&amp; !this.password) {</span>
<a href="#l9.234"></a><span id="l9.234" class="difflineplus">+          this.password = password;</span>
<a href="#l9.235"></a><span id="l9.235" class="difflineplus">+        }</span>
<a href="#l9.236"></a><span id="l9.236" class="difflineplus">+      } catch (e) {</span>
<a href="#l9.237"></a><span id="l9.237" class="difflineplus">+        /* No password saved in the prefs for this account. */</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineplus">+      }</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineplus">+    }</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+</span>
<a href="#l9.241"></a><span id="l9.241" class="difflineplus">+    // Check for errors that should prevent connection attempts.</span>
<a href="#l9.242"></a><span id="l9.242" class="difflineplus">+    if (this._passwordRequired &amp;&amp; !this.password) {</span>
<a href="#l9.243"></a><span id="l9.243" class="difflineplus">+      this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l9.244"></a><span id="l9.244" class="difflineplus">+    } else if (</span>
<a href="#l9.245"></a><span id="l9.245" class="difflineplus">+      this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineplus">+    ) {</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineplus">+      this._connectionErrorReason = Ci.imIAccount.ERROR_CRASHED;</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+    }</span>
<a href="#l9.249"></a><span id="l9.249" class="difflineplus">+  });</span>
<a href="#l9.250"></a><span id="l9.250" class="difflineplus">+}</span>
<a href="#l9.251"></a><span id="l9.251" class="difflineplus">+</span>
<a href="#l9.252"></a><span id="l9.252" class="difflineplus">+imAccount.prototype = {</span>
<a href="#l9.253"></a><span id="l9.253" class="difflineplus">+  __proto__: ClassInfo([&quot;imIAccount&quot;, &quot;prplIAccount&quot;], &quot;im account object&quot;),</span>
<a href="#l9.254"></a><span id="l9.254" class="difflineplus">+</span>
<a href="#l9.255"></a><span id="l9.255" class="difflineplus">+  name: &quot;&quot;,</span>
<a href="#l9.256"></a><span id="l9.256" class="difflineplus">+  id: &quot;&quot;,</span>
<a href="#l9.257"></a><span id="l9.257" class="difflineplus">+  numericId: 0,</span>
<a href="#l9.258"></a><span id="l9.258" class="difflineplus">+  protocol: null,</span>
<a href="#l9.259"></a><span id="l9.259" class="difflineplus">+  prplAccount: null,</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineplus">+  connectionState: Ci.imIAccount.STATE_DISCONNECTED,</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineplus">+  connectionStateMsg: &quot;&quot;,</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+  connectionErrorMessage: &quot;&quot;,</span>
<a href="#l9.263"></a><span id="l9.263" class="difflineplus">+  _connectionErrorReason: Ci.prplIAccount.NO_ERROR,</span>
<a href="#l9.264"></a><span id="l9.264" class="difflineplus">+  get connectionErrorReason() {</span>
<a href="#l9.265"></a><span id="l9.265" class="difflineplus">+    if (</span>
<a href="#l9.266"></a><span id="l9.266" class="difflineplus">+      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineplus">+      (this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineplus">+        !this._password)</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+    ) {</span>
<a href="#l9.270"></a><span id="l9.270" class="difflineplus">+      return this._connectionErrorReason;</span>
<a href="#l9.271"></a><span id="l9.271" class="difflineplus">+    }</span>
<a href="#l9.272"></a><span id="l9.272" class="difflineplus">+    return this.prplAccount.connectionErrorReason;</span>
<a href="#l9.273"></a><span id="l9.273" class="difflineplus">+  },</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineplus">+</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l9.276"></a><span id="l9.276" class="difflineplus">+    if (aTopic == &quot;account-connect-progress&quot;) {</span>
<a href="#l9.277"></a><span id="l9.277" class="difflineplus">+      this.connectionStateMsg = aData;</span>
<a href="#l9.278"></a><span id="l9.278" class="difflineplus">+    } else if (aTopic == &quot;account-connecting&quot;) {</span>
<a href="#l9.279"></a><span id="l9.279" class="difflineplus">+      if (this.prplAccount.connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l9.280"></a><span id="l9.280" class="difflineplus">+        delete this.connectionErrorMessage;</span>
<a href="#l9.281"></a><span id="l9.281" class="difflineplus">+        if (this.timeOfNextReconnect - Date.now() &gt; 1000) {</span>
<a href="#l9.282"></a><span id="l9.282" class="difflineplus">+          // This is a manual reconnection, reset the auto-reconnect stuff</span>
<a href="#l9.283"></a><span id="l9.283" class="difflineplus">+          this.timeOfLastConnect = 0;</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineplus">+          this._cancelReconnection();</span>
<a href="#l9.285"></a><span id="l9.285" class="difflineplus">+        }</span>
<a href="#l9.286"></a><span id="l9.286" class="difflineplus">+      }</span>
<a href="#l9.287"></a><span id="l9.287" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l9.288"></a><span id="l9.288" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_PENDING;</span>
<a href="#l9.289"></a><span id="l9.289" class="difflineplus">+      }</span>
<a href="#l9.290"></a><span id="l9.290" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l9.291"></a><span id="l9.291" class="difflineplus">+    } else if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l9.292"></a><span id="l9.292" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineplus">+      this.timeOfLastConnect = Date.now();</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+      if (this.firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l9.296"></a><span id="l9.296" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l9.297"></a><span id="l9.297" class="difflineplus">+      }</span>
<a href="#l9.298"></a><span id="l9.298" class="difflineplus">+      delete this.connectionStateMsg;</span>
<a href="#l9.299"></a><span id="l9.299" class="difflineplus">+</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineplus">+      if (</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineplus">+        this.canJoinChat &amp;&amp;</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+        this.prefBranch.prefHasUserValue(kPrefAccountAutoJoin)</span>
<a href="#l9.303"></a><span id="l9.303" class="difflineplus">+      ) {</span>
<a href="#l9.304"></a><span id="l9.304" class="difflineplus">+        let autojoin = this.prefBranch.getStringPref(kPrefAccountAutoJoin);</span>
<a href="#l9.305"></a><span id="l9.305" class="difflineplus">+        if (autojoin) {</span>
<a href="#l9.306"></a><span id="l9.306" class="difflineplus">+          for (let room of autojoin.trim().split(/,\s*/)) {</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineplus">+            if (room) {</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineplus">+              this.joinChat(this.getChatRoomDefaultFieldValues(room));</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+            }</span>
<a href="#l9.310"></a><span id="l9.310" class="difflineplus">+          }</span>
<a href="#l9.311"></a><span id="l9.311" class="difflineplus">+        }</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineplus">+      }</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l9.314"></a><span id="l9.314" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l9.315"></a><span id="l9.315" class="difflineplus">+      this.connectionErrorMessage = aData;</span>
<a href="#l9.316"></a><span id="l9.316" class="difflineplus">+      delete this.connectionStateMsg;</span>
<a href="#l9.317"></a><span id="l9.317" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l9.318"></a><span id="l9.318" class="difflineplus">+</span>
<a href="#l9.319"></a><span id="l9.319" class="difflineplus">+      let firstConnectionState = this.firstConnectionState;</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineplus">+      if (</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineplus">+        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_OK &amp;&amp;</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+        firstConnectionState != Ci.imIAccount.FIRST_CONNECTION_CRASHED</span>
<a href="#l9.323"></a><span id="l9.323" class="difflineplus">+      ) {</span>
<a href="#l9.324"></a><span id="l9.324" class="difflineplus">+        this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l9.325"></a><span id="l9.325" class="difflineplus">+      }</span>
<a href="#l9.326"></a><span id="l9.326" class="difflineplus">+</span>
<a href="#l9.327"></a><span id="l9.327" class="difflineplus">+      let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l9.328"></a><span id="l9.328" class="difflineplus">+      if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l9.329"></a><span id="l9.329" class="difflineplus">+        if (</span>
<a href="#l9.330"></a><span id="l9.330" class="difflineplus">+          connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l9.331"></a><span id="l9.331" class="difflineplus">+          connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR</span>
<a href="#l9.332"></a><span id="l9.332" class="difflineplus">+        ) {</span>
<a href="#l9.333"></a><span id="l9.333" class="difflineplus">+          this._startReconnectTimer();</span>
<a href="#l9.334"></a><span id="l9.334" class="difflineplus">+        }</span>
<a href="#l9.335"></a><span id="l9.335" class="difflineplus">+        this._sendNotification(&quot;account-connect-error&quot;);</span>
<a href="#l9.336"></a><span id="l9.336" class="difflineplus">+      }</span>
<a href="#l9.337"></a><span id="l9.337" class="difflineplus">+    } else if (aTopic == &quot;account-disconnected&quot;) {</span>
<a href="#l9.338"></a><span id="l9.338" class="difflineplus">+      this.connectionState = Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l9.339"></a><span id="l9.339" class="difflineplus">+      let connectionErrorReason = this.prplAccount.connectionErrorReason;</span>
<a href="#l9.340"></a><span id="l9.340" class="difflineplus">+      if (connectionErrorReason != Ci.prplIAccount.NO_ERROR) {</span>
<a href="#l9.341"></a><span id="l9.341" class="difflineplus">+        // If the account was disconnected with an error, save the debug messages.</span>
<a href="#l9.342"></a><span id="l9.342" class="difflineplus">+        this._omittedDebugMessagesBeforeError += this._omittedDebugMessages;</span>
<a href="#l9.343"></a><span id="l9.343" class="difflineplus">+        if (this._debugMessagesBeforeError) {</span>
<a href="#l9.344"></a><span id="l9.344" class="difflineplus">+          this._omittedDebugMessagesBeforeError += this._debugMessagesBeforeError.length;</span>
<a href="#l9.345"></a><span id="l9.345" class="difflineplus">+        }</span>
<a href="#l9.346"></a><span id="l9.346" class="difflineplus">+        this._debugMessagesBeforeError = this._debugMessages;</span>
<a href="#l9.347"></a><span id="l9.347" class="difflineplus">+      } else {</span>
<a href="#l9.348"></a><span id="l9.348" class="difflineplus">+        // After a clean disconnection, drop the debug messages that</span>
<a href="#l9.349"></a><span id="l9.349" class="difflineplus">+        // could have been left by a previous error.</span>
<a href="#l9.350"></a><span id="l9.350" class="difflineplus">+        delete this._omittedDebugMessagesBeforeError;</span>
<a href="#l9.351"></a><span id="l9.351" class="difflineplus">+        delete this._debugMessagesBeforeError;</span>
<a href="#l9.352"></a><span id="l9.352" class="difflineplus">+      }</span>
<a href="#l9.353"></a><span id="l9.353" class="difflineplus">+      delete this._omittedDebugMessages;</span>
<a href="#l9.354"></a><span id="l9.354" class="difflineplus">+      delete this._debugMessages;</span>
<a href="#l9.355"></a><span id="l9.355" class="difflineplus">+      if (</span>
<a href="#l9.356"></a><span id="l9.356" class="difflineplus">+        this._statusObserver &amp;&amp;</span>
<a href="#l9.357"></a><span id="l9.357" class="difflineplus">+        connectionErrorReason == Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l9.358"></a><span id="l9.358" class="difflineplus">+        this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l9.359"></a><span id="l9.359" class="difflineplus">+      ) {</span>
<a href="#l9.360"></a><span id="l9.360" class="difflineplus">+        // If the status changed back to online while an account was still</span>
<a href="#l9.361"></a><span id="l9.361" class="difflineplus">+        // disconnecting, it was not reconnected automatically at that point,</span>
<a href="#l9.362"></a><span id="l9.362" class="difflineplus">+        // so we must do it now. (This happens for protocols like IRC where</span>
<a href="#l9.363"></a><span id="l9.363" class="difflineplus">+        // disconnection is not immediate.)</span>
<a href="#l9.364"></a><span id="l9.364" class="difflineplus">+        this._sendNotification(aTopic, aData);</span>
<a href="#l9.365"></a><span id="l9.365" class="difflineplus">+        this.connect();</span>
<a href="#l9.366"></a><span id="l9.366" class="difflineplus">+        return;</span>
<a href="#l9.367"></a><span id="l9.367" class="difflineplus">+      }</span>
<a href="#l9.368"></a><span id="l9.368" class="difflineplus">+    } else {</span>
<a href="#l9.369"></a><span id="l9.369" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.370"></a><span id="l9.370" class="difflineplus">+    }</span>
<a href="#l9.371"></a><span id="l9.371" class="difflineplus">+    this._sendNotification(aTopic, aData);</span>
<a href="#l9.372"></a><span id="l9.372" class="difflineplus">+  },</span>
<a href="#l9.373"></a><span id="l9.373" class="difflineplus">+</span>
<a href="#l9.374"></a><span id="l9.374" class="difflineplus">+  _debugMessages: null,</span>
<a href="#l9.375"></a><span id="l9.375" class="difflineplus">+  _omittedDebugMessages: 0,</span>
<a href="#l9.376"></a><span id="l9.376" class="difflineplus">+  _debugMessagesBeforeError: null,</span>
<a href="#l9.377"></a><span id="l9.377" class="difflineplus">+  _omittedDebugMessagesBeforeError: 0,</span>
<a href="#l9.378"></a><span id="l9.378" class="difflineplus">+  logDebugMessage(aMessage, aLevel) {</span>
<a href="#l9.379"></a><span id="l9.379" class="difflineplus">+    if (!this._debugMessages) {</span>
<a href="#l9.380"></a><span id="l9.380" class="difflineplus">+      this._debugMessages = [];</span>
<a href="#l9.381"></a><span id="l9.381" class="difflineplus">+    }</span>
<a href="#l9.382"></a><span id="l9.382" class="difflineplus">+    if (_maxDebugMessages &amp;&amp; this._debugMessages.length &gt;= _maxDebugMessages) {</span>
<a href="#l9.383"></a><span id="l9.383" class="difflineplus">+      this._debugMessages.shift();</span>
<a href="#l9.384"></a><span id="l9.384" class="difflineplus">+      ++this._omittedDebugMessages;</span>
<a href="#l9.385"></a><span id="l9.385" class="difflineplus">+    }</span>
<a href="#l9.386"></a><span id="l9.386" class="difflineplus">+    this._debugMessages.push({ logLevel: aLevel, message: aMessage });</span>
<a href="#l9.387"></a><span id="l9.387" class="difflineplus">+  },</span>
<a href="#l9.388"></a><span id="l9.388" class="difflineplus">+  _createDebugMessage(aMessage) {</span>
<a href="#l9.389"></a><span id="l9.389" class="difflineplus">+    let scriptError = Cc[&quot;@mozilla.org/scripterror;1&quot;].createInstance(</span>
<a href="#l9.390"></a><span id="l9.390" class="difflineplus">+      Ci.nsIScriptError</span>
<a href="#l9.391"></a><span id="l9.391" class="difflineplus">+    );</span>
<a href="#l9.392"></a><span id="l9.392" class="difflineplus">+    scriptError.init(</span>
<a href="#l9.393"></a><span id="l9.393" class="difflineplus">+      aMessage,</span>
<a href="#l9.394"></a><span id="l9.394" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l9.395"></a><span id="l9.395" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l9.396"></a><span id="l9.396" class="difflineplus">+      0,</span>
<a href="#l9.397"></a><span id="l9.397" class="difflineplus">+      null,</span>
<a href="#l9.398"></a><span id="l9.398" class="difflineplus">+      Ci.nsIScriptError.warningFlag,</span>
<a href="#l9.399"></a><span id="l9.399" class="difflineplus">+      &quot;component javascript&quot;</span>
<a href="#l9.400"></a><span id="l9.400" class="difflineplus">+    );</span>
<a href="#l9.401"></a><span id="l9.401" class="difflineplus">+    return { logLevel: 0, message: scriptError };</span>
<a href="#l9.402"></a><span id="l9.402" class="difflineplus">+  },</span>
<a href="#l9.403"></a><span id="l9.403" class="difflineplus">+  getDebugMessages() {</span>
<a href="#l9.404"></a><span id="l9.404" class="difflineplus">+    let messages = [];</span>
<a href="#l9.405"></a><span id="l9.405" class="difflineplus">+    if (this._omittedDebugMessagesBeforeError) {</span>
<a href="#l9.406"></a><span id="l9.406" class="difflineplus">+      let text = this._omittedDebugMessagesBeforeError + &quot; messages omitted&quot;;</span>
<a href="#l9.407"></a><span id="l9.407" class="difflineplus">+      messages.push(this._createDebugMessage(text));</span>
<a href="#l9.408"></a><span id="l9.408" class="difflineplus">+    }</span>
<a href="#l9.409"></a><span id="l9.409" class="difflineplus">+    if (this._debugMessagesBeforeError) {</span>
<a href="#l9.410"></a><span id="l9.410" class="difflineplus">+      messages = messages.concat(this._debugMessagesBeforeError);</span>
<a href="#l9.411"></a><span id="l9.411" class="difflineplus">+    }</span>
<a href="#l9.412"></a><span id="l9.412" class="difflineplus">+    if (this._omittedDebugMessages) {</span>
<a href="#l9.413"></a><span id="l9.413" class="difflineplus">+      let text = this._omittedDebugMessages + &quot; messages omitted&quot;;</span>
<a href="#l9.414"></a><span id="l9.414" class="difflineplus">+      messages.push(this._createDebugMessage(text));</span>
<a href="#l9.415"></a><span id="l9.415" class="difflineplus">+    }</span>
<a href="#l9.416"></a><span id="l9.416" class="difflineplus">+    if (this._debugMessages) {</span>
<a href="#l9.417"></a><span id="l9.417" class="difflineplus">+      messages = messages.concat(this._debugMessages);</span>
<a href="#l9.418"></a><span id="l9.418" class="difflineplus">+    }</span>
<a href="#l9.419"></a><span id="l9.419" class="difflineplus">+    if (messages.length) {</span>
<a href="#l9.420"></a><span id="l9.420" class="difflineplus">+      let appInfo = Services.appinfo;</span>
<a href="#l9.421"></a><span id="l9.421" class="difflineplus">+      let header =</span>
<a href="#l9.422"></a><span id="l9.422" class="difflineplus">+        `${appInfo.name} ${appInfo.version} (${appInfo.appBuildID}), ` +</span>
<a href="#l9.423"></a><span id="l9.423" class="difflineplus">+        `Gecko ${appInfo.platformVersion} (${appInfo.platformBuildID}) ` +</span>
<a href="#l9.424"></a><span id="l9.424" class="difflineplus">+        `on ${HttpProtocolHandler.oscpu}`;</span>
<a href="#l9.425"></a><span id="l9.425" class="difflineplus">+      messages.unshift(this._createDebugMessage(header));</span>
<a href="#l9.426"></a><span id="l9.426" class="difflineplus">+    }</span>
<a href="#l9.427"></a><span id="l9.427" class="difflineplus">+</span>
<a href="#l9.428"></a><span id="l9.428" class="difflineplus">+    return messages;</span>
<a href="#l9.429"></a><span id="l9.429" class="difflineplus">+  },</span>
<a href="#l9.430"></a><span id="l9.430" class="difflineplus">+</span>
<a href="#l9.431"></a><span id="l9.431" class="difflineplus">+  _observedStatusInfo: null,</span>
<a href="#l9.432"></a><span id="l9.432" class="difflineplus">+  get observedStatusInfo() {</span>
<a href="#l9.433"></a><span id="l9.433" class="difflineplus">+    return this._observedStatusInfo;</span>
<a href="#l9.434"></a><span id="l9.434" class="difflineplus">+  },</span>
<a href="#l9.435"></a><span id="l9.435" class="difflineplus">+  _statusObserver: null,</span>
<a href="#l9.436"></a><span id="l9.436" class="difflineplus">+  set observedStatusInfo(aUserStatusInfo) {</span>
<a href="#l9.437"></a><span id="l9.437" class="difflineplus">+    if (!this.prplAccount) {</span>
<a href="#l9.438"></a><span id="l9.438" class="difflineplus">+      return;</span>
<a href="#l9.439"></a><span id="l9.439" class="difflineplus">+    }</span>
<a href="#l9.440"></a><span id="l9.440" class="difflineplus">+    if (this._statusObserver) {</span>
<a href="#l9.441"></a><span id="l9.441" class="difflineplus">+      this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l9.442"></a><span id="l9.442" class="difflineplus">+    }</span>
<a href="#l9.443"></a><span id="l9.443" class="difflineplus">+    this._observedStatusInfo = aUserStatusInfo;</span>
<a href="#l9.444"></a><span id="l9.444" class="difflineplus">+    if (this._statusObserver) {</span>
<a href="#l9.445"></a><span id="l9.445" class="difflineplus">+      this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l9.446"></a><span id="l9.446" class="difflineplus">+    }</span>
<a href="#l9.447"></a><span id="l9.447" class="difflineplus">+  },</span>
<a href="#l9.448"></a><span id="l9.448" class="difflineplus">+  _removeStatusObserver() {</span>
<a href="#l9.449"></a><span id="l9.449" class="difflineplus">+    if (this._statusObserver) {</span>
<a href="#l9.450"></a><span id="l9.450" class="difflineplus">+      this.statusInfo.removeObserver(this._statusObserver);</span>
<a href="#l9.451"></a><span id="l9.451" class="difflineplus">+      delete this._statusObserver;</span>
<a href="#l9.452"></a><span id="l9.452" class="difflineplus">+    }</span>
<a href="#l9.453"></a><span id="l9.453" class="difflineplus">+  },</span>
<a href="#l9.454"></a><span id="l9.454" class="difflineplus">+  get statusInfo() {</span>
<a href="#l9.455"></a><span id="l9.455" class="difflineplus">+    return this._observedStatusInfo || Services.core.globalUserStatus;</span>
<a href="#l9.456"></a><span id="l9.456" class="difflineplus">+  },</span>
<a href="#l9.457"></a><span id="l9.457" class="difflineplus">+</span>
<a href="#l9.458"></a><span id="l9.458" class="difflineplus">+  reconnectAttempt: 0,</span>
<a href="#l9.459"></a><span id="l9.459" class="difflineplus">+  timeOfLastConnect: 0,</span>
<a href="#l9.460"></a><span id="l9.460" class="difflineplus">+  timeOfNextReconnect: 0,</span>
<a href="#l9.461"></a><span id="l9.461" class="difflineplus">+  _reconnectTimer: null,</span>
<a href="#l9.462"></a><span id="l9.462" class="difflineplus">+  _startReconnectTimer() {</span>
<a href="#l9.463"></a><span id="l9.463" class="difflineplus">+    if (Services.io.offline) {</span>
<a href="#l9.464"></a><span id="l9.464" class="difflineplus">+      Cu.reportError(&quot;_startReconnectTimer called while offline&quot;);</span>
<a href="#l9.465"></a><span id="l9.465" class="difflineplus">+      return;</span>
<a href="#l9.466"></a><span id="l9.466" class="difflineplus">+    }</span>
<a href="#l9.467"></a><span id="l9.467" class="difflineplus">+</span>
<a href="#l9.468"></a><span id="l9.468" class="difflineplus">+    /* If the last successful connection is older than 10 seconds, reset the</span>
<a href="#l9.469"></a><span id="l9.469" class="difflineplus">+       number of reconnection attempts. */</span>
<a href="#l9.470"></a><span id="l9.470" class="difflineplus">+    const kTimeBeforeSuccessfulConnection = 10;</span>
<a href="#l9.471"></a><span id="l9.471" class="difflineplus">+    if (</span>
<a href="#l9.472"></a><span id="l9.472" class="difflineplus">+      this.timeOfLastConnect &amp;&amp;</span>
<a href="#l9.473"></a><span id="l9.473" class="difflineplus">+      this.timeOfLastConnect + kTimeBeforeSuccessfulConnection * 1000 &lt;</span>
<a href="#l9.474"></a><span id="l9.474" class="difflineplus">+        Date.now()</span>
<a href="#l9.475"></a><span id="l9.475" class="difflineplus">+    ) {</span>
<a href="#l9.476"></a><span id="l9.476" class="difflineplus">+      delete this.reconnectAttempt;</span>
<a href="#l9.477"></a><span id="l9.477" class="difflineplus">+      delete this.timeOfLastConnect;</span>
<a href="#l9.478"></a><span id="l9.478" class="difflineplus">+    }</span>
<a href="#l9.479"></a><span id="l9.479" class="difflineplus">+</span>
<a href="#l9.480"></a><span id="l9.480" class="difflineplus">+    let timers = Services.prefs</span>
<a href="#l9.481"></a><span id="l9.481" class="difflineplus">+      .getCharPref(&quot;messenger.accounts.reconnectTimer&quot;)</span>
<a href="#l9.482"></a><span id="l9.482" class="difflineplus">+      .split(&quot;,&quot;);</span>
<a href="#l9.483"></a><span id="l9.483" class="difflineplus">+    let delay = timers[Math.min(this.reconnectAttempt, timers.length - 1)];</span>
<a href="#l9.484"></a><span id="l9.484" class="difflineplus">+    let msDelay = parseInt(delay) * 1000;</span>
<a href="#l9.485"></a><span id="l9.485" class="difflineplus">+    ++this.reconnectAttempt;</span>
<a href="#l9.486"></a><span id="l9.486" class="difflineplus">+    this.timeOfNextReconnect = Date.now() + msDelay;</span>
<a href="#l9.487"></a><span id="l9.487" class="difflineplus">+    this._reconnectTimer = setTimeout(this.connect.bind(this), msDelay);</span>
<a href="#l9.488"></a><span id="l9.488" class="difflineplus">+  },</span>
<a href="#l9.489"></a><span id="l9.489" class="difflineplus">+</span>
<a href="#l9.490"></a><span id="l9.490" class="difflineplus">+  _sendNotification(aTopic, aData) {</span>
<a href="#l9.491"></a><span id="l9.491" class="difflineplus">+    Services.obs.notifyObservers(this, aTopic, aData);</span>
<a href="#l9.492"></a><span id="l9.492" class="difflineplus">+  },</span>
<a href="#l9.493"></a><span id="l9.493" class="difflineplus">+</span>
<a href="#l9.494"></a><span id="l9.494" class="difflineplus">+  get firstConnectionState() {</span>
<a href="#l9.495"></a><span id="l9.495" class="difflineplus">+    try {</span>
<a href="#l9.496"></a><span id="l9.496" class="difflineplus">+      return this.prefBranch.getIntPref(kPrefAccountFirstConnectionState);</span>
<a href="#l9.497"></a><span id="l9.497" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.498"></a><span id="l9.498" class="difflineplus">+      return Ci.imIAccount.FIRST_CONNECTION_OK;</span>
<a href="#l9.499"></a><span id="l9.499" class="difflineplus">+    }</span>
<a href="#l9.500"></a><span id="l9.500" class="difflineplus">+  },</span>
<a href="#l9.501"></a><span id="l9.501" class="difflineplus">+  set firstConnectionState(aState) {</span>
<a href="#l9.502"></a><span id="l9.502" class="difflineplus">+    if (aState == Ci.imIAccount.FIRST_CONNECTION_OK) {</span>
<a href="#l9.503"></a><span id="l9.503" class="difflineplus">+      this.prefBranch.deleteBranch(kPrefAccountFirstConnectionState);</span>
<a href="#l9.504"></a><span id="l9.504" class="difflineplus">+    } else {</span>
<a href="#l9.505"></a><span id="l9.505" class="difflineplus">+      this.prefBranch.setIntPref(kPrefAccountFirstConnectionState, aState);</span>
<a href="#l9.506"></a><span id="l9.506" class="difflineplus">+      // We want to save this pref immediately when trying to connect.</span>
<a href="#l9.507"></a><span id="l9.507" class="difflineplus">+      if (aState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l9.508"></a><span id="l9.508" class="difflineplus">+        SavePrefTimer.saveNow();</span>
<a href="#l9.509"></a><span id="l9.509" class="difflineplus">+      } else {</span>
<a href="#l9.510"></a><span id="l9.510" class="difflineplus">+        SavePrefTimer.initTimer();</span>
<a href="#l9.511"></a><span id="l9.511" class="difflineplus">+      }</span>
<a href="#l9.512"></a><span id="l9.512" class="difflineplus">+    }</span>
<a href="#l9.513"></a><span id="l9.513" class="difflineplus">+  },</span>
<a href="#l9.514"></a><span id="l9.514" class="difflineplus">+</span>
<a href="#l9.515"></a><span id="l9.515" class="difflineplus">+  _pendingReconnectForConnectionInfoChange: false,</span>
<a href="#l9.516"></a><span id="l9.516" class="difflineplus">+  _connectionInfoChanged() {</span>
<a href="#l9.517"></a><span id="l9.517" class="difflineplus">+    // The next connection will be the first connection with these parameters.</span>
<a href="#l9.518"></a><span id="l9.518" class="difflineplus">+    this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l9.519"></a><span id="l9.519" class="difflineplus">+</span>
<a href="#l9.520"></a><span id="l9.520" class="difflineplus">+    // We want to attempt to reconnect with the new settings only if a</span>
<a href="#l9.521"></a><span id="l9.521" class="difflineplus">+    // previous attempt failed or a connection attempt is currently</span>
<a href="#l9.522"></a><span id="l9.522" class="difflineplus">+    // pending (so we can return early if the account is currently</span>
<a href="#l9.523"></a><span id="l9.523" class="difflineplus">+    // connected or disconnected without error).</span>
<a href="#l9.524"></a><span id="l9.524" class="difflineplus">+    // The code doing the reconnection attempt is wrapped within an</span>
<a href="#l9.525"></a><span id="l9.525" class="difflineplus">+    // executeSoon call so that when multiple settings are changed at</span>
<a href="#l9.526"></a><span id="l9.526" class="difflineplus">+    // once we don't attempt to reconnect until they are all saved.</span>
<a href="#l9.527"></a><span id="l9.527" class="difflineplus">+    // If a reconnect attempt is already scheduled, we can also return early.</span>
<a href="#l9.528"></a><span id="l9.528" class="difflineplus">+    if (</span>
<a href="#l9.529"></a><span id="l9.529" class="difflineplus">+      this._pendingReconnectForConnectionInfoChange ||</span>
<a href="#l9.530"></a><span id="l9.530" class="difflineplus">+      this.connected ||</span>
<a href="#l9.531"></a><span id="l9.531" class="difflineplus">+      (this.disconnected &amp;&amp;</span>
<a href="#l9.532"></a><span id="l9.532" class="difflineplus">+        this.connectionErrorReason == Ci.prplIAccount.NO_ERROR)</span>
<a href="#l9.533"></a><span id="l9.533" class="difflineplus">+    ) {</span>
<a href="#l9.534"></a><span id="l9.534" class="difflineplus">+      return;</span>
<a href="#l9.535"></a><span id="l9.535" class="difflineplus">+    }</span>
<a href="#l9.536"></a><span id="l9.536" class="difflineplus">+</span>
<a href="#l9.537"></a><span id="l9.537" class="difflineplus">+    this._pendingReconnectForConnectionInfoChange = true;</span>
<a href="#l9.538"></a><span id="l9.538" class="difflineplus">+    executeSoon(</span>
<a href="#l9.539"></a><span id="l9.539" class="difflineplus">+      function() {</span>
<a href="#l9.540"></a><span id="l9.540" class="difflineplus">+        delete this._pendingReconnectForConnectionInfoChange;</span>
<a href="#l9.541"></a><span id="l9.541" class="difflineplus">+        // If the connection parameters have changed while we were</span>
<a href="#l9.542"></a><span id="l9.542" class="difflineplus">+        // trying to connect, cancel the ongoing connection attempt and</span>
<a href="#l9.543"></a><span id="l9.543" class="difflineplus">+        // try again with the new parameters.</span>
<a href="#l9.544"></a><span id="l9.544" class="difflineplus">+        if (this.connecting) {</span>
<a href="#l9.545"></a><span id="l9.545" class="difflineplus">+          this.disconnect();</span>
<a href="#l9.546"></a><span id="l9.546" class="difflineplus">+          this.connect();</span>
<a href="#l9.547"></a><span id="l9.547" class="difflineplus">+          return;</span>
<a href="#l9.548"></a><span id="l9.548" class="difflineplus">+        }</span>
<a href="#l9.549"></a><span id="l9.549" class="difflineplus">+        // If the account was disconnected because of a non-fatal</span>
<a href="#l9.550"></a><span id="l9.550" class="difflineplus">+        // connection error, retry now that we have new parameters.</span>
<a href="#l9.551"></a><span id="l9.551" class="difflineplus">+        let errorReason = this.connectionErrorReason;</span>
<a href="#l9.552"></a><span id="l9.552" class="difflineplus">+        if (</span>
<a href="#l9.553"></a><span id="l9.553" class="difflineplus">+          this.disconnected &amp;&amp;</span>
<a href="#l9.554"></a><span id="l9.554" class="difflineplus">+          errorReason != Ci.prplIAccount.NO_ERROR &amp;&amp;</span>
<a href="#l9.555"></a><span id="l9.555" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD &amp;&amp;</span>
<a href="#l9.556"></a><span id="l9.556" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_CRASHED &amp;&amp;</span>
<a href="#l9.557"></a><span id="l9.557" class="difflineplus">+          errorReason != Ci.imIAccount.ERROR_UNKNOWN_PRPL</span>
<a href="#l9.558"></a><span id="l9.558" class="difflineplus">+        ) {</span>
<a href="#l9.559"></a><span id="l9.559" class="difflineplus">+          this.connect();</span>
<a href="#l9.560"></a><span id="l9.560" class="difflineplus">+        }</span>
<a href="#l9.561"></a><span id="l9.561" class="difflineplus">+      }.bind(this)</span>
<a href="#l9.562"></a><span id="l9.562" class="difflineplus">+    );</span>
<a href="#l9.563"></a><span id="l9.563" class="difflineplus">+  },</span>
<a href="#l9.564"></a><span id="l9.564" class="difflineplus">+</span>
<a href="#l9.565"></a><span id="l9.565" class="difflineplus">+  // If the protocol plugin is missing, we can't access the normalizedName,</span>
<a href="#l9.566"></a><span id="l9.566" class="difflineplus">+  // but in lots of cases this.name is equivalent.</span>
<a href="#l9.567"></a><span id="l9.567" class="difflineplus">+  get normalizedName() {</span>
<a href="#l9.568"></a><span id="l9.568" class="difflineplus">+    return this.prplAccount ? this.prplAccount.normalizedName : this.name;</span>
<a href="#l9.569"></a><span id="l9.569" class="difflineplus">+  },</span>
<a href="#l9.570"></a><span id="l9.570" class="difflineplus">+  normalize(aName) {</span>
<a href="#l9.571"></a><span id="l9.571" class="difflineplus">+    return this.prplAccount ? this.prplAccount.normalize(aName) : aName;</span>
<a href="#l9.572"></a><span id="l9.572" class="difflineplus">+  },</span>
<a href="#l9.573"></a><span id="l9.573" class="difflineplus">+</span>
<a href="#l9.574"></a><span id="l9.574" class="difflineplus">+  _sendUpdateNotification() {</span>
<a href="#l9.575"></a><span id="l9.575" class="difflineplus">+    this._sendNotification(&quot;account-updated&quot;);</span>
<a href="#l9.576"></a><span id="l9.576" class="difflineplus">+  },</span>
<a href="#l9.577"></a><span id="l9.577" class="difflineplus">+</span>
<a href="#l9.578"></a><span id="l9.578" class="difflineplus">+  set alias(val) {</span>
<a href="#l9.579"></a><span id="l9.579" class="difflineplus">+    if (val) {</span>
<a href="#l9.580"></a><span id="l9.580" class="difflineplus">+      this.prefBranch.setStringPref(kPrefAccountAlias, val);</span>
<a href="#l9.581"></a><span id="l9.581" class="difflineplus">+    } else {</span>
<a href="#l9.582"></a><span id="l9.582" class="difflineplus">+      this.prefBranch.deleteBranch(kPrefAccountAlias);</span>
<a href="#l9.583"></a><span id="l9.583" class="difflineplus">+    }</span>
<a href="#l9.584"></a><span id="l9.584" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l9.585"></a><span id="l9.585" class="difflineplus">+  },</span>
<a href="#l9.586"></a><span id="l9.586" class="difflineplus">+  get alias() {</span>
<a href="#l9.587"></a><span id="l9.587" class="difflineplus">+    try {</span>
<a href="#l9.588"></a><span id="l9.588" class="difflineplus">+      return this.prefBranch.getStringPref(kPrefAccountAlias);</span>
<a href="#l9.589"></a><span id="l9.589" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.590"></a><span id="l9.590" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.591"></a><span id="l9.591" class="difflineplus">+    }</span>
<a href="#l9.592"></a><span id="l9.592" class="difflineplus">+  },</span>
<a href="#l9.593"></a><span id="l9.593" class="difflineplus">+</span>
<a href="#l9.594"></a><span id="l9.594" class="difflineplus">+  _password: &quot;&quot;,</span>
<a href="#l9.595"></a><span id="l9.595" class="difflineplus">+  get password() {</span>
<a href="#l9.596"></a><span id="l9.596" class="difflineplus">+    if (this._password) {</span>
<a href="#l9.597"></a><span id="l9.597" class="difflineplus">+      return this._password;</span>
<a href="#l9.598"></a><span id="l9.598" class="difflineplus">+    }</span>
<a href="#l9.599"></a><span id="l9.599" class="difflineplus">+</span>
<a href="#l9.600"></a><span id="l9.600" class="difflineplus">+    // Avoid prompting the user for the master password more than once at startup.</span>
<a href="#l9.601"></a><span id="l9.601" class="difflineplus">+    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l9.602"></a><span id="l9.602" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.603"></a><span id="l9.603" class="difflineplus">+    }</span>
<a href="#l9.604"></a><span id="l9.604" class="difflineplus">+</span>
<a href="#l9.605"></a><span id="l9.605" class="difflineplus">+    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l9.606"></a><span id="l9.606" class="difflineplus">+    let logins;</span>
<a href="#l9.607"></a><span id="l9.607" class="difflineplus">+    try {</span>
<a href="#l9.608"></a><span id="l9.608" class="difflineplus">+      logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l9.609"></a><span id="l9.609" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.610"></a><span id="l9.610" class="difflineplus">+      this._handleMasterPasswordException(e);</span>
<a href="#l9.611"></a><span id="l9.611" class="difflineplus">+      return &quot;&quot;;</span>
<a href="#l9.612"></a><span id="l9.612" class="difflineplus">+    }</span>
<a href="#l9.613"></a><span id="l9.613" class="difflineplus">+    let normalizedName = this.normalizedName;</span>
<a href="#l9.614"></a><span id="l9.614" class="difflineplus">+    for (let login of logins) {</span>
<a href="#l9.615"></a><span id="l9.615" class="difflineplus">+      if (login.username == normalizedName) {</span>
<a href="#l9.616"></a><span id="l9.616" class="difflineplus">+        this._password = login.password;</span>
<a href="#l9.617"></a><span id="l9.617" class="difflineplus">+        if (</span>
<a href="#l9.618"></a><span id="l9.618" class="difflineplus">+          this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l9.619"></a><span id="l9.619" class="difflineplus">+        ) {</span>
<a href="#l9.620"></a><span id="l9.620" class="difflineplus">+          // We have found a password for an account marked as missing password,</span>
<a href="#l9.621"></a><span id="l9.621" class="difflineplus">+          // re-check all others accounts missing a password. But first,</span>
<a href="#l9.622"></a><span id="l9.622" class="difflineplus">+          // remove the error on our own account to avoid re-checking it.</span>
<a href="#l9.623"></a><span id="l9.623" class="difflineplus">+          delete this._connectionErrorReason;</span>
<a href="#l9.624"></a><span id="l9.624" class="difflineplus">+          gAccountsService._checkIfPasswordStillMissing();</span>
<a href="#l9.625"></a><span id="l9.625" class="difflineplus">+        }</span>
<a href="#l9.626"></a><span id="l9.626" class="difflineplus">+        return this._password;</span>
<a href="#l9.627"></a><span id="l9.627" class="difflineplus">+      }</span>
<a href="#l9.628"></a><span id="l9.628" class="difflineplus">+    }</span>
<a href="#l9.629"></a><span id="l9.629" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l9.630"></a><span id="l9.630" class="difflineplus">+  },</span>
<a href="#l9.631"></a><span id="l9.631" class="difflineplus">+  _checkIfPasswordStillMissing() {</span>
<a href="#l9.632"></a><span id="l9.632" class="difflineplus">+    if (</span>
<a href="#l9.633"></a><span id="l9.633" class="difflineplus">+      this._connectionErrorReason != Ci.imIAccount.ERROR_MISSING_PASSWORD ||</span>
<a href="#l9.634"></a><span id="l9.634" class="difflineplus">+      !this.password</span>
<a href="#l9.635"></a><span id="l9.635" class="difflineplus">+    ) {</span>
<a href="#l9.636"></a><span id="l9.636" class="difflineplus">+      return;</span>
<a href="#l9.637"></a><span id="l9.637" class="difflineplus">+    }</span>
<a href="#l9.638"></a><span id="l9.638" class="difflineplus">+</span>
<a href="#l9.639"></a><span id="l9.639" class="difflineplus">+    delete this._connectionErrorReason;</span>
<a href="#l9.640"></a><span id="l9.640" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l9.641"></a><span id="l9.641" class="difflineplus">+  },</span>
<a href="#l9.642"></a><span id="l9.642" class="difflineplus">+  get _passwordRequired() {</span>
<a href="#l9.643"></a><span id="l9.643" class="difflineplus">+    return !this.protocol.noPassword &amp;&amp; !this.protocol.passwordOptional;</span>
<a href="#l9.644"></a><span id="l9.644" class="difflineplus">+  },</span>
<a href="#l9.645"></a><span id="l9.645" class="difflineplus">+  set password(aPassword) {</span>
<a href="#l9.646"></a><span id="l9.646" class="difflineplus">+    this._password = aPassword;</span>
<a href="#l9.647"></a><span id="l9.647" class="difflineplus">+    if (gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l9.648"></a><span id="l9.648" class="difflineplus">+      return;</span>
<a href="#l9.649"></a><span id="l9.649" class="difflineplus">+    }</span>
<a href="#l9.650"></a><span id="l9.650" class="difflineplus">+    let newLogin = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l9.651"></a><span id="l9.651" class="difflineplus">+      Ci.nsILoginInfo</span>
<a href="#l9.652"></a><span id="l9.652" class="difflineplus">+    );</span>
<a href="#l9.653"></a><span id="l9.653" class="difflineplus">+    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l9.654"></a><span id="l9.654" class="difflineplus">+    newLogin.init(</span>
<a href="#l9.655"></a><span id="l9.655" class="difflineplus">+      passwordURI,</span>
<a href="#l9.656"></a><span id="l9.656" class="difflineplus">+      null,</span>
<a href="#l9.657"></a><span id="l9.657" class="difflineplus">+      passwordURI,</span>
<a href="#l9.658"></a><span id="l9.658" class="difflineplus">+      this.normalizedName,</span>
<a href="#l9.659"></a><span id="l9.659" class="difflineplus">+      aPassword,</span>
<a href="#l9.660"></a><span id="l9.660" class="difflineplus">+      &quot;&quot;,</span>
<a href="#l9.661"></a><span id="l9.661" class="difflineplus">+      &quot;&quot;</span>
<a href="#l9.662"></a><span id="l9.662" class="difflineplus">+    );</span>
<a href="#l9.663"></a><span id="l9.663" class="difflineplus">+    try {</span>
<a href="#l9.664"></a><span id="l9.664" class="difflineplus">+      let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l9.665"></a><span id="l9.665" class="difflineplus">+      let saved = false;</span>
<a href="#l9.666"></a><span id="l9.666" class="difflineplus">+      for (let login of logins) {</span>
<a href="#l9.667"></a><span id="l9.667" class="difflineplus">+        if (newLogin.matches(login, true)) {</span>
<a href="#l9.668"></a><span id="l9.668" class="difflineplus">+          if (aPassword) {</span>
<a href="#l9.669"></a><span id="l9.669" class="difflineplus">+            Services.logins.modifyLogin(login, newLogin);</span>
<a href="#l9.670"></a><span id="l9.670" class="difflineplus">+          } else {</span>
<a href="#l9.671"></a><span id="l9.671" class="difflineplus">+            Services.logins.removeLogin(login);</span>
<a href="#l9.672"></a><span id="l9.672" class="difflineplus">+          }</span>
<a href="#l9.673"></a><span id="l9.673" class="difflineplus">+          saved = true;</span>
<a href="#l9.674"></a><span id="l9.674" class="difflineplus">+          break;</span>
<a href="#l9.675"></a><span id="l9.675" class="difflineplus">+        }</span>
<a href="#l9.676"></a><span id="l9.676" class="difflineplus">+      }</span>
<a href="#l9.677"></a><span id="l9.677" class="difflineplus">+      if (!saved &amp;&amp; aPassword) {</span>
<a href="#l9.678"></a><span id="l9.678" class="difflineplus">+        Services.logins.addLogin(newLogin);</span>
<a href="#l9.679"></a><span id="l9.679" class="difflineplus">+      }</span>
<a href="#l9.680"></a><span id="l9.680" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.681"></a><span id="l9.681" class="difflineplus">+      this._handleMasterPasswordException(e);</span>
<a href="#l9.682"></a><span id="l9.682" class="difflineplus">+    }</span>
<a href="#l9.683"></a><span id="l9.683" class="difflineplus">+</span>
<a href="#l9.684"></a><span id="l9.684" class="difflineplus">+    this._connectionInfoChanged();</span>
<a href="#l9.685"></a><span id="l9.685" class="difflineplus">+    if (</span>
<a href="#l9.686"></a><span id="l9.686" class="difflineplus">+      aPassword &amp;&amp;</span>
<a href="#l9.687"></a><span id="l9.687" class="difflineplus">+      this._connectionErrorReason == Ci.imIAccount.ERROR_MISSING_PASSWORD</span>
<a href="#l9.688"></a><span id="l9.688" class="difflineplus">+    ) {</span>
<a href="#l9.689"></a><span id="l9.689" class="difflineplus">+      this._connectionErrorReason = Ci.imIAccount.NO_ERROR;</span>
<a href="#l9.690"></a><span id="l9.690" class="difflineplus">+    } else if (!aPassword &amp;&amp; this._passwordRequired) {</span>
<a href="#l9.691"></a><span id="l9.691" class="difflineplus">+      this._connectionErrorReason = Ci.imIAccount.ERROR_MISSING_PASSWORD;</span>
<a href="#l9.692"></a><span id="l9.692" class="difflineplus">+    }</span>
<a href="#l9.693"></a><span id="l9.693" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l9.694"></a><span id="l9.694" class="difflineplus">+  },</span>
<a href="#l9.695"></a><span id="l9.695" class="difflineplus">+  _handleMasterPasswordException(aException) {</span>
<a href="#l9.696"></a><span id="l9.696" class="difflineplus">+    if (aException.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l9.697"></a><span id="l9.697" class="difflineplus">+      throw aException;</span>
<a href="#l9.698"></a><span id="l9.698" class="difflineplus">+    }</span>
<a href="#l9.699"></a><span id="l9.699" class="difflineplus">+</span>
<a href="#l9.700"></a><span id="l9.700" class="difflineplus">+    gUserCanceledMasterPasswordPrompt = true;</span>
<a href="#l9.701"></a><span id="l9.701" class="difflineplus">+    executeSoon(function() {</span>
<a href="#l9.702"></a><span id="l9.702" class="difflineplus">+      gUserCanceledMasterPasswordPrompt = false;</span>
<a href="#l9.703"></a><span id="l9.703" class="difflineplus">+    });</span>
<a href="#l9.704"></a><span id="l9.704" class="difflineplus">+  },</span>
<a href="#l9.705"></a><span id="l9.705" class="difflineplus">+</span>
<a href="#l9.706"></a><span id="l9.706" class="difflineplus">+  get autoLogin() {</span>
<a href="#l9.707"></a><span id="l9.707" class="difflineplus">+    return this.prefBranch.getBoolPref(kPrefAccountAutoLogin, true);</span>
<a href="#l9.708"></a><span id="l9.708" class="difflineplus">+  },</span>
<a href="#l9.709"></a><span id="l9.709" class="difflineplus">+  set autoLogin(val) {</span>
<a href="#l9.710"></a><span id="l9.710" class="difflineplus">+    this.prefBranch.setBoolPref(kPrefAccountAutoLogin, val);</span>
<a href="#l9.711"></a><span id="l9.711" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l9.712"></a><span id="l9.712" class="difflineplus">+    this._sendUpdateNotification();</span>
<a href="#l9.713"></a><span id="l9.713" class="difflineplus">+  },</span>
<a href="#l9.714"></a><span id="l9.714" class="difflineplus">+  _autoLoginPending: false,</span>
<a href="#l9.715"></a><span id="l9.715" class="difflineplus">+  checkAutoLogin() {</span>
<a href="#l9.716"></a><span id="l9.716" class="difflineplus">+    // No auto-login if: the account has an error at the imIAccount level</span>
<a href="#l9.717"></a><span id="l9.717" class="difflineplus">+    // (unknown protocol, missing password, first connection crashed),</span>
<a href="#l9.718"></a><span id="l9.718" class="difflineplus">+    // the account is already connected or connecting, or autoLogin is off.</span>
<a href="#l9.719"></a><span id="l9.719" class="difflineplus">+    if (</span>
<a href="#l9.720"></a><span id="l9.720" class="difflineplus">+      this._connectionErrorReason != Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l9.721"></a><span id="l9.721" class="difflineplus">+      this.connecting ||</span>
<a href="#l9.722"></a><span id="l9.722" class="difflineplus">+      this.connected ||</span>
<a href="#l9.723"></a><span id="l9.723" class="difflineplus">+      !this.autoLogin</span>
<a href="#l9.724"></a><span id="l9.724" class="difflineplus">+    ) {</span>
<a href="#l9.725"></a><span id="l9.725" class="difflineplus">+      return;</span>
<a href="#l9.726"></a><span id="l9.726" class="difflineplus">+    }</span>
<a href="#l9.727"></a><span id="l9.727" class="difflineplus">+</span>
<a href="#l9.728"></a><span id="l9.728" class="difflineplus">+    this._autoLoginPending = true;</span>
<a href="#l9.729"></a><span id="l9.729" class="difflineplus">+    AutoLoginCounter.startAutoLogin();</span>
<a href="#l9.730"></a><span id="l9.730" class="difflineplus">+    try {</span>
<a href="#l9.731"></a><span id="l9.731" class="difflineplus">+      this.connect();</span>
<a href="#l9.732"></a><span id="l9.732" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.733"></a><span id="l9.733" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l9.734"></a><span id="l9.734" class="difflineplus">+      this._finishedAutoLogin();</span>
<a href="#l9.735"></a><span id="l9.735" class="difflineplus">+    }</span>
<a href="#l9.736"></a><span id="l9.736" class="difflineplus">+  },</span>
<a href="#l9.737"></a><span id="l9.737" class="difflineplus">+  _finishedAutoLogin() {</span>
<a href="#l9.738"></a><span id="l9.738" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_autoLoginPending&quot;)) {</span>
<a href="#l9.739"></a><span id="l9.739" class="difflineplus">+      return;</span>
<a href="#l9.740"></a><span id="l9.740" class="difflineplus">+    }</span>
<a href="#l9.741"></a><span id="l9.741" class="difflineplus">+    delete this._autoLoginPending;</span>
<a href="#l9.742"></a><span id="l9.742" class="difflineplus">+    AutoLoginCounter.finishedAutoLogin();</span>
<a href="#l9.743"></a><span id="l9.743" class="difflineplus">+  },</span>
<a href="#l9.744"></a><span id="l9.744" class="difflineplus">+</span>
<a href="#l9.745"></a><span id="l9.745" class="difflineplus">+  // Delete the account (from the preferences, mozStorage, and call unInit).</span>
<a href="#l9.746"></a><span id="l9.746" class="difflineplus">+  remove() {</span>
<a href="#l9.747"></a><span id="l9.747" class="difflineplus">+    let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;].createInstance(</span>
<a href="#l9.748"></a><span id="l9.748" class="difflineplus">+      Ci.nsILoginInfo</span>
<a href="#l9.749"></a><span id="l9.749" class="difflineplus">+    );</span>
<a href="#l9.750"></a><span id="l9.750" class="difflineplus">+    let passwordURI = &quot;im://&quot; + this.protocol.id;</span>
<a href="#l9.751"></a><span id="l9.751" class="difflineplus">+    // Note: the normalizedName may not be exactly right if the</span>
<a href="#l9.752"></a><span id="l9.752" class="difflineplus">+    // protocol plugin is missing.</span>
<a href="#l9.753"></a><span id="l9.753" class="difflineplus">+    login.init(passwordURI, null, passwordURI, this.normalizedName, &quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l9.754"></a><span id="l9.754" class="difflineplus">+    let logins = Services.logins.findLogins(passwordURI, null, passwordURI);</span>
<a href="#l9.755"></a><span id="l9.755" class="difflineplus">+    for (let l of logins) {</span>
<a href="#l9.756"></a><span id="l9.756" class="difflineplus">+      if (login.matches(l, true)) {</span>
<a href="#l9.757"></a><span id="l9.757" class="difflineplus">+        Services.logins.removeLogin(l);</span>
<a href="#l9.758"></a><span id="l9.758" class="difflineplus">+        break;</span>
<a href="#l9.759"></a><span id="l9.759" class="difflineplus">+      }</span>
<a href="#l9.760"></a><span id="l9.760" class="difflineplus">+    }</span>
<a href="#l9.761"></a><span id="l9.761" class="difflineplus">+    if (this.connected || this.connecting) {</span>
<a href="#l9.762"></a><span id="l9.762" class="difflineplus">+      this.disconnect();</span>
<a href="#l9.763"></a><span id="l9.763" class="difflineplus">+    }</span>
<a href="#l9.764"></a><span id="l9.764" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.765"></a><span id="l9.765" class="difflineplus">+      this.prplAccount.remove();</span>
<a href="#l9.766"></a><span id="l9.766" class="difflineplus">+    }</span>
<a href="#l9.767"></a><span id="l9.767" class="difflineplus">+    this.unInit();</span>
<a href="#l9.768"></a><span id="l9.768" class="difflineplus">+    Services.contacts.forgetAccount(this.numericId);</span>
<a href="#l9.769"></a><span id="l9.769" class="difflineplus">+    this.prefBranch.deleteBranch(&quot;&quot;);</span>
<a href="#l9.770"></a><span id="l9.770" class="difflineplus">+  },</span>
<a href="#l9.771"></a><span id="l9.771" class="difflineplus">+  unInit() {</span>
<a href="#l9.772"></a><span id="l9.772" class="difflineplus">+    // remove any pending reconnection timer.</span>
<a href="#l9.773"></a><span id="l9.773" class="difflineplus">+    this._cancelReconnection();</span>
<a href="#l9.774"></a><span id="l9.774" class="difflineplus">+</span>
<a href="#l9.775"></a><span id="l9.775" class="difflineplus">+    // Keeping a status observer could cause an immediate reconnection.</span>
<a href="#l9.776"></a><span id="l9.776" class="difflineplus">+    this._removeStatusObserver();</span>
<a href="#l9.777"></a><span id="l9.777" class="difflineplus">+</span>
<a href="#l9.778"></a><span id="l9.778" class="difflineplus">+    // remove any pending autologin preference used for crash detection.</span>
<a href="#l9.779"></a><span id="l9.779" class="difflineplus">+    this._finishedAutoLogin();</span>
<a href="#l9.780"></a><span id="l9.780" class="difflineplus">+</span>
<a href="#l9.781"></a><span id="l9.781" class="difflineplus">+    // If the first connection was pending on quit, we set it back to unknown.</span>
<a href="#l9.782"></a><span id="l9.782" class="difflineplus">+    if (this.firstConnectionState == Ci.imIAccount.FIRST_CONNECTION_PENDING) {</span>
<a href="#l9.783"></a><span id="l9.783" class="difflineplus">+      this.firstConnectionState = Ci.imIAccount.FIRST_CONNECTION_UNKNOWN;</span>
<a href="#l9.784"></a><span id="l9.784" class="difflineplus">+    }</span>
<a href="#l9.785"></a><span id="l9.785" class="difflineplus">+</span>
<a href="#l9.786"></a><span id="l9.786" class="difflineplus">+    // and make sure we cleanup the save pref timer.</span>
<a href="#l9.787"></a><span id="l9.787" class="difflineplus">+    SavePrefTimer.unInitTimer();</span>
<a href="#l9.788"></a><span id="l9.788" class="difflineplus">+</span>
<a href="#l9.789"></a><span id="l9.789" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.790"></a><span id="l9.790" class="difflineplus">+      this.prplAccount.unInit();</span>
<a href="#l9.791"></a><span id="l9.791" class="difflineplus">+    }</span>
<a href="#l9.792"></a><span id="l9.792" class="difflineplus">+</span>
<a href="#l9.793"></a><span id="l9.793" class="difflineplus">+    delete this.protocol;</span>
<a href="#l9.794"></a><span id="l9.794" class="difflineplus">+    delete this.prplAccount;</span>
<a href="#l9.795"></a><span id="l9.795" class="difflineplus">+  },</span>
<a href="#l9.796"></a><span id="l9.796" class="difflineplus">+</span>
<a href="#l9.797"></a><span id="l9.797" class="difflineplus">+  get _ensurePrplAccount() {</span>
<a href="#l9.798"></a><span id="l9.798" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.799"></a><span id="l9.799" class="difflineplus">+      return this.prplAccount;</span>
<a href="#l9.800"></a><span id="l9.800" class="difflineplus">+    }</span>
<a href="#l9.801"></a><span id="l9.801" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.802"></a><span id="l9.802" class="difflineplus">+  },</span>
<a href="#l9.803"></a><span id="l9.803" class="difflineplus">+  connect() {</span>
<a href="#l9.804"></a><span id="l9.804" class="difflineplus">+    if (!this.prplAccount) {</span>
<a href="#l9.805"></a><span id="l9.805" class="difflineplus">+      throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.806"></a><span id="l9.806" class="difflineplus">+    }</span>
<a href="#l9.807"></a><span id="l9.807" class="difflineplus">+</span>
<a href="#l9.808"></a><span id="l9.808" class="difflineplus">+    if (this._passwordRequired) {</span>
<a href="#l9.809"></a><span id="l9.809" class="difflineplus">+      // If the previous connection attempt failed because we have a wrong password,</span>
<a href="#l9.810"></a><span id="l9.810" class="difflineplus">+      // clear the passwor cache so that if there's no password in the password</span>
<a href="#l9.811"></a><span id="l9.811" class="difflineplus">+      // manager the user gets prompted again.</span>
<a href="#l9.812"></a><span id="l9.812" class="difflineplus">+      if (</span>
<a href="#l9.813"></a><span id="l9.813" class="difflineplus">+        this.connectionErrorReason ==</span>
<a href="#l9.814"></a><span id="l9.814" class="difflineplus">+        Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED</span>
<a href="#l9.815"></a><span id="l9.815" class="difflineplus">+      ) {</span>
<a href="#l9.816"></a><span id="l9.816" class="difflineplus">+        delete this._password;</span>
<a href="#l9.817"></a><span id="l9.817" class="difflineplus">+      }</span>
<a href="#l9.818"></a><span id="l9.818" class="difflineplus">+</span>
<a href="#l9.819"></a><span id="l9.819" class="difflineplus">+      let password = this.password;</span>
<a href="#l9.820"></a><span id="l9.820" class="difflineplus">+      if (!password) {</span>
<a href="#l9.821"></a><span id="l9.821" class="difflineplus">+        let prompts = Services.prompt;</span>
<a href="#l9.822"></a><span id="l9.822" class="difflineplus">+        let shouldSave = { value: false };</span>
<a href="#l9.823"></a><span id="l9.823" class="difflineplus">+        password = { value: &quot;&quot; };</span>
<a href="#l9.824"></a><span id="l9.824" class="difflineplus">+        if (</span>
<a href="#l9.825"></a><span id="l9.825" class="difflineplus">+          !prompts.promptPassword(</span>
<a href="#l9.826"></a><span id="l9.826" class="difflineplus">+            null,</span>
<a href="#l9.827"></a><span id="l9.827" class="difflineplus">+            _(&quot;passwordPromptTitle&quot;, this.name),</span>
<a href="#l9.828"></a><span id="l9.828" class="difflineplus">+            _(&quot;passwordPromptText&quot;, this.name),</span>
<a href="#l9.829"></a><span id="l9.829" class="difflineplus">+            password,</span>
<a href="#l9.830"></a><span id="l9.830" class="difflineplus">+            _(&quot;passwordPromptSaveCheckbox&quot;),</span>
<a href="#l9.831"></a><span id="l9.831" class="difflineplus">+            shouldSave</span>
<a href="#l9.832"></a><span id="l9.832" class="difflineplus">+          )</span>
<a href="#l9.833"></a><span id="l9.833" class="difflineplus">+        ) {</span>
<a href="#l9.834"></a><span id="l9.834" class="difflineplus">+          return;</span>
<a href="#l9.835"></a><span id="l9.835" class="difflineplus">+        }</span>
<a href="#l9.836"></a><span id="l9.836" class="difflineplus">+</span>
<a href="#l9.837"></a><span id="l9.837" class="difflineplus">+        if (shouldSave.value) {</span>
<a href="#l9.838"></a><span id="l9.838" class="difflineplus">+          this.password = password.value;</span>
<a href="#l9.839"></a><span id="l9.839" class="difflineplus">+        } else {</span>
<a href="#l9.840"></a><span id="l9.840" class="difflineplus">+          this._password = password.value;</span>
<a href="#l9.841"></a><span id="l9.841" class="difflineplus">+        }</span>
<a href="#l9.842"></a><span id="l9.842" class="difflineplus">+      }</span>
<a href="#l9.843"></a><span id="l9.843" class="difflineplus">+    }</span>
<a href="#l9.844"></a><span id="l9.844" class="difflineplus">+</span>
<a href="#l9.845"></a><span id="l9.845" class="difflineplus">+    if (!this._statusObserver) {</span>
<a href="#l9.846"></a><span id="l9.846" class="difflineplus">+      this._statusObserver = {</span>
<a href="#l9.847"></a><span id="l9.847" class="difflineplus">+        observe: function(aSubject, aTopic, aData) {</span>
<a href="#l9.848"></a><span id="l9.848" class="difflineplus">+          // Disconnect or reconnect the account automatically, otherwise notify</span>
<a href="#l9.849"></a><span id="l9.849" class="difflineplus">+          // the prplAccount instance.</span>
<a href="#l9.850"></a><span id="l9.850" class="difflineplus">+          let statusType = aSubject.statusType;</span>
<a href="#l9.851"></a><span id="l9.851" class="difflineplus">+          let connectionErrorReason = this.connectionErrorReason;</span>
<a href="#l9.852"></a><span id="l9.852" class="difflineplus">+          if (statusType == Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l9.853"></a><span id="l9.853" class="difflineplus">+            if (this.connected || this.connecting) {</span>
<a href="#l9.854"></a><span id="l9.854" class="difflineplus">+              this.prplAccount.disconnect();</span>
<a href="#l9.855"></a><span id="l9.855" class="difflineplus">+            }</span>
<a href="#l9.856"></a><span id="l9.856" class="difflineplus">+            this._cancelReconnection();</span>
<a href="#l9.857"></a><span id="l9.857" class="difflineplus">+          } else if (</span>
<a href="#l9.858"></a><span id="l9.858" class="difflineplus">+            statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l9.859"></a><span id="l9.859" class="difflineplus">+            this.disconnected &amp;&amp;</span>
<a href="#l9.860"></a><span id="l9.860" class="difflineplus">+            (connectionErrorReason == Ci.prplIAccount.NO_ERROR ||</span>
<a href="#l9.861"></a><span id="l9.861" class="difflineplus">+              connectionErrorReason == Ci.prplIAccount.ERROR_NETWORK_ERROR ||</span>
<a href="#l9.862"></a><span id="l9.862" class="difflineplus">+              connectionErrorReason == Ci.prplIAccount.ERROR_ENCRYPTION_ERROR)</span>
<a href="#l9.863"></a><span id="l9.863" class="difflineplus">+          ) {</span>
<a href="#l9.864"></a><span id="l9.864" class="difflineplus">+            this.prplAccount.connect();</span>
<a href="#l9.865"></a><span id="l9.865" class="difflineplus">+          } else if (this.connected) {</span>
<a href="#l9.866"></a><span id="l9.866" class="difflineplus">+            this.prplAccount.observe(aSubject, aTopic, aData);</span>
<a href="#l9.867"></a><span id="l9.867" class="difflineplus">+          }</span>
<a href="#l9.868"></a><span id="l9.868" class="difflineplus">+        }.bind(this),</span>
<a href="#l9.869"></a><span id="l9.869" class="difflineplus">+      };</span>
<a href="#l9.870"></a><span id="l9.870" class="difflineplus">+</span>
<a href="#l9.871"></a><span id="l9.871" class="difflineplus">+      this.statusInfo.addObserver(this._statusObserver);</span>
<a href="#l9.872"></a><span id="l9.872" class="difflineplus">+    }</span>
<a href="#l9.873"></a><span id="l9.873" class="difflineplus">+</span>
<a href="#l9.874"></a><span id="l9.874" class="difflineplus">+    if (</span>
<a href="#l9.875"></a><span id="l9.875" class="difflineplus">+      !Services.io.offline &amp;&amp;</span>
<a href="#l9.876"></a><span id="l9.876" class="difflineplus">+      this.statusInfo.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE &amp;&amp;</span>
<a href="#l9.877"></a><span id="l9.877" class="difflineplus">+      this.disconnected</span>
<a href="#l9.878"></a><span id="l9.878" class="difflineplus">+    ) {</span>
<a href="#l9.879"></a><span id="l9.879" class="difflineplus">+      this.prplAccount.connect();</span>
<a href="#l9.880"></a><span id="l9.880" class="difflineplus">+    }</span>
<a href="#l9.881"></a><span id="l9.881" class="difflineplus">+  },</span>
<a href="#l9.882"></a><span id="l9.882" class="difflineplus">+  disconnect() {</span>
<a href="#l9.883"></a><span id="l9.883" class="difflineplus">+    this._removeStatusObserver();</span>
<a href="#l9.884"></a><span id="l9.884" class="difflineplus">+    if (!this.disconnected) {</span>
<a href="#l9.885"></a><span id="l9.885" class="difflineplus">+      this._ensurePrplAccount.disconnect();</span>
<a href="#l9.886"></a><span id="l9.886" class="difflineplus">+    }</span>
<a href="#l9.887"></a><span id="l9.887" class="difflineplus">+  },</span>
<a href="#l9.888"></a><span id="l9.888" class="difflineplus">+</span>
<a href="#l9.889"></a><span id="l9.889" class="difflineplus">+  get disconnected() {</span>
<a href="#l9.890"></a><span id="l9.890" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTED;</span>
<a href="#l9.891"></a><span id="l9.891" class="difflineplus">+  },</span>
<a href="#l9.892"></a><span id="l9.892" class="difflineplus">+  get connected() {</span>
<a href="#l9.893"></a><span id="l9.893" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_CONNECTED;</span>
<a href="#l9.894"></a><span id="l9.894" class="difflineplus">+  },</span>
<a href="#l9.895"></a><span id="l9.895" class="difflineplus">+  get connecting() {</span>
<a href="#l9.896"></a><span id="l9.896" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_CONNECTING;</span>
<a href="#l9.897"></a><span id="l9.897" class="difflineplus">+  },</span>
<a href="#l9.898"></a><span id="l9.898" class="difflineplus">+  get disconnecting() {</span>
<a href="#l9.899"></a><span id="l9.899" class="difflineplus">+    return this.connectionState == Ci.imIAccount.STATE_DISCONNECTING;</span>
<a href="#l9.900"></a><span id="l9.900" class="difflineplus">+  },</span>
<a href="#l9.901"></a><span id="l9.901" class="difflineplus">+</span>
<a href="#l9.902"></a><span id="l9.902" class="difflineplus">+  _cancelReconnection() {</span>
<a href="#l9.903"></a><span id="l9.903" class="difflineplus">+    if (this._reconnectTimer) {</span>
<a href="#l9.904"></a><span id="l9.904" class="difflineplus">+      clearTimeout(this._reconnectTimer);</span>
<a href="#l9.905"></a><span id="l9.905" class="difflineplus">+      delete this._reconnectTimer;</span>
<a href="#l9.906"></a><span id="l9.906" class="difflineplus">+    }</span>
<a href="#l9.907"></a><span id="l9.907" class="difflineplus">+    delete this.reconnectAttempt;</span>
<a href="#l9.908"></a><span id="l9.908" class="difflineplus">+    delete this.timeOfNextReconnect;</span>
<a href="#l9.909"></a><span id="l9.909" class="difflineplus">+  },</span>
<a href="#l9.910"></a><span id="l9.910" class="difflineplus">+  cancelReconnection() {</span>
<a href="#l9.911"></a><span id="l9.911" class="difflineplus">+    if (!this.disconnected) {</span>
<a href="#l9.912"></a><span id="l9.912" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.913"></a><span id="l9.913" class="difflineplus">+    }</span>
<a href="#l9.914"></a><span id="l9.914" class="difflineplus">+</span>
<a href="#l9.915"></a><span id="l9.915" class="difflineplus">+    // Ensure we don't keep a status observer that could re-enable the</span>
<a href="#l9.916"></a><span id="l9.916" class="difflineplus">+    // auto-reconnect timers.</span>
<a href="#l9.917"></a><span id="l9.917" class="difflineplus">+    this.disconnect();</span>
<a href="#l9.918"></a><span id="l9.918" class="difflineplus">+</span>
<a href="#l9.919"></a><span id="l9.919" class="difflineplus">+    this._cancelReconnection();</span>
<a href="#l9.920"></a><span id="l9.920" class="difflineplus">+  },</span>
<a href="#l9.921"></a><span id="l9.921" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l9.922"></a><span id="l9.922" class="difflineplus">+    return this._ensurePrplAccount.createConversation(aName);</span>
<a href="#l9.923"></a><span id="l9.923" class="difflineplus">+  },</span>
<a href="#l9.924"></a><span id="l9.924" class="difflineplus">+  addBuddy(aTag, aName) {</span>
<a href="#l9.925"></a><span id="l9.925" class="difflineplus">+    this._ensurePrplAccount.addBuddy(aTag, aName);</span>
<a href="#l9.926"></a><span id="l9.926" class="difflineplus">+  },</span>
<a href="#l9.927"></a><span id="l9.927" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l9.928"></a><span id="l9.928" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.929"></a><span id="l9.929" class="difflineplus">+      return this.prplAccount.loadBuddy(aBuddy, aTag);</span>
<a href="#l9.930"></a><span id="l9.930" class="difflineplus">+    }</span>
<a href="#l9.931"></a><span id="l9.931" class="difflineplus">+    // Generate dummy account buddies for unknown protocols.</span>
<a href="#l9.932"></a><span id="l9.932" class="difflineplus">+    return new UnknownAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l9.933"></a><span id="l9.933" class="difflineplus">+  },</span>
<a href="#l9.934"></a><span id="l9.934" class="difflineplus">+  requestBuddyInfo(aBuddyName) {</span>
<a href="#l9.935"></a><span id="l9.935" class="difflineplus">+    this._ensurePrplAccount.requestBuddyInfo(aBuddyName);</span>
<a href="#l9.936"></a><span id="l9.936" class="difflineplus">+  },</span>
<a href="#l9.937"></a><span id="l9.937" class="difflineplus">+  getChatRoomFields() {</span>
<a href="#l9.938"></a><span id="l9.938" class="difflineplus">+    return this._ensurePrplAccount.getChatRoomFields();</span>
<a href="#l9.939"></a><span id="l9.939" class="difflineplus">+  },</span>
<a href="#l9.940"></a><span id="l9.940" class="difflineplus">+  getChatRoomDefaultFieldValues(aDefaultChatName) {</span>
<a href="#l9.941"></a><span id="l9.941" class="difflineplus">+    return this._ensurePrplAccount.getChatRoomDefaultFieldValues(</span>
<a href="#l9.942"></a><span id="l9.942" class="difflineplus">+      aDefaultChatName</span>
<a href="#l9.943"></a><span id="l9.943" class="difflineplus">+    );</span>
<a href="#l9.944"></a><span id="l9.944" class="difflineplus">+  },</span>
<a href="#l9.945"></a><span id="l9.945" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l9.946"></a><span id="l9.946" class="difflineplus">+    return this.prplAccount ? this.prplAccount.canJoinChat : false;</span>
<a href="#l9.947"></a><span id="l9.947" class="difflineplus">+  },</span>
<a href="#l9.948"></a><span id="l9.948" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l9.949"></a><span id="l9.949" class="difflineplus">+    this._ensurePrplAccount.joinChat(aComponents);</span>
<a href="#l9.950"></a><span id="l9.950" class="difflineplus">+  },</span>
<a href="#l9.951"></a><span id="l9.951" class="difflineplus">+  setBool(aName, aVal) {</span>
<a href="#l9.952"></a><span id="l9.952" class="difflineplus">+    this.prefBranch.setBoolPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l9.953"></a><span id="l9.953" class="difflineplus">+    this._connectionInfoChanged();</span>
<a href="#l9.954"></a><span id="l9.954" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.955"></a><span id="l9.955" class="difflineplus">+      this.prplAccount.setBool(aName, aVal);</span>
<a href="#l9.956"></a><span id="l9.956" class="difflineplus">+    }</span>
<a href="#l9.957"></a><span id="l9.957" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l9.958"></a><span id="l9.958" class="difflineplus">+  },</span>
<a href="#l9.959"></a><span id="l9.959" class="difflineplus">+  setInt(aName, aVal) {</span>
<a href="#l9.960"></a><span id="l9.960" class="difflineplus">+    this.prefBranch.setIntPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l9.961"></a><span id="l9.961" class="difflineplus">+    this._connectionInfoChanged();</span>
<a href="#l9.962"></a><span id="l9.962" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.963"></a><span id="l9.963" class="difflineplus">+      this.prplAccount.setInt(aName, aVal);</span>
<a href="#l9.964"></a><span id="l9.964" class="difflineplus">+    }</span>
<a href="#l9.965"></a><span id="l9.965" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l9.966"></a><span id="l9.966" class="difflineplus">+  },</span>
<a href="#l9.967"></a><span id="l9.967" class="difflineplus">+  setString(aName, aVal) {</span>
<a href="#l9.968"></a><span id="l9.968" class="difflineplus">+    this.prefBranch.setStringPref(kAccountOptionPrefPrefix + aName, aVal);</span>
<a href="#l9.969"></a><span id="l9.969" class="difflineplus">+    this._connectionInfoChanged();</span>
<a href="#l9.970"></a><span id="l9.970" class="difflineplus">+    if (this.prplAccount) {</span>
<a href="#l9.971"></a><span id="l9.971" class="difflineplus">+      this.prplAccount.setString(aName, aVal);</span>
<a href="#l9.972"></a><span id="l9.972" class="difflineplus">+    }</span>
<a href="#l9.973"></a><span id="l9.973" class="difflineplus">+    SavePrefTimer.initTimer();</span>
<a href="#l9.974"></a><span id="l9.974" class="difflineplus">+  },</span>
<a href="#l9.975"></a><span id="l9.975" class="difflineplus">+  save() {</span>
<a href="#l9.976"></a><span id="l9.976" class="difflineplus">+    SavePrefTimer.saveNow();</span>
<a href="#l9.977"></a><span id="l9.977" class="difflineplus">+  },</span>
<a href="#l9.978"></a><span id="l9.978" class="difflineplus">+</span>
<a href="#l9.979"></a><span id="l9.979" class="difflineplus">+  get HTMLEnabled() {</span>
<a href="#l9.980"></a><span id="l9.980" class="difflineplus">+    return this._ensurePrplAccount.HTMLEnabled;</span>
<a href="#l9.981"></a><span id="l9.981" class="difflineplus">+  },</span>
<a href="#l9.982"></a><span id="l9.982" class="difflineplus">+  get HTMLEscapePlainText() {</span>
<a href="#l9.983"></a><span id="l9.983" class="difflineplus">+    return this._ensurePrplAccount.HTMLEscapePlainText;</span>
<a href="#l9.984"></a><span id="l9.984" class="difflineplus">+  },</span>
<a href="#l9.985"></a><span id="l9.985" class="difflineplus">+  get noBackgroundColors() {</span>
<a href="#l9.986"></a><span id="l9.986" class="difflineplus">+    return this._ensurePrplAccount.noBackgroundColors;</span>
<a href="#l9.987"></a><span id="l9.987" class="difflineplus">+  },</span>
<a href="#l9.988"></a><span id="l9.988" class="difflineplus">+  get autoResponses() {</span>
<a href="#l9.989"></a><span id="l9.989" class="difflineplus">+    return this._ensurePrplAccount.autoResponses;</span>
<a href="#l9.990"></a><span id="l9.990" class="difflineplus">+  },</span>
<a href="#l9.991"></a><span id="l9.991" class="difflineplus">+  get singleFormatting() {</span>
<a href="#l9.992"></a><span id="l9.992" class="difflineplus">+    return this._ensurePrplAccount.singleFormatting;</span>
<a href="#l9.993"></a><span id="l9.993" class="difflineplus">+  },</span>
<a href="#l9.994"></a><span id="l9.994" class="difflineplus">+  get noFontSizes() {</span>
<a href="#l9.995"></a><span id="l9.995" class="difflineplus">+    return this._ensurePrplAccount.noFontSizes;</span>
<a href="#l9.996"></a><span id="l9.996" class="difflineplus">+  },</span>
<a href="#l9.997"></a><span id="l9.997" class="difflineplus">+  get noUrlDesc() {</span>
<a href="#l9.998"></a><span id="l9.998" class="difflineplus">+    return this._ensurePrplAccount.noUrlDesc;</span>
<a href="#l9.999"></a><span id="l9.999" class="difflineplus">+  },</span>
<a href="#l9.1000"></a><span id="l9.1000" class="difflineplus">+  get noImages() {</span>
<a href="#l9.1001"></a><span id="l9.1001" class="difflineplus">+    return this._ensurePrplAccount.noImages;</span>
<a href="#l9.1002"></a><span id="l9.1002" class="difflineplus">+  },</span>
<a href="#l9.1003"></a><span id="l9.1003" class="difflineplus">+};</span>
<a href="#l9.1004"></a><span id="l9.1004" class="difflineplus">+</span>
<a href="#l9.1005"></a><span id="l9.1005" class="difflineplus">+var gAccountsService = null;</span>
<a href="#l9.1006"></a><span id="l9.1006" class="difflineplus">+</span>
<a href="#l9.1007"></a><span id="l9.1007" class="difflineplus">+function AccountsService() {}</span>
<a href="#l9.1008"></a><span id="l9.1008" class="difflineplus">+AccountsService.prototype = {</span>
<a href="#l9.1009"></a><span id="l9.1009" class="difflineplus">+  initAccounts() {</span>
<a href="#l9.1010"></a><span id="l9.1010" class="difflineplus">+    this._initAutoLoginStatus();</span>
<a href="#l9.1011"></a><span id="l9.1011" class="difflineplus">+    this._accounts = [];</span>
<a href="#l9.1012"></a><span id="l9.1012" class="difflineplus">+    this._accountsById = {};</span>
<a href="#l9.1013"></a><span id="l9.1013" class="difflineplus">+    gAccountsService = this;</span>
<a href="#l9.1014"></a><span id="l9.1014" class="difflineplus">+    gConvertingOldPasswords = Services.prefs.getBoolPref(</span>
<a href="#l9.1015"></a><span id="l9.1015" class="difflineplus">+      kPrefConvertOldPasswords</span>
<a href="#l9.1016"></a><span id="l9.1016" class="difflineplus">+    );</span>
<a href="#l9.1017"></a><span id="l9.1017" class="difflineplus">+    let accountList = this._accountList;</span>
<a href="#l9.1018"></a><span id="l9.1018" class="difflineplus">+    for (let account of accountList ? accountList.split(&quot;,&quot;) : []) {</span>
<a href="#l9.1019"></a><span id="l9.1019" class="difflineplus">+      try {</span>
<a href="#l9.1020"></a><span id="l9.1020" class="difflineplus">+        account.trim();</span>
<a href="#l9.1021"></a><span id="l9.1021" class="difflineplus">+        if (!account) {</span>
<a href="#l9.1022"></a><span id="l9.1022" class="difflineplus">+          throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l9.1023"></a><span id="l9.1023" class="difflineplus">+        }</span>
<a href="#l9.1024"></a><span id="l9.1024" class="difflineplus">+        new imAccount(account);</span>
<a href="#l9.1025"></a><span id="l9.1025" class="difflineplus">+      } catch (e) {</span>
<a href="#l9.1026"></a><span id="l9.1026" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l9.1027"></a><span id="l9.1027" class="difflineplus">+        dump(e + &quot; &quot; + e.toSource() + &quot;\n&quot;);</span>
<a href="#l9.1028"></a><span id="l9.1028" class="difflineplus">+      }</span>
<a href="#l9.1029"></a><span id="l9.1029" class="difflineplus">+    }</span>
<a href="#l9.1030"></a><span id="l9.1030" class="difflineplus">+    // If the user has canceled a master password prompt, we haven't</span>
<a href="#l9.1031"></a><span id="l9.1031" class="difflineplus">+    // been able to save any password, so the old password conversion</span>
<a href="#l9.1032"></a><span id="l9.1032" class="difflineplus">+    // still needs to happen.</span>
<a href="#l9.1033"></a><span id="l9.1033" class="difflineplus">+    if (gConvertingOldPasswords &amp;&amp; !gUserCanceledMasterPasswordPrompt) {</span>
<a href="#l9.1034"></a><span id="l9.1034" class="difflineplus">+      Services.prefs.setBoolPref(kPrefConvertOldPasswords, false);</span>
<a href="#l9.1035"></a><span id="l9.1035" class="difflineplus">+    }</span>
<a href="#l9.1036"></a><span id="l9.1036" class="difflineplus">+</span>
<a href="#l9.1037"></a><span id="l9.1037" class="difflineplus">+    this._prefObserver = this.observe.bind(this);</span>
<a href="#l9.1038"></a><span id="l9.1038" class="difflineplus">+    Services.prefs.addObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l9.1039"></a><span id="l9.1039" class="difflineplus">+  },</span>
<a href="#l9.1040"></a><span id="l9.1040" class="difflineplus">+</span>
<a href="#l9.1041"></a><span id="l9.1041" class="difflineplus">+  _observingAccountListChange: true,</span>
<a href="#l9.1042"></a><span id="l9.1042" class="difflineplus">+  _prefObserver: null,</span>
<a href="#l9.1043"></a><span id="l9.1043" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l9.1044"></a><span id="l9.1044" class="difflineplus">+    if (</span>
<a href="#l9.1045"></a><span id="l9.1045" class="difflineplus">+      aTopic != &quot;nsPref:changed&quot; ||</span>
<a href="#l9.1046"></a><span id="l9.1046" class="difflineplus">+      aData != kPrefMessengerAccounts ||</span>
<a href="#l9.1047"></a><span id="l9.1047" class="difflineplus">+      !this._observingAccountListChange</span>
<a href="#l9.1048"></a><span id="l9.1048" class="difflineplus">+    ) {</span>
<a href="#l9.1049"></a><span id="l9.1049" class="difflineplus">+      return;</span>
<a href="#l9.1050"></a><span id="l9.1050" class="difflineplus">+    }</span>
<a href="#l9.1051"></a><span id="l9.1051" class="difflineplus">+</span>
<a href="#l9.1052"></a><span id="l9.1052" class="difflineplus">+    this._accounts = this._accountList</span>
<a href="#l9.1053"></a><span id="l9.1053" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l9.1054"></a><span id="l9.1054" class="difflineplus">+      .map(account =&gt; account.trim())</span>
<a href="#l9.1055"></a><span id="l9.1055" class="difflineplus">+      .filter(k =&gt; k.startsWith(kAccountKeyPrefix))</span>
<a href="#l9.1056"></a><span id="l9.1056" class="difflineplus">+      .map(k =&gt; parseInt(k.substr(kAccountKeyPrefix.length)))</span>
<a href="#l9.1057"></a><span id="l9.1057" class="difflineplus">+      .map(this.getAccountByNumericId, this)</span>
<a href="#l9.1058"></a><span id="l9.1058" class="difflineplus">+      .filter(a =&gt; a);</span>
<a href="#l9.1059"></a><span id="l9.1059" class="difflineplus">+</span>
<a href="#l9.1060"></a><span id="l9.1060" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;account-list-updated&quot;);</span>
<a href="#l9.1061"></a><span id="l9.1061" class="difflineplus">+  },</span>
<a href="#l9.1062"></a><span id="l9.1062" class="difflineplus">+</span>
<a href="#l9.1063"></a><span id="l9.1063" class="difflineplus">+  get _accountList() {</span>
<a href="#l9.1064"></a><span id="l9.1064" class="difflineplus">+    return Services.prefs.getCharPref(kPrefMessengerAccounts);</span>
<a href="#l9.1065"></a><span id="l9.1065" class="difflineplus">+  },</span>
<a href="#l9.1066"></a><span id="l9.1066" class="difflineplus">+  set _accountList(aNewList) {</span>
<a href="#l9.1067"></a><span id="l9.1067" class="difflineplus">+    this._observingAccountListChange = false;</span>
<a href="#l9.1068"></a><span id="l9.1068" class="difflineplus">+    Services.prefs.setCharPref(kPrefMessengerAccounts, aNewList);</span>
<a href="#l9.1069"></a><span id="l9.1069" class="difflineplus">+    delete this._observingAccountListChange;</span>
<a href="#l9.1070"></a><span id="l9.1070" class="difflineplus">+  },</span>
<a href="#l9.1071"></a><span id="l9.1071" class="difflineplus">+</span>
<a href="#l9.1072"></a><span id="l9.1072" class="difflineplus">+  unInitAccounts() {</span>
<a href="#l9.1073"></a><span id="l9.1073" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l9.1074"></a><span id="l9.1074" class="difflineplus">+      account.unInit();</span>
<a href="#l9.1075"></a><span id="l9.1075" class="difflineplus">+    }</span>
<a href="#l9.1076"></a><span id="l9.1076" class="difflineplus">+    gAccountsService = null;</span>
<a href="#l9.1077"></a><span id="l9.1077" class="difflineplus">+    delete this._accounts;</span>
<a href="#l9.1078"></a><span id="l9.1078" class="difflineplus">+    delete this._accountsById;</span>
<a href="#l9.1079"></a><span id="l9.1079" class="difflineplus">+    Services.prefs.removeObserver(kPrefMessengerAccounts, this._prefObserver);</span>
<a href="#l9.1080"></a><span id="l9.1080" class="difflineplus">+    delete this._prefObserver;</span>
<a href="#l9.1081"></a><span id="l9.1081" class="difflineplus">+  },</span>
<a href="#l9.1082"></a><span id="l9.1082" class="difflineplus">+</span>
<a href="#l9.1083"></a><span id="l9.1083" class="difflineplus">+  autoLoginStatus: Ci.imIAccountsService.AUTOLOGIN_ENABLED,</span>
<a href="#l9.1084"></a><span id="l9.1084" class="difflineplus">+  _initAutoLoginStatus() {</span>
<a href="#l9.1085"></a><span id="l9.1085" class="difflineplus">+    /* If auto-login is already disabled, do nothing */</span>
<a href="#l9.1086"></a><span id="l9.1086" class="difflineplus">+    if (this.autoLoginStatus != Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l9.1087"></a><span id="l9.1087" class="difflineplus">+      return;</span>
<a href="#l9.1088"></a><span id="l9.1088" class="difflineplus">+    }</span>
<a href="#l9.1089"></a><span id="l9.1089" class="difflineplus">+</span>
<a href="#l9.1090"></a><span id="l9.1090" class="difflineplus">+    let prefs = Services.prefs;</span>
<a href="#l9.1091"></a><span id="l9.1091" class="difflineplus">+    if (!prefs.getIntPref(&quot;messenger.startup.action&quot;)) {</span>
<a href="#l9.1092"></a><span id="l9.1092" class="difflineplus">+      // the value 0 means that we start without connecting the accounts</span>
<a href="#l9.1093"></a><span id="l9.1093" class="difflineplus">+      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_USER_DISABLED;</span>
<a href="#l9.1094"></a><span id="l9.1094" class="difflineplus">+      return;</span>
<a href="#l9.1095"></a><span id="l9.1095" class="difflineplus">+    }</span>
<a href="#l9.1096"></a><span id="l9.1096" class="difflineplus">+</span>
<a href="#l9.1097"></a><span id="l9.1097" class="difflineplus">+    /* Disable auto-login if we are running in safe mode */</span>
<a href="#l9.1098"></a><span id="l9.1098" class="difflineplus">+    if (Services.appinfo.inSafeMode) {</span>
<a href="#l9.1099"></a><span id="l9.1099" class="difflineplus">+      this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_SAFE_MODE;</span>
<a href="#l9.1100"></a><span id="l9.1100" class="difflineplus">+      return;</span>
<a href="#l9.1101"></a><span id="l9.1101" class="difflineplus">+    }</span>
<a href="#l9.1102"></a><span id="l9.1102" class="difflineplus">+</span>
<a href="#l9.1103"></a><span id="l9.1103" class="difflineplus">+    /* Check if we crashed at the last startup during autologin */</span>
<a href="#l9.1104"></a><span id="l9.1104" class="difflineplus">+    let autoLoginPending;</span>
<a href="#l9.1105"></a><span id="l9.1105" class="difflineplus">+    if (</span>
<a href="#l9.1106"></a><span id="l9.1106" class="difflineplus">+      prefs.getPrefType(kPrefAutologinPending) == prefs.PREF_INVALID ||</span>
<a href="#l9.1107"></a><span id="l9.1107" class="difflineplus">+      !(autoLoginPending = prefs.getIntPref(kPrefAutologinPending))</span>
<a href="#l9.1108"></a><span id="l9.1108" class="difflineplus">+    ) {</span>
<a href="#l9.1109"></a><span id="l9.1109" class="difflineplus">+      // if the pref isn't set, then we haven't crashed: keep autologin enabled</span>
<a href="#l9.1110"></a><span id="l9.1110" class="difflineplus">+      return;</span>
<a href="#l9.1111"></a><span id="l9.1111" class="difflineplus">+    }</span>
<a href="#l9.1112"></a><span id="l9.1112" class="difflineplus">+</span>
<a href="#l9.1113"></a><span id="l9.1113" class="difflineplus">+    // Last autologin hasn't finished properly.</span>
<a href="#l9.1114"></a><span id="l9.1114" class="difflineplus">+    // For now, assume it's because of a crash.</span>
<a href="#l9.1115"></a><span id="l9.1115" class="difflineplus">+    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_CRASH;</span>
<a href="#l9.1116"></a><span id="l9.1116" class="difflineplus">+    prefs.deleteBranch(kPrefAutologinPending);</span>
<a href="#l9.1117"></a><span id="l9.1117" class="difflineplus">+</span>
<a href="#l9.1118"></a><span id="l9.1118" class="difflineplus">+    // If the crash reporter isn't built, we can't know anything more.</span>
<a href="#l9.1119"></a><span id="l9.1119" class="difflineplus">+    if (!(&quot;nsICrashReporter&quot; in Ci)) {</span>
<a href="#l9.1120"></a><span id="l9.1120" class="difflineplus">+      return;</span>
<a href="#l9.1121"></a><span id="l9.1121" class="difflineplus">+    }</span>
<a href="#l9.1122"></a><span id="l9.1122" class="difflineplus">+</span>
<a href="#l9.1123"></a><span id="l9.1123" class="difflineplus">+    try {</span>
<a href="#l9.1124"></a><span id="l9.1124" class="difflineplus">+      // Try to get more info with breakpad</span>
<a href="#l9.1125"></a><span id="l9.1125" class="difflineplus">+      let lastCrashTime = 0;</span>
<a href="#l9.1126"></a><span id="l9.1126" class="difflineplus">+</span>
<a href="#l9.1127"></a><span id="l9.1127" class="difflineplus">+      /* Locate the LastCrash file */</span>
<a href="#l9.1128"></a><span id="l9.1128" class="difflineplus">+      let lastCrash = Services.dirsvc.get(&quot;UAppData&quot;, Ci.nsIFile);</span>
<a href="#l9.1129"></a><span id="l9.1129" class="difflineplus">+      lastCrash.append(&quot;Crash Reports&quot;);</span>
<a href="#l9.1130"></a><span id="l9.1130" class="difflineplus">+      lastCrash.append(&quot;LastCrash&quot;);</span>
<a href="#l9.1131"></a><span id="l9.1131" class="difflineplus">+      if (lastCrash.exists()) {</span>
<a href="#l9.1132"></a><span id="l9.1132" class="difflineplus">+        /* Ok, the file exists, now let's try to read it */</span>
<a href="#l9.1133"></a><span id="l9.1133" class="difflineplus">+        let is = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l9.1134"></a><span id="l9.1134" class="difflineplus">+          Ci.nsIFileInputStream</span>
<a href="#l9.1135"></a><span id="l9.1135" class="difflineplus">+        );</span>
<a href="#l9.1136"></a><span id="l9.1136" class="difflineplus">+        let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l9.1137"></a><span id="l9.1137" class="difflineplus">+          Ci.nsIScriptableInputStream</span>
<a href="#l9.1138"></a><span id="l9.1138" class="difflineplus">+        );</span>
<a href="#l9.1139"></a><span id="l9.1139" class="difflineplus">+        is.init(lastCrash, -1, 0, 0);</span>
<a href="#l9.1140"></a><span id="l9.1140" class="difflineplus">+        sis.init(sis);</span>
<a href="#l9.1141"></a><span id="l9.1141" class="difflineplus">+</span>
<a href="#l9.1142"></a><span id="l9.1142" class="difflineplus">+        lastCrashTime = parseInt(sis.read(lastCrash.fileSize));</span>
<a href="#l9.1143"></a><span id="l9.1143" class="difflineplus">+</span>
<a href="#l9.1144"></a><span id="l9.1144" class="difflineplus">+        sis.close();</span>
<a href="#l9.1145"></a><span id="l9.1145" class="difflineplus">+      }</span>
<a href="#l9.1146"></a><span id="l9.1146" class="difflineplus">+      // The file not existing is totally acceptable, it just means that</span>
<a href="#l9.1147"></a><span id="l9.1147" class="difflineplus">+      // either we never crashed or breakpad is not enabled.</span>
<a href="#l9.1148"></a><span id="l9.1148" class="difflineplus">+      // In this case, lastCrashTime will keep its 0 initialization value.</span>
<a href="#l9.1149"></a><span id="l9.1149" class="difflineplus">+</span>
<a href="#l9.1150"></a><span id="l9.1150" class="difflineplus">+      /* dump(&quot;autoLoginPending = &quot; + autoLoginPending +</span>
<a href="#l9.1151"></a><span id="l9.1151" class="difflineplus">+              &quot;, lastCrash = &quot; + lastCrashTime +</span>
<a href="#l9.1152"></a><span id="l9.1152" class="difflineplus">+              &quot;, difference = &quot; + lastCrashTime - autoLoginPending + &quot;\n&quot;);*/</span>
<a href="#l9.1153"></a><span id="l9.1153" class="difflineplus">+</span>
<a href="#l9.1154"></a><span id="l9.1154" class="difflineplus">+      if (lastCrashTime &lt; autoLoginPending) {</span>
<a href="#l9.1155"></a><span id="l9.1155" class="difflineplus">+        // the last crash caught by breakpad is older than our last autologin</span>
<a href="#l9.1156"></a><span id="l9.1156" class="difflineplus">+        // attempt.</span>
<a href="#l9.1157"></a><span id="l9.1157" class="difflineplus">+        // If breakpad is currently enabled, we can be confident that</span>
<a href="#l9.1158"></a><span id="l9.1158" class="difflineplus">+        // autologin was interrupted for an exterior reason</span>
<a href="#l9.1159"></a><span id="l9.1159" class="difflineplus">+        // (application killed by the user, power outage, ...)</span>
<a href="#l9.1160"></a><span id="l9.1160" class="difflineplus">+        try {</span>
<a href="#l9.1161"></a><span id="l9.1161" class="difflineplus">+          Services.appinfo</span>
<a href="#l9.1162"></a><span id="l9.1162" class="difflineplus">+            .QueryInterface(Ci.nsICrashReporter)</span>
<a href="#l9.1163"></a><span id="l9.1163" class="difflineplus">+            .annotateCrashReport(&quot;=&quot;, &quot;&quot;);</span>
<a href="#l9.1164"></a><span id="l9.1164" class="difflineplus">+        } catch (e) {</span>
<a href="#l9.1165"></a><span id="l9.1165" class="difflineplus">+          // This should fail with NS_ERROR_INVALID_ARG if breakpad is enabled,</span>
<a href="#l9.1166"></a><span id="l9.1166" class="difflineplus">+          // and NS_ERROR_NOT_INITIALIZED if it is not.</span>
<a href="#l9.1167"></a><span id="l9.1167" class="difflineplus">+          if (e.result != Cr.NS_ERROR_NOT_INITIALIZED) {</span>
<a href="#l9.1168"></a><span id="l9.1168" class="difflineplus">+            this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l9.1169"></a><span id="l9.1169" class="difflineplus">+          }</span>
<a href="#l9.1170"></a><span id="l9.1170" class="difflineplus">+        }</span>
<a href="#l9.1171"></a><span id="l9.1171" class="difflineplus">+      }</span>
<a href="#l9.1172"></a><span id="l9.1172" class="difflineplus">+    } catch (e) {</span>
<a href="#l9.1173"></a><span id="l9.1173" class="difflineplus">+      // if we failed to get the last crash time, then keep the</span>
<a href="#l9.1174"></a><span id="l9.1174" class="difflineplus">+      // AUTOLOGIN_CRASH value in mAutoLoginStatus and return.</span>
<a href="#l9.1175"></a><span id="l9.1175" class="difflineplus">+    }</span>
<a href="#l9.1176"></a><span id="l9.1176" class="difflineplus">+  },</span>
<a href="#l9.1177"></a><span id="l9.1177" class="difflineplus">+</span>
<a href="#l9.1178"></a><span id="l9.1178" class="difflineplus">+  processAutoLogin() {</span>
<a href="#l9.1179"></a><span id="l9.1179" class="difflineplus">+    if (!this._accounts) {</span>
<a href="#l9.1180"></a><span id="l9.1180" class="difflineplus">+      // if we're already shutting down</span>
<a href="#l9.1181"></a><span id="l9.1181" class="difflineplus">+      return;</span>
<a href="#l9.1182"></a><span id="l9.1182" class="difflineplus">+    }</span>
<a href="#l9.1183"></a><span id="l9.1183" class="difflineplus">+</span>
<a href="#l9.1184"></a><span id="l9.1184" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l9.1185"></a><span id="l9.1185" class="difflineplus">+      account.checkAutoLogin();</span>
<a href="#l9.1186"></a><span id="l9.1186" class="difflineplus">+    }</span>
<a href="#l9.1187"></a><span id="l9.1187" class="difflineplus">+</span>
<a href="#l9.1188"></a><span id="l9.1188" class="difflineplus">+    // Make sure autologin is now enabled, so that we don't display a</span>
<a href="#l9.1189"></a><span id="l9.1189" class="difflineplus">+    // message stating that it is disabled and asking the user if it</span>
<a href="#l9.1190"></a><span id="l9.1190" class="difflineplus">+    // should be processed now.</span>
<a href="#l9.1191"></a><span id="l9.1191" class="difflineplus">+    this.autoLoginStatus = Ci.imIAccountsService.AUTOLOGIN_ENABLED;</span>
<a href="#l9.1192"></a><span id="l9.1192" class="difflineplus">+</span>
<a href="#l9.1193"></a><span id="l9.1193" class="difflineplus">+    // Notify observers so that any message stating that autologin is</span>
<a href="#l9.1194"></a><span id="l9.1194" class="difflineplus">+    // disabled can be removed</span>
<a href="#l9.1195"></a><span id="l9.1195" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;autologin-processed&quot;);</span>
<a href="#l9.1196"></a><span id="l9.1196" class="difflineplus">+  },</span>
<a href="#l9.1197"></a><span id="l9.1197" class="difflineplus">+</span>
<a href="#l9.1198"></a><span id="l9.1198" class="difflineplus">+  _checkingIfPasswordStillMissing: false,</span>
<a href="#l9.1199"></a><span id="l9.1199" class="difflineplus">+  _checkIfPasswordStillMissing() {</span>
<a href="#l9.1200"></a><span id="l9.1200" class="difflineplus">+    // Avoid recursion.</span>
<a href="#l9.1201"></a><span id="l9.1201" class="difflineplus">+    if (this._checkingIfPasswordStillMissing) {</span>
<a href="#l9.1202"></a><span id="l9.1202" class="difflineplus">+      return;</span>
<a href="#l9.1203"></a><span id="l9.1203" class="difflineplus">+    }</span>
<a href="#l9.1204"></a><span id="l9.1204" class="difflineplus">+</span>
<a href="#l9.1205"></a><span id="l9.1205" class="difflineplus">+    this._checkingIfPasswordStillMissing = true;</span>
<a href="#l9.1206"></a><span id="l9.1206" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l9.1207"></a><span id="l9.1207" class="difflineplus">+      account._checkIfPasswordStillMissing();</span>
<a href="#l9.1208"></a><span id="l9.1208" class="difflineplus">+    }</span>
<a href="#l9.1209"></a><span id="l9.1209" class="difflineplus">+    delete this._checkingIfPasswordStillMissing;</span>
<a href="#l9.1210"></a><span id="l9.1210" class="difflineplus">+  },</span>
<a href="#l9.1211"></a><span id="l9.1211" class="difflineplus">+</span>
<a href="#l9.1212"></a><span id="l9.1212" class="difflineplus">+  getAccountById(aAccountId) {</span>
<a href="#l9.1213"></a><span id="l9.1213" class="difflineplus">+    if (!aAccountId.startsWith(kAccountKeyPrefix)) {</span>
<a href="#l9.1214"></a><span id="l9.1214" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l9.1215"></a><span id="l9.1215" class="difflineplus">+    }</span>
<a href="#l9.1216"></a><span id="l9.1216" class="difflineplus">+</span>
<a href="#l9.1217"></a><span id="l9.1217" class="difflineplus">+    let id = parseInt(aAccountId.substr(kAccountKeyPrefix.length));</span>
<a href="#l9.1218"></a><span id="l9.1218" class="difflineplus">+    return this.getAccountByNumericId(id);</span>
<a href="#l9.1219"></a><span id="l9.1219" class="difflineplus">+  },</span>
<a href="#l9.1220"></a><span id="l9.1220" class="difflineplus">+</span>
<a href="#l9.1221"></a><span id="l9.1221" class="difflineplus">+  _keepAccount(aAccount) {</span>
<a href="#l9.1222"></a><span id="l9.1222" class="difflineplus">+    this._accounts.push(aAccount);</span>
<a href="#l9.1223"></a><span id="l9.1223" class="difflineplus">+    this._accountsById[aAccount.numericId] = aAccount;</span>
<a href="#l9.1224"></a><span id="l9.1224" class="difflineplus">+  },</span>
<a href="#l9.1225"></a><span id="l9.1225" class="difflineplus">+  getAccountByNumericId(aAccountId) {</span>
<a href="#l9.1226"></a><span id="l9.1226" class="difflineplus">+    return this._accountsById[aAccountId];</span>
<a href="#l9.1227"></a><span id="l9.1227" class="difflineplus">+  },</span>
<a href="#l9.1228"></a><span id="l9.1228" class="difflineplus">+  getAccounts() {</span>
<a href="#l9.1229"></a><span id="l9.1229" class="difflineplus">+    return new nsSimpleEnumerator(this._accounts);</span>
<a href="#l9.1230"></a><span id="l9.1230" class="difflineplus">+  },</span>
<a href="#l9.1231"></a><span id="l9.1231" class="difflineplus">+</span>
<a href="#l9.1232"></a><span id="l9.1232" class="difflineplus">+  createAccount(aName, aPrpl) {</span>
<a href="#l9.1233"></a><span id="l9.1233" class="difflineplus">+    // Ensure an account with the same name and protocol doesn't already exist.</span>
<a href="#l9.1234"></a><span id="l9.1234" class="difflineplus">+    let prpl = Services.core.getProtocolById(aPrpl);</span>
<a href="#l9.1235"></a><span id="l9.1235" class="difflineplus">+    if (!prpl) {</span>
<a href="#l9.1236"></a><span id="l9.1236" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.1237"></a><span id="l9.1237" class="difflineplus">+    }</span>
<a href="#l9.1238"></a><span id="l9.1238" class="difflineplus">+    if (prpl.accountExists(aName)) {</span>
<a href="#l9.1239"></a><span id="l9.1239" class="difflineplus">+      Cu.reportError(&quot;Attempted to create a duplicate account!&quot;);</span>
<a href="#l9.1240"></a><span id="l9.1240" class="difflineplus">+      throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l9.1241"></a><span id="l9.1241" class="difflineplus">+    }</span>
<a href="#l9.1242"></a><span id="l9.1242" class="difflineplus">+</span>
<a href="#l9.1243"></a><span id="l9.1243" class="difflineplus">+    /* First get a unique id for the new account. */</span>
<a href="#l9.1244"></a><span id="l9.1244" class="difflineplus">+    let id;</span>
<a href="#l9.1245"></a><span id="l9.1245" class="difflineplus">+    for (id = 1; ; ++id) {</span>
<a href="#l9.1246"></a><span id="l9.1246" class="difflineplus">+      if (this._accountsById.hasOwnProperty(id)) {</span>
<a href="#l9.1247"></a><span id="l9.1247" class="difflineplus">+        continue;</span>
<a href="#l9.1248"></a><span id="l9.1248" class="difflineplus">+      }</span>
<a href="#l9.1249"></a><span id="l9.1249" class="difflineplus">+</span>
<a href="#l9.1250"></a><span id="l9.1250" class="difflineplus">+      /* id isn't used by a known account, double check it isn't</span>
<a href="#l9.1251"></a><span id="l9.1251" class="difflineplus">+       already used in the sqlite database. This should never</span>
<a href="#l9.1252"></a><span id="l9.1252" class="difflineplus">+       happen, except if we have a corrupted profile. */</span>
<a href="#l9.1253"></a><span id="l9.1253" class="difflineplus">+      if (!Services.contacts.accountIdExists(id)) {</span>
<a href="#l9.1254"></a><span id="l9.1254" class="difflineplus">+        break;</span>
<a href="#l9.1255"></a><span id="l9.1255" class="difflineplus">+      }</span>
<a href="#l9.1256"></a><span id="l9.1256" class="difflineplus">+      Services.console.logStringMessage(</span>
<a href="#l9.1257"></a><span id="l9.1257" class="difflineplus">+        &quot;No account &quot; +</span>
<a href="#l9.1258"></a><span id="l9.1258" class="difflineplus">+          id +</span>
<a href="#l9.1259"></a><span id="l9.1259" class="difflineplus">+          &quot; but there is some data in the buddy list for an account with this number. Your profile may be corrupted.&quot;</span>
<a href="#l9.1260"></a><span id="l9.1260" class="difflineplus">+      );</span>
<a href="#l9.1261"></a><span id="l9.1261" class="difflineplus">+    }</span>
<a href="#l9.1262"></a><span id="l9.1262" class="difflineplus">+</span>
<a href="#l9.1263"></a><span id="l9.1263" class="difflineplus">+    /* Actually create the new account. */</span>
<a href="#l9.1264"></a><span id="l9.1264" class="difflineplus">+    let key = kAccountKeyPrefix + id;</span>
<a href="#l9.1265"></a><span id="l9.1265" class="difflineplus">+    let account = new imAccount(key, aName, aPrpl);</span>
<a href="#l9.1266"></a><span id="l9.1266" class="difflineplus">+</span>
<a href="#l9.1267"></a><span id="l9.1267" class="difflineplus">+    /* Save the account list pref. */</span>
<a href="#l9.1268"></a><span id="l9.1268" class="difflineplus">+    let list = this._accountList;</span>
<a href="#l9.1269"></a><span id="l9.1269" class="difflineplus">+    this._accountList = list ? list + &quot;,&quot; + key : key;</span>
<a href="#l9.1270"></a><span id="l9.1270" class="difflineplus">+</span>
<a href="#l9.1271"></a><span id="l9.1271" class="difflineplus">+    Services.obs.notifyObservers(account, &quot;account-added&quot;);</span>
<a href="#l9.1272"></a><span id="l9.1272" class="difflineplus">+    return account;</span>
<a href="#l9.1273"></a><span id="l9.1273" class="difflineplus">+  },</span>
<a href="#l9.1274"></a><span id="l9.1274" class="difflineplus">+</span>
<a href="#l9.1275"></a><span id="l9.1275" class="difflineplus">+  deleteAccount(aAccountId) {</span>
<a href="#l9.1276"></a><span id="l9.1276" class="difflineplus">+    let account = this.getAccountById(aAccountId);</span>
<a href="#l9.1277"></a><span id="l9.1277" class="difflineplus">+    if (!account) {</span>
<a href="#l9.1278"></a><span id="l9.1278" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l9.1279"></a><span id="l9.1279" class="difflineplus">+    }</span>
<a href="#l9.1280"></a><span id="l9.1280" class="difflineplus">+</span>
<a href="#l9.1281"></a><span id="l9.1281" class="difflineplus">+    let index = this._accounts.indexOf(account);</span>
<a href="#l9.1282"></a><span id="l9.1282" class="difflineplus">+    if (index == -1) {</span>
<a href="#l9.1283"></a><span id="l9.1283" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l9.1284"></a><span id="l9.1284" class="difflineplus">+    }</span>
<a href="#l9.1285"></a><span id="l9.1285" class="difflineplus">+</span>
<a href="#l9.1286"></a><span id="l9.1286" class="difflineplus">+    let id = account.numericId;</span>
<a href="#l9.1287"></a><span id="l9.1287" class="difflineplus">+    account.remove();</span>
<a href="#l9.1288"></a><span id="l9.1288" class="difflineplus">+    this._accounts.splice(index, 1);</span>
<a href="#l9.1289"></a><span id="l9.1289" class="difflineplus">+    delete this._accountsById[id];</span>
<a href="#l9.1290"></a><span id="l9.1290" class="difflineplus">+    Services.obs.notifyObservers(account, &quot;account-removed&quot;);</span>
<a href="#l9.1291"></a><span id="l9.1291" class="difflineplus">+</span>
<a href="#l9.1292"></a><span id="l9.1292" class="difflineplus">+    /* Update the account list pref. */</span>
<a href="#l9.1293"></a><span id="l9.1293" class="difflineplus">+    let list = this._accountList;</span>
<a href="#l9.1294"></a><span id="l9.1294" class="difflineplus">+    this._accountList = list</span>
<a href="#l9.1295"></a><span id="l9.1295" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l9.1296"></a><span id="l9.1296" class="difflineplus">+      .filter(k =&gt; k.trim() != aAccountId)</span>
<a href="#l9.1297"></a><span id="l9.1297" class="difflineplus">+      .join(&quot;,&quot;);</span>
<a href="#l9.1298"></a><span id="l9.1298" class="difflineplus">+  },</span>
<a href="#l9.1299"></a><span id="l9.1299" class="difflineplus">+</span>
<a href="#l9.1300"></a><span id="l9.1300" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imIAccountsService]),</span>
<a href="#l9.1301"></a><span id="l9.1301" class="difflineplus">+  classDescription: &quot;Accounts&quot;,</span>
<a href="#l9.1302"></a><span id="l9.1302" class="difflineplus">+  classID: Components.ID(&quot;{a94b5427-cd8d-40cf-b47e-b67671953e70}&quot;),</span>
<a href="#l9.1303"></a><span id="l9.1303" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/accounts-service;1&quot;,</span>
<a href="#l9.1304"></a><span id="l9.1304" class="difflineplus">+};</span>
<a href="#l9.1305"></a><span id="l9.1305" class="difflineplus">+</span>
<a href="#l9.1306"></a><span id="l9.1306" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([AccountsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/chat/components/src/imAccounts.manifest</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+component {a94b5427-cd8d-40cf-b47e-b67671953e70} imAccounts.js</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+contract @mozilla.org/chat/accounts-service;1 {a94b5427-cd8d-40cf-b47e-b67671953e70}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/chat/components/src/imCommands.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,292 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+);</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/commands.properties&quot;)</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+);</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+function CommandsService() {}</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+CommandsService.prototype = {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  initCommands() {</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+    this._commands = {};</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+    // The say command is directly implemented in the UI layer, but has a</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+    // dummy command registered here so it shows up as a command (e.g. when</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+    // using the /help command).</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+    this.registerCommand({</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+      name: &quot;say&quot;,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+      get helpString() {</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+        return _(&quot;sayHelpString&quot;);</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+      },</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+      priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+      run(aMsg, aConv) {</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+        throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+      },</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+    });</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+    this.registerCommand({</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+      name: &quot;raw&quot;,</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+      get helpString() {</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+        return _(&quot;rawHelpString&quot;);</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+      },</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+      priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+      run(aMsg, aConv) {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+        let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+        if (!conv) {</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+          return false;</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+        }</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+        conv.sendMsg(aMsg);</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+        return true;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+      },</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+    });</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+    this.registerCommand({</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      // Reference the command service so we can use the internal properties</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+      // directly.</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+      cmdSrv: this,</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+      name: &quot;help&quot;,</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+      get helpString() {</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+        return _(&quot;helpHelpString&quot;);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+      },</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+      priority: Ci.imICommand.CMD_PRIORITY_DEFAULT,</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+      run(aMsg, aConv) {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+        aMsg = aMsg.trim();</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+        let conv = Services.conversations.getUIConversation(aConv);</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+        if (!conv) {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+          return false;</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+        }</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+        // Handle when no command is given, list all possible commands that are</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+        // available for this conversation (alphabetically).</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+        if (!aMsg) {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+          let commands = this.cmdSrv.listCommandsForConversation(aConv);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+          if (!commands.length) {</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+            return false;</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+          }</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+          // Concatenate the command names (separated by a comma and space).</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+          let cmds = commands</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+            .map(aCmd =&gt; aCmd.name)</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+            .sort()</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+            .join(&quot;, &quot;);</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+          let message = _(&quot;commands&quot;, cmds);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+          // Display the message</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+          conv.systemMessage(message);</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+          return true;</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+        }</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+        // A command name was given, find the commands that match.</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+        let cmdArray = this.cmdSrv._findCommands(aConv, aMsg);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+        if (!cmdArray.length) {</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+          // No command that matches.</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+          let message = _(&quot;noCommand&quot;, aMsg);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+          conv.systemMessage(message);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+          return true;</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+        }</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+        // Only show the help for the one of the highest priority.</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+        let cmd = cmdArray[0];</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+        let text = cmd.helpString;</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+        if (!text) {</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+          text = _(&quot;noHelp&quot;, cmd.name);</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+        }</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+        // Display the message.</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+        conv.systemMessage(text);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+        return true;</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+      },</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+    });</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+    // Status commands</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    let status = {</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+      back: &quot;AVAILABLE&quot;,</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+      away: &quot;AWAY&quot;,</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+      busy: &quot;UNAVAILABLE&quot;,</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+      dnd: &quot;UNAVAILABLE&quot;,</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+      offline: &quot;OFFLINE&quot;,</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+    };</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+    for (let cmd in status) {</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+      let statusValue = Ci.imIStatusInfo[&quot;STATUS_&quot; + status[cmd]];</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      this.registerCommand({</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+        name: cmd,</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+        get helpString() {</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+          return _(&quot;statusCommand&quot;, this.name, _(this.name));</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+        },</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+        usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+        priority: Ci.imICommand.CMD_PRIORITY_HIGH,</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+        run(aMsg) {</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+          Services.core.globalUserStatus.setStatus(statusValue, aMsg);</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+          return true;</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+        },</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+      });</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+    }</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  },</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+  unInitCommands() {</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+    delete this._commands;</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+  },</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+  registerCommand(aCommand, aPrplId) {</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+    let name = aCommand.name;</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+    if (!name) {</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+    }</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    if (!this._commands.hasOwnProperty(name)) {</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+      this._commands[name] = {};</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+    }</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+    this._commands[name][aPrplId || &quot;&quot;] = aCommand;</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+  },</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+  unregisterCommand(aCommandName, aPrplId) {</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+    if (this._commands.hasOwnProperty(aCommandName)) {</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+      let prplId = aPrplId || &quot;&quot;;</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+      let commands = this._commands[aCommandName];</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+      if (commands.hasOwnProperty(prplId)) {</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+        delete commands[prplId];</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+      }</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+      if (!Object.keys(commands).length) {</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+        delete this._commands[aCommandName];</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+      }</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+    }</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+  },</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+  listCommandsForConversation(aConversation) {</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+    let result = [];</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+    let prplId = aConversation &amp;&amp; aConversation.account.protocol.id;</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    for (let name in this._commands) {</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+      let commands = this._commands[name];</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+        result.push(commands[&quot;&quot;]);</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+      }</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+        result.push(commands[prplId]);</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+      }</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+    }</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+    if (aConversation) {</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+      result = result.filter(this._usageContextFilter(aConversation));</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+    }</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+    return result;</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+  },</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+  // List only the commands for a protocol (excluding the global commands).</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+  listCommandsForProtocol(aPrplId) {</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+    if (!aPrplId) {</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+      throw new Error(&quot;You must provide a prpl ID.&quot;);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+    }</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+    let result = [];</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+    for (let name in this._commands) {</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+      let commands = this._commands[name];</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+      if (commands.hasOwnProperty(aPrplId)) {</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+        result.push(commands[aPrplId]);</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+      }</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+    }</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+    return result;</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+  },</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+  _usageContextFilter(aConversation) {</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+    let usageContext =</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+      Ci.imICommand[&quot;CMD_CONTEXT_&quot; + (aConversation.isChat ? &quot;CHAT&quot; : &quot;IM&quot;)];</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+    return c =&gt; c.usageContext &amp; usageContext;</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+  },</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  _findCommands(aConversation, aName) {</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+    let prplId = null;</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+    if (aConversation) {</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+      let account = aConversation.account;</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+      if (account.connected) {</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+        prplId = account.protocol.id;</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+      }</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+    }</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+    let commandNames;</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+    // If there is an exact match for the given command name,</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+    // don't look at any other commands.</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+    if (this._commands.hasOwnProperty(aName)) {</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+      commandNames = [aName];</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+    } else {</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+      // Otherwise, check if there is a partial match.</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+      commandNames = Object.keys(this._commands).filter(command =&gt;</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+        command.startsWith(aName)</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+      );</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+    }</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+    // If a single full command name matches the given (partial)</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+    // command name, return the results for that command name. Otherwise,</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+    // return an empty array (don't assume a certain command).</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+    let cmdArray = [];</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+    for (let commandName of commandNames) {</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+      let matches = [];</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+      // Get the 2 possible commands (the global and the proto specific).</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+      let commands = this._commands[commandName];</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+      if (commands.hasOwnProperty(&quot;&quot;)) {</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+        matches.push(commands[&quot;&quot;]);</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+      }</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+      if (prplId &amp;&amp; commands.hasOwnProperty(prplId)) {</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+        matches.push(commands[prplId]);</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+      }</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+      // Remove the commands that can't apply in this context.</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+      if (aConversation) {</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+        matches = matches.filter(this._usageContextFilter(aConversation));</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+      }</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+      if (!matches.length) {</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+        continue;</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+      }</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+      // If we have found a second matching command name, return the empty array.</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+      if (cmdArray.length) {</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+        return [];</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+      }</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+      cmdArray = matches;</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+    }</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+    // Sort the matching commands by priority before returning the array.</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+    return cmdArray.sort((a, b) =&gt; b.priority - a.priority);</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  },</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+  executeCommand(aMessage, aConversation, aReturnedConv) {</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+    if (!aMessage) {</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+    }</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+    let matchResult;</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+    if (</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+      aMessage[0] != &quot;/&quot; ||</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+      !(matchResult = /^\/([a-z0-9]+)(?: |$)([\s\S]*)/.exec(aMessage))</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+    ) {</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+      return false;</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+    }</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+    let [, name, args] = matchResult;</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+    let cmdArray = this._findCommands(aConversation, name);</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+    if (!cmdArray.length) {</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+      return false;</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+    }</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+    // cmdArray contains commands sorted by priority, attempt to apply</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+    // them in order until one succeeds.</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+    if (!cmdArray.some(aCmd =&gt; aCmd.run(args, aConversation, aReturnedConv))) {</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+      // If they all failed, print help message.</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+      this.executeCommand(&quot;/help &quot; + name, aConversation);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+    }</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+    return true;</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+  },</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imICommandsService]),</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+  classDescription: &quot;Commands&quot;,</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+  classID: Components.ID(&quot;{7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}&quot;),</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/commands-service;1&quot;,</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+};</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([CommandsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/chat/components/src/imCommands.manifest</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+component {7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23} imCommands.js</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+contract @mozilla.org/chat/commands-service;1 {7cb20c68-ccc8-4a79-b6f1-0b4771ed6c23}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineminus">--- /dev/null</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineplus">+++ b/chat/components/src/imContacts.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineat">@@ -0,0 +1,1810 @@</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l13.6"></a><span id="l13.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l13.7"></a><span id="l13.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.8"></a><span id="l13.8" class="difflineplus">+</span>
<a href="#l13.9"></a><span id="l13.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l13.10"></a><span id="l13.10" class="difflineplus">+var { XPCOMUtils, executeSoon, ClassInfo, l10nHelper } = ChromeUtils.import(</span>
<a href="#l13.11"></a><span id="l13.11" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/contacts.properties&quot;)</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineplus">+);</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+var gDBConnection = null;</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineplus">+</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineplus">+function executeAsyncThenFinalize(statement) {</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineplus">+  statement.executeAsync();</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+  statement.finalize();</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+}</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+function getDBConnection() {</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineplus">+  const NS_APP_USER_PROFILE_50_DIR = &quot;ProfD&quot;;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineplus">+  let dbFile = Services.dirsvc.get(NS_APP_USER_PROFILE_50_DIR, Ci.nsIFile);</span>
<a href="#l13.28"></a><span id="l13.28" class="difflineplus">+  dbFile.append(&quot;blist.sqlite&quot;);</span>
<a href="#l13.29"></a><span id="l13.29" class="difflineplus">+</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineplus">+  let conn = Services.storage.openDatabase(dbFile);</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  if (!conn.connectionReady) {</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+    throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineplus">+  }</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineplus">+  // Grow blist db in 512KB increments.</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+  try {</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+    conn.setGrowthIncrement(512 * 1024, &quot;&quot;);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+  } catch (e) {</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineplus">+    if (e.result == Cr.NS_ERROR_FILE_TOO_BIG) {</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineplus">+      Services.console.logStringMessage(</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineplus">+        &quot;Not setting growth increment on &quot; +</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineplus">+          &quot;blist.sqlite because the available &quot; +</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+          &quot;disk space is limited&quot;</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+      );</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineplus">+    } else {</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineplus">+      throw e;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineplus">+    }</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineplus">+  }</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  // Create tables and indexes.</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+  [</span>
<a href="#l13.52"></a><span id="l13.52" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS accounts (&quot; +</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l13.54"></a><span id="l13.54" class="difflineplus">+      &quot;name VARCHAR, &quot; +</span>
<a href="#l13.55"></a><span id="l13.55" class="difflineplus">+      &quot;prpl VARCHAR)&quot;,</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineplus">+</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS contacts (&quot; +</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+      &quot;firstname VARCHAR, &quot; +</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+      &quot;lastname VARCHAR, &quot; +</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+      &quot;alias VARCHAR)&quot;,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS buddies (&quot; +</span>
<a href="#l13.64"></a><span id="l13.64" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineplus">+      &quot;key VARCHAR NOT NULL, &quot; +</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+      &quot;name VARCHAR NOT NULL, &quot; +</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+      &quot;srv_alias VARCHAR, &quot; +</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+      &quot;position INTEGER, &quot; +</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+      &quot;icon BLOB, &quot; +</span>
<a href="#l13.70"></a><span id="l13.70" class="difflineplus">+      &quot;contact_id INTEGER)&quot;,</span>
<a href="#l13.71"></a><span id="l13.71" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS buddies_contactindex &quot; +</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineplus">+      &quot;ON buddies (contact_id)&quot;,</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS tags (&quot; +</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+      &quot;id INTEGER PRIMARY KEY, &quot; +</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+      &quot;name VARCHAR UNIQUE NOT NULL, &quot; +</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineplus">+      &quot;position INTEGER)&quot;,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+</span>
<a href="#l13.79"></a><span id="l13.79" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS contact_tag (&quot; +</span>
<a href="#l13.80"></a><span id="l13.80" class="difflineplus">+      &quot;contact_id INTEGER NOT NULL, &quot; +</span>
<a href="#l13.81"></a><span id="l13.81" class="difflineplus">+      &quot;tag_id INTEGER NOT NULL)&quot;,</span>
<a href="#l13.82"></a><span id="l13.82" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS contact_tag_contactindex &quot; +</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineplus">+      &quot;ON contact_tag (contact_id)&quot;,</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS contact_tag_tagindex &quot; +</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineplus">+      &quot;ON contact_tag (tag_id)&quot;,</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineplus">+    &quot;CREATE TABLE IF NOT EXISTS account_buddy (&quot; +</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineplus">+      &quot;account_id INTEGER NOT NULL, &quot; +</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+      &quot;buddy_id INTEGER NOT NULL, &quot; +</span>
<a href="#l13.90"></a><span id="l13.90" class="difflineplus">+      &quot;status VARCHAR, &quot; +</span>
<a href="#l13.91"></a><span id="l13.91" class="difflineplus">+      &quot;tag_id INTEGER)&quot;,</span>
<a href="#l13.92"></a><span id="l13.92" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS account_buddy_accountindex &quot; +</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+      &quot;ON account_buddy (account_id)&quot;,</span>
<a href="#l13.94"></a><span id="l13.94" class="difflineplus">+    &quot;CREATE INDEX IF NOT EXISTS account_buddy_buddyindex &quot; +</span>
<a href="#l13.95"></a><span id="l13.95" class="difflineplus">+      &quot;ON account_buddy (buddy_id)&quot;,</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+  ].forEach(conn.executeSimpleSQL);</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineplus">+  return conn;</span>
<a href="#l13.99"></a><span id="l13.99" class="difflineplus">+}</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineplus">+</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+// Wrap all the usage of DBConn inside a transaction that will be</span>
<a href="#l13.102"></a><span id="l13.102" class="difflineplus">+// committed automatically at the end of the event loop spin so that</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineplus">+// we flush buddy list data to disk only once per event loop spin.</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineplus">+var gDBConnWithPendingTransaction = null;</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+Object.defineProperty(this, &quot;DBConn&quot;, {</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+  configurable: true,</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineplus">+  enumerable: true,</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineplus">+</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  get() {</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+    if (gDBConnWithPendingTransaction) {</span>
<a href="#l13.111"></a><span id="l13.111" class="difflineplus">+      return gDBConnWithPendingTransaction;</span>
<a href="#l13.112"></a><span id="l13.112" class="difflineplus">+    }</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineplus">+</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+    if (!gDBConnection) {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineplus">+      gDBConnection = getDBConnection();</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+      Services.obs.addObserver(function dbClose(aSubject, aTopic, aData) {</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineplus">+        Services.obs.removeObserver(dbClose, aTopic);</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+        if (gDBConnection) {</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineplus">+          gDBConnection.asyncClose();</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineplus">+          gDBConnection = null;</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+        }</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+      }, &quot;profile-before-change&quot;);</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+    }</span>
<a href="#l13.124"></a><span id="l13.124" class="difflineplus">+    gDBConnWithPendingTransaction = gDBConnection;</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineplus">+    gDBConnection.beginTransaction();</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    executeSoon(function() {</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineplus">+      gDBConnWithPendingTransaction.commitTransaction();</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+      gDBConnWithPendingTransaction = null;</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+    });</span>
<a href="#l13.130"></a><span id="l13.130" class="difflineplus">+    return gDBConnection;</span>
<a href="#l13.131"></a><span id="l13.131" class="difflineplus">+  },</span>
<a href="#l13.132"></a><span id="l13.132" class="difflineplus">+});</span>
<a href="#l13.133"></a><span id="l13.133" class="difflineplus">+</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineplus">+function TagsService() {}</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+TagsService.prototype = {</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+    return this;</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineplus">+  },</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+  get defaultTag() {</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+    return this.createTag(_(&quot;defaultGroup&quot;));</span>
<a href="#l13.141"></a><span id="l13.141" class="difflineplus">+  },</span>
<a href="#l13.142"></a><span id="l13.142" class="difflineplus">+  createTag(aName) {</span>
<a href="#l13.143"></a><span id="l13.143" class="difflineplus">+    // If the tag already exists, we don't want to create a duplicate.</span>
<a href="#l13.144"></a><span id="l13.144" class="difflineplus">+    let tag = this.getTagByName(aName);</span>
<a href="#l13.145"></a><span id="l13.145" class="difflineplus">+    if (tag) {</span>
<a href="#l13.146"></a><span id="l13.146" class="difflineplus">+      return tag;</span>
<a href="#l13.147"></a><span id="l13.147" class="difflineplus">+    }</span>
<a href="#l13.148"></a><span id="l13.148" class="difflineplus">+</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.150"></a><span id="l13.150" class="difflineplus">+      &quot;INSERT INTO tags (name, position) VALUES(:name, 0)&quot;</span>
<a href="#l13.151"></a><span id="l13.151" class="difflineplus">+    );</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+    try {</span>
<a href="#l13.153"></a><span id="l13.153" class="difflineplus">+      statement.params.name = aName;</span>
<a href="#l13.154"></a><span id="l13.154" class="difflineplus">+      statement.executeStep();</span>
<a href="#l13.155"></a><span id="l13.155" class="difflineplus">+    } finally {</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+    }</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineplus">+</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+    tag = new Tag(DBConn.lastInsertRowID, aName);</span>
<a href="#l13.160"></a><span id="l13.160" class="difflineplus">+    Tags.push(tag);</span>
<a href="#l13.161"></a><span id="l13.161" class="difflineplus">+    return tag;</span>
<a href="#l13.162"></a><span id="l13.162" class="difflineplus">+  },</span>
<a href="#l13.163"></a><span id="l13.163" class="difflineplus">+  // Get an existing tag by (numeric) id. Returns null if not found.</span>
<a href="#l13.164"></a><span id="l13.164" class="difflineplus">+  getTagById: aId =&gt; TagsById[aId],</span>
<a href="#l13.165"></a><span id="l13.165" class="difflineplus">+  // Get an existing tag by name (will do an SQL query). Returns null</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineplus">+  // if not found.</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineplus">+  getTagByName(aName) {</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+      &quot;SELECT id FROM tags where name = :name&quot;</span>
<a href="#l13.170"></a><span id="l13.170" class="difflineplus">+    );</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineplus">+    statement.params.name = aName;</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineplus">+    try {</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+      if (!statement.executeStep()) {</span>
<a href="#l13.174"></a><span id="l13.174" class="difflineplus">+        return null;</span>
<a href="#l13.175"></a><span id="l13.175" class="difflineplus">+      }</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineplus">+      return this.getTagById(statement.row.id);</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+    } finally {</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+    }</span>
<a href="#l13.180"></a><span id="l13.180" class="difflineplus">+  },</span>
<a href="#l13.181"></a><span id="l13.181" class="difflineplus">+  // Get an array of all existing tags.</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineplus">+  getTags() {</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+    if (Tags.length) {</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+      Tags.sort((a, b) =&gt;</span>
<a href="#l13.185"></a><span id="l13.185" class="difflineplus">+        a.name.toLowerCase().localeCompare(b.name.toLowerCase())</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineplus">+      );</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineplus">+    } else {</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+      this.defaultTag;</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+    }</span>
<a href="#l13.190"></a><span id="l13.190" class="difflineplus">+</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineplus">+    return Tags;</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  },</span>
<a href="#l13.193"></a><span id="l13.193" class="difflineplus">+</span>
<a href="#l13.194"></a><span id="l13.194" class="difflineplus">+  isTagHidden: aTag =&gt; aTag.id in otherContactsTag._hiddenTags,</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineplus">+  hideTag(aTag) {</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+    otherContactsTag.hideTag(aTag);</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineplus">+  },</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  showTag(aTag) {</span>
<a href="#l13.199"></a><span id="l13.199" class="difflineplus">+    otherContactsTag.showTag(aTag);</span>
<a href="#l13.200"></a><span id="l13.200" class="difflineplus">+  },</span>
<a href="#l13.201"></a><span id="l13.201" class="difflineplus">+  get otherContactsTag() {</span>
<a href="#l13.202"></a><span id="l13.202" class="difflineplus">+    otherContactsTag._initContacts();</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineplus">+    return otherContactsTag;</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+  },</span>
<a href="#l13.205"></a><span id="l13.205" class="difflineplus">+</span>
<a href="#l13.206"></a><span id="l13.206" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imITagsService]),</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineplus">+  classDescription: &quot;Tags&quot;,</span>
<a href="#l13.208"></a><span id="l13.208" class="difflineplus">+  classID: Components.ID(&quot;{1fa92237-4303-4384-b8ac-4e65b50810a5}&quot;),</span>
<a href="#l13.209"></a><span id="l13.209" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/tags-service;1&quot;,</span>
<a href="#l13.210"></a><span id="l13.210" class="difflineplus">+};</span>
<a href="#l13.211"></a><span id="l13.211" class="difflineplus">+</span>
<a href="#l13.212"></a><span id="l13.212" class="difflineplus">+// TODO move into the tagsService</span>
<a href="#l13.213"></a><span id="l13.213" class="difflineplus">+var Tags = [];</span>
<a href="#l13.214"></a><span id="l13.214" class="difflineplus">+var TagsById = {};</span>
<a href="#l13.215"></a><span id="l13.215" class="difflineplus">+</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineplus">+function Tag(aId, aName) {</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  this._id = aId;</span>
<a href="#l13.218"></a><span id="l13.218" class="difflineplus">+  this._name = aName;</span>
<a href="#l13.219"></a><span id="l13.219" class="difflineplus">+  this._contacts = [];</span>
<a href="#l13.220"></a><span id="l13.220" class="difflineplus">+  this._observers = [];</span>
<a href="#l13.221"></a><span id="l13.221" class="difflineplus">+</span>
<a href="#l13.222"></a><span id="l13.222" class="difflineplus">+  TagsById[this.id] = this;</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineplus">+}</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+Tag.prototype = {</span>
<a href="#l13.225"></a><span id="l13.225" class="difflineplus">+  __proto__: ClassInfo(&quot;imITag&quot;, &quot;Tag&quot;),</span>
<a href="#l13.226"></a><span id="l13.226" class="difflineplus">+  get id() {</span>
<a href="#l13.227"></a><span id="l13.227" class="difflineplus">+    return this._id;</span>
<a href="#l13.228"></a><span id="l13.228" class="difflineplus">+  },</span>
<a href="#l13.229"></a><span id="l13.229" class="difflineplus">+  get name() {</span>
<a href="#l13.230"></a><span id="l13.230" class="difflineplus">+    return this._name;</span>
<a href="#l13.231"></a><span id="l13.231" class="difflineplus">+  },</span>
<a href="#l13.232"></a><span id="l13.232" class="difflineplus">+  set name(aNewName) {</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.234"></a><span id="l13.234" class="difflineplus">+      &quot;UPDATE tags SET name = :name WHERE id = :id&quot;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineplus">+    );</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+    try {</span>
<a href="#l13.237"></a><span id="l13.237" class="difflineplus">+      statement.params.name = aNewName;</span>
<a href="#l13.238"></a><span id="l13.238" class="difflineplus">+      statement.params.id = this._id;</span>
<a href="#l13.239"></a><span id="l13.239" class="difflineplus">+      statement.execute();</span>
<a href="#l13.240"></a><span id="l13.240" class="difflineplus">+    } finally {</span>
<a href="#l13.241"></a><span id="l13.241" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineplus">+    }</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+</span>
<a href="#l13.244"></a><span id="l13.244" class="difflineplus">+    // FIXME move the account buddies if some use this tag as their group</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineplus">+    return aNewName;</span>
<a href="#l13.246"></a><span id="l13.246" class="difflineplus">+  },</span>
<a href="#l13.247"></a><span id="l13.247" class="difflineplus">+  getContacts() {</span>
<a href="#l13.248"></a><span id="l13.248" class="difflineplus">+    return this._contacts.filter(c =&gt; !c._empty);</span>
<a href="#l13.249"></a><span id="l13.249" class="difflineplus">+  },</span>
<a href="#l13.250"></a><span id="l13.250" class="difflineplus">+  _addContact(aContact) {</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineplus">+    this._contacts.push(aContact);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+  },</span>
<a href="#l13.253"></a><span id="l13.253" class="difflineplus">+  _removeContact(aContact) {</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineplus">+    let index = this._contacts.indexOf(aContact);</span>
<a href="#l13.255"></a><span id="l13.255" class="difflineplus">+    if (index != -1) {</span>
<a href="#l13.256"></a><span id="l13.256" class="difflineplus">+      this._contacts.splice(index, 1);</span>
<a href="#l13.257"></a><span id="l13.257" class="difflineplus">+    }</span>
<a href="#l13.258"></a><span id="l13.258" class="difflineplus">+  },</span>
<a href="#l13.259"></a><span id="l13.259" class="difflineplus">+</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l13.262"></a><span id="l13.262" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l13.263"></a><span id="l13.263" class="difflineplus">+    }</span>
<a href="#l13.264"></a><span id="l13.264" class="difflineplus">+  },</span>
<a href="#l13.265"></a><span id="l13.265" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l13.266"></a><span id="l13.266" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l13.267"></a><span id="l13.267" class="difflineplus">+  },</span>
<a href="#l13.268"></a><span id="l13.268" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l13.269"></a><span id="l13.269" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineplus">+      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+    }</span>
<a href="#l13.272"></a><span id="l13.272" class="difflineplus">+  },</span>
<a href="#l13.273"></a><span id="l13.273" class="difflineplus">+};</span>
<a href="#l13.274"></a><span id="l13.274" class="difflineplus">+</span>
<a href="#l13.275"></a><span id="l13.275" class="difflineplus">+var otherContactsTag = {</span>
<a href="#l13.276"></a><span id="l13.276" class="difflineplus">+  __proto__: ClassInfo([&quot;nsIObserver&quot;, &quot;imITag&quot;], &quot;Other Contacts Tag&quot;),</span>
<a href="#l13.277"></a><span id="l13.277" class="difflineplus">+  hiddenTagsPref: &quot;messenger.buddies.hiddenTags&quot;,</span>
<a href="#l13.278"></a><span id="l13.278" class="difflineplus">+  _hiddenTags: {},</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineplus">+  _contactsInitialized: false,</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+  _saveHiddenTagsPref() {</span>
<a href="#l13.281"></a><span id="l13.281" class="difflineplus">+    Services.prefs.setCharPref(</span>
<a href="#l13.282"></a><span id="l13.282" class="difflineplus">+      this.hiddenTagsPref,</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineplus">+      Object.keys(this._hiddenTags).join(&quot;,&quot;)</span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+    );</span>
<a href="#l13.285"></a><span id="l13.285" class="difflineplus">+  },</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineplus">+  showTag(aTag) {</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+    let id = aTag.id;</span>
<a href="#l13.288"></a><span id="l13.288" class="difflineplus">+    delete this._hiddenTags[id];</span>
<a href="#l13.289"></a><span id="l13.289" class="difflineplus">+    let contacts = Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineplus">+    for (let contact of contacts) {</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+      if (contact.getTags().some(t =&gt; t.id == id)) {</span>
<a href="#l13.292"></a><span id="l13.292" class="difflineplus">+        this._removeContact(contact);</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineplus">+      }</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineplus">+    }</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+    aTag.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l13.297"></a><span id="l13.297" class="difflineplus">+    Services.obs.notifyObservers(aTag, &quot;tag-shown&quot;);</span>
<a href="#l13.298"></a><span id="l13.298" class="difflineplus">+    this._saveHiddenTagsPref();</span>
<a href="#l13.299"></a><span id="l13.299" class="difflineplus">+  },</span>
<a href="#l13.300"></a><span id="l13.300" class="difflineplus">+  hideTag(aTag) {</span>
<a href="#l13.301"></a><span id="l13.301" class="difflineplus">+    if (aTag.id &lt; 0 || aTag.id in otherContactsTag._hiddenTags) {</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineplus">+      return;</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+    }</span>
<a href="#l13.304"></a><span id="l13.304" class="difflineplus">+</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineplus">+    this._hiddenTags[aTag.id] = aTag;</span>
<a href="#l13.306"></a><span id="l13.306" class="difflineplus">+    if (this._contactsInitialized) {</span>
<a href="#l13.307"></a><span id="l13.307" class="difflineplus">+      this._hideTag(aTag);</span>
<a href="#l13.308"></a><span id="l13.308" class="difflineplus">+    }</span>
<a href="#l13.309"></a><span id="l13.309" class="difflineplus">+</span>
<a href="#l13.310"></a><span id="l13.310" class="difflineplus">+    aTag.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l13.311"></a><span id="l13.311" class="difflineplus">+    Services.obs.notifyObservers(aTag, &quot;tag-hidden&quot;);</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineplus">+    this._saveHiddenTagsPref();</span>
<a href="#l13.313"></a><span id="l13.313" class="difflineplus">+  },</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineplus">+  _hideTag(aTag) {</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+    for (let contact of aTag.getContacts()) {</span>
<a href="#l13.316"></a><span id="l13.316" class="difflineplus">+      if (</span>
<a href="#l13.317"></a><span id="l13.317" class="difflineplus">+        !(contact.id in this._contacts) &amp;&amp;</span>
<a href="#l13.318"></a><span id="l13.318" class="difflineplus">+        contact.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l13.319"></a><span id="l13.319" class="difflineplus">+      ) {</span>
<a href="#l13.320"></a><span id="l13.320" class="difflineplus">+        this._addContact(contact);</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineplus">+      }</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+    }</span>
<a href="#l13.323"></a><span id="l13.323" class="difflineplus">+  },</span>
<a href="#l13.324"></a><span id="l13.324" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l13.325"></a><span id="l13.325" class="difflineplus">+    aSubject.QueryInterface(Ci.imIContact);</span>
<a href="#l13.326"></a><span id="l13.326" class="difflineplus">+    if (aTopic == &quot;contact-tag-removed&quot; || aTopic == &quot;contact-added&quot;) {</span>
<a href="#l13.327"></a><span id="l13.327" class="difflineplus">+      if (</span>
<a href="#l13.328"></a><span id="l13.328" class="difflineplus">+        !(aSubject.id in this._contacts) &amp;&amp;</span>
<a href="#l13.329"></a><span id="l13.329" class="difflineplus">+        !(parseInt(aData) in this._hiddenTags) &amp;&amp;</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineplus">+        aSubject.getTags().every(t =&gt; t.id in this._hiddenTags)</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineplus">+      ) {</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+        this._addContact(aSubject);</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+      }</span>
<a href="#l13.334"></a><span id="l13.334" class="difflineplus">+    } else if (</span>
<a href="#l13.335"></a><span id="l13.335" class="difflineplus">+      aSubject.id in this._contacts &amp;&amp;</span>
<a href="#l13.336"></a><span id="l13.336" class="difflineplus">+      (aTopic == &quot;contact-removed&quot; ||</span>
<a href="#l13.337"></a><span id="l13.337" class="difflineplus">+        (aTopic == &quot;contact-tag-added&quot; &amp;&amp;</span>
<a href="#l13.338"></a><span id="l13.338" class="difflineplus">+          !(parseInt(aData) in this._hiddenTags)))</span>
<a href="#l13.339"></a><span id="l13.339" class="difflineplus">+    ) {</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineplus">+      this._removeContact(aSubject);</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+    }</span>
<a href="#l13.342"></a><span id="l13.342" class="difflineplus">+  },</span>
<a href="#l13.343"></a><span id="l13.343" class="difflineplus">+</span>
<a href="#l13.344"></a><span id="l13.344" class="difflineplus">+  _initHiddenTags() {</span>
<a href="#l13.345"></a><span id="l13.345" class="difflineplus">+    let pref = Services.prefs.getCharPref(this.hiddenTagsPref);</span>
<a href="#l13.346"></a><span id="l13.346" class="difflineplus">+    if (!pref) {</span>
<a href="#l13.347"></a><span id="l13.347" class="difflineplus">+      return;</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineplus">+    }</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+    for (let tagId of pref.split(&quot;,&quot;)) {</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineplus">+      this._hiddenTags[tagId] = TagsById[tagId];</span>
<a href="#l13.351"></a><span id="l13.351" class="difflineplus">+    }</span>
<a href="#l13.352"></a><span id="l13.352" class="difflineplus">+  },</span>
<a href="#l13.353"></a><span id="l13.353" class="difflineplus">+  _initContacts() {</span>
<a href="#l13.354"></a><span id="l13.354" class="difflineplus">+    if (this._contactsInitialized) {</span>
<a href="#l13.355"></a><span id="l13.355" class="difflineplus">+      return;</span>
<a href="#l13.356"></a><span id="l13.356" class="difflineplus">+    }</span>
<a href="#l13.357"></a><span id="l13.357" class="difflineplus">+    this._observers = [];</span>
<a href="#l13.358"></a><span id="l13.358" class="difflineplus">+    this._observer = {</span>
<a href="#l13.359"></a><span id="l13.359" class="difflineplus">+      self: this,</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineplus">+      observe(aSubject, aTopic, aData) {</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineplus">+        if (aTopic == &quot;contact-moved-in&quot; &amp;&amp; !(aSubject instanceof Contact)) {</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineplus">+          return;</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineplus">+        }</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+        this.self.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+      },</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+    };</span>
<a href="#l13.368"></a><span id="l13.368" class="difflineplus">+    this._contacts = {};</span>
<a href="#l13.369"></a><span id="l13.369" class="difflineplus">+    this._contactsInitialized = true;</span>
<a href="#l13.370"></a><span id="l13.370" class="difflineplus">+    for (let id in this._hiddenTags) {</span>
<a href="#l13.371"></a><span id="l13.371" class="difflineplus">+      let tag = this._hiddenTags[id];</span>
<a href="#l13.372"></a><span id="l13.372" class="difflineplus">+      this._hideTag(tag);</span>
<a href="#l13.373"></a><span id="l13.373" class="difflineplus">+    }</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineplus">+    Services.obs.addObserver(this, &quot;contact-tag-added&quot;);</span>
<a href="#l13.375"></a><span id="l13.375" class="difflineplus">+    Services.obs.addObserver(this, &quot;contact-tag-removed&quot;);</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineplus">+    Services.obs.addObserver(this, &quot;contact-added&quot;);</span>
<a href="#l13.377"></a><span id="l13.377" class="difflineplus">+    Services.obs.addObserver(this, &quot;contact-removed&quot;);</span>
<a href="#l13.378"></a><span id="l13.378" class="difflineplus">+  },</span>
<a href="#l13.379"></a><span id="l13.379" class="difflineplus">+</span>
<a href="#l13.380"></a><span id="l13.380" class="difflineplus">+  // imITag implementation</span>
<a href="#l13.381"></a><span id="l13.381" class="difflineplus">+  get id() {</span>
<a href="#l13.382"></a><span id="l13.382" class="difflineplus">+    return -1;</span>
<a href="#l13.383"></a><span id="l13.383" class="difflineplus">+  },</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+  get name() {</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineplus">+    return &quot;__others__&quot;;</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+  },</span>
<a href="#l13.387"></a><span id="l13.387" class="difflineplus">+  set name(aNewName) {</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineplus">+    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineplus">+  },</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineplus">+  getContacts() {</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+    return Object.keys(this._contacts).map(id =&gt; this._contacts[id]);</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+  },</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+  _addContact(aContact) {</span>
<a href="#l13.394"></a><span id="l13.394" class="difflineplus">+    this._contacts[aContact.id] = aContact;</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineplus">+    this.notifyObservers(aContact, &quot;contact-moved-in&quot;);</span>
<a href="#l13.396"></a><span id="l13.396" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l13.397"></a><span id="l13.397" class="difflineplus">+      observer.observe(this, &quot;contact-moved-in&quot;, null);</span>
<a href="#l13.398"></a><span id="l13.398" class="difflineplus">+    }</span>
<a href="#l13.399"></a><span id="l13.399" class="difflineplus">+    aContact.addObserver(this._observer);</span>
<a href="#l13.400"></a><span id="l13.400" class="difflineplus">+  },</span>
<a href="#l13.401"></a><span id="l13.401" class="difflineplus">+  _removeContact(aContact) {</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineplus">+    delete this._contacts[aContact.id];</span>
<a href="#l13.403"></a><span id="l13.403" class="difflineplus">+    aContact.removeObserver(this._observer);</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineplus">+    this.notifyObservers(aContact, &quot;contact-moved-out&quot;);</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+    for (let observer of ContactsById[aContact.id]._observers) {</span>
<a href="#l13.406"></a><span id="l13.406" class="difflineplus">+      observer.observe(this, &quot;contact-moved-out&quot;, null);</span>
<a href="#l13.407"></a><span id="l13.407" class="difflineplus">+    }</span>
<a href="#l13.408"></a><span id="l13.408" class="difflineplus">+  },</span>
<a href="#l13.409"></a><span id="l13.409" class="difflineplus">+</span>
<a href="#l13.410"></a><span id="l13.410" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l13.411"></a><span id="l13.411" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+    }</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+  },</span>
<a href="#l13.415"></a><span id="l13.415" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l13.416"></a><span id="l13.416" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineplus">+  },</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l13.419"></a><span id="l13.419" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l13.420"></a><span id="l13.420" class="difflineplus">+      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l13.421"></a><span id="l13.421" class="difflineplus">+    }</span>
<a href="#l13.422"></a><span id="l13.422" class="difflineplus">+  },</span>
<a href="#l13.423"></a><span id="l13.423" class="difflineplus">+};</span>
<a href="#l13.424"></a><span id="l13.424" class="difflineplus">+</span>
<a href="#l13.425"></a><span id="l13.425" class="difflineplus">+var ContactsById = {};</span>
<a href="#l13.426"></a><span id="l13.426" class="difflineplus">+var LastDummyContactId = 0;</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineplus">+function Contact(aId, aAlias) {</span>
<a href="#l13.428"></a><span id="l13.428" class="difflineplus">+  // Assign a negative id to dummy contacts that have a single buddy</span>
<a href="#l13.429"></a><span id="l13.429" class="difflineplus">+  this._id = aId || --LastDummyContactId;</span>
<a href="#l13.430"></a><span id="l13.430" class="difflineplus">+  this._alias = aAlias;</span>
<a href="#l13.431"></a><span id="l13.431" class="difflineplus">+  this._tags = [];</span>
<a href="#l13.432"></a><span id="l13.432" class="difflineplus">+  this._buddies = [];</span>
<a href="#l13.433"></a><span id="l13.433" class="difflineplus">+  this._observers = [];</span>
<a href="#l13.434"></a><span id="l13.434" class="difflineplus">+</span>
<a href="#l13.435"></a><span id="l13.435" class="difflineplus">+  ContactsById[this._id] = this;</span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+}</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+Contact.prototype = {</span>
<a href="#l13.438"></a><span id="l13.438" class="difflineplus">+  __proto__: ClassInfo(&quot;imIContact&quot;, &quot;Contact&quot;),</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineplus">+  _id: 0,</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+  get id() {</span>
<a href="#l13.441"></a><span id="l13.441" class="difflineplus">+    return this._id;</span>
<a href="#l13.442"></a><span id="l13.442" class="difflineplus">+  },</span>
<a href="#l13.443"></a><span id="l13.443" class="difflineplus">+  get alias() {</span>
<a href="#l13.444"></a><span id="l13.444" class="difflineplus">+    return this._alias;</span>
<a href="#l13.445"></a><span id="l13.445" class="difflineplus">+  },</span>
<a href="#l13.446"></a><span id="l13.446" class="difflineplus">+  set alias(aNewAlias) {</span>
<a href="#l13.447"></a><span id="l13.447" class="difflineplus">+    this._ensureNotDummy();</span>
<a href="#l13.448"></a><span id="l13.448" class="difflineplus">+</span>
<a href="#l13.449"></a><span id="l13.449" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.450"></a><span id="l13.450" class="difflineplus">+      &quot;UPDATE contacts SET alias = :alias WHERE id = :id&quot;</span>
<a href="#l13.451"></a><span id="l13.451" class="difflineplus">+    );</span>
<a href="#l13.452"></a><span id="l13.452" class="difflineplus">+    statement.params.alias = aNewAlias;</span>
<a href="#l13.453"></a><span id="l13.453" class="difflineplus">+    statement.params.id = this._id;</span>
<a href="#l13.454"></a><span id="l13.454" class="difflineplus">+    executeAsyncThenFinalize(statement);</span>
<a href="#l13.455"></a><span id="l13.455" class="difflineplus">+</span>
<a href="#l13.456"></a><span id="l13.456" class="difflineplus">+    let oldDisplayName = this.displayName;</span>
<a href="#l13.457"></a><span id="l13.457" class="difflineplus">+    this._alias = aNewAlias;</span>
<a href="#l13.458"></a><span id="l13.458" class="difflineplus">+    this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l13.459"></a><span id="l13.459" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l13.460"></a><span id="l13.460" class="difflineplus">+      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l13.461"></a><span id="l13.461" class="difflineplus">+        accountBuddy.serverAlias = aNewAlias;</span>
<a href="#l13.462"></a><span id="l13.462" class="difflineplus">+      }</span>
<a href="#l13.463"></a><span id="l13.463" class="difflineplus">+    }</span>
<a href="#l13.464"></a><span id="l13.464" class="difflineplus">+    return aNewAlias;</span>
<a href="#l13.465"></a><span id="l13.465" class="difflineplus">+  },</span>
<a href="#l13.466"></a><span id="l13.466" class="difflineplus">+  _ensureNotDummy() {</span>
<a href="#l13.467"></a><span id="l13.467" class="difflineplus">+    if (this._id &gt;= 0) {</span>
<a href="#l13.468"></a><span id="l13.468" class="difflineplus">+      return;</span>
<a href="#l13.469"></a><span id="l13.469" class="difflineplus">+    }</span>
<a href="#l13.470"></a><span id="l13.470" class="difflineplus">+</span>
<a href="#l13.471"></a><span id="l13.471" class="difflineplus">+    // Create a real contact for this dummy contact</span>
<a href="#l13.472"></a><span id="l13.472" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.473"></a><span id="l13.473" class="difflineplus">+      &quot;INSERT INTO contacts DEFAULT VALUES&quot;</span>
<a href="#l13.474"></a><span id="l13.474" class="difflineplus">+    );</span>
<a href="#l13.475"></a><span id="l13.475" class="difflineplus">+    try {</span>
<a href="#l13.476"></a><span id="l13.476" class="difflineplus">+      statement.execute();</span>
<a href="#l13.477"></a><span id="l13.477" class="difflineplus">+    } finally {</span>
<a href="#l13.478"></a><span id="l13.478" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.479"></a><span id="l13.479" class="difflineplus">+    }</span>
<a href="#l13.480"></a><span id="l13.480" class="difflineplus">+    delete ContactsById[this._id];</span>
<a href="#l13.481"></a><span id="l13.481" class="difflineplus">+    let oldId = this._id;</span>
<a href="#l13.482"></a><span id="l13.482" class="difflineplus">+    this._id = DBConn.lastInsertRowID;</span>
<a href="#l13.483"></a><span id="l13.483" class="difflineplus">+    ContactsById[this._id] = this;</span>
<a href="#l13.484"></a><span id="l13.484" class="difflineplus">+    this._notifyObservers(&quot;no-longer-dummy&quot;, oldId.toString());</span>
<a href="#l13.485"></a><span id="l13.485" class="difflineplus">+    // Update the contact_id for the single existing buddy of this contact</span>
<a href="#l13.486"></a><span id="l13.486" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.487"></a><span id="l13.487" class="difflineplus">+      &quot;UPDATE buddies SET contact_id = :id WHERE id = :buddy_id&quot;</span>
<a href="#l13.488"></a><span id="l13.488" class="difflineplus">+    );</span>
<a href="#l13.489"></a><span id="l13.489" class="difflineplus">+    statement.params.id = this._id;</span>
<a href="#l13.490"></a><span id="l13.490" class="difflineplus">+    statement.params.buddy_id = this._buddies[0].id;</span>
<a href="#l13.491"></a><span id="l13.491" class="difflineplus">+    executeAsyncThenFinalize(statement);</span>
<a href="#l13.492"></a><span id="l13.492" class="difflineplus">+  },</span>
<a href="#l13.493"></a><span id="l13.493" class="difflineplus">+</span>
<a href="#l13.494"></a><span id="l13.494" class="difflineplus">+  getTags() {</span>
<a href="#l13.495"></a><span id="l13.495" class="difflineplus">+    return this._tags;</span>
<a href="#l13.496"></a><span id="l13.496" class="difflineplus">+  },</span>
<a href="#l13.497"></a><span id="l13.497" class="difflineplus">+  addTag(aTag, aInherited) {</span>
<a href="#l13.498"></a><span id="l13.498" class="difflineplus">+    if (this.hasTag(aTag)) {</span>
<a href="#l13.499"></a><span id="l13.499" class="difflineplus">+      return;</span>
<a href="#l13.500"></a><span id="l13.500" class="difflineplus">+    }</span>
<a href="#l13.501"></a><span id="l13.501" class="difflineplus">+</span>
<a href="#l13.502"></a><span id="l13.502" class="difflineplus">+    if (!aInherited) {</span>
<a href="#l13.503"></a><span id="l13.503" class="difflineplus">+      this._ensureNotDummy();</span>
<a href="#l13.504"></a><span id="l13.504" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l13.505"></a><span id="l13.505" class="difflineplus">+        &quot;INSERT INTO contact_tag (contact_id, tag_id) &quot; +</span>
<a href="#l13.506"></a><span id="l13.506" class="difflineplus">+          &quot;VALUES(:contactId, :tagId)&quot;</span>
<a href="#l13.507"></a><span id="l13.507" class="difflineplus">+      );</span>
<a href="#l13.508"></a><span id="l13.508" class="difflineplus">+      statement.params.contactId = this.id;</span>
<a href="#l13.509"></a><span id="l13.509" class="difflineplus">+      statement.params.tagId = aTag.id;</span>
<a href="#l13.510"></a><span id="l13.510" class="difflineplus">+      executeAsyncThenFinalize(statement);</span>
<a href="#l13.511"></a><span id="l13.511" class="difflineplus">+    }</span>
<a href="#l13.512"></a><span id="l13.512" class="difflineplus">+</span>
<a href="#l13.513"></a><span id="l13.513" class="difflineplus">+    aTag = TagsById[aTag.id];</span>
<a href="#l13.514"></a><span id="l13.514" class="difflineplus">+    this._tags.push(aTag);</span>
<a href="#l13.515"></a><span id="l13.515" class="difflineplus">+    aTag._addContact(this);</span>
<a href="#l13.516"></a><span id="l13.516" class="difflineplus">+</span>
<a href="#l13.517"></a><span id="l13.517" class="difflineplus">+    aTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l13.518"></a><span id="l13.518" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l13.519"></a><span id="l13.519" class="difflineplus">+      observer.observe(aTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l13.520"></a><span id="l13.520" class="difflineplus">+    }</span>
<a href="#l13.521"></a><span id="l13.521" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aTag.id);</span>
<a href="#l13.522"></a><span id="l13.522" class="difflineplus">+  },</span>
<a href="#l13.523"></a><span id="l13.523" class="difflineplus">+  /* Remove a tag from the local tags of the contact. */</span>
<a href="#l13.524"></a><span id="l13.524" class="difflineplus">+  _removeTag(aTag) {</span>
<a href="#l13.525"></a><span id="l13.525" class="difflineplus">+    if (!this.hasTag(aTag) || this._isTagInherited(aTag)) {</span>
<a href="#l13.526"></a><span id="l13.526" class="difflineplus">+      return;</span>
<a href="#l13.527"></a><span id="l13.527" class="difflineplus">+    }</span>
<a href="#l13.528"></a><span id="l13.528" class="difflineplus">+</span>
<a href="#l13.529"></a><span id="l13.529" class="difflineplus">+    this._removeContactTagRow(aTag);</span>
<a href="#l13.530"></a><span id="l13.530" class="difflineplus">+</span>
<a href="#l13.531"></a><span id="l13.531" class="difflineplus">+    this._tags = this._tags.filter(tag =&gt; tag.id != aTag.id);</span>
<a href="#l13.532"></a><span id="l13.532" class="difflineplus">+    aTag = TagsById[aTag.id];</span>
<a href="#l13.533"></a><span id="l13.533" class="difflineplus">+    aTag._removeContact(this);</span>
<a href="#l13.534"></a><span id="l13.534" class="difflineplus">+</span>
<a href="#l13.535"></a><span id="l13.535" class="difflineplus">+    aTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l13.536"></a><span id="l13.536" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l13.537"></a><span id="l13.537" class="difflineplus">+      observer.observe(aTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l13.538"></a><span id="l13.538" class="difflineplus">+    }</span>
<a href="#l13.539"></a><span id="l13.539" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aTag.id);</span>
<a href="#l13.540"></a><span id="l13.540" class="difflineplus">+  },</span>
<a href="#l13.541"></a><span id="l13.541" class="difflineplus">+  _removeContactTagRow(aTag) {</span>
<a href="#l13.542"></a><span id="l13.542" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.543"></a><span id="l13.543" class="difflineplus">+      &quot;DELETE FROM contact_tag &quot; +</span>
<a href="#l13.544"></a><span id="l13.544" class="difflineplus">+        &quot;WHERE contact_id = :contactId &quot; +</span>
<a href="#l13.545"></a><span id="l13.545" class="difflineplus">+        &quot;AND tag_id = :tagId&quot;</span>
<a href="#l13.546"></a><span id="l13.546" class="difflineplus">+    );</span>
<a href="#l13.547"></a><span id="l13.547" class="difflineplus">+    statement.params.contactId = this.id;</span>
<a href="#l13.548"></a><span id="l13.548" class="difflineplus">+    statement.params.tagId = aTag.id;</span>
<a href="#l13.549"></a><span id="l13.549" class="difflineplus">+    executeAsyncThenFinalize(statement);</span>
<a href="#l13.550"></a><span id="l13.550" class="difflineplus">+  },</span>
<a href="#l13.551"></a><span id="l13.551" class="difflineplus">+  hasTag(aTag) {</span>
<a href="#l13.552"></a><span id="l13.552" class="difflineplus">+    return this._tags.some(t =&gt; t.id == aTag.id);</span>
<a href="#l13.553"></a><span id="l13.553" class="difflineplus">+  },</span>
<a href="#l13.554"></a><span id="l13.554" class="difflineplus">+  _massMove: false,</span>
<a href="#l13.555"></a><span id="l13.555" class="difflineplus">+  removeTag(aTag) {</span>
<a href="#l13.556"></a><span id="l13.556" class="difflineplus">+    if (!this.hasTag(aTag)) {</span>
<a href="#l13.557"></a><span id="l13.557" class="difflineplus">+      throw new Error(</span>
<a href="#l13.558"></a><span id="l13.558" class="difflineplus">+        &quot;Attempting to remove a tag that the contact doesn't have&quot;</span>
<a href="#l13.559"></a><span id="l13.559" class="difflineplus">+      );</span>
<a href="#l13.560"></a><span id="l13.560" class="difflineplus">+    }</span>
<a href="#l13.561"></a><span id="l13.561" class="difflineplus">+    if (this._tags.length == 1) {</span>
<a href="#l13.562"></a><span id="l13.562" class="difflineplus">+      throw new Error(&quot;Attempting to remove the last tag of a contact&quot;);</span>
<a href="#l13.563"></a><span id="l13.563" class="difflineplus">+    }</span>
<a href="#l13.564"></a><span id="l13.564" class="difflineplus">+</span>
<a href="#l13.565"></a><span id="l13.565" class="difflineplus">+    this._massMove = true;</span>
<a href="#l13.566"></a><span id="l13.566" class="difflineplus">+    let hasTag = this.hasTag.bind(this);</span>
<a href="#l13.567"></a><span id="l13.567" class="difflineplus">+    let newTag = this._tags[this._tags[0].id != aTag.id ? 0 : 1];</span>
<a href="#l13.568"></a><span id="l13.568" class="difflineplus">+    let moved = false;</span>
<a href="#l13.569"></a><span id="l13.569" class="difflineplus">+    this._buddies.forEach(function(aBuddy) {</span>
<a href="#l13.570"></a><span id="l13.570" class="difflineplus">+      aBuddy._accounts.forEach(function(aAccountBuddy) {</span>
<a href="#l13.571"></a><span id="l13.571" class="difflineplus">+        if (aAccountBuddy.tag.id == aTag.id) {</span>
<a href="#l13.572"></a><span id="l13.572" class="difflineplus">+          if (</span>
<a href="#l13.573"></a><span id="l13.573" class="difflineplus">+            aBuddy._accounts.some(</span>
<a href="#l13.574"></a><span id="l13.574" class="difflineplus">+              ab =&gt;</span>
<a href="#l13.575"></a><span id="l13.575" class="difflineplus">+                ab.account.numericId == aAccountBuddy.account.numericId &amp;&amp;</span>
<a href="#l13.576"></a><span id="l13.576" class="difflineplus">+                ab.tag.id != aTag.id &amp;&amp;</span>
<a href="#l13.577"></a><span id="l13.577" class="difflineplus">+                hasTag(ab.tag)</span>
<a href="#l13.578"></a><span id="l13.578" class="difflineplus">+            )</span>
<a href="#l13.579"></a><span id="l13.579" class="difflineplus">+          ) {</span>
<a href="#l13.580"></a><span id="l13.580" class="difflineplus">+            // A buddy that already has an accountBuddy of the same</span>
<a href="#l13.581"></a><span id="l13.581" class="difflineplus">+            // account with another tag of the contact shouldn't be</span>
<a href="#l13.582"></a><span id="l13.582" class="difflineplus">+            // moved to newTag, just remove the accountBuddy</span>
<a href="#l13.583"></a><span id="l13.583" class="difflineplus">+            // associated to the tag we are removing.</span>
<a href="#l13.584"></a><span id="l13.584" class="difflineplus">+            aAccountBuddy.remove();</span>
<a href="#l13.585"></a><span id="l13.585" class="difflineplus">+            moved = true;</span>
<a href="#l13.586"></a><span id="l13.586" class="difflineplus">+          } else {</span>
<a href="#l13.587"></a><span id="l13.587" class="difflineplus">+            try {</span>
<a href="#l13.588"></a><span id="l13.588" class="difflineplus">+              aAccountBuddy.tag = newTag;</span>
<a href="#l13.589"></a><span id="l13.589" class="difflineplus">+              moved = true;</span>
<a href="#l13.590"></a><span id="l13.590" class="difflineplus">+            } catch (e) {</span>
<a href="#l13.591"></a><span id="l13.591" class="difflineplus">+              // Ignore failures. Some protocol plugins may not implement this.</span>
<a href="#l13.592"></a><span id="l13.592" class="difflineplus">+            }</span>
<a href="#l13.593"></a><span id="l13.593" class="difflineplus">+          }</span>
<a href="#l13.594"></a><span id="l13.594" class="difflineplus">+        }</span>
<a href="#l13.595"></a><span id="l13.595" class="difflineplus">+      });</span>
<a href="#l13.596"></a><span id="l13.596" class="difflineplus">+    });</span>
<a href="#l13.597"></a><span id="l13.597" class="difflineplus">+    this._massMove = false;</span>
<a href="#l13.598"></a><span id="l13.598" class="difflineplus">+    if (moved) {</span>
<a href="#l13.599"></a><span id="l13.599" class="difflineplus">+      this._moved(aTag, newTag);</span>
<a href="#l13.600"></a><span id="l13.600" class="difflineplus">+    } else {</span>
<a href="#l13.601"></a><span id="l13.601" class="difflineplus">+      // If we are here, the old tag is not inherited from a buddy, so</span>
<a href="#l13.602"></a><span id="l13.602" class="difflineplus">+      // just remove the local tag.</span>
<a href="#l13.603"></a><span id="l13.603" class="difflineplus">+      this._removeTag(aTag);</span>
<a href="#l13.604"></a><span id="l13.604" class="difflineplus">+    }</span>
<a href="#l13.605"></a><span id="l13.605" class="difflineplus">+  },</span>
<a href="#l13.606"></a><span id="l13.606" class="difflineplus">+  _isTagInherited(aTag) {</span>
<a href="#l13.607"></a><span id="l13.607" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l13.608"></a><span id="l13.608" class="difflineplus">+      for (let accountBuddy of buddy._accounts) {</span>
<a href="#l13.609"></a><span id="l13.609" class="difflineplus">+        if (accountBuddy.tag.id == aTag.id) {</span>
<a href="#l13.610"></a><span id="l13.610" class="difflineplus">+          return true;</span>
<a href="#l13.611"></a><span id="l13.611" class="difflineplus">+        }</span>
<a href="#l13.612"></a><span id="l13.612" class="difflineplus">+      }</span>
<a href="#l13.613"></a><span id="l13.613" class="difflineplus">+    }</span>
<a href="#l13.614"></a><span id="l13.614" class="difflineplus">+    return false;</span>
<a href="#l13.615"></a><span id="l13.615" class="difflineplus">+  },</span>
<a href="#l13.616"></a><span id="l13.616" class="difflineplus">+  _moved(aOldTag, aNewTag) {</span>
<a href="#l13.617"></a><span id="l13.617" class="difflineplus">+    if (this._massMove) {</span>
<a href="#l13.618"></a><span id="l13.618" class="difflineplus">+      return;</span>
<a href="#l13.619"></a><span id="l13.619" class="difflineplus">+    }</span>
<a href="#l13.620"></a><span id="l13.620" class="difflineplus">+</span>
<a href="#l13.621"></a><span id="l13.621" class="difflineplus">+    // Avoid xpconnect wrappers.</span>
<a href="#l13.622"></a><span id="l13.622" class="difflineplus">+    aNewTag = aNewTag &amp;&amp; TagsById[aNewTag.id];</span>
<a href="#l13.623"></a><span id="l13.623" class="difflineplus">+    aOldTag = aOldTag &amp;&amp; TagsById[aOldTag.id];</span>
<a href="#l13.624"></a><span id="l13.624" class="difflineplus">+</span>
<a href="#l13.625"></a><span id="l13.625" class="difflineplus">+    // Decide what we need to do. Return early if nothing to do.</span>
<a href="#l13.626"></a><span id="l13.626" class="difflineplus">+    let shouldRemove =</span>
<a href="#l13.627"></a><span id="l13.627" class="difflineplus">+      aOldTag &amp;&amp; this.hasTag(aOldTag) &amp;&amp; !this._isTagInherited(aOldTag);</span>
<a href="#l13.628"></a><span id="l13.628" class="difflineplus">+    let shouldAdd =</span>
<a href="#l13.629"></a><span id="l13.629" class="difflineplus">+      aNewTag &amp;&amp; !this.hasTag(aNewTag) &amp;&amp; this._isTagInherited(aNewTag);</span>
<a href="#l13.630"></a><span id="l13.630" class="difflineplus">+    if (!shouldRemove &amp;&amp; !shouldAdd) {</span>
<a href="#l13.631"></a><span id="l13.631" class="difflineplus">+      return;</span>
<a href="#l13.632"></a><span id="l13.632" class="difflineplus">+    }</span>
<a href="#l13.633"></a><span id="l13.633" class="difflineplus">+</span>
<a href="#l13.634"></a><span id="l13.634" class="difflineplus">+    // Apply the changes.</span>
<a href="#l13.635"></a><span id="l13.635" class="difflineplus">+    let tags = this._tags;</span>
<a href="#l13.636"></a><span id="l13.636" class="difflineplus">+    if (shouldRemove) {</span>
<a href="#l13.637"></a><span id="l13.637" class="difflineplus">+      tags = tags.filter(aTag =&gt; aTag.id != aOldTag.id);</span>
<a href="#l13.638"></a><span id="l13.638" class="difflineplus">+      aOldTag._removeContact(this);</span>
<a href="#l13.639"></a><span id="l13.639" class="difflineplus">+    }</span>
<a href="#l13.640"></a><span id="l13.640" class="difflineplus">+    if (shouldAdd) {</span>
<a href="#l13.641"></a><span id="l13.641" class="difflineplus">+      tags.push(aNewTag);</span>
<a href="#l13.642"></a><span id="l13.642" class="difflineplus">+      aNewTag._addContact(this);</span>
<a href="#l13.643"></a><span id="l13.643" class="difflineplus">+    }</span>
<a href="#l13.644"></a><span id="l13.644" class="difflineplus">+    this._tags = tags;</span>
<a href="#l13.645"></a><span id="l13.645" class="difflineplus">+</span>
<a href="#l13.646"></a><span id="l13.646" class="difflineplus">+    // Finally, notify of the changes.</span>
<a href="#l13.647"></a><span id="l13.647" class="difflineplus">+    if (shouldRemove) {</span>
<a href="#l13.648"></a><span id="l13.648" class="difflineplus">+      aOldTag.notifyObservers(this, &quot;contact-moved-out&quot;);</span>
<a href="#l13.649"></a><span id="l13.649" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l13.650"></a><span id="l13.650" class="difflineplus">+        observer.observe(aOldTag, &quot;contact-moved-out&quot;, null);</span>
<a href="#l13.651"></a><span id="l13.651" class="difflineplus">+      }</span>
<a href="#l13.652"></a><span id="l13.652" class="difflineplus">+      Services.obs.notifyObservers(this, &quot;contact-tag-removed&quot;, aOldTag.id);</span>
<a href="#l13.653"></a><span id="l13.653" class="difflineplus">+    }</span>
<a href="#l13.654"></a><span id="l13.654" class="difflineplus">+    if (shouldAdd) {</span>
<a href="#l13.655"></a><span id="l13.655" class="difflineplus">+      aNewTag.notifyObservers(this, &quot;contact-moved-in&quot;);</span>
<a href="#l13.656"></a><span id="l13.656" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l13.657"></a><span id="l13.657" class="difflineplus">+        observer.observe(aNewTag, &quot;contact-moved-in&quot;, null);</span>
<a href="#l13.658"></a><span id="l13.658" class="difflineplus">+      }</span>
<a href="#l13.659"></a><span id="l13.659" class="difflineplus">+      Services.obs.notifyObservers(this, &quot;contact-tag-added&quot;, aNewTag.id);</span>
<a href="#l13.660"></a><span id="l13.660" class="difflineplus">+    }</span>
<a href="#l13.661"></a><span id="l13.661" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;contact-moved&quot;);</span>
<a href="#l13.662"></a><span id="l13.662" class="difflineplus">+  },</span>
<a href="#l13.663"></a><span id="l13.663" class="difflineplus">+</span>
<a href="#l13.664"></a><span id="l13.664" class="difflineplus">+  getBuddies() {</span>
<a href="#l13.665"></a><span id="l13.665" class="difflineplus">+    return this._buddies;</span>
<a href="#l13.666"></a><span id="l13.666" class="difflineplus">+  },</span>
<a href="#l13.667"></a><span id="l13.667" class="difflineplus">+  get _empty() {</span>
<a href="#l13.668"></a><span id="l13.668" class="difflineplus">+    return this._buddies.length == 0 || this._buddies.every(b =&gt; b._empty);</span>
<a href="#l13.669"></a><span id="l13.669" class="difflineplus">+  },</span>
<a href="#l13.670"></a><span id="l13.670" class="difflineplus">+</span>
<a href="#l13.671"></a><span id="l13.671" class="difflineplus">+  mergeContact(aContact) {</span>
<a href="#l13.672"></a><span id="l13.672" class="difflineplus">+    // Avoid merging the contact with itself or merging into an</span>
<a href="#l13.673"></a><span id="l13.673" class="difflineplus">+    // already removed contact.</span>
<a href="#l13.674"></a><span id="l13.674" class="difflineplus">+    if (aContact.id == this.id || !(this.id in ContactsById)) {</span>
<a href="#l13.675"></a><span id="l13.675" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.676"></a><span id="l13.676" class="difflineplus">+    }</span>
<a href="#l13.677"></a><span id="l13.677" class="difflineplus">+</span>
<a href="#l13.678"></a><span id="l13.678" class="difflineplus">+    this._ensureNotDummy();</span>
<a href="#l13.679"></a><span id="l13.679" class="difflineplus">+    let contact = ContactsById[aContact.id]; // remove XPConnect wrapper</span>
<a href="#l13.680"></a><span id="l13.680" class="difflineplus">+</span>
<a href="#l13.681"></a><span id="l13.681" class="difflineplus">+    // Copy all the contact-only tags first, otherwise they would be lost.</span>
<a href="#l13.682"></a><span id="l13.682" class="difflineplus">+    for (let tag of contact.getTags()) {</span>
<a href="#l13.683"></a><span id="l13.683" class="difflineplus">+      if (!contact._isTagInherited(tag)) {</span>
<a href="#l13.684"></a><span id="l13.684" class="difflineplus">+        this.addTag(tag);</span>
<a href="#l13.685"></a><span id="l13.685" class="difflineplus">+      }</span>
<a href="#l13.686"></a><span id="l13.686" class="difflineplus">+    }</span>
<a href="#l13.687"></a><span id="l13.687" class="difflineplus">+</span>
<a href="#l13.688"></a><span id="l13.688" class="difflineplus">+    // Adopt each buddy. Removing the last one will delete the contact.</span>
<a href="#l13.689"></a><span id="l13.689" class="difflineplus">+    for (let buddy of contact.getBuddies()) {</span>
<a href="#l13.690"></a><span id="l13.690" class="difflineplus">+      buddy.contact = this;</span>
<a href="#l13.691"></a><span id="l13.691" class="difflineplus">+    }</span>
<a href="#l13.692"></a><span id="l13.692" class="difflineplus">+    this._updatePreferredBuddy();</span>
<a href="#l13.693"></a><span id="l13.693" class="difflineplus">+  },</span>
<a href="#l13.694"></a><span id="l13.694" class="difflineplus">+  moveBuddyBefore(aBuddy, aBeforeBuddy) {</span>
<a href="#l13.695"></a><span id="l13.695" class="difflineplus">+    let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l13.696"></a><span id="l13.696" class="difflineplus">+    let oldPosition = this._buddies.indexOf(buddy);</span>
<a href="#l13.697"></a><span id="l13.697" class="difflineplus">+    if (oldPosition == -1) {</span>
<a href="#l13.698"></a><span id="l13.698" class="difflineplus">+      throw new Error(&quot;aBuddy isn't attached to this contact&quot;);</span>
<a href="#l13.699"></a><span id="l13.699" class="difflineplus">+    }</span>
<a href="#l13.700"></a><span id="l13.700" class="difflineplus">+</span>
<a href="#l13.701"></a><span id="l13.701" class="difflineplus">+    let newPosition = -1;</span>
<a href="#l13.702"></a><span id="l13.702" class="difflineplus">+    if (aBeforeBuddy) {</span>
<a href="#l13.703"></a><span id="l13.703" class="difflineplus">+      newPosition = this._buddies.indexOf(BuddiesById[aBeforeBuddy.id]);</span>
<a href="#l13.704"></a><span id="l13.704" class="difflineplus">+    }</span>
<a href="#l13.705"></a><span id="l13.705" class="difflineplus">+    if (newPosition == -1) {</span>
<a href="#l13.706"></a><span id="l13.706" class="difflineplus">+      newPosition = this._buddies.length - 1;</span>
<a href="#l13.707"></a><span id="l13.707" class="difflineplus">+    }</span>
<a href="#l13.708"></a><span id="l13.708" class="difflineplus">+</span>
<a href="#l13.709"></a><span id="l13.709" class="difflineplus">+    if (oldPosition == newPosition) {</span>
<a href="#l13.710"></a><span id="l13.710" class="difflineplus">+      return;</span>
<a href="#l13.711"></a><span id="l13.711" class="difflineplus">+    }</span>
<a href="#l13.712"></a><span id="l13.712" class="difflineplus">+</span>
<a href="#l13.713"></a><span id="l13.713" class="difflineplus">+    this._buddies.splice(oldPosition, 1);</span>
<a href="#l13.714"></a><span id="l13.714" class="difflineplus">+    this._buddies.splice(newPosition, 0, buddy);</span>
<a href="#l13.715"></a><span id="l13.715" class="difflineplus">+    this._updatePositions(</span>
<a href="#l13.716"></a><span id="l13.716" class="difflineplus">+      Math.min(oldPosition, newPosition),</span>
<a href="#l13.717"></a><span id="l13.717" class="difflineplus">+      Math.max(oldPosition, newPosition)</span>
<a href="#l13.718"></a><span id="l13.718" class="difflineplus">+    );</span>
<a href="#l13.719"></a><span id="l13.719" class="difflineplus">+    buddy._notifyObservers(&quot;position-changed&quot;, String(newPosition));</span>
<a href="#l13.720"></a><span id="l13.720" class="difflineplus">+    this._updatePreferredBuddy(buddy);</span>
<a href="#l13.721"></a><span id="l13.721" class="difflineplus">+  },</span>
<a href="#l13.722"></a><span id="l13.722" class="difflineplus">+  adoptBuddy(aBuddy) {</span>
<a href="#l13.723"></a><span id="l13.723" class="difflineplus">+    if (aBuddy.contact.id == this.id) {</span>
<a href="#l13.724"></a><span id="l13.724" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.725"></a><span id="l13.725" class="difflineplus">+    }</span>
<a href="#l13.726"></a><span id="l13.726" class="difflineplus">+</span>
<a href="#l13.727"></a><span id="l13.727" class="difflineplus">+    let buddy = BuddiesById[aBuddy.id]; // remove XPConnect wrapper</span>
<a href="#l13.728"></a><span id="l13.728" class="difflineplus">+    buddy.contact = this;</span>
<a href="#l13.729"></a><span id="l13.729" class="difflineplus">+    this._updatePreferredBuddy(buddy);</span>
<a href="#l13.730"></a><span id="l13.730" class="difflineplus">+  },</span>
<a href="#l13.731"></a><span id="l13.731" class="difflineplus">+  _massRemove: false,</span>
<a href="#l13.732"></a><span id="l13.732" class="difflineplus">+  _removeBuddy(aBuddy) {</span>
<a href="#l13.733"></a><span id="l13.733" class="difflineplus">+    if (this._buddies.length == 1) {</span>
<a href="#l13.734"></a><span id="l13.734" class="difflineplus">+      if (this._id &gt; 0) {</span>
<a href="#l13.735"></a><span id="l13.735" class="difflineplus">+        let statement = DBConn.createStatement(</span>
<a href="#l13.736"></a><span id="l13.736" class="difflineplus">+          &quot;DELETE FROM contacts WHERE id = :id&quot;</span>
<a href="#l13.737"></a><span id="l13.737" class="difflineplus">+        );</span>
<a href="#l13.738"></a><span id="l13.738" class="difflineplus">+        statement.params.id = this._id;</span>
<a href="#l13.739"></a><span id="l13.739" class="difflineplus">+        executeAsyncThenFinalize(statement);</span>
<a href="#l13.740"></a><span id="l13.740" class="difflineplus">+      }</span>
<a href="#l13.741"></a><span id="l13.741" class="difflineplus">+      this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l13.742"></a><span id="l13.742" class="difflineplus">+      delete ContactsById[this._id];</span>
<a href="#l13.743"></a><span id="l13.743" class="difflineplus">+</span>
<a href="#l13.744"></a><span id="l13.744" class="difflineplus">+      for (let tag of this._tags) {</span>
<a href="#l13.745"></a><span id="l13.745" class="difflineplus">+        tag._removeContact(this);</span>
<a href="#l13.746"></a><span id="l13.746" class="difflineplus">+      }</span>
<a href="#l13.747"></a><span id="l13.747" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l13.748"></a><span id="l13.748" class="difflineplus">+        &quot;DELETE FROM contact_tag WHERE contact_id = :id&quot;</span>
<a href="#l13.749"></a><span id="l13.749" class="difflineplus">+      );</span>
<a href="#l13.750"></a><span id="l13.750" class="difflineplus">+      statement.params.id = this._id;</span>
<a href="#l13.751"></a><span id="l13.751" class="difflineplus">+      executeAsyncThenFinalize(statement);</span>
<a href="#l13.752"></a><span id="l13.752" class="difflineplus">+</span>
<a href="#l13.753"></a><span id="l13.753" class="difflineplus">+      delete this._tags;</span>
<a href="#l13.754"></a><span id="l13.754" class="difflineplus">+      delete this._buddies;</span>
<a href="#l13.755"></a><span id="l13.755" class="difflineplus">+      delete this._observers;</span>
<a href="#l13.756"></a><span id="l13.756" class="difflineplus">+    } else {</span>
<a href="#l13.757"></a><span id="l13.757" class="difflineplus">+      let index = this._buddies.indexOf(aBuddy);</span>
<a href="#l13.758"></a><span id="l13.758" class="difflineplus">+      if (index == -1) {</span>
<a href="#l13.759"></a><span id="l13.759" class="difflineplus">+        throw new Error(&quot;Removing an unknown buddy from contact &quot; + this._id);</span>
<a href="#l13.760"></a><span id="l13.760" class="difflineplus">+      }</span>
<a href="#l13.761"></a><span id="l13.761" class="difflineplus">+</span>
<a href="#l13.762"></a><span id="l13.762" class="difflineplus">+      this._buddies = this._buddies.filter(b =&gt; b !== aBuddy);</span>
<a href="#l13.763"></a><span id="l13.763" class="difflineplus">+</span>
<a href="#l13.764"></a><span id="l13.764" class="difflineplus">+      // If we are actually removing the whole contact, don't bother updating</span>
<a href="#l13.765"></a><span id="l13.765" class="difflineplus">+      // the positions or the preferred buddy.</span>
<a href="#l13.766"></a><span id="l13.766" class="difflineplus">+      if (this._massRemove) {</span>
<a href="#l13.767"></a><span id="l13.767" class="difflineplus">+        return;</span>
<a href="#l13.768"></a><span id="l13.768" class="difflineplus">+      }</span>
<a href="#l13.769"></a><span id="l13.769" class="difflineplus">+</span>
<a href="#l13.770"></a><span id="l13.770" class="difflineplus">+      // No position to update if the removed buddy is at the last position.</span>
<a href="#l13.771"></a><span id="l13.771" class="difflineplus">+      if (index &lt; this._buddies.length) {</span>
<a href="#l13.772"></a><span id="l13.772" class="difflineplus">+        this._updatePositions(index);</span>
<a href="#l13.773"></a><span id="l13.773" class="difflineplus">+      }</span>
<a href="#l13.774"></a><span id="l13.774" class="difflineplus">+</span>
<a href="#l13.775"></a><span id="l13.775" class="difflineplus">+      if (this._preferredBuddy.id == aBuddy.id) {</span>
<a href="#l13.776"></a><span id="l13.776" class="difflineplus">+        this._updatePreferredBuddy();</span>
<a href="#l13.777"></a><span id="l13.777" class="difflineplus">+      }</span>
<a href="#l13.778"></a><span id="l13.778" class="difflineplus">+    }</span>
<a href="#l13.779"></a><span id="l13.779" class="difflineplus">+  },</span>
<a href="#l13.780"></a><span id="l13.780" class="difflineplus">+  _updatePositions(aIndexBegin, aIndexEnd) {</span>
<a href="#l13.781"></a><span id="l13.781" class="difflineplus">+    if (aIndexEnd === undefined) {</span>
<a href="#l13.782"></a><span id="l13.782" class="difflineplus">+      aIndexEnd = this._buddies.length - 1;</span>
<a href="#l13.783"></a><span id="l13.783" class="difflineplus">+    }</span>
<a href="#l13.784"></a><span id="l13.784" class="difflineplus">+    if (aIndexBegin &gt; aIndexEnd) {</span>
<a href="#l13.785"></a><span id="l13.785" class="difflineplus">+      throw new Error(&quot;_updatePositions: Invalid indexes&quot;);</span>
<a href="#l13.786"></a><span id="l13.786" class="difflineplus">+    }</span>
<a href="#l13.787"></a><span id="l13.787" class="difflineplus">+</span>
<a href="#l13.788"></a><span id="l13.788" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.789"></a><span id="l13.789" class="difflineplus">+      &quot;UPDATE buddies SET position = :position WHERE id = :buddyId&quot;</span>
<a href="#l13.790"></a><span id="l13.790" class="difflineplus">+    );</span>
<a href="#l13.791"></a><span id="l13.791" class="difflineplus">+    for (let i = aIndexBegin; i &lt;= aIndexEnd; ++i) {</span>
<a href="#l13.792"></a><span id="l13.792" class="difflineplus">+      statement.params.position = i;</span>
<a href="#l13.793"></a><span id="l13.793" class="difflineplus">+      statement.params.buddyId = this._buddies[i].id;</span>
<a href="#l13.794"></a><span id="l13.794" class="difflineplus">+      statement.executeAsync();</span>
<a href="#l13.795"></a><span id="l13.795" class="difflineplus">+    }</span>
<a href="#l13.796"></a><span id="l13.796" class="difflineplus">+    statement.finalize();</span>
<a href="#l13.797"></a><span id="l13.797" class="difflineplus">+  },</span>
<a href="#l13.798"></a><span id="l13.798" class="difflineplus">+</span>
<a href="#l13.799"></a><span id="l13.799" class="difflineplus">+  detachBuddy(aBuddy) {</span>
<a href="#l13.800"></a><span id="l13.800" class="difflineplus">+    // Should return a new contact with the same list of tags.</span>
<a href="#l13.801"></a><span id="l13.801" class="difflineplus">+    let buddy = BuddiesById[aBuddy.id];</span>
<a href="#l13.802"></a><span id="l13.802" class="difflineplus">+    if (buddy.contact.id != this.id) {</span>
<a href="#l13.803"></a><span id="l13.803" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.804"></a><span id="l13.804" class="difflineplus">+    }</span>
<a href="#l13.805"></a><span id="l13.805" class="difflineplus">+    if (buddy.contact._buddies.length == 1) {</span>
<a href="#l13.806"></a><span id="l13.806" class="difflineplus">+      throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l13.807"></a><span id="l13.807" class="difflineplus">+    }</span>
<a href="#l13.808"></a><span id="l13.808" class="difflineplus">+</span>
<a href="#l13.809"></a><span id="l13.809" class="difflineplus">+    // Save the list of tags, it may be destoyed if the buddy was the last one.</span>
<a href="#l13.810"></a><span id="l13.810" class="difflineplus">+    let tags = buddy.contact.getTags();</span>
<a href="#l13.811"></a><span id="l13.811" class="difflineplus">+</span>
<a href="#l13.812"></a><span id="l13.812" class="difflineplus">+    // Create a new dummy contact and use it for the detached buddy.</span>
<a href="#l13.813"></a><span id="l13.813" class="difflineplus">+    buddy.contact = new Contact();</span>
<a href="#l13.814"></a><span id="l13.814" class="difflineplus">+    buddy.contact._notifyObservers(&quot;added&quot;);</span>
<a href="#l13.815"></a><span id="l13.815" class="difflineplus">+</span>
<a href="#l13.816"></a><span id="l13.816" class="difflineplus">+    // The first tag was inherited during the contact setter.</span>
<a href="#l13.817"></a><span id="l13.817" class="difflineplus">+    // This will copy the remaining tags.</span>
<a href="#l13.818"></a><span id="l13.818" class="difflineplus">+    for (let tag of tags) {</span>
<a href="#l13.819"></a><span id="l13.819" class="difflineplus">+      buddy.contact.addTag(tag);</span>
<a href="#l13.820"></a><span id="l13.820" class="difflineplus">+    }</span>
<a href="#l13.821"></a><span id="l13.821" class="difflineplus">+</span>
<a href="#l13.822"></a><span id="l13.822" class="difflineplus">+    return buddy.contact;</span>
<a href="#l13.823"></a><span id="l13.823" class="difflineplus">+  },</span>
<a href="#l13.824"></a><span id="l13.824" class="difflineplus">+  remove() {</span>
<a href="#l13.825"></a><span id="l13.825" class="difflineplus">+    this._massRemove = true;</span>
<a href="#l13.826"></a><span id="l13.826" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l13.827"></a><span id="l13.827" class="difflineplus">+      buddy.remove();</span>
<a href="#l13.828"></a><span id="l13.828" class="difflineplus">+    }</span>
<a href="#l13.829"></a><span id="l13.829" class="difflineplus">+  },</span>
<a href="#l13.830"></a><span id="l13.830" class="difflineplus">+</span>
<a href="#l13.831"></a><span id="l13.831" class="difflineplus">+  // imIStatusInfo implementation</span>
<a href="#l13.832"></a><span id="l13.832" class="difflineplus">+  _preferredBuddy: null,</span>
<a href="#l13.833"></a><span id="l13.833" class="difflineplus">+  get preferredBuddy() {</span>
<a href="#l13.834"></a><span id="l13.834" class="difflineplus">+    if (!this._preferredBuddy) {</span>
<a href="#l13.835"></a><span id="l13.835" class="difflineplus">+      this._updatePreferredBuddy();</span>
<a href="#l13.836"></a><span id="l13.836" class="difflineplus">+    }</span>
<a href="#l13.837"></a><span id="l13.837" class="difflineplus">+    return this._preferredBuddy;</span>
<a href="#l13.838"></a><span id="l13.838" class="difflineplus">+  },</span>
<a href="#l13.839"></a><span id="l13.839" class="difflineplus">+  set preferredBuddy(aBuddy) {</span>
<a href="#l13.840"></a><span id="l13.840" class="difflineplus">+    let shouldNotify = this._preferredBuddy != null;</span>
<a href="#l13.841"></a><span id="l13.841" class="difflineplus">+    let oldDisplayName =</span>
<a href="#l13.842"></a><span id="l13.842" class="difflineplus">+      this._preferredBuddy &amp;&amp; this._preferredBuddy.displayName;</span>
<a href="#l13.843"></a><span id="l13.843" class="difflineplus">+    this._preferredBuddy = aBuddy;</span>
<a href="#l13.844"></a><span id="l13.844" class="difflineplus">+    if (shouldNotify) {</span>
<a href="#l13.845"></a><span id="l13.845" class="difflineplus">+      this._notifyObservers(&quot;preferred-buddy-changed&quot;);</span>
<a href="#l13.846"></a><span id="l13.846" class="difflineplus">+    }</span>
<a href="#l13.847"></a><span id="l13.847" class="difflineplus">+    if (oldDisplayName &amp;&amp; this._preferredBuddy.displayName != oldDisplayName) {</span>
<a href="#l13.848"></a><span id="l13.848" class="difflineplus">+      this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l13.849"></a><span id="l13.849" class="difflineplus">+    }</span>
<a href="#l13.850"></a><span id="l13.850" class="difflineplus">+    this._updateStatus();</span>
<a href="#l13.851"></a><span id="l13.851" class="difflineplus">+  },</span>
<a href="#l13.852"></a><span id="l13.852" class="difflineplus">+  // aBuddy indicate which buddy's availability has changed.</span>
<a href="#l13.853"></a><span id="l13.853" class="difflineplus">+  _updatePreferredBuddy(aBuddy) {</span>
<a href="#l13.854"></a><span id="l13.854" class="difflineplus">+    if (aBuddy) {</span>
<a href="#l13.855"></a><span id="l13.855" class="difflineplus">+      aBuddy = BuddiesById[aBuddy.id]; // remove potential XPConnect wrapper</span>
<a href="#l13.856"></a><span id="l13.856" class="difflineplus">+</span>
<a href="#l13.857"></a><span id="l13.857" class="difflineplus">+      if (!this._preferredBuddy) {</span>
<a href="#l13.858"></a><span id="l13.858" class="difflineplus">+        this.preferredBuddy = aBuddy;</span>
<a href="#l13.859"></a><span id="l13.859" class="difflineplus">+        return;</span>
<a href="#l13.860"></a><span id="l13.860" class="difflineplus">+      }</span>
<a href="#l13.861"></a><span id="l13.861" class="difflineplus">+</span>
<a href="#l13.862"></a><span id="l13.862" class="difflineplus">+      if (aBuddy.id == this._preferredBuddy.id) {</span>
<a href="#l13.863"></a><span id="l13.863" class="difflineplus">+        // The suggested buddy is already preferred, check if its</span>
<a href="#l13.864"></a><span id="l13.864" class="difflineplus">+        // availability has changed.</span>
<a href="#l13.865"></a><span id="l13.865" class="difflineplus">+        if (</span>
<a href="#l13.866"></a><span id="l13.866" class="difflineplus">+          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l13.867"></a><span id="l13.867" class="difflineplus">+          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l13.868"></a><span id="l13.868" class="difflineplus">+            aBuddy.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l13.869"></a><span id="l13.869" class="difflineplus">+        ) {</span>
<a href="#l13.870"></a><span id="l13.870" class="difflineplus">+          // keep the currently preferred buddy, only update the status.</span>
<a href="#l13.871"></a><span id="l13.871" class="difflineplus">+          this._updateStatus();</span>
<a href="#l13.872"></a><span id="l13.872" class="difflineplus">+          return;</span>
<a href="#l13.873"></a><span id="l13.873" class="difflineplus">+        }</span>
<a href="#l13.874"></a><span id="l13.874" class="difflineplus">+        // We aren't sure that the currently preferred buddy should</span>
<a href="#l13.875"></a><span id="l13.875" class="difflineplus">+        // still be preferred. Let's go through the list!</span>
<a href="#l13.876"></a><span id="l13.876" class="difflineplus">+      } else {</span>
<a href="#l13.877"></a><span id="l13.877" class="difflineplus">+        // The suggested buddy is not currently preferred. If it is</span>
<a href="#l13.878"></a><span id="l13.878" class="difflineplus">+        // more available or at a better position, prefer it!</span>
<a href="#l13.879"></a><span id="l13.879" class="difflineplus">+        if (</span>
<a href="#l13.880"></a><span id="l13.880" class="difflineplus">+          aBuddy.statusType &gt; this._statusType ||</span>
<a href="#l13.881"></a><span id="l13.881" class="difflineplus">+          (aBuddy.statusType == this._statusType &amp;&amp;</span>
<a href="#l13.882"></a><span id="l13.882" class="difflineplus">+            (aBuddy.availabilityDetails &gt; this._availabilityDetails ||</span>
<a href="#l13.883"></a><span id="l13.883" class="difflineplus">+              (aBuddy.availabilityDetails == this._availabilityDetails &amp;&amp;</span>
<a href="#l13.884"></a><span id="l13.884" class="difflineplus">+                this._buddies.indexOf(aBuddy) &lt;</span>
<a href="#l13.885"></a><span id="l13.885" class="difflineplus">+                  this._buddies.indexOf(this.preferredBuddy))))</span>
<a href="#l13.886"></a><span id="l13.886" class="difflineplus">+        ) {</span>
<a href="#l13.887"></a><span id="l13.887" class="difflineplus">+          this.preferredBuddy = aBuddy;</span>
<a href="#l13.888"></a><span id="l13.888" class="difflineplus">+        }</span>
<a href="#l13.889"></a><span id="l13.889" class="difflineplus">+        return;</span>
<a href="#l13.890"></a><span id="l13.890" class="difflineplus">+      }</span>
<a href="#l13.891"></a><span id="l13.891" class="difflineplus">+    }</span>
<a href="#l13.892"></a><span id="l13.892" class="difflineplus">+</span>
<a href="#l13.893"></a><span id="l13.893" class="difflineplus">+    let preferred;</span>
<a href="#l13.894"></a><span id="l13.894" class="difflineplus">+    // |this._buddies| is ordered by user preference, so in case of</span>
<a href="#l13.895"></a><span id="l13.895" class="difflineplus">+    // equal availability, keep the current value of |preferred|.</span>
<a href="#l13.896"></a><span id="l13.896" class="difflineplus">+    for (let buddy of this._buddies) {</span>
<a href="#l13.897"></a><span id="l13.897" class="difflineplus">+      if (</span>
<a href="#l13.898"></a><span id="l13.898" class="difflineplus">+        !preferred ||</span>
<a href="#l13.899"></a><span id="l13.899" class="difflineplus">+        preferred.statusType &lt; buddy.statusType ||</span>
<a href="#l13.900"></a><span id="l13.900" class="difflineplus">+        (preferred.statusType == buddy.statusType &amp;&amp;</span>
<a href="#l13.901"></a><span id="l13.901" class="difflineplus">+          preferred.availabilityDetails &lt; buddy.availabilityDetails)</span>
<a href="#l13.902"></a><span id="l13.902" class="difflineplus">+      ) {</span>
<a href="#l13.903"></a><span id="l13.903" class="difflineplus">+        preferred = buddy;</span>
<a href="#l13.904"></a><span id="l13.904" class="difflineplus">+      }</span>
<a href="#l13.905"></a><span id="l13.905" class="difflineplus">+    }</span>
<a href="#l13.906"></a><span id="l13.906" class="difflineplus">+    if (</span>
<a href="#l13.907"></a><span id="l13.907" class="difflineplus">+      preferred &amp;&amp;</span>
<a href="#l13.908"></a><span id="l13.908" class="difflineplus">+      (!this._preferredBuddy || preferred.id != this._preferredBuddy.id)</span>
<a href="#l13.909"></a><span id="l13.909" class="difflineplus">+    ) {</span>
<a href="#l13.910"></a><span id="l13.910" class="difflineplus">+      this.preferredBuddy = preferred;</span>
<a href="#l13.911"></a><span id="l13.911" class="difflineplus">+    }</span>
<a href="#l13.912"></a><span id="l13.912" class="difflineplus">+  },</span>
<a href="#l13.913"></a><span id="l13.913" class="difflineplus">+  _updateStatus() {</span>
<a href="#l13.914"></a><span id="l13.914" class="difflineplus">+    let buddy = this._preferredBuddy; // for convenience</span>
<a href="#l13.915"></a><span id="l13.915" class="difflineplus">+</span>
<a href="#l13.916"></a><span id="l13.916" class="difflineplus">+    // Decide which notifications should be fired.</span>
<a href="#l13.917"></a><span id="l13.917" class="difflineplus">+    let notifications = [];</span>
<a href="#l13.918"></a><span id="l13.918" class="difflineplus">+    if (</span>
<a href="#l13.919"></a><span id="l13.919" class="difflineplus">+      this._statusType != buddy.statusType ||</span>
<a href="#l13.920"></a><span id="l13.920" class="difflineplus">+      this._availabilityDetails != buddy.availabilityDetails</span>
<a href="#l13.921"></a><span id="l13.921" class="difflineplus">+    ) {</span>
<a href="#l13.922"></a><span id="l13.922" class="difflineplus">+      notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l13.923"></a><span id="l13.923" class="difflineplus">+    }</span>
<a href="#l13.924"></a><span id="l13.924" class="difflineplus">+    if (</span>
<a href="#l13.925"></a><span id="l13.925" class="difflineplus">+      this._statusType != buddy.statusType ||</span>
<a href="#l13.926"></a><span id="l13.926" class="difflineplus">+      this._statusText != buddy.statusText</span>
<a href="#l13.927"></a><span id="l13.927" class="difflineplus">+    ) {</span>
<a href="#l13.928"></a><span id="l13.928" class="difflineplus">+      notifications.push(&quot;status-changed&quot;);</span>
<a href="#l13.929"></a><span id="l13.929" class="difflineplus">+      if (this.online &amp;&amp; buddy.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l13.930"></a><span id="l13.930" class="difflineplus">+        notifications.push(&quot;signed-off&quot;);</span>
<a href="#l13.931"></a><span id="l13.931" class="difflineplus">+      }</span>
<a href="#l13.932"></a><span id="l13.932" class="difflineplus">+      if (!this.online &amp;&amp; buddy.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l13.933"></a><span id="l13.933" class="difflineplus">+        notifications.push(&quot;signed-on&quot;);</span>
<a href="#l13.934"></a><span id="l13.934" class="difflineplus">+      }</span>
<a href="#l13.935"></a><span id="l13.935" class="difflineplus">+    }</span>
<a href="#l13.936"></a><span id="l13.936" class="difflineplus">+</span>
<a href="#l13.937"></a><span id="l13.937" class="difflineplus">+    // Actually change the stored status.</span>
<a href="#l13.938"></a><span id="l13.938" class="difflineplus">+    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l13.939"></a><span id="l13.939" class="difflineplus">+      buddy.statusType,</span>
<a href="#l13.940"></a><span id="l13.940" class="difflineplus">+      buddy.statusText,</span>
<a href="#l13.941"></a><span id="l13.941" class="difflineplus">+      buddy.availabilityDetails,</span>
<a href="#l13.942"></a><span id="l13.942" class="difflineplus">+    ];</span>
<a href="#l13.943"></a><span id="l13.943" class="difflineplus">+</span>
<a href="#l13.944"></a><span id="l13.944" class="difflineplus">+    // Fire the notifications.</span>
<a href="#l13.945"></a><span id="l13.945" class="difflineplus">+    notifications.forEach(function(aTopic) {</span>
<a href="#l13.946"></a><span id="l13.946" class="difflineplus">+      this._notifyObservers(aTopic);</span>
<a href="#l13.947"></a><span id="l13.947" class="difflineplus">+    }, this);</span>
<a href="#l13.948"></a><span id="l13.948" class="difflineplus">+  },</span>
<a href="#l13.949"></a><span id="l13.949" class="difflineplus">+  get displayName() {</span>
<a href="#l13.950"></a><span id="l13.950" class="difflineplus">+    return this._alias || this.preferredBuddy.displayName;</span>
<a href="#l13.951"></a><span id="l13.951" class="difflineplus">+  },</span>
<a href="#l13.952"></a><span id="l13.952" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l13.953"></a><span id="l13.953" class="difflineplus">+    return this.preferredBuddy.buddyIconFilename;</span>
<a href="#l13.954"></a><span id="l13.954" class="difflineplus">+  },</span>
<a href="#l13.955"></a><span id="l13.955" class="difflineplus">+  _statusType: 0,</span>
<a href="#l13.956"></a><span id="l13.956" class="difflineplus">+  get statusType() {</span>
<a href="#l13.957"></a><span id="l13.957" class="difflineplus">+    return this._statusType;</span>
<a href="#l13.958"></a><span id="l13.958" class="difflineplus">+  },</span>
<a href="#l13.959"></a><span id="l13.959" class="difflineplus">+  get online() {</span>
<a href="#l13.960"></a><span id="l13.960" class="difflineplus">+    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l13.961"></a><span id="l13.961" class="difflineplus">+  },</span>
<a href="#l13.962"></a><span id="l13.962" class="difflineplus">+  get available() {</span>
<a href="#l13.963"></a><span id="l13.963" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l13.964"></a><span id="l13.964" class="difflineplus">+  },</span>
<a href="#l13.965"></a><span id="l13.965" class="difflineplus">+  get idle() {</span>
<a href="#l13.966"></a><span id="l13.966" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l13.967"></a><span id="l13.967" class="difflineplus">+  },</span>
<a href="#l13.968"></a><span id="l13.968" class="difflineplus">+  get mobile() {</span>
<a href="#l13.969"></a><span id="l13.969" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l13.970"></a><span id="l13.970" class="difflineplus">+  },</span>
<a href="#l13.971"></a><span id="l13.971" class="difflineplus">+  _statusText: &quot;&quot;,</span>
<a href="#l13.972"></a><span id="l13.972" class="difflineplus">+  get statusText() {</span>
<a href="#l13.973"></a><span id="l13.973" class="difflineplus">+    return this._statusText;</span>
<a href="#l13.974"></a><span id="l13.974" class="difflineplus">+  },</span>
<a href="#l13.975"></a><span id="l13.975" class="difflineplus">+  _availabilityDetails: 0,</span>
<a href="#l13.976"></a><span id="l13.976" class="difflineplus">+  get availabilityDetails() {</span>
<a href="#l13.977"></a><span id="l13.977" class="difflineplus">+    return this._availabilityDetails;</span>
<a href="#l13.978"></a><span id="l13.978" class="difflineplus">+  },</span>
<a href="#l13.979"></a><span id="l13.979" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l13.980"></a><span id="l13.980" class="difflineplus">+    return this.preferredBuddy.canSendMessage;</span>
<a href="#l13.981"></a><span id="l13.981" class="difflineplus">+  },</span>
<a href="#l13.982"></a><span id="l13.982" class="difflineplus">+  // XXX should we list the buddies in the tooltip?</span>
<a href="#l13.983"></a><span id="l13.983" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l13.984"></a><span id="l13.984" class="difflineplus">+    return this.preferredBuddy.getTooltipInfo();</span>
<a href="#l13.985"></a><span id="l13.985" class="difflineplus">+  },</span>
<a href="#l13.986"></a><span id="l13.986" class="difflineplus">+  createConversation() {</span>
<a href="#l13.987"></a><span id="l13.987" class="difflineplus">+    let uiConv = Services.conversations.getUIConversationByContactId(this.id);</span>
<a href="#l13.988"></a><span id="l13.988" class="difflineplus">+    if (uiConv) {</span>
<a href="#l13.989"></a><span id="l13.989" class="difflineplus">+      return uiConv.target;</span>
<a href="#l13.990"></a><span id="l13.990" class="difflineplus">+    }</span>
<a href="#l13.991"></a><span id="l13.991" class="difflineplus">+    return this.preferredBuddy.createConversation();</span>
<a href="#l13.992"></a><span id="l13.992" class="difflineplus">+  },</span>
<a href="#l13.993"></a><span id="l13.993" class="difflineplus">+</span>
<a href="#l13.994"></a><span id="l13.994" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l13.995"></a><span id="l13.995" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l13.996"></a><span id="l13.996" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l13.997"></a><span id="l13.997" class="difflineplus">+    }</span>
<a href="#l13.998"></a><span id="l13.998" class="difflineplus">+  },</span>
<a href="#l13.999"></a><span id="l13.999" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l13.1000"></a><span id="l13.1000" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_observers&quot;)) {</span>
<a href="#l13.1001"></a><span id="l13.1001" class="difflineplus">+      return;</span>
<a href="#l13.1002"></a><span id="l13.1002" class="difflineplus">+    }</span>
<a href="#l13.1003"></a><span id="l13.1003" class="difflineplus">+</span>
<a href="#l13.1004"></a><span id="l13.1004" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l13.1005"></a><span id="l13.1005" class="difflineplus">+  },</span>
<a href="#l13.1006"></a><span id="l13.1006" class="difflineplus">+  // internal calls + calls from add-ons</span>
<a href="#l13.1007"></a><span id="l13.1007" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l13.1008"></a><span id="l13.1008" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l13.1009"></a><span id="l13.1009" class="difflineplus">+      if (&quot;observe&quot; in observer) {</span>
<a href="#l13.1010"></a><span id="l13.1010" class="difflineplus">+        // avoid failing on destructed XBL bindings...</span>
<a href="#l13.1011"></a><span id="l13.1011" class="difflineplus">+        observer.observe(aSubject, aTopic, aData);</span>
<a href="#l13.1012"></a><span id="l13.1012" class="difflineplus">+      }</span>
<a href="#l13.1013"></a><span id="l13.1013" class="difflineplus">+    }</span>
<a href="#l13.1014"></a><span id="l13.1014" class="difflineplus">+    for (let tag of this._tags) {</span>
<a href="#l13.1015"></a><span id="l13.1015" class="difflineplus">+      tag.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l13.1016"></a><span id="l13.1016" class="difflineplus">+    }</span>
<a href="#l13.1017"></a><span id="l13.1017" class="difflineplus">+    Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l13.1018"></a><span id="l13.1018" class="difflineplus">+  },</span>
<a href="#l13.1019"></a><span id="l13.1019" class="difflineplus">+  _notifyObservers(aTopic, aData) {</span>
<a href="#l13.1020"></a><span id="l13.1020" class="difflineplus">+    this.notifyObservers(this, &quot;contact-&quot; + aTopic, aData);</span>
<a href="#l13.1021"></a><span id="l13.1021" class="difflineplus">+  },</span>
<a href="#l13.1022"></a><span id="l13.1022" class="difflineplus">+</span>
<a href="#l13.1023"></a><span id="l13.1023" class="difflineplus">+  // This is called by the imIBuddy implementations.</span>
<a href="#l13.1024"></a><span id="l13.1024" class="difflineplus">+  _observe(aSubject, aTopic, aData) {</span>
<a href="#l13.1025"></a><span id="l13.1025" class="difflineplus">+    // Forward the notification.</span>
<a href="#l13.1026"></a><span id="l13.1026" class="difflineplus">+    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l13.1027"></a><span id="l13.1027" class="difflineplus">+</span>
<a href="#l13.1028"></a><span id="l13.1028" class="difflineplus">+    let isPreferredBuddy =</span>
<a href="#l13.1029"></a><span id="l13.1029" class="difflineplus">+      aSubject instanceof Buddy &amp;&amp; aSubject.id == this.preferredBuddy.id;</span>
<a href="#l13.1030"></a><span id="l13.1030" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l13.1031"></a><span id="l13.1031" class="difflineplus">+      case &quot;buddy-availability-changed&quot;:</span>
<a href="#l13.1032"></a><span id="l13.1032" class="difflineplus">+        this._updatePreferredBuddy(aSubject);</span>
<a href="#l13.1033"></a><span id="l13.1033" class="difflineplus">+        break;</span>
<a href="#l13.1034"></a><span id="l13.1034" class="difflineplus">+      case &quot;buddy-status-changed&quot;:</span>
<a href="#l13.1035"></a><span id="l13.1035" class="difflineplus">+        if (isPreferredBuddy) {</span>
<a href="#l13.1036"></a><span id="l13.1036" class="difflineplus">+          this._updateStatus();</span>
<a href="#l13.1037"></a><span id="l13.1037" class="difflineplus">+        }</span>
<a href="#l13.1038"></a><span id="l13.1038" class="difflineplus">+        break;</span>
<a href="#l13.1039"></a><span id="l13.1039" class="difflineplus">+      case &quot;buddy-display-name-changed&quot;:</span>
<a href="#l13.1040"></a><span id="l13.1040" class="difflineplus">+        if (isPreferredBuddy &amp;&amp; !this._alias) {</span>
<a href="#l13.1041"></a><span id="l13.1041" class="difflineplus">+          this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l13.1042"></a><span id="l13.1042" class="difflineplus">+        }</span>
<a href="#l13.1043"></a><span id="l13.1043" class="difflineplus">+        break;</span>
<a href="#l13.1044"></a><span id="l13.1044" class="difflineplus">+      case &quot;buddy-icon-changed&quot;:</span>
<a href="#l13.1045"></a><span id="l13.1045" class="difflineplus">+        if (isPreferredBuddy) {</span>
<a href="#l13.1046"></a><span id="l13.1046" class="difflineplus">+          this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l13.1047"></a><span id="l13.1047" class="difflineplus">+        }</span>
<a href="#l13.1048"></a><span id="l13.1048" class="difflineplus">+        break;</span>
<a href="#l13.1049"></a><span id="l13.1049" class="difflineplus">+      case &quot;buddy-added&quot;:</span>
<a href="#l13.1050"></a><span id="l13.1050" class="difflineplus">+        // Currently buddies are always added in dummy empty contacts,</span>
<a href="#l13.1051"></a><span id="l13.1051" class="difflineplus">+        // later we may want to check this._buddies.length == 1.</span>
<a href="#l13.1052"></a><span id="l13.1052" class="difflineplus">+        this._notifyObservers(&quot;added&quot;);</span>
<a href="#l13.1053"></a><span id="l13.1053" class="difflineplus">+        break;</span>
<a href="#l13.1054"></a><span id="l13.1054" class="difflineplus">+      case &quot;buddy-removed&quot;:</span>
<a href="#l13.1055"></a><span id="l13.1055" class="difflineplus">+        this._removeBuddy(aSubject);</span>
<a href="#l13.1056"></a><span id="l13.1056" class="difflineplus">+    }</span>
<a href="#l13.1057"></a><span id="l13.1057" class="difflineplus">+  },</span>
<a href="#l13.1058"></a><span id="l13.1058" class="difflineplus">+};</span>
<a href="#l13.1059"></a><span id="l13.1059" class="difflineplus">+</span>
<a href="#l13.1060"></a><span id="l13.1060" class="difflineplus">+var BuddiesById = {};</span>
<a href="#l13.1061"></a><span id="l13.1061" class="difflineplus">+function Buddy(aId, aKey, aName, aSrvAlias, aContactId) {</span>
<a href="#l13.1062"></a><span id="l13.1062" class="difflineplus">+  this._id = aId;</span>
<a href="#l13.1063"></a><span id="l13.1063" class="difflineplus">+  this._key = aKey;</span>
<a href="#l13.1064"></a><span id="l13.1064" class="difflineplus">+  this._name = aName;</span>
<a href="#l13.1065"></a><span id="l13.1065" class="difflineplus">+  if (aSrvAlias) {</span>
<a href="#l13.1066"></a><span id="l13.1066" class="difflineplus">+    this._srvAlias = aSrvAlias;</span>
<a href="#l13.1067"></a><span id="l13.1067" class="difflineplus">+  }</span>
<a href="#l13.1068"></a><span id="l13.1068" class="difflineplus">+  this._accounts = [];</span>
<a href="#l13.1069"></a><span id="l13.1069" class="difflineplus">+  this._observers = [];</span>
<a href="#l13.1070"></a><span id="l13.1070" class="difflineplus">+</span>
<a href="#l13.1071"></a><span id="l13.1071" class="difflineplus">+  if (aContactId) {</span>
<a href="#l13.1072"></a><span id="l13.1072" class="difflineplus">+    this._contact = ContactsById[aContactId];</span>
<a href="#l13.1073"></a><span id="l13.1073" class="difflineplus">+  }</span>
<a href="#l13.1074"></a><span id="l13.1074" class="difflineplus">+  // Avoid failure if aContactId was invalid.</span>
<a href="#l13.1075"></a><span id="l13.1075" class="difflineplus">+  if (!this._contact) {</span>
<a href="#l13.1076"></a><span id="l13.1076" class="difflineplus">+    this._contact = new Contact(null, null);</span>
<a href="#l13.1077"></a><span id="l13.1077" class="difflineplus">+  }</span>
<a href="#l13.1078"></a><span id="l13.1078" class="difflineplus">+</span>
<a href="#l13.1079"></a><span id="l13.1079" class="difflineplus">+  this._contact._buddies.push(this);</span>
<a href="#l13.1080"></a><span id="l13.1080" class="difflineplus">+</span>
<a href="#l13.1081"></a><span id="l13.1081" class="difflineplus">+  BuddiesById[this._id] = this;</span>
<a href="#l13.1082"></a><span id="l13.1082" class="difflineplus">+}</span>
<a href="#l13.1083"></a><span id="l13.1083" class="difflineplus">+Buddy.prototype = {</span>
<a href="#l13.1084"></a><span id="l13.1084" class="difflineplus">+  __proto__: ClassInfo(&quot;imIBuddy&quot;, &quot;Buddy&quot;),</span>
<a href="#l13.1085"></a><span id="l13.1085" class="difflineplus">+  get id() {</span>
<a href="#l13.1086"></a><span id="l13.1086" class="difflineplus">+    return this._id;</span>
<a href="#l13.1087"></a><span id="l13.1087" class="difflineplus">+  },</span>
<a href="#l13.1088"></a><span id="l13.1088" class="difflineplus">+  destroy() {</span>
<a href="#l13.1089"></a><span id="l13.1089" class="difflineplus">+    for (let ab of this._accounts) {</span>
<a href="#l13.1090"></a><span id="l13.1090" class="difflineplus">+      ab.unInit();</span>
<a href="#l13.1091"></a><span id="l13.1091" class="difflineplus">+    }</span>
<a href="#l13.1092"></a><span id="l13.1092" class="difflineplus">+    delete this._accounts;</span>
<a href="#l13.1093"></a><span id="l13.1093" class="difflineplus">+    delete this._observers;</span>
<a href="#l13.1094"></a><span id="l13.1094" class="difflineplus">+    delete this._preferredAccount;</span>
<a href="#l13.1095"></a><span id="l13.1095" class="difflineplus">+  },</span>
<a href="#l13.1096"></a><span id="l13.1096" class="difflineplus">+  get protocol() {</span>
<a href="#l13.1097"></a><span id="l13.1097" class="difflineplus">+    return this._accounts[0].account.protocol;</span>
<a href="#l13.1098"></a><span id="l13.1098" class="difflineplus">+  },</span>
<a href="#l13.1099"></a><span id="l13.1099" class="difflineplus">+  get userName() {</span>
<a href="#l13.1100"></a><span id="l13.1100" class="difflineplus">+    return this._name;</span>
<a href="#l13.1101"></a><span id="l13.1101" class="difflineplus">+  },</span>
<a href="#l13.1102"></a><span id="l13.1102" class="difflineplus">+  get normalizedName() {</span>
<a href="#l13.1103"></a><span id="l13.1103" class="difflineplus">+    return this._key;</span>
<a href="#l13.1104"></a><span id="l13.1104" class="difflineplus">+  },</span>
<a href="#l13.1105"></a><span id="l13.1105" class="difflineplus">+  _srvAlias: &quot;&quot;,</span>
<a href="#l13.1106"></a><span id="l13.1106" class="difflineplus">+  _contact: null,</span>
<a href="#l13.1107"></a><span id="l13.1107" class="difflineplus">+  get contact() {</span>
<a href="#l13.1108"></a><span id="l13.1108" class="difflineplus">+    return this._contact;</span>
<a href="#l13.1109"></a><span id="l13.1109" class="difflineplus">+  },</span>
<a href="#l13.1110"></a><span id="l13.1110" class="difflineplus">+  set contact(aContact) /* not in imIBuddy */ {</span>
<a href="#l13.1111"></a><span id="l13.1111" class="difflineplus">+    if (aContact.id == this._contact.id) {</span>
<a href="#l13.1112"></a><span id="l13.1112" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l13.1113"></a><span id="l13.1113" class="difflineplus">+    }</span>
<a href="#l13.1114"></a><span id="l13.1114" class="difflineplus">+</span>
<a href="#l13.1115"></a><span id="l13.1115" class="difflineplus">+    this._notifyObservers(&quot;moved-out-of-contact&quot;);</span>
<a href="#l13.1116"></a><span id="l13.1116" class="difflineplus">+    this._contact._removeBuddy(this);</span>
<a href="#l13.1117"></a><span id="l13.1117" class="difflineplus">+</span>
<a href="#l13.1118"></a><span id="l13.1118" class="difflineplus">+    this._contact = aContact;</span>
<a href="#l13.1119"></a><span id="l13.1119" class="difflineplus">+    this._contact._buddies.push(this);</span>
<a href="#l13.1120"></a><span id="l13.1120" class="difflineplus">+</span>
<a href="#l13.1121"></a><span id="l13.1121" class="difflineplus">+    // Ensure all the inherited tags are in the new contact.</span>
<a href="#l13.1122"></a><span id="l13.1122" class="difflineplus">+    for (let accountBuddy of this._accounts) {</span>
<a href="#l13.1123"></a><span id="l13.1123" class="difflineplus">+      this._contact.addTag(TagsById[accountBuddy.tag.id], true);</span>
<a href="#l13.1124"></a><span id="l13.1124" class="difflineplus">+    }</span>
<a href="#l13.1125"></a><span id="l13.1125" class="difflineplus">+</span>
<a href="#l13.1126"></a><span id="l13.1126" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1127"></a><span id="l13.1127" class="difflineplus">+      &quot;UPDATE buddies SET contact_id = :contactId, &quot; +</span>
<a href="#l13.1128"></a><span id="l13.1128" class="difflineplus">+        &quot;position = :position &quot; +</span>
<a href="#l13.1129"></a><span id="l13.1129" class="difflineplus">+        &quot;WHERE id = :buddyId&quot;</span>
<a href="#l13.1130"></a><span id="l13.1130" class="difflineplus">+    );</span>
<a href="#l13.1131"></a><span id="l13.1131" class="difflineplus">+    statement.params.contactId = aContact.id &gt; 0 ? aContact.id : 0;</span>
<a href="#l13.1132"></a><span id="l13.1132" class="difflineplus">+    statement.params.position = aContact._buddies.length - 1;</span>
<a href="#l13.1133"></a><span id="l13.1133" class="difflineplus">+    statement.params.buddyId = this.id;</span>
<a href="#l13.1134"></a><span id="l13.1134" class="difflineplus">+    executeAsyncThenFinalize(statement);</span>
<a href="#l13.1135"></a><span id="l13.1135" class="difflineplus">+</span>
<a href="#l13.1136"></a><span id="l13.1136" class="difflineplus">+    this._notifyObservers(&quot;moved-into-contact&quot;);</span>
<a href="#l13.1137"></a><span id="l13.1137" class="difflineplus">+    return aContact;</span>
<a href="#l13.1138"></a><span id="l13.1138" class="difflineplus">+  },</span>
<a href="#l13.1139"></a><span id="l13.1139" class="difflineplus">+  _hasAccountBuddy(aAccountId, aTagId) {</span>
<a href="#l13.1140"></a><span id="l13.1140" class="difflineplus">+    for (let ab of this._accounts) {</span>
<a href="#l13.1141"></a><span id="l13.1141" class="difflineplus">+      if (ab.account.numericId == aAccountId &amp;&amp; ab.tag.id == aTagId) {</span>
<a href="#l13.1142"></a><span id="l13.1142" class="difflineplus">+        return true;</span>
<a href="#l13.1143"></a><span id="l13.1143" class="difflineplus">+      }</span>
<a href="#l13.1144"></a><span id="l13.1144" class="difflineplus">+    }</span>
<a href="#l13.1145"></a><span id="l13.1145" class="difflineplus">+    return false;</span>
<a href="#l13.1146"></a><span id="l13.1146" class="difflineplus">+  },</span>
<a href="#l13.1147"></a><span id="l13.1147" class="difflineplus">+  getAccountBuddies() {</span>
<a href="#l13.1148"></a><span id="l13.1148" class="difflineplus">+    return this._accounts;</span>
<a href="#l13.1149"></a><span id="l13.1149" class="difflineplus">+  },</span>
<a href="#l13.1150"></a><span id="l13.1150" class="difflineplus">+</span>
<a href="#l13.1151"></a><span id="l13.1151" class="difflineplus">+  _addAccount(aAccountBuddy, aTag) {</span>
<a href="#l13.1152"></a><span id="l13.1152" class="difflineplus">+    this._accounts.push(aAccountBuddy);</span>
<a href="#l13.1153"></a><span id="l13.1153" class="difflineplus">+    let contact = this._contact;</span>
<a href="#l13.1154"></a><span id="l13.1154" class="difflineplus">+    if (!this._contact._tags.includes(aTag)) {</span>
<a href="#l13.1155"></a><span id="l13.1155" class="difflineplus">+      this._contact._tags.push(aTag);</span>
<a href="#l13.1156"></a><span id="l13.1156" class="difflineplus">+      aTag._addContact(contact);</span>
<a href="#l13.1157"></a><span id="l13.1157" class="difflineplus">+    }</span>
<a href="#l13.1158"></a><span id="l13.1158" class="difflineplus">+</span>
<a href="#l13.1159"></a><span id="l13.1159" class="difflineplus">+    if (!this._preferredAccount) {</span>
<a href="#l13.1160"></a><span id="l13.1160" class="difflineplus">+      this._preferredAccount = aAccountBuddy;</span>
<a href="#l13.1161"></a><span id="l13.1161" class="difflineplus">+    }</span>
<a href="#l13.1162"></a><span id="l13.1162" class="difflineplus">+  },</span>
<a href="#l13.1163"></a><span id="l13.1163" class="difflineplus">+  get _empty() {</span>
<a href="#l13.1164"></a><span id="l13.1164" class="difflineplus">+    return this._accounts.length == 0;</span>
<a href="#l13.1165"></a><span id="l13.1165" class="difflineplus">+  },</span>
<a href="#l13.1166"></a><span id="l13.1166" class="difflineplus">+</span>
<a href="#l13.1167"></a><span id="l13.1167" class="difflineplus">+  remove() {</span>
<a href="#l13.1168"></a><span id="l13.1168" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l13.1169"></a><span id="l13.1169" class="difflineplus">+      account.remove();</span>
<a href="#l13.1170"></a><span id="l13.1170" class="difflineplus">+    }</span>
<a href="#l13.1171"></a><span id="l13.1171" class="difflineplus">+  },</span>
<a href="#l13.1172"></a><span id="l13.1172" class="difflineplus">+</span>
<a href="#l13.1173"></a><span id="l13.1173" class="difflineplus">+  // imIStatusInfo implementation</span>
<a href="#l13.1174"></a><span id="l13.1174" class="difflineplus">+  _preferredAccount: null,</span>
<a href="#l13.1175"></a><span id="l13.1175" class="difflineplus">+  get preferredAccountBuddy() {</span>
<a href="#l13.1176"></a><span id="l13.1176" class="difflineplus">+    return this._preferredAccount;</span>
<a href="#l13.1177"></a><span id="l13.1177" class="difflineplus">+  },</span>
<a href="#l13.1178"></a><span id="l13.1178" class="difflineplus">+  _isPreferredAccount(aAccountBuddy) {</span>
<a href="#l13.1179"></a><span id="l13.1179" class="difflineplus">+    if (</span>
<a href="#l13.1180"></a><span id="l13.1180" class="difflineplus">+      aAccountBuddy.account.numericId !=</span>
<a href="#l13.1181"></a><span id="l13.1181" class="difflineplus">+      this._preferredAccount.account.numericId</span>
<a href="#l13.1182"></a><span id="l13.1182" class="difflineplus">+    ) {</span>
<a href="#l13.1183"></a><span id="l13.1183" class="difflineplus">+      return false;</span>
<a href="#l13.1184"></a><span id="l13.1184" class="difflineplus">+    }</span>
<a href="#l13.1185"></a><span id="l13.1185" class="difflineplus">+</span>
<a href="#l13.1186"></a><span id="l13.1186" class="difflineplus">+    // In case we have more than one accountBuddy for the same buddy</span>
<a href="#l13.1187"></a><span id="l13.1187" class="difflineplus">+    // and account (possible if the buddy is in several groups on the</span>
<a href="#l13.1188"></a><span id="l13.1188" class="difflineplus">+    // server), the protocol plugin may be broken and not update all</span>
<a href="#l13.1189"></a><span id="l13.1189" class="difflineplus">+    // instances, so ensure we handle the notifications on the instance</span>
<a href="#l13.1190"></a><span id="l13.1190" class="difflineplus">+    // that is currently being notified of a change:</span>
<a href="#l13.1191"></a><span id="l13.1191" class="difflineplus">+    this._preferredAccount = aAccountBuddy;</span>
<a href="#l13.1192"></a><span id="l13.1192" class="difflineplus">+</span>
<a href="#l13.1193"></a><span id="l13.1193" class="difflineplus">+    return true;</span>
<a href="#l13.1194"></a><span id="l13.1194" class="difflineplus">+  },</span>
<a href="#l13.1195"></a><span id="l13.1195" class="difflineplus">+  set preferredAccount(aAccount) {</span>
<a href="#l13.1196"></a><span id="l13.1196" class="difflineplus">+    let oldDisplayName =</span>
<a href="#l13.1197"></a><span id="l13.1197" class="difflineplus">+      this._preferredAccount &amp;&amp; this._preferredAccount.displayName;</span>
<a href="#l13.1198"></a><span id="l13.1198" class="difflineplus">+    this._preferredAccount = aAccount;</span>
<a href="#l13.1199"></a><span id="l13.1199" class="difflineplus">+    this._notifyObservers(&quot;preferred-account-changed&quot;);</span>
<a href="#l13.1200"></a><span id="l13.1200" class="difflineplus">+    if (</span>
<a href="#l13.1201"></a><span id="l13.1201" class="difflineplus">+      oldDisplayName &amp;&amp;</span>
<a href="#l13.1202"></a><span id="l13.1202" class="difflineplus">+      this._preferredAccount.displayName != oldDisplayName</span>
<a href="#l13.1203"></a><span id="l13.1203" class="difflineplus">+    ) {</span>
<a href="#l13.1204"></a><span id="l13.1204" class="difflineplus">+      this._notifyObservers(&quot;display-name-changed&quot;, oldDisplayName);</span>
<a href="#l13.1205"></a><span id="l13.1205" class="difflineplus">+    }</span>
<a href="#l13.1206"></a><span id="l13.1206" class="difflineplus">+    this._updateStatus();</span>
<a href="#l13.1207"></a><span id="l13.1207" class="difflineplus">+  },</span>
<a href="#l13.1208"></a><span id="l13.1208" class="difflineplus">+  // aAccount indicate which account's availability has changed.</span>
<a href="#l13.1209"></a><span id="l13.1209" class="difflineplus">+  _updatePreferredAccount(aAccount) {</span>
<a href="#l13.1210"></a><span id="l13.1210" class="difflineplus">+    if (aAccount) {</span>
<a href="#l13.1211"></a><span id="l13.1211" class="difflineplus">+      if (</span>
<a href="#l13.1212"></a><span id="l13.1212" class="difflineplus">+        aAccount.account.numericId == this._preferredAccount.account.numericId</span>
<a href="#l13.1213"></a><span id="l13.1213" class="difflineplus">+      ) {</span>
<a href="#l13.1214"></a><span id="l13.1214" class="difflineplus">+        // The suggested account is already preferred, check if its</span>
<a href="#l13.1215"></a><span id="l13.1215" class="difflineplus">+        // availability has changed.</span>
<a href="#l13.1216"></a><span id="l13.1216" class="difflineplus">+        if (</span>
<a href="#l13.1217"></a><span id="l13.1217" class="difflineplus">+          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l13.1218"></a><span id="l13.1218" class="difflineplus">+          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l13.1219"></a><span id="l13.1219" class="difflineplus">+            aAccount.availabilityDetails &gt;= this._availabilityDetails)</span>
<a href="#l13.1220"></a><span id="l13.1220" class="difflineplus">+        ) {</span>
<a href="#l13.1221"></a><span id="l13.1221" class="difflineplus">+          // keep the currently preferred account, only update the status.</span>
<a href="#l13.1222"></a><span id="l13.1222" class="difflineplus">+          this._updateStatus();</span>
<a href="#l13.1223"></a><span id="l13.1223" class="difflineplus">+          return;</span>
<a href="#l13.1224"></a><span id="l13.1224" class="difflineplus">+        }</span>
<a href="#l13.1225"></a><span id="l13.1225" class="difflineplus">+        // We aren't sure that the currently preferred account should</span>
<a href="#l13.1226"></a><span id="l13.1226" class="difflineplus">+        // still be preferred. Let's go through the list!</span>
<a href="#l13.1227"></a><span id="l13.1227" class="difflineplus">+      } else {</span>
<a href="#l13.1228"></a><span id="l13.1228" class="difflineplus">+        // The suggested account is not currently preferred. If it is</span>
<a href="#l13.1229"></a><span id="l13.1229" class="difflineplus">+        // more available, prefer it!</span>
<a href="#l13.1230"></a><span id="l13.1230" class="difflineplus">+        if (</span>
<a href="#l13.1231"></a><span id="l13.1231" class="difflineplus">+          aAccount.statusType &gt; this._statusType ||</span>
<a href="#l13.1232"></a><span id="l13.1232" class="difflineplus">+          (aAccount.statusType == this._statusType &amp;&amp;</span>
<a href="#l13.1233"></a><span id="l13.1233" class="difflineplus">+            aAccount.availabilityDetails &gt; this._availabilityDetails)</span>
<a href="#l13.1234"></a><span id="l13.1234" class="difflineplus">+        ) {</span>
<a href="#l13.1235"></a><span id="l13.1235" class="difflineplus">+          this.preferredAccount = aAccount;</span>
<a href="#l13.1236"></a><span id="l13.1236" class="difflineplus">+        }</span>
<a href="#l13.1237"></a><span id="l13.1237" class="difflineplus">+        return;</span>
<a href="#l13.1238"></a><span id="l13.1238" class="difflineplus">+      }</span>
<a href="#l13.1239"></a><span id="l13.1239" class="difflineplus">+    }</span>
<a href="#l13.1240"></a><span id="l13.1240" class="difflineplus">+</span>
<a href="#l13.1241"></a><span id="l13.1241" class="difflineplus">+    let preferred;</span>
<a href="#l13.1242"></a><span id="l13.1242" class="difflineplus">+    // TODO take into account the order of the account-manager list.</span>
<a href="#l13.1243"></a><span id="l13.1243" class="difflineplus">+    for (let account of this._accounts) {</span>
<a href="#l13.1244"></a><span id="l13.1244" class="difflineplus">+      if (</span>
<a href="#l13.1245"></a><span id="l13.1245" class="difflineplus">+        !preferred ||</span>
<a href="#l13.1246"></a><span id="l13.1246" class="difflineplus">+        preferred.statusType &lt; account.statusType ||</span>
<a href="#l13.1247"></a><span id="l13.1247" class="difflineplus">+        (preferred.statusType == account.statusType &amp;&amp;</span>
<a href="#l13.1248"></a><span id="l13.1248" class="difflineplus">+          preferred.availabilityDetails &lt; account.availabilityDetails)</span>
<a href="#l13.1249"></a><span id="l13.1249" class="difflineplus">+      ) {</span>
<a href="#l13.1250"></a><span id="l13.1250" class="difflineplus">+        preferred = account;</span>
<a href="#l13.1251"></a><span id="l13.1251" class="difflineplus">+      }</span>
<a href="#l13.1252"></a><span id="l13.1252" class="difflineplus">+    }</span>
<a href="#l13.1253"></a><span id="l13.1253" class="difflineplus">+    if (!this._preferredAccount) {</span>
<a href="#l13.1254"></a><span id="l13.1254" class="difflineplus">+      if (preferred) {</span>
<a href="#l13.1255"></a><span id="l13.1255" class="difflineplus">+        this.preferredAccount = preferred;</span>
<a href="#l13.1256"></a><span id="l13.1256" class="difflineplus">+      }</span>
<a href="#l13.1257"></a><span id="l13.1257" class="difflineplus">+      return;</span>
<a href="#l13.1258"></a><span id="l13.1258" class="difflineplus">+    }</span>
<a href="#l13.1259"></a><span id="l13.1259" class="difflineplus">+    if (</span>
<a href="#l13.1260"></a><span id="l13.1260" class="difflineplus">+      preferred.account.numericId != this._preferredAccount.account.numericId</span>
<a href="#l13.1261"></a><span id="l13.1261" class="difflineplus">+    ) {</span>
<a href="#l13.1262"></a><span id="l13.1262" class="difflineplus">+      this.preferredAccount = preferred;</span>
<a href="#l13.1263"></a><span id="l13.1263" class="difflineplus">+    } else {</span>
<a href="#l13.1264"></a><span id="l13.1264" class="difflineplus">+      this._updateStatus();</span>
<a href="#l13.1265"></a><span id="l13.1265" class="difflineplus">+    }</span>
<a href="#l13.1266"></a><span id="l13.1266" class="difflineplus">+  },</span>
<a href="#l13.1267"></a><span id="l13.1267" class="difflineplus">+  _updateStatus() {</span>
<a href="#l13.1268"></a><span id="l13.1268" class="difflineplus">+    let account = this._preferredAccount; // for convenience</span>
<a href="#l13.1269"></a><span id="l13.1269" class="difflineplus">+</span>
<a href="#l13.1270"></a><span id="l13.1270" class="difflineplus">+    // Decide which notifications should be fired.</span>
<a href="#l13.1271"></a><span id="l13.1271" class="difflineplus">+    let notifications = [];</span>
<a href="#l13.1272"></a><span id="l13.1272" class="difflineplus">+    if (</span>
<a href="#l13.1273"></a><span id="l13.1273" class="difflineplus">+      this._statusType != account.statusType ||</span>
<a href="#l13.1274"></a><span id="l13.1274" class="difflineplus">+      this._availabilityDetails != account.availabilityDetails</span>
<a href="#l13.1275"></a><span id="l13.1275" class="difflineplus">+    ) {</span>
<a href="#l13.1276"></a><span id="l13.1276" class="difflineplus">+      notifications.push(&quot;availability-changed&quot;);</span>
<a href="#l13.1277"></a><span id="l13.1277" class="difflineplus">+    }</span>
<a href="#l13.1278"></a><span id="l13.1278" class="difflineplus">+    if (</span>
<a href="#l13.1279"></a><span id="l13.1279" class="difflineplus">+      this._statusType != account.statusType ||</span>
<a href="#l13.1280"></a><span id="l13.1280" class="difflineplus">+      this._statusText != account.statusText</span>
<a href="#l13.1281"></a><span id="l13.1281" class="difflineplus">+    ) {</span>
<a href="#l13.1282"></a><span id="l13.1282" class="difflineplus">+      notifications.push(&quot;status-changed&quot;);</span>
<a href="#l13.1283"></a><span id="l13.1283" class="difflineplus">+      if (</span>
<a href="#l13.1284"></a><span id="l13.1284" class="difflineplus">+        this.online &amp;&amp;</span>
<a href="#l13.1285"></a><span id="l13.1285" class="difflineplus">+        account.statusType &lt;= Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l13.1286"></a><span id="l13.1286" class="difflineplus">+      ) {</span>
<a href="#l13.1287"></a><span id="l13.1287" class="difflineplus">+        notifications.push(&quot;signed-off&quot;);</span>
<a href="#l13.1288"></a><span id="l13.1288" class="difflineplus">+      }</span>
<a href="#l13.1289"></a><span id="l13.1289" class="difflineplus">+      if (</span>
<a href="#l13.1290"></a><span id="l13.1290" class="difflineplus">+        !this.online &amp;&amp;</span>
<a href="#l13.1291"></a><span id="l13.1291" class="difflineplus">+        account.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE</span>
<a href="#l13.1292"></a><span id="l13.1292" class="difflineplus">+      ) {</span>
<a href="#l13.1293"></a><span id="l13.1293" class="difflineplus">+        notifications.push(&quot;signed-on&quot;);</span>
<a href="#l13.1294"></a><span id="l13.1294" class="difflineplus">+      }</span>
<a href="#l13.1295"></a><span id="l13.1295" class="difflineplus">+    }</span>
<a href="#l13.1296"></a><span id="l13.1296" class="difflineplus">+</span>
<a href="#l13.1297"></a><span id="l13.1297" class="difflineplus">+    // Actually change the stored status.</span>
<a href="#l13.1298"></a><span id="l13.1298" class="difflineplus">+    [this._statusType, this._statusText, this._availabilityDetails] = [</span>
<a href="#l13.1299"></a><span id="l13.1299" class="difflineplus">+      account.statusType,</span>
<a href="#l13.1300"></a><span id="l13.1300" class="difflineplus">+      account.statusText,</span>
<a href="#l13.1301"></a><span id="l13.1301" class="difflineplus">+      account.availabilityDetails,</span>
<a href="#l13.1302"></a><span id="l13.1302" class="difflineplus">+    ];</span>
<a href="#l13.1303"></a><span id="l13.1303" class="difflineplus">+</span>
<a href="#l13.1304"></a><span id="l13.1304" class="difflineplus">+    // Fire the notifications.</span>
<a href="#l13.1305"></a><span id="l13.1305" class="difflineplus">+    notifications.forEach(function(aTopic) {</span>
<a href="#l13.1306"></a><span id="l13.1306" class="difflineplus">+      this._notifyObservers(aTopic);</span>
<a href="#l13.1307"></a><span id="l13.1307" class="difflineplus">+    }, this);</span>
<a href="#l13.1308"></a><span id="l13.1308" class="difflineplus">+  },</span>
<a href="#l13.1309"></a><span id="l13.1309" class="difflineplus">+  get displayName() {</span>
<a href="#l13.1310"></a><span id="l13.1310" class="difflineplus">+    return (</span>
<a href="#l13.1311"></a><span id="l13.1311" class="difflineplus">+      (this._preferredAccount &amp;&amp; this._preferredAccount.displayName) ||</span>
<a href="#l13.1312"></a><span id="l13.1312" class="difflineplus">+      this._srvAlias ||</span>
<a href="#l13.1313"></a><span id="l13.1313" class="difflineplus">+      this._name</span>
<a href="#l13.1314"></a><span id="l13.1314" class="difflineplus">+    );</span>
<a href="#l13.1315"></a><span id="l13.1315" class="difflineplus">+  },</span>
<a href="#l13.1316"></a><span id="l13.1316" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l13.1317"></a><span id="l13.1317" class="difflineplus">+    return this._preferredAccount.buddyIconFilename;</span>
<a href="#l13.1318"></a><span id="l13.1318" class="difflineplus">+  },</span>
<a href="#l13.1319"></a><span id="l13.1319" class="difflineplus">+  _statusType: 0,</span>
<a href="#l13.1320"></a><span id="l13.1320" class="difflineplus">+  get statusType() {</span>
<a href="#l13.1321"></a><span id="l13.1321" class="difflineplus">+    return this._statusType;</span>
<a href="#l13.1322"></a><span id="l13.1322" class="difflineplus">+  },</span>
<a href="#l13.1323"></a><span id="l13.1323" class="difflineplus">+  get online() {</span>
<a href="#l13.1324"></a><span id="l13.1324" class="difflineplus">+    return this.statusType &gt; Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l13.1325"></a><span id="l13.1325" class="difflineplus">+  },</span>
<a href="#l13.1326"></a><span id="l13.1326" class="difflineplus">+  get available() {</span>
<a href="#l13.1327"></a><span id="l13.1327" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l13.1328"></a><span id="l13.1328" class="difflineplus">+  },</span>
<a href="#l13.1329"></a><span id="l13.1329" class="difflineplus">+  get idle() {</span>
<a href="#l13.1330"></a><span id="l13.1330" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l13.1331"></a><span id="l13.1331" class="difflineplus">+  },</span>
<a href="#l13.1332"></a><span id="l13.1332" class="difflineplus">+  get mobile() {</span>
<a href="#l13.1333"></a><span id="l13.1333" class="difflineplus">+    return this.statusType == Ci.imIStatusInfo.STATUS_MOBILE;</span>
<a href="#l13.1334"></a><span id="l13.1334" class="difflineplus">+  },</span>
<a href="#l13.1335"></a><span id="l13.1335" class="difflineplus">+  _statusText: &quot;&quot;,</span>
<a href="#l13.1336"></a><span id="l13.1336" class="difflineplus">+  get statusText() {</span>
<a href="#l13.1337"></a><span id="l13.1337" class="difflineplus">+    return this._statusText;</span>
<a href="#l13.1338"></a><span id="l13.1338" class="difflineplus">+  },</span>
<a href="#l13.1339"></a><span id="l13.1339" class="difflineplus">+  _availabilityDetails: 0,</span>
<a href="#l13.1340"></a><span id="l13.1340" class="difflineplus">+  get availabilityDetails() {</span>
<a href="#l13.1341"></a><span id="l13.1341" class="difflineplus">+    return this._availabilityDetails;</span>
<a href="#l13.1342"></a><span id="l13.1342" class="difflineplus">+  },</span>
<a href="#l13.1343"></a><span id="l13.1343" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l13.1344"></a><span id="l13.1344" class="difflineplus">+    return this._preferredAccount.canSendMessage;</span>
<a href="#l13.1345"></a><span id="l13.1345" class="difflineplus">+  },</span>
<a href="#l13.1346"></a><span id="l13.1346" class="difflineplus">+  // XXX should we list the accounts in the tooltip?</span>
<a href="#l13.1347"></a><span id="l13.1347" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l13.1348"></a><span id="l13.1348" class="difflineplus">+    return this._preferredAccount.getTooltipInfo();</span>
<a href="#l13.1349"></a><span id="l13.1349" class="difflineplus">+  },</span>
<a href="#l13.1350"></a><span id="l13.1350" class="difflineplus">+  createConversation() {</span>
<a href="#l13.1351"></a><span id="l13.1351" class="difflineplus">+    return this._preferredAccount.createConversation();</span>
<a href="#l13.1352"></a><span id="l13.1352" class="difflineplus">+  },</span>
<a href="#l13.1353"></a><span id="l13.1353" class="difflineplus">+</span>
<a href="#l13.1354"></a><span id="l13.1354" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l13.1355"></a><span id="l13.1355" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l13.1356"></a><span id="l13.1356" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l13.1357"></a><span id="l13.1357" class="difflineplus">+    }</span>
<a href="#l13.1358"></a><span id="l13.1358" class="difflineplus">+  },</span>
<a href="#l13.1359"></a><span id="l13.1359" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l13.1360"></a><span id="l13.1360" class="difflineplus">+    if (!this._observers) {</span>
<a href="#l13.1361"></a><span id="l13.1361" class="difflineplus">+      return;</span>
<a href="#l13.1362"></a><span id="l13.1362" class="difflineplus">+    }</span>
<a href="#l13.1363"></a><span id="l13.1363" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l13.1364"></a><span id="l13.1364" class="difflineplus">+  },</span>
<a href="#l13.1365"></a><span id="l13.1365" class="difflineplus">+  // internal calls + calls from add-ons</span>
<a href="#l13.1366"></a><span id="l13.1366" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l13.1367"></a><span id="l13.1367" class="difflineplus">+    try {</span>
<a href="#l13.1368"></a><span id="l13.1368" class="difflineplus">+      for (let observer of this._observers) {</span>
<a href="#l13.1369"></a><span id="l13.1369" class="difflineplus">+        observer.observe(aSubject, aTopic, aData);</span>
<a href="#l13.1370"></a><span id="l13.1370" class="difflineplus">+      }</span>
<a href="#l13.1371"></a><span id="l13.1371" class="difflineplus">+      this._contact._observe(aSubject, aTopic, aData);</span>
<a href="#l13.1372"></a><span id="l13.1372" class="difflineplus">+    } catch (e) {</span>
<a href="#l13.1373"></a><span id="l13.1373" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l13.1374"></a><span id="l13.1374" class="difflineplus">+    }</span>
<a href="#l13.1375"></a><span id="l13.1375" class="difflineplus">+  },</span>
<a href="#l13.1376"></a><span id="l13.1376" class="difflineplus">+  _notifyObservers(aTopic, aData) {</span>
<a href="#l13.1377"></a><span id="l13.1377" class="difflineplus">+    this.notifyObservers(this, &quot;buddy-&quot; + aTopic, aData);</span>
<a href="#l13.1378"></a><span id="l13.1378" class="difflineplus">+  },</span>
<a href="#l13.1379"></a><span id="l13.1379" class="difflineplus">+</span>
<a href="#l13.1380"></a><span id="l13.1380" class="difflineplus">+  // This is called by the prplIAccountBuddy implementations.</span>
<a href="#l13.1381"></a><span id="l13.1381" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l13.1382"></a><span id="l13.1382" class="difflineplus">+    // Forward the notification.</span>
<a href="#l13.1383"></a><span id="l13.1383" class="difflineplus">+    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l13.1384"></a><span id="l13.1384" class="difflineplus">+</span>
<a href="#l13.1385"></a><span id="l13.1385" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l13.1386"></a><span id="l13.1386" class="difflineplus">+      case &quot;account-buddy-availability-changed&quot;:</span>
<a href="#l13.1387"></a><span id="l13.1387" class="difflineplus">+        this._updatePreferredAccount(aSubject);</span>
<a href="#l13.1388"></a><span id="l13.1388" class="difflineplus">+        break;</span>
<a href="#l13.1389"></a><span id="l13.1389" class="difflineplus">+      case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l13.1390"></a><span id="l13.1390" class="difflineplus">+        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l13.1391"></a><span id="l13.1391" class="difflineplus">+          this._updateStatus();</span>
<a href="#l13.1392"></a><span id="l13.1392" class="difflineplus">+        }</span>
<a href="#l13.1393"></a><span id="l13.1393" class="difflineplus">+        break;</span>
<a href="#l13.1394"></a><span id="l13.1394" class="difflineplus">+      case &quot;account-buddy-display-name-changed&quot;:</span>
<a href="#l13.1395"></a><span id="l13.1395" class="difflineplus">+        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l13.1396"></a><span id="l13.1396" class="difflineplus">+          this._srvAlias =</span>
<a href="#l13.1397"></a><span id="l13.1397" class="difflineplus">+            this.displayName != this.userName ? this.displayName : &quot;&quot;;</span>
<a href="#l13.1398"></a><span id="l13.1398" class="difflineplus">+          let statement = DBConn.createStatement(</span>
<a href="#l13.1399"></a><span id="l13.1399" class="difflineplus">+            &quot;UPDATE buddies SET srv_alias = :srvAlias WHERE id = :buddyId&quot;</span>
<a href="#l13.1400"></a><span id="l13.1400" class="difflineplus">+          );</span>
<a href="#l13.1401"></a><span id="l13.1401" class="difflineplus">+          statement.params.buddyId = this.id;</span>
<a href="#l13.1402"></a><span id="l13.1402" class="difflineplus">+          statement.params.srvAlias = this._srvAlias;</span>
<a href="#l13.1403"></a><span id="l13.1403" class="difflineplus">+          executeAsyncThenFinalize(statement);</span>
<a href="#l13.1404"></a><span id="l13.1404" class="difflineplus">+          this._notifyObservers(&quot;display-name-changed&quot;, aData);</span>
<a href="#l13.1405"></a><span id="l13.1405" class="difflineplus">+        }</span>
<a href="#l13.1406"></a><span id="l13.1406" class="difflineplus">+        break;</span>
<a href="#l13.1407"></a><span id="l13.1407" class="difflineplus">+      case &quot;account-buddy-icon-changed&quot;:</span>
<a href="#l13.1408"></a><span id="l13.1408" class="difflineplus">+        if (this._isPreferredAccount(aSubject)) {</span>
<a href="#l13.1409"></a><span id="l13.1409" class="difflineplus">+          this._notifyObservers(&quot;icon-changed&quot;);</span>
<a href="#l13.1410"></a><span id="l13.1410" class="difflineplus">+        }</span>
<a href="#l13.1411"></a><span id="l13.1411" class="difflineplus">+        break;</span>
<a href="#l13.1412"></a><span id="l13.1412" class="difflineplus">+      case &quot;account-buddy-added&quot;:</span>
<a href="#l13.1413"></a><span id="l13.1413" class="difflineplus">+        if (this._accounts.length == 0) {</span>
<a href="#l13.1414"></a><span id="l13.1414" class="difflineplus">+          // Add the new account in the empty buddy instance.</span>
<a href="#l13.1415"></a><span id="l13.1415" class="difflineplus">+          // The TagsById hack is to bypass the xpconnect wrapper.</span>
<a href="#l13.1416"></a><span id="l13.1416" class="difflineplus">+          this._addAccount(aSubject, TagsById[aSubject.tag.id]);</span>
<a href="#l13.1417"></a><span id="l13.1417" class="difflineplus">+          this._updateStatus();</span>
<a href="#l13.1418"></a><span id="l13.1418" class="difflineplus">+          this._notifyObservers(&quot;added&quot;);</span>
<a href="#l13.1419"></a><span id="l13.1419" class="difflineplus">+        } else {</span>
<a href="#l13.1420"></a><span id="l13.1420" class="difflineplus">+          this._accounts.push(aSubject);</span>
<a href="#l13.1421"></a><span id="l13.1421" class="difflineplus">+          this.contact._moved(null, aSubject.tag);</span>
<a href="#l13.1422"></a><span id="l13.1422" class="difflineplus">+          this._updatePreferredAccount(aSubject);</span>
<a href="#l13.1423"></a><span id="l13.1423" class="difflineplus">+        }</span>
<a href="#l13.1424"></a><span id="l13.1424" class="difflineplus">+        break;</span>
<a href="#l13.1425"></a><span id="l13.1425" class="difflineplus">+      case &quot;account-buddy-removed&quot;:</span>
<a href="#l13.1426"></a><span id="l13.1426" class="difflineplus">+        if (this._accounts.length == 1) {</span>
<a href="#l13.1427"></a><span id="l13.1427" class="difflineplus">+          let statement = DBConn.createStatement(</span>
<a href="#l13.1428"></a><span id="l13.1428" class="difflineplus">+            &quot;DELETE FROM buddies WHERE id = :id&quot;</span>
<a href="#l13.1429"></a><span id="l13.1429" class="difflineplus">+          );</span>
<a href="#l13.1430"></a><span id="l13.1430" class="difflineplus">+          try {</span>
<a href="#l13.1431"></a><span id="l13.1431" class="difflineplus">+            statement.params.id = this.id;</span>
<a href="#l13.1432"></a><span id="l13.1432" class="difflineplus">+            statement.execute();</span>
<a href="#l13.1433"></a><span id="l13.1433" class="difflineplus">+          } finally {</span>
<a href="#l13.1434"></a><span id="l13.1434" class="difflineplus">+            statement.finalize();</span>
<a href="#l13.1435"></a><span id="l13.1435" class="difflineplus">+          }</span>
<a href="#l13.1436"></a><span id="l13.1436" class="difflineplus">+          this._notifyObservers(&quot;removed&quot;);</span>
<a href="#l13.1437"></a><span id="l13.1437" class="difflineplus">+</span>
<a href="#l13.1438"></a><span id="l13.1438" class="difflineplus">+          delete BuddiesById[this._id];</span>
<a href="#l13.1439"></a><span id="l13.1439" class="difflineplus">+          this.destroy();</span>
<a href="#l13.1440"></a><span id="l13.1440" class="difflineplus">+        } else {</span>
<a href="#l13.1441"></a><span id="l13.1441" class="difflineplus">+          this._accounts = this._accounts.filter(function(ab) {</span>
<a href="#l13.1442"></a><span id="l13.1442" class="difflineplus">+            return (</span>
<a href="#l13.1443"></a><span id="l13.1443" class="difflineplus">+              ab.account.numericId != aSubject.account.numericId ||</span>
<a href="#l13.1444"></a><span id="l13.1444" class="difflineplus">+              ab.tag.id != aSubject.tag.id</span>
<a href="#l13.1445"></a><span id="l13.1445" class="difflineplus">+            );</span>
<a href="#l13.1446"></a><span id="l13.1446" class="difflineplus">+          });</span>
<a href="#l13.1447"></a><span id="l13.1447" class="difflineplus">+          if (</span>
<a href="#l13.1448"></a><span id="l13.1448" class="difflineplus">+            this._preferredAccount.account.numericId ==</span>
<a href="#l13.1449"></a><span id="l13.1449" class="difflineplus">+              aSubject.account.numericId &amp;&amp;</span>
<a href="#l13.1450"></a><span id="l13.1450" class="difflineplus">+            this._preferredAccount.tag.id == aSubject.tag.id</span>
<a href="#l13.1451"></a><span id="l13.1451" class="difflineplus">+          ) {</span>
<a href="#l13.1452"></a><span id="l13.1452" class="difflineplus">+            this._preferredAccount = null;</span>
<a href="#l13.1453"></a><span id="l13.1453" class="difflineplus">+            this._updatePreferredAccount();</span>
<a href="#l13.1454"></a><span id="l13.1454" class="difflineplus">+          }</span>
<a href="#l13.1455"></a><span id="l13.1455" class="difflineplus">+          this.contact._moved(aSubject.tag);</span>
<a href="#l13.1456"></a><span id="l13.1456" class="difflineplus">+        }</span>
<a href="#l13.1457"></a><span id="l13.1457" class="difflineplus">+        break;</span>
<a href="#l13.1458"></a><span id="l13.1458" class="difflineplus">+    }</span>
<a href="#l13.1459"></a><span id="l13.1459" class="difflineplus">+  },</span>
<a href="#l13.1460"></a><span id="l13.1460" class="difflineplus">+};</span>
<a href="#l13.1461"></a><span id="l13.1461" class="difflineplus">+</span>
<a href="#l13.1462"></a><span id="l13.1462" class="difflineplus">+function ContactsService() {}</span>
<a href="#l13.1463"></a><span id="l13.1463" class="difflineplus">+ContactsService.prototype = {</span>
<a href="#l13.1464"></a><span id="l13.1464" class="difflineplus">+  initContacts() {</span>
<a href="#l13.1465"></a><span id="l13.1465" class="difflineplus">+    let statement = DBConn.createStatement(&quot;SELECT id, name FROM tags&quot;);</span>
<a href="#l13.1466"></a><span id="l13.1466" class="difflineplus">+    try {</span>
<a href="#l13.1467"></a><span id="l13.1467" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l13.1468"></a><span id="l13.1468" class="difflineplus">+        Tags.push(new Tag(statement.getInt32(0), statement.getUTF8String(1)));</span>
<a href="#l13.1469"></a><span id="l13.1469" class="difflineplus">+      }</span>
<a href="#l13.1470"></a><span id="l13.1470" class="difflineplus">+    } finally {</span>
<a href="#l13.1471"></a><span id="l13.1471" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1472"></a><span id="l13.1472" class="difflineplus">+    }</span>
<a href="#l13.1473"></a><span id="l13.1473" class="difflineplus">+</span>
<a href="#l13.1474"></a><span id="l13.1474" class="difflineplus">+    statement = DBConn.createStatement(&quot;SELECT id, alias FROM contacts&quot;);</span>
<a href="#l13.1475"></a><span id="l13.1475" class="difflineplus">+    try {</span>
<a href="#l13.1476"></a><span id="l13.1476" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l13.1477"></a><span id="l13.1477" class="difflineplus">+        new Contact(statement.getInt32(0), statement.getUTF8String(1));</span>
<a href="#l13.1478"></a><span id="l13.1478" class="difflineplus">+      }</span>
<a href="#l13.1479"></a><span id="l13.1479" class="difflineplus">+    } finally {</span>
<a href="#l13.1480"></a><span id="l13.1480" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1481"></a><span id="l13.1481" class="difflineplus">+    }</span>
<a href="#l13.1482"></a><span id="l13.1482" class="difflineplus">+</span>
<a href="#l13.1483"></a><span id="l13.1483" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.1484"></a><span id="l13.1484" class="difflineplus">+      &quot;SELECT contact_id, tag_id FROM contact_tag&quot;</span>
<a href="#l13.1485"></a><span id="l13.1485" class="difflineplus">+    );</span>
<a href="#l13.1486"></a><span id="l13.1486" class="difflineplus">+    try {</span>
<a href="#l13.1487"></a><span id="l13.1487" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l13.1488"></a><span id="l13.1488" class="difflineplus">+        let contact = ContactsById[statement.getInt32(0)];</span>
<a href="#l13.1489"></a><span id="l13.1489" class="difflineplus">+        let tag = TagsById[statement.getInt32(1)];</span>
<a href="#l13.1490"></a><span id="l13.1490" class="difflineplus">+        contact._tags.push(tag);</span>
<a href="#l13.1491"></a><span id="l13.1491" class="difflineplus">+        tag._addContact(contact);</span>
<a href="#l13.1492"></a><span id="l13.1492" class="difflineplus">+      }</span>
<a href="#l13.1493"></a><span id="l13.1493" class="difflineplus">+    } finally {</span>
<a href="#l13.1494"></a><span id="l13.1494" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1495"></a><span id="l13.1495" class="difflineplus">+    }</span>
<a href="#l13.1496"></a><span id="l13.1496" class="difflineplus">+</span>
<a href="#l13.1497"></a><span id="l13.1497" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.1498"></a><span id="l13.1498" class="difflineplus">+      &quot;SELECT id, key, name, srv_alias, contact_id FROM buddies ORDER BY position&quot;</span>
<a href="#l13.1499"></a><span id="l13.1499" class="difflineplus">+    );</span>
<a href="#l13.1500"></a><span id="l13.1500" class="difflineplus">+    try {</span>
<a href="#l13.1501"></a><span id="l13.1501" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l13.1502"></a><span id="l13.1502" class="difflineplus">+        new Buddy(</span>
<a href="#l13.1503"></a><span id="l13.1503" class="difflineplus">+          statement.getInt32(0),</span>
<a href="#l13.1504"></a><span id="l13.1504" class="difflineplus">+          statement.getUTF8String(1),</span>
<a href="#l13.1505"></a><span id="l13.1505" class="difflineplus">+          statement.getUTF8String(2),</span>
<a href="#l13.1506"></a><span id="l13.1506" class="difflineplus">+          statement.getUTF8String(3),</span>
<a href="#l13.1507"></a><span id="l13.1507" class="difflineplus">+          statement.getInt32(4)</span>
<a href="#l13.1508"></a><span id="l13.1508" class="difflineplus">+        );</span>
<a href="#l13.1509"></a><span id="l13.1509" class="difflineplus">+        // FIXME is there a way to enforce that all AccountBuddies of a Buddy have the same protocol?</span>
<a href="#l13.1510"></a><span id="l13.1510" class="difflineplus">+      }</span>
<a href="#l13.1511"></a><span id="l13.1511" class="difflineplus">+    } finally {</span>
<a href="#l13.1512"></a><span id="l13.1512" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1513"></a><span id="l13.1513" class="difflineplus">+    }</span>
<a href="#l13.1514"></a><span id="l13.1514" class="difflineplus">+</span>
<a href="#l13.1515"></a><span id="l13.1515" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.1516"></a><span id="l13.1516" class="difflineplus">+      &quot;SELECT account_id, buddy_id, tag_id FROM account_buddy&quot;</span>
<a href="#l13.1517"></a><span id="l13.1517" class="difflineplus">+    );</span>
<a href="#l13.1518"></a><span id="l13.1518" class="difflineplus">+    try {</span>
<a href="#l13.1519"></a><span id="l13.1519" class="difflineplus">+      while (statement.executeStep()) {</span>
<a href="#l13.1520"></a><span id="l13.1520" class="difflineplus">+        let accountId = statement.getInt32(0);</span>
<a href="#l13.1521"></a><span id="l13.1521" class="difflineplus">+        let buddyId = statement.getInt32(1);</span>
<a href="#l13.1522"></a><span id="l13.1522" class="difflineplus">+        let tagId = statement.getInt32(2);</span>
<a href="#l13.1523"></a><span id="l13.1523" class="difflineplus">+</span>
<a href="#l13.1524"></a><span id="l13.1524" class="difflineplus">+        if (!BuddiesById.hasOwnProperty(buddyId)) {</span>
<a href="#l13.1525"></a><span id="l13.1525" class="difflineplus">+          Cu.reportError(</span>
<a href="#l13.1526"></a><span id="l13.1526" class="difflineplus">+            &quot;Corrupted database: account_buddy entry for account &quot; +</span>
<a href="#l13.1527"></a><span id="l13.1527" class="difflineplus">+              accountId +</span>
<a href="#l13.1528"></a><span id="l13.1528" class="difflineplus">+              &quot; and tag &quot; +</span>
<a href="#l13.1529"></a><span id="l13.1529" class="difflineplus">+              tagId +</span>
<a href="#l13.1530"></a><span id="l13.1530" class="difflineplus">+              &quot; references unknown buddy with id &quot; +</span>
<a href="#l13.1531"></a><span id="l13.1531" class="difflineplus">+              buddyId</span>
<a href="#l13.1532"></a><span id="l13.1532" class="difflineplus">+          );</span>
<a href="#l13.1533"></a><span id="l13.1533" class="difflineplus">+          continue;</span>
<a href="#l13.1534"></a><span id="l13.1534" class="difflineplus">+        }</span>
<a href="#l13.1535"></a><span id="l13.1535" class="difflineplus">+</span>
<a href="#l13.1536"></a><span id="l13.1536" class="difflineplus">+        let buddy = BuddiesById[buddyId];</span>
<a href="#l13.1537"></a><span id="l13.1537" class="difflineplus">+        if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l13.1538"></a><span id="l13.1538" class="difflineplus">+          Cu.reportError(</span>
<a href="#l13.1539"></a><span id="l13.1539" class="difflineplus">+            &quot;Corrupted database: duplicated account_buddy entry: &quot; +</span>
<a href="#l13.1540"></a><span id="l13.1540" class="difflineplus">+              &quot;account_id = &quot; +</span>
<a href="#l13.1541"></a><span id="l13.1541" class="difflineplus">+              accountId +</span>
<a href="#l13.1542"></a><span id="l13.1542" class="difflineplus">+              &quot;, buddy_id = &quot; +</span>
<a href="#l13.1543"></a><span id="l13.1543" class="difflineplus">+              buddyId +</span>
<a href="#l13.1544"></a><span id="l13.1544" class="difflineplus">+              &quot;, tag_id = &quot; +</span>
<a href="#l13.1545"></a><span id="l13.1545" class="difflineplus">+              tagId</span>
<a href="#l13.1546"></a><span id="l13.1546" class="difflineplus">+          );</span>
<a href="#l13.1547"></a><span id="l13.1547" class="difflineplus">+          continue;</span>
<a href="#l13.1548"></a><span id="l13.1548" class="difflineplus">+        }</span>
<a href="#l13.1549"></a><span id="l13.1549" class="difflineplus">+</span>
<a href="#l13.1550"></a><span id="l13.1550" class="difflineplus">+        let account = Services.accounts.getAccountByNumericId(accountId);</span>
<a href="#l13.1551"></a><span id="l13.1551" class="difflineplus">+        let tag = TagsById[tagId];</span>
<a href="#l13.1552"></a><span id="l13.1552" class="difflineplus">+        try {</span>
<a href="#l13.1553"></a><span id="l13.1553" class="difflineplus">+          buddy._addAccount(account.loadBuddy(buddy, tag), tag);</span>
<a href="#l13.1554"></a><span id="l13.1554" class="difflineplus">+        } catch (e) {</span>
<a href="#l13.1555"></a><span id="l13.1555" class="difflineplus">+          Cu.reportError(e);</span>
<a href="#l13.1556"></a><span id="l13.1556" class="difflineplus">+          dump(e + &quot;\n&quot;);</span>
<a href="#l13.1557"></a><span id="l13.1557" class="difflineplus">+        }</span>
<a href="#l13.1558"></a><span id="l13.1558" class="difflineplus">+      }</span>
<a href="#l13.1559"></a><span id="l13.1559" class="difflineplus">+    } finally {</span>
<a href="#l13.1560"></a><span id="l13.1560" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1561"></a><span id="l13.1561" class="difflineplus">+    }</span>
<a href="#l13.1562"></a><span id="l13.1562" class="difflineplus">+    otherContactsTag._initHiddenTags();</span>
<a href="#l13.1563"></a><span id="l13.1563" class="difflineplus">+  },</span>
<a href="#l13.1564"></a><span id="l13.1564" class="difflineplus">+  unInitContacts() {</span>
<a href="#l13.1565"></a><span id="l13.1565" class="difflineplus">+    Tags = [];</span>
<a href="#l13.1566"></a><span id="l13.1566" class="difflineplus">+    TagsById = {};</span>
<a href="#l13.1567"></a><span id="l13.1567" class="difflineplus">+    // Avoid shutdown leaks caused by references to native components</span>
<a href="#l13.1568"></a><span id="l13.1568" class="difflineplus">+    // implementing prplIAccountBuddy.</span>
<a href="#l13.1569"></a><span id="l13.1569" class="difflineplus">+    for (let buddyId in BuddiesById) {</span>
<a href="#l13.1570"></a><span id="l13.1570" class="difflineplus">+      let buddy = BuddiesById[buddyId];</span>
<a href="#l13.1571"></a><span id="l13.1571" class="difflineplus">+      buddy.destroy();</span>
<a href="#l13.1572"></a><span id="l13.1572" class="difflineplus">+    }</span>
<a href="#l13.1573"></a><span id="l13.1573" class="difflineplus">+    BuddiesById = {};</span>
<a href="#l13.1574"></a><span id="l13.1574" class="difflineplus">+    ContactsById = {};</span>
<a href="#l13.1575"></a><span id="l13.1575" class="difflineplus">+  },</span>
<a href="#l13.1576"></a><span id="l13.1576" class="difflineplus">+</span>
<a href="#l13.1577"></a><span id="l13.1577" class="difflineplus">+  getContactById: aId =&gt; ContactsById[aId],</span>
<a href="#l13.1578"></a><span id="l13.1578" class="difflineplus">+  // Get an array of all existing contacts.</span>
<a href="#l13.1579"></a><span id="l13.1579" class="difflineplus">+  getContacts() {</span>
<a href="#l13.1580"></a><span id="l13.1580" class="difflineplus">+    return Object.keys(ContactsById)</span>
<a href="#l13.1581"></a><span id="l13.1581" class="difflineplus">+      .filter(id =&gt; !ContactsById[id]._empty)</span>
<a href="#l13.1582"></a><span id="l13.1582" class="difflineplus">+      .map(id =&gt; ContactsById[id]);</span>
<a href="#l13.1583"></a><span id="l13.1583" class="difflineplus">+  },</span>
<a href="#l13.1584"></a><span id="l13.1584" class="difflineplus">+  getBuddyById: aId =&gt; BuddiesById[aId],</span>
<a href="#l13.1585"></a><span id="l13.1585" class="difflineplus">+  getBuddyByNameAndProtocol(aNormalizedName, aPrpl) {</span>
<a href="#l13.1586"></a><span id="l13.1586" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1587"></a><span id="l13.1587" class="difflineplus">+      &quot;SELECT b.id FROM buddies b &quot; +</span>
<a href="#l13.1588"></a><span id="l13.1588" class="difflineplus">+        &quot;JOIN account_buddy ab ON buddy_id = b.id &quot; +</span>
<a href="#l13.1589"></a><span id="l13.1589" class="difflineplus">+        &quot;JOIN accounts a ON account_id = a.id &quot; +</span>
<a href="#l13.1590"></a><span id="l13.1590" class="difflineplus">+        &quot;WHERE b.key = :buddyName and a.prpl = :prplId&quot;</span>
<a href="#l13.1591"></a><span id="l13.1591" class="difflineplus">+    );</span>
<a href="#l13.1592"></a><span id="l13.1592" class="difflineplus">+    statement.params.buddyName = aNormalizedName;</span>
<a href="#l13.1593"></a><span id="l13.1593" class="difflineplus">+    statement.params.prplId = aPrpl.id;</span>
<a href="#l13.1594"></a><span id="l13.1594" class="difflineplus">+    try {</span>
<a href="#l13.1595"></a><span id="l13.1595" class="difflineplus">+      if (!statement.executeStep()) {</span>
<a href="#l13.1596"></a><span id="l13.1596" class="difflineplus">+        return null;</span>
<a href="#l13.1597"></a><span id="l13.1597" class="difflineplus">+      }</span>
<a href="#l13.1598"></a><span id="l13.1598" class="difflineplus">+      return BuddiesById[statement.row.id];</span>
<a href="#l13.1599"></a><span id="l13.1599" class="difflineplus">+    } finally {</span>
<a href="#l13.1600"></a><span id="l13.1600" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1601"></a><span id="l13.1601" class="difflineplus">+    }</span>
<a href="#l13.1602"></a><span id="l13.1602" class="difflineplus">+  },</span>
<a href="#l13.1603"></a><span id="l13.1603" class="difflineplus">+  getAccountBuddyByNameAndAccount(aNormalizedName, aAccount) {</span>
<a href="#l13.1604"></a><span id="l13.1604" class="difflineplus">+    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l13.1605"></a><span id="l13.1605" class="difflineplus">+      aNormalizedName,</span>
<a href="#l13.1606"></a><span id="l13.1606" class="difflineplus">+      aAccount.protocol</span>
<a href="#l13.1607"></a><span id="l13.1607" class="difflineplus">+    );</span>
<a href="#l13.1608"></a><span id="l13.1608" class="difflineplus">+    if (buddy) {</span>
<a href="#l13.1609"></a><span id="l13.1609" class="difflineplus">+      let id = aAccount.id;</span>
<a href="#l13.1610"></a><span id="l13.1610" class="difflineplus">+      for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l13.1611"></a><span id="l13.1611" class="difflineplus">+        if (accountBuddy.account.id == id) {</span>
<a href="#l13.1612"></a><span id="l13.1612" class="difflineplus">+          return accountBuddy;</span>
<a href="#l13.1613"></a><span id="l13.1613" class="difflineplus">+        }</span>
<a href="#l13.1614"></a><span id="l13.1614" class="difflineplus">+      }</span>
<a href="#l13.1615"></a><span id="l13.1615" class="difflineplus">+    }</span>
<a href="#l13.1616"></a><span id="l13.1616" class="difflineplus">+    return null;</span>
<a href="#l13.1617"></a><span id="l13.1617" class="difflineplus">+  },</span>
<a href="#l13.1618"></a><span id="l13.1618" class="difflineplus">+</span>
<a href="#l13.1619"></a><span id="l13.1619" class="difflineplus">+  accountBuddyAdded(aAccountBuddy) {</span>
<a href="#l13.1620"></a><span id="l13.1620" class="difflineplus">+    let account = aAccountBuddy.account;</span>
<a href="#l13.1621"></a><span id="l13.1621" class="difflineplus">+    let normalizedName = aAccountBuddy.normalizedName;</span>
<a href="#l13.1622"></a><span id="l13.1622" class="difflineplus">+    let buddy = this.getBuddyByNameAndProtocol(</span>
<a href="#l13.1623"></a><span id="l13.1623" class="difflineplus">+      normalizedName,</span>
<a href="#l13.1624"></a><span id="l13.1624" class="difflineplus">+      account.protocol</span>
<a href="#l13.1625"></a><span id="l13.1625" class="difflineplus">+    );</span>
<a href="#l13.1626"></a><span id="l13.1626" class="difflineplus">+    if (!buddy) {</span>
<a href="#l13.1627"></a><span id="l13.1627" class="difflineplus">+      let statement = DBConn.createStatement(</span>
<a href="#l13.1628"></a><span id="l13.1628" class="difflineplus">+        &quot;INSERT INTO buddies &quot; +</span>
<a href="#l13.1629"></a><span id="l13.1629" class="difflineplus">+          &quot;(key, name, srv_alias, position) &quot; +</span>
<a href="#l13.1630"></a><span id="l13.1630" class="difflineplus">+          &quot;VALUES(:key, :name, :srvAlias, 0)&quot;</span>
<a href="#l13.1631"></a><span id="l13.1631" class="difflineplus">+      );</span>
<a href="#l13.1632"></a><span id="l13.1632" class="difflineplus">+      try {</span>
<a href="#l13.1633"></a><span id="l13.1633" class="difflineplus">+        let name = aAccountBuddy.userName;</span>
<a href="#l13.1634"></a><span id="l13.1634" class="difflineplus">+        let srvAlias = aAccountBuddy.serverAlias;</span>
<a href="#l13.1635"></a><span id="l13.1635" class="difflineplus">+        statement.params.key = normalizedName;</span>
<a href="#l13.1636"></a><span id="l13.1636" class="difflineplus">+        statement.params.name = name;</span>
<a href="#l13.1637"></a><span id="l13.1637" class="difflineplus">+        statement.params.srvAlias = srvAlias;</span>
<a href="#l13.1638"></a><span id="l13.1638" class="difflineplus">+        statement.execute();</span>
<a href="#l13.1639"></a><span id="l13.1639" class="difflineplus">+        buddy = new Buddy(</span>
<a href="#l13.1640"></a><span id="l13.1640" class="difflineplus">+          DBConn.lastInsertRowID,</span>
<a href="#l13.1641"></a><span id="l13.1641" class="difflineplus">+          normalizedName,</span>
<a href="#l13.1642"></a><span id="l13.1642" class="difflineplus">+          name,</span>
<a href="#l13.1643"></a><span id="l13.1643" class="difflineplus">+          srvAlias,</span>
<a href="#l13.1644"></a><span id="l13.1644" class="difflineplus">+          0</span>
<a href="#l13.1645"></a><span id="l13.1645" class="difflineplus">+        );</span>
<a href="#l13.1646"></a><span id="l13.1646" class="difflineplus">+      } finally {</span>
<a href="#l13.1647"></a><span id="l13.1647" class="difflineplus">+        statement.finalize();</span>
<a href="#l13.1648"></a><span id="l13.1648" class="difflineplus">+      }</span>
<a href="#l13.1649"></a><span id="l13.1649" class="difflineplus">+    }</span>
<a href="#l13.1650"></a><span id="l13.1650" class="difflineplus">+</span>
<a href="#l13.1651"></a><span id="l13.1651" class="difflineplus">+    // Initialize the 'buddy' field of the prplIAccountBuddy instance.</span>
<a href="#l13.1652"></a><span id="l13.1652" class="difflineplus">+    aAccountBuddy.buddy = buddy;</span>
<a href="#l13.1653"></a><span id="l13.1653" class="difflineplus">+</span>
<a href="#l13.1654"></a><span id="l13.1654" class="difflineplus">+    // Ensure we aren't storing a duplicate entry.</span>
<a href="#l13.1655"></a><span id="l13.1655" class="difflineplus">+    let accountId = account.numericId;</span>
<a href="#l13.1656"></a><span id="l13.1656" class="difflineplus">+    let tagId = aAccountBuddy.tag.id;</span>
<a href="#l13.1657"></a><span id="l13.1657" class="difflineplus">+    if (buddy._hasAccountBuddy(accountId, tagId)) {</span>
<a href="#l13.1658"></a><span id="l13.1658" class="difflineplus">+      Cu.reportError(</span>
<a href="#l13.1659"></a><span id="l13.1659" class="difflineplus">+        &quot;Attempting to store a duplicate account buddy &quot; +</span>
<a href="#l13.1660"></a><span id="l13.1660" class="difflineplus">+          normalizedName +</span>
<a href="#l13.1661"></a><span id="l13.1661" class="difflineplus">+          &quot;, account id = &quot; +</span>
<a href="#l13.1662"></a><span id="l13.1662" class="difflineplus">+          accountId +</span>
<a href="#l13.1663"></a><span id="l13.1663" class="difflineplus">+          &quot;, tag id = &quot; +</span>
<a href="#l13.1664"></a><span id="l13.1664" class="difflineplus">+          tagId</span>
<a href="#l13.1665"></a><span id="l13.1665" class="difflineplus">+      );</span>
<a href="#l13.1666"></a><span id="l13.1666" class="difflineplus">+      return;</span>
<a href="#l13.1667"></a><span id="l13.1667" class="difflineplus">+    }</span>
<a href="#l13.1668"></a><span id="l13.1668" class="difflineplus">+</span>
<a href="#l13.1669"></a><span id="l13.1669" class="difflineplus">+    // Store the new account buddy.</span>
<a href="#l13.1670"></a><span id="l13.1670" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1671"></a><span id="l13.1671" class="difflineplus">+      &quot;INSERT INTO account_buddy &quot; +</span>
<a href="#l13.1672"></a><span id="l13.1672" class="difflineplus">+        &quot;(account_id, buddy_id, tag_id) &quot; +</span>
<a href="#l13.1673"></a><span id="l13.1673" class="difflineplus">+        &quot;VALUES(:accountId, :buddyId, :tagId)&quot;</span>
<a href="#l13.1674"></a><span id="l13.1674" class="difflineplus">+    );</span>
<a href="#l13.1675"></a><span id="l13.1675" class="difflineplus">+    try {</span>
<a href="#l13.1676"></a><span id="l13.1676" class="difflineplus">+      statement.params.accountId = accountId;</span>
<a href="#l13.1677"></a><span id="l13.1677" class="difflineplus">+      statement.params.buddyId = buddy.id;</span>
<a href="#l13.1678"></a><span id="l13.1678" class="difflineplus">+      statement.params.tagId = tagId;</span>
<a href="#l13.1679"></a><span id="l13.1679" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1680"></a><span id="l13.1680" class="difflineplus">+    } finally {</span>
<a href="#l13.1681"></a><span id="l13.1681" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1682"></a><span id="l13.1682" class="difflineplus">+    }</span>
<a href="#l13.1683"></a><span id="l13.1683" class="difflineplus">+</span>
<a href="#l13.1684"></a><span id="l13.1684" class="difflineplus">+    // Fire the notifications.</span>
<a href="#l13.1685"></a><span id="l13.1685" class="difflineplus">+    buddy.observe(aAccountBuddy, &quot;account-buddy-added&quot;);</span>
<a href="#l13.1686"></a><span id="l13.1686" class="difflineplus">+  },</span>
<a href="#l13.1687"></a><span id="l13.1687" class="difflineplus">+  accountBuddyRemoved(aAccountBuddy) {</span>
<a href="#l13.1688"></a><span id="l13.1688" class="difflineplus">+    let buddy = aAccountBuddy.buddy;</span>
<a href="#l13.1689"></a><span id="l13.1689" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1690"></a><span id="l13.1690" class="difflineplus">+      &quot;DELETE FROM account_buddy &quot; +</span>
<a href="#l13.1691"></a><span id="l13.1691" class="difflineplus">+        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l13.1692"></a><span id="l13.1692" class="difflineplus">+        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l13.1693"></a><span id="l13.1693" class="difflineplus">+        &quot;tag_id = :tagId&quot;</span>
<a href="#l13.1694"></a><span id="l13.1694" class="difflineplus">+    );</span>
<a href="#l13.1695"></a><span id="l13.1695" class="difflineplus">+    try {</span>
<a href="#l13.1696"></a><span id="l13.1696" class="difflineplus">+      statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l13.1697"></a><span id="l13.1697" class="difflineplus">+      statement.params.buddyId = buddy.id;</span>
<a href="#l13.1698"></a><span id="l13.1698" class="difflineplus">+      statement.params.tagId = aAccountBuddy.tag.id;</span>
<a href="#l13.1699"></a><span id="l13.1699" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1700"></a><span id="l13.1700" class="difflineplus">+    } finally {</span>
<a href="#l13.1701"></a><span id="l13.1701" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1702"></a><span id="l13.1702" class="difflineplus">+    }</span>
<a href="#l13.1703"></a><span id="l13.1703" class="difflineplus">+</span>
<a href="#l13.1704"></a><span id="l13.1704" class="difflineplus">+    buddy.observe(aAccountBuddy, &quot;account-buddy-removed&quot;);</span>
<a href="#l13.1705"></a><span id="l13.1705" class="difflineplus">+  },</span>
<a href="#l13.1706"></a><span id="l13.1706" class="difflineplus">+</span>
<a href="#l13.1707"></a><span id="l13.1707" class="difflineplus">+  accountBuddyMoved(aAccountBuddy, aOldTag, aNewTag) {</span>
<a href="#l13.1708"></a><span id="l13.1708" class="difflineplus">+    let buddy = aAccountBuddy.buddy;</span>
<a href="#l13.1709"></a><span id="l13.1709" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1710"></a><span id="l13.1710" class="difflineplus">+      &quot;UPDATE account_buddy &quot; +</span>
<a href="#l13.1711"></a><span id="l13.1711" class="difflineplus">+        &quot;SET tag_id = :newTagId &quot; +</span>
<a href="#l13.1712"></a><span id="l13.1712" class="difflineplus">+        &quot;WHERE account_id = :accountId AND &quot; +</span>
<a href="#l13.1713"></a><span id="l13.1713" class="difflineplus">+        &quot;buddy_id = :buddyId AND &quot; +</span>
<a href="#l13.1714"></a><span id="l13.1714" class="difflineplus">+        &quot;tag_id = :oldTagId&quot;</span>
<a href="#l13.1715"></a><span id="l13.1715" class="difflineplus">+    );</span>
<a href="#l13.1716"></a><span id="l13.1716" class="difflineplus">+    try {</span>
<a href="#l13.1717"></a><span id="l13.1717" class="difflineplus">+      statement.params.accountId = aAccountBuddy.account.numericId;</span>
<a href="#l13.1718"></a><span id="l13.1718" class="difflineplus">+      statement.params.buddyId = buddy.id;</span>
<a href="#l13.1719"></a><span id="l13.1719" class="difflineplus">+      statement.params.oldTagId = aOldTag.id;</span>
<a href="#l13.1720"></a><span id="l13.1720" class="difflineplus">+      statement.params.newTagId = aNewTag.id;</span>
<a href="#l13.1721"></a><span id="l13.1721" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1722"></a><span id="l13.1722" class="difflineplus">+    } finally {</span>
<a href="#l13.1723"></a><span id="l13.1723" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1724"></a><span id="l13.1724" class="difflineplus">+    }</span>
<a href="#l13.1725"></a><span id="l13.1725" class="difflineplus">+</span>
<a href="#l13.1726"></a><span id="l13.1726" class="difflineplus">+    let contact = ContactsById[buddy.contact.id];</span>
<a href="#l13.1727"></a><span id="l13.1727" class="difflineplus">+</span>
<a href="#l13.1728"></a><span id="l13.1728" class="difflineplus">+    // aNewTag is now inherited by the contact from an account buddy, so avoid</span>
<a href="#l13.1729"></a><span id="l13.1729" class="difflineplus">+    // keeping direct tag &lt;-&gt; contact links in the contact_tag table.</span>
<a href="#l13.1730"></a><span id="l13.1730" class="difflineplus">+    contact._removeContactTagRow(aNewTag);</span>
<a href="#l13.1731"></a><span id="l13.1731" class="difflineplus">+</span>
<a href="#l13.1732"></a><span id="l13.1732" class="difflineplus">+    buddy.observe(aAccountBuddy, &quot;account-buddy-moved&quot;);</span>
<a href="#l13.1733"></a><span id="l13.1733" class="difflineplus">+    contact._moved(aOldTag, aNewTag);</span>
<a href="#l13.1734"></a><span id="l13.1734" class="difflineplus">+  },</span>
<a href="#l13.1735"></a><span id="l13.1735" class="difflineplus">+</span>
<a href="#l13.1736"></a><span id="l13.1736" class="difflineplus">+  storeAccount(aId, aUserName, aPrplId) {</span>
<a href="#l13.1737"></a><span id="l13.1737" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1738"></a><span id="l13.1738" class="difflineplus">+      &quot;SELECT name, prpl FROM accounts WHERE id = :id&quot;</span>
<a href="#l13.1739"></a><span id="l13.1739" class="difflineplus">+    );</span>
<a href="#l13.1740"></a><span id="l13.1740" class="difflineplus">+    statement.params.id = aId;</span>
<a href="#l13.1741"></a><span id="l13.1741" class="difflineplus">+    try {</span>
<a href="#l13.1742"></a><span id="l13.1742" class="difflineplus">+      if (statement.executeStep()) {</span>
<a href="#l13.1743"></a><span id="l13.1743" class="difflineplus">+        if (</span>
<a href="#l13.1744"></a><span id="l13.1744" class="difflineplus">+          statement.getUTF8String(0) == aUserName &amp;&amp;</span>
<a href="#l13.1745"></a><span id="l13.1745" class="difflineplus">+          statement.getUTF8String(1) == aPrplId</span>
<a href="#l13.1746"></a><span id="l13.1746" class="difflineplus">+        ) {</span>
<a href="#l13.1747"></a><span id="l13.1747" class="difflineplus">+          // The account is already stored correctly.</span>
<a href="#l13.1748"></a><span id="l13.1748" class="difflineplus">+          return;</span>
<a href="#l13.1749"></a><span id="l13.1749" class="difflineplus">+        }</span>
<a href="#l13.1750"></a><span id="l13.1750" class="difflineplus">+        throw Cr.NS_ERROR_UNEXPECTED; // Corrupted database?!?</span>
<a href="#l13.1751"></a><span id="l13.1751" class="difflineplus">+      }</span>
<a href="#l13.1752"></a><span id="l13.1752" class="difflineplus">+    } finally {</span>
<a href="#l13.1753"></a><span id="l13.1753" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1754"></a><span id="l13.1754" class="difflineplus">+    }</span>
<a href="#l13.1755"></a><span id="l13.1755" class="difflineplus">+</span>
<a href="#l13.1756"></a><span id="l13.1756" class="difflineplus">+    // Actually store the account.</span>
<a href="#l13.1757"></a><span id="l13.1757" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.1758"></a><span id="l13.1758" class="difflineplus">+      &quot;INSERT INTO accounts (id, name, prpl) &quot; +</span>
<a href="#l13.1759"></a><span id="l13.1759" class="difflineplus">+        &quot;VALUES(:id, :userName, :prplId)&quot;</span>
<a href="#l13.1760"></a><span id="l13.1760" class="difflineplus">+    );</span>
<a href="#l13.1761"></a><span id="l13.1761" class="difflineplus">+    try {</span>
<a href="#l13.1762"></a><span id="l13.1762" class="difflineplus">+      statement.params.id = aId;</span>
<a href="#l13.1763"></a><span id="l13.1763" class="difflineplus">+      statement.params.userName = aUserName;</span>
<a href="#l13.1764"></a><span id="l13.1764" class="difflineplus">+      statement.params.prplId = aPrplId;</span>
<a href="#l13.1765"></a><span id="l13.1765" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1766"></a><span id="l13.1766" class="difflineplus">+    } finally {</span>
<a href="#l13.1767"></a><span id="l13.1767" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1768"></a><span id="l13.1768" class="difflineplus">+    }</span>
<a href="#l13.1769"></a><span id="l13.1769" class="difflineplus">+  },</span>
<a href="#l13.1770"></a><span id="l13.1770" class="difflineplus">+  accountIdExists(aId) {</span>
<a href="#l13.1771"></a><span id="l13.1771" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1772"></a><span id="l13.1772" class="difflineplus">+      &quot;SELECT id FROM accounts WHERE id = :id&quot;</span>
<a href="#l13.1773"></a><span id="l13.1773" class="difflineplus">+    );</span>
<a href="#l13.1774"></a><span id="l13.1774" class="difflineplus">+    try {</span>
<a href="#l13.1775"></a><span id="l13.1775" class="difflineplus">+      statement.params.id = aId;</span>
<a href="#l13.1776"></a><span id="l13.1776" class="difflineplus">+      return statement.executeStep();</span>
<a href="#l13.1777"></a><span id="l13.1777" class="difflineplus">+    } finally {</span>
<a href="#l13.1778"></a><span id="l13.1778" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1779"></a><span id="l13.1779" class="difflineplus">+    }</span>
<a href="#l13.1780"></a><span id="l13.1780" class="difflineplus">+  },</span>
<a href="#l13.1781"></a><span id="l13.1781" class="difflineplus">+  forgetAccount(aId) {</span>
<a href="#l13.1782"></a><span id="l13.1782" class="difflineplus">+    let statement = DBConn.createStatement(</span>
<a href="#l13.1783"></a><span id="l13.1783" class="difflineplus">+      &quot;DELETE FROM accounts WHERE id = :accountId&quot;</span>
<a href="#l13.1784"></a><span id="l13.1784" class="difflineplus">+    );</span>
<a href="#l13.1785"></a><span id="l13.1785" class="difflineplus">+    try {</span>
<a href="#l13.1786"></a><span id="l13.1786" class="difflineplus">+      statement.params.accountId = aId;</span>
<a href="#l13.1787"></a><span id="l13.1787" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1788"></a><span id="l13.1788" class="difflineplus">+    } finally {</span>
<a href="#l13.1789"></a><span id="l13.1789" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1790"></a><span id="l13.1790" class="difflineplus">+    }</span>
<a href="#l13.1791"></a><span id="l13.1791" class="difflineplus">+</span>
<a href="#l13.1792"></a><span id="l13.1792" class="difflineplus">+    // removing the account from the accounts table is not enough,</span>
<a href="#l13.1793"></a><span id="l13.1793" class="difflineplus">+    // we need to remove all the associated account_buddy entries too</span>
<a href="#l13.1794"></a><span id="l13.1794" class="difflineplus">+    statement = DBConn.createStatement(</span>
<a href="#l13.1795"></a><span id="l13.1795" class="difflineplus">+      &quot;DELETE FROM account_buddy WHERE account_id = :accountId&quot;</span>
<a href="#l13.1796"></a><span id="l13.1796" class="difflineplus">+    );</span>
<a href="#l13.1797"></a><span id="l13.1797" class="difflineplus">+    try {</span>
<a href="#l13.1798"></a><span id="l13.1798" class="difflineplus">+      statement.params.accountId = aId;</span>
<a href="#l13.1799"></a><span id="l13.1799" class="difflineplus">+      statement.execute();</span>
<a href="#l13.1800"></a><span id="l13.1800" class="difflineplus">+    } finally {</span>
<a href="#l13.1801"></a><span id="l13.1801" class="difflineplus">+      statement.finalize();</span>
<a href="#l13.1802"></a><span id="l13.1802" class="difflineplus">+    }</span>
<a href="#l13.1803"></a><span id="l13.1803" class="difflineplus">+  },</span>
<a href="#l13.1804"></a><span id="l13.1804" class="difflineplus">+</span>
<a href="#l13.1805"></a><span id="l13.1805" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imIContactsService]),</span>
<a href="#l13.1806"></a><span id="l13.1806" class="difflineplus">+  classDescription: &quot;Contacts&quot;,</span>
<a href="#l13.1807"></a><span id="l13.1807" class="difflineplus">+  classID: Components.ID(&quot;{8c3725dd-ee26-489d-8135-736015af8c7f}&quot;),</span>
<a href="#l13.1808"></a><span id="l13.1808" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/contacts-service;1&quot;,</span>
<a href="#l13.1809"></a><span id="l13.1809" class="difflineplus">+};</span>
<a href="#l13.1810"></a><span id="l13.1810" class="difflineplus">+</span>
<a href="#l13.1811"></a><span id="l13.1811" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([</span>
<a href="#l13.1812"></a><span id="l13.1812" class="difflineplus">+  ContactsService,</span>
<a href="#l13.1813"></a><span id="l13.1813" class="difflineplus">+  TagsService,</span>
<a href="#l13.1814"></a><span id="l13.1814" class="difflineplus">+]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/chat/components/src/imContacts.manifest</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+component {8c3725dd-ee26-489d-8135-736015af8c7f} imContacts.js</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+contract @mozilla.org/chat/contacts-service;1 {8c3725dd-ee26-489d-8135-736015af8c7f}</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+component {1fa92237-4303-4384-b8ac-4e65b50810a5} imContacts.js</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+contract @mozilla.org/chat/tags-service;1 {1fa92237-4303-4384-b8ac-4e65b50810a5}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/chat/components/src/imConversations.js</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,839 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineplus">+</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+var { Status } = ChromeUtils.import(&quot;resource:///modules/imStatusUtils.jsm&quot;);</span>
<a href="#l15.11"></a><span id="l15.11" class="difflineplus">+var { XPCOMUtils, nsSimpleEnumerator, ClassInfo } = ChromeUtils.import(</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+var { Message } = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+var gLastUIConvId = 0;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+var gLastPrplConvId = 0;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;bundle&quot;, () =&gt;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  Services.strings.createBundle(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+);</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+function OutgoingMessage(aMsg, aConversation) {</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+  this.message = aMsg;</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+  this.conversation = aConversation;</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+}</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+OutgoingMessage.prototype = {</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  __proto__: ClassInfo(&quot;imIOutgoingMessage&quot;, &quot;Outgoing Message&quot;),</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  cancelled: false,</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+  action: false,</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+};</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+function imMessage(aPrplMessage) {</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineplus">+  this.prplMessage = aPrplMessage;</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+}</span>
<a href="#l15.36"></a><span id="l15.36" class="difflineplus">+imMessage.prototype = {</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineplus">+  __proto__: ClassInfo([&quot;imIMessage&quot;, &quot;prplIMessage&quot;], &quot;IM Message&quot;),</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  cancelled: false,</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+  color: &quot;&quot;,</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  _displayMessage: null,</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  encrypted: false,</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+</span>
<a href="#l15.43"></a><span id="l15.43" class="difflineplus">+  get displayMessage() {</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineplus">+    // Explicitly test for null so that blank messages don't fall back to</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+    // the original. Especially problematic in encryption extensions like OTR.</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineplus">+    return this._displayMessage !== null</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineplus">+      ? this._displayMessage</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+      : this.prplMessage.originalMessage;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  },</span>
<a href="#l15.50"></a><span id="l15.50" class="difflineplus">+  set displayMessage(aMsg) {</span>
<a href="#l15.51"></a><span id="l15.51" class="difflineplus">+    this._displayMessage = aMsg;</span>
<a href="#l15.52"></a><span id="l15.52" class="difflineplus">+  },</span>
<a href="#l15.53"></a><span id="l15.53" class="difflineplus">+</span>
<a href="#l15.54"></a><span id="l15.54" class="difflineplus">+  get message() {</span>
<a href="#l15.55"></a><span id="l15.55" class="difflineplus">+    return this.prplMessage.message;</span>
<a href="#l15.56"></a><span id="l15.56" class="difflineplus">+  },</span>
<a href="#l15.57"></a><span id="l15.57" class="difflineplus">+  set message(aMsg) {</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineplus">+    this.prplMessage.message = aMsg;</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  },</span>
<a href="#l15.60"></a><span id="l15.60" class="difflineplus">+</span>
<a href="#l15.61"></a><span id="l15.61" class="difflineplus">+  // from prplIMessage</span>
<a href="#l15.62"></a><span id="l15.62" class="difflineplus">+  get who() {</span>
<a href="#l15.63"></a><span id="l15.63" class="difflineplus">+    return this.prplMessage.who;</span>
<a href="#l15.64"></a><span id="l15.64" class="difflineplus">+  },</span>
<a href="#l15.65"></a><span id="l15.65" class="difflineplus">+  get time() {</span>
<a href="#l15.66"></a><span id="l15.66" class="difflineplus">+    return this.prplMessage.time;</span>
<a href="#l15.67"></a><span id="l15.67" class="difflineplus">+  },</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineplus">+  get id() {</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+    return this.prplMessage.id;</span>
<a href="#l15.70"></a><span id="l15.70" class="difflineplus">+  },</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineplus">+  get alias() {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+    return this.prplMessage.alias;</span>
<a href="#l15.73"></a><span id="l15.73" class="difflineplus">+  },</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineplus">+  get iconURL() {</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineplus">+    return this.prplMessage.iconURL;</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineplus">+  },</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+  get conversation() {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+    return this.prplMessage.conversation;</span>
<a href="#l15.79"></a><span id="l15.79" class="difflineplus">+  },</span>
<a href="#l15.80"></a><span id="l15.80" class="difflineplus">+  set conversation(aConv) {</span>
<a href="#l15.81"></a><span id="l15.81" class="difflineplus">+    this.prplMessage.conversation = aConv;</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineplus">+  },</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  get outgoing() {</span>
<a href="#l15.84"></a><span id="l15.84" class="difflineplus">+    return this.prplMessage.outgoing;</span>
<a href="#l15.85"></a><span id="l15.85" class="difflineplus">+  },</span>
<a href="#l15.86"></a><span id="l15.86" class="difflineplus">+  get incoming() {</span>
<a href="#l15.87"></a><span id="l15.87" class="difflineplus">+    return this.prplMessage.incoming;</span>
<a href="#l15.88"></a><span id="l15.88" class="difflineplus">+  },</span>
<a href="#l15.89"></a><span id="l15.89" class="difflineplus">+  get system() {</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineplus">+    return this.prplMessage.system;</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+  },</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineplus">+  get autoResponse() {</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineplus">+    return this.prplMessage.autoResponse;</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  },</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+  get containsNick() {</span>
<a href="#l15.96"></a><span id="l15.96" class="difflineplus">+    return this.prplMessage.containsNick;</span>
<a href="#l15.97"></a><span id="l15.97" class="difflineplus">+  },</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineplus">+  get noLog() {</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+    return this.prplMessage.noLog;</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineplus">+  },</span>
<a href="#l15.101"></a><span id="l15.101" class="difflineplus">+  get error() {</span>
<a href="#l15.102"></a><span id="l15.102" class="difflineplus">+    return this.prplMessage.error;</span>
<a href="#l15.103"></a><span id="l15.103" class="difflineplus">+  },</span>
<a href="#l15.104"></a><span id="l15.104" class="difflineplus">+  get delayed() {</span>
<a href="#l15.105"></a><span id="l15.105" class="difflineplus">+    return this.prplMessage.delayed;</span>
<a href="#l15.106"></a><span id="l15.106" class="difflineplus">+  },</span>
<a href="#l15.107"></a><span id="l15.107" class="difflineplus">+  get noFormat() {</span>
<a href="#l15.108"></a><span id="l15.108" class="difflineplus">+    return this.prplMessage.noFormat;</span>
<a href="#l15.109"></a><span id="l15.109" class="difflineplus">+  },</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+  get containsImages() {</span>
<a href="#l15.111"></a><span id="l15.111" class="difflineplus">+    return this.prplMessage.containsImages;</span>
<a href="#l15.112"></a><span id="l15.112" class="difflineplus">+  },</span>
<a href="#l15.113"></a><span id="l15.113" class="difflineplus">+  get notification() {</span>
<a href="#l15.114"></a><span id="l15.114" class="difflineplus">+    return this.prplMessage.notification;</span>
<a href="#l15.115"></a><span id="l15.115" class="difflineplus">+  },</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineplus">+  get noLinkification() {</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineplus">+    return this.prplMessage.noLinkification;</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+  },</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineplus">+  get originalMessage() {</span>
<a href="#l15.120"></a><span id="l15.120" class="difflineplus">+    return this.prplMessage.originalMessage;</span>
<a href="#l15.121"></a><span id="l15.121" class="difflineplus">+  },</span>
<a href="#l15.122"></a><span id="l15.122" class="difflineplus">+  getActions() {</span>
<a href="#l15.123"></a><span id="l15.123" class="difflineplus">+    return this.prplMessage.getActions();</span>
<a href="#l15.124"></a><span id="l15.124" class="difflineplus">+  },</span>
<a href="#l15.125"></a><span id="l15.125" class="difflineplus">+};</span>
<a href="#l15.126"></a><span id="l15.126" class="difflineplus">+</span>
<a href="#l15.127"></a><span id="l15.127" class="difflineplus">+function UIConversation(aPrplConversation) {</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineplus">+  this._prplConv = {};</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  this.id = ++gLastUIConvId;</span>
<a href="#l15.130"></a><span id="l15.130" class="difflineplus">+  this._observers = [];</span>
<a href="#l15.131"></a><span id="l15.131" class="difflineplus">+  this._messages = [];</span>
<a href="#l15.132"></a><span id="l15.132" class="difflineplus">+  this.changeTargetTo(aPrplConversation);</span>
<a href="#l15.133"></a><span id="l15.133" class="difflineplus">+  let iface = Ci[&quot;prplIConv&quot; + (aPrplConversation.isChat ? &quot;Chat&quot; : &quot;IM&quot;)];</span>
<a href="#l15.134"></a><span id="l15.134" class="difflineplus">+  this._interfaces = this._interfaces.concat(iface);</span>
<a href="#l15.135"></a><span id="l15.135" class="difflineplus">+  // XPConnect will create a wrapper around 'this' after here,</span>
<a href="#l15.136"></a><span id="l15.136" class="difflineplus">+  // so the list of exposed interfaces shouldn't change anymore.</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineplus">+  this.updateContactObserver();</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+  Services.obs.notifyObservers(this, &quot;new-ui-conversation&quot;);</span>
<a href="#l15.139"></a><span id="l15.139" class="difflineplus">+}</span>
<a href="#l15.140"></a><span id="l15.140" class="difflineplus">+</span>
<a href="#l15.141"></a><span id="l15.141" class="difflineplus">+UIConversation.prototype = {</span>
<a href="#l15.142"></a><span id="l15.142" class="difflineplus">+  __proto__: ClassInfo(</span>
<a href="#l15.143"></a><span id="l15.143" class="difflineplus">+    [&quot;imIConversation&quot;, &quot;prplIConversation&quot;, &quot;nsIObserver&quot;],</span>
<a href="#l15.144"></a><span id="l15.144" class="difflineplus">+    &quot;UI conversation&quot;</span>
<a href="#l15.145"></a><span id="l15.145" class="difflineplus">+  ),</span>
<a href="#l15.146"></a><span id="l15.146" class="difflineplus">+  _observedContact: null,</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineplus">+  get contact() {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+    let target = this.target;</span>
<a href="#l15.149"></a><span id="l15.149" class="difflineplus">+    if (!target.isChat &amp;&amp; target.buddy) {</span>
<a href="#l15.150"></a><span id="l15.150" class="difflineplus">+      return target.buddy.buddy.contact;</span>
<a href="#l15.151"></a><span id="l15.151" class="difflineplus">+    }</span>
<a href="#l15.152"></a><span id="l15.152" class="difflineplus">+    return null;</span>
<a href="#l15.153"></a><span id="l15.153" class="difflineplus">+  },</span>
<a href="#l15.154"></a><span id="l15.154" class="difflineplus">+  updateContactObserver() {</span>
<a href="#l15.155"></a><span id="l15.155" class="difflineplus">+    let contact = this.contact;</span>
<a href="#l15.156"></a><span id="l15.156" class="difflineplus">+    if (contact &amp;&amp; !this._observedContact) {</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineplus">+      contact.addObserver(this);</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+      this._observedContact = contact;</span>
<a href="#l15.159"></a><span id="l15.159" class="difflineplus">+    } else if (!contact &amp;&amp; this.observedContact) {</span>
<a href="#l15.160"></a><span id="l15.160" class="difflineplus">+      this._observedContact.removeObserver(this);</span>
<a href="#l15.161"></a><span id="l15.161" class="difflineplus">+      delete this._observedContact;</span>
<a href="#l15.162"></a><span id="l15.162" class="difflineplus">+    }</span>
<a href="#l15.163"></a><span id="l15.163" class="difflineplus">+  },</span>
<a href="#l15.164"></a><span id="l15.164" class="difflineplus">+  get target() {</span>
<a href="#l15.165"></a><span id="l15.165" class="difflineplus">+    return this._prplConv[this._currentTargetId];</span>
<a href="#l15.166"></a><span id="l15.166" class="difflineplus">+  },</span>
<a href="#l15.167"></a><span id="l15.167" class="difflineplus">+  set target(aPrplConversation) {</span>
<a href="#l15.168"></a><span id="l15.168" class="difflineplus">+    this.changeTargetTo(aPrplConversation);</span>
<a href="#l15.169"></a><span id="l15.169" class="difflineplus">+  },</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineplus">+  get hasMultipleTargets() {</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+    return Object.keys(this._prplConv).length &gt; 1;</span>
<a href="#l15.172"></a><span id="l15.172" class="difflineplus">+  },</span>
<a href="#l15.173"></a><span id="l15.173" class="difflineplus">+  getTargetByAccount(aAccount) {</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+    let accountId = aAccount.id;</span>
<a href="#l15.175"></a><span id="l15.175" class="difflineplus">+    for (let id in this._prplConv) {</span>
<a href="#l15.176"></a><span id="l15.176" class="difflineplus">+      let prplConv = this._prplConv[id];</span>
<a href="#l15.177"></a><span id="l15.177" class="difflineplus">+      if (prplConv.account.id == accountId) {</span>
<a href="#l15.178"></a><span id="l15.178" class="difflineplus">+        return prplConv;</span>
<a href="#l15.179"></a><span id="l15.179" class="difflineplus">+      }</span>
<a href="#l15.180"></a><span id="l15.180" class="difflineplus">+    }</span>
<a href="#l15.181"></a><span id="l15.181" class="difflineplus">+    return null;</span>
<a href="#l15.182"></a><span id="l15.182" class="difflineplus">+  },</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineplus">+  _currentTargetId: 0,</span>
<a href="#l15.184"></a><span id="l15.184" class="difflineplus">+  changeTargetTo(aPrplConversation) {</span>
<a href="#l15.185"></a><span id="l15.185" class="difflineplus">+    let id = aPrplConversation.id;</span>
<a href="#l15.186"></a><span id="l15.186" class="difflineplus">+    if (this._currentTargetId == id) {</span>
<a href="#l15.187"></a><span id="l15.187" class="difflineplus">+      return;</span>
<a href="#l15.188"></a><span id="l15.188" class="difflineplus">+    }</span>
<a href="#l15.189"></a><span id="l15.189" class="difflineplus">+</span>
<a href="#l15.190"></a><span id="l15.190" class="difflineplus">+    if (!(id in this._prplConv)) {</span>
<a href="#l15.191"></a><span id="l15.191" class="difflineplus">+      this._prplConv[id] = aPrplConversation;</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineplus">+      aPrplConversation.addObserver(this.observeConv.bind(this, id));</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+    }</span>
<a href="#l15.194"></a><span id="l15.194" class="difflineplus">+</span>
<a href="#l15.195"></a><span id="l15.195" class="difflineplus">+    let shouldNotify = this._currentTargetId;</span>
<a href="#l15.196"></a><span id="l15.196" class="difflineplus">+    this._currentTargetId = id;</span>
<a href="#l15.197"></a><span id="l15.197" class="difflineplus">+    if (!this.isChat) {</span>
<a href="#l15.198"></a><span id="l15.198" class="difflineplus">+      let buddy = this.buddy;</span>
<a href="#l15.199"></a><span id="l15.199" class="difflineplus">+      if (buddy) {</span>
<a href="#l15.200"></a><span id="l15.200" class="difflineplus">+        ({ statusType: this.statusType, statusText: this.statusText } = buddy);</span>
<a href="#l15.201"></a><span id="l15.201" class="difflineplus">+      }</span>
<a href="#l15.202"></a><span id="l15.202" class="difflineplus">+    }</span>
<a href="#l15.203"></a><span id="l15.203" class="difflineplus">+    if (shouldNotify) {</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineplus">+      this.notifyObservers(this, &quot;target-prpl-conversation-changed&quot;);</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+      let target = this.target;</span>
<a href="#l15.206"></a><span id="l15.206" class="difflineplus">+      let params = [target.title, target.account.protocol.name];</span>
<a href="#l15.207"></a><span id="l15.207" class="difflineplus">+      this.systemMessage(bundle.formatStringFromName(&quot;targetChanged&quot;, params));</span>
<a href="#l15.208"></a><span id="l15.208" class="difflineplus">+    }</span>
<a href="#l15.209"></a><span id="l15.209" class="difflineplus">+  },</span>
<a href="#l15.210"></a><span id="l15.210" class="difflineplus">+  // Returns a boolean indicating if the ui-conversation was closed.</span>
<a href="#l15.211"></a><span id="l15.211" class="difflineplus">+  // If the conversation was closed, aContactId.value is set to the contact id</span>
<a href="#l15.212"></a><span id="l15.212" class="difflineplus">+  // or 0 if no contact was associated with the conversation.</span>
<a href="#l15.213"></a><span id="l15.213" class="difflineplus">+  removeTarget(aPrplConversation, aContactId) {</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineplus">+    let id = aPrplConversation.id;</span>
<a href="#l15.215"></a><span id="l15.215" class="difflineplus">+    if (!(id in this._prplConv)) {</span>
<a href="#l15.216"></a><span id="l15.216" class="difflineplus">+      throw new Error(&quot;unknown prpl conversation&quot;);</span>
<a href="#l15.217"></a><span id="l15.217" class="difflineplus">+    }</span>
<a href="#l15.218"></a><span id="l15.218" class="difflineplus">+</span>
<a href="#l15.219"></a><span id="l15.219" class="difflineplus">+    delete this._prplConv[id];</span>
<a href="#l15.220"></a><span id="l15.220" class="difflineplus">+    if (this._currentTargetId != id) {</span>
<a href="#l15.221"></a><span id="l15.221" class="difflineplus">+      return false;</span>
<a href="#l15.222"></a><span id="l15.222" class="difflineplus">+    }</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineplus">+</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineplus">+    for (let newId in this._prplConv) {</span>
<a href="#l15.225"></a><span id="l15.225" class="difflineplus">+      this.changeTargetTo(this._prplConv[newId]);</span>
<a href="#l15.226"></a><span id="l15.226" class="difflineplus">+      return false;</span>
<a href="#l15.227"></a><span id="l15.227" class="difflineplus">+    }</span>
<a href="#l15.228"></a><span id="l15.228" class="difflineplus">+</span>
<a href="#l15.229"></a><span id="l15.229" class="difflineplus">+    if (this._observedContact) {</span>
<a href="#l15.230"></a><span id="l15.230" class="difflineplus">+      this._observedContact.removeObserver(this);</span>
<a href="#l15.231"></a><span id="l15.231" class="difflineplus">+      aContactId.value = this._observedContact.id;</span>
<a href="#l15.232"></a><span id="l15.232" class="difflineplus">+      delete this._observedContact;</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineplus">+    } else {</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+      aContactId.value = 0;</span>
<a href="#l15.235"></a><span id="l15.235" class="difflineplus">+    }</span>
<a href="#l15.236"></a><span id="l15.236" class="difflineplus">+</span>
<a href="#l15.237"></a><span id="l15.237" class="difflineplus">+    delete this._currentTargetId;</span>
<a href="#l15.238"></a><span id="l15.238" class="difflineplus">+    this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l15.239"></a><span id="l15.239" class="difflineplus">+    return true;</span>
<a href="#l15.240"></a><span id="l15.240" class="difflineplus">+  },</span>
<a href="#l15.241"></a><span id="l15.241" class="difflineplus">+</span>
<a href="#l15.242"></a><span id="l15.242" class="difflineplus">+  _unreadMessageCount: 0,</span>
<a href="#l15.243"></a><span id="l15.243" class="difflineplus">+  get unreadMessageCount() {</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineplus">+    return this._unreadMessageCount;</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+  },</span>
<a href="#l15.246"></a><span id="l15.246" class="difflineplus">+  _unreadTargetedMessageCount: 0,</span>
<a href="#l15.247"></a><span id="l15.247" class="difflineplus">+  get unreadTargetedMessageCount() {</span>
<a href="#l15.248"></a><span id="l15.248" class="difflineplus">+    return this._unreadTargetedMessageCount;</span>
<a href="#l15.249"></a><span id="l15.249" class="difflineplus">+  },</span>
<a href="#l15.250"></a><span id="l15.250" class="difflineplus">+  _unreadIncomingMessageCount: 0,</span>
<a href="#l15.251"></a><span id="l15.251" class="difflineplus">+  get unreadIncomingMessageCount() {</span>
<a href="#l15.252"></a><span id="l15.252" class="difflineplus">+    return this._unreadIncomingMessageCount;</span>
<a href="#l15.253"></a><span id="l15.253" class="difflineplus">+  },</span>
<a href="#l15.254"></a><span id="l15.254" class="difflineplus">+  markAsRead() {</span>
<a href="#l15.255"></a><span id="l15.255" class="difflineplus">+    delete this._unreadMessageCount;</span>
<a href="#l15.256"></a><span id="l15.256" class="difflineplus">+    delete this._unreadTargetedMessageCount;</span>
<a href="#l15.257"></a><span id="l15.257" class="difflineplus">+    delete this._unreadIncomingMessageCount;</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineplus">+    this._notifyUnreadCountChanged();</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+  },</span>
<a href="#l15.260"></a><span id="l15.260" class="difflineplus">+  _lastNotifiedUnreadCount: 0,</span>
<a href="#l15.261"></a><span id="l15.261" class="difflineplus">+  _notifyUnreadCountChanged() {</span>
<a href="#l15.262"></a><span id="l15.262" class="difflineplus">+    if (this._unreadIncomingMessageCount == this._lastNotifiedUnreadCount) {</span>
<a href="#l15.263"></a><span id="l15.263" class="difflineplus">+      return;</span>
<a href="#l15.264"></a><span id="l15.264" class="difflineplus">+    }</span>
<a href="#l15.265"></a><span id="l15.265" class="difflineplus">+</span>
<a href="#l15.266"></a><span id="l15.266" class="difflineplus">+    this._lastNotifiedUnreadCount = this._unreadIncomingMessageCount;</span>
<a href="#l15.267"></a><span id="l15.267" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineplus">+      observer.observe(</span>
<a href="#l15.269"></a><span id="l15.269" class="difflineplus">+        this,</span>
<a href="#l15.270"></a><span id="l15.270" class="difflineplus">+        &quot;unread-message-count-changed&quot;,</span>
<a href="#l15.271"></a><span id="l15.271" class="difflineplus">+        this._unreadIncomingMessageCount.toString()</span>
<a href="#l15.272"></a><span id="l15.272" class="difflineplus">+      );</span>
<a href="#l15.273"></a><span id="l15.273" class="difflineplus">+    }</span>
<a href="#l15.274"></a><span id="l15.274" class="difflineplus">+  },</span>
<a href="#l15.275"></a><span id="l15.275" class="difflineplus">+  getMessages() {</span>
<a href="#l15.276"></a><span id="l15.276" class="difflineplus">+    return this._messages;</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineplus">+  },</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+  checkClose() {</span>
<a href="#l15.279"></a><span id="l15.279" class="difflineplus">+    if (!this._currentTargetId) {</span>
<a href="#l15.280"></a><span id="l15.280" class="difflineplus">+      // Already closed.</span>
<a href="#l15.281"></a><span id="l15.281" class="difflineplus">+      return true;</span>
<a href="#l15.282"></a><span id="l15.282" class="difflineplus">+    }</span>
<a href="#l15.283"></a><span id="l15.283" class="difflineplus">+</span>
<a href="#l15.284"></a><span id="l15.284" class="difflineplus">+    if (</span>
<a href="#l15.285"></a><span id="l15.285" class="difflineplus">+      !Services.prefs.getBoolPref(&quot;messenger.conversations.alwaysClose&quot;) &amp;&amp;</span>
<a href="#l15.286"></a><span id="l15.286" class="difflineplus">+      ((this.isChat &amp;&amp; !this.left) ||</span>
<a href="#l15.287"></a><span id="l15.287" class="difflineplus">+        (!this.isChat &amp;&amp;</span>
<a href="#l15.288"></a><span id="l15.288" class="difflineplus">+          (this.unreadIncomingMessageCount != 0 ||</span>
<a href="#l15.289"></a><span id="l15.289" class="difflineplus">+            Services.prefs.getBoolPref(</span>
<a href="#l15.290"></a><span id="l15.290" class="difflineplus">+              &quot;messenger.conversations.holdByDefault&quot;</span>
<a href="#l15.291"></a><span id="l15.291" class="difflineplus">+            ))))</span>
<a href="#l15.292"></a><span id="l15.292" class="difflineplus">+    ) {</span>
<a href="#l15.293"></a><span id="l15.293" class="difflineplus">+      return false;</span>
<a href="#l15.294"></a><span id="l15.294" class="difflineplus">+    }</span>
<a href="#l15.295"></a><span id="l15.295" class="difflineplus">+</span>
<a href="#l15.296"></a><span id="l15.296" class="difflineplus">+    this.close();</span>
<a href="#l15.297"></a><span id="l15.297" class="difflineplus">+    return true;</span>
<a href="#l15.298"></a><span id="l15.298" class="difflineplus">+  },</span>
<a href="#l15.299"></a><span id="l15.299" class="difflineplus">+</span>
<a href="#l15.300"></a><span id="l15.300" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l15.301"></a><span id="l15.301" class="difflineplus">+    if (aTopic == &quot;contact-no-longer-dummy&quot;) {</span>
<a href="#l15.302"></a><span id="l15.302" class="difflineplus">+      let oldId = parseInt(aData);</span>
<a href="#l15.303"></a><span id="l15.303" class="difflineplus">+      // gConversationsService is ugly... :(</span>
<a href="#l15.304"></a><span id="l15.304" class="difflineplus">+      delete gConversationsService._uiConvByContactId[oldId];</span>
<a href="#l15.305"></a><span id="l15.305" class="difflineplus">+      gConversationsService._uiConvByContactId[aSubject.id] = this;</span>
<a href="#l15.306"></a><span id="l15.306" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-status-changed&quot;) {</span>
<a href="#l15.307"></a><span id="l15.307" class="difflineplus">+      if (</span>
<a href="#l15.308"></a><span id="l15.308" class="difflineplus">+        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l15.309"></a><span id="l15.309" class="difflineplus">+        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l15.310"></a><span id="l15.310" class="difflineplus">+        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l15.311"></a><span id="l15.311" class="difflineplus">+      ) {</span>
<a href="#l15.312"></a><span id="l15.312" class="difflineplus">+        this._statusUpdatePending = true;</span>
<a href="#l15.313"></a><span id="l15.313" class="difflineplus">+        Services.tm.mainThread.dispatch(</span>
<a href="#l15.314"></a><span id="l15.314" class="difflineplus">+          this.updateBuddyStatus.bind(this),</span>
<a href="#l15.315"></a><span id="l15.315" class="difflineplus">+          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l15.316"></a><span id="l15.316" class="difflineplus">+        );</span>
<a href="#l15.317"></a><span id="l15.317" class="difflineplus">+      }</span>
<a href="#l15.318"></a><span id="l15.318" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-icon-changed&quot;) {</span>
<a href="#l15.319"></a><span id="l15.319" class="difflineplus">+      if (</span>
<a href="#l15.320"></a><span id="l15.320" class="difflineplus">+        !this._statusUpdatePending &amp;&amp;</span>
<a href="#l15.321"></a><span id="l15.321" class="difflineplus">+        aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l15.322"></a><span id="l15.322" class="difflineplus">+        aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l15.323"></a><span id="l15.323" class="difflineplus">+      ) {</span>
<a href="#l15.324"></a><span id="l15.324" class="difflineplus">+        this._iconUpdatePending = true;</span>
<a href="#l15.325"></a><span id="l15.325" class="difflineplus">+        Services.tm.mainThread.dispatch(</span>
<a href="#l15.326"></a><span id="l15.326" class="difflineplus">+          this.updateIcon.bind(this),</span>
<a href="#l15.327"></a><span id="l15.327" class="difflineplus">+          Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l15.328"></a><span id="l15.328" class="difflineplus">+        );</span>
<a href="#l15.329"></a><span id="l15.329" class="difflineplus">+      }</span>
<a href="#l15.330"></a><span id="l15.330" class="difflineplus">+    } else if (</span>
<a href="#l15.331"></a><span id="l15.331" class="difflineplus">+      aTopic == &quot;account-buddy-display-name-changed&quot; &amp;&amp;</span>
<a href="#l15.332"></a><span id="l15.332" class="difflineplus">+      aSubject.account.id == this.account.id &amp;&amp;</span>
<a href="#l15.333"></a><span id="l15.333" class="difflineplus">+      aSubject.buddy.id == this.buddy.buddy.id</span>
<a href="#l15.334"></a><span id="l15.334" class="difflineplus">+    ) {</span>
<a href="#l15.335"></a><span id="l15.335" class="difflineplus">+      this.notifyObservers(this, &quot;update-buddy-display-name&quot;);</span>
<a href="#l15.336"></a><span id="l15.336" class="difflineplus">+    }</span>
<a href="#l15.337"></a><span id="l15.337" class="difflineplus">+  },</span>
<a href="#l15.338"></a><span id="l15.338" class="difflineplus">+</span>
<a href="#l15.339"></a><span id="l15.339" class="difflineplus">+  _iconUpdatePending: false,</span>
<a href="#l15.340"></a><span id="l15.340" class="difflineplus">+  updateIcon() {</span>
<a href="#l15.341"></a><span id="l15.341" class="difflineplus">+    delete this._iconUpdatePending;</span>
<a href="#l15.342"></a><span id="l15.342" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-icon&quot;);</span>
<a href="#l15.343"></a><span id="l15.343" class="difflineplus">+  },</span>
<a href="#l15.344"></a><span id="l15.344" class="difflineplus">+</span>
<a href="#l15.345"></a><span id="l15.345" class="difflineplus">+  _statusUpdatePending: false,</span>
<a href="#l15.346"></a><span id="l15.346" class="difflineplus">+  updateBuddyStatus() {</span>
<a href="#l15.347"></a><span id="l15.347" class="difflineplus">+    delete this._statusUpdatePending;</span>
<a href="#l15.348"></a><span id="l15.348" class="difflineplus">+    let { statusType: statusType, statusText: statusText } = this.buddy;</span>
<a href="#l15.349"></a><span id="l15.349" class="difflineplus">+</span>
<a href="#l15.350"></a><span id="l15.350" class="difflineplus">+    if (</span>
<a href="#l15.351"></a><span id="l15.351" class="difflineplus">+      &quot;statusType&quot; in this &amp;&amp;</span>
<a href="#l15.352"></a><span id="l15.352" class="difflineplus">+      this.statusType == statusType &amp;&amp;</span>
<a href="#l15.353"></a><span id="l15.353" class="difflineplus">+      this.statusText == statusText</span>
<a href="#l15.354"></a><span id="l15.354" class="difflineplus">+    ) {</span>
<a href="#l15.355"></a><span id="l15.355" class="difflineplus">+      return;</span>
<a href="#l15.356"></a><span id="l15.356" class="difflineplus">+    }</span>
<a href="#l15.357"></a><span id="l15.357" class="difflineplus">+</span>
<a href="#l15.358"></a><span id="l15.358" class="difflineplus">+    let wasUnknown = this.statusType == Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l15.359"></a><span id="l15.359" class="difflineplus">+    this.statusType = statusType;</span>
<a href="#l15.360"></a><span id="l15.360" class="difflineplus">+    this.statusText = statusText;</span>
<a href="#l15.361"></a><span id="l15.361" class="difflineplus">+</span>
<a href="#l15.362"></a><span id="l15.362" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l15.363"></a><span id="l15.363" class="difflineplus">+</span>
<a href="#l15.364"></a><span id="l15.364" class="difflineplus">+    let msg;</span>
<a href="#l15.365"></a><span id="l15.365" class="difflineplus">+    if (statusType == Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l15.366"></a><span id="l15.366" class="difflineplus">+      msg = bundle.formatStringFromName(&quot;statusUnknown&quot;, [this.title]);</span>
<a href="#l15.367"></a><span id="l15.367" class="difflineplus">+    } else {</span>
<a href="#l15.368"></a><span id="l15.368" class="difflineplus">+      let status = Status.toLabel(statusType);</span>
<a href="#l15.369"></a><span id="l15.369" class="difflineplus">+      let stringId = wasUnknown ? &quot;statusChangedFromUnknown&quot; : &quot;statusChanged&quot;;</span>
<a href="#l15.370"></a><span id="l15.370" class="difflineplus">+      if (this._justReconnected) {</span>
<a href="#l15.371"></a><span id="l15.371" class="difflineplus">+        stringId = &quot;statusKnown&quot;;</span>
<a href="#l15.372"></a><span id="l15.372" class="difflineplus">+        delete this._justReconnected;</span>
<a href="#l15.373"></a><span id="l15.373" class="difflineplus">+      }</span>
<a href="#l15.374"></a><span id="l15.374" class="difflineplus">+      if (statusText) {</span>
<a href="#l15.375"></a><span id="l15.375" class="difflineplus">+        msg = bundle.formatStringFromName(stringId + &quot;WithStatusText&quot;, [</span>
<a href="#l15.376"></a><span id="l15.376" class="difflineplus">+          this.title,</span>
<a href="#l15.377"></a><span id="l15.377" class="difflineplus">+          status,</span>
<a href="#l15.378"></a><span id="l15.378" class="difflineplus">+          statusText,</span>
<a href="#l15.379"></a><span id="l15.379" class="difflineplus">+        ]);</span>
<a href="#l15.380"></a><span id="l15.380" class="difflineplus">+      } else {</span>
<a href="#l15.381"></a><span id="l15.381" class="difflineplus">+        msg = bundle.formatStringFromName(stringId, [this.title, status]);</span>
<a href="#l15.382"></a><span id="l15.382" class="difflineplus">+      }</span>
<a href="#l15.383"></a><span id="l15.383" class="difflineplus">+    }</span>
<a href="#l15.384"></a><span id="l15.384" class="difflineplus">+    this.systemMessage(msg);</span>
<a href="#l15.385"></a><span id="l15.385" class="difflineplus">+  },</span>
<a href="#l15.386"></a><span id="l15.386" class="difflineplus">+</span>
<a href="#l15.387"></a><span id="l15.387" class="difflineplus">+  _disconnected: false,</span>
<a href="#l15.388"></a><span id="l15.388" class="difflineplus">+  disconnecting() {</span>
<a href="#l15.389"></a><span id="l15.389" class="difflineplus">+    if (this._disconnected) {</span>
<a href="#l15.390"></a><span id="l15.390" class="difflineplus">+      return;</span>
<a href="#l15.391"></a><span id="l15.391" class="difflineplus">+    }</span>
<a href="#l15.392"></a><span id="l15.392" class="difflineplus">+</span>
<a href="#l15.393"></a><span id="l15.393" class="difflineplus">+    this._disconnected = true;</span>
<a href="#l15.394"></a><span id="l15.394" class="difflineplus">+    if (this.contact) {</span>
<a href="#l15.395"></a><span id="l15.395" class="difflineplus">+      // Handled by the contact observer.</span>
<a href="#l15.396"></a><span id="l15.396" class="difflineplus">+      return;</span>
<a href="#l15.397"></a><span id="l15.397" class="difflineplus">+    }</span>
<a href="#l15.398"></a><span id="l15.398" class="difflineplus">+</span>
<a href="#l15.399"></a><span id="l15.399" class="difflineplus">+    if (this.isChat &amp;&amp; this.left) {</span>
<a href="#l15.400"></a><span id="l15.400" class="difflineplus">+      this._wasLeft = true;</span>
<a href="#l15.401"></a><span id="l15.401" class="difflineplus">+    } else {</span>
<a href="#l15.402"></a><span id="l15.402" class="difflineplus">+      this.systemMessage(bundle.GetStringFromName(&quot;accountDisconnected&quot;));</span>
<a href="#l15.403"></a><span id="l15.403" class="difflineplus">+    }</span>
<a href="#l15.404"></a><span id="l15.404" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l15.405"></a><span id="l15.405" class="difflineplus">+  },</span>
<a href="#l15.406"></a><span id="l15.406" class="difflineplus">+  connected() {</span>
<a href="#l15.407"></a><span id="l15.407" class="difflineplus">+    if (this._disconnected) {</span>
<a href="#l15.408"></a><span id="l15.408" class="difflineplus">+      delete this._disconnected;</span>
<a href="#l15.409"></a><span id="l15.409" class="difflineplus">+      let msg = bundle.GetStringFromName(&quot;accountReconnected&quot;);</span>
<a href="#l15.410"></a><span id="l15.410" class="difflineplus">+      if (this.isChat) {</span>
<a href="#l15.411"></a><span id="l15.411" class="difflineplus">+        if (!this._wasLeft) {</span>
<a href="#l15.412"></a><span id="l15.412" class="difflineplus">+          this.systemMessage(msg);</span>
<a href="#l15.413"></a><span id="l15.413" class="difflineplus">+          // Reconnect chat if possible.</span>
<a href="#l15.414"></a><span id="l15.414" class="difflineplus">+          let chatRoomFields = this.target.chatRoomFields;</span>
<a href="#l15.415"></a><span id="l15.415" class="difflineplus">+          if (chatRoomFields) {</span>
<a href="#l15.416"></a><span id="l15.416" class="difflineplus">+            this.account.joinChat(chatRoomFields);</span>
<a href="#l15.417"></a><span id="l15.417" class="difflineplus">+          }</span>
<a href="#l15.418"></a><span id="l15.418" class="difflineplus">+        }</span>
<a href="#l15.419"></a><span id="l15.419" class="difflineplus">+        delete this._wasLeft;</span>
<a href="#l15.420"></a><span id="l15.420" class="difflineplus">+      } else {</span>
<a href="#l15.421"></a><span id="l15.421" class="difflineplus">+        this._justReconnected = true;</span>
<a href="#l15.422"></a><span id="l15.422" class="difflineplus">+        // Exclude convs with contacts, these receive presence info updates</span>
<a href="#l15.423"></a><span id="l15.423" class="difflineplus">+        // (and therefore a reconnected message).</span>
<a href="#l15.424"></a><span id="l15.424" class="difflineplus">+        if (!this.contact) {</span>
<a href="#l15.425"></a><span id="l15.425" class="difflineplus">+          this.systemMessage(msg);</span>
<a href="#l15.426"></a><span id="l15.426" class="difflineplus">+        }</span>
<a href="#l15.427"></a><span id="l15.427" class="difflineplus">+      }</span>
<a href="#l15.428"></a><span id="l15.428" class="difflineplus">+    }</span>
<a href="#l15.429"></a><span id="l15.429" class="difflineplus">+    this.notifyObservers(this, &quot;update-buddy-status&quot;);</span>
<a href="#l15.430"></a><span id="l15.430" class="difflineplus">+  },</span>
<a href="#l15.431"></a><span id="l15.431" class="difflineplus">+</span>
<a href="#l15.432"></a><span id="l15.432" class="difflineplus">+  observeConv(aTargetId, aSubject, aTopic, aData) {</span>
<a href="#l15.433"></a><span id="l15.433" class="difflineplus">+    if (</span>
<a href="#l15.434"></a><span id="l15.434" class="difflineplus">+      aTargetId != this._currentTargetId &amp;&amp;</span>
<a href="#l15.435"></a><span id="l15.435" class="difflineplus">+      (aTopic == &quot;new-text&quot; ||</span>
<a href="#l15.436"></a><span id="l15.436" class="difflineplus">+        (aTopic == &quot;update-typing&quot; &amp;&amp;</span>
<a href="#l15.437"></a><span id="l15.437" class="difflineplus">+          this._prplConv[aTargetId].typingState == Ci.prplIConvIM.TYPING))</span>
<a href="#l15.438"></a><span id="l15.438" class="difflineplus">+    ) {</span>
<a href="#l15.439"></a><span id="l15.439" class="difflineplus">+      this.target = this._prplConv[aTargetId];</span>
<a href="#l15.440"></a><span id="l15.440" class="difflineplus">+    }</span>
<a href="#l15.441"></a><span id="l15.441" class="difflineplus">+</span>
<a href="#l15.442"></a><span id="l15.442" class="difflineplus">+    this.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l15.443"></a><span id="l15.443" class="difflineplus">+  },</span>
<a href="#l15.444"></a><span id="l15.444" class="difflineplus">+</span>
<a href="#l15.445"></a><span id="l15.445" class="difflineplus">+  systemMessage(aText, aIsError) {</span>
<a href="#l15.446"></a><span id="l15.446" class="difflineplus">+    let flags = { system: true, noLog: true, error: !!aIsError };</span>
<a href="#l15.447"></a><span id="l15.447" class="difflineplus">+    new Message(&quot;system&quot;, aText, flags).conversation = this;</span>
<a href="#l15.448"></a><span id="l15.448" class="difflineplus">+  },</span>
<a href="#l15.449"></a><span id="l15.449" class="difflineplus">+</span>
<a href="#l15.450"></a><span id="l15.450" class="difflineplus">+  // prplIConversation</span>
<a href="#l15.451"></a><span id="l15.451" class="difflineplus">+  get isChat() {</span>
<a href="#l15.452"></a><span id="l15.452" class="difflineplus">+    return this.target.isChat;</span>
<a href="#l15.453"></a><span id="l15.453" class="difflineplus">+  },</span>
<a href="#l15.454"></a><span id="l15.454" class="difflineplus">+  get account() {</span>
<a href="#l15.455"></a><span id="l15.455" class="difflineplus">+    return this.target.account;</span>
<a href="#l15.456"></a><span id="l15.456" class="difflineplus">+  },</span>
<a href="#l15.457"></a><span id="l15.457" class="difflineplus">+  get name() {</span>
<a href="#l15.458"></a><span id="l15.458" class="difflineplus">+    return this.target.name;</span>
<a href="#l15.459"></a><span id="l15.459" class="difflineplus">+  },</span>
<a href="#l15.460"></a><span id="l15.460" class="difflineplus">+  get normalizedName() {</span>
<a href="#l15.461"></a><span id="l15.461" class="difflineplus">+    return this.target.normalizedName;</span>
<a href="#l15.462"></a><span id="l15.462" class="difflineplus">+  },</span>
<a href="#l15.463"></a><span id="l15.463" class="difflineplus">+  get title() {</span>
<a href="#l15.464"></a><span id="l15.464" class="difflineplus">+    return this.target.title;</span>
<a href="#l15.465"></a><span id="l15.465" class="difflineplus">+  },</span>
<a href="#l15.466"></a><span id="l15.466" class="difflineplus">+  get startDate() {</span>
<a href="#l15.467"></a><span id="l15.467" class="difflineplus">+    return this.target.startDate;</span>
<a href="#l15.468"></a><span id="l15.468" class="difflineplus">+  },</span>
<a href="#l15.469"></a><span id="l15.469" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l15.470"></a><span id="l15.470" class="difflineplus">+    // Add-ons (eg. pastebin) have an opportunity to cancel the message at this</span>
<a href="#l15.471"></a><span id="l15.471" class="difflineplus">+    // point, or change the text content of the message.</span>
<a href="#l15.472"></a><span id="l15.472" class="difflineplus">+    // If an add-on wants to split a message, it should truncate the first</span>
<a href="#l15.473"></a><span id="l15.473" class="difflineplus">+    // message, and insert new messages using the conversation's sendMsg method.</span>
<a href="#l15.474"></a><span id="l15.474" class="difflineplus">+    let om = new OutgoingMessage(aMsg, this);</span>
<a href="#l15.475"></a><span id="l15.475" class="difflineplus">+    this.notifyObservers(om, &quot;preparing-message&quot;);</span>
<a href="#l15.476"></a><span id="l15.476" class="difflineplus">+    if (om.cancelled) {</span>
<a href="#l15.477"></a><span id="l15.477" class="difflineplus">+      return;</span>
<a href="#l15.478"></a><span id="l15.478" class="difflineplus">+    }</span>
<a href="#l15.479"></a><span id="l15.479" class="difflineplus">+</span>
<a href="#l15.480"></a><span id="l15.480" class="difflineplus">+    // Protocols have an opportunity here to preprocess messages before they are</span>
<a href="#l15.481"></a><span id="l15.481" class="difflineplus">+    // sent (eg. split long messages). If a message is split here, the split</span>
<a href="#l15.482"></a><span id="l15.482" class="difflineplus">+    // will be visible in the UI.</span>
<a href="#l15.483"></a><span id="l15.483" class="difflineplus">+    let messages = this.target.prepareForSending(om);</span>
<a href="#l15.484"></a><span id="l15.484" class="difflineplus">+</span>
<a href="#l15.485"></a><span id="l15.485" class="difflineplus">+    // Protocols can return null if they don't need to make any changes.</span>
<a href="#l15.486"></a><span id="l15.486" class="difflineplus">+    // (nb. passing null with retval array results in an empty array)</span>
<a href="#l15.487"></a><span id="l15.487" class="difflineplus">+    if (!messages || !messages.length) {</span>
<a href="#l15.488"></a><span id="l15.488" class="difflineplus">+      messages = [om.message];</span>
<a href="#l15.489"></a><span id="l15.489" class="difflineplus">+    }</span>
<a href="#l15.490"></a><span id="l15.490" class="difflineplus">+</span>
<a href="#l15.491"></a><span id="l15.491" class="difflineplus">+    for (let msg of messages) {</span>
<a href="#l15.492"></a><span id="l15.492" class="difflineplus">+      // Add-ons (eg. OTR) have an opportunity to tweak or cancel the message</span>
<a href="#l15.493"></a><span id="l15.493" class="difflineplus">+      // at this point.</span>
<a href="#l15.494"></a><span id="l15.494" class="difflineplus">+      om = new OutgoingMessage(msg, this.target);</span>
<a href="#l15.495"></a><span id="l15.495" class="difflineplus">+      this.notifyObservers(om, &quot;sending-message&quot;);</span>
<a href="#l15.496"></a><span id="l15.496" class="difflineplus">+      if (om.cancelled) {</span>
<a href="#l15.497"></a><span id="l15.497" class="difflineplus">+        continue;</span>
<a href="#l15.498"></a><span id="l15.498" class="difflineplus">+      }</span>
<a href="#l15.499"></a><span id="l15.499" class="difflineplus">+      this.target.sendMsg(om.message);</span>
<a href="#l15.500"></a><span id="l15.500" class="difflineplus">+    }</span>
<a href="#l15.501"></a><span id="l15.501" class="difflineplus">+  },</span>
<a href="#l15.502"></a><span id="l15.502" class="difflineplus">+  unInit() {</span>
<a href="#l15.503"></a><span id="l15.503" class="difflineplus">+    for (let id in this._prplConv) {</span>
<a href="#l15.504"></a><span id="l15.504" class="difflineplus">+      let conv = this._prplConv[id];</span>
<a href="#l15.505"></a><span id="l15.505" class="difflineplus">+      gConversationsService.forgetConversation(conv);</span>
<a href="#l15.506"></a><span id="l15.506" class="difflineplus">+    }</span>
<a href="#l15.507"></a><span id="l15.507" class="difflineplus">+    if (this._observedContact) {</span>
<a href="#l15.508"></a><span id="l15.508" class="difflineplus">+      this._observedContact.removeObserver(this);</span>
<a href="#l15.509"></a><span id="l15.509" class="difflineplus">+      delete this._observedContact;</span>
<a href="#l15.510"></a><span id="l15.510" class="difflineplus">+    }</span>
<a href="#l15.511"></a><span id="l15.511" class="difflineplus">+    this._prplConv = {}; // Prevent .close from failing.</span>
<a href="#l15.512"></a><span id="l15.512" class="difflineplus">+    delete this._currentTargetId;</span>
<a href="#l15.513"></a><span id="l15.513" class="difflineplus">+    this.notifyObservers(this, &quot;ui-conversation-destroyed&quot;);</span>
<a href="#l15.514"></a><span id="l15.514" class="difflineplus">+  },</span>
<a href="#l15.515"></a><span id="l15.515" class="difflineplus">+  close() {</span>
<a href="#l15.516"></a><span id="l15.516" class="difflineplus">+    for (let id in this._prplConv) {</span>
<a href="#l15.517"></a><span id="l15.517" class="difflineplus">+      let conv = this._prplConv[id];</span>
<a href="#l15.518"></a><span id="l15.518" class="difflineplus">+      conv.close();</span>
<a href="#l15.519"></a><span id="l15.519" class="difflineplus">+    }</span>
<a href="#l15.520"></a><span id="l15.520" class="difflineplus">+    if (!this.hasOwnProperty(&quot;_currentTargetId&quot;)) {</span>
<a href="#l15.521"></a><span id="l15.521" class="difflineplus">+      return;</span>
<a href="#l15.522"></a><span id="l15.522" class="difflineplus">+    }</span>
<a href="#l15.523"></a><span id="l15.523" class="difflineplus">+    delete this._currentTargetId;</span>
<a href="#l15.524"></a><span id="l15.524" class="difflineplus">+    this.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l15.525"></a><span id="l15.525" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;ui-conversation-closed&quot;);</span>
<a href="#l15.526"></a><span id="l15.526" class="difflineplus">+  },</span>
<a href="#l15.527"></a><span id="l15.527" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l15.528"></a><span id="l15.528" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l15.529"></a><span id="l15.529" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l15.530"></a><span id="l15.530" class="difflineplus">+    }</span>
<a href="#l15.531"></a><span id="l15.531" class="difflineplus">+  },</span>
<a href="#l15.532"></a><span id="l15.532" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l15.533"></a><span id="l15.533" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l15.534"></a><span id="l15.534" class="difflineplus">+  },</span>
<a href="#l15.535"></a><span id="l15.535" class="difflineplus">+  notifyObservers(aSubject, aTopic, aData) {</span>
<a href="#l15.536"></a><span id="l15.536" class="difflineplus">+    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l15.537"></a><span id="l15.537" class="difflineplus">+      aSubject = new imMessage(aSubject);</span>
<a href="#l15.538"></a><span id="l15.538" class="difflineplus">+      this.notifyObservers(aSubject, &quot;received-message&quot;);</span>
<a href="#l15.539"></a><span id="l15.539" class="difflineplus">+      if (aSubject.cancelled) {</span>
<a href="#l15.540"></a><span id="l15.540" class="difflineplus">+        return;</span>
<a href="#l15.541"></a><span id="l15.541" class="difflineplus">+      }</span>
<a href="#l15.542"></a><span id="l15.542" class="difflineplus">+      if (!aSubject.system) {</span>
<a href="#l15.543"></a><span id="l15.543" class="difflineplus">+        aSubject.conversation.prepareForDisplaying(aSubject);</span>
<a href="#l15.544"></a><span id="l15.544" class="difflineplus">+      }</span>
<a href="#l15.545"></a><span id="l15.545" class="difflineplus">+</span>
<a href="#l15.546"></a><span id="l15.546" class="difflineplus">+      this._messages.push(aSubject);</span>
<a href="#l15.547"></a><span id="l15.547" class="difflineplus">+      ++this._unreadMessageCount;</span>
<a href="#l15.548"></a><span id="l15.548" class="difflineplus">+      if (aSubject.incoming &amp;&amp; !aSubject.system) {</span>
<a href="#l15.549"></a><span id="l15.549" class="difflineplus">+        ++this._unreadIncomingMessageCount;</span>
<a href="#l15.550"></a><span id="l15.550" class="difflineplus">+        if (!this.isChat || aSubject.containsNick) {</span>
<a href="#l15.551"></a><span id="l15.551" class="difflineplus">+          ++this._unreadTargetedMessageCount;</span>
<a href="#l15.552"></a><span id="l15.552" class="difflineplus">+        }</span>
<a href="#l15.553"></a><span id="l15.553" class="difflineplus">+      }</span>
<a href="#l15.554"></a><span id="l15.554" class="difflineplus">+    }</span>
<a href="#l15.555"></a><span id="l15.555" class="difflineplus">+</span>
<a href="#l15.556"></a><span id="l15.556" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l15.557"></a><span id="l15.557" class="difflineplus">+      if (!observer.observe &amp;&amp; !this._observers.includes(observer)) {</span>
<a href="#l15.558"></a><span id="l15.558" class="difflineplus">+        // Observer removed by a previous call to another observer.</span>
<a href="#l15.559"></a><span id="l15.559" class="difflineplus">+        continue;</span>
<a href="#l15.560"></a><span id="l15.560" class="difflineplus">+      }</span>
<a href="#l15.561"></a><span id="l15.561" class="difflineplus">+      observer.observe(aSubject, aTopic, aData);</span>
<a href="#l15.562"></a><span id="l15.562" class="difflineplus">+    }</span>
<a href="#l15.563"></a><span id="l15.563" class="difflineplus">+    this._notifyUnreadCountChanged();</span>
<a href="#l15.564"></a><span id="l15.564" class="difflineplus">+</span>
<a href="#l15.565"></a><span id="l15.565" class="difflineplus">+    if (aTopic == &quot;new-text&quot;) {</span>
<a href="#l15.566"></a><span id="l15.566" class="difflineplus">+      Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l15.567"></a><span id="l15.567" class="difflineplus">+      if (</span>
<a href="#l15.568"></a><span id="l15.568" class="difflineplus">+        aSubject.incoming &amp;&amp;</span>
<a href="#l15.569"></a><span id="l15.569" class="difflineplus">+        !aSubject.system &amp;&amp;</span>
<a href="#l15.570"></a><span id="l15.570" class="difflineplus">+        (!this.isChat || aSubject.containsNick)</span>
<a href="#l15.571"></a><span id="l15.571" class="difflineplus">+      ) {</span>
<a href="#l15.572"></a><span id="l15.572" class="difflineplus">+        this.notifyObservers(aSubject, &quot;new-directed-incoming-message&quot;, aData);</span>
<a href="#l15.573"></a><span id="l15.573" class="difflineplus">+        Services.obs.notifyObservers(</span>
<a href="#l15.574"></a><span id="l15.574" class="difflineplus">+          aSubject,</span>
<a href="#l15.575"></a><span id="l15.575" class="difflineplus">+          &quot;new-directed-incoming-message&quot;,</span>
<a href="#l15.576"></a><span id="l15.576" class="difflineplus">+          aData</span>
<a href="#l15.577"></a><span id="l15.577" class="difflineplus">+        );</span>
<a href="#l15.578"></a><span id="l15.578" class="difflineplus">+      }</span>
<a href="#l15.579"></a><span id="l15.579" class="difflineplus">+    }</span>
<a href="#l15.580"></a><span id="l15.580" class="difflineplus">+  },</span>
<a href="#l15.581"></a><span id="l15.581" class="difflineplus">+</span>
<a href="#l15.582"></a><span id="l15.582" class="difflineplus">+  // Used above when notifying of new-texts originating in the</span>
<a href="#l15.583"></a><span id="l15.583" class="difflineplus">+  // UIConversation. This happens when this.systemMessage() is called. The</span>
<a href="#l15.584"></a><span id="l15.584" class="difflineplus">+  // conversation for the message is set as the UIConversation.</span>
<a href="#l15.585"></a><span id="l15.585" class="difflineplus">+  prepareForDisplaying(aMsg) {},</span>
<a href="#l15.586"></a><span id="l15.586" class="difflineplus">+</span>
<a href="#l15.587"></a><span id="l15.587" class="difflineplus">+  // prplIConvIM</span>
<a href="#l15.588"></a><span id="l15.588" class="difflineplus">+  get buddy() {</span>
<a href="#l15.589"></a><span id="l15.589" class="difflineplus">+    return this.target.buddy;</span>
<a href="#l15.590"></a><span id="l15.590" class="difflineplus">+  },</span>
<a href="#l15.591"></a><span id="l15.591" class="difflineplus">+  get typingState() {</span>
<a href="#l15.592"></a><span id="l15.592" class="difflineplus">+    return this.target.typingState;</span>
<a href="#l15.593"></a><span id="l15.593" class="difflineplus">+  },</span>
<a href="#l15.594"></a><span id="l15.594" class="difflineplus">+  sendTyping(aString) {</span>
<a href="#l15.595"></a><span id="l15.595" class="difflineplus">+    return this.target.sendTyping(aString);</span>
<a href="#l15.596"></a><span id="l15.596" class="difflineplus">+  },</span>
<a href="#l15.597"></a><span id="l15.597" class="difflineplus">+</span>
<a href="#l15.598"></a><span id="l15.598" class="difflineplus">+  // Chat only</span>
<a href="#l15.599"></a><span id="l15.599" class="difflineplus">+  getParticipants() {</span>
<a href="#l15.600"></a><span id="l15.600" class="difflineplus">+    return this.target.getParticipants();</span>
<a href="#l15.601"></a><span id="l15.601" class="difflineplus">+  },</span>
<a href="#l15.602"></a><span id="l15.602" class="difflineplus">+  get topic() {</span>
<a href="#l15.603"></a><span id="l15.603" class="difflineplus">+    return this.target.topic;</span>
<a href="#l15.604"></a><span id="l15.604" class="difflineplus">+  },</span>
<a href="#l15.605"></a><span id="l15.605" class="difflineplus">+  set topic(aTopic) {</span>
<a href="#l15.606"></a><span id="l15.606" class="difflineplus">+    this.target.topic = aTopic;</span>
<a href="#l15.607"></a><span id="l15.607" class="difflineplus">+  },</span>
<a href="#l15.608"></a><span id="l15.608" class="difflineplus">+  get topicSetter() {</span>
<a href="#l15.609"></a><span id="l15.609" class="difflineplus">+    return this.target.topicSetter;</span>
<a href="#l15.610"></a><span id="l15.610" class="difflineplus">+  },</span>
<a href="#l15.611"></a><span id="l15.611" class="difflineplus">+  get topicSettable() {</span>
<a href="#l15.612"></a><span id="l15.612" class="difflineplus">+    return this.target.topicSettable;</span>
<a href="#l15.613"></a><span id="l15.613" class="difflineplus">+  },</span>
<a href="#l15.614"></a><span id="l15.614" class="difflineplus">+  get noTopicString() {</span>
<a href="#l15.615"></a><span id="l15.615" class="difflineplus">+    return bundle.GetStringFromName(&quot;noTopic&quot;);</span>
<a href="#l15.616"></a><span id="l15.616" class="difflineplus">+  },</span>
<a href="#l15.617"></a><span id="l15.617" class="difflineplus">+  get nick() {</span>
<a href="#l15.618"></a><span id="l15.618" class="difflineplus">+    return this.target.nick;</span>
<a href="#l15.619"></a><span id="l15.619" class="difflineplus">+  },</span>
<a href="#l15.620"></a><span id="l15.620" class="difflineplus">+  get left() {</span>
<a href="#l15.621"></a><span id="l15.621" class="difflineplus">+    return this.target.left;</span>
<a href="#l15.622"></a><span id="l15.622" class="difflineplus">+  },</span>
<a href="#l15.623"></a><span id="l15.623" class="difflineplus">+  get joining() {</span>
<a href="#l15.624"></a><span id="l15.624" class="difflineplus">+    return this.target.joining;</span>
<a href="#l15.625"></a><span id="l15.625" class="difflineplus">+  },</span>
<a href="#l15.626"></a><span id="l15.626" class="difflineplus">+};</span>
<a href="#l15.627"></a><span id="l15.627" class="difflineplus">+</span>
<a href="#l15.628"></a><span id="l15.628" class="difflineplus">+var gConversationsService;</span>
<a href="#l15.629"></a><span id="l15.629" class="difflineplus">+function ConversationsService() {</span>
<a href="#l15.630"></a><span id="l15.630" class="difflineplus">+  gConversationsService = this;</span>
<a href="#l15.631"></a><span id="l15.631" class="difflineplus">+}</span>
<a href="#l15.632"></a><span id="l15.632" class="difflineplus">+ConversationsService.prototype = {</span>
<a href="#l15.633"></a><span id="l15.633" class="difflineplus">+  get wrappedJSObject() {</span>
<a href="#l15.634"></a><span id="l15.634" class="difflineplus">+    return this;</span>
<a href="#l15.635"></a><span id="l15.635" class="difflineplus">+  },</span>
<a href="#l15.636"></a><span id="l15.636" class="difflineplus">+</span>
<a href="#l15.637"></a><span id="l15.637" class="difflineplus">+  initConversations() {</span>
<a href="#l15.638"></a><span id="l15.638" class="difflineplus">+    this._uiConv = {};</span>
<a href="#l15.639"></a><span id="l15.639" class="difflineplus">+    this._uiConvByContactId = {};</span>
<a href="#l15.640"></a><span id="l15.640" class="difflineplus">+    this._prplConversations = [];</span>
<a href="#l15.641"></a><span id="l15.641" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l15.642"></a><span id="l15.642" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-connected&quot;);</span>
<a href="#l15.643"></a><span id="l15.643" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l15.644"></a><span id="l15.644" class="difflineplus">+    Services.obs.addObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l15.645"></a><span id="l15.645" class="difflineplus">+  },</span>
<a href="#l15.646"></a><span id="l15.646" class="difflineplus">+</span>
<a href="#l15.647"></a><span id="l15.647" class="difflineplus">+  unInitConversations() {</span>
<a href="#l15.648"></a><span id="l15.648" class="difflineplus">+    let UIConvs = this.getUIConversations();</span>
<a href="#l15.649"></a><span id="l15.649" class="difflineplus">+    for (let UIConv of UIConvs) {</span>
<a href="#l15.650"></a><span id="l15.650" class="difflineplus">+      UIConv.unInit();</span>
<a href="#l15.651"></a><span id="l15.651" class="difflineplus">+    }</span>
<a href="#l15.652"></a><span id="l15.652" class="difflineplus">+    delete this._uiConv;</span>
<a href="#l15.653"></a><span id="l15.653" class="difflineplus">+    delete this._uiConvByContactId;</span>
<a href="#l15.654"></a><span id="l15.654" class="difflineplus">+    // This should already be empty, but just to be sure...</span>
<a href="#l15.655"></a><span id="l15.655" class="difflineplus">+    for (let prplConv of this._prplConversations) {</span>
<a href="#l15.656"></a><span id="l15.656" class="difflineplus">+      prplConv.unInit();</span>
<a href="#l15.657"></a><span id="l15.657" class="difflineplus">+    }</span>
<a href="#l15.658"></a><span id="l15.658" class="difflineplus">+    delete this._prplConversations;</span>
<a href="#l15.659"></a><span id="l15.659" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-disconnecting&quot;);</span>
<a href="#l15.660"></a><span id="l15.660" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-connected&quot;);</span>
<a href="#l15.661"></a><span id="l15.661" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-buddy-added&quot;);</span>
<a href="#l15.662"></a><span id="l15.662" class="difflineplus">+    Services.obs.removeObserver(this, &quot;account-buddy-removed&quot;);</span>
<a href="#l15.663"></a><span id="l15.663" class="difflineplus">+  },</span>
<a href="#l15.664"></a><span id="l15.664" class="difflineplus">+</span>
<a href="#l15.665"></a><span id="l15.665" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l15.666"></a><span id="l15.666" class="difflineplus">+    if (aTopic == &quot;account-connected&quot;) {</span>
<a href="#l15.667"></a><span id="l15.667" class="difflineplus">+      for (let id in this._uiConv) {</span>
<a href="#l15.668"></a><span id="l15.668" class="difflineplus">+        let conv = this._uiConv[id];</span>
<a href="#l15.669"></a><span id="l15.669" class="difflineplus">+        if (conv.account.id == aSubject.id) {</span>
<a href="#l15.670"></a><span id="l15.670" class="difflineplus">+          conv.connected();</span>
<a href="#l15.671"></a><span id="l15.671" class="difflineplus">+        }</span>
<a href="#l15.672"></a><span id="l15.672" class="difflineplus">+      }</span>
<a href="#l15.673"></a><span id="l15.673" class="difflineplus">+    } else if (aTopic == &quot;account-disconnecting&quot;) {</span>
<a href="#l15.674"></a><span id="l15.674" class="difflineplus">+      for (let id in this._uiConv) {</span>
<a href="#l15.675"></a><span id="l15.675" class="difflineplus">+        let conv = this._uiConv[id];</span>
<a href="#l15.676"></a><span id="l15.676" class="difflineplus">+        if (conv.account.id == aSubject.id) {</span>
<a href="#l15.677"></a><span id="l15.677" class="difflineplus">+          conv.disconnecting();</span>
<a href="#l15.678"></a><span id="l15.678" class="difflineplus">+        }</span>
<a href="#l15.679"></a><span id="l15.679" class="difflineplus">+      }</span>
<a href="#l15.680"></a><span id="l15.680" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-added&quot;) {</span>
<a href="#l15.681"></a><span id="l15.681" class="difflineplus">+      let accountBuddy = aSubject;</span>
<a href="#l15.682"></a><span id="l15.682" class="difflineplus">+      let prplConversation = this.getConversationByNameAndAccount(</span>
<a href="#l15.683"></a><span id="l15.683" class="difflineplus">+        accountBuddy.normalizedName,</span>
<a href="#l15.684"></a><span id="l15.684" class="difflineplus">+        accountBuddy.account,</span>
<a href="#l15.685"></a><span id="l15.685" class="difflineplus">+        false</span>
<a href="#l15.686"></a><span id="l15.686" class="difflineplus">+      );</span>
<a href="#l15.687"></a><span id="l15.687" class="difflineplus">+      if (!prplConversation) {</span>
<a href="#l15.688"></a><span id="l15.688" class="difflineplus">+        return;</span>
<a href="#l15.689"></a><span id="l15.689" class="difflineplus">+      }</span>
<a href="#l15.690"></a><span id="l15.690" class="difflineplus">+</span>
<a href="#l15.691"></a><span id="l15.691" class="difflineplus">+      let uiConv = this.getUIConversation(prplConversation);</span>
<a href="#l15.692"></a><span id="l15.692" class="difflineplus">+      let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l15.693"></a><span id="l15.693" class="difflineplus">+      if (contactId in this._uiConvByContactId) {</span>
<a href="#l15.694"></a><span id="l15.694" class="difflineplus">+        // Trouble! There is an existing uiConv for this contact.</span>
<a href="#l15.695"></a><span id="l15.695" class="difflineplus">+        // We should avoid having two uiConvs with the same contact.</span>
<a href="#l15.696"></a><span id="l15.696" class="difflineplus">+        // This is ugly UX, but at least can only happen if there is</span>
<a href="#l15.697"></a><span id="l15.697" class="difflineplus">+        // already an accountBuddy with the same name for the same</span>
<a href="#l15.698"></a><span id="l15.698" class="difflineplus">+        // protocol on a different account, which should be rare.</span>
<a href="#l15.699"></a><span id="l15.699" class="difflineplus">+        this.removeConversation(prplConversation);</span>
<a href="#l15.700"></a><span id="l15.700" class="difflineplus">+        return;</span>
<a href="#l15.701"></a><span id="l15.701" class="difflineplus">+      }</span>
<a href="#l15.702"></a><span id="l15.702" class="difflineplus">+      // Link the existing uiConv to the contact.</span>
<a href="#l15.703"></a><span id="l15.703" class="difflineplus">+      this._uiConvByContactId[contactId] = uiConv;</span>
<a href="#l15.704"></a><span id="l15.704" class="difflineplus">+      uiConv.updateContactObserver();</span>
<a href="#l15.705"></a><span id="l15.705" class="difflineplus">+      uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l15.706"></a><span id="l15.706" class="difflineplus">+    } else if (aTopic == &quot;account-buddy-removed&quot;) {</span>
<a href="#l15.707"></a><span id="l15.707" class="difflineplus">+      let accountBuddy = aSubject;</span>
<a href="#l15.708"></a><span id="l15.708" class="difflineplus">+      let contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l15.709"></a><span id="l15.709" class="difflineplus">+      if (!(contactId in this._uiConvByContactId)) {</span>
<a href="#l15.710"></a><span id="l15.710" class="difflineplus">+        return;</span>
<a href="#l15.711"></a><span id="l15.711" class="difflineplus">+      }</span>
<a href="#l15.712"></a><span id="l15.712" class="difflineplus">+      let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l15.713"></a><span id="l15.713" class="difflineplus">+</span>
<a href="#l15.714"></a><span id="l15.714" class="difflineplus">+      // If there is more than one target on the uiConv, close the</span>
<a href="#l15.715"></a><span id="l15.715" class="difflineplus">+      // prplConv as we can't dissociate the uiConv from the contact.</span>
<a href="#l15.716"></a><span id="l15.716" class="difflineplus">+      // The conversation with the contact will continue with a different</span>
<a href="#l15.717"></a><span id="l15.717" class="difflineplus">+      // target.</span>
<a href="#l15.718"></a><span id="l15.718" class="difflineplus">+      if (uiConv.hasMultipleTargets) {</span>
<a href="#l15.719"></a><span id="l15.719" class="difflineplus">+        let prplConversation = uiConv.getTargetByAccount(accountBuddy.account);</span>
<a href="#l15.720"></a><span id="l15.720" class="difflineplus">+        if (prplConversation) {</span>
<a href="#l15.721"></a><span id="l15.721" class="difflineplus">+          this.removeConversation(prplConversation);</span>
<a href="#l15.722"></a><span id="l15.722" class="difflineplus">+        }</span>
<a href="#l15.723"></a><span id="l15.723" class="difflineplus">+        return;</span>
<a href="#l15.724"></a><span id="l15.724" class="difflineplus">+      }</span>
<a href="#l15.725"></a><span id="l15.725" class="difflineplus">+</span>
<a href="#l15.726"></a><span id="l15.726" class="difflineplus">+      delete this._uiConvByContactId[contactId];</span>
<a href="#l15.727"></a><span id="l15.727" class="difflineplus">+      uiConv.updateContactObserver();</span>
<a href="#l15.728"></a><span id="l15.728" class="difflineplus">+      uiConv.notifyObservers(uiConv, &quot;update-conv-buddy&quot;);</span>
<a href="#l15.729"></a><span id="l15.729" class="difflineplus">+    }</span>
<a href="#l15.730"></a><span id="l15.730" class="difflineplus">+  },</span>
<a href="#l15.731"></a><span id="l15.731" class="difflineplus">+</span>
<a href="#l15.732"></a><span id="l15.732" class="difflineplus">+  addConversation(aPrplConversation) {</span>
<a href="#l15.733"></a><span id="l15.733" class="difflineplus">+    // Give an id to the new conversation.</span>
<a href="#l15.734"></a><span id="l15.734" class="difflineplus">+    aPrplConversation.id = ++gLastPrplConvId;</span>
<a href="#l15.735"></a><span id="l15.735" class="difflineplus">+    this._prplConversations.push(aPrplConversation);</span>
<a href="#l15.736"></a><span id="l15.736" class="difflineplus">+</span>
<a href="#l15.737"></a><span id="l15.737" class="difflineplus">+    // Notify observers.</span>
<a href="#l15.738"></a><span id="l15.738" class="difflineplus">+    Services.obs.notifyObservers(aPrplConversation, &quot;new-conversation&quot;);</span>
<a href="#l15.739"></a><span id="l15.739" class="difflineplus">+</span>
<a href="#l15.740"></a><span id="l15.740" class="difflineplus">+    // Update or create the corresponding UI conversation.</span>
<a href="#l15.741"></a><span id="l15.741" class="difflineplus">+    let contactId;</span>
<a href="#l15.742"></a><span id="l15.742" class="difflineplus">+    if (!aPrplConversation.isChat) {</span>
<a href="#l15.743"></a><span id="l15.743" class="difflineplus">+      let accountBuddy = aPrplConversation.buddy;</span>
<a href="#l15.744"></a><span id="l15.744" class="difflineplus">+      if (accountBuddy) {</span>
<a href="#l15.745"></a><span id="l15.745" class="difflineplus">+        contactId = accountBuddy.buddy.contact.id;</span>
<a href="#l15.746"></a><span id="l15.746" class="difflineplus">+      }</span>
<a href="#l15.747"></a><span id="l15.747" class="difflineplus">+    }</span>
<a href="#l15.748"></a><span id="l15.748" class="difflineplus">+</span>
<a href="#l15.749"></a><span id="l15.749" class="difflineplus">+    if (contactId) {</span>
<a href="#l15.750"></a><span id="l15.750" class="difflineplus">+      if (contactId in this._uiConvByContactId) {</span>
<a href="#l15.751"></a><span id="l15.751" class="difflineplus">+        let uiConv = this._uiConvByContactId[contactId];</span>
<a href="#l15.752"></a><span id="l15.752" class="difflineplus">+        uiConv.target = aPrplConversation;</span>
<a href="#l15.753"></a><span id="l15.753" class="difflineplus">+        this._uiConv[aPrplConversation.id] = uiConv;</span>
<a href="#l15.754"></a><span id="l15.754" class="difflineplus">+        return;</span>
<a href="#l15.755"></a><span id="l15.755" class="difflineplus">+      }</span>
<a href="#l15.756"></a><span id="l15.756" class="difflineplus">+    }</span>
<a href="#l15.757"></a><span id="l15.757" class="difflineplus">+</span>
<a href="#l15.758"></a><span id="l15.758" class="difflineplus">+    let newUIConv = new UIConversation(aPrplConversation);</span>
<a href="#l15.759"></a><span id="l15.759" class="difflineplus">+    this._uiConv[aPrplConversation.id] = newUIConv;</span>
<a href="#l15.760"></a><span id="l15.760" class="difflineplus">+    if (contactId) {</span>
<a href="#l15.761"></a><span id="l15.761" class="difflineplus">+      this._uiConvByContactId[contactId] = newUIConv;</span>
<a href="#l15.762"></a><span id="l15.762" class="difflineplus">+    }</span>
<a href="#l15.763"></a><span id="l15.763" class="difflineplus">+  },</span>
<a href="#l15.764"></a><span id="l15.764" class="difflineplus">+  removeConversation(aPrplConversation) {</span>
<a href="#l15.765"></a><span id="l15.765" class="difflineplus">+    Services.obs.notifyObservers(aPrplConversation, &quot;conversation-closed&quot;);</span>
<a href="#l15.766"></a><span id="l15.766" class="difflineplus">+</span>
<a href="#l15.767"></a><span id="l15.767" class="difflineplus">+    let uiConv = this.getUIConversation(aPrplConversation);</span>
<a href="#l15.768"></a><span id="l15.768" class="difflineplus">+    delete this._uiConv[aPrplConversation.id];</span>
<a href="#l15.769"></a><span id="l15.769" class="difflineplus">+    let contactId = {};</span>
<a href="#l15.770"></a><span id="l15.770" class="difflineplus">+    if (uiConv.removeTarget(aPrplConversation, contactId)) {</span>
<a href="#l15.771"></a><span id="l15.771" class="difflineplus">+      if (contactId.value) {</span>
<a href="#l15.772"></a><span id="l15.772" class="difflineplus">+        delete this._uiConvByContactId[contactId.value];</span>
<a href="#l15.773"></a><span id="l15.773" class="difflineplus">+      }</span>
<a href="#l15.774"></a><span id="l15.774" class="difflineplus">+      Services.obs.notifyObservers(uiConv, &quot;ui-conversation-closed&quot;);</span>
<a href="#l15.775"></a><span id="l15.775" class="difflineplus">+    }</span>
<a href="#l15.776"></a><span id="l15.776" class="difflineplus">+    this.forgetConversation(aPrplConversation);</span>
<a href="#l15.777"></a><span id="l15.777" class="difflineplus">+  },</span>
<a href="#l15.778"></a><span id="l15.778" class="difflineplus">+  forgetConversation(aPrplConversation) {</span>
<a href="#l15.779"></a><span id="l15.779" class="difflineplus">+    aPrplConversation.unInit();</span>
<a href="#l15.780"></a><span id="l15.780" class="difflineplus">+</span>
<a href="#l15.781"></a><span id="l15.781" class="difflineplus">+    this._prplConversations = this._prplConversations.filter(</span>
<a href="#l15.782"></a><span id="l15.782" class="difflineplus">+      c =&gt; c !== aPrplConversation</span>
<a href="#l15.783"></a><span id="l15.783" class="difflineplus">+    );</span>
<a href="#l15.784"></a><span id="l15.784" class="difflineplus">+  },</span>
<a href="#l15.785"></a><span id="l15.785" class="difflineplus">+</span>
<a href="#l15.786"></a><span id="l15.786" class="difflineplus">+  getUIConversations() {</span>
<a href="#l15.787"></a><span id="l15.787" class="difflineplus">+    let rv = [];</span>
<a href="#l15.788"></a><span id="l15.788" class="difflineplus">+    if (this._uiConv) {</span>
<a href="#l15.789"></a><span id="l15.789" class="difflineplus">+      for (let prplConvId in this._uiConv) {</span>
<a href="#l15.790"></a><span id="l15.790" class="difflineplus">+        // Since an UIConversation may be linked to multiple prplConversations,</span>
<a href="#l15.791"></a><span id="l15.791" class="difflineplus">+        // we must ensure we don't return the same UIConversation twice,</span>
<a href="#l15.792"></a><span id="l15.792" class="difflineplus">+        // by checking the id matches that of the active prplConversation.</span>
<a href="#l15.793"></a><span id="l15.793" class="difflineplus">+        let uiConv = this._uiConv[prplConvId];</span>
<a href="#l15.794"></a><span id="l15.794" class="difflineplus">+        if (prplConvId == uiConv.target.id) {</span>
<a href="#l15.795"></a><span id="l15.795" class="difflineplus">+          rv.push(uiConv);</span>
<a href="#l15.796"></a><span id="l15.796" class="difflineplus">+        }</span>
<a href="#l15.797"></a><span id="l15.797" class="difflineplus">+      }</span>
<a href="#l15.798"></a><span id="l15.798" class="difflineplus">+    }</span>
<a href="#l15.799"></a><span id="l15.799" class="difflineplus">+    return rv;</span>
<a href="#l15.800"></a><span id="l15.800" class="difflineplus">+  },</span>
<a href="#l15.801"></a><span id="l15.801" class="difflineplus">+  getUIConversation(aPrplConversation) {</span>
<a href="#l15.802"></a><span id="l15.802" class="difflineplus">+    let id = aPrplConversation.id;</span>
<a href="#l15.803"></a><span id="l15.803" class="difflineplus">+    if (this._uiConv &amp;&amp; id in this._uiConv) {</span>
<a href="#l15.804"></a><span id="l15.804" class="difflineplus">+      return this._uiConv[id];</span>
<a href="#l15.805"></a><span id="l15.805" class="difflineplus">+    }</span>
<a href="#l15.806"></a><span id="l15.806" class="difflineplus">+    throw new Error(&quot;Unknown conversation&quot;);</span>
<a href="#l15.807"></a><span id="l15.807" class="difflineplus">+  },</span>
<a href="#l15.808"></a><span id="l15.808" class="difflineplus">+  getUIConversationByContactId(aId) {</span>
<a href="#l15.809"></a><span id="l15.809" class="difflineplus">+    return aId in this._uiConvByContactId ? this._uiConvByContactId[aId] : null;</span>
<a href="#l15.810"></a><span id="l15.810" class="difflineplus">+  },</span>
<a href="#l15.811"></a><span id="l15.811" class="difflineplus">+</span>
<a href="#l15.812"></a><span id="l15.812" class="difflineplus">+  getConversations() {</span>
<a href="#l15.813"></a><span id="l15.813" class="difflineplus">+    return new nsSimpleEnumerator(this._prplConversations);</span>
<a href="#l15.814"></a><span id="l15.814" class="difflineplus">+  },</span>
<a href="#l15.815"></a><span id="l15.815" class="difflineplus">+  getConversationById(aId) {</span>
<a href="#l15.816"></a><span id="l15.816" class="difflineplus">+    for (let conv of this._prplConversations) {</span>
<a href="#l15.817"></a><span id="l15.817" class="difflineplus">+      if (conv.id == aId) {</span>
<a href="#l15.818"></a><span id="l15.818" class="difflineplus">+        return conv;</span>
<a href="#l15.819"></a><span id="l15.819" class="difflineplus">+      }</span>
<a href="#l15.820"></a><span id="l15.820" class="difflineplus">+    }</span>
<a href="#l15.821"></a><span id="l15.821" class="difflineplus">+    return null;</span>
<a href="#l15.822"></a><span id="l15.822" class="difflineplus">+  },</span>
<a href="#l15.823"></a><span id="l15.823" class="difflineplus">+  getConversationByNameAndAccount(aName, aAccount, aIsChat) {</span>
<a href="#l15.824"></a><span id="l15.824" class="difflineplus">+    let normalizedName = aAccount.normalize(aName);</span>
<a href="#l15.825"></a><span id="l15.825" class="difflineplus">+    for (let conv of this._prplConversations) {</span>
<a href="#l15.826"></a><span id="l15.826" class="difflineplus">+      if (</span>
<a href="#l15.827"></a><span id="l15.827" class="difflineplus">+        aAccount.normalize(conv.name) == normalizedName &amp;&amp;</span>
<a href="#l15.828"></a><span id="l15.828" class="difflineplus">+        aAccount.numericId == conv.account.numericId &amp;&amp;</span>
<a href="#l15.829"></a><span id="l15.829" class="difflineplus">+        conv.isChat == aIsChat</span>
<a href="#l15.830"></a><span id="l15.830" class="difflineplus">+      ) {</span>
<a href="#l15.831"></a><span id="l15.831" class="difflineplus">+        return conv;</span>
<a href="#l15.832"></a><span id="l15.832" class="difflineplus">+      }</span>
<a href="#l15.833"></a><span id="l15.833" class="difflineplus">+    }</span>
<a href="#l15.834"></a><span id="l15.834" class="difflineplus">+    return null;</span>
<a href="#l15.835"></a><span id="l15.835" class="difflineplus">+  },</span>
<a href="#l15.836"></a><span id="l15.836" class="difflineplus">+</span>
<a href="#l15.837"></a><span id="l15.837" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imIConversationsService]),</span>
<a href="#l15.838"></a><span id="l15.838" class="difflineplus">+  classDescription: &quot;Conversations&quot;,</span>
<a href="#l15.839"></a><span id="l15.839" class="difflineplus">+  classID: Components.ID(&quot;{b2397cd5-c76d-4618-8410-f344c7c6443a}&quot;),</span>
<a href="#l15.840"></a><span id="l15.840" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/conversations-service;1&quot;,</span>
<a href="#l15.841"></a><span id="l15.841" class="difflineplus">+};</span>
<a href="#l15.842"></a><span id="l15.842" class="difflineplus">+</span>
<a href="#l15.843"></a><span id="l15.843" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([ConversationsService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/chat/components/src/imConversations.manifest</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+component {b2397cd5-c76d-4618-8410-f344c7c6443a} imConversations.js</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+contract @mozilla.org/chat/conversations-service;1 {b2397cd5-c76d-4618-8410-f344c7c6443a}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/chat/components/src/imCore.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,420 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+var {</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+  ClassInfo,</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+  initLogModule,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+  nsSimpleEnumerator,</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+XPCOMUtils.defineLazyServiceGetter(</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+  this,</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+  &quot;categoryManager&quot;,</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  &quot;@mozilla.org/categorymanager;1&quot;,</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  &quot;nsICategoryManager&quot;</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+var kQuitApplicationGranted = &quot;quit-application-granted&quot;;</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+var kProtocolPluginCategory = &quot;im-protocol-plugin&quot;;</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+var kPrefReportIdle = &quot;messenger.status.reportIdle&quot;;</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+var kPrefUserIconFilename = &quot;messenger.status.userIconFileName&quot;;</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+var kPrefUserDisplayname = &quot;messenger.status.userDisplayName&quot;;</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+var kPrefTimeBeforeIdle = &quot;messenger.status.timeBeforeIdle&quot;;</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+var kPrefAwayWhenIdle = &quot;messenger.status.awayWhenIdle&quot;;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+var kPrefDefaultMessage = &quot;messenger.status.defaultIdleAwayMessage&quot;;</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+var NS_IOSERVICE_GOING_OFFLINE_TOPIC = &quot;network:offline-about-to-go-offline&quot;;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+var NS_IOSERVICE_OFFLINE_STATUS_TOPIC = &quot;network:offline-status-changed&quot;;</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+function UserStatus() {</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  this._observers = [];</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+  if (Services.prefs.getBoolPref(kPrefReportIdle)) {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+    this._addIdleObserver();</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  }</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+  Services.prefs.addObserver(kPrefReportIdle, this);</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+  if (Services.io.offline) {</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+    this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  }</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+  Services.obs.addObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+  Services.obs.addObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+}</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+UserStatus.prototype = {</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+  __proto__: ClassInfo(&quot;imIUserStatusInfo&quot;, &quot;User status info&quot;),</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+  unInit() {</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+    this._observers = [];</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+    Services.prefs.removeObserver(kPrefReportIdle, this);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    if (this._observingIdleness) {</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+      this._removeIdleObserver();</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+    }</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    Services.obs.removeObserver(this, NS_IOSERVICE_GOING_OFFLINE_TOPIC);</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+    Services.obs.removeObserver(this, NS_IOSERVICE_OFFLINE_STATUS_TOPIC);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+  },</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+  _observingIdleness: false,</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+  _addIdleObserver() {</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+    this._observingIdleness = true;</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+    this._idleService = Cc[&quot;@mozilla.org/widget/idleservice;1&quot;].getService(</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+      Ci.nsIIdleService</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+    );</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+    Services.obs.addObserver(this, &quot;im-sent&quot;);</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    this._timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+    if (this._timeBeforeIdle &lt; 0) {</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+      this._timeBeforeIdle = 0;</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    }</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+    Services.prefs.addObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+    if (this._timeBeforeIdle) {</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+      this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+    }</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  },</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  _removeIdleObserver() {</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+    if (this._timeBeforeIdle) {</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+      this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+    }</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+    Services.prefs.removeObserver(kPrefTimeBeforeIdle, this);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+    delete this._timeBeforeIdle;</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+    Services.obs.removeObserver(this, &quot;im-sent&quot;);</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+    delete this._idleService;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+    delete this._observingIdleness;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  },</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+      if (aData == kPrefReportIdle) {</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+        let reportIdle = Services.prefs.getBoolPref(kPrefReportIdle);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+        if (reportIdle &amp;&amp; !this._observingIdleness) {</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+          this._addIdleObserver();</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+        } else if (!reportIdle &amp;&amp; this._observingIdleness) {</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+          this._removeIdleObserver();</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+        }</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+      } else if (aData == kPrefTimeBeforeIdle) {</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+        let timeBeforeIdle = Services.prefs.getIntPref(kPrefTimeBeforeIdle);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+        if (timeBeforeIdle != this._timeBeforeIdle) {</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+          if (this._timeBeforeIdle) {</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+            this._idleService.removeIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+          }</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+          this._timeBeforeIdle = timeBeforeIdle;</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+          if (this._timeBeforeIdle) {</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+            this._idleService.addIdleObserver(this, this._timeBeforeIdle);</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+          }</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+        }</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+      } else {</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+        throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+      }</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+    } else if (aTopic == NS_IOSERVICE_GOING_OFFLINE_TOPIC) {</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+      this.offline = true;</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+    } else if (</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+      aTopic == NS_IOSERVICE_OFFLINE_STATUS_TOPIC &amp;&amp;</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+      aData == &quot;online&quot;</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+    ) {</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+      this.offline = false;</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+    } else {</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+      this._checkIdle();</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+    }</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+  },</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+  _offlineStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+  set offline(aOffline) {</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+    let statusType = this.statusType;</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+    let statusText = this.statusText;</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+    if (aOffline) {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+      this._offlineStatusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+    } else {</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+      delete this._offlineStatusType;</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    }</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    }</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+  },</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+  _idleTime: 0,</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  get idleTime() {</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+    return this._idleTime;</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  },</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+  set idleTime(aIdleTime) {</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+    this._idleTime = aIdleTime;</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+    this._notifyObservers(&quot;idle-time-changed&quot;, aIdleTime);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+  },</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+  _idle: false,</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+  _idleStatusText: &quot;&quot;,</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+  _idleStatusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+  _checkIdle() {</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+    let idleTime = Math.floor(this._idleService.idleTime / 1000);</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+    let idle = this._timeBeforeIdle &amp;&amp; idleTime &gt;= this._timeBeforeIdle;</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+    if (idle == this._idle) {</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+      return;</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+    }</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+    let statusType = this.statusType;</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+    let statusText = this.statusText;</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+    this._idle = idle;</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+    if (idle) {</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+      this.idleTime = idleTime;</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+      if (Services.prefs.getBoolPref(kPrefAwayWhenIdle)) {</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+        this._idleStatusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+        this._idleStatusText = Services.prefs.getComplexValue(</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+          kPrefDefaultMessage,</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+          Ci.nsIPrefLocalizedString</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+        ).data;</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+      }</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    } else {</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+      this.idleTime = 0;</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+      delete this._idleStatusType;</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      delete this._idleStatusText;</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    }</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+    if (this.statusType != statusType || this.statusText != statusText) {</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+      this._notifyObservers(&quot;status-changed&quot;, this.statusText);</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+    }</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+  },</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+  _statusText: &quot;&quot;,</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+  get statusText() {</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+    return this._statusText || this._idleStatusText;</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+  },</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+  _statusType: Ci.imIStatusInfo.STATUS_AVAILABLE,</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+  get statusType() {</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+    return Math.min(</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+      this._statusType,</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+      this._idleStatusType,</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+      this._offlineStatusType</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+    );</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+  },</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+  setStatus(aStatus, aMessage) {</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_UNKNOWN) {</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+      this._statusType = aStatus;</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+    }</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+    if (aStatus != Ci.imIStatusInfo.STATUS_OFFLINE) {</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+      this._statusText = aMessage;</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+    }</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+    this._notifyObservers(&quot;status-changed&quot;, aMessage);</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+  },</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+  _getProfileDir: () =&gt; Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile),</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+  setUserIcon(aIconFile) {</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+    let folder = this._getProfileDir();</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+    let newName = &quot;&quot;;</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+    if (aIconFile) {</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+      // Get the extension (remove trailing dots - invalid Windows extension).</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+      let ext = aIconFile.leafName.replace(/.*(\.[a-z0-9]+)\.*/i, &quot;$1&quot;);</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+      // newName = userIcon-&lt;timestamp(now)&gt;.&lt;aIconFile.extension&gt;</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+      newName = &quot;userIcon-&quot; + Math.floor(Date.now() / 1000) + ext;</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+      // Copy the new icon file to newName in the profile folder.</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+      aIconFile.copyTo(folder, newName);</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+    }</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+    // Get the previous file name before saving the new file name.</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+    let oldFileName = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+    Services.prefs.setCharPref(kPrefUserIconFilename, newName);</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+    // Now that the new icon has been copied to the profile directory</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    // and the pref value changed, we can remove the old icon. Ignore</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+    // failures so that we always fire the user-icon-changed notification.</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+    try {</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+      if (oldFileName) {</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+        folder.append(oldFileName);</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+        if (folder.exists()) {</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+          folder.remove(false);</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+        }</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+      }</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+      Cu.reportError(e);</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+    }</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+    this._notifyObservers(&quot;user-icon-changed&quot;, newName);</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+  },</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+  getUserIcon() {</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+    let filename = Services.prefs.getCharPref(kPrefUserIconFilename);</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+    if (!filename) {</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+      // No icon has been set.</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+      return null;</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+    }</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+    let file = this._getProfileDir();</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+    file.append(filename);</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+    if (!file.exists()) {</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+      Services.console.logStringMessage(&quot;Invalid userIconFileName preference&quot;);</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+      return null;</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    }</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+    return Services.io.newFileURI(file);</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+  },</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+  get displayName() {</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+    return Services.prefs.getStringPref(kPrefUserDisplayname);</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+  },</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+  set displayName(aDisplayName) {</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+    Services.prefs.setStringPref(kPrefUserDisplayname, aDisplayName);</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+    this._notifyObservers(&quot;user-display-name-changed&quot;, aDisplayName);</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+  },</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+    if (!this._observers.includes(aObserver)) {</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+      this._observers.push(aObserver);</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+    }</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+  },</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+    this._observers = this._observers.filter(o =&gt; o !== aObserver);</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+  },</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+  _notifyObservers(aTopic, aData) {</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+    for (let observer of this._observers) {</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+      observer.observe(this, aTopic, aData);</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+    }</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+  },</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+};</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+var gCoreService;</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+function CoreService() {</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+  gCoreService = this;</span>
<a href="#l17.283"></a><span id="l17.283" class="difflineplus">+}</span>
<a href="#l17.284"></a><span id="l17.284" class="difflineplus">+CoreService.prototype = {</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineplus">+  globalUserStatus: null,</span>
<a href="#l17.286"></a><span id="l17.286" class="difflineplus">+</span>
<a href="#l17.287"></a><span id="l17.287" class="difflineplus">+  _initialized: false,</span>
<a href="#l17.288"></a><span id="l17.288" class="difflineplus">+  get initialized() {</span>
<a href="#l17.289"></a><span id="l17.289" class="difflineplus">+    return this._initialized;</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+  },</span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+  init() {</span>
<a href="#l17.292"></a><span id="l17.292" class="difflineplus">+    if (this._initialized) {</span>
<a href="#l17.293"></a><span id="l17.293" class="difflineplus">+      return;</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineplus">+    }</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+</span>
<a href="#l17.296"></a><span id="l17.296" class="difflineplus">+    initLogModule(&quot;core&quot;, this);</span>
<a href="#l17.297"></a><span id="l17.297" class="difflineplus">+</span>
<a href="#l17.298"></a><span id="l17.298" class="difflineplus">+    Services.obs.addObserver(this, kQuitApplicationGranted);</span>
<a href="#l17.299"></a><span id="l17.299" class="difflineplus">+    this._initialized = true;</span>
<a href="#l17.300"></a><span id="l17.300" class="difflineplus">+</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineplus">+    Services.cmd.initCommands();</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+    this._protos = {};</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+    this.globalUserStatus = new UserStatus();</span>
<a href="#l17.305"></a><span id="l17.305" class="difflineplus">+    this.globalUserStatus.addObserver({</span>
<a href="#l17.306"></a><span id="l17.306" class="difflineplus">+      observe(aSubject, aTopic, aData) {</span>
<a href="#l17.307"></a><span id="l17.307" class="difflineplus">+        Services.obs.notifyObservers(aSubject, aTopic, aData);</span>
<a href="#l17.308"></a><span id="l17.308" class="difflineplus">+      },</span>
<a href="#l17.309"></a><span id="l17.309" class="difflineplus">+    });</span>
<a href="#l17.310"></a><span id="l17.310" class="difflineplus">+</span>
<a href="#l17.311"></a><span id="l17.311" class="difflineplus">+    let accounts = Services.accounts;</span>
<a href="#l17.312"></a><span id="l17.312" class="difflineplus">+    accounts.initAccounts();</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineplus">+    Services.contacts.initContacts();</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+    Services.conversations.initConversations();</span>
<a href="#l17.315"></a><span id="l17.315" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;prpl-init&quot;);</span>
<a href="#l17.316"></a><span id="l17.316" class="difflineplus">+</span>
<a href="#l17.317"></a><span id="l17.317" class="difflineplus">+    // Wait with automatic connections until the password service</span>
<a href="#l17.318"></a><span id="l17.318" class="difflineplus">+    // is available.</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineplus">+    if (accounts.autoLoginStatus == Ci.imIAccountsService.AUTOLOGIN_ENABLED) {</span>
<a href="#l17.320"></a><span id="l17.320" class="difflineplus">+      Services.logins.initializationPromise.then(() =&gt; {</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+        Services.accounts.processAutoLogin();</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+      });</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineplus">+    }</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineplus">+  },</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineplus">+  observe(aObject, aTopic, aData) {</span>
<a href="#l17.326"></a><span id="l17.326" class="difflineplus">+    if (aTopic == kQuitApplicationGranted) {</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineplus">+      this.quit();</span>
<a href="#l17.328"></a><span id="l17.328" class="difflineplus">+    }</span>
<a href="#l17.329"></a><span id="l17.329" class="difflineplus">+  },</span>
<a href="#l17.330"></a><span id="l17.330" class="difflineplus">+  quit() {</span>
<a href="#l17.331"></a><span id="l17.331" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+    }</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+</span>
<a href="#l17.335"></a><span id="l17.335" class="difflineplus">+    Services.obs.removeObserver(this, kQuitApplicationGranted);</span>
<a href="#l17.336"></a><span id="l17.336" class="difflineplus">+    Services.obs.notifyObservers(this, &quot;prpl-quit&quot;);</span>
<a href="#l17.337"></a><span id="l17.337" class="difflineplus">+</span>
<a href="#l17.338"></a><span id="l17.338" class="difflineplus">+    Services.conversations.unInitConversations();</span>
<a href="#l17.339"></a><span id="l17.339" class="difflineplus">+    Services.accounts.unInitAccounts();</span>
<a href="#l17.340"></a><span id="l17.340" class="difflineplus">+    Services.contacts.unInitContacts();</span>
<a href="#l17.341"></a><span id="l17.341" class="difflineplus">+    Services.cmd.unInitCommands();</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineplus">+</span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+    this.globalUserStatus.unInit();</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+    delete this.globalUserStatus;</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineplus">+    delete this._protos;</span>
<a href="#l17.346"></a><span id="l17.346" class="difflineplus">+    delete this._initialized;</span>
<a href="#l17.347"></a><span id="l17.347" class="difflineplus">+  },</span>
<a href="#l17.348"></a><span id="l17.348" class="difflineplus">+</span>
<a href="#l17.349"></a><span id="l17.349" class="difflineplus">+  getProtocols() {</span>
<a href="#l17.350"></a><span id="l17.350" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+    }</span>
<a href="#l17.353"></a><span id="l17.353" class="difflineplus">+</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineplus">+    let protocols = [];</span>
<a href="#l17.355"></a><span id="l17.355" class="difflineplus">+    let entries = categoryManager.enumerateCategory(kProtocolPluginCategory);</span>
<a href="#l17.356"></a><span id="l17.356" class="difflineplus">+    while (entries.hasMoreElements()) {</span>
<a href="#l17.357"></a><span id="l17.357" class="difflineplus">+      let id = entries.getNext().QueryInterface(Ci.nsISupportsCString).data;</span>
<a href="#l17.358"></a><span id="l17.358" class="difflineplus">+</span>
<a href="#l17.359"></a><span id="l17.359" class="difflineplus">+      // If the preference is set to disable this prpl, don't show it in the</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineplus">+      // full list of protocols.</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+      let pref = &quot;chat.prpls.&quot; + id + &quot;.disable&quot;;</span>
<a href="#l17.362"></a><span id="l17.362" class="difflineplus">+      if (</span>
<a href="#l17.363"></a><span id="l17.363" class="difflineplus">+        Services.prefs.getPrefType(pref) == Services.prefs.PREF_BOOL &amp;&amp;</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineplus">+        Services.prefs.getBoolPref(pref)</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+      ) {</span>
<a href="#l17.366"></a><span id="l17.366" class="difflineplus">+        this.LOG(&quot;Disabling prpl: &quot; + id);</span>
<a href="#l17.367"></a><span id="l17.367" class="difflineplus">+        continue;</span>
<a href="#l17.368"></a><span id="l17.368" class="difflineplus">+      }</span>
<a href="#l17.369"></a><span id="l17.369" class="difflineplus">+</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineplus">+      let proto = this.getProtocolById(id);</span>
<a href="#l17.371"></a><span id="l17.371" class="difflineplus">+      if (proto) {</span>
<a href="#l17.372"></a><span id="l17.372" class="difflineplus">+        protocols.push(proto);</span>
<a href="#l17.373"></a><span id="l17.373" class="difflineplus">+      }</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineplus">+    }</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineplus">+    return new nsSimpleEnumerator(protocols);</span>
<a href="#l17.376"></a><span id="l17.376" class="difflineplus">+  },</span>
<a href="#l17.377"></a><span id="l17.377" class="difflineplus">+</span>
<a href="#l17.378"></a><span id="l17.378" class="difflineplus">+  getProtocolById(aPrplId) {</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineplus">+    if (!this._initialized) {</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+      throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineplus">+    }</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineplus">+</span>
<a href="#l17.383"></a><span id="l17.383" class="difflineplus">+    if (this._protos.hasOwnProperty(aPrplId)) {</span>
<a href="#l17.384"></a><span id="l17.384" class="difflineplus">+      return this._protos[aPrplId];</span>
<a href="#l17.385"></a><span id="l17.385" class="difflineplus">+    }</span>
<a href="#l17.386"></a><span id="l17.386" class="difflineplus">+</span>
<a href="#l17.387"></a><span id="l17.387" class="difflineplus">+    let cid;</span>
<a href="#l17.388"></a><span id="l17.388" class="difflineplus">+    try {</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineplus">+      cid = categoryManager.getCategoryEntry(kProtocolPluginCategory, aPrplId);</span>
<a href="#l17.390"></a><span id="l17.390" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineplus">+      return null; // no protocol registered for this id.</span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+    }</span>
<a href="#l17.393"></a><span id="l17.393" class="difflineplus">+</span>
<a href="#l17.394"></a><span id="l17.394" class="difflineplus">+    let proto = null;</span>
<a href="#l17.395"></a><span id="l17.395" class="difflineplus">+    try {</span>
<a href="#l17.396"></a><span id="l17.396" class="difflineplus">+      proto = Cc[cid].createInstance(Ci.prplIProtocol);</span>
<a href="#l17.397"></a><span id="l17.397" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineplus">+      // This is a real error, the protocol is registered and failed to init.</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineplus">+      let error = &quot;failed to create an instance of &quot; + cid + &quot;: &quot; + e;</span>
<a href="#l17.400"></a><span id="l17.400" class="difflineplus">+      dump(error + &quot;\n&quot;);</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineplus">+      Cu.reportError(error);</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+    }</span>
<a href="#l17.403"></a><span id="l17.403" class="difflineplus">+    if (!proto) {</span>
<a href="#l17.404"></a><span id="l17.404" class="difflineplus">+      return null;</span>
<a href="#l17.405"></a><span id="l17.405" class="difflineplus">+    }</span>
<a href="#l17.406"></a><span id="l17.406" class="difflineplus">+</span>
<a href="#l17.407"></a><span id="l17.407" class="difflineplus">+    try {</span>
<a href="#l17.408"></a><span id="l17.408" class="difflineplus">+      proto.init(aPrplId);</span>
<a href="#l17.409"></a><span id="l17.409" class="difflineplus">+    } catch (e) {</span>
<a href="#l17.410"></a><span id="l17.410" class="difflineplus">+      Cu.reportError(&quot;Could not initialize protocol &quot; + aPrplId + &quot;: &quot; + e);</span>
<a href="#l17.411"></a><span id="l17.411" class="difflineplus">+      return null;</span>
<a href="#l17.412"></a><span id="l17.412" class="difflineplus">+    }</span>
<a href="#l17.413"></a><span id="l17.413" class="difflineplus">+</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineplus">+    this._protos[aPrplId] = proto;</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineplus">+    return proto;</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+  },</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+</span>
<a href="#l17.418"></a><span id="l17.418" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.imICoreService]),</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineplus">+  classDescription: &quot;Core&quot;,</span>
<a href="#l17.420"></a><span id="l17.420" class="difflineplus">+  classID: Components.ID(&quot;{073f5953-853c-4a38-bd81-255510c31c2e}&quot;),</span>
<a href="#l17.421"></a><span id="l17.421" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/core-service;1&quot;,</span>
<a href="#l17.422"></a><span id="l17.422" class="difflineplus">+};</span>
<a href="#l17.423"></a><span id="l17.423" class="difflineplus">+</span>
<a href="#l17.424"></a><span id="l17.424" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([CoreService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/chat/components/src/imCore.manifest</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+component {073f5953-853c-4a38-bd81-255510c31c2e} imCore.js</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+contract @mozilla.org/chat/core-service;1 {073f5953-853c-4a38-bd81-255510c31c2e}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,1137 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+var CC = Components.Constructor;</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+var { EmptyEnumerator, l10nHelper, XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+var { GenericMessagePrototype } = ChromeUtils.import(</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+);</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+var { ClassInfo } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+var { ToLocaleFormat } = ChromeUtils.import(</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+  &quot;resource:///modules/ToLocaleFormat.jsm&quot;</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+var { getHiddenHTMLWindow } = ChromeUtils.import(</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  &quot;resource:///modules/hiddenWindow.jsm&quot;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+);</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/logger.properties&quot;)</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+);</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+var kLineBreak = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? &quot;\r\n&quot; : &quot;\n&quot;;</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+/*</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+ * Maps file paths to promises returned by ongoing OS.File operations on them.</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+ * This is so that a file can be read after a pending write operation completes</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+ * and vice versa (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+ */</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+var gFilePromises = new Map();</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+// Uses above map to queue operations on a file.</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+function queueFileOperation(aPath, aOperation) {</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  // Ensure the operation is queued regardless of whether the last one succeeded.</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  // This is safe since the promise is returned and consumers are expected to</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  // handle any errors. If there's no promise existing for the given path already,</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+  // queue the operation on a dummy pre-resolved promise.</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+  let promise = (gFilePromises.get(aPath) || Promise.resolve()).then(</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+    aOperation,</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+    aOperation</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+  );</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  gFilePromises.set(aPath, promise);</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+  let cleanup = () =&gt; {</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+    // If no further operations have been queued, remove the reference from the map.</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+    if (gFilePromises.get(aPath) === promise) {</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+      gFilePromises.delete(aPath);</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+    }</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+  };</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+  // Ensure we clear unused promises whether they resolved or rejected.</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+  promise.then(cleanup, cleanup);</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+  return promise;</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+}</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+/*</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+ * Convenience method to append to a file using the above queue system. If any of</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+ * the I/O operations reject, the returned promise will reject with the same reason.</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+ * We open the file, append, and close it immediately. The alternative is to keep</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+ * it open and append as required, but we want to make sure we don't open a file</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+ * for reading while it's already open for writing, so we close it every time</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+ * (opening a file multiple times concurrently may fail on Windows).</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+ * Note: This function creates parent directories if required.</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+ */</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+function appendToFile(aPath, aEncodedString, aCreate) {</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  return queueFileOperation(aPath, async function() {</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+    await OS.File.makeDir(OS.Path.dirname(aPath), {</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+      ignoreExisting: true,</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+      from: OS.Constants.Path.profileDir,</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+    });</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+    let file = await OS.File.open(aPath, { write: true, create: aCreate });</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+    try {</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+      await file.write(aEncodedString);</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+    } finally {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+      /*</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+       * If both the write() above and the close() below throw, and we don't</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+       * handle the close error here, the promise will be rejected with the close</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+       * error and the write error will be dropped. To avoid this, we log any</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+       * close error here so that any write error will be propagated.</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+       */</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+      await file.close().catch(Cu.reportError);</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+    }</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+  });</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+}</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+OS.File.profileBeforeChange.addBlocker(</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+  &quot;Chat logger: writing all pending messages&quot;,</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+  async function() {</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+    for (let promise of gFilePromises.values()) {</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+      try {</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+        await promise;</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+      } catch (aError) {</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+        // Ignore the error, whatever queued the operation will take care of it.</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+      }</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+    }</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+  }</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+);</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+// This function checks names against OS naming conventions and alters them</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+// accordingly so that they can be used as file/folder names.</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+function encodeName(aName) {</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+  // Reserved device names by Windows (prefixing &quot;%&quot;).</span>
<a href="#l19.111"></a><span id="l19.111" class="difflineplus">+  let reservedNames = /^(CON|PRN|AUX|NUL|COM\d|LPT\d)$/i;</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineplus">+  if (reservedNames.test(aName)) {</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+    return &quot;%&quot; + aName;</span>
<a href="#l19.114"></a><span id="l19.114" class="difflineplus">+  }</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineplus">+</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+  // &quot;.&quot; and &quot; &quot; must not be at the end of a file or folder name (appending &quot;_&quot;).</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+  if (/[\. _]/.test(aName.slice(-1))) {</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineplus">+    aName += &quot;_&quot;;</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+  }</span>
<a href="#l19.120"></a><span id="l19.120" class="difflineplus">+</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineplus">+  // Reserved characters are replaced by %[hex value]. encodeURIComponent() is</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineplus">+  // not sufficient, nevertheless decodeURIComponent() can be used to decode.</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+  function encodeReservedChars(match) {</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+    return &quot;%&quot; + match.charCodeAt(0).toString(16);</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineplus">+  }</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineplus">+  return aName.replace(/[&lt;&gt;:&quot;\/\\|?*&amp;%]/g, encodeReservedChars);</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineplus">+}</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineplus">+</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+function getLogFolderPathForAccount(aAccount) {</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+  return OS.Path.join(</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+    OS.Constants.Path.profileDir,</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+    &quot;logs&quot;,</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+    aAccount.protocol.normalizedName,</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineplus">+    encodeName(aAccount.normalizedName)</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+  );</span>
<a href="#l19.136"></a><span id="l19.136" class="difflineplus">+}</span>
<a href="#l19.137"></a><span id="l19.137" class="difflineplus">+</span>
<a href="#l19.138"></a><span id="l19.138" class="difflineplus">+function getLogFilePathForConversation(aConv, aFormat, aStartTime) {</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineplus">+  if (!aStartTime) {</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+    aStartTime = aConv.startDate / 1000;</span>
<a href="#l19.141"></a><span id="l19.141" class="difflineplus">+  }</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineplus">+  let path = getLogFolderPathForAccount(aConv.account);</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineplus">+  let name = aConv.normalizedName;</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+  if (convIsRealMUC(aConv)) {</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+    name += &quot;.chat&quot;;</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineplus">+  }</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineplus">+  return OS.Path.join(</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+    path,</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+    encodeName(name),</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+    getNewLogFileName(aFormat, aStartTime)</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+  );</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+}</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+function getNewLogFileName(aFormat, aStartTime) {</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+  let date = aStartTime ? new Date(aStartTime) : new Date();</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+  let dateTime = ToLocaleFormat(&quot;%Y-%m-%d.%H%M%S&quot;, date);</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+  let offset = date.getTimezoneOffset();</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+  if (offset &lt; 0) {</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+    dateTime += &quot;+&quot;;</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+    offset *= -1;</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineplus">+  } else {</span>
<a href="#l19.162"></a><span id="l19.162" class="difflineplus">+    dateTime += &quot;-&quot;;</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineplus">+  }</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineplus">+  let minutes = offset % 60;</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+  offset = (offset - minutes) / 60;</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+  function twoDigits(aNumber) {</span>
<a href="#l19.167"></a><span id="l19.167" class="difflineplus">+    if (aNumber == 0) {</span>
<a href="#l19.168"></a><span id="l19.168" class="difflineplus">+      return &quot;00&quot;;</span>
<a href="#l19.169"></a><span id="l19.169" class="difflineplus">+    }</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineplus">+    return aNumber &lt; 10 ? &quot;0&quot; + aNumber : aNumber;</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+  }</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineplus">+  if (!aFormat) {</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+    aFormat = &quot;txt&quot;;</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+  }</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineplus">+  return dateTime + twoDigits(offset) + twoDigits(minutes) + &quot;.&quot; + aFormat;</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+}</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineplus">+// One of these is maintained for every conversation being logged. It initializes</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+// a log file and appends to it as required.</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+function LogWriter(aConversation) {</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+  this._conv = aConversation;</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;) {</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+    this.format = &quot;json&quot;;</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+  }</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+  this.paths = [];</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+  this.startNewFile(this._conv.startDate / 1000);</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+}</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+LogWriter.prototype = {</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+  // All log file paths used by this LogWriter.</span>
<a href="#l19.190"></a><span id="l19.190" class="difflineplus">+  paths: [],</span>
<a href="#l19.191"></a><span id="l19.191" class="difflineplus">+  // Path of the log file that is currently being written to.</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineplus">+  get currentPath() {</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+    return this.paths[this.paths.length - 1];</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+  },</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+  // has been written.</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+  _initialized: null,</span>
<a href="#l19.198"></a><span id="l19.198" class="difflineplus">+  _startTime: null,</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineplus">+  _lastMessageTime: null,</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+  _messageCount: 0,</span>
<a href="#l19.201"></a><span id="l19.201" class="difflineplus">+  format: &quot;txt&quot;,</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineplus">+  encoder: new TextEncoder(),</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+  startNewFile(aStartTime, aContinuedSession) {</span>
<a href="#l19.204"></a><span id="l19.204" class="difflineplus">+    // We start a new log file every 1000 messages. The start time of this new</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineplus">+    // log file is the time of the next message. Since message times are in seconds,</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+    // if we receive 1000 messages within a second after starting the new file,</span>
<a href="#l19.207"></a><span id="l19.207" class="difflineplus">+    // we will create another file, using the same start time - and so the same</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+    // file name. To avoid this, ensure the new start time is at least one second</span>
<a href="#l19.209"></a><span id="l19.209" class="difflineplus">+    // greater than the current one. This is ugly, but should rarely be needed.</span>
<a href="#l19.210"></a><span id="l19.210" class="difflineplus">+    aStartTime = Math.max(aStartTime, this._startTime + 1000);</span>
<a href="#l19.211"></a><span id="l19.211" class="difflineplus">+    this._startTime = this._lastMessageTime = aStartTime;</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineplus">+    this._messageCount = 0;</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+    this.paths.push(</span>
<a href="#l19.214"></a><span id="l19.214" class="difflineplus">+      getLogFilePathForConversation(this._conv, this.format, aStartTime)</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+    );</span>
<a href="#l19.216"></a><span id="l19.216" class="difflineplus">+    let account = this._conv.account;</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineplus">+    let header;</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+    if (this.format == &quot;json&quot;) {</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+      header = {</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineplus">+        date: new Date(this._startTime),</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineplus">+        name: this._conv.name,</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineplus">+        title: this._conv.title,</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineplus">+        account: account.normalizedName,</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineplus">+        protocol: account.protocol.normalizedName,</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineplus">+        isChat: this._conv.isChat,</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineplus">+        normalizedName: this._conv.normalizedName,</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+      };</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+      if (aContinuedSession) {</span>
<a href="#l19.229"></a><span id="l19.229" class="difflineplus">+        header.continuedSession = true;</span>
<a href="#l19.230"></a><span id="l19.230" class="difflineplus">+      }</span>
<a href="#l19.231"></a><span id="l19.231" class="difflineplus">+      header = JSON.stringify(header) + &quot;\n&quot;;</span>
<a href="#l19.232"></a><span id="l19.232" class="difflineplus">+    } else {</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineplus">+      const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineplus">+        dateStyle: &quot;full&quot;,</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+        timeStyle: &quot;long&quot;,</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineplus">+      });</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineplus">+      header =</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+        &quot;Conversation with &quot; +</span>
<a href="#l19.239"></a><span id="l19.239" class="difflineplus">+        this._conv.name +</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineplus">+        &quot; at &quot; +</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineplus">+        dateTimeFormatter.format(new Date(this._conv.startDate / 1000)) +</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+        &quot; on &quot; +</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineplus">+        account.name +</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineplus">+        &quot; (&quot; +</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineplus">+        account.protocol.normalizedName +</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineplus">+        &quot;)&quot; +</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineplus">+        kLineBreak;</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineplus">+    }</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineplus">+    this._initialized = appendToFile(</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineplus">+      this.currentPath,</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+      this.encoder.encode(header),</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+      true</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+    );</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+    // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+    // writing the header failed.</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+    this._initialized.catch(aError =&gt;</span>
<a href="#l19.257"></a><span id="l19.257" class="difflineplus">+      Cu.reportError(&quot;Failed to initialize log file:\n&quot; + aError)</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineplus">+    );</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+  },</span>
<a href="#l19.260"></a><span id="l19.260" class="difflineplus">+  _serialize(aString) {</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineplus">+    // TODO cleanup once bug 102699 is fixed</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+    let doc = getHiddenHTMLWindow().document;</span>
<a href="#l19.263"></a><span id="l19.263" class="difflineplus">+    let div = doc.createElementNS(&quot;http://www.w3.org/1999/xhtml&quot;, &quot;div&quot;);</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineplus">+    // eslint-disable-next-line no-unsanitized/property</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+    div.innerHTML = aString</span>
<a href="#l19.266"></a><span id="l19.266" class="difflineplus">+      .replace(/\r?\n/g, &quot;&lt;br/&gt;&quot;)</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineplus">+      .replace(/&lt;br&gt;/gi, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineplus">+    const type = &quot;text/plain&quot;;</span>
<a href="#l19.269"></a><span id="l19.269" class="difflineplus">+    let encoder = Cu.createDocumentEncoder(type);</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineplus">+    encoder.init(doc, type, 0);</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineplus">+    encoder.setContainerNode(div);</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineplus">+    encoder.setNodeFixup({</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+      fixupNode(aNode, aSerializeKids) {</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+        if (aNode.localName == &quot;a&quot; &amp;&amp; aNode.hasAttribute(&quot;href&quot;)) {</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+          let url = aNode.getAttribute(&quot;href&quot;);</span>
<a href="#l19.276"></a><span id="l19.276" class="difflineplus">+          let content = aNode.textContent;</span>
<a href="#l19.277"></a><span id="l19.277" class="difflineplus">+          if (url != content) {</span>
<a href="#l19.278"></a><span id="l19.278" class="difflineplus">+            aNode.textContent = content + &quot; (&quot; + url + &quot;)&quot;;</span>
<a href="#l19.279"></a><span id="l19.279" class="difflineplus">+          }</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineplus">+        }</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineplus">+        return null;</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+      },</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+    });</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineplus">+    return encoder.encodeToString();</span>
<a href="#l19.285"></a><span id="l19.285" class="difflineplus">+  },</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineplus">+  // We start a new log file in the following cases:</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineplus">+  // - If it has been 30 minutes since the last message.</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+  kInactivityLimit: 30 * 60 * 1000,</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineplus">+  // - If at midnight, it's been longer than 3 hours since we started the file.</span>
<a href="#l19.290"></a><span id="l19.290" class="difflineplus">+  kDayOverlapLimit: 3 * 60 * 60 * 1000,</span>
<a href="#l19.291"></a><span id="l19.291" class="difflineplus">+  // - After every 1000 messages.</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineplus">+  kMessageCountLimit: 1000,</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+  logMessage(aMessage) {</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineplus">+    // aMessage.time is in seconds, we need it in milliseconds.</span>
<a href="#l19.295"></a><span id="l19.295" class="difflineplus">+    let messageTime = aMessage.time * 1000;</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineplus">+    let messageMidnight = new Date(messageTime).setHours(0, 0, 0, 0);</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+    let inactivityLimitExceeded =</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+      !aMessage.delayed &amp;&amp;</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+      messageTime - this._lastMessageTime &gt; this.kInactivityLimit;</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+    let dayOverlapLimitExceeded =</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+      !aMessage.delayed &amp;&amp;</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+      messageMidnight - this._startTime &gt; this.kDayOverlapLimit;</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineplus">+    if (</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineplus">+      inactivityLimitExceeded ||</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineplus">+      dayOverlapLimitExceeded ||</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineplus">+      this._messageCount == this.kMessageCountLimit</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineplus">+    ) {</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineplus">+      // We start a new session if the inactivity limit was exceeded.</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+      this.startNewFile(messageTime, !inactivityLimitExceeded);</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+    }</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineplus">+    ++this._messageCount;</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineplus">+</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineplus">+    if (!aMessage.delayed) {</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineplus">+      this._lastMessageTime = messageTime;</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineplus">+    }</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineplus">+</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineplus">+    let lineToWrite;</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    if (this.format == &quot;json&quot;) {</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineplus">+      let msg = {</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+        date: new Date(messageTime),</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+        who: aMessage.who,</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+        text: aMessage.displayMessage,</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineplus">+        flags: [</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineplus">+          &quot;outgoing&quot;,</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineplus">+          &quot;incoming&quot;,</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineplus">+          &quot;system&quot;,</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+          &quot;autoResponse&quot;,</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+          &quot;containsNick&quot;,</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+          &quot;error&quot;,</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineplus">+          &quot;delayed&quot;,</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+          &quot;noFormat&quot;,</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+          &quot;containsImages&quot;,</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineplus">+          &quot;notification&quot;,</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+          &quot;noLinkification&quot;,</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+        ].filter(f =&gt; aMessage[f]),</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+      };</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineplus">+      let alias = aMessage.alias;</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+      if (alias &amp;&amp; alias != msg.who) {</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineplus">+        msg.alias = alias;</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineplus">+      }</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineplus">+      lineToWrite = JSON.stringify(msg) + &quot;\n&quot;;</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineplus">+    } else {</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineplus">+      // Text log.</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+      let date = new Date(messageTime);</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+      let line = &quot;(&quot; + date.toLocaleTimeString() + &quot;) &quot;;</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineplus">+      let msg = this._serialize(aMessage.displayMessage);</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineplus">+      if (aMessage.system) {</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineplus">+        line += msg;</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineplus">+      } else {</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+        let sender = aMessage.alias || aMessage.who;</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineplus">+        if (aMessage.autoResponse) {</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+          line += sender + &quot; &lt;AUTO-REPLY&gt;: &quot; + msg;</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+        } else if (msg.startsWith(&quot;/me &quot;)) {</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+          line += &quot;***&quot; + sender + &quot; &quot; + msg.substr(4);</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+        } else {</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+          line += sender + &quot;: &quot; + msg;</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+        }</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineplus">+      }</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+      lineToWrite = line + kLineBreak;</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineplus">+    }</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+    lineToWrite = this.encoder.encode(lineToWrite);</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineplus">+    this._initialized.then(() =&gt; {</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineplus">+      appendToFile(this.currentPath, lineToWrite).catch(aError =&gt;</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineplus">+        Cu.reportError(&quot;Failed to log message:\n&quot; + aError)</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineplus">+      );</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineplus">+    });</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineplus">+  },</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineplus">+};</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineplus">+</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineplus">+var dummyLogWriter = {</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineplus">+  paths: null,</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+  currentPath: null,</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+  logMessage() {},</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineplus">+};</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineplus">+</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+var gLogWritersById = new Map();</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+function getLogWriter(aConversation) {</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+  let id = aConversation.id;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+  if (!gLogWritersById.has(id)) {</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineplus">+    let prefName =</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+      &quot;purple.logging.log_&quot; + (aConversation.isChat ? &quot;chats&quot; : &quot;ims&quot;);</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+    if (Services.prefs.getBoolPref(prefName)) {</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+      gLogWritersById.set(id, new LogWriter(aConversation));</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineplus">+    } else {</span>
<a href="#l19.387"></a><span id="l19.387" class="difflineplus">+      gLogWritersById.set(id, dummyLogWriter);</span>
<a href="#l19.388"></a><span id="l19.388" class="difflineplus">+    }</span>
<a href="#l19.389"></a><span id="l19.389" class="difflineplus">+  }</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineplus">+  return gLogWritersById.get(id);</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineplus">+}</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+function closeLogWriter(aConversation) {</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineplus">+  gLogWritersById.delete(aConversation.id);</span>
<a href="#l19.395"></a><span id="l19.395" class="difflineplus">+}</span>
<a href="#l19.396"></a><span id="l19.396" class="difflineplus">+</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineplus">+// LogWriter for system logs.</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+function SystemLogWriter(aAccount) {</span>
<a href="#l19.399"></a><span id="l19.399" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineplus">+  this.path = OS.Path.join(</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+    getLogFolderPathForAccount(aAccount),</span>
<a href="#l19.402"></a><span id="l19.402" class="difflineplus">+    &quot;.system&quot;,</span>
<a href="#l19.403"></a><span id="l19.403" class="difflineplus">+    getNewLogFileName()</span>
<a href="#l19.404"></a><span id="l19.404" class="difflineplus">+  );</span>
<a href="#l19.405"></a><span id="l19.405" class="difflineplus">+  const dateTimeFormatter = new Services.intl.DateTimeFormat(&quot;en-US&quot;, {</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineplus">+    dateStyle: &quot;full&quot;,</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+    timeStyle: &quot;long&quot;,</span>
<a href="#l19.408"></a><span id="l19.408" class="difflineplus">+  });</span>
<a href="#l19.409"></a><span id="l19.409" class="difflineplus">+  let header =</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineplus">+    &quot;System log for account &quot; +</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+    aAccount.name +</span>
<a href="#l19.412"></a><span id="l19.412" class="difflineplus">+    &quot; (&quot; +</span>
<a href="#l19.413"></a><span id="l19.413" class="difflineplus">+    aAccount.protocol.normalizedName +</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineplus">+    &quot;) connected at &quot; +</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineplus">+    dateTimeFormatter.format(new Date()) +</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineplus">+    kLineBreak;</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+  this._initialized = appendToFile(</span>
<a href="#l19.418"></a><span id="l19.418" class="difflineplus">+    this.path,</span>
<a href="#l19.419"></a><span id="l19.419" class="difflineplus">+    this.encoder.encode(header),</span>
<a href="#l19.420"></a><span id="l19.420" class="difflineplus">+    true</span>
<a href="#l19.421"></a><span id="l19.421" class="difflineplus">+  );</span>
<a href="#l19.422"></a><span id="l19.422" class="difflineplus">+  // Catch the error separately so that _initialized will stay rejected if</span>
<a href="#l19.423"></a><span id="l19.423" class="difflineplus">+  // writing the header failed.</span>
<a href="#l19.424"></a><span id="l19.424" class="difflineplus">+  this._initialized.catch(aError =&gt;</span>
<a href="#l19.425"></a><span id="l19.425" class="difflineplus">+    Cu.reportError(&quot;Error initializing system log:\n&quot; + aError)</span>
<a href="#l19.426"></a><span id="l19.426" class="difflineplus">+  );</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineplus">+}</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineplus">+SystemLogWriter.prototype = {</span>
<a href="#l19.429"></a><span id="l19.429" class="difflineplus">+  encoder: new TextEncoder(),</span>
<a href="#l19.430"></a><span id="l19.430" class="difflineplus">+  // Constructor sets this to a promise that will resolve when the log header</span>
<a href="#l19.431"></a><span id="l19.431" class="difflineplus">+  // has been written.</span>
<a href="#l19.432"></a><span id="l19.432" class="difflineplus">+  _initialized: null,</span>
<a href="#l19.433"></a><span id="l19.433" class="difflineplus">+  path: null,</span>
<a href="#l19.434"></a><span id="l19.434" class="difflineplus">+  logEvent(aString) {</span>
<a href="#l19.435"></a><span id="l19.435" class="difflineplus">+    let date = ToLocaleFormat(&quot;%x %X&quot;, new Date());</span>
<a href="#l19.436"></a><span id="l19.436" class="difflineplus">+    let lineToWrite = this.encoder.encode(</span>
<a href="#l19.437"></a><span id="l19.437" class="difflineplus">+      &quot;---- &quot; + aString + &quot; @ &quot; + date + &quot; ----&quot; + kLineBreak</span>
<a href="#l19.438"></a><span id="l19.438" class="difflineplus">+    );</span>
<a href="#l19.439"></a><span id="l19.439" class="difflineplus">+    this._initialized.then(() =&gt; {</span>
<a href="#l19.440"></a><span id="l19.440" class="difflineplus">+      appendToFile(this.path, lineToWrite).catch(aError =&gt;</span>
<a href="#l19.441"></a><span id="l19.441" class="difflineplus">+        Cu.reportError(&quot;Failed to log event:\n&quot; + aError)</span>
<a href="#l19.442"></a><span id="l19.442" class="difflineplus">+      );</span>
<a href="#l19.443"></a><span id="l19.443" class="difflineplus">+    });</span>
<a href="#l19.444"></a><span id="l19.444" class="difflineplus">+  },</span>
<a href="#l19.445"></a><span id="l19.445" class="difflineplus">+};</span>
<a href="#l19.446"></a><span id="l19.446" class="difflineplus">+</span>
<a href="#l19.447"></a><span id="l19.447" class="difflineplus">+var dummySystemLogWriter = {</span>
<a href="#l19.448"></a><span id="l19.448" class="difflineplus">+  path: null,</span>
<a href="#l19.449"></a><span id="l19.449" class="difflineplus">+  logEvent() {},</span>
<a href="#l19.450"></a><span id="l19.450" class="difflineplus">+};</span>
<a href="#l19.451"></a><span id="l19.451" class="difflineplus">+</span>
<a href="#l19.452"></a><span id="l19.452" class="difflineplus">+var gSystemLogWritersById = new Map();</span>
<a href="#l19.453"></a><span id="l19.453" class="difflineplus">+function getSystemLogWriter(aAccount, aCreate) {</span>
<a href="#l19.454"></a><span id="l19.454" class="difflineplus">+  let id = aAccount.id;</span>
<a href="#l19.455"></a><span id="l19.455" class="difflineplus">+  if (aCreate) {</span>
<a href="#l19.456"></a><span id="l19.456" class="difflineplus">+    if (!Services.prefs.getBoolPref(&quot;purple.logging.log_system&quot;)) {</span>
<a href="#l19.457"></a><span id="l19.457" class="difflineplus">+      return dummySystemLogWriter;</span>
<a href="#l19.458"></a><span id="l19.458" class="difflineplus">+    }</span>
<a href="#l19.459"></a><span id="l19.459" class="difflineplus">+    let writer = new SystemLogWriter(aAccount);</span>
<a href="#l19.460"></a><span id="l19.460" class="difflineplus">+    gSystemLogWritersById.set(id, writer);</span>
<a href="#l19.461"></a><span id="l19.461" class="difflineplus">+    return writer;</span>
<a href="#l19.462"></a><span id="l19.462" class="difflineplus">+  }</span>
<a href="#l19.463"></a><span id="l19.463" class="difflineplus">+</span>
<a href="#l19.464"></a><span id="l19.464" class="difflineplus">+  return (</span>
<a href="#l19.465"></a><span id="l19.465" class="difflineplus">+    (gSystemLogWritersById.has(id) &amp;&amp; gSystemLogWritersById.get(id)) ||</span>
<a href="#l19.466"></a><span id="l19.466" class="difflineplus">+    dummySystemLogWriter</span>
<a href="#l19.467"></a><span id="l19.467" class="difflineplus">+  );</span>
<a href="#l19.468"></a><span id="l19.468" class="difflineplus">+}</span>
<a href="#l19.469"></a><span id="l19.469" class="difflineplus">+</span>
<a href="#l19.470"></a><span id="l19.470" class="difflineplus">+function closeSystemLogWriter(aAccount) {</span>
<a href="#l19.471"></a><span id="l19.471" class="difflineplus">+  gSystemLogWritersById.delete(aAccount.id);</span>
<a href="#l19.472"></a><span id="l19.472" class="difflineplus">+}</span>
<a href="#l19.473"></a><span id="l19.473" class="difflineplus">+</span>
<a href="#l19.474"></a><span id="l19.474" class="difflineplus">+/**</span>
<a href="#l19.475"></a><span id="l19.475" class="difflineplus">+ * Takes a properly formatted log file name and extracts the date information</span>
<a href="#l19.476"></a><span id="l19.476" class="difflineplus">+ * and filetype, returning the results as an Array.</span>
<a href="#l19.477"></a><span id="l19.477" class="difflineplus">+ *</span>
<a href="#l19.478"></a><span id="l19.478" class="difflineplus">+ * Filenames are expected to be formatted as:</span>
<a href="#l19.479"></a><span id="l19.479" class="difflineplus">+ *</span>
<a href="#l19.480"></a><span id="l19.480" class="difflineplus">+ * YYYY-MM-DD.HHmmSS+ZZzz.format</span>
<a href="#l19.481"></a><span id="l19.481" class="difflineplus">+ *</span>
<a href="#l19.482"></a><span id="l19.482" class="difflineplus">+ * @param aFilename the name of the file</span>
<a href="#l19.483"></a><span id="l19.483" class="difflineplus">+ * @returns an Array, where the first element is a Date object for the date</span>
<a href="#l19.484"></a><span id="l19.484" class="difflineplus">+ *          that the log file represents, and the file type as a string.</span>
<a href="#l19.485"></a><span id="l19.485" class="difflineplus">+ */</span>
<a href="#l19.486"></a><span id="l19.486" class="difflineplus">+function getDateFromFilename(aFilename) {</span>
<a href="#l19.487"></a><span id="l19.487" class="difflineplus">+  const kRegExp = /([\d]{4})-([\d]{2})-([\d]{2}).([\d]{2})([\d]{2})([\d]{2})([+-])([\d]{2})([\d]{2}).*\.([A-Za-z]+)$/;</span>
<a href="#l19.488"></a><span id="l19.488" class="difflineplus">+</span>
<a href="#l19.489"></a><span id="l19.489" class="difflineplus">+  let r = aFilename.match(kRegExp);</span>
<a href="#l19.490"></a><span id="l19.490" class="difflineplus">+  if (!r) {</span>
<a href="#l19.491"></a><span id="l19.491" class="difflineplus">+    Cu.reportError(</span>
<a href="#l19.492"></a><span id="l19.492" class="difflineplus">+      &quot;Found log file with name not matching YYYY-MM-DD.HHmmSS+ZZzz.format: &quot; +</span>
<a href="#l19.493"></a><span id="l19.493" class="difflineplus">+        aFilename</span>
<a href="#l19.494"></a><span id="l19.494" class="difflineplus">+    );</span>
<a href="#l19.495"></a><span id="l19.495" class="difflineplus">+    return [];</span>
<a href="#l19.496"></a><span id="l19.496" class="difflineplus">+  }</span>
<a href="#l19.497"></a><span id="l19.497" class="difflineplus">+</span>
<a href="#l19.498"></a><span id="l19.498" class="difflineplus">+  // We ignore the timezone offset for now (FIXME)</span>
<a href="#l19.499"></a><span id="l19.499" class="difflineplus">+  return [new Date(r[1], r[2] - 1, r[3], r[4], r[5], r[6]), r[10]];</span>
<a href="#l19.500"></a><span id="l19.500" class="difflineplus">+}</span>
<a href="#l19.501"></a><span id="l19.501" class="difflineplus">+</span>
<a href="#l19.502"></a><span id="l19.502" class="difflineplus">+/**</span>
<a href="#l19.503"></a><span id="l19.503" class="difflineplus">+ * Returns true if a Conversation is both a chat conversation, and not</span>
<a href="#l19.504"></a><span id="l19.504" class="difflineplus">+ * a Twitter conversation.</span>
<a href="#l19.505"></a><span id="l19.505" class="difflineplus">+ */</span>
<a href="#l19.506"></a><span id="l19.506" class="difflineplus">+function convIsRealMUC(aConversation) {</span>
<a href="#l19.507"></a><span id="l19.507" class="difflineplus">+  return (</span>
<a href="#l19.508"></a><span id="l19.508" class="difflineplus">+    aConversation.isChat &amp;&amp; aConversation.account.protocol.id != &quot;prpl-twitter&quot;</span>
<a href="#l19.509"></a><span id="l19.509" class="difflineplus">+  );</span>
<a href="#l19.510"></a><span id="l19.510" class="difflineplus">+}</span>
<a href="#l19.511"></a><span id="l19.511" class="difflineplus">+</span>
<a href="#l19.512"></a><span id="l19.512" class="difflineplus">+function LogMessage(aData, aConversation) {</span>
<a href="#l19.513"></a><span id="l19.513" class="difflineplus">+  this._init(aData.who, aData.text);</span>
<a href="#l19.514"></a><span id="l19.514" class="difflineplus">+  this._conversation = aConversation;</span>
<a href="#l19.515"></a><span id="l19.515" class="difflineplus">+  this.time = Math.round(new Date(aData.date) / 1000);</span>
<a href="#l19.516"></a><span id="l19.516" class="difflineplus">+  if (&quot;alias&quot; in aData) {</span>
<a href="#l19.517"></a><span id="l19.517" class="difflineplus">+    this._alias = aData.alias;</span>
<a href="#l19.518"></a><span id="l19.518" class="difflineplus">+  }</span>
<a href="#l19.519"></a><span id="l19.519" class="difflineplus">+  for (let flag of aData.flags) {</span>
<a href="#l19.520"></a><span id="l19.520" class="difflineplus">+    this[flag] = true;</span>
<a href="#l19.521"></a><span id="l19.521" class="difflineplus">+  }</span>
<a href="#l19.522"></a><span id="l19.522" class="difflineplus">+}</span>
<a href="#l19.523"></a><span id="l19.523" class="difflineplus">+</span>
<a href="#l19.524"></a><span id="l19.524" class="difflineplus">+LogMessage.prototype = {</span>
<a href="#l19.525"></a><span id="l19.525" class="difflineplus">+  __proto__: GenericMessagePrototype,</span>
<a href="#l19.526"></a><span id="l19.526" class="difflineplus">+  _interfaces: [Ci.imIMessage, Ci.prplIMessage],</span>
<a href="#l19.527"></a><span id="l19.527" class="difflineplus">+  get displayMessage() {</span>
<a href="#l19.528"></a><span id="l19.528" class="difflineplus">+    return this.originalMessage;</span>
<a href="#l19.529"></a><span id="l19.529" class="difflineplus">+  },</span>
<a href="#l19.530"></a><span id="l19.530" class="difflineplus">+};</span>
<a href="#l19.531"></a><span id="l19.531" class="difflineplus">+</span>
<a href="#l19.532"></a><span id="l19.532" class="difflineplus">+function LogConversation(aMessages, aProperties) {</span>
<a href="#l19.533"></a><span id="l19.533" class="difflineplus">+  this._messages = aMessages;</span>
<a href="#l19.534"></a><span id="l19.534" class="difflineplus">+  for (let property in aProperties) {</span>
<a href="#l19.535"></a><span id="l19.535" class="difflineplus">+    this[property] = aProperties[property];</span>
<a href="#l19.536"></a><span id="l19.536" class="difflineplus">+  }</span>
<a href="#l19.537"></a><span id="l19.537" class="difflineplus">+}</span>
<a href="#l19.538"></a><span id="l19.538" class="difflineplus">+LogConversation.prototype = {</span>
<a href="#l19.539"></a><span id="l19.539" class="difflineplus">+  __proto__: ClassInfo(&quot;imILogConversation&quot;, &quot;Log conversation object&quot;),</span>
<a href="#l19.540"></a><span id="l19.540" class="difflineplus">+  get isChat() {</span>
<a href="#l19.541"></a><span id="l19.541" class="difflineplus">+    return this._isChat;</span>
<a href="#l19.542"></a><span id="l19.542" class="difflineplus">+  },</span>
<a href="#l19.543"></a><span id="l19.543" class="difflineplus">+  get buddy() {</span>
<a href="#l19.544"></a><span id="l19.544" class="difflineplus">+    return null;</span>
<a href="#l19.545"></a><span id="l19.545" class="difflineplus">+  },</span>
<a href="#l19.546"></a><span id="l19.546" class="difflineplus">+  get account() {</span>
<a href="#l19.547"></a><span id="l19.547" class="difflineplus">+    return {</span>
<a href="#l19.548"></a><span id="l19.548" class="difflineplus">+      alias: &quot;&quot;,</span>
<a href="#l19.549"></a><span id="l19.549" class="difflineplus">+      name: this._accountName,</span>
<a href="#l19.550"></a><span id="l19.550" class="difflineplus">+      normalizedName: this._accountName,</span>
<a href="#l19.551"></a><span id="l19.551" class="difflineplus">+      protocol: { name: this._protocolName },</span>
<a href="#l19.552"></a><span id="l19.552" class="difflineplus">+      statusInfo: Services.core.globalUserStatus,</span>
<a href="#l19.553"></a><span id="l19.553" class="difflineplus">+    };</span>
<a href="#l19.554"></a><span id="l19.554" class="difflineplus">+  },</span>
<a href="#l19.555"></a><span id="l19.555" class="difflineplus">+  getMessages() {</span>
<a href="#l19.556"></a><span id="l19.556" class="difflineplus">+    return this._messages.map(m =&gt; new LogMessage(m, this));</span>
<a href="#l19.557"></a><span id="l19.557" class="difflineplus">+  },</span>
<a href="#l19.558"></a><span id="l19.558" class="difflineplus">+  getMessagesEnumerator(aMessageCount) {</span>
<a href="#l19.559"></a><span id="l19.559" class="difflineplus">+    if (aMessageCount) {</span>
<a href="#l19.560"></a><span id="l19.560" class="difflineplus">+      aMessageCount.value = this._messages.length;</span>
<a href="#l19.561"></a><span id="l19.561" class="difflineplus">+    }</span>
<a href="#l19.562"></a><span id="l19.562" class="difflineplus">+    let enumerator = {</span>
<a href="#l19.563"></a><span id="l19.563" class="difflineplus">+      _index: 0,</span>
<a href="#l19.564"></a><span id="l19.564" class="difflineplus">+      _conv: this,</span>
<a href="#l19.565"></a><span id="l19.565" class="difflineplus">+      _messages: this._messages,</span>
<a href="#l19.566"></a><span id="l19.566" class="difflineplus">+      hasMoreElements() {</span>
<a href="#l19.567"></a><span id="l19.567" class="difflineplus">+        return this._index &lt; this._messages.length;</span>
<a href="#l19.568"></a><span id="l19.568" class="difflineplus">+      },</span>
<a href="#l19.569"></a><span id="l19.569" class="difflineplus">+      getNext() {</span>
<a href="#l19.570"></a><span id="l19.570" class="difflineplus">+        return new LogMessage(this._messages[this._index++], this._conv);</span>
<a href="#l19.571"></a><span id="l19.571" class="difflineplus">+      },</span>
<a href="#l19.572"></a><span id="l19.572" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l19.573"></a><span id="l19.573" class="difflineplus">+      *[Symbol.iterator]() {</span>
<a href="#l19.574"></a><span id="l19.574" class="difflineplus">+        while (this.hasMoreElements()) {</span>
<a href="#l19.575"></a><span id="l19.575" class="difflineplus">+          yield this.getNext();</span>
<a href="#l19.576"></a><span id="l19.576" class="difflineplus">+        }</span>
<a href="#l19.577"></a><span id="l19.577" class="difflineplus">+      },</span>
<a href="#l19.578"></a><span id="l19.578" class="difflineplus">+    };</span>
<a href="#l19.579"></a><span id="l19.579" class="difflineplus">+    return enumerator;</span>
<a href="#l19.580"></a><span id="l19.580" class="difflineplus">+  },</span>
<a href="#l19.581"></a><span id="l19.581" class="difflineplus">+};</span>
<a href="#l19.582"></a><span id="l19.582" class="difflineplus">+</span>
<a href="#l19.583"></a><span id="l19.583" class="difflineplus">+/**</span>
<a href="#l19.584"></a><span id="l19.584" class="difflineplus">+ * A Log object represents one or more log files. The constructor expects one</span>
<a href="#l19.585"></a><span id="l19.585" class="difflineplus">+ * argument, which is either a single path to a (json or txt) log file or an</span>
<a href="#l19.586"></a><span id="l19.586" class="difflineplus">+ * array of objects each having two properties:</span>
<a href="#l19.587"></a><span id="l19.587" class="difflineplus">+ *   path: The full path of the (json only) log file it represents.</span>
<a href="#l19.588"></a><span id="l19.588" class="difflineplus">+ *   time: The Date object extracted from the filename of the logfile.</span>
<a href="#l19.589"></a><span id="l19.589" class="difflineplus">+ *</span>
<a href="#l19.590"></a><span id="l19.590" class="difflineplus">+ * The returned Log object's time property will be:</span>
<a href="#l19.591"></a><span id="l19.591" class="difflineplus">+ *   For a single file - exact time extracted from the name of the log file.</span>
<a href="#l19.592"></a><span id="l19.592" class="difflineplus">+ *   For a set of files - the time extracted, reduced to the day.</span>
<a href="#l19.593"></a><span id="l19.593" class="difflineplus">+ */</span>
<a href="#l19.594"></a><span id="l19.594" class="difflineplus">+function Log(aEntries) {</span>
<a href="#l19.595"></a><span id="l19.595" class="difflineplus">+  if (typeof aEntries == &quot;string&quot;) {</span>
<a href="#l19.596"></a><span id="l19.596" class="difflineplus">+    // Assume that aEntries is a single path.</span>
<a href="#l19.597"></a><span id="l19.597" class="difflineplus">+    let path = aEntries;</span>
<a href="#l19.598"></a><span id="l19.598" class="difflineplus">+    this.path = path;</span>
<a href="#l19.599"></a><span id="l19.599" class="difflineplus">+    let [date, format] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l19.600"></a><span id="l19.600" class="difflineplus">+    if (!date || !format) {</span>
<a href="#l19.601"></a><span id="l19.601" class="difflineplus">+      this.format = &quot;invalid&quot;;</span>
<a href="#l19.602"></a><span id="l19.602" class="difflineplus">+      this.time = 0;</span>
<a href="#l19.603"></a><span id="l19.603" class="difflineplus">+      return;</span>
<a href="#l19.604"></a><span id="l19.604" class="difflineplus">+    }</span>
<a href="#l19.605"></a><span id="l19.605" class="difflineplus">+    this.time = date.valueOf() / 1000;</span>
<a href="#l19.606"></a><span id="l19.606" class="difflineplus">+    this.format = format;</span>
<a href="#l19.607"></a><span id="l19.607" class="difflineplus">+    // Wrap the path in an array</span>
<a href="#l19.608"></a><span id="l19.608" class="difflineplus">+    this._entryPaths = [path];</span>
<a href="#l19.609"></a><span id="l19.609" class="difflineplus">+    return;</span>
<a href="#l19.610"></a><span id="l19.610" class="difflineplus">+  }</span>
<a href="#l19.611"></a><span id="l19.611" class="difflineplus">+</span>
<a href="#l19.612"></a><span id="l19.612" class="difflineplus">+  if (!aEntries.length) {</span>
<a href="#l19.613"></a><span id="l19.613" class="difflineplus">+    throw new Error(</span>
<a href="#l19.614"></a><span id="l19.614" class="difflineplus">+      &quot;Log was passed an invalid argument, &quot; +</span>
<a href="#l19.615"></a><span id="l19.615" class="difflineplus">+        &quot;expected a non-empty array or a string.&quot;</span>
<a href="#l19.616"></a><span id="l19.616" class="difflineplus">+    );</span>
<a href="#l19.617"></a><span id="l19.617" class="difflineplus">+  }</span>
<a href="#l19.618"></a><span id="l19.618" class="difflineplus">+</span>
<a href="#l19.619"></a><span id="l19.619" class="difflineplus">+  // Assume aEntries is an array of objects.</span>
<a href="#l19.620"></a><span id="l19.620" class="difflineplus">+  // Sort our list of entries for this day in increasing order.</span>
<a href="#l19.621"></a><span id="l19.621" class="difflineplus">+  aEntries.sort((aLeft, aRight) =&gt; aLeft.time - aRight.time);</span>
<a href="#l19.622"></a><span id="l19.622" class="difflineplus">+</span>
<a href="#l19.623"></a><span id="l19.623" class="difflineplus">+  this._entryPaths = aEntries.map(entry =&gt; entry.path);</span>
<a href="#l19.624"></a><span id="l19.624" class="difflineplus">+  // Calculate the timestamp for the first entry down to the day.</span>
<a href="#l19.625"></a><span id="l19.625" class="difflineplus">+  let timestamp = new Date(aEntries[0].time);</span>
<a href="#l19.626"></a><span id="l19.626" class="difflineplus">+  timestamp.setHours(0);</span>
<a href="#l19.627"></a><span id="l19.627" class="difflineplus">+  timestamp.setMinutes(0);</span>
<a href="#l19.628"></a><span id="l19.628" class="difflineplus">+  timestamp.setSeconds(0);</span>
<a href="#l19.629"></a><span id="l19.629" class="difflineplus">+  this.time = timestamp.valueOf() / 1000;</span>
<a href="#l19.630"></a><span id="l19.630" class="difflineplus">+  // Path is used to uniquely identify a Log, and sometimes used to</span>
<a href="#l19.631"></a><span id="l19.631" class="difflineplus">+  // quickly determine which directory a log file is from.  We'll use</span>
<a href="#l19.632"></a><span id="l19.632" class="difflineplus">+  // the first file's path.</span>
<a href="#l19.633"></a><span id="l19.633" class="difflineplus">+  this.path = aEntries[0].path;</span>
<a href="#l19.634"></a><span id="l19.634" class="difflineplus">+}</span>
<a href="#l19.635"></a><span id="l19.635" class="difflineplus">+Log.prototype = {</span>
<a href="#l19.636"></a><span id="l19.636" class="difflineplus">+  __proto__: ClassInfo(&quot;imILog&quot;, &quot;Log object&quot;),</span>
<a href="#l19.637"></a><span id="l19.637" class="difflineplus">+  _entryPaths: null,</span>
<a href="#l19.638"></a><span id="l19.638" class="difflineplus">+  format: &quot;json&quot;,</span>
<a href="#l19.639"></a><span id="l19.639" class="difflineplus">+  async getConversation() {</span>
<a href="#l19.640"></a><span id="l19.640" class="difflineplus">+    /*</span>
<a href="#l19.641"></a><span id="l19.641" class="difflineplus">+     * Read the set of log files asynchronously and return a promise that</span>
<a href="#l19.642"></a><span id="l19.642" class="difflineplus">+     * resolves to a LogConversation instance. Even if a file contains some</span>
<a href="#l19.643"></a><span id="l19.643" class="difflineplus">+     * junk (invalid JSON), messages that are valid will be read. If the first</span>
<a href="#l19.644"></a><span id="l19.644" class="difflineplus">+     * line of metadata is corrupt however, the data isn't useful and the</span>
<a href="#l19.645"></a><span id="l19.645" class="difflineplus">+     * promise will resolve to null.</span>
<a href="#l19.646"></a><span id="l19.646" class="difflineplus">+     */</span>
<a href="#l19.647"></a><span id="l19.647" class="difflineplus">+    if (this.format != &quot;json&quot;) {</span>
<a href="#l19.648"></a><span id="l19.648" class="difflineplus">+      return null;</span>
<a href="#l19.649"></a><span id="l19.649" class="difflineplus">+    }</span>
<a href="#l19.650"></a><span id="l19.650" class="difflineplus">+    let messages = [];</span>
<a href="#l19.651"></a><span id="l19.651" class="difflineplus">+    let properties = {};</span>
<a href="#l19.652"></a><span id="l19.652" class="difflineplus">+    let firstFile = true;</span>
<a href="#l19.653"></a><span id="l19.653" class="difflineplus">+    let decoder = new TextDecoder();</span>
<a href="#l19.654"></a><span id="l19.654" class="difflineplus">+    for (let path of this._entryPaths) {</span>
<a href="#l19.655"></a><span id="l19.655" class="difflineplus">+      let lines;</span>
<a href="#l19.656"></a><span id="l19.656" class="difflineplus">+      try {</span>
<a href="#l19.657"></a><span id="l19.657" class="difflineplus">+        let contents = await queueFileOperation(path, () =&gt; OS.File.read(path));</span>
<a href="#l19.658"></a><span id="l19.658" class="difflineplus">+        lines = decoder.decode(contents).split(&quot;\n&quot;);</span>
<a href="#l19.659"></a><span id="l19.659" class="difflineplus">+      } catch (aError) {</span>
<a href="#l19.660"></a><span id="l19.660" class="difflineplus">+        Cu.reportError('Error reading log file &quot;' + path + '&quot;:\n' + aError);</span>
<a href="#l19.661"></a><span id="l19.661" class="difflineplus">+        continue;</span>
<a href="#l19.662"></a><span id="l19.662" class="difflineplus">+      }</span>
<a href="#l19.663"></a><span id="l19.663" class="difflineplus">+      let nextLine = lines.shift();</span>
<a href="#l19.664"></a><span id="l19.664" class="difflineplus">+      let filename = OS.Path.basename(path);</span>
<a href="#l19.665"></a><span id="l19.665" class="difflineplus">+</span>
<a href="#l19.666"></a><span id="l19.666" class="difflineplus">+      let data;</span>
<a href="#l19.667"></a><span id="l19.667" class="difflineplus">+      try {</span>
<a href="#l19.668"></a><span id="l19.668" class="difflineplus">+        // This will fail if either nextLine is undefined, or not valid JSON.</span>
<a href="#l19.669"></a><span id="l19.669" class="difflineplus">+        data = JSON.parse(nextLine);</span>
<a href="#l19.670"></a><span id="l19.670" class="difflineplus">+      } catch (aError) {</span>
<a href="#l19.671"></a><span id="l19.671" class="difflineplus">+        messages.push({</span>
<a href="#l19.672"></a><span id="l19.672" class="difflineplus">+          who: &quot;sessionstart&quot;,</span>
<a href="#l19.673"></a><span id="l19.673" class="difflineplus">+          date: getDateFromFilename(filename)[0],</span>
<a href="#l19.674"></a><span id="l19.674" class="difflineplus">+          text: _(&quot;badLogfile&quot;, filename),</span>
<a href="#l19.675"></a><span id="l19.675" class="difflineplus">+          flags: [&quot;noLog&quot;, &quot;notification&quot;, &quot;error&quot;, &quot;system&quot;],</span>
<a href="#l19.676"></a><span id="l19.676" class="difflineplus">+        });</span>
<a href="#l19.677"></a><span id="l19.677" class="difflineplus">+        continue;</span>
<a href="#l19.678"></a><span id="l19.678" class="difflineplus">+      }</span>
<a href="#l19.679"></a><span id="l19.679" class="difflineplus">+</span>
<a href="#l19.680"></a><span id="l19.680" class="difflineplus">+      if (firstFile || !data.continuedSession) {</span>
<a href="#l19.681"></a><span id="l19.681" class="difflineplus">+        messages.push({</span>
<a href="#l19.682"></a><span id="l19.682" class="difflineplus">+          who: &quot;sessionstart&quot;,</span>
<a href="#l19.683"></a><span id="l19.683" class="difflineplus">+          date: getDateFromFilename(filename)[0],</span>
<a href="#l19.684"></a><span id="l19.684" class="difflineplus">+          text: &quot;&quot;,</span>
<a href="#l19.685"></a><span id="l19.685" class="difflineplus">+          flags: [&quot;noLog&quot;, &quot;notification&quot;],</span>
<a href="#l19.686"></a><span id="l19.686" class="difflineplus">+        });</span>
<a href="#l19.687"></a><span id="l19.687" class="difflineplus">+      }</span>
<a href="#l19.688"></a><span id="l19.688" class="difflineplus">+</span>
<a href="#l19.689"></a><span id="l19.689" class="difflineplus">+      if (firstFile) {</span>
<a href="#l19.690"></a><span id="l19.690" class="difflineplus">+        properties.startDate = new Date(data.date) * 1000;</span>
<a href="#l19.691"></a><span id="l19.691" class="difflineplus">+        properties.name = data.name;</span>
<a href="#l19.692"></a><span id="l19.692" class="difflineplus">+        properties.title = data.title;</span>
<a href="#l19.693"></a><span id="l19.693" class="difflineplus">+        properties._accountName = data.account;</span>
<a href="#l19.694"></a><span id="l19.694" class="difflineplus">+        properties._protocolName = data.protocol;</span>
<a href="#l19.695"></a><span id="l19.695" class="difflineplus">+        properties._isChat = data.isChat;</span>
<a href="#l19.696"></a><span id="l19.696" class="difflineplus">+        properties.normalizedName = data.normalizedName;</span>
<a href="#l19.697"></a><span id="l19.697" class="difflineplus">+        firstFile = false;</span>
<a href="#l19.698"></a><span id="l19.698" class="difflineplus">+      }</span>
<a href="#l19.699"></a><span id="l19.699" class="difflineplus">+</span>
<a href="#l19.700"></a><span id="l19.700" class="difflineplus">+      while (lines.length) {</span>
<a href="#l19.701"></a><span id="l19.701" class="difflineplus">+        nextLine = lines.shift();</span>
<a href="#l19.702"></a><span id="l19.702" class="difflineplus">+        if (!nextLine) {</span>
<a href="#l19.703"></a><span id="l19.703" class="difflineplus">+          break;</span>
<a href="#l19.704"></a><span id="l19.704" class="difflineplus">+        }</span>
<a href="#l19.705"></a><span id="l19.705" class="difflineplus">+        try {</span>
<a href="#l19.706"></a><span id="l19.706" class="difflineplus">+          messages.push(JSON.parse(nextLine));</span>
<a href="#l19.707"></a><span id="l19.707" class="difflineplus">+        } catch (e) {</span>
<a href="#l19.708"></a><span id="l19.708" class="difflineplus">+          // If a message line contains junk, just ignore the error and</span>
<a href="#l19.709"></a><span id="l19.709" class="difflineplus">+          // continue reading the conversation.</span>
<a href="#l19.710"></a><span id="l19.710" class="difflineplus">+        }</span>
<a href="#l19.711"></a><span id="l19.711" class="difflineplus">+      }</span>
<a href="#l19.712"></a><span id="l19.712" class="difflineplus">+    }</span>
<a href="#l19.713"></a><span id="l19.713" class="difflineplus">+</span>
<a href="#l19.714"></a><span id="l19.714" class="difflineplus">+    if (firstFile) {</span>
<a href="#l19.715"></a><span id="l19.715" class="difflineplus">+      // All selected log files are invalid.</span>
<a href="#l19.716"></a><span id="l19.716" class="difflineplus">+      return null;</span>
<a href="#l19.717"></a><span id="l19.717" class="difflineplus">+    }</span>
<a href="#l19.718"></a><span id="l19.718" class="difflineplus">+</span>
<a href="#l19.719"></a><span id="l19.719" class="difflineplus">+    return new LogConversation(messages, properties);</span>
<a href="#l19.720"></a><span id="l19.720" class="difflineplus">+  },</span>
<a href="#l19.721"></a><span id="l19.721" class="difflineplus">+};</span>
<a href="#l19.722"></a><span id="l19.722" class="difflineplus">+</span>
<a href="#l19.723"></a><span id="l19.723" class="difflineplus">+/**</span>
<a href="#l19.724"></a><span id="l19.724" class="difflineplus">+ * Log enumerators provide lists of log files (&quot;entries&quot;). aEntries is an array</span>
<a href="#l19.725"></a><span id="l19.725" class="difflineplus">+ * of the OS.File.DirectoryIterator.Entry instances which represent the log</span>
<a href="#l19.726"></a><span id="l19.726" class="difflineplus">+ * files to be parsed.</span>
<a href="#l19.727"></a><span id="l19.727" class="difflineplus">+ *</span>
<a href="#l19.728"></a><span id="l19.728" class="difflineplus">+ * DailyLogEnumerator organizes entries by date, and enumerates them in order.</span>
<a href="#l19.729"></a><span id="l19.729" class="difflineplus">+ * LogEnumerator enumerates logs in the same order as the input array.</span>
<a href="#l19.730"></a><span id="l19.730" class="difflineplus">+ */</span>
<a href="#l19.731"></a><span id="l19.731" class="difflineplus">+function DailyLogEnumerator(aEntries) {</span>
<a href="#l19.732"></a><span id="l19.732" class="difflineplus">+  this._entries = {};</span>
<a href="#l19.733"></a><span id="l19.733" class="difflineplus">+</span>
<a href="#l19.734"></a><span id="l19.734" class="difflineplus">+  for (let entry of aEntries) {</span>
<a href="#l19.735"></a><span id="l19.735" class="difflineplus">+    let path = entry.path;</span>
<a href="#l19.736"></a><span id="l19.736" class="difflineplus">+</span>
<a href="#l19.737"></a><span id="l19.737" class="difflineplus">+    let [logDate, logFormat] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l19.738"></a><span id="l19.738" class="difflineplus">+    if (!logDate) {</span>
<a href="#l19.739"></a><span id="l19.739" class="difflineplus">+      // We'll skip this one, since it's got a busted filename.</span>
<a href="#l19.740"></a><span id="l19.740" class="difflineplus">+      continue;</span>
<a href="#l19.741"></a><span id="l19.741" class="difflineplus">+    }</span>
<a href="#l19.742"></a><span id="l19.742" class="difflineplus">+</span>
<a href="#l19.743"></a><span id="l19.743" class="difflineplus">+    let dateForID = new Date(logDate);</span>
<a href="#l19.744"></a><span id="l19.744" class="difflineplus">+    let dayID;</span>
<a href="#l19.745"></a><span id="l19.745" class="difflineplus">+    if (logFormat == &quot;json&quot;) {</span>
<a href="#l19.746"></a><span id="l19.746" class="difflineplus">+      // We want to cluster all of the logs that occur on the same day</span>
<a href="#l19.747"></a><span id="l19.747" class="difflineplus">+      // into the same Arrays. We clone the date for the log, reset it to</span>
<a href="#l19.748"></a><span id="l19.748" class="difflineplus">+      // the 0th hour/minute/second, and use that to construct an ID for the</span>
<a href="#l19.749"></a><span id="l19.749" class="difflineplus">+      // Array we'll put the log in.</span>
<a href="#l19.750"></a><span id="l19.750" class="difflineplus">+      dateForID.setHours(0);</span>
<a href="#l19.751"></a><span id="l19.751" class="difflineplus">+      dateForID.setMinutes(0);</span>
<a href="#l19.752"></a><span id="l19.752" class="difflineplus">+      dateForID.setSeconds(0);</span>
<a href="#l19.753"></a><span id="l19.753" class="difflineplus">+      dayID = dateForID.toISOString();</span>
<a href="#l19.754"></a><span id="l19.754" class="difflineplus">+</span>
<a href="#l19.755"></a><span id="l19.755" class="difflineplus">+      if (!(dayID in this._entries)) {</span>
<a href="#l19.756"></a><span id="l19.756" class="difflineplus">+        this._entries[dayID] = [];</span>
<a href="#l19.757"></a><span id="l19.757" class="difflineplus">+      }</span>
<a href="#l19.758"></a><span id="l19.758" class="difflineplus">+</span>
<a href="#l19.759"></a><span id="l19.759" class="difflineplus">+      this._entries[dayID].push({</span>
<a href="#l19.760"></a><span id="l19.760" class="difflineplus">+        path,</span>
<a href="#l19.761"></a><span id="l19.761" class="difflineplus">+        time: logDate,</span>
<a href="#l19.762"></a><span id="l19.762" class="difflineplus">+      });</span>
<a href="#l19.763"></a><span id="l19.763" class="difflineplus">+    } else {</span>
<a href="#l19.764"></a><span id="l19.764" class="difflineplus">+      // Add legacy text logs as individual paths.</span>
<a href="#l19.765"></a><span id="l19.765" class="difflineplus">+      dayID = dateForID.toISOString() + &quot;txt&quot;;</span>
<a href="#l19.766"></a><span id="l19.766" class="difflineplus">+      this._entries[dayID] = path;</span>
<a href="#l19.767"></a><span id="l19.767" class="difflineplus">+    }</span>
<a href="#l19.768"></a><span id="l19.768" class="difflineplus">+  }</span>
<a href="#l19.769"></a><span id="l19.769" class="difflineplus">+</span>
<a href="#l19.770"></a><span id="l19.770" class="difflineplus">+  this._days = Object.keys(this._entries).sort();</span>
<a href="#l19.771"></a><span id="l19.771" class="difflineplus">+  this._index = 0;</span>
<a href="#l19.772"></a><span id="l19.772" class="difflineplus">+}</span>
<a href="#l19.773"></a><span id="l19.773" class="difflineplus">+DailyLogEnumerator.prototype = {</span>
<a href="#l19.774"></a><span id="l19.774" class="difflineplus">+  _entries: {},</span>
<a href="#l19.775"></a><span id="l19.775" class="difflineplus">+  _days: [],</span>
<a href="#l19.776"></a><span id="l19.776" class="difflineplus">+  _index: 0,</span>
<a href="#l19.777"></a><span id="l19.777" class="difflineplus">+  hasMoreElements() {</span>
<a href="#l19.778"></a><span id="l19.778" class="difflineplus">+    return this._index &lt; this._days.length;</span>
<a href="#l19.779"></a><span id="l19.779" class="difflineplus">+  },</span>
<a href="#l19.780"></a><span id="l19.780" class="difflineplus">+  getNext() {</span>
<a href="#l19.781"></a><span id="l19.781" class="difflineplus">+    let dayID = this._days[this._index++];</span>
<a href="#l19.782"></a><span id="l19.782" class="difflineplus">+    return new Log(this._entries[dayID]);</span>
<a href="#l19.783"></a><span id="l19.783" class="difflineplus">+  },</span>
<a href="#l19.784"></a><span id="l19.784" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l19.785"></a><span id="l19.785" class="difflineplus">+  *[Symbol.iterator]() {</span>
<a href="#l19.786"></a><span id="l19.786" class="difflineplus">+    while (this.hasMoreElements()) {</span>
<a href="#l19.787"></a><span id="l19.787" class="difflineplus">+      yield this.getNext();</span>
<a href="#l19.788"></a><span id="l19.788" class="difflineplus">+    }</span>
<a href="#l19.789"></a><span id="l19.789" class="difflineplus">+  },</span>
<a href="#l19.790"></a><span id="l19.790" class="difflineplus">+};</span>
<a href="#l19.791"></a><span id="l19.791" class="difflineplus">+</span>
<a href="#l19.792"></a><span id="l19.792" class="difflineplus">+function LogEnumerator(aEntries) {</span>
<a href="#l19.793"></a><span id="l19.793" class="difflineplus">+  this._entries = aEntries;</span>
<a href="#l19.794"></a><span id="l19.794" class="difflineplus">+  this._entries.sort((a, b) =&gt; a.name &gt; b.name);</span>
<a href="#l19.795"></a><span id="l19.795" class="difflineplus">+}</span>
<a href="#l19.796"></a><span id="l19.796" class="difflineplus">+LogEnumerator.prototype = {</span>
<a href="#l19.797"></a><span id="l19.797" class="difflineplus">+  _entries: [],</span>
<a href="#l19.798"></a><span id="l19.798" class="difflineplus">+  hasMoreElements() {</span>
<a href="#l19.799"></a><span id="l19.799" class="difflineplus">+    return this._entries.length &gt; 0;</span>
<a href="#l19.800"></a><span id="l19.800" class="difflineplus">+  },</span>
<a href="#l19.801"></a><span id="l19.801" class="difflineplus">+  getNext() {</span>
<a href="#l19.802"></a><span id="l19.802" class="difflineplus">+    // Create and return a log from the first entry.</span>
<a href="#l19.803"></a><span id="l19.803" class="difflineplus">+    return new Log(this._entries.shift().path);</span>
<a href="#l19.804"></a><span id="l19.804" class="difflineplus">+  },</span>
<a href="#l19.805"></a><span id="l19.805" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l19.806"></a><span id="l19.806" class="difflineplus">+  *[Symbol.iterator]() {</span>
<a href="#l19.807"></a><span id="l19.807" class="difflineplus">+    while (this.hasMoreElements()) {</span>
<a href="#l19.808"></a><span id="l19.808" class="difflineplus">+      yield this.getNext();</span>
<a href="#l19.809"></a><span id="l19.809" class="difflineplus">+    }</span>
<a href="#l19.810"></a><span id="l19.810" class="difflineplus">+  },</span>
<a href="#l19.811"></a><span id="l19.811" class="difflineplus">+};</span>
<a href="#l19.812"></a><span id="l19.812" class="difflineplus">+</span>
<a href="#l19.813"></a><span id="l19.813" class="difflineplus">+function Logger() {}</span>
<a href="#l19.814"></a><span id="l19.814" class="difflineplus">+Logger.prototype = {</span>
<a href="#l19.815"></a><span id="l19.815" class="difflineplus">+  // Returned Promise resolves to an array of entries for the</span>
<a href="#l19.816"></a><span id="l19.816" class="difflineplus">+  // log folder if it exists, otherwise null.</span>
<a href="#l19.817"></a><span id="l19.817" class="difflineplus">+  async _getLogArray(aAccount, aNormalizedName) {</span>
<a href="#l19.818"></a><span id="l19.818" class="difflineplus">+    let iterator, path;</span>
<a href="#l19.819"></a><span id="l19.819" class="difflineplus">+    try {</span>
<a href="#l19.820"></a><span id="l19.820" class="difflineplus">+      path = OS.Path.join(</span>
<a href="#l19.821"></a><span id="l19.821" class="difflineplus">+        getLogFolderPathForAccount(aAccount),</span>
<a href="#l19.822"></a><span id="l19.822" class="difflineplus">+        encodeName(aNormalizedName)</span>
<a href="#l19.823"></a><span id="l19.823" class="difflineplus">+      );</span>
<a href="#l19.824"></a><span id="l19.824" class="difflineplus">+      if (await queueFileOperation(path, () =&gt; OS.File.exists(path))) {</span>
<a href="#l19.825"></a><span id="l19.825" class="difflineplus">+        iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l19.826"></a><span id="l19.826" class="difflineplus">+        let entries = await iterator.nextBatch();</span>
<a href="#l19.827"></a><span id="l19.827" class="difflineplus">+        iterator.close();</span>
<a href="#l19.828"></a><span id="l19.828" class="difflineplus">+        return entries;</span>
<a href="#l19.829"></a><span id="l19.829" class="difflineplus">+      }</span>
<a href="#l19.830"></a><span id="l19.830" class="difflineplus">+    } catch (aError) {</span>
<a href="#l19.831"></a><span id="l19.831" class="difflineplus">+      if (iterator) {</span>
<a href="#l19.832"></a><span id="l19.832" class="difflineplus">+        iterator.close();</span>
<a href="#l19.833"></a><span id="l19.833" class="difflineplus">+      }</span>
<a href="#l19.834"></a><span id="l19.834" class="difflineplus">+      Cu.reportError(</span>
<a href="#l19.835"></a><span id="l19.835" class="difflineplus">+        'Error getting directory entries for &quot;' + path + '&quot;:\n' + aError</span>
<a href="#l19.836"></a><span id="l19.836" class="difflineplus">+      );</span>
<a href="#l19.837"></a><span id="l19.837" class="difflineplus">+    }</span>
<a href="#l19.838"></a><span id="l19.838" class="difflineplus">+    return [];</span>
<a href="#l19.839"></a><span id="l19.839" class="difflineplus">+  },</span>
<a href="#l19.840"></a><span id="l19.840" class="difflineplus">+  getLogFromFile(aFilePath, aGroupByDay) {</span>
<a href="#l19.841"></a><span id="l19.841" class="difflineplus">+    if (!aGroupByDay) {</span>
<a href="#l19.842"></a><span id="l19.842" class="difflineplus">+      return Promise.resolve(new Log(aFilePath));</span>
<a href="#l19.843"></a><span id="l19.843" class="difflineplus">+    }</span>
<a href="#l19.844"></a><span id="l19.844" class="difflineplus">+    let [targetDate] = getDateFromFilename(OS.Path.basename(aFilePath));</span>
<a href="#l19.845"></a><span id="l19.845" class="difflineplus">+    if (!targetDate) {</span>
<a href="#l19.846"></a><span id="l19.846" class="difflineplus">+      return null;</span>
<a href="#l19.847"></a><span id="l19.847" class="difflineplus">+    }</span>
<a href="#l19.848"></a><span id="l19.848" class="difflineplus">+</span>
<a href="#l19.849"></a><span id="l19.849" class="difflineplus">+    targetDate = targetDate.toDateString();</span>
<a href="#l19.850"></a><span id="l19.850" class="difflineplus">+</span>
<a href="#l19.851"></a><span id="l19.851" class="difflineplus">+    // We'll assume that the files relevant to our interests are</span>
<a href="#l19.852"></a><span id="l19.852" class="difflineplus">+    // in the same folder as the one provided.</span>
<a href="#l19.853"></a><span id="l19.853" class="difflineplus">+    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aFilePath));</span>
<a href="#l19.854"></a><span id="l19.854" class="difflineplus">+    let relevantEntries = [];</span>
<a href="#l19.855"></a><span id="l19.855" class="difflineplus">+    return iterator</span>
<a href="#l19.856"></a><span id="l19.856" class="difflineplus">+      .forEach(function(aEntry) {</span>
<a href="#l19.857"></a><span id="l19.857" class="difflineplus">+        if (aEntry.isDir) {</span>
<a href="#l19.858"></a><span id="l19.858" class="difflineplus">+          return;</span>
<a href="#l19.859"></a><span id="l19.859" class="difflineplus">+        }</span>
<a href="#l19.860"></a><span id="l19.860" class="difflineplus">+        let path = aEntry.path;</span>
<a href="#l19.861"></a><span id="l19.861" class="difflineplus">+        let [logTime] = getDateFromFilename(OS.Path.basename(path));</span>
<a href="#l19.862"></a><span id="l19.862" class="difflineplus">+</span>
<a href="#l19.863"></a><span id="l19.863" class="difflineplus">+        // If someone placed a 'foreign' file into the logs directory,</span>
<a href="#l19.864"></a><span id="l19.864" class="difflineplus">+        // pattern matching fails and getDateFromFilename() returns [].</span>
<a href="#l19.865"></a><span id="l19.865" class="difflineplus">+        if (logTime &amp;&amp; targetDate == logTime.toDateString()) {</span>
<a href="#l19.866"></a><span id="l19.866" class="difflineplus">+          relevantEntries.push({</span>
<a href="#l19.867"></a><span id="l19.867" class="difflineplus">+            path,</span>
<a href="#l19.868"></a><span id="l19.868" class="difflineplus">+            time: logTime,</span>
<a href="#l19.869"></a><span id="l19.869" class="difflineplus">+          });</span>
<a href="#l19.870"></a><span id="l19.870" class="difflineplus">+        }</span>
<a href="#l19.871"></a><span id="l19.871" class="difflineplus">+      })</span>
<a href="#l19.872"></a><span id="l19.872" class="difflineplus">+      .then(</span>
<a href="#l19.873"></a><span id="l19.873" class="difflineplus">+        () =&gt; {</span>
<a href="#l19.874"></a><span id="l19.874" class="difflineplus">+          iterator.close();</span>
<a href="#l19.875"></a><span id="l19.875" class="difflineplus">+          return new Log(relevantEntries);</span>
<a href="#l19.876"></a><span id="l19.876" class="difflineplus">+        },</span>
<a href="#l19.877"></a><span id="l19.877" class="difflineplus">+        aError =&gt; {</span>
<a href="#l19.878"></a><span id="l19.878" class="difflineplus">+          iterator.close();</span>
<a href="#l19.879"></a><span id="l19.879" class="difflineplus">+          throw aError;</span>
<a href="#l19.880"></a><span id="l19.880" class="difflineplus">+        }</span>
<a href="#l19.881"></a><span id="l19.881" class="difflineplus">+      );</span>
<a href="#l19.882"></a><span id="l19.882" class="difflineplus">+  },</span>
<a href="#l19.883"></a><span id="l19.883" class="difflineplus">+  // Creates and returns the appropriate LogEnumerator for the given log array</span>
<a href="#l19.884"></a><span id="l19.884" class="difflineplus">+  // depending on aGroupByDay, or an EmptyEnumerator if the input array is empty.</span>
<a href="#l19.885"></a><span id="l19.885" class="difflineplus">+  _getEnumerator(aLogArray, aGroupByDay) {</span>
<a href="#l19.886"></a><span id="l19.886" class="difflineplus">+    let enumerator = aGroupByDay ? DailyLogEnumerator : LogEnumerator;</span>
<a href="#l19.887"></a><span id="l19.887" class="difflineplus">+    return aLogArray.length ? new enumerator(aLogArray) : EmptyEnumerator;</span>
<a href="#l19.888"></a><span id="l19.888" class="difflineplus">+  },</span>
<a href="#l19.889"></a><span id="l19.889" class="difflineplus">+  async getLogPathsForConversation(aConversation) {</span>
<a href="#l19.890"></a><span id="l19.890" class="difflineplus">+    let writer = gLogWritersById.get(aConversation.id);</span>
<a href="#l19.891"></a><span id="l19.891" class="difflineplus">+    // Resolve to null if we haven't created a LogWriter yet for this conv, or</span>
<a href="#l19.892"></a><span id="l19.892" class="difflineplus">+    // if logging is disabled (paths will be null).</span>
<a href="#l19.893"></a><span id="l19.893" class="difflineplus">+    if (!writer || !writer.paths) {</span>
<a href="#l19.894"></a><span id="l19.894" class="difflineplus">+      return null;</span>
<a href="#l19.895"></a><span id="l19.895" class="difflineplus">+    }</span>
<a href="#l19.896"></a><span id="l19.896" class="difflineplus">+    let paths = writer.paths;</span>
<a href="#l19.897"></a><span id="l19.897" class="difflineplus">+    // Wait for any pending file operations to finish, then resolve to the paths</span>
<a href="#l19.898"></a><span id="l19.898" class="difflineplus">+    // regardless of whether these operations succeeded.</span>
<a href="#l19.899"></a><span id="l19.899" class="difflineplus">+    for (let path of paths) {</span>
<a href="#l19.900"></a><span id="l19.900" class="difflineplus">+      await gFilePromises.get(path);</span>
<a href="#l19.901"></a><span id="l19.901" class="difflineplus">+    }</span>
<a href="#l19.902"></a><span id="l19.902" class="difflineplus">+    return paths;</span>
<a href="#l19.903"></a><span id="l19.903" class="difflineplus">+  },</span>
<a href="#l19.904"></a><span id="l19.904" class="difflineplus">+  getLogsForAccountAndName(aAccount, aNormalizedName, aGroupByDay) {</span>
<a href="#l19.905"></a><span id="l19.905" class="difflineplus">+    return this._getLogArray(aAccount, aNormalizedName).then(aEntries =&gt;</span>
<a href="#l19.906"></a><span id="l19.906" class="difflineplus">+      this._getEnumerator(aEntries, aGroupByDay)</span>
<a href="#l19.907"></a><span id="l19.907" class="difflineplus">+    );</span>
<a href="#l19.908"></a><span id="l19.908" class="difflineplus">+  },</span>
<a href="#l19.909"></a><span id="l19.909" class="difflineplus">+  getLogsForAccountBuddy(aAccountBuddy, aGroupByDay) {</span>
<a href="#l19.910"></a><span id="l19.910" class="difflineplus">+    return this.getLogsForAccountAndName(</span>
<a href="#l19.911"></a><span id="l19.911" class="difflineplus">+      aAccountBuddy.account,</span>
<a href="#l19.912"></a><span id="l19.912" class="difflineplus">+      aAccountBuddy.normalizedName,</span>
<a href="#l19.913"></a><span id="l19.913" class="difflineplus">+      aGroupByDay</span>
<a href="#l19.914"></a><span id="l19.914" class="difflineplus">+    );</span>
<a href="#l19.915"></a><span id="l19.915" class="difflineplus">+  },</span>
<a href="#l19.916"></a><span id="l19.916" class="difflineplus">+  async getLogsForBuddy(aBuddy, aGroupByDay) {</span>
<a href="#l19.917"></a><span id="l19.917" class="difflineplus">+    let entries = [];</span>
<a href="#l19.918"></a><span id="l19.918" class="difflineplus">+    for (let accountBuddy of aBuddy.getAccountBuddies()) {</span>
<a href="#l19.919"></a><span id="l19.919" class="difflineplus">+      entries = entries.concat(</span>
<a href="#l19.920"></a><span id="l19.920" class="difflineplus">+        await this._getLogArray(</span>
<a href="#l19.921"></a><span id="l19.921" class="difflineplus">+          accountBuddy.account,</span>
<a href="#l19.922"></a><span id="l19.922" class="difflineplus">+          accountBuddy.normalizedName</span>
<a href="#l19.923"></a><span id="l19.923" class="difflineplus">+        )</span>
<a href="#l19.924"></a><span id="l19.924" class="difflineplus">+      );</span>
<a href="#l19.925"></a><span id="l19.925" class="difflineplus">+    }</span>
<a href="#l19.926"></a><span id="l19.926" class="difflineplus">+    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l19.927"></a><span id="l19.927" class="difflineplus">+  },</span>
<a href="#l19.928"></a><span id="l19.928" class="difflineplus">+  async getLogsForContact(aContact, aGroupByDay) {</span>
<a href="#l19.929"></a><span id="l19.929" class="difflineplus">+    let entries = [];</span>
<a href="#l19.930"></a><span id="l19.930" class="difflineplus">+    for (let buddy of aContact.getBuddies()) {</span>
<a href="#l19.931"></a><span id="l19.931" class="difflineplus">+      for (let accountBuddy of buddy.getAccountBuddies()) {</span>
<a href="#l19.932"></a><span id="l19.932" class="difflineplus">+        entries = entries.concat(</span>
<a href="#l19.933"></a><span id="l19.933" class="difflineplus">+          await this._getLogArray(</span>
<a href="#l19.934"></a><span id="l19.934" class="difflineplus">+            accountBuddy.account,</span>
<a href="#l19.935"></a><span id="l19.935" class="difflineplus">+            accountBuddy.normalizedName</span>
<a href="#l19.936"></a><span id="l19.936" class="difflineplus">+          )</span>
<a href="#l19.937"></a><span id="l19.937" class="difflineplus">+        );</span>
<a href="#l19.938"></a><span id="l19.938" class="difflineplus">+      }</span>
<a href="#l19.939"></a><span id="l19.939" class="difflineplus">+    }</span>
<a href="#l19.940"></a><span id="l19.940" class="difflineplus">+    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l19.941"></a><span id="l19.941" class="difflineplus">+  },</span>
<a href="#l19.942"></a><span id="l19.942" class="difflineplus">+  getLogsForConversation(aConversation, aGroupByDay) {</span>
<a href="#l19.943"></a><span id="l19.943" class="difflineplus">+    let name = aConversation.normalizedName;</span>
<a href="#l19.944"></a><span id="l19.944" class="difflineplus">+    if (convIsRealMUC(aConversation)) {</span>
<a href="#l19.945"></a><span id="l19.945" class="difflineplus">+      name += &quot;.chat&quot;;</span>
<a href="#l19.946"></a><span id="l19.946" class="difflineplus">+    }</span>
<a href="#l19.947"></a><span id="l19.947" class="difflineplus">+    return this.getLogsForAccountAndName(</span>
<a href="#l19.948"></a><span id="l19.948" class="difflineplus">+      aConversation.account,</span>
<a href="#l19.949"></a><span id="l19.949" class="difflineplus">+      name,</span>
<a href="#l19.950"></a><span id="l19.950" class="difflineplus">+      aGroupByDay</span>
<a href="#l19.951"></a><span id="l19.951" class="difflineplus">+    );</span>
<a href="#l19.952"></a><span id="l19.952" class="difflineplus">+  },</span>
<a href="#l19.953"></a><span id="l19.953" class="difflineplus">+  getSystemLogsForAccount(aAccount) {</span>
<a href="#l19.954"></a><span id="l19.954" class="difflineplus">+    return this.getLogsForAccountAndName(aAccount, &quot;.system&quot;);</span>
<a href="#l19.955"></a><span id="l19.955" class="difflineplus">+  },</span>
<a href="#l19.956"></a><span id="l19.956" class="difflineplus">+  async getSimilarLogs(aLog, aGroupByDay) {</span>
<a href="#l19.957"></a><span id="l19.957" class="difflineplus">+    let iterator = new OS.File.DirectoryIterator(OS.Path.dirname(aLog.path));</span>
<a href="#l19.958"></a><span id="l19.958" class="difflineplus">+    let entries;</span>
<a href="#l19.959"></a><span id="l19.959" class="difflineplus">+    try {</span>
<a href="#l19.960"></a><span id="l19.960" class="difflineplus">+      entries = await iterator.nextBatch();</span>
<a href="#l19.961"></a><span id="l19.961" class="difflineplus">+    } catch (aError) {</span>
<a href="#l19.962"></a><span id="l19.962" class="difflineplus">+      Cu.reportError(</span>
<a href="#l19.963"></a><span id="l19.963" class="difflineplus">+        'Error getting similar logs for &quot;' + aLog.path + '&quot;:\n' + aError</span>
<a href="#l19.964"></a><span id="l19.964" class="difflineplus">+      );</span>
<a href="#l19.965"></a><span id="l19.965" class="difflineplus">+    }</span>
<a href="#l19.966"></a><span id="l19.966" class="difflineplus">+    // If there was an error, this will return an EmptyEnumerator.</span>
<a href="#l19.967"></a><span id="l19.967" class="difflineplus">+    return this._getEnumerator(entries, aGroupByDay);</span>
<a href="#l19.968"></a><span id="l19.968" class="difflineplus">+  },</span>
<a href="#l19.969"></a><span id="l19.969" class="difflineplus">+</span>
<a href="#l19.970"></a><span id="l19.970" class="difflineplus">+  getLogFolderPathForAccount(aAccount) {</span>
<a href="#l19.971"></a><span id="l19.971" class="difflineplus">+    return getLogFolderPathForAccount(aAccount);</span>
<a href="#l19.972"></a><span id="l19.972" class="difflineplus">+  },</span>
<a href="#l19.973"></a><span id="l19.973" class="difflineplus">+</span>
<a href="#l19.974"></a><span id="l19.974" class="difflineplus">+  deleteLogFolderForAccount(aAccount) {</span>
<a href="#l19.975"></a><span id="l19.975" class="difflineplus">+    if (!aAccount.disconnecting &amp;&amp; !aAccount.disconnected) {</span>
<a href="#l19.976"></a><span id="l19.976" class="difflineplus">+      throw new Error(</span>
<a href="#l19.977"></a><span id="l19.977" class="difflineplus">+        &quot;Account must be disconnected first before deleting logs.&quot;</span>
<a href="#l19.978"></a><span id="l19.978" class="difflineplus">+      );</span>
<a href="#l19.979"></a><span id="l19.979" class="difflineplus">+    }</span>
<a href="#l19.980"></a><span id="l19.980" class="difflineplus">+</span>
<a href="#l19.981"></a><span id="l19.981" class="difflineplus">+    if (aAccount.disconnecting) {</span>
<a href="#l19.982"></a><span id="l19.982" class="difflineplus">+      Cu.reportError(</span>
<a href="#l19.983"></a><span id="l19.983" class="difflineplus">+        &quot;Account is still disconnecting while we attempt to remove logs.&quot;</span>
<a href="#l19.984"></a><span id="l19.984" class="difflineplus">+      );</span>
<a href="#l19.985"></a><span id="l19.985" class="difflineplus">+    }</span>
<a href="#l19.986"></a><span id="l19.986" class="difflineplus">+</span>
<a href="#l19.987"></a><span id="l19.987" class="difflineplus">+    let logPath = this.getLogFolderPathForAccount(aAccount);</span>
<a href="#l19.988"></a><span id="l19.988" class="difflineplus">+    // Find all operations on files inside the log folder.</span>
<a href="#l19.989"></a><span id="l19.989" class="difflineplus">+    let pendingPromises = [];</span>
<a href="#l19.990"></a><span id="l19.990" class="difflineplus">+    function checkLogFiles(promiseOperation, filePath) {</span>
<a href="#l19.991"></a><span id="l19.991" class="difflineplus">+      if (filePath.startsWith(logPath)) {</span>
<a href="#l19.992"></a><span id="l19.992" class="difflineplus">+        pendingPromises.push(promiseOperation);</span>
<a href="#l19.993"></a><span id="l19.993" class="difflineplus">+      }</span>
<a href="#l19.994"></a><span id="l19.994" class="difflineplus">+    }</span>
<a href="#l19.995"></a><span id="l19.995" class="difflineplus">+    gFilePromises.forEach(checkLogFiles);</span>
<a href="#l19.996"></a><span id="l19.996" class="difflineplus">+    // After all operations finish, remove the whole log folder.</span>
<a href="#l19.997"></a><span id="l19.997" class="difflineplus">+    return Promise.all(pendingPromises)</span>
<a href="#l19.998"></a><span id="l19.998" class="difflineplus">+      .then(values =&gt; {</span>
<a href="#l19.999"></a><span id="l19.999" class="difflineplus">+        OS.File.removeDir(logPath, { ignoreAbsent: true });</span>
<a href="#l19.1000"></a><span id="l19.1000" class="difflineplus">+      })</span>
<a href="#l19.1001"></a><span id="l19.1001" class="difflineplus">+      .catch(aError =&gt;</span>
<a href="#l19.1002"></a><span id="l19.1002" class="difflineplus">+        Cu.reportError(&quot;Failed to remove log folders:\n&quot; + aError)</span>
<a href="#l19.1003"></a><span id="l19.1003" class="difflineplus">+      );</span>
<a href="#l19.1004"></a><span id="l19.1004" class="difflineplus">+  },</span>
<a href="#l19.1005"></a><span id="l19.1005" class="difflineplus">+</span>
<a href="#l19.1006"></a><span id="l19.1006" class="difflineplus">+  async forEach(aCallback) {</span>
<a href="#l19.1007"></a><span id="l19.1007" class="difflineplus">+    let getAllSubdirs = async function(aPaths, aErrorMsg) {</span>
<a href="#l19.1008"></a><span id="l19.1008" class="difflineplus">+      let entries = [];</span>
<a href="#l19.1009"></a><span id="l19.1009" class="difflineplus">+      for (let path of aPaths) {</span>
<a href="#l19.1010"></a><span id="l19.1010" class="difflineplus">+        let iterator = new OS.File.DirectoryIterator(path);</span>
<a href="#l19.1011"></a><span id="l19.1011" class="difflineplus">+        try {</span>
<a href="#l19.1012"></a><span id="l19.1012" class="difflineplus">+          entries = entries.concat(await iterator.nextBatch());</span>
<a href="#l19.1013"></a><span id="l19.1013" class="difflineplus">+        } catch (aError) {</span>
<a href="#l19.1014"></a><span id="l19.1014" class="difflineplus">+          if (aErrorMsg) {</span>
<a href="#l19.1015"></a><span id="l19.1015" class="difflineplus">+            Cu.reportError(aErrorMsg + &quot;\n&quot; + aError);</span>
<a href="#l19.1016"></a><span id="l19.1016" class="difflineplus">+          }</span>
<a href="#l19.1017"></a><span id="l19.1017" class="difflineplus">+        } finally {</span>
<a href="#l19.1018"></a><span id="l19.1018" class="difflineplus">+          iterator.close();</span>
<a href="#l19.1019"></a><span id="l19.1019" class="difflineplus">+        }</span>
<a href="#l19.1020"></a><span id="l19.1020" class="difflineplus">+      }</span>
<a href="#l19.1021"></a><span id="l19.1021" class="difflineplus">+      entries = entries</span>
<a href="#l19.1022"></a><span id="l19.1022" class="difflineplus">+        .filter(aEntry =&gt; aEntry.isDir)</span>
<a href="#l19.1023"></a><span id="l19.1023" class="difflineplus">+        .map(aEntry =&gt; aEntry.path);</span>
<a href="#l19.1024"></a><span id="l19.1024" class="difflineplus">+      return entries;</span>
<a href="#l19.1025"></a><span id="l19.1025" class="difflineplus">+    };</span>
<a href="#l19.1026"></a><span id="l19.1026" class="difflineplus">+</span>
<a href="#l19.1027"></a><span id="l19.1027" class="difflineplus">+    let logsPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l19.1028"></a><span id="l19.1028" class="difflineplus">+    let prpls = await getAllSubdirs([logsPath]);</span>
<a href="#l19.1029"></a><span id="l19.1029" class="difflineplus">+    let accounts = await getAllSubdirs(</span>
<a href="#l19.1030"></a><span id="l19.1030" class="difflineplus">+      prpls,</span>
<a href="#l19.1031"></a><span id="l19.1031" class="difflineplus">+      &quot;Error while sweeping prpl folder:&quot;</span>
<a href="#l19.1032"></a><span id="l19.1032" class="difflineplus">+    );</span>
<a href="#l19.1033"></a><span id="l19.1033" class="difflineplus">+    let logFolders = await getAllSubdirs(</span>
<a href="#l19.1034"></a><span id="l19.1034" class="difflineplus">+      accounts,</span>
<a href="#l19.1035"></a><span id="l19.1035" class="difflineplus">+      &quot;Error while sweeping account folder:&quot;</span>
<a href="#l19.1036"></a><span id="l19.1036" class="difflineplus">+    );</span>
<a href="#l19.1037"></a><span id="l19.1037" class="difflineplus">+    for (let folder of logFolders) {</span>
<a href="#l19.1038"></a><span id="l19.1038" class="difflineplus">+      let iterator = new OS.File.DirectoryIterator(folder);</span>
<a href="#l19.1039"></a><span id="l19.1039" class="difflineplus">+      try {</span>
<a href="#l19.1040"></a><span id="l19.1040" class="difflineplus">+        await iterator.forEach(aEntry =&gt; {</span>
<a href="#l19.1041"></a><span id="l19.1041" class="difflineplus">+          if (aEntry.isDir || !aEntry.name.endsWith(&quot;.json&quot;)) {</span>
<a href="#l19.1042"></a><span id="l19.1042" class="difflineplus">+            return null;</span>
<a href="#l19.1043"></a><span id="l19.1043" class="difflineplus">+          }</span>
<a href="#l19.1044"></a><span id="l19.1044" class="difflineplus">+          return aCallback.processLog(aEntry.path);</span>
<a href="#l19.1045"></a><span id="l19.1045" class="difflineplus">+        });</span>
<a href="#l19.1046"></a><span id="l19.1046" class="difflineplus">+      } catch (aError) {</span>
<a href="#l19.1047"></a><span id="l19.1047" class="difflineplus">+        // If the callback threw, reject the promise and let the caller handle it.</span>
<a href="#l19.1048"></a><span id="l19.1048" class="difflineplus">+        if (!(aError instanceof OS.File.Error)) {</span>
<a href="#l19.1049"></a><span id="l19.1049" class="difflineplus">+          throw aError;</span>
<a href="#l19.1050"></a><span id="l19.1050" class="difflineplus">+        }</span>
<a href="#l19.1051"></a><span id="l19.1051" class="difflineplus">+        Cu.reportError(&quot;Error sweeping log folder:\n&quot; + aError);</span>
<a href="#l19.1052"></a><span id="l19.1052" class="difflineplus">+      } finally {</span>
<a href="#l19.1053"></a><span id="l19.1053" class="difflineplus">+        iterator.close();</span>
<a href="#l19.1054"></a><span id="l19.1054" class="difflineplus">+      }</span>
<a href="#l19.1055"></a><span id="l19.1055" class="difflineplus">+    }</span>
<a href="#l19.1056"></a><span id="l19.1056" class="difflineplus">+  },</span>
<a href="#l19.1057"></a><span id="l19.1057" class="difflineplus">+</span>
<a href="#l19.1058"></a><span id="l19.1058" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l19.1059"></a><span id="l19.1059" class="difflineplus">+    switch (aTopic) {</span>
<a href="#l19.1060"></a><span id="l19.1060" class="difflineplus">+      case &quot;profile-after-change&quot;:</span>
<a href="#l19.1061"></a><span id="l19.1061" class="difflineplus">+        Services.obs.addObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l19.1062"></a><span id="l19.1062" class="difflineplus">+        break;</span>
<a href="#l19.1063"></a><span id="l19.1063" class="difflineplus">+      case &quot;final-ui-startup&quot;:</span>
<a href="#l19.1064"></a><span id="l19.1064" class="difflineplus">+        Services.obs.removeObserver(this, &quot;final-ui-startup&quot;);</span>
<a href="#l19.1065"></a><span id="l19.1065" class="difflineplus">+        [</span>
<a href="#l19.1066"></a><span id="l19.1066" class="difflineplus">+          &quot;new-text&quot;,</span>
<a href="#l19.1067"></a><span id="l19.1067" class="difflineplus">+          &quot;conversation-closed&quot;,</span>
<a href="#l19.1068"></a><span id="l19.1068" class="difflineplus">+          &quot;conversation-left-chat&quot;,</span>
<a href="#l19.1069"></a><span id="l19.1069" class="difflineplus">+          &quot;account-connected&quot;,</span>
<a href="#l19.1070"></a><span id="l19.1070" class="difflineplus">+          &quot;account-disconnected&quot;,</span>
<a href="#l19.1071"></a><span id="l19.1071" class="difflineplus">+          &quot;account-buddy-status-changed&quot;,</span>
<a href="#l19.1072"></a><span id="l19.1072" class="difflineplus">+        ].forEach(function(aEvent) {</span>
<a href="#l19.1073"></a><span id="l19.1073" class="difflineplus">+          Services.obs.addObserver(this, aEvent);</span>
<a href="#l19.1074"></a><span id="l19.1074" class="difflineplus">+        }, this);</span>
<a href="#l19.1075"></a><span id="l19.1075" class="difflineplus">+        break;</span>
<a href="#l19.1076"></a><span id="l19.1076" class="difflineplus">+      case &quot;new-text&quot;:</span>
<a href="#l19.1077"></a><span id="l19.1077" class="difflineplus">+        let excludeBecauseEncrypted = false;</span>
<a href="#l19.1078"></a><span id="l19.1078" class="difflineplus">+        if (aSubject.encrypted) {</span>
<a href="#l19.1079"></a><span id="l19.1079" class="difflineplus">+          excludeBecauseEncrypted = !Services.prefs.getBoolPref(</span>
<a href="#l19.1080"></a><span id="l19.1080" class="difflineplus">+            &quot;messenger.account.&quot; +</span>
<a href="#l19.1081"></a><span id="l19.1081" class="difflineplus">+              aSubject.conversation.account.id +</span>
<a href="#l19.1082"></a><span id="l19.1082" class="difflineplus">+              &quot;.options.otrAllowMsgLog&quot;,</span>
<a href="#l19.1083"></a><span id="l19.1083" class="difflineplus">+            Services.prefs.getBoolPref(&quot;chat.otr.default.allowMsgLog&quot;)</span>
<a href="#l19.1084"></a><span id="l19.1084" class="difflineplus">+          );</span>
<a href="#l19.1085"></a><span id="l19.1085" class="difflineplus">+        }</span>
<a href="#l19.1086"></a><span id="l19.1086" class="difflineplus">+        if (!aSubject.noLog &amp;&amp; !excludeBecauseEncrypted) {</span>
<a href="#l19.1087"></a><span id="l19.1087" class="difflineplus">+          let log = getLogWriter(aSubject.conversation);</span>
<a href="#l19.1088"></a><span id="l19.1088" class="difflineplus">+          log.logMessage(aSubject);</span>
<a href="#l19.1089"></a><span id="l19.1089" class="difflineplus">+        }</span>
<a href="#l19.1090"></a><span id="l19.1090" class="difflineplus">+        break;</span>
<a href="#l19.1091"></a><span id="l19.1091" class="difflineplus">+      case &quot;conversation-closed&quot;:</span>
<a href="#l19.1092"></a><span id="l19.1092" class="difflineplus">+      case &quot;conversation-left-chat&quot;:</span>
<a href="#l19.1093"></a><span id="l19.1093" class="difflineplus">+        closeLogWriter(aSubject);</span>
<a href="#l19.1094"></a><span id="l19.1094" class="difflineplus">+        break;</span>
<a href="#l19.1095"></a><span id="l19.1095" class="difflineplus">+      case &quot;account-connected&quot;:</span>
<a href="#l19.1096"></a><span id="l19.1096" class="difflineplus">+        getSystemLogWriter(aSubject, true).logEvent(</span>
<a href="#l19.1097"></a><span id="l19.1097" class="difflineplus">+          &quot;+++ &quot; + aSubject.name + &quot; signed on&quot;</span>
<a href="#l19.1098"></a><span id="l19.1098" class="difflineplus">+        );</span>
<a href="#l19.1099"></a><span id="l19.1099" class="difflineplus">+        break;</span>
<a href="#l19.1100"></a><span id="l19.1100" class="difflineplus">+      case &quot;account-disconnected&quot;:</span>
<a href="#l19.1101"></a><span id="l19.1101" class="difflineplus">+        getSystemLogWriter(aSubject).logEvent(</span>
<a href="#l19.1102"></a><span id="l19.1102" class="difflineplus">+          &quot;+++ &quot; + aSubject.name + &quot; signed off&quot;</span>
<a href="#l19.1103"></a><span id="l19.1103" class="difflineplus">+        );</span>
<a href="#l19.1104"></a><span id="l19.1104" class="difflineplus">+        closeSystemLogWriter(aSubject);</span>
<a href="#l19.1105"></a><span id="l19.1105" class="difflineplus">+        break;</span>
<a href="#l19.1106"></a><span id="l19.1106" class="difflineplus">+      case &quot;account-buddy-status-changed&quot;:</span>
<a href="#l19.1107"></a><span id="l19.1107" class="difflineplus">+        let status;</span>
<a href="#l19.1108"></a><span id="l19.1108" class="difflineplus">+        if (!aSubject.online) {</span>
<a href="#l19.1109"></a><span id="l19.1109" class="difflineplus">+          status = &quot;Offline&quot;;</span>
<a href="#l19.1110"></a><span id="l19.1110" class="difflineplus">+        } else if (aSubject.mobile) {</span>
<a href="#l19.1111"></a><span id="l19.1111" class="difflineplus">+          status = &quot;Mobile&quot;;</span>
<a href="#l19.1112"></a><span id="l19.1112" class="difflineplus">+        } else if (aSubject.idle) {</span>
<a href="#l19.1113"></a><span id="l19.1113" class="difflineplus">+          status = &quot;Idle&quot;;</span>
<a href="#l19.1114"></a><span id="l19.1114" class="difflineplus">+        } else if (aSubject.available) {</span>
<a href="#l19.1115"></a><span id="l19.1115" class="difflineplus">+          status = &quot;Available&quot;;</span>
<a href="#l19.1116"></a><span id="l19.1116" class="difflineplus">+        } else {</span>
<a href="#l19.1117"></a><span id="l19.1117" class="difflineplus">+          status = &quot;Unavailable&quot;;</span>
<a href="#l19.1118"></a><span id="l19.1118" class="difflineplus">+        }</span>
<a href="#l19.1119"></a><span id="l19.1119" class="difflineplus">+</span>
<a href="#l19.1120"></a><span id="l19.1120" class="difflineplus">+        let statusText = aSubject.statusText;</span>
<a href="#l19.1121"></a><span id="l19.1121" class="difflineplus">+        if (statusText) {</span>
<a href="#l19.1122"></a><span id="l19.1122" class="difflineplus">+          status += ' (&quot;' + statusText + '&quot;)';</span>
<a href="#l19.1123"></a><span id="l19.1123" class="difflineplus">+        }</span>
<a href="#l19.1124"></a><span id="l19.1124" class="difflineplus">+</span>
<a href="#l19.1125"></a><span id="l19.1125" class="difflineplus">+        let nameText = aSubject.displayName + &quot; (&quot; + aSubject.userName + &quot;)&quot;;</span>
<a href="#l19.1126"></a><span id="l19.1126" class="difflineplus">+        getSystemLogWriter(aSubject.account).logEvent(</span>
<a href="#l19.1127"></a><span id="l19.1127" class="difflineplus">+          nameText + &quot; is now &quot; + status</span>
<a href="#l19.1128"></a><span id="l19.1128" class="difflineplus">+        );</span>
<a href="#l19.1129"></a><span id="l19.1129" class="difflineplus">+        break;</span>
<a href="#l19.1130"></a><span id="l19.1130" class="difflineplus">+      default:</span>
<a href="#l19.1131"></a><span id="l19.1131" class="difflineplus">+        throw new Error(&quot;Unexpected notification &quot; + aTopic);</span>
<a href="#l19.1132"></a><span id="l19.1132" class="difflineplus">+    }</span>
<a href="#l19.1133"></a><span id="l19.1133" class="difflineplus">+  },</span>
<a href="#l19.1134"></a><span id="l19.1134" class="difflineplus">+</span>
<a href="#l19.1135"></a><span id="l19.1135" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver, Ci.imILogger]),</span>
<a href="#l19.1136"></a><span id="l19.1136" class="difflineplus">+  classDescription: &quot;Logger&quot;,</span>
<a href="#l19.1137"></a><span id="l19.1137" class="difflineplus">+  classID: Components.ID(&quot;{fb0dc220-2c7a-4216-9f19-6b8f3480eae9}&quot;),</span>
<a href="#l19.1138"></a><span id="l19.1138" class="difflineplus">+  contractID: &quot;@mozilla.org/chat/logger;1&quot;,</span>
<a href="#l19.1139"></a><span id="l19.1139" class="difflineplus">+};</span>
<a href="#l19.1140"></a><span id="l19.1140" class="difflineplus">+</span>
<a href="#l19.1141"></a><span id="l19.1141" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([Logger]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/components/src/logger.manifest</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+component {fb0dc220-2c7a-4216-9f19-6b8f3480eae9} logger.js</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+contract @mozilla.org/chat/logger;1 {fb0dc220-2c7a-4216-9f19-6b8f3480eae9}</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+category profile-after-change Logger @mozilla.org/chat/logger;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/chat/components/src/moz.build</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/chat/components/src/moz.build</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,20 +1,24 @@</span>
<a href="#l21.4"></a><span id="l21.4"> # vim: set filetype=python:</span>
<a href="#l21.5"></a><span id="l21.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l21.10"></a><span id="l21.10"> </span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-    'IMAccounts.jsm',</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-    'IMCommands.jsm',</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-    'IMContacts.jsm',</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-    'IMConversations.jsm',</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-    'IMCore.jsm',</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    'Logger.jsm',</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-    'SmileProtocolHandler.jsm'</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+    'imAccounts.js',</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+    'imAccounts.manifest',</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+    'imCommands.js',</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+    'imCommands.manifest',</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+    'imContacts.js',</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+    'imContacts.manifest',</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+    'imConversations.js',</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+    'imConversations.manifest',</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+    'imCore.js',</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+    'imCore.manifest',</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+    'logger.js',</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+    'logger.manifest',</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+    'smileProtocolHandler.js',</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+    'smileProtocolHandler.manifest',</span>
<a href="#l21.34"></a><span id="l21.34"> ]</span>
<a href="#l21.35"></a><span id="l21.35"> </span>
<a href="#l21.36"></a><span id="l21.36" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-    'components.conf',</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.js</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,42 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+  &quot;resource://gre/modules/XPCOMUtils.jsm&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+var { getSmileRealURI } = ChromeUtils.import(</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+  &quot;resource:///modules/imSmileys.jsm&quot;</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+);</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+var kSmileRegexp = /^smile:\/\//;</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+function smileProtocolHandler() {}</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+smileProtocolHandler.prototype = {</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+  scheme: &quot;smile&quot;,</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+  defaultPort: -1,</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+  protocolFlags:</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+    Ci.nsIProtocolHandler.URI_NORELATIVE |</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+    Ci.nsIProtocolHandler.URI_NOAUTH |</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+    Ci.nsIProtocolHandler.URI_IS_UI_RESOURCE |</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+    Ci.nsIProtocolHandler.URI_IS_LOCAL_RESOURCE,</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  newChannel(aURI, aLoadInfo) {</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+    let smile = aURI.spec.replace(kSmileRegexp, &quot;&quot;);</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+    let uri = Services.io.newURI(getSmileRealURI(smile));</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+    let channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+    channel.originalURI = aURI;</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    return channel;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  },</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  allowPort(aPort, aScheme) {</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+    return false;</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+  },</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+  classDescription: &quot;Smile Protocol Handler&quot;,</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+  classID: Components.ID(&quot;{04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}&quot;),</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+  contractID: &quot;@mozilla.org/network/protocol;1?name=smile&quot;,</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+  QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+};</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([smileProtocolHandler]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/chat/components/src/smileProtocolHandler.manifest</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,2 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+component {04e58eae-dfbc-4c9e-8130-6d9ef19cbff4} smileProtocolHandler.js</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+contract @mozilla.org/network/protocol;1?name=smile {04e58eae-dfbc-4c9e-8130-6d9ef19cbff4}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/chat/components/src/test/test_commands.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/chat/components/src/test/test_commands.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -1,16 +1,20 @@</span>
<a href="#l24.4"></a><span id="l24.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.5"></a><span id="l24.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l24.6"></a><span id="l24.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.7"></a><span id="l24.7"> </span>
<a href="#l24.8"></a><span id="l24.8"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9"> // We don't load the command service via Services as we want to access</span>
<a href="#l24.10"></a><span id="l24.10"> // _findCommands in order to avoid having to intercept command execution.</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineminus">-var { IMCommands } = ChromeUtils.import(&quot;resource:///modules/IMCommands.jsm&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+var imCommands = {};</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+  &quot;resource:///components/imCommands.js&quot;,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+  imCommands</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+);</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> var kPrplId = &quot;green&quot;;</span>
<a href="#l24.19"></a><span id="l24.19"> var kPrplId2 = &quot;red&quot;;</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21"> var fakeAccount = {</span>
<a href="#l24.22"></a><span id="l24.22">   connected: true,</span>
<a href="#l24.23"></a><span id="l24.23">   protocol: { id: kPrplId },</span>
<a href="#l24.24"></a><span id="l24.24"> };</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineat">@@ -39,17 +43,17 @@ fakeCommand.prototype = {</span>
<a href="#l24.26"></a><span id="l24.26">     return &quot;&quot;;</span>
<a href="#l24.27"></a><span id="l24.27">   },</span>
<a href="#l24.28"></a><span id="l24.28">   usageContext: Ci.imICommand.CMD_CONTEXT_ALL,</span>
<a href="#l24.29"></a><span id="l24.29">   priority: Ci.imICommand.CMD_PRIORITY_PRPL,</span>
<a href="#l24.30"></a><span id="l24.30">   run: (aMsg, aConv) =&gt; true,</span>
<a href="#l24.31"></a><span id="l24.31"> };</span>
<a href="#l24.32"></a><span id="l24.32"> </span>
<a href="#l24.33"></a><span id="l24.33"> function run_test() {</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  let cmdserv = new IMCommands();</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  let cmdserv = new imCommands.CommandsService();</span>
<a href="#l24.36"></a><span id="l24.36">   cmdserv.initCommands();</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   // Some commands providing multiple possible completions.</span>
<a href="#l24.39"></a><span id="l24.39">   cmdserv.registerCommand(new fakeCommand(&quot;banana&quot;), kPrplId2);</span>
<a href="#l24.40"></a><span id="l24.40">   cmdserv.registerCommand(new fakeCommand(&quot;baloney&quot;), kPrplId2);</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42">   // MUC-only command.</span>
<a href="#l24.43"></a><span id="l24.43">   cmdserv.registerCommand(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/chat/components/src/test/test_conversations.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/chat/components/src/test/test_conversations.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,17 +1,20 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l25.5"></a><span id="l25.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l25.8"></a><span id="l25.8"> var { GenericConvIMPrototype, Message } = ChromeUtils.import(</span>
<a href="#l25.9"></a><span id="l25.9">   &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l25.10"></a><span id="l25.10"> );</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineminus">-var { IMMessage, UIConversation } = ChromeUtils.import(</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  &quot;resource:///modules/IMConversations.jsm&quot;</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+var imConversations = {};</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  &quot;resource:///components/imConversations.js&quot;,</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  imConversations</span>
<a href="#l25.18"></a><span id="l25.18"> );</span>
<a href="#l25.19"></a><span id="l25.19"> </span>
<a href="#l25.20"></a><span id="l25.20"> // Fake prplConversation</span>
<a href="#l25.21"></a><span id="l25.21"> var _id = 0;</span>
<a href="#l25.22"></a><span id="l25.22"> function Conversation(aName) {</span>
<a href="#l25.23"></a><span id="l25.23">   this._name = aName;</span>
<a href="#l25.24"></a><span id="l25.24">   this._observers = [];</span>
<a href="#l25.25"></a><span id="l25.25">   this._date = Date.now() * 1000;</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineat">@@ -43,17 +46,17 @@ Conversation.prototype = {</span>
<a href="#l25.27"></a><span id="l25.27"> // message. This prevents regressions due to JS coercions.</span>
<a href="#l25.28"></a><span id="l25.28"> var test_null_message = function() {</span>
<a href="#l25.29"></a><span id="l25.29">   let originalMessage = &quot;Hi!&quot;;</span>
<a href="#l25.30"></a><span id="l25.30">   let pMsg = new Message(&quot;buddy&quot;, originalMessage, {</span>
<a href="#l25.31"></a><span id="l25.31">     outgoing: true,</span>
<a href="#l25.32"></a><span id="l25.32">     _alias: &quot;buddy&quot;,</span>
<a href="#l25.33"></a><span id="l25.33">     time: Date.now(),</span>
<a href="#l25.34"></a><span id="l25.34">   });</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-  let iMsg = new IMMessage(pMsg);</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+  let iMsg = new imConversations.imMessage(pMsg);</span>
<a href="#l25.37"></a><span id="l25.37">   equal(iMsg.message, originalMessage, &quot;Expected the original message.&quot;);</span>
<a href="#l25.38"></a><span id="l25.38">   // Setting the message should prevent a fallback to the original.</span>
<a href="#l25.39"></a><span id="l25.39">   iMsg.message = &quot;&quot;;</span>
<a href="#l25.40"></a><span id="l25.40">   equal(</span>
<a href="#l25.41"></a><span id="l25.41">     iMsg.message,</span>
<a href="#l25.42"></a><span id="l25.42">     &quot;&quot;,</span>
<a href="#l25.43"></a><span id="l25.43">     &quot;Expected an empty string; not the original message.&quot;</span>
<a href="#l25.44"></a><span id="l25.44">   );</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineat">@@ -96,17 +99,17 @@ function rot13(aString) {</span>
<a href="#l25.46"></a><span id="l25.46"> //</span>
<a href="#l25.47"></a><span id="l25.47"> // The test walks the sending path, which covers both.</span>
<a href="#l25.48"></a><span id="l25.48"> var test_message_transformation = function() {</span>
<a href="#l25.49"></a><span id="l25.49">   let conv = new Conversation();</span>
<a href="#l25.50"></a><span id="l25.50">   conv.sendMsg = function(aMsg) {</span>
<a href="#l25.51"></a><span id="l25.51">     this.writeMessage(&quot;user&quot;, aMsg, { outgoing: true });</span>
<a href="#l25.52"></a><span id="l25.52">   };</span>
<a href="#l25.53"></a><span id="l25.53"> </span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  let uiConv = new UIConversation(conv);</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+  let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l25.56"></a><span id="l25.56">   let message = &quot;Hello!&quot;;</span>
<a href="#l25.57"></a><span id="l25.57">   let receivedMsg = false,</span>
<a href="#l25.58"></a><span id="l25.58">     newTxt = false;</span>
<a href="#l25.59"></a><span id="l25.59"> </span>
<a href="#l25.60"></a><span id="l25.60">   uiConv.addObserver({</span>
<a href="#l25.61"></a><span id="l25.61">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l25.62"></a><span id="l25.62">       switch (aTopic) {</span>
<a href="#l25.63"></a><span id="l25.63">         case &quot;sending-message&quot;:</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineat">@@ -163,17 +166,17 @@ var test_cancel_send_message = function(</span>
<a href="#l25.65"></a><span id="l25.65">   conv.sendMsg = function(aMsg) {</span>
<a href="#l25.66"></a><span id="l25.66">     ok(</span>
<a href="#l25.67"></a><span id="l25.67">       false,</span>
<a href="#l25.68"></a><span id="l25.68">       &quot;The message should have been halted in the conversation service.&quot;</span>
<a href="#l25.69"></a><span id="l25.69">     );</span>
<a href="#l25.70"></a><span id="l25.70">   };</span>
<a href="#l25.71"></a><span id="l25.71"> </span>
<a href="#l25.72"></a><span id="l25.72">   let sending = false;</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineminus">-  let uiConv = new UIConversation(conv);</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+  let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l25.75"></a><span id="l25.75">   uiConv.addObserver({</span>
<a href="#l25.76"></a><span id="l25.76">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l25.77"></a><span id="l25.77">       switch (aTopic) {</span>
<a href="#l25.78"></a><span id="l25.78">         case &quot;sending-message&quot;:</span>
<a href="#l25.79"></a><span id="l25.79">           ok(</span>
<a href="#l25.80"></a><span id="l25.80">             aObject.QueryInterface(Ci.imIOutgoingMessage),</span>
<a href="#l25.81"></a><span id="l25.81">             &quot;Wrong message type.&quot;</span>
<a href="#l25.82"></a><span id="l25.82">           );</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineat">@@ -197,17 +200,17 @@ var test_cancel_send_message = function(</span>
<a href="#l25.84"></a><span id="l25.84"> // A test that cancels a message before it gets displayed.</span>
<a href="#l25.85"></a><span id="l25.85"> var test_cancel_display_message = function() {</span>
<a href="#l25.86"></a><span id="l25.86">   let conv = new Conversation();</span>
<a href="#l25.87"></a><span id="l25.87">   conv.sendMsg = function(aMsg) {</span>
<a href="#l25.88"></a><span id="l25.88">     this.writeMessage(&quot;user&quot;, aMsg, { outgoing: true });</span>
<a href="#l25.89"></a><span id="l25.89">   };</span>
<a href="#l25.90"></a><span id="l25.90"> </span>
<a href="#l25.91"></a><span id="l25.91">   let received = false;</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-  let uiConv = new UIConversation(conv);</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+  let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l25.94"></a><span id="l25.94">   uiConv.addObserver({</span>
<a href="#l25.95"></a><span id="l25.95">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l25.96"></a><span id="l25.96">       switch (aTopic) {</span>
<a href="#l25.97"></a><span id="l25.97">         case &quot;received-message&quot;:</span>
<a href="#l25.98"></a><span id="l25.98">           ok(aObject.QueryInterface(Ci.imIMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l25.99"></a><span id="l25.99">           aObject.cancelled = true;</span>
<a href="#l25.100"></a><span id="l25.100">           received = true;</span>
<a href="#l25.101"></a><span id="l25.101">           break;</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineat">@@ -243,17 +246,17 @@ var test_prpl_message_prep = function() </span>
<a href="#l25.103"></a><span id="l25.103"> </span>
<a href="#l25.104"></a><span id="l25.104">   conv.prepareForDisplaying = function(aMsg) {</span>
<a href="#l25.105"></a><span id="l25.105">     ok(aMsg.QueryInterface(Ci.imIMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l25.106"></a><span id="l25.106">     equal(aMsg.displayMessage, prefix + msg, &quot;Expected the prefixed message.&quot;);</span>
<a href="#l25.107"></a><span id="l25.107">     aMsg.displayMessage = aMsg.displayMessage.slice(prefix.length);</span>
<a href="#l25.108"></a><span id="l25.108">   };</span>
<a href="#l25.109"></a><span id="l25.109"> </span>
<a href="#l25.110"></a><span id="l25.110">   let receivedMsg = false;</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineminus">-  let uiConv = new UIConversation(conv);</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+  let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l25.113"></a><span id="l25.113">   uiConv.addObserver({</span>
<a href="#l25.114"></a><span id="l25.114">     observe(aObject, aTopic, aMsg) {</span>
<a href="#l25.115"></a><span id="l25.115">       if (aTopic === &quot;new-text&quot;) {</span>
<a href="#l25.116"></a><span id="l25.116">         ok(prepared, &quot;The message was not prepared before sending.&quot;);</span>
<a href="#l25.117"></a><span id="l25.117">         equal(aObject.displayMessage, msg, &quot;Expected the original message.&quot;);</span>
<a href="#l25.118"></a><span id="l25.118">         receivedMsg = true;</span>
<a href="#l25.119"></a><span id="l25.119">       }</span>
<a href="#l25.120"></a><span id="l25.120">     },</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineat">@@ -276,17 +279,17 @@ var test_split_message_before_sending = </span>
<a href="#l25.122"></a><span id="l25.122">     equal(aMsg, msgs[msgCount++], &quot;Sending an unexpected message.&quot;);</span>
<a href="#l25.123"></a><span id="l25.123">   };</span>
<a href="#l25.124"></a><span id="l25.124">   conv.prepareForSending = function(aMsg) {</span>
<a href="#l25.125"></a><span id="l25.125">     ok(aMsg.QueryInterface(Ci.imIOutgoingMessage), &quot;Wrong message type.&quot;);</span>
<a href="#l25.126"></a><span id="l25.126">     prepared = true;</span>
<a href="#l25.127"></a><span id="l25.127">     return aMsg.message.split(&quot;\n&quot;);</span>
<a href="#l25.128"></a><span id="l25.128">   };</span>
<a href="#l25.129"></a><span id="l25.129"> </span>
<a href="#l25.130"></a><span id="l25.130" class="difflineminus">-  let uiConv = new UIConversation(conv);</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+  let uiConv = new imConversations.UIConversation(conv);</span>
<a href="#l25.132"></a><span id="l25.132">   uiConv.sendMsg(msg);</span>
<a href="#l25.133"></a><span id="l25.133"> </span>
<a href="#l25.134"></a><span id="l25.134">   ok(prepared, &quot;Message wasn't prepared for sending.&quot;);</span>
<a href="#l25.135"></a><span id="l25.135">   equal(msgCount, 3, &quot;Not enough messages were sent.&quot;);</span>
<a href="#l25.136"></a><span id="l25.136"> };</span>
<a href="#l25.137"></a><span id="l25.137"> </span>
<a href="#l25.138"></a><span id="l25.138"> function run_test() {</span>
<a href="#l25.139"></a><span id="l25.139">   test_null_message();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/chat/components/src/test/test_logger.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/chat/components/src/test/test_logger.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -3,29 +3,20 @@</span>
<a href="#l26.4"></a><span id="l26.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.5"></a><span id="l26.5"> </span>
<a href="#l26.6"></a><span id="l26.6"> do_get_profile();</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l26.9"></a><span id="l26.9"> const { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l26.10"></a><span id="l26.10"> </span>
<a href="#l26.11"></a><span id="l26.11"> var gLogger = {};</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-var {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-  Logger,</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  encodeName,</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-  convIsRealMUC,</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineminus">-  getLogFolderPathForAccount,</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-  getLogFilePathForConversation,</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineminus">-  getNewLogFileName,</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineminus">-  queueFileOperation,</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  fileOperations,</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineminus">-  appendToFile,</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineminus">-  getLogWriter,</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-  closeLogWriter,</span>
<a href="#l26.24"></a><span id="l26.24" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/Logger.jsm&quot;);</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineplus">+Services.scriptloader.loadSubScript(</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineplus">+  &quot;resource:///components/logger.js&quot;,</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineplus">+  gLogger</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineplus">+);</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> var logDirPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32"> var dummyAccount = {</span>
<a href="#l26.33"></a><span id="l26.33">   name: &quot;dummy-account&quot;,</span>
<a href="#l26.34"></a><span id="l26.34">   normalizedName: &quot;dummyaccount&quot;,</span>
<a href="#l26.35"></a><span id="l26.35">   protocol: {</span>
<a href="#l26.36"></a><span id="l26.36">     normalizedName: &quot;dummy&quot;,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineat">@@ -188,147 +179,150 @@ var encodeName_output = [</span>
<a href="#l26.38"></a><span id="l26.38">   &quot;%25file&quot;,</span>
<a href="#l26.39"></a><span id="l26.39">   &quot;%5c&quot; + &quot;fi&quot; + &quot;%3f%2a%26%25&quot; + &quot;le&quot; + &quot;%3c%3e&quot;, // eslint-disable-line no-useless-concat</span>
<a href="#l26.40"></a><span id="l26.40"> ];</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42"> var test_queueFileOperation = async function() {</span>
<a href="#l26.43"></a><span id="l26.43">   let dummyRejectedOperation = () =&gt; Promise.reject(&quot;Rejected!&quot;);</span>
<a href="#l26.44"></a><span id="l26.44">   let dummyResolvedOperation = () =&gt; Promise.resolve(&quot;Resolved!&quot;);</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46" class="difflineminus">-  // Immediately after calling queueFileOperation, &quot;path1&quot; should be mapped to p1.</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineplus">+  let gFP = gLogger.gFilePromises;</span>
<a href="#l26.48"></a><span id="l26.48" class="difflineplus">+  let qFO = gLogger.queueFileOperation;</span>
<a href="#l26.49"></a><span id="l26.49" class="difflineplus">+</span>
<a href="#l26.50"></a><span id="l26.50" class="difflineplus">+  // Immediately after calling qFO, &quot;path1&quot; should be mapped to p1.</span>
<a href="#l26.51"></a><span id="l26.51">   // After yielding, the reference should be cleared from the map.</span>
<a href="#l26.52"></a><span id="l26.52" class="difflineminus">-  let p1 = queueFileOperation(&quot;path1&quot;, dummyResolvedOperation);</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  equal(fileOperations.get(&quot;path1&quot;), p1);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineplus">+  let p1 = qFO(&quot;path1&quot;, dummyResolvedOperation);</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineplus">+  equal(gFP.get(&quot;path1&quot;), p1);</span>
<a href="#l26.56"></a><span id="l26.56">   await p1;</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineminus">-  ok(!fileOperations.has(&quot;path1&quot;));</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+  ok(!gFP.has(&quot;path1&quot;));</span>
<a href="#l26.59"></a><span id="l26.59"> </span>
<a href="#l26.60"></a><span id="l26.60">   // Repeat above test for a rejected promise.</span>
<a href="#l26.61"></a><span id="l26.61" class="difflineminus">-  let p2 = queueFileOperation(&quot;path2&quot;, dummyRejectedOperation);</span>
<a href="#l26.62"></a><span id="l26.62" class="difflineminus">-  equal(fileOperations.get(&quot;path2&quot;), p2);</span>
<a href="#l26.63"></a><span id="l26.63" class="difflineplus">+  let p2 = qFO(&quot;path2&quot;, dummyRejectedOperation);</span>
<a href="#l26.64"></a><span id="l26.64" class="difflineplus">+  equal(gFP.get(&quot;path2&quot;), p2);</span>
<a href="#l26.65"></a><span id="l26.65">   // This should throw since p2 rejected. Drop the error.</span>
<a href="#l26.66"></a><span id="l26.66">   await p2.then(() =&gt; do_throw(), () =&gt; {});</span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-  ok(!fileOperations.has(&quot;path2&quot;));</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  ok(!gFP.has(&quot;path2&quot;));</span>
<a href="#l26.69"></a><span id="l26.69"> </span>
<a href="#l26.70"></a><span id="l26.70">   let onPromiseComplete = (aPromise, aHandler) =&gt; {</span>
<a href="#l26.71"></a><span id="l26.71">     return aPromise.then(aHandler, aHandler);</span>
<a href="#l26.72"></a><span id="l26.72">   };</span>
<a href="#l26.73"></a><span id="l26.73">   let test_queueOrder = aOperation =&gt; {</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-    let promise = queueFileOperation(&quot;queueOrderPath&quot;, aOperation);</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+    let promise = qFO(&quot;queueOrderPath&quot;, aOperation);</span>
<a href="#l26.76"></a><span id="l26.76">     let firstOperationComplete = false;</span>
<a href="#l26.77"></a><span id="l26.77">     onPromiseComplete(promise, () =&gt; (firstOperationComplete = true));</span>
<a href="#l26.78"></a><span id="l26.78" class="difflineminus">-    return queueFileOperation(&quot;queueOrderPath&quot;, () =&gt; {</span>
<a href="#l26.79"></a><span id="l26.79" class="difflineplus">+    return qFO(&quot;queueOrderPath&quot;, () =&gt; {</span>
<a href="#l26.80"></a><span id="l26.80">       ok(firstOperationComplete);</span>
<a href="#l26.81"></a><span id="l26.81">     });</span>
<a href="#l26.82"></a><span id="l26.82">   };</span>
<a href="#l26.83"></a><span id="l26.83">   // Test the queue order for rejected and resolved promises.</span>
<a href="#l26.84"></a><span id="l26.84">   await test_queueOrder(dummyResolvedOperation);</span>
<a href="#l26.85"></a><span id="l26.85">   await test_queueOrder(dummyRejectedOperation);</span>
<a href="#l26.86"></a><span id="l26.86"> };</span>
<a href="#l26.87"></a><span id="l26.87"> </span>
<a href="#l26.88"></a><span id="l26.88"> var test_getLogFolderPathForAccount = async function() {</span>
<a href="#l26.89"></a><span id="l26.89" class="difflineminus">-  let path = getLogFolderPathForAccount(dummyAccount);</span>
<a href="#l26.90"></a><span id="l26.90" class="difflineplus">+  let path = gLogger.getLogFolderPathForAccount(dummyAccount);</span>
<a href="#l26.91"></a><span id="l26.91">   equal(</span>
<a href="#l26.92"></a><span id="l26.92">     OS.Path.join(</span>
<a href="#l26.93"></a><span id="l26.93">       logDirPath,</span>
<a href="#l26.94"></a><span id="l26.94">       dummyAccount.protocol.normalizedName,</span>
<a href="#l26.95"></a><span id="l26.95" class="difflineminus">-      encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineplus">+      gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.97"></a><span id="l26.97">     ),</span>
<a href="#l26.98"></a><span id="l26.98">     path</span>
<a href="#l26.99"></a><span id="l26.99">   );</span>
<a href="#l26.100"></a><span id="l26.100"> };</span>
<a href="#l26.101"></a><span id="l26.101"> </span>
<a href="#l26.102"></a><span id="l26.102"> // Tests the global function getLogFilePathForConversation in logger.js.</span>
<a href="#l26.103"></a><span id="l26.103"> var test_getLogFilePathForConversation = async function() {</span>
<a href="#l26.104"></a><span id="l26.104" class="difflineminus">-  let path = getLogFilePathForConversation(dummyConv, &quot;format&quot;);</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineplus">+  let path = gLogger.getLogFilePathForConversation(dummyConv, &quot;format&quot;);</span>
<a href="#l26.106"></a><span id="l26.106">   let expectedPath = OS.Path.join(</span>
<a href="#l26.107"></a><span id="l26.107">     logDirPath,</span>
<a href="#l26.108"></a><span id="l26.108">     dummyAccount.protocol.normalizedName,</span>
<a href="#l26.109"></a><span id="l26.109" class="difflineminus">-    encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.110"></a><span id="l26.110" class="difflineplus">+    gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.111"></a><span id="l26.111">   );</span>
<a href="#l26.112"></a><span id="l26.112">   expectedPath = OS.Path.join(</span>
<a href="#l26.113"></a><span id="l26.113">     expectedPath,</span>
<a href="#l26.114"></a><span id="l26.114" class="difflineminus">-    encodeName(dummyConv.normalizedName)</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineplus">+    gLogger.encodeName(dummyConv.normalizedName)</span>
<a href="#l26.116"></a><span id="l26.116">   );</span>
<a href="#l26.117"></a><span id="l26.117">   expectedPath = OS.Path.join(</span>
<a href="#l26.118"></a><span id="l26.118">     expectedPath,</span>
<a href="#l26.119"></a><span id="l26.119" class="difflineminus">-    getNewLogFileName(&quot;format&quot;, dummyConv.startDate / 1000)</span>
<a href="#l26.120"></a><span id="l26.120" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyConv.startDate / 1000)</span>
<a href="#l26.121"></a><span id="l26.121">   );</span>
<a href="#l26.122"></a><span id="l26.122">   equal(path, expectedPath);</span>
<a href="#l26.123"></a><span id="l26.123"> };</span>
<a href="#l26.124"></a><span id="l26.124"> </span>
<a href="#l26.125"></a><span id="l26.125"> var test_getLogFilePathForMUC = async function() {</span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-  let path = getLogFilePathForConversation(dummyMUC, &quot;format&quot;);</span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+  let path = gLogger.getLogFilePathForConversation(dummyMUC, &quot;format&quot;);</span>
<a href="#l26.128"></a><span id="l26.128">   let expectedPath = OS.Path.join(</span>
<a href="#l26.129"></a><span id="l26.129">     logDirPath,</span>
<a href="#l26.130"></a><span id="l26.130">     dummyAccount.protocol.normalizedName,</span>
<a href="#l26.131"></a><span id="l26.131" class="difflineminus">-    encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.132"></a><span id="l26.132" class="difflineplus">+    gLogger.encodeName(dummyAccount.normalizedName)</span>
<a href="#l26.133"></a><span id="l26.133">   );</span>
<a href="#l26.134"></a><span id="l26.134">   expectedPath = OS.Path.join(</span>
<a href="#l26.135"></a><span id="l26.135">     expectedPath,</span>
<a href="#l26.136"></a><span id="l26.136" class="difflineminus">-    encodeName(dummyMUC.normalizedName + &quot;.chat&quot;)</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineplus">+    gLogger.encodeName(dummyMUC.normalizedName + &quot;.chat&quot;)</span>
<a href="#l26.138"></a><span id="l26.138">   );</span>
<a href="#l26.139"></a><span id="l26.139">   expectedPath = OS.Path.join(</span>
<a href="#l26.140"></a><span id="l26.140">     expectedPath,</span>
<a href="#l26.141"></a><span id="l26.141" class="difflineminus">-    getNewLogFileName(&quot;format&quot;, dummyMUC.startDate / 1000)</span>
<a href="#l26.142"></a><span id="l26.142" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyMUC.startDate / 1000)</span>
<a href="#l26.143"></a><span id="l26.143">   );</span>
<a href="#l26.144"></a><span id="l26.144">   equal(path, expectedPath);</span>
<a href="#l26.145"></a><span id="l26.145"> };</span>
<a href="#l26.146"></a><span id="l26.146"> </span>
<a href="#l26.147"></a><span id="l26.147"> var test_getLogFilePathForTwitterConv = async function() {</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineminus">-  let path = getLogFilePathForConversation(dummyTwitterConv, &quot;format&quot;);</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  let path = gLogger.getLogFilePathForConversation(dummyTwitterConv, &quot;format&quot;);</span>
<a href="#l26.150"></a><span id="l26.150">   let expectedPath = OS.Path.join(</span>
<a href="#l26.151"></a><span id="l26.151">     logDirPath,</span>
<a href="#l26.152"></a><span id="l26.152">     dummyTwitterAccount.protocol.normalizedName,</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineminus">-    encodeName(dummyTwitterAccount.normalizedName)</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+    gLogger.encodeName(dummyTwitterAccount.normalizedName)</span>
<a href="#l26.155"></a><span id="l26.155">   );</span>
<a href="#l26.156"></a><span id="l26.156">   expectedPath = OS.Path.join(</span>
<a href="#l26.157"></a><span id="l26.157">     expectedPath,</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineminus">-    encodeName(dummyTwitterConv.normalizedName)</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+    gLogger.encodeName(dummyTwitterConv.normalizedName)</span>
<a href="#l26.160"></a><span id="l26.160">   );</span>
<a href="#l26.161"></a><span id="l26.161">   expectedPath = OS.Path.join(</span>
<a href="#l26.162"></a><span id="l26.162">     expectedPath,</span>
<a href="#l26.163"></a><span id="l26.163" class="difflineminus">-    getNewLogFileName(&quot;format&quot;, dummyTwitterConv.startDate / 1000)</span>
<a href="#l26.164"></a><span id="l26.164" class="difflineplus">+    gLogger.getNewLogFileName(&quot;format&quot;, dummyTwitterConv.startDate / 1000)</span>
<a href="#l26.165"></a><span id="l26.165">   );</span>
<a href="#l26.166"></a><span id="l26.166">   equal(path, expectedPath);</span>
<a href="#l26.167"></a><span id="l26.167"> };</span>
<a href="#l26.168"></a><span id="l26.168"> </span>
<a href="#l26.169"></a><span id="l26.169"> var test_appendToFile = async function() {</span>
<a href="#l26.170"></a><span id="l26.170">   const kStringToWrite = &quot;Hello, world!&quot;;</span>
<a href="#l26.171"></a><span id="l26.171">   let path = OS.Path.join(OS.Constants.Path.profileDir, &quot;testFile.txt&quot;);</span>
<a href="#l26.172"></a><span id="l26.172">   let encoder = new TextEncoder();</span>
<a href="#l26.173"></a><span id="l26.173">   let encodedString = encoder.encode(kStringToWrite);</span>
<a href="#l26.174"></a><span id="l26.174" class="difflineminus">-  appendToFile(path, encodedString);</span>
<a href="#l26.175"></a><span id="l26.175" class="difflineplus">+  gLogger.appendToFile(path, encodedString);</span>
<a href="#l26.176"></a><span id="l26.176">   encodedString = encoder.encode(kStringToWrite);</span>
<a href="#l26.177"></a><span id="l26.177" class="difflineminus">-  appendToFile(path, encodedString);</span>
<a href="#l26.178"></a><span id="l26.178" class="difflineplus">+  gLogger.appendToFile(path, encodedString);</span>
<a href="#l26.179"></a><span id="l26.179">   let text = new TextDecoder().decode(</span>
<a href="#l26.180"></a><span id="l26.180" class="difflineminus">-    await queueFileOperation(path, () =&gt; OS.File.read(path))</span>
<a href="#l26.181"></a><span id="l26.181" class="difflineplus">+    await gLogger.queueFileOperation(path, () =&gt; OS.File.read(path))</span>
<a href="#l26.182"></a><span id="l26.182">   );</span>
<a href="#l26.183"></a><span id="l26.183">   // The read text should be equal to kStringToWrite repeated twice.</span>
<a href="#l26.184"></a><span id="l26.184">   equal(text, kStringToWrite + kStringToWrite);</span>
<a href="#l26.185"></a><span id="l26.185">   await OS.File.remove(path);</span>
<a href="#l26.186"></a><span id="l26.186"> };</span>
<a href="#l26.187"></a><span id="l26.187"> </span>
<a href="#l26.188"></a><span id="l26.188"> // Tests the getLogPathsForConversation API defined in the imILogger interface.</span>
<a href="#l26.189"></a><span id="l26.189"> var test_getLogPathsForConversation = async function() {</span>
<a href="#l26.190"></a><span id="l26.190" class="difflineminus">-  let logger = new Logger();</span>
<a href="#l26.191"></a><span id="l26.191" class="difflineplus">+  let logger = new gLogger.Logger();</span>
<a href="#l26.192"></a><span id="l26.192">   let paths = await logger.getLogPathsForConversation(dummyConv);</span>
<a href="#l26.193"></a><span id="l26.193">   // The path should be null since a LogWriter hasn't been created yet.</span>
<a href="#l26.194"></a><span id="l26.194">   equal(paths, null);</span>
<a href="#l26.195"></a><span id="l26.195" class="difflineminus">-  let logWriter = getLogWriter(dummyConv);</span>
<a href="#l26.196"></a><span id="l26.196" class="difflineplus">+  let logWriter = gLogger.getLogWriter(dummyConv);</span>
<a href="#l26.197"></a><span id="l26.197">   paths = await logger.getLogPathsForConversation(dummyConv);</span>
<a href="#l26.198"></a><span id="l26.198">   equal(paths.length, 1);</span>
<a href="#l26.199"></a><span id="l26.199">   equal(paths[0], logWriter.currentPath);</span>
<a href="#l26.200"></a><span id="l26.200">   ok(await OS.File.exists(paths[0]));</span>
<a href="#l26.201"></a><span id="l26.201">   // Ensure this doesn't interfere with future tests.</span>
<a href="#l26.202"></a><span id="l26.202">   await OS.File.remove(paths[0]);</span>
<a href="#l26.203"></a><span id="l26.203" class="difflineminus">-  closeLogWriter(dummyConv);</span>
<a href="#l26.204"></a><span id="l26.204" class="difflineplus">+  gLogger.closeLogWriter(dummyConv);</span>
<a href="#l26.205"></a><span id="l26.205"> };</span>
<a href="#l26.206"></a><span id="l26.206"> </span>
<a href="#l26.207"></a><span id="l26.207"> var test_logging = async function() {</span>
<a href="#l26.208"></a><span id="l26.208" class="difflineminus">-  let logger = new Logger();</span>
<a href="#l26.209"></a><span id="l26.209" class="difflineplus">+  let logger = new gLogger.Logger();</span>
<a href="#l26.210"></a><span id="l26.210">   let oneSec = 1000000; // Microseconds.</span>
<a href="#l26.211"></a><span id="l26.211"> </span>
<a href="#l26.212"></a><span id="l26.212">   // Creates a set of dummy messages for a conv (sets appropriate times).</span>
<a href="#l26.213"></a><span id="l26.213">   let getMsgsForConv = function(aConv) {</span>
<a href="#l26.214"></a><span id="l26.214">     // Convert to seconds because that's what logMessage expects.</span>
<a href="#l26.215"></a><span id="l26.215">     let startTime = Math.round(aConv.startDate / oneSec);</span>
<a href="#l26.216"></a><span id="l26.216">     return [</span>
<a href="#l26.217"></a><span id="l26.217">       {</span>
<a href="#l26.218"></a><span id="l26.218" class="difflineat">@@ -356,45 +350,45 @@ var test_logging = async function() {</span>
<a href="#l26.219"></a><span id="l26.219">         incoming: true,</span>
<a href="#l26.220"></a><span id="l26.220">       },</span>
<a href="#l26.221"></a><span id="l26.221">     ];</span>
<a href="#l26.222"></a><span id="l26.222">   };</span>
<a href="#l26.223"></a><span id="l26.223">   let firstDayMsgs = getMsgsForConv(dummyConv);</span>
<a href="#l26.224"></a><span id="l26.224">   let secondDayMsgs = getMsgsForConv(dummyConv2);</span>
<a href="#l26.225"></a><span id="l26.225"> </span>
<a href="#l26.226"></a><span id="l26.226">   let logMessagesForConv = async function(aConv, aMessages) {</span>
<a href="#l26.227"></a><span id="l26.227" class="difflineminus">-    let logWriter = getLogWriter(aConv);</span>
<a href="#l26.228"></a><span id="l26.228" class="difflineplus">+    let logWriter = gLogger.getLogWriter(aConv);</span>
<a href="#l26.229"></a><span id="l26.229">     for (let message of aMessages) {</span>
<a href="#l26.230"></a><span id="l26.230">       logWriter.logMessage(message);</span>
<a href="#l26.231"></a><span id="l26.231">     }</span>
<a href="#l26.232"></a><span id="l26.232">     // If we don't wait for the messages to get written, we have no guarantee</span>
<a href="#l26.233"></a><span id="l26.233">     // later in the test that the log files were created, and getConversation</span>
<a href="#l26.234"></a><span id="l26.234">     // will return an EmptyEnumerator. Logging the messages is queued on the</span>
<a href="#l26.235"></a><span id="l26.235">     // _initialized promise, so we need to await on that first.</span>
<a href="#l26.236"></a><span id="l26.236">     await logWriter._initialized;</span>
<a href="#l26.237"></a><span id="l26.237" class="difflineminus">-    await fileOperations.get(logWriter.currentPath);</span>
<a href="#l26.238"></a><span id="l26.238" class="difflineplus">+    await gLogger.gFilePromises.get(logWriter.currentPath);</span>
<a href="#l26.239"></a><span id="l26.239">     // Ensure two different files for the different dates.</span>
<a href="#l26.240"></a><span id="l26.240" class="difflineminus">-    closeLogWriter(aConv);</span>
<a href="#l26.241"></a><span id="l26.241" class="difflineplus">+    gLogger.closeLogWriter(aConv);</span>
<a href="#l26.242"></a><span id="l26.242">   };</span>
<a href="#l26.243"></a><span id="l26.243">   await logMessagesForConv(dummyConv, firstDayMsgs);</span>
<a href="#l26.244"></a><span id="l26.244">   await logMessagesForConv(dummyConv2, secondDayMsgs);</span>
<a href="#l26.245"></a><span id="l26.245"> </span>
<a href="#l26.246"></a><span id="l26.246">   // Write a zero-length file and a file with incorrect JSON for each day</span>
<a href="#l26.247"></a><span id="l26.247">   // to ensure they are handled correctly.</span>
<a href="#l26.248"></a><span id="l26.248">   let logDir = OS.Path.dirname(</span>
<a href="#l26.249"></a><span id="l26.249" class="difflineminus">-    getLogFilePathForConversation(dummyConv, &quot;json&quot;)</span>
<a href="#l26.250"></a><span id="l26.250" class="difflineplus">+    gLogger.getLogFilePathForConversation(dummyConv, &quot;json&quot;)</span>
<a href="#l26.251"></a><span id="l26.251">   );</span>
<a href="#l26.252"></a><span id="l26.252">   let createBadFiles = async function(aConv) {</span>
<a href="#l26.253"></a><span id="l26.253">     let blankFile = OS.Path.join(</span>
<a href="#l26.254"></a><span id="l26.254">       logDir,</span>
<a href="#l26.255"></a><span id="l26.255" class="difflineminus">-      getNewLogFileName(&quot;json&quot;, (aConv.startDate + oneSec) / 1000)</span>
<a href="#l26.256"></a><span id="l26.256" class="difflineplus">+      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + oneSec) / 1000)</span>
<a href="#l26.257"></a><span id="l26.257">     );</span>
<a href="#l26.258"></a><span id="l26.258">     let invalidJSONFile = OS.Path.join(</span>
<a href="#l26.259"></a><span id="l26.259">       logDir,</span>
<a href="#l26.260"></a><span id="l26.260" class="difflineminus">-      getNewLogFileName(&quot;json&quot;, (aConv.startDate + 2 * oneSec) / 1000)</span>
<a href="#l26.261"></a><span id="l26.261" class="difflineplus">+      gLogger.getNewLogFileName(&quot;json&quot;, (aConv.startDate + 2 * oneSec) / 1000)</span>
<a href="#l26.262"></a><span id="l26.262">     );</span>
<a href="#l26.263"></a><span id="l26.263">     let file = await OS.File.open(blankFile, { truncate: true });</span>
<a href="#l26.264"></a><span id="l26.264">     await file.close();</span>
<a href="#l26.265"></a><span id="l26.265">     await OS.File.writeAtomic(</span>
<a href="#l26.266"></a><span id="l26.266">       invalidJSONFile,</span>
<a href="#l26.267"></a><span id="l26.267">       new TextEncoder().encode(&quot;This isn't JSON!&quot;)</span>
<a href="#l26.268"></a><span id="l26.268">     );</span>
<a href="#l26.269"></a><span id="l26.269">   };</span>
<a href="#l26.270"></a><span id="l26.270" class="difflineat">@@ -460,39 +454,41 @@ var test_logging = async function() {</span>
<a href="#l26.271"></a><span id="l26.271">   await logger.forEach({</span>
<a href="#l26.272"></a><span id="l26.272">     async processLog(aLog) {</span>
<a href="#l26.273"></a><span id="l26.273">       let info = await OS.File.stat(aLog);</span>
<a href="#l26.274"></a><span id="l26.274">       ok(!info.isDir);</span>
<a href="#l26.275"></a><span id="l26.275">       ok(aLog.endsWith(&quot;.json&quot;));</span>
<a href="#l26.276"></a><span id="l26.276">       await OS.File.remove(aLog);</span>
<a href="#l26.277"></a><span id="l26.277">     },</span>
<a href="#l26.278"></a><span id="l26.278">   });</span>
<a href="#l26.279"></a><span id="l26.279" class="difflineminus">-  let logFolder = OS.Path.dirname(getLogFilePathForConversation(dummyConv));</span>
<a href="#l26.280"></a><span id="l26.280" class="difflineplus">+  let logFolder = OS.Path.dirname(</span>
<a href="#l26.281"></a><span id="l26.281" class="difflineplus">+    gLogger.getLogFilePathForConversation(dummyConv)</span>
<a href="#l26.282"></a><span id="l26.282" class="difflineplus">+  );</span>
<a href="#l26.283"></a><span id="l26.283">   // The folder should now be empty - this will throw if it isn't.</span>
<a href="#l26.284"></a><span id="l26.284">   await OS.File.removeEmptyDir(logFolder, { ignoreAbsent: false });</span>
<a href="#l26.285"></a><span id="l26.285"> };</span>
<a href="#l26.286"></a><span id="l26.286"> </span>
<a href="#l26.287"></a><span id="l26.287"> var test_logFileSplitting = async function() {</span>
<a href="#l26.288"></a><span id="l26.288">   // Start clean, remove the log directory.</span>
<a href="#l26.289"></a><span id="l26.289">   let logFolderPath = OS.Path.join(OS.Constants.Path.profileDir, &quot;logs&quot;);</span>
<a href="#l26.290"></a><span id="l26.290">   await OS.File.removeDir(logFolderPath, { ignoreAbsent: true });</span>
<a href="#l26.291"></a><span id="l26.291" class="difflineminus">-  let logWriter = getLogWriter(dummyConv);</span>
<a href="#l26.292"></a><span id="l26.292" class="difflineplus">+  let logWriter = gLogger.getLogWriter(dummyConv);</span>
<a href="#l26.293"></a><span id="l26.293">   let startTime = logWriter._startTime / 1000; // Message times are in seconds.</span>
<a href="#l26.294"></a><span id="l26.294">   let oldPath = logWriter.currentPath;</span>
<a href="#l26.295"></a><span id="l26.295">   let message = {</span>
<a href="#l26.296"></a><span id="l26.296">     time: startTime,</span>
<a href="#l26.297"></a><span id="l26.297">     who: &quot;John Doe&quot;,</span>
<a href="#l26.298"></a><span id="l26.298">     originalMessage: &quot;Hello, world!&quot;,</span>
<a href="#l26.299"></a><span id="l26.299">     outgoing: true,</span>
<a href="#l26.300"></a><span id="l26.300">   };</span>
<a href="#l26.301"></a><span id="l26.301"> </span>
<a href="#l26.302"></a><span id="l26.302">   let logMessage = async function(aMessage) {</span>
<a href="#l26.303"></a><span id="l26.303">     logWriter.logMessage(aMessage);</span>
<a href="#l26.304"></a><span id="l26.304">     await logWriter._initialized;</span>
<a href="#l26.305"></a><span id="l26.305" class="difflineminus">-    await fileOperations.get(logWriter.currentPath);</span>
<a href="#l26.306"></a><span id="l26.306" class="difflineplus">+    await gLogger.gFilePromises.get(logWriter.currentPath);</span>
<a href="#l26.307"></a><span id="l26.307">   };</span>
<a href="#l26.308"></a><span id="l26.308"> </span>
<a href="#l26.309"></a><span id="l26.309">   await logMessage(message);</span>
<a href="#l26.310"></a><span id="l26.310">   message.time += logWriter.kInactivityLimit / 1000 + 1;</span>
<a href="#l26.311"></a><span id="l26.311">   // This should go in a new log file.</span>
<a href="#l26.312"></a><span id="l26.312">   await logMessage(message);</span>
<a href="#l26.313"></a><span id="l26.313">   notEqual(logWriter.currentPath, oldPath);</span>
<a href="#l26.314"></a><span id="l26.314">   // The log writer's new start time should be the time of the message.</span>
<a href="#l26.315"></a><span id="l26.315" class="difflineat">@@ -567,23 +563,23 @@ var test_logFileSplitting = async functi</span>
<a href="#l26.316"></a><span id="l26.316"> </span>
<a href="#l26.317"></a><span id="l26.317">   // Clean up.</span>
<a href="#l26.318"></a><span id="l26.318">   await OS.File.removeDir(logFolderPath);</span>
<a href="#l26.319"></a><span id="l26.319"> };</span>
<a href="#l26.320"></a><span id="l26.320"> </span>
<a href="#l26.321"></a><span id="l26.321"> function run_test() {</span>
<a href="#l26.322"></a><span id="l26.322">   // Test encodeName().</span>
<a href="#l26.323"></a><span id="l26.323">   for (let i = 0; i &lt; encodeName_input.length; ++i) {</span>
<a href="#l26.324"></a><span id="l26.324" class="difflineminus">-    equal(encodeName(encodeName_input[i]), encodeName_output[i]);</span>
<a href="#l26.325"></a><span id="l26.325" class="difflineplus">+    equal(gLogger.encodeName(encodeName_input[i]), encodeName_output[i]);</span>
<a href="#l26.326"></a><span id="l26.326">   }</span>
<a href="#l26.327"></a><span id="l26.327"> </span>
<a href="#l26.328"></a><span id="l26.328">   // Test convIsRealMUC().</span>
<a href="#l26.329"></a><span id="l26.329" class="difflineminus">-  ok(!convIsRealMUC(dummyConv));</span>
<a href="#l26.330"></a><span id="l26.330" class="difflineminus">-  ok(!convIsRealMUC(dummyTwitterConv));</span>
<a href="#l26.331"></a><span id="l26.331" class="difflineminus">-  ok(convIsRealMUC(dummyMUC));</span>
<a href="#l26.332"></a><span id="l26.332" class="difflineplus">+  ok(!gLogger.convIsRealMUC(dummyConv));</span>
<a href="#l26.333"></a><span id="l26.333" class="difflineplus">+  ok(!gLogger.convIsRealMUC(dummyTwitterConv));</span>
<a href="#l26.334"></a><span id="l26.334" class="difflineplus">+  ok(gLogger.convIsRealMUC(dummyMUC));</span>
<a href="#l26.335"></a><span id="l26.335"> </span>
<a href="#l26.336"></a><span id="l26.336">   add_task(test_getLogFolderPathForAccount);</span>
<a href="#l26.337"></a><span id="l26.337"> </span>
<a href="#l26.338"></a><span id="l26.338">   add_task(test_getLogFilePathForConversation);</span>
<a href="#l26.339"></a><span id="l26.339"> </span>
<a href="#l26.340"></a><span id="l26.340">   add_task(test_getLogFilePathForMUC);</span>
<a href="#l26.341"></a><span id="l26.341"> </span>
<a href="#l26.342"></a><span id="l26.342">   add_task(test_getLogFilePathForTwitterConv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">deleted file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- a/chat/protocols/facebook/Facebook.jsm</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ /dev/null</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineminus">-</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;FacebookProtocol&quot;];</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineminus">-</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-);</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineminus">-);</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/facebook.properties&quot;)</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-);</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineminus">-function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineminus">-}</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineminus">-FacebookAccount.prototype = {</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-</span>
<a href="#l27.28"></a><span id="l27.28" class="difflineminus">-  connect() {</span>
<a href="#l27.29"></a><span id="l27.29" class="difflineminus">-    this.WARN(</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineminus">-      &quot;As Facebook deprecated its XMPP gateway, it is currently not &quot; +</span>
<a href="#l27.31"></a><span id="l27.31" class="difflineminus">-        &quot;possible to connect to Facebook Chat. See bug 1141674.&quot;</span>
<a href="#l27.32"></a><span id="l27.32" class="difflineminus">-    );</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineminus">-    this.reportDisconnecting(</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineminus">-      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineminus">-      _(&quot;facebook.disabled&quot;)</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-    );</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineminus">-  },</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-  // Nothing to do.</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineminus">-  unInit() {},</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineminus">-};</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineminus">-</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-function FacebookProtocol() {}</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-FacebookProtocol.prototype = {</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-  get normalizedName() {</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineminus">-    return &quot;facebook&quot;;</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineminus">-  },</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  get name() {</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-    return _(&quot;facebook.chat.name&quot;);</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  },</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-    return &quot;chrome://prpl-facebook/skin/&quot;;</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineminus">-  },</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l27.57"></a><span id="l27.57" class="difflineminus">-    return new FacebookAccount(this, aImAccount);</span>
<a href="#l27.58"></a><span id="l27.58" class="difflineminus">-  },</span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">deleted file mode 100644</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineminus">--- a/chat/protocols/facebook/components.conf</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineplus">+++ /dev/null</span>
<a href="#l28.4"></a><span id="l28.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l28.5"></a><span id="l28.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l28.6"></a><span id="l28.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l28.7"></a><span id="l28.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.8"></a><span id="l28.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.9"></a><span id="l28.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineminus">-</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineminus">-Classes = [</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-    'cid': '{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}',</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/facebook;1'],</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-    'jsm': 'resource:///modules/Facebook.jsm',</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-    'constructor': 'FacebookProtocol',</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-facebook'},</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineminus">-  },</span>
<a href="#l28.19"></a><span id="l28.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">new file mode 100644</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineminus">--- /dev/null</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineplus">+++ b/chat/protocols/facebook/facebook.js</span>
<a href="#l29.4"></a><span id="l29.4" class="difflineat">@@ -0,0 +1,56 @@</span>
<a href="#l29.5"></a><span id="l29.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.6"></a><span id="l29.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.7"></a><span id="l29.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.8"></a><span id="l29.8" class="difflineplus">+</span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+);</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineplus">+);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/facebook.properties&quot;)</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+);</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+function FacebookAccount(aProtoInstance, aImAccount) {</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineplus">+}</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+FacebookAccount.prototype = {</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineplus">+</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineplus">+  connect() {</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineplus">+    this.WARN(</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineplus">+      &quot;As Facebook deprecated its XMPP gateway, it is currently not &quot; +</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+        &quot;possible to connect to Facebook Chat. See bug 1141674.&quot;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+    );</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineplus">+      _(&quot;facebook.disabled&quot;)</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineplus">+    );</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+  },</span>
<a href="#l29.37"></a><span id="l29.37" class="difflineplus">+</span>
<a href="#l29.38"></a><span id="l29.38" class="difflineplus">+  // Nothing to do.</span>
<a href="#l29.39"></a><span id="l29.39" class="difflineplus">+  unInit() {},</span>
<a href="#l29.40"></a><span id="l29.40" class="difflineplus">+};</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineplus">+</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineplus">+function FacebookProtocol() {}</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+FacebookProtocol.prototype = {</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l29.45"></a><span id="l29.45" class="difflineplus">+  get normalizedName() {</span>
<a href="#l29.46"></a><span id="l29.46" class="difflineplus">+    return &quot;facebook&quot;;</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineplus">+  },</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+  get name() {</span>
<a href="#l29.49"></a><span id="l29.49" class="difflineplus">+    return _(&quot;facebook.chat.name&quot;);</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineplus">+  },</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l29.52"></a><span id="l29.52" class="difflineplus">+    return &quot;chrome://prpl-facebook/skin/&quot;;</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineplus">+  },</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+    return new FacebookAccount(this, aImAccount);</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+  },</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+  classID: Components.ID(&quot;{1d1d0bc5-610c-472f-b2cb-4b89857d80dc}&quot;),</span>
<a href="#l29.58"></a><span id="l29.58" class="difflineplus">+};</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineplus">+</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([FacebookProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/chat/protocols/facebook/facebook.manifest</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+component {1d1d0bc5-610c-472f-b2cb-4b89857d80dc} facebook.js</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+contract @mozilla.org/chat/facebook;1 {1d1d0bc5-610c-472f-b2cb-4b89857d80dc}</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+category im-protocol-plugin prpl-facebook @mozilla.org/chat/facebook;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/chat/protocols/facebook/moz.build</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/chat/protocols/facebook/moz.build</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,14 +1,11 @@</span>
<a href="#l31.4"></a><span id="l31.4"> # vim: set filetype=python:</span>
<a href="#l31.5"></a><span id="l31.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineminus">-</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    'Facebook.jsm',</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+    'facebook.js',</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+    'facebook.manifest',</span>
<a href="#l31.16"></a><span id="l31.16"> ]</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineminus">-    'components.conf',</span>
<a href="#l31.20"></a><span id="l31.20" class="difflineminus">-]</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">deleted file mode 100644</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineminus">--- a/chat/protocols/gtalk/Gtalk.jsm</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineplus">+++ /dev/null</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineat">@@ -1,117 +0,0 @@</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.6"></a><span id="l32.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.7"></a><span id="l32.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.8"></a><span id="l32.8" class="difflineminus">-</span>
<a href="#l32.9"></a><span id="l32.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;GTalkProtocol&quot;];</span>
<a href="#l32.10"></a><span id="l32.10" class="difflineminus">-</span>
<a href="#l32.11"></a><span id="l32.11" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-);</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-);</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineminus">-  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineminus">-);</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineminus">-var { Stanza } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l32.24"></a><span id="l32.24" class="difflineminus">-</span>
<a href="#l32.25"></a><span id="l32.25" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-);</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineminus">-</span>
<a href="#l32.29"></a><span id="l32.29" class="difflineminus">-// PlainFullBindAuth is an authentication mechanism that works like</span>
<a href="#l32.30"></a><span id="l32.30" class="difflineminus">-// the standard PLAIN mechanism but adds a client-uses-full-bind-result</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-// attribute to the auth stanza to tell the Google Talk servers that we</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-// support their JID Domain Discovery extension.</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-// See https://developers.google.com/talk/jep_extensions/jid_domain_change</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineminus">-function* PlainFullBindAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l32.35"></a><span id="l32.35" class="difflineminus">-  let key = btoa(&quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword);</span>
<a href="#l32.36"></a><span id="l32.36" class="difflineminus">-  let attrs = {</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-    mechanism: &quot;PLAIN&quot;,</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-    &quot;xmlns:ga&quot;: &quot;http://www.google.com/talk/protocol/auth&quot;,</span>
<a href="#l32.39"></a><span id="l32.39" class="difflineminus">-    &quot;ga:client-uses-full-bind-result&quot;: &quot;true&quot;,</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-  };</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-  let stanza = yield {</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, attrs, key),</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-    log:</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-      &quot;&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)&quot;,</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-  };</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineminus">-</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-  if (stanza.localName != &quot;success&quot;) {</span>
<a href="#l32.48"></a><span id="l32.48" class="difflineminus">-    throw new Error(&quot;Didn't receive the expected auth success stanza.&quot;);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  }</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineminus">-}</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineminus">-</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineminus">-function GTalkAccount(aProtoInstance, aImAccount) {</span>
<a href="#l32.53"></a><span id="l32.53" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l32.54"></a><span id="l32.54" class="difflineminus">-}</span>
<a href="#l32.55"></a><span id="l32.55" class="difflineminus">-GTalkAccount.prototype = {</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineminus">-  __proto__: XMPPAccountPrototype,</span>
<a href="#l32.57"></a><span id="l32.57" class="difflineminus">-  connect() {</span>
<a href="#l32.58"></a><span id="l32.58" class="difflineminus">-    this._jid = this._parseJID(this.name);</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-    // The XMPP spec says that the node part of a JID is optional, but</span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-    // in the case of Google Talk if the username typed by the user</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineminus">-    // doesn't contain an @, we prefer assuming that it's the domain</span>
<a href="#l32.62"></a><span id="l32.62" class="difflineminus">-    // part that's been omitted.</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-    if (!this._jid.node) {</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-      // If the domain part was omitted, swap the node and domain parts,</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-      // use 'gmail.com' as the default domain, and tell the Google</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-      // Talk server that we will use the full bind result.</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-      this._jid.node = this._jid.domain;</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-      this._jid.domain = &quot;gmail.com&quot;;</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-      this.authMechanisms = { PLAIN: PlainFullBindAuth };</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineminus">-    }</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineminus">-</span>
<a href="#l32.72"></a><span id="l32.72" class="difflineminus">-    // For the resource, if the user has edited the option, always use that.</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineminus">-      let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l32.75"></a><span id="l32.75" class="difflineminus">-      this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l32.76"></a><span id="l32.76" class="difflineminus">-    }</span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-    this._connection = new XMPPSession(</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineminus">-      &quot;talk.google.com&quot;,</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineminus">-      443,</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-      &quot;require_tls&quot;,</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-      this._jid,</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-      this.imAccount.password,</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineminus">-      this</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineminus">-    );</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineminus">-  },</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineminus">-};</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineminus">-</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-function GTalkProtocol() {</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-  this.registerCommands();</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineminus">-}</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineminus">-GTalkProtocol.prototype = {</span>
<a href="#l32.94"></a><span id="l32.94" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l32.95"></a><span id="l32.95" class="difflineminus">-  get normalizedName() {</span>
<a href="#l32.96"></a><span id="l32.96" class="difflineminus">-    return &quot;gtalk&quot;;</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-  },</span>
<a href="#l32.98"></a><span id="l32.98" class="difflineminus">-  get name() {</span>
<a href="#l32.99"></a><span id="l32.99" class="difflineminus">-    return _(&quot;gtalk.protocolName&quot;);</span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-  },</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-    return &quot;chrome://prpl-gtalk/skin/&quot;;</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineminus">-  },</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineminus">-  get usernameEmptyText() {</span>
<a href="#l32.105"></a><span id="l32.105" class="difflineminus">-    return _(&quot;gtalk.usernameHint&quot;);</span>
<a href="#l32.106"></a><span id="l32.106" class="difflineminus">-  },</span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-    return new GTalkAccount(this, aImAccount);</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-  },</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-  options: {</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-    resource: {</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-      get label() {</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-        return _(&quot;options.resource&quot;);</span>
<a href="#l32.114"></a><span id="l32.114" class="difflineminus">-      },</span>
<a href="#l32.115"></a><span id="l32.115" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l32.116"></a><span id="l32.116" class="difflineminus">-    },</span>
<a href="#l32.117"></a><span id="l32.117" class="difflineminus">-  },</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineminus">-    return true;</span>
<a href="#l32.120"></a><span id="l32.120" class="difflineminus">-  },</span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">deleted file mode 100644</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineminus">--- a/chat/protocols/gtalk/components.conf</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineplus">+++ /dev/null</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l33.6"></a><span id="l33.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l33.7"></a><span id="l33.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.8"></a><span id="l33.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.9"></a><span id="l33.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineminus">-</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineminus">-Classes = [</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-    'cid': '{38a224c1-6748-49a9-8ab2-efc362b1000d}',</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/gtalk;1'],</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-    'jsm': 'resource:///modules/Gtalk.jsm',</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-    'constructor': 'GTalkProtocol',</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-gtalk'},</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-  },</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">new file mode 100644</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineminus">--- /dev/null</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.js</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineat">@@ -0,0 +1,118 @@</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineplus">+</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+);</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+);</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+);</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+var { XMPPSession } = ChromeUtils.import(</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+);</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+var { Stanza } = ChromeUtils.import(&quot;resource:///modules/xmpp-xml.jsm&quot;);</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+);</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+// PlainFullBindAuth is an authentication mechanism that works like</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+// the standard PLAIN mechanism but adds a client-uses-full-bind-result</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+// attribute to the auth stanza to tell the Google Talk servers that we</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+// support their JID Domain Discovery extension.</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+// See https://developers.google.com/talk/jep_extensions/jid_domain_change</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+function* PlainFullBindAuth(aUsername, aPassword, aDomain) {</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+  let key = btoa(&quot;\0&quot; + aUsername + &quot;\0&quot; + aPassword);</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+  let attrs = {</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+    mechanism: &quot;PLAIN&quot;,</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+    &quot;xmlns:ga&quot;: &quot;http://www.google.com/talk/protocol/auth&quot;,</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+    &quot;ga:client-uses-full-bind-result&quot;: &quot;true&quot;,</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+  };</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+  let stanza = yield {</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+    send: Stanza.node(&quot;auth&quot;, Stanza.NS.sasl, attrs, key),</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+    log:</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+      &quot;&lt;auth.../&gt; (PlainFullBindAuth base64 encoded username and password not logged)&quot;,</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+  };</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  if (stanza.localName != &quot;success&quot;) {</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+    throw new Error(&quot;Didn't receive the expected auth success stanza.&quot;);</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+  }</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+}</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+function GTalkAccount(aProtoInstance, aImAccount) {</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+}</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+GTalkAccount.prototype = {</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  __proto__: XMPPAccountPrototype,</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+  connect() {</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+    this._jid = this._parseJID(this.name);</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+    // The XMPP spec says that the node part of a JID is optional, but</span>
<a href="#l34.58"></a><span id="l34.58" class="difflineplus">+    // in the case of Google Talk if the username typed by the user</span>
<a href="#l34.59"></a><span id="l34.59" class="difflineplus">+    // doesn't contain an @, we prefer assuming that it's the domain</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+    // part that's been omitted.</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+    if (!this._jid.node) {</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+      // If the domain part was omitted, swap the node and domain parts,</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineplus">+      // use 'gmail.com' as the default domain, and tell the Google</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+      // Talk server that we will use the full bind result.</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+      this._jid.node = this._jid.domain;</span>
<a href="#l34.66"></a><span id="l34.66" class="difflineplus">+      this._jid.domain = &quot;gmail.com&quot;;</span>
<a href="#l34.67"></a><span id="l34.67" class="difflineplus">+      this.authMechanisms = { PLAIN: PlainFullBindAuth };</span>
<a href="#l34.68"></a><span id="l34.68" class="difflineplus">+    }</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+</span>
<a href="#l34.70"></a><span id="l34.70" class="difflineplus">+    // For the resource, if the user has edited the option, always use that.</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;resource&quot;)) {</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+      let resource = this.getString(&quot;resource&quot;);</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+      this._jid = this._setJID(this._jid.domain, this._jid.node, resource);</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineplus">+    }</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+    this._connection = new XMPPSession(</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+      &quot;talk.google.com&quot;,</span>
<a href="#l34.78"></a><span id="l34.78" class="difflineplus">+      443,</span>
<a href="#l34.79"></a><span id="l34.79" class="difflineplus">+      &quot;require_tls&quot;,</span>
<a href="#l34.80"></a><span id="l34.80" class="difflineplus">+      this._jid,</span>
<a href="#l34.81"></a><span id="l34.81" class="difflineplus">+      this.imAccount.password,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineplus">+      this</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+    );</span>
<a href="#l34.84"></a><span id="l34.84" class="difflineplus">+  },</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineplus">+};</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineplus">+</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+function GTalkProtocol() {</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineplus">+  this.registerCommands();</span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+}</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineplus">+GTalkProtocol.prototype = {</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l34.93"></a><span id="l34.93" class="difflineplus">+  get normalizedName() {</span>
<a href="#l34.94"></a><span id="l34.94" class="difflineplus">+    return &quot;gtalk&quot;;</span>
<a href="#l34.95"></a><span id="l34.95" class="difflineplus">+  },</span>
<a href="#l34.96"></a><span id="l34.96" class="difflineplus">+  get name() {</span>
<a href="#l34.97"></a><span id="l34.97" class="difflineplus">+    return _(&quot;gtalk.protocolName&quot;);</span>
<a href="#l34.98"></a><span id="l34.98" class="difflineplus">+  },</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+    return &quot;chrome://prpl-gtalk/skin/&quot;;</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineplus">+  },</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+    return _(&quot;gtalk.usernameHint&quot;);</span>
<a href="#l34.104"></a><span id="l34.104" class="difflineplus">+  },</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+    return new GTalkAccount(this, aImAccount);</span>
<a href="#l34.107"></a><span id="l34.107" class="difflineplus">+  },</span>
<a href="#l34.108"></a><span id="l34.108" class="difflineplus">+  options: {</span>
<a href="#l34.109"></a><span id="l34.109" class="difflineplus">+    resource: {</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineplus">+      get label() {</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+        return _(&quot;options.resource&quot;);</span>
<a href="#l34.112"></a><span id="l34.112" class="difflineplus">+      },</span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+    },</span>
<a href="#l34.115"></a><span id="l34.115" class="difflineplus">+  },</span>
<a href="#l34.116"></a><span id="l34.116" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineplus">+    return true;</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+  },</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+  classID: Components.ID(&quot;{38a224c1-6748-49a9-8ab2-efc362b1000d}&quot;),</span>
<a href="#l34.120"></a><span id="l34.120" class="difflineplus">+};</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+</span>
<a href="#l34.122"></a><span id="l34.122" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([GTalkProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">new file mode 100644</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineminus">--- /dev/null</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineplus">+++ b/chat/protocols/gtalk/gtalk.manifest</span>
<a href="#l35.4"></a><span id="l35.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l35.5"></a><span id="l35.5" class="difflineplus">+component {38a224c1-6748-49a9-8ab2-efc362b1000d} gtalk.js</span>
<a href="#l35.6"></a><span id="l35.6" class="difflineplus">+contract @mozilla.org/chat/gtalk;1 {38a224c1-6748-49a9-8ab2-efc362b1000d}</span>
<a href="#l35.7"></a><span id="l35.7" class="difflineplus">+category im-protocol-plugin prpl-gtalk @mozilla.org/chat/gtalk;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/chat/protocols/gtalk/moz.build</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/chat/protocols/gtalk/moz.build</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,14 +1,11 @@</span>
<a href="#l36.4"></a><span id="l36.4"> # vim: set filetype=python:</span>
<a href="#l36.5"></a><span id="l36.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.7"></a><span id="l36.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineminus">-</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-    'Gtalk.jsm',</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+    'gtalk.js',</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+    'gtalk.manifest',</span>
<a href="#l36.16"></a><span id="l36.16"> ]</span>
<a href="#l36.17"></a><span id="l36.17"> </span>
<a href="#l36.18"></a><span id="l36.18" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-    'components.conf',</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-]</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">deleted file mode 100644</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineminus">--- a/chat/protocols/irc/IRC.jsm</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineplus">+++ /dev/null</span>
<a href="#l37.4"></a><span id="l37.4" class="difflineat">@@ -1,2425 +0,0 @@</span>
<a href="#l37.5"></a><span id="l37.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l37.6"></a><span id="l37.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l37.7"></a><span id="l37.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l37.8"></a><span id="l37.8" class="difflineminus">-</span>
<a href="#l37.9"></a><span id="l37.9" class="difflineminus">-var EXPORTED_SYMBOLS = [</span>
<a href="#l37.10"></a><span id="l37.10" class="difflineminus">-  &quot;IRCProtocol&quot;,</span>
<a href="#l37.11"></a><span id="l37.11" class="difflineminus">-  &quot;IRCAccount&quot;,</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  &quot;IRCConversation&quot;,</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineminus">-  &quot;IRCMessage&quot;,</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-  &quot;IRCChannel&quot;,</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineminus">-  &quot;clearTimeout&quot;,</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineminus">-  &quot;setTimeout&quot;,</span>
<a href="#l37.17"></a><span id="l37.17" class="difflineminus">-  &quot;GenericIRCConversation&quot;,</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-];</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineminus">-</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-var {</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-  ClassInfo,</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-  clearTimeout,</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-  setTimeout,</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-  executeSoon,</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  l10nHelper,</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l37.28"></a><span id="l37.28" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l37.29"></a><span id="l37.29" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l37.30"></a><span id="l37.30" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-var { _, ctcpFormatToHTML, kListRefreshInterval } = ChromeUtils.import(</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineminus">-  &quot;resource:///modules/ircUtils.jsm&quot;</span>
<a href="#l37.33"></a><span id="l37.33" class="difflineminus">-);</span>
<a href="#l37.34"></a><span id="l37.34" class="difflineminus">-var { ircHandlers } = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-var {</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l37.37"></a><span id="l37.37" class="difflineminus">-  GenericAccountBuddyPrototype,</span>
<a href="#l37.38"></a><span id="l37.38" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-  GenericConvChatPrototype,</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineminus">-  GenericConvChatBuddyPrototype,</span>
<a href="#l37.41"></a><span id="l37.41" class="difflineminus">-  GenericConversationPrototype,</span>
<a href="#l37.42"></a><span id="l37.42" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l37.43"></a><span id="l37.43" class="difflineminus">-  TooltipInfo,</span>
<a href="#l37.44"></a><span id="l37.44" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineminus">-var { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l37.46"></a><span id="l37.46" class="difflineminus">-  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l37.47"></a><span id="l37.47" class="difflineminus">-);</span>
<a href="#l37.48"></a><span id="l37.48" class="difflineminus">-var { Socket } = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l37.49"></a><span id="l37.49" class="difflineminus">-</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineminus">-  this,</span>
<a href="#l37.52"></a><span id="l37.52" class="difflineminus">-  &quot;PluralForm&quot;,</span>
<a href="#l37.53"></a><span id="l37.53" class="difflineminus">-  &quot;resource://gre/modules/PluralForm.jsm&quot;</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-);</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineminus">-</span>
<a href="#l37.56"></a><span id="l37.56" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l37.57"></a><span id="l37.57" class="difflineminus">-  this,</span>
<a href="#l37.58"></a><span id="l37.58" class="difflineminus">-  &quot;DownloadUtils&quot;,</span>
<a href="#l37.59"></a><span id="l37.59" class="difflineminus">-  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineminus">-);</span>
<a href="#l37.61"></a><span id="l37.61" class="difflineminus">-</span>
<a href="#l37.62"></a><span id="l37.62" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_conv&quot;, () =&gt;</span>
<a href="#l37.63"></a><span id="l37.63" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l37.64"></a><span id="l37.64" class="difflineminus">-);</span>
<a href="#l37.65"></a><span id="l37.65" class="difflineminus">-</span>
<a href="#l37.66"></a><span id="l37.66" class="difflineminus">-/*</span>
<a href="#l37.67"></a><span id="l37.67" class="difflineminus">- * Parses a raw IRC message into an object (see section 2.3 of RFC 2812). This</span>
<a href="#l37.68"></a><span id="l37.68" class="difflineminus">- * returns an object with the following fields:</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">- *   rawMessage The initial message string received without any processing.</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineminus">- *   command    A string that is the command or response code.</span>
<a href="#l37.71"></a><span id="l37.71" class="difflineminus">- *   params     An array of strings for the parameters. The last parameter is</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineminus">- *              stripped of its : prefix.</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">- *   origin     The user's nickname or the server who sent the message. Can be</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">- *              a host (e.g. irc.mozilla.org) or an IPv4 address (e.g. 1.2.3.4)</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">- *              or an IPv6 address (e.g. 3ffe:1900:4545:3:200:f8ff:fe21:67cf).</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineminus">- *   user       The user's username, note that this can be undefined.</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineminus">- *   host       The user's hostname, note that this can be undefined.</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineminus">- *   source     A &quot;nicely&quot; formatted combination of user &amp; host, which is</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineminus">- *              &lt;user&gt;@&lt;host&gt; or &lt;user&gt; if host is undefined.</span>
<a href="#l37.80"></a><span id="l37.80" class="difflineminus">- *   tags       A Map with tags stored as key-value-pair. The value is a decoded</span>
<a href="#l37.81"></a><span id="l37.81" class="difflineminus">- *              string or undefined if the tag has no value.</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">- *</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineminus">- * There are cases (e.g. localhost) where it cannot be easily determined if a</span>
<a href="#l37.84"></a><span id="l37.84" class="difflineminus">- * message is from a server or from a user, thus the usage of a generic &quot;origin&quot;</span>
<a href="#l37.85"></a><span id="l37.85" class="difflineminus">- * instead of &quot;nickname&quot; or &quot;servername&quot;.</span>
<a href="#l37.86"></a><span id="l37.86" class="difflineminus">- *</span>
<a href="#l37.87"></a><span id="l37.87" class="difflineminus">- * Inputs:</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">- *  aData       The raw string to parse, it should already have the \r\n</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineminus">- *              stripped from the end.</span>
<a href="#l37.90"></a><span id="l37.90" class="difflineminus">- *  aOrigin     The default origin to use for unprefixed messages.</span>
<a href="#l37.91"></a><span id="l37.91" class="difflineminus">- */</span>
<a href="#l37.92"></a><span id="l37.92" class="difflineminus">-function IRCMessage(aData, aOrigin) {</span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-  let message = { rawMessage: aData };</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineminus">-  let temp;</span>
<a href="#l37.95"></a><span id="l37.95" class="difflineminus">-</span>
<a href="#l37.96"></a><span id="l37.96" class="difflineminus">-  // Splits the raw string into five parts. The third part, the command, is</span>
<a href="#l37.97"></a><span id="l37.97" class="difflineminus">-  // required. A raw string looks like:</span>
<a href="#l37.98"></a><span id="l37.98" class="difflineminus">-  //   [&quot;@&quot; &lt;tags&gt; &quot; &quot;] [&quot;:&quot; &lt;prefix&gt; &quot; &quot;] &lt;command&gt; [&quot; &quot; &lt;parameter&gt;]* [&quot;:&quot; &lt;last parameter&gt;]</span>
<a href="#l37.99"></a><span id="l37.99" class="difflineminus">-  //     &lt;tags&gt;: /[^ ]+/</span>
<a href="#l37.100"></a><span id="l37.100" class="difflineminus">-  //     &lt;prefix&gt;: :(&lt;server name&gt; | &lt;nickname&gt; [[&quot;!&quot; &lt;user&gt;] &quot;@&quot; &lt;host&gt;])</span>
<a href="#l37.101"></a><span id="l37.101" class="difflineminus">-  //     &lt;command&gt;: /[^ ]+/</span>
<a href="#l37.102"></a><span id="l37.102" class="difflineminus">-  //     &lt;parameter&gt;: /[^ ]+/</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-  //     &lt;last parameter&gt;: /.+/</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineminus">-  // See http://joshualuckers.nl/2010/01/10/regular-expression-to-match-raw-irc-messages/</span>
<a href="#l37.105"></a><span id="l37.105" class="difflineminus">-  // Note that this expression is slightly more aggressive in matching than RFC</span>
<a href="#l37.106"></a><span id="l37.106" class="difflineminus">-  // 2812 would allow. It allows for empty parameters (besides the last</span>
<a href="#l37.107"></a><span id="l37.107" class="difflineminus">-  // parameter, which can always be empty), by allowing multiple spaces.</span>
<a href="#l37.108"></a><span id="l37.108" class="difflineminus">-  // (This is for compatibility with Unreal's 432 response, which returns an</span>
<a href="#l37.109"></a><span id="l37.109" class="difflineminus">-  // empty first parameter.) It also allows a trailing space after the</span>
<a href="#l37.110"></a><span id="l37.110" class="difflineminus">-  // &lt;parameter&gt;s when no &lt;last parameter&gt; is present (also occurs with Unreal).</span>
<a href="#l37.111"></a><span id="l37.111" class="difflineminus">-  if (</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-    !(temp = aData.match(</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-      /^(?:@([^ ]+) )?(?::([^ ]+) )?([^ ]+)((?: +[^: ][^ ]*)*)? *(?::([\s\S]*))?$/</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-    ))</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineminus">-  ) {</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineminus">-    throw new Error(&quot;Couldn't parse message: \&quot;&quot; + aData + '&quot;');</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineminus">-  }</span>
<a href="#l37.118"></a><span id="l37.118" class="difflineminus">-</span>
<a href="#l37.119"></a><span id="l37.119" class="difflineminus">-  message.command = temp[3];</span>
<a href="#l37.120"></a><span id="l37.120" class="difflineminus">-  // Space separated parameters. Since we expect a space as the first thing</span>
<a href="#l37.121"></a><span id="l37.121" class="difflineminus">-  // here, we want to ignore the first value (which is empty).</span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-  message.params = temp[4] ? temp[4].split(&quot; &quot;).slice(1) : [];</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineminus">-  // Last parameter can contain spaces or be an empty string.</span>
<a href="#l37.124"></a><span id="l37.124" class="difflineminus">-  if (temp[5] !== undefined) {</span>
<a href="#l37.125"></a><span id="l37.125" class="difflineminus">-    message.params.push(temp[5]);</span>
<a href="#l37.126"></a><span id="l37.126" class="difflineminus">-  }</span>
<a href="#l37.127"></a><span id="l37.127" class="difflineminus">-</span>
<a href="#l37.128"></a><span id="l37.128" class="difflineminus">-  // Handle the prefix part of the message per RFC 2812 Section 2.3.</span>
<a href="#l37.129"></a><span id="l37.129" class="difflineminus">-</span>
<a href="#l37.130"></a><span id="l37.130" class="difflineminus">-  // If no prefix is given, assume the current server is the origin.</span>
<a href="#l37.131"></a><span id="l37.131" class="difflineminus">-  if (!temp[2]) {</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-    temp[2] = aOrigin;</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineminus">-  }</span>
<a href="#l37.134"></a><span id="l37.134" class="difflineminus">-</span>
<a href="#l37.135"></a><span id="l37.135" class="difflineminus">-  // Split the prefix into separate nickname, username and hostname fields as:</span>
<a href="#l37.136"></a><span id="l37.136" class="difflineminus">-  //   :(servername|(nickname[[!user]@host]))</span>
<a href="#l37.137"></a><span id="l37.137" class="difflineminus">-  [message.origin, message.user, message.host] = temp[2].split(/[!@]/);</span>
<a href="#l37.138"></a><span id="l37.138" class="difflineminus">-</span>
<a href="#l37.139"></a><span id="l37.139" class="difflineminus">-  // Store the tags in a Map, see IRCv3.2 Message Tags.</span>
<a href="#l37.140"></a><span id="l37.140" class="difflineminus">-  message.tags = new Map();</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-  if (temp[1]) {</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineminus">-    let tags = temp[1].split(&quot;;&quot;);</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineminus">-    tags.forEach(tag =&gt; {</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineminus">-      let [key, value] = tag.split(&quot;=&quot;);</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineminus">-</span>
<a href="#l37.147"></a><span id="l37.147" class="difflineminus">-      if (value) {</span>
<a href="#l37.148"></a><span id="l37.148" class="difflineminus">-        // Unescape tag values according to this mapping:</span>
<a href="#l37.149"></a><span id="l37.149" class="difflineminus">-        // \\ = \</span>
<a href="#l37.150"></a><span id="l37.150" class="difflineminus">-        // \n = LF</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineminus">-        // \r = CR</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineminus">-        // \s = SPACE</span>
<a href="#l37.153"></a><span id="l37.153" class="difflineminus">-        // \: = ;</span>
<a href="#l37.154"></a><span id="l37.154" class="difflineminus">-        // everything else stays identical.</span>
<a href="#l37.155"></a><span id="l37.155" class="difflineminus">-        value = value.replace(/\\(.)/g, (str, type) =&gt; {</span>
<a href="#l37.156"></a><span id="l37.156" class="difflineminus">-          if (type == &quot;\\&quot;) {</span>
<a href="#l37.157"></a><span id="l37.157" class="difflineminus">-            return &quot;\\&quot;;</span>
<a href="#l37.158"></a><span id="l37.158" class="difflineminus">-          } else if (type == &quot;n&quot;) {</span>
<a href="#l37.159"></a><span id="l37.159" class="difflineminus">-            return &quot;\n&quot;;</span>
<a href="#l37.160"></a><span id="l37.160" class="difflineminus">-          } else if (type == &quot;r&quot;) {</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineminus">-            return &quot;\r&quot;;</span>
<a href="#l37.162"></a><span id="l37.162" class="difflineminus">-          } else if (type == &quot;s&quot;) {</span>
<a href="#l37.163"></a><span id="l37.163" class="difflineminus">-            return &quot; &quot;;</span>
<a href="#l37.164"></a><span id="l37.164" class="difflineminus">-          } else if (type == &quot;:&quot;) {</span>
<a href="#l37.165"></a><span id="l37.165" class="difflineminus">-            return &quot;;&quot;;</span>
<a href="#l37.166"></a><span id="l37.166" class="difflineminus">-          }</span>
<a href="#l37.167"></a><span id="l37.167" class="difflineminus">-          // Ignore the backslash, not specified by the spec, but as it says</span>
<a href="#l37.168"></a><span id="l37.168" class="difflineminus">-          // backslashes must be escaped this case should not occur in a valid</span>
<a href="#l37.169"></a><span id="l37.169" class="difflineminus">-          // tag value.</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineminus">-          return type;</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineminus">-        });</span>
<a href="#l37.172"></a><span id="l37.172" class="difflineminus">-      }</span>
<a href="#l37.173"></a><span id="l37.173" class="difflineminus">-      // The tag key can typically have the form of example.com/aaa for vendor</span>
<a href="#l37.174"></a><span id="l37.174" class="difflineminus">-      // defined tags. The spec wants any unicode characters in URLs to be</span>
<a href="#l37.175"></a><span id="l37.175" class="difflineminus">-      // in punycode (xn--). These are not unescaped to their unicode value.</span>
<a href="#l37.176"></a><span id="l37.176" class="difflineminus">-      message.tags.set(key, value);</span>
<a href="#l37.177"></a><span id="l37.177" class="difflineminus">-    });</span>
<a href="#l37.178"></a><span id="l37.178" class="difflineminus">-  }</span>
<a href="#l37.179"></a><span id="l37.179" class="difflineminus">-</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineminus">-  // It is occasionally useful to have a &quot;source&quot; which is a combination of</span>
<a href="#l37.181"></a><span id="l37.181" class="difflineminus">-  // user@host.</span>
<a href="#l37.182"></a><span id="l37.182" class="difflineminus">-  if (message.user) {</span>
<a href="#l37.183"></a><span id="l37.183" class="difflineminus">-    message.source = message.user + &quot;@&quot; + message.host;</span>
<a href="#l37.184"></a><span id="l37.184" class="difflineminus">-  } else if (message.host) {</span>
<a href="#l37.185"></a><span id="l37.185" class="difflineminus">-    message.source = message.host;</span>
<a href="#l37.186"></a><span id="l37.186" class="difflineminus">-  } else {</span>
<a href="#l37.187"></a><span id="l37.187" class="difflineminus">-    message.source = &quot;&quot;;</span>
<a href="#l37.188"></a><span id="l37.188" class="difflineminus">-  }</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineminus">-  return message;</span>
<a href="#l37.191"></a><span id="l37.191" class="difflineminus">-}</span>
<a href="#l37.192"></a><span id="l37.192" class="difflineminus">-</span>
<a href="#l37.193"></a><span id="l37.193" class="difflineminus">-// This handles a mode change string for both channels and participants. A mode</span>
<a href="#l37.194"></a><span id="l37.194" class="difflineminus">-// change string is of the form:</span>
<a href="#l37.195"></a><span id="l37.195" class="difflineminus">-//   aAddNewMode is true if modes are being added, false otherwise.</span>
<a href="#l37.196"></a><span id="l37.196" class="difflineminus">-//   aNewModes is an array of mode characters.</span>
<a href="#l37.197"></a><span id="l37.197" class="difflineminus">-function _setMode(aAddNewMode, aNewModes) {</span>
<a href="#l37.198"></a><span id="l37.198" class="difflineminus">-  // Check each mode being added/removed.</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineminus">-  for (let newMode of aNewModes) {</span>
<a href="#l37.200"></a><span id="l37.200" class="difflineminus">-    let hasMode = this._modes.has(newMode);</span>
<a href="#l37.201"></a><span id="l37.201" class="difflineminus">-    // If the mode is in the list of modes and we want to remove it.</span>
<a href="#l37.202"></a><span id="l37.202" class="difflineminus">-    if (hasMode &amp;&amp; !aAddNewMode) {</span>
<a href="#l37.203"></a><span id="l37.203" class="difflineminus">-      this._modes.delete(newMode);</span>
<a href="#l37.204"></a><span id="l37.204" class="difflineminus">-    } else if (!hasMode &amp;&amp; aAddNewMode) {</span>
<a href="#l37.205"></a><span id="l37.205" class="difflineminus">-      // If the mode is not in the list of modes and we want to add it.</span>
<a href="#l37.206"></a><span id="l37.206" class="difflineminus">-      this._modes.add(newMode);</span>
<a href="#l37.207"></a><span id="l37.207" class="difflineminus">-    }</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineminus">-  }</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineminus">-}</span>
<a href="#l37.210"></a><span id="l37.210" class="difflineminus">-</span>
<a href="#l37.211"></a><span id="l37.211" class="difflineminus">-function TagMessage(aMessage, aTagName) {</span>
<a href="#l37.212"></a><span id="l37.212" class="difflineminus">-  this.message = aMessage;</span>
<a href="#l37.213"></a><span id="l37.213" class="difflineminus">-  this.tagName = aTagName;</span>
<a href="#l37.214"></a><span id="l37.214" class="difflineminus">-  this.tagValue = aMessage.tags.get(aTagName);</span>
<a href="#l37.215"></a><span id="l37.215" class="difflineminus">-}</span>
<a href="#l37.216"></a><span id="l37.216" class="difflineminus">-</span>
<a href="#l37.217"></a><span id="l37.217" class="difflineminus">-// Properties / methods shared by both IRCChannel and IRCConversation.</span>
<a href="#l37.218"></a><span id="l37.218" class="difflineminus">-var GenericIRCConversation = {</span>
<a href="#l37.219"></a><span id="l37.219" class="difflineminus">-  _observedNicks: [],</span>
<a href="#l37.220"></a><span id="l37.220" class="difflineminus">-  // This is set to true after a message is sent to notify the 401</span>
<a href="#l37.221"></a><span id="l37.221" class="difflineminus">-  // ERR_NOSUCHNICK handler to write an error message to the conversation.</span>
<a href="#l37.222"></a><span id="l37.222" class="difflineminus">-  _pendingMessage: false,</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-  _waitingForNick: false,</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineminus">-</span>
<a href="#l37.225"></a><span id="l37.225" class="difflineminus">-  normalizeNick(aNick) {</span>
<a href="#l37.226"></a><span id="l37.226" class="difflineminus">-    return this._account.normalizeNick(aNick);</span>
<a href="#l37.227"></a><span id="l37.227" class="difflineminus">-  },</span>
<a href="#l37.228"></a><span id="l37.228" class="difflineminus">-</span>
<a href="#l37.229"></a><span id="l37.229" class="difflineminus">-  // This will calculate the maximum number of bytes that are left for a message</span>
<a href="#l37.230"></a><span id="l37.230" class="difflineminus">-  // typed by the user by calculate the amount of bytes that would be used by</span>
<a href="#l37.231"></a><span id="l37.231" class="difflineminus">-  // the IRC messaging.</span>
<a href="#l37.232"></a><span id="l37.232" class="difflineminus">-  getMaxMessageLength() {</span>
<a href="#l37.233"></a><span id="l37.233" class="difflineminus">-    // Build the shortest possible message that could be sent to other users.</span>
<a href="#l37.234"></a><span id="l37.234" class="difflineminus">-    let baseMessage =</span>
<a href="#l37.235"></a><span id="l37.235" class="difflineminus">-      &quot;:&quot; +</span>
<a href="#l37.236"></a><span id="l37.236" class="difflineminus">-      this._account._nickname +</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineminus">-      this._account.prefix +</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineminus">-      &quot; &quot; +</span>
<a href="#l37.239"></a><span id="l37.239" class="difflineminus">-      this._account.buildMessage(&quot;PRIVMSG&quot;, this.name) +</span>
<a href="#l37.240"></a><span id="l37.240" class="difflineminus">-      &quot; :\r\n&quot;;</span>
<a href="#l37.241"></a><span id="l37.241" class="difflineminus">-    return (</span>
<a href="#l37.242"></a><span id="l37.242" class="difflineminus">-      this._account.maxMessageLength - this._account.countBytes(baseMessage)</span>
<a href="#l37.243"></a><span id="l37.243" class="difflineminus">-    );</span>
<a href="#l37.244"></a><span id="l37.244" class="difflineminus">-  },</span>
<a href="#l37.245"></a><span id="l37.245" class="difflineminus">-  /**</span>
<a href="#l37.246"></a><span id="l37.246" class="difflineminus">-   * @param {string} aWho - Message author's username.</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineminus">-   * @param {string} aMessage - Message text.</span>
<a href="#l37.248"></a><span id="l37.248" class="difflineminus">-   * @param {Object} aObject - Other properties to set on the IMMessage.</span>
<a href="#l37.249"></a><span id="l37.249" class="difflineminus">-   */</span>
<a href="#l37.250"></a><span id="l37.250" class="difflineminus">-  handleTags(aWho, aMessage, aObject) {</span>
<a href="#l37.251"></a><span id="l37.251" class="difflineminus">-    let messageProps = aObject;</span>
<a href="#l37.252"></a><span id="l37.252" class="difflineminus">-    if (&quot;tags&quot; in aObject &amp;&amp; ircHandlers.hasTagHandlers) {</span>
<a href="#l37.253"></a><span id="l37.253" class="difflineminus">-      // Merge extra info for the handler into the props.</span>
<a href="#l37.254"></a><span id="l37.254" class="difflineminus">-      messageProps = Object.assign(</span>
<a href="#l37.255"></a><span id="l37.255" class="difflineminus">-        {</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-          who: aWho,</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineminus">-          message: aMessage,</span>
<a href="#l37.258"></a><span id="l37.258" class="difflineminus">-          get originalMessage() {</span>
<a href="#l37.259"></a><span id="l37.259" class="difflineminus">-            return aMessage;</span>
<a href="#l37.260"></a><span id="l37.260" class="difflineminus">-          },</span>
<a href="#l37.261"></a><span id="l37.261" class="difflineminus">-        },</span>
<a href="#l37.262"></a><span id="l37.262" class="difflineminus">-        messageProps</span>
<a href="#l37.263"></a><span id="l37.263" class="difflineminus">-      );</span>
<a href="#l37.264"></a><span id="l37.264" class="difflineminus">-      for (let tag of aObject.tags.keys()) {</span>
<a href="#l37.265"></a><span id="l37.265" class="difflineminus">-        // Unhandled tags may be common, since a tag does not have to be handled</span>
<a href="#l37.266"></a><span id="l37.266" class="difflineminus">-        // with a tag handler, it may also be handled by a message command handler.</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineminus">-        ircHandlers.handleTag(this._account, new TagMessage(messageProps, tag));</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineminus">-      }</span>
<a href="#l37.269"></a><span id="l37.269" class="difflineminus">-</span>
<a href="#l37.270"></a><span id="l37.270" class="difflineminus">-      // Remove helper prop for tag handlers. We don't want to remove the other</span>
<a href="#l37.271"></a><span id="l37.271" class="difflineminus">-      // ones, since they might have been changed and will override aWho and</span>
<a href="#l37.272"></a><span id="l37.272" class="difflineminus">-      // aMessage in the IMMessage constructor.</span>
<a href="#l37.273"></a><span id="l37.273" class="difflineminus">-      delete messageProps.originalMessage;</span>
<a href="#l37.274"></a><span id="l37.274" class="difflineminus">-    }</span>
<a href="#l37.275"></a><span id="l37.275" class="difflineminus">-    // Remove the IRC tags, as those were passed in just for this step.</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineminus">-    delete messageProps.tags;</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineminus">-    return messageProps;</span>
<a href="#l37.278"></a><span id="l37.278" class="difflineminus">-  },</span>
<a href="#l37.279"></a><span id="l37.279" class="difflineminus">-  // Apply CTCP formatting before displaying.</span>
<a href="#l37.280"></a><span id="l37.280" class="difflineminus">-  prepareForDisplaying(aMsg) {</span>
<a href="#l37.281"></a><span id="l37.281" class="difflineminus">-    aMsg.displayMessage = ctcpFormatToHTML(aMsg.displayMessage);</span>
<a href="#l37.282"></a><span id="l37.282" class="difflineminus">-    GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l37.283"></a><span id="l37.283" class="difflineminus">-  },</span>
<a href="#l37.284"></a><span id="l37.284" class="difflineminus">-  prepareForSending(aOutgoingMessage) {</span>
<a href="#l37.285"></a><span id="l37.285" class="difflineminus">-    // Split the message by line breaks and send each one individually.</span>
<a href="#l37.286"></a><span id="l37.286" class="difflineminus">-    let messages = aOutgoingMessage.message.split(/[\r\n]+/);</span>
<a href="#l37.287"></a><span id="l37.287" class="difflineminus">-</span>
<a href="#l37.288"></a><span id="l37.288" class="difflineminus">-    let maxLength = this.getMaxMessageLength();</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineminus">-    // Attempt to smartly split a string into multiple lines (based on the</span>
<a href="#l37.291"></a><span id="l37.291" class="difflineminus">-    // maximum number of characters the message can contain).</span>
<a href="#l37.292"></a><span id="l37.292" class="difflineminus">-    for (let i = 0; i &lt; messages.length; ++i) {</span>
<a href="#l37.293"></a><span id="l37.293" class="difflineminus">-      let message = messages[i];</span>
<a href="#l37.294"></a><span id="l37.294" class="difflineminus">-      let length = this._account.countBytes(message);</span>
<a href="#l37.295"></a><span id="l37.295" class="difflineminus">-      // The message is short enough.</span>
<a href="#l37.296"></a><span id="l37.296" class="difflineminus">-      if (length &lt;= maxLength) {</span>
<a href="#l37.297"></a><span id="l37.297" class="difflineminus">-        continue;</span>
<a href="#l37.298"></a><span id="l37.298" class="difflineminus">-      }</span>
<a href="#l37.299"></a><span id="l37.299" class="difflineminus">-</span>
<a href="#l37.300"></a><span id="l37.300" class="difflineminus">-      // Find the location of a space before the maximum length.</span>
<a href="#l37.301"></a><span id="l37.301" class="difflineminus">-      let index = message.lastIndexOf(&quot; &quot;, maxLength);</span>
<a href="#l37.302"></a><span id="l37.302" class="difflineminus">-</span>
<a href="#l37.303"></a><span id="l37.303" class="difflineminus">-      // Remove the current message and insert the two new ones. If no space was</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineminus">-      // found, cut the first message to the maximum length and start the second</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineminus">-      // message one character after that. If a space was found, exclude it.</span>
<a href="#l37.306"></a><span id="l37.306" class="difflineminus">-      messages.splice(</span>
<a href="#l37.307"></a><span id="l37.307" class="difflineminus">-        i,</span>
<a href="#l37.308"></a><span id="l37.308" class="difflineminus">-        1,</span>
<a href="#l37.309"></a><span id="l37.309" class="difflineminus">-        message.substr(0, index == -1 ? maxLength : index),</span>
<a href="#l37.310"></a><span id="l37.310" class="difflineminus">-        message.substr(index + 1 || maxLength)</span>
<a href="#l37.311"></a><span id="l37.311" class="difflineminus">-      );</span>
<a href="#l37.312"></a><span id="l37.312" class="difflineminus">-    }</span>
<a href="#l37.313"></a><span id="l37.313" class="difflineminus">-</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineminus">-    return messages;</span>
<a href="#l37.315"></a><span id="l37.315" class="difflineminus">-  },</span>
<a href="#l37.316"></a><span id="l37.316" class="difflineminus">-  sendMsg(aMessage, aIsNotice) {</span>
<a href="#l37.317"></a><span id="l37.317" class="difflineminus">-    if (!aMessage.length) {</span>
<a href="#l37.318"></a><span id="l37.318" class="difflineminus">-      return;</span>
<a href="#l37.319"></a><span id="l37.319" class="difflineminus">-    }</span>
<a href="#l37.320"></a><span id="l37.320" class="difflineminus">-</span>
<a href="#l37.321"></a><span id="l37.321" class="difflineminus">-    if (</span>
<a href="#l37.322"></a><span id="l37.322" class="difflineminus">-      !this._account.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineminus">-        this.name,</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineminus">-        aMessage,</span>
<a href="#l37.325"></a><span id="l37.325" class="difflineminus">-      ])</span>
<a href="#l37.326"></a><span id="l37.326" class="difflineminus">-    ) {</span>
<a href="#l37.327"></a><span id="l37.327" class="difflineminus">-      this.writeMessage(</span>
<a href="#l37.328"></a><span id="l37.328" class="difflineminus">-        this._account._currentServerName,</span>
<a href="#l37.329"></a><span id="l37.329" class="difflineminus">-        _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l37.330"></a><span id="l37.330" class="difflineminus">-        { error: true, system: true }</span>
<a href="#l37.331"></a><span id="l37.331" class="difflineminus">-      );</span>
<a href="#l37.332"></a><span id="l37.332" class="difflineminus">-      return;</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineminus">-    }</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineminus">-</span>
<a href="#l37.335"></a><span id="l37.335" class="difflineminus">-    // Since the server doesn't send us a message back, just assume the</span>
<a href="#l37.336"></a><span id="l37.336" class="difflineminus">-    // message was received and immediately show it.</span>
<a href="#l37.337"></a><span id="l37.337" class="difflineminus">-    this.writeMessage(this._account._nickname, aMessage, { outgoing: true });</span>
<a href="#l37.338"></a><span id="l37.338" class="difflineminus">-</span>
<a href="#l37.339"></a><span id="l37.339" class="difflineminus">-    this._pendingMessage = true;</span>
<a href="#l37.340"></a><span id="l37.340" class="difflineminus">-  },</span>
<a href="#l37.341"></a><span id="l37.341" class="difflineminus">-  // IRC doesn't support typing notifications, but it does have a maximum</span>
<a href="#l37.342"></a><span id="l37.342" class="difflineminus">-  // message length.</span>
<a href="#l37.343"></a><span id="l37.343" class="difflineminus">-  sendTyping(aString) {</span>
<a href="#l37.344"></a><span id="l37.344" class="difflineminus">-    let longestLineLength = Math.max.apply(</span>
<a href="#l37.345"></a><span id="l37.345" class="difflineminus">-      null,</span>
<a href="#l37.346"></a><span id="l37.346" class="difflineminus">-      aString.split(&quot;\n&quot;).map(this._account.countBytes, this._account)</span>
<a href="#l37.347"></a><span id="l37.347" class="difflineminus">-    );</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineminus">-    return this.getMaxMessageLength() - longestLineLength;</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineminus">-  },</span>
<a href="#l37.350"></a><span id="l37.350" class="difflineminus">-</span>
<a href="#l37.351"></a><span id="l37.351" class="difflineminus">-  requestCurrentWhois(aNick) {</span>
<a href="#l37.352"></a><span id="l37.352" class="difflineminus">-    if (!this._observedNicks.length) {</span>
<a href="#l37.353"></a><span id="l37.353" class="difflineminus">-      Services.obs.addObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l37.354"></a><span id="l37.354" class="difflineminus">-    }</span>
<a href="#l37.355"></a><span id="l37.355" class="difflineminus">-    this._observedNicks.push(this.normalizeNick(aNick));</span>
<a href="#l37.356"></a><span id="l37.356" class="difflineminus">-    this._account.requestCurrentWhois(aNick);</span>
<a href="#l37.357"></a><span id="l37.357" class="difflineminus">-  },</span>
<a href="#l37.358"></a><span id="l37.358" class="difflineminus">-</span>
<a href="#l37.359"></a><span id="l37.359" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l37.360"></a><span id="l37.360" class="difflineminus">-    if (aTopic != &quot;user-info-received&quot;) {</span>
<a href="#l37.361"></a><span id="l37.361" class="difflineminus">-      return;</span>
<a href="#l37.362"></a><span id="l37.362" class="difflineminus">-    }</span>
<a href="#l37.363"></a><span id="l37.363" class="difflineminus">-</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineminus">-    let nick = this.normalizeNick(aData);</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineminus">-    let nickIndex = this._observedNicks.indexOf(nick);</span>
<a href="#l37.366"></a><span id="l37.366" class="difflineminus">-    if (nickIndex == -1) {</span>
<a href="#l37.367"></a><span id="l37.367" class="difflineminus">-      return;</span>
<a href="#l37.368"></a><span id="l37.368" class="difflineminus">-    }</span>
<a href="#l37.369"></a><span id="l37.369" class="difflineminus">-</span>
<a href="#l37.370"></a><span id="l37.370" class="difflineminus">-    // Remove the nick from the list of nicks that are being waited to received.</span>
<a href="#l37.371"></a><span id="l37.371" class="difflineminus">-    this._observedNicks.splice(nickIndex, 1);</span>
<a href="#l37.372"></a><span id="l37.372" class="difflineminus">-</span>
<a href="#l37.373"></a><span id="l37.373" class="difflineminus">-    // If this is the last nick, remove the observer.</span>
<a href="#l37.374"></a><span id="l37.374" class="difflineminus">-    if (!this._observedNicks.length) {</span>
<a href="#l37.375"></a><span id="l37.375" class="difflineminus">-      Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l37.376"></a><span id="l37.376" class="difflineminus">-    }</span>
<a href="#l37.377"></a><span id="l37.377" class="difflineminus">-</span>
<a href="#l37.378"></a><span id="l37.378" class="difflineminus">-    // If we are waiting for the conversation name, set it.</span>
<a href="#l37.379"></a><span id="l37.379" class="difflineminus">-    let account = this._account;</span>
<a href="#l37.380"></a><span id="l37.380" class="difflineminus">-    if (this._waitingForNick &amp;&amp; nick == this.normalizedName) {</span>
<a href="#l37.381"></a><span id="l37.381" class="difflineminus">-      if (account.whoisInformation.has(nick)) {</span>
<a href="#l37.382"></a><span id="l37.382" class="difflineminus">-        this.updateNick(account.whoisInformation.get(nick).nick);</span>
<a href="#l37.383"></a><span id="l37.383" class="difflineminus">-      }</span>
<a href="#l37.384"></a><span id="l37.384" class="difflineminus">-      delete this._waitingForNick;</span>
<a href="#l37.385"></a><span id="l37.385" class="difflineminus">-      return;</span>
<a href="#l37.386"></a><span id="l37.386" class="difflineminus">-    }</span>
<a href="#l37.387"></a><span id="l37.387" class="difflineminus">-</span>
<a href="#l37.388"></a><span id="l37.388" class="difflineminus">-    // Otherwise, print the requested whois information.</span>
<a href="#l37.389"></a><span id="l37.389" class="difflineminus">-    let type = { system: true, noLog: true };</span>
<a href="#l37.390"></a><span id="l37.390" class="difflineminus">-    // RFC 2812 errors 401 and 406 result in there being no entry for the nick.</span>
<a href="#l37.391"></a><span id="l37.391" class="difflineminus">-    if (!account.whoisInformation.has(nick)) {</span>
<a href="#l37.392"></a><span id="l37.392" class="difflineminus">-      this.writeMessage(null, _(&quot;message.unknownNick&quot;, nick), type);</span>
<a href="#l37.393"></a><span id="l37.393" class="difflineminus">-      return;</span>
<a href="#l37.394"></a><span id="l37.394" class="difflineminus">-    }</span>
<a href="#l37.395"></a><span id="l37.395" class="difflineminus">-    // If the nick is offline, tell the user. In that case, it's WHOWAS info.</span>
<a href="#l37.396"></a><span id="l37.396" class="difflineminus">-    let msgType = &quot;message.whois&quot;;</span>
<a href="#l37.397"></a><span id="l37.397" class="difflineminus">-    if (&quot;offline&quot; in account.whoisInformation.get(nick)) {</span>
<a href="#l37.398"></a><span id="l37.398" class="difflineminus">-      msgType = &quot;message.whowas&quot;;</span>
<a href="#l37.399"></a><span id="l37.399" class="difflineminus">-    }</span>
<a href="#l37.400"></a><span id="l37.400" class="difflineminus">-    let msg = _(msgType, account.whoisInformation.get(nick).nick);</span>
<a href="#l37.401"></a><span id="l37.401" class="difflineminus">-</span>
<a href="#l37.402"></a><span id="l37.402" class="difflineminus">-    // Iterate over each field.</span>
<a href="#l37.403"></a><span id="l37.403" class="difflineminus">-    let tooltipInfo = aSubject.QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l37.404"></a><span id="l37.404" class="difflineminus">-    while (tooltipInfo.hasMoreElements()) {</span>
<a href="#l37.405"></a><span id="l37.405" class="difflineminus">-      let elt = tooltipInfo.getNext().QueryInterface(Ci.prplITooltipInfo);</span>
<a href="#l37.406"></a><span id="l37.406" class="difflineminus">-      switch (elt.type) {</span>
<a href="#l37.407"></a><span id="l37.407" class="difflineminus">-        case Ci.prplITooltipInfo.pair:</span>
<a href="#l37.408"></a><span id="l37.408" class="difflineminus">-        case Ci.prplITooltipInfo.sectionHeader:</span>
<a href="#l37.409"></a><span id="l37.409" class="difflineminus">-          msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, elt.label, elt.value);</span>
<a href="#l37.410"></a><span id="l37.410" class="difflineminus">-          break;</span>
<a href="#l37.411"></a><span id="l37.411" class="difflineminus">-        case Ci.prplITooltipInfo.sectionBreak:</span>
<a href="#l37.412"></a><span id="l37.412" class="difflineminus">-          break;</span>
<a href="#l37.413"></a><span id="l37.413" class="difflineminus">-        case Ci.prplITooltipInfo.status:</span>
<a href="#l37.414"></a><span id="l37.414" class="difflineminus">-          if (elt.label != Ci.imIStatusInfo.STATUS_AWAY) {</span>
<a href="#l37.415"></a><span id="l37.415" class="difflineminus">-            break;</span>
<a href="#l37.416"></a><span id="l37.416" class="difflineminus">-          }</span>
<a href="#l37.417"></a><span id="l37.417" class="difflineminus">-          // The away message has no tooltipInfo.pair entry.</span>
<a href="#l37.418"></a><span id="l37.418" class="difflineminus">-          msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, _(&quot;tooltip.away&quot;), elt.value);</span>
<a href="#l37.419"></a><span id="l37.419" class="difflineminus">-          break;</span>
<a href="#l37.420"></a><span id="l37.420" class="difflineminus">-      }</span>
<a href="#l37.421"></a><span id="l37.421" class="difflineminus">-    }</span>
<a href="#l37.422"></a><span id="l37.422" class="difflineminus">-    this.writeMessage(null, msg, type);</span>
<a href="#l37.423"></a><span id="l37.423" class="difflineminus">-  },</span>
<a href="#l37.424"></a><span id="l37.424" class="difflineminus">-</span>
<a href="#l37.425"></a><span id="l37.425" class="difflineminus">-  unInitIRCConversation() {</span>
<a href="#l37.426"></a><span id="l37.426" class="difflineminus">-    this._account.removeConversation(this.name);</span>
<a href="#l37.427"></a><span id="l37.427" class="difflineminus">-    if (this._observedNicks.length) {</span>
<a href="#l37.428"></a><span id="l37.428" class="difflineminus">-      Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l37.429"></a><span id="l37.429" class="difflineminus">-    }</span>
<a href="#l37.430"></a><span id="l37.430" class="difflineminus">-  },</span>
<a href="#l37.431"></a><span id="l37.431" class="difflineminus">-};</span>
<a href="#l37.432"></a><span id="l37.432" class="difflineminus">-</span>
<a href="#l37.433"></a><span id="l37.433" class="difflineminus">-function IRCChannel(aAccount, aName, aNick) {</span>
<a href="#l37.434"></a><span id="l37.434" class="difflineminus">-  this._init(aAccount, aName, aNick);</span>
<a href="#l37.435"></a><span id="l37.435" class="difflineminus">-  this._participants = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l37.436"></a><span id="l37.436" class="difflineminus">-  this._modes = new Set();</span>
<a href="#l37.437"></a><span id="l37.437" class="difflineminus">-  this._observedNicks = [];</span>
<a href="#l37.438"></a><span id="l37.438" class="difflineminus">-  this.banMasks = [];</span>
<a href="#l37.439"></a><span id="l37.439" class="difflineminus">-}</span>
<a href="#l37.440"></a><span id="l37.440" class="difflineminus">-IRCChannel.prototype = {</span>
<a href="#l37.441"></a><span id="l37.441" class="difflineminus">-  __proto__: GenericConvChatPrototype,</span>
<a href="#l37.442"></a><span id="l37.442" class="difflineminus">-  _modes: null,</span>
<a href="#l37.443"></a><span id="l37.443" class="difflineminus">-  _receivedInitialMode: false,</span>
<a href="#l37.444"></a><span id="l37.444" class="difflineminus">-  // For IRC you're not in a channel until the JOIN command is received, open</span>
<a href="#l37.445"></a><span id="l37.445" class="difflineminus">-  // all channels (initially) as left.</span>
<a href="#l37.446"></a><span id="l37.446" class="difflineminus">-  _left: true,</span>
<a href="#l37.447"></a><span id="l37.447" class="difflineminus">-  // True while we are rejoining a channel previously parted by the user.</span>
<a href="#l37.448"></a><span id="l37.448" class="difflineminus">-  _rejoined: false,</span>
<a href="#l37.449"></a><span id="l37.449" class="difflineminus">-  banMasks: [],</span>
<a href="#l37.450"></a><span id="l37.450" class="difflineminus">-</span>
<a href="#l37.451"></a><span id="l37.451" class="difflineminus">-  // Section 3.2.2 of RFC 2812.</span>
<a href="#l37.452"></a><span id="l37.452" class="difflineminus">-  part(aMessage) {</span>
<a href="#l37.453"></a><span id="l37.453" class="difflineminus">-    let params = [this.name];</span>
<a href="#l37.454"></a><span id="l37.454" class="difflineminus">-</span>
<a href="#l37.455"></a><span id="l37.455" class="difflineminus">-    // If a valid message was given, use it as the part message.</span>
<a href="#l37.456"></a><span id="l37.456" class="difflineminus">-    // Otherwise, fall back to the default part message, if it exists.</span>
<a href="#l37.457"></a><span id="l37.457" class="difflineminus">-    let msg = aMessage || this._account.getString(&quot;partmsg&quot;);</span>
<a href="#l37.458"></a><span id="l37.458" class="difflineminus">-    if (msg) {</span>
<a href="#l37.459"></a><span id="l37.459" class="difflineminus">-      params.push(msg);</span>
<a href="#l37.460"></a><span id="l37.460" class="difflineminus">-    }</span>
<a href="#l37.461"></a><span id="l37.461" class="difflineminus">-</span>
<a href="#l37.462"></a><span id="l37.462" class="difflineminus">-    this._account.sendMessage(&quot;PART&quot;, params);</span>
<a href="#l37.463"></a><span id="l37.463" class="difflineminus">-</span>
<a href="#l37.464"></a><span id="l37.464" class="difflineminus">-    // Remove reconnection information.</span>
<a href="#l37.465"></a><span id="l37.465" class="difflineminus">-    delete this.chatRoomFields;</span>
<a href="#l37.466"></a><span id="l37.466" class="difflineminus">-  },</span>
<a href="#l37.467"></a><span id="l37.467" class="difflineminus">-</span>
<a href="#l37.468"></a><span id="l37.468" class="difflineminus">-  close() {</span>
<a href="#l37.469"></a><span id="l37.469" class="difflineminus">-    // Part the room if we're connected.</span>
<a href="#l37.470"></a><span id="l37.470" class="difflineminus">-    if (this._account.connected &amp;&amp; !this.left) {</span>
<a href="#l37.471"></a><span id="l37.471" class="difflineminus">-      this.part();</span>
<a href="#l37.472"></a><span id="l37.472" class="difflineminus">-    }</span>
<a href="#l37.473"></a><span id="l37.473" class="difflineminus">-    GenericConvChatPrototype.close.call(this);</span>
<a href="#l37.474"></a><span id="l37.474" class="difflineminus">-  },</span>
<a href="#l37.475"></a><span id="l37.475" class="difflineminus">-</span>
<a href="#l37.476"></a><span id="l37.476" class="difflineminus">-  unInit() {</span>
<a href="#l37.477"></a><span id="l37.477" class="difflineminus">-    this.unInitIRCConversation();</span>
<a href="#l37.478"></a><span id="l37.478" class="difflineminus">-    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l37.479"></a><span id="l37.479" class="difflineminus">-  },</span>
<a href="#l37.480"></a><span id="l37.480" class="difflineminus">-</span>
<a href="#l37.481"></a><span id="l37.481" class="difflineminus">-  // Use the normalized nick in order to properly notify the observers.</span>
<a href="#l37.482"></a><span id="l37.482" class="difflineminus">-  getNormalizedChatBuddyName(aNick) {</span>
<a href="#l37.483"></a><span id="l37.483" class="difflineminus">-    return this.normalizeNick(aNick);</span>
<a href="#l37.484"></a><span id="l37.484" class="difflineminus">-  },</span>
<a href="#l37.485"></a><span id="l37.485" class="difflineminus">-</span>
<a href="#l37.486"></a><span id="l37.486" class="difflineminus">-  getParticipant(aNick, aNotifyObservers) {</span>
<a href="#l37.487"></a><span id="l37.487" class="difflineminus">-    if (this._participants.has(aNick)) {</span>
<a href="#l37.488"></a><span id="l37.488" class="difflineminus">-      return this._participants.get(aNick);</span>
<a href="#l37.489"></a><span id="l37.489" class="difflineminus">-    }</span>
<a href="#l37.490"></a><span id="l37.490" class="difflineminus">-</span>
<a href="#l37.491"></a><span id="l37.491" class="difflineminus">-    let participant = new ircParticipant(aNick, this);</span>
<a href="#l37.492"></a><span id="l37.492" class="difflineminus">-    this._participants.set(aNick, participant);</span>
<a href="#l37.493"></a><span id="l37.493" class="difflineminus">-</span>
<a href="#l37.494"></a><span id="l37.494" class="difflineminus">-    // Add the participant to the whois table if it is not already there.</span>
<a href="#l37.495"></a><span id="l37.495" class="difflineminus">-    this._account.setWhois(participant._name);</span>
<a href="#l37.496"></a><span id="l37.496" class="difflineminus">-</span>
<a href="#l37.497"></a><span id="l37.497" class="difflineminus">-    if (aNotifyObservers) {</span>
<a href="#l37.498"></a><span id="l37.498" class="difflineminus">-      this.notifyObservers(</span>
<a href="#l37.499"></a><span id="l37.499" class="difflineminus">-        new nsSimpleEnumerator([participant]),</span>
<a href="#l37.500"></a><span id="l37.500" class="difflineminus">-        &quot;chat-buddy-add&quot;</span>
<a href="#l37.501"></a><span id="l37.501" class="difflineminus">-      );</span>
<a href="#l37.502"></a><span id="l37.502" class="difflineminus">-    }</span>
<a href="#l37.503"></a><span id="l37.503" class="difflineminus">-    return participant;</span>
<a href="#l37.504"></a><span id="l37.504" class="difflineminus">-  },</span>
<a href="#l37.505"></a><span id="l37.505" class="difflineminus">-</span>
<a href="#l37.506"></a><span id="l37.506" class="difflineminus">-  /*</span>
<a href="#l37.507"></a><span id="l37.507" class="difflineminus">-   * Add/remove modes from this channel.</span>
<a href="#l37.508"></a><span id="l37.508" class="difflineminus">-   *</span>
<a href="#l37.509"></a><span id="l37.509" class="difflineminus">-   * aNewMode is the new mode string, it MUST begin with + or -.</span>
<a href="#l37.510"></a><span id="l37.510" class="difflineminus">-   * aModeParams is a list of ordered string parameters for the mode string.</span>
<a href="#l37.511"></a><span id="l37.511" class="difflineminus">-   * aSetter is the nick of the person (or service) that set the mode.</span>
<a href="#l37.512"></a><span id="l37.512" class="difflineminus">-   */</span>
<a href="#l37.513"></a><span id="l37.513" class="difflineminus">-  setMode(aNewMode, aModeParams, aSetter) {</span>
<a href="#l37.514"></a><span id="l37.514" class="difflineminus">-    // Save this for a comparison after the new modes have been set.</span>
<a href="#l37.515"></a><span id="l37.515" class="difflineminus">-    let previousTopicSettable = this.topicSettable;</span>
<a href="#l37.516"></a><span id="l37.516" class="difflineminus">-</span>
<a href="#l37.517"></a><span id="l37.517" class="difflineminus">-    const hostMaskExp = /^.+!.+@.+$/;</span>
<a href="#l37.518"></a><span id="l37.518" class="difflineminus">-    function getNextParam() {</span>
<a href="#l37.519"></a><span id="l37.519" class="difflineminus">-      // If there's no next parameter, throw a warning.</span>
<a href="#l37.520"></a><span id="l37.520" class="difflineminus">-      if (!aModeParams.length) {</span>
<a href="#l37.521"></a><span id="l37.521" class="difflineminus">-        this.WARN(&quot;Mode parameter expected!&quot;);</span>
<a href="#l37.522"></a><span id="l37.522" class="difflineminus">-        return undefined;</span>
<a href="#l37.523"></a><span id="l37.523" class="difflineminus">-      }</span>
<a href="#l37.524"></a><span id="l37.524" class="difflineminus">-      return aModeParams.pop();</span>
<a href="#l37.525"></a><span id="l37.525" class="difflineminus">-    }</span>
<a href="#l37.526"></a><span id="l37.526" class="difflineminus">-    function peekNextParam() {</span>
<a href="#l37.527"></a><span id="l37.527" class="difflineminus">-      // Non-destructively gets the next param.</span>
<a href="#l37.528"></a><span id="l37.528" class="difflineminus">-      if (!aModeParams.length) {</span>
<a href="#l37.529"></a><span id="l37.529" class="difflineminus">-        return undefined;</span>
<a href="#l37.530"></a><span id="l37.530" class="difflineminus">-      }</span>
<a href="#l37.531"></a><span id="l37.531" class="difflineminus">-      return aModeParams.slice(-1)[0];</span>
<a href="#l37.532"></a><span id="l37.532" class="difflineminus">-    }</span>
<a href="#l37.533"></a><span id="l37.533" class="difflineminus">-</span>
<a href="#l37.534"></a><span id="l37.534" class="difflineminus">-    // Are modes being added or removed?</span>
<a href="#l37.535"></a><span id="l37.535" class="difflineminus">-    if (aNewMode[0] != &quot;+&quot; &amp;&amp; aNewMode[0] != &quot;-&quot;) {</span>
<a href="#l37.536"></a><span id="l37.536" class="difflineminus">-      this.WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l37.537"></a><span id="l37.537" class="difflineminus">-      return;</span>
<a href="#l37.538"></a><span id="l37.538" class="difflineminus">-    }</span>
<a href="#l37.539"></a><span id="l37.539" class="difflineminus">-    let addNewMode = aNewMode[0] == &quot;+&quot;;</span>
<a href="#l37.540"></a><span id="l37.540" class="difflineminus">-</span>
<a href="#l37.541"></a><span id="l37.541" class="difflineminus">-    // Check each mode being added and update the user.</span>
<a href="#l37.542"></a><span id="l37.542" class="difflineminus">-    let channelModes = [];</span>
<a href="#l37.543"></a><span id="l37.543" class="difflineminus">-    let userModes = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l37.544"></a><span id="l37.544" class="difflineminus">-    let msg;</span>
<a href="#l37.545"></a><span id="l37.545" class="difflineminus">-</span>
<a href="#l37.546"></a><span id="l37.546" class="difflineminus">-    for (let i = aNewMode.length - 1; i &gt; 0; --i) {</span>
<a href="#l37.547"></a><span id="l37.547" class="difflineminus">-      // Since some modes are conflicted between different server</span>
<a href="#l37.548"></a><span id="l37.548" class="difflineminus">-      // implementations, check if a participant with that name exists. If this</span>
<a href="#l37.549"></a><span id="l37.549" class="difflineminus">-      // is true, then update the mode of the ConvChatBuddy.</span>
<a href="#l37.550"></a><span id="l37.550" class="difflineminus">-      if (</span>
<a href="#l37.551"></a><span id="l37.551" class="difflineminus">-        this._account.memberStatuses.includes(aNewMode[i]) &amp;&amp;</span>
<a href="#l37.552"></a><span id="l37.552" class="difflineminus">-        aModeParams.length &amp;&amp;</span>
<a href="#l37.553"></a><span id="l37.553" class="difflineminus">-        this._participants.has(peekNextParam())</span>
<a href="#l37.554"></a><span id="l37.554" class="difflineminus">-      ) {</span>
<a href="#l37.555"></a><span id="l37.555" class="difflineminus">-        // Store the new modes for this nick (so each participant's mode is only</span>
<a href="#l37.556"></a><span id="l37.556" class="difflineminus">-        // updated once).</span>
<a href="#l37.557"></a><span id="l37.557" class="difflineminus">-        let nick = getNextParam();</span>
<a href="#l37.558"></a><span id="l37.558" class="difflineminus">-        if (!userModes.has(nick)) {</span>
<a href="#l37.559"></a><span id="l37.559" class="difflineminus">-          userModes.set(nick, []);</span>
<a href="#l37.560"></a><span id="l37.560" class="difflineminus">-        }</span>
<a href="#l37.561"></a><span id="l37.561" class="difflineminus">-        userModes.get(nick).push(aNewMode[i]);</span>
<a href="#l37.562"></a><span id="l37.562" class="difflineminus">-</span>
<a href="#l37.563"></a><span id="l37.563" class="difflineminus">-        // Don't use this mode as a channel mode.</span>
<a href="#l37.564"></a><span id="l37.564" class="difflineminus">-        continue;</span>
<a href="#l37.565"></a><span id="l37.565" class="difflineminus">-      } else if (aNewMode[i] == &quot;k&quot;) {</span>
<a href="#l37.566"></a><span id="l37.566" class="difflineminus">-        // Channel key.</span>
<a href="#l37.567"></a><span id="l37.567" class="difflineminus">-        let newFields = this.name;</span>
<a href="#l37.568"></a><span id="l37.568" class="difflineminus">-        if (addNewMode) {</span>
<a href="#l37.569"></a><span id="l37.569" class="difflineminus">-          let key = getNextParam();</span>
<a href="#l37.570"></a><span id="l37.570" class="difflineminus">-          // A new channel key was set, display a message if this key is not</span>
<a href="#l37.571"></a><span id="l37.571" class="difflineminus">-          // already known.</span>
<a href="#l37.572"></a><span id="l37.572" class="difflineminus">-          if (</span>
<a href="#l37.573"></a><span id="l37.573" class="difflineminus">-            this.chatRoomFields &amp;&amp;</span>
<a href="#l37.574"></a><span id="l37.574" class="difflineminus">-            this.chatRoomFields.getValue(&quot;password&quot;) == key</span>
<a href="#l37.575"></a><span id="l37.575" class="difflineminus">-          ) {</span>
<a href="#l37.576"></a><span id="l37.576" class="difflineminus">-            continue;</span>
<a href="#l37.577"></a><span id="l37.577" class="difflineminus">-          }</span>
<a href="#l37.578"></a><span id="l37.578" class="difflineminus">-          msg = _(&quot;message.channelKeyAdded&quot;, aSetter, key);</span>
<a href="#l37.579"></a><span id="l37.579" class="difflineminus">-          newFields += &quot; &quot; + key;</span>
<a href="#l37.580"></a><span id="l37.580" class="difflineminus">-        } else {</span>
<a href="#l37.581"></a><span id="l37.581" class="difflineminus">-          msg = _(&quot;message.channelKeyRemoved&quot;, aSetter);</span>
<a href="#l37.582"></a><span id="l37.582" class="difflineminus">-        }</span>
<a href="#l37.583"></a><span id="l37.583" class="difflineminus">-</span>
<a href="#l37.584"></a><span id="l37.584" class="difflineminus">-        this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l37.585"></a><span id="l37.585" class="difflineminus">-        // Store the new fields for reconnect.</span>
<a href="#l37.586"></a><span id="l37.586" class="difflineminus">-        this.chatRoomFields = this._account.getChatRoomDefaultFieldValues(</span>
<a href="#l37.587"></a><span id="l37.587" class="difflineminus">-          newFields</span>
<a href="#l37.588"></a><span id="l37.588" class="difflineminus">-        );</span>
<a href="#l37.589"></a><span id="l37.589" class="difflineminus">-      } else if (aNewMode[i] == &quot;b&quot;) {</span>
<a href="#l37.590"></a><span id="l37.590" class="difflineminus">-        // A banmask was added or removed.</span>
<a href="#l37.591"></a><span id="l37.591" class="difflineminus">-        let banMask = getNextParam();</span>
<a href="#l37.592"></a><span id="l37.592" class="difflineminus">-        let msgKey = &quot;message.banMask&quot;;</span>
<a href="#l37.593"></a><span id="l37.593" class="difflineminus">-        if (addNewMode) {</span>
<a href="#l37.594"></a><span id="l37.594" class="difflineminus">-          this.banMasks.push(banMask);</span>
<a href="#l37.595"></a><span id="l37.595" class="difflineminus">-          msgKey += &quot;Added&quot;;</span>
<a href="#l37.596"></a><span id="l37.596" class="difflineminus">-        } else {</span>
<a href="#l37.597"></a><span id="l37.597" class="difflineminus">-          this.banMasks = this.banMasks.filter(aBanMask =&gt; banMask != aBanMask);</span>
<a href="#l37.598"></a><span id="l37.598" class="difflineminus">-          msgKey += &quot;Removed&quot;;</span>
<a href="#l37.599"></a><span id="l37.599" class="difflineminus">-        }</span>
<a href="#l37.600"></a><span id="l37.600" class="difflineminus">-        this.writeMessage(aSetter, _(msgKey, banMask, aSetter), {</span>
<a href="#l37.601"></a><span id="l37.601" class="difflineminus">-          system: true,</span>
<a href="#l37.602"></a><span id="l37.602" class="difflineminus">-        });</span>
<a href="#l37.603"></a><span id="l37.603" class="difflineminus">-      } else if ([&quot;e&quot;, &quot;I&quot;, &quot;l&quot;].includes(aNewMode[i])) {</span>
<a href="#l37.604"></a><span id="l37.604" class="difflineminus">-        // TODO The following have parameters that must be accounted for.</span>
<a href="#l37.605"></a><span id="l37.605" class="difflineminus">-        getNextParam();</span>
<a href="#l37.606"></a><span id="l37.606" class="difflineminus">-      } else if (</span>
<a href="#l37.607"></a><span id="l37.607" class="difflineminus">-        aNewMode[i] == &quot;R&quot; &amp;&amp;</span>
<a href="#l37.608"></a><span id="l37.608" class="difflineminus">-        aModeParams.length &amp;&amp;</span>
<a href="#l37.609"></a><span id="l37.609" class="difflineminus">-        peekNextParam().match(hostMaskExp)</span>
<a href="#l37.610"></a><span id="l37.610" class="difflineminus">-      ) {</span>
<a href="#l37.611"></a><span id="l37.611" class="difflineminus">-        // REOP_LIST takes a mask as a parameter, since R is a conflicted mode,</span>
<a href="#l37.612"></a><span id="l37.612" class="difflineminus">-        // try to match the parameter. Implemented by IRCNet.</span>
<a href="#l37.613"></a><span id="l37.613" class="difflineminus">-        // TODO The parameter must be acounted for.</span>
<a href="#l37.614"></a><span id="l37.614" class="difflineminus">-        getNextParam();</span>
<a href="#l37.615"></a><span id="l37.615" class="difflineminus">-      }</span>
<a href="#l37.616"></a><span id="l37.616" class="difflineminus">-      // TODO From RFC 2811: a, i, m, n, q, p, s, r, t, l, e, I.</span>
<a href="#l37.617"></a><span id="l37.617" class="difflineminus">-</span>
<a href="#l37.618"></a><span id="l37.618" class="difflineminus">-      // Keep track of the channel modes in the order they were received.</span>
<a href="#l37.619"></a><span id="l37.619" class="difflineminus">-      channelModes.unshift(aNewMode[i]);</span>
<a href="#l37.620"></a><span id="l37.620" class="difflineminus">-    }</span>
<a href="#l37.621"></a><span id="l37.621" class="difflineminus">-</span>
<a href="#l37.622"></a><span id="l37.622" class="difflineminus">-    if (aModeParams.length) {</span>
<a href="#l37.623"></a><span id="l37.623" class="difflineminus">-      this.WARN(&quot;Unused mode parameters: &quot; + aModeParams.join(&quot;, &quot;));</span>
<a href="#l37.624"></a><span id="l37.624" class="difflineminus">-    }</span>
<a href="#l37.625"></a><span id="l37.625" class="difflineminus">-</span>
<a href="#l37.626"></a><span id="l37.626" class="difflineminus">-    // Update the mode of each participant.</span>
<a href="#l37.627"></a><span id="l37.627" class="difflineminus">-    for (let [nick, mode] of userModes.entries()) {</span>
<a href="#l37.628"></a><span id="l37.628" class="difflineminus">-      this.getParticipant(nick).setMode(addNewMode, mode, aSetter);</span>
<a href="#l37.629"></a><span id="l37.629" class="difflineminus">-    }</span>
<a href="#l37.630"></a><span id="l37.630" class="difflineminus">-</span>
<a href="#l37.631"></a><span id="l37.631" class="difflineminus">-    // If the topic can now be set (and it couldn't previously) or vice versa,</span>
<a href="#l37.632"></a><span id="l37.632" class="difflineminus">-    // notify the UI. Note that this status can change by either a channel mode</span>
<a href="#l37.633"></a><span id="l37.633" class="difflineminus">-    // or a user mode changing.</span>
<a href="#l37.634"></a><span id="l37.634" class="difflineminus">-    if (this.topicSettable != previousTopicSettable) {</span>
<a href="#l37.635"></a><span id="l37.635" class="difflineminus">-      this.notifyObservers(this, &quot;chat-update-topic&quot;);</span>
<a href="#l37.636"></a><span id="l37.636" class="difflineminus">-    }</span>
<a href="#l37.637"></a><span id="l37.637" class="difflineminus">-</span>
<a href="#l37.638"></a><span id="l37.638" class="difflineminus">-    // If no channel modes were being set, don't display a message for it.</span>
<a href="#l37.639"></a><span id="l37.639" class="difflineminus">-    if (!channelModes.length) {</span>
<a href="#l37.640"></a><span id="l37.640" class="difflineminus">-      return;</span>
<a href="#l37.641"></a><span id="l37.641" class="difflineminus">-    }</span>
<a href="#l37.642"></a><span id="l37.642" class="difflineminus">-</span>
<a href="#l37.643"></a><span id="l37.643" class="difflineminus">-    // Store the channel modes.</span>
<a href="#l37.644"></a><span id="l37.644" class="difflineminus">-    _setMode.call(this, addNewMode, channelModes);</span>
<a href="#l37.645"></a><span id="l37.645" class="difflineminus">-</span>
<a href="#l37.646"></a><span id="l37.646" class="difflineminus">-    // Notify the UI of changes.</span>
<a href="#l37.647"></a><span id="l37.647" class="difflineminus">-    msg = _(</span>
<a href="#l37.648"></a><span id="l37.648" class="difflineminus">-      &quot;message.channelmode&quot;,</span>
<a href="#l37.649"></a><span id="l37.649" class="difflineminus">-      aNewMode[0] + channelModes.join(&quot;&quot;),</span>
<a href="#l37.650"></a><span id="l37.650" class="difflineminus">-      aSetter</span>
<a href="#l37.651"></a><span id="l37.651" class="difflineminus">-    );</span>
<a href="#l37.652"></a><span id="l37.652" class="difflineminus">-    this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l37.653"></a><span id="l37.653" class="difflineminus">-</span>
<a href="#l37.654"></a><span id="l37.654" class="difflineminus">-    this._receivedInitialMode = true;</span>
<a href="#l37.655"></a><span id="l37.655" class="difflineminus">-  },</span>
<a href="#l37.656"></a><span id="l37.656" class="difflineminus">-</span>
<a href="#l37.657"></a><span id="l37.657" class="difflineminus">-  setModesFromRestriction(aRestriction) {</span>
<a href="#l37.658"></a><span id="l37.658" class="difflineminus">-    // First remove all types from the list of modes.</span>
<a href="#l37.659"></a><span id="l37.659" class="difflineminus">-    for (let key in this._account.channelRestrictionToModeMap) {</span>
<a href="#l37.660"></a><span id="l37.660" class="difflineminus">-      let mode = this._account.channelRestrictionToModeMap[key];</span>
<a href="#l37.661"></a><span id="l37.661" class="difflineminus">-      this._modes.delete(mode);</span>
<a href="#l37.662"></a><span id="l37.662" class="difflineminus">-    }</span>
<a href="#l37.663"></a><span id="l37.663" class="difflineminus">-</span>
<a href="#l37.664"></a><span id="l37.664" class="difflineminus">-    // Add the new mode onto the list.</span>
<a href="#l37.665"></a><span id="l37.665" class="difflineminus">-    if (aRestriction in this._account.channelRestrictionToModeMap) {</span>
<a href="#l37.666"></a><span id="l37.666" class="difflineminus">-      let mode = this._account.channelRestrictionToModeMap[aRestriction];</span>
<a href="#l37.667"></a><span id="l37.667" class="difflineminus">-      if (mode) {</span>
<a href="#l37.668"></a><span id="l37.668" class="difflineminus">-        this._modes.add(mode);</span>
<a href="#l37.669"></a><span id="l37.669" class="difflineminus">-      }</span>
<a href="#l37.670"></a><span id="l37.670" class="difflineminus">-    }</span>
<a href="#l37.671"></a><span id="l37.671" class="difflineminus">-  },</span>
<a href="#l37.672"></a><span id="l37.672" class="difflineminus">-</span>
<a href="#l37.673"></a><span id="l37.673" class="difflineminus">-  get topic() {</span>
<a href="#l37.674"></a><span id="l37.674" class="difflineminus">-    return this._topic;</span>
<a href="#l37.675"></a><span id="l37.675" class="difflineminus">-  }, // can't add a setter without redefining the getter</span>
<a href="#l37.676"></a><span id="l37.676" class="difflineminus">-  set topic(aTopic) {</span>
<a href="#l37.677"></a><span id="l37.677" class="difflineminus">-    // Note that the UI isn't updated here because the server will echo back the</span>
<a href="#l37.678"></a><span id="l37.678" class="difflineminus">-    // TOPIC to us and we'll set it on receive.</span>
<a href="#l37.679"></a><span id="l37.679" class="difflineminus">-    this._account.sendMessage(&quot;TOPIC&quot;, [this.name, aTopic]);</span>
<a href="#l37.680"></a><span id="l37.680" class="difflineminus">-  },</span>
<a href="#l37.681"></a><span id="l37.681" class="difflineminus">-  get topicSettable() {</span>
<a href="#l37.682"></a><span id="l37.682" class="difflineminus">-    // Don't use getParticipant since we don't want to lazily create it!</span>
<a href="#l37.683"></a><span id="l37.683" class="difflineminus">-    let participant = this._participants.get(this.nick);</span>
<a href="#l37.684"></a><span id="l37.684" class="difflineminus">-</span>
<a href="#l37.685"></a><span id="l37.685" class="difflineminus">-    // We must be in the room to set the topic.</span>
<a href="#l37.686"></a><span id="l37.686" class="difflineminus">-    if (!participant) {</span>
<a href="#l37.687"></a><span id="l37.687" class="difflineminus">-      return false;</span>
<a href="#l37.688"></a><span id="l37.688" class="difflineminus">-    }</span>
<a href="#l37.689"></a><span id="l37.689" class="difflineminus">-</span>
<a href="#l37.690"></a><span id="l37.690" class="difflineminus">-    // If the channel mode is +t, hops and ops can set the topic; otherwise</span>
<a href="#l37.691"></a><span id="l37.691" class="difflineminus">-    // everyone can.</span>
<a href="#l37.692"></a><span id="l37.692" class="difflineminus">-    return !this._modes.has(&quot;t&quot;) || participant.op || participant.halfOp;</span>
<a href="#l37.693"></a><span id="l37.693" class="difflineminus">-  },</span>
<a href="#l37.694"></a><span id="l37.694" class="difflineminus">-  writeMessage(aMsg, aWho, aObject) {</span>
<a href="#l37.695"></a><span id="l37.695" class="difflineminus">-    const messageProps = this.handleTags(aMsg, aWho, aObject);</span>
<a href="#l37.696"></a><span id="l37.696" class="difflineminus">-    GenericConvChatPrototype.writeMessage.call(this, aMsg, aWho, messageProps);</span>
<a href="#l37.697"></a><span id="l37.697" class="difflineminus">-  },</span>
<a href="#l37.698"></a><span id="l37.698" class="difflineminus">-};</span>
<a href="#l37.699"></a><span id="l37.699" class="difflineminus">-Object.assign(IRCChannel.prototype, GenericIRCConversation);</span>
<a href="#l37.700"></a><span id="l37.700" class="difflineminus">-</span>
<a href="#l37.701"></a><span id="l37.701" class="difflineminus">-function ircParticipant(aName, aConv) {</span>
<a href="#l37.702"></a><span id="l37.702" class="difflineminus">-  this._name = aName;</span>
<a href="#l37.703"></a><span id="l37.703" class="difflineminus">-  this._conv = aConv;</span>
<a href="#l37.704"></a><span id="l37.704" class="difflineminus">-  this._account = aConv._account;</span>
<a href="#l37.705"></a><span id="l37.705" class="difflineminus">-  this._modes = new Set();</span>
<a href="#l37.706"></a><span id="l37.706" class="difflineminus">-</span>
<a href="#l37.707"></a><span id="l37.707" class="difflineminus">-  // Handle multi-prefix modes.</span>
<a href="#l37.708"></a><span id="l37.708" class="difflineminus">-  let i;</span>
<a href="#l37.709"></a><span id="l37.709" class="difflineminus">-  for (</span>
<a href="#l37.710"></a><span id="l37.710" class="difflineminus">-    i = 0;</span>
<a href="#l37.711"></a><span id="l37.711" class="difflineminus">-    i &lt; this._name.length &amp;&amp; this._name[i] in this._account.userPrefixToModeMap;</span>
<a href="#l37.712"></a><span id="l37.712" class="difflineminus">-    ++i</span>
<a href="#l37.713"></a><span id="l37.713" class="difflineminus">-  ) {</span>
<a href="#l37.714"></a><span id="l37.714" class="difflineminus">-    let mode = this._account.userPrefixToModeMap[this._name[i]];</span>
<a href="#l37.715"></a><span id="l37.715" class="difflineminus">-    if (mode) {</span>
<a href="#l37.716"></a><span id="l37.716" class="difflineminus">-      this._modes.add(mode);</span>
<a href="#l37.717"></a><span id="l37.717" class="difflineminus">-    }</span>
<a href="#l37.718"></a><span id="l37.718" class="difflineminus">-  }</span>
<a href="#l37.719"></a><span id="l37.719" class="difflineminus">-  this._name = this._name.slice(i);</span>
<a href="#l37.720"></a><span id="l37.720" class="difflineminus">-}</span>
<a href="#l37.721"></a><span id="l37.721" class="difflineminus">-ircParticipant.prototype = {</span>
<a href="#l37.722"></a><span id="l37.722" class="difflineminus">-  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l37.723"></a><span id="l37.723" class="difflineminus">-</span>
<a href="#l37.724"></a><span id="l37.724" class="difflineminus">-  setMode(aAddNewMode, aNewModes, aSetter) {</span>
<a href="#l37.725"></a><span id="l37.725" class="difflineminus">-    _setMode.call(this, aAddNewMode, aNewModes);</span>
<a href="#l37.726"></a><span id="l37.726" class="difflineminus">-</span>
<a href="#l37.727"></a><span id="l37.727" class="difflineminus">-    // Notify the UI of changes.</span>
<a href="#l37.728"></a><span id="l37.728" class="difflineminus">-    let msg = _(</span>
<a href="#l37.729"></a><span id="l37.729" class="difflineminus">-      &quot;message.usermode&quot;,</span>
<a href="#l37.730"></a><span id="l37.730" class="difflineminus">-      (aAddNewMode ? &quot;+&quot; : &quot;-&quot;) + aNewModes.join(&quot;&quot;),</span>
<a href="#l37.731"></a><span id="l37.731" class="difflineminus">-      this.name,</span>
<a href="#l37.732"></a><span id="l37.732" class="difflineminus">-      aSetter</span>
<a href="#l37.733"></a><span id="l37.733" class="difflineminus">-    );</span>
<a href="#l37.734"></a><span id="l37.734" class="difflineminus">-    this._conv.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l37.735"></a><span id="l37.735" class="difflineminus">-    this._conv.notifyObservers(this, &quot;chat-buddy-update&quot;);</span>
<a href="#l37.736"></a><span id="l37.736" class="difflineminus">-  },</span>
<a href="#l37.737"></a><span id="l37.737" class="difflineminus">-</span>
<a href="#l37.738"></a><span id="l37.738" class="difflineminus">-  get voiced() {</span>
<a href="#l37.739"></a><span id="l37.739" class="difflineminus">-    return this._modes.has(&quot;v&quot;);</span>
<a href="#l37.740"></a><span id="l37.740" class="difflineminus">-  },</span>
<a href="#l37.741"></a><span id="l37.741" class="difflineminus">-  get halfOp() {</span>
<a href="#l37.742"></a><span id="l37.742" class="difflineminus">-    return this._modes.has(&quot;h&quot;);</span>
<a href="#l37.743"></a><span id="l37.743" class="difflineminus">-  },</span>
<a href="#l37.744"></a><span id="l37.744" class="difflineminus">-  get op() {</span>
<a href="#l37.745"></a><span id="l37.745" class="difflineminus">-    return this._modes.has(&quot;o&quot;);</span>
<a href="#l37.746"></a><span id="l37.746" class="difflineminus">-  },</span>
<a href="#l37.747"></a><span id="l37.747" class="difflineminus">-  get founder() {</span>
<a href="#l37.748"></a><span id="l37.748" class="difflineminus">-    return this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;);</span>
<a href="#l37.749"></a><span id="l37.749" class="difflineminus">-  },</span>
<a href="#l37.750"></a><span id="l37.750" class="difflineminus">-  get typing() {</span>
<a href="#l37.751"></a><span id="l37.751" class="difflineminus">-    return false;</span>
<a href="#l37.752"></a><span id="l37.752" class="difflineminus">-  },</span>
<a href="#l37.753"></a><span id="l37.753" class="difflineminus">-};</span>
<a href="#l37.754"></a><span id="l37.754" class="difflineminus">-</span>
<a href="#l37.755"></a><span id="l37.755" class="difflineminus">-function IRCConversation(aAccount, aName) {</span>
<a href="#l37.756"></a><span id="l37.756" class="difflineminus">-  let nick = aAccount.normalize(aName);</span>
<a href="#l37.757"></a><span id="l37.757" class="difflineminus">-  if (aAccount.whoisInformation.has(nick)) {</span>
<a href="#l37.758"></a><span id="l37.758" class="difflineminus">-    aName = aAccount.whoisInformation.get(nick).nick;</span>
<a href="#l37.759"></a><span id="l37.759" class="difflineminus">-  }</span>
<a href="#l37.760"></a><span id="l37.760" class="difflineminus">-</span>
<a href="#l37.761"></a><span id="l37.761" class="difflineminus">-  this._init(aAccount, aName);</span>
<a href="#l37.762"></a><span id="l37.762" class="difflineminus">-  this._observedNicks = [];</span>
<a href="#l37.763"></a><span id="l37.763" class="difflineminus">-</span>
<a href="#l37.764"></a><span id="l37.764" class="difflineminus">-  // Fetch correctly capitalized name.</span>
<a href="#l37.765"></a><span id="l37.765" class="difflineminus">-  // Always request the info as it may be out of date.</span>
<a href="#l37.766"></a><span id="l37.766" class="difflineminus">-  this._waitingForNick = true;</span>
<a href="#l37.767"></a><span id="l37.767" class="difflineminus">-  this.requestCurrentWhois(aName);</span>
<a href="#l37.768"></a><span id="l37.768" class="difflineminus">-}</span>
<a href="#l37.769"></a><span id="l37.769" class="difflineminus">-IRCConversation.prototype = {</span>
<a href="#l37.770"></a><span id="l37.770" class="difflineminus">-  __proto__: GenericConvIMPrototype,</span>
<a href="#l37.771"></a><span id="l37.771" class="difflineminus">-  get buddy() {</span>
<a href="#l37.772"></a><span id="l37.772" class="difflineminus">-    return this._account.buddies.get(this.name);</span>
<a href="#l37.773"></a><span id="l37.773" class="difflineminus">-  },</span>
<a href="#l37.774"></a><span id="l37.774" class="difflineminus">-</span>
<a href="#l37.775"></a><span id="l37.775" class="difflineminus">-  unInit() {</span>
<a href="#l37.776"></a><span id="l37.776" class="difflineminus">-    this.unInitIRCConversation();</span>
<a href="#l37.777"></a><span id="l37.777" class="difflineminus">-    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l37.778"></a><span id="l37.778" class="difflineminus">-  },</span>
<a href="#l37.779"></a><span id="l37.779" class="difflineminus">-</span>
<a href="#l37.780"></a><span id="l37.780" class="difflineminus">-  updateNick(aNewNick) {</span>
<a href="#l37.781"></a><span id="l37.781" class="difflineminus">-    this._name = aNewNick;</span>
<a href="#l37.782"></a><span id="l37.782" class="difflineminus">-    this.notifyObservers(null, &quot;update-conv-title&quot;);</span>
<a href="#l37.783"></a><span id="l37.783" class="difflineminus">-  },</span>
<a href="#l37.784"></a><span id="l37.784" class="difflineminus">-  writeMessage(aMsg, aWho, aObject) {</span>
<a href="#l37.785"></a><span id="l37.785" class="difflineminus">-    const messageProps = this.handleTags(aMsg, aWho, aObject);</span>
<a href="#l37.786"></a><span id="l37.786" class="difflineminus">-    GenericConvIMPrototype.writeMessage.call(this, aMsg, aWho, messageProps);</span>
<a href="#l37.787"></a><span id="l37.787" class="difflineminus">-  },</span>
<a href="#l37.788"></a><span id="l37.788" class="difflineminus">-};</span>
<a href="#l37.789"></a><span id="l37.789" class="difflineminus">-Object.assign(IRCConversation.prototype, GenericIRCConversation);</span>
<a href="#l37.790"></a><span id="l37.790" class="difflineminus">-</span>
<a href="#l37.791"></a><span id="l37.791" class="difflineminus">-function ircSocket(aAccount) {</span>
<a href="#l37.792"></a><span id="l37.792" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l37.793"></a><span id="l37.793" class="difflineminus">-  this._initCharsetConverter();</span>
<a href="#l37.794"></a><span id="l37.794" class="difflineminus">-}</span>
<a href="#l37.795"></a><span id="l37.795" class="difflineminus">-ircSocket.prototype = {</span>
<a href="#l37.796"></a><span id="l37.796" class="difflineminus">-  __proto__: Socket,</span>
<a href="#l37.797"></a><span id="l37.797" class="difflineminus">-  // Although RFCs 1459 and 2812 explicitly say that \r\n is the message</span>
<a href="#l37.798"></a><span id="l37.798" class="difflineminus">-  // separator, some networks (euIRC) only send \n.</span>
<a href="#l37.799"></a><span id="l37.799" class="difflineminus">-  delimiter: /\r?\n/,</span>
<a href="#l37.800"></a><span id="l37.800" class="difflineminus">-  connectTimeout: 60, // Failure to connect after 1 minute</span>
<a href="#l37.801"></a><span id="l37.801" class="difflineminus">-  readWriteTimeout: 300, // Failure when no data for 5 minutes</span>
<a href="#l37.802"></a><span id="l37.802" class="difflineminus">-  _converter: null,</span>
<a href="#l37.803"></a><span id="l37.803" class="difflineminus">-</span>
<a href="#l37.804"></a><span id="l37.804" class="difflineminus">-  sendPing() {</span>
<a href="#l37.805"></a><span id="l37.805" class="difflineminus">-    // Send a ping using the current timestamp as a payload prefixed with</span>
<a href="#l37.806"></a><span id="l37.806" class="difflineminus">-    // an underscore to signify this was an &quot;automatic&quot; PING (used to avoid</span>
<a href="#l37.807"></a><span id="l37.807" class="difflineminus">-    // socket timeouts).</span>
<a href="#l37.808"></a><span id="l37.808" class="difflineminus">-    this._account.sendMessage(&quot;PING&quot;, &quot;_&quot; + Date.now());</span>
<a href="#l37.809"></a><span id="l37.809" class="difflineminus">-  },</span>
<a href="#l37.810"></a><span id="l37.810" class="difflineminus">-</span>
<a href="#l37.811"></a><span id="l37.811" class="difflineminus">-  _initCharsetConverter() {</span>
<a href="#l37.812"></a><span id="l37.812" class="difflineminus">-    this._converter = Cc[</span>
<a href="#l37.813"></a><span id="l37.813" class="difflineminus">-      &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l37.814"></a><span id="l37.814" class="difflineminus">-    ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l37.815"></a><span id="l37.815" class="difflineminus">-    try {</span>
<a href="#l37.816"></a><span id="l37.816" class="difflineminus">-      this._converter.charset = this._account._encoding;</span>
<a href="#l37.817"></a><span id="l37.817" class="difflineminus">-    } catch (e) {</span>
<a href="#l37.818"></a><span id="l37.818" class="difflineminus">-      delete this._converter;</span>
<a href="#l37.819"></a><span id="l37.819" class="difflineminus">-      this.ERROR(</span>
<a href="#l37.820"></a><span id="l37.820" class="difflineminus">-        &quot;Failed to set character set to: &quot; +</span>
<a href="#l37.821"></a><span id="l37.821" class="difflineminus">-          this._account._encoding +</span>
<a href="#l37.822"></a><span id="l37.822" class="difflineminus">-          &quot; for &quot; +</span>
<a href="#l37.823"></a><span id="l37.823" class="difflineminus">-          this._account.name +</span>
<a href="#l37.824"></a><span id="l37.824" class="difflineminus">-          &quot;.&quot;</span>
<a href="#l37.825"></a><span id="l37.825" class="difflineminus">-      );</span>
<a href="#l37.826"></a><span id="l37.826" class="difflineminus">-    }</span>
<a href="#l37.827"></a><span id="l37.827" class="difflineminus">-  },</span>
<a href="#l37.828"></a><span id="l37.828" class="difflineminus">-</span>
<a href="#l37.829"></a><span id="l37.829" class="difflineminus">-  // Implement Section 5 of RFC 2812.</span>
<a href="#l37.830"></a><span id="l37.830" class="difflineminus">-  onDataReceived(aRawMessage) {</span>
<a href="#l37.831"></a><span id="l37.831" class="difflineminus">-    let conversionWarning = &quot;&quot;;</span>
<a href="#l37.832"></a><span id="l37.832" class="difflineminus">-    if (this._converter) {</span>
<a href="#l37.833"></a><span id="l37.833" class="difflineminus">-      try {</span>
<a href="#l37.834"></a><span id="l37.834" class="difflineminus">-        aRawMessage = this._converter.ConvertToUnicode(aRawMessage);</span>
<a href="#l37.835"></a><span id="l37.835" class="difflineminus">-      } catch (e) {</span>
<a href="#l37.836"></a><span id="l37.836" class="difflineminus">-        conversionWarning =</span>
<a href="#l37.837"></a><span id="l37.837" class="difflineminus">-          &quot;\nThis message doesn't seem to be &quot; +</span>
<a href="#l37.838"></a><span id="l37.838" class="difflineminus">-          this._account._encoding +</span>
<a href="#l37.839"></a><span id="l37.839" class="difflineminus">-          &quot; encoded.&quot;;</span>
<a href="#l37.840"></a><span id="l37.840" class="difflineminus">-        // Unfortunately, if the unicode converter failed once,</span>
<a href="#l37.841"></a><span id="l37.841" class="difflineminus">-        // it will keep failing so we need to reinitialize it.</span>
<a href="#l37.842"></a><span id="l37.842" class="difflineminus">-        this._initCharsetConverter();</span>
<a href="#l37.843"></a><span id="l37.843" class="difflineminus">-      }</span>
<a href="#l37.844"></a><span id="l37.844" class="difflineminus">-    }</span>
<a href="#l37.845"></a><span id="l37.845" class="difflineminus">-</span>
<a href="#l37.846"></a><span id="l37.846" class="difflineminus">-    // We've received data and are past the authentication stage.</span>
<a href="#l37.847"></a><span id="l37.847" class="difflineminus">-    if (this._account.connected) {</span>
<a href="#l37.848"></a><span id="l37.848" class="difflineminus">-      this.resetPingTimer();</span>
<a href="#l37.849"></a><span id="l37.849" class="difflineminus">-    }</span>
<a href="#l37.850"></a><span id="l37.850" class="difflineminus">-</span>
<a href="#l37.851"></a><span id="l37.851" class="difflineminus">-    // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l37.852"></a><span id="l37.852" class="difflineminus">-    // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l37.853"></a><span id="l37.853" class="difflineminus">-    // replaced with itself.</span>
<a href="#l37.854"></a><span id="l37.854" class="difflineminus">-    const lowDequote = { &quot;0&quot;: &quot;\0&quot;, n: &quot;\n&quot;, r: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l37.855"></a><span id="l37.855" class="difflineminus">-    let dequotedMessage = aRawMessage.replace(</span>
<a href="#l37.856"></a><span id="l37.856" class="difflineminus">-      // eslint-disable-next-line no-control-regex</span>
<a href="#l37.857"></a><span id="l37.857" class="difflineminus">-      /\x10./g,</span>
<a href="#l37.858"></a><span id="l37.858" class="difflineminus">-      aStr =&gt; lowDequote[aStr[1]] || aStr[1]</span>
<a href="#l37.859"></a><span id="l37.859" class="difflineminus">-    );</span>
<a href="#l37.860"></a><span id="l37.860" class="difflineminus">-</span>
<a href="#l37.861"></a><span id="l37.861" class="difflineminus">-    try {</span>
<a href="#l37.862"></a><span id="l37.862" class="difflineminus">-      let message = new IRCMessage(</span>
<a href="#l37.863"></a><span id="l37.863" class="difflineminus">-        dequotedMessage,</span>
<a href="#l37.864"></a><span id="l37.864" class="difflineminus">-        this._account._currentServerName</span>
<a href="#l37.865"></a><span id="l37.865" class="difflineminus">-      );</span>
<a href="#l37.866"></a><span id="l37.866" class="difflineminus">-      this.DEBUG(JSON.stringify(message) + conversionWarning);</span>
<a href="#l37.867"></a><span id="l37.867" class="difflineminus">-      if (!ircHandlers.handleMessage(this._account, message)) {</span>
<a href="#l37.868"></a><span id="l37.868" class="difflineminus">-        // If the message was not handled, throw a warning containing</span>
<a href="#l37.869"></a><span id="l37.869" class="difflineminus">-        // the original quoted message.</span>
<a href="#l37.870"></a><span id="l37.870" class="difflineminus">-        this.WARN(&quot;Unhandled IRC message:\n&quot; + aRawMessage);</span>
<a href="#l37.871"></a><span id="l37.871" class="difflineminus">-      }</span>
<a href="#l37.872"></a><span id="l37.872" class="difflineminus">-    } catch (e) {</span>
<a href="#l37.873"></a><span id="l37.873" class="difflineminus">-      // Catch the error, display it and hope the connection can continue with</span>
<a href="#l37.874"></a><span id="l37.874" class="difflineminus">-      // this message in error. Errors are also caught inside of handleMessage,</span>
<a href="#l37.875"></a><span id="l37.875" class="difflineminus">-      // but we expect to handle message parsing errors here.</span>
<a href="#l37.876"></a><span id="l37.876" class="difflineminus">-      this.DEBUG(aRawMessage + conversionWarning);</span>
<a href="#l37.877"></a><span id="l37.877" class="difflineminus">-      this.ERROR(e);</span>
<a href="#l37.878"></a><span id="l37.878" class="difflineminus">-    }</span>
<a href="#l37.879"></a><span id="l37.879" class="difflineminus">-  },</span>
<a href="#l37.880"></a><span id="l37.880" class="difflineminus">-  onConnection() {</span>
<a href="#l37.881"></a><span id="l37.881" class="difflineminus">-    this._account._connectionRegistration();</span>
<a href="#l37.882"></a><span id="l37.882" class="difflineminus">-  },</span>
<a href="#l37.883"></a><span id="l37.883" class="difflineminus">-  disconnect() {</span>
<a href="#l37.884"></a><span id="l37.884" class="difflineminus">-    if (!this._account) {</span>
<a href="#l37.885"></a><span id="l37.885" class="difflineminus">-      return;</span>
<a href="#l37.886"></a><span id="l37.886" class="difflineminus">-    }</span>
<a href="#l37.887"></a><span id="l37.887" class="difflineminus">-    Socket.disconnect.call(this);</span>
<a href="#l37.888"></a><span id="l37.888" class="difflineminus">-    delete this._account;</span>
<a href="#l37.889"></a><span id="l37.889" class="difflineminus">-  },</span>
<a href="#l37.890"></a><span id="l37.890" class="difflineminus">-</span>
<a href="#l37.891"></a><span id="l37.891" class="difflineminus">-  // Throw errors if the socket has issues.</span>
<a href="#l37.892"></a><span id="l37.892" class="difflineminus">-  onConnectionClosed() {</span>
<a href="#l37.893"></a><span id="l37.893" class="difflineminus">-    // If the account was already disconnected, e.g. in response to</span>
<a href="#l37.894"></a><span id="l37.894" class="difflineminus">-    // onConnectionReset, do nothing.</span>
<a href="#l37.895"></a><span id="l37.895" class="difflineminus">-    if (!this._account) {</span>
<a href="#l37.896"></a><span id="l37.896" class="difflineminus">-      return;</span>
<a href="#l37.897"></a><span id="l37.897" class="difflineminus">-    }</span>
<a href="#l37.898"></a><span id="l37.898" class="difflineminus">-    const msg = &quot;Connection closed by server.&quot;;</span>
<a href="#l37.899"></a><span id="l37.899" class="difflineminus">-    if (this._account.disconnecting) {</span>
<a href="#l37.900"></a><span id="l37.900" class="difflineminus">-      // The server closed the connection before we handled the ERROR</span>
<a href="#l37.901"></a><span id="l37.901" class="difflineminus">-      // response to QUIT.</span>
<a href="#l37.902"></a><span id="l37.902" class="difflineminus">-      this.LOG(msg);</span>
<a href="#l37.903"></a><span id="l37.903" class="difflineminus">-      this._account.gotDisconnected();</span>
<a href="#l37.904"></a><span id="l37.904" class="difflineminus">-    } else {</span>
<a href="#l37.905"></a><span id="l37.905" class="difflineminus">-      this.WARN(msg);</span>
<a href="#l37.906"></a><span id="l37.906" class="difflineminus">-      this._account.gotDisconnected(</span>
<a href="#l37.907"></a><span id="l37.907" class="difflineminus">-        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l37.908"></a><span id="l37.908" class="difflineminus">-        _(&quot;connection.error.lost&quot;)</span>
<a href="#l37.909"></a><span id="l37.909" class="difflineminus">-      );</span>
<a href="#l37.910"></a><span id="l37.910" class="difflineminus">-    }</span>
<a href="#l37.911"></a><span id="l37.911" class="difflineminus">-  },</span>
<a href="#l37.912"></a><span id="l37.912" class="difflineminus">-  onConnectionReset() {</span>
<a href="#l37.913"></a><span id="l37.913" class="difflineminus">-    this.WARN(&quot;Connection reset.&quot;);</span>
<a href="#l37.914"></a><span id="l37.914" class="difflineminus">-    this._account.gotDisconnected(</span>
<a href="#l37.915"></a><span id="l37.915" class="difflineminus">-      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l37.916"></a><span id="l37.916" class="difflineminus">-      _(&quot;connection.error.lost&quot;)</span>
<a href="#l37.917"></a><span id="l37.917" class="difflineminus">-    );</span>
<a href="#l37.918"></a><span id="l37.918" class="difflineminus">-  },</span>
<a href="#l37.919"></a><span id="l37.919" class="difflineminus">-  onConnectionTimedOut() {</span>
<a href="#l37.920"></a><span id="l37.920" class="difflineminus">-    this.WARN(&quot;Connection timed out.&quot;);</span>
<a href="#l37.921"></a><span id="l37.921" class="difflineminus">-    this._account.gotDisconnected(</span>
<a href="#l37.922"></a><span id="l37.922" class="difflineminus">-      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l37.923"></a><span id="l37.923" class="difflineminus">-      _(&quot;connection.error.timeOut&quot;)</span>
<a href="#l37.924"></a><span id="l37.924" class="difflineminus">-    );</span>
<a href="#l37.925"></a><span id="l37.925" class="difflineminus">-  },</span>
<a href="#l37.926"></a><span id="l37.926" class="difflineminus">-  onBadCertificate(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l37.927"></a><span id="l37.927" class="difflineminus">-    this.WARN(</span>
<a href="#l37.928"></a><span id="l37.928" class="difflineminus">-      &quot;Bad certificate or SSL connection for &quot; +</span>
<a href="#l37.929"></a><span id="l37.929" class="difflineminus">-        this._account.name +</span>
<a href="#l37.930"></a><span id="l37.930" class="difflineminus">-        &quot;:\n&quot; +</span>
<a href="#l37.931"></a><span id="l37.931" class="difflineminus">-        aNSSErrorMessage</span>
<a href="#l37.932"></a><span id="l37.932" class="difflineminus">-    );</span>
<a href="#l37.933"></a><span id="l37.933" class="difflineminus">-    let error = this._account.handleBadCertificate(this, aIsSslError);</span>
<a href="#l37.934"></a><span id="l37.934" class="difflineminus">-    this._account.gotDisconnected(error, aNSSErrorMessage);</span>
<a href="#l37.935"></a><span id="l37.935" class="difflineminus">-  },</span>
<a href="#l37.936"></a><span id="l37.936" class="difflineminus">-</span>
<a href="#l37.937"></a><span id="l37.937" class="difflineminus">-  get DEBUG() {</span>
<a href="#l37.938"></a><span id="l37.938" class="difflineminus">-    return this._account.DEBUG;</span>
<a href="#l37.939"></a><span id="l37.939" class="difflineminus">-  },</span>
<a href="#l37.940"></a><span id="l37.940" class="difflineminus">-  get LOG() {</span>
<a href="#l37.941"></a><span id="l37.941" class="difflineminus">-    return this._account.LOG;</span>
<a href="#l37.942"></a><span id="l37.942" class="difflineminus">-  },</span>
<a href="#l37.943"></a><span id="l37.943" class="difflineminus">-  get WARN() {</span>
<a href="#l37.944"></a><span id="l37.944" class="difflineminus">-    return this._account.WARN;</span>
<a href="#l37.945"></a><span id="l37.945" class="difflineminus">-  },</span>
<a href="#l37.946"></a><span id="l37.946" class="difflineminus">-  get ERROR() {</span>
<a href="#l37.947"></a><span id="l37.947" class="difflineminus">-    return this._account.ERROR;</span>
<a href="#l37.948"></a><span id="l37.948" class="difflineminus">-  },</span>
<a href="#l37.949"></a><span id="l37.949" class="difflineminus">-};</span>
<a href="#l37.950"></a><span id="l37.950" class="difflineminus">-</span>
<a href="#l37.951"></a><span id="l37.951" class="difflineminus">-function IRCAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l37.952"></a><span id="l37.952" class="difflineminus">-  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l37.953"></a><span id="l37.953" class="difflineminus">-}</span>
<a href="#l37.954"></a><span id="l37.954" class="difflineminus">-IRCAccountBuddy.prototype = {</span>
<a href="#l37.955"></a><span id="l37.955" class="difflineminus">-  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l37.956"></a><span id="l37.956" class="difflineminus">-</span>
<a href="#l37.957"></a><span id="l37.957" class="difflineminus">-  // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l37.958"></a><span id="l37.958" class="difflineminus">-  // hovers over the buddy.</span>
<a href="#l37.959"></a><span id="l37.959" class="difflineminus">-  getTooltipInfo() {</span>
<a href="#l37.960"></a><span id="l37.960" class="difflineminus">-    return this._account.getBuddyInfo(this.normalizedName);</span>
<a href="#l37.961"></a><span id="l37.961" class="difflineminus">-  },</span>
<a href="#l37.962"></a><span id="l37.962" class="difflineminus">-</span>
<a href="#l37.963"></a><span id="l37.963" class="difflineminus">-  // Allow sending of messages to buddies even if they are not online since IRC</span>
<a href="#l37.964"></a><span id="l37.964" class="difflineminus">-  // does not always provide status information in a timely fashion. (Note that</span>
<a href="#l37.965"></a><span id="l37.965" class="difflineminus">-  // this is OK since the server will throw an error if the user is not online.)</span>
<a href="#l37.966"></a><span id="l37.966" class="difflineminus">-  get canSendMessage() {</span>
<a href="#l37.967"></a><span id="l37.967" class="difflineminus">-    return this.account.connected;</span>
<a href="#l37.968"></a><span id="l37.968" class="difflineminus">-  },</span>
<a href="#l37.969"></a><span id="l37.969" class="difflineminus">-</span>
<a href="#l37.970"></a><span id="l37.970" class="difflineminus">-  // Called when the user wants to chat with the buddy.</span>
<a href="#l37.971"></a><span id="l37.971" class="difflineminus">-  createConversation() {</span>
<a href="#l37.972"></a><span id="l37.972" class="difflineminus">-    return this._account.createConversation(this.userName);</span>
<a href="#l37.973"></a><span id="l37.973" class="difflineminus">-  },</span>
<a href="#l37.974"></a><span id="l37.974" class="difflineminus">-</span>
<a href="#l37.975"></a><span id="l37.975" class="difflineminus">-  remove() {</span>
<a href="#l37.976"></a><span id="l37.976" class="difflineminus">-    this._account.removeBuddy(this);</span>
<a href="#l37.977"></a><span id="l37.977" class="difflineminus">-    GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l37.978"></a><span id="l37.978" class="difflineminus">-  },</span>
<a href="#l37.979"></a><span id="l37.979" class="difflineminus">-};</span>
<a href="#l37.980"></a><span id="l37.980" class="difflineminus">-</span>
<a href="#l37.981"></a><span id="l37.981" class="difflineminus">-function ircRoomInfo(aName, aAccount) {</span>
<a href="#l37.982"></a><span id="l37.982" class="difflineminus">-  this.name = aName;</span>
<a href="#l37.983"></a><span id="l37.983" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l37.984"></a><span id="l37.984" class="difflineminus">-}</span>
<a href="#l37.985"></a><span id="l37.985" class="difflineminus">-ircRoomInfo.prototype = {</span>
<a href="#l37.986"></a><span id="l37.986" class="difflineminus">-  __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;IRC RoomInfo Object&quot;),</span>
<a href="#l37.987"></a><span id="l37.987" class="difflineminus">-  get topic() {</span>
<a href="#l37.988"></a><span id="l37.988" class="difflineminus">-    return this._account._channelList.get(this.name).topic;</span>
<a href="#l37.989"></a><span id="l37.989" class="difflineminus">-  },</span>
<a href="#l37.990"></a><span id="l37.990" class="difflineminus">-  get participantCount() {</span>
<a href="#l37.991"></a><span id="l37.991" class="difflineminus">-    return this._account._channelList.get(this.name).participantCount;</span>
<a href="#l37.992"></a><span id="l37.992" class="difflineminus">-  },</span>
<a href="#l37.993"></a><span id="l37.993" class="difflineminus">-  get chatRoomFieldValues() {</span>
<a href="#l37.994"></a><span id="l37.994" class="difflineminus">-    return this._account.getChatRoomDefaultFieldValues(this.name);</span>
<a href="#l37.995"></a><span id="l37.995" class="difflineminus">-  },</span>
<a href="#l37.996"></a><span id="l37.996" class="difflineminus">-};</span>
<a href="#l37.997"></a><span id="l37.997" class="difflineminus">-</span>
<a href="#l37.998"></a><span id="l37.998" class="difflineminus">-function IRCAccount(aProtocol, aImAccount) {</span>
<a href="#l37.999"></a><span id="l37.999" class="difflineminus">-  this._init(aProtocol, aImAccount);</span>
<a href="#l37.1000"></a><span id="l37.1000" class="difflineminus">-  this.buddies = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l37.1001"></a><span id="l37.1001" class="difflineminus">-  this.conversations = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l37.1002"></a><span id="l37.1002" class="difflineminus">-</span>
<a href="#l37.1003"></a><span id="l37.1003" class="difflineminus">-  // Split the account name into usable parts.</span>
<a href="#l37.1004"></a><span id="l37.1004" class="difflineminus">-  let splitter = this.name.lastIndexOf(&quot;@&quot;);</span>
<a href="#l37.1005"></a><span id="l37.1005" class="difflineminus">-  this._accountNickname = this.name.slice(0, splitter);</span>
<a href="#l37.1006"></a><span id="l37.1006" class="difflineminus">-  this._server = this.name.slice(splitter + 1);</span>
<a href="#l37.1007"></a><span id="l37.1007" class="difflineminus">-  // To avoid _currentServerName being null, initialize it to the server being</span>
<a href="#l37.1008"></a><span id="l37.1008" class="difflineminus">-  // connected to. This will also get overridden during the 001 response from</span>
<a href="#l37.1009"></a><span id="l37.1009" class="difflineminus">-  // the server.</span>
<a href="#l37.1010"></a><span id="l37.1010" class="difflineminus">-  this._currentServerName = this._server;</span>
<a href="#l37.1011"></a><span id="l37.1011" class="difflineminus">-</span>
<a href="#l37.1012"></a><span id="l37.1012" class="difflineminus">-  this._nickname = this._accountNickname;</span>
<a href="#l37.1013"></a><span id="l37.1013" class="difflineminus">-  this._requestedNickname = this._nickname;</span>
<a href="#l37.1014"></a><span id="l37.1014" class="difflineminus">-</span>
<a href="#l37.1015"></a><span id="l37.1015" class="difflineminus">-  // For more information, see where these are defined in the prototype below.</span>
<a href="#l37.1016"></a><span id="l37.1016" class="difflineminus">-  this.trackQueue = [];</span>
<a href="#l37.1017"></a><span id="l37.1017" class="difflineminus">-  this.pendingIsOnQueue = [];</span>
<a href="#l37.1018"></a><span id="l37.1018" class="difflineminus">-  this.whoisInformation = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l37.1019"></a><span id="l37.1019" class="difflineminus">-  this._requestedCAPs = new Set();</span>
<a href="#l37.1020"></a><span id="l37.1020" class="difflineminus">-  this._availableCAPs = new Set();</span>
<a href="#l37.1021"></a><span id="l37.1021" class="difflineminus">-  this._activeCAPs = new Set();</span>
<a href="#l37.1022"></a><span id="l37.1022" class="difflineminus">-  this._queuedCAPs = [];</span>
<a href="#l37.1023"></a><span id="l37.1023" class="difflineminus">-  this._commandBuffers = new Map();</span>
<a href="#l37.1024"></a><span id="l37.1024" class="difflineminus">-  this._roomInfoCallbacks = new Set();</span>
<a href="#l37.1025"></a><span id="l37.1025" class="difflineminus">-}</span>
<a href="#l37.1026"></a><span id="l37.1026" class="difflineminus">-IRCAccount.prototype = {</span>
<a href="#l37.1027"></a><span id="l37.1027" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l37.1028"></a><span id="l37.1028" class="difflineminus">-  _socket: null,</span>
<a href="#l37.1029"></a><span id="l37.1029" class="difflineminus">-  _MODE_WALLOPS: 1 &lt;&lt; 2, // mode 'w'</span>
<a href="#l37.1030"></a><span id="l37.1030" class="difflineminus">-  _MODE_INVISIBLE: 1 &lt;&lt; 3, // mode 'i'</span>
<a href="#l37.1031"></a><span id="l37.1031" class="difflineminus">-  get _mode() {</span>
<a href="#l37.1032"></a><span id="l37.1032" class="difflineminus">-    return 0;</span>
<a href="#l37.1033"></a><span id="l37.1033" class="difflineminus">-  },</span>
<a href="#l37.1034"></a><span id="l37.1034" class="difflineminus">-</span>
<a href="#l37.1035"></a><span id="l37.1035" class="difflineminus">-  // The name of the server we last connected to.</span>
<a href="#l37.1036"></a><span id="l37.1036" class="difflineminus">-  _currentServerName: null,</span>
<a href="#l37.1037"></a><span id="l37.1037" class="difflineminus">-  // Whether to attempt authenticating with NickServ.</span>
<a href="#l37.1038"></a><span id="l37.1038" class="difflineminus">-  shouldAuthenticate: true,</span>
<a href="#l37.1039"></a><span id="l37.1039" class="difflineminus">-  // Whether the user has successfully authenticated with NickServ.</span>
<a href="#l37.1040"></a><span id="l37.1040" class="difflineminus">-  isAuthenticated: false,</span>
<a href="#l37.1041"></a><span id="l37.1041" class="difflineminus">-  // The current in use nickname.</span>
<a href="#l37.1042"></a><span id="l37.1042" class="difflineminus">-  _nickname: null,</span>
<a href="#l37.1043"></a><span id="l37.1043" class="difflineminus">-  // The nickname stored in the account name.</span>
<a href="#l37.1044"></a><span id="l37.1044" class="difflineminus">-  _accountNickname: null,</span>
<a href="#l37.1045"></a><span id="l37.1045" class="difflineminus">-  // The nickname that was last requested by the user.</span>
<a href="#l37.1046"></a><span id="l37.1046" class="difflineminus">-  _requestedNickname: null,</span>
<a href="#l37.1047"></a><span id="l37.1047" class="difflineminus">-  // The nickname that was last requested. This can differ from</span>
<a href="#l37.1048"></a><span id="l37.1048" class="difflineminus">-  // _requestedNickname when a new nick is automatically generated (e.g. by</span>
<a href="#l37.1049"></a><span id="l37.1049" class="difflineminus">-  // adding digits).</span>
<a href="#l37.1050"></a><span id="l37.1050" class="difflineminus">-  _sentNickname: null,</span>
<a href="#l37.1051"></a><span id="l37.1051" class="difflineminus">-  // If we don't get the desired nick on connect, we try again a bit later,</span>
<a href="#l37.1052"></a><span id="l37.1052" class="difflineminus">-  // to see if it wasn't just our nick not having timed out yet.</span>
<a href="#l37.1053"></a><span id="l37.1053" class="difflineminus">-  _nickInUseTimeout: null,</span>
<a href="#l37.1054"></a><span id="l37.1054" class="difflineminus">-  get username() {</span>
<a href="#l37.1055"></a><span id="l37.1055" class="difflineminus">-    let username;</span>
<a href="#l37.1056"></a><span id="l37.1056" class="difflineminus">-    // Use a custom username in a hidden preference.</span>
<a href="#l37.1057"></a><span id="l37.1057" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;username&quot;)) {</span>
<a href="#l37.1058"></a><span id="l37.1058" class="difflineminus">-      username = this.getString(&quot;username&quot;);</span>
<a href="#l37.1059"></a><span id="l37.1059" class="difflineminus">-    }</span>
<a href="#l37.1060"></a><span id="l37.1060" class="difflineminus">-    // But fallback to brandShortName if no username is provided (or is empty).</span>
<a href="#l37.1061"></a><span id="l37.1061" class="difflineminus">-    if (!username) {</span>
<a href="#l37.1062"></a><span id="l37.1062" class="difflineminus">-      username = Services.appinfo.name;</span>
<a href="#l37.1063"></a><span id="l37.1063" class="difflineminus">-    }</span>
<a href="#l37.1064"></a><span id="l37.1064" class="difflineminus">-</span>
<a href="#l37.1065"></a><span id="l37.1065" class="difflineminus">-    return username;</span>
<a href="#l37.1066"></a><span id="l37.1066" class="difflineminus">-  },</span>
<a href="#l37.1067"></a><span id="l37.1067" class="difflineminus">-  // The prefix minus the nick (!user@host) as returned by the server, this is</span>
<a href="#l37.1068"></a><span id="l37.1068" class="difflineminus">-  // necessary for guessing message lengths.</span>
<a href="#l37.1069"></a><span id="l37.1069" class="difflineminus">-  prefix: null,</span>
<a href="#l37.1070"></a><span id="l37.1070" class="difflineminus">-</span>
<a href="#l37.1071"></a><span id="l37.1071" class="difflineminus">-  // Parts of the specification give max lengths, keep track of them since a</span>
<a href="#l37.1072"></a><span id="l37.1072" class="difflineminus">-  // server can overwrite them. The defaults given here are from RFC 2812.</span>
<a href="#l37.1073"></a><span id="l37.1073" class="difflineminus">-  maxNicknameLength: 9, // 1.2.1 Users</span>
<a href="#l37.1074"></a><span id="l37.1074" class="difflineminus">-  maxChannelLength: 50, // 1.3 Channels</span>
<a href="#l37.1075"></a><span id="l37.1075" class="difflineminus">-  maxMessageLength: 512, // 2.3 Messages</span>
<a href="#l37.1076"></a><span id="l37.1076" class="difflineminus">-  maxHostnameLength: 63, // 2.3.1 Message format in Augmented BNF</span>
<a href="#l37.1077"></a><span id="l37.1077" class="difflineminus">-</span>
<a href="#l37.1078"></a><span id="l37.1078" class="difflineminus">-  // The default prefixes to modes.</span>
<a href="#l37.1079"></a><span id="l37.1079" class="difflineminus">-  userPrefixToModeMap: { &quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot; },</span>
<a href="#l37.1080"></a><span id="l37.1080" class="difflineminus">-  get userPrefixes() {</span>
<a href="#l37.1081"></a><span id="l37.1081" class="difflineminus">-    return Object.keys(this.userPrefixToModeMap);</span>
<a href="#l37.1082"></a><span id="l37.1082" class="difflineminus">-  },</span>
<a href="#l37.1083"></a><span id="l37.1083" class="difflineminus">-  // Modes that have a nickname parameter and affect a participant. See 4.1</span>
<a href="#l37.1084"></a><span id="l37.1084" class="difflineminus">-  // Member Status of RFC 2811.</span>
<a href="#l37.1085"></a><span id="l37.1085" class="difflineminus">-  memberStatuses: [&quot;a&quot;, &quot;h&quot;, &quot;o&quot;, &quot;O&quot;, &quot;q&quot;, &quot;v&quot;, &quot;!&quot;],</span>
<a href="#l37.1086"></a><span id="l37.1086" class="difflineminus">-  channelPrefixes: [&quot;&amp;&quot;, &quot;#&quot;, &quot;+&quot;, &quot;!&quot;], // 1.3 Channels</span>
<a href="#l37.1087"></a><span id="l37.1087" class="difflineminus">-  channelRestrictionToModeMap: { &quot;@&quot;: &quot;s&quot;, &quot;*&quot;: &quot;p&quot;, &quot;=&quot;: null }, // 353 RPL_NAMREPLY</span>
<a href="#l37.1088"></a><span id="l37.1088" class="difflineminus">-</span>
<a href="#l37.1089"></a><span id="l37.1089" class="difflineminus">-  // Handle Scandanavian lower case (optionally remove status indicators).</span>
<a href="#l37.1090"></a><span id="l37.1090" class="difflineminus">-  // See Section 2.2 of RFC 2812: the characters {}|^ are considered to be the</span>
<a href="#l37.1091"></a><span id="l37.1091" class="difflineminus">-  // lower case equivalents of the characters []\~, respectively.</span>
<a href="#l37.1092"></a><span id="l37.1092" class="difflineminus">-  normalizeExpression: /[\x41-\x5E]/g,</span>
<a href="#l37.1093"></a><span id="l37.1093" class="difflineminus">-  normalize(aStr, aPrefixes) {</span>
<a href="#l37.1094"></a><span id="l37.1094" class="difflineminus">-    let str = aStr;</span>
<a href="#l37.1095"></a><span id="l37.1095" class="difflineminus">-</span>
<a href="#l37.1096"></a><span id="l37.1096" class="difflineminus">-    if (aPrefixes) {</span>
<a href="#l37.1097"></a><span id="l37.1097" class="difflineminus">-      while (aPrefixes.includes(str[0])) {</span>
<a href="#l37.1098"></a><span id="l37.1098" class="difflineminus">-        str = str.slice(1);</span>
<a href="#l37.1099"></a><span id="l37.1099" class="difflineminus">-      }</span>
<a href="#l37.1100"></a><span id="l37.1100" class="difflineminus">-    }</span>
<a href="#l37.1101"></a><span id="l37.1101" class="difflineminus">-</span>
<a href="#l37.1102"></a><span id="l37.1102" class="difflineminus">-    return str.replace(this.normalizeExpression, c =&gt;</span>
<a href="#l37.1103"></a><span id="l37.1103" class="difflineminus">-      String.fromCharCode(c.charCodeAt(0) + 0x20)</span>
<a href="#l37.1104"></a><span id="l37.1104" class="difflineminus">-    );</span>
<a href="#l37.1105"></a><span id="l37.1105" class="difflineminus">-  },</span>
<a href="#l37.1106"></a><span id="l37.1106" class="difflineminus">-  normalizeNick(aNick) {</span>
<a href="#l37.1107"></a><span id="l37.1107" class="difflineminus">-    return this.normalize(aNick, this.userPrefixes);</span>
<a href="#l37.1108"></a><span id="l37.1108" class="difflineminus">-  },</span>
<a href="#l37.1109"></a><span id="l37.1109" class="difflineminus">-</span>
<a href="#l37.1110"></a><span id="l37.1110" class="difflineminus">-  isMUCName(aStr) {</span>
<a href="#l37.1111"></a><span id="l37.1111" class="difflineminus">-    return this.channelPrefixes.includes(aStr[0]);</span>
<a href="#l37.1112"></a><span id="l37.1112" class="difflineminus">-  },</span>
<a href="#l37.1113"></a><span id="l37.1113" class="difflineminus">-</span>
<a href="#l37.1114"></a><span id="l37.1114" class="difflineminus">-  // Tell the server about status changes. IRC is only away or not away;</span>
<a href="#l37.1115"></a><span id="l37.1115" class="difflineminus">-  // consider the away, idle and unavailable status type to be away.</span>
<a href="#l37.1116"></a><span id="l37.1116" class="difflineminus">-  isAway: false,</span>
<a href="#l37.1117"></a><span id="l37.1117" class="difflineminus">-  observe(aSubject, aTopic, aData) {</span>
<a href="#l37.1118"></a><span id="l37.1118" class="difflineminus">-    if (aTopic != &quot;status-changed&quot;) {</span>
<a href="#l37.1119"></a><span id="l37.1119" class="difflineminus">-      return;</span>
<a href="#l37.1120"></a><span id="l37.1120" class="difflineminus">-    }</span>
<a href="#l37.1121"></a><span id="l37.1121" class="difflineminus">-</span>
<a href="#l37.1122"></a><span id="l37.1122" class="difflineminus">-    let { statusType: type, statusText: text } = this.imAccount.statusInfo;</span>
<a href="#l37.1123"></a><span id="l37.1123" class="difflineminus">-    this.DEBUG(&quot;New status received:\ntype = &quot; + type + &quot;\ntext = &quot; + text);</span>
<a href="#l37.1124"></a><span id="l37.1124" class="difflineminus">-</span>
<a href="#l37.1125"></a><span id="l37.1125" class="difflineminus">-    // Tell the server to mark us as away.</span>
<a href="#l37.1126"></a><span id="l37.1126" class="difflineminus">-    if (type &lt; Ci.imIStatusInfo.STATUS_AVAILABLE) {</span>
<a href="#l37.1127"></a><span id="l37.1127" class="difflineminus">-      // We have to have a string in order to set IRC as AWAY.</span>
<a href="#l37.1128"></a><span id="l37.1128" class="difflineminus">-      if (!text) {</span>
<a href="#l37.1129"></a><span id="l37.1129" class="difflineminus">-        // If no status is given, use the the default idle/away message.</span>
<a href="#l37.1130"></a><span id="l37.1130" class="difflineminus">-        const IDLE_PREF_BRANCH = &quot;messenger.status.&quot;;</span>
<a href="#l37.1131"></a><span id="l37.1131" class="difflineminus">-        const IDLE_PREF = &quot;defaultIdleAwayMessage&quot;;</span>
<a href="#l37.1132"></a><span id="l37.1132" class="difflineminus">-        text = Services.prefs.getComplexValue(</span>
<a href="#l37.1133"></a><span id="l37.1133" class="difflineminus">-          IDLE_PREF_BRANCH + IDLE_PREF,</span>
<a href="#l37.1134"></a><span id="l37.1134" class="difflineminus">-          Ci.nsIPrefLocalizedString</span>
<a href="#l37.1135"></a><span id="l37.1135" class="difflineminus">-        ).data;</span>
<a href="#l37.1136"></a><span id="l37.1136" class="difflineminus">-</span>
<a href="#l37.1137"></a><span id="l37.1137" class="difflineminus">-        if (!text) {</span>
<a href="#l37.1138"></a><span id="l37.1138" class="difflineminus">-          // Get the default value of the localized preference.</span>
<a href="#l37.1139"></a><span id="l37.1139" class="difflineminus">-          text = Services.prefs</span>
<a href="#l37.1140"></a><span id="l37.1140" class="difflineminus">-            .getDefaultBranch(IDLE_PREF_BRANCH)</span>
<a href="#l37.1141"></a><span id="l37.1141" class="difflineminus">-            .getComplexValue(IDLE_PREF, Ci.nsIPrefLocalizedString).data;</span>
<a href="#l37.1142"></a><span id="l37.1142" class="difflineminus">-        }</span>
<a href="#l37.1143"></a><span id="l37.1143" class="difflineminus">-        // The last resort, fallback to a non-localized string.</span>
<a href="#l37.1144"></a><span id="l37.1144" class="difflineminus">-        if (!text) {</span>
<a href="#l37.1145"></a><span id="l37.1145" class="difflineminus">-          text = &quot;Away&quot;;</span>
<a href="#l37.1146"></a><span id="l37.1146" class="difflineminus">-        }</span>
<a href="#l37.1147"></a><span id="l37.1147" class="difflineminus">-      }</span>
<a href="#l37.1148"></a><span id="l37.1148" class="difflineminus">-      this.sendMessage(&quot;AWAY&quot;, text); // Mark as away.</span>
<a href="#l37.1149"></a><span id="l37.1149" class="difflineminus">-    } else if (type == Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; this.isAway) {</span>
<a href="#l37.1150"></a><span id="l37.1150" class="difflineminus">-      // Mark as back.</span>
<a href="#l37.1151"></a><span id="l37.1151" class="difflineminus">-      this.sendMessage(&quot;AWAY&quot;);</span>
<a href="#l37.1152"></a><span id="l37.1152" class="difflineminus">-    }</span>
<a href="#l37.1153"></a><span id="l37.1153" class="difflineminus">-  },</span>
<a href="#l37.1154"></a><span id="l37.1154" class="difflineminus">-</span>
<a href="#l37.1155"></a><span id="l37.1155" class="difflineminus">-  // The user's user mode.</span>
<a href="#l37.1156"></a><span id="l37.1156" class="difflineminus">-  _modes: null,</span>
<a href="#l37.1157"></a><span id="l37.1157" class="difflineminus">-  _userModeReceived: false,</span>
<a href="#l37.1158"></a><span id="l37.1158" class="difflineminus">-  setUserMode(aNick, aNewModes, aSetter, aDisplayFullMode) {</span>
<a href="#l37.1159"></a><span id="l37.1159" class="difflineminus">-    if (this.normalizeNick(aNick) != this.normalizeNick(this._nickname)) {</span>
<a href="#l37.1160"></a><span id="l37.1160" class="difflineminus">-      this.WARN(&quot;Received unexpected mode for &quot; + aNick);</span>
<a href="#l37.1161"></a><span id="l37.1161" class="difflineminus">-      return false;</span>
<a href="#l37.1162"></a><span id="l37.1162" class="difflineminus">-    }</span>
<a href="#l37.1163"></a><span id="l37.1163" class="difflineminus">-</span>
<a href="#l37.1164"></a><span id="l37.1164" class="difflineminus">-    // Are modes being added or removed?</span>
<a href="#l37.1165"></a><span id="l37.1165" class="difflineminus">-    let addNewMode = aNewModes[0] == &quot;+&quot;;</span>
<a href="#l37.1166"></a><span id="l37.1166" class="difflineminus">-    if (!addNewMode &amp;&amp; aNewModes[0] != &quot;-&quot;) {</span>
<a href="#l37.1167"></a><span id="l37.1167" class="difflineminus">-      this.WARN(&quot;Invalid mode string: &quot; + aNewModes);</span>
<a href="#l37.1168"></a><span id="l37.1168" class="difflineminus">-      return false;</span>
<a href="#l37.1169"></a><span id="l37.1169" class="difflineminus">-    }</span>
<a href="#l37.1170"></a><span id="l37.1170" class="difflineminus">-    _setMode.call(this, addNewMode, aNewModes.slice(1));</span>
<a href="#l37.1171"></a><span id="l37.1171" class="difflineminus">-</span>
<a href="#l37.1172"></a><span id="l37.1172" class="difflineminus">-    // The server informs us of the user's mode when connecting.</span>
<a href="#l37.1173"></a><span id="l37.1173" class="difflineminus">-    // We should not report this initial mode message as a mode change</span>
<a href="#l37.1174"></a><span id="l37.1174" class="difflineminus">-    // initiated by the user, but instead display the full mode</span>
<a href="#l37.1175"></a><span id="l37.1175" class="difflineminus">-    // and then remember we have done so.</span>
<a href="#l37.1176"></a><span id="l37.1176" class="difflineminus">-    this._userModeReceived = true;</span>
<a href="#l37.1177"></a><span id="l37.1177" class="difflineminus">-</span>
<a href="#l37.1178"></a><span id="l37.1178" class="difflineminus">-    if (this._showServerTab) {</span>
<a href="#l37.1179"></a><span id="l37.1179" class="difflineminus">-      let msg;</span>
<a href="#l37.1180"></a><span id="l37.1180" class="difflineminus">-      if (aDisplayFullMode) {</span>
<a href="#l37.1181"></a><span id="l37.1181" class="difflineminus">-        msg = _(&quot;message.yourmode&quot;, Array.from(this._modes).join(&quot;&quot;));</span>
<a href="#l37.1182"></a><span id="l37.1182" class="difflineminus">-      } else {</span>
<a href="#l37.1183"></a><span id="l37.1183" class="difflineminus">-        msg = _(</span>
<a href="#l37.1184"></a><span id="l37.1184" class="difflineminus">-          &quot;message.usermode&quot;,</span>
<a href="#l37.1185"></a><span id="l37.1185" class="difflineminus">-          aNewModes,</span>
<a href="#l37.1186"></a><span id="l37.1186" class="difflineminus">-          aNick,</span>
<a href="#l37.1187"></a><span id="l37.1187" class="difflineminus">-          aSetter || this._currentServerName</span>
<a href="#l37.1188"></a><span id="l37.1188" class="difflineminus">-        );</span>
<a href="#l37.1189"></a><span id="l37.1189" class="difflineminus">-      }</span>
<a href="#l37.1190"></a><span id="l37.1190" class="difflineminus">-      this.getConversation(this._currentServerName).writeMessage(</span>
<a href="#l37.1191"></a><span id="l37.1191" class="difflineminus">-        this._currentServerName,</span>
<a href="#l37.1192"></a><span id="l37.1192" class="difflineminus">-        msg,</span>
<a href="#l37.1193"></a><span id="l37.1193" class="difflineminus">-        { system: true }</span>
<a href="#l37.1194"></a><span id="l37.1194" class="difflineminus">-      );</span>
<a href="#l37.1195"></a><span id="l37.1195" class="difflineminus">-    }</span>
<a href="#l37.1196"></a><span id="l37.1196" class="difflineminus">-    return true;</span>
<a href="#l37.1197"></a><span id="l37.1197" class="difflineminus">-  },</span>
<a href="#l37.1198"></a><span id="l37.1198" class="difflineminus">-</span>
<a href="#l37.1199"></a><span id="l37.1199" class="difflineminus">-  // Room info: maps channel names to {topic, participantCount}.</span>
<a href="#l37.1200"></a><span id="l37.1200" class="difflineminus">-  _channelList: new Map(),</span>
<a href="#l37.1201"></a><span id="l37.1201" class="difflineminus">-  _roomInfoCallbacks: new Set(),</span>
<a href="#l37.1202"></a><span id="l37.1202" class="difflineminus">-  // If true, we have sent the LIST request and are waiting for replies.</span>
<a href="#l37.1203"></a><span id="l37.1203" class="difflineminus">-  _pendingList: false,</span>
<a href="#l37.1204"></a><span id="l37.1204" class="difflineminus">-  // Callbacks receive this many channels per call while results are incoming.</span>
<a href="#l37.1205"></a><span id="l37.1205" class="difflineminus">-  _channelsPerBatch: 50,</span>
<a href="#l37.1206"></a><span id="l37.1206" class="difflineminus">-  _currentBatch: [],</span>
<a href="#l37.1207"></a><span id="l37.1207" class="difflineminus">-  _lastListTime: 0,</span>
<a href="#l37.1208"></a><span id="l37.1208" class="difflineminus">-  get isRoomInfoStale() {</span>
<a href="#l37.1209"></a><span id="l37.1209" class="difflineminus">-    return Date.now() - this._lastListTime &gt; kListRefreshInterval;</span>
<a href="#l37.1210"></a><span id="l37.1210" class="difflineminus">-  },</span>
<a href="#l37.1211"></a><span id="l37.1211" class="difflineminus">-  // Called by consumers that want a list of available channels, which are</span>
<a href="#l37.1212"></a><span id="l37.1212" class="difflineminus">-  // provided through the callback (prplIRoomInfoCallback instance).</span>
<a href="#l37.1213"></a><span id="l37.1213" class="difflineminus">-  requestRoomInfo(aCallback, aIsUserRequest) {</span>
<a href="#l37.1214"></a><span id="l37.1214" class="difflineminus">-    // Ignore the automaticList pref if the user explicitly requests /list.</span>
<a href="#l37.1215"></a><span id="l37.1215" class="difflineminus">-    if (</span>
<a href="#l37.1216"></a><span id="l37.1216" class="difflineminus">-      !aIsUserRequest &amp;&amp;</span>
<a href="#l37.1217"></a><span id="l37.1217" class="difflineminus">-      !Services.prefs.getBoolPref(&quot;chat.irc.automaticList&quot;)</span>
<a href="#l37.1218"></a><span id="l37.1218" class="difflineminus">-    ) {</span>
<a href="#l37.1219"></a><span id="l37.1219" class="difflineminus">-      // Pretend we can't return roomInfo.</span>
<a href="#l37.1220"></a><span id="l37.1220" class="difflineminus">-      throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l37.1221"></a><span id="l37.1221" class="difflineminus">-    }</span>
<a href="#l37.1222"></a><span id="l37.1222" class="difflineminus">-    if (this._roomInfoCallbacks.has(aCallback)) {</span>
<a href="#l37.1223"></a><span id="l37.1223" class="difflineminus">-      // Callback is not new.</span>
<a href="#l37.1224"></a><span id="l37.1224" class="difflineminus">-      return;</span>
<a href="#l37.1225"></a><span id="l37.1225" class="difflineminus">-    }</span>
<a href="#l37.1226"></a><span id="l37.1226" class="difflineminus">-    // Send a LIST request if the channel list is stale and a current request</span>
<a href="#l37.1227"></a><span id="l37.1227" class="difflineminus">-    // has not been sent.</span>
<a href="#l37.1228"></a><span id="l37.1228" class="difflineminus">-    if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l37.1229"></a><span id="l37.1229" class="difflineminus">-      this._channelList = new Map();</span>
<a href="#l37.1230"></a><span id="l37.1230" class="difflineminus">-      this._currentBatch = [];</span>
<a href="#l37.1231"></a><span id="l37.1231" class="difflineminus">-      this._pendingList = true;</span>
<a href="#l37.1232"></a><span id="l37.1232" class="difflineminus">-      this._lastListTime = Date.now();</span>
<a href="#l37.1233"></a><span id="l37.1233" class="difflineminus">-      this.sendMessage(&quot;LIST&quot;);</span>
<a href="#l37.1234"></a><span id="l37.1234" class="difflineminus">-    } else {</span>
<a href="#l37.1235"></a><span id="l37.1235" class="difflineminus">-      // Otherwise, pass channels that have already been received to the callback.</span>
<a href="#l37.1236"></a><span id="l37.1236" class="difflineminus">-      let rooms = [...this._channelList.keys()];</span>
<a href="#l37.1237"></a><span id="l37.1237" class="difflineminus">-      aCallback.onRoomInfoAvailable(rooms, !this._pendingList);</span>
<a href="#l37.1238"></a><span id="l37.1238" class="difflineminus">-    }</span>
<a href="#l37.1239"></a><span id="l37.1239" class="difflineminus">-</span>
<a href="#l37.1240"></a><span id="l37.1240" class="difflineminus">-    if (this._pendingList) {</span>
<a href="#l37.1241"></a><span id="l37.1241" class="difflineminus">-      this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l37.1242"></a><span id="l37.1242" class="difflineminus">-    }</span>
<a href="#l37.1243"></a><span id="l37.1243" class="difflineminus">-  },</span>
<a href="#l37.1244"></a><span id="l37.1244" class="difflineminus">-  // Pass room info for any remaining channels to callbacks and clean up.</span>
<a href="#l37.1245"></a><span id="l37.1245" class="difflineminus">-  _sendRemainingRoomInfo() {</span>
<a href="#l37.1246"></a><span id="l37.1246" class="difflineminus">-    if (this._currentBatch.length) {</span>
<a href="#l37.1247"></a><span id="l37.1247" class="difflineminus">-      for (let callback of this._roomInfoCallbacks) {</span>
<a href="#l37.1248"></a><span id="l37.1248" class="difflineminus">-        callback.onRoomInfoAvailable(this._currentBatch, true);</span>
<a href="#l37.1249"></a><span id="l37.1249" class="difflineminus">-      }</span>
<a href="#l37.1250"></a><span id="l37.1250" class="difflineminus">-    }</span>
<a href="#l37.1251"></a><span id="l37.1251" class="difflineminus">-    this._roomInfoCallbacks.clear();</span>
<a href="#l37.1252"></a><span id="l37.1252" class="difflineminus">-    delete this._pendingList;</span>
<a href="#l37.1253"></a><span id="l37.1253" class="difflineminus">-    delete this._currentBatch;</span>
<a href="#l37.1254"></a><span id="l37.1254" class="difflineminus">-  },</span>
<a href="#l37.1255"></a><span id="l37.1255" class="difflineminus">-  getRoomInfo(aName) {</span>
<a href="#l37.1256"></a><span id="l37.1256" class="difflineminus">-    return new ircRoomInfo(aName, this);</span>
<a href="#l37.1257"></a><span id="l37.1257" class="difflineminus">-  },</span>
<a href="#l37.1258"></a><span id="l37.1258" class="difflineminus">-</span>
<a href="#l37.1259"></a><span id="l37.1259" class="difflineminus">-  // The last time a buffered command was sent.</span>
<a href="#l37.1260"></a><span id="l37.1260" class="difflineminus">-  _lastCommandSendTime: 0,</span>
<a href="#l37.1261"></a><span id="l37.1261" class="difflineminus">-  // A map from command names to the parameter buffer for that command.</span>
<a href="#l37.1262"></a><span id="l37.1262" class="difflineminus">-  // This buffer is a map from first parameter to the corresponding (optional)</span>
<a href="#l37.1263"></a><span id="l37.1263" class="difflineminus">-  // second parameter, to ensure automatic deduplication.</span>
<a href="#l37.1264"></a><span id="l37.1264" class="difflineminus">-  _commandBuffers: new Map(),</span>
<a href="#l37.1265"></a><span id="l37.1265" class="difflineminus">-  _handleCommandBuffer(aCommand) {</span>
<a href="#l37.1266"></a><span id="l37.1266" class="difflineminus">-    let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l37.1267"></a><span id="l37.1267" class="difflineminus">-    if (!buffer || !buffer.size) {</span>
<a href="#l37.1268"></a><span id="l37.1268" class="difflineminus">-      return;</span>
<a href="#l37.1269"></a><span id="l37.1269" class="difflineminus">-    }</span>
<a href="#l37.1270"></a><span id="l37.1270" class="difflineminus">-    // This short delay should usually not affect commands triggered by</span>
<a href="#l37.1271"></a><span id="l37.1271" class="difflineminus">-    // user action, but helps gather commands together which are sent</span>
<a href="#l37.1272"></a><span id="l37.1272" class="difflineminus">-    // by the prpl on connection (e.g. WHOIS sent in response to incoming</span>
<a href="#l37.1273"></a><span id="l37.1273" class="difflineminus">-    // WATCH results).</span>
<a href="#l37.1274"></a><span id="l37.1274" class="difflineminus">-    const kInterval = 1000;</span>
<a href="#l37.1275"></a><span id="l37.1275" class="difflineminus">-    let delay = kInterval - (Date.now() - this._lastCommandSendTime);</span>
<a href="#l37.1276"></a><span id="l37.1276" class="difflineminus">-    if (delay &gt; 0) {</span>
<a href="#l37.1277"></a><span id="l37.1277" class="difflineminus">-      setTimeout(() =&gt; this._handleCommandBuffer(aCommand), delay);</span>
<a href="#l37.1278"></a><span id="l37.1278" class="difflineminus">-      return;</span>
<a href="#l37.1279"></a><span id="l37.1279" class="difflineminus">-    }</span>
<a href="#l37.1280"></a><span id="l37.1280" class="difflineminus">-    this._lastCommandSendTime = Date.now();</span>
<a href="#l37.1281"></a><span id="l37.1281" class="difflineminus">-</span>
<a href="#l37.1282"></a><span id="l37.1282" class="difflineminus">-    let getParams = aItems =&gt; {</span>
<a href="#l37.1283"></a><span id="l37.1283" class="difflineminus">-      // Taking the JOIN use case as an example, aItems is an array</span>
<a href="#l37.1284"></a><span id="l37.1284" class="difflineminus">-      // of [channel, key] pairs.</span>
<a href="#l37.1285"></a><span id="l37.1285" class="difflineminus">-      // To work around an inspircd bug (bug 1108596), we reorder</span>
<a href="#l37.1286"></a><span id="l37.1286" class="difflineminus">-      // the list so that entries with keys appear first.</span>
<a href="#l37.1287"></a><span id="l37.1287" class="difflineminus">-      let items = aItems.slice().sort(([c1, k1], [c2, k2]) =&gt; {</span>
<a href="#l37.1288"></a><span id="l37.1288" class="difflineminus">-        if (!k1 &amp;&amp; k2) {</span>
<a href="#l37.1289"></a><span id="l37.1289" class="difflineminus">-          return 1;</span>
<a href="#l37.1290"></a><span id="l37.1290" class="difflineminus">-        }</span>
<a href="#l37.1291"></a><span id="l37.1291" class="difflineminus">-        if (k1 &amp;&amp; !k2) {</span>
<a href="#l37.1292"></a><span id="l37.1292" class="difflineminus">-          return -1;</span>
<a href="#l37.1293"></a><span id="l37.1293" class="difflineminus">-        }</span>
<a href="#l37.1294"></a><span id="l37.1294" class="difflineminus">-        return 0;</span>
<a href="#l37.1295"></a><span id="l37.1295" class="difflineminus">-      });</span>
<a href="#l37.1296"></a><span id="l37.1296" class="difflineminus">-      // To send the command, we have to group all the channels and keys</span>
<a href="#l37.1297"></a><span id="l37.1297" class="difflineminus">-      // together, i.e. grab the columns of this matrix, and build the two</span>
<a href="#l37.1298"></a><span id="l37.1298" class="difflineminus">-      // parameters of the command from that.</span>
<a href="#l37.1299"></a><span id="l37.1299" class="difflineminus">-      let channels = items.map(([channel, key]) =&gt; channel);</span>
<a href="#l37.1300"></a><span id="l37.1300" class="difflineminus">-      let keys = items.map(([channel, key]) =&gt; key).filter(key =&gt; !!key);</span>
<a href="#l37.1301"></a><span id="l37.1301" class="difflineminus">-      let params = [channels.join(&quot;,&quot;)];</span>
<a href="#l37.1302"></a><span id="l37.1302" class="difflineminus">-      if (keys.length) {</span>
<a href="#l37.1303"></a><span id="l37.1303" class="difflineminus">-        params.push(keys.join(&quot;,&quot;));</span>
<a href="#l37.1304"></a><span id="l37.1304" class="difflineminus">-      }</span>
<a href="#l37.1305"></a><span id="l37.1305" class="difflineminus">-      return params;</span>
<a href="#l37.1306"></a><span id="l37.1306" class="difflineminus">-    };</span>
<a href="#l37.1307"></a><span id="l37.1307" class="difflineminus">-    let tooMany = aItems =&gt; {</span>
<a href="#l37.1308"></a><span id="l37.1308" class="difflineminus">-      let params = getParams(aItems);</span>
<a href="#l37.1309"></a><span id="l37.1309" class="difflineminus">-      let length = this.countBytes(this.buildMessage(aCommand, params)) + 2;</span>
<a href="#l37.1310"></a><span id="l37.1310" class="difflineminus">-      return this.maxMessageLength &lt; length;</span>
<a href="#l37.1311"></a><span id="l37.1311" class="difflineminus">-    };</span>
<a href="#l37.1312"></a><span id="l37.1312" class="difflineminus">-    let send = aItems =&gt; {</span>
<a href="#l37.1313"></a><span id="l37.1313" class="difflineminus">-      let params = getParams(aItems);</span>
<a href="#l37.1314"></a><span id="l37.1314" class="difflineminus">-      // Send the command, but don't log the keys.</span>
<a href="#l37.1315"></a><span id="l37.1315" class="difflineminus">-      this.sendMessage(</span>
<a href="#l37.1316"></a><span id="l37.1316" class="difflineminus">-        aCommand,</span>
<a href="#l37.1317"></a><span id="l37.1317" class="difflineminus">-        params,</span>
<a href="#l37.1318"></a><span id="l37.1318" class="difflineminus">-        aCommand +</span>
<a href="#l37.1319"></a><span id="l37.1319" class="difflineminus">-          &quot; &quot; +</span>
<a href="#l37.1320"></a><span id="l37.1320" class="difflineminus">-          params[0] +</span>
<a href="#l37.1321"></a><span id="l37.1321" class="difflineminus">-          (params.length &gt; 1 ? &quot; &lt;keys not logged&gt;&quot; : &quot;&quot;)</span>
<a href="#l37.1322"></a><span id="l37.1322" class="difflineminus">-      );</span>
<a href="#l37.1323"></a><span id="l37.1323" class="difflineminus">-    };</span>
<a href="#l37.1324"></a><span id="l37.1324" class="difflineminus">-</span>
<a href="#l37.1325"></a><span id="l37.1325" class="difflineminus">-    let items = [];</span>
<a href="#l37.1326"></a><span id="l37.1326" class="difflineminus">-    for (let item of buffer) {</span>
<a href="#l37.1327"></a><span id="l37.1327" class="difflineminus">-      items.push(item);</span>
<a href="#l37.1328"></a><span id="l37.1328" class="difflineminus">-      if (tooMany(items)) {</span>
<a href="#l37.1329"></a><span id="l37.1329" class="difflineminus">-        items.pop();</span>
<a href="#l37.1330"></a><span id="l37.1330" class="difflineminus">-        send(items);</span>
<a href="#l37.1331"></a><span id="l37.1331" class="difflineminus">-        items = [item];</span>
<a href="#l37.1332"></a><span id="l37.1332" class="difflineminus">-      }</span>
<a href="#l37.1333"></a><span id="l37.1333" class="difflineminus">-    }</span>
<a href="#l37.1334"></a><span id="l37.1334" class="difflineminus">-    send(items);</span>
<a href="#l37.1335"></a><span id="l37.1335" class="difflineminus">-    buffer.clear();</span>
<a href="#l37.1336"></a><span id="l37.1336" class="difflineminus">-  },</span>
<a href="#l37.1337"></a><span id="l37.1337" class="difflineminus">-  // For commands which allow an arbitrary number of parameters, we use a</span>
<a href="#l37.1338"></a><span id="l37.1338" class="difflineminus">-  // buffer to send as few commands as possible, by gathering the parameters.</span>
<a href="#l37.1339"></a><span id="l37.1339" class="difflineminus">-  // On servers which impose command penalties (e.g. inspircd) this helps</span>
<a href="#l37.1340"></a><span id="l37.1340" class="difflineminus">-  // avoid triggering fakelags by minimizing the command penalty.</span>
<a href="#l37.1341"></a><span id="l37.1341" class="difflineminus">-  // aParam is the first and aKey the optional second parameter of a command</span>
<a href="#l37.1342"></a><span id="l37.1342" class="difflineminus">-  // with the syntax &lt;param&gt; *(&quot;,&quot; &lt;param&gt;) [&lt;key&gt; *(&quot;,&quot; &lt;key&gt;)]</span>
<a href="#l37.1343"></a><span id="l37.1343" class="difflineminus">-  // While this code is mostly abstracted, it is currently assumed the second</span>
<a href="#l37.1344"></a><span id="l37.1344" class="difflineminus">-  // parameter is only used for JOIN.</span>
<a href="#l37.1345"></a><span id="l37.1345" class="difflineminus">-  sendBufferedCommand(aCommand, aParam, aKey = &quot;&quot;) {</span>
<a href="#l37.1346"></a><span id="l37.1346" class="difflineminus">-    if (!this._commandBuffers.has(aCommand)) {</span>
<a href="#l37.1347"></a><span id="l37.1347" class="difflineminus">-      this._commandBuffers.set(aCommand, new Map());</span>
<a href="#l37.1348"></a><span id="l37.1348" class="difflineminus">-    }</span>
<a href="#l37.1349"></a><span id="l37.1349" class="difflineminus">-    let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l37.1350"></a><span id="l37.1350" class="difflineminus">-    // If the buffer is empty, schedule sending the command, otherwise</span>
<a href="#l37.1351"></a><span id="l37.1351" class="difflineminus">-    // we just need to add the parameter to the buffer.</span>
<a href="#l37.1352"></a><span id="l37.1352" class="difflineminus">-    // We use executeSoon so as to not delay the sending of these</span>
<a href="#l37.1353"></a><span id="l37.1353" class="difflineminus">-    // commands when it is not necessary.</span>
<a href="#l37.1354"></a><span id="l37.1354" class="difflineminus">-    if (!buffer.size) {</span>
<a href="#l37.1355"></a><span id="l37.1355" class="difflineminus">-      executeSoon(() =&gt; this._handleCommandBuffer(aCommand));</span>
<a href="#l37.1356"></a><span id="l37.1356" class="difflineminus">-    }</span>
<a href="#l37.1357"></a><span id="l37.1357" class="difflineminus">-    buffer.set(aParam, aKey);</span>
<a href="#l37.1358"></a><span id="l37.1358" class="difflineminus">-  },</span>
<a href="#l37.1359"></a><span id="l37.1359" class="difflineminus">-</span>
<a href="#l37.1360"></a><span id="l37.1360" class="difflineminus">-  // The whois information: nicks are used as keys and refer to a map of field</span>
<a href="#l37.1361"></a><span id="l37.1361" class="difflineminus">-  // to value.</span>
<a href="#l37.1362"></a><span id="l37.1362" class="difflineminus">-  whoisInformation: null,</span>
<a href="#l37.1363"></a><span id="l37.1363" class="difflineminus">-  // Request WHOIS information on a buddy when the user requests more</span>
<a href="#l37.1364"></a><span id="l37.1364" class="difflineminus">-  // information. If we already have some WHOIS information stored for this</span>
<a href="#l37.1365"></a><span id="l37.1365" class="difflineminus">-  // nick, a notification with this (potentially out-of-date) information</span>
<a href="#l37.1366"></a><span id="l37.1366" class="difflineminus">-  // is sent out immediately. It is followed by another notification when</span>
<a href="#l37.1367"></a><span id="l37.1367" class="difflineminus">-  // the current WHOIS data is returned by the server.</span>
<a href="#l37.1368"></a><span id="l37.1368" class="difflineminus">-  // If you are only interested in the current WHOIS, requestCurrentWhois</span>
<a href="#l37.1369"></a><span id="l37.1369" class="difflineminus">-  // should be used instead.</span>
<a href="#l37.1370"></a><span id="l37.1370" class="difflineminus">-  requestBuddyInfo(aBuddyName) {</span>
<a href="#l37.1371"></a><span id="l37.1371" class="difflineminus">-    if (!this.connected) {</span>
<a href="#l37.1372"></a><span id="l37.1372" class="difflineminus">-      return;</span>
<a href="#l37.1373"></a><span id="l37.1373" class="difflineminus">-    }</span>
<a href="#l37.1374"></a><span id="l37.1374" class="difflineminus">-</span>
<a href="#l37.1375"></a><span id="l37.1375" class="difflineminus">-    // Return what we have stored immediately.</span>
<a href="#l37.1376"></a><span id="l37.1376" class="difflineminus">-    if (this.whoisInformation.has(aBuddyName)) {</span>
<a href="#l37.1377"></a><span id="l37.1377" class="difflineminus">-      this.notifyWhois(aBuddyName);</span>
<a href="#l37.1378"></a><span id="l37.1378" class="difflineminus">-    }</span>
<a href="#l37.1379"></a><span id="l37.1379" class="difflineminus">-</span>
<a href="#l37.1380"></a><span id="l37.1380" class="difflineminus">-    // Request the current whois and update.</span>
<a href="#l37.1381"></a><span id="l37.1381" class="difflineminus">-    this.requestCurrentWhois(aBuddyName);</span>
<a href="#l37.1382"></a><span id="l37.1382" class="difflineminus">-  },</span>
<a href="#l37.1383"></a><span id="l37.1383" class="difflineminus">-  // Request fresh WHOIS information on a nick.</span>
<a href="#l37.1384"></a><span id="l37.1384" class="difflineminus">-  requestCurrentWhois(aNick) {</span>
<a href="#l37.1385"></a><span id="l37.1385" class="difflineminus">-    if (!this.connected) {</span>
<a href="#l37.1386"></a><span id="l37.1386" class="difflineminus">-      return;</span>
<a href="#l37.1387"></a><span id="l37.1387" class="difflineminus">-    }</span>
<a href="#l37.1388"></a><span id="l37.1388" class="difflineminus">-</span>
<a href="#l37.1389"></a><span id="l37.1389" class="difflineminus">-    this.removeBuddyInfo(aNick);</span>
<a href="#l37.1390"></a><span id="l37.1390" class="difflineminus">-    this.sendBufferedCommand(&quot;WHOIS&quot;, aNick);</span>
<a href="#l37.1391"></a><span id="l37.1391" class="difflineminus">-  },</span>
<a href="#l37.1392"></a><span id="l37.1392" class="difflineminus">-  notifyWhois(aNick) {</span>
<a href="#l37.1393"></a><span id="l37.1393" class="difflineminus">-    Services.obs.notifyObservers(</span>
<a href="#l37.1394"></a><span id="l37.1394" class="difflineminus">-      this.getBuddyInfo(aNick),</span>
<a href="#l37.1395"></a><span id="l37.1395" class="difflineminus">-      &quot;user-info-received&quot;,</span>
<a href="#l37.1396"></a><span id="l37.1396" class="difflineminus">-      this.normalizeNick(aNick)</span>
<a href="#l37.1397"></a><span id="l37.1397" class="difflineminus">-    );</span>
<a href="#l37.1398"></a><span id="l37.1398" class="difflineminus">-  },</span>
<a href="#l37.1399"></a><span id="l37.1399" class="difflineminus">-  // Request WHOWAS information on a buddy when the user requests more</span>
<a href="#l37.1400"></a><span id="l37.1400" class="difflineminus">-  // information.</span>
<a href="#l37.1401"></a><span id="l37.1401" class="difflineminus">-  requestOfflineBuddyInfo(aBuddyName) {</span>
<a href="#l37.1402"></a><span id="l37.1402" class="difflineminus">-    this.removeBuddyInfo(aBuddyName);</span>
<a href="#l37.1403"></a><span id="l37.1403" class="difflineminus">-    this.sendMessage(&quot;WHOWAS&quot;, aBuddyName);</span>
<a href="#l37.1404"></a><span id="l37.1404" class="difflineminus">-  },</span>
<a href="#l37.1405"></a><span id="l37.1405" class="difflineminus">-  // Return an nsISimpleEnumerator of imITooltipInfo for a given nick.</span>
<a href="#l37.1406"></a><span id="l37.1406" class="difflineminus">-  getBuddyInfo(aNick) {</span>
<a href="#l37.1407"></a><span id="l37.1407" class="difflineminus">-    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l37.1408"></a><span id="l37.1408" class="difflineminus">-      return EmptyEnumerator;</span>
<a href="#l37.1409"></a><span id="l37.1409" class="difflineminus">-    }</span>
<a href="#l37.1410"></a><span id="l37.1410" class="difflineminus">-</span>
<a href="#l37.1411"></a><span id="l37.1411" class="difflineminus">-    let whoisInformation = this.whoisInformation.get(aNick);</span>
<a href="#l37.1412"></a><span id="l37.1412" class="difflineminus">-    if (whoisInformation.serverName &amp;&amp; whoisInformation.serverInfo) {</span>
<a href="#l37.1413"></a><span id="l37.1413" class="difflineminus">-      whoisInformation.server = _(</span>
<a href="#l37.1414"></a><span id="l37.1414" class="difflineminus">-        &quot;tooltip.serverValue&quot;,</span>
<a href="#l37.1415"></a><span id="l37.1415" class="difflineminus">-        whoisInformation.serverName,</span>
<a href="#l37.1416"></a><span id="l37.1416" class="difflineminus">-        whoisInformation.serverInfo</span>
<a href="#l37.1417"></a><span id="l37.1417" class="difflineminus">-      );</span>
<a href="#l37.1418"></a><span id="l37.1418" class="difflineminus">-    }</span>
<a href="#l37.1419"></a><span id="l37.1419" class="difflineminus">-</span>
<a href="#l37.1420"></a><span id="l37.1420" class="difflineminus">-    // Sort the list of channels, ignoring the prefixes of channel and user.</span>
<a href="#l37.1421"></a><span id="l37.1421" class="difflineminus">-    let prefixes = this.userPrefixes.concat(this.channelPrefixes);</span>
<a href="#l37.1422"></a><span id="l37.1422" class="difflineminus">-    let sortWithoutPrefix = function(a, b) {</span>
<a href="#l37.1423"></a><span id="l37.1423" class="difflineminus">-      a = this.normalize(a, prefixes);</span>
<a href="#l37.1424"></a><span id="l37.1424" class="difflineminus">-      b = this.normalize(b, prefixes);</span>
<a href="#l37.1425"></a><span id="l37.1425" class="difflineminus">-      if (a &lt; b) {</span>
<a href="#l37.1426"></a><span id="l37.1426" class="difflineminus">-        return -1;</span>
<a href="#l37.1427"></a><span id="l37.1427" class="difflineminus">-      }</span>
<a href="#l37.1428"></a><span id="l37.1428" class="difflineminus">-      return a &gt; b ? 1 : 0;</span>
<a href="#l37.1429"></a><span id="l37.1429" class="difflineminus">-    }.bind(this);</span>
<a href="#l37.1430"></a><span id="l37.1430" class="difflineminus">-    let sortChannels = channels =&gt;</span>
<a href="#l37.1431"></a><span id="l37.1431" class="difflineminus">-      channels</span>
<a href="#l37.1432"></a><span id="l37.1432" class="difflineminus">-        .trim()</span>
<a href="#l37.1433"></a><span id="l37.1433" class="difflineminus">-        .split(/\s+/)</span>
<a href="#l37.1434"></a><span id="l37.1434" class="difflineminus">-        .sort(sortWithoutPrefix)</span>
<a href="#l37.1435"></a><span id="l37.1435" class="difflineminus">-        .join(&quot; &quot;);</span>
<a href="#l37.1436"></a><span id="l37.1436" class="difflineminus">-</span>
<a href="#l37.1437"></a><span id="l37.1437" class="difflineminus">-    // Convert booleans into a human-readable form.</span>
<a href="#l37.1438"></a><span id="l37.1438" class="difflineminus">-    let normalizeBool = aBool =&gt; _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l37.1439"></a><span id="l37.1439" class="difflineminus">-</span>
<a href="#l37.1440"></a><span id="l37.1440" class="difflineminus">-    // Convert timespan in seconds into a human-readable form.</span>
<a href="#l37.1441"></a><span id="l37.1441" class="difflineminus">-    let normalizeTime = function(aTime) {</span>
<a href="#l37.1442"></a><span id="l37.1442" class="difflineminus">-      let valuesAndUnits = DownloadUtils.convertTimeUnits(aTime);</span>
<a href="#l37.1443"></a><span id="l37.1443" class="difflineminus">-      // If the time is exact to the first set of units, trim off</span>
<a href="#l37.1444"></a><span id="l37.1444" class="difflineminus">-      // the subsequent zeroes.</span>
<a href="#l37.1445"></a><span id="l37.1445" class="difflineminus">-      if (!valuesAndUnits[2]) {</span>
<a href="#l37.1446"></a><span id="l37.1446" class="difflineminus">-        valuesAndUnits.splice(2, 2);</span>
<a href="#l37.1447"></a><span id="l37.1447" class="difflineminus">-      }</span>
<a href="#l37.1448"></a><span id="l37.1448" class="difflineminus">-      return _(&quot;tooltip.timespan&quot;, valuesAndUnits.join(&quot; &quot;));</span>
<a href="#l37.1449"></a><span id="l37.1449" class="difflineminus">-    };</span>
<a href="#l37.1450"></a><span id="l37.1450" class="difflineminus">-</span>
<a href="#l37.1451"></a><span id="l37.1451" class="difflineminus">-    // List of the names of the info to actually show in the tooltip and</span>
<a href="#l37.1452"></a><span id="l37.1452" class="difflineminus">-    // optionally a transform function to apply to the value. Each field here</span>
<a href="#l37.1453"></a><span id="l37.1453" class="difflineminus">-    // maps to tooltip.&lt;fieldname&gt; in irc.properties.</span>
<a href="#l37.1454"></a><span id="l37.1454" class="difflineminus">-    // See the various RPL_WHOIS* results for the options.</span>
<a href="#l37.1455"></a><span id="l37.1455" class="difflineminus">-    const kFields = {</span>
<a href="#l37.1456"></a><span id="l37.1456" class="difflineminus">-      realname: null,</span>
<a href="#l37.1457"></a><span id="l37.1457" class="difflineminus">-      server: null,</span>
<a href="#l37.1458"></a><span id="l37.1458" class="difflineminus">-      connectedFrom: null,</span>
<a href="#l37.1459"></a><span id="l37.1459" class="difflineminus">-      registered: normalizeBool,</span>
<a href="#l37.1460"></a><span id="l37.1460" class="difflineminus">-      registeredAs: null,</span>
<a href="#l37.1461"></a><span id="l37.1461" class="difflineminus">-      secure: normalizeBool,</span>
<a href="#l37.1462"></a><span id="l37.1462" class="difflineminus">-      ircOp: normalizeBool,</span>
<a href="#l37.1463"></a><span id="l37.1463" class="difflineminus">-      bot: normalizeBool,</span>
<a href="#l37.1464"></a><span id="l37.1464" class="difflineminus">-      lastActivity: normalizeTime,</span>
<a href="#l37.1465"></a><span id="l37.1465" class="difflineminus">-      channels: sortChannels,</span>
<a href="#l37.1466"></a><span id="l37.1466" class="difflineminus">-    };</span>
<a href="#l37.1467"></a><span id="l37.1467" class="difflineminus">-</span>
<a href="#l37.1468"></a><span id="l37.1468" class="difflineminus">-    let tooltipInfo = [];</span>
<a href="#l37.1469"></a><span id="l37.1469" class="difflineminus">-    for (let field in kFields) {</span>
<a href="#l37.1470"></a><span id="l37.1470" class="difflineminus">-      if (whoisInformation.hasOwnProperty(field) &amp;&amp; whoisInformation[field]) {</span>
<a href="#l37.1471"></a><span id="l37.1471" class="difflineminus">-        let value = whoisInformation[field];</span>
<a href="#l37.1472"></a><span id="l37.1472" class="difflineminus">-        if (kFields[field]) {</span>
<a href="#l37.1473"></a><span id="l37.1473" class="difflineminus">-          value = kFields[field](value);</span>
<a href="#l37.1474"></a><span id="l37.1474" class="difflineminus">-        }</span>
<a href="#l37.1475"></a><span id="l37.1475" class="difflineminus">-        tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l37.1476"></a><span id="l37.1476" class="difflineminus">-      }</span>
<a href="#l37.1477"></a><span id="l37.1477" class="difflineminus">-    }</span>
<a href="#l37.1478"></a><span id="l37.1478" class="difflineminus">-</span>
<a href="#l37.1479"></a><span id="l37.1479" class="difflineminus">-    const kSetIdleStatusAfterSeconds = 3600;</span>
<a href="#l37.1480"></a><span id="l37.1480" class="difflineminus">-    let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l37.1481"></a><span id="l37.1481" class="difflineminus">-    let statusText = &quot;&quot;;</span>
<a href="#l37.1482"></a><span id="l37.1482" class="difflineminus">-    if (&quot;away&quot; in whoisInformation) {</span>
<a href="#l37.1483"></a><span id="l37.1483" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l37.1484"></a><span id="l37.1484" class="difflineminus">-      statusText = whoisInformation.away;</span>
<a href="#l37.1485"></a><span id="l37.1485" class="difflineminus">-    } else if (&quot;offline&quot; in whoisInformation) {</span>
<a href="#l37.1486"></a><span id="l37.1486" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l37.1487"></a><span id="l37.1487" class="difflineminus">-    } else if (</span>
<a href="#l37.1488"></a><span id="l37.1488" class="difflineminus">-      &quot;lastActivity&quot; in whoisInformation &amp;&amp;</span>
<a href="#l37.1489"></a><span id="l37.1489" class="difflineminus">-      whoisInformation.lastActivity &gt; kSetIdleStatusAfterSeconds</span>
<a href="#l37.1490"></a><span id="l37.1490" class="difflineminus">-    ) {</span>
<a href="#l37.1491"></a><span id="l37.1491" class="difflineminus">-      statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l37.1492"></a><span id="l37.1492" class="difflineminus">-    }</span>
<a href="#l37.1493"></a><span id="l37.1493" class="difflineminus">-    tooltipInfo.push(</span>
<a href="#l37.1494"></a><span id="l37.1494" class="difflineminus">-      new TooltipInfo(statusType, statusText, Ci.prplITooltipInfo.status)</span>
<a href="#l37.1495"></a><span id="l37.1495" class="difflineminus">-    );</span>
<a href="#l37.1496"></a><span id="l37.1496" class="difflineminus">-</span>
<a href="#l37.1497"></a><span id="l37.1497" class="difflineminus">-    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l37.1498"></a><span id="l37.1498" class="difflineminus">-  },</span>
<a href="#l37.1499"></a><span id="l37.1499" class="difflineminus">-  // Remove a WHOIS entry.</span>
<a href="#l37.1500"></a><span id="l37.1500" class="difflineminus">-  removeBuddyInfo(aNick) {</span>
<a href="#l37.1501"></a><span id="l37.1501" class="difflineminus">-    return this.whoisInformation.delete(aNick);</span>
<a href="#l37.1502"></a><span id="l37.1502" class="difflineminus">-  },</span>
<a href="#l37.1503"></a><span id="l37.1503" class="difflineminus">-  // Copies the fields of aFields into the whois table. If the field already</span>
<a href="#l37.1504"></a><span id="l37.1504" class="difflineminus">-  // exists, that field is ignored (it is assumed that the first server response</span>
<a href="#l37.1505"></a><span id="l37.1505" class="difflineminus">-  // is the most up to date information, as is the case for 312/314). Note that</span>
<a href="#l37.1506"></a><span id="l37.1506" class="difflineminus">-  // the whois info for a nick is reset whenever whois information is requested,</span>
<a href="#l37.1507"></a><span id="l37.1507" class="difflineminus">-  // so the first response from each whois is recorded.</span>
<a href="#l37.1508"></a><span id="l37.1508" class="difflineminus">-  setWhois(aNick, aFields = {}) {</span>
<a href="#l37.1509"></a><span id="l37.1509" class="difflineminus">-    // If the nickname isn't in the list yet, add it.</span>
<a href="#l37.1510"></a><span id="l37.1510" class="difflineminus">-    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l37.1511"></a><span id="l37.1511" class="difflineminus">-      this.whoisInformation.set(aNick, {});</span>
<a href="#l37.1512"></a><span id="l37.1512" class="difflineminus">-    }</span>
<a href="#l37.1513"></a><span id="l37.1513" class="difflineminus">-</span>
<a href="#l37.1514"></a><span id="l37.1514" class="difflineminus">-    // Set non-normalized nickname field.</span>
<a href="#l37.1515"></a><span id="l37.1515" class="difflineminus">-    let whoisInfo = this.whoisInformation.get(aNick);</span>
<a href="#l37.1516"></a><span id="l37.1516" class="difflineminus">-    whoisInfo.nick = aNick;</span>
<a href="#l37.1517"></a><span id="l37.1517" class="difflineminus">-</span>
<a href="#l37.1518"></a><span id="l37.1518" class="difflineminus">-    // Set the WHOIS fields, but only the first time a field is set.</span>
<a href="#l37.1519"></a><span id="l37.1519" class="difflineminus">-    for (let field in aFields) {</span>
<a href="#l37.1520"></a><span id="l37.1520" class="difflineminus">-      if (!whoisInfo.hasOwnProperty(field)) {</span>
<a href="#l37.1521"></a><span id="l37.1521" class="difflineminus">-        whoisInfo[field] = aFields[field];</span>
<a href="#l37.1522"></a><span id="l37.1522" class="difflineminus">-      }</span>
<a href="#l37.1523"></a><span id="l37.1523" class="difflineminus">-    }</span>
<a href="#l37.1524"></a><span id="l37.1524" class="difflineminus">-</span>
<a href="#l37.1525"></a><span id="l37.1525" class="difflineminus">-    return true;</span>
<a href="#l37.1526"></a><span id="l37.1526" class="difflineminus">-  },</span>
<a href="#l37.1527"></a><span id="l37.1527" class="difflineminus">-</span>
<a href="#l37.1528"></a><span id="l37.1528" class="difflineminus">-  trackBuddy(aNick) {</span>
<a href="#l37.1529"></a><span id="l37.1529" class="difflineminus">-    // Put the username as the first to be checked on the next ISON call.</span>
<a href="#l37.1530"></a><span id="l37.1530" class="difflineminus">-    this.trackQueue.unshift(aNick);</span>
<a href="#l37.1531"></a><span id="l37.1531" class="difflineminus">-  },</span>
<a href="#l37.1532"></a><span id="l37.1532" class="difflineminus">-  untrackBuddy(aNick) {</span>
<a href="#l37.1533"></a><span id="l37.1533" class="difflineminus">-    let index = this.trackQueue.indexOf(aNick);</span>
<a href="#l37.1534"></a><span id="l37.1534" class="difflineminus">-    if (index &lt; 0) {</span>
<a href="#l37.1535"></a><span id="l37.1535" class="difflineminus">-      this.ERROR(</span>
<a href="#l37.1536"></a><span id="l37.1536" class="difflineminus">-        &quot;Trying to untrack a nick that was not being tracked: &quot; + aNick</span>
<a href="#l37.1537"></a><span id="l37.1537" class="difflineminus">-      );</span>
<a href="#l37.1538"></a><span id="l37.1538" class="difflineminus">-      return;</span>
<a href="#l37.1539"></a><span id="l37.1539" class="difflineminus">-    }</span>
<a href="#l37.1540"></a><span id="l37.1540" class="difflineminus">-    this.trackQueue.splice(index, 1);</span>
<a href="#l37.1541"></a><span id="l37.1541" class="difflineminus">-  },</span>
<a href="#l37.1542"></a><span id="l37.1542" class="difflineminus">-  addBuddy(aTag, aName) {</span>
<a href="#l37.1543"></a><span id="l37.1543" class="difflineminus">-    let buddy = new IRCAccountBuddy(this, null, aTag, aName);</span>
<a href="#l37.1544"></a><span id="l37.1544" class="difflineminus">-    this.buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l37.1545"></a><span id="l37.1545" class="difflineminus">-    this.trackBuddy(buddy.userName);</span>
<a href="#l37.1546"></a><span id="l37.1546" class="difflineminus">-</span>
<a href="#l37.1547"></a><span id="l37.1547" class="difflineminus">-    Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l37.1548"></a><span id="l37.1548" class="difflineminus">-  },</span>
<a href="#l37.1549"></a><span id="l37.1549" class="difflineminus">-  removeBuddy(aBuddy) {</span>
<a href="#l37.1550"></a><span id="l37.1550" class="difflineminus">-    this.buddies.delete(aBuddy.normalizedName);</span>
<a href="#l37.1551"></a><span id="l37.1551" class="difflineminus">-    this.untrackBuddy(aBuddy.userName);</span>
<a href="#l37.1552"></a><span id="l37.1552" class="difflineminus">-  },</span>
<a href="#l37.1553"></a><span id="l37.1553" class="difflineminus">-  // Loads a buddy from the local storage. Called for each buddy locally stored</span>
<a href="#l37.1554"></a><span id="l37.1554" class="difflineminus">-  // before connecting to the server.</span>
<a href="#l37.1555"></a><span id="l37.1555" class="difflineminus">-  loadBuddy(aBuddy, aTag) {</span>
<a href="#l37.1556"></a><span id="l37.1556" class="difflineminus">-    let buddy = new IRCAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l37.1557"></a><span id="l37.1557" class="difflineminus">-    this.buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l37.1558"></a><span id="l37.1558" class="difflineminus">-    this.trackBuddy(buddy.userName);</span>
<a href="#l37.1559"></a><span id="l37.1559" class="difflineminus">-</span>
<a href="#l37.1560"></a><span id="l37.1560" class="difflineminus">-    return buddy;</span>
<a href="#l37.1561"></a><span id="l37.1561" class="difflineminus">-  },</span>
<a href="#l37.1562"></a><span id="l37.1562" class="difflineminus">-  changeBuddyNick(aOldNick, aNewNick) {</span>
<a href="#l37.1563"></a><span id="l37.1563" class="difflineminus">-    if (this.normalizeNick(aOldNick) == this.normalizeNick(this._nickname)) {</span>
<a href="#l37.1564"></a><span id="l37.1564" class="difflineminus">-      // Your nickname changed!</span>
<a href="#l37.1565"></a><span id="l37.1565" class="difflineminus">-      this._nickname = aNewNick;</span>
<a href="#l37.1566"></a><span id="l37.1566" class="difflineminus">-      this.conversations.forEach(conversation =&gt; {</span>
<a href="#l37.1567"></a><span id="l37.1567" class="difflineminus">-        // Update the nick for chats, and inform the user in every conversation.</span>
<a href="#l37.1568"></a><span id="l37.1568" class="difflineminus">-        if (conversation.isChat) {</span>
<a href="#l37.1569"></a><span id="l37.1569" class="difflineminus">-          conversation.updateNick(aOldNick, aNewNick, true);</span>
<a href="#l37.1570"></a><span id="l37.1570" class="difflineminus">-        } else {</span>
<a href="#l37.1571"></a><span id="l37.1571" class="difflineminus">-          conversation.writeMessage(aOldNick, _conv(&quot;nickSet.you&quot;, aNewNick), {</span>
<a href="#l37.1572"></a><span id="l37.1572" class="difflineminus">-            system: true,</span>
<a href="#l37.1573"></a><span id="l37.1573" class="difflineminus">-          });</span>
<a href="#l37.1574"></a><span id="l37.1574" class="difflineminus">-        }</span>
<a href="#l37.1575"></a><span id="l37.1575" class="difflineminus">-      });</span>
<a href="#l37.1576"></a><span id="l37.1576" class="difflineminus">-    } else {</span>
<a href="#l37.1577"></a><span id="l37.1577" class="difflineminus">-      this.conversations.forEach(conversation =&gt; {</span>
<a href="#l37.1578"></a><span id="l37.1578" class="difflineminus">-        if (conversation.isChat &amp;&amp; conversation._participants.has(aOldNick)) {</span>
<a href="#l37.1579"></a><span id="l37.1579" class="difflineminus">-          // Update the nick in every chat conversation it is in.</span>
<a href="#l37.1580"></a><span id="l37.1580" class="difflineminus">-          conversation.updateNick(aOldNick, aNewNick, false);</span>
<a href="#l37.1581"></a><span id="l37.1581" class="difflineminus">-        }</span>
<a href="#l37.1582"></a><span id="l37.1582" class="difflineminus">-      });</span>
<a href="#l37.1583"></a><span id="l37.1583" class="difflineminus">-    }</span>
<a href="#l37.1584"></a><span id="l37.1584" class="difflineminus">-</span>
<a href="#l37.1585"></a><span id="l37.1585" class="difflineminus">-    // Adjust the whois table where necessary.</span>
<a href="#l37.1586"></a><span id="l37.1586" class="difflineminus">-    this.removeBuddyInfo(aOldNick);</span>
<a href="#l37.1587"></a><span id="l37.1587" class="difflineminus">-    this.setWhois(aNewNick);</span>
<a href="#l37.1588"></a><span id="l37.1588" class="difflineminus">-</span>
<a href="#l37.1589"></a><span id="l37.1589" class="difflineminus">-    // If a private conversation is open with that user, change its title.</span>
<a href="#l37.1590"></a><span id="l37.1590" class="difflineminus">-    if (this.conversations.has(aOldNick)) {</span>
<a href="#l37.1591"></a><span id="l37.1591" class="difflineminus">-      // Get the current conversation and rename it.</span>
<a href="#l37.1592"></a><span id="l37.1592" class="difflineminus">-      let conversation = this.getConversation(aOldNick);</span>
<a href="#l37.1593"></a><span id="l37.1593" class="difflineminus">-</span>
<a href="#l37.1594"></a><span id="l37.1594" class="difflineminus">-      // Remove the old reference to the conversation and create a new one.</span>
<a href="#l37.1595"></a><span id="l37.1595" class="difflineminus">-      this.removeConversation(aOldNick);</span>
<a href="#l37.1596"></a><span id="l37.1596" class="difflineminus">-      this.conversations.set(aNewNick, conversation);</span>
<a href="#l37.1597"></a><span id="l37.1597" class="difflineminus">-</span>
<a href="#l37.1598"></a><span id="l37.1598" class="difflineminus">-      conversation.updateNick(aNewNick);</span>
<a href="#l37.1599"></a><span id="l37.1599" class="difflineminus">-      conversation.writeMessage(</span>
<a href="#l37.1600"></a><span id="l37.1600" class="difflineminus">-        aOldNick,</span>
<a href="#l37.1601"></a><span id="l37.1601" class="difflineminus">-        _conv(&quot;nickSet&quot;, aOldNick, aNewNick),</span>
<a href="#l37.1602"></a><span id="l37.1602" class="difflineminus">-        { system: true }</span>
<a href="#l37.1603"></a><span id="l37.1603" class="difflineminus">-      );</span>
<a href="#l37.1604"></a><span id="l37.1604" class="difflineminus">-    }</span>
<a href="#l37.1605"></a><span id="l37.1605" class="difflineminus">-  },</span>
<a href="#l37.1606"></a><span id="l37.1606" class="difflineminus">-</span>
<a href="#l37.1607"></a><span id="l37.1607" class="difflineminus">-  /*</span>
<a href="#l37.1608"></a><span id="l37.1608" class="difflineminus">-   * Ask the server to change the user's nick.</span>
<a href="#l37.1609"></a><span id="l37.1609" class="difflineminus">-   */</span>
<a href="#l37.1610"></a><span id="l37.1610" class="difflineminus">-  changeNick(aNewNick) {</span>
<a href="#l37.1611"></a><span id="l37.1611" class="difflineminus">-    this._sentNickname = aNewNick;</span>
<a href="#l37.1612"></a><span id="l37.1612" class="difflineminus">-    this.sendMessage(&quot;NICK&quot;, aNewNick); // Nick message.</span>
<a href="#l37.1613"></a><span id="l37.1613" class="difflineminus">-  },</span>
<a href="#l37.1614"></a><span id="l37.1614" class="difflineminus">-  /*</span>
<a href="#l37.1615"></a><span id="l37.1615" class="difflineminus">-   * Generate a new nick to change to if the user requested nick is already in</span>
<a href="#l37.1616"></a><span id="l37.1616" class="difflineminus">-   * use or is otherwise invalid.</span>
<a href="#l37.1617"></a><span id="l37.1617" class="difflineminus">-   *</span>
<a href="#l37.1618"></a><span id="l37.1618" class="difflineminus">-   * First try all the alternate nicks that were chosen by the user, and if none</span>
<a href="#l37.1619"></a><span id="l37.1619" class="difflineminus">-   * of them work, then generate a new nick by:</span>
<a href="#l37.1620"></a><span id="l37.1620" class="difflineminus">-   *  1. If there was not a digit at the end of the nick, append a 1.</span>
<a href="#l37.1621"></a><span id="l37.1621" class="difflineminus">-   *  2. If there was a digit, then increment the number.</span>
<a href="#l37.1622"></a><span id="l37.1622" class="difflineminus">-   *  3. Add leading 0s back on.</span>
<a href="#l37.1623"></a><span id="l37.1623" class="difflineminus">-   *  4. Ensure the nick is an appropriate length.</span>
<a href="#l37.1624"></a><span id="l37.1624" class="difflineminus">-   */</span>
<a href="#l37.1625"></a><span id="l37.1625" class="difflineminus">-  tryNewNick(aOldNick) {</span>
<a href="#l37.1626"></a><span id="l37.1626" class="difflineminus">-    // Split the string on commas, remove whitespace around the nicks and</span>
<a href="#l37.1627"></a><span id="l37.1627" class="difflineminus">-    // remove empty nicks.</span>
<a href="#l37.1628"></a><span id="l37.1628" class="difflineminus">-    let allNicks = this.getString(&quot;alternateNicks&quot;)</span>
<a href="#l37.1629"></a><span id="l37.1629" class="difflineminus">-      .split(&quot;,&quot;)</span>
<a href="#l37.1630"></a><span id="l37.1630" class="difflineminus">-      .map(n =&gt; n.trim())</span>
<a href="#l37.1631"></a><span id="l37.1631" class="difflineminus">-      .filter(n =&gt; !!n);</span>
<a href="#l37.1632"></a><span id="l37.1632" class="difflineminus">-    allNicks.unshift(this._accountNickname);</span>
<a href="#l37.1633"></a><span id="l37.1633" class="difflineminus">-</span>
<a href="#l37.1634"></a><span id="l37.1634" class="difflineminus">-    // If the previously tried nick is in the array and not the last</span>
<a href="#l37.1635"></a><span id="l37.1635" class="difflineminus">-    // element, try the next nick in the array.</span>
<a href="#l37.1636"></a><span id="l37.1636" class="difflineminus">-    let oldIndex = allNicks.indexOf(aOldNick);</span>
<a href="#l37.1637"></a><span id="l37.1637" class="difflineminus">-    if (oldIndex != -1 &amp;&amp; oldIndex &lt; allNicks.length - 1) {</span>
<a href="#l37.1638"></a><span id="l37.1638" class="difflineminus">-      let newNick = allNicks[oldIndex + 1];</span>
<a href="#l37.1639"></a><span id="l37.1639" class="difflineminus">-      this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l37.1640"></a><span id="l37.1640" class="difflineminus">-      this.changeNick(newNick);</span>
<a href="#l37.1641"></a><span id="l37.1641" class="difflineminus">-      return true;</span>
<a href="#l37.1642"></a><span id="l37.1642" class="difflineminus">-    }</span>
<a href="#l37.1643"></a><span id="l37.1643" class="difflineminus">-</span>
<a href="#l37.1644"></a><span id="l37.1644" class="difflineminus">-    // Separate the nick into the text and digits part.</span>
<a href="#l37.1645"></a><span id="l37.1645" class="difflineminus">-    let kNickPattern = /^(.+?)(\d*)$/;</span>
<a href="#l37.1646"></a><span id="l37.1646" class="difflineminus">-    let nickParts = kNickPattern.exec(aOldNick);</span>
<a href="#l37.1647"></a><span id="l37.1647" class="difflineminus">-    let newNick = nickParts[1];</span>
<a href="#l37.1648"></a><span id="l37.1648" class="difflineminus">-</span>
<a href="#l37.1649"></a><span id="l37.1649" class="difflineminus">-    // No nick found from the user's preferences, so just generating one.</span>
<a href="#l37.1650"></a><span id="l37.1650" class="difflineminus">-    // If there is not a digit at the end of the nick, just append 1.</span>
<a href="#l37.1651"></a><span id="l37.1651" class="difflineminus">-    let newDigits = &quot;1&quot;;</span>
<a href="#l37.1652"></a><span id="l37.1652" class="difflineminus">-    // If there is a digit at the end of the nick, increment it.</span>
<a href="#l37.1653"></a><span id="l37.1653" class="difflineminus">-    if (nickParts[2]) {</span>
<a href="#l37.1654"></a><span id="l37.1654" class="difflineminus">-      newDigits = (parseInt(nickParts[2], 10) + 1).toString();</span>
<a href="#l37.1655"></a><span id="l37.1655" class="difflineminus">-      // If there are leading 0s, add them back on, after we've incremented (e.g.</span>
<a href="#l37.1656"></a><span id="l37.1656" class="difflineminus">-      // 009 --&gt; 010).</span>
<a href="#l37.1657"></a><span id="l37.1657" class="difflineminus">-      let numLeadingZeros = nickParts[2].length - newDigits.length;</span>
<a href="#l37.1658"></a><span id="l37.1658" class="difflineminus">-      if (numLeadingZeros &gt; 0) {</span>
<a href="#l37.1659"></a><span id="l37.1659" class="difflineminus">-        newDigits = &quot;0&quot;.repeat(numLeadingZeros) + newDigits;</span>
<a href="#l37.1660"></a><span id="l37.1660" class="difflineminus">-      }</span>
<a href="#l37.1661"></a><span id="l37.1661" class="difflineminus">-    }</span>
<a href="#l37.1662"></a><span id="l37.1662" class="difflineminus">-</span>
<a href="#l37.1663"></a><span id="l37.1663" class="difflineminus">-    // Servers truncate nicks that are too long, compare the previously sent</span>
<a href="#l37.1664"></a><span id="l37.1664" class="difflineminus">-    // nickname with the returned nickname and check for truncation.</span>
<a href="#l37.1665"></a><span id="l37.1665" class="difflineminus">-    if (aOldNick.length &lt; this._sentNickname.length) {</span>
<a href="#l37.1666"></a><span id="l37.1666" class="difflineminus">-      // The nick will be too long, overwrite the end of the nick instead of</span>
<a href="#l37.1667"></a><span id="l37.1667" class="difflineminus">-      // appending.</span>
<a href="#l37.1668"></a><span id="l37.1668" class="difflineminus">-      let maxLength = aOldNick.length;</span>
<a href="#l37.1669"></a><span id="l37.1669" class="difflineminus">-</span>
<a href="#l37.1670"></a><span id="l37.1670" class="difflineminus">-      let sentNickParts = kNickPattern.exec(this._sentNickname);</span>
<a href="#l37.1671"></a><span id="l37.1671" class="difflineminus">-      // Resend the same digits as last time, but overwrite part of the nick</span>
<a href="#l37.1672"></a><span id="l37.1672" class="difflineminus">-      // this time.</span>
<a href="#l37.1673"></a><span id="l37.1673" class="difflineminus">-      if (nickParts[2] &amp;&amp; sentNickParts[2]) {</span>
<a href="#l37.1674"></a><span id="l37.1674" class="difflineminus">-        newDigits = sentNickParts[2];</span>
<a href="#l37.1675"></a><span id="l37.1675" class="difflineminus">-      }</span>
<a href="#l37.1676"></a><span id="l37.1676" class="difflineminus">-</span>
<a href="#l37.1677"></a><span id="l37.1677" class="difflineminus">-      // Handle the silly case of a single letter followed by all nines.</span>
<a href="#l37.1678"></a><span id="l37.1678" class="difflineminus">-      if (newDigits.length == this.maxNicknameLength) {</span>
<a href="#l37.1679"></a><span id="l37.1679" class="difflineminus">-        newDigits = newDigits.slice(1);</span>
<a href="#l37.1680"></a><span id="l37.1680" class="difflineminus">-      }</span>
<a href="#l37.1681"></a><span id="l37.1681" class="difflineminus">-      newNick = newNick.slice(0, maxLength - newDigits.length);</span>
<a href="#l37.1682"></a><span id="l37.1682" class="difflineminus">-    }</span>
<a href="#l37.1683"></a><span id="l37.1683" class="difflineminus">-    // Append the digits.</span>
<a href="#l37.1684"></a><span id="l37.1684" class="difflineminus">-    newNick += newDigits;</span>
<a href="#l37.1685"></a><span id="l37.1685" class="difflineminus">-</span>
<a href="#l37.1686"></a><span id="l37.1686" class="difflineminus">-    if (this.normalize(newNick) == this.normalize(this._nickname)) {</span>
<a href="#l37.1687"></a><span id="l37.1687" class="difflineminus">-      // The nick we were about to try next is our current nick. This means</span>
<a href="#l37.1688"></a><span id="l37.1688" class="difflineminus">-      // the user attempted to change to a version of the nick with a lower or</span>
<a href="#l37.1689"></a><span id="l37.1689" class="difflineminus">-      // absent number suffix, and this failed.</span>
<a href="#l37.1690"></a><span id="l37.1690" class="difflineminus">-      let msg = _(&quot;message.nick.fail&quot;, this._nickname);</span>
<a href="#l37.1691"></a><span id="l37.1691" class="difflineminus">-      this.conversations.forEach(conversation =&gt;</span>
<a href="#l37.1692"></a><span id="l37.1692" class="difflineminus">-        conversation.writeMessage(this._nickname, msg, { system: true })</span>
<a href="#l37.1693"></a><span id="l37.1693" class="difflineminus">-      );</span>
<a href="#l37.1694"></a><span id="l37.1694" class="difflineminus">-      return true;</span>
<a href="#l37.1695"></a><span id="l37.1695" class="difflineminus">-    }</span>
<a href="#l37.1696"></a><span id="l37.1696" class="difflineminus">-</span>
<a href="#l37.1697"></a><span id="l37.1697" class="difflineminus">-    this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l37.1698"></a><span id="l37.1698" class="difflineminus">-    this.changeNick(newNick);</span>
<a href="#l37.1699"></a><span id="l37.1699" class="difflineminus">-    return true;</span>
<a href="#l37.1700"></a><span id="l37.1700" class="difflineminus">-  },</span>
<a href="#l37.1701"></a><span id="l37.1701" class="difflineminus">-</span>
<a href="#l37.1702"></a><span id="l37.1702" class="difflineminus">-  handlePingReply(aSource, aPongTime) {</span>
<a href="#l37.1703"></a><span id="l37.1703" class="difflineminus">-    // Received PING response, display to the user.</span>
<a href="#l37.1704"></a><span id="l37.1704" class="difflineminus">-    let sentTime = new Date(parseInt(aPongTime, 10));</span>
<a href="#l37.1705"></a><span id="l37.1705" class="difflineminus">-</span>
<a href="#l37.1706"></a><span id="l37.1706" class="difflineminus">-    // The received timestamp is invalid.</span>
<a href="#l37.1707"></a><span id="l37.1707" class="difflineminus">-    if (isNaN(sentTime)) {</span>
<a href="#l37.1708"></a><span id="l37.1708" class="difflineminus">-      this.WARN(</span>
<a href="#l37.1709"></a><span id="l37.1709" class="difflineminus">-        aSource + &quot; returned an invalid timestamp from a PING: &quot; + aPongTime</span>
<a href="#l37.1710"></a><span id="l37.1710" class="difflineminus">-      );</span>
<a href="#l37.1711"></a><span id="l37.1711" class="difflineminus">-      return false;</span>
<a href="#l37.1712"></a><span id="l37.1712" class="difflineminus">-    }</span>
<a href="#l37.1713"></a><span id="l37.1713" class="difflineminus">-</span>
<a href="#l37.1714"></a><span id="l37.1714" class="difflineminus">-    // Find the delay in milliseconds.</span>
<a href="#l37.1715"></a><span id="l37.1715" class="difflineminus">-    let delay = Date.now() - sentTime;</span>
<a href="#l37.1716"></a><span id="l37.1716" class="difflineminus">-</span>
<a href="#l37.1717"></a><span id="l37.1717" class="difflineminus">-    // If the delay is negative or greater than 1 minute, something is</span>
<a href="#l37.1718"></a><span id="l37.1718" class="difflineminus">-    // feeding us a crazy value. Don't display this to the user.</span>
<a href="#l37.1719"></a><span id="l37.1719" class="difflineminus">-    if (delay &lt; 0 || 60 * 1000 &lt; delay) {</span>
<a href="#l37.1720"></a><span id="l37.1720" class="difflineminus">-      this.WARN(aSource + &quot; returned an invalid delay from a PING: &quot; + delay);</span>
<a href="#l37.1721"></a><span id="l37.1721" class="difflineminus">-      return false;</span>
<a href="#l37.1722"></a><span id="l37.1722" class="difflineminus">-    }</span>
<a href="#l37.1723"></a><span id="l37.1723" class="difflineminus">-</span>
<a href="#l37.1724"></a><span id="l37.1724" class="difflineminus">-    let msg = PluralForm.get(delay, _(&quot;message.ping&quot;, aSource)).replace(</span>
<a href="#l37.1725"></a><span id="l37.1725" class="difflineminus">-      &quot;#2&quot;,</span>
<a href="#l37.1726"></a><span id="l37.1726" class="difflineminus">-      delay</span>
<a href="#l37.1727"></a><span id="l37.1727" class="difflineminus">-    );</span>
<a href="#l37.1728"></a><span id="l37.1728" class="difflineminus">-    this.getConversation(aSource).writeMessage(aSource, msg, { system: true });</span>
<a href="#l37.1729"></a><span id="l37.1729" class="difflineminus">-    return true;</span>
<a href="#l37.1730"></a><span id="l37.1730" class="difflineminus">-  },</span>
<a href="#l37.1731"></a><span id="l37.1731" class="difflineminus">-</span>
<a href="#l37.1732"></a><span id="l37.1732" class="difflineminus">-  countBytes(aStr) {</span>
<a href="#l37.1733"></a><span id="l37.1733" class="difflineminus">-    // Assume that if it's not UTF-8 then each character is 1 byte.</span>
<a href="#l37.1734"></a><span id="l37.1734" class="difflineminus">-    if (this._encoding != &quot;UTF-8&quot;) {</span>
<a href="#l37.1735"></a><span id="l37.1735" class="difflineminus">-      return aStr.length;</span>
<a href="#l37.1736"></a><span id="l37.1736" class="difflineminus">-    }</span>
<a href="#l37.1737"></a><span id="l37.1737" class="difflineminus">-</span>
<a href="#l37.1738"></a><span id="l37.1738" class="difflineminus">-    // Count the number of bytes in a UTF-8 encoded string.</span>
<a href="#l37.1739"></a><span id="l37.1739" class="difflineminus">-    function charCodeToByteCount(c) {</span>
<a href="#l37.1740"></a><span id="l37.1740" class="difflineminus">-      // UTF-8 stores:</span>
<a href="#l37.1741"></a><span id="l37.1741" class="difflineminus">-      // - code points below U+0080 are 1 byte,</span>
<a href="#l37.1742"></a><span id="l37.1742" class="difflineminus">-      // - code points below U+0800 are 2 bytes,</span>
<a href="#l37.1743"></a><span id="l37.1743" class="difflineminus">-      // - code points U+D800 through U+DFFF are UTF-16 surrogate halves</span>
<a href="#l37.1744"></a><span id="l37.1744" class="difflineminus">-      // (they indicate that JS has split a 4 bytes UTF-8 character</span>
<a href="#l37.1745"></a><span id="l37.1745" class="difflineminus">-      // in two halves of 2 bytes each),</span>
<a href="#l37.1746"></a><span id="l37.1746" class="difflineminus">-      // - other code points are 3 bytes.</span>
<a href="#l37.1747"></a><span id="l37.1747" class="difflineminus">-      if (c &lt; 0x80) {</span>
<a href="#l37.1748"></a><span id="l37.1748" class="difflineminus">-        return 1;</span>
<a href="#l37.1749"></a><span id="l37.1749" class="difflineminus">-      }</span>
<a href="#l37.1750"></a><span id="l37.1750" class="difflineminus">-      if (c &lt; 0x800 || (c &gt;= 0xd800 &amp;&amp; c &lt;= 0xdfff)) {</span>
<a href="#l37.1751"></a><span id="l37.1751" class="difflineminus">-        return 2;</span>
<a href="#l37.1752"></a><span id="l37.1752" class="difflineminus">-      }</span>
<a href="#l37.1753"></a><span id="l37.1753" class="difflineminus">-      return 3;</span>
<a href="#l37.1754"></a><span id="l37.1754" class="difflineminus">-    }</span>
<a href="#l37.1755"></a><span id="l37.1755" class="difflineminus">-    let bytes = 0;</span>
<a href="#l37.1756"></a><span id="l37.1756" class="difflineminus">-    for (let i = 0; i &lt; aStr.length; i++) {</span>
<a href="#l37.1757"></a><span id="l37.1757" class="difflineminus">-      bytes += charCodeToByteCount(aStr.charCodeAt(i));</span>
<a href="#l37.1758"></a><span id="l37.1758" class="difflineminus">-    }</span>
<a href="#l37.1759"></a><span id="l37.1759" class="difflineminus">-    return bytes;</span>
<a href="#l37.1760"></a><span id="l37.1760" class="difflineminus">-  },</span>
<a href="#l37.1761"></a><span id="l37.1761" class="difflineminus">-</span>
<a href="#l37.1762"></a><span id="l37.1762" class="difflineminus">-  // To check if users are online, we need to queue multiple messages.</span>
<a href="#l37.1763"></a><span id="l37.1763" class="difflineminus">-  // An internal queue of all nicks that we wish to know the status of.</span>
<a href="#l37.1764"></a><span id="l37.1764" class="difflineminus">-  trackQueue: [],</span>
<a href="#l37.1765"></a><span id="l37.1765" class="difflineminus">-  // The nicks that were last sent to the server that we're waiting for a</span>
<a href="#l37.1766"></a><span id="l37.1766" class="difflineminus">-  // response about.</span>
<a href="#l37.1767"></a><span id="l37.1767" class="difflineminus">-  pendingIsOnQueue: [],</span>
<a href="#l37.1768"></a><span id="l37.1768" class="difflineminus">-  // The time between sending isOn messages (milliseconds).</span>
<a href="#l37.1769"></a><span id="l37.1769" class="difflineminus">-  _isOnDelay: 60 * 1000,</span>
<a href="#l37.1770"></a><span id="l37.1770" class="difflineminus">-  _isOnTimer: null,</span>
<a href="#l37.1771"></a><span id="l37.1771" class="difflineminus">-  // The number of characters that are available to be filled with nicks for</span>
<a href="#l37.1772"></a><span id="l37.1772" class="difflineminus">-  // each ISON message.</span>
<a href="#l37.1773"></a><span id="l37.1773" class="difflineminus">-  _isOnLength: null,</span>
<a href="#l37.1774"></a><span id="l37.1774" class="difflineminus">-  // Generate and send an ISON message to poll for each nick's status.</span>
<a href="#l37.1775"></a><span id="l37.1775" class="difflineminus">-  sendIsOn() {</span>
<a href="#l37.1776"></a><span id="l37.1776" class="difflineminus">-    // If no buddies, just look again after the timeout.</span>
<a href="#l37.1777"></a><span id="l37.1777" class="difflineminus">-    if (this.trackQueue.length) {</span>
<a href="#l37.1778"></a><span id="l37.1778" class="difflineminus">-      // Calculate the possible length of names we can send.</span>
<a href="#l37.1779"></a><span id="l37.1779" class="difflineminus">-      if (!this._isOnLength) {</span>
<a href="#l37.1780"></a><span id="l37.1780" class="difflineminus">-        let length = this.countBytes(this.buildMessage(&quot;ISON&quot;, &quot; &quot;)) + 2;</span>
<a href="#l37.1781"></a><span id="l37.1781" class="difflineminus">-        this._isOnLength = this.maxMessageLength - length + 1;</span>
<a href="#l37.1782"></a><span id="l37.1782" class="difflineminus">-      }</span>
<a href="#l37.1783"></a><span id="l37.1783" class="difflineminus">-</span>
<a href="#l37.1784"></a><span id="l37.1784" class="difflineminus">-      // Always add the next nickname to the pending queue, this handles a silly</span>
<a href="#l37.1785"></a><span id="l37.1785" class="difflineminus">-      // case where the next nick is greater than or equal to the maximum</span>
<a href="#l37.1786"></a><span id="l37.1786" class="difflineminus">-      // message length.</span>
<a href="#l37.1787"></a><span id="l37.1787" class="difflineminus">-      this.pendingIsOnQueue = [this.trackQueue.shift()];</span>
<a href="#l37.1788"></a><span id="l37.1788" class="difflineminus">-</span>
<a href="#l37.1789"></a><span id="l37.1789" class="difflineminus">-      // Attempt to maximize the characters used in each message, this may mean</span>
<a href="#l37.1790"></a><span id="l37.1790" class="difflineminus">-      // that a specific user gets sent very often since they have a short name!</span>
<a href="#l37.1791"></a><span id="l37.1791" class="difflineminus">-      let buddiesLength = this.countBytes(this.pendingIsOnQueue[0]);</span>
<a href="#l37.1792"></a><span id="l37.1792" class="difflineminus">-      for (let i = 0; i &lt; this.trackQueue.length; ++i) {</span>
<a href="#l37.1793"></a><span id="l37.1793" class="difflineminus">-        // If we can fit the nick, add it to the current buffer.</span>
<a href="#l37.1794"></a><span id="l37.1794" class="difflineminus">-        if (</span>
<a href="#l37.1795"></a><span id="l37.1795" class="difflineminus">-          buddiesLength + this.countBytes(this.trackQueue[i]) &lt;</span>
<a href="#l37.1796"></a><span id="l37.1796" class="difflineminus">-          this._isOnLength</span>
<a href="#l37.1797"></a><span id="l37.1797" class="difflineminus">-        ) {</span>
<a href="#l37.1798"></a><span id="l37.1798" class="difflineminus">-          // Remove the name from the list and add it to the pending queue.</span>
<a href="#l37.1799"></a><span id="l37.1799" class="difflineminus">-          let nick = this.trackQueue.splice(i--, 1)[0];</span>
<a href="#l37.1800"></a><span id="l37.1800" class="difflineminus">-          this.pendingIsOnQueue.push(nick);</span>
<a href="#l37.1801"></a><span id="l37.1801" class="difflineminus">-</span>
<a href="#l37.1802"></a><span id="l37.1802" class="difflineminus">-          // Keep track of the length of the string, the + 1 is for the spaces.</span>
<a href="#l37.1803"></a><span id="l37.1803" class="difflineminus">-          buddiesLength += this.countBytes(nick) + 1;</span>
<a href="#l37.1804"></a><span id="l37.1804" class="difflineminus">-</span>
<a href="#l37.1805"></a><span id="l37.1805" class="difflineminus">-          // If we've filled up the message, stop looking for more nicks.</span>
<a href="#l37.1806"></a><span id="l37.1806" class="difflineminus">-          if (buddiesLength &gt;= this._isOnLength) {</span>
<a href="#l37.1807"></a><span id="l37.1807" class="difflineminus">-            break;</span>
<a href="#l37.1808"></a><span id="l37.1808" class="difflineminus">-          }</span>
<a href="#l37.1809"></a><span id="l37.1809" class="difflineminus">-        }</span>
<a href="#l37.1810"></a><span id="l37.1810" class="difflineminus">-      }</span>
<a href="#l37.1811"></a><span id="l37.1811" class="difflineminus">-</span>
<a href="#l37.1812"></a><span id="l37.1812" class="difflineminus">-      // Send the message.</span>
<a href="#l37.1813"></a><span id="l37.1813" class="difflineminus">-      this.sendMessage(&quot;ISON&quot;, this.pendingIsOnQueue.join(&quot; &quot;));</span>
<a href="#l37.1814"></a><span id="l37.1814" class="difflineminus">-</span>
<a href="#l37.1815"></a><span id="l37.1815" class="difflineminus">-      // Append the pending nicks so trackQueue contains all the nicks.</span>
<a href="#l37.1816"></a><span id="l37.1816" class="difflineminus">-      this.trackQueue = this.trackQueue.concat(this.pendingIsOnQueue);</span>
<a href="#l37.1817"></a><span id="l37.1817" class="difflineminus">-    }</span>
<a href="#l37.1818"></a><span id="l37.1818" class="difflineminus">-</span>
<a href="#l37.1819"></a><span id="l37.1819" class="difflineminus">-    // Call this function again in _isOnDelay seconds.</span>
<a href="#l37.1820"></a><span id="l37.1820" class="difflineminus">-    // This makes the assumption that this._isOnDelay &gt;&gt; the response to ISON</span>
<a href="#l37.1821"></a><span id="l37.1821" class="difflineminus">-    // from the server.</span>
<a href="#l37.1822"></a><span id="l37.1822" class="difflineminus">-    this._isOnTimer = setTimeout(this.sendIsOn.bind(this), this._isOnDelay);</span>
<a href="#l37.1823"></a><span id="l37.1823" class="difflineminus">-  },</span>
<a href="#l37.1824"></a><span id="l37.1824" class="difflineminus">-</span>
<a href="#l37.1825"></a><span id="l37.1825" class="difflineminus">-  // The message of the day uses two fields to append messages.</span>
<a href="#l37.1826"></a><span id="l37.1826" class="difflineminus">-  _motd: null,</span>
<a href="#l37.1827"></a><span id="l37.1827" class="difflineminus">-  _motdTimer: null,</span>
<a href="#l37.1828"></a><span id="l37.1828" class="difflineminus">-</span>
<a href="#l37.1829"></a><span id="l37.1829" class="difflineminus">-  connect() {</span>
<a href="#l37.1830"></a><span id="l37.1830" class="difflineminus">-    this.reportConnecting();</span>
<a href="#l37.1831"></a><span id="l37.1831" class="difflineminus">-</span>
<a href="#l37.1832"></a><span id="l37.1832" class="difflineminus">-    // Mark existing MUCs as joining if they will be rejoined.</span>
<a href="#l37.1833"></a><span id="l37.1833" class="difflineminus">-    this.conversations.forEach(conversation =&gt; {</span>
<a href="#l37.1834"></a><span id="l37.1834" class="difflineminus">-      if (conversation.isChat &amp;&amp; conversation.chatRoomFields) {</span>
<a href="#l37.1835"></a><span id="l37.1835" class="difflineminus">-        conversation.joining = true;</span>
<a href="#l37.1836"></a><span id="l37.1836" class="difflineminus">-      }</span>
<a href="#l37.1837"></a><span id="l37.1837" class="difflineminus">-    });</span>
<a href="#l37.1838"></a><span id="l37.1838" class="difflineminus">-</span>
<a href="#l37.1839"></a><span id="l37.1839" class="difflineminus">-    // Load preferences.</span>
<a href="#l37.1840"></a><span id="l37.1840" class="difflineminus">-    this._port = this.getInt(&quot;port&quot;);</span>
<a href="#l37.1841"></a><span id="l37.1841" class="difflineminus">-    this._ssl = this.getBool(&quot;ssl&quot;);</span>
<a href="#l37.1842"></a><span id="l37.1842" class="difflineminus">-</span>
<a href="#l37.1843"></a><span id="l37.1843" class="difflineminus">-    // Use the display name as the user's real name.</span>
<a href="#l37.1844"></a><span id="l37.1844" class="difflineminus">-    this._realname = this.imAccount.statusInfo.displayName;</span>
<a href="#l37.1845"></a><span id="l37.1845" class="difflineminus">-    this._encoding = this.getString(&quot;encoding&quot;) || &quot;UTF-8&quot;;</span>
<a href="#l37.1846"></a><span id="l37.1846" class="difflineminus">-    this._showServerTab = this.getBool(&quot;showServerTab&quot;);</span>
<a href="#l37.1847"></a><span id="l37.1847" class="difflineminus">-</span>
<a href="#l37.1848"></a><span id="l37.1848" class="difflineminus">-    // Open the socket connection.</span>
<a href="#l37.1849"></a><span id="l37.1849" class="difflineminus">-    this._socket = new ircSocket(this);</span>
<a href="#l37.1850"></a><span id="l37.1850" class="difflineminus">-    this._socket.connect(this._server, this._port, this._ssl ? [&quot;ssl&quot;] : []);</span>
<a href="#l37.1851"></a><span id="l37.1851" class="difflineminus">-  },</span>
<a href="#l37.1852"></a><span id="l37.1852" class="difflineminus">-</span>
<a href="#l37.1853"></a><span id="l37.1853" class="difflineminus">-  // Functions for keeping track of whether the Client Capabilities is done.</span>
<a href="#l37.1854"></a><span id="l37.1854" class="difflineminus">-  // If a cap is to be handled, it should be registered with addCAP, where aCAP</span>
<a href="#l37.1855"></a><span id="l37.1855" class="difflineminus">-  // is a &quot;unique&quot; string defining what is being handled. When the cap is done</span>
<a href="#l37.1856"></a><span id="l37.1856" class="difflineminus">-  // being handled removeCAP should be called with the same string.</span>
<a href="#l37.1857"></a><span id="l37.1857" class="difflineminus">-  _availableCAPs: new Set(),</span>
<a href="#l37.1858"></a><span id="l37.1858" class="difflineminus">-  _activeCAPs: new Set(),</span>
<a href="#l37.1859"></a><span id="l37.1859" class="difflineminus">-  _requestedCAPs: new Set(),</span>
<a href="#l37.1860"></a><span id="l37.1860" class="difflineminus">-  _capTimeout: null,</span>
<a href="#l37.1861"></a><span id="l37.1861" class="difflineminus">-  _negotiatedCAPs: false,</span>
<a href="#l37.1862"></a><span id="l37.1862" class="difflineminus">-  _queuedCAPs: [],</span>
<a href="#l37.1863"></a><span id="l37.1863" class="difflineminus">-  addCAP(aCAP) {</span>
<a href="#l37.1864"></a><span id="l37.1864" class="difflineminus">-    if (this.connected) {</span>
<a href="#l37.1865"></a><span id="l37.1865" class="difflineminus">-      this.ERROR(&quot;Trying to add CAP &quot; + aCAP + &quot; after connection.&quot;);</span>
<a href="#l37.1866"></a><span id="l37.1866" class="difflineminus">-      return;</span>
<a href="#l37.1867"></a><span id="l37.1867" class="difflineminus">-    }</span>
<a href="#l37.1868"></a><span id="l37.1868" class="difflineminus">-</span>
<a href="#l37.1869"></a><span id="l37.1869" class="difflineminus">-    this._requestedCAPs.add(aCAP);</span>
<a href="#l37.1870"></a><span id="l37.1870" class="difflineminus">-  },</span>
<a href="#l37.1871"></a><span id="l37.1871" class="difflineminus">-  removeCAP(aDoneCAP) {</span>
<a href="#l37.1872"></a><span id="l37.1872" class="difflineminus">-    if (!this._requestedCAPs.has(aDoneCAP)) {</span>
<a href="#l37.1873"></a><span id="l37.1873" class="difflineminus">-      this.ERROR(</span>
<a href="#l37.1874"></a><span id="l37.1874" class="difflineminus">-        &quot;Trying to remove a CAP (&quot; + aDoneCAP + &quot;) which isn't added.&quot;</span>
<a href="#l37.1875"></a><span id="l37.1875" class="difflineminus">-      );</span>
<a href="#l37.1876"></a><span id="l37.1876" class="difflineminus">-      return;</span>
<a href="#l37.1877"></a><span id="l37.1877" class="difflineminus">-    }</span>
<a href="#l37.1878"></a><span id="l37.1878" class="difflineminus">-    if (this.connected) {</span>
<a href="#l37.1879"></a><span id="l37.1879" class="difflineminus">-      this.ERROR(&quot;Trying to remove CAP &quot; + aDoneCAP + &quot; after connection.&quot;);</span>
<a href="#l37.1880"></a><span id="l37.1880" class="difflineminus">-      return;</span>
<a href="#l37.1881"></a><span id="l37.1881" class="difflineminus">-    }</span>
<a href="#l37.1882"></a><span id="l37.1882" class="difflineminus">-</span>
<a href="#l37.1883"></a><span id="l37.1883" class="difflineminus">-    // Remove any reference to the given capability.</span>
<a href="#l37.1884"></a><span id="l37.1884" class="difflineminus">-    this._requestedCAPs.delete(aDoneCAP);</span>
<a href="#l37.1885"></a><span id="l37.1885" class="difflineminus">-</span>
<a href="#l37.1886"></a><span id="l37.1886" class="difflineminus">-    // However only notify the server the first time during cap negotiation, not</span>
<a href="#l37.1887"></a><span id="l37.1887" class="difflineminus">-    // when the server exposes a new cap.</span>
<a href="#l37.1888"></a><span id="l37.1888" class="difflineminus">-    if (!this._requestedCAPs.size &amp;&amp; !this._negotiatedCAPs) {</span>
<a href="#l37.1889"></a><span id="l37.1889" class="difflineminus">-      this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l37.1890"></a><span id="l37.1890" class="difflineminus">-      this._negotiatedCAPs = true;</span>
<a href="#l37.1891"></a><span id="l37.1891" class="difflineminus">-    }</span>
<a href="#l37.1892"></a><span id="l37.1892" class="difflineminus">-  },</span>
<a href="#l37.1893"></a><span id="l37.1893" class="difflineminus">-</span>
<a href="#l37.1894"></a><span id="l37.1894" class="difflineminus">-  // Used to wait for a response from the server.</span>
<a href="#l37.1895"></a><span id="l37.1895" class="difflineminus">-  _quitTimer: null,</span>
<a href="#l37.1896"></a><span id="l37.1896" class="difflineminus">-  // RFC 2812 Section 3.1.7.</span>
<a href="#l37.1897"></a><span id="l37.1897" class="difflineminus">-  quit(aMessage) {</span>
<a href="#l37.1898"></a><span id="l37.1898" class="difflineminus">-    this._reportDisconnecting(Ci.prplIAccount.NO_ERROR);</span>
<a href="#l37.1899"></a><span id="l37.1899" class="difflineminus">-    this.sendMessage(</span>
<a href="#l37.1900"></a><span id="l37.1900" class="difflineminus">-      &quot;QUIT&quot;,</span>
<a href="#l37.1901"></a><span id="l37.1901" class="difflineminus">-      aMessage || this.getString(&quot;quitmsg&quot;) || undefined</span>
<a href="#l37.1902"></a><span id="l37.1902" class="difflineminus">-    );</span>
<a href="#l37.1903"></a><span id="l37.1903" class="difflineminus">-  },</span>
<a href="#l37.1904"></a><span id="l37.1904" class="difflineminus">-  // When the user clicks &quot;Disconnect&quot; in account manager, or uses /quit.</span>
<a href="#l37.1905"></a><span id="l37.1905" class="difflineminus">-  // aMessage is an optional parameter containing the quit message.</span>
<a href="#l37.1906"></a><span id="l37.1906" class="difflineminus">-  disconnect(aMessage) {</span>
<a href="#l37.1907"></a><span id="l37.1907" class="difflineminus">-    if (this.disconnected || this.disconnecting) {</span>
<a href="#l37.1908"></a><span id="l37.1908" class="difflineminus">-      return;</span>
<a href="#l37.1909"></a><span id="l37.1909" class="difflineminus">-    }</span>
<a href="#l37.1910"></a><span id="l37.1910" class="difflineminus">-</span>
<a href="#l37.1911"></a><span id="l37.1911" class="difflineminus">-    // If there's no socket, disconnect immediately to avoid waiting 2 seconds.</span>
<a href="#l37.1912"></a><span id="l37.1912" class="difflineminus">-    if (!this._socket || this._socket.disconnected) {</span>
<a href="#l37.1913"></a><span id="l37.1913" class="difflineminus">-      this.gotDisconnected();</span>
<a href="#l37.1914"></a><span id="l37.1914" class="difflineminus">-      return;</span>
<a href="#l37.1915"></a><span id="l37.1915" class="difflineminus">-    }</span>
<a href="#l37.1916"></a><span id="l37.1916" class="difflineminus">-</span>
<a href="#l37.1917"></a><span id="l37.1917" class="difflineminus">-    // Let the server know we're going to disconnect.</span>
<a href="#l37.1918"></a><span id="l37.1918" class="difflineminus">-    this.quit(aMessage);</span>
<a href="#l37.1919"></a><span id="l37.1919" class="difflineminus">-</span>
<a href="#l37.1920"></a><span id="l37.1920" class="difflineminus">-    // Reset original nickname for the next reconnect.</span>
<a href="#l37.1921"></a><span id="l37.1921" class="difflineminus">-    this._requestedNickname = this._accountNickname;</span>
<a href="#l37.1922"></a><span id="l37.1922" class="difflineminus">-</span>
<a href="#l37.1923"></a><span id="l37.1923" class="difflineminus">-    // Give the server 2 seconds to respond, otherwise just forcefully</span>
<a href="#l37.1924"></a><span id="l37.1924" class="difflineminus">-    // disconnect the socket. This will be cancelled if a response is heard from</span>
<a href="#l37.1925"></a><span id="l37.1925" class="difflineminus">-    // the server.</span>
<a href="#l37.1926"></a><span id="l37.1926" class="difflineminus">-    this._quitTimer = setTimeout(this.gotDisconnected.bind(this), 2 * 1000);</span>
<a href="#l37.1927"></a><span id="l37.1927" class="difflineminus">-  },</span>
<a href="#l37.1928"></a><span id="l37.1928" class="difflineminus">-</span>
<a href="#l37.1929"></a><span id="l37.1929" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l37.1930"></a><span id="l37.1930" class="difflineminus">-    return this.getConversation(aName);</span>
<a href="#l37.1931"></a><span id="l37.1931" class="difflineminus">-  },</span>
<a href="#l37.1932"></a><span id="l37.1932" class="difflineminus">-</span>
<a href="#l37.1933"></a><span id="l37.1933" class="difflineminus">-  // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l37.1934"></a><span id="l37.1934" class="difflineminus">-  joinChat(aComponents) {</span>
<a href="#l37.1935"></a><span id="l37.1935" class="difflineminus">-    let channel = aComponents.getValue(&quot;channel&quot;);</span>
<a href="#l37.1936"></a><span id="l37.1936" class="difflineminus">-    // Mildly sanitize input.</span>
<a href="#l37.1937"></a><span id="l37.1937" class="difflineminus">-    channel = channel</span>
<a href="#l37.1938"></a><span id="l37.1938" class="difflineminus">-      .trimLeft()</span>
<a href="#l37.1939"></a><span id="l37.1939" class="difflineminus">-      .split(&quot;,&quot;)[0]</span>
<a href="#l37.1940"></a><span id="l37.1940" class="difflineminus">-      .split(&quot; &quot;)[0];</span>
<a href="#l37.1941"></a><span id="l37.1941" class="difflineminus">-    if (!channel) {</span>
<a href="#l37.1942"></a><span id="l37.1942" class="difflineminus">-      this.ERROR(&quot;joinChat called without a valid channel name.&quot;);</span>
<a href="#l37.1943"></a><span id="l37.1943" class="difflineminus">-      return null;</span>
<a href="#l37.1944"></a><span id="l37.1944" class="difflineminus">-    }</span>
<a href="#l37.1945"></a><span id="l37.1945" class="difflineminus">-</span>
<a href="#l37.1946"></a><span id="l37.1946" class="difflineminus">-    // A channel prefix is required. If the user didn't include one,</span>
<a href="#l37.1947"></a><span id="l37.1947" class="difflineminus">-    // we prepend # automatically to match the behavior of other</span>
<a href="#l37.1948"></a><span id="l37.1948" class="difflineminus">-    // clients. Not doing it used to cause user confusion.</span>
<a href="#l37.1949"></a><span id="l37.1949" class="difflineminus">-    if (!this.channelPrefixes.includes(channel[0])) {</span>
<a href="#l37.1950"></a><span id="l37.1950" class="difflineminus">-      channel = &quot;#&quot; + channel;</span>
<a href="#l37.1951"></a><span id="l37.1951" class="difflineminus">-    }</span>
<a href="#l37.1952"></a><span id="l37.1952" class="difflineminus">-</span>
<a href="#l37.1953"></a><span id="l37.1953" class="difflineminus">-    if (this.conversations.has(channel)) {</span>
<a href="#l37.1954"></a><span id="l37.1954" class="difflineminus">-      let conv = this.getConversation(channel);</span>
<a href="#l37.1955"></a><span id="l37.1955" class="difflineminus">-      if (!conv.left) {</span>
<a href="#l37.1956"></a><span id="l37.1956" class="difflineminus">-        // No need to join a channel we are already in.</span>
<a href="#l37.1957"></a><span id="l37.1957" class="difflineminus">-        return conv;</span>
<a href="#l37.1958"></a><span id="l37.1958" class="difflineminus">-      } else if (!conv.chatRoomFields) {</span>
<a href="#l37.1959"></a><span id="l37.1959" class="difflineminus">-        // We are rejoining a channel that was parted by the user.</span>
<a href="#l37.1960"></a><span id="l37.1960" class="difflineminus">-        conv._rejoined = true;</span>
<a href="#l37.1961"></a><span id="l37.1961" class="difflineminus">-      }</span>
<a href="#l37.1962"></a><span id="l37.1962" class="difflineminus">-    }</span>
<a href="#l37.1963"></a><span id="l37.1963" class="difflineminus">-</span>
<a href="#l37.1964"></a><span id="l37.1964" class="difflineminus">-    let key = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l37.1965"></a><span id="l37.1965" class="difflineminus">-    this.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l37.1966"></a><span id="l37.1966" class="difflineminus">-</span>
<a href="#l37.1967"></a><span id="l37.1967" class="difflineminus">-    // Open conversation early for better responsiveness.</span>
<a href="#l37.1968"></a><span id="l37.1968" class="difflineminus">-    let conv = this.getConversation(channel);</span>
<a href="#l37.1969"></a><span id="l37.1969" class="difflineminus">-    conv.joining = true;</span>
<a href="#l37.1970"></a><span id="l37.1970" class="difflineminus">-</span>
<a href="#l37.1971"></a><span id="l37.1971" class="difflineminus">-    // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l37.1972"></a><span id="l37.1972" class="difflineminus">-    let defaultName = key ? channel + &quot; &quot; + key : channel;</span>
<a href="#l37.1973"></a><span id="l37.1973" class="difflineminus">-    conv.chatRoomFields = this.getChatRoomDefaultFieldValues(defaultName);</span>
<a href="#l37.1974"></a><span id="l37.1974" class="difflineminus">-</span>
<a href="#l37.1975"></a><span id="l37.1975" class="difflineminus">-    return conv;</span>
<a href="#l37.1976"></a><span id="l37.1976" class="difflineminus">-  },</span>
<a href="#l37.1977"></a><span id="l37.1977" class="difflineminus">-</span>
<a href="#l37.1978"></a><span id="l37.1978" class="difflineminus">-  chatRoomFields: {</span>
<a href="#l37.1979"></a><span id="l37.1979" class="difflineminus">-    channel: {</span>
<a href="#l37.1980"></a><span id="l37.1980" class="difflineminus">-      get label() {</span>
<a href="#l37.1981"></a><span id="l37.1981" class="difflineminus">-        return _(&quot;joinChat.channel&quot;);</span>
<a href="#l37.1982"></a><span id="l37.1982" class="difflineminus">-      },</span>
<a href="#l37.1983"></a><span id="l37.1983" class="difflineminus">-      required: true,</span>
<a href="#l37.1984"></a><span id="l37.1984" class="difflineminus">-    },</span>
<a href="#l37.1985"></a><span id="l37.1985" class="difflineminus">-    password: {</span>
<a href="#l37.1986"></a><span id="l37.1986" class="difflineminus">-      get label() {</span>
<a href="#l37.1987"></a><span id="l37.1987" class="difflineminus">-        return _(&quot;joinChat.password&quot;);</span>
<a href="#l37.1988"></a><span id="l37.1988" class="difflineminus">-      },</span>
<a href="#l37.1989"></a><span id="l37.1989" class="difflineminus">-      isPassword: true,</span>
<a href="#l37.1990"></a><span id="l37.1990" class="difflineminus">-    },</span>
<a href="#l37.1991"></a><span id="l37.1991" class="difflineminus">-  },</span>
<a href="#l37.1992"></a><span id="l37.1992" class="difflineminus">-</span>
<a href="#l37.1993"></a><span id="l37.1993" class="difflineminus">-  parseDefaultChatName(aDefaultName) {</span>
<a href="#l37.1994"></a><span id="l37.1994" class="difflineminus">-    let params = aDefaultName.trim().split(/\s+/);</span>
<a href="#l37.1995"></a><span id="l37.1995" class="difflineminus">-    let chatFields = { channel: params[0] };</span>
<a href="#l37.1996"></a><span id="l37.1996" class="difflineminus">-    if (params.length &gt; 1) {</span>
<a href="#l37.1997"></a><span id="l37.1997" class="difflineminus">-      chatFields.password = params[1];</span>
<a href="#l37.1998"></a><span id="l37.1998" class="difflineminus">-    }</span>
<a href="#l37.1999"></a><span id="l37.1999" class="difflineminus">-    return chatFields;</span>
<a href="#l37.2000"></a><span id="l37.2000" class="difflineminus">-  },</span>
<a href="#l37.2001"></a><span id="l37.2001" class="difflineminus">-</span>
<a href="#l37.2002"></a><span id="l37.2002" class="difflineminus">-  // Attributes</span>
<a href="#l37.2003"></a><span id="l37.2003" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l37.2004"></a><span id="l37.2004" class="difflineminus">-    return true;</span>
<a href="#l37.2005"></a><span id="l37.2005" class="difflineminus">-  },</span>
<a href="#l37.2006"></a><span id="l37.2006" class="difflineminus">-</span>
<a href="#l37.2007"></a><span id="l37.2007" class="difflineminus">-  // Returns a conversation (creates it if it doesn't exist)</span>
<a href="#l37.2008"></a><span id="l37.2008" class="difflineminus">-  getConversation(aName) {</span>
<a href="#l37.2009"></a><span id="l37.2009" class="difflineminus">-    if (!this.conversations.has(aName)) {</span>
<a href="#l37.2010"></a><span id="l37.2010" class="difflineminus">-      // If the whois information has been received, we have the proper nick</span>
<a href="#l37.2011"></a><span id="l37.2011" class="difflineminus">-      // capitalization.</span>
<a href="#l37.2012"></a><span id="l37.2012" class="difflineminus">-      if (this.whoisInformation.has(aName)) {</span>
<a href="#l37.2013"></a><span id="l37.2013" class="difflineminus">-        aName = this.whoisInformation.get(aName).nick;</span>
<a href="#l37.2014"></a><span id="l37.2014" class="difflineminus">-      }</span>
<a href="#l37.2015"></a><span id="l37.2015" class="difflineminus">-      let convClass = this.isMUCName(aName) ? IRCChannel : IRCConversation;</span>
<a href="#l37.2016"></a><span id="l37.2016" class="difflineminus">-      this.conversations.set(aName, new convClass(this, aName, this._nickname));</span>
<a href="#l37.2017"></a><span id="l37.2017" class="difflineminus">-    }</span>
<a href="#l37.2018"></a><span id="l37.2018" class="difflineminus">-    return this.conversations.get(aName);</span>
<a href="#l37.2019"></a><span id="l37.2019" class="difflineminus">-  },</span>
<a href="#l37.2020"></a><span id="l37.2020" class="difflineminus">-</span>
<a href="#l37.2021"></a><span id="l37.2021" class="difflineminus">-  removeConversation(aConversationName) {</span>
<a href="#l37.2022"></a><span id="l37.2022" class="difflineminus">-    if (this.conversations.has(aConversationName)) {</span>
<a href="#l37.2023"></a><span id="l37.2023" class="difflineminus">-      this.conversations.delete(aConversationName);</span>
<a href="#l37.2024"></a><span id="l37.2024" class="difflineminus">-    }</span>
<a href="#l37.2025"></a><span id="l37.2025" class="difflineminus">-  },</span>
<a href="#l37.2026"></a><span id="l37.2026" class="difflineminus">-</span>
<a href="#l37.2027"></a><span id="l37.2027" class="difflineminus">-  // This builds the message string that will be sent to the server.</span>
<a href="#l37.2028"></a><span id="l37.2028" class="difflineminus">-  buildMessage(aCommand, aParams = []) {</span>
<a href="#l37.2029"></a><span id="l37.2029" class="difflineminus">-    if (!aCommand) {</span>
<a href="#l37.2030"></a><span id="l37.2030" class="difflineminus">-      this.ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l37.2031"></a><span id="l37.2031" class="difflineminus">-      return null;</span>
<a href="#l37.2032"></a><span id="l37.2032" class="difflineminus">-    }</span>
<a href="#l37.2033"></a><span id="l37.2033" class="difflineminus">-</span>
<a href="#l37.2034"></a><span id="l37.2034" class="difflineminus">-    // Ensure a command is only characters or numbers.</span>
<a href="#l37.2035"></a><span id="l37.2035" class="difflineminus">-    if (!/^[A-Z0-9]+$/i.test(aCommand)) {</span>
<a href="#l37.2036"></a><span id="l37.2036" class="difflineminus">-      this.ERROR(&quot;IRC command invalid: &quot; + aCommand);</span>
<a href="#l37.2037"></a><span id="l37.2037" class="difflineminus">-      return null;</span>
<a href="#l37.2038"></a><span id="l37.2038" class="difflineminus">-    }</span>
<a href="#l37.2039"></a><span id="l37.2039" class="difflineminus">-</span>
<a href="#l37.2040"></a><span id="l37.2040" class="difflineminus">-    let message = aCommand;</span>
<a href="#l37.2041"></a><span id="l37.2041" class="difflineminus">-    // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l37.2042"></a><span id="l37.2042" class="difflineminus">-    // it into an array.</span>
<a href="#l37.2043"></a><span id="l37.2043" class="difflineminus">-    let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l37.2044"></a><span id="l37.2044" class="difflineminus">-    if (params.length) {</span>
<a href="#l37.2045"></a><span id="l37.2045" class="difflineminus">-      if (params.slice(0, -1).some(p =&gt; p.includes(&quot; &quot;))) {</span>
<a href="#l37.2046"></a><span id="l37.2046" class="difflineminus">-        this.ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l37.2047"></a><span id="l37.2047" class="difflineminus">-        return null;</span>
<a href="#l37.2048"></a><span id="l37.2048" class="difflineminus">-      }</span>
<a href="#l37.2049"></a><span id="l37.2049" class="difflineminus">-      // Join the parameters with spaces. There are three cases in which the</span>
<a href="#l37.2050"></a><span id="l37.2050" class="difflineminus">-      // last parameter (&quot;trailing&quot; in RFC 2812) must be prepended with a colon:</span>
<a href="#l37.2051"></a><span id="l37.2051" class="difflineminus">-      //  1. If the last parameter contains a space.</span>
<a href="#l37.2052"></a><span id="l37.2052" class="difflineminus">-      //  2. If the first character of the last parameter is a colon.</span>
<a href="#l37.2053"></a><span id="l37.2053" class="difflineminus">-      //  3. If the last parameter is an empty string.</span>
<a href="#l37.2054"></a><span id="l37.2054" class="difflineminus">-      let trailing = params.slice(-1)[0];</span>
<a href="#l37.2055"></a><span id="l37.2055" class="difflineminus">-      if (</span>
<a href="#l37.2056"></a><span id="l37.2056" class="difflineminus">-        !trailing.length ||</span>
<a href="#l37.2057"></a><span id="l37.2057" class="difflineminus">-        trailing.includes(&quot; &quot;) ||</span>
<a href="#l37.2058"></a><span id="l37.2058" class="difflineminus">-        trailing.startsWith(&quot;:&quot;)</span>
<a href="#l37.2059"></a><span id="l37.2059" class="difflineminus">-      ) {</span>
<a href="#l37.2060"></a><span id="l37.2060" class="difflineminus">-        params.push(&quot;:&quot; + params.pop());</span>
<a href="#l37.2061"></a><span id="l37.2061" class="difflineminus">-      }</span>
<a href="#l37.2062"></a><span id="l37.2062" class="difflineminus">-      message += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l37.2063"></a><span id="l37.2063" class="difflineminus">-    }</span>
<a href="#l37.2064"></a><span id="l37.2064" class="difflineminus">-</span>
<a href="#l37.2065"></a><span id="l37.2065" class="difflineminus">-    return message;</span>
<a href="#l37.2066"></a><span id="l37.2066" class="difflineminus">-  },</span>
<a href="#l37.2067"></a><span id="l37.2067" class="difflineminus">-</span>
<a href="#l37.2068"></a><span id="l37.2068" class="difflineminus">-  // Shortcut method to build &amp; send a message at once. Use aLoggedData to log</span>
<a href="#l37.2069"></a><span id="l37.2069" class="difflineminus">-  // something different than what is actually sent.</span>
<a href="#l37.2070"></a><span id="l37.2070" class="difflineminus">-  // Returns false if the message could not be sent.</span>
<a href="#l37.2071"></a><span id="l37.2071" class="difflineminus">-  sendMessage(aCommand, aParams, aLoggedData) {</span>
<a href="#l37.2072"></a><span id="l37.2072" class="difflineminus">-    return this.sendRawMessage(</span>
<a href="#l37.2073"></a><span id="l37.2073" class="difflineminus">-      this.buildMessage(aCommand, aParams),</span>
<a href="#l37.2074"></a><span id="l37.2074" class="difflineminus">-      aLoggedData</span>
<a href="#l37.2075"></a><span id="l37.2075" class="difflineminus">-    );</span>
<a href="#l37.2076"></a><span id="l37.2076" class="difflineminus">-  },</span>
<a href="#l37.2077"></a><span id="l37.2077" class="difflineminus">-</span>
<a href="#l37.2078"></a><span id="l37.2078" class="difflineminus">-  // This sends a message over the socket and catches any errors. Use</span>
<a href="#l37.2079"></a><span id="l37.2079" class="difflineminus">-  // aLoggedData to log something different than what is actually sent.</span>
<a href="#l37.2080"></a><span id="l37.2080" class="difflineminus">-  // Returns false if the message could not be sent.</span>
<a href="#l37.2081"></a><span id="l37.2081" class="difflineminus">-  sendRawMessage(aMessage, aLoggedData) {</span>
<a href="#l37.2082"></a><span id="l37.2082" class="difflineminus">-    // Low level quoting, replace \0, \n, \r or \020 with \0200, \020n, \020r or</span>
<a href="#l37.2083"></a><span id="l37.2083" class="difflineminus">-    // \020\020, respectively.</span>
<a href="#l37.2084"></a><span id="l37.2084" class="difflineminus">-    const lowQuote = { &quot;\0&quot;: &quot;0&quot;, &quot;\n&quot;: &quot;n&quot;, &quot;\r&quot;: &quot;r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l37.2085"></a><span id="l37.2085" class="difflineminus">-    const lowRegex = new RegExp(</span>
<a href="#l37.2086"></a><span id="l37.2086" class="difflineminus">-      &quot;[&quot; + Object.keys(lowQuote).join(&quot;&quot;) + &quot;]&quot;,</span>
<a href="#l37.2087"></a><span id="l37.2087" class="difflineminus">-      &quot;g&quot;</span>
<a href="#l37.2088"></a><span id="l37.2088" class="difflineminus">-    );</span>
<a href="#l37.2089"></a><span id="l37.2089" class="difflineminus">-    aMessage = aMessage.replace(lowRegex, aChar =&gt; &quot;\x10&quot; + lowQuote[aChar]);</span>
<a href="#l37.2090"></a><span id="l37.2090" class="difflineminus">-</span>
<a href="#l37.2091"></a><span id="l37.2091" class="difflineminus">-    if (!this._socket || this._socket.disconnected) {</span>
<a href="#l37.2092"></a><span id="l37.2092" class="difflineminus">-      this.gotDisconnected(</span>
<a href="#l37.2093"></a><span id="l37.2093" class="difflineminus">-        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l37.2094"></a><span id="l37.2094" class="difflineminus">-        _(&quot;connection.error.lost&quot;)</span>
<a href="#l37.2095"></a><span id="l37.2095" class="difflineminus">-      );</span>
<a href="#l37.2096"></a><span id="l37.2096" class="difflineminus">-    }</span>
<a href="#l37.2097"></a><span id="l37.2097" class="difflineminus">-</span>
<a href="#l37.2098"></a><span id="l37.2098" class="difflineminus">-    let length = this.countBytes(aMessage) + 2;</span>
<a href="#l37.2099"></a><span id="l37.2099" class="difflineminus">-    if (length &gt; this.maxMessageLength) {</span>
<a href="#l37.2100"></a><span id="l37.2100" class="difflineminus">-      // Log if the message is too long, but try to send it anyway.</span>
<a href="#l37.2101"></a><span id="l37.2101" class="difflineminus">-      this.WARN(</span>
<a href="#l37.2102"></a><span id="l37.2102" class="difflineminus">-        &quot;Message length too long (&quot; +</span>
<a href="#l37.2103"></a><span id="l37.2103" class="difflineminus">-          length +</span>
<a href="#l37.2104"></a><span id="l37.2104" class="difflineminus">-          &quot; &gt; &quot; +</span>
<a href="#l37.2105"></a><span id="l37.2105" class="difflineminus">-          this.maxMessageLength +</span>
<a href="#l37.2106"></a><span id="l37.2106" class="difflineminus">-          &quot;\n&quot; +</span>
<a href="#l37.2107"></a><span id="l37.2107" class="difflineminus">-          aMessage</span>
<a href="#l37.2108"></a><span id="l37.2108" class="difflineminus">-      );</span>
<a href="#l37.2109"></a><span id="l37.2109" class="difflineminus">-    }</span>
<a href="#l37.2110"></a><span id="l37.2110" class="difflineminus">-</span>
<a href="#l37.2111"></a><span id="l37.2111" class="difflineminus">-    aMessage += &quot;\r\n&quot;;</span>
<a href="#l37.2112"></a><span id="l37.2112" class="difflineminus">-</span>
<a href="#l37.2113"></a><span id="l37.2113" class="difflineminus">-    try {</span>
<a href="#l37.2114"></a><span id="l37.2114" class="difflineminus">-      this._socket.sendString(aMessage, this._encoding, aLoggedData);</span>
<a href="#l37.2115"></a><span id="l37.2115" class="difflineminus">-      return true;</span>
<a href="#l37.2116"></a><span id="l37.2116" class="difflineminus">-    } catch (e) {</span>
<a href="#l37.2117"></a><span id="l37.2117" class="difflineminus">-      try {</span>
<a href="#l37.2118"></a><span id="l37.2118" class="difflineminus">-        this._socket.sendData(aMessage, aLoggedData);</span>
<a href="#l37.2119"></a><span id="l37.2119" class="difflineminus">-        this.WARN(</span>
<a href="#l37.2120"></a><span id="l37.2120" class="difflineminus">-          &quot;Failed to convert &quot; +</span>
<a href="#l37.2121"></a><span id="l37.2121" class="difflineminus">-            aMessage +</span>
<a href="#l37.2122"></a><span id="l37.2122" class="difflineminus">-            &quot; from Unicode to &quot; +</span>
<a href="#l37.2123"></a><span id="l37.2123" class="difflineminus">-            this._encoding +</span>
<a href="#l37.2124"></a><span id="l37.2124" class="difflineminus">-            &quot;.&quot;</span>
<a href="#l37.2125"></a><span id="l37.2125" class="difflineminus">-        );</span>
<a href="#l37.2126"></a><span id="l37.2126" class="difflineminus">-        return true;</span>
<a href="#l37.2127"></a><span id="l37.2127" class="difflineminus">-      } catch (e) {</span>
<a href="#l37.2128"></a><span id="l37.2128" class="difflineminus">-        this.ERROR(&quot;Socket error:&quot;, e);</span>
<a href="#l37.2129"></a><span id="l37.2129" class="difflineminus">-        this.gotDisconnected(</span>
<a href="#l37.2130"></a><span id="l37.2130" class="difflineminus">-          Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l37.2131"></a><span id="l37.2131" class="difflineminus">-          _(&quot;connection.error.lost&quot;)</span>
<a href="#l37.2132"></a><span id="l37.2132" class="difflineminus">-        );</span>
<a href="#l37.2133"></a><span id="l37.2133" class="difflineminus">-        return false;</span>
<a href="#l37.2134"></a><span id="l37.2134" class="difflineminus">-      }</span>
<a href="#l37.2135"></a><span id="l37.2135" class="difflineminus">-    }</span>
<a href="#l37.2136"></a><span id="l37.2136" class="difflineminus">-  },</span>
<a href="#l37.2137"></a><span id="l37.2137" class="difflineminus">-</span>
<a href="#l37.2138"></a><span id="l37.2138" class="difflineminus">-  // CTCP messages are \001&lt;COMMAND&gt; [&lt;parameters&gt;]*\001.</span>
<a href="#l37.2139"></a><span id="l37.2139" class="difflineminus">-  // Returns false if the message could not be sent.</span>
<a href="#l37.2140"></a><span id="l37.2140" class="difflineminus">-  sendCTCPMessage(aTarget, aIsNotice, aCtcpCommand, aParams = []) {</span>
<a href="#l37.2141"></a><span id="l37.2141" class="difflineminus">-    // Combine the CTCP command and parameters into the single IRC param.</span>
<a href="#l37.2142"></a><span id="l37.2142" class="difflineminus">-    let ircParam = aCtcpCommand;</span>
<a href="#l37.2143"></a><span id="l37.2143" class="difflineminus">-    // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l37.2144"></a><span id="l37.2144" class="difflineminus">-    // it into an array.</span>
<a href="#l37.2145"></a><span id="l37.2145" class="difflineminus">-    let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l37.2146"></a><span id="l37.2146" class="difflineminus">-    if (params.length) {</span>
<a href="#l37.2147"></a><span id="l37.2147" class="difflineminus">-      ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l37.2148"></a><span id="l37.2148" class="difflineminus">-    }</span>
<a href="#l37.2149"></a><span id="l37.2149" class="difflineminus">-</span>
<a href="#l37.2150"></a><span id="l37.2150" class="difflineminus">-    // High/CTCP level quoting, replace \134 or \001 with \134\134 or \134a,</span>
<a href="#l37.2151"></a><span id="l37.2151" class="difflineminus">-    // respectively. This is only done inside the extended data message.</span>
<a href="#l37.2152"></a><span id="l37.2152" class="difflineminus">-    // eslint-disable-next-line no-control-regex</span>
<a href="#l37.2153"></a><span id="l37.2153" class="difflineminus">-    const highRegex = /\\|\x01/g;</span>
<a href="#l37.2154"></a><span id="l37.2154" class="difflineminus">-    ircParam = ircParam.replace(</span>
<a href="#l37.2155"></a><span id="l37.2155" class="difflineminus">-      highRegex,</span>
<a href="#l37.2156"></a><span id="l37.2156" class="difflineminus">-      aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;)</span>
<a href="#l37.2157"></a><span id="l37.2157" class="difflineminus">-    );</span>
<a href="#l37.2158"></a><span id="l37.2158" class="difflineminus">-</span>
<a href="#l37.2159"></a><span id="l37.2159" class="difflineminus">-    // Add the CTCP tagging.</span>
<a href="#l37.2160"></a><span id="l37.2160" class="difflineminus">-    ircParam = &quot;\x01&quot; + ircParam + &quot;\x01&quot;;</span>
<a href="#l37.2161"></a><span id="l37.2161" class="difflineminus">-</span>
<a href="#l37.2162"></a><span id="l37.2162" class="difflineminus">-    // Send the IRC message as a NOTICE or PRIVMSG.</span>
<a href="#l37.2163"></a><span id="l37.2163" class="difflineminus">-    return this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l37.2164"></a><span id="l37.2164" class="difflineminus">-      aTarget,</span>
<a href="#l37.2165"></a><span id="l37.2165" class="difflineminus">-      ircParam,</span>
<a href="#l37.2166"></a><span id="l37.2166" class="difflineminus">-    ]);</span>
<a href="#l37.2167"></a><span id="l37.2167" class="difflineminus">-  },</span>
<a href="#l37.2168"></a><span id="l37.2168" class="difflineminus">-</span>
<a href="#l37.2169"></a><span id="l37.2169" class="difflineminus">-  // Implement section 3.1 of RFC 2812</span>
<a href="#l37.2170"></a><span id="l37.2170" class="difflineminus">-  _connectionRegistration() {</span>
<a href="#l37.2171"></a><span id="l37.2171" class="difflineminus">-    // Send the Client Capabilities list command version 3.2.</span>
<a href="#l37.2172"></a><span id="l37.2172" class="difflineminus">-    this.sendMessage(&quot;CAP&quot;, [&quot;LS&quot;, &quot;302&quot;]);</span>
<a href="#l37.2173"></a><span id="l37.2173" class="difflineminus">-</span>
<a href="#l37.2174"></a><span id="l37.2174" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;serverPassword&quot;)) {</span>
<a href="#l37.2175"></a><span id="l37.2175" class="difflineminus">-      this.sendMessage(</span>
<a href="#l37.2176"></a><span id="l37.2176" class="difflineminus">-        &quot;PASS&quot;,</span>
<a href="#l37.2177"></a><span id="l37.2177" class="difflineminus">-        this.getString(&quot;serverPassword&quot;),</span>
<a href="#l37.2178"></a><span id="l37.2178" class="difflineminus">-        &quot;PASS &lt;password not logged&gt;&quot;</span>
<a href="#l37.2179"></a><span id="l37.2179" class="difflineminus">-      );</span>
<a href="#l37.2180"></a><span id="l37.2180" class="difflineminus">-    }</span>
<a href="#l37.2181"></a><span id="l37.2181" class="difflineminus">-</span>
<a href="#l37.2182"></a><span id="l37.2182" class="difflineminus">-    // Send the nick message (section 3.1.2).</span>
<a href="#l37.2183"></a><span id="l37.2183" class="difflineminus">-    this.changeNick(this._requestedNickname);</span>
<a href="#l37.2184"></a><span id="l37.2184" class="difflineminus">-</span>
<a href="#l37.2185"></a><span id="l37.2185" class="difflineminus">-    // Send the user message (section 3.1.3).</span>
<a href="#l37.2186"></a><span id="l37.2186" class="difflineminus">-    this.sendMessage(&quot;USER&quot;, [</span>
<a href="#l37.2187"></a><span id="l37.2187" class="difflineminus">-      this.username,</span>
<a href="#l37.2188"></a><span id="l37.2188" class="difflineminus">-      this._mode.toString(),</span>
<a href="#l37.2189"></a><span id="l37.2189" class="difflineminus">-      &quot;*&quot;,</span>
<a href="#l37.2190"></a><span id="l37.2190" class="difflineminus">-      this._realname || this._requestedNickname,</span>
<a href="#l37.2191"></a><span id="l37.2191" class="difflineminus">-    ]);</span>
<a href="#l37.2192"></a><span id="l37.2192" class="difflineminus">-  },</span>
<a href="#l37.2193"></a><span id="l37.2193" class="difflineminus">-</span>
<a href="#l37.2194"></a><span id="l37.2194" class="difflineminus">-  _reportDisconnecting(aErrorReason, aErrorMessage) {</span>
<a href="#l37.2195"></a><span id="l37.2195" class="difflineminus">-    this.reportDisconnecting(aErrorReason, aErrorMessage);</span>
<a href="#l37.2196"></a><span id="l37.2196" class="difflineminus">-</span>
<a href="#l37.2197"></a><span id="l37.2197" class="difflineminus">-    // Cancel any pending buffered commands.</span>
<a href="#l37.2198"></a><span id="l37.2198" class="difflineminus">-    this._commandBuffers.clear();</span>
<a href="#l37.2199"></a><span id="l37.2199" class="difflineminus">-</span>
<a href="#l37.2200"></a><span id="l37.2200" class="difflineminus">-    // Mark all contacts on the account as having an unknown status.</span>
<a href="#l37.2201"></a><span id="l37.2201" class="difflineminus">-    this.buddies.forEach(aBuddy =&gt;</span>
<a href="#l37.2202"></a><span id="l37.2202" class="difflineminus">-      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l37.2203"></a><span id="l37.2203" class="difflineminus">-    );</span>
<a href="#l37.2204"></a><span id="l37.2204" class="difflineminus">-  },</span>
<a href="#l37.2205"></a><span id="l37.2205" class="difflineminus">-</span>
<a href="#l37.2206"></a><span id="l37.2206" class="difflineminus">-  gotDisconnected(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;) {</span>
<a href="#l37.2207"></a><span id="l37.2207" class="difflineminus">-    if (!this.imAccount || this.disconnected) {</span>
<a href="#l37.2208"></a><span id="l37.2208" class="difflineminus">-      return;</span>
<a href="#l37.2209"></a><span id="l37.2209" class="difflineminus">-    }</span>
<a href="#l37.2210"></a><span id="l37.2210" class="difflineminus">-</span>
<a href="#l37.2211"></a><span id="l37.2211" class="difflineminus">-    // If we are already disconnecting, this call to gotDisconnected</span>
<a href="#l37.2212"></a><span id="l37.2212" class="difflineminus">-    // is when the server acknowledges our disconnection.</span>
<a href="#l37.2213"></a><span id="l37.2213" class="difflineminus">-    // Otherwise it's because we lost the connection.</span>
<a href="#l37.2214"></a><span id="l37.2214" class="difflineminus">-    if (!this.disconnecting) {</span>
<a href="#l37.2215"></a><span id="l37.2215" class="difflineminus">-      this._reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l37.2216"></a><span id="l37.2216" class="difflineminus">-    }</span>
<a href="#l37.2217"></a><span id="l37.2217" class="difflineminus">-    this._socket.disconnect();</span>
<a href="#l37.2218"></a><span id="l37.2218" class="difflineminus">-    delete this._socket;</span>
<a href="#l37.2219"></a><span id="l37.2219" class="difflineminus">-</span>
<a href="#l37.2220"></a><span id="l37.2220" class="difflineminus">-    this._requestedCAPs.clear();</span>
<a href="#l37.2221"></a><span id="l37.2221" class="difflineminus">-    this._availableCAPs.clear();</span>
<a href="#l37.2222"></a><span id="l37.2222" class="difflineminus">-    this._activeCAPs.clear();</span>
<a href="#l37.2223"></a><span id="l37.2223" class="difflineminus">-    this._queuedCAPs.length = 0;</span>
<a href="#l37.2224"></a><span id="l37.2224" class="difflineminus">-</span>
<a href="#l37.2225"></a><span id="l37.2225" class="difflineminus">-    clearTimeout(this._isOnTimer);</span>
<a href="#l37.2226"></a><span id="l37.2226" class="difflineminus">-    delete this._isOnTimer;</span>
<a href="#l37.2227"></a><span id="l37.2227" class="difflineminus">-</span>
<a href="#l37.2228"></a><span id="l37.2228" class="difflineminus">-    // No need to call gotDisconnected a second time.</span>
<a href="#l37.2229"></a><span id="l37.2229" class="difflineminus">-    clearTimeout(this._quitTimer);</span>
<a href="#l37.2230"></a><span id="l37.2230" class="difflineminus">-    delete this._quitTimer;</span>
<a href="#l37.2231"></a><span id="l37.2231" class="difflineminus">-</span>
<a href="#l37.2232"></a><span id="l37.2232" class="difflineminus">-    // MOTD will be resent.</span>
<a href="#l37.2233"></a><span id="l37.2233" class="difflineminus">-    delete this._motd;</span>
<a href="#l37.2234"></a><span id="l37.2234" class="difflineminus">-    clearTimeout(this._motdTimer);</span>
<a href="#l37.2235"></a><span id="l37.2235" class="difflineminus">-    delete this._motdTimer;</span>
<a href="#l37.2236"></a><span id="l37.2236" class="difflineminus">-</span>
<a href="#l37.2237"></a><span id="l37.2237" class="difflineminus">-    // We must authenticate if we reconnect.</span>
<a href="#l37.2238"></a><span id="l37.2238" class="difflineminus">-    delete this.isAuthenticated;</span>
<a href="#l37.2239"></a><span id="l37.2239" class="difflineminus">-</span>
<a href="#l37.2240"></a><span id="l37.2240" class="difflineminus">-    // Clear any pending attempt to regain our nick.</span>
<a href="#l37.2241"></a><span id="l37.2241" class="difflineminus">-    clearTimeout(this._nickInUseTimeout);</span>
<a href="#l37.2242"></a><span id="l37.2242" class="difflineminus">-    delete this._nickInUseTimeout;</span>
<a href="#l37.2243"></a><span id="l37.2243" class="difflineminus">-</span>
<a href="#l37.2244"></a><span id="l37.2244" class="difflineminus">-    // Clean up each conversation: mark as left and remove participant.</span>
<a href="#l37.2245"></a><span id="l37.2245" class="difflineminus">-    this.conversations.forEach(conversation =&gt; {</span>
<a href="#l37.2246"></a><span id="l37.2246" class="difflineminus">-      if (conversation.isChat) {</span>
<a href="#l37.2247"></a><span id="l37.2247" class="difflineminus">-        conversation.joining = false; // In case we never finished joining.</span>
<a href="#l37.2248"></a><span id="l37.2248" class="difflineminus">-        if (!conversation.left) {</span>
<a href="#l37.2249"></a><span id="l37.2249" class="difflineminus">-          // Remove the user's nick and mark the conversation as left as that's</span>
<a href="#l37.2250"></a><span id="l37.2250" class="difflineminus">-          // the final known state of the room.</span>
<a href="#l37.2251"></a><span id="l37.2251" class="difflineminus">-          conversation.removeParticipant(this._nickname);</span>
<a href="#l37.2252"></a><span id="l37.2252" class="difflineminus">-          conversation.left = true;</span>
<a href="#l37.2253"></a><span id="l37.2253" class="difflineminus">-        }</span>
<a href="#l37.2254"></a><span id="l37.2254" class="difflineminus">-      }</span>
<a href="#l37.2255"></a><span id="l37.2255" class="difflineminus">-    });</span>
<a href="#l37.2256"></a><span id="l37.2256" class="difflineminus">-</span>
<a href="#l37.2257"></a><span id="l37.2257" class="difflineminus">-    // If we disconnected during a pending LIST request, make sure callbacks</span>
<a href="#l37.2258"></a><span id="l37.2258" class="difflineminus">-    // receive any remaining channels.</span>
<a href="#l37.2259"></a><span id="l37.2259" class="difflineminus">-    if (this._pendingList) {</span>
<a href="#l37.2260"></a><span id="l37.2260" class="difflineminus">-      this._sendRemainingRoomInfo();</span>
<a href="#l37.2261"></a><span id="l37.2261" class="difflineminus">-    }</span>
<a href="#l37.2262"></a><span id="l37.2262" class="difflineminus">-</span>
<a href="#l37.2263"></a><span id="l37.2263" class="difflineminus">-    // Clear whois table.</span>
<a href="#l37.2264"></a><span id="l37.2264" class="difflineminus">-    this.whoisInformation.clear();</span>
<a href="#l37.2265"></a><span id="l37.2265" class="difflineminus">-</span>
<a href="#l37.2266"></a><span id="l37.2266" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l37.2267"></a><span id="l37.2267" class="difflineminus">-  },</span>
<a href="#l37.2268"></a><span id="l37.2268" class="difflineminus">-</span>
<a href="#l37.2269"></a><span id="l37.2269" class="difflineminus">-  remove() {</span>
<a href="#l37.2270"></a><span id="l37.2270" class="difflineminus">-    this.conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l37.2271"></a><span id="l37.2271" class="difflineminus">-    delete this.conversations;</span>
<a href="#l37.2272"></a><span id="l37.2272" class="difflineminus">-    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l37.2273"></a><span id="l37.2273" class="difflineminus">-    delete this.buddies;</span>
<a href="#l37.2274"></a><span id="l37.2274" class="difflineminus">-  },</span>
<a href="#l37.2275"></a><span id="l37.2275" class="difflineminus">-</span>
<a href="#l37.2276"></a><span id="l37.2276" class="difflineminus">-  unInit() {</span>
<a href="#l37.2277"></a><span id="l37.2277" class="difflineminus">-    // Disconnect if we're online while this gets called.</span>
<a href="#l37.2278"></a><span id="l37.2278" class="difflineminus">-    if (this._socket) {</span>
<a href="#l37.2279"></a><span id="l37.2279" class="difflineminus">-      if (!this.disconnecting) {</span>
<a href="#l37.2280"></a><span id="l37.2280" class="difflineminus">-        this.quit();</span>
<a href="#l37.2281"></a><span id="l37.2281" class="difflineminus">-      }</span>
<a href="#l37.2282"></a><span id="l37.2282" class="difflineminus">-      this._socket.disconnect();</span>
<a href="#l37.2283"></a><span id="l37.2283" class="difflineminus">-    }</span>
<a href="#l37.2284"></a><span id="l37.2284" class="difflineminus">-    delete this.imAccount;</span>
<a href="#l37.2285"></a><span id="l37.2285" class="difflineminus">-    clearTimeout(this._isOnTimer);</span>
<a href="#l37.2286"></a><span id="l37.2286" class="difflineminus">-    clearTimeout(this._quitTimer);</span>
<a href="#l37.2287"></a><span id="l37.2287" class="difflineminus">-  },</span>
<a href="#l37.2288"></a><span id="l37.2288" class="difflineminus">-};</span>
<a href="#l37.2289"></a><span id="l37.2289" class="difflineminus">-</span>
<a href="#l37.2290"></a><span id="l37.2290" class="difflineminus">-function IRCProtocol() {</span>
<a href="#l37.2291"></a><span id="l37.2291" class="difflineminus">-  // ircCommands.jsm exports one variable: commands. Import this directly into</span>
<a href="#l37.2292"></a><span id="l37.2292" class="difflineminus">-  // the protocol object.</span>
<a href="#l37.2293"></a><span id="l37.2293" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;, this);</span>
<a href="#l37.2294"></a><span id="l37.2294" class="difflineminus">-  this.registerCommands();</span>
<a href="#l37.2295"></a><span id="l37.2295" class="difflineminus">-</span>
<a href="#l37.2296"></a><span id="l37.2296" class="difflineminus">-  // Register the standard handlers.</span>
<a href="#l37.2297"></a><span id="l37.2297" class="difflineminus">-  let tempScope = {};</span>
<a href="#l37.2298"></a><span id="l37.2298" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircBase.jsm&quot;, tempScope);</span>
<a href="#l37.2299"></a><span id="l37.2299" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircISUPPORT.jsm&quot;, tempScope);</span>
<a href="#l37.2300"></a><span id="l37.2300" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircCAP.jsm&quot;, tempScope);</span>
<a href="#l37.2301"></a><span id="l37.2301" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircCTCP.jsm&quot;, tempScope);</span>
<a href="#l37.2302"></a><span id="l37.2302" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircDCC.jsm&quot;, tempScope);</span>
<a href="#l37.2303"></a><span id="l37.2303" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircServices.jsm&quot;, tempScope);</span>
<a href="#l37.2304"></a><span id="l37.2304" class="difflineminus">-</span>
<a href="#l37.2305"></a><span id="l37.2305" class="difflineminus">-  // Extra features.</span>
<a href="#l37.2306"></a><span id="l37.2306" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircMultiPrefix.jsm&quot;, tempScope);</span>
<a href="#l37.2307"></a><span id="l37.2307" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircNonStandard.jsm&quot;, tempScope);</span>
<a href="#l37.2308"></a><span id="l37.2308" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircSASL.jsm&quot;, tempScope);</span>
<a href="#l37.2309"></a><span id="l37.2309" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircServerTime.jsm&quot;, tempScope);</span>
<a href="#l37.2310"></a><span id="l37.2310" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/ircWatchMonitor.jsm&quot;, tempScope);</span>
<a href="#l37.2311"></a><span id="l37.2311" class="difflineminus">-</span>
<a href="#l37.2312"></a><span id="l37.2312" class="difflineminus">-  // Register default IRC handlers (IRC base, CTCP).</span>
<a href="#l37.2313"></a><span id="l37.2313" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircBase);</span>
<a href="#l37.2314"></a><span id="l37.2314" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircISUPPORT);</span>
<a href="#l37.2315"></a><span id="l37.2315" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircCAP);</span>
<a href="#l37.2316"></a><span id="l37.2316" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircCTCP);</span>
<a href="#l37.2317"></a><span id="l37.2317" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircServices);</span>
<a href="#l37.2318"></a><span id="l37.2318" class="difflineminus">-  // Register default ISUPPORT handler (ISUPPORT base).</span>
<a href="#l37.2319"></a><span id="l37.2319" class="difflineminus">-  ircHandlers.registerISUPPORTHandler(tempScope.isupportBase);</span>
<a href="#l37.2320"></a><span id="l37.2320" class="difflineminus">-  // Register default CTCP handlers (CTCP base, DCC).</span>
<a href="#l37.2321"></a><span id="l37.2321" class="difflineminus">-  ircHandlers.registerCTCPHandler(tempScope.ctcpBase);</span>
<a href="#l37.2322"></a><span id="l37.2322" class="difflineminus">-  ircHandlers.registerCTCPHandler(tempScope.ctcpDCC);</span>
<a href="#l37.2323"></a><span id="l37.2323" class="difflineminus">-  // Register default IRC Services handlers (IRC Services base).</span>
<a href="#l37.2324"></a><span id="l37.2324" class="difflineminus">-  ircHandlers.registerServicesHandler(tempScope.servicesBase);</span>
<a href="#l37.2325"></a><span id="l37.2325" class="difflineminus">-  // Register default CAP handlers for base features (CAP basics).</span>
<a href="#l37.2326"></a><span id="l37.2326" class="difflineminus">-  ircHandlers.registerCAPHandler(tempScope.capNotify);</span>
<a href="#l37.2327"></a><span id="l37.2327" class="difflineminus">-</span>
<a href="#l37.2328"></a><span id="l37.2328" class="difflineminus">-  // Register extra features.</span>
<a href="#l37.2329"></a><span id="l37.2329" class="difflineminus">-  ircHandlers.registerISUPPORTHandler(tempScope.isupportNAMESX);</span>
<a href="#l37.2330"></a><span id="l37.2330" class="difflineminus">-  ircHandlers.registerCAPHandler(tempScope.capMultiPrefix);</span>
<a href="#l37.2331"></a><span id="l37.2331" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircNonStandard);</span>
<a href="#l37.2332"></a><span id="l37.2332" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircWATCH);</span>
<a href="#l37.2333"></a><span id="l37.2333" class="difflineminus">-  ircHandlers.registerISUPPORTHandler(tempScope.isupportWATCH);</span>
<a href="#l37.2334"></a><span id="l37.2334" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircMONITOR);</span>
<a href="#l37.2335"></a><span id="l37.2335" class="difflineminus">-  ircHandlers.registerISUPPORTHandler(tempScope.isupportMONITOR);</span>
<a href="#l37.2336"></a><span id="l37.2336" class="difflineminus">-  ircHandlers.registerHandler(tempScope.ircSASL);</span>
<a href="#l37.2337"></a><span id="l37.2337" class="difflineminus">-  ircHandlers.registerCAPHandler(tempScope.capSASL);</span>
<a href="#l37.2338"></a><span id="l37.2338" class="difflineminus">-  ircHandlers.registerCAPHandler(tempScope.capServerTime);</span>
<a href="#l37.2339"></a><span id="l37.2339" class="difflineminus">-  ircHandlers.registerTagHandler(tempScope.tagServerTime);</span>
<a href="#l37.2340"></a><span id="l37.2340" class="difflineminus">-}</span>
<a href="#l37.2341"></a><span id="l37.2341" class="difflineminus">-IRCProtocol.prototype = {</span>
<a href="#l37.2342"></a><span id="l37.2342" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l37.2343"></a><span id="l37.2343" class="difflineminus">-  get name() {</span>
<a href="#l37.2344"></a><span id="l37.2344" class="difflineminus">-    return &quot;IRC&quot;;</span>
<a href="#l37.2345"></a><span id="l37.2345" class="difflineminus">-  },</span>
<a href="#l37.2346"></a><span id="l37.2346" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l37.2347"></a><span id="l37.2347" class="difflineminus">-    return &quot;chrome://prpl-irc/skin/&quot;;</span>
<a href="#l37.2348"></a><span id="l37.2348" class="difflineminus">-  },</span>
<a href="#l37.2349"></a><span id="l37.2349" class="difflineminus">-  get usernameEmptyText() {</span>
<a href="#l37.2350"></a><span id="l37.2350" class="difflineminus">-    return _(&quot;irc.usernameHint&quot;);</span>
<a href="#l37.2351"></a><span id="l37.2351" class="difflineminus">-  },</span>
<a href="#l37.2352"></a><span id="l37.2352" class="difflineminus">-  get baseId() {</span>
<a href="#l37.2353"></a><span id="l37.2353" class="difflineminus">-    return &quot;prpl-irc&quot;;</span>
<a href="#l37.2354"></a><span id="l37.2354" class="difflineminus">-  },</span>
<a href="#l37.2355"></a><span id="l37.2355" class="difflineminus">-</span>
<a href="#l37.2356"></a><span id="l37.2356" class="difflineminus">-  usernameSplits: [</span>
<a href="#l37.2357"></a><span id="l37.2357" class="difflineminus">-    {</span>
<a href="#l37.2358"></a><span id="l37.2358" class="difflineminus">-      get label() {</span>
<a href="#l37.2359"></a><span id="l37.2359" class="difflineminus">-        return _(&quot;options.server&quot;);</span>
<a href="#l37.2360"></a><span id="l37.2360" class="difflineminus">-      },</span>
<a href="#l37.2361"></a><span id="l37.2361" class="difflineminus">-      separator: &quot;@&quot;,</span>
<a href="#l37.2362"></a><span id="l37.2362" class="difflineminus">-      defaultValue: &quot;chat.freenode.net&quot;,</span>
<a href="#l37.2363"></a><span id="l37.2363" class="difflineminus">-      reverse: true,</span>
<a href="#l37.2364"></a><span id="l37.2364" class="difflineminus">-    },</span>
<a href="#l37.2365"></a><span id="l37.2365" class="difflineminus">-  ],</span>
<a href="#l37.2366"></a><span id="l37.2366" class="difflineminus">-</span>
<a href="#l37.2367"></a><span id="l37.2367" class="difflineminus">-  options: {</span>
<a href="#l37.2368"></a><span id="l37.2368" class="difflineminus">-    port: {</span>
<a href="#l37.2369"></a><span id="l37.2369" class="difflineminus">-      get label() {</span>
<a href="#l37.2370"></a><span id="l37.2370" class="difflineminus">-        return _(&quot;options.port&quot;);</span>
<a href="#l37.2371"></a><span id="l37.2371" class="difflineminus">-      },</span>
<a href="#l37.2372"></a><span id="l37.2372" class="difflineminus">-      default: 6697,</span>
<a href="#l37.2373"></a><span id="l37.2373" class="difflineminus">-    },</span>
<a href="#l37.2374"></a><span id="l37.2374" class="difflineminus">-    ssl: {</span>
<a href="#l37.2375"></a><span id="l37.2375" class="difflineminus">-      get label() {</span>
<a href="#l37.2376"></a><span id="l37.2376" class="difflineminus">-        return _(&quot;options.ssl&quot;);</span>
<a href="#l37.2377"></a><span id="l37.2377" class="difflineminus">-      },</span>
<a href="#l37.2378"></a><span id="l37.2378" class="difflineminus">-      default: true,</span>
<a href="#l37.2379"></a><span id="l37.2379" class="difflineminus">-    },</span>
<a href="#l37.2380"></a><span id="l37.2380" class="difflineminus">-    // TODO We should attempt to auto-detect encoding instead.</span>
<a href="#l37.2381"></a><span id="l37.2381" class="difflineminus">-    encoding: {</span>
<a href="#l37.2382"></a><span id="l37.2382" class="difflineminus">-      get label() {</span>
<a href="#l37.2383"></a><span id="l37.2383" class="difflineminus">-        return _(&quot;options.encoding&quot;);</span>
<a href="#l37.2384"></a><span id="l37.2384" class="difflineminus">-      },</span>
<a href="#l37.2385"></a><span id="l37.2385" class="difflineminus">-      default: &quot;UTF-8&quot;,</span>
<a href="#l37.2386"></a><span id="l37.2386" class="difflineminus">-    },</span>
<a href="#l37.2387"></a><span id="l37.2387" class="difflineminus">-    quitmsg: {</span>
<a href="#l37.2388"></a><span id="l37.2388" class="difflineminus">-      get label() {</span>
<a href="#l37.2389"></a><span id="l37.2389" class="difflineminus">-        return _(&quot;options.quitMessage&quot;);</span>
<a href="#l37.2390"></a><span id="l37.2390" class="difflineminus">-      },</span>
<a href="#l37.2391"></a><span id="l37.2391" class="difflineminus">-      get default() {</span>
<a href="#l37.2392"></a><span id="l37.2392" class="difflineminus">-        return Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;);</span>
<a href="#l37.2393"></a><span id="l37.2393" class="difflineminus">-      },</span>
<a href="#l37.2394"></a><span id="l37.2394" class="difflineminus">-    },</span>
<a href="#l37.2395"></a><span id="l37.2395" class="difflineminus">-    partmsg: {</span>
<a href="#l37.2396"></a><span id="l37.2396" class="difflineminus">-      get label() {</span>
<a href="#l37.2397"></a><span id="l37.2397" class="difflineminus">-        return _(&quot;options.partMessage&quot;);</span>
<a href="#l37.2398"></a><span id="l37.2398" class="difflineminus">-      },</span>
<a href="#l37.2399"></a><span id="l37.2399" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l37.2400"></a><span id="l37.2400" class="difflineminus">-    },</span>
<a href="#l37.2401"></a><span id="l37.2401" class="difflineminus">-    showServerTab: {</span>
<a href="#l37.2402"></a><span id="l37.2402" class="difflineminus">-      get label() {</span>
<a href="#l37.2403"></a><span id="l37.2403" class="difflineminus">-        return _(&quot;options.showServerTab&quot;);</span>
<a href="#l37.2404"></a><span id="l37.2404" class="difflineminus">-      },</span>
<a href="#l37.2405"></a><span id="l37.2405" class="difflineminus">-      default: false,</span>
<a href="#l37.2406"></a><span id="l37.2406" class="difflineminus">-    },</span>
<a href="#l37.2407"></a><span id="l37.2407" class="difflineminus">-    alternateNicks: {</span>
<a href="#l37.2408"></a><span id="l37.2408" class="difflineminus">-      get label() {</span>
<a href="#l37.2409"></a><span id="l37.2409" class="difflineminus">-        return _(&quot;options.alternateNicks&quot;);</span>
<a href="#l37.2410"></a><span id="l37.2410" class="difflineminus">-      },</span>
<a href="#l37.2411"></a><span id="l37.2411" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l37.2412"></a><span id="l37.2412" class="difflineminus">-    },</span>
<a href="#l37.2413"></a><span id="l37.2413" class="difflineminus">-  },</span>
<a href="#l37.2414"></a><span id="l37.2414" class="difflineminus">-</span>
<a href="#l37.2415"></a><span id="l37.2415" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l37.2416"></a><span id="l37.2416" class="difflineminus">-    return true;</span>
<a href="#l37.2417"></a><span id="l37.2417" class="difflineminus">-  },</span>
<a href="#l37.2418"></a><span id="l37.2418" class="difflineminus">-  get slashCommandsNative() {</span>
<a href="#l37.2419"></a><span id="l37.2419" class="difflineminus">-    return true;</span>
<a href="#l37.2420"></a><span id="l37.2420" class="difflineminus">-  },</span>
<a href="#l37.2421"></a><span id="l37.2421" class="difflineminus">-  //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l37.2422"></a><span id="l37.2422" class="difflineminus">-  get passwordOptional() {</span>
<a href="#l37.2423"></a><span id="l37.2423" class="difflineminus">-    return true;</span>
<a href="#l37.2424"></a><span id="l37.2424" class="difflineminus">-  },</span>
<a href="#l37.2425"></a><span id="l37.2425" class="difflineminus">-</span>
<a href="#l37.2426"></a><span id="l37.2426" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l37.2427"></a><span id="l37.2427" class="difflineminus">-    return new IRCAccount(this, aImAccount);</span>
<a href="#l37.2428"></a><span id="l37.2428" class="difflineminus">-  },</span>
<a href="#l37.2429"></a><span id="l37.2429" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/chat/protocols/irc/components.conf</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineminus">-Classes = [</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-    'cid': '{607b2c0b-9504-483f-ad62-41de09238aec}',</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/irc;1'],</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-    'jsm': 'resource:///modules/IRC.jsm',</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-    'constructor': 'IRCProtocol',</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-irc'},</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-  },</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,2417 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+var {</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+  ClassInfo,</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+  clearTimeout,</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+  EmptyEnumerator,</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  setTimeout,</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+  executeSoon,</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+  l10nHelper,</span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+  nsSimpleEnumerator,</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l39.20"></a><span id="l39.20" class="difflineplus">+var { _, ctcpFormatToHTML, kListRefreshInterval } = ChromeUtils.import(</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+  &quot;resource:///modules/ircUtils.jsm&quot;</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+);</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+var { ircHandlers } = ChromeUtils.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+var {</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+  GenericAccountBuddyPrototype,</span>
<a href="#l39.27"></a><span id="l39.27" class="difflineplus">+  GenericConvIMPrototype,</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineplus">+  GenericConvChatPrototype,</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+  GenericConvChatBuddyPrototype,</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+  GenericConversationPrototype,</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  GenericProtocolPrototype,</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+  TooltipInfo,</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+var { NormalizedMap } = ChromeUtils.import(</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+  &quot;resource:///modules/NormalizedMap.jsm&quot;</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+);</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+var { Socket } = ChromeUtils.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+  this,</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineplus">+  &quot;PluralForm&quot;,</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineplus">+  &quot;resource://gre/modules/PluralForm.jsm&quot;</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+);</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineplus">+  this,</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineplus">+  &quot;DownloadUtils&quot;,</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineplus">+  &quot;resource://gre/modules/DownloadUtils.jsm&quot;</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineplus">+);</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_conv&quot;, () =&gt;</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/conversations.properties&quot;)</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineplus">+);</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineplus">+</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+/*</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+ * Parses a raw IRC message into an object (see section 2.3 of RFC 2812). This</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+ * returns an object with the following fields:</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+ *   rawMessage The initial message string received without any processing.</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+ *   command    A string that is the command or response code.</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+ *   params     An array of strings for the parameters. The last parameter is</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+ *              stripped of its : prefix.</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+ *   origin     The user's nickname or the server who sent the message. Can be</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+ *              a host (e.g. irc.mozilla.org) or an IPv4 address (e.g. 1.2.3.4)</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+ *              or an IPv6 address (e.g. 3ffe:1900:4545:3:200:f8ff:fe21:67cf).</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+ *   user       The user's username, note that this can be undefined.</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+ *   host       The user's hostname, note that this can be undefined.</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+ *   source     A &quot;nicely&quot; formatted combination of user &amp; host, which is</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+ *              &lt;user&gt;@&lt;host&gt; or &lt;user&gt; if host is undefined.</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+ *   tags       A Map with tags stored as key-value-pair. The value is a decoded</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+ *              string or undefined if the tag has no value.</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+ *</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+ * There are cases (e.g. localhost) where it cannot be easily determined if a</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+ * message is from a server or from a user, thus the usage of a generic &quot;origin&quot;</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+ * instead of &quot;nickname&quot; or &quot;servername&quot;.</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+ *</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+ * Inputs:</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineplus">+ *  aData       The raw string to parse, it should already have the \r\n</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineplus">+ *              stripped from the end.</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineplus">+ *  aOrigin     The default origin to use for unprefixed messages.</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+ */</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+function ircMessage(aData, aOrigin) {</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+  let message = { rawMessage: aData };</span>
<a href="#l39.83"></a><span id="l39.83" class="difflineplus">+  let temp;</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineplus">+</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineplus">+  // Splits the raw string into five parts. The third part, the command, is</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineplus">+  // required. A raw string looks like:</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineplus">+  //   [&quot;@&quot; &lt;tags&gt; &quot; &quot;] [&quot;:&quot; &lt;prefix&gt; &quot; &quot;] &lt;command&gt; [&quot; &quot; &lt;parameter&gt;]* [&quot;:&quot; &lt;last parameter&gt;]</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  //     &lt;tags&gt;: /[^ ]+/</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineplus">+  //     &lt;prefix&gt;: :(&lt;server name&gt; | &lt;nickname&gt; [[&quot;!&quot; &lt;user&gt;] &quot;@&quot; &lt;host&gt;])</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+  //     &lt;command&gt;: /[^ ]+/</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineplus">+  //     &lt;parameter&gt;: /[^ ]+/</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+  //     &lt;last parameter&gt;: /.+/</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineplus">+  // See http://joshualuckers.nl/2010/01/10/regular-expression-to-match-raw-irc-messages/</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineplus">+  // Note that this expression is slightly more aggressive in matching than RFC</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineplus">+  // 2812 would allow. It allows for empty parameters (besides the last</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineplus">+  // parameter, which can always be empty), by allowing multiple spaces.</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineplus">+  // (This is for compatibility with Unreal's 432 response, which returns an</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineplus">+  // empty first parameter.) It also allows a trailing space after the</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineplus">+  // &lt;parameter&gt;s when no &lt;last parameter&gt; is present (also occurs with Unreal).</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineplus">+  if (</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineplus">+    !(temp = aData.match(</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineplus">+      /^(?:@([^ ]+) )?(?::([^ ]+) )?([^ ]+)((?: +[^: ][^ ]*)*)? *(?::([\s\S]*))?$/</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+    ))</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+  ) {</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineplus">+    throw new Error(&quot;Couldn't parse message: \&quot;&quot; + aData + '&quot;');</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineplus">+  }</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineplus">+  message.command = temp[3];</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineplus">+  // Space separated parameters. Since we expect a space as the first thing</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineplus">+  // here, we want to ignore the first value (which is empty).</span>
<a href="#l39.111"></a><span id="l39.111" class="difflineplus">+  message.params = temp[4] ? temp[4].split(&quot; &quot;).slice(1) : [];</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineplus">+  // Last parameter can contain spaces or be an empty string.</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+  if (temp[5] !== undefined) {</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+    message.params.push(temp[5]);</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+  }</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+</span>
<a href="#l39.117"></a><span id="l39.117" class="difflineplus">+  // Handle the prefix part of the message per RFC 2812 Section 2.3.</span>
<a href="#l39.118"></a><span id="l39.118" class="difflineplus">+</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineplus">+  // If no prefix is given, assume the current server is the origin.</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+  if (!temp[2]) {</span>
<a href="#l39.121"></a><span id="l39.121" class="difflineplus">+    temp[2] = aOrigin;</span>
<a href="#l39.122"></a><span id="l39.122" class="difflineplus">+  }</span>
<a href="#l39.123"></a><span id="l39.123" class="difflineplus">+</span>
<a href="#l39.124"></a><span id="l39.124" class="difflineplus">+  // Split the prefix into separate nickname, username and hostname fields as:</span>
<a href="#l39.125"></a><span id="l39.125" class="difflineplus">+  //   :(servername|(nickname[[!user]@host]))</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineplus">+  [message.origin, message.user, message.host] = temp[2].split(/[!@]/);</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineplus">+</span>
<a href="#l39.128"></a><span id="l39.128" class="difflineplus">+  // Store the tags in a Map, see IRCv3.2 Message Tags.</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+  message.tags = new Map();</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineplus">+</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineplus">+  if (temp[1]) {</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+    let tags = temp[1].split(&quot;;&quot;);</span>
<a href="#l39.133"></a><span id="l39.133" class="difflineplus">+    tags.forEach(tag =&gt; {</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineplus">+      let [key, value] = tag.split(&quot;=&quot;);</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+</span>
<a href="#l39.136"></a><span id="l39.136" class="difflineplus">+      if (value) {</span>
<a href="#l39.137"></a><span id="l39.137" class="difflineplus">+        // Unescape tag values according to this mapping:</span>
<a href="#l39.138"></a><span id="l39.138" class="difflineplus">+        // \\ = \</span>
<a href="#l39.139"></a><span id="l39.139" class="difflineplus">+        // \n = LF</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineplus">+        // \r = CR</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+        // \s = SPACE</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineplus">+        // \: = ;</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+        // everything else stays identical.</span>
<a href="#l39.144"></a><span id="l39.144" class="difflineplus">+        value = value.replace(/\\(.)/g, (str, type) =&gt; {</span>
<a href="#l39.145"></a><span id="l39.145" class="difflineplus">+          if (type == &quot;\\&quot;) {</span>
<a href="#l39.146"></a><span id="l39.146" class="difflineplus">+            return &quot;\\&quot;;</span>
<a href="#l39.147"></a><span id="l39.147" class="difflineplus">+          } else if (type == &quot;n&quot;) {</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineplus">+            return &quot;\n&quot;;</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineplus">+          } else if (type == &quot;r&quot;) {</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+            return &quot;\r&quot;;</span>
<a href="#l39.151"></a><span id="l39.151" class="difflineplus">+          } else if (type == &quot;s&quot;) {</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineplus">+            return &quot; &quot;;</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineplus">+          } else if (type == &quot;:&quot;) {</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+            return &quot;;&quot;;</span>
<a href="#l39.155"></a><span id="l39.155" class="difflineplus">+          }</span>
<a href="#l39.156"></a><span id="l39.156" class="difflineplus">+          // Ignore the backslash, not specified by the spec, but as it says</span>
<a href="#l39.157"></a><span id="l39.157" class="difflineplus">+          // backslashes must be escaped this case should not occur in a valid</span>
<a href="#l39.158"></a><span id="l39.158" class="difflineplus">+          // tag value.</span>
<a href="#l39.159"></a><span id="l39.159" class="difflineplus">+          return type;</span>
<a href="#l39.160"></a><span id="l39.160" class="difflineplus">+        });</span>
<a href="#l39.161"></a><span id="l39.161" class="difflineplus">+      }</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineplus">+      // The tag key can typically have the form of example.com/aaa for vendor</span>
<a href="#l39.163"></a><span id="l39.163" class="difflineplus">+      // defined tags. The spec wants any unicode characters in URLs to be</span>
<a href="#l39.164"></a><span id="l39.164" class="difflineplus">+      // in punycode (xn--). These are not unescaped to their unicode value.</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineplus">+      message.tags.set(key, value);</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineplus">+    });</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+  }</span>
<a href="#l39.168"></a><span id="l39.168" class="difflineplus">+</span>
<a href="#l39.169"></a><span id="l39.169" class="difflineplus">+  // It is occasionally useful to have a &quot;source&quot; which is a combination of</span>
<a href="#l39.170"></a><span id="l39.170" class="difflineplus">+  // user@host.</span>
<a href="#l39.171"></a><span id="l39.171" class="difflineplus">+  if (message.user) {</span>
<a href="#l39.172"></a><span id="l39.172" class="difflineplus">+    message.source = message.user + &quot;@&quot; + message.host;</span>
<a href="#l39.173"></a><span id="l39.173" class="difflineplus">+  } else if (message.host) {</span>
<a href="#l39.174"></a><span id="l39.174" class="difflineplus">+    message.source = message.host;</span>
<a href="#l39.175"></a><span id="l39.175" class="difflineplus">+  } else {</span>
<a href="#l39.176"></a><span id="l39.176" class="difflineplus">+    message.source = &quot;&quot;;</span>
<a href="#l39.177"></a><span id="l39.177" class="difflineplus">+  }</span>
<a href="#l39.178"></a><span id="l39.178" class="difflineplus">+</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineplus">+  return message;</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+}</span>
<a href="#l39.181"></a><span id="l39.181" class="difflineplus">+</span>
<a href="#l39.182"></a><span id="l39.182" class="difflineplus">+// This handles a mode change string for both channels and participants. A mode</span>
<a href="#l39.183"></a><span id="l39.183" class="difflineplus">+// change string is of the form:</span>
<a href="#l39.184"></a><span id="l39.184" class="difflineplus">+//   aAddNewMode is true if modes are being added, false otherwise.</span>
<a href="#l39.185"></a><span id="l39.185" class="difflineplus">+//   aNewModes is an array of mode characters.</span>
<a href="#l39.186"></a><span id="l39.186" class="difflineplus">+function _setMode(aAddNewMode, aNewModes) {</span>
<a href="#l39.187"></a><span id="l39.187" class="difflineplus">+  // Check each mode being added/removed.</span>
<a href="#l39.188"></a><span id="l39.188" class="difflineplus">+  for (let newMode of aNewModes) {</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineplus">+    let hasMode = this._modes.has(newMode);</span>
<a href="#l39.190"></a><span id="l39.190" class="difflineplus">+    // If the mode is in the list of modes and we want to remove it.</span>
<a href="#l39.191"></a><span id="l39.191" class="difflineplus">+    if (hasMode &amp;&amp; !aAddNewMode) {</span>
<a href="#l39.192"></a><span id="l39.192" class="difflineplus">+      this._modes.delete(newMode);</span>
<a href="#l39.193"></a><span id="l39.193" class="difflineplus">+    } else if (!hasMode &amp;&amp; aAddNewMode) {</span>
<a href="#l39.194"></a><span id="l39.194" class="difflineplus">+      // If the mode is not in the list of modes and we want to add it.</span>
<a href="#l39.195"></a><span id="l39.195" class="difflineplus">+      this._modes.add(newMode);</span>
<a href="#l39.196"></a><span id="l39.196" class="difflineplus">+    }</span>
<a href="#l39.197"></a><span id="l39.197" class="difflineplus">+  }</span>
<a href="#l39.198"></a><span id="l39.198" class="difflineplus">+}</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineplus">+</span>
<a href="#l39.200"></a><span id="l39.200" class="difflineplus">+function TagMessage(aMessage, aTagName) {</span>
<a href="#l39.201"></a><span id="l39.201" class="difflineplus">+  this.message = aMessage;</span>
<a href="#l39.202"></a><span id="l39.202" class="difflineplus">+  this.tagName = aTagName;</span>
<a href="#l39.203"></a><span id="l39.203" class="difflineplus">+  this.tagValue = aMessage.tags.get(aTagName);</span>
<a href="#l39.204"></a><span id="l39.204" class="difflineplus">+}</span>
<a href="#l39.205"></a><span id="l39.205" class="difflineplus">+</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineplus">+// Properties / methods shared by both ircChannel and ircConversation.</span>
<a href="#l39.207"></a><span id="l39.207" class="difflineplus">+var GenericIRCConversation = {</span>
<a href="#l39.208"></a><span id="l39.208" class="difflineplus">+  _observedNicks: [],</span>
<a href="#l39.209"></a><span id="l39.209" class="difflineplus">+  // This is set to true after a message is sent to notify the 401</span>
<a href="#l39.210"></a><span id="l39.210" class="difflineplus">+  // ERR_NOSUCHNICK handler to write an error message to the conversation.</span>
<a href="#l39.211"></a><span id="l39.211" class="difflineplus">+  _pendingMessage: false,</span>
<a href="#l39.212"></a><span id="l39.212" class="difflineplus">+  _waitingForNick: false,</span>
<a href="#l39.213"></a><span id="l39.213" class="difflineplus">+</span>
<a href="#l39.214"></a><span id="l39.214" class="difflineplus">+  normalizeNick(aNick) {</span>
<a href="#l39.215"></a><span id="l39.215" class="difflineplus">+    return this._account.normalizeNick(aNick);</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineplus">+  },</span>
<a href="#l39.217"></a><span id="l39.217" class="difflineplus">+</span>
<a href="#l39.218"></a><span id="l39.218" class="difflineplus">+  // This will calculate the maximum number of bytes that are left for a message</span>
<a href="#l39.219"></a><span id="l39.219" class="difflineplus">+  // typed by the user by calculate the amount of bytes that would be used by</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineplus">+  // the IRC messaging.</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineplus">+  getMaxMessageLength() {</span>
<a href="#l39.222"></a><span id="l39.222" class="difflineplus">+    // Build the shortest possible message that could be sent to other users.</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineplus">+    let baseMessage =</span>
<a href="#l39.224"></a><span id="l39.224" class="difflineplus">+      &quot;:&quot; +</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineplus">+      this._account._nickname +</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineplus">+      this._account.prefix +</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineplus">+      &quot; &quot; +</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineplus">+      this._account.buildMessage(&quot;PRIVMSG&quot;, this.name) +</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+      &quot; :\r\n&quot;;</span>
<a href="#l39.230"></a><span id="l39.230" class="difflineplus">+    return (</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineplus">+      this._account.maxMessageLength - this._account.countBytes(baseMessage)</span>
<a href="#l39.232"></a><span id="l39.232" class="difflineplus">+    );</span>
<a href="#l39.233"></a><span id="l39.233" class="difflineplus">+  },</span>
<a href="#l39.234"></a><span id="l39.234" class="difflineplus">+  /**</span>
<a href="#l39.235"></a><span id="l39.235" class="difflineplus">+   * @param {string} aWho - Message author's username.</span>
<a href="#l39.236"></a><span id="l39.236" class="difflineplus">+   * @param {string} aMessage - Message text.</span>
<a href="#l39.237"></a><span id="l39.237" class="difflineplus">+   * @param {Object} aObject - Other properties to set on the imMessage.</span>
<a href="#l39.238"></a><span id="l39.238" class="difflineplus">+   */</span>
<a href="#l39.239"></a><span id="l39.239" class="difflineplus">+  handleTags(aWho, aMessage, aObject) {</span>
<a href="#l39.240"></a><span id="l39.240" class="difflineplus">+    let messageProps = aObject;</span>
<a href="#l39.241"></a><span id="l39.241" class="difflineplus">+    if (&quot;tags&quot; in aObject &amp;&amp; ircHandlers.hasTagHandlers) {</span>
<a href="#l39.242"></a><span id="l39.242" class="difflineplus">+      // Merge extra info for the handler into the props.</span>
<a href="#l39.243"></a><span id="l39.243" class="difflineplus">+      messageProps = Object.assign(</span>
<a href="#l39.244"></a><span id="l39.244" class="difflineplus">+        {</span>
<a href="#l39.245"></a><span id="l39.245" class="difflineplus">+          who: aWho,</span>
<a href="#l39.246"></a><span id="l39.246" class="difflineplus">+          message: aMessage,</span>
<a href="#l39.247"></a><span id="l39.247" class="difflineplus">+          get originalMessage() {</span>
<a href="#l39.248"></a><span id="l39.248" class="difflineplus">+            return aMessage;</span>
<a href="#l39.249"></a><span id="l39.249" class="difflineplus">+          },</span>
<a href="#l39.250"></a><span id="l39.250" class="difflineplus">+        },</span>
<a href="#l39.251"></a><span id="l39.251" class="difflineplus">+        messageProps</span>
<a href="#l39.252"></a><span id="l39.252" class="difflineplus">+      );</span>
<a href="#l39.253"></a><span id="l39.253" class="difflineplus">+      for (let tag of aObject.tags.keys()) {</span>
<a href="#l39.254"></a><span id="l39.254" class="difflineplus">+        // Unhandled tags may be common, since a tag does not have to be handled</span>
<a href="#l39.255"></a><span id="l39.255" class="difflineplus">+        // with a tag handler, it may also be handled by a message command handler.</span>
<a href="#l39.256"></a><span id="l39.256" class="difflineplus">+        ircHandlers.handleTag(this._account, new TagMessage(messageProps, tag));</span>
<a href="#l39.257"></a><span id="l39.257" class="difflineplus">+      }</span>
<a href="#l39.258"></a><span id="l39.258" class="difflineplus">+</span>
<a href="#l39.259"></a><span id="l39.259" class="difflineplus">+      // Remove helper prop for tag handlers. We don't want to remove the other</span>
<a href="#l39.260"></a><span id="l39.260" class="difflineplus">+      // ones, since they might have been changed and will override aWho and</span>
<a href="#l39.261"></a><span id="l39.261" class="difflineplus">+      // aMessage in the imMessage constructor.</span>
<a href="#l39.262"></a><span id="l39.262" class="difflineplus">+      delete messageProps.originalMessage;</span>
<a href="#l39.263"></a><span id="l39.263" class="difflineplus">+    }</span>
<a href="#l39.264"></a><span id="l39.264" class="difflineplus">+    // Remove the IRC tags, as those were passed in just for this step.</span>
<a href="#l39.265"></a><span id="l39.265" class="difflineplus">+    delete messageProps.tags;</span>
<a href="#l39.266"></a><span id="l39.266" class="difflineplus">+    return messageProps;</span>
<a href="#l39.267"></a><span id="l39.267" class="difflineplus">+  },</span>
<a href="#l39.268"></a><span id="l39.268" class="difflineplus">+  // Apply CTCP formatting before displaying.</span>
<a href="#l39.269"></a><span id="l39.269" class="difflineplus">+  prepareForDisplaying(aMsg) {</span>
<a href="#l39.270"></a><span id="l39.270" class="difflineplus">+    aMsg.displayMessage = ctcpFormatToHTML(aMsg.displayMessage);</span>
<a href="#l39.271"></a><span id="l39.271" class="difflineplus">+    GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l39.272"></a><span id="l39.272" class="difflineplus">+  },</span>
<a href="#l39.273"></a><span id="l39.273" class="difflineplus">+  prepareForSending(aOutgoingMessage) {</span>
<a href="#l39.274"></a><span id="l39.274" class="difflineplus">+    // Split the message by line breaks and send each one individually.</span>
<a href="#l39.275"></a><span id="l39.275" class="difflineplus">+    let messages = aOutgoingMessage.message.split(/[\r\n]+/);</span>
<a href="#l39.276"></a><span id="l39.276" class="difflineplus">+</span>
<a href="#l39.277"></a><span id="l39.277" class="difflineplus">+    let maxLength = this.getMaxMessageLength();</span>
<a href="#l39.278"></a><span id="l39.278" class="difflineplus">+</span>
<a href="#l39.279"></a><span id="l39.279" class="difflineplus">+    // Attempt to smartly split a string into multiple lines (based on the</span>
<a href="#l39.280"></a><span id="l39.280" class="difflineplus">+    // maximum number of characters the message can contain).</span>
<a href="#l39.281"></a><span id="l39.281" class="difflineplus">+    for (let i = 0; i &lt; messages.length; ++i) {</span>
<a href="#l39.282"></a><span id="l39.282" class="difflineplus">+      let message = messages[i];</span>
<a href="#l39.283"></a><span id="l39.283" class="difflineplus">+      let length = this._account.countBytes(message);</span>
<a href="#l39.284"></a><span id="l39.284" class="difflineplus">+      // The message is short enough.</span>
<a href="#l39.285"></a><span id="l39.285" class="difflineplus">+      if (length &lt;= maxLength) {</span>
<a href="#l39.286"></a><span id="l39.286" class="difflineplus">+        continue;</span>
<a href="#l39.287"></a><span id="l39.287" class="difflineplus">+      }</span>
<a href="#l39.288"></a><span id="l39.288" class="difflineplus">+</span>
<a href="#l39.289"></a><span id="l39.289" class="difflineplus">+      // Find the location of a space before the maximum length.</span>
<a href="#l39.290"></a><span id="l39.290" class="difflineplus">+      let index = message.lastIndexOf(&quot; &quot;, maxLength);</span>
<a href="#l39.291"></a><span id="l39.291" class="difflineplus">+</span>
<a href="#l39.292"></a><span id="l39.292" class="difflineplus">+      // Remove the current message and insert the two new ones. If no space was</span>
<a href="#l39.293"></a><span id="l39.293" class="difflineplus">+      // found, cut the first message to the maximum length and start the second</span>
<a href="#l39.294"></a><span id="l39.294" class="difflineplus">+      // message one character after that. If a space was found, exclude it.</span>
<a href="#l39.295"></a><span id="l39.295" class="difflineplus">+      messages.splice(</span>
<a href="#l39.296"></a><span id="l39.296" class="difflineplus">+        i,</span>
<a href="#l39.297"></a><span id="l39.297" class="difflineplus">+        1,</span>
<a href="#l39.298"></a><span id="l39.298" class="difflineplus">+        message.substr(0, index == -1 ? maxLength : index),</span>
<a href="#l39.299"></a><span id="l39.299" class="difflineplus">+        message.substr(index + 1 || maxLength)</span>
<a href="#l39.300"></a><span id="l39.300" class="difflineplus">+      );</span>
<a href="#l39.301"></a><span id="l39.301" class="difflineplus">+    }</span>
<a href="#l39.302"></a><span id="l39.302" class="difflineplus">+</span>
<a href="#l39.303"></a><span id="l39.303" class="difflineplus">+    return messages;</span>
<a href="#l39.304"></a><span id="l39.304" class="difflineplus">+  },</span>
<a href="#l39.305"></a><span id="l39.305" class="difflineplus">+  sendMsg(aMessage, aIsNotice) {</span>
<a href="#l39.306"></a><span id="l39.306" class="difflineplus">+    if (!aMessage.length) {</span>
<a href="#l39.307"></a><span id="l39.307" class="difflineplus">+      return;</span>
<a href="#l39.308"></a><span id="l39.308" class="difflineplus">+    }</span>
<a href="#l39.309"></a><span id="l39.309" class="difflineplus">+</span>
<a href="#l39.310"></a><span id="l39.310" class="difflineplus">+    if (</span>
<a href="#l39.311"></a><span id="l39.311" class="difflineplus">+      !this._account.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l39.312"></a><span id="l39.312" class="difflineplus">+        this.name,</span>
<a href="#l39.313"></a><span id="l39.313" class="difflineplus">+        aMessage,</span>
<a href="#l39.314"></a><span id="l39.314" class="difflineplus">+      ])</span>
<a href="#l39.315"></a><span id="l39.315" class="difflineplus">+    ) {</span>
<a href="#l39.316"></a><span id="l39.316" class="difflineplus">+      this.writeMessage(</span>
<a href="#l39.317"></a><span id="l39.317" class="difflineplus">+        this._account._currentServerName,</span>
<a href="#l39.318"></a><span id="l39.318" class="difflineplus">+        _(&quot;error.sendMessageFailed&quot;),</span>
<a href="#l39.319"></a><span id="l39.319" class="difflineplus">+        { error: true, system: true }</span>
<a href="#l39.320"></a><span id="l39.320" class="difflineplus">+      );</span>
<a href="#l39.321"></a><span id="l39.321" class="difflineplus">+      return;</span>
<a href="#l39.322"></a><span id="l39.322" class="difflineplus">+    }</span>
<a href="#l39.323"></a><span id="l39.323" class="difflineplus">+</span>
<a href="#l39.324"></a><span id="l39.324" class="difflineplus">+    // Since the server doesn't send us a message back, just assume the</span>
<a href="#l39.325"></a><span id="l39.325" class="difflineplus">+    // message was received and immediately show it.</span>
<a href="#l39.326"></a><span id="l39.326" class="difflineplus">+    this.writeMessage(this._account._nickname, aMessage, { outgoing: true });</span>
<a href="#l39.327"></a><span id="l39.327" class="difflineplus">+</span>
<a href="#l39.328"></a><span id="l39.328" class="difflineplus">+    this._pendingMessage = true;</span>
<a href="#l39.329"></a><span id="l39.329" class="difflineplus">+  },</span>
<a href="#l39.330"></a><span id="l39.330" class="difflineplus">+  // IRC doesn't support typing notifications, but it does have a maximum</span>
<a href="#l39.331"></a><span id="l39.331" class="difflineplus">+  // message length.</span>
<a href="#l39.332"></a><span id="l39.332" class="difflineplus">+  sendTyping(aString) {</span>
<a href="#l39.333"></a><span id="l39.333" class="difflineplus">+    let longestLineLength = Math.max.apply(</span>
<a href="#l39.334"></a><span id="l39.334" class="difflineplus">+      null,</span>
<a href="#l39.335"></a><span id="l39.335" class="difflineplus">+      aString.split(&quot;\n&quot;).map(this._account.countBytes, this._account)</span>
<a href="#l39.336"></a><span id="l39.336" class="difflineplus">+    );</span>
<a href="#l39.337"></a><span id="l39.337" class="difflineplus">+    return this.getMaxMessageLength() - longestLineLength;</span>
<a href="#l39.338"></a><span id="l39.338" class="difflineplus">+  },</span>
<a href="#l39.339"></a><span id="l39.339" class="difflineplus">+</span>
<a href="#l39.340"></a><span id="l39.340" class="difflineplus">+  requestCurrentWhois(aNick) {</span>
<a href="#l39.341"></a><span id="l39.341" class="difflineplus">+    if (!this._observedNicks.length) {</span>
<a href="#l39.342"></a><span id="l39.342" class="difflineplus">+      Services.obs.addObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l39.343"></a><span id="l39.343" class="difflineplus">+    }</span>
<a href="#l39.344"></a><span id="l39.344" class="difflineplus">+    this._observedNicks.push(this.normalizeNick(aNick));</span>
<a href="#l39.345"></a><span id="l39.345" class="difflineplus">+    this._account.requestCurrentWhois(aNick);</span>
<a href="#l39.346"></a><span id="l39.346" class="difflineplus">+  },</span>
<a href="#l39.347"></a><span id="l39.347" class="difflineplus">+</span>
<a href="#l39.348"></a><span id="l39.348" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l39.349"></a><span id="l39.349" class="difflineplus">+    if (aTopic != &quot;user-info-received&quot;) {</span>
<a href="#l39.350"></a><span id="l39.350" class="difflineplus">+      return;</span>
<a href="#l39.351"></a><span id="l39.351" class="difflineplus">+    }</span>
<a href="#l39.352"></a><span id="l39.352" class="difflineplus">+</span>
<a href="#l39.353"></a><span id="l39.353" class="difflineplus">+    let nick = this.normalizeNick(aData);</span>
<a href="#l39.354"></a><span id="l39.354" class="difflineplus">+    let nickIndex = this._observedNicks.indexOf(nick);</span>
<a href="#l39.355"></a><span id="l39.355" class="difflineplus">+    if (nickIndex == -1) {</span>
<a href="#l39.356"></a><span id="l39.356" class="difflineplus">+      return;</span>
<a href="#l39.357"></a><span id="l39.357" class="difflineplus">+    }</span>
<a href="#l39.358"></a><span id="l39.358" class="difflineplus">+</span>
<a href="#l39.359"></a><span id="l39.359" class="difflineplus">+    // Remove the nick from the list of nicks that are being waited to received.</span>
<a href="#l39.360"></a><span id="l39.360" class="difflineplus">+    this._observedNicks.splice(nickIndex, 1);</span>
<a href="#l39.361"></a><span id="l39.361" class="difflineplus">+</span>
<a href="#l39.362"></a><span id="l39.362" class="difflineplus">+    // If this is the last nick, remove the observer.</span>
<a href="#l39.363"></a><span id="l39.363" class="difflineplus">+    if (!this._observedNicks.length) {</span>
<a href="#l39.364"></a><span id="l39.364" class="difflineplus">+      Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l39.365"></a><span id="l39.365" class="difflineplus">+    }</span>
<a href="#l39.366"></a><span id="l39.366" class="difflineplus">+</span>
<a href="#l39.367"></a><span id="l39.367" class="difflineplus">+    // If we are waiting for the conversation name, set it.</span>
<a href="#l39.368"></a><span id="l39.368" class="difflineplus">+    let account = this._account;</span>
<a href="#l39.369"></a><span id="l39.369" class="difflineplus">+    if (this._waitingForNick &amp;&amp; nick == this.normalizedName) {</span>
<a href="#l39.370"></a><span id="l39.370" class="difflineplus">+      if (account.whoisInformation.has(nick)) {</span>
<a href="#l39.371"></a><span id="l39.371" class="difflineplus">+        this.updateNick(account.whoisInformation.get(nick).nick);</span>
<a href="#l39.372"></a><span id="l39.372" class="difflineplus">+      }</span>
<a href="#l39.373"></a><span id="l39.373" class="difflineplus">+      delete this._waitingForNick;</span>
<a href="#l39.374"></a><span id="l39.374" class="difflineplus">+      return;</span>
<a href="#l39.375"></a><span id="l39.375" class="difflineplus">+    }</span>
<a href="#l39.376"></a><span id="l39.376" class="difflineplus">+</span>
<a href="#l39.377"></a><span id="l39.377" class="difflineplus">+    // Otherwise, print the requested whois information.</span>
<a href="#l39.378"></a><span id="l39.378" class="difflineplus">+    let type = { system: true, noLog: true };</span>
<a href="#l39.379"></a><span id="l39.379" class="difflineplus">+    // RFC 2812 errors 401 and 406 result in there being no entry for the nick.</span>
<a href="#l39.380"></a><span id="l39.380" class="difflineplus">+    if (!account.whoisInformation.has(nick)) {</span>
<a href="#l39.381"></a><span id="l39.381" class="difflineplus">+      this.writeMessage(null, _(&quot;message.unknownNick&quot;, nick), type);</span>
<a href="#l39.382"></a><span id="l39.382" class="difflineplus">+      return;</span>
<a href="#l39.383"></a><span id="l39.383" class="difflineplus">+    }</span>
<a href="#l39.384"></a><span id="l39.384" class="difflineplus">+    // If the nick is offline, tell the user. In that case, it's WHOWAS info.</span>
<a href="#l39.385"></a><span id="l39.385" class="difflineplus">+    let msgType = &quot;message.whois&quot;;</span>
<a href="#l39.386"></a><span id="l39.386" class="difflineplus">+    if (&quot;offline&quot; in account.whoisInformation.get(nick)) {</span>
<a href="#l39.387"></a><span id="l39.387" class="difflineplus">+      msgType = &quot;message.whowas&quot;;</span>
<a href="#l39.388"></a><span id="l39.388" class="difflineplus">+    }</span>
<a href="#l39.389"></a><span id="l39.389" class="difflineplus">+    let msg = _(msgType, account.whoisInformation.get(nick).nick);</span>
<a href="#l39.390"></a><span id="l39.390" class="difflineplus">+</span>
<a href="#l39.391"></a><span id="l39.391" class="difflineplus">+    // Iterate over each field.</span>
<a href="#l39.392"></a><span id="l39.392" class="difflineplus">+    let tooltipInfo = aSubject.QueryInterface(Ci.nsISimpleEnumerator);</span>
<a href="#l39.393"></a><span id="l39.393" class="difflineplus">+    while (tooltipInfo.hasMoreElements()) {</span>
<a href="#l39.394"></a><span id="l39.394" class="difflineplus">+      let elt = tooltipInfo.getNext().QueryInterface(Ci.prplITooltipInfo);</span>
<a href="#l39.395"></a><span id="l39.395" class="difflineplus">+      switch (elt.type) {</span>
<a href="#l39.396"></a><span id="l39.396" class="difflineplus">+        case Ci.prplITooltipInfo.pair:</span>
<a href="#l39.397"></a><span id="l39.397" class="difflineplus">+        case Ci.prplITooltipInfo.sectionHeader:</span>
<a href="#l39.398"></a><span id="l39.398" class="difflineplus">+          msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, elt.label, elt.value);</span>
<a href="#l39.399"></a><span id="l39.399" class="difflineplus">+          break;</span>
<a href="#l39.400"></a><span id="l39.400" class="difflineplus">+        case Ci.prplITooltipInfo.sectionBreak:</span>
<a href="#l39.401"></a><span id="l39.401" class="difflineplus">+          break;</span>
<a href="#l39.402"></a><span id="l39.402" class="difflineplus">+        case Ci.prplITooltipInfo.status:</span>
<a href="#l39.403"></a><span id="l39.403" class="difflineplus">+          if (elt.label != Ci.imIStatusInfo.STATUS_AWAY) {</span>
<a href="#l39.404"></a><span id="l39.404" class="difflineplus">+            break;</span>
<a href="#l39.405"></a><span id="l39.405" class="difflineplus">+          }</span>
<a href="#l39.406"></a><span id="l39.406" class="difflineplus">+          // The away message has no tooltipInfo.pair entry.</span>
<a href="#l39.407"></a><span id="l39.407" class="difflineplus">+          msg += &quot;\n&quot; + _(&quot;message.whoisEntry&quot;, _(&quot;tooltip.away&quot;), elt.value);</span>
<a href="#l39.408"></a><span id="l39.408" class="difflineplus">+          break;</span>
<a href="#l39.409"></a><span id="l39.409" class="difflineplus">+      }</span>
<a href="#l39.410"></a><span id="l39.410" class="difflineplus">+    }</span>
<a href="#l39.411"></a><span id="l39.411" class="difflineplus">+    this.writeMessage(null, msg, type);</span>
<a href="#l39.412"></a><span id="l39.412" class="difflineplus">+  },</span>
<a href="#l39.413"></a><span id="l39.413" class="difflineplus">+</span>
<a href="#l39.414"></a><span id="l39.414" class="difflineplus">+  unInitIRCConversation() {</span>
<a href="#l39.415"></a><span id="l39.415" class="difflineplus">+    this._account.removeConversation(this.name);</span>
<a href="#l39.416"></a><span id="l39.416" class="difflineplus">+    if (this._observedNicks.length) {</span>
<a href="#l39.417"></a><span id="l39.417" class="difflineplus">+      Services.obs.removeObserver(this, &quot;user-info-received&quot;);</span>
<a href="#l39.418"></a><span id="l39.418" class="difflineplus">+    }</span>
<a href="#l39.419"></a><span id="l39.419" class="difflineplus">+  },</span>
<a href="#l39.420"></a><span id="l39.420" class="difflineplus">+};</span>
<a href="#l39.421"></a><span id="l39.421" class="difflineplus">+</span>
<a href="#l39.422"></a><span id="l39.422" class="difflineplus">+function ircChannel(aAccount, aName, aNick) {</span>
<a href="#l39.423"></a><span id="l39.423" class="difflineplus">+  this._init(aAccount, aName, aNick);</span>
<a href="#l39.424"></a><span id="l39.424" class="difflineplus">+  this._participants = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l39.425"></a><span id="l39.425" class="difflineplus">+  this._modes = new Set();</span>
<a href="#l39.426"></a><span id="l39.426" class="difflineplus">+  this._observedNicks = [];</span>
<a href="#l39.427"></a><span id="l39.427" class="difflineplus">+  this.banMasks = [];</span>
<a href="#l39.428"></a><span id="l39.428" class="difflineplus">+}</span>
<a href="#l39.429"></a><span id="l39.429" class="difflineplus">+ircChannel.prototype = {</span>
<a href="#l39.430"></a><span id="l39.430" class="difflineplus">+  __proto__: GenericConvChatPrototype,</span>
<a href="#l39.431"></a><span id="l39.431" class="difflineplus">+  _modes: null,</span>
<a href="#l39.432"></a><span id="l39.432" class="difflineplus">+  _receivedInitialMode: false,</span>
<a href="#l39.433"></a><span id="l39.433" class="difflineplus">+  // For IRC you're not in a channel until the JOIN command is received, open</span>
<a href="#l39.434"></a><span id="l39.434" class="difflineplus">+  // all channels (initially) as left.</span>
<a href="#l39.435"></a><span id="l39.435" class="difflineplus">+  _left: true,</span>
<a href="#l39.436"></a><span id="l39.436" class="difflineplus">+  // True while we are rejoining a channel previously parted by the user.</span>
<a href="#l39.437"></a><span id="l39.437" class="difflineplus">+  _rejoined: false,</span>
<a href="#l39.438"></a><span id="l39.438" class="difflineplus">+  banMasks: [],</span>
<a href="#l39.439"></a><span id="l39.439" class="difflineplus">+</span>
<a href="#l39.440"></a><span id="l39.440" class="difflineplus">+  // Section 3.2.2 of RFC 2812.</span>
<a href="#l39.441"></a><span id="l39.441" class="difflineplus">+  part(aMessage) {</span>
<a href="#l39.442"></a><span id="l39.442" class="difflineplus">+    let params = [this.name];</span>
<a href="#l39.443"></a><span id="l39.443" class="difflineplus">+</span>
<a href="#l39.444"></a><span id="l39.444" class="difflineplus">+    // If a valid message was given, use it as the part message.</span>
<a href="#l39.445"></a><span id="l39.445" class="difflineplus">+    // Otherwise, fall back to the default part message, if it exists.</span>
<a href="#l39.446"></a><span id="l39.446" class="difflineplus">+    let msg = aMessage || this._account.getString(&quot;partmsg&quot;);</span>
<a href="#l39.447"></a><span id="l39.447" class="difflineplus">+    if (msg) {</span>
<a href="#l39.448"></a><span id="l39.448" class="difflineplus">+      params.push(msg);</span>
<a href="#l39.449"></a><span id="l39.449" class="difflineplus">+    }</span>
<a href="#l39.450"></a><span id="l39.450" class="difflineplus">+</span>
<a href="#l39.451"></a><span id="l39.451" class="difflineplus">+    this._account.sendMessage(&quot;PART&quot;, params);</span>
<a href="#l39.452"></a><span id="l39.452" class="difflineplus">+</span>
<a href="#l39.453"></a><span id="l39.453" class="difflineplus">+    // Remove reconnection information.</span>
<a href="#l39.454"></a><span id="l39.454" class="difflineplus">+    delete this.chatRoomFields;</span>
<a href="#l39.455"></a><span id="l39.455" class="difflineplus">+  },</span>
<a href="#l39.456"></a><span id="l39.456" class="difflineplus">+</span>
<a href="#l39.457"></a><span id="l39.457" class="difflineplus">+  close() {</span>
<a href="#l39.458"></a><span id="l39.458" class="difflineplus">+    // Part the room if we're connected.</span>
<a href="#l39.459"></a><span id="l39.459" class="difflineplus">+    if (this._account.connected &amp;&amp; !this.left) {</span>
<a href="#l39.460"></a><span id="l39.460" class="difflineplus">+      this.part();</span>
<a href="#l39.461"></a><span id="l39.461" class="difflineplus">+    }</span>
<a href="#l39.462"></a><span id="l39.462" class="difflineplus">+    GenericConvChatPrototype.close.call(this);</span>
<a href="#l39.463"></a><span id="l39.463" class="difflineplus">+  },</span>
<a href="#l39.464"></a><span id="l39.464" class="difflineplus">+</span>
<a href="#l39.465"></a><span id="l39.465" class="difflineplus">+  unInit() {</span>
<a href="#l39.466"></a><span id="l39.466" class="difflineplus">+    this.unInitIRCConversation();</span>
<a href="#l39.467"></a><span id="l39.467" class="difflineplus">+    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l39.468"></a><span id="l39.468" class="difflineplus">+  },</span>
<a href="#l39.469"></a><span id="l39.469" class="difflineplus">+</span>
<a href="#l39.470"></a><span id="l39.470" class="difflineplus">+  // Use the normalized nick in order to properly notify the observers.</span>
<a href="#l39.471"></a><span id="l39.471" class="difflineplus">+  getNormalizedChatBuddyName(aNick) {</span>
<a href="#l39.472"></a><span id="l39.472" class="difflineplus">+    return this.normalizeNick(aNick);</span>
<a href="#l39.473"></a><span id="l39.473" class="difflineplus">+  },</span>
<a href="#l39.474"></a><span id="l39.474" class="difflineplus">+</span>
<a href="#l39.475"></a><span id="l39.475" class="difflineplus">+  getParticipant(aNick, aNotifyObservers) {</span>
<a href="#l39.476"></a><span id="l39.476" class="difflineplus">+    if (this._participants.has(aNick)) {</span>
<a href="#l39.477"></a><span id="l39.477" class="difflineplus">+      return this._participants.get(aNick);</span>
<a href="#l39.478"></a><span id="l39.478" class="difflineplus">+    }</span>
<a href="#l39.479"></a><span id="l39.479" class="difflineplus">+</span>
<a href="#l39.480"></a><span id="l39.480" class="difflineplus">+    let participant = new ircParticipant(aNick, this);</span>
<a href="#l39.481"></a><span id="l39.481" class="difflineplus">+    this._participants.set(aNick, participant);</span>
<a href="#l39.482"></a><span id="l39.482" class="difflineplus">+</span>
<a href="#l39.483"></a><span id="l39.483" class="difflineplus">+    // Add the participant to the whois table if it is not already there.</span>
<a href="#l39.484"></a><span id="l39.484" class="difflineplus">+    this._account.setWhois(participant._name);</span>
<a href="#l39.485"></a><span id="l39.485" class="difflineplus">+</span>
<a href="#l39.486"></a><span id="l39.486" class="difflineplus">+    if (aNotifyObservers) {</span>
<a href="#l39.487"></a><span id="l39.487" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l39.488"></a><span id="l39.488" class="difflineplus">+        new nsSimpleEnumerator([participant]),</span>
<a href="#l39.489"></a><span id="l39.489" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l39.490"></a><span id="l39.490" class="difflineplus">+      );</span>
<a href="#l39.491"></a><span id="l39.491" class="difflineplus">+    }</span>
<a href="#l39.492"></a><span id="l39.492" class="difflineplus">+    return participant;</span>
<a href="#l39.493"></a><span id="l39.493" class="difflineplus">+  },</span>
<a href="#l39.494"></a><span id="l39.494" class="difflineplus">+</span>
<a href="#l39.495"></a><span id="l39.495" class="difflineplus">+  /*</span>
<a href="#l39.496"></a><span id="l39.496" class="difflineplus">+   * Add/remove modes from this channel.</span>
<a href="#l39.497"></a><span id="l39.497" class="difflineplus">+   *</span>
<a href="#l39.498"></a><span id="l39.498" class="difflineplus">+   * aNewMode is the new mode string, it MUST begin with + or -.</span>
<a href="#l39.499"></a><span id="l39.499" class="difflineplus">+   * aModeParams is a list of ordered string parameters for the mode string.</span>
<a href="#l39.500"></a><span id="l39.500" class="difflineplus">+   * aSetter is the nick of the person (or service) that set the mode.</span>
<a href="#l39.501"></a><span id="l39.501" class="difflineplus">+   */</span>
<a href="#l39.502"></a><span id="l39.502" class="difflineplus">+  setMode(aNewMode, aModeParams, aSetter) {</span>
<a href="#l39.503"></a><span id="l39.503" class="difflineplus">+    // Save this for a comparison after the new modes have been set.</span>
<a href="#l39.504"></a><span id="l39.504" class="difflineplus">+    let previousTopicSettable = this.topicSettable;</span>
<a href="#l39.505"></a><span id="l39.505" class="difflineplus">+</span>
<a href="#l39.506"></a><span id="l39.506" class="difflineplus">+    const hostMaskExp = /^.+!.+@.+$/;</span>
<a href="#l39.507"></a><span id="l39.507" class="difflineplus">+    function getNextParam() {</span>
<a href="#l39.508"></a><span id="l39.508" class="difflineplus">+      // If there's no next parameter, throw a warning.</span>
<a href="#l39.509"></a><span id="l39.509" class="difflineplus">+      if (!aModeParams.length) {</span>
<a href="#l39.510"></a><span id="l39.510" class="difflineplus">+        this.WARN(&quot;Mode parameter expected!&quot;);</span>
<a href="#l39.511"></a><span id="l39.511" class="difflineplus">+        return undefined;</span>
<a href="#l39.512"></a><span id="l39.512" class="difflineplus">+      }</span>
<a href="#l39.513"></a><span id="l39.513" class="difflineplus">+      return aModeParams.pop();</span>
<a href="#l39.514"></a><span id="l39.514" class="difflineplus">+    }</span>
<a href="#l39.515"></a><span id="l39.515" class="difflineplus">+    function peekNextParam() {</span>
<a href="#l39.516"></a><span id="l39.516" class="difflineplus">+      // Non-destructively gets the next param.</span>
<a href="#l39.517"></a><span id="l39.517" class="difflineplus">+      if (!aModeParams.length) {</span>
<a href="#l39.518"></a><span id="l39.518" class="difflineplus">+        return undefined;</span>
<a href="#l39.519"></a><span id="l39.519" class="difflineplus">+      }</span>
<a href="#l39.520"></a><span id="l39.520" class="difflineplus">+      return aModeParams.slice(-1)[0];</span>
<a href="#l39.521"></a><span id="l39.521" class="difflineplus">+    }</span>
<a href="#l39.522"></a><span id="l39.522" class="difflineplus">+</span>
<a href="#l39.523"></a><span id="l39.523" class="difflineplus">+    // Are modes being added or removed?</span>
<a href="#l39.524"></a><span id="l39.524" class="difflineplus">+    if (aNewMode[0] != &quot;+&quot; &amp;&amp; aNewMode[0] != &quot;-&quot;) {</span>
<a href="#l39.525"></a><span id="l39.525" class="difflineplus">+      this.WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l39.526"></a><span id="l39.526" class="difflineplus">+      return;</span>
<a href="#l39.527"></a><span id="l39.527" class="difflineplus">+    }</span>
<a href="#l39.528"></a><span id="l39.528" class="difflineplus">+    let addNewMode = aNewMode[0] == &quot;+&quot;;</span>
<a href="#l39.529"></a><span id="l39.529" class="difflineplus">+</span>
<a href="#l39.530"></a><span id="l39.530" class="difflineplus">+    // Check each mode being added and update the user.</span>
<a href="#l39.531"></a><span id="l39.531" class="difflineplus">+    let channelModes = [];</span>
<a href="#l39.532"></a><span id="l39.532" class="difflineplus">+    let userModes = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l39.533"></a><span id="l39.533" class="difflineplus">+    let msg;</span>
<a href="#l39.534"></a><span id="l39.534" class="difflineplus">+</span>
<a href="#l39.535"></a><span id="l39.535" class="difflineplus">+    for (let i = aNewMode.length - 1; i &gt; 0; --i) {</span>
<a href="#l39.536"></a><span id="l39.536" class="difflineplus">+      // Since some modes are conflicted between different server</span>
<a href="#l39.537"></a><span id="l39.537" class="difflineplus">+      // implementations, check if a participant with that name exists. If this</span>
<a href="#l39.538"></a><span id="l39.538" class="difflineplus">+      // is true, then update the mode of the ConvChatBuddy.</span>
<a href="#l39.539"></a><span id="l39.539" class="difflineplus">+      if (</span>
<a href="#l39.540"></a><span id="l39.540" class="difflineplus">+        this._account.memberStatuses.includes(aNewMode[i]) &amp;&amp;</span>
<a href="#l39.541"></a><span id="l39.541" class="difflineplus">+        aModeParams.length &amp;&amp;</span>
<a href="#l39.542"></a><span id="l39.542" class="difflineplus">+        this._participants.has(peekNextParam())</span>
<a href="#l39.543"></a><span id="l39.543" class="difflineplus">+      ) {</span>
<a href="#l39.544"></a><span id="l39.544" class="difflineplus">+        // Store the new modes for this nick (so each participant's mode is only</span>
<a href="#l39.545"></a><span id="l39.545" class="difflineplus">+        // updated once).</span>
<a href="#l39.546"></a><span id="l39.546" class="difflineplus">+        let nick = getNextParam();</span>
<a href="#l39.547"></a><span id="l39.547" class="difflineplus">+        if (!userModes.has(nick)) {</span>
<a href="#l39.548"></a><span id="l39.548" class="difflineplus">+          userModes.set(nick, []);</span>
<a href="#l39.549"></a><span id="l39.549" class="difflineplus">+        }</span>
<a href="#l39.550"></a><span id="l39.550" class="difflineplus">+        userModes.get(nick).push(aNewMode[i]);</span>
<a href="#l39.551"></a><span id="l39.551" class="difflineplus">+</span>
<a href="#l39.552"></a><span id="l39.552" class="difflineplus">+        // Don't use this mode as a channel mode.</span>
<a href="#l39.553"></a><span id="l39.553" class="difflineplus">+        continue;</span>
<a href="#l39.554"></a><span id="l39.554" class="difflineplus">+      } else if (aNewMode[i] == &quot;k&quot;) {</span>
<a href="#l39.555"></a><span id="l39.555" class="difflineplus">+        // Channel key.</span>
<a href="#l39.556"></a><span id="l39.556" class="difflineplus">+        let newFields = this.name;</span>
<a href="#l39.557"></a><span id="l39.557" class="difflineplus">+        if (addNewMode) {</span>
<a href="#l39.558"></a><span id="l39.558" class="difflineplus">+          let key = getNextParam();</span>
<a href="#l39.559"></a><span id="l39.559" class="difflineplus">+          // A new channel key was set, display a message if this key is not</span>
<a href="#l39.560"></a><span id="l39.560" class="difflineplus">+          // already known.</span>
<a href="#l39.561"></a><span id="l39.561" class="difflineplus">+          if (</span>
<a href="#l39.562"></a><span id="l39.562" class="difflineplus">+            this.chatRoomFields &amp;&amp;</span>
<a href="#l39.563"></a><span id="l39.563" class="difflineplus">+            this.chatRoomFields.getValue(&quot;password&quot;) == key</span>
<a href="#l39.564"></a><span id="l39.564" class="difflineplus">+          ) {</span>
<a href="#l39.565"></a><span id="l39.565" class="difflineplus">+            continue;</span>
<a href="#l39.566"></a><span id="l39.566" class="difflineplus">+          }</span>
<a href="#l39.567"></a><span id="l39.567" class="difflineplus">+          msg = _(&quot;message.channelKeyAdded&quot;, aSetter, key);</span>
<a href="#l39.568"></a><span id="l39.568" class="difflineplus">+          newFields += &quot; &quot; + key;</span>
<a href="#l39.569"></a><span id="l39.569" class="difflineplus">+        } else {</span>
<a href="#l39.570"></a><span id="l39.570" class="difflineplus">+          msg = _(&quot;message.channelKeyRemoved&quot;, aSetter);</span>
<a href="#l39.571"></a><span id="l39.571" class="difflineplus">+        }</span>
<a href="#l39.572"></a><span id="l39.572" class="difflineplus">+</span>
<a href="#l39.573"></a><span id="l39.573" class="difflineplus">+        this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l39.574"></a><span id="l39.574" class="difflineplus">+        // Store the new fields for reconnect.</span>
<a href="#l39.575"></a><span id="l39.575" class="difflineplus">+        this.chatRoomFields = this._account.getChatRoomDefaultFieldValues(</span>
<a href="#l39.576"></a><span id="l39.576" class="difflineplus">+          newFields</span>
<a href="#l39.577"></a><span id="l39.577" class="difflineplus">+        );</span>
<a href="#l39.578"></a><span id="l39.578" class="difflineplus">+      } else if (aNewMode[i] == &quot;b&quot;) {</span>
<a href="#l39.579"></a><span id="l39.579" class="difflineplus">+        // A banmask was added or removed.</span>
<a href="#l39.580"></a><span id="l39.580" class="difflineplus">+        let banMask = getNextParam();</span>
<a href="#l39.581"></a><span id="l39.581" class="difflineplus">+        let msgKey = &quot;message.banMask&quot;;</span>
<a href="#l39.582"></a><span id="l39.582" class="difflineplus">+        if (addNewMode) {</span>
<a href="#l39.583"></a><span id="l39.583" class="difflineplus">+          this.banMasks.push(banMask);</span>
<a href="#l39.584"></a><span id="l39.584" class="difflineplus">+          msgKey += &quot;Added&quot;;</span>
<a href="#l39.585"></a><span id="l39.585" class="difflineplus">+        } else {</span>
<a href="#l39.586"></a><span id="l39.586" class="difflineplus">+          this.banMasks = this.banMasks.filter(aBanMask =&gt; banMask != aBanMask);</span>
<a href="#l39.587"></a><span id="l39.587" class="difflineplus">+          msgKey += &quot;Removed&quot;;</span>
<a href="#l39.588"></a><span id="l39.588" class="difflineplus">+        }</span>
<a href="#l39.589"></a><span id="l39.589" class="difflineplus">+        this.writeMessage(aSetter, _(msgKey, banMask, aSetter), {</span>
<a href="#l39.590"></a><span id="l39.590" class="difflineplus">+          system: true,</span>
<a href="#l39.591"></a><span id="l39.591" class="difflineplus">+        });</span>
<a href="#l39.592"></a><span id="l39.592" class="difflineplus">+      } else if ([&quot;e&quot;, &quot;I&quot;, &quot;l&quot;].includes(aNewMode[i])) {</span>
<a href="#l39.593"></a><span id="l39.593" class="difflineplus">+        // TODO The following have parameters that must be accounted for.</span>
<a href="#l39.594"></a><span id="l39.594" class="difflineplus">+        getNextParam();</span>
<a href="#l39.595"></a><span id="l39.595" class="difflineplus">+      } else if (</span>
<a href="#l39.596"></a><span id="l39.596" class="difflineplus">+        aNewMode[i] == &quot;R&quot; &amp;&amp;</span>
<a href="#l39.597"></a><span id="l39.597" class="difflineplus">+        aModeParams.length &amp;&amp;</span>
<a href="#l39.598"></a><span id="l39.598" class="difflineplus">+        peekNextParam().match(hostMaskExp)</span>
<a href="#l39.599"></a><span id="l39.599" class="difflineplus">+      ) {</span>
<a href="#l39.600"></a><span id="l39.600" class="difflineplus">+        // REOP_LIST takes a mask as a parameter, since R is a conflicted mode,</span>
<a href="#l39.601"></a><span id="l39.601" class="difflineplus">+        // try to match the parameter. Implemented by IRCNet.</span>
<a href="#l39.602"></a><span id="l39.602" class="difflineplus">+        // TODO The parameter must be acounted for.</span>
<a href="#l39.603"></a><span id="l39.603" class="difflineplus">+        getNextParam();</span>
<a href="#l39.604"></a><span id="l39.604" class="difflineplus">+      }</span>
<a href="#l39.605"></a><span id="l39.605" class="difflineplus">+      // TODO From RFC 2811: a, i, m, n, q, p, s, r, t, l, e, I.</span>
<a href="#l39.606"></a><span id="l39.606" class="difflineplus">+</span>
<a href="#l39.607"></a><span id="l39.607" class="difflineplus">+      // Keep track of the channel modes in the order they were received.</span>
<a href="#l39.608"></a><span id="l39.608" class="difflineplus">+      channelModes.unshift(aNewMode[i]);</span>
<a href="#l39.609"></a><span id="l39.609" class="difflineplus">+    }</span>
<a href="#l39.610"></a><span id="l39.610" class="difflineplus">+</span>
<a href="#l39.611"></a><span id="l39.611" class="difflineplus">+    if (aModeParams.length) {</span>
<a href="#l39.612"></a><span id="l39.612" class="difflineplus">+      this.WARN(&quot;Unused mode parameters: &quot; + aModeParams.join(&quot;, &quot;));</span>
<a href="#l39.613"></a><span id="l39.613" class="difflineplus">+    }</span>
<a href="#l39.614"></a><span id="l39.614" class="difflineplus">+</span>
<a href="#l39.615"></a><span id="l39.615" class="difflineplus">+    // Update the mode of each participant.</span>
<a href="#l39.616"></a><span id="l39.616" class="difflineplus">+    for (let [nick, mode] of userModes.entries()) {</span>
<a href="#l39.617"></a><span id="l39.617" class="difflineplus">+      this.getParticipant(nick).setMode(addNewMode, mode, aSetter);</span>
<a href="#l39.618"></a><span id="l39.618" class="difflineplus">+    }</span>
<a href="#l39.619"></a><span id="l39.619" class="difflineplus">+</span>
<a href="#l39.620"></a><span id="l39.620" class="difflineplus">+    // If the topic can now be set (and it couldn't previously) or vice versa,</span>
<a href="#l39.621"></a><span id="l39.621" class="difflineplus">+    // notify the UI. Note that this status can change by either a channel mode</span>
<a href="#l39.622"></a><span id="l39.622" class="difflineplus">+    // or a user mode changing.</span>
<a href="#l39.623"></a><span id="l39.623" class="difflineplus">+    if (this.topicSettable != previousTopicSettable) {</span>
<a href="#l39.624"></a><span id="l39.624" class="difflineplus">+      this.notifyObservers(this, &quot;chat-update-topic&quot;);</span>
<a href="#l39.625"></a><span id="l39.625" class="difflineplus">+    }</span>
<a href="#l39.626"></a><span id="l39.626" class="difflineplus">+</span>
<a href="#l39.627"></a><span id="l39.627" class="difflineplus">+    // If no channel modes were being set, don't display a message for it.</span>
<a href="#l39.628"></a><span id="l39.628" class="difflineplus">+    if (!channelModes.length) {</span>
<a href="#l39.629"></a><span id="l39.629" class="difflineplus">+      return;</span>
<a href="#l39.630"></a><span id="l39.630" class="difflineplus">+    }</span>
<a href="#l39.631"></a><span id="l39.631" class="difflineplus">+</span>
<a href="#l39.632"></a><span id="l39.632" class="difflineplus">+    // Store the channel modes.</span>
<a href="#l39.633"></a><span id="l39.633" class="difflineplus">+    _setMode.call(this, addNewMode, channelModes);</span>
<a href="#l39.634"></a><span id="l39.634" class="difflineplus">+</span>
<a href="#l39.635"></a><span id="l39.635" class="difflineplus">+    // Notify the UI of changes.</span>
<a href="#l39.636"></a><span id="l39.636" class="difflineplus">+    msg = _(</span>
<a href="#l39.637"></a><span id="l39.637" class="difflineplus">+      &quot;message.channelmode&quot;,</span>
<a href="#l39.638"></a><span id="l39.638" class="difflineplus">+      aNewMode[0] + channelModes.join(&quot;&quot;),</span>
<a href="#l39.639"></a><span id="l39.639" class="difflineplus">+      aSetter</span>
<a href="#l39.640"></a><span id="l39.640" class="difflineplus">+    );</span>
<a href="#l39.641"></a><span id="l39.641" class="difflineplus">+    this.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l39.642"></a><span id="l39.642" class="difflineplus">+</span>
<a href="#l39.643"></a><span id="l39.643" class="difflineplus">+    this._receivedInitialMode = true;</span>
<a href="#l39.644"></a><span id="l39.644" class="difflineplus">+  },</span>
<a href="#l39.645"></a><span id="l39.645" class="difflineplus">+</span>
<a href="#l39.646"></a><span id="l39.646" class="difflineplus">+  setModesFromRestriction(aRestriction) {</span>
<a href="#l39.647"></a><span id="l39.647" class="difflineplus">+    // First remove all types from the list of modes.</span>
<a href="#l39.648"></a><span id="l39.648" class="difflineplus">+    for (let key in this._account.channelRestrictionToModeMap) {</span>
<a href="#l39.649"></a><span id="l39.649" class="difflineplus">+      let mode = this._account.channelRestrictionToModeMap[key];</span>
<a href="#l39.650"></a><span id="l39.650" class="difflineplus">+      this._modes.delete(mode);</span>
<a href="#l39.651"></a><span id="l39.651" class="difflineplus">+    }</span>
<a href="#l39.652"></a><span id="l39.652" class="difflineplus">+</span>
<a href="#l39.653"></a><span id="l39.653" class="difflineplus">+    // Add the new mode onto the list.</span>
<a href="#l39.654"></a><span id="l39.654" class="difflineplus">+    if (aRestriction in this._account.channelRestrictionToModeMap) {</span>
<a href="#l39.655"></a><span id="l39.655" class="difflineplus">+      let mode = this._account.channelRestrictionToModeMap[aRestriction];</span>
<a href="#l39.656"></a><span id="l39.656" class="difflineplus">+      if (mode) {</span>
<a href="#l39.657"></a><span id="l39.657" class="difflineplus">+        this._modes.add(mode);</span>
<a href="#l39.658"></a><span id="l39.658" class="difflineplus">+      }</span>
<a href="#l39.659"></a><span id="l39.659" class="difflineplus">+    }</span>
<a href="#l39.660"></a><span id="l39.660" class="difflineplus">+  },</span>
<a href="#l39.661"></a><span id="l39.661" class="difflineplus">+</span>
<a href="#l39.662"></a><span id="l39.662" class="difflineplus">+  get topic() {</span>
<a href="#l39.663"></a><span id="l39.663" class="difflineplus">+    return this._topic;</span>
<a href="#l39.664"></a><span id="l39.664" class="difflineplus">+  }, // can't add a setter without redefining the getter</span>
<a href="#l39.665"></a><span id="l39.665" class="difflineplus">+  set topic(aTopic) {</span>
<a href="#l39.666"></a><span id="l39.666" class="difflineplus">+    // Note that the UI isn't updated here because the server will echo back the</span>
<a href="#l39.667"></a><span id="l39.667" class="difflineplus">+    // TOPIC to us and we'll set it on receive.</span>
<a href="#l39.668"></a><span id="l39.668" class="difflineplus">+    this._account.sendMessage(&quot;TOPIC&quot;, [this.name, aTopic]);</span>
<a href="#l39.669"></a><span id="l39.669" class="difflineplus">+  },</span>
<a href="#l39.670"></a><span id="l39.670" class="difflineplus">+  get topicSettable() {</span>
<a href="#l39.671"></a><span id="l39.671" class="difflineplus">+    // Don't use getParticipant since we don't want to lazily create it!</span>
<a href="#l39.672"></a><span id="l39.672" class="difflineplus">+    let participant = this._participants.get(this.nick);</span>
<a href="#l39.673"></a><span id="l39.673" class="difflineplus">+</span>
<a href="#l39.674"></a><span id="l39.674" class="difflineplus">+    // We must be in the room to set the topic.</span>
<a href="#l39.675"></a><span id="l39.675" class="difflineplus">+    if (!participant) {</span>
<a href="#l39.676"></a><span id="l39.676" class="difflineplus">+      return false;</span>
<a href="#l39.677"></a><span id="l39.677" class="difflineplus">+    }</span>
<a href="#l39.678"></a><span id="l39.678" class="difflineplus">+</span>
<a href="#l39.679"></a><span id="l39.679" class="difflineplus">+    // If the channel mode is +t, hops and ops can set the topic; otherwise</span>
<a href="#l39.680"></a><span id="l39.680" class="difflineplus">+    // everyone can.</span>
<a href="#l39.681"></a><span id="l39.681" class="difflineplus">+    return !this._modes.has(&quot;t&quot;) || participant.op || participant.halfOp;</span>
<a href="#l39.682"></a><span id="l39.682" class="difflineplus">+  },</span>
<a href="#l39.683"></a><span id="l39.683" class="difflineplus">+  writeMessage(aMsg, aWho, aObject) {</span>
<a href="#l39.684"></a><span id="l39.684" class="difflineplus">+    const messageProps = this.handleTags(aMsg, aWho, aObject);</span>
<a href="#l39.685"></a><span id="l39.685" class="difflineplus">+    GenericConvChatPrototype.writeMessage.call(this, aMsg, aWho, messageProps);</span>
<a href="#l39.686"></a><span id="l39.686" class="difflineplus">+  },</span>
<a href="#l39.687"></a><span id="l39.687" class="difflineplus">+};</span>
<a href="#l39.688"></a><span id="l39.688" class="difflineplus">+Object.assign(ircChannel.prototype, GenericIRCConversation);</span>
<a href="#l39.689"></a><span id="l39.689" class="difflineplus">+</span>
<a href="#l39.690"></a><span id="l39.690" class="difflineplus">+function ircParticipant(aName, aConv) {</span>
<a href="#l39.691"></a><span id="l39.691" class="difflineplus">+  this._name = aName;</span>
<a href="#l39.692"></a><span id="l39.692" class="difflineplus">+  this._conv = aConv;</span>
<a href="#l39.693"></a><span id="l39.693" class="difflineplus">+  this._account = aConv._account;</span>
<a href="#l39.694"></a><span id="l39.694" class="difflineplus">+  this._modes = new Set();</span>
<a href="#l39.695"></a><span id="l39.695" class="difflineplus">+</span>
<a href="#l39.696"></a><span id="l39.696" class="difflineplus">+  // Handle multi-prefix modes.</span>
<a href="#l39.697"></a><span id="l39.697" class="difflineplus">+  let i;</span>
<a href="#l39.698"></a><span id="l39.698" class="difflineplus">+  for (</span>
<a href="#l39.699"></a><span id="l39.699" class="difflineplus">+    i = 0;</span>
<a href="#l39.700"></a><span id="l39.700" class="difflineplus">+    i &lt; this._name.length &amp;&amp; this._name[i] in this._account.userPrefixToModeMap;</span>
<a href="#l39.701"></a><span id="l39.701" class="difflineplus">+    ++i</span>
<a href="#l39.702"></a><span id="l39.702" class="difflineplus">+  ) {</span>
<a href="#l39.703"></a><span id="l39.703" class="difflineplus">+    let mode = this._account.userPrefixToModeMap[this._name[i]];</span>
<a href="#l39.704"></a><span id="l39.704" class="difflineplus">+    if (mode) {</span>
<a href="#l39.705"></a><span id="l39.705" class="difflineplus">+      this._modes.add(mode);</span>
<a href="#l39.706"></a><span id="l39.706" class="difflineplus">+    }</span>
<a href="#l39.707"></a><span id="l39.707" class="difflineplus">+  }</span>
<a href="#l39.708"></a><span id="l39.708" class="difflineplus">+  this._name = this._name.slice(i);</span>
<a href="#l39.709"></a><span id="l39.709" class="difflineplus">+}</span>
<a href="#l39.710"></a><span id="l39.710" class="difflineplus">+ircParticipant.prototype = {</span>
<a href="#l39.711"></a><span id="l39.711" class="difflineplus">+  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l39.712"></a><span id="l39.712" class="difflineplus">+</span>
<a href="#l39.713"></a><span id="l39.713" class="difflineplus">+  setMode(aAddNewMode, aNewModes, aSetter) {</span>
<a href="#l39.714"></a><span id="l39.714" class="difflineplus">+    _setMode.call(this, aAddNewMode, aNewModes);</span>
<a href="#l39.715"></a><span id="l39.715" class="difflineplus">+</span>
<a href="#l39.716"></a><span id="l39.716" class="difflineplus">+    // Notify the UI of changes.</span>
<a href="#l39.717"></a><span id="l39.717" class="difflineplus">+    let msg = _(</span>
<a href="#l39.718"></a><span id="l39.718" class="difflineplus">+      &quot;message.usermode&quot;,</span>
<a href="#l39.719"></a><span id="l39.719" class="difflineplus">+      (aAddNewMode ? &quot;+&quot; : &quot;-&quot;) + aNewModes.join(&quot;&quot;),</span>
<a href="#l39.720"></a><span id="l39.720" class="difflineplus">+      this.name,</span>
<a href="#l39.721"></a><span id="l39.721" class="difflineplus">+      aSetter</span>
<a href="#l39.722"></a><span id="l39.722" class="difflineplus">+    );</span>
<a href="#l39.723"></a><span id="l39.723" class="difflineplus">+    this._conv.writeMessage(aSetter, msg, { system: true });</span>
<a href="#l39.724"></a><span id="l39.724" class="difflineplus">+    this._conv.notifyObservers(this, &quot;chat-buddy-update&quot;);</span>
<a href="#l39.725"></a><span id="l39.725" class="difflineplus">+  },</span>
<a href="#l39.726"></a><span id="l39.726" class="difflineplus">+</span>
<a href="#l39.727"></a><span id="l39.727" class="difflineplus">+  get voiced() {</span>
<a href="#l39.728"></a><span id="l39.728" class="difflineplus">+    return this._modes.has(&quot;v&quot;);</span>
<a href="#l39.729"></a><span id="l39.729" class="difflineplus">+  },</span>
<a href="#l39.730"></a><span id="l39.730" class="difflineplus">+  get halfOp() {</span>
<a href="#l39.731"></a><span id="l39.731" class="difflineplus">+    return this._modes.has(&quot;h&quot;);</span>
<a href="#l39.732"></a><span id="l39.732" class="difflineplus">+  },</span>
<a href="#l39.733"></a><span id="l39.733" class="difflineplus">+  get op() {</span>
<a href="#l39.734"></a><span id="l39.734" class="difflineplus">+    return this._modes.has(&quot;o&quot;);</span>
<a href="#l39.735"></a><span id="l39.735" class="difflineplus">+  },</span>
<a href="#l39.736"></a><span id="l39.736" class="difflineplus">+  get founder() {</span>
<a href="#l39.737"></a><span id="l39.737" class="difflineplus">+    return this._modes.has(&quot;O&quot;) || this._modes.has(&quot;q&quot;);</span>
<a href="#l39.738"></a><span id="l39.738" class="difflineplus">+  },</span>
<a href="#l39.739"></a><span id="l39.739" class="difflineplus">+  get typing() {</span>
<a href="#l39.740"></a><span id="l39.740" class="difflineplus">+    return false;</span>
<a href="#l39.741"></a><span id="l39.741" class="difflineplus">+  },</span>
<a href="#l39.742"></a><span id="l39.742" class="difflineplus">+};</span>
<a href="#l39.743"></a><span id="l39.743" class="difflineplus">+</span>
<a href="#l39.744"></a><span id="l39.744" class="difflineplus">+function ircConversation(aAccount, aName) {</span>
<a href="#l39.745"></a><span id="l39.745" class="difflineplus">+  let nick = aAccount.normalize(aName);</span>
<a href="#l39.746"></a><span id="l39.746" class="difflineplus">+  if (aAccount.whoisInformation.has(nick)) {</span>
<a href="#l39.747"></a><span id="l39.747" class="difflineplus">+    aName = aAccount.whoisInformation.get(nick).nick;</span>
<a href="#l39.748"></a><span id="l39.748" class="difflineplus">+  }</span>
<a href="#l39.749"></a><span id="l39.749" class="difflineplus">+</span>
<a href="#l39.750"></a><span id="l39.750" class="difflineplus">+  this._init(aAccount, aName);</span>
<a href="#l39.751"></a><span id="l39.751" class="difflineplus">+  this._observedNicks = [];</span>
<a href="#l39.752"></a><span id="l39.752" class="difflineplus">+</span>
<a href="#l39.753"></a><span id="l39.753" class="difflineplus">+  // Fetch correctly capitalized name.</span>
<a href="#l39.754"></a><span id="l39.754" class="difflineplus">+  // Always request the info as it may be out of date.</span>
<a href="#l39.755"></a><span id="l39.755" class="difflineplus">+  this._waitingForNick = true;</span>
<a href="#l39.756"></a><span id="l39.756" class="difflineplus">+  this.requestCurrentWhois(aName);</span>
<a href="#l39.757"></a><span id="l39.757" class="difflineplus">+}</span>
<a href="#l39.758"></a><span id="l39.758" class="difflineplus">+ircConversation.prototype = {</span>
<a href="#l39.759"></a><span id="l39.759" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l39.760"></a><span id="l39.760" class="difflineplus">+  get buddy() {</span>
<a href="#l39.761"></a><span id="l39.761" class="difflineplus">+    return this._account.buddies.get(this.name);</span>
<a href="#l39.762"></a><span id="l39.762" class="difflineplus">+  },</span>
<a href="#l39.763"></a><span id="l39.763" class="difflineplus">+</span>
<a href="#l39.764"></a><span id="l39.764" class="difflineplus">+  unInit() {</span>
<a href="#l39.765"></a><span id="l39.765" class="difflineplus">+    this.unInitIRCConversation();</span>
<a href="#l39.766"></a><span id="l39.766" class="difflineplus">+    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l39.767"></a><span id="l39.767" class="difflineplus">+  },</span>
<a href="#l39.768"></a><span id="l39.768" class="difflineplus">+</span>
<a href="#l39.769"></a><span id="l39.769" class="difflineplus">+  updateNick(aNewNick) {</span>
<a href="#l39.770"></a><span id="l39.770" class="difflineplus">+    this._name = aNewNick;</span>
<a href="#l39.771"></a><span id="l39.771" class="difflineplus">+    this.notifyObservers(null, &quot;update-conv-title&quot;);</span>
<a href="#l39.772"></a><span id="l39.772" class="difflineplus">+  },</span>
<a href="#l39.773"></a><span id="l39.773" class="difflineplus">+  writeMessage(aMsg, aWho, aObject) {</span>
<a href="#l39.774"></a><span id="l39.774" class="difflineplus">+    const messageProps = this.handleTags(aMsg, aWho, aObject);</span>
<a href="#l39.775"></a><span id="l39.775" class="difflineplus">+    GenericConvIMPrototype.writeMessage.call(this, aMsg, aWho, messageProps);</span>
<a href="#l39.776"></a><span id="l39.776" class="difflineplus">+  },</span>
<a href="#l39.777"></a><span id="l39.777" class="difflineplus">+};</span>
<a href="#l39.778"></a><span id="l39.778" class="difflineplus">+Object.assign(ircConversation.prototype, GenericIRCConversation);</span>
<a href="#l39.779"></a><span id="l39.779" class="difflineplus">+</span>
<a href="#l39.780"></a><span id="l39.780" class="difflineplus">+function ircSocket(aAccount) {</span>
<a href="#l39.781"></a><span id="l39.781" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l39.782"></a><span id="l39.782" class="difflineplus">+  this._initCharsetConverter();</span>
<a href="#l39.783"></a><span id="l39.783" class="difflineplus">+}</span>
<a href="#l39.784"></a><span id="l39.784" class="difflineplus">+ircSocket.prototype = {</span>
<a href="#l39.785"></a><span id="l39.785" class="difflineplus">+  __proto__: Socket,</span>
<a href="#l39.786"></a><span id="l39.786" class="difflineplus">+  // Although RFCs 1459 and 2812 explicitly say that \r\n is the message</span>
<a href="#l39.787"></a><span id="l39.787" class="difflineplus">+  // separator, some networks (euIRC) only send \n.</span>
<a href="#l39.788"></a><span id="l39.788" class="difflineplus">+  delimiter: /\r?\n/,</span>
<a href="#l39.789"></a><span id="l39.789" class="difflineplus">+  connectTimeout: 60, // Failure to connect after 1 minute</span>
<a href="#l39.790"></a><span id="l39.790" class="difflineplus">+  readWriteTimeout: 300, // Failure when no data for 5 minutes</span>
<a href="#l39.791"></a><span id="l39.791" class="difflineplus">+  _converter: null,</span>
<a href="#l39.792"></a><span id="l39.792" class="difflineplus">+</span>
<a href="#l39.793"></a><span id="l39.793" class="difflineplus">+  sendPing() {</span>
<a href="#l39.794"></a><span id="l39.794" class="difflineplus">+    // Send a ping using the current timestamp as a payload prefixed with</span>
<a href="#l39.795"></a><span id="l39.795" class="difflineplus">+    // an underscore to signify this was an &quot;automatic&quot; PING (used to avoid</span>
<a href="#l39.796"></a><span id="l39.796" class="difflineplus">+    // socket timeouts).</span>
<a href="#l39.797"></a><span id="l39.797" class="difflineplus">+    this._account.sendMessage(&quot;PING&quot;, &quot;_&quot; + Date.now());</span>
<a href="#l39.798"></a><span id="l39.798" class="difflineplus">+  },</span>
<a href="#l39.799"></a><span id="l39.799" class="difflineplus">+</span>
<a href="#l39.800"></a><span id="l39.800" class="difflineplus">+  _initCharsetConverter() {</span>
<a href="#l39.801"></a><span id="l39.801" class="difflineplus">+    this._converter = Cc[</span>
<a href="#l39.802"></a><span id="l39.802" class="difflineplus">+      &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l39.803"></a><span id="l39.803" class="difflineplus">+    ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l39.804"></a><span id="l39.804" class="difflineplus">+    try {</span>
<a href="#l39.805"></a><span id="l39.805" class="difflineplus">+      this._converter.charset = this._account._encoding;</span>
<a href="#l39.806"></a><span id="l39.806" class="difflineplus">+    } catch (e) {</span>
<a href="#l39.807"></a><span id="l39.807" class="difflineplus">+      delete this._converter;</span>
<a href="#l39.808"></a><span id="l39.808" class="difflineplus">+      this.ERROR(</span>
<a href="#l39.809"></a><span id="l39.809" class="difflineplus">+        &quot;Failed to set character set to: &quot; +</span>
<a href="#l39.810"></a><span id="l39.810" class="difflineplus">+          this._account._encoding +</span>
<a href="#l39.811"></a><span id="l39.811" class="difflineplus">+          &quot; for &quot; +</span>
<a href="#l39.812"></a><span id="l39.812" class="difflineplus">+          this._account.name +</span>
<a href="#l39.813"></a><span id="l39.813" class="difflineplus">+          &quot;.&quot;</span>
<a href="#l39.814"></a><span id="l39.814" class="difflineplus">+      );</span>
<a href="#l39.815"></a><span id="l39.815" class="difflineplus">+    }</span>
<a href="#l39.816"></a><span id="l39.816" class="difflineplus">+  },</span>
<a href="#l39.817"></a><span id="l39.817" class="difflineplus">+</span>
<a href="#l39.818"></a><span id="l39.818" class="difflineplus">+  // Implement Section 5 of RFC 2812.</span>
<a href="#l39.819"></a><span id="l39.819" class="difflineplus">+  onDataReceived(aRawMessage) {</span>
<a href="#l39.820"></a><span id="l39.820" class="difflineplus">+    let conversionWarning = &quot;&quot;;</span>
<a href="#l39.821"></a><span id="l39.821" class="difflineplus">+    if (this._converter) {</span>
<a href="#l39.822"></a><span id="l39.822" class="difflineplus">+      try {</span>
<a href="#l39.823"></a><span id="l39.823" class="difflineplus">+        aRawMessage = this._converter.ConvertToUnicode(aRawMessage);</span>
<a href="#l39.824"></a><span id="l39.824" class="difflineplus">+      } catch (e) {</span>
<a href="#l39.825"></a><span id="l39.825" class="difflineplus">+        conversionWarning =</span>
<a href="#l39.826"></a><span id="l39.826" class="difflineplus">+          &quot;\nThis message doesn't seem to be &quot; +</span>
<a href="#l39.827"></a><span id="l39.827" class="difflineplus">+          this._account._encoding +</span>
<a href="#l39.828"></a><span id="l39.828" class="difflineplus">+          &quot; encoded.&quot;;</span>
<a href="#l39.829"></a><span id="l39.829" class="difflineplus">+        // Unfortunately, if the unicode converter failed once,</span>
<a href="#l39.830"></a><span id="l39.830" class="difflineplus">+        // it will keep failing so we need to reinitialize it.</span>
<a href="#l39.831"></a><span id="l39.831" class="difflineplus">+        this._initCharsetConverter();</span>
<a href="#l39.832"></a><span id="l39.832" class="difflineplus">+      }</span>
<a href="#l39.833"></a><span id="l39.833" class="difflineplus">+    }</span>
<a href="#l39.834"></a><span id="l39.834" class="difflineplus">+</span>
<a href="#l39.835"></a><span id="l39.835" class="difflineplus">+    // We've received data and are past the authentication stage.</span>
<a href="#l39.836"></a><span id="l39.836" class="difflineplus">+    if (this._account.connected) {</span>
<a href="#l39.837"></a><span id="l39.837" class="difflineplus">+      this.resetPingTimer();</span>
<a href="#l39.838"></a><span id="l39.838" class="difflineplus">+    }</span>
<a href="#l39.839"></a><span id="l39.839" class="difflineplus">+</span>
<a href="#l39.840"></a><span id="l39.840" class="difflineplus">+    // Low level dequote: replace quote character \020 followed by 0, n, r or</span>
<a href="#l39.841"></a><span id="l39.841" class="difflineplus">+    // \020 with a \0, \n, \r or \020, respectively. Any other character is</span>
<a href="#l39.842"></a><span id="l39.842" class="difflineplus">+    // replaced with itself.</span>
<a href="#l39.843"></a><span id="l39.843" class="difflineplus">+    const lowDequote = { &quot;0&quot;: &quot;\0&quot;, n: &quot;\n&quot;, r: &quot;\r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l39.844"></a><span id="l39.844" class="difflineplus">+    let dequotedMessage = aRawMessage.replace(</span>
<a href="#l39.845"></a><span id="l39.845" class="difflineplus">+      // eslint-disable-next-line no-control-regex</span>
<a href="#l39.846"></a><span id="l39.846" class="difflineplus">+      /\x10./g,</span>
<a href="#l39.847"></a><span id="l39.847" class="difflineplus">+      aStr =&gt; lowDequote[aStr[1]] || aStr[1]</span>
<a href="#l39.848"></a><span id="l39.848" class="difflineplus">+    );</span>
<a href="#l39.849"></a><span id="l39.849" class="difflineplus">+</span>
<a href="#l39.850"></a><span id="l39.850" class="difflineplus">+    try {</span>
<a href="#l39.851"></a><span id="l39.851" class="difflineplus">+      let message = new ircMessage(</span>
<a href="#l39.852"></a><span id="l39.852" class="difflineplus">+        dequotedMessage,</span>
<a href="#l39.853"></a><span id="l39.853" class="difflineplus">+        this._account._currentServerName</span>
<a href="#l39.854"></a><span id="l39.854" class="difflineplus">+      );</span>
<a href="#l39.855"></a><span id="l39.855" class="difflineplus">+      this.DEBUG(JSON.stringify(message) + conversionWarning);</span>
<a href="#l39.856"></a><span id="l39.856" class="difflineplus">+      if (!ircHandlers.handleMessage(this._account, message)) {</span>
<a href="#l39.857"></a><span id="l39.857" class="difflineplus">+        // If the message was not handled, throw a warning containing</span>
<a href="#l39.858"></a><span id="l39.858" class="difflineplus">+        // the original quoted message.</span>
<a href="#l39.859"></a><span id="l39.859" class="difflineplus">+        this.WARN(&quot;Unhandled IRC message:\n&quot; + aRawMessage);</span>
<a href="#l39.860"></a><span id="l39.860" class="difflineplus">+      }</span>
<a href="#l39.861"></a><span id="l39.861" class="difflineplus">+    } catch (e) {</span>
<a href="#l39.862"></a><span id="l39.862" class="difflineplus">+      // Catch the error, display it and hope the connection can continue with</span>
<a href="#l39.863"></a><span id="l39.863" class="difflineplus">+      // this message in error. Errors are also caught inside of handleMessage,</span>
<a href="#l39.864"></a><span id="l39.864" class="difflineplus">+      // but we expect to handle message parsing errors here.</span>
<a href="#l39.865"></a><span id="l39.865" class="difflineplus">+      this.DEBUG(aRawMessage + conversionWarning);</span>
<a href="#l39.866"></a><span id="l39.866" class="difflineplus">+      this.ERROR(e);</span>
<a href="#l39.867"></a><span id="l39.867" class="difflineplus">+    }</span>
<a href="#l39.868"></a><span id="l39.868" class="difflineplus">+  },</span>
<a href="#l39.869"></a><span id="l39.869" class="difflineplus">+  onConnection() {</span>
<a href="#l39.870"></a><span id="l39.870" class="difflineplus">+    this._account._connectionRegistration();</span>
<a href="#l39.871"></a><span id="l39.871" class="difflineplus">+  },</span>
<a href="#l39.872"></a><span id="l39.872" class="difflineplus">+  disconnect() {</span>
<a href="#l39.873"></a><span id="l39.873" class="difflineplus">+    if (!this._account) {</span>
<a href="#l39.874"></a><span id="l39.874" class="difflineplus">+      return;</span>
<a href="#l39.875"></a><span id="l39.875" class="difflineplus">+    }</span>
<a href="#l39.876"></a><span id="l39.876" class="difflineplus">+    Socket.disconnect.call(this);</span>
<a href="#l39.877"></a><span id="l39.877" class="difflineplus">+    delete this._account;</span>
<a href="#l39.878"></a><span id="l39.878" class="difflineplus">+  },</span>
<a href="#l39.879"></a><span id="l39.879" class="difflineplus">+</span>
<a href="#l39.880"></a><span id="l39.880" class="difflineplus">+  // Throw errors if the socket has issues.</span>
<a href="#l39.881"></a><span id="l39.881" class="difflineplus">+  onConnectionClosed() {</span>
<a href="#l39.882"></a><span id="l39.882" class="difflineplus">+    // If the account was already disconnected, e.g. in response to</span>
<a href="#l39.883"></a><span id="l39.883" class="difflineplus">+    // onConnectionReset, do nothing.</span>
<a href="#l39.884"></a><span id="l39.884" class="difflineplus">+    if (!this._account) {</span>
<a href="#l39.885"></a><span id="l39.885" class="difflineplus">+      return;</span>
<a href="#l39.886"></a><span id="l39.886" class="difflineplus">+    }</span>
<a href="#l39.887"></a><span id="l39.887" class="difflineplus">+    const msg = &quot;Connection closed by server.&quot;;</span>
<a href="#l39.888"></a><span id="l39.888" class="difflineplus">+    if (this._account.disconnecting) {</span>
<a href="#l39.889"></a><span id="l39.889" class="difflineplus">+      // The server closed the connection before we handled the ERROR</span>
<a href="#l39.890"></a><span id="l39.890" class="difflineplus">+      // response to QUIT.</span>
<a href="#l39.891"></a><span id="l39.891" class="difflineplus">+      this.LOG(msg);</span>
<a href="#l39.892"></a><span id="l39.892" class="difflineplus">+      this._account.gotDisconnected();</span>
<a href="#l39.893"></a><span id="l39.893" class="difflineplus">+    } else {</span>
<a href="#l39.894"></a><span id="l39.894" class="difflineplus">+      this.WARN(msg);</span>
<a href="#l39.895"></a><span id="l39.895" class="difflineplus">+      this._account.gotDisconnected(</span>
<a href="#l39.896"></a><span id="l39.896" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l39.897"></a><span id="l39.897" class="difflineplus">+        _(&quot;connection.error.lost&quot;)</span>
<a href="#l39.898"></a><span id="l39.898" class="difflineplus">+      );</span>
<a href="#l39.899"></a><span id="l39.899" class="difflineplus">+    }</span>
<a href="#l39.900"></a><span id="l39.900" class="difflineplus">+  },</span>
<a href="#l39.901"></a><span id="l39.901" class="difflineplus">+  onConnectionReset() {</span>
<a href="#l39.902"></a><span id="l39.902" class="difflineplus">+    this.WARN(&quot;Connection reset.&quot;);</span>
<a href="#l39.903"></a><span id="l39.903" class="difflineplus">+    this._account.gotDisconnected(</span>
<a href="#l39.904"></a><span id="l39.904" class="difflineplus">+      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l39.905"></a><span id="l39.905" class="difflineplus">+      _(&quot;connection.error.lost&quot;)</span>
<a href="#l39.906"></a><span id="l39.906" class="difflineplus">+    );</span>
<a href="#l39.907"></a><span id="l39.907" class="difflineplus">+  },</span>
<a href="#l39.908"></a><span id="l39.908" class="difflineplus">+  onConnectionTimedOut() {</span>
<a href="#l39.909"></a><span id="l39.909" class="difflineplus">+    this.WARN(&quot;Connection timed out.&quot;);</span>
<a href="#l39.910"></a><span id="l39.910" class="difflineplus">+    this._account.gotDisconnected(</span>
<a href="#l39.911"></a><span id="l39.911" class="difflineplus">+      Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l39.912"></a><span id="l39.912" class="difflineplus">+      _(&quot;connection.error.timeOut&quot;)</span>
<a href="#l39.913"></a><span id="l39.913" class="difflineplus">+    );</span>
<a href="#l39.914"></a><span id="l39.914" class="difflineplus">+  },</span>
<a href="#l39.915"></a><span id="l39.915" class="difflineplus">+  onBadCertificate(aIsSslError, aNSSErrorMessage) {</span>
<a href="#l39.916"></a><span id="l39.916" class="difflineplus">+    this.WARN(</span>
<a href="#l39.917"></a><span id="l39.917" class="difflineplus">+      &quot;Bad certificate or SSL connection for &quot; +</span>
<a href="#l39.918"></a><span id="l39.918" class="difflineplus">+        this._account.name +</span>
<a href="#l39.919"></a><span id="l39.919" class="difflineplus">+        &quot;:\n&quot; +</span>
<a href="#l39.920"></a><span id="l39.920" class="difflineplus">+        aNSSErrorMessage</span>
<a href="#l39.921"></a><span id="l39.921" class="difflineplus">+    );</span>
<a href="#l39.922"></a><span id="l39.922" class="difflineplus">+    let error = this._account.handleBadCertificate(this, aIsSslError);</span>
<a href="#l39.923"></a><span id="l39.923" class="difflineplus">+    this._account.gotDisconnected(error, aNSSErrorMessage);</span>
<a href="#l39.924"></a><span id="l39.924" class="difflineplus">+  },</span>
<a href="#l39.925"></a><span id="l39.925" class="difflineplus">+</span>
<a href="#l39.926"></a><span id="l39.926" class="difflineplus">+  get DEBUG() {</span>
<a href="#l39.927"></a><span id="l39.927" class="difflineplus">+    return this._account.DEBUG;</span>
<a href="#l39.928"></a><span id="l39.928" class="difflineplus">+  },</span>
<a href="#l39.929"></a><span id="l39.929" class="difflineplus">+  get LOG() {</span>
<a href="#l39.930"></a><span id="l39.930" class="difflineplus">+    return this._account.LOG;</span>
<a href="#l39.931"></a><span id="l39.931" class="difflineplus">+  },</span>
<a href="#l39.932"></a><span id="l39.932" class="difflineplus">+  get WARN() {</span>
<a href="#l39.933"></a><span id="l39.933" class="difflineplus">+    return this._account.WARN;</span>
<a href="#l39.934"></a><span id="l39.934" class="difflineplus">+  },</span>
<a href="#l39.935"></a><span id="l39.935" class="difflineplus">+  get ERROR() {</span>
<a href="#l39.936"></a><span id="l39.936" class="difflineplus">+    return this._account.ERROR;</span>
<a href="#l39.937"></a><span id="l39.937" class="difflineplus">+  },</span>
<a href="#l39.938"></a><span id="l39.938" class="difflineplus">+};</span>
<a href="#l39.939"></a><span id="l39.939" class="difflineplus">+</span>
<a href="#l39.940"></a><span id="l39.940" class="difflineplus">+function ircAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l39.941"></a><span id="l39.941" class="difflineplus">+  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l39.942"></a><span id="l39.942" class="difflineplus">+}</span>
<a href="#l39.943"></a><span id="l39.943" class="difflineplus">+ircAccountBuddy.prototype = {</span>
<a href="#l39.944"></a><span id="l39.944" class="difflineplus">+  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l39.945"></a><span id="l39.945" class="difflineplus">+</span>
<a href="#l39.946"></a><span id="l39.946" class="difflineplus">+  // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l39.947"></a><span id="l39.947" class="difflineplus">+  // hovers over the buddy.</span>
<a href="#l39.948"></a><span id="l39.948" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l39.949"></a><span id="l39.949" class="difflineplus">+    return this._account.getBuddyInfo(this.normalizedName);</span>
<a href="#l39.950"></a><span id="l39.950" class="difflineplus">+  },</span>
<a href="#l39.951"></a><span id="l39.951" class="difflineplus">+</span>
<a href="#l39.952"></a><span id="l39.952" class="difflineplus">+  // Allow sending of messages to buddies even if they are not online since IRC</span>
<a href="#l39.953"></a><span id="l39.953" class="difflineplus">+  // does not always provide status information in a timely fashion. (Note that</span>
<a href="#l39.954"></a><span id="l39.954" class="difflineplus">+  // this is OK since the server will throw an error if the user is not online.)</span>
<a href="#l39.955"></a><span id="l39.955" class="difflineplus">+  get canSendMessage() {</span>
<a href="#l39.956"></a><span id="l39.956" class="difflineplus">+    return this.account.connected;</span>
<a href="#l39.957"></a><span id="l39.957" class="difflineplus">+  },</span>
<a href="#l39.958"></a><span id="l39.958" class="difflineplus">+</span>
<a href="#l39.959"></a><span id="l39.959" class="difflineplus">+  // Called when the user wants to chat with the buddy.</span>
<a href="#l39.960"></a><span id="l39.960" class="difflineplus">+  createConversation() {</span>
<a href="#l39.961"></a><span id="l39.961" class="difflineplus">+    return this._account.createConversation(this.userName);</span>
<a href="#l39.962"></a><span id="l39.962" class="difflineplus">+  },</span>
<a href="#l39.963"></a><span id="l39.963" class="difflineplus">+</span>
<a href="#l39.964"></a><span id="l39.964" class="difflineplus">+  remove() {</span>
<a href="#l39.965"></a><span id="l39.965" class="difflineplus">+    this._account.removeBuddy(this);</span>
<a href="#l39.966"></a><span id="l39.966" class="difflineplus">+    GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l39.967"></a><span id="l39.967" class="difflineplus">+  },</span>
<a href="#l39.968"></a><span id="l39.968" class="difflineplus">+};</span>
<a href="#l39.969"></a><span id="l39.969" class="difflineplus">+</span>
<a href="#l39.970"></a><span id="l39.970" class="difflineplus">+function ircRoomInfo(aName, aAccount) {</span>
<a href="#l39.971"></a><span id="l39.971" class="difflineplus">+  this.name = aName;</span>
<a href="#l39.972"></a><span id="l39.972" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l39.973"></a><span id="l39.973" class="difflineplus">+}</span>
<a href="#l39.974"></a><span id="l39.974" class="difflineplus">+ircRoomInfo.prototype = {</span>
<a href="#l39.975"></a><span id="l39.975" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIRoomInfo&quot;, &quot;IRC RoomInfo Object&quot;),</span>
<a href="#l39.976"></a><span id="l39.976" class="difflineplus">+  get topic() {</span>
<a href="#l39.977"></a><span id="l39.977" class="difflineplus">+    return this._account._channelList.get(this.name).topic;</span>
<a href="#l39.978"></a><span id="l39.978" class="difflineplus">+  },</span>
<a href="#l39.979"></a><span id="l39.979" class="difflineplus">+  get participantCount() {</span>
<a href="#l39.980"></a><span id="l39.980" class="difflineplus">+    return this._account._channelList.get(this.name).participantCount;</span>
<a href="#l39.981"></a><span id="l39.981" class="difflineplus">+  },</span>
<a href="#l39.982"></a><span id="l39.982" class="difflineplus">+  get chatRoomFieldValues() {</span>
<a href="#l39.983"></a><span id="l39.983" class="difflineplus">+    return this._account.getChatRoomDefaultFieldValues(this.name);</span>
<a href="#l39.984"></a><span id="l39.984" class="difflineplus">+  },</span>
<a href="#l39.985"></a><span id="l39.985" class="difflineplus">+};</span>
<a href="#l39.986"></a><span id="l39.986" class="difflineplus">+</span>
<a href="#l39.987"></a><span id="l39.987" class="difflineplus">+function ircAccount(aProtocol, aImAccount) {</span>
<a href="#l39.988"></a><span id="l39.988" class="difflineplus">+  this._init(aProtocol, aImAccount);</span>
<a href="#l39.989"></a><span id="l39.989" class="difflineplus">+  this.buddies = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l39.990"></a><span id="l39.990" class="difflineplus">+  this.conversations = new NormalizedMap(this.normalize.bind(this));</span>
<a href="#l39.991"></a><span id="l39.991" class="difflineplus">+</span>
<a href="#l39.992"></a><span id="l39.992" class="difflineplus">+  // Split the account name into usable parts.</span>
<a href="#l39.993"></a><span id="l39.993" class="difflineplus">+  let splitter = this.name.lastIndexOf(&quot;@&quot;);</span>
<a href="#l39.994"></a><span id="l39.994" class="difflineplus">+  this._accountNickname = this.name.slice(0, splitter);</span>
<a href="#l39.995"></a><span id="l39.995" class="difflineplus">+  this._server = this.name.slice(splitter + 1);</span>
<a href="#l39.996"></a><span id="l39.996" class="difflineplus">+  // To avoid _currentServerName being null, initialize it to the server being</span>
<a href="#l39.997"></a><span id="l39.997" class="difflineplus">+  // connected to. This will also get overridden during the 001 response from</span>
<a href="#l39.998"></a><span id="l39.998" class="difflineplus">+  // the server.</span>
<a href="#l39.999"></a><span id="l39.999" class="difflineplus">+  this._currentServerName = this._server;</span>
<a href="#l39.1000"></a><span id="l39.1000" class="difflineplus">+</span>
<a href="#l39.1001"></a><span id="l39.1001" class="difflineplus">+  this._nickname = this._accountNickname;</span>
<a href="#l39.1002"></a><span id="l39.1002" class="difflineplus">+  this._requestedNickname = this._nickname;</span>
<a href="#l39.1003"></a><span id="l39.1003" class="difflineplus">+</span>
<a href="#l39.1004"></a><span id="l39.1004" class="difflineplus">+  // For more information, see where these are defined in the prototype below.</span>
<a href="#l39.1005"></a><span id="l39.1005" class="difflineplus">+  this.trackQueue = [];</span>
<a href="#l39.1006"></a><span id="l39.1006" class="difflineplus">+  this.pendingIsOnQueue = [];</span>
<a href="#l39.1007"></a><span id="l39.1007" class="difflineplus">+  this.whoisInformation = new NormalizedMap(this.normalizeNick.bind(this));</span>
<a href="#l39.1008"></a><span id="l39.1008" class="difflineplus">+  this._requestedCAPs = new Set();</span>
<a href="#l39.1009"></a><span id="l39.1009" class="difflineplus">+  this._availableCAPs = new Set();</span>
<a href="#l39.1010"></a><span id="l39.1010" class="difflineplus">+  this._activeCAPs = new Set();</span>
<a href="#l39.1011"></a><span id="l39.1011" class="difflineplus">+  this._queuedCAPs = [];</span>
<a href="#l39.1012"></a><span id="l39.1012" class="difflineplus">+  this._commandBuffers = new Map();</span>
<a href="#l39.1013"></a><span id="l39.1013" class="difflineplus">+  this._roomInfoCallbacks = new Set();</span>
<a href="#l39.1014"></a><span id="l39.1014" class="difflineplus">+}</span>
<a href="#l39.1015"></a><span id="l39.1015" class="difflineplus">+ircAccount.prototype = {</span>
<a href="#l39.1016"></a><span id="l39.1016" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l39.1017"></a><span id="l39.1017" class="difflineplus">+  _socket: null,</span>
<a href="#l39.1018"></a><span id="l39.1018" class="difflineplus">+  _MODE_WALLOPS: 1 &lt;&lt; 2, // mode 'w'</span>
<a href="#l39.1019"></a><span id="l39.1019" class="difflineplus">+  _MODE_INVISIBLE: 1 &lt;&lt; 3, // mode 'i'</span>
<a href="#l39.1020"></a><span id="l39.1020" class="difflineplus">+  get _mode() {</span>
<a href="#l39.1021"></a><span id="l39.1021" class="difflineplus">+    return 0;</span>
<a href="#l39.1022"></a><span id="l39.1022" class="difflineplus">+  },</span>
<a href="#l39.1023"></a><span id="l39.1023" class="difflineplus">+</span>
<a href="#l39.1024"></a><span id="l39.1024" class="difflineplus">+  // The name of the server we last connected to.</span>
<a href="#l39.1025"></a><span id="l39.1025" class="difflineplus">+  _currentServerName: null,</span>
<a href="#l39.1026"></a><span id="l39.1026" class="difflineplus">+  // Whether to attempt authenticating with NickServ.</span>
<a href="#l39.1027"></a><span id="l39.1027" class="difflineplus">+  shouldAuthenticate: true,</span>
<a href="#l39.1028"></a><span id="l39.1028" class="difflineplus">+  // Whether the user has successfully authenticated with NickServ.</span>
<a href="#l39.1029"></a><span id="l39.1029" class="difflineplus">+  isAuthenticated: false,</span>
<a href="#l39.1030"></a><span id="l39.1030" class="difflineplus">+  // The current in use nickname.</span>
<a href="#l39.1031"></a><span id="l39.1031" class="difflineplus">+  _nickname: null,</span>
<a href="#l39.1032"></a><span id="l39.1032" class="difflineplus">+  // The nickname stored in the account name.</span>
<a href="#l39.1033"></a><span id="l39.1033" class="difflineplus">+  _accountNickname: null,</span>
<a href="#l39.1034"></a><span id="l39.1034" class="difflineplus">+  // The nickname that was last requested by the user.</span>
<a href="#l39.1035"></a><span id="l39.1035" class="difflineplus">+  _requestedNickname: null,</span>
<a href="#l39.1036"></a><span id="l39.1036" class="difflineplus">+  // The nickname that was last requested. This can differ from</span>
<a href="#l39.1037"></a><span id="l39.1037" class="difflineplus">+  // _requestedNickname when a new nick is automatically generated (e.g. by</span>
<a href="#l39.1038"></a><span id="l39.1038" class="difflineplus">+  // adding digits).</span>
<a href="#l39.1039"></a><span id="l39.1039" class="difflineplus">+  _sentNickname: null,</span>
<a href="#l39.1040"></a><span id="l39.1040" class="difflineplus">+  // If we don't get the desired nick on connect, we try again a bit later,</span>
<a href="#l39.1041"></a><span id="l39.1041" class="difflineplus">+  // to see if it wasn't just our nick not having timed out yet.</span>
<a href="#l39.1042"></a><span id="l39.1042" class="difflineplus">+  _nickInUseTimeout: null,</span>
<a href="#l39.1043"></a><span id="l39.1043" class="difflineplus">+  get username() {</span>
<a href="#l39.1044"></a><span id="l39.1044" class="difflineplus">+    let username;</span>
<a href="#l39.1045"></a><span id="l39.1045" class="difflineplus">+    // Use a custom username in a hidden preference.</span>
<a href="#l39.1046"></a><span id="l39.1046" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;username&quot;)) {</span>
<a href="#l39.1047"></a><span id="l39.1047" class="difflineplus">+      username = this.getString(&quot;username&quot;);</span>
<a href="#l39.1048"></a><span id="l39.1048" class="difflineplus">+    }</span>
<a href="#l39.1049"></a><span id="l39.1049" class="difflineplus">+    // But fallback to brandShortName if no username is provided (or is empty).</span>
<a href="#l39.1050"></a><span id="l39.1050" class="difflineplus">+    if (!username) {</span>
<a href="#l39.1051"></a><span id="l39.1051" class="difflineplus">+      username = Services.appinfo.name;</span>
<a href="#l39.1052"></a><span id="l39.1052" class="difflineplus">+    }</span>
<a href="#l39.1053"></a><span id="l39.1053" class="difflineplus">+</span>
<a href="#l39.1054"></a><span id="l39.1054" class="difflineplus">+    return username;</span>
<a href="#l39.1055"></a><span id="l39.1055" class="difflineplus">+  },</span>
<a href="#l39.1056"></a><span id="l39.1056" class="difflineplus">+  // The prefix minus the nick (!user@host) as returned by the server, this is</span>
<a href="#l39.1057"></a><span id="l39.1057" class="difflineplus">+  // necessary for guessing message lengths.</span>
<a href="#l39.1058"></a><span id="l39.1058" class="difflineplus">+  prefix: null,</span>
<a href="#l39.1059"></a><span id="l39.1059" class="difflineplus">+</span>
<a href="#l39.1060"></a><span id="l39.1060" class="difflineplus">+  // Parts of the specification give max lengths, keep track of them since a</span>
<a href="#l39.1061"></a><span id="l39.1061" class="difflineplus">+  // server can overwrite them. The defaults given here are from RFC 2812.</span>
<a href="#l39.1062"></a><span id="l39.1062" class="difflineplus">+  maxNicknameLength: 9, // 1.2.1 Users</span>
<a href="#l39.1063"></a><span id="l39.1063" class="difflineplus">+  maxChannelLength: 50, // 1.3 Channels</span>
<a href="#l39.1064"></a><span id="l39.1064" class="difflineplus">+  maxMessageLength: 512, // 2.3 Messages</span>
<a href="#l39.1065"></a><span id="l39.1065" class="difflineplus">+  maxHostnameLength: 63, // 2.3.1 Message format in Augmented BNF</span>
<a href="#l39.1066"></a><span id="l39.1066" class="difflineplus">+</span>
<a href="#l39.1067"></a><span id="l39.1067" class="difflineplus">+  // The default prefixes to modes.</span>
<a href="#l39.1068"></a><span id="l39.1068" class="difflineplus">+  userPrefixToModeMap: { &quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot; },</span>
<a href="#l39.1069"></a><span id="l39.1069" class="difflineplus">+  get userPrefixes() {</span>
<a href="#l39.1070"></a><span id="l39.1070" class="difflineplus">+    return Object.keys(this.userPrefixToModeMap);</span>
<a href="#l39.1071"></a><span id="l39.1071" class="difflineplus">+  },</span>
<a href="#l39.1072"></a><span id="l39.1072" class="difflineplus">+  // Modes that have a nickname parameter and affect a participant. See 4.1</span>
<a href="#l39.1073"></a><span id="l39.1073" class="difflineplus">+  // Member Status of RFC 2811.</span>
<a href="#l39.1074"></a><span id="l39.1074" class="difflineplus">+  memberStatuses: [&quot;a&quot;, &quot;h&quot;, &quot;o&quot;, &quot;O&quot;, &quot;q&quot;, &quot;v&quot;, &quot;!&quot;],</span>
<a href="#l39.1075"></a><span id="l39.1075" class="difflineplus">+  channelPrefixes: [&quot;&amp;&quot;, &quot;#&quot;, &quot;+&quot;, &quot;!&quot;], // 1.3 Channels</span>
<a href="#l39.1076"></a><span id="l39.1076" class="difflineplus">+  channelRestrictionToModeMap: { &quot;@&quot;: &quot;s&quot;, &quot;*&quot;: &quot;p&quot;, &quot;=&quot;: null }, // 353 RPL_NAMREPLY</span>
<a href="#l39.1077"></a><span id="l39.1077" class="difflineplus">+</span>
<a href="#l39.1078"></a><span id="l39.1078" class="difflineplus">+  // Handle Scandanavian lower case (optionally remove status indicators).</span>
<a href="#l39.1079"></a><span id="l39.1079" class="difflineplus">+  // See Section 2.2 of RFC 2812: the characters {}|^ are considered to be the</span>
<a href="#l39.1080"></a><span id="l39.1080" class="difflineplus">+  // lower case equivalents of the characters []\~, respectively.</span>
<a href="#l39.1081"></a><span id="l39.1081" class="difflineplus">+  normalizeExpression: /[\x41-\x5E]/g,</span>
<a href="#l39.1082"></a><span id="l39.1082" class="difflineplus">+  normalize(aStr, aPrefixes) {</span>
<a href="#l39.1083"></a><span id="l39.1083" class="difflineplus">+    let str = aStr;</span>
<a href="#l39.1084"></a><span id="l39.1084" class="difflineplus">+</span>
<a href="#l39.1085"></a><span id="l39.1085" class="difflineplus">+    if (aPrefixes) {</span>
<a href="#l39.1086"></a><span id="l39.1086" class="difflineplus">+      while (aPrefixes.includes(str[0])) {</span>
<a href="#l39.1087"></a><span id="l39.1087" class="difflineplus">+        str = str.slice(1);</span>
<a href="#l39.1088"></a><span id="l39.1088" class="difflineplus">+      }</span>
<a href="#l39.1089"></a><span id="l39.1089" class="difflineplus">+    }</span>
<a href="#l39.1090"></a><span id="l39.1090" class="difflineplus">+</span>
<a href="#l39.1091"></a><span id="l39.1091" class="difflineplus">+    return str.replace(this.normalizeExpression, c =&gt;</span>
<a href="#l39.1092"></a><span id="l39.1092" class="difflineplus">+      String.fromCharCode(c.charCodeAt(0) + 0x20)</span>
<a href="#l39.1093"></a><span id="l39.1093" class="difflineplus">+    );</span>
<a href="#l39.1094"></a><span id="l39.1094" class="difflineplus">+  },</span>
<a href="#l39.1095"></a><span id="l39.1095" class="difflineplus">+  normalizeNick(aNick) {</span>
<a href="#l39.1096"></a><span id="l39.1096" class="difflineplus">+    return this.normalize(aNick, this.userPrefixes);</span>
<a href="#l39.1097"></a><span id="l39.1097" class="difflineplus">+  },</span>
<a href="#l39.1098"></a><span id="l39.1098" class="difflineplus">+</span>
<a href="#l39.1099"></a><span id="l39.1099" class="difflineplus">+  isMUCName(aStr) {</span>
<a href="#l39.1100"></a><span id="l39.1100" class="difflineplus">+    return this.channelPrefixes.includes(aStr[0]);</span>
<a href="#l39.1101"></a><span id="l39.1101" class="difflineplus">+  },</span>
<a href="#l39.1102"></a><span id="l39.1102" class="difflineplus">+</span>
<a href="#l39.1103"></a><span id="l39.1103" class="difflineplus">+  // Tell the server about status changes. IRC is only away or not away;</span>
<a href="#l39.1104"></a><span id="l39.1104" class="difflineplus">+  // consider the away, idle and unavailable status type to be away.</span>
<a href="#l39.1105"></a><span id="l39.1105" class="difflineplus">+  isAway: false,</span>
<a href="#l39.1106"></a><span id="l39.1106" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l39.1107"></a><span id="l39.1107" class="difflineplus">+    if (aTopic != &quot;status-changed&quot;) {</span>
<a href="#l39.1108"></a><span id="l39.1108" class="difflineplus">+      return;</span>
<a href="#l39.1109"></a><span id="l39.1109" class="difflineplus">+    }</span>
<a href="#l39.1110"></a><span id="l39.1110" class="difflineplus">+</span>
<a href="#l39.1111"></a><span id="l39.1111" class="difflineplus">+    let { statusType: type, statusText: text } = this.imAccount.statusInfo;</span>
<a href="#l39.1112"></a><span id="l39.1112" class="difflineplus">+    this.DEBUG(&quot;New status received:\ntype = &quot; + type + &quot;\ntext = &quot; + text);</span>
<a href="#l39.1113"></a><span id="l39.1113" class="difflineplus">+</span>
<a href="#l39.1114"></a><span id="l39.1114" class="difflineplus">+    // Tell the server to mark us as away.</span>
<a href="#l39.1115"></a><span id="l39.1115" class="difflineplus">+    if (type &lt; Ci.imIStatusInfo.STATUS_AVAILABLE) {</span>
<a href="#l39.1116"></a><span id="l39.1116" class="difflineplus">+      // We have to have a string in order to set IRC as AWAY.</span>
<a href="#l39.1117"></a><span id="l39.1117" class="difflineplus">+      if (!text) {</span>
<a href="#l39.1118"></a><span id="l39.1118" class="difflineplus">+        // If no status is given, use the the default idle/away message.</span>
<a href="#l39.1119"></a><span id="l39.1119" class="difflineplus">+        const IDLE_PREF_BRANCH = &quot;messenger.status.&quot;;</span>
<a href="#l39.1120"></a><span id="l39.1120" class="difflineplus">+        const IDLE_PREF = &quot;defaultIdleAwayMessage&quot;;</span>
<a href="#l39.1121"></a><span id="l39.1121" class="difflineplus">+        text = Services.prefs.getComplexValue(</span>
<a href="#l39.1122"></a><span id="l39.1122" class="difflineplus">+          IDLE_PREF_BRANCH + IDLE_PREF,</span>
<a href="#l39.1123"></a><span id="l39.1123" class="difflineplus">+          Ci.nsIPrefLocalizedString</span>
<a href="#l39.1124"></a><span id="l39.1124" class="difflineplus">+        ).data;</span>
<a href="#l39.1125"></a><span id="l39.1125" class="difflineplus">+</span>
<a href="#l39.1126"></a><span id="l39.1126" class="difflineplus">+        if (!text) {</span>
<a href="#l39.1127"></a><span id="l39.1127" class="difflineplus">+          // Get the default value of the localized preference.</span>
<a href="#l39.1128"></a><span id="l39.1128" class="difflineplus">+          text = Services.prefs</span>
<a href="#l39.1129"></a><span id="l39.1129" class="difflineplus">+            .getDefaultBranch(IDLE_PREF_BRANCH)</span>
<a href="#l39.1130"></a><span id="l39.1130" class="difflineplus">+            .getComplexValue(IDLE_PREF, Ci.nsIPrefLocalizedString).data;</span>
<a href="#l39.1131"></a><span id="l39.1131" class="difflineplus">+        }</span>
<a href="#l39.1132"></a><span id="l39.1132" class="difflineplus">+        // The last resort, fallback to a non-localized string.</span>
<a href="#l39.1133"></a><span id="l39.1133" class="difflineplus">+        if (!text) {</span>
<a href="#l39.1134"></a><span id="l39.1134" class="difflineplus">+          text = &quot;Away&quot;;</span>
<a href="#l39.1135"></a><span id="l39.1135" class="difflineplus">+        }</span>
<a href="#l39.1136"></a><span id="l39.1136" class="difflineplus">+      }</span>
<a href="#l39.1137"></a><span id="l39.1137" class="difflineplus">+      this.sendMessage(&quot;AWAY&quot;, text); // Mark as away.</span>
<a href="#l39.1138"></a><span id="l39.1138" class="difflineplus">+    } else if (type == Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; this.isAway) {</span>
<a href="#l39.1139"></a><span id="l39.1139" class="difflineplus">+      // Mark as back.</span>
<a href="#l39.1140"></a><span id="l39.1140" class="difflineplus">+      this.sendMessage(&quot;AWAY&quot;);</span>
<a href="#l39.1141"></a><span id="l39.1141" class="difflineplus">+    }</span>
<a href="#l39.1142"></a><span id="l39.1142" class="difflineplus">+  },</span>
<a href="#l39.1143"></a><span id="l39.1143" class="difflineplus">+</span>
<a href="#l39.1144"></a><span id="l39.1144" class="difflineplus">+  // The user's user mode.</span>
<a href="#l39.1145"></a><span id="l39.1145" class="difflineplus">+  _modes: null,</span>
<a href="#l39.1146"></a><span id="l39.1146" class="difflineplus">+  _userModeReceived: false,</span>
<a href="#l39.1147"></a><span id="l39.1147" class="difflineplus">+  setUserMode(aNick, aNewModes, aSetter, aDisplayFullMode) {</span>
<a href="#l39.1148"></a><span id="l39.1148" class="difflineplus">+    if (this.normalizeNick(aNick) != this.normalizeNick(this._nickname)) {</span>
<a href="#l39.1149"></a><span id="l39.1149" class="difflineplus">+      this.WARN(&quot;Received unexpected mode for &quot; + aNick);</span>
<a href="#l39.1150"></a><span id="l39.1150" class="difflineplus">+      return false;</span>
<a href="#l39.1151"></a><span id="l39.1151" class="difflineplus">+    }</span>
<a href="#l39.1152"></a><span id="l39.1152" class="difflineplus">+</span>
<a href="#l39.1153"></a><span id="l39.1153" class="difflineplus">+    // Are modes being added or removed?</span>
<a href="#l39.1154"></a><span id="l39.1154" class="difflineplus">+    let addNewMode = aNewModes[0] == &quot;+&quot;;</span>
<a href="#l39.1155"></a><span id="l39.1155" class="difflineplus">+    if (!addNewMode &amp;&amp; aNewModes[0] != &quot;-&quot;) {</span>
<a href="#l39.1156"></a><span id="l39.1156" class="difflineplus">+      this.WARN(&quot;Invalid mode string: &quot; + aNewModes);</span>
<a href="#l39.1157"></a><span id="l39.1157" class="difflineplus">+      return false;</span>
<a href="#l39.1158"></a><span id="l39.1158" class="difflineplus">+    }</span>
<a href="#l39.1159"></a><span id="l39.1159" class="difflineplus">+    _setMode.call(this, addNewMode, aNewModes.slice(1));</span>
<a href="#l39.1160"></a><span id="l39.1160" class="difflineplus">+</span>
<a href="#l39.1161"></a><span id="l39.1161" class="difflineplus">+    // The server informs us of the user's mode when connecting.</span>
<a href="#l39.1162"></a><span id="l39.1162" class="difflineplus">+    // We should not report this initial mode message as a mode change</span>
<a href="#l39.1163"></a><span id="l39.1163" class="difflineplus">+    // initiated by the user, but instead display the full mode</span>
<a href="#l39.1164"></a><span id="l39.1164" class="difflineplus">+    // and then remember we have done so.</span>
<a href="#l39.1165"></a><span id="l39.1165" class="difflineplus">+    this._userModeReceived = true;</span>
<a href="#l39.1166"></a><span id="l39.1166" class="difflineplus">+</span>
<a href="#l39.1167"></a><span id="l39.1167" class="difflineplus">+    if (this._showServerTab) {</span>
<a href="#l39.1168"></a><span id="l39.1168" class="difflineplus">+      let msg;</span>
<a href="#l39.1169"></a><span id="l39.1169" class="difflineplus">+      if (aDisplayFullMode) {</span>
<a href="#l39.1170"></a><span id="l39.1170" class="difflineplus">+        msg = _(&quot;message.yourmode&quot;, Array.from(this._modes).join(&quot;&quot;));</span>
<a href="#l39.1171"></a><span id="l39.1171" class="difflineplus">+      } else {</span>
<a href="#l39.1172"></a><span id="l39.1172" class="difflineplus">+        msg = _(</span>
<a href="#l39.1173"></a><span id="l39.1173" class="difflineplus">+          &quot;message.usermode&quot;,</span>
<a href="#l39.1174"></a><span id="l39.1174" class="difflineplus">+          aNewModes,</span>
<a href="#l39.1175"></a><span id="l39.1175" class="difflineplus">+          aNick,</span>
<a href="#l39.1176"></a><span id="l39.1176" class="difflineplus">+          aSetter || this._currentServerName</span>
<a href="#l39.1177"></a><span id="l39.1177" class="difflineplus">+        );</span>
<a href="#l39.1178"></a><span id="l39.1178" class="difflineplus">+      }</span>
<a href="#l39.1179"></a><span id="l39.1179" class="difflineplus">+      this.getConversation(this._currentServerName).writeMessage(</span>
<a href="#l39.1180"></a><span id="l39.1180" class="difflineplus">+        this._currentServerName,</span>
<a href="#l39.1181"></a><span id="l39.1181" class="difflineplus">+        msg,</span>
<a href="#l39.1182"></a><span id="l39.1182" class="difflineplus">+        { system: true }</span>
<a href="#l39.1183"></a><span id="l39.1183" class="difflineplus">+      );</span>
<a href="#l39.1184"></a><span id="l39.1184" class="difflineplus">+    }</span>
<a href="#l39.1185"></a><span id="l39.1185" class="difflineplus">+    return true;</span>
<a href="#l39.1186"></a><span id="l39.1186" class="difflineplus">+  },</span>
<a href="#l39.1187"></a><span id="l39.1187" class="difflineplus">+</span>
<a href="#l39.1188"></a><span id="l39.1188" class="difflineplus">+  // Room info: maps channel names to {topic, participantCount}.</span>
<a href="#l39.1189"></a><span id="l39.1189" class="difflineplus">+  _channelList: new Map(),</span>
<a href="#l39.1190"></a><span id="l39.1190" class="difflineplus">+  _roomInfoCallbacks: new Set(),</span>
<a href="#l39.1191"></a><span id="l39.1191" class="difflineplus">+  // If true, we have sent the LIST request and are waiting for replies.</span>
<a href="#l39.1192"></a><span id="l39.1192" class="difflineplus">+  _pendingList: false,</span>
<a href="#l39.1193"></a><span id="l39.1193" class="difflineplus">+  // Callbacks receive this many channels per call while results are incoming.</span>
<a href="#l39.1194"></a><span id="l39.1194" class="difflineplus">+  _channelsPerBatch: 50,</span>
<a href="#l39.1195"></a><span id="l39.1195" class="difflineplus">+  _currentBatch: [],</span>
<a href="#l39.1196"></a><span id="l39.1196" class="difflineplus">+  _lastListTime: 0,</span>
<a href="#l39.1197"></a><span id="l39.1197" class="difflineplus">+  get isRoomInfoStale() {</span>
<a href="#l39.1198"></a><span id="l39.1198" class="difflineplus">+    return Date.now() - this._lastListTime &gt; kListRefreshInterval;</span>
<a href="#l39.1199"></a><span id="l39.1199" class="difflineplus">+  },</span>
<a href="#l39.1200"></a><span id="l39.1200" class="difflineplus">+  // Called by consumers that want a list of available channels, which are</span>
<a href="#l39.1201"></a><span id="l39.1201" class="difflineplus">+  // provided through the callback (prplIRoomInfoCallback instance).</span>
<a href="#l39.1202"></a><span id="l39.1202" class="difflineplus">+  requestRoomInfo(aCallback, aIsUserRequest) {</span>
<a href="#l39.1203"></a><span id="l39.1203" class="difflineplus">+    // Ignore the automaticList pref if the user explicitly requests /list.</span>
<a href="#l39.1204"></a><span id="l39.1204" class="difflineplus">+    if (</span>
<a href="#l39.1205"></a><span id="l39.1205" class="difflineplus">+      !aIsUserRequest &amp;&amp;</span>
<a href="#l39.1206"></a><span id="l39.1206" class="difflineplus">+      !Services.prefs.getBoolPref(&quot;chat.irc.automaticList&quot;)</span>
<a href="#l39.1207"></a><span id="l39.1207" class="difflineplus">+    ) {</span>
<a href="#l39.1208"></a><span id="l39.1208" class="difflineplus">+      // Pretend we can't return roomInfo.</span>
<a href="#l39.1209"></a><span id="l39.1209" class="difflineplus">+      throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l39.1210"></a><span id="l39.1210" class="difflineplus">+    }</span>
<a href="#l39.1211"></a><span id="l39.1211" class="difflineplus">+    if (this._roomInfoCallbacks.has(aCallback)) {</span>
<a href="#l39.1212"></a><span id="l39.1212" class="difflineplus">+      // Callback is not new.</span>
<a href="#l39.1213"></a><span id="l39.1213" class="difflineplus">+      return;</span>
<a href="#l39.1214"></a><span id="l39.1214" class="difflineplus">+    }</span>
<a href="#l39.1215"></a><span id="l39.1215" class="difflineplus">+    // Send a LIST request if the channel list is stale and a current request</span>
<a href="#l39.1216"></a><span id="l39.1216" class="difflineplus">+    // has not been sent.</span>
<a href="#l39.1217"></a><span id="l39.1217" class="difflineplus">+    if (this.isRoomInfoStale &amp;&amp; !this._pendingList) {</span>
<a href="#l39.1218"></a><span id="l39.1218" class="difflineplus">+      this._channelList = new Map();</span>
<a href="#l39.1219"></a><span id="l39.1219" class="difflineplus">+      this._currentBatch = [];</span>
<a href="#l39.1220"></a><span id="l39.1220" class="difflineplus">+      this._pendingList = true;</span>
<a href="#l39.1221"></a><span id="l39.1221" class="difflineplus">+      this._lastListTime = Date.now();</span>
<a href="#l39.1222"></a><span id="l39.1222" class="difflineplus">+      this.sendMessage(&quot;LIST&quot;);</span>
<a href="#l39.1223"></a><span id="l39.1223" class="difflineplus">+    } else {</span>
<a href="#l39.1224"></a><span id="l39.1224" class="difflineplus">+      // Otherwise, pass channels that have already been received to the callback.</span>
<a href="#l39.1225"></a><span id="l39.1225" class="difflineplus">+      let rooms = [...this._channelList.keys()];</span>
<a href="#l39.1226"></a><span id="l39.1226" class="difflineplus">+      aCallback.onRoomInfoAvailable(rooms, !this._pendingList);</span>
<a href="#l39.1227"></a><span id="l39.1227" class="difflineplus">+    }</span>
<a href="#l39.1228"></a><span id="l39.1228" class="difflineplus">+</span>
<a href="#l39.1229"></a><span id="l39.1229" class="difflineplus">+    if (this._pendingList) {</span>
<a href="#l39.1230"></a><span id="l39.1230" class="difflineplus">+      this._roomInfoCallbacks.add(aCallback);</span>
<a href="#l39.1231"></a><span id="l39.1231" class="difflineplus">+    }</span>
<a href="#l39.1232"></a><span id="l39.1232" class="difflineplus">+  },</span>
<a href="#l39.1233"></a><span id="l39.1233" class="difflineplus">+  // Pass room info for any remaining channels to callbacks and clean up.</span>
<a href="#l39.1234"></a><span id="l39.1234" class="difflineplus">+  _sendRemainingRoomInfo() {</span>
<a href="#l39.1235"></a><span id="l39.1235" class="difflineplus">+    if (this._currentBatch.length) {</span>
<a href="#l39.1236"></a><span id="l39.1236" class="difflineplus">+      for (let callback of this._roomInfoCallbacks) {</span>
<a href="#l39.1237"></a><span id="l39.1237" class="difflineplus">+        callback.onRoomInfoAvailable(this._currentBatch, true);</span>
<a href="#l39.1238"></a><span id="l39.1238" class="difflineplus">+      }</span>
<a href="#l39.1239"></a><span id="l39.1239" class="difflineplus">+    }</span>
<a href="#l39.1240"></a><span id="l39.1240" class="difflineplus">+    this._roomInfoCallbacks.clear();</span>
<a href="#l39.1241"></a><span id="l39.1241" class="difflineplus">+    delete this._pendingList;</span>
<a href="#l39.1242"></a><span id="l39.1242" class="difflineplus">+    delete this._currentBatch;</span>
<a href="#l39.1243"></a><span id="l39.1243" class="difflineplus">+  },</span>
<a href="#l39.1244"></a><span id="l39.1244" class="difflineplus">+  getRoomInfo(aName) {</span>
<a href="#l39.1245"></a><span id="l39.1245" class="difflineplus">+    return new ircRoomInfo(aName, this);</span>
<a href="#l39.1246"></a><span id="l39.1246" class="difflineplus">+  },</span>
<a href="#l39.1247"></a><span id="l39.1247" class="difflineplus">+</span>
<a href="#l39.1248"></a><span id="l39.1248" class="difflineplus">+  // The last time a buffered command was sent.</span>
<a href="#l39.1249"></a><span id="l39.1249" class="difflineplus">+  _lastCommandSendTime: 0,</span>
<a href="#l39.1250"></a><span id="l39.1250" class="difflineplus">+  // A map from command names to the parameter buffer for that command.</span>
<a href="#l39.1251"></a><span id="l39.1251" class="difflineplus">+  // This buffer is a map from first parameter to the corresponding (optional)</span>
<a href="#l39.1252"></a><span id="l39.1252" class="difflineplus">+  // second parameter, to ensure automatic deduplication.</span>
<a href="#l39.1253"></a><span id="l39.1253" class="difflineplus">+  _commandBuffers: new Map(),</span>
<a href="#l39.1254"></a><span id="l39.1254" class="difflineplus">+  _handleCommandBuffer(aCommand) {</span>
<a href="#l39.1255"></a><span id="l39.1255" class="difflineplus">+    let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l39.1256"></a><span id="l39.1256" class="difflineplus">+    if (!buffer || !buffer.size) {</span>
<a href="#l39.1257"></a><span id="l39.1257" class="difflineplus">+      return;</span>
<a href="#l39.1258"></a><span id="l39.1258" class="difflineplus">+    }</span>
<a href="#l39.1259"></a><span id="l39.1259" class="difflineplus">+    // This short delay should usually not affect commands triggered by</span>
<a href="#l39.1260"></a><span id="l39.1260" class="difflineplus">+    // user action, but helps gather commands together which are sent</span>
<a href="#l39.1261"></a><span id="l39.1261" class="difflineplus">+    // by the prpl on connection (e.g. WHOIS sent in response to incoming</span>
<a href="#l39.1262"></a><span id="l39.1262" class="difflineplus">+    // WATCH results).</span>
<a href="#l39.1263"></a><span id="l39.1263" class="difflineplus">+    const kInterval = 1000;</span>
<a href="#l39.1264"></a><span id="l39.1264" class="difflineplus">+    let delay = kInterval - (Date.now() - this._lastCommandSendTime);</span>
<a href="#l39.1265"></a><span id="l39.1265" class="difflineplus">+    if (delay &gt; 0) {</span>
<a href="#l39.1266"></a><span id="l39.1266" class="difflineplus">+      setTimeout(() =&gt; this._handleCommandBuffer(aCommand), delay);</span>
<a href="#l39.1267"></a><span id="l39.1267" class="difflineplus">+      return;</span>
<a href="#l39.1268"></a><span id="l39.1268" class="difflineplus">+    }</span>
<a href="#l39.1269"></a><span id="l39.1269" class="difflineplus">+    this._lastCommandSendTime = Date.now();</span>
<a href="#l39.1270"></a><span id="l39.1270" class="difflineplus">+</span>
<a href="#l39.1271"></a><span id="l39.1271" class="difflineplus">+    let getParams = aItems =&gt; {</span>
<a href="#l39.1272"></a><span id="l39.1272" class="difflineplus">+      // Taking the JOIN use case as an example, aItems is an array</span>
<a href="#l39.1273"></a><span id="l39.1273" class="difflineplus">+      // of [channel, key] pairs.</span>
<a href="#l39.1274"></a><span id="l39.1274" class="difflineplus">+      // To work around an inspircd bug (bug 1108596), we reorder</span>
<a href="#l39.1275"></a><span id="l39.1275" class="difflineplus">+      // the list so that entries with keys appear first.</span>
<a href="#l39.1276"></a><span id="l39.1276" class="difflineplus">+      let items = aItems.slice().sort(([c1, k1], [c2, k2]) =&gt; {</span>
<a href="#l39.1277"></a><span id="l39.1277" class="difflineplus">+        if (!k1 &amp;&amp; k2) {</span>
<a href="#l39.1278"></a><span id="l39.1278" class="difflineplus">+          return 1;</span>
<a href="#l39.1279"></a><span id="l39.1279" class="difflineplus">+        }</span>
<a href="#l39.1280"></a><span id="l39.1280" class="difflineplus">+        if (k1 &amp;&amp; !k2) {</span>
<a href="#l39.1281"></a><span id="l39.1281" class="difflineplus">+          return -1;</span>
<a href="#l39.1282"></a><span id="l39.1282" class="difflineplus">+        }</span>
<a href="#l39.1283"></a><span id="l39.1283" class="difflineplus">+        return 0;</span>
<a href="#l39.1284"></a><span id="l39.1284" class="difflineplus">+      });</span>
<a href="#l39.1285"></a><span id="l39.1285" class="difflineplus">+      // To send the command, we have to group all the channels and keys</span>
<a href="#l39.1286"></a><span id="l39.1286" class="difflineplus">+      // together, i.e. grab the columns of this matrix, and build the two</span>
<a href="#l39.1287"></a><span id="l39.1287" class="difflineplus">+      // parameters of the command from that.</span>
<a href="#l39.1288"></a><span id="l39.1288" class="difflineplus">+      let channels = items.map(([channel, key]) =&gt; channel);</span>
<a href="#l39.1289"></a><span id="l39.1289" class="difflineplus">+      let keys = items.map(([channel, key]) =&gt; key).filter(key =&gt; !!key);</span>
<a href="#l39.1290"></a><span id="l39.1290" class="difflineplus">+      let params = [channels.join(&quot;,&quot;)];</span>
<a href="#l39.1291"></a><span id="l39.1291" class="difflineplus">+      if (keys.length) {</span>
<a href="#l39.1292"></a><span id="l39.1292" class="difflineplus">+        params.push(keys.join(&quot;,&quot;));</span>
<a href="#l39.1293"></a><span id="l39.1293" class="difflineplus">+      }</span>
<a href="#l39.1294"></a><span id="l39.1294" class="difflineplus">+      return params;</span>
<a href="#l39.1295"></a><span id="l39.1295" class="difflineplus">+    };</span>
<a href="#l39.1296"></a><span id="l39.1296" class="difflineplus">+    let tooMany = aItems =&gt; {</span>
<a href="#l39.1297"></a><span id="l39.1297" class="difflineplus">+      let params = getParams(aItems);</span>
<a href="#l39.1298"></a><span id="l39.1298" class="difflineplus">+      let length = this.countBytes(this.buildMessage(aCommand, params)) + 2;</span>
<a href="#l39.1299"></a><span id="l39.1299" class="difflineplus">+      return this.maxMessageLength &lt; length;</span>
<a href="#l39.1300"></a><span id="l39.1300" class="difflineplus">+    };</span>
<a href="#l39.1301"></a><span id="l39.1301" class="difflineplus">+    let send = aItems =&gt; {</span>
<a href="#l39.1302"></a><span id="l39.1302" class="difflineplus">+      let params = getParams(aItems);</span>
<a href="#l39.1303"></a><span id="l39.1303" class="difflineplus">+      // Send the command, but don't log the keys.</span>
<a href="#l39.1304"></a><span id="l39.1304" class="difflineplus">+      this.sendMessage(</span>
<a href="#l39.1305"></a><span id="l39.1305" class="difflineplus">+        aCommand,</span>
<a href="#l39.1306"></a><span id="l39.1306" class="difflineplus">+        params,</span>
<a href="#l39.1307"></a><span id="l39.1307" class="difflineplus">+        aCommand +</span>
<a href="#l39.1308"></a><span id="l39.1308" class="difflineplus">+          &quot; &quot; +</span>
<a href="#l39.1309"></a><span id="l39.1309" class="difflineplus">+          params[0] +</span>
<a href="#l39.1310"></a><span id="l39.1310" class="difflineplus">+          (params.length &gt; 1 ? &quot; &lt;keys not logged&gt;&quot; : &quot;&quot;)</span>
<a href="#l39.1311"></a><span id="l39.1311" class="difflineplus">+      );</span>
<a href="#l39.1312"></a><span id="l39.1312" class="difflineplus">+    };</span>
<a href="#l39.1313"></a><span id="l39.1313" class="difflineplus">+</span>
<a href="#l39.1314"></a><span id="l39.1314" class="difflineplus">+    let items = [];</span>
<a href="#l39.1315"></a><span id="l39.1315" class="difflineplus">+    for (let item of buffer) {</span>
<a href="#l39.1316"></a><span id="l39.1316" class="difflineplus">+      items.push(item);</span>
<a href="#l39.1317"></a><span id="l39.1317" class="difflineplus">+      if (tooMany(items)) {</span>
<a href="#l39.1318"></a><span id="l39.1318" class="difflineplus">+        items.pop();</span>
<a href="#l39.1319"></a><span id="l39.1319" class="difflineplus">+        send(items);</span>
<a href="#l39.1320"></a><span id="l39.1320" class="difflineplus">+        items = [item];</span>
<a href="#l39.1321"></a><span id="l39.1321" class="difflineplus">+      }</span>
<a href="#l39.1322"></a><span id="l39.1322" class="difflineplus">+    }</span>
<a href="#l39.1323"></a><span id="l39.1323" class="difflineplus">+    send(items);</span>
<a href="#l39.1324"></a><span id="l39.1324" class="difflineplus">+    buffer.clear();</span>
<a href="#l39.1325"></a><span id="l39.1325" class="difflineplus">+  },</span>
<a href="#l39.1326"></a><span id="l39.1326" class="difflineplus">+  // For commands which allow an arbitrary number of parameters, we use a</span>
<a href="#l39.1327"></a><span id="l39.1327" class="difflineplus">+  // buffer to send as few commands as possible, by gathering the parameters.</span>
<a href="#l39.1328"></a><span id="l39.1328" class="difflineplus">+  // On servers which impose command penalties (e.g. inspircd) this helps</span>
<a href="#l39.1329"></a><span id="l39.1329" class="difflineplus">+  // avoid triggering fakelags by minimizing the command penalty.</span>
<a href="#l39.1330"></a><span id="l39.1330" class="difflineplus">+  // aParam is the first and aKey the optional second parameter of a command</span>
<a href="#l39.1331"></a><span id="l39.1331" class="difflineplus">+  // with the syntax &lt;param&gt; *(&quot;,&quot; &lt;param&gt;) [&lt;key&gt; *(&quot;,&quot; &lt;key&gt;)]</span>
<a href="#l39.1332"></a><span id="l39.1332" class="difflineplus">+  // While this code is mostly abstracted, it is currently assumed the second</span>
<a href="#l39.1333"></a><span id="l39.1333" class="difflineplus">+  // parameter is only used for JOIN.</span>
<a href="#l39.1334"></a><span id="l39.1334" class="difflineplus">+  sendBufferedCommand(aCommand, aParam, aKey = &quot;&quot;) {</span>
<a href="#l39.1335"></a><span id="l39.1335" class="difflineplus">+    if (!this._commandBuffers.has(aCommand)) {</span>
<a href="#l39.1336"></a><span id="l39.1336" class="difflineplus">+      this._commandBuffers.set(aCommand, new Map());</span>
<a href="#l39.1337"></a><span id="l39.1337" class="difflineplus">+    }</span>
<a href="#l39.1338"></a><span id="l39.1338" class="difflineplus">+    let buffer = this._commandBuffers.get(aCommand);</span>
<a href="#l39.1339"></a><span id="l39.1339" class="difflineplus">+    // If the buffer is empty, schedule sending the command, otherwise</span>
<a href="#l39.1340"></a><span id="l39.1340" class="difflineplus">+    // we just need to add the parameter to the buffer.</span>
<a href="#l39.1341"></a><span id="l39.1341" class="difflineplus">+    // We use executeSoon so as to not delay the sending of these</span>
<a href="#l39.1342"></a><span id="l39.1342" class="difflineplus">+    // commands when it is not necessary.</span>
<a href="#l39.1343"></a><span id="l39.1343" class="difflineplus">+    if (!buffer.size) {</span>
<a href="#l39.1344"></a><span id="l39.1344" class="difflineplus">+      executeSoon(() =&gt; this._handleCommandBuffer(aCommand));</span>
<a href="#l39.1345"></a><span id="l39.1345" class="difflineplus">+    }</span>
<a href="#l39.1346"></a><span id="l39.1346" class="difflineplus">+    buffer.set(aParam, aKey);</span>
<a href="#l39.1347"></a><span id="l39.1347" class="difflineplus">+  },</span>
<a href="#l39.1348"></a><span id="l39.1348" class="difflineplus">+</span>
<a href="#l39.1349"></a><span id="l39.1349" class="difflineplus">+  // The whois information: nicks are used as keys and refer to a map of field</span>
<a href="#l39.1350"></a><span id="l39.1350" class="difflineplus">+  // to value.</span>
<a href="#l39.1351"></a><span id="l39.1351" class="difflineplus">+  whoisInformation: null,</span>
<a href="#l39.1352"></a><span id="l39.1352" class="difflineplus">+  // Request WHOIS information on a buddy when the user requests more</span>
<a href="#l39.1353"></a><span id="l39.1353" class="difflineplus">+  // information. If we already have some WHOIS information stored for this</span>
<a href="#l39.1354"></a><span id="l39.1354" class="difflineplus">+  // nick, a notification with this (potentially out-of-date) information</span>
<a href="#l39.1355"></a><span id="l39.1355" class="difflineplus">+  // is sent out immediately. It is followed by another notification when</span>
<a href="#l39.1356"></a><span id="l39.1356" class="difflineplus">+  // the current WHOIS data is returned by the server.</span>
<a href="#l39.1357"></a><span id="l39.1357" class="difflineplus">+  // If you are only interested in the current WHOIS, requestCurrentWhois</span>
<a href="#l39.1358"></a><span id="l39.1358" class="difflineplus">+  // should be used instead.</span>
<a href="#l39.1359"></a><span id="l39.1359" class="difflineplus">+  requestBuddyInfo(aBuddyName) {</span>
<a href="#l39.1360"></a><span id="l39.1360" class="difflineplus">+    if (!this.connected) {</span>
<a href="#l39.1361"></a><span id="l39.1361" class="difflineplus">+      return;</span>
<a href="#l39.1362"></a><span id="l39.1362" class="difflineplus">+    }</span>
<a href="#l39.1363"></a><span id="l39.1363" class="difflineplus">+</span>
<a href="#l39.1364"></a><span id="l39.1364" class="difflineplus">+    // Return what we have stored immediately.</span>
<a href="#l39.1365"></a><span id="l39.1365" class="difflineplus">+    if (this.whoisInformation.has(aBuddyName)) {</span>
<a href="#l39.1366"></a><span id="l39.1366" class="difflineplus">+      this.notifyWhois(aBuddyName);</span>
<a href="#l39.1367"></a><span id="l39.1367" class="difflineplus">+    }</span>
<a href="#l39.1368"></a><span id="l39.1368" class="difflineplus">+</span>
<a href="#l39.1369"></a><span id="l39.1369" class="difflineplus">+    // Request the current whois and update.</span>
<a href="#l39.1370"></a><span id="l39.1370" class="difflineplus">+    this.requestCurrentWhois(aBuddyName);</span>
<a href="#l39.1371"></a><span id="l39.1371" class="difflineplus">+  },</span>
<a href="#l39.1372"></a><span id="l39.1372" class="difflineplus">+  // Request fresh WHOIS information on a nick.</span>
<a href="#l39.1373"></a><span id="l39.1373" class="difflineplus">+  requestCurrentWhois(aNick) {</span>
<a href="#l39.1374"></a><span id="l39.1374" class="difflineplus">+    if (!this.connected) {</span>
<a href="#l39.1375"></a><span id="l39.1375" class="difflineplus">+      return;</span>
<a href="#l39.1376"></a><span id="l39.1376" class="difflineplus">+    }</span>
<a href="#l39.1377"></a><span id="l39.1377" class="difflineplus">+</span>
<a href="#l39.1378"></a><span id="l39.1378" class="difflineplus">+    this.removeBuddyInfo(aNick);</span>
<a href="#l39.1379"></a><span id="l39.1379" class="difflineplus">+    this.sendBufferedCommand(&quot;WHOIS&quot;, aNick);</span>
<a href="#l39.1380"></a><span id="l39.1380" class="difflineplus">+  },</span>
<a href="#l39.1381"></a><span id="l39.1381" class="difflineplus">+  notifyWhois(aNick) {</span>
<a href="#l39.1382"></a><span id="l39.1382" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l39.1383"></a><span id="l39.1383" class="difflineplus">+      this.getBuddyInfo(aNick),</span>
<a href="#l39.1384"></a><span id="l39.1384" class="difflineplus">+      &quot;user-info-received&quot;,</span>
<a href="#l39.1385"></a><span id="l39.1385" class="difflineplus">+      this.normalizeNick(aNick)</span>
<a href="#l39.1386"></a><span id="l39.1386" class="difflineplus">+    );</span>
<a href="#l39.1387"></a><span id="l39.1387" class="difflineplus">+  },</span>
<a href="#l39.1388"></a><span id="l39.1388" class="difflineplus">+  // Request WHOWAS information on a buddy when the user requests more</span>
<a href="#l39.1389"></a><span id="l39.1389" class="difflineplus">+  // information.</span>
<a href="#l39.1390"></a><span id="l39.1390" class="difflineplus">+  requestOfflineBuddyInfo(aBuddyName) {</span>
<a href="#l39.1391"></a><span id="l39.1391" class="difflineplus">+    this.removeBuddyInfo(aBuddyName);</span>
<a href="#l39.1392"></a><span id="l39.1392" class="difflineplus">+    this.sendMessage(&quot;WHOWAS&quot;, aBuddyName);</span>
<a href="#l39.1393"></a><span id="l39.1393" class="difflineplus">+  },</span>
<a href="#l39.1394"></a><span id="l39.1394" class="difflineplus">+  // Return an nsISimpleEnumerator of imITooltipInfo for a given nick.</span>
<a href="#l39.1395"></a><span id="l39.1395" class="difflineplus">+  getBuddyInfo(aNick) {</span>
<a href="#l39.1396"></a><span id="l39.1396" class="difflineplus">+    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l39.1397"></a><span id="l39.1397" class="difflineplus">+      return EmptyEnumerator;</span>
<a href="#l39.1398"></a><span id="l39.1398" class="difflineplus">+    }</span>
<a href="#l39.1399"></a><span id="l39.1399" class="difflineplus">+</span>
<a href="#l39.1400"></a><span id="l39.1400" class="difflineplus">+    let whoisInformation = this.whoisInformation.get(aNick);</span>
<a href="#l39.1401"></a><span id="l39.1401" class="difflineplus">+    if (whoisInformation.serverName &amp;&amp; whoisInformation.serverInfo) {</span>
<a href="#l39.1402"></a><span id="l39.1402" class="difflineplus">+      whoisInformation.server = _(</span>
<a href="#l39.1403"></a><span id="l39.1403" class="difflineplus">+        &quot;tooltip.serverValue&quot;,</span>
<a href="#l39.1404"></a><span id="l39.1404" class="difflineplus">+        whoisInformation.serverName,</span>
<a href="#l39.1405"></a><span id="l39.1405" class="difflineplus">+        whoisInformation.serverInfo</span>
<a href="#l39.1406"></a><span id="l39.1406" class="difflineplus">+      );</span>
<a href="#l39.1407"></a><span id="l39.1407" class="difflineplus">+    }</span>
<a href="#l39.1408"></a><span id="l39.1408" class="difflineplus">+</span>
<a href="#l39.1409"></a><span id="l39.1409" class="difflineplus">+    // Sort the list of channels, ignoring the prefixes of channel and user.</span>
<a href="#l39.1410"></a><span id="l39.1410" class="difflineplus">+    let prefixes = this.userPrefixes.concat(this.channelPrefixes);</span>
<a href="#l39.1411"></a><span id="l39.1411" class="difflineplus">+    let sortWithoutPrefix = function(a, b) {</span>
<a href="#l39.1412"></a><span id="l39.1412" class="difflineplus">+      a = this.normalize(a, prefixes);</span>
<a href="#l39.1413"></a><span id="l39.1413" class="difflineplus">+      b = this.normalize(b, prefixes);</span>
<a href="#l39.1414"></a><span id="l39.1414" class="difflineplus">+      if (a &lt; b) {</span>
<a href="#l39.1415"></a><span id="l39.1415" class="difflineplus">+        return -1;</span>
<a href="#l39.1416"></a><span id="l39.1416" class="difflineplus">+      }</span>
<a href="#l39.1417"></a><span id="l39.1417" class="difflineplus">+      return a &gt; b ? 1 : 0;</span>
<a href="#l39.1418"></a><span id="l39.1418" class="difflineplus">+    }.bind(this);</span>
<a href="#l39.1419"></a><span id="l39.1419" class="difflineplus">+    let sortChannels = channels =&gt;</span>
<a href="#l39.1420"></a><span id="l39.1420" class="difflineplus">+      channels</span>
<a href="#l39.1421"></a><span id="l39.1421" class="difflineplus">+        .trim()</span>
<a href="#l39.1422"></a><span id="l39.1422" class="difflineplus">+        .split(/\s+/)</span>
<a href="#l39.1423"></a><span id="l39.1423" class="difflineplus">+        .sort(sortWithoutPrefix)</span>
<a href="#l39.1424"></a><span id="l39.1424" class="difflineplus">+        .join(&quot; &quot;);</span>
<a href="#l39.1425"></a><span id="l39.1425" class="difflineplus">+</span>
<a href="#l39.1426"></a><span id="l39.1426" class="difflineplus">+    // Convert booleans into a human-readable form.</span>
<a href="#l39.1427"></a><span id="l39.1427" class="difflineplus">+    let normalizeBool = aBool =&gt; _(aBool ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l39.1428"></a><span id="l39.1428" class="difflineplus">+</span>
<a href="#l39.1429"></a><span id="l39.1429" class="difflineplus">+    // Convert timespan in seconds into a human-readable form.</span>
<a href="#l39.1430"></a><span id="l39.1430" class="difflineplus">+    let normalizeTime = function(aTime) {</span>
<a href="#l39.1431"></a><span id="l39.1431" class="difflineplus">+      let valuesAndUnits = DownloadUtils.convertTimeUnits(aTime);</span>
<a href="#l39.1432"></a><span id="l39.1432" class="difflineplus">+      // If the time is exact to the first set of units, trim off</span>
<a href="#l39.1433"></a><span id="l39.1433" class="difflineplus">+      // the subsequent zeroes.</span>
<a href="#l39.1434"></a><span id="l39.1434" class="difflineplus">+      if (!valuesAndUnits[2]) {</span>
<a href="#l39.1435"></a><span id="l39.1435" class="difflineplus">+        valuesAndUnits.splice(2, 2);</span>
<a href="#l39.1436"></a><span id="l39.1436" class="difflineplus">+      }</span>
<a href="#l39.1437"></a><span id="l39.1437" class="difflineplus">+      return _(&quot;tooltip.timespan&quot;, valuesAndUnits.join(&quot; &quot;));</span>
<a href="#l39.1438"></a><span id="l39.1438" class="difflineplus">+    };</span>
<a href="#l39.1439"></a><span id="l39.1439" class="difflineplus">+</span>
<a href="#l39.1440"></a><span id="l39.1440" class="difflineplus">+    // List of the names of the info to actually show in the tooltip and</span>
<a href="#l39.1441"></a><span id="l39.1441" class="difflineplus">+    // optionally a transform function to apply to the value. Each field here</span>
<a href="#l39.1442"></a><span id="l39.1442" class="difflineplus">+    // maps to tooltip.&lt;fieldname&gt; in irc.properties.</span>
<a href="#l39.1443"></a><span id="l39.1443" class="difflineplus">+    // See the various RPL_WHOIS* results for the options.</span>
<a href="#l39.1444"></a><span id="l39.1444" class="difflineplus">+    const kFields = {</span>
<a href="#l39.1445"></a><span id="l39.1445" class="difflineplus">+      realname: null,</span>
<a href="#l39.1446"></a><span id="l39.1446" class="difflineplus">+      server: null,</span>
<a href="#l39.1447"></a><span id="l39.1447" class="difflineplus">+      connectedFrom: null,</span>
<a href="#l39.1448"></a><span id="l39.1448" class="difflineplus">+      registered: normalizeBool,</span>
<a href="#l39.1449"></a><span id="l39.1449" class="difflineplus">+      registeredAs: null,</span>
<a href="#l39.1450"></a><span id="l39.1450" class="difflineplus">+      secure: normalizeBool,</span>
<a href="#l39.1451"></a><span id="l39.1451" class="difflineplus">+      ircOp: normalizeBool,</span>
<a href="#l39.1452"></a><span id="l39.1452" class="difflineplus">+      bot: normalizeBool,</span>
<a href="#l39.1453"></a><span id="l39.1453" class="difflineplus">+      lastActivity: normalizeTime,</span>
<a href="#l39.1454"></a><span id="l39.1454" class="difflineplus">+      channels: sortChannels,</span>
<a href="#l39.1455"></a><span id="l39.1455" class="difflineplus">+    };</span>
<a href="#l39.1456"></a><span id="l39.1456" class="difflineplus">+</span>
<a href="#l39.1457"></a><span id="l39.1457" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l39.1458"></a><span id="l39.1458" class="difflineplus">+    for (let field in kFields) {</span>
<a href="#l39.1459"></a><span id="l39.1459" class="difflineplus">+      if (whoisInformation.hasOwnProperty(field) &amp;&amp; whoisInformation[field]) {</span>
<a href="#l39.1460"></a><span id="l39.1460" class="difflineplus">+        let value = whoisInformation[field];</span>
<a href="#l39.1461"></a><span id="l39.1461" class="difflineplus">+        if (kFields[field]) {</span>
<a href="#l39.1462"></a><span id="l39.1462" class="difflineplus">+          value = kFields[field](value);</span>
<a href="#l39.1463"></a><span id="l39.1463" class="difflineplus">+        }</span>
<a href="#l39.1464"></a><span id="l39.1464" class="difflineplus">+        tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l39.1465"></a><span id="l39.1465" class="difflineplus">+      }</span>
<a href="#l39.1466"></a><span id="l39.1466" class="difflineplus">+    }</span>
<a href="#l39.1467"></a><span id="l39.1467" class="difflineplus">+</span>
<a href="#l39.1468"></a><span id="l39.1468" class="difflineplus">+    const kSetIdleStatusAfterSeconds = 3600;</span>
<a href="#l39.1469"></a><span id="l39.1469" class="difflineplus">+    let statusType = Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l39.1470"></a><span id="l39.1470" class="difflineplus">+    let statusText = &quot;&quot;;</span>
<a href="#l39.1471"></a><span id="l39.1471" class="difflineplus">+    if (&quot;away&quot; in whoisInformation) {</span>
<a href="#l39.1472"></a><span id="l39.1472" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_AWAY;</span>
<a href="#l39.1473"></a><span id="l39.1473" class="difflineplus">+      statusText = whoisInformation.away;</span>
<a href="#l39.1474"></a><span id="l39.1474" class="difflineplus">+    } else if (&quot;offline&quot; in whoisInformation) {</span>
<a href="#l39.1475"></a><span id="l39.1475" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_OFFLINE;</span>
<a href="#l39.1476"></a><span id="l39.1476" class="difflineplus">+    } else if (</span>
<a href="#l39.1477"></a><span id="l39.1477" class="difflineplus">+      &quot;lastActivity&quot; in whoisInformation &amp;&amp;</span>
<a href="#l39.1478"></a><span id="l39.1478" class="difflineplus">+      whoisInformation.lastActivity &gt; kSetIdleStatusAfterSeconds</span>
<a href="#l39.1479"></a><span id="l39.1479" class="difflineplus">+    ) {</span>
<a href="#l39.1480"></a><span id="l39.1480" class="difflineplus">+      statusType = Ci.imIStatusInfo.STATUS_IDLE;</span>
<a href="#l39.1481"></a><span id="l39.1481" class="difflineplus">+    }</span>
<a href="#l39.1482"></a><span id="l39.1482" class="difflineplus">+    tooltipInfo.push(</span>
<a href="#l39.1483"></a><span id="l39.1483" class="difflineplus">+      new TooltipInfo(statusType, statusText, Ci.prplITooltipInfo.status)</span>
<a href="#l39.1484"></a><span id="l39.1484" class="difflineplus">+    );</span>
<a href="#l39.1485"></a><span id="l39.1485" class="difflineplus">+</span>
<a href="#l39.1486"></a><span id="l39.1486" class="difflineplus">+    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l39.1487"></a><span id="l39.1487" class="difflineplus">+  },</span>
<a href="#l39.1488"></a><span id="l39.1488" class="difflineplus">+  // Remove a WHOIS entry.</span>
<a href="#l39.1489"></a><span id="l39.1489" class="difflineplus">+  removeBuddyInfo(aNick) {</span>
<a href="#l39.1490"></a><span id="l39.1490" class="difflineplus">+    return this.whoisInformation.delete(aNick);</span>
<a href="#l39.1491"></a><span id="l39.1491" class="difflineplus">+  },</span>
<a href="#l39.1492"></a><span id="l39.1492" class="difflineplus">+  // Copies the fields of aFields into the whois table. If the field already</span>
<a href="#l39.1493"></a><span id="l39.1493" class="difflineplus">+  // exists, that field is ignored (it is assumed that the first server response</span>
<a href="#l39.1494"></a><span id="l39.1494" class="difflineplus">+  // is the most up to date information, as is the case for 312/314). Note that</span>
<a href="#l39.1495"></a><span id="l39.1495" class="difflineplus">+  // the whois info for a nick is reset whenever whois information is requested,</span>
<a href="#l39.1496"></a><span id="l39.1496" class="difflineplus">+  // so the first response from each whois is recorded.</span>
<a href="#l39.1497"></a><span id="l39.1497" class="difflineplus">+  setWhois(aNick, aFields = {}) {</span>
<a href="#l39.1498"></a><span id="l39.1498" class="difflineplus">+    // If the nickname isn't in the list yet, add it.</span>
<a href="#l39.1499"></a><span id="l39.1499" class="difflineplus">+    if (!this.whoisInformation.has(aNick)) {</span>
<a href="#l39.1500"></a><span id="l39.1500" class="difflineplus">+      this.whoisInformation.set(aNick, {});</span>
<a href="#l39.1501"></a><span id="l39.1501" class="difflineplus">+    }</span>
<a href="#l39.1502"></a><span id="l39.1502" class="difflineplus">+</span>
<a href="#l39.1503"></a><span id="l39.1503" class="difflineplus">+    // Set non-normalized nickname field.</span>
<a href="#l39.1504"></a><span id="l39.1504" class="difflineplus">+    let whoisInfo = this.whoisInformation.get(aNick);</span>
<a href="#l39.1505"></a><span id="l39.1505" class="difflineplus">+    whoisInfo.nick = aNick;</span>
<a href="#l39.1506"></a><span id="l39.1506" class="difflineplus">+</span>
<a href="#l39.1507"></a><span id="l39.1507" class="difflineplus">+    // Set the WHOIS fields, but only the first time a field is set.</span>
<a href="#l39.1508"></a><span id="l39.1508" class="difflineplus">+    for (let field in aFields) {</span>
<a href="#l39.1509"></a><span id="l39.1509" class="difflineplus">+      if (!whoisInfo.hasOwnProperty(field)) {</span>
<a href="#l39.1510"></a><span id="l39.1510" class="difflineplus">+        whoisInfo[field] = aFields[field];</span>
<a href="#l39.1511"></a><span id="l39.1511" class="difflineplus">+      }</span>
<a href="#l39.1512"></a><span id="l39.1512" class="difflineplus">+    }</span>
<a href="#l39.1513"></a><span id="l39.1513" class="difflineplus">+</span>
<a href="#l39.1514"></a><span id="l39.1514" class="difflineplus">+    return true;</span>
<a href="#l39.1515"></a><span id="l39.1515" class="difflineplus">+  },</span>
<a href="#l39.1516"></a><span id="l39.1516" class="difflineplus">+</span>
<a href="#l39.1517"></a><span id="l39.1517" class="difflineplus">+  trackBuddy(aNick) {</span>
<a href="#l39.1518"></a><span id="l39.1518" class="difflineplus">+    // Put the username as the first to be checked on the next ISON call.</span>
<a href="#l39.1519"></a><span id="l39.1519" class="difflineplus">+    this.trackQueue.unshift(aNick);</span>
<a href="#l39.1520"></a><span id="l39.1520" class="difflineplus">+  },</span>
<a href="#l39.1521"></a><span id="l39.1521" class="difflineplus">+  untrackBuddy(aNick) {</span>
<a href="#l39.1522"></a><span id="l39.1522" class="difflineplus">+    let index = this.trackQueue.indexOf(aNick);</span>
<a href="#l39.1523"></a><span id="l39.1523" class="difflineplus">+    if (index &lt; 0) {</span>
<a href="#l39.1524"></a><span id="l39.1524" class="difflineplus">+      this.ERROR(</span>
<a href="#l39.1525"></a><span id="l39.1525" class="difflineplus">+        &quot;Trying to untrack a nick that was not being tracked: &quot; + aNick</span>
<a href="#l39.1526"></a><span id="l39.1526" class="difflineplus">+      );</span>
<a href="#l39.1527"></a><span id="l39.1527" class="difflineplus">+      return;</span>
<a href="#l39.1528"></a><span id="l39.1528" class="difflineplus">+    }</span>
<a href="#l39.1529"></a><span id="l39.1529" class="difflineplus">+    this.trackQueue.splice(index, 1);</span>
<a href="#l39.1530"></a><span id="l39.1530" class="difflineplus">+  },</span>
<a href="#l39.1531"></a><span id="l39.1531" class="difflineplus">+  addBuddy(aTag, aName) {</span>
<a href="#l39.1532"></a><span id="l39.1532" class="difflineplus">+    let buddy = new ircAccountBuddy(this, null, aTag, aName);</span>
<a href="#l39.1533"></a><span id="l39.1533" class="difflineplus">+    this.buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l39.1534"></a><span id="l39.1534" class="difflineplus">+    this.trackBuddy(buddy.userName);</span>
<a href="#l39.1535"></a><span id="l39.1535" class="difflineplus">+</span>
<a href="#l39.1536"></a><span id="l39.1536" class="difflineplus">+    Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l39.1537"></a><span id="l39.1537" class="difflineplus">+  },</span>
<a href="#l39.1538"></a><span id="l39.1538" class="difflineplus">+  removeBuddy(aBuddy) {</span>
<a href="#l39.1539"></a><span id="l39.1539" class="difflineplus">+    this.buddies.delete(aBuddy.normalizedName);</span>
<a href="#l39.1540"></a><span id="l39.1540" class="difflineplus">+    this.untrackBuddy(aBuddy.userName);</span>
<a href="#l39.1541"></a><span id="l39.1541" class="difflineplus">+  },</span>
<a href="#l39.1542"></a><span id="l39.1542" class="difflineplus">+  // Loads a buddy from the local storage. Called for each buddy locally stored</span>
<a href="#l39.1543"></a><span id="l39.1543" class="difflineplus">+  // before connecting to the server.</span>
<a href="#l39.1544"></a><span id="l39.1544" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l39.1545"></a><span id="l39.1545" class="difflineplus">+    let buddy = new ircAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l39.1546"></a><span id="l39.1546" class="difflineplus">+    this.buddies.set(buddy.normalizedName, buddy);</span>
<a href="#l39.1547"></a><span id="l39.1547" class="difflineplus">+    this.trackBuddy(buddy.userName);</span>
<a href="#l39.1548"></a><span id="l39.1548" class="difflineplus">+</span>
<a href="#l39.1549"></a><span id="l39.1549" class="difflineplus">+    return buddy;</span>
<a href="#l39.1550"></a><span id="l39.1550" class="difflineplus">+  },</span>
<a href="#l39.1551"></a><span id="l39.1551" class="difflineplus">+  changeBuddyNick(aOldNick, aNewNick) {</span>
<a href="#l39.1552"></a><span id="l39.1552" class="difflineplus">+    if (this.normalizeNick(aOldNick) == this.normalizeNick(this._nickname)) {</span>
<a href="#l39.1553"></a><span id="l39.1553" class="difflineplus">+      // Your nickname changed!</span>
<a href="#l39.1554"></a><span id="l39.1554" class="difflineplus">+      this._nickname = aNewNick;</span>
<a href="#l39.1555"></a><span id="l39.1555" class="difflineplus">+      this.conversations.forEach(conversation =&gt; {</span>
<a href="#l39.1556"></a><span id="l39.1556" class="difflineplus">+        // Update the nick for chats, and inform the user in every conversation.</span>
<a href="#l39.1557"></a><span id="l39.1557" class="difflineplus">+        if (conversation.isChat) {</span>
<a href="#l39.1558"></a><span id="l39.1558" class="difflineplus">+          conversation.updateNick(aOldNick, aNewNick, true);</span>
<a href="#l39.1559"></a><span id="l39.1559" class="difflineplus">+        } else {</span>
<a href="#l39.1560"></a><span id="l39.1560" class="difflineplus">+          conversation.writeMessage(aOldNick, _conv(&quot;nickSet.you&quot;, aNewNick), {</span>
<a href="#l39.1561"></a><span id="l39.1561" class="difflineplus">+            system: true,</span>
<a href="#l39.1562"></a><span id="l39.1562" class="difflineplus">+          });</span>
<a href="#l39.1563"></a><span id="l39.1563" class="difflineplus">+        }</span>
<a href="#l39.1564"></a><span id="l39.1564" class="difflineplus">+      });</span>
<a href="#l39.1565"></a><span id="l39.1565" class="difflineplus">+    } else {</span>
<a href="#l39.1566"></a><span id="l39.1566" class="difflineplus">+      this.conversations.forEach(conversation =&gt; {</span>
<a href="#l39.1567"></a><span id="l39.1567" class="difflineplus">+        if (conversation.isChat &amp;&amp; conversation._participants.has(aOldNick)) {</span>
<a href="#l39.1568"></a><span id="l39.1568" class="difflineplus">+          // Update the nick in every chat conversation it is in.</span>
<a href="#l39.1569"></a><span id="l39.1569" class="difflineplus">+          conversation.updateNick(aOldNick, aNewNick, false);</span>
<a href="#l39.1570"></a><span id="l39.1570" class="difflineplus">+        }</span>
<a href="#l39.1571"></a><span id="l39.1571" class="difflineplus">+      });</span>
<a href="#l39.1572"></a><span id="l39.1572" class="difflineplus">+    }</span>
<a href="#l39.1573"></a><span id="l39.1573" class="difflineplus">+</span>
<a href="#l39.1574"></a><span id="l39.1574" class="difflineplus">+    // Adjust the whois table where necessary.</span>
<a href="#l39.1575"></a><span id="l39.1575" class="difflineplus">+    this.removeBuddyInfo(aOldNick);</span>
<a href="#l39.1576"></a><span id="l39.1576" class="difflineplus">+    this.setWhois(aNewNick);</span>
<a href="#l39.1577"></a><span id="l39.1577" class="difflineplus">+</span>
<a href="#l39.1578"></a><span id="l39.1578" class="difflineplus">+    // If a private conversation is open with that user, change its title.</span>
<a href="#l39.1579"></a><span id="l39.1579" class="difflineplus">+    if (this.conversations.has(aOldNick)) {</span>
<a href="#l39.1580"></a><span id="l39.1580" class="difflineplus">+      // Get the current conversation and rename it.</span>
<a href="#l39.1581"></a><span id="l39.1581" class="difflineplus">+      let conversation = this.getConversation(aOldNick);</span>
<a href="#l39.1582"></a><span id="l39.1582" class="difflineplus">+</span>
<a href="#l39.1583"></a><span id="l39.1583" class="difflineplus">+      // Remove the old reference to the conversation and create a new one.</span>
<a href="#l39.1584"></a><span id="l39.1584" class="difflineplus">+      this.removeConversation(aOldNick);</span>
<a href="#l39.1585"></a><span id="l39.1585" class="difflineplus">+      this.conversations.set(aNewNick, conversation);</span>
<a href="#l39.1586"></a><span id="l39.1586" class="difflineplus">+</span>
<a href="#l39.1587"></a><span id="l39.1587" class="difflineplus">+      conversation.updateNick(aNewNick);</span>
<a href="#l39.1588"></a><span id="l39.1588" class="difflineplus">+      conversation.writeMessage(</span>
<a href="#l39.1589"></a><span id="l39.1589" class="difflineplus">+        aOldNick,</span>
<a href="#l39.1590"></a><span id="l39.1590" class="difflineplus">+        _conv(&quot;nickSet&quot;, aOldNick, aNewNick),</span>
<a href="#l39.1591"></a><span id="l39.1591" class="difflineplus">+        { system: true }</span>
<a href="#l39.1592"></a><span id="l39.1592" class="difflineplus">+      );</span>
<a href="#l39.1593"></a><span id="l39.1593" class="difflineplus">+    }</span>
<a href="#l39.1594"></a><span id="l39.1594" class="difflineplus">+  },</span>
<a href="#l39.1595"></a><span id="l39.1595" class="difflineplus">+</span>
<a href="#l39.1596"></a><span id="l39.1596" class="difflineplus">+  /*</span>
<a href="#l39.1597"></a><span id="l39.1597" class="difflineplus">+   * Ask the server to change the user's nick.</span>
<a href="#l39.1598"></a><span id="l39.1598" class="difflineplus">+   */</span>
<a href="#l39.1599"></a><span id="l39.1599" class="difflineplus">+  changeNick(aNewNick) {</span>
<a href="#l39.1600"></a><span id="l39.1600" class="difflineplus">+    this._sentNickname = aNewNick;</span>
<a href="#l39.1601"></a><span id="l39.1601" class="difflineplus">+    this.sendMessage(&quot;NICK&quot;, aNewNick); // Nick message.</span>
<a href="#l39.1602"></a><span id="l39.1602" class="difflineplus">+  },</span>
<a href="#l39.1603"></a><span id="l39.1603" class="difflineplus">+  /*</span>
<a href="#l39.1604"></a><span id="l39.1604" class="difflineplus">+   * Generate a new nick to change to if the user requested nick is already in</span>
<a href="#l39.1605"></a><span id="l39.1605" class="difflineplus">+   * use or is otherwise invalid.</span>
<a href="#l39.1606"></a><span id="l39.1606" class="difflineplus">+   *</span>
<a href="#l39.1607"></a><span id="l39.1607" class="difflineplus">+   * First try all the alternate nicks that were chosen by the user, and if none</span>
<a href="#l39.1608"></a><span id="l39.1608" class="difflineplus">+   * of them work, then generate a new nick by:</span>
<a href="#l39.1609"></a><span id="l39.1609" class="difflineplus">+   *  1. If there was not a digit at the end of the nick, append a 1.</span>
<a href="#l39.1610"></a><span id="l39.1610" class="difflineplus">+   *  2. If there was a digit, then increment the number.</span>
<a href="#l39.1611"></a><span id="l39.1611" class="difflineplus">+   *  3. Add leading 0s back on.</span>
<a href="#l39.1612"></a><span id="l39.1612" class="difflineplus">+   *  4. Ensure the nick is an appropriate length.</span>
<a href="#l39.1613"></a><span id="l39.1613" class="difflineplus">+   */</span>
<a href="#l39.1614"></a><span id="l39.1614" class="difflineplus">+  tryNewNick(aOldNick) {</span>
<a href="#l39.1615"></a><span id="l39.1615" class="difflineplus">+    // Split the string on commas, remove whitespace around the nicks and</span>
<a href="#l39.1616"></a><span id="l39.1616" class="difflineplus">+    // remove empty nicks.</span>
<a href="#l39.1617"></a><span id="l39.1617" class="difflineplus">+    let allNicks = this.getString(&quot;alternateNicks&quot;)</span>
<a href="#l39.1618"></a><span id="l39.1618" class="difflineplus">+      .split(&quot;,&quot;)</span>
<a href="#l39.1619"></a><span id="l39.1619" class="difflineplus">+      .map(n =&gt; n.trim())</span>
<a href="#l39.1620"></a><span id="l39.1620" class="difflineplus">+      .filter(n =&gt; !!n);</span>
<a href="#l39.1621"></a><span id="l39.1621" class="difflineplus">+    allNicks.unshift(this._accountNickname);</span>
<a href="#l39.1622"></a><span id="l39.1622" class="difflineplus">+</span>
<a href="#l39.1623"></a><span id="l39.1623" class="difflineplus">+    // If the previously tried nick is in the array and not the last</span>
<a href="#l39.1624"></a><span id="l39.1624" class="difflineplus">+    // element, try the next nick in the array.</span>
<a href="#l39.1625"></a><span id="l39.1625" class="difflineplus">+    let oldIndex = allNicks.indexOf(aOldNick);</span>
<a href="#l39.1626"></a><span id="l39.1626" class="difflineplus">+    if (oldIndex != -1 &amp;&amp; oldIndex &lt; allNicks.length - 1) {</span>
<a href="#l39.1627"></a><span id="l39.1627" class="difflineplus">+      let newNick = allNicks[oldIndex + 1];</span>
<a href="#l39.1628"></a><span id="l39.1628" class="difflineplus">+      this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l39.1629"></a><span id="l39.1629" class="difflineplus">+      this.changeNick(newNick);</span>
<a href="#l39.1630"></a><span id="l39.1630" class="difflineplus">+      return true;</span>
<a href="#l39.1631"></a><span id="l39.1631" class="difflineplus">+    }</span>
<a href="#l39.1632"></a><span id="l39.1632" class="difflineplus">+</span>
<a href="#l39.1633"></a><span id="l39.1633" class="difflineplus">+    // Separate the nick into the text and digits part.</span>
<a href="#l39.1634"></a><span id="l39.1634" class="difflineplus">+    let kNickPattern = /^(.+?)(\d*)$/;</span>
<a href="#l39.1635"></a><span id="l39.1635" class="difflineplus">+    let nickParts = kNickPattern.exec(aOldNick);</span>
<a href="#l39.1636"></a><span id="l39.1636" class="difflineplus">+    let newNick = nickParts[1];</span>
<a href="#l39.1637"></a><span id="l39.1637" class="difflineplus">+</span>
<a href="#l39.1638"></a><span id="l39.1638" class="difflineplus">+    // No nick found from the user's preferences, so just generating one.</span>
<a href="#l39.1639"></a><span id="l39.1639" class="difflineplus">+    // If there is not a digit at the end of the nick, just append 1.</span>
<a href="#l39.1640"></a><span id="l39.1640" class="difflineplus">+    let newDigits = &quot;1&quot;;</span>
<a href="#l39.1641"></a><span id="l39.1641" class="difflineplus">+    // If there is a digit at the end of the nick, increment it.</span>
<a href="#l39.1642"></a><span id="l39.1642" class="difflineplus">+    if (nickParts[2]) {</span>
<a href="#l39.1643"></a><span id="l39.1643" class="difflineplus">+      newDigits = (parseInt(nickParts[2], 10) + 1).toString();</span>
<a href="#l39.1644"></a><span id="l39.1644" class="difflineplus">+      // If there are leading 0s, add them back on, after we've incremented (e.g.</span>
<a href="#l39.1645"></a><span id="l39.1645" class="difflineplus">+      // 009 --&gt; 010).</span>
<a href="#l39.1646"></a><span id="l39.1646" class="difflineplus">+      let numLeadingZeros = nickParts[2].length - newDigits.length;</span>
<a href="#l39.1647"></a><span id="l39.1647" class="difflineplus">+      if (numLeadingZeros &gt; 0) {</span>
<a href="#l39.1648"></a><span id="l39.1648" class="difflineplus">+        newDigits = &quot;0&quot;.repeat(numLeadingZeros) + newDigits;</span>
<a href="#l39.1649"></a><span id="l39.1649" class="difflineplus">+      }</span>
<a href="#l39.1650"></a><span id="l39.1650" class="difflineplus">+    }</span>
<a href="#l39.1651"></a><span id="l39.1651" class="difflineplus">+</span>
<a href="#l39.1652"></a><span id="l39.1652" class="difflineplus">+    // Servers truncate nicks that are too long, compare the previously sent</span>
<a href="#l39.1653"></a><span id="l39.1653" class="difflineplus">+    // nickname with the returned nickname and check for truncation.</span>
<a href="#l39.1654"></a><span id="l39.1654" class="difflineplus">+    if (aOldNick.length &lt; this._sentNickname.length) {</span>
<a href="#l39.1655"></a><span id="l39.1655" class="difflineplus">+      // The nick will be too long, overwrite the end of the nick instead of</span>
<a href="#l39.1656"></a><span id="l39.1656" class="difflineplus">+      // appending.</span>
<a href="#l39.1657"></a><span id="l39.1657" class="difflineplus">+      let maxLength = aOldNick.length;</span>
<a href="#l39.1658"></a><span id="l39.1658" class="difflineplus">+</span>
<a href="#l39.1659"></a><span id="l39.1659" class="difflineplus">+      let sentNickParts = kNickPattern.exec(this._sentNickname);</span>
<a href="#l39.1660"></a><span id="l39.1660" class="difflineplus">+      // Resend the same digits as last time, but overwrite part of the nick</span>
<a href="#l39.1661"></a><span id="l39.1661" class="difflineplus">+      // this time.</span>
<a href="#l39.1662"></a><span id="l39.1662" class="difflineplus">+      if (nickParts[2] &amp;&amp; sentNickParts[2]) {</span>
<a href="#l39.1663"></a><span id="l39.1663" class="difflineplus">+        newDigits = sentNickParts[2];</span>
<a href="#l39.1664"></a><span id="l39.1664" class="difflineplus">+      }</span>
<a href="#l39.1665"></a><span id="l39.1665" class="difflineplus">+</span>
<a href="#l39.1666"></a><span id="l39.1666" class="difflineplus">+      // Handle the silly case of a single letter followed by all nines.</span>
<a href="#l39.1667"></a><span id="l39.1667" class="difflineplus">+      if (newDigits.length == this.maxNicknameLength) {</span>
<a href="#l39.1668"></a><span id="l39.1668" class="difflineplus">+        newDigits = newDigits.slice(1);</span>
<a href="#l39.1669"></a><span id="l39.1669" class="difflineplus">+      }</span>
<a href="#l39.1670"></a><span id="l39.1670" class="difflineplus">+      newNick = newNick.slice(0, maxLength - newDigits.length);</span>
<a href="#l39.1671"></a><span id="l39.1671" class="difflineplus">+    }</span>
<a href="#l39.1672"></a><span id="l39.1672" class="difflineplus">+    // Append the digits.</span>
<a href="#l39.1673"></a><span id="l39.1673" class="difflineplus">+    newNick += newDigits;</span>
<a href="#l39.1674"></a><span id="l39.1674" class="difflineplus">+</span>
<a href="#l39.1675"></a><span id="l39.1675" class="difflineplus">+    if (this.normalize(newNick) == this.normalize(this._nickname)) {</span>
<a href="#l39.1676"></a><span id="l39.1676" class="difflineplus">+      // The nick we were about to try next is our current nick. This means</span>
<a href="#l39.1677"></a><span id="l39.1677" class="difflineplus">+      // the user attempted to change to a version of the nick with a lower or</span>
<a href="#l39.1678"></a><span id="l39.1678" class="difflineplus">+      // absent number suffix, and this failed.</span>
<a href="#l39.1679"></a><span id="l39.1679" class="difflineplus">+      let msg = _(&quot;message.nick.fail&quot;, this._nickname);</span>
<a href="#l39.1680"></a><span id="l39.1680" class="difflineplus">+      this.conversations.forEach(conversation =&gt;</span>
<a href="#l39.1681"></a><span id="l39.1681" class="difflineplus">+        conversation.writeMessage(this._nickname, msg, { system: true })</span>
<a href="#l39.1682"></a><span id="l39.1682" class="difflineplus">+      );</span>
<a href="#l39.1683"></a><span id="l39.1683" class="difflineplus">+      return true;</span>
<a href="#l39.1684"></a><span id="l39.1684" class="difflineplus">+    }</span>
<a href="#l39.1685"></a><span id="l39.1685" class="difflineplus">+</span>
<a href="#l39.1686"></a><span id="l39.1686" class="difflineplus">+    this.LOG(aOldNick + &quot; is already in use, trying &quot; + newNick);</span>
<a href="#l39.1687"></a><span id="l39.1687" class="difflineplus">+    this.changeNick(newNick);</span>
<a href="#l39.1688"></a><span id="l39.1688" class="difflineplus">+    return true;</span>
<a href="#l39.1689"></a><span id="l39.1689" class="difflineplus">+  },</span>
<a href="#l39.1690"></a><span id="l39.1690" class="difflineplus">+</span>
<a href="#l39.1691"></a><span id="l39.1691" class="difflineplus">+  handlePingReply(aSource, aPongTime) {</span>
<a href="#l39.1692"></a><span id="l39.1692" class="difflineplus">+    // Received PING response, display to the user.</span>
<a href="#l39.1693"></a><span id="l39.1693" class="difflineplus">+    let sentTime = new Date(parseInt(aPongTime, 10));</span>
<a href="#l39.1694"></a><span id="l39.1694" class="difflineplus">+</span>
<a href="#l39.1695"></a><span id="l39.1695" class="difflineplus">+    // The received timestamp is invalid.</span>
<a href="#l39.1696"></a><span id="l39.1696" class="difflineplus">+    if (isNaN(sentTime)) {</span>
<a href="#l39.1697"></a><span id="l39.1697" class="difflineplus">+      this.WARN(</span>
<a href="#l39.1698"></a><span id="l39.1698" class="difflineplus">+        aSource + &quot; returned an invalid timestamp from a PING: &quot; + aPongTime</span>
<a href="#l39.1699"></a><span id="l39.1699" class="difflineplus">+      );</span>
<a href="#l39.1700"></a><span id="l39.1700" class="difflineplus">+      return false;</span>
<a href="#l39.1701"></a><span id="l39.1701" class="difflineplus">+    }</span>
<a href="#l39.1702"></a><span id="l39.1702" class="difflineplus">+</span>
<a href="#l39.1703"></a><span id="l39.1703" class="difflineplus">+    // Find the delay in milliseconds.</span>
<a href="#l39.1704"></a><span id="l39.1704" class="difflineplus">+    let delay = Date.now() - sentTime;</span>
<a href="#l39.1705"></a><span id="l39.1705" class="difflineplus">+</span>
<a href="#l39.1706"></a><span id="l39.1706" class="difflineplus">+    // If the delay is negative or greater than 1 minute, something is</span>
<a href="#l39.1707"></a><span id="l39.1707" class="difflineplus">+    // feeding us a crazy value. Don't display this to the user.</span>
<a href="#l39.1708"></a><span id="l39.1708" class="difflineplus">+    if (delay &lt; 0 || 60 * 1000 &lt; delay) {</span>
<a href="#l39.1709"></a><span id="l39.1709" class="difflineplus">+      this.WARN(aSource + &quot; returned an invalid delay from a PING: &quot; + delay);</span>
<a href="#l39.1710"></a><span id="l39.1710" class="difflineplus">+      return false;</span>
<a href="#l39.1711"></a><span id="l39.1711" class="difflineplus">+    }</span>
<a href="#l39.1712"></a><span id="l39.1712" class="difflineplus">+</span>
<a href="#l39.1713"></a><span id="l39.1713" class="difflineplus">+    let msg = PluralForm.get(delay, _(&quot;message.ping&quot;, aSource)).replace(</span>
<a href="#l39.1714"></a><span id="l39.1714" class="difflineplus">+      &quot;#2&quot;,</span>
<a href="#l39.1715"></a><span id="l39.1715" class="difflineplus">+      delay</span>
<a href="#l39.1716"></a><span id="l39.1716" class="difflineplus">+    );</span>
<a href="#l39.1717"></a><span id="l39.1717" class="difflineplus">+    this.getConversation(aSource).writeMessage(aSource, msg, { system: true });</span>
<a href="#l39.1718"></a><span id="l39.1718" class="difflineplus">+    return true;</span>
<a href="#l39.1719"></a><span id="l39.1719" class="difflineplus">+  },</span>
<a href="#l39.1720"></a><span id="l39.1720" class="difflineplus">+</span>
<a href="#l39.1721"></a><span id="l39.1721" class="difflineplus">+  countBytes(aStr) {</span>
<a href="#l39.1722"></a><span id="l39.1722" class="difflineplus">+    // Assume that if it's not UTF-8 then each character is 1 byte.</span>
<a href="#l39.1723"></a><span id="l39.1723" class="difflineplus">+    if (this._encoding != &quot;UTF-8&quot;) {</span>
<a href="#l39.1724"></a><span id="l39.1724" class="difflineplus">+      return aStr.length;</span>
<a href="#l39.1725"></a><span id="l39.1725" class="difflineplus">+    }</span>
<a href="#l39.1726"></a><span id="l39.1726" class="difflineplus">+</span>
<a href="#l39.1727"></a><span id="l39.1727" class="difflineplus">+    // Count the number of bytes in a UTF-8 encoded string.</span>
<a href="#l39.1728"></a><span id="l39.1728" class="difflineplus">+    function charCodeToByteCount(c) {</span>
<a href="#l39.1729"></a><span id="l39.1729" class="difflineplus">+      // UTF-8 stores:</span>
<a href="#l39.1730"></a><span id="l39.1730" class="difflineplus">+      // - code points below U+0080 are 1 byte,</span>
<a href="#l39.1731"></a><span id="l39.1731" class="difflineplus">+      // - code points below U+0800 are 2 bytes,</span>
<a href="#l39.1732"></a><span id="l39.1732" class="difflineplus">+      // - code points U+D800 through U+DFFF are UTF-16 surrogate halves</span>
<a href="#l39.1733"></a><span id="l39.1733" class="difflineplus">+      // (they indicate that JS has split a 4 bytes UTF-8 character</span>
<a href="#l39.1734"></a><span id="l39.1734" class="difflineplus">+      // in two halves of 2 bytes each),</span>
<a href="#l39.1735"></a><span id="l39.1735" class="difflineplus">+      // - other code points are 3 bytes.</span>
<a href="#l39.1736"></a><span id="l39.1736" class="difflineplus">+      if (c &lt; 0x80) {</span>
<a href="#l39.1737"></a><span id="l39.1737" class="difflineplus">+        return 1;</span>
<a href="#l39.1738"></a><span id="l39.1738" class="difflineplus">+      }</span>
<a href="#l39.1739"></a><span id="l39.1739" class="difflineplus">+      if (c &lt; 0x800 || (c &gt;= 0xd800 &amp;&amp; c &lt;= 0xdfff)) {</span>
<a href="#l39.1740"></a><span id="l39.1740" class="difflineplus">+        return 2;</span>
<a href="#l39.1741"></a><span id="l39.1741" class="difflineplus">+      }</span>
<a href="#l39.1742"></a><span id="l39.1742" class="difflineplus">+      return 3;</span>
<a href="#l39.1743"></a><span id="l39.1743" class="difflineplus">+    }</span>
<a href="#l39.1744"></a><span id="l39.1744" class="difflineplus">+    let bytes = 0;</span>
<a href="#l39.1745"></a><span id="l39.1745" class="difflineplus">+    for (let i = 0; i &lt; aStr.length; i++) {</span>
<a href="#l39.1746"></a><span id="l39.1746" class="difflineplus">+      bytes += charCodeToByteCount(aStr.charCodeAt(i));</span>
<a href="#l39.1747"></a><span id="l39.1747" class="difflineplus">+    }</span>
<a href="#l39.1748"></a><span id="l39.1748" class="difflineplus">+    return bytes;</span>
<a href="#l39.1749"></a><span id="l39.1749" class="difflineplus">+  },</span>
<a href="#l39.1750"></a><span id="l39.1750" class="difflineplus">+</span>
<a href="#l39.1751"></a><span id="l39.1751" class="difflineplus">+  // To check if users are online, we need to queue multiple messages.</span>
<a href="#l39.1752"></a><span id="l39.1752" class="difflineplus">+  // An internal queue of all nicks that we wish to know the status of.</span>
<a href="#l39.1753"></a><span id="l39.1753" class="difflineplus">+  trackQueue: [],</span>
<a href="#l39.1754"></a><span id="l39.1754" class="difflineplus">+  // The nicks that were last sent to the server that we're waiting for a</span>
<a href="#l39.1755"></a><span id="l39.1755" class="difflineplus">+  // response about.</span>
<a href="#l39.1756"></a><span id="l39.1756" class="difflineplus">+  pendingIsOnQueue: [],</span>
<a href="#l39.1757"></a><span id="l39.1757" class="difflineplus">+  // The time between sending isOn messages (milliseconds).</span>
<a href="#l39.1758"></a><span id="l39.1758" class="difflineplus">+  _isOnDelay: 60 * 1000,</span>
<a href="#l39.1759"></a><span id="l39.1759" class="difflineplus">+  _isOnTimer: null,</span>
<a href="#l39.1760"></a><span id="l39.1760" class="difflineplus">+  // The number of characters that are available to be filled with nicks for</span>
<a href="#l39.1761"></a><span id="l39.1761" class="difflineplus">+  // each ISON message.</span>
<a href="#l39.1762"></a><span id="l39.1762" class="difflineplus">+  _isOnLength: null,</span>
<a href="#l39.1763"></a><span id="l39.1763" class="difflineplus">+  // Generate and send an ISON message to poll for each nick's status.</span>
<a href="#l39.1764"></a><span id="l39.1764" class="difflineplus">+  sendIsOn() {</span>
<a href="#l39.1765"></a><span id="l39.1765" class="difflineplus">+    // If no buddies, just look again after the timeout.</span>
<a href="#l39.1766"></a><span id="l39.1766" class="difflineplus">+    if (this.trackQueue.length) {</span>
<a href="#l39.1767"></a><span id="l39.1767" class="difflineplus">+      // Calculate the possible length of names we can send.</span>
<a href="#l39.1768"></a><span id="l39.1768" class="difflineplus">+      if (!this._isOnLength) {</span>
<a href="#l39.1769"></a><span id="l39.1769" class="difflineplus">+        let length = this.countBytes(this.buildMessage(&quot;ISON&quot;, &quot; &quot;)) + 2;</span>
<a href="#l39.1770"></a><span id="l39.1770" class="difflineplus">+        this._isOnLength = this.maxMessageLength - length + 1;</span>
<a href="#l39.1771"></a><span id="l39.1771" class="difflineplus">+      }</span>
<a href="#l39.1772"></a><span id="l39.1772" class="difflineplus">+</span>
<a href="#l39.1773"></a><span id="l39.1773" class="difflineplus">+      // Always add the next nickname to the pending queue, this handles a silly</span>
<a href="#l39.1774"></a><span id="l39.1774" class="difflineplus">+      // case where the next nick is greater than or equal to the maximum</span>
<a href="#l39.1775"></a><span id="l39.1775" class="difflineplus">+      // message length.</span>
<a href="#l39.1776"></a><span id="l39.1776" class="difflineplus">+      this.pendingIsOnQueue = [this.trackQueue.shift()];</span>
<a href="#l39.1777"></a><span id="l39.1777" class="difflineplus">+</span>
<a href="#l39.1778"></a><span id="l39.1778" class="difflineplus">+      // Attempt to maximize the characters used in each message, this may mean</span>
<a href="#l39.1779"></a><span id="l39.1779" class="difflineplus">+      // that a specific user gets sent very often since they have a short name!</span>
<a href="#l39.1780"></a><span id="l39.1780" class="difflineplus">+      let buddiesLength = this.countBytes(this.pendingIsOnQueue[0]);</span>
<a href="#l39.1781"></a><span id="l39.1781" class="difflineplus">+      for (let i = 0; i &lt; this.trackQueue.length; ++i) {</span>
<a href="#l39.1782"></a><span id="l39.1782" class="difflineplus">+        // If we can fit the nick, add it to the current buffer.</span>
<a href="#l39.1783"></a><span id="l39.1783" class="difflineplus">+        if (</span>
<a href="#l39.1784"></a><span id="l39.1784" class="difflineplus">+          buddiesLength + this.countBytes(this.trackQueue[i]) &lt;</span>
<a href="#l39.1785"></a><span id="l39.1785" class="difflineplus">+          this._isOnLength</span>
<a href="#l39.1786"></a><span id="l39.1786" class="difflineplus">+        ) {</span>
<a href="#l39.1787"></a><span id="l39.1787" class="difflineplus">+          // Remove the name from the list and add it to the pending queue.</span>
<a href="#l39.1788"></a><span id="l39.1788" class="difflineplus">+          let nick = this.trackQueue.splice(i--, 1)[0];</span>
<a href="#l39.1789"></a><span id="l39.1789" class="difflineplus">+          this.pendingIsOnQueue.push(nick);</span>
<a href="#l39.1790"></a><span id="l39.1790" class="difflineplus">+</span>
<a href="#l39.1791"></a><span id="l39.1791" class="difflineplus">+          // Keep track of the length of the string, the + 1 is for the spaces.</span>
<a href="#l39.1792"></a><span id="l39.1792" class="difflineplus">+          buddiesLength += this.countBytes(nick) + 1;</span>
<a href="#l39.1793"></a><span id="l39.1793" class="difflineplus">+</span>
<a href="#l39.1794"></a><span id="l39.1794" class="difflineplus">+          // If we've filled up the message, stop looking for more nicks.</span>
<a href="#l39.1795"></a><span id="l39.1795" class="difflineplus">+          if (buddiesLength &gt;= this._isOnLength) {</span>
<a href="#l39.1796"></a><span id="l39.1796" class="difflineplus">+            break;</span>
<a href="#l39.1797"></a><span id="l39.1797" class="difflineplus">+          }</span>
<a href="#l39.1798"></a><span id="l39.1798" class="difflineplus">+        }</span>
<a href="#l39.1799"></a><span id="l39.1799" class="difflineplus">+      }</span>
<a href="#l39.1800"></a><span id="l39.1800" class="difflineplus">+</span>
<a href="#l39.1801"></a><span id="l39.1801" class="difflineplus">+      // Send the message.</span>
<a href="#l39.1802"></a><span id="l39.1802" class="difflineplus">+      this.sendMessage(&quot;ISON&quot;, this.pendingIsOnQueue.join(&quot; &quot;));</span>
<a href="#l39.1803"></a><span id="l39.1803" class="difflineplus">+</span>
<a href="#l39.1804"></a><span id="l39.1804" class="difflineplus">+      // Append the pending nicks so trackQueue contains all the nicks.</span>
<a href="#l39.1805"></a><span id="l39.1805" class="difflineplus">+      this.trackQueue = this.trackQueue.concat(this.pendingIsOnQueue);</span>
<a href="#l39.1806"></a><span id="l39.1806" class="difflineplus">+    }</span>
<a href="#l39.1807"></a><span id="l39.1807" class="difflineplus">+</span>
<a href="#l39.1808"></a><span id="l39.1808" class="difflineplus">+    // Call this function again in _isOnDelay seconds.</span>
<a href="#l39.1809"></a><span id="l39.1809" class="difflineplus">+    // This makes the assumption that this._isOnDelay &gt;&gt; the response to ISON</span>
<a href="#l39.1810"></a><span id="l39.1810" class="difflineplus">+    // from the server.</span>
<a href="#l39.1811"></a><span id="l39.1811" class="difflineplus">+    this._isOnTimer = setTimeout(this.sendIsOn.bind(this), this._isOnDelay);</span>
<a href="#l39.1812"></a><span id="l39.1812" class="difflineplus">+  },</span>
<a href="#l39.1813"></a><span id="l39.1813" class="difflineplus">+</span>
<a href="#l39.1814"></a><span id="l39.1814" class="difflineplus">+  // The message of the day uses two fields to append messages.</span>
<a href="#l39.1815"></a><span id="l39.1815" class="difflineplus">+  _motd: null,</span>
<a href="#l39.1816"></a><span id="l39.1816" class="difflineplus">+  _motdTimer: null,</span>
<a href="#l39.1817"></a><span id="l39.1817" class="difflineplus">+</span>
<a href="#l39.1818"></a><span id="l39.1818" class="difflineplus">+  connect() {</span>
<a href="#l39.1819"></a><span id="l39.1819" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l39.1820"></a><span id="l39.1820" class="difflineplus">+</span>
<a href="#l39.1821"></a><span id="l39.1821" class="difflineplus">+    // Mark existing MUCs as joining if they will be rejoined.</span>
<a href="#l39.1822"></a><span id="l39.1822" class="difflineplus">+    this.conversations.forEach(conversation =&gt; {</span>
<a href="#l39.1823"></a><span id="l39.1823" class="difflineplus">+      if (conversation.isChat &amp;&amp; conversation.chatRoomFields) {</span>
<a href="#l39.1824"></a><span id="l39.1824" class="difflineplus">+        conversation.joining = true;</span>
<a href="#l39.1825"></a><span id="l39.1825" class="difflineplus">+      }</span>
<a href="#l39.1826"></a><span id="l39.1826" class="difflineplus">+    });</span>
<a href="#l39.1827"></a><span id="l39.1827" class="difflineplus">+</span>
<a href="#l39.1828"></a><span id="l39.1828" class="difflineplus">+    // Load preferences.</span>
<a href="#l39.1829"></a><span id="l39.1829" class="difflineplus">+    this._port = this.getInt(&quot;port&quot;);</span>
<a href="#l39.1830"></a><span id="l39.1830" class="difflineplus">+    this._ssl = this.getBool(&quot;ssl&quot;);</span>
<a href="#l39.1831"></a><span id="l39.1831" class="difflineplus">+</span>
<a href="#l39.1832"></a><span id="l39.1832" class="difflineplus">+    // Use the display name as the user's real name.</span>
<a href="#l39.1833"></a><span id="l39.1833" class="difflineplus">+    this._realname = this.imAccount.statusInfo.displayName;</span>
<a href="#l39.1834"></a><span id="l39.1834" class="difflineplus">+    this._encoding = this.getString(&quot;encoding&quot;) || &quot;UTF-8&quot;;</span>
<a href="#l39.1835"></a><span id="l39.1835" class="difflineplus">+    this._showServerTab = this.getBool(&quot;showServerTab&quot;);</span>
<a href="#l39.1836"></a><span id="l39.1836" class="difflineplus">+</span>
<a href="#l39.1837"></a><span id="l39.1837" class="difflineplus">+    // Open the socket connection.</span>
<a href="#l39.1838"></a><span id="l39.1838" class="difflineplus">+    this._socket = new ircSocket(this);</span>
<a href="#l39.1839"></a><span id="l39.1839" class="difflineplus">+    this._socket.connect(this._server, this._port, this._ssl ? [&quot;ssl&quot;] : []);</span>
<a href="#l39.1840"></a><span id="l39.1840" class="difflineplus">+  },</span>
<a href="#l39.1841"></a><span id="l39.1841" class="difflineplus">+</span>
<a href="#l39.1842"></a><span id="l39.1842" class="difflineplus">+  // Functions for keeping track of whether the Client Capabilities is done.</span>
<a href="#l39.1843"></a><span id="l39.1843" class="difflineplus">+  // If a cap is to be handled, it should be registered with addCAP, where aCAP</span>
<a href="#l39.1844"></a><span id="l39.1844" class="difflineplus">+  // is a &quot;unique&quot; string defining what is being handled. When the cap is done</span>
<a href="#l39.1845"></a><span id="l39.1845" class="difflineplus">+  // being handled removeCAP should be called with the same string.</span>
<a href="#l39.1846"></a><span id="l39.1846" class="difflineplus">+  _availableCAPs: new Set(),</span>
<a href="#l39.1847"></a><span id="l39.1847" class="difflineplus">+  _activeCAPs: new Set(),</span>
<a href="#l39.1848"></a><span id="l39.1848" class="difflineplus">+  _requestedCAPs: new Set(),</span>
<a href="#l39.1849"></a><span id="l39.1849" class="difflineplus">+  _capTimeout: null,</span>
<a href="#l39.1850"></a><span id="l39.1850" class="difflineplus">+  _negotiatedCAPs: false,</span>
<a href="#l39.1851"></a><span id="l39.1851" class="difflineplus">+  _queuedCAPs: [],</span>
<a href="#l39.1852"></a><span id="l39.1852" class="difflineplus">+  addCAP(aCAP) {</span>
<a href="#l39.1853"></a><span id="l39.1853" class="difflineplus">+    if (this.connected) {</span>
<a href="#l39.1854"></a><span id="l39.1854" class="difflineplus">+      this.ERROR(&quot;Trying to add CAP &quot; + aCAP + &quot; after connection.&quot;);</span>
<a href="#l39.1855"></a><span id="l39.1855" class="difflineplus">+      return;</span>
<a href="#l39.1856"></a><span id="l39.1856" class="difflineplus">+    }</span>
<a href="#l39.1857"></a><span id="l39.1857" class="difflineplus">+</span>
<a href="#l39.1858"></a><span id="l39.1858" class="difflineplus">+    this._requestedCAPs.add(aCAP);</span>
<a href="#l39.1859"></a><span id="l39.1859" class="difflineplus">+  },</span>
<a href="#l39.1860"></a><span id="l39.1860" class="difflineplus">+  removeCAP(aDoneCAP) {</span>
<a href="#l39.1861"></a><span id="l39.1861" class="difflineplus">+    if (!this._requestedCAPs.has(aDoneCAP)) {</span>
<a href="#l39.1862"></a><span id="l39.1862" class="difflineplus">+      this.ERROR(</span>
<a href="#l39.1863"></a><span id="l39.1863" class="difflineplus">+        &quot;Trying to remove a CAP (&quot; + aDoneCAP + &quot;) which isn't added.&quot;</span>
<a href="#l39.1864"></a><span id="l39.1864" class="difflineplus">+      );</span>
<a href="#l39.1865"></a><span id="l39.1865" class="difflineplus">+      return;</span>
<a href="#l39.1866"></a><span id="l39.1866" class="difflineplus">+    }</span>
<a href="#l39.1867"></a><span id="l39.1867" class="difflineplus">+    if (this.connected) {</span>
<a href="#l39.1868"></a><span id="l39.1868" class="difflineplus">+      this.ERROR(&quot;Trying to remove CAP &quot; + aDoneCAP + &quot; after connection.&quot;);</span>
<a href="#l39.1869"></a><span id="l39.1869" class="difflineplus">+      return;</span>
<a href="#l39.1870"></a><span id="l39.1870" class="difflineplus">+    }</span>
<a href="#l39.1871"></a><span id="l39.1871" class="difflineplus">+</span>
<a href="#l39.1872"></a><span id="l39.1872" class="difflineplus">+    // Remove any reference to the given capability.</span>
<a href="#l39.1873"></a><span id="l39.1873" class="difflineplus">+    this._requestedCAPs.delete(aDoneCAP);</span>
<a href="#l39.1874"></a><span id="l39.1874" class="difflineplus">+</span>
<a href="#l39.1875"></a><span id="l39.1875" class="difflineplus">+    // However only notify the server the first time during cap negotiation, not</span>
<a href="#l39.1876"></a><span id="l39.1876" class="difflineplus">+    // when the server exposes a new cap.</span>
<a href="#l39.1877"></a><span id="l39.1877" class="difflineplus">+    if (!this._requestedCAPs.size &amp;&amp; !this._negotiatedCAPs) {</span>
<a href="#l39.1878"></a><span id="l39.1878" class="difflineplus">+      this.sendMessage(&quot;CAP&quot;, &quot;END&quot;);</span>
<a href="#l39.1879"></a><span id="l39.1879" class="difflineplus">+      this._negotiatedCAPs = true;</span>
<a href="#l39.1880"></a><span id="l39.1880" class="difflineplus">+    }</span>
<a href="#l39.1881"></a><span id="l39.1881" class="difflineplus">+  },</span>
<a href="#l39.1882"></a><span id="l39.1882" class="difflineplus">+</span>
<a href="#l39.1883"></a><span id="l39.1883" class="difflineplus">+  // Used to wait for a response from the server.</span>
<a href="#l39.1884"></a><span id="l39.1884" class="difflineplus">+  _quitTimer: null,</span>
<a href="#l39.1885"></a><span id="l39.1885" class="difflineplus">+  // RFC 2812 Section 3.1.7.</span>
<a href="#l39.1886"></a><span id="l39.1886" class="difflineplus">+  quit(aMessage) {</span>
<a href="#l39.1887"></a><span id="l39.1887" class="difflineplus">+    this._reportDisconnecting(Ci.prplIAccount.NO_ERROR);</span>
<a href="#l39.1888"></a><span id="l39.1888" class="difflineplus">+    this.sendMessage(</span>
<a href="#l39.1889"></a><span id="l39.1889" class="difflineplus">+      &quot;QUIT&quot;,</span>
<a href="#l39.1890"></a><span id="l39.1890" class="difflineplus">+      aMessage || this.getString(&quot;quitmsg&quot;) || undefined</span>
<a href="#l39.1891"></a><span id="l39.1891" class="difflineplus">+    );</span>
<a href="#l39.1892"></a><span id="l39.1892" class="difflineplus">+  },</span>
<a href="#l39.1893"></a><span id="l39.1893" class="difflineplus">+  // When the user clicks &quot;Disconnect&quot; in account manager, or uses /quit.</span>
<a href="#l39.1894"></a><span id="l39.1894" class="difflineplus">+  // aMessage is an optional parameter containing the quit message.</span>
<a href="#l39.1895"></a><span id="l39.1895" class="difflineplus">+  disconnect(aMessage) {</span>
<a href="#l39.1896"></a><span id="l39.1896" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l39.1897"></a><span id="l39.1897" class="difflineplus">+      return;</span>
<a href="#l39.1898"></a><span id="l39.1898" class="difflineplus">+    }</span>
<a href="#l39.1899"></a><span id="l39.1899" class="difflineplus">+</span>
<a href="#l39.1900"></a><span id="l39.1900" class="difflineplus">+    // If there's no socket, disconnect immediately to avoid waiting 2 seconds.</span>
<a href="#l39.1901"></a><span id="l39.1901" class="difflineplus">+    if (!this._socket || this._socket.disconnected) {</span>
<a href="#l39.1902"></a><span id="l39.1902" class="difflineplus">+      this.gotDisconnected();</span>
<a href="#l39.1903"></a><span id="l39.1903" class="difflineplus">+      return;</span>
<a href="#l39.1904"></a><span id="l39.1904" class="difflineplus">+    }</span>
<a href="#l39.1905"></a><span id="l39.1905" class="difflineplus">+</span>
<a href="#l39.1906"></a><span id="l39.1906" class="difflineplus">+    // Let the server know we're going to disconnect.</span>
<a href="#l39.1907"></a><span id="l39.1907" class="difflineplus">+    this.quit(aMessage);</span>
<a href="#l39.1908"></a><span id="l39.1908" class="difflineplus">+</span>
<a href="#l39.1909"></a><span id="l39.1909" class="difflineplus">+    // Reset original nickname for the next reconnect.</span>
<a href="#l39.1910"></a><span id="l39.1910" class="difflineplus">+    this._requestedNickname = this._accountNickname;</span>
<a href="#l39.1911"></a><span id="l39.1911" class="difflineplus">+</span>
<a href="#l39.1912"></a><span id="l39.1912" class="difflineplus">+    // Give the server 2 seconds to respond, otherwise just forcefully</span>
<a href="#l39.1913"></a><span id="l39.1913" class="difflineplus">+    // disconnect the socket. This will be cancelled if a response is heard from</span>
<a href="#l39.1914"></a><span id="l39.1914" class="difflineplus">+    // the server.</span>
<a href="#l39.1915"></a><span id="l39.1915" class="difflineplus">+    this._quitTimer = setTimeout(this.gotDisconnected.bind(this), 2 * 1000);</span>
<a href="#l39.1916"></a><span id="l39.1916" class="difflineplus">+  },</span>
<a href="#l39.1917"></a><span id="l39.1917" class="difflineplus">+</span>
<a href="#l39.1918"></a><span id="l39.1918" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l39.1919"></a><span id="l39.1919" class="difflineplus">+    return this.getConversation(aName);</span>
<a href="#l39.1920"></a><span id="l39.1920" class="difflineplus">+  },</span>
<a href="#l39.1921"></a><span id="l39.1921" class="difflineplus">+</span>
<a href="#l39.1922"></a><span id="l39.1922" class="difflineplus">+  // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l39.1923"></a><span id="l39.1923" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l39.1924"></a><span id="l39.1924" class="difflineplus">+    let channel = aComponents.getValue(&quot;channel&quot;);</span>
<a href="#l39.1925"></a><span id="l39.1925" class="difflineplus">+    // Mildly sanitize input.</span>
<a href="#l39.1926"></a><span id="l39.1926" class="difflineplus">+    channel = channel</span>
<a href="#l39.1927"></a><span id="l39.1927" class="difflineplus">+      .trimLeft()</span>
<a href="#l39.1928"></a><span id="l39.1928" class="difflineplus">+      .split(&quot;,&quot;)[0]</span>
<a href="#l39.1929"></a><span id="l39.1929" class="difflineplus">+      .split(&quot; &quot;)[0];</span>
<a href="#l39.1930"></a><span id="l39.1930" class="difflineplus">+    if (!channel) {</span>
<a href="#l39.1931"></a><span id="l39.1931" class="difflineplus">+      this.ERROR(&quot;joinChat called without a valid channel name.&quot;);</span>
<a href="#l39.1932"></a><span id="l39.1932" class="difflineplus">+      return null;</span>
<a href="#l39.1933"></a><span id="l39.1933" class="difflineplus">+    }</span>
<a href="#l39.1934"></a><span id="l39.1934" class="difflineplus">+</span>
<a href="#l39.1935"></a><span id="l39.1935" class="difflineplus">+    // A channel prefix is required. If the user didn't include one,</span>
<a href="#l39.1936"></a><span id="l39.1936" class="difflineplus">+    // we prepend # automatically to match the behavior of other</span>
<a href="#l39.1937"></a><span id="l39.1937" class="difflineplus">+    // clients. Not doing it used to cause user confusion.</span>
<a href="#l39.1938"></a><span id="l39.1938" class="difflineplus">+    if (!this.channelPrefixes.includes(channel[0])) {</span>
<a href="#l39.1939"></a><span id="l39.1939" class="difflineplus">+      channel = &quot;#&quot; + channel;</span>
<a href="#l39.1940"></a><span id="l39.1940" class="difflineplus">+    }</span>
<a href="#l39.1941"></a><span id="l39.1941" class="difflineplus">+</span>
<a href="#l39.1942"></a><span id="l39.1942" class="difflineplus">+    if (this.conversations.has(channel)) {</span>
<a href="#l39.1943"></a><span id="l39.1943" class="difflineplus">+      let conv = this.getConversation(channel);</span>
<a href="#l39.1944"></a><span id="l39.1944" class="difflineplus">+      if (!conv.left) {</span>
<a href="#l39.1945"></a><span id="l39.1945" class="difflineplus">+        // No need to join a channel we are already in.</span>
<a href="#l39.1946"></a><span id="l39.1946" class="difflineplus">+        return conv;</span>
<a href="#l39.1947"></a><span id="l39.1947" class="difflineplus">+      } else if (!conv.chatRoomFields) {</span>
<a href="#l39.1948"></a><span id="l39.1948" class="difflineplus">+        // We are rejoining a channel that was parted by the user.</span>
<a href="#l39.1949"></a><span id="l39.1949" class="difflineplus">+        conv._rejoined = true;</span>
<a href="#l39.1950"></a><span id="l39.1950" class="difflineplus">+      }</span>
<a href="#l39.1951"></a><span id="l39.1951" class="difflineplus">+    }</span>
<a href="#l39.1952"></a><span id="l39.1952" class="difflineplus">+</span>
<a href="#l39.1953"></a><span id="l39.1953" class="difflineplus">+    let key = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l39.1954"></a><span id="l39.1954" class="difflineplus">+    this.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l39.1955"></a><span id="l39.1955" class="difflineplus">+</span>
<a href="#l39.1956"></a><span id="l39.1956" class="difflineplus">+    // Open conversation early for better responsiveness.</span>
<a href="#l39.1957"></a><span id="l39.1957" class="difflineplus">+    let conv = this.getConversation(channel);</span>
<a href="#l39.1958"></a><span id="l39.1958" class="difflineplus">+    conv.joining = true;</span>
<a href="#l39.1959"></a><span id="l39.1959" class="difflineplus">+</span>
<a href="#l39.1960"></a><span id="l39.1960" class="difflineplus">+    // Store the prplIChatRoomFieldValues to enable later reconnections.</span>
<a href="#l39.1961"></a><span id="l39.1961" class="difflineplus">+    let defaultName = key ? channel + &quot; &quot; + key : channel;</span>
<a href="#l39.1962"></a><span id="l39.1962" class="difflineplus">+    conv.chatRoomFields = this.getChatRoomDefaultFieldValues(defaultName);</span>
<a href="#l39.1963"></a><span id="l39.1963" class="difflineplus">+</span>
<a href="#l39.1964"></a><span id="l39.1964" class="difflineplus">+    return conv;</span>
<a href="#l39.1965"></a><span id="l39.1965" class="difflineplus">+  },</span>
<a href="#l39.1966"></a><span id="l39.1966" class="difflineplus">+</span>
<a href="#l39.1967"></a><span id="l39.1967" class="difflineplus">+  chatRoomFields: {</span>
<a href="#l39.1968"></a><span id="l39.1968" class="difflineplus">+    channel: {</span>
<a href="#l39.1969"></a><span id="l39.1969" class="difflineplus">+      get label() {</span>
<a href="#l39.1970"></a><span id="l39.1970" class="difflineplus">+        return _(&quot;joinChat.channel&quot;);</span>
<a href="#l39.1971"></a><span id="l39.1971" class="difflineplus">+      },</span>
<a href="#l39.1972"></a><span id="l39.1972" class="difflineplus">+      required: true,</span>
<a href="#l39.1973"></a><span id="l39.1973" class="difflineplus">+    },</span>
<a href="#l39.1974"></a><span id="l39.1974" class="difflineplus">+    password: {</span>
<a href="#l39.1975"></a><span id="l39.1975" class="difflineplus">+      get label() {</span>
<a href="#l39.1976"></a><span id="l39.1976" class="difflineplus">+        return _(&quot;joinChat.password&quot;);</span>
<a href="#l39.1977"></a><span id="l39.1977" class="difflineplus">+      },</span>
<a href="#l39.1978"></a><span id="l39.1978" class="difflineplus">+      isPassword: true,</span>
<a href="#l39.1979"></a><span id="l39.1979" class="difflineplus">+    },</span>
<a href="#l39.1980"></a><span id="l39.1980" class="difflineplus">+  },</span>
<a href="#l39.1981"></a><span id="l39.1981" class="difflineplus">+</span>
<a href="#l39.1982"></a><span id="l39.1982" class="difflineplus">+  parseDefaultChatName(aDefaultName) {</span>
<a href="#l39.1983"></a><span id="l39.1983" class="difflineplus">+    let params = aDefaultName.trim().split(/\s+/);</span>
<a href="#l39.1984"></a><span id="l39.1984" class="difflineplus">+    let chatFields = { channel: params[0] };</span>
<a href="#l39.1985"></a><span id="l39.1985" class="difflineplus">+    if (params.length &gt; 1) {</span>
<a href="#l39.1986"></a><span id="l39.1986" class="difflineplus">+      chatFields.password = params[1];</span>
<a href="#l39.1987"></a><span id="l39.1987" class="difflineplus">+    }</span>
<a href="#l39.1988"></a><span id="l39.1988" class="difflineplus">+    return chatFields;</span>
<a href="#l39.1989"></a><span id="l39.1989" class="difflineplus">+  },</span>
<a href="#l39.1990"></a><span id="l39.1990" class="difflineplus">+</span>
<a href="#l39.1991"></a><span id="l39.1991" class="difflineplus">+  // Attributes</span>
<a href="#l39.1992"></a><span id="l39.1992" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l39.1993"></a><span id="l39.1993" class="difflineplus">+    return true;</span>
<a href="#l39.1994"></a><span id="l39.1994" class="difflineplus">+  },</span>
<a href="#l39.1995"></a><span id="l39.1995" class="difflineplus">+</span>
<a href="#l39.1996"></a><span id="l39.1996" class="difflineplus">+  // Returns a conversation (creates it if it doesn't exist)</span>
<a href="#l39.1997"></a><span id="l39.1997" class="difflineplus">+  getConversation(aName) {</span>
<a href="#l39.1998"></a><span id="l39.1998" class="difflineplus">+    if (!this.conversations.has(aName)) {</span>
<a href="#l39.1999"></a><span id="l39.1999" class="difflineplus">+      // If the whois information has been received, we have the proper nick</span>
<a href="#l39.2000"></a><span id="l39.2000" class="difflineplus">+      // capitalization.</span>
<a href="#l39.2001"></a><span id="l39.2001" class="difflineplus">+      if (this.whoisInformation.has(aName)) {</span>
<a href="#l39.2002"></a><span id="l39.2002" class="difflineplus">+        aName = this.whoisInformation.get(aName).nick;</span>
<a href="#l39.2003"></a><span id="l39.2003" class="difflineplus">+      }</span>
<a href="#l39.2004"></a><span id="l39.2004" class="difflineplus">+      let convClass = this.isMUCName(aName) ? ircChannel : ircConversation;</span>
<a href="#l39.2005"></a><span id="l39.2005" class="difflineplus">+      this.conversations.set(aName, new convClass(this, aName, this._nickname));</span>
<a href="#l39.2006"></a><span id="l39.2006" class="difflineplus">+    }</span>
<a href="#l39.2007"></a><span id="l39.2007" class="difflineplus">+    return this.conversations.get(aName);</span>
<a href="#l39.2008"></a><span id="l39.2008" class="difflineplus">+  },</span>
<a href="#l39.2009"></a><span id="l39.2009" class="difflineplus">+</span>
<a href="#l39.2010"></a><span id="l39.2010" class="difflineplus">+  removeConversation(aConversationName) {</span>
<a href="#l39.2011"></a><span id="l39.2011" class="difflineplus">+    if (this.conversations.has(aConversationName)) {</span>
<a href="#l39.2012"></a><span id="l39.2012" class="difflineplus">+      this.conversations.delete(aConversationName);</span>
<a href="#l39.2013"></a><span id="l39.2013" class="difflineplus">+    }</span>
<a href="#l39.2014"></a><span id="l39.2014" class="difflineplus">+  },</span>
<a href="#l39.2015"></a><span id="l39.2015" class="difflineplus">+</span>
<a href="#l39.2016"></a><span id="l39.2016" class="difflineplus">+  // This builds the message string that will be sent to the server.</span>
<a href="#l39.2017"></a><span id="l39.2017" class="difflineplus">+  buildMessage(aCommand, aParams = []) {</span>
<a href="#l39.2018"></a><span id="l39.2018" class="difflineplus">+    if (!aCommand) {</span>
<a href="#l39.2019"></a><span id="l39.2019" class="difflineplus">+      this.ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l39.2020"></a><span id="l39.2020" class="difflineplus">+      return null;</span>
<a href="#l39.2021"></a><span id="l39.2021" class="difflineplus">+    }</span>
<a href="#l39.2022"></a><span id="l39.2022" class="difflineplus">+</span>
<a href="#l39.2023"></a><span id="l39.2023" class="difflineplus">+    // Ensure a command is only characters or numbers.</span>
<a href="#l39.2024"></a><span id="l39.2024" class="difflineplus">+    if (!/^[A-Z0-9]+$/i.test(aCommand)) {</span>
<a href="#l39.2025"></a><span id="l39.2025" class="difflineplus">+      this.ERROR(&quot;IRC command invalid: &quot; + aCommand);</span>
<a href="#l39.2026"></a><span id="l39.2026" class="difflineplus">+      return null;</span>
<a href="#l39.2027"></a><span id="l39.2027" class="difflineplus">+    }</span>
<a href="#l39.2028"></a><span id="l39.2028" class="difflineplus">+</span>
<a href="#l39.2029"></a><span id="l39.2029" class="difflineplus">+    let message = aCommand;</span>
<a href="#l39.2030"></a><span id="l39.2030" class="difflineplus">+    // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l39.2031"></a><span id="l39.2031" class="difflineplus">+    // it into an array.</span>
<a href="#l39.2032"></a><span id="l39.2032" class="difflineplus">+    let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l39.2033"></a><span id="l39.2033" class="difflineplus">+    if (params.length) {</span>
<a href="#l39.2034"></a><span id="l39.2034" class="difflineplus">+      if (params.slice(0, -1).some(p =&gt; p.includes(&quot; &quot;))) {</span>
<a href="#l39.2035"></a><span id="l39.2035" class="difflineplus">+        this.ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l39.2036"></a><span id="l39.2036" class="difflineplus">+        return null;</span>
<a href="#l39.2037"></a><span id="l39.2037" class="difflineplus">+      }</span>
<a href="#l39.2038"></a><span id="l39.2038" class="difflineplus">+      // Join the parameters with spaces. There are three cases in which the</span>
<a href="#l39.2039"></a><span id="l39.2039" class="difflineplus">+      // last parameter (&quot;trailing&quot; in RFC 2812) must be prepended with a colon:</span>
<a href="#l39.2040"></a><span id="l39.2040" class="difflineplus">+      //  1. If the last parameter contains a space.</span>
<a href="#l39.2041"></a><span id="l39.2041" class="difflineplus">+      //  2. If the first character of the last parameter is a colon.</span>
<a href="#l39.2042"></a><span id="l39.2042" class="difflineplus">+      //  3. If the last parameter is an empty string.</span>
<a href="#l39.2043"></a><span id="l39.2043" class="difflineplus">+      let trailing = params.slice(-1)[0];</span>
<a href="#l39.2044"></a><span id="l39.2044" class="difflineplus">+      if (</span>
<a href="#l39.2045"></a><span id="l39.2045" class="difflineplus">+        !trailing.length ||</span>
<a href="#l39.2046"></a><span id="l39.2046" class="difflineplus">+        trailing.includes(&quot; &quot;) ||</span>
<a href="#l39.2047"></a><span id="l39.2047" class="difflineplus">+        trailing.startsWith(&quot;:&quot;)</span>
<a href="#l39.2048"></a><span id="l39.2048" class="difflineplus">+      ) {</span>
<a href="#l39.2049"></a><span id="l39.2049" class="difflineplus">+        params.push(&quot;:&quot; + params.pop());</span>
<a href="#l39.2050"></a><span id="l39.2050" class="difflineplus">+      }</span>
<a href="#l39.2051"></a><span id="l39.2051" class="difflineplus">+      message += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l39.2052"></a><span id="l39.2052" class="difflineplus">+    }</span>
<a href="#l39.2053"></a><span id="l39.2053" class="difflineplus">+</span>
<a href="#l39.2054"></a><span id="l39.2054" class="difflineplus">+    return message;</span>
<a href="#l39.2055"></a><span id="l39.2055" class="difflineplus">+  },</span>
<a href="#l39.2056"></a><span id="l39.2056" class="difflineplus">+</span>
<a href="#l39.2057"></a><span id="l39.2057" class="difflineplus">+  // Shortcut method to build &amp; send a message at once. Use aLoggedData to log</span>
<a href="#l39.2058"></a><span id="l39.2058" class="difflineplus">+  // something different than what is actually sent.</span>
<a href="#l39.2059"></a><span id="l39.2059" class="difflineplus">+  // Returns false if the message could not be sent.</span>
<a href="#l39.2060"></a><span id="l39.2060" class="difflineplus">+  sendMessage(aCommand, aParams, aLoggedData) {</span>
<a href="#l39.2061"></a><span id="l39.2061" class="difflineplus">+    return this.sendRawMessage(</span>
<a href="#l39.2062"></a><span id="l39.2062" class="difflineplus">+      this.buildMessage(aCommand, aParams),</span>
<a href="#l39.2063"></a><span id="l39.2063" class="difflineplus">+      aLoggedData</span>
<a href="#l39.2064"></a><span id="l39.2064" class="difflineplus">+    );</span>
<a href="#l39.2065"></a><span id="l39.2065" class="difflineplus">+  },</span>
<a href="#l39.2066"></a><span id="l39.2066" class="difflineplus">+</span>
<a href="#l39.2067"></a><span id="l39.2067" class="difflineplus">+  // This sends a message over the socket and catches any errors. Use</span>
<a href="#l39.2068"></a><span id="l39.2068" class="difflineplus">+  // aLoggedData to log something different than what is actually sent.</span>
<a href="#l39.2069"></a><span id="l39.2069" class="difflineplus">+  // Returns false if the message could not be sent.</span>
<a href="#l39.2070"></a><span id="l39.2070" class="difflineplus">+  sendRawMessage(aMessage, aLoggedData) {</span>
<a href="#l39.2071"></a><span id="l39.2071" class="difflineplus">+    // Low level quoting, replace \0, \n, \r or \020 with \0200, \020n, \020r or</span>
<a href="#l39.2072"></a><span id="l39.2072" class="difflineplus">+    // \020\020, respectively.</span>
<a href="#l39.2073"></a><span id="l39.2073" class="difflineplus">+    const lowQuote = { &quot;\0&quot;: &quot;0&quot;, &quot;\n&quot;: &quot;n&quot;, &quot;\r&quot;: &quot;r&quot;, &quot;\x10&quot;: &quot;\x10&quot; };</span>
<a href="#l39.2074"></a><span id="l39.2074" class="difflineplus">+    const lowRegex = new RegExp(</span>
<a href="#l39.2075"></a><span id="l39.2075" class="difflineplus">+      &quot;[&quot; + Object.keys(lowQuote).join(&quot;&quot;) + &quot;]&quot;,</span>
<a href="#l39.2076"></a><span id="l39.2076" class="difflineplus">+      &quot;g&quot;</span>
<a href="#l39.2077"></a><span id="l39.2077" class="difflineplus">+    );</span>
<a href="#l39.2078"></a><span id="l39.2078" class="difflineplus">+    aMessage = aMessage.replace(lowRegex, aChar =&gt; &quot;\x10&quot; + lowQuote[aChar]);</span>
<a href="#l39.2079"></a><span id="l39.2079" class="difflineplus">+</span>
<a href="#l39.2080"></a><span id="l39.2080" class="difflineplus">+    if (!this._socket || this._socket.disconnected) {</span>
<a href="#l39.2081"></a><span id="l39.2081" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l39.2082"></a><span id="l39.2082" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l39.2083"></a><span id="l39.2083" class="difflineplus">+        _(&quot;connection.error.lost&quot;)</span>
<a href="#l39.2084"></a><span id="l39.2084" class="difflineplus">+      );</span>
<a href="#l39.2085"></a><span id="l39.2085" class="difflineplus">+    }</span>
<a href="#l39.2086"></a><span id="l39.2086" class="difflineplus">+</span>
<a href="#l39.2087"></a><span id="l39.2087" class="difflineplus">+    let length = this.countBytes(aMessage) + 2;</span>
<a href="#l39.2088"></a><span id="l39.2088" class="difflineplus">+    if (length &gt; this.maxMessageLength) {</span>
<a href="#l39.2089"></a><span id="l39.2089" class="difflineplus">+      // Log if the message is too long, but try to send it anyway.</span>
<a href="#l39.2090"></a><span id="l39.2090" class="difflineplus">+      this.WARN(</span>
<a href="#l39.2091"></a><span id="l39.2091" class="difflineplus">+        &quot;Message length too long (&quot; +</span>
<a href="#l39.2092"></a><span id="l39.2092" class="difflineplus">+          length +</span>
<a href="#l39.2093"></a><span id="l39.2093" class="difflineplus">+          &quot; &gt; &quot; +</span>
<a href="#l39.2094"></a><span id="l39.2094" class="difflineplus">+          this.maxMessageLength +</span>
<a href="#l39.2095"></a><span id="l39.2095" class="difflineplus">+          &quot;\n&quot; +</span>
<a href="#l39.2096"></a><span id="l39.2096" class="difflineplus">+          aMessage</span>
<a href="#l39.2097"></a><span id="l39.2097" class="difflineplus">+      );</span>
<a href="#l39.2098"></a><span id="l39.2098" class="difflineplus">+    }</span>
<a href="#l39.2099"></a><span id="l39.2099" class="difflineplus">+</span>
<a href="#l39.2100"></a><span id="l39.2100" class="difflineplus">+    aMessage += &quot;\r\n&quot;;</span>
<a href="#l39.2101"></a><span id="l39.2101" class="difflineplus">+</span>
<a href="#l39.2102"></a><span id="l39.2102" class="difflineplus">+    try {</span>
<a href="#l39.2103"></a><span id="l39.2103" class="difflineplus">+      this._socket.sendString(aMessage, this._encoding, aLoggedData);</span>
<a href="#l39.2104"></a><span id="l39.2104" class="difflineplus">+      return true;</span>
<a href="#l39.2105"></a><span id="l39.2105" class="difflineplus">+    } catch (e) {</span>
<a href="#l39.2106"></a><span id="l39.2106" class="difflineplus">+      try {</span>
<a href="#l39.2107"></a><span id="l39.2107" class="difflineplus">+        this._socket.sendData(aMessage, aLoggedData);</span>
<a href="#l39.2108"></a><span id="l39.2108" class="difflineplus">+        this.WARN(</span>
<a href="#l39.2109"></a><span id="l39.2109" class="difflineplus">+          &quot;Failed to convert &quot; +</span>
<a href="#l39.2110"></a><span id="l39.2110" class="difflineplus">+            aMessage +</span>
<a href="#l39.2111"></a><span id="l39.2111" class="difflineplus">+            &quot; from Unicode to &quot; +</span>
<a href="#l39.2112"></a><span id="l39.2112" class="difflineplus">+            this._encoding +</span>
<a href="#l39.2113"></a><span id="l39.2113" class="difflineplus">+            &quot;.&quot;</span>
<a href="#l39.2114"></a><span id="l39.2114" class="difflineplus">+        );</span>
<a href="#l39.2115"></a><span id="l39.2115" class="difflineplus">+        return true;</span>
<a href="#l39.2116"></a><span id="l39.2116" class="difflineplus">+      } catch (e) {</span>
<a href="#l39.2117"></a><span id="l39.2117" class="difflineplus">+        this.ERROR(&quot;Socket error:&quot;, e);</span>
<a href="#l39.2118"></a><span id="l39.2118" class="difflineplus">+        this.gotDisconnected(</span>
<a href="#l39.2119"></a><span id="l39.2119" class="difflineplus">+          Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l39.2120"></a><span id="l39.2120" class="difflineplus">+          _(&quot;connection.error.lost&quot;)</span>
<a href="#l39.2121"></a><span id="l39.2121" class="difflineplus">+        );</span>
<a href="#l39.2122"></a><span id="l39.2122" class="difflineplus">+        return false;</span>
<a href="#l39.2123"></a><span id="l39.2123" class="difflineplus">+      }</span>
<a href="#l39.2124"></a><span id="l39.2124" class="difflineplus">+    }</span>
<a href="#l39.2125"></a><span id="l39.2125" class="difflineplus">+  },</span>
<a href="#l39.2126"></a><span id="l39.2126" class="difflineplus">+</span>
<a href="#l39.2127"></a><span id="l39.2127" class="difflineplus">+  // CTCP messages are \001&lt;COMMAND&gt; [&lt;parameters&gt;]*\001.</span>
<a href="#l39.2128"></a><span id="l39.2128" class="difflineplus">+  // Returns false if the message could not be sent.</span>
<a href="#l39.2129"></a><span id="l39.2129" class="difflineplus">+  sendCTCPMessage(aTarget, aIsNotice, aCtcpCommand, aParams = []) {</span>
<a href="#l39.2130"></a><span id="l39.2130" class="difflineplus">+    // Combine the CTCP command and parameters into the single IRC param.</span>
<a href="#l39.2131"></a><span id="l39.2131" class="difflineplus">+    let ircParam = aCtcpCommand;</span>
<a href="#l39.2132"></a><span id="l39.2132" class="difflineplus">+    // If aParams is not an array, consider it to be a single parameter and put</span>
<a href="#l39.2133"></a><span id="l39.2133" class="difflineplus">+    // it into an array.</span>
<a href="#l39.2134"></a><span id="l39.2134" class="difflineplus">+    let params = Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l39.2135"></a><span id="l39.2135" class="difflineplus">+    if (params.length) {</span>
<a href="#l39.2136"></a><span id="l39.2136" class="difflineplus">+      ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l39.2137"></a><span id="l39.2137" class="difflineplus">+    }</span>
<a href="#l39.2138"></a><span id="l39.2138" class="difflineplus">+</span>
<a href="#l39.2139"></a><span id="l39.2139" class="difflineplus">+    // High/CTCP level quoting, replace \134 or \001 with \134\134 or \134a,</span>
<a href="#l39.2140"></a><span id="l39.2140" class="difflineplus">+    // respectively. This is only done inside the extended data message.</span>
<a href="#l39.2141"></a><span id="l39.2141" class="difflineplus">+    // eslint-disable-next-line no-control-regex</span>
<a href="#l39.2142"></a><span id="l39.2142" class="difflineplus">+    const highRegex = /\\|\x01/g;</span>
<a href="#l39.2143"></a><span id="l39.2143" class="difflineplus">+    ircParam = ircParam.replace(</span>
<a href="#l39.2144"></a><span id="l39.2144" class="difflineplus">+      highRegex,</span>
<a href="#l39.2145"></a><span id="l39.2145" class="difflineplus">+      aChar =&gt; &quot;\\&quot; + (aChar == &quot;\\&quot; ? &quot;\\&quot; : &quot;a&quot;)</span>
<a href="#l39.2146"></a><span id="l39.2146" class="difflineplus">+    );</span>
<a href="#l39.2147"></a><span id="l39.2147" class="difflineplus">+</span>
<a href="#l39.2148"></a><span id="l39.2148" class="difflineplus">+    // Add the CTCP tagging.</span>
<a href="#l39.2149"></a><span id="l39.2149" class="difflineplus">+    ircParam = &quot;\x01&quot; + ircParam + &quot;\x01&quot;;</span>
<a href="#l39.2150"></a><span id="l39.2150" class="difflineplus">+</span>
<a href="#l39.2151"></a><span id="l39.2151" class="difflineplus">+    // Send the IRC message as a NOTICE or PRIVMSG.</span>
<a href="#l39.2152"></a><span id="l39.2152" class="difflineplus">+    return this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [</span>
<a href="#l39.2153"></a><span id="l39.2153" class="difflineplus">+      aTarget,</span>
<a href="#l39.2154"></a><span id="l39.2154" class="difflineplus">+      ircParam,</span>
<a href="#l39.2155"></a><span id="l39.2155" class="difflineplus">+    ]);</span>
<a href="#l39.2156"></a><span id="l39.2156" class="difflineplus">+  },</span>
<a href="#l39.2157"></a><span id="l39.2157" class="difflineplus">+</span>
<a href="#l39.2158"></a><span id="l39.2158" class="difflineplus">+  // Implement section 3.1 of RFC 2812</span>
<a href="#l39.2159"></a><span id="l39.2159" class="difflineplus">+  _connectionRegistration() {</span>
<a href="#l39.2160"></a><span id="l39.2160" class="difflineplus">+    // Send the Client Capabilities list command version 3.2.</span>
<a href="#l39.2161"></a><span id="l39.2161" class="difflineplus">+    this.sendMessage(&quot;CAP&quot;, [&quot;LS&quot;, &quot;302&quot;]);</span>
<a href="#l39.2162"></a><span id="l39.2162" class="difflineplus">+</span>
<a href="#l39.2163"></a><span id="l39.2163" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;serverPassword&quot;)) {</span>
<a href="#l39.2164"></a><span id="l39.2164" class="difflineplus">+      this.sendMessage(</span>
<a href="#l39.2165"></a><span id="l39.2165" class="difflineplus">+        &quot;PASS&quot;,</span>
<a href="#l39.2166"></a><span id="l39.2166" class="difflineplus">+        this.getString(&quot;serverPassword&quot;),</span>
<a href="#l39.2167"></a><span id="l39.2167" class="difflineplus">+        &quot;PASS &lt;password not logged&gt;&quot;</span>
<a href="#l39.2168"></a><span id="l39.2168" class="difflineplus">+      );</span>
<a href="#l39.2169"></a><span id="l39.2169" class="difflineplus">+    }</span>
<a href="#l39.2170"></a><span id="l39.2170" class="difflineplus">+</span>
<a href="#l39.2171"></a><span id="l39.2171" class="difflineplus">+    // Send the nick message (section 3.1.2).</span>
<a href="#l39.2172"></a><span id="l39.2172" class="difflineplus">+    this.changeNick(this._requestedNickname);</span>
<a href="#l39.2173"></a><span id="l39.2173" class="difflineplus">+</span>
<a href="#l39.2174"></a><span id="l39.2174" class="difflineplus">+    // Send the user message (section 3.1.3).</span>
<a href="#l39.2175"></a><span id="l39.2175" class="difflineplus">+    this.sendMessage(&quot;USER&quot;, [</span>
<a href="#l39.2176"></a><span id="l39.2176" class="difflineplus">+      this.username,</span>
<a href="#l39.2177"></a><span id="l39.2177" class="difflineplus">+      this._mode.toString(),</span>
<a href="#l39.2178"></a><span id="l39.2178" class="difflineplus">+      &quot;*&quot;,</span>
<a href="#l39.2179"></a><span id="l39.2179" class="difflineplus">+      this._realname || this._requestedNickname,</span>
<a href="#l39.2180"></a><span id="l39.2180" class="difflineplus">+    ]);</span>
<a href="#l39.2181"></a><span id="l39.2181" class="difflineplus">+  },</span>
<a href="#l39.2182"></a><span id="l39.2182" class="difflineplus">+</span>
<a href="#l39.2183"></a><span id="l39.2183" class="difflineplus">+  _reportDisconnecting(aErrorReason, aErrorMessage) {</span>
<a href="#l39.2184"></a><span id="l39.2184" class="difflineplus">+    this.reportDisconnecting(aErrorReason, aErrorMessage);</span>
<a href="#l39.2185"></a><span id="l39.2185" class="difflineplus">+</span>
<a href="#l39.2186"></a><span id="l39.2186" class="difflineplus">+    // Cancel any pending buffered commands.</span>
<a href="#l39.2187"></a><span id="l39.2187" class="difflineplus">+    this._commandBuffers.clear();</span>
<a href="#l39.2188"></a><span id="l39.2188" class="difflineplus">+</span>
<a href="#l39.2189"></a><span id="l39.2189" class="difflineplus">+    // Mark all contacts on the account as having an unknown status.</span>
<a href="#l39.2190"></a><span id="l39.2190" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt;</span>
<a href="#l39.2191"></a><span id="l39.2191" class="difflineplus">+      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l39.2192"></a><span id="l39.2192" class="difflineplus">+    );</span>
<a href="#l39.2193"></a><span id="l39.2193" class="difflineplus">+  },</span>
<a href="#l39.2194"></a><span id="l39.2194" class="difflineplus">+</span>
<a href="#l39.2195"></a><span id="l39.2195" class="difflineplus">+  gotDisconnected(aError = Ci.prplIAccount.NO_ERROR, aErrorMessage = &quot;&quot;) {</span>
<a href="#l39.2196"></a><span id="l39.2196" class="difflineplus">+    if (!this.imAccount || this.disconnected) {</span>
<a href="#l39.2197"></a><span id="l39.2197" class="difflineplus">+      return;</span>
<a href="#l39.2198"></a><span id="l39.2198" class="difflineplus">+    }</span>
<a href="#l39.2199"></a><span id="l39.2199" class="difflineplus">+</span>
<a href="#l39.2200"></a><span id="l39.2200" class="difflineplus">+    // If we are already disconnecting, this call to gotDisconnected</span>
<a href="#l39.2201"></a><span id="l39.2201" class="difflineplus">+    // is when the server acknowledges our disconnection.</span>
<a href="#l39.2202"></a><span id="l39.2202" class="difflineplus">+    // Otherwise it's because we lost the connection.</span>
<a href="#l39.2203"></a><span id="l39.2203" class="difflineplus">+    if (!this.disconnecting) {</span>
<a href="#l39.2204"></a><span id="l39.2204" class="difflineplus">+      this._reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l39.2205"></a><span id="l39.2205" class="difflineplus">+    }</span>
<a href="#l39.2206"></a><span id="l39.2206" class="difflineplus">+    this._socket.disconnect();</span>
<a href="#l39.2207"></a><span id="l39.2207" class="difflineplus">+    delete this._socket;</span>
<a href="#l39.2208"></a><span id="l39.2208" class="difflineplus">+</span>
<a href="#l39.2209"></a><span id="l39.2209" class="difflineplus">+    this._requestedCAPs.clear();</span>
<a href="#l39.2210"></a><span id="l39.2210" class="difflineplus">+    this._availableCAPs.clear();</span>
<a href="#l39.2211"></a><span id="l39.2211" class="difflineplus">+    this._activeCAPs.clear();</span>
<a href="#l39.2212"></a><span id="l39.2212" class="difflineplus">+    this._queuedCAPs.length = 0;</span>
<a href="#l39.2213"></a><span id="l39.2213" class="difflineplus">+</span>
<a href="#l39.2214"></a><span id="l39.2214" class="difflineplus">+    clearTimeout(this._isOnTimer);</span>
<a href="#l39.2215"></a><span id="l39.2215" class="difflineplus">+    delete this._isOnTimer;</span>
<a href="#l39.2216"></a><span id="l39.2216" class="difflineplus">+</span>
<a href="#l39.2217"></a><span id="l39.2217" class="difflineplus">+    // No need to call gotDisconnected a second time.</span>
<a href="#l39.2218"></a><span id="l39.2218" class="difflineplus">+    clearTimeout(this._quitTimer);</span>
<a href="#l39.2219"></a><span id="l39.2219" class="difflineplus">+    delete this._quitTimer;</span>
<a href="#l39.2220"></a><span id="l39.2220" class="difflineplus">+</span>
<a href="#l39.2221"></a><span id="l39.2221" class="difflineplus">+    // MOTD will be resent.</span>
<a href="#l39.2222"></a><span id="l39.2222" class="difflineplus">+    delete this._motd;</span>
<a href="#l39.2223"></a><span id="l39.2223" class="difflineplus">+    clearTimeout(this._motdTimer);</span>
<a href="#l39.2224"></a><span id="l39.2224" class="difflineplus">+    delete this._motdTimer;</span>
<a href="#l39.2225"></a><span id="l39.2225" class="difflineplus">+</span>
<a href="#l39.2226"></a><span id="l39.2226" class="difflineplus">+    // We must authenticate if we reconnect.</span>
<a href="#l39.2227"></a><span id="l39.2227" class="difflineplus">+    delete this.isAuthenticated;</span>
<a href="#l39.2228"></a><span id="l39.2228" class="difflineplus">+</span>
<a href="#l39.2229"></a><span id="l39.2229" class="difflineplus">+    // Clear any pending attempt to regain our nick.</span>
<a href="#l39.2230"></a><span id="l39.2230" class="difflineplus">+    clearTimeout(this._nickInUseTimeout);</span>
<a href="#l39.2231"></a><span id="l39.2231" class="difflineplus">+    delete this._nickInUseTimeout;</span>
<a href="#l39.2232"></a><span id="l39.2232" class="difflineplus">+</span>
<a href="#l39.2233"></a><span id="l39.2233" class="difflineplus">+    // Clean up each conversation: mark as left and remove participant.</span>
<a href="#l39.2234"></a><span id="l39.2234" class="difflineplus">+    this.conversations.forEach(conversation =&gt; {</span>
<a href="#l39.2235"></a><span id="l39.2235" class="difflineplus">+      if (conversation.isChat) {</span>
<a href="#l39.2236"></a><span id="l39.2236" class="difflineplus">+        conversation.joining = false; // In case we never finished joining.</span>
<a href="#l39.2237"></a><span id="l39.2237" class="difflineplus">+        if (!conversation.left) {</span>
<a href="#l39.2238"></a><span id="l39.2238" class="difflineplus">+          // Remove the user's nick and mark the conversation as left as that's</span>
<a href="#l39.2239"></a><span id="l39.2239" class="difflineplus">+          // the final known state of the room.</span>
<a href="#l39.2240"></a><span id="l39.2240" class="difflineplus">+          conversation.removeParticipant(this._nickname);</span>
<a href="#l39.2241"></a><span id="l39.2241" class="difflineplus">+          conversation.left = true;</span>
<a href="#l39.2242"></a><span id="l39.2242" class="difflineplus">+        }</span>
<a href="#l39.2243"></a><span id="l39.2243" class="difflineplus">+      }</span>
<a href="#l39.2244"></a><span id="l39.2244" class="difflineplus">+    });</span>
<a href="#l39.2245"></a><span id="l39.2245" class="difflineplus">+</span>
<a href="#l39.2246"></a><span id="l39.2246" class="difflineplus">+    // If we disconnected during a pending LIST request, make sure callbacks</span>
<a href="#l39.2247"></a><span id="l39.2247" class="difflineplus">+    // receive any remaining channels.</span>
<a href="#l39.2248"></a><span id="l39.2248" class="difflineplus">+    if (this._pendingList) {</span>
<a href="#l39.2249"></a><span id="l39.2249" class="difflineplus">+      this._sendRemainingRoomInfo();</span>
<a href="#l39.2250"></a><span id="l39.2250" class="difflineplus">+    }</span>
<a href="#l39.2251"></a><span id="l39.2251" class="difflineplus">+</span>
<a href="#l39.2252"></a><span id="l39.2252" class="difflineplus">+    // Clear whois table.</span>
<a href="#l39.2253"></a><span id="l39.2253" class="difflineplus">+    this.whoisInformation.clear();</span>
<a href="#l39.2254"></a><span id="l39.2254" class="difflineplus">+</span>
<a href="#l39.2255"></a><span id="l39.2255" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l39.2256"></a><span id="l39.2256" class="difflineplus">+  },</span>
<a href="#l39.2257"></a><span id="l39.2257" class="difflineplus">+</span>
<a href="#l39.2258"></a><span id="l39.2258" class="difflineplus">+  remove() {</span>
<a href="#l39.2259"></a><span id="l39.2259" class="difflineplus">+    this.conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l39.2260"></a><span id="l39.2260" class="difflineplus">+    delete this.conversations;</span>
<a href="#l39.2261"></a><span id="l39.2261" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l39.2262"></a><span id="l39.2262" class="difflineplus">+    delete this.buddies;</span>
<a href="#l39.2263"></a><span id="l39.2263" class="difflineplus">+  },</span>
<a href="#l39.2264"></a><span id="l39.2264" class="difflineplus">+</span>
<a href="#l39.2265"></a><span id="l39.2265" class="difflineplus">+  unInit() {</span>
<a href="#l39.2266"></a><span id="l39.2266" class="difflineplus">+    // Disconnect if we're online while this gets called.</span>
<a href="#l39.2267"></a><span id="l39.2267" class="difflineplus">+    if (this._socket) {</span>
<a href="#l39.2268"></a><span id="l39.2268" class="difflineplus">+      if (!this.disconnecting) {</span>
<a href="#l39.2269"></a><span id="l39.2269" class="difflineplus">+        this.quit();</span>
<a href="#l39.2270"></a><span id="l39.2270" class="difflineplus">+      }</span>
<a href="#l39.2271"></a><span id="l39.2271" class="difflineplus">+      this._socket.disconnect();</span>
<a href="#l39.2272"></a><span id="l39.2272" class="difflineplus">+    }</span>
<a href="#l39.2273"></a><span id="l39.2273" class="difflineplus">+    delete this.imAccount;</span>
<a href="#l39.2274"></a><span id="l39.2274" class="difflineplus">+    clearTimeout(this._isOnTimer);</span>
<a href="#l39.2275"></a><span id="l39.2275" class="difflineplus">+    clearTimeout(this._quitTimer);</span>
<a href="#l39.2276"></a><span id="l39.2276" class="difflineplus">+  },</span>
<a href="#l39.2277"></a><span id="l39.2277" class="difflineplus">+};</span>
<a href="#l39.2278"></a><span id="l39.2278" class="difflineplus">+</span>
<a href="#l39.2279"></a><span id="l39.2279" class="difflineplus">+function ircProtocol() {</span>
<a href="#l39.2280"></a><span id="l39.2280" class="difflineplus">+  // ircCommands.jsm exports one variable: commands. Import this directly into</span>
<a href="#l39.2281"></a><span id="l39.2281" class="difflineplus">+  // the protocol object.</span>
<a href="#l39.2282"></a><span id="l39.2282" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;, this);</span>
<a href="#l39.2283"></a><span id="l39.2283" class="difflineplus">+  this.registerCommands();</span>
<a href="#l39.2284"></a><span id="l39.2284" class="difflineplus">+</span>
<a href="#l39.2285"></a><span id="l39.2285" class="difflineplus">+  // Register the standard handlers.</span>
<a href="#l39.2286"></a><span id="l39.2286" class="difflineplus">+  let tempScope = {};</span>
<a href="#l39.2287"></a><span id="l39.2287" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircBase.jsm&quot;, tempScope);</span>
<a href="#l39.2288"></a><span id="l39.2288" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircISUPPORT.jsm&quot;, tempScope);</span>
<a href="#l39.2289"></a><span id="l39.2289" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircCAP.jsm&quot;, tempScope);</span>
<a href="#l39.2290"></a><span id="l39.2290" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircCTCP.jsm&quot;, tempScope);</span>
<a href="#l39.2291"></a><span id="l39.2291" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircDCC.jsm&quot;, tempScope);</span>
<a href="#l39.2292"></a><span id="l39.2292" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircServices.jsm&quot;, tempScope);</span>
<a href="#l39.2293"></a><span id="l39.2293" class="difflineplus">+</span>
<a href="#l39.2294"></a><span id="l39.2294" class="difflineplus">+  // Extra features.</span>
<a href="#l39.2295"></a><span id="l39.2295" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircMultiPrefix.jsm&quot;, tempScope);</span>
<a href="#l39.2296"></a><span id="l39.2296" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircNonStandard.jsm&quot;, tempScope);</span>
<a href="#l39.2297"></a><span id="l39.2297" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircSASL.jsm&quot;, tempScope);</span>
<a href="#l39.2298"></a><span id="l39.2298" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircServerTime.jsm&quot;, tempScope);</span>
<a href="#l39.2299"></a><span id="l39.2299" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/ircWatchMonitor.jsm&quot;, tempScope);</span>
<a href="#l39.2300"></a><span id="l39.2300" class="difflineplus">+</span>
<a href="#l39.2301"></a><span id="l39.2301" class="difflineplus">+  // Register default IRC handlers (IRC base, CTCP).</span>
<a href="#l39.2302"></a><span id="l39.2302" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircBase);</span>
<a href="#l39.2303"></a><span id="l39.2303" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircISUPPORT);</span>
<a href="#l39.2304"></a><span id="l39.2304" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircCAP);</span>
<a href="#l39.2305"></a><span id="l39.2305" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircCTCP);</span>
<a href="#l39.2306"></a><span id="l39.2306" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircServices);</span>
<a href="#l39.2307"></a><span id="l39.2307" class="difflineplus">+  // Register default ISUPPORT handler (ISUPPORT base).</span>
<a href="#l39.2308"></a><span id="l39.2308" class="difflineplus">+  ircHandlers.registerISUPPORTHandler(tempScope.isupportBase);</span>
<a href="#l39.2309"></a><span id="l39.2309" class="difflineplus">+  // Register default CTCP handlers (CTCP base, DCC).</span>
<a href="#l39.2310"></a><span id="l39.2310" class="difflineplus">+  ircHandlers.registerCTCPHandler(tempScope.ctcpBase);</span>
<a href="#l39.2311"></a><span id="l39.2311" class="difflineplus">+  ircHandlers.registerCTCPHandler(tempScope.ctcpDCC);</span>
<a href="#l39.2312"></a><span id="l39.2312" class="difflineplus">+  // Register default IRC Services handlers (IRC Services base).</span>
<a href="#l39.2313"></a><span id="l39.2313" class="difflineplus">+  ircHandlers.registerServicesHandler(tempScope.servicesBase);</span>
<a href="#l39.2314"></a><span id="l39.2314" class="difflineplus">+  // Register default CAP handlers for base features (CAP basics).</span>
<a href="#l39.2315"></a><span id="l39.2315" class="difflineplus">+  ircHandlers.registerCAPHandler(tempScope.capNotify);</span>
<a href="#l39.2316"></a><span id="l39.2316" class="difflineplus">+</span>
<a href="#l39.2317"></a><span id="l39.2317" class="difflineplus">+  // Register extra features.</span>
<a href="#l39.2318"></a><span id="l39.2318" class="difflineplus">+  ircHandlers.registerISUPPORTHandler(tempScope.isupportNAMESX);</span>
<a href="#l39.2319"></a><span id="l39.2319" class="difflineplus">+  ircHandlers.registerCAPHandler(tempScope.capMultiPrefix);</span>
<a href="#l39.2320"></a><span id="l39.2320" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircNonStandard);</span>
<a href="#l39.2321"></a><span id="l39.2321" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircWATCH);</span>
<a href="#l39.2322"></a><span id="l39.2322" class="difflineplus">+  ircHandlers.registerISUPPORTHandler(tempScope.isupportWATCH);</span>
<a href="#l39.2323"></a><span id="l39.2323" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircMONITOR);</span>
<a href="#l39.2324"></a><span id="l39.2324" class="difflineplus">+  ircHandlers.registerISUPPORTHandler(tempScope.isupportMONITOR);</span>
<a href="#l39.2325"></a><span id="l39.2325" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircSASL);</span>
<a href="#l39.2326"></a><span id="l39.2326" class="difflineplus">+  ircHandlers.registerCAPHandler(tempScope.capSASL);</span>
<a href="#l39.2327"></a><span id="l39.2327" class="difflineplus">+  ircHandlers.registerCAPHandler(tempScope.capServerTime);</span>
<a href="#l39.2328"></a><span id="l39.2328" class="difflineplus">+  ircHandlers.registerTagHandler(tempScope.tagServerTime);</span>
<a href="#l39.2329"></a><span id="l39.2329" class="difflineplus">+}</span>
<a href="#l39.2330"></a><span id="l39.2330" class="difflineplus">+ircProtocol.prototype = {</span>
<a href="#l39.2331"></a><span id="l39.2331" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l39.2332"></a><span id="l39.2332" class="difflineplus">+  get name() {</span>
<a href="#l39.2333"></a><span id="l39.2333" class="difflineplus">+    return &quot;IRC&quot;;</span>
<a href="#l39.2334"></a><span id="l39.2334" class="difflineplus">+  },</span>
<a href="#l39.2335"></a><span id="l39.2335" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l39.2336"></a><span id="l39.2336" class="difflineplus">+    return &quot;chrome://prpl-irc/skin/&quot;;</span>
<a href="#l39.2337"></a><span id="l39.2337" class="difflineplus">+  },</span>
<a href="#l39.2338"></a><span id="l39.2338" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l39.2339"></a><span id="l39.2339" class="difflineplus">+    return _(&quot;irc.usernameHint&quot;);</span>
<a href="#l39.2340"></a><span id="l39.2340" class="difflineplus">+  },</span>
<a href="#l39.2341"></a><span id="l39.2341" class="difflineplus">+  get baseId() {</span>
<a href="#l39.2342"></a><span id="l39.2342" class="difflineplus">+    return &quot;prpl-irc&quot;;</span>
<a href="#l39.2343"></a><span id="l39.2343" class="difflineplus">+  },</span>
<a href="#l39.2344"></a><span id="l39.2344" class="difflineplus">+</span>
<a href="#l39.2345"></a><span id="l39.2345" class="difflineplus">+  usernameSplits: [</span>
<a href="#l39.2346"></a><span id="l39.2346" class="difflineplus">+    {</span>
<a href="#l39.2347"></a><span id="l39.2347" class="difflineplus">+      get label() {</span>
<a href="#l39.2348"></a><span id="l39.2348" class="difflineplus">+        return _(&quot;options.server&quot;);</span>
<a href="#l39.2349"></a><span id="l39.2349" class="difflineplus">+      },</span>
<a href="#l39.2350"></a><span id="l39.2350" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l39.2351"></a><span id="l39.2351" class="difflineplus">+      defaultValue: &quot;chat.freenode.net&quot;,</span>
<a href="#l39.2352"></a><span id="l39.2352" class="difflineplus">+      reverse: true,</span>
<a href="#l39.2353"></a><span id="l39.2353" class="difflineplus">+    },</span>
<a href="#l39.2354"></a><span id="l39.2354" class="difflineplus">+  ],</span>
<a href="#l39.2355"></a><span id="l39.2355" class="difflineplus">+</span>
<a href="#l39.2356"></a><span id="l39.2356" class="difflineplus">+  options: {</span>
<a href="#l39.2357"></a><span id="l39.2357" class="difflineplus">+    port: {</span>
<a href="#l39.2358"></a><span id="l39.2358" class="difflineplus">+      get label() {</span>
<a href="#l39.2359"></a><span id="l39.2359" class="difflineplus">+        return _(&quot;options.port&quot;);</span>
<a href="#l39.2360"></a><span id="l39.2360" class="difflineplus">+      },</span>
<a href="#l39.2361"></a><span id="l39.2361" class="difflineplus">+      default: 6697,</span>
<a href="#l39.2362"></a><span id="l39.2362" class="difflineplus">+    },</span>
<a href="#l39.2363"></a><span id="l39.2363" class="difflineplus">+    ssl: {</span>
<a href="#l39.2364"></a><span id="l39.2364" class="difflineplus">+      get label() {</span>
<a href="#l39.2365"></a><span id="l39.2365" class="difflineplus">+        return _(&quot;options.ssl&quot;);</span>
<a href="#l39.2366"></a><span id="l39.2366" class="difflineplus">+      },</span>
<a href="#l39.2367"></a><span id="l39.2367" class="difflineplus">+      default: true,</span>
<a href="#l39.2368"></a><span id="l39.2368" class="difflineplus">+    },</span>
<a href="#l39.2369"></a><span id="l39.2369" class="difflineplus">+    // TODO We should attempt to auto-detect encoding instead.</span>
<a href="#l39.2370"></a><span id="l39.2370" class="difflineplus">+    encoding: {</span>
<a href="#l39.2371"></a><span id="l39.2371" class="difflineplus">+      get label() {</span>
<a href="#l39.2372"></a><span id="l39.2372" class="difflineplus">+        return _(&quot;options.encoding&quot;);</span>
<a href="#l39.2373"></a><span id="l39.2373" class="difflineplus">+      },</span>
<a href="#l39.2374"></a><span id="l39.2374" class="difflineplus">+      default: &quot;UTF-8&quot;,</span>
<a href="#l39.2375"></a><span id="l39.2375" class="difflineplus">+    },</span>
<a href="#l39.2376"></a><span id="l39.2376" class="difflineplus">+    quitmsg: {</span>
<a href="#l39.2377"></a><span id="l39.2377" class="difflineplus">+      get label() {</span>
<a href="#l39.2378"></a><span id="l39.2378" class="difflineplus">+        return _(&quot;options.quitMessage&quot;);</span>
<a href="#l39.2379"></a><span id="l39.2379" class="difflineplus">+      },</span>
<a href="#l39.2380"></a><span id="l39.2380" class="difflineplus">+      get default() {</span>
<a href="#l39.2381"></a><span id="l39.2381" class="difflineplus">+        return Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;);</span>
<a href="#l39.2382"></a><span id="l39.2382" class="difflineplus">+      },</span>
<a href="#l39.2383"></a><span id="l39.2383" class="difflineplus">+    },</span>
<a href="#l39.2384"></a><span id="l39.2384" class="difflineplus">+    partmsg: {</span>
<a href="#l39.2385"></a><span id="l39.2385" class="difflineplus">+      get label() {</span>
<a href="#l39.2386"></a><span id="l39.2386" class="difflineplus">+        return _(&quot;options.partMessage&quot;);</span>
<a href="#l39.2387"></a><span id="l39.2387" class="difflineplus">+      },</span>
<a href="#l39.2388"></a><span id="l39.2388" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l39.2389"></a><span id="l39.2389" class="difflineplus">+    },</span>
<a href="#l39.2390"></a><span id="l39.2390" class="difflineplus">+    showServerTab: {</span>
<a href="#l39.2391"></a><span id="l39.2391" class="difflineplus">+      get label() {</span>
<a href="#l39.2392"></a><span id="l39.2392" class="difflineplus">+        return _(&quot;options.showServerTab&quot;);</span>
<a href="#l39.2393"></a><span id="l39.2393" class="difflineplus">+      },</span>
<a href="#l39.2394"></a><span id="l39.2394" class="difflineplus">+      default: false,</span>
<a href="#l39.2395"></a><span id="l39.2395" class="difflineplus">+    },</span>
<a href="#l39.2396"></a><span id="l39.2396" class="difflineplus">+    alternateNicks: {</span>
<a href="#l39.2397"></a><span id="l39.2397" class="difflineplus">+      get label() {</span>
<a href="#l39.2398"></a><span id="l39.2398" class="difflineplus">+        return _(&quot;options.alternateNicks&quot;);</span>
<a href="#l39.2399"></a><span id="l39.2399" class="difflineplus">+      },</span>
<a href="#l39.2400"></a><span id="l39.2400" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l39.2401"></a><span id="l39.2401" class="difflineplus">+    },</span>
<a href="#l39.2402"></a><span id="l39.2402" class="difflineplus">+  },</span>
<a href="#l39.2403"></a><span id="l39.2403" class="difflineplus">+</span>
<a href="#l39.2404"></a><span id="l39.2404" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l39.2405"></a><span id="l39.2405" class="difflineplus">+    return true;</span>
<a href="#l39.2406"></a><span id="l39.2406" class="difflineplus">+  },</span>
<a href="#l39.2407"></a><span id="l39.2407" class="difflineplus">+  get slashCommandsNative() {</span>
<a href="#l39.2408"></a><span id="l39.2408" class="difflineplus">+    return true;</span>
<a href="#l39.2409"></a><span id="l39.2409" class="difflineplus">+  },</span>
<a href="#l39.2410"></a><span id="l39.2410" class="difflineplus">+  //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l39.2411"></a><span id="l39.2411" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l39.2412"></a><span id="l39.2412" class="difflineplus">+    return true;</span>
<a href="#l39.2413"></a><span id="l39.2413" class="difflineplus">+  },</span>
<a href="#l39.2414"></a><span id="l39.2414" class="difflineplus">+</span>
<a href="#l39.2415"></a><span id="l39.2415" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l39.2416"></a><span id="l39.2416" class="difflineplus">+    return new ircAccount(this, aImAccount);</span>
<a href="#l39.2417"></a><span id="l39.2417" class="difflineplus">+  },</span>
<a href="#l39.2418"></a><span id="l39.2418" class="difflineplus">+  classID: Components.ID(&quot;{607b2c0b-9504-483f-ad62-41de09238aec}&quot;),</span>
<a href="#l39.2419"></a><span id="l39.2419" class="difflineplus">+};</span>
<a href="#l39.2420"></a><span id="l39.2420" class="difflineplus">+</span>
<a href="#l39.2421"></a><span id="l39.2421" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([ircProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">new file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- /dev/null</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ b/chat/protocols/irc/irc.manifest</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineplus">+component {607b2c0b-9504-483f-ad62-41de09238aec} irc.js</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineplus">+contract @mozilla.org/chat/irc;1 {607b2c0b-9504-483f-ad62-41de09238aec}</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+category im-protocol-plugin prpl-irc @mozilla.org/chat/irc;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -14,17 +14,17 @@</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5"> this.EXPORTED_SYMBOLS = [&quot;ircISUPPORT&quot;, &quot;isupportBase&quot;];</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7"> const { ircHandlers } = ChromeUtils.import(</span>
<a href="#l41.8"></a><span id="l41.8">   &quot;resource:///modules/ircHandlers.jsm&quot;</span>
<a href="#l41.9"></a><span id="l41.9"> );</span>
<a href="#l41.10"></a><span id="l41.10"> </span>
<a href="#l41.11"></a><span id="l41.11"> /*</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">- * Parses an IRCMessage into an ISUPPORT message for each token of the form:</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+ * Parses an ircMessage into an ISUPPORT message for each token of the form:</span>
<a href="#l41.14"></a><span id="l41.14">  *   &lt;parameter&gt;=&lt;value&gt; or -&lt;value&gt;</span>
<a href="#l41.15"></a><span id="l41.15">  * The isupport field is added to the message and it has the following fields:</span>
<a href="#l41.16"></a><span id="l41.16">  *   parameter  What is being configured by this ISUPPORT token.</span>
<a href="#l41.17"></a><span id="l41.17">  *   useDefault Whether this parameter should be reset to the default value, as</span>
<a href="#l41.18"></a><span id="l41.18">  *              defined by the RFC.</span>
<a href="#l41.19"></a><span id="l41.19">  *   value      The new value for the parameter.</span>
<a href="#l41.20"></a><span id="l41.20">  */</span>
<a href="#l41.21"></a><span id="l41.21"> function isupportMessage(aMessage) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/chat/protocols/irc/moz.build</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/chat/protocols/irc/moz.build</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,17 +1,21 @@</span>
<a href="#l42.4"></a><span id="l42.4"> # vim: set filetype=python:</span>
<a href="#l42.5"></a><span id="l42.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.7"></a><span id="l42.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineplus">+    'irc.js',</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+    'irc.manifest',</span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+]</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+</span>
<a href="#l42.16"></a><span id="l42.16"> EXTRA_JS_MODULES += [</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineminus">-    'IRC.jsm',</span>
<a href="#l42.18"></a><span id="l42.18">     'ircBase.jsm',</span>
<a href="#l42.19"></a><span id="l42.19">     'ircCAP.jsm',</span>
<a href="#l42.20"></a><span id="l42.20">     'ircCommands.jsm',</span>
<a href="#l42.21"></a><span id="l42.21">     'ircCTCP.jsm',</span>
<a href="#l42.22"></a><span id="l42.22">     'ircDCC.jsm',</span>
<a href="#l42.23"></a><span id="l42.23">     'ircHandlers.jsm',</span>
<a href="#l42.24"></a><span id="l42.24">     'ircISUPPORT.jsm',</span>
<a href="#l42.25"></a><span id="l42.25">     'ircMultiPrefix.jsm',</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineat">@@ -19,12 +23,8 @@ EXTRA_JS_MODULES += [</span>
<a href="#l42.27"></a><span id="l42.27">     'ircSASL.jsm',</span>
<a href="#l42.28"></a><span id="l42.28">     'ircServerTime.jsm',</span>
<a href="#l42.29"></a><span id="l42.29">     'ircServices.jsm',</span>
<a href="#l42.30"></a><span id="l42.30">     'ircUtils.jsm',</span>
<a href="#l42.31"></a><span id="l42.31">     'ircWatchMonitor.jsm',</span>
<a href="#l42.32"></a><span id="l42.32"> ]</span>
<a href="#l42.33"></a><span id="l42.33"> </span>
<a href="#l42.34"></a><span id="l42.34"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-    'components.conf',</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpQuote.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l43.4"></a><span id="l43.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l43.5"></a><span id="l43.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineminus">-var { IRCAccount } = ChromeUtils.import(&quot;resource:///modules/IRC.jsm&quot;);</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineplus">+var irc = {};</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12"> var input = [</span>
<a href="#l43.13"></a><span id="l43.13">   undefined,</span>
<a href="#l43.14"></a><span id="l43.14">   &quot;test&quot;,</span>
<a href="#l43.15"></a><span id="l43.15">   &quot;\\test&quot;,</span>
<a href="#l43.16"></a><span id="l43.16">   &quot;te\\st&quot;,</span>
<a href="#l43.17"></a><span id="l43.17">   &quot;test\\&quot;,</span>
<a href="#l43.18"></a><span id="l43.18">   &quot;\\\\test&quot;,</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineat">@@ -39,24 +40,24 @@ var expectedOutputParams = [</span>
<a href="#l43.20"></a><span id="l43.20">   &quot;ACTION te\\ast&quot;,</span>
<a href="#l43.21"></a><span id="l43.21">   &quot;ACTION test\\a&quot;,</span>
<a href="#l43.22"></a><span id="l43.22">   &quot;ACTION \\\\\\\\\\atest&quot;,</span>
<a href="#l43.23"></a><span id="l43.23">   &quot;ACTION \\\\\\\\atest&quot;,</span>
<a href="#l43.24"></a><span id="l43.24"> ];</span>
<a href="#l43.25"></a><span id="l43.25"> </span>
<a href="#l43.26"></a><span id="l43.26"> var outputParams = [];</span>
<a href="#l43.27"></a><span id="l43.27"> </span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">-IRCAccount.prototype.sendMessage = function(aCommand, aParams) {</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineplus">+irc.ircAccount.prototype.sendMessage = function(aCommand, aParams) {</span>
<a href="#l43.30"></a><span id="l43.30">   equal(&quot;PRIVMSG&quot;, aCommand);</span>
<a href="#l43.31"></a><span id="l43.31">   outputParams.push(aParams[1]);</span>
<a href="#l43.32"></a><span id="l43.32"> };</span>
<a href="#l43.33"></a><span id="l43.33"> </span>
<a href="#l43.34"></a><span id="l43.34"> function run_test() {</span>
<a href="#l43.35"></a><span id="l43.35">   input.map(aStr =&gt;</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineminus">-    IRCAccount.prototype.sendCTCPMessage(&quot;&quot;, false, &quot;ACTION&quot;, aStr)</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineplus">+    irc.ircAccount.prototype.sendCTCPMessage(&quot;&quot;, false, &quot;ACTION&quot;, aStr)</span>
<a href="#l43.38"></a><span id="l43.38">   );</span>
<a href="#l43.39"></a><span id="l43.39"> </span>
<a href="#l43.40"></a><span id="l43.40">   // Ensure both arrays have the same length.</span>
<a href="#l43.41"></a><span id="l43.41">   equal(expectedOutputParams.length, outputParams.length);</span>
<a href="#l43.42"></a><span id="l43.42">   // Ensure the values in the arrays are equal.</span>
<a href="#l43.43"></a><span id="l43.43">   for (let i = 0; i &lt; outputParams.length; ++i) {</span>
<a href="#l43.44"></a><span id="l43.44">     equal(&quot;\x01&quot; + expectedOutputParams[i] + &quot;\x01&quot;, outputParams[i]);</span>
<a href="#l43.45"></a><span id="l43.45">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCAP.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCAP.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -177,25 +177,25 @@ function run_test() {</span>
<a href="#l44.4"></a><span id="l44.4">   run_next_test();</span>
<a href="#l44.5"></a><span id="l44.5"> }</span>
<a href="#l44.6"></a><span id="l44.6"> </span>
<a href="#l44.7"></a><span id="l44.7"> /*</span>
<a href="#l44.8"></a><span id="l44.8">  * Test round tripping parsing and then rebuilding the messages from RFC 2812.</span>
<a href="#l44.9"></a><span id="l44.9">  */</span>
<a href="#l44.10"></a><span id="l44.10"> function testCapMessages() {</span>
<a href="#l44.11"></a><span id="l44.11">   for (let data of testData) {</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    // Generate an IRCMessage to send into capMessage.</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+    // Generate an ircMessage to send into capMessage.</span>
<a href="#l44.14"></a><span id="l44.14">     let i = 0;</span>
<a href="#l44.15"></a><span id="l44.15">     let message;</span>
<a href="#l44.16"></a><span id="l44.16">     let outputs;</span>
<a href="#l44.17"></a><span id="l44.17">     const account = {</span>
<a href="#l44.18"></a><span id="l44.18">       _queuedCAPs: [],</span>
<a href="#l44.19"></a><span id="l44.19">     };</span>
<a href="#l44.20"></a><span id="l44.20"> </span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-    // Generate an IRCMessage to send into capMessage.</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+    // Generate an ircMessage to send into capMessage.</span>
<a href="#l44.23"></a><span id="l44.23">     while (typeof data[i][0] == &quot;string&quot;) {</span>
<a href="#l44.24"></a><span id="l44.24">       message = {</span>
<a href="#l44.25"></a><span id="l44.25">         params: data[i],</span>
<a href="#l44.26"></a><span id="l44.26">       };</span>
<a href="#l44.27"></a><span id="l44.27"> </span>
<a href="#l44.28"></a><span id="l44.28">       // Create the CAP message.</span>
<a href="#l44.29"></a><span id="l44.29">       outputs = cap.capMessage(message, account);</span>
<a href="#l44.30"></a><span id="l44.30">       ++i;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircCommands.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l45.4"></a><span id="l45.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l45.5"></a><span id="l45.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l45.8"></a><span id="l45.8"> var { commands } = ChromeUtils.import(&quot;resource:///modules/ircCommands.jsm&quot;);</span>
<a href="#l45.9"></a><span id="l45.9" class="difflineminus">-var { IRCAccount, IRCConversation } = ChromeUtils.import(</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineminus">-  &quot;resource:///modules/IRC.jsm&quot;</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineminus">-);</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+var irc = {};</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l45.15"></a><span id="l45.15"> </span>
<a href="#l45.16"></a><span id="l45.16"> // Ensure the commands have been initialized.</span>
<a href="#l45.17"></a><span id="l45.17"> Services.conversations.initConversations();</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19"> var fakeProto = {</span>
<a href="#l45.20"></a><span id="l45.20">   id: &quot;fake-proto&quot;,</span>
<a href="#l45.21"></a><span id="l45.21"> };</span>
<a href="#l45.22"></a><span id="l45.22"> </span>
<a href="#l45.23"></a><span id="l45.23" class="difflineat">@@ -114,36 +114,36 @@ function testModeCommand() {</span>
<a href="#l45.24"></a><span id="l45.24">       expectedMessage: &quot;MODE matrixisreal_19 +oWp&quot;,</span>
<a href="#l45.25"></a><span id="l45.25">     },</span>
<a href="#l45.26"></a><span id="l45.26">     {</span>
<a href="#l45.27"></a><span id="l45.27">       msg: &quot;nick&quot;,</span>
<a href="#l45.28"></a><span id="l45.28">       expectedMessage: &quot;MODE nick&quot;,</span>
<a href="#l45.29"></a><span id="l45.29">     },</span>
<a href="#l45.30"></a><span id="l45.30">   ];</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32" class="difflineminus">-  let account = new IRCAccount(fakeProto, {</span>
<a href="#l45.33"></a><span id="l45.33" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l45.34"></a><span id="l45.34">     name: &quot;defaultnick@instantbird.org&quot;,</span>
<a href="#l45.35"></a><span id="l45.35">   });</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37">   // check if the message being sent is same as expected message.</span>
<a href="#l45.38"></a><span id="l45.38">   account.sendRawMessage = aMessage =&gt; {</span>
<a href="#l45.39"></a><span id="l45.39">     equal(aMessage, account._expectedMessage);</span>
<a href="#l45.40"></a><span id="l45.40">   };</span>
<a href="#l45.41"></a><span id="l45.41"> </span>
<a href="#l45.42"></a><span id="l45.42">   const command = _getRunCommand(&quot;mode&quot;);</span>
<a href="#l45.43"></a><span id="l45.43"> </span>
<a href="#l45.44"></a><span id="l45.44">   // First test Channel Commands.</span>
<a href="#l45.45"></a><span id="l45.45">   for (let test of testChannelCommands) {</span>
<a href="#l45.46"></a><span id="l45.46" class="difflineminus">-    let conv = new IRCConversation(account, test.channel);</span>
<a href="#l45.47"></a><span id="l45.47" class="difflineplus">+    let conv = new irc.ircConversation(account, test.channel);</span>
<a href="#l45.48"></a><span id="l45.48">     account._expectedMessage = test.expectedMessage;</span>
<a href="#l45.49"></a><span id="l45.49">     command(test.msg, conv);</span>
<a href="#l45.50"></a><span id="l45.50">   }</span>
<a href="#l45.51"></a><span id="l45.51"> </span>
<a href="#l45.52"></a><span id="l45.52">   // Now test the User Commands.</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineminus">-  let conv = new IRCConversation(account, &quot;dummyConversation&quot;);</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+  let conv = new irc.ircConversation(account, &quot;dummyConversation&quot;);</span>
<a href="#l45.55"></a><span id="l45.55">   account._nickname = &quot;test_nick&quot;;</span>
<a href="#l45.56"></a><span id="l45.56">   for (let test of testUserCommands) {</span>
<a href="#l45.57"></a><span id="l45.57">     account._expectedMessage = test.expectedMessage;</span>
<a href="#l45.58"></a><span id="l45.58">     command(test.msg, conv);</span>
<a href="#l45.59"></a><span id="l45.59">   }</span>
<a href="#l45.60"></a><span id="l45.60"> </span>
<a href="#l45.61"></a><span id="l45.61">   run_next_test();</span>
<a href="#l45.62"></a><span id="l45.62"> }</span>
<a href="#l45.63"></a><span id="l45.63" class="difflineat">@@ -168,21 +168,21 @@ function testUserModeCommand() {</span>
<a href="#l45.64"></a><span id="l45.64">       expectedMessage: &quot;MODE test_nick +oWp&quot;,</span>
<a href="#l45.65"></a><span id="l45.65">     },</span>
<a href="#l45.66"></a><span id="l45.66">     {</span>
<a href="#l45.67"></a><span id="l45.67">       msg: &quot;&quot;,</span>
<a href="#l45.68"></a><span id="l45.68">       expectedMessage: &quot;MODE test_nick&quot;,</span>
<a href="#l45.69"></a><span id="l45.69">     },</span>
<a href="#l45.70"></a><span id="l45.70">   ];</span>
<a href="#l45.71"></a><span id="l45.71"> </span>
<a href="#l45.72"></a><span id="l45.72" class="difflineminus">-  let account = new IRCAccount(fakeProto, {</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l45.74"></a><span id="l45.74">     name: &quot;test_nick@instantbird.org&quot;,</span>
<a href="#l45.75"></a><span id="l45.75">   });</span>
<a href="#l45.76"></a><span id="l45.76">   account._nickname = &quot;test_nick&quot;;</span>
<a href="#l45.77"></a><span id="l45.77" class="difflineminus">-  let conv = new IRCConversation(account, &quot;newconv&quot;);</span>
<a href="#l45.78"></a><span id="l45.78" class="difflineplus">+  let conv = new irc.ircConversation(account, &quot;newconv&quot;);</span>
<a href="#l45.79"></a><span id="l45.79"> </span>
<a href="#l45.80"></a><span id="l45.80">   // check if the message being sent is same as expected message.</span>
<a href="#l45.81"></a><span id="l45.81">   account.sendRawMessage = aMessage =&gt; {</span>
<a href="#l45.82"></a><span id="l45.82">     equal(aMessage, account._expectedMessage);</span>
<a href="#l45.83"></a><span id="l45.83">   };</span>
<a href="#l45.84"></a><span id="l45.84"> </span>
<a href="#l45.85"></a><span id="l45.85">   const command = _getRunCommand(&quot;umode&quot;);</span>
<a href="#l45.86"></a><span id="l45.86"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircMessage.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l46.4"></a><span id="l46.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l46.5"></a><span id="l46.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l46.6"></a><span id="l46.6"> </span>
<a href="#l46.7"></a><span id="l46.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineminus">-var { IRCAccount, IRCMessage } = ChromeUtils.import(</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineminus">-  &quot;resource:///modules/IRC.jsm&quot;</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineminus">-);</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineplus">+var irc = {};</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l46.13"></a><span id="l46.13"> </span>
<a href="#l46.14"></a><span id="l46.14"> var testData = [</span>
<a href="#l46.15"></a><span id="l46.15">   // First off, let's test the messages from RFC 2812.</span>
<a href="#l46.16"></a><span id="l46.16">   &quot;PASS secretpasswordhere&quot;,</span>
<a href="#l46.17"></a><span id="l46.17">   &quot;NICK Wiz&quot;,</span>
<a href="#l46.18"></a><span id="l46.18">   &quot;:WiZ!jto@tolsun.oulu.fi NICK Kilroy&quot;,</span>
<a href="#l46.19"></a><span id="l46.19">   &quot;USER guest 0 * :Ronnie Reagan&quot;,</span>
<a href="#l46.20"></a><span id="l46.20">   &quot;USER guest 8 * :Ronnie Reagan&quot;,</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineat">@@ -127,19 +126,19 @@ function run_test() {</span>
<a href="#l46.22"></a><span id="l46.22"> }</span>
<a href="#l46.23"></a><span id="l46.23"> </span>
<a href="#l46.24"></a><span id="l46.24"> /*</span>
<a href="#l46.25"></a><span id="l46.25">  * Test round tripping parsing and then rebuilding the messages from RFC 2812.</span>
<a href="#l46.26"></a><span id="l46.26">  */</span>
<a href="#l46.27"></a><span id="l46.27"> function testRFC2812Messages() {</span>
<a href="#l46.28"></a><span id="l46.28">   for (let expectedStringMessage of testData) {</span>
<a href="#l46.29"></a><span id="l46.29">     // Pass in an empty default origin in order to check this below.</span>
<a href="#l46.30"></a><span id="l46.30" class="difflineminus">-    let message = IRCMessage(expectedStringMessage, &quot;&quot;);</span>
<a href="#l46.31"></a><span id="l46.31" class="difflineplus">+    let message = irc.ircMessage(expectedStringMessage, &quot;&quot;);</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33" class="difflineminus">-    let stringMessage = IRCAccount.prototype.buildMessage(</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineplus">+    let stringMessage = irc.ircAccount.prototype.buildMessage(</span>
<a href="#l46.35"></a><span id="l46.35">       message.command,</span>
<a href="#l46.36"></a><span id="l46.36">       message.params</span>
<a href="#l46.37"></a><span id="l46.37">     );</span>
<a href="#l46.38"></a><span id="l46.38"> </span>
<a href="#l46.39"></a><span id="l46.39">     // Let's do a little dance here...we don't rebuild the &quot;source&quot; of the</span>
<a href="#l46.40"></a><span id="l46.40">     // message (the server does that), so when comparing our output message, we</span>
<a href="#l46.41"></a><span id="l46.41">     // need to avoid comparing to that part.</span>
<a href="#l46.42"></a><span id="l46.42">     if (message.origin) {</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineat">@@ -149,17 +148,17 @@ function testRFC2812Messages() {</span>
<a href="#l46.44"></a><span id="l46.44">     }</span>
<a href="#l46.45"></a><span id="l46.45"> </span>
<a href="#l46.46"></a><span id="l46.46">     equal(stringMessage, expectedStringMessage);</span>
<a href="#l46.47"></a><span id="l46.47">   }</span>
<a href="#l46.48"></a><span id="l46.48"> </span>
<a href="#l46.49"></a><span id="l46.49">   run_next_test();</span>
<a href="#l46.50"></a><span id="l46.50"> }</span>
<a href="#l46.51"></a><span id="l46.51"> </span>
<a href="#l46.52"></a><span id="l46.52" class="difflineminus">-// Unreal sends a couple of broken messages, see IRCMessage in IRC.jsm for a</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineplus">+// Unreal sends a couple of broken messages, see ircMessage in irc.js for a</span>
<a href="#l46.54"></a><span id="l46.54"> // description of what's wrong.</span>
<a href="#l46.55"></a><span id="l46.55"> function testBrokenUnrealMessages() {</span>
<a href="#l46.56"></a><span id="l46.56">   let messages = {</span>
<a href="#l46.57"></a><span id="l46.57">     // Two spaces after command.</span>
<a href="#l46.58"></a><span id="l46.58">     &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;: {</span>
<a href="#l46.59"></a><span id="l46.59">       rawMessage:</span>
<a href="#l46.60"></a><span id="l46.60">         &quot;:gravel.mozilla.org 432  #momo :Erroneous Nickname: Illegal characters&quot;,</span>
<a href="#l46.61"></a><span id="l46.61">       command: &quot;432&quot;,</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineat">@@ -190,17 +189,17 @@ function testBrokenUnrealMessages() {</span>
<a href="#l46.63"></a><span id="l46.63">       user: undefined,</span>
<a href="#l46.64"></a><span id="l46.64">       host: undefined,</span>
<a href="#l46.65"></a><span id="l46.65">       source: &quot;&quot;,</span>
<a href="#l46.66"></a><span id="l46.66">       tags: new Map(),</span>
<a href="#l46.67"></a><span id="l46.67">     },</span>
<a href="#l46.68"></a><span id="l46.68">   };</span>
<a href="#l46.69"></a><span id="l46.69"> </span>
<a href="#l46.70"></a><span id="l46.70">   for (let messageStr in messages) {</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineminus">-    deepEqual(messages[messageStr], IRCMessage(messageStr, &quot;&quot;));</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineplus">+    deepEqual(messages[messageStr], irc.ircMessage(messageStr, &quot;&quot;));</span>
<a href="#l46.73"></a><span id="l46.73">   }</span>
<a href="#l46.74"></a><span id="l46.74"> </span>
<a href="#l46.75"></a><span id="l46.75">   run_next_test();</span>
<a href="#l46.76"></a><span id="l46.76"> }</span>
<a href="#l46.77"></a><span id="l46.77"> </span>
<a href="#l46.78"></a><span id="l46.78"> // After unescaping we can end up with line breaks inside of IRC messages. Test</span>
<a href="#l46.79"></a><span id="l46.79"> // this edge case specifically.</span>
<a href="#l46.80"></a><span id="l46.80"> function testNewLinesInMessages() {</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineat">@@ -225,17 +224,17 @@ function testNewLinesInMessages() {</span>
<a href="#l46.82"></a><span id="l46.82">       user: &quot;Instantbir&quot;,</span>
<a href="#l46.83"></a><span id="l46.83">       host: &quot;host&quot;,</span>
<a href="#l46.84"></a><span id="l46.84">       tags: new Map(),</span>
<a href="#l46.85"></a><span id="l46.85">       source: &quot;Instantbir@host&quot;,</span>
<a href="#l46.86"></a><span id="l46.86">     },</span>
<a href="#l46.87"></a><span id="l46.87">   };</span>
<a href="#l46.88"></a><span id="l46.88"> </span>
<a href="#l46.89"></a><span id="l46.89">   for (let messageStr in messages) {</span>
<a href="#l46.90"></a><span id="l46.90" class="difflineminus">-    deepEqual(messages[messageStr], IRCMessage(messageStr));</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineplus">+    deepEqual(messages[messageStr], irc.ircMessage(messageStr));</span>
<a href="#l46.92"></a><span id="l46.92">   }</span>
<a href="#l46.93"></a><span id="l46.93"> </span>
<a href="#l46.94"></a><span id="l46.94">   run_next_test();</span>
<a href="#l46.95"></a><span id="l46.95"> }</span>
<a href="#l46.96"></a><span id="l46.96"> </span>
<a href="#l46.97"></a><span id="l46.97"> // Sometimes it is a bit hard to tell whether a prefix is a nickname or a</span>
<a href="#l46.98"></a><span id="l46.98"> // servername. Generally this happens when connecting to localhost or a local</span>
<a href="#l46.99"></a><span id="l46.99"> // hostname and is likely seen with bouncers.</span>
<a href="#l46.100"></a><span id="l46.100" class="difflineat">@@ -250,17 +249,17 @@ function testLocalhost() {</span>
<a href="#l46.101"></a><span id="l46.101">       user: undefined,</span>
<a href="#l46.102"></a><span id="l46.102">       host: undefined,</span>
<a href="#l46.103"></a><span id="l46.103">       tags: new Map(),</span>
<a href="#l46.104"></a><span id="l46.104">       source: &quot;&quot;,</span>
<a href="#l46.105"></a><span id="l46.105">     },</span>
<a href="#l46.106"></a><span id="l46.106">   };</span>
<a href="#l46.107"></a><span id="l46.107"> </span>
<a href="#l46.108"></a><span id="l46.108">   for (let messageStr in messages) {</span>
<a href="#l46.109"></a><span id="l46.109" class="difflineminus">-    deepEqual(messages[messageStr], IRCMessage(messageStr));</span>
<a href="#l46.110"></a><span id="l46.110" class="difflineplus">+    deepEqual(messages[messageStr], irc.ircMessage(messageStr));</span>
<a href="#l46.111"></a><span id="l46.111">   }</span>
<a href="#l46.112"></a><span id="l46.112"> </span>
<a href="#l46.113"></a><span id="l46.113">   run_next_test();</span>
<a href="#l46.114"></a><span id="l46.114"> }</span>
<a href="#l46.115"></a><span id="l46.115"> </span>
<a href="#l46.116"></a><span id="l46.116"> function testTags() {</span>
<a href="#l46.117"></a><span id="l46.117">   let messages = {</span>
<a href="#l46.118"></a><span id="l46.118">     &quot;@aaa=bBb;ccc;example.com/ddd=eee :nick!ident@host.com PRIVMSG me :Hello&quot;: {</span>
<a href="#l46.119"></a><span id="l46.119" class="difflineat">@@ -321,13 +320,13 @@ function testTags() {</span>
<a href="#l46.120"></a><span id="l46.120">       user: &quot;~john&quot;,</span>
<a href="#l46.121"></a><span id="l46.121">       host: &quot;1.2.3.4&quot;,</span>
<a href="#l46.122"></a><span id="l46.122">       tags: new Map([[&quot;time&quot;, &quot;2012-06-30T23:59:60.419Z&quot;]]),</span>
<a href="#l46.123"></a><span id="l46.123">       source: &quot;~john@1.2.3.4&quot;,</span>
<a href="#l46.124"></a><span id="l46.124">     },</span>
<a href="#l46.125"></a><span id="l46.125">   };</span>
<a href="#l46.126"></a><span id="l46.126"> </span>
<a href="#l46.127"></a><span id="l46.127">   for (let messageStr in messages) {</span>
<a href="#l46.128"></a><span id="l46.128" class="difflineminus">-    deepEqual(messages[messageStr], IRCMessage(messageStr, &quot;&quot;));</span>
<a href="#l46.129"></a><span id="l46.129" class="difflineplus">+    deepEqual(messages[messageStr], irc.ircMessage(messageStr, &quot;&quot;));</span>
<a href="#l46.130"></a><span id="l46.130">   }</span>
<a href="#l46.131"></a><span id="l46.131"> </span>
<a href="#l46.132"></a><span id="l46.132">   run_next_test();</span>
<a href="#l46.133"></a><span id="l46.133"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircNonStandard.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l47.5"></a><span id="l47.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l47.6"></a><span id="l47.6"> </span>
<a href="#l47.7"></a><span id="l47.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">-var { IRCMessage } = ChromeUtils.import(&quot;resource:///modules/IRC.jsm&quot;);</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+var irc = {};</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l47.11"></a><span id="l47.11"> const { ircNonStandard } = ChromeUtils.import(</span>
<a href="#l47.12"></a><span id="l47.12">   &quot;resource:///modules/ircNonStandard.jsm&quot;</span>
<a href="#l47.13"></a><span id="l47.13"> );</span>
<a href="#l47.14"></a><span id="l47.14"> </span>
<a href="#l47.15"></a><span id="l47.15"> // The function that is under test here.</span>
<a href="#l47.16"></a><span id="l47.16"> var NOTICE = ircNonStandard.commands.NOTICE;</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18"> function FakeConversation() {}</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineat">@@ -51,17 +52,17 @@ function run_test() {</span>
<a href="#l47.20"></a><span id="l47.20"> /*</span>
<a href="#l47.21"></a><span id="l47.21">  * Test that SECURELIST properly sets the timer such that another LIST call can</span>
<a href="#l47.22"></a><span id="l47.22">  * happen soon. See bug 1082501.</span>
<a href="#l47.23"></a><span id="l47.23">  */</span>
<a href="#l47.24"></a><span id="l47.24"> function testSecureList() {</span>
<a href="#l47.25"></a><span id="l47.25">   const kSecureListMsg =</span>
<a href="#l47.26"></a><span id="l47.26">     &quot;:fripp.mozilla.org NOTICE aleth-build :*** You cannot list within the first 60 seconds of connecting. Please try again later.&quot;;</span>
<a href="#l47.27"></a><span id="l47.27"> </span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-  let message = IRCMessage(kSecureListMsg, &quot;&quot;);</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+  let message = irc.ircMessage(kSecureListMsg, &quot;&quot;);</span>
<a href="#l47.30"></a><span id="l47.30">   let account = new FakeAccount();</span>
<a href="#l47.31"></a><span id="l47.31">   account.connected = true;</span>
<a href="#l47.32"></a><span id="l47.32">   let result = NOTICE.call(account, message);</span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34">   // Yes, it was handled.</span>
<a href="#l47.35"></a><span id="l47.35">   ok(result);</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37">   // Undo the expected calculation, this should be near 0.</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineat">@@ -78,17 +79,17 @@ function testSecureList() {</span>
<a href="#l47.39"></a><span id="l47.39">  */</span>
<a href="#l47.40"></a><span id="l47.40"> function testZncAuth() {</span>
<a href="#l47.41"></a><span id="l47.41">   const kZncMsgs = [</span>
<a href="#l47.42"></a><span id="l47.42">     &quot;:irc.znc.in NOTICE AUTH :*** You need to send your password. Try /quote PASS &lt;username&gt;:&lt;password&gt;&quot;,</span>
<a href="#l47.43"></a><span id="l47.43">     &quot;:irc.znc.in NOTICE AUTH :*** You need to send your password. Configure your client to send a server password.&quot;,</span>
<a href="#l47.44"></a><span id="l47.44">   ];</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46">   for (let msg of kZncMsgs) {</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-    let message = IRCMessage(msg, &quot;&quot;);</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+    let message = irc.ircMessage(msg, &quot;&quot;);</span>
<a href="#l47.49"></a><span id="l47.49">     // No provided password.</span>
<a href="#l47.50"></a><span id="l47.50">     let account = new FakeAccount();</span>
<a href="#l47.51"></a><span id="l47.51">     let result = NOTICE.call(account, message);</span>
<a href="#l47.52"></a><span id="l47.52"> </span>
<a href="#l47.53"></a><span id="l47.53">     // Yes, it was handled.</span>
<a href="#l47.54"></a><span id="l47.54">     Assert.ok(result);</span>
<a href="#l47.55"></a><span id="l47.55"> </span>
<a href="#l47.56"></a><span id="l47.56">     // No sent data and parameters should be unchanged.</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineat">@@ -137,27 +138,27 @@ function testUMich() {</span>
<a href="#l47.58"></a><span id="l47.58">     &quot;NOTICE AUTH :*** No Ident response&quot;,</span>
<a href="#l47.59"></a><span id="l47.59">   ];</span>
<a href="#l47.60"></a><span id="l47.60"> </span>
<a href="#l47.61"></a><span id="l47.61">   const kFinalMsg =</span>
<a href="#l47.62"></a><span id="l47.62">     ':irc.umich.edu NOTICE clokep :To complete your connection to this server, type &quot;/QUOTE PONG :cookie&quot;, where cookie is the following ascii.';</span>
<a href="#l47.63"></a><span id="l47.63"> </span>
<a href="#l47.64"></a><span id="l47.64">   let account = new FakeAccount();</span>
<a href="#l47.65"></a><span id="l47.65">   for (let msg of kMsgs) {</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineminus">-    let message = IRCMessage(msg, &quot;&quot;);</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineplus">+    let message = irc.ircMessage(msg, &quot;&quot;);</span>
<a href="#l47.68"></a><span id="l47.68">     let result = NOTICE.call(account, message);</span>
<a href="#l47.69"></a><span id="l47.69"> </span>
<a href="#l47.70"></a><span id="l47.70">     // These initial notices are not handled (i.e. they'll be subject to</span>
<a href="#l47.71"></a><span id="l47.71">     // _showServerTab).</span>
<a href="#l47.72"></a><span id="l47.72">     equal(result, false);</span>
<a href="#l47.73"></a><span id="l47.73">   }</span>
<a href="#l47.74"></a><span id="l47.74"> </span>
<a href="#l47.75"></a><span id="l47.75">   // And finally the last one should be printed out, always. It contains the</span>
<a href="#l47.76"></a><span id="l47.76">   // directions of what to do next.</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-  let message = IRCMessage(kFinalMsg, &quot;&quot;);</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+  let message = irc.ircMessage(kFinalMsg, &quot;&quot;);</span>
<a href="#l47.79"></a><span id="l47.79">   let result = NOTICE.call(account, message);</span>
<a href="#l47.80"></a><span id="l47.80">   ok(result);</span>
<a href="#l47.81"></a><span id="l47.81">   equal(account.convs.length, 1);</span>
<a href="#l47.82"></a><span id="l47.82">   equal(account.convs[0], &quot;irc.umich.edu&quot;);</span>
<a href="#l47.83"></a><span id="l47.83"> </span>
<a href="#l47.84"></a><span id="l47.84">   run_next_test();</span>
<a href="#l47.85"></a><span id="l47.85"> }</span>
<a href="#l47.86"></a><span id="l47.86"> </span>
<a href="#l47.87"></a><span id="l47.87" class="difflineat">@@ -166,17 +167,17 @@ function testUMich() {</span>
<a href="#l47.88"></a><span id="l47.88">  */</span>
<a href="#l47.89"></a><span id="l47.89"> function testAuthNick() {</span>
<a href="#l47.90"></a><span id="l47.90">   const kMsg =</span>
<a href="#l47.91"></a><span id="l47.91">     ':irc.umich.edu NOTICE AUTH :To complete your connection to this server, type &quot;/QUOTE PONG :cookie&quot;, where cookie is the following ascii.';</span>
<a href="#l47.92"></a><span id="l47.92"> </span>
<a href="#l47.93"></a><span id="l47.93">   let account = new FakeAccount();</span>
<a href="#l47.94"></a><span id="l47.94">   account._nickname = &quot;AUTH&quot;;</span>
<a href="#l47.95"></a><span id="l47.95"> </span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-  let message = IRCMessage(kMsg, &quot;&quot;);</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+  let message = irc.ircMessage(kMsg, &quot;&quot;);</span>
<a href="#l47.98"></a><span id="l47.98">   let result = NOTICE.call(account, message);</span>
<a href="#l47.99"></a><span id="l47.99"> </span>
<a href="#l47.100"></a><span id="l47.100">   // Since it is ambiguous if it was an authentication message or a message</span>
<a href="#l47.101"></a><span id="l47.101">   // directed at the user, print it out.</span>
<a href="#l47.102"></a><span id="l47.102">   ok(result);</span>
<a href="#l47.103"></a><span id="l47.103"> </span>
<a href="#l47.104"></a><span id="l47.104">   run_next_test();</span>
<a href="#l47.105"></a><span id="l47.105"> }</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineat">@@ -192,17 +193,17 @@ function testIgnoredNotices() {</span>
<a href="#l47.107"></a><span id="l47.107">     // Some servers (oftc) send a NOTICE that isn't an auth, but notifies about</span>
<a href="#l47.108"></a><span id="l47.108">     // the connection. See bug 1182735.</span>
<a href="#l47.109"></a><span id="l47.109">     &quot;:beauty.oftc.net NOTICE myusername :*** Connected securely via UNKNOWN AES128-SHA-128&quot;,</span>
<a href="#l47.110"></a><span id="l47.110">   ];</span>
<a href="#l47.111"></a><span id="l47.111"> </span>
<a href="#l47.112"></a><span id="l47.112">   for (let msg of kMsgs) {</span>
<a href="#l47.113"></a><span id="l47.113">     let account = new FakeAccount();</span>
<a href="#l47.114"></a><span id="l47.114"> </span>
<a href="#l47.115"></a><span id="l47.115" class="difflineminus">-    let message = IRCMessage(msg, &quot;&quot;);</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineplus">+    let message = irc.ircMessage(msg, &quot;&quot;);</span>
<a href="#l47.117"></a><span id="l47.117">     let result = NOTICE.call(account, message);</span>
<a href="#l47.118"></a><span id="l47.118"> </span>
<a href="#l47.119"></a><span id="l47.119">     // This message should *NOT* be shown.</span>
<a href="#l47.120"></a><span id="l47.120">     equal(result, false);</span>
<a href="#l47.121"></a><span id="l47.121">   }</span>
<a href="#l47.122"></a><span id="l47.122"> </span>
<a href="#l47.123"></a><span id="l47.123">   run_next_test();</span>
<a href="#l47.124"></a><span id="l47.124"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_ircServerTime.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,20 +1,21 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l48.5"></a><span id="l48.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> var { tagServerTime } = ChromeUtils.import(</span>
<a href="#l48.8"></a><span id="l48.8">   &quot;resource:///modules/ircServerTime.jsm&quot;</span>
<a href="#l48.9"></a><span id="l48.9"> );</span>
<a href="#l48.10"></a><span id="l48.10"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-var { IRCMessage } = ChromeUtils.import(&quot;resource:///modules/IRC.jsm&quot;);</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+var irc = {};</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l48.15"></a><span id="l48.15"> </span>
<a href="#l48.16"></a><span id="l48.16"> function getTags(aRawMsg) {</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-  const { tags } = IRCMessage(aRawMsg, &quot;doesnt@matter&quot;);</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+  const { tags } = irc.ircMessage(aRawMsg, &quot;doesnt@matter&quot;);</span>
<a href="#l48.19"></a><span id="l48.19"> </span>
<a href="#l48.20"></a><span id="l48.20">   return tags;</span>
<a href="#l48.21"></a><span id="l48.21"> }</span>
<a href="#l48.22"></a><span id="l48.22"> </span>
<a href="#l48.23"></a><span id="l48.23"> function run_test() {</span>
<a href="#l48.24"></a><span id="l48.24">   add_test(specMessages);</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26">   run_next_test();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_sendBufferedCommand.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,23 +1,22 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.5"></a><span id="l49.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l49.9"></a><span id="l49.9" class="difflineminus">-var { setTimeout, IRCAccount, clearTimeout } = ChromeUtils.import(</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineminus">-  &quot;resource:///modules/IRC.jsm&quot;</span>
<a href="#l49.11"></a><span id="l49.11" class="difflineminus">-);</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineplus">+var irc = {};</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15"> function FakeAccount() {</span>
<a href="#l49.16"></a><span id="l49.16">   this._commandBuffers = new Map();</span>
<a href="#l49.17"></a><span id="l49.17">   this.callbacks = [];</span>
<a href="#l49.18"></a><span id="l49.18"> }</span>
<a href="#l49.19"></a><span id="l49.19"> FakeAccount.prototype = {</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-  __proto__: IRCAccount.prototype,</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+  __proto__: irc.ircAccount.prototype,</span>
<a href="#l49.22"></a><span id="l49.22">   maxMessageLength: 60,</span>
<a href="#l49.23"></a><span id="l49.23">   callbacks: [],</span>
<a href="#l49.24"></a><span id="l49.24">   sendMessage(aCommand, aParams) {</span>
<a href="#l49.25"></a><span id="l49.25">     this.callbacks.shift()(aCommand, aParams);</span>
<a href="#l49.26"></a><span id="l49.26">   },</span>
<a href="#l49.27"></a><span id="l49.27"> };</span>
<a href="#l49.28"></a><span id="l49.28"> </span>
<a href="#l49.29"></a><span id="l49.29"> var account = new FakeAccount();</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineat">@@ -61,26 +60,25 @@ function test_parameterCollect() {</span>
<a href="#l49.31"></a><span id="l49.31">   for (let test of tests) {</span>
<a href="#l49.32"></a><span id="l49.32">     let timeout;</span>
<a href="#l49.33"></a><span id="l49.33">     // Destructure test to local variables so each function</span>
<a href="#l49.34"></a><span id="l49.34">     // generated here gets the correct value in its scope.</span>
<a href="#l49.35"></a><span id="l49.35">     let { data, result } = test;</span>
<a href="#l49.36"></a><span id="l49.36">     account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l49.37"></a><span id="l49.37">       let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l49.38"></a><span id="l49.38">       equal(msg, result, &quot;Test buffering of parameters&quot;);</span>
<a href="#l49.39"></a><span id="l49.39" class="difflineminus">-      clearTimeout(timeout);</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineplus">+      irc.clearTimeout(timeout);</span>
<a href="#l49.41"></a><span id="l49.41">       account._lastCommandSendTime = 0;</span>
<a href="#l49.42"></a><span id="l49.42">       run_next_test();</span>
<a href="#l49.43"></a><span id="l49.43">     });</span>
<a href="#l49.44"></a><span id="l49.44">     add_test(() =&gt; {</span>
<a href="#l49.45"></a><span id="l49.45">       // This timeout lets the test fail more quickly if</span>
<a href="#l49.46"></a><span id="l49.46">       // some of the callbacks we added don't get called.</span>
<a href="#l49.47"></a><span id="l49.47">       // Not strictly speaking necessary.</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineminus">-      // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-      timeout = setTimeout(() =&gt; {</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+      timeout = irc.setTimeout(() =&gt; {</span>
<a href="#l49.51"></a><span id="l49.51">         ok(false, &quot;test_parameterCollect failed after timeout.&quot;);</span>
<a href="#l49.52"></a><span id="l49.52">         run_next_test();</span>
<a href="#l49.53"></a><span id="l49.53">       }, 2000);</span>
<a href="#l49.54"></a><span id="l49.54">       for (let [channel, key] of data) {</span>
<a href="#l49.55"></a><span id="l49.55">         account.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l49.56"></a><span id="l49.56">       }</span>
<a href="#l49.57"></a><span id="l49.57">     });</span>
<a href="#l49.58"></a><span id="l49.58">   }</span>
<a href="#l49.59"></a><span id="l49.59" class="difflineat">@@ -89,34 +87,32 @@ function test_parameterCollect() {</span>
<a href="#l49.60"></a><span id="l49.60">   // the event loop.</span>
<a href="#l49.61"></a><span id="l49.61">   account._lastCommandSendTime = 0;</span>
<a href="#l49.62"></a><span id="l49.62">   for (let test of tests) {</span>
<a href="#l49.63"></a><span id="l49.63">     let timeout;</span>
<a href="#l49.64"></a><span id="l49.64">     let { data, result } = test;</span>
<a href="#l49.65"></a><span id="l49.65">     account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l49.66"></a><span id="l49.66">       let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l49.67"></a><span id="l49.67">       equal(msg, result, &quot;Test buffering with setTimeout&quot;);</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineminus">-      clearTimeout(timeout);</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+      irc.clearTimeout(timeout);</span>
<a href="#l49.70"></a><span id="l49.70">       run_next_test();</span>
<a href="#l49.71"></a><span id="l49.71">     });</span>
<a href="#l49.72"></a><span id="l49.72">     add_test(() =&gt; {</span>
<a href="#l49.73"></a><span id="l49.73">       // This timeout lets the test fail more quickly if</span>
<a href="#l49.74"></a><span id="l49.74">       // some of the callbacks we added don't get called.</span>
<a href="#l49.75"></a><span id="l49.75">       // Not strictly speaking necessary.</span>
<a href="#l49.76"></a><span id="l49.76" class="difflineminus">-      // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l49.77"></a><span id="l49.77" class="difflineminus">-      timeout = setTimeout(() =&gt; {</span>
<a href="#l49.78"></a><span id="l49.78" class="difflineplus">+      timeout = irc.setTimeout(() =&gt; {</span>
<a href="#l49.79"></a><span id="l49.79">         ok(false, &quot;test_parameterCollect failed after timeout.&quot;);</span>
<a href="#l49.80"></a><span id="l49.80">         run_next_test();</span>
<a href="#l49.81"></a><span id="l49.81">       }, 2000);</span>
<a href="#l49.82"></a><span id="l49.82">       let delay = 0;</span>
<a href="#l49.83"></a><span id="l49.83">       for (let params of data) {</span>
<a href="#l49.84"></a><span id="l49.84">         let [channel, key] = params;</span>
<a href="#l49.85"></a><span id="l49.85">         delay += 200;</span>
<a href="#l49.86"></a><span id="l49.86" class="difflineminus">-        // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineminus">-        setTimeout(() =&gt; {</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineplus">+        irc.setTimeout(() =&gt; {</span>
<a href="#l49.89"></a><span id="l49.89">           account.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l49.90"></a><span id="l49.90">         }, delay);</span>
<a href="#l49.91"></a><span id="l49.91">       }</span>
<a href="#l49.92"></a><span id="l49.92">     });</span>
<a href="#l49.93"></a><span id="l49.93">   }</span>
<a href="#l49.94"></a><span id="l49.94"> }</span>
<a href="#l49.95"></a><span id="l49.95"> </span>
<a href="#l49.96"></a><span id="l49.96"> function test_maxLength() {</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineat">@@ -167,27 +163,26 @@ function test_maxLength() {</span>
<a href="#l49.98"></a><span id="l49.98">     let { data, results } = test;</span>
<a href="#l49.99"></a><span id="l49.99">     for (let r of results) {</span>
<a href="#l49.100"></a><span id="l49.100">       let result = r;</span>
<a href="#l49.101"></a><span id="l49.101">       account.callbacks.push((aCommand, aParams) =&gt; {</span>
<a href="#l49.102"></a><span id="l49.102">         let msg = account.buildMessage(aCommand, aParams);</span>
<a href="#l49.103"></a><span id="l49.103">         equal(msg, result, &quot;Test maximum message length constraint&quot;);</span>
<a href="#l49.104"></a><span id="l49.104">         // After all results are checked, run the next test.</span>
<a href="#l49.105"></a><span id="l49.105">         if (result == results[results.length - 1]) {</span>
<a href="#l49.106"></a><span id="l49.106" class="difflineminus">-          clearTimeout(timeout);</span>
<a href="#l49.107"></a><span id="l49.107" class="difflineplus">+          irc.clearTimeout(timeout);</span>
<a href="#l49.108"></a><span id="l49.108">           run_next_test();</span>
<a href="#l49.109"></a><span id="l49.109">         }</span>
<a href="#l49.110"></a><span id="l49.110">       });</span>
<a href="#l49.111"></a><span id="l49.111">     }</span>
<a href="#l49.112"></a><span id="l49.112">     add_test(() =&gt; {</span>
<a href="#l49.113"></a><span id="l49.113">       // This timeout lets the test fail more quickly if</span>
<a href="#l49.114"></a><span id="l49.114">       // some of the callbacks we added don't get called.</span>
<a href="#l49.115"></a><span id="l49.115">       // Not strictly speaking necessary.</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineminus">-      // eslint-disable-next-line mozilla/no-arbitrary-setTimeout</span>
<a href="#l49.117"></a><span id="l49.117" class="difflineminus">-      timeout = setTimeout(() =&gt; {</span>
<a href="#l49.118"></a><span id="l49.118" class="difflineplus">+      timeout = irc.setTimeout(() =&gt; {</span>
<a href="#l49.119"></a><span id="l49.119">         ok(false, &quot;test_maxLength failed after timeout.&quot;);</span>
<a href="#l49.120"></a><span id="l49.120">         run_next_test();</span>
<a href="#l49.121"></a><span id="l49.121">       }, 2000);</span>
<a href="#l49.122"></a><span id="l49.122">       for (let [channel, key] of data) {</span>
<a href="#l49.123"></a><span id="l49.123">         account.sendBufferedCommand(&quot;JOIN&quot;, channel, key);</span>
<a href="#l49.124"></a><span id="l49.124">       }</span>
<a href="#l49.125"></a><span id="l49.125">     });</span>
<a href="#l49.126"></a><span id="l49.126">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_setMode.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -1,36 +1,35 @@</span>
<a href="#l50.4"></a><span id="l50.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l50.5"></a><span id="l50.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l50.8"></a><span id="l50.8" class="difflineminus">-var { IRCAccount, IRCChannel } = ChromeUtils.import(</span>
<a href="#l50.9"></a><span id="l50.9" class="difflineminus">-  &quot;resource:///modules/IRC.jsm&quot;</span>
<a href="#l50.10"></a><span id="l50.10" class="difflineminus">-);</span>
<a href="#l50.11"></a><span id="l50.11" class="difflineplus">+var irc = {};</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l50.13"></a><span id="l50.13"> Services.conversations.initConversations();</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15"> function FakeAccount() {</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-  this.normalizeNick = IRCAccount.prototype.normalizeNick.bind(this);</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+  this.normalizeNick = irc.ircAccount.prototype.normalizeNick.bind(this);</span>
<a href="#l50.18"></a><span id="l50.18"> }</span>
<a href="#l50.19"></a><span id="l50.19"> FakeAccount.prototype = {</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-  __proto__: IRCAccount.prototype,</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+  __proto__: irc.ircAccount.prototype,</span>
<a href="#l50.22"></a><span id="l50.22">   setWhois: (n, f) =&gt; true,</span>
<a href="#l50.23"></a><span id="l50.23">   ERROR: do_throw,</span>
<a href="#l50.24"></a><span id="l50.24"> };</span>
<a href="#l50.25"></a><span id="l50.25"> </span>
<a href="#l50.26"></a><span id="l50.26"> function run_test() {</span>
<a href="#l50.27"></a><span id="l50.27">   add_test(test_topicSettable);</span>
<a href="#l50.28"></a><span id="l50.28">   add_test(test_topicSettableJoinAsOp);</span>
<a href="#l50.29"></a><span id="l50.29"> </span>
<a href="#l50.30"></a><span id="l50.30">   run_next_test();</span>
<a href="#l50.31"></a><span id="l50.31"> }</span>
<a href="#l50.32"></a><span id="l50.32"> </span>
<a href="#l50.33"></a><span id="l50.33"> // Test joining a channel, then being set as op.</span>
<a href="#l50.34"></a><span id="l50.34"> function test_topicSettable() {</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineminus">-  let channel = new IRCChannel(new FakeAccount(), &quot;#test&quot;, &quot;nick&quot;);</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+  let channel = new irc.ircChannel(new FakeAccount(), &quot;#test&quot;, &quot;nick&quot;);</span>
<a href="#l50.37"></a><span id="l50.37">   // We're not in the room yet, so the topic is NOT editable.</span>
<a href="#l50.38"></a><span id="l50.38">   equal(channel.topicSettable, false);</span>
<a href="#l50.39"></a><span id="l50.39"> </span>
<a href="#l50.40"></a><span id="l50.40">   // Join the room.</span>
<a href="#l50.41"></a><span id="l50.41">   channel.getParticipant(&quot;nick&quot;);</span>
<a href="#l50.42"></a><span id="l50.42">   // The topic should be editable.</span>
<a href="#l50.43"></a><span id="l50.43">   equal(channel.topicSettable, true);</span>
<a href="#l50.44"></a><span id="l50.44"> </span>
<a href="#l50.45"></a><span id="l50.45" class="difflineat">@@ -44,17 +43,17 @@ function test_topicSettable() {</span>
<a href="#l50.46"></a><span id="l50.46">   // Nick is now an op and can set the topic!</span>
<a href="#l50.47"></a><span id="l50.47">   equal(channel.topicSettable, true);</span>
<a href="#l50.48"></a><span id="l50.48"> </span>
<a href="#l50.49"></a><span id="l50.49">   run_next_test();</span>
<a href="#l50.50"></a><span id="l50.50"> }</span>
<a href="#l50.51"></a><span id="l50.51"> </span>
<a href="#l50.52"></a><span id="l50.52"> // Test when you join as an op (as opposed to being set to op after joining).</span>
<a href="#l50.53"></a><span id="l50.53"> function test_topicSettableJoinAsOp() {</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-  let channel = new IRCChannel(new FakeAccount(), &quot;#test&quot;, &quot;nick&quot;);</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+  let channel = new irc.ircChannel(new FakeAccount(), &quot;#test&quot;, &quot;nick&quot;);</span>
<a href="#l50.56"></a><span id="l50.56">   // We're not in the room yet, so the topic is NOT editable.</span>
<a href="#l50.57"></a><span id="l50.57">   equal(channel.topicSettable, false);</span>
<a href="#l50.58"></a><span id="l50.58"> </span>
<a href="#l50.59"></a><span id="l50.59">   // Join the room as an op.</span>
<a href="#l50.60"></a><span id="l50.60">   channel.getParticipant(&quot;@nick&quot;);</span>
<a href="#l50.61"></a><span id="l50.61">   // The topic should be editable.</span>
<a href="#l50.62"></a><span id="l50.62">   equal(channel.topicSettable, true);</span>
<a href="#l50.63"></a><span id="l50.63"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_splitLongMessages.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -1,41 +1,40 @@</span>
<a href="#l51.4"></a><span id="l51.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l51.5"></a><span id="l51.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l51.6"></a><span id="l51.6"> </span>
<a href="#l51.7"></a><span id="l51.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l51.8"></a><span id="l51.8" class="difflineminus">-var { IRCAccount, GenericIRCConversation } = ChromeUtils.import(</span>
<a href="#l51.9"></a><span id="l51.9" class="difflineminus">-  &quot;resource:///modules/IRC.jsm&quot;</span>
<a href="#l51.10"></a><span id="l51.10" class="difflineminus">-);</span>
<a href="#l51.11"></a><span id="l51.11" class="difflineplus">+var irc = {};</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l51.13"></a><span id="l51.13"> </span>
<a href="#l51.14"></a><span id="l51.14"> var messages = {</span>
<a href="#l51.15"></a><span id="l51.15">   // Exactly 51 characters.</span>
<a href="#l51.16"></a><span id="l51.16">   &quot;This is a test.&quot;: [&quot;This is a test.&quot;],</span>
<a href="#l51.17"></a><span id="l51.17">   // Too long.</span>
<a href="#l51.18"></a><span id="l51.18">   &quot;This is a message that is too long.&quot;: [</span>
<a href="#l51.19"></a><span id="l51.19">     &quot;This is a&quot;,</span>
<a href="#l51.20"></a><span id="l51.20">     &quot;message that is&quot;,</span>
<a href="#l51.21"></a><span id="l51.21">     &quot;too long.&quot;,</span>
<a href="#l51.22"></a><span id="l51.22">   ],</span>
<a href="#l51.23"></a><span id="l51.23">   // Too short.</span>
<a href="#l51.24"></a><span id="l51.24">   &quot;Short msg.&quot;: [&quot;Short msg.&quot;],</span>
<a href="#l51.25"></a><span id="l51.25">   &quot;Thismessagecan'tbecut.&quot;: [&quot;Thismessagecan'&quot;, &quot;tbecut.&quot;],</span>
<a href="#l51.26"></a><span id="l51.26"> };</span>
<a href="#l51.27"></a><span id="l51.27"> </span>
<a href="#l51.28"></a><span id="l51.28" class="difflineminus">-GenericIRCConversation.name = &quot;target&quot;;</span>
<a href="#l51.29"></a><span id="l51.29" class="difflineminus">-GenericIRCConversation._account = {</span>
<a href="#l51.30"></a><span id="l51.30" class="difflineminus">-  __proto__: IRCAccount.prototype,</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineplus">+irc.GenericIRCConversation.name = &quot;target&quot;;</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineplus">+irc.GenericIRCConversation._account = {</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineplus">+  __proto__: irc.ircAccount.prototype,</span>
<a href="#l51.34"></a><span id="l51.34">   _nickname: &quot;sender&quot;,</span>
<a href="#l51.35"></a><span id="l51.35">   prefix: &quot;!user@host&quot;,</span>
<a href="#l51.36"></a><span id="l51.36">   maxMessageLength: 51, // For convenience.</span>
<a href="#l51.37"></a><span id="l51.37"> };</span>
<a href="#l51.38"></a><span id="l51.38"> </span>
<a href="#l51.39"></a><span id="l51.39"> function run_test() {</span>
<a href="#l51.40"></a><span id="l51.40">   for (let message in messages) {</span>
<a href="#l51.41"></a><span id="l51.41">     let msg = { message };</span>
<a href="#l51.42"></a><span id="l51.42" class="difflineminus">-    let generatedMsgs = GenericIRCConversation.prepareForSending(msg);</span>
<a href="#l51.43"></a><span id="l51.43" class="difflineplus">+    let generatedMsgs = irc.GenericIRCConversation.prepareForSending(msg);</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45">     // The expected messages as defined above.</span>
<a href="#l51.46"></a><span id="l51.46">     let expectedMsgs = messages[message];</span>
<a href="#l51.47"></a><span id="l51.47">     // Ensure the arrays are equal.</span>
<a href="#l51.48"></a><span id="l51.48">     deepEqual(generatedMsgs, expectedMsgs);</span>
<a href="#l51.49"></a><span id="l51.49">   }</span>
<a href="#l51.50"></a><span id="l51.50"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/chat/protocols/irc/test/test_tryNewNick.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l52.4"></a><span id="l52.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l52.5"></a><span id="l52.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.8"></a><span id="l52.8" class="difflineminus">-var { IRCAccount } = ChromeUtils.import(&quot;resource:///modules/IRC.jsm&quot;);</span>
<a href="#l52.9"></a><span id="l52.9" class="difflineplus">+var irc = {};</span>
<a href="#l52.10"></a><span id="l52.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/irc.js&quot;, irc);</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12"> var fakeProto = {</span>
<a href="#l52.13"></a><span id="l52.13">   id: &quot;fake-proto&quot;,</span>
<a href="#l52.14"></a><span id="l52.14">   options: { alternateNicks: &quot;&quot; },</span>
<a href="#l52.15"></a><span id="l52.15">   _getOptionDefault(aOption) {</span>
<a href="#l52.16"></a><span id="l52.16">     return this.options[aOption];</span>
<a href="#l52.17"></a><span id="l52.17">   },</span>
<a href="#l52.18"></a><span id="l52.18"> };</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineat">@@ -25,17 +26,17 @@ function test_tryNewNick() {</span>
<a href="#l52.20"></a><span id="l52.20">     clo1kep: &quot;clo1kep1&quot;,</span>
<a href="#l52.21"></a><span id="l52.21">     clo1kep1: &quot;clo1kep2&quot;,</span>
<a href="#l52.22"></a><span id="l52.22">     clo1kep10: &quot;clo1kep11&quot;,</span>
<a href="#l52.23"></a><span id="l52.23">     clo1kep0: &quot;clo1kep1&quot;,</span>
<a href="#l52.24"></a><span id="l52.24">     clo1kep01: &quot;clo1kep02&quot;,</span>
<a href="#l52.25"></a><span id="l52.25">     clo1kep09: &quot;clo1kep10&quot;,</span>
<a href="#l52.26"></a><span id="l52.26">   };</span>
<a href="#l52.27"></a><span id="l52.27"> </span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-  let account = new IRCAccount(fakeProto, {</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l52.30"></a><span id="l52.30">     name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l52.31"></a><span id="l52.31">   });</span>
<a href="#l52.32"></a><span id="l52.32">   account.LOG = function(aStr) {};</span>
<a href="#l52.33"></a><span id="l52.33">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35">   for (let currentNick in testData) {</span>
<a href="#l52.36"></a><span id="l52.36">     account._sentNickname = currentNick;</span>
<a href="#l52.37"></a><span id="l52.37">     account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l52.38"></a><span id="l52.38" class="difflineat">@@ -68,17 +69,17 @@ function test_maxLength() {</span>
<a href="#l52.39"></a><span id="l52.39">     [&quot;abcdefgh1&quot;, &quot;abcdefg10&quot;],</span>
<a href="#l52.40"></a><span id="l52.40">     [&quot;abcdefg10&quot;, &quot;abcdefg11&quot;],</span>
<a href="#l52.41"></a><span id="l52.41">     [&quot;abcdefg99&quot;, &quot;abcdefg100&quot;],</span>
<a href="#l52.42"></a><span id="l52.42">     [&quot;abcdefg10&quot;, &quot;abcdef100&quot;],</span>
<a href="#l52.43"></a><span id="l52.43">     [&quot;a99999999&quot;, &quot;a100000000&quot;],</span>
<a href="#l52.44"></a><span id="l52.44">     [&quot;a10000000&quot;, &quot;a00000000&quot;],</span>
<a href="#l52.45"></a><span id="l52.45">   ];</span>
<a href="#l52.46"></a><span id="l52.46"> </span>
<a href="#l52.47"></a><span id="l52.47" class="difflineminus">-  let account = new IRCAccount(fakeProto, {</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l52.49"></a><span id="l52.49">     name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l52.50"></a><span id="l52.50">   });</span>
<a href="#l52.51"></a><span id="l52.51">   account.LOG = function(aStr) {};</span>
<a href="#l52.52"></a><span id="l52.52">   account._sentNickname = &quot;abcdefghi&quot;;</span>
<a href="#l52.53"></a><span id="l52.53">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l52.54"></a><span id="l52.54"> </span>
<a href="#l52.55"></a><span id="l52.55">   for (let currentNick of testData) {</span>
<a href="#l52.56"></a><span id="l52.56">     account.sendMessage = (aCommand, aNewNick) =&gt;</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineat">@@ -101,17 +102,17 @@ function test_altNicks() {</span>
<a href="#l52.58"></a><span id="l52.58">     &quot;clokep|&quot;: [altNicks, &quot;clokep|1&quot;],</span>
<a href="#l52.59"></a><span id="l52.59">     // Test element not in list with number at end.</span>
<a href="#l52.60"></a><span id="l52.60">     clokep1: [altNicks, &quot;clokep2&quot;],</span>
<a href="#l52.61"></a><span id="l52.61"> </span>
<a href="#l52.62"></a><span id="l52.62">     // Test messy alternatives.</span>
<a href="#l52.63"></a><span id="l52.63">     &quot;clokep[&quot;: [&quot; clokep ,\n clokep111,,,\tclokep[, clokep_&quot;, &quot;clokep_&quot;],</span>
<a href="#l52.64"></a><span id="l52.64">   };</span>
<a href="#l52.65"></a><span id="l52.65"> </span>
<a href="#l52.66"></a><span id="l52.66" class="difflineminus">-  let account = new IRCAccount(fakeProto, {</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineplus">+  let account = new irc.ircAccount(fakeProto, {</span>
<a href="#l52.68"></a><span id="l52.68">     name: &quot;clokep@instantbird.org&quot;,</span>
<a href="#l52.69"></a><span id="l52.69">   });</span>
<a href="#l52.70"></a><span id="l52.70">   account.LOG = function(aStr) {};</span>
<a href="#l52.71"></a><span id="l52.71">   account.normalize = aStr =&gt; aStr;</span>
<a href="#l52.72"></a><span id="l52.72"> </span>
<a href="#l52.73"></a><span id="l52.73">   for (let currentNick in testData) {</span>
<a href="#l52.74"></a><span id="l52.74">     // Only one pref is touched in here, override the default to return</span>
<a href="#l52.75"></a><span id="l52.75">     // what this test needs.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">deleted file mode 100644</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineminus">--- a/chat/protocols/jsTest/JSTestProtocol.jsm</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineplus">+++ /dev/null</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineat">@@ -1,141 +0,0 @@</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.6"></a><span id="l53.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.7"></a><span id="l53.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.8"></a><span id="l53.8" class="difflineminus">-</span>
<a href="#l53.9"></a><span id="l53.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;JSTestProtocol&quot;];</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineminus">-</span>
<a href="#l53.11"></a><span id="l53.11" class="difflineminus">-var { setTimeout } = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-var {</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineminus">-</span>
<a href="#l53.18"></a><span id="l53.18" class="difflineminus">-function Conversation(aAccount) {</span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-  this._init(aAccount);</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-}</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineminus">-Conversation.prototype = {</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineminus">-  __proto__: GenericConvIMPrototype,</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineminus">-  _disconnected: false,</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineminus">-  _setDisconnected() {</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineminus">-    this._disconnected = true;</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineminus">-  },</span>
<a href="#l53.27"></a><span id="l53.27" class="difflineminus">-  close() {</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineminus">-    if (!this._disconnected) {</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineminus">-      this.account.disconnect(true);</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-    }</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-  },</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-    if (this._disconnected) {</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-      this.writeMessage(</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-        &quot;jstest&quot;,</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineminus">-        &quot;This message could not be sent because the conversation is no longer active: &quot; +</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-          aMsg,</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineminus">-        { system: true, error: true }</span>
<a href="#l53.39"></a><span id="l53.39" class="difflineminus">-      );</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineminus">-      return;</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-    }</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineminus">-</span>
<a href="#l53.43"></a><span id="l53.43" class="difflineminus">-    this.writeMessage(&quot;You&quot;, aMsg, { outgoing: true });</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-    this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;, {</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineminus">-      incoming: true,</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineminus">-      autoResponse: true,</span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-    });</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineminus">-  },</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineminus">-</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-  get name() {</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineminus">-    return &quot;/dev/null&quot;;</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineminus">-  },</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineminus">-};</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineminus">-</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineminus">-function Account(aProtoInstance, aImAccount) {</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-}</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineminus">-Account.prototype = {</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-  connect() {</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineminus">-    this.reportConnecting();</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineminus">-    // do something here</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineminus">-    this.reportConnected();</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineminus">-    setTimeout(</span>
<a href="#l53.65"></a><span id="l53.65" class="difflineminus">-      function() {</span>
<a href="#l53.66"></a><span id="l53.66" class="difflineminus">-        this._conv = new Conversation(this);</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-        this._conv.writeMessage(&quot;jstest&quot;, &quot;You are now talking to /dev/null&quot;, {</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineminus">-          system: true,</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-        });</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineminus">-      }.bind(this),</span>
<a href="#l53.71"></a><span id="l53.71" class="difflineminus">-      0</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineminus">-    );</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-  },</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineminus">-  _conv: null,</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-  disconnect(aSilent) {</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineminus">-    this.reportDisconnecting(Ci.prplIAccount.NO_ERROR, &quot;&quot;);</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineminus">-    if (!aSilent) {</span>
<a href="#l53.78"></a><span id="l53.78" class="difflineminus">-      this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineminus">-        system: true,</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineminus">-      });</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineminus">-    }</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineminus">-    if (this._conv) {</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineminus">-      this._conv._setDisconnected();</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineminus">-      delete this._conv;</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineminus">-    }</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineminus">-  },</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineminus">-    return true;</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-  },</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-  chatRoomFields: {</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-    channel: { label: &quot;_Channel Field&quot;, required: true },</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineminus">-    channelDefault: { label: &quot;_Field with default&quot;, default: &quot;Default Value&quot; },</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-    password: {</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-      label: &quot;_Password Field&quot;,</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineminus">-      isPassword: true,</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineminus">-      required: false,</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineminus">-    },</span>
<a href="#l53.101"></a><span id="l53.101" class="difflineminus">-    sampleIntField: {</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineminus">-      label: &quot;_Int Field&quot;,</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-      default: 4,</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineminus">-      min: 0,</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineminus">-      max: 10,</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineminus">-      required: true,</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineminus">-    },</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-  },</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineminus">-</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineminus">-  // Nothing to do.</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineminus">-  unInit() {},</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineminus">-};</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineminus">-</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineminus">-function JSTestProtocol() {}</span>
<a href="#l53.115"></a><span id="l53.115" class="difflineminus">-JSTestProtocol.prototype = {</span>
<a href="#l53.116"></a><span id="l53.116" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l53.117"></a><span id="l53.117" class="difflineminus">-  get name() {</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineminus">-    return &quot;JS Test&quot;;</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-  },</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineminus">-  options: {</span>
<a href="#l53.121"></a><span id="l53.121" class="difflineminus">-    text: { label: &quot;Text option&quot;, default: &quot;foo&quot; },</span>
<a href="#l53.122"></a><span id="l53.122" class="difflineminus">-    bool: { label: &quot;Boolean option&quot;, default: true },</span>
<a href="#l53.123"></a><span id="l53.123" class="difflineminus">-    int: { label: &quot;Integer option&quot;, default: 42 },</span>
<a href="#l53.124"></a><span id="l53.124" class="difflineminus">-    list: {</span>
<a href="#l53.125"></a><span id="l53.125" class="difflineminus">-      label: &quot;Select option&quot;,</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineminus">-      default: &quot;option2&quot;,</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineminus">-      listValues: {</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineminus">-        option1: &quot;First option&quot;,</span>
<a href="#l53.129"></a><span id="l53.129" class="difflineminus">-        option2: &quot;Default option&quot;,</span>
<a href="#l53.130"></a><span id="l53.130" class="difflineminus">-        option3: &quot;Other option&quot;,</span>
<a href="#l53.131"></a><span id="l53.131" class="difflineminus">-      },</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineminus">-    },</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineminus">-  },</span>
<a href="#l53.134"></a><span id="l53.134" class="difflineminus">-  usernameSplits: [</span>
<a href="#l53.135"></a><span id="l53.135" class="difflineminus">-    {</span>
<a href="#l53.136"></a><span id="l53.136" class="difflineminus">-      label: &quot;Server&quot;,</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineminus">-      separator: &quot;@&quot;,</span>
<a href="#l53.138"></a><span id="l53.138" class="difflineminus">-      defaultValue: &quot;default.server&quot;,</span>
<a href="#l53.139"></a><span id="l53.139" class="difflineminus">-      reverse: true,</span>
<a href="#l53.140"></a><span id="l53.140" class="difflineminus">-    },</span>
<a href="#l53.141"></a><span id="l53.141" class="difflineminus">-  ],</span>
<a href="#l53.142"></a><span id="l53.142" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l53.143"></a><span id="l53.143" class="difflineminus">-    return new Account(this, aImAccount);</span>
<a href="#l53.144"></a><span id="l53.144" class="difflineminus">-  },</span>
<a href="#l53.145"></a><span id="l53.145" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">deleted file mode 100644</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineminus">--- a/chat/protocols/jsTest/components.conf</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineplus">+++ /dev/null</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l54.6"></a><span id="l54.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l54.7"></a><span id="l54.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.8"></a><span id="l54.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.9"></a><span id="l54.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l54.10"></a><span id="l54.10" class="difflineminus">-</span>
<a href="#l54.11"></a><span id="l54.11" class="difflineminus">-Classes = [</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-  {</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-    'cid': '{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}',</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/jstest;1'],</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-    'jsm': 'resource:///modules/JSTestProtocol.jsm',</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-    'constructor': 'JSTestProtocol',</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-jstest'},</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">-  },</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">new file mode 100644</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineminus">--- /dev/null</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.js</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineat">@@ -0,0 +1,144 @@</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.6"></a><span id="l55.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.7"></a><span id="l55.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.8"></a><span id="l55.8" class="difflineplus">+</span>
<a href="#l55.9"></a><span id="l55.9" class="difflineplus">+var { XPCOMUtils, setTimeout } = ChromeUtils.import(</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+);</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+var {</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+  GenericConvIMPrototype,</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+  GenericProtocolPrototype,</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+function Conversation(aAccount) {</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+  this._init(aAccount);</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineplus">+}</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+Conversation.prototype = {</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineplus">+  _disconnected: false,</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineplus">+  _setDisconnected() {</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+    this._disconnected = true;</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+  },</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+  close() {</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+    if (!this._disconnected) {</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineplus">+      this.account.disconnect(true);</span>
<a href="#l55.30"></a><span id="l55.30" class="difflineplus">+    }</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineplus">+  },</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineplus">+    if (this._disconnected) {</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineplus">+      this.writeMessage(</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+        &quot;jstest&quot;,</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+        &quot;This message could not be sent because the conversation is no longer active: &quot; +</span>
<a href="#l55.37"></a><span id="l55.37" class="difflineplus">+          aMsg,</span>
<a href="#l55.38"></a><span id="l55.38" class="difflineplus">+        { system: true, error: true }</span>
<a href="#l55.39"></a><span id="l55.39" class="difflineplus">+      );</span>
<a href="#l55.40"></a><span id="l55.40" class="difflineplus">+      return;</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineplus">+    }</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+</span>
<a href="#l55.43"></a><span id="l55.43" class="difflineplus">+    this.writeMessage(&quot;You&quot;, aMsg, { outgoing: true });</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineplus">+    this.writeMessage(&quot;/dev/null&quot;, &quot;Thanks! I appreciate your attention.&quot;, {</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+      incoming: true,</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+      autoResponse: true,</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+    });</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+  },</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+  get name() {</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+    return &quot;/dev/null&quot;;</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineplus">+  },</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+};</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+function Account(aProtoInstance, aImAccount) {</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l55.57"></a><span id="l55.57" class="difflineplus">+}</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineplus">+Account.prototype = {</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineplus">+  connect() {</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l55.62"></a><span id="l55.62" class="difflineplus">+    // do something here</span>
<a href="#l55.63"></a><span id="l55.63" class="difflineplus">+    this.reportConnected();</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineplus">+    setTimeout(</span>
<a href="#l55.65"></a><span id="l55.65" class="difflineplus">+      function() {</span>
<a href="#l55.66"></a><span id="l55.66" class="difflineplus">+        this._conv = new Conversation(this);</span>
<a href="#l55.67"></a><span id="l55.67" class="difflineplus">+        this._conv.writeMessage(&quot;jstest&quot;, &quot;You are now talking to /dev/null&quot;, {</span>
<a href="#l55.68"></a><span id="l55.68" class="difflineplus">+          system: true,</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineplus">+        });</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+      }.bind(this),</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineplus">+      0</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+    );</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+  },</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+  _conv: null,</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+  disconnect(aSilent) {</span>
<a href="#l55.76"></a><span id="l55.76" class="difflineplus">+    this.reportDisconnecting(Ci.prplIAccount.NO_ERROR, &quot;&quot;);</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineplus">+    if (!aSilent) {</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineplus">+      this._conv.writeMessage(&quot;jstest&quot;, &quot;You have disconnected.&quot;, {</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineplus">+        system: true,</span>
<a href="#l55.80"></a><span id="l55.80" class="difflineplus">+      });</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineplus">+    }</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineplus">+    if (this._conv) {</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineplus">+      this._conv._setDisconnected();</span>
<a href="#l55.84"></a><span id="l55.84" class="difflineplus">+      delete this._conv;</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+    }</span>
<a href="#l55.86"></a><span id="l55.86" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineplus">+  },</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+</span>
<a href="#l55.89"></a><span id="l55.89" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l55.90"></a><span id="l55.90" class="difflineplus">+    return true;</span>
<a href="#l55.91"></a><span id="l55.91" class="difflineplus">+  },</span>
<a href="#l55.92"></a><span id="l55.92" class="difflineplus">+  chatRoomFields: {</span>
<a href="#l55.93"></a><span id="l55.93" class="difflineplus">+    channel: { label: &quot;_Channel Field&quot;, required: true },</span>
<a href="#l55.94"></a><span id="l55.94" class="difflineplus">+    channelDefault: { label: &quot;_Field with default&quot;, default: &quot;Default Value&quot; },</span>
<a href="#l55.95"></a><span id="l55.95" class="difflineplus">+    password: {</span>
<a href="#l55.96"></a><span id="l55.96" class="difflineplus">+      label: &quot;_Password Field&quot;,</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l55.98"></a><span id="l55.98" class="difflineplus">+      isPassword: true,</span>
<a href="#l55.99"></a><span id="l55.99" class="difflineplus">+      required: false,</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineplus">+    },</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+    sampleIntField: {</span>
<a href="#l55.102"></a><span id="l55.102" class="difflineplus">+      label: &quot;_Int Field&quot;,</span>
<a href="#l55.103"></a><span id="l55.103" class="difflineplus">+      default: 4,</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineplus">+      min: 0,</span>
<a href="#l55.105"></a><span id="l55.105" class="difflineplus">+      max: 10,</span>
<a href="#l55.106"></a><span id="l55.106" class="difflineplus">+      required: true,</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineplus">+    },</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+  },</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+  // Nothing to do.</span>
<a href="#l55.111"></a><span id="l55.111" class="difflineplus">+  unInit() {},</span>
<a href="#l55.112"></a><span id="l55.112" class="difflineplus">+};</span>
<a href="#l55.113"></a><span id="l55.113" class="difflineplus">+</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineplus">+function jsTestProtocol() {}</span>
<a href="#l55.115"></a><span id="l55.115" class="difflineplus">+jsTestProtocol.prototype = {</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l55.117"></a><span id="l55.117" class="difflineplus">+  get name() {</span>
<a href="#l55.118"></a><span id="l55.118" class="difflineplus">+    return &quot;JS Test&quot;;</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineplus">+  },</span>
<a href="#l55.120"></a><span id="l55.120" class="difflineplus">+  options: {</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineplus">+    text: { label: &quot;Text option&quot;, default: &quot;foo&quot; },</span>
<a href="#l55.122"></a><span id="l55.122" class="difflineplus">+    bool: { label: &quot;Boolean option&quot;, default: true },</span>
<a href="#l55.123"></a><span id="l55.123" class="difflineplus">+    int: { label: &quot;Integer option&quot;, default: 42 },</span>
<a href="#l55.124"></a><span id="l55.124" class="difflineplus">+    list: {</span>
<a href="#l55.125"></a><span id="l55.125" class="difflineplus">+      label: &quot;Select option&quot;,</span>
<a href="#l55.126"></a><span id="l55.126" class="difflineplus">+      default: &quot;option2&quot;,</span>
<a href="#l55.127"></a><span id="l55.127" class="difflineplus">+      listValues: {</span>
<a href="#l55.128"></a><span id="l55.128" class="difflineplus">+        option1: &quot;First option&quot;,</span>
<a href="#l55.129"></a><span id="l55.129" class="difflineplus">+        option2: &quot;Default option&quot;,</span>
<a href="#l55.130"></a><span id="l55.130" class="difflineplus">+        option3: &quot;Other option&quot;,</span>
<a href="#l55.131"></a><span id="l55.131" class="difflineplus">+      },</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineplus">+    },</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineplus">+  },</span>
<a href="#l55.134"></a><span id="l55.134" class="difflineplus">+  usernameSplits: [</span>
<a href="#l55.135"></a><span id="l55.135" class="difflineplus">+    {</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineplus">+      label: &quot;Server&quot;,</span>
<a href="#l55.137"></a><span id="l55.137" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l55.138"></a><span id="l55.138" class="difflineplus">+      defaultValue: &quot;default.server&quot;,</span>
<a href="#l55.139"></a><span id="l55.139" class="difflineplus">+      reverse: true,</span>
<a href="#l55.140"></a><span id="l55.140" class="difflineplus">+    },</span>
<a href="#l55.141"></a><span id="l55.141" class="difflineplus">+  ],</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l55.143"></a><span id="l55.143" class="difflineplus">+    return new Account(this, aImAccount);</span>
<a href="#l55.144"></a><span id="l55.144" class="difflineplus">+  },</span>
<a href="#l55.145"></a><span id="l55.145" class="difflineplus">+  classID: Components.ID(&quot;{a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}&quot;),</span>
<a href="#l55.146"></a><span id="l55.146" class="difflineplus">+};</span>
<a href="#l55.147"></a><span id="l55.147" class="difflineplus">+</span>
<a href="#l55.148"></a><span id="l55.148" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([jsTestProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">new file mode 100644</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineminus">--- /dev/null</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineplus">+++ b/chat/protocols/jsTest/jsTestProtocol.manifest</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineplus">+component {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630} jsTestProtocol.js</span>
<a href="#l56.6"></a><span id="l56.6" class="difflineplus">+contract @mozilla.org/chat/jstest;1 {a0774c5a-4aea-458b-9fbc-8d3cbf1a4630}</span>
<a href="#l56.7"></a><span id="l56.7" class="difflineplus">+category im-protocol-plugin prpl-jstest @mozilla.org/chat/jstest;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/chat/protocols/jsTest/moz.build</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/chat/protocols/jsTest/moz.build</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -1,14 +1,11 @@</span>
<a href="#l57.4"></a><span id="l57.4"> # vim: set filetype=python:</span>
<a href="#l57.5"></a><span id="l57.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l57.6"></a><span id="l57.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l57.7"></a><span id="l57.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l57.8"></a><span id="l57.8"> </span>
<a href="#l57.9"></a><span id="l57.9"> if CONFIG['MOZ_DEBUG']:</span>
<a href="#l57.10"></a><span id="l57.10" class="difflineminus">-    EXTRA_JS_MODULES += [</span>
<a href="#l57.11"></a><span id="l57.11" class="difflineminus">-        'JSTestProtocol.jsm',</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+    EXTRA_COMPONENTS += [</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+        'jsTestProtocol.js',</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+        'jsTestProtocol.manifest',</span>
<a href="#l57.15"></a><span id="l57.15">     ]</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17" class="difflineminus">-    XPCOM_MANIFESTS += [</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineminus">-        'components.conf',</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineminus">-    ]</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1">deleted file mode 100644</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineminus">--- a/chat/protocols/matrix/Matrix.jsm</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineplus">+++ /dev/null</span>
<a href="#l58.4"></a><span id="l58.4" class="difflineat">@@ -1,310 +0,0 @@</span>
<a href="#l58.5"></a><span id="l58.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.6"></a><span id="l58.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.7"></a><span id="l58.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.8"></a><span id="l58.8" class="difflineminus">-</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;MatrixProtocol&quot;];</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineminus">-</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineminus">-var { XPCOMUtils, nsSimpleEnumerator, l10nHelper } = ChromeUtils.import(</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-);</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-var {</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineminus">-  GenericConvChatPrototype,</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineminus">-  GenericConvChatBuddyPrototype,</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/matrix.properties&quot;)</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineminus">-);</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineminus">-ChromeUtils.defineModuleGetter(</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineminus">-  this,</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineminus">-  &quot;MatrixSDK&quot;,</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineminus">-  &quot;resource:///modules/matrix-sdk.jsm&quot;</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-);</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineminus">-</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-function MatrixParticipant(aRoomMember) {</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineminus">-  // FIXME: Should probably use aRoomMember.name, but it's not unique id?</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-  this._name = aRoomMember.userId;</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-  this._roomMember = aRoomMember;</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-}</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineminus">-MatrixParticipant.prototype = {</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-  get alias() {</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineminus">-    return this._roomMember.name;</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-  },</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineminus">-};</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineminus">-</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-/*</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineminus">- * TODO Other functionality from MatrixClient to implement:</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">- *  sendNotice</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineminus">- *  sendReadReceipt</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineminus">- *  sendTyping</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineminus">- *  setPowerLevel</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineminus">- *  setRoomTopic</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineminus">- */</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineminus">-function MatrixConversation(aAccount, aName, aNick) {</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineminus">-  this._init(aAccount, aName, aNick);</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineminus">-}</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineminus">-MatrixConversation.prototype = {</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-  __proto__: GenericConvChatPrototype,</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-    this._account._client.sendTextMessage(this._roomId, aMsg);</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-  },</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineminus">-  get room() {</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-    return this._account._client.getRoom(this._roomId);</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-  },</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-  addParticipant(aRoomMember) {</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-    if (this._participants.has(aRoomMember.userId)) {</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineminus">-      return;</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineminus">-    }</span>
<a href="#l58.66"></a><span id="l58.66" class="difflineminus">-</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineminus">-    let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineminus">-    this._participants.set(aRoomMember.userId, participant);</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineminus">-    this.notifyObservers(</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-      new nsSimpleEnumerator([participant]),</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineminus">-      &quot;chat-buddy-add&quot;</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineminus">-    );</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineminus">-  },</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineminus">-  initListOfParticipants() {</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineminus">-    let conv = this;</span>
<a href="#l58.76"></a><span id="l58.76" class="difflineminus">-    let participants = [];</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-    this.room.getJoinedMembers().forEach(function(aRoomMember) {</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-      if (!conv._participants.has(aRoomMember.userId)) {</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineminus">-        let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineminus">-        participants.push(participant);</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineminus">-        conv._participants.set(aRoomMember.userId, participant);</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineminus">-      }</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-    });</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineminus">-    if (participants.length) {</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineminus">-      this.notifyObservers(</span>
<a href="#l58.86"></a><span id="l58.86" class="difflineminus">-        new nsSimpleEnumerator(participants),</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineminus">-        &quot;chat-buddy-add&quot;</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineminus">-      );</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineminus">-    }</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineminus">-  },</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-};</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">-/*</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">- * TODO Other random functionality from MatrixClient that will be useful:</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">- *  getRooms / getUsers / publicRooms</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">- *  invite</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineminus">- *  ban / kick</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineminus">- *  leave</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">- *  redactEvent</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">- *  scrollback</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">- *  setAvatarUrl</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineminus">- *  setDisplayName</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineminus">- *  setPassword</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineminus">- *  setPresence</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineminus">- */</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineminus">-function MatrixAccount(aProtocol, aImAccount) {</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineminus">-  this._init(aProtocol, aImAccount);</span>
<a href="#l58.108"></a><span id="l58.108" class="difflineminus">-}</span>
<a href="#l58.109"></a><span id="l58.109" class="difflineminus">-MatrixAccount.prototype = {</span>
<a href="#l58.110"></a><span id="l58.110" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineminus">-  observe(aSubject, aTopic, aData) {},</span>
<a href="#l58.112"></a><span id="l58.112" class="difflineminus">-  remove() {},</span>
<a href="#l58.113"></a><span id="l58.113" class="difflineminus">-  unInit() {},</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineminus">-  connect() {</span>
<a href="#l58.115"></a><span id="l58.115" class="difflineminus">-    this.reportConnecting();</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineminus">-    let baseURL = this.getString(&quot;server&quot;) + &quot;:&quot; + this.getInt(&quot;port&quot;);</span>
<a href="#l58.117"></a><span id="l58.117" class="difflineminus">-</span>
<a href="#l58.118"></a><span id="l58.118" class="difflineminus">-    this._client = MatrixSDK.createClient(baseURL);</span>
<a href="#l58.119"></a><span id="l58.119" class="difflineminus">-</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-    // Send the login request to the server.</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineminus">-    // See https://matrix-org.github.io/matrix-js-sdk/2.4.1/module-client-MatrixClient.html#loginWithPassword</span>
<a href="#l58.122"></a><span id="l58.122" class="difflineminus">-    this._client</span>
<a href="#l58.123"></a><span id="l58.123" class="difflineminus">-      .loginWithPassword(this.name, this.imAccount.password)</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineminus">-      .then(data =&gt; {</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineminus">-        // TODO: Check data.errcode to pass more accurate value as the first</span>
<a href="#l58.126"></a><span id="l58.126" class="difflineminus">-        // parameter of reportDisconnecting.</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineminus">-        if (data.error) {</span>
<a href="#l58.128"></a><span id="l58.128" class="difflineminus">-          throw new Error(data.error);</span>
<a href="#l58.129"></a><span id="l58.129" class="difflineminus">-        }</span>
<a href="#l58.130"></a><span id="l58.130" class="difflineminus">-        this.startClient();</span>
<a href="#l58.131"></a><span id="l58.131" class="difflineminus">-      })</span>
<a href="#l58.132"></a><span id="l58.132" class="difflineminus">-      .catch(error =&gt; {</span>
<a href="#l58.133"></a><span id="l58.133" class="difflineminus">-        this.reportDisconnecting(</span>
<a href="#l58.134"></a><span id="l58.134" class="difflineminus">-          Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l58.135"></a><span id="l58.135" class="difflineminus">-          error.message</span>
<a href="#l58.136"></a><span id="l58.136" class="difflineminus">-        );</span>
<a href="#l58.137"></a><span id="l58.137" class="difflineminus">-        this._client = null;</span>
<a href="#l58.138"></a><span id="l58.138" class="difflineminus">-        this.reportDisconnected();</span>
<a href="#l58.139"></a><span id="l58.139" class="difflineminus">-      });</span>
<a href="#l58.140"></a><span id="l58.140" class="difflineminus">-  },</span>
<a href="#l58.141"></a><span id="l58.141" class="difflineminus">-  /*</span>
<a href="#l58.142"></a><span id="l58.142" class="difflineminus">-   * Hook up the Matrix Client to callbacks to handle various events.</span>
<a href="#l58.143"></a><span id="l58.143" class="difflineminus">-   *</span>
<a href="#l58.144"></a><span id="l58.144" class="difflineminus">-   * The possible events are documented starting at:</span>
<a href="#l58.145"></a><span id="l58.145" class="difflineminus">-   * https://matrix-org.github.io/matrix-js-sdk/2.4.1/module-client.html#~event:MatrixClient%22accountData%22</span>
<a href="#l58.146"></a><span id="l58.146" class="difflineminus">-   */</span>
<a href="#l58.147"></a><span id="l58.147" class="difflineminus">-  startClient() {</span>
<a href="#l58.148"></a><span id="l58.148" class="difflineminus">-    this._client.on(&quot;sync&quot;, (state, prevState, data) =&gt; {</span>
<a href="#l58.149"></a><span id="l58.149" class="difflineminus">-      switch (state) {</span>
<a href="#l58.150"></a><span id="l58.150" class="difflineminus">-        case &quot;PREPARED&quot;:</span>
<a href="#l58.151"></a><span id="l58.151" class="difflineminus">-          this.reportConnected();</span>
<a href="#l58.152"></a><span id="l58.152" class="difflineminus">-          break;</span>
<a href="#l58.153"></a><span id="l58.153" class="difflineminus">-        case &quot;STOPPED&quot;:</span>
<a href="#l58.154"></a><span id="l58.154" class="difflineminus">-          // XXX Report disconnecting here?</span>
<a href="#l58.155"></a><span id="l58.155" class="difflineminus">-          this._client.logout().then(() =&gt; {</span>
<a href="#l58.156"></a><span id="l58.156" class="difflineminus">-            this.reportDisconnected();</span>
<a href="#l58.157"></a><span id="l58.157" class="difflineminus">-            this._client = null;</span>
<a href="#l58.158"></a><span id="l58.158" class="difflineminus">-          });</span>
<a href="#l58.159"></a><span id="l58.159" class="difflineminus">-          break;</span>
<a href="#l58.160"></a><span id="l58.160" class="difflineminus">-        // TODO: Handle other states (RECONNECTING, ERROR, SYNCING).</span>
<a href="#l58.161"></a><span id="l58.161" class="difflineminus">-      }</span>
<a href="#l58.162"></a><span id="l58.162" class="difflineminus">-    });</span>
<a href="#l58.163"></a><span id="l58.163" class="difflineminus">-    this._client.on(&quot;RoomMember.membership&quot;, (event, member, oldMembership) =&gt; {</span>
<a href="#l58.164"></a><span id="l58.164" class="difflineminus">-      if (member.roomId in this._roomList) {</span>
<a href="#l58.165"></a><span id="l58.165" class="difflineminus">-        var room = this._roomList[member.roomId];</span>
<a href="#l58.166"></a><span id="l58.166" class="difflineminus">-        if (member.membership === &quot;join&quot;) {</span>
<a href="#l58.167"></a><span id="l58.167" class="difflineminus">-          room.addParticipant(member);</span>
<a href="#l58.168"></a><span id="l58.168" class="difflineminus">-        } else {</span>
<a href="#l58.169"></a><span id="l58.169" class="difflineminus">-          room.removeParticipant(member.userId);</span>
<a href="#l58.170"></a><span id="l58.170" class="difflineminus">-        }</span>
<a href="#l58.171"></a><span id="l58.171" class="difflineminus">-      }</span>
<a href="#l58.172"></a><span id="l58.172" class="difflineminus">-    });</span>
<a href="#l58.173"></a><span id="l58.173" class="difflineminus">-    this._client.on(&quot;Room.timeline&quot;, (event, room, toStartOfTimeline) =&gt; {</span>
<a href="#l58.174"></a><span id="l58.174" class="difflineminus">-      // TODO: Better handle messages!</span>
<a href="#l58.175"></a><span id="l58.175" class="difflineminus">-      if (toStartOfTimeline) {</span>
<a href="#l58.176"></a><span id="l58.176" class="difflineminus">-        return;</span>
<a href="#l58.177"></a><span id="l58.177" class="difflineminus">-      }</span>
<a href="#l58.178"></a><span id="l58.178" class="difflineminus">-      if (room.roomId in this._roomList) {</span>
<a href="#l58.179"></a><span id="l58.179" class="difflineminus">-        let body;</span>
<a href="#l58.180"></a><span id="l58.180" class="difflineminus">-        if (event.getType() === &quot;m.room.message&quot;) {</span>
<a href="#l58.181"></a><span id="l58.181" class="difflineminus">-          body = event.getContent().body;</span>
<a href="#l58.182"></a><span id="l58.182" class="difflineminus">-        } else {</span>
<a href="#l58.183"></a><span id="l58.183" class="difflineminus">-          body = JSON.stringify(event.getContent());</span>
<a href="#l58.184"></a><span id="l58.184" class="difflineminus">-        }</span>
<a href="#l58.185"></a><span id="l58.185" class="difflineminus">-        this._roomList[room.roomId].writeMessage(event.getSender(), body, {</span>
<a href="#l58.186"></a><span id="l58.186" class="difflineminus">-          incoming: true,</span>
<a href="#l58.187"></a><span id="l58.187" class="difflineminus">-        });</span>
<a href="#l58.188"></a><span id="l58.188" class="difflineminus">-      }</span>
<a href="#l58.189"></a><span id="l58.189" class="difflineminus">-    });</span>
<a href="#l58.190"></a><span id="l58.190" class="difflineminus">-</span>
<a href="#l58.191"></a><span id="l58.191" class="difflineminus">-    // TODO Other events to handle:</span>
<a href="#l58.192"></a><span id="l58.192" class="difflineminus">-    //  Room.accountData</span>
<a href="#l58.193"></a><span id="l58.193" class="difflineminus">-    //  Room.localEchoUpdated</span>
<a href="#l58.194"></a><span id="l58.194" class="difflineminus">-    //  Room.name</span>
<a href="#l58.195"></a><span id="l58.195" class="difflineminus">-    //  Room.tags</span>
<a href="#l58.196"></a><span id="l58.196" class="difflineminus">-    //  Room</span>
<a href="#l58.197"></a><span id="l58.197" class="difflineminus">-    //  RoomMember.name</span>
<a href="#l58.198"></a><span id="l58.198" class="difflineminus">-    //  RoomMember.powerLevel</span>
<a href="#l58.199"></a><span id="l58.199" class="difflineminus">-    //  RoomMember.typing</span>
<a href="#l58.200"></a><span id="l58.200" class="difflineminus">-    //  Session.logged_out</span>
<a href="#l58.201"></a><span id="l58.201" class="difflineminus">-    //  User.avatarUrl</span>
<a href="#l58.202"></a><span id="l58.202" class="difflineminus">-    //  User.currentlyActive</span>
<a href="#l58.203"></a><span id="l58.203" class="difflineminus">-    //  User.displayName</span>
<a href="#l58.204"></a><span id="l58.204" class="difflineminus">-    //  User.presence</span>
<a href="#l58.205"></a><span id="l58.205" class="difflineminus">-</span>
<a href="#l58.206"></a><span id="l58.206" class="difflineminus">-    this._client.startClient();</span>
<a href="#l58.207"></a><span id="l58.207" class="difflineminus">-  },</span>
<a href="#l58.208"></a><span id="l58.208" class="difflineminus">-  disconnect() {</span>
<a href="#l58.209"></a><span id="l58.209" class="difflineminus">-    if (this._client) {</span>
<a href="#l58.210"></a><span id="l58.210" class="difflineminus">-      this._client.stopClient();</span>
<a href="#l58.211"></a><span id="l58.211" class="difflineminus">-    }</span>
<a href="#l58.212"></a><span id="l58.212" class="difflineminus">-  },</span>
<a href="#l58.213"></a><span id="l58.213" class="difflineminus">-</span>
<a href="#l58.214"></a><span id="l58.214" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l58.215"></a><span id="l58.215" class="difflineminus">-    return true;</span>
<a href="#l58.216"></a><span id="l58.216" class="difflineminus">-  },</span>
<a href="#l58.217"></a><span id="l58.217" class="difflineminus">-  chatRoomFields: {</span>
<a href="#l58.218"></a><span id="l58.218" class="difflineminus">-    // XXX Does it make sense to split up the server into a separate field?</span>
<a href="#l58.219"></a><span id="l58.219" class="difflineminus">-    roomIdOrAlias: {</span>
<a href="#l58.220"></a><span id="l58.220" class="difflineminus">-      get label() {</span>
<a href="#l58.221"></a><span id="l58.221" class="difflineminus">-        return _(&quot;chatRoomField.room&quot;);</span>
<a href="#l58.222"></a><span id="l58.222" class="difflineminus">-      },</span>
<a href="#l58.223"></a><span id="l58.223" class="difflineminus">-      required: true,</span>
<a href="#l58.224"></a><span id="l58.224" class="difflineminus">-    },</span>
<a href="#l58.225"></a><span id="l58.225" class="difflineminus">-  },</span>
<a href="#l58.226"></a><span id="l58.226" class="difflineminus">-  parseDefaultChatName(aDefaultName) {</span>
<a href="#l58.227"></a><span id="l58.227" class="difflineminus">-    let chatFields = {</span>
<a href="#l58.228"></a><span id="l58.228" class="difflineminus">-      roomIdOrAlias: aDefaultName,</span>
<a href="#l58.229"></a><span id="l58.229" class="difflineminus">-    };</span>
<a href="#l58.230"></a><span id="l58.230" class="difflineminus">-</span>
<a href="#l58.231"></a><span id="l58.231" class="difflineminus">-    return chatFields;</span>
<a href="#l58.232"></a><span id="l58.232" class="difflineminus">-  },</span>
<a href="#l58.233"></a><span id="l58.233" class="difflineminus">-  joinChat(aComponents) {</span>
<a href="#l58.234"></a><span id="l58.234" class="difflineminus">-    let roomIdOrAlias = aComponents.getValue(&quot;roomIdOrAlias&quot;).trim();</span>
<a href="#l58.235"></a><span id="l58.235" class="difflineminus">-    let domain = this._client.getDomain();</span>
<a href="#l58.236"></a><span id="l58.236" class="difflineminus">-    // For the format of room id and alias, see the matrix documentation:</span>
<a href="#l58.237"></a><span id="l58.237" class="difflineminus">-    // https://matrix.org/docs/spec/intro.html#room-structure</span>
<a href="#l58.238"></a><span id="l58.238" class="difflineminus">-    // https://matrix.org/docs/spec/intro.html#room-aliases</span>
<a href="#l58.239"></a><span id="l58.239" class="difflineminus">-    if (!roomIdOrAlias.endsWith(&quot;:&quot; + domain)) {</span>
<a href="#l58.240"></a><span id="l58.240" class="difflineminus">-      roomIdOrAlias += &quot;:&quot; + domain;</span>
<a href="#l58.241"></a><span id="l58.241" class="difflineminus">-    }</span>
<a href="#l58.242"></a><span id="l58.242" class="difflineminus">-    if (!roomIdOrAlias.match(&quot;^[!#]&quot;)) {</span>
<a href="#l58.243"></a><span id="l58.243" class="difflineminus">-      roomIdOrAlias = &quot;#&quot; + roomIdOrAlias;</span>
<a href="#l58.244"></a><span id="l58.244" class="difflineminus">-    }</span>
<a href="#l58.245"></a><span id="l58.245" class="difflineminus">-</span>
<a href="#l58.246"></a><span id="l58.246" class="difflineminus">-    // TODO: Use getRoom to find existing conversation?</span>
<a href="#l58.247"></a><span id="l58.247" class="difflineminus">-    let conv = new MatrixConversation(this, roomIdOrAlias, this.userId);</span>
<a href="#l58.248"></a><span id="l58.248" class="difflineminus">-    conv.joining = true;</span>
<a href="#l58.249"></a><span id="l58.249" class="difflineminus">-    this._client</span>
<a href="#l58.250"></a><span id="l58.250" class="difflineminus">-      .joinRoom(roomIdOrAlias)</span>
<a href="#l58.251"></a><span id="l58.251" class="difflineminus">-      .then(room =&gt; {</span>
<a href="#l58.252"></a><span id="l58.252" class="difflineminus">-        conv._roomId = room.roomId;</span>
<a href="#l58.253"></a><span id="l58.253" class="difflineminus">-        this._roomList[room.roomId] = conv;</span>
<a href="#l58.254"></a><span id="l58.254" class="difflineminus">-        conv.initListOfParticipants();</span>
<a href="#l58.255"></a><span id="l58.255" class="difflineminus">-        conv.joining = false;</span>
<a href="#l58.256"></a><span id="l58.256" class="difflineminus">-      })</span>
<a href="#l58.257"></a><span id="l58.257" class="difflineminus">-      .catch(error =&gt; {</span>
<a href="#l58.258"></a><span id="l58.258" class="difflineminus">-        // TODO: Handle errors?</span>
<a href="#l58.259"></a><span id="l58.259" class="difflineminus">-        // XXX We probably want to display an error in the open conversation</span>
<a href="#l58.260"></a><span id="l58.260" class="difflineminus">-        //     window and leave it as unjoined.</span>
<a href="#l58.261"></a><span id="l58.261" class="difflineminus">-        this.ERROR(error);</span>
<a href="#l58.262"></a><span id="l58.262" class="difflineminus">-        conv.close();</span>
<a href="#l58.263"></a><span id="l58.263" class="difflineminus">-</span>
<a href="#l58.264"></a><span id="l58.264" class="difflineminus">-        // TODO Perhaps we should call createRoom if the room doesn't exist.</span>
<a href="#l58.265"></a><span id="l58.265" class="difflineminus">-      });</span>
<a href="#l58.266"></a><span id="l58.266" class="difflineminus">-    return conv;</span>
<a href="#l58.267"></a><span id="l58.267" class="difflineminus">-  },</span>
<a href="#l58.268"></a><span id="l58.268" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l58.269"></a><span id="l58.269" class="difflineminus">-    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l58.270"></a><span id="l58.270" class="difflineminus">-  },</span>
<a href="#l58.271"></a><span id="l58.271" class="difflineminus">-</span>
<a href="#l58.272"></a><span id="l58.272" class="difflineminus">-  get userId() {</span>
<a href="#l58.273"></a><span id="l58.273" class="difflineminus">-    return this._client.credentials.userId;</span>
<a href="#l58.274"></a><span id="l58.274" class="difflineminus">-  },</span>
<a href="#l58.275"></a><span id="l58.275" class="difflineminus">-  _client: null,</span>
<a href="#l58.276"></a><span id="l58.276" class="difflineminus">-  _roomList: new Map(),</span>
<a href="#l58.277"></a><span id="l58.277" class="difflineminus">-};</span>
<a href="#l58.278"></a><span id="l58.278" class="difflineminus">-</span>
<a href="#l58.279"></a><span id="l58.279" class="difflineminus">-function MatrixProtocol() {}</span>
<a href="#l58.280"></a><span id="l58.280" class="difflineminus">-MatrixProtocol.prototype = {</span>
<a href="#l58.281"></a><span id="l58.281" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l58.282"></a><span id="l58.282" class="difflineminus">-  get normalizedName() {</span>
<a href="#l58.283"></a><span id="l58.283" class="difflineminus">-    return &quot;matrix&quot;;</span>
<a href="#l58.284"></a><span id="l58.284" class="difflineminus">-  },</span>
<a href="#l58.285"></a><span id="l58.285" class="difflineminus">-  get name() {</span>
<a href="#l58.286"></a><span id="l58.286" class="difflineminus">-    return &quot;Matrix&quot;;</span>
<a href="#l58.287"></a><span id="l58.287" class="difflineminus">-  },</span>
<a href="#l58.288"></a><span id="l58.288" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l58.289"></a><span id="l58.289" class="difflineminus">-    return &quot;chrome://prpl-matrix/skin/&quot;;</span>
<a href="#l58.290"></a><span id="l58.290" class="difflineminus">-  },</span>
<a href="#l58.291"></a><span id="l58.291" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l58.292"></a><span id="l58.292" class="difflineminus">-    return new MatrixAccount(this, aImAccount);</span>
<a href="#l58.293"></a><span id="l58.293" class="difflineminus">-  },</span>
<a href="#l58.294"></a><span id="l58.294" class="difflineminus">-</span>
<a href="#l58.295"></a><span id="l58.295" class="difflineminus">-  options: {</span>
<a href="#l58.296"></a><span id="l58.296" class="difflineminus">-    // XXX Default to matrix.org once we support connection as guest?</span>
<a href="#l58.297"></a><span id="l58.297" class="difflineminus">-    server: {</span>
<a href="#l58.298"></a><span id="l58.298" class="difflineminus">-      get label() {</span>
<a href="#l58.299"></a><span id="l58.299" class="difflineminus">-        return _(&quot;options.connectServer&quot;);</span>
<a href="#l58.300"></a><span id="l58.300" class="difflineminus">-      },</span>
<a href="#l58.301"></a><span id="l58.301" class="difflineminus">-      default: &quot;https://&quot;,</span>
<a href="#l58.302"></a><span id="l58.302" class="difflineminus">-    },</span>
<a href="#l58.303"></a><span id="l58.303" class="difflineminus">-    port: {</span>
<a href="#l58.304"></a><span id="l58.304" class="difflineminus">-      get label() {</span>
<a href="#l58.305"></a><span id="l58.305" class="difflineminus">-        return _(&quot;options.connectPort&quot;);</span>
<a href="#l58.306"></a><span id="l58.306" class="difflineminus">-      },</span>
<a href="#l58.307"></a><span id="l58.307" class="difflineminus">-      default: 443,</span>
<a href="#l58.308"></a><span id="l58.308" class="difflineminus">-    },</span>
<a href="#l58.309"></a><span id="l58.309" class="difflineminus">-  },</span>
<a href="#l58.310"></a><span id="l58.310" class="difflineminus">-</span>
<a href="#l58.311"></a><span id="l58.311" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l58.312"></a><span id="l58.312" class="difflineminus">-    return true;</span>
<a href="#l58.313"></a><span id="l58.313" class="difflineminus">-  },</span>
<a href="#l58.314"></a><span id="l58.314" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1">deleted file mode 100644</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineminus">--- a/chat/protocols/matrix/components.conf</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineplus">+++ /dev/null</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l59.6"></a><span id="l59.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l59.7"></a><span id="l59.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l59.8"></a><span id="l59.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l59.9"></a><span id="l59.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l59.10"></a><span id="l59.10" class="difflineminus">-</span>
<a href="#l59.11"></a><span id="l59.11" class="difflineminus">-Classes = [</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  {</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-    'cid': '{e9653ac6-a671-11e6-bf84-60a44c717042}',</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/matrix;1'],</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-    'jsm': 'resource:///modules/Matrix.jsm',</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-    'constructor': 'MatrixProtocol',</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-matrix'},</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-  },</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1">new file mode 100644</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineminus">--- /dev/null</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix.js</span>
<a href="#l60.4"></a><span id="l60.4" class="difflineat">@@ -0,0 +1,312 @@</span>
<a href="#l60.5"></a><span id="l60.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l60.6"></a><span id="l60.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l60.7"></a><span id="l60.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l60.8"></a><span id="l60.8" class="difflineplus">+</span>
<a href="#l60.9"></a><span id="l60.9" class="difflineplus">+var { XPCOMUtils, nsSimpleEnumerator, l10nHelper } = ChromeUtils.import(</span>
<a href="#l60.10"></a><span id="l60.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l60.11"></a><span id="l60.11" class="difflineplus">+);</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+var {</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+  GenericConvChatPrototype,</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  GenericConvChatBuddyPrototype,</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+  GenericProtocolPrototype,</span>
<a href="#l60.17"></a><span id="l60.17" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l60.18"></a><span id="l60.18" class="difflineplus">+</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/matrix.properties&quot;)</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+);</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+ChromeUtils.defineModuleGetter(</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+  this,</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+  &quot;MatrixSDK&quot;,</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+  &quot;resource:///modules/matrix-sdk.jsm&quot;</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+);</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+function MatrixParticipant(aRoomMember) {</span>
<a href="#l60.30"></a><span id="l60.30" class="difflineplus">+  // FIXME: Should probably use aRoomMember.name, but it's not unique id?</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineplus">+  this._name = aRoomMember.userId;</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+  this._roomMember = aRoomMember;</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+}</span>
<a href="#l60.34"></a><span id="l60.34" class="difflineplus">+MatrixParticipant.prototype = {</span>
<a href="#l60.35"></a><span id="l60.35" class="difflineplus">+  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l60.36"></a><span id="l60.36" class="difflineplus">+  get alias() {</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineplus">+    return this._roomMember.name;</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+  },</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+};</span>
<a href="#l60.40"></a><span id="l60.40" class="difflineplus">+</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineplus">+/*</span>
<a href="#l60.42"></a><span id="l60.42" class="difflineplus">+ * TODO Other functionality from MatrixClient to implement:</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineplus">+ *  sendNotice</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineplus">+ *  sendReadReceipt</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineplus">+ *  sendTyping</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+ *  setPowerLevel</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+ *  setRoomTopic</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+ */</span>
<a href="#l60.49"></a><span id="l60.49" class="difflineplus">+function MatrixConversation(aAccount, aName, aNick) {</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineplus">+  this._init(aAccount, aName, aNick);</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+}</span>
<a href="#l60.52"></a><span id="l60.52" class="difflineplus">+MatrixConversation.prototype = {</span>
<a href="#l60.53"></a><span id="l60.53" class="difflineplus">+  __proto__: GenericConvChatPrototype,</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+    this._account._client.sendTextMessage(this._roomId, aMsg);</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+  },</span>
<a href="#l60.57"></a><span id="l60.57" class="difflineplus">+  get room() {</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineplus">+    return this._account._client.getRoom(this._roomId);</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+  },</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+  addParticipant(aRoomMember) {</span>
<a href="#l60.61"></a><span id="l60.61" class="difflineplus">+    if (this._participants.has(aRoomMember.userId)) {</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineplus">+      return;</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+    }</span>
<a href="#l60.64"></a><span id="l60.64" class="difflineplus">+</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineplus">+    let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+    this._participants.set(aRoomMember.userId, participant);</span>
<a href="#l60.67"></a><span id="l60.67" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineplus">+      new nsSimpleEnumerator([participant]),</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineplus">+      &quot;chat-buddy-add&quot;</span>
<a href="#l60.70"></a><span id="l60.70" class="difflineplus">+    );</span>
<a href="#l60.71"></a><span id="l60.71" class="difflineplus">+  },</span>
<a href="#l60.72"></a><span id="l60.72" class="difflineplus">+  initListOfParticipants() {</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineplus">+    let conv = this;</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+    let participants = [];</span>
<a href="#l60.75"></a><span id="l60.75" class="difflineplus">+    this.room.getJoinedMembers().forEach(function(aRoomMember) {</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+      if (!conv._participants.has(aRoomMember.userId)) {</span>
<a href="#l60.77"></a><span id="l60.77" class="difflineplus">+        let participant = new MatrixParticipant(aRoomMember);</span>
<a href="#l60.78"></a><span id="l60.78" class="difflineplus">+        participants.push(participant);</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineplus">+        conv._participants.set(aRoomMember.userId, participant);</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+      }</span>
<a href="#l60.81"></a><span id="l60.81" class="difflineplus">+    });</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineplus">+    if (participants.length) {</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+      this.notifyObservers(</span>
<a href="#l60.84"></a><span id="l60.84" class="difflineplus">+        new nsSimpleEnumerator(participants),</span>
<a href="#l60.85"></a><span id="l60.85" class="difflineplus">+        &quot;chat-buddy-add&quot;</span>
<a href="#l60.86"></a><span id="l60.86" class="difflineplus">+      );</span>
<a href="#l60.87"></a><span id="l60.87" class="difflineplus">+    }</span>
<a href="#l60.88"></a><span id="l60.88" class="difflineplus">+  },</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineplus">+};</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+</span>
<a href="#l60.91"></a><span id="l60.91" class="difflineplus">+/*</span>
<a href="#l60.92"></a><span id="l60.92" class="difflineplus">+ * TODO Other random functionality from MatrixClient that will be useful:</span>
<a href="#l60.93"></a><span id="l60.93" class="difflineplus">+ *  getRooms / getUsers / publicRooms</span>
<a href="#l60.94"></a><span id="l60.94" class="difflineplus">+ *  invite</span>
<a href="#l60.95"></a><span id="l60.95" class="difflineplus">+ *  ban / kick</span>
<a href="#l60.96"></a><span id="l60.96" class="difflineplus">+ *  leave</span>
<a href="#l60.97"></a><span id="l60.97" class="difflineplus">+ *  redactEvent</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineplus">+ *  scrollback</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+ *  setAvatarUrl</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineplus">+ *  setDisplayName</span>
<a href="#l60.101"></a><span id="l60.101" class="difflineplus">+ *  setPassword</span>
<a href="#l60.102"></a><span id="l60.102" class="difflineplus">+ *  setPresence</span>
<a href="#l60.103"></a><span id="l60.103" class="difflineplus">+ */</span>
<a href="#l60.104"></a><span id="l60.104" class="difflineplus">+function MatrixAccount(aProtocol, aImAccount) {</span>
<a href="#l60.105"></a><span id="l60.105" class="difflineplus">+  this._init(aProtocol, aImAccount);</span>
<a href="#l60.106"></a><span id="l60.106" class="difflineplus">+}</span>
<a href="#l60.107"></a><span id="l60.107" class="difflineplus">+MatrixAccount.prototype = {</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l60.109"></a><span id="l60.109" class="difflineplus">+  observe(aSubject, aTopic, aData) {},</span>
<a href="#l60.110"></a><span id="l60.110" class="difflineplus">+  remove() {},</span>
<a href="#l60.111"></a><span id="l60.111" class="difflineplus">+  unInit() {},</span>
<a href="#l60.112"></a><span id="l60.112" class="difflineplus">+  connect() {</span>
<a href="#l60.113"></a><span id="l60.113" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l60.114"></a><span id="l60.114" class="difflineplus">+    let baseURL = this.getString(&quot;server&quot;) + &quot;:&quot; + this.getInt(&quot;port&quot;);</span>
<a href="#l60.115"></a><span id="l60.115" class="difflineplus">+</span>
<a href="#l60.116"></a><span id="l60.116" class="difflineplus">+    this._client = MatrixSDK.createClient(baseURL);</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineplus">+</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+    // Send the login request to the server.</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineplus">+    // See https://matrix-org.github.io/matrix-js-sdk/2.4.1/module-client-MatrixClient.html#loginWithPassword</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineplus">+    this._client</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineplus">+      .loginWithPassword(this.name, this.imAccount.password)</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineplus">+      .then(data =&gt; {</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineplus">+        // TODO: Check data.errcode to pass more accurate value as the first</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineplus">+        // parameter of reportDisconnecting.</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+        if (data.error) {</span>
<a href="#l60.126"></a><span id="l60.126" class="difflineplus">+          throw new Error(data.error);</span>
<a href="#l60.127"></a><span id="l60.127" class="difflineplus">+        }</span>
<a href="#l60.128"></a><span id="l60.128" class="difflineplus">+        this.startClient();</span>
<a href="#l60.129"></a><span id="l60.129" class="difflineplus">+      })</span>
<a href="#l60.130"></a><span id="l60.130" class="difflineplus">+      .catch(error =&gt; {</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineplus">+        this.reportDisconnecting(</span>
<a href="#l60.132"></a><span id="l60.132" class="difflineplus">+          Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l60.133"></a><span id="l60.133" class="difflineplus">+          error.message</span>
<a href="#l60.134"></a><span id="l60.134" class="difflineplus">+        );</span>
<a href="#l60.135"></a><span id="l60.135" class="difflineplus">+        this._client = null;</span>
<a href="#l60.136"></a><span id="l60.136" class="difflineplus">+        this.reportDisconnected();</span>
<a href="#l60.137"></a><span id="l60.137" class="difflineplus">+      });</span>
<a href="#l60.138"></a><span id="l60.138" class="difflineplus">+  },</span>
<a href="#l60.139"></a><span id="l60.139" class="difflineplus">+  /*</span>
<a href="#l60.140"></a><span id="l60.140" class="difflineplus">+   * Hook up the Matrix Client to callbacks to handle various events.</span>
<a href="#l60.141"></a><span id="l60.141" class="difflineplus">+   *</span>
<a href="#l60.142"></a><span id="l60.142" class="difflineplus">+   * The possible events are documented starting at:</span>
<a href="#l60.143"></a><span id="l60.143" class="difflineplus">+   * https://matrix-org.github.io/matrix-js-sdk/2.4.1/module-client.html#~event:MatrixClient%22accountData%22</span>
<a href="#l60.144"></a><span id="l60.144" class="difflineplus">+   */</span>
<a href="#l60.145"></a><span id="l60.145" class="difflineplus">+  startClient() {</span>
<a href="#l60.146"></a><span id="l60.146" class="difflineplus">+    this._client.on(&quot;sync&quot;, (state, prevState, data) =&gt; {</span>
<a href="#l60.147"></a><span id="l60.147" class="difflineplus">+      switch (state) {</span>
<a href="#l60.148"></a><span id="l60.148" class="difflineplus">+        case &quot;PREPARED&quot;:</span>
<a href="#l60.149"></a><span id="l60.149" class="difflineplus">+          this.reportConnected();</span>
<a href="#l60.150"></a><span id="l60.150" class="difflineplus">+          break;</span>
<a href="#l60.151"></a><span id="l60.151" class="difflineplus">+        case &quot;STOPPED&quot;:</span>
<a href="#l60.152"></a><span id="l60.152" class="difflineplus">+          // XXX Report disconnecting here?</span>
<a href="#l60.153"></a><span id="l60.153" class="difflineplus">+          this._client.logout().then(() =&gt; {</span>
<a href="#l60.154"></a><span id="l60.154" class="difflineplus">+            this.reportDisconnected();</span>
<a href="#l60.155"></a><span id="l60.155" class="difflineplus">+            this._client = null;</span>
<a href="#l60.156"></a><span id="l60.156" class="difflineplus">+          });</span>
<a href="#l60.157"></a><span id="l60.157" class="difflineplus">+          break;</span>
<a href="#l60.158"></a><span id="l60.158" class="difflineplus">+        // TODO: Handle other states (RECONNECTING, ERROR, SYNCING).</span>
<a href="#l60.159"></a><span id="l60.159" class="difflineplus">+      }</span>
<a href="#l60.160"></a><span id="l60.160" class="difflineplus">+    });</span>
<a href="#l60.161"></a><span id="l60.161" class="difflineplus">+    this._client.on(&quot;RoomMember.membership&quot;, (event, member, oldMembership) =&gt; {</span>
<a href="#l60.162"></a><span id="l60.162" class="difflineplus">+      if (member.roomId in this._roomList) {</span>
<a href="#l60.163"></a><span id="l60.163" class="difflineplus">+        var room = this._roomList[member.roomId];</span>
<a href="#l60.164"></a><span id="l60.164" class="difflineplus">+        if (member.membership === &quot;join&quot;) {</span>
<a href="#l60.165"></a><span id="l60.165" class="difflineplus">+          room.addParticipant(member);</span>
<a href="#l60.166"></a><span id="l60.166" class="difflineplus">+        } else {</span>
<a href="#l60.167"></a><span id="l60.167" class="difflineplus">+          room.removeParticipant(member.userId);</span>
<a href="#l60.168"></a><span id="l60.168" class="difflineplus">+        }</span>
<a href="#l60.169"></a><span id="l60.169" class="difflineplus">+      }</span>
<a href="#l60.170"></a><span id="l60.170" class="difflineplus">+    });</span>
<a href="#l60.171"></a><span id="l60.171" class="difflineplus">+    this._client.on(&quot;Room.timeline&quot;, (event, room, toStartOfTimeline) =&gt; {</span>
<a href="#l60.172"></a><span id="l60.172" class="difflineplus">+      // TODO: Better handle messages!</span>
<a href="#l60.173"></a><span id="l60.173" class="difflineplus">+      if (toStartOfTimeline) {</span>
<a href="#l60.174"></a><span id="l60.174" class="difflineplus">+        return;</span>
<a href="#l60.175"></a><span id="l60.175" class="difflineplus">+      }</span>
<a href="#l60.176"></a><span id="l60.176" class="difflineplus">+      if (room.roomId in this._roomList) {</span>
<a href="#l60.177"></a><span id="l60.177" class="difflineplus">+        let body;</span>
<a href="#l60.178"></a><span id="l60.178" class="difflineplus">+        if (event.getType() === &quot;m.room.message&quot;) {</span>
<a href="#l60.179"></a><span id="l60.179" class="difflineplus">+          body = event.getContent().body;</span>
<a href="#l60.180"></a><span id="l60.180" class="difflineplus">+        } else {</span>
<a href="#l60.181"></a><span id="l60.181" class="difflineplus">+          body = JSON.stringify(event.getContent());</span>
<a href="#l60.182"></a><span id="l60.182" class="difflineplus">+        }</span>
<a href="#l60.183"></a><span id="l60.183" class="difflineplus">+        this._roomList[room.roomId].writeMessage(event.getSender(), body, {</span>
<a href="#l60.184"></a><span id="l60.184" class="difflineplus">+          incoming: true,</span>
<a href="#l60.185"></a><span id="l60.185" class="difflineplus">+        });</span>
<a href="#l60.186"></a><span id="l60.186" class="difflineplus">+      }</span>
<a href="#l60.187"></a><span id="l60.187" class="difflineplus">+    });</span>
<a href="#l60.188"></a><span id="l60.188" class="difflineplus">+</span>
<a href="#l60.189"></a><span id="l60.189" class="difflineplus">+    // TODO Other events to handle:</span>
<a href="#l60.190"></a><span id="l60.190" class="difflineplus">+    //  Room.accountData</span>
<a href="#l60.191"></a><span id="l60.191" class="difflineplus">+    //  Room.localEchoUpdated</span>
<a href="#l60.192"></a><span id="l60.192" class="difflineplus">+    //  Room.name</span>
<a href="#l60.193"></a><span id="l60.193" class="difflineplus">+    //  Room.tags</span>
<a href="#l60.194"></a><span id="l60.194" class="difflineplus">+    //  Room</span>
<a href="#l60.195"></a><span id="l60.195" class="difflineplus">+    //  RoomMember.name</span>
<a href="#l60.196"></a><span id="l60.196" class="difflineplus">+    //  RoomMember.powerLevel</span>
<a href="#l60.197"></a><span id="l60.197" class="difflineplus">+    //  RoomMember.typing</span>
<a href="#l60.198"></a><span id="l60.198" class="difflineplus">+    //  Session.logged_out</span>
<a href="#l60.199"></a><span id="l60.199" class="difflineplus">+    //  User.avatarUrl</span>
<a href="#l60.200"></a><span id="l60.200" class="difflineplus">+    //  User.currentlyActive</span>
<a href="#l60.201"></a><span id="l60.201" class="difflineplus">+    //  User.displayName</span>
<a href="#l60.202"></a><span id="l60.202" class="difflineplus">+    //  User.presence</span>
<a href="#l60.203"></a><span id="l60.203" class="difflineplus">+</span>
<a href="#l60.204"></a><span id="l60.204" class="difflineplus">+    this._client.startClient();</span>
<a href="#l60.205"></a><span id="l60.205" class="difflineplus">+  },</span>
<a href="#l60.206"></a><span id="l60.206" class="difflineplus">+  disconnect() {</span>
<a href="#l60.207"></a><span id="l60.207" class="difflineplus">+    if (this._client) {</span>
<a href="#l60.208"></a><span id="l60.208" class="difflineplus">+      this._client.stopClient();</span>
<a href="#l60.209"></a><span id="l60.209" class="difflineplus">+    }</span>
<a href="#l60.210"></a><span id="l60.210" class="difflineplus">+  },</span>
<a href="#l60.211"></a><span id="l60.211" class="difflineplus">+</span>
<a href="#l60.212"></a><span id="l60.212" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l60.213"></a><span id="l60.213" class="difflineplus">+    return true;</span>
<a href="#l60.214"></a><span id="l60.214" class="difflineplus">+  },</span>
<a href="#l60.215"></a><span id="l60.215" class="difflineplus">+  chatRoomFields: {</span>
<a href="#l60.216"></a><span id="l60.216" class="difflineplus">+    // XXX Does it make sense to split up the server into a separate field?</span>
<a href="#l60.217"></a><span id="l60.217" class="difflineplus">+    roomIdOrAlias: {</span>
<a href="#l60.218"></a><span id="l60.218" class="difflineplus">+      get label() {</span>
<a href="#l60.219"></a><span id="l60.219" class="difflineplus">+        return _(&quot;chatRoomField.room&quot;);</span>
<a href="#l60.220"></a><span id="l60.220" class="difflineplus">+      },</span>
<a href="#l60.221"></a><span id="l60.221" class="difflineplus">+      required: true,</span>
<a href="#l60.222"></a><span id="l60.222" class="difflineplus">+    },</span>
<a href="#l60.223"></a><span id="l60.223" class="difflineplus">+  },</span>
<a href="#l60.224"></a><span id="l60.224" class="difflineplus">+  parseDefaultChatName(aDefaultName) {</span>
<a href="#l60.225"></a><span id="l60.225" class="difflineplus">+    let chatFields = {</span>
<a href="#l60.226"></a><span id="l60.226" class="difflineplus">+      roomIdOrAlias: aDefaultName,</span>
<a href="#l60.227"></a><span id="l60.227" class="difflineplus">+    };</span>
<a href="#l60.228"></a><span id="l60.228" class="difflineplus">+</span>
<a href="#l60.229"></a><span id="l60.229" class="difflineplus">+    return chatFields;</span>
<a href="#l60.230"></a><span id="l60.230" class="difflineplus">+  },</span>
<a href="#l60.231"></a><span id="l60.231" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l60.232"></a><span id="l60.232" class="difflineplus">+    let roomIdOrAlias = aComponents.getValue(&quot;roomIdOrAlias&quot;).trim();</span>
<a href="#l60.233"></a><span id="l60.233" class="difflineplus">+    let domain = this._client.getDomain();</span>
<a href="#l60.234"></a><span id="l60.234" class="difflineplus">+    // For the format of room id and alias, see the matrix documentation:</span>
<a href="#l60.235"></a><span id="l60.235" class="difflineplus">+    // https://matrix.org/docs/spec/intro.html#room-structure</span>
<a href="#l60.236"></a><span id="l60.236" class="difflineplus">+    // https://matrix.org/docs/spec/intro.html#room-aliases</span>
<a href="#l60.237"></a><span id="l60.237" class="difflineplus">+    if (!roomIdOrAlias.endsWith(&quot;:&quot; + domain)) {</span>
<a href="#l60.238"></a><span id="l60.238" class="difflineplus">+      roomIdOrAlias += &quot;:&quot; + domain;</span>
<a href="#l60.239"></a><span id="l60.239" class="difflineplus">+    }</span>
<a href="#l60.240"></a><span id="l60.240" class="difflineplus">+    if (!roomIdOrAlias.match(&quot;^[!#]&quot;)) {</span>
<a href="#l60.241"></a><span id="l60.241" class="difflineplus">+      roomIdOrAlias = &quot;#&quot; + roomIdOrAlias;</span>
<a href="#l60.242"></a><span id="l60.242" class="difflineplus">+    }</span>
<a href="#l60.243"></a><span id="l60.243" class="difflineplus">+</span>
<a href="#l60.244"></a><span id="l60.244" class="difflineplus">+    // TODO: Use getRoom to find existing conversation?</span>
<a href="#l60.245"></a><span id="l60.245" class="difflineplus">+    let conv = new MatrixConversation(this, roomIdOrAlias, this.userId);</span>
<a href="#l60.246"></a><span id="l60.246" class="difflineplus">+    conv.joining = true;</span>
<a href="#l60.247"></a><span id="l60.247" class="difflineplus">+    this._client</span>
<a href="#l60.248"></a><span id="l60.248" class="difflineplus">+      .joinRoom(roomIdOrAlias)</span>
<a href="#l60.249"></a><span id="l60.249" class="difflineplus">+      .then(room =&gt; {</span>
<a href="#l60.250"></a><span id="l60.250" class="difflineplus">+        conv._roomId = room.roomId;</span>
<a href="#l60.251"></a><span id="l60.251" class="difflineplus">+        this._roomList[room.roomId] = conv;</span>
<a href="#l60.252"></a><span id="l60.252" class="difflineplus">+        conv.initListOfParticipants();</span>
<a href="#l60.253"></a><span id="l60.253" class="difflineplus">+        conv.joining = false;</span>
<a href="#l60.254"></a><span id="l60.254" class="difflineplus">+      })</span>
<a href="#l60.255"></a><span id="l60.255" class="difflineplus">+      .catch(error =&gt; {</span>
<a href="#l60.256"></a><span id="l60.256" class="difflineplus">+        // TODO: Handle errors?</span>
<a href="#l60.257"></a><span id="l60.257" class="difflineplus">+        // XXX We probably want to display an error in the open conversation</span>
<a href="#l60.258"></a><span id="l60.258" class="difflineplus">+        //     window and leave it as unjoined.</span>
<a href="#l60.259"></a><span id="l60.259" class="difflineplus">+        this.ERROR(error);</span>
<a href="#l60.260"></a><span id="l60.260" class="difflineplus">+        conv.close();</span>
<a href="#l60.261"></a><span id="l60.261" class="difflineplus">+</span>
<a href="#l60.262"></a><span id="l60.262" class="difflineplus">+        // TODO Perhaps we should call createRoom if the room doesn't exist.</span>
<a href="#l60.263"></a><span id="l60.263" class="difflineplus">+      });</span>
<a href="#l60.264"></a><span id="l60.264" class="difflineplus">+    return conv;</span>
<a href="#l60.265"></a><span id="l60.265" class="difflineplus">+  },</span>
<a href="#l60.266"></a><span id="l60.266" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l60.267"></a><span id="l60.267" class="difflineplus">+    throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l60.268"></a><span id="l60.268" class="difflineplus">+  },</span>
<a href="#l60.269"></a><span id="l60.269" class="difflineplus">+</span>
<a href="#l60.270"></a><span id="l60.270" class="difflineplus">+  get userId() {</span>
<a href="#l60.271"></a><span id="l60.271" class="difflineplus">+    return this._client.credentials.userId;</span>
<a href="#l60.272"></a><span id="l60.272" class="difflineplus">+  },</span>
<a href="#l60.273"></a><span id="l60.273" class="difflineplus">+  _client: null,</span>
<a href="#l60.274"></a><span id="l60.274" class="difflineplus">+  _roomList: new Map(),</span>
<a href="#l60.275"></a><span id="l60.275" class="difflineplus">+};</span>
<a href="#l60.276"></a><span id="l60.276" class="difflineplus">+</span>
<a href="#l60.277"></a><span id="l60.277" class="difflineplus">+function MatrixProtocol() {}</span>
<a href="#l60.278"></a><span id="l60.278" class="difflineplus">+MatrixProtocol.prototype = {</span>
<a href="#l60.279"></a><span id="l60.279" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l60.280"></a><span id="l60.280" class="difflineplus">+  get normalizedName() {</span>
<a href="#l60.281"></a><span id="l60.281" class="difflineplus">+    return &quot;matrix&quot;;</span>
<a href="#l60.282"></a><span id="l60.282" class="difflineplus">+  },</span>
<a href="#l60.283"></a><span id="l60.283" class="difflineplus">+  get name() {</span>
<a href="#l60.284"></a><span id="l60.284" class="difflineplus">+    return &quot;Matrix&quot;;</span>
<a href="#l60.285"></a><span id="l60.285" class="difflineplus">+  },</span>
<a href="#l60.286"></a><span id="l60.286" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l60.287"></a><span id="l60.287" class="difflineplus">+    return &quot;chrome://prpl-matrix/skin/&quot;;</span>
<a href="#l60.288"></a><span id="l60.288" class="difflineplus">+  },</span>
<a href="#l60.289"></a><span id="l60.289" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l60.290"></a><span id="l60.290" class="difflineplus">+    return new MatrixAccount(this, aImAccount);</span>
<a href="#l60.291"></a><span id="l60.291" class="difflineplus">+  },</span>
<a href="#l60.292"></a><span id="l60.292" class="difflineplus">+</span>
<a href="#l60.293"></a><span id="l60.293" class="difflineplus">+  options: {</span>
<a href="#l60.294"></a><span id="l60.294" class="difflineplus">+    // XXX Default to matrix.org once we support connection as guest?</span>
<a href="#l60.295"></a><span id="l60.295" class="difflineplus">+    server: {</span>
<a href="#l60.296"></a><span id="l60.296" class="difflineplus">+      get label() {</span>
<a href="#l60.297"></a><span id="l60.297" class="difflineplus">+        return _(&quot;options.connectServer&quot;);</span>
<a href="#l60.298"></a><span id="l60.298" class="difflineplus">+      },</span>
<a href="#l60.299"></a><span id="l60.299" class="difflineplus">+      default: &quot;https://&quot;,</span>
<a href="#l60.300"></a><span id="l60.300" class="difflineplus">+    },</span>
<a href="#l60.301"></a><span id="l60.301" class="difflineplus">+    port: {</span>
<a href="#l60.302"></a><span id="l60.302" class="difflineplus">+      get label() {</span>
<a href="#l60.303"></a><span id="l60.303" class="difflineplus">+        return _(&quot;options.connectPort&quot;);</span>
<a href="#l60.304"></a><span id="l60.304" class="difflineplus">+      },</span>
<a href="#l60.305"></a><span id="l60.305" class="difflineplus">+      default: 443,</span>
<a href="#l60.306"></a><span id="l60.306" class="difflineplus">+    },</span>
<a href="#l60.307"></a><span id="l60.307" class="difflineplus">+  },</span>
<a href="#l60.308"></a><span id="l60.308" class="difflineplus">+</span>
<a href="#l60.309"></a><span id="l60.309" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l60.310"></a><span id="l60.310" class="difflineplus">+    return true;</span>
<a href="#l60.311"></a><span id="l60.311" class="difflineplus">+  },</span>
<a href="#l60.312"></a><span id="l60.312" class="difflineplus">+</span>
<a href="#l60.313"></a><span id="l60.313" class="difflineplus">+  classID: Components.ID(&quot;{e9653ac6-a671-11e6-bf84-60a44c717042}&quot;),</span>
<a href="#l60.314"></a><span id="l60.314" class="difflineplus">+};</span>
<a href="#l60.315"></a><span id="l60.315" class="difflineplus">+</span>
<a href="#l60.316"></a><span id="l60.316" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([MatrixProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">new file mode 100644</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineminus">--- /dev/null</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineplus">+++ b/chat/protocols/matrix/matrix.manifest</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineat">@@ -0,0 +1,4 @@</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineplus">+component {e9653ac6-a671-11e6-bf84-60a44c717042} matrix.js</span>
<a href="#l61.6"></a><span id="l61.6" class="difflineplus">+contract @mozilla.org/chat/matrix;1 {e9653ac6-a671-11e6-bf84-60a44c717042}</span>
<a href="#l61.7"></a><span id="l61.7" class="difflineplus">+category im-protocol-plugin prpl-matrix @mozilla.org/chat/matrix;1</span>
<a href="#l61.8"></a><span id="l61.8" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/chat/protocols/matrix/moz.build</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/chat/protocols/matrix/moz.build</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -5,20 +5,20 @@</span>
<a href="#l62.4"></a><span id="l62.4"> </span>
<a href="#l62.5"></a><span id="l62.5"> # XPCSHELL_TESTS_MANIFESTS += []</span>
<a href="#l62.6"></a><span id="l62.6"> </span>
<a href="#l62.7"></a><span id="l62.7"> DIRS += [</span>
<a href="#l62.8"></a><span id="l62.8">     'lib',</span>
<a href="#l62.9"></a><span id="l62.9">     'shims',</span>
<a href="#l62.10"></a><span id="l62.10"> ]</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+    'matrix.js',</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineplus">+    'matrix.manifest',</span>
<a href="#l62.15"></a><span id="l62.15" class="difflineplus">+]</span>
<a href="#l62.16"></a><span id="l62.16" class="difflineplus">+</span>
<a href="#l62.17"></a><span id="l62.17"> EXTRA_JS_MODULES += [</span>
<a href="#l62.18"></a><span id="l62.18">     'matrix-sdk.jsm',</span>
<a href="#l62.19"></a><span id="l62.19" class="difflineminus">-    'Matrix.jsm',</span>
<a href="#l62.20"></a><span id="l62.20"> ]</span>
<a href="#l62.21"></a><span id="l62.21"> </span>
<a href="#l62.22"></a><span id="l62.22"> JAR_MANIFESTS += [</span>
<a href="#l62.23"></a><span id="l62.23">     'jar.mn',</span>
<a href="#l62.24"></a><span id="l62.24"> ]</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineminus">-</span>
<a href="#l62.26"></a><span id="l62.26" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l62.27"></a><span id="l62.27" class="difflineminus">-    'components.conf',</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">deleted file mode 100644</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineminus">--- a/chat/protocols/odnoklassniki/Odnoklassniki.jsm</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineplus">+++ /dev/null</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineat">@@ -1,80 +0,0 @@</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l63.6"></a><span id="l63.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l63.7"></a><span id="l63.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineminus">-</span>
<a href="#l63.9"></a><span id="l63.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;OdnoklassnikiProtocol&quot;];</span>
<a href="#l63.10"></a><span id="l63.10" class="difflineminus">-</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-);</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineminus">-var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineminus">-);</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineminus">-var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-);</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineminus">-var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineminus">-  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineminus">-);</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineminus">-</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineminus">-);</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineminus">-</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineminus">-function OdnoklassnikiAccount(aProtoInstance, aImAccount) {</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineminus">-}</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-OdnoklassnikiAccount.prototype = {</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineminus">-  __proto__: XMPPAccountPrototype,</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineminus">-    return false;</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineminus">-  },</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineminus">-  connect() {</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineminus">-    if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineminus">-      // TODO: Do not use the default resource value if the user has not</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineminus">-      // specified it and let the service generate it.</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineminus">-      let jid = this.name + &quot;@odnoklassniki.ru/&quot; + XMPPDefaultResource;</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-      this._jid = this._parseJID(jid);</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-    } else {</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-      this._jid = this._parseJID(this.name);</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-      if (this._jid.domain != &quot;odnoklassniki.ru&quot;) {</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineminus">-        // We can't use this.onError because this._connection doesn't exist.</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineminus">-        this.reportDisconnecting(</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-          Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineminus">-          _(&quot;connection.error.invalidUsername&quot;)</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineminus">-        );</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineminus">-        this.reportDisconnected();</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineminus">-        return;</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineminus">-      }</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-    }</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineminus">-</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineminus">-    this._connection = new XMPPSession(</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineminus">-      &quot;xmpp.odnoklassniki.ru&quot;,</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineminus">-      5222,</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineminus">-      &quot;require_tls&quot;,</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineminus">-      this._jid,</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineminus">-      this.imAccount.password,</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-      this</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineminus">-    );</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineminus">-  },</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineminus">-};</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineminus">-</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineminus">-function OdnoklassnikiProtocol() {}</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineminus">-OdnoklassnikiProtocol.prototype = {</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineminus">-  get normalizedName() {</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineminus">-    return &quot;odnoklassniki&quot;;</span>
<a href="#l63.71"></a><span id="l63.71" class="difflineminus">-  },</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineminus">-  get name() {</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineminus">-    return _(&quot;odnoklassniki.protocolName&quot;);</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineminus">-  },</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineminus">-    return &quot;chrome://prpl-odnoklassniki/skin/&quot;;</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineminus">-  },</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineminus">-  get usernameEmptyText() {</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineminus">-    return _(&quot;odnoklassniki.usernameHint&quot;);</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineminus">-  },</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineminus">-    return new OdnoklassnikiAccount(this, aImAccount);</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineminus">-  },</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1">deleted file mode 100644</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineminus">--- a/chat/protocols/odnoklassniki/components.conf</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineplus">+++ /dev/null</span>
<a href="#l64.4"></a><span id="l64.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l64.5"></a><span id="l64.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l64.6"></a><span id="l64.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l64.7"></a><span id="l64.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.8"></a><span id="l64.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l64.10"></a><span id="l64.10" class="difflineminus">-</span>
<a href="#l64.11"></a><span id="l64.11" class="difflineminus">-Classes = [</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-  {</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-    'cid': '{29b09a83-81c1-2032-11e2-6d9bc4f8e969}',</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/odnoklassniki;1'],</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineminus">-    'jsm': 'resource:///modules/Odnoklassniki.jsm',</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineminus">-    'constructor': 'OdnoklassnikiProtocol',</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-odnoklassniki'},</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineminus">-  },</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/chat/protocols/odnoklassniki/moz.build</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/chat/protocols/odnoklassniki/moz.build</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,14 +1,11 @@</span>
<a href="#l65.4"></a><span id="l65.4"> # vim: set filetype=python:</span>
<a href="#l65.5"></a><span id="l65.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l65.6"></a><span id="l65.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l65.7"></a><span id="l65.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l65.8"></a><span id="l65.8"> </span>
<a href="#l65.9"></a><span id="l65.9" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l65.10"></a><span id="l65.10" class="difflineminus">-</span>
<a href="#l65.11"></a><span id="l65.11" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-    'components.conf',</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+    'odnoklassniki.js',</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+    'odnoklassniki.manifest',</span>
<a href="#l65.16"></a><span id="l65.16"> ]</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineminus">-    'Odnoklassniki.jsm',</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineminus">-]</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1">new file mode 100644</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineminus">--- /dev/null</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.js</span>
<a href="#l66.4"></a><span id="l66.4" class="difflineat">@@ -0,0 +1,81 @@</span>
<a href="#l66.5"></a><span id="l66.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l66.6"></a><span id="l66.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l66.7"></a><span id="l66.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l66.8"></a><span id="l66.8" class="difflineplus">+</span>
<a href="#l66.9"></a><span id="l66.9" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+);</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+);</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineplus">+  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineplus">+);</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+var { XMPPSession, XMPPDefaultResource } = ChromeUtils.import(</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+  &quot;resource:///modules/xmpp-session.jsm&quot;</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineplus">+);</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineplus">+</span>
<a href="#l66.22"></a><span id="l66.22" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+);</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+</span>
<a href="#l66.26"></a><span id="l66.26" class="difflineplus">+function OdnoklassnikiAccount(aProtoInstance, aImAccount) {</span>
<a href="#l66.27"></a><span id="l66.27" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l66.28"></a><span id="l66.28" class="difflineplus">+}</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineplus">+OdnoklassnikiAccount.prototype = {</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+  __proto__: XMPPAccountPrototype,</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l66.32"></a><span id="l66.32" class="difflineplus">+    return false;</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineplus">+  },</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineplus">+  connect() {</span>
<a href="#l66.35"></a><span id="l66.35" class="difflineplus">+    if (!this.name.includes(&quot;@&quot;)) {</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineplus">+      // TODO: Do not use the default resource value if the user has not</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineplus">+      // specified it and let the service generate it.</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+      let jid = this.name + &quot;@odnoklassniki.ru/&quot; + XMPPDefaultResource;</span>
<a href="#l66.39"></a><span id="l66.39" class="difflineplus">+      this._jid = this._parseJID(jid);</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineplus">+    } else {</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+      this._jid = this._parseJID(this.name);</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineplus">+      if (this._jid.domain != &quot;odnoklassniki.ru&quot;) {</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+        // We can't use this.onError because this._connection doesn't exist.</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+        this.reportDisconnecting(</span>
<a href="#l66.45"></a><span id="l66.45" class="difflineplus">+          Ci.prplIAccount.ERROR_INVALID_USERNAME,</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineplus">+          _(&quot;connection.error.invalidUsername&quot;)</span>
<a href="#l66.47"></a><span id="l66.47" class="difflineplus">+        );</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineplus">+        this.reportDisconnected();</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineplus">+        return;</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineplus">+      }</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+    }</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+</span>
<a href="#l66.53"></a><span id="l66.53" class="difflineplus">+    this._connection = new XMPPSession(</span>
<a href="#l66.54"></a><span id="l66.54" class="difflineplus">+      &quot;xmpp.odnoklassniki.ru&quot;,</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineplus">+      5222,</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+      &quot;require_tls&quot;,</span>
<a href="#l66.57"></a><span id="l66.57" class="difflineplus">+      this._jid,</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineplus">+      this.imAccount.password,</span>
<a href="#l66.59"></a><span id="l66.59" class="difflineplus">+      this</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineplus">+    );</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+  },</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+};</span>
<a href="#l66.63"></a><span id="l66.63" class="difflineplus">+</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineplus">+function OdnoklassnikiProtocol() {}</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+OdnoklassnikiProtocol.prototype = {</span>
<a href="#l66.66"></a><span id="l66.66" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineplus">+  get normalizedName() {</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineplus">+    return &quot;odnoklassniki&quot;;</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineplus">+  },</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineplus">+  get name() {</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineplus">+    return _(&quot;odnoklassniki.protocolName&quot;);</span>
<a href="#l66.72"></a><span id="l66.72" class="difflineplus">+  },</span>
<a href="#l66.73"></a><span id="l66.73" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l66.74"></a><span id="l66.74" class="difflineplus">+    return &quot;chrome://prpl-odnoklassniki/skin/&quot;;</span>
<a href="#l66.75"></a><span id="l66.75" class="difflineplus">+  },</span>
<a href="#l66.76"></a><span id="l66.76" class="difflineplus">+  get usernameEmptyText() {</span>
<a href="#l66.77"></a><span id="l66.77" class="difflineplus">+    return _(&quot;odnoklassniki.usernameHint&quot;);</span>
<a href="#l66.78"></a><span id="l66.78" class="difflineplus">+  },</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l66.80"></a><span id="l66.80" class="difflineplus">+    return new OdnoklassnikiAccount(this, aImAccount);</span>
<a href="#l66.81"></a><span id="l66.81" class="difflineplus">+  },</span>
<a href="#l66.82"></a><span id="l66.82" class="difflineplus">+  classID: Components.ID(&quot;{29b09a83-81c1-2032-11e2-6d9bc4f8e969}&quot;),</span>
<a href="#l66.83"></a><span id="l66.83" class="difflineplus">+};</span>
<a href="#l66.84"></a><span id="l66.84" class="difflineplus">+</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([OdnoklassnikiProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1">new file mode 100644</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineminus">--- /dev/null</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineplus">+++ b/chat/protocols/odnoklassniki/odnoklassniki.manifest</span>
<a href="#l67.4"></a><span id="l67.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l67.5"></a><span id="l67.5" class="difflineplus">+component {29b09a83-81c1-2032-11e2-6d9bc4f8e969} odnoklassniki.js</span>
<a href="#l67.6"></a><span id="l67.6" class="difflineplus">+contract @mozilla.org/chat/odnoklassniki;1 {29b09a83-81c1-2032-11e2-6d9bc4f8e969}</span>
<a href="#l67.7"></a><span id="l67.7" class="difflineplus">+category im-protocol-plugin prpl-odnoklassniki @mozilla.org/chat/odnoklassniki;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1">deleted file mode 100644</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineminus">--- a/chat/protocols/skype/Skype.jsm</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineplus">+++ /dev/null</span>
<a href="#l68.4"></a><span id="l68.4" class="difflineat">@@ -1,960 +0,0 @@</span>
<a href="#l68.5"></a><span id="l68.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l68.6"></a><span id="l68.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l68.7"></a><span id="l68.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l68.8"></a><span id="l68.8" class="difflineminus">-</span>
<a href="#l68.9"></a><span id="l68.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;SkypeProtocol&quot;, &quot;contactUrlToName&quot;, &quot;magicSha256&quot;];</span>
<a href="#l68.10"></a><span id="l68.10" class="difflineminus">-var { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l68.11"></a><span id="l68.11" class="difflineminus">-var { StringToArrayBuffer } = ChromeUtils.import(</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  &quot;resource:///modules/ArrayBufferUtils.jsm&quot;</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineminus">-);</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-var { bigInt } = ChromeUtils.import(&quot;resource:///modules/BigInteger.jsm&quot;);</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineminus">-var {</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineminus">-  setTimeout,</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineminus">-  clearTimeout,</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineminus">-  l10nHelper,</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineminus">-  EmptyEnumerator,</span>
<a href="#l68.23"></a><span id="l68.23" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineminus">-var {</span>
<a href="#l68.25"></a><span id="l68.25" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineminus">-  GenericAccountBuddyPrototype,</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineminus">-  TooltipInfo,</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineminus">-</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineminus">-// Constants used by the login process. This emulates a captured session using</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineminus">-// official means.</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineminus">-var kLockAndKeyAppId = &quot;msmsgs@msnmsgr.com&quot;;</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineminus">-var kLockAndKeySecret = &quot;Q1P7W2E4J9R8U3S5&quot;;</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineminus">-var kClientId = &quot;578134&quot;;</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineminus">-var kClientInfo =</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineminus">-  &quot;os=Windows; osVer=8.1; proc=Win32; lcid=en-us; &quot; +</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineminus">-  &quot;deviceType=1; country=n/a; clientName=swx-skype.com; clientVer=908/1.0.0.20&quot;;</span>
<a href="#l68.40"></a><span id="l68.40" class="difflineminus">-</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineminus">-var kLoginHost = &quot;login.skype.com&quot;;</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineminus">-var kContactsHost = &quot;api.skype.com&quot;;</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineminus">-var kMessagesHost = &quot;client-s.gateway.messenger.live.com&quot;;</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineminus">-</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineminus">-// Map from strings returned by the SkypeWeb API to statuses.</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineminus">-var kStatusMap = {</span>
<a href="#l68.47"></a><span id="l68.47" class="difflineminus">-  Online: &quot;AVAILABLE&quot;,</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineminus">-  Offline: &quot;OFFLINE&quot;,</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineminus">-  Idle: &quot;IDLE&quot;,</span>
<a href="#l68.50"></a><span id="l68.50" class="difflineminus">-  Away: &quot;AWAY&quot;,</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineminus">-  Hidden: &quot;INVISIBLE&quot;,</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-};</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineminus">-</span>
<a href="#l68.54"></a><span id="l68.54" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l68.55"></a><span id="l68.55" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/skype.properties&quot;)</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineminus">-);</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineminus">-</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineminus">-/*</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineminus">- * Convert a URL to a user's name.</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineminus">- *</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineminus">- * E.g. https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep</span>
<a href="#l68.62"></a><span id="l68.62" class="difflineminus">- *      https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineminus">- *</span>
<a href="#l68.64"></a><span id="l68.64" class="difflineminus">- *</span>
<a href="#l68.65"></a><span id="l68.65" class="difflineminus">- * Note that some contacts might have a /1: in them (instead of a /8:), that's</span>
<a href="#l68.66"></a><span id="l68.66" class="difflineminus">- * for MSN linked contacts.</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineminus">- */</span>
<a href="#l68.68"></a><span id="l68.68" class="difflineminus">-function contactUrlToName(aUrl) {</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineminus">-  let start = aUrl.indexOf(&quot;/8:&quot;);</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineminus">-  if (start == -1) {</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineminus">-    return null;</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineminus">-  }</span>
<a href="#l68.73"></a><span id="l68.73" class="difflineminus">-  // Skip over the separator.</span>
<a href="#l68.74"></a><span id="l68.74" class="difflineminus">-  start += &quot;/8:&quot;.length;</span>
<a href="#l68.75"></a><span id="l68.75" class="difflineminus">-</span>
<a href="#l68.76"></a><span id="l68.76" class="difflineminus">-  let end = aUrl.indexOf(&quot;/&quot;, start);</span>
<a href="#l68.77"></a><span id="l68.77" class="difflineminus">-  if (end == -1) {</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineminus">-    end = undefined;</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineminus">-  }</span>
<a href="#l68.80"></a><span id="l68.80" class="difflineminus">-</span>
<a href="#l68.81"></a><span id="l68.81" class="difflineminus">-  return aUrl.slice(start, end);</span>
<a href="#l68.82"></a><span id="l68.82" class="difflineminus">-}</span>
<a href="#l68.83"></a><span id="l68.83" class="difflineminus">-</span>
<a href="#l68.84"></a><span id="l68.84" class="difflineminus">-function SkypeConversation(aAccount, aName) {</span>
<a href="#l68.85"></a><span id="l68.85" class="difflineminus">-  this.buddy = aAccount._buddies.get(aName);</span>
<a href="#l68.86"></a><span id="l68.86" class="difflineminus">-  this._init(aAccount, aName);</span>
<a href="#l68.87"></a><span id="l68.87" class="difflineminus">-}</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-SkypeConversation.prototype = {</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineminus">-  __proto__: GenericConvIMPrototype,</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineminus">-  _account: null,</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineminus">-</span>
<a href="#l68.92"></a><span id="l68.92" class="difflineminus">-  sendMsg(aMessage) {</span>
<a href="#l68.93"></a><span id="l68.93" class="difflineminus">-    if (!aMessage.length) {</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineminus">-      return;</span>
<a href="#l68.95"></a><span id="l68.95" class="difflineminus">-    }</span>
<a href="#l68.96"></a><span id="l68.96" class="difflineminus">-</span>
<a href="#l68.97"></a><span id="l68.97" class="difflineminus">-    let target = &quot;8:&quot; + this.name;</span>
<a href="#l68.98"></a><span id="l68.98" class="difflineminus">-    let url =</span>
<a href="#l68.99"></a><span id="l68.99" class="difflineminus">-      &quot;https://&quot; +</span>
<a href="#l68.100"></a><span id="l68.100" class="difflineminus">-      kMessagesHost +</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineminus">-      &quot;/v1/users/ME/conversations/&quot; +</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineminus">-      target +</span>
<a href="#l68.103"></a><span id="l68.103" class="difflineminus">-      &quot;/messages&quot;;</span>
<a href="#l68.104"></a><span id="l68.104" class="difflineminus">-</span>
<a href="#l68.105"></a><span id="l68.105" class="difflineminus">-    let clientMessageId = Date.now().toString();</span>
<a href="#l68.106"></a><span id="l68.106" class="difflineminus">-    let message = {</span>
<a href="#l68.107"></a><span id="l68.107" class="difflineminus">-      clientmessageid: clientMessageId,</span>
<a href="#l68.108"></a><span id="l68.108" class="difflineminus">-      content: aMessage,</span>
<a href="#l68.109"></a><span id="l68.109" class="difflineminus">-      messagetype: &quot;RichText&quot;,</span>
<a href="#l68.110"></a><span id="l68.110" class="difflineminus">-      contenttype: &quot;text&quot;,</span>
<a href="#l68.111"></a><span id="l68.111" class="difflineminus">-    };</span>
<a href="#l68.112"></a><span id="l68.112" class="difflineminus">-    let options = {</span>
<a href="#l68.113"></a><span id="l68.113" class="difflineminus">-      onLoad: (aResponse, aXhr) =&gt; {</span>
<a href="#l68.114"></a><span id="l68.114" class="difflineminus">-        this._account.LOG(&quot;Message response: &quot; + aResponse);</span>
<a href="#l68.115"></a><span id="l68.115" class="difflineminus">-        this._account.LOG(&quot;Successfully sent message: &quot; + aMessage);</span>
<a href="#l68.116"></a><span id="l68.116" class="difflineminus">-      },</span>
<a href="#l68.117"></a><span id="l68.117" class="difflineminus">-      onError: this._account._onHttpFailure(&quot;sending message&quot;),</span>
<a href="#l68.118"></a><span id="l68.118" class="difflineminus">-      postData: JSON.stringify(message),</span>
<a href="#l68.119"></a><span id="l68.119" class="difflineminus">-      logger: this._account.logger,</span>
<a href="#l68.120"></a><span id="l68.120" class="difflineminus">-    };</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineminus">-</span>
<a href="#l68.122"></a><span id="l68.122" class="difflineminus">-    // TODO Track the messages we sent?</span>
<a href="#l68.123"></a><span id="l68.123" class="difflineminus">-    this._account._messagesRequest(url, options);</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineminus">-  },</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineminus">-};</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineminus">-</span>
<a href="#l68.127"></a><span id="l68.127" class="difflineminus">-function SkypeAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l68.128"></a><span id="l68.128" class="difflineminus">-  aAccount.LOG(&quot;Creating account buddy for &quot; + aUserName);</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineminus">-</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineminus">-  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l68.131"></a><span id="l68.131" class="difflineminus">-}</span>
<a href="#l68.132"></a><span id="l68.132" class="difflineminus">-SkypeAccountBuddy.prototype = {</span>
<a href="#l68.133"></a><span id="l68.133" class="difflineminus">-  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l68.134"></a><span id="l68.134" class="difflineminus">-  _info: null,</span>
<a href="#l68.135"></a><span id="l68.135" class="difflineminus">-  mood: null,</span>
<a href="#l68.136"></a><span id="l68.136" class="difflineminus">-</span>
<a href="#l68.137"></a><span id="l68.137" class="difflineminus">-  // Called when the user wants to chat with the buddy.</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineminus">-  createConversation() {</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineminus">-    return this._account.createConversation(this.userName);</span>
<a href="#l68.140"></a><span id="l68.140" class="difflineminus">-  },</span>
<a href="#l68.141"></a><span id="l68.141" class="difflineminus">-</span>
<a href="#l68.142"></a><span id="l68.142" class="difflineminus">-  // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l68.143"></a><span id="l68.143" class="difflineminus">-  // hovers over the buddy.</span>
<a href="#l68.144"></a><span id="l68.144" class="difflineminus">-  getTooltipInfo() {</span>
<a href="#l68.145"></a><span id="l68.145" class="difflineminus">-    if (!this._info) {</span>
<a href="#l68.146"></a><span id="l68.146" class="difflineminus">-      return EmptyEnumerator;</span>
<a href="#l68.147"></a><span id="l68.147" class="difflineminus">-    }</span>
<a href="#l68.148"></a><span id="l68.148" class="difflineminus">-</span>
<a href="#l68.149"></a><span id="l68.149" class="difflineminus">-    let tooltipInfo = [];</span>
<a href="#l68.150"></a><span id="l68.150" class="difflineminus">-    for (let info in this._info) {</span>
<a href="#l68.151"></a><span id="l68.151" class="difflineminus">-      // If there's no value, skip the element.</span>
<a href="#l68.152"></a><span id="l68.152" class="difflineminus">-      if (!this._info[info]) {</span>
<a href="#l68.153"></a><span id="l68.153" class="difflineminus">-        continue;</span>
<a href="#l68.154"></a><span id="l68.154" class="difflineminus">-      }</span>
<a href="#l68.155"></a><span id="l68.155" class="difflineminus">-</span>
<a href="#l68.156"></a><span id="l68.156" class="difflineminus">-      // TODO Put real labels on here.</span>
<a href="#l68.157"></a><span id="l68.157" class="difflineminus">-      tooltipInfo.push(new TooltipInfo(info, this._info[info]));</span>
<a href="#l68.158"></a><span id="l68.158" class="difflineminus">-    }</span>
<a href="#l68.159"></a><span id="l68.159" class="difflineminus">-    if (this.mood) {</span>
<a href="#l68.160"></a><span id="l68.160" class="difflineminus">-      tooltipInfo.push(new TooltipInfo(&quot;Mood&quot;, this.mood));</span>
<a href="#l68.161"></a><span id="l68.161" class="difflineminus">-    }</span>
<a href="#l68.162"></a><span id="l68.162" class="difflineminus">-</span>
<a href="#l68.163"></a><span id="l68.163" class="difflineminus">-    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l68.164"></a><span id="l68.164" class="difflineminus">-  },</span>
<a href="#l68.165"></a><span id="l68.165" class="difflineminus">-</span>
<a href="#l68.166"></a><span id="l68.166" class="difflineminus">-  remove() {</span>
<a href="#l68.167"></a><span id="l68.167" class="difflineminus">-    this._account.removeBuddy(this);</span>
<a href="#l68.168"></a><span id="l68.168" class="difflineminus">-    GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l68.169"></a><span id="l68.169" class="difflineminus">-  },</span>
<a href="#l68.170"></a><span id="l68.170" class="difflineminus">-};</span>
<a href="#l68.171"></a><span id="l68.171" class="difflineminus">-</span>
<a href="#l68.172"></a><span id="l68.172" class="difflineminus">-/*</span>
<a href="#l68.173"></a><span id="l68.173" class="difflineminus">- * Cut out a part of a larger string bordered by aStart and aEnd. Returns an</span>
<a href="#l68.174"></a><span id="l68.174" class="difflineminus">- * empty string if the needle is not found.</span>
<a href="#l68.175"></a><span id="l68.175" class="difflineminus">- */</span>
<a href="#l68.176"></a><span id="l68.176" class="difflineminus">-function extractString(aStr, aStart, aEnd) {</span>
<a href="#l68.177"></a><span id="l68.177" class="difflineminus">-  // First find the start index, then offset by the string length.</span>
<a href="#l68.178"></a><span id="l68.178" class="difflineminus">-  let startIndex = aStr.indexOf(aStart) + aStart.length;</span>
<a href="#l68.179"></a><span id="l68.179" class="difflineminus">-  if (startIndex == -1) {</span>
<a href="#l68.180"></a><span id="l68.180" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l68.181"></a><span id="l68.181" class="difflineminus">-  }</span>
<a href="#l68.182"></a><span id="l68.182" class="difflineminus">-  // Now find the next occurrence of end after the start.</span>
<a href="#l68.183"></a><span id="l68.183" class="difflineminus">-  let endIndex = aStr.indexOf(aEnd, startIndex);</span>
<a href="#l68.184"></a><span id="l68.184" class="difflineminus">-  if (endIndex == -1) {</span>
<a href="#l68.185"></a><span id="l68.185" class="difflineminus">-    return &quot;&quot;;</span>
<a href="#l68.186"></a><span id="l68.186" class="difflineminus">-  }</span>
<a href="#l68.187"></a><span id="l68.187" class="difflineminus">-</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineminus">-  return aStr.slice(startIndex, endIndex);</span>
<a href="#l68.189"></a><span id="l68.189" class="difflineminus">-}</span>
<a href="#l68.190"></a><span id="l68.190" class="difflineminus">-</span>
<a href="#l68.191"></a><span id="l68.191" class="difflineminus">-/*</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineminus">- * A magic method (originally from MSN) to stop 3rd parties from connecting.</span>
<a href="#l68.193"></a><span id="l68.193" class="difflineminus">- * Differs from MSN by swapping MD5 for SHA256.</span>
<a href="#l68.194"></a><span id="l68.194" class="difflineminus">- *</span>
<a href="#l68.195"></a><span id="l68.195" class="difflineminus">- * A pre-emptive apology is necessary for those about to embark on the journey</span>
<a href="#l68.196"></a><span id="l68.196" class="difflineminus">- * of understanding this code. I wish you luck and God's speed.</span>
<a href="#l68.197"></a><span id="l68.197" class="difflineminus">- */</span>
<a href="#l68.198"></a><span id="l68.198" class="difflineminus">-function magicSha256(aInput) {</span>
<a href="#l68.199"></a><span id="l68.199" class="difflineminus">-  let productId = kLockAndKeyAppId;</span>
<a href="#l68.200"></a><span id="l68.200" class="difflineminus">-</span>
<a href="#l68.201"></a><span id="l68.201" class="difflineminus">-  // Create a SHA 256 hash.</span>
<a href="#l68.202"></a><span id="l68.202" class="difflineminus">-  let converter = Cc[</span>
<a href="#l68.203"></a><span id="l68.203" class="difflineminus">-    &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l68.204"></a><span id="l68.204" class="difflineminus">-  ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l68.205"></a><span id="l68.205" class="difflineminus">-  converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l68.206"></a><span id="l68.206" class="difflineminus">-  let data = converter.convertToByteArray(aInput);</span>
<a href="#l68.207"></a><span id="l68.207" class="difflineminus">-  let productKey = converter.convertToByteArray(kLockAndKeySecret);</span>
<a href="#l68.208"></a><span id="l68.208" class="difflineminus">-</span>
<a href="#l68.209"></a><span id="l68.209" class="difflineminus">-  let hash = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l68.210"></a><span id="l68.210" class="difflineminus">-    Ci.nsICryptoHash</span>
<a href="#l68.211"></a><span id="l68.211" class="difflineminus">-  );</span>
<a href="#l68.212"></a><span id="l68.212" class="difflineminus">-  hash.init(hash.SHA256);</span>
<a href="#l68.213"></a><span id="l68.213" class="difflineminus">-  hash.update(data, data.length);</span>
<a href="#l68.214"></a><span id="l68.214" class="difflineminus">-  hash.update(productKey, productKey.length);</span>
<a href="#l68.215"></a><span id="l68.215" class="difflineminus">-  // Finalize the hash as a set of bytes.</span>
<a href="#l68.216"></a><span id="l68.216" class="difflineminus">-  let sha256Hash = hash.finish(false);</span>
<a href="#l68.217"></a><span id="l68.217" class="difflineminus">-</span>
<a href="#l68.218"></a><span id="l68.218" class="difflineminus">-  // Split it into four integers (note that this ignores the second half of the</span>
<a href="#l68.219"></a><span id="l68.219" class="difflineminus">-  // hash).</span>
<a href="#l68.220"></a><span id="l68.220" class="difflineminus">-  let sha256Buffer = StringToArrayBuffer(sha256Hash);</span>
<a href="#l68.221"></a><span id="l68.221" class="difflineminus">-  let view = new DataView(sha256Buffer, 0, 16);</span>
<a href="#l68.222"></a><span id="l68.222" class="difflineminus">-</span>
<a href="#l68.223"></a><span id="l68.223" class="difflineminus">-  let sha256Parts = [];</span>
<a href="#l68.224"></a><span id="l68.224" class="difflineminus">-  let newHashParts = [];</span>
<a href="#l68.225"></a><span id="l68.225" class="difflineminus">-  for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l68.226"></a><span id="l68.226" class="difflineminus">-    // Ensure little-endianness is used.</span>
<a href="#l68.227"></a><span id="l68.227" class="difflineminus">-    sha256Parts.push(view.getUint32(i * 4, true));</span>
<a href="#l68.228"></a><span id="l68.228" class="difflineminus">-</span>
<a href="#l68.229"></a><span id="l68.229" class="difflineminus">-    newHashParts.push(sha256Parts[i]);</span>
<a href="#l68.230"></a><span id="l68.230" class="difflineminus">-    sha256Parts[i] &amp;= 0x7fffffff;</span>
<a href="#l68.231"></a><span id="l68.231" class="difflineminus">-  }</span>
<a href="#l68.232"></a><span id="l68.232" class="difflineminus">-</span>
<a href="#l68.233"></a><span id="l68.233" class="difflineminus">-  // Make a new string and pad with '0' to a length that's a multiple of 8.</span>
<a href="#l68.234"></a><span id="l68.234" class="difflineminus">-  let buf = aInput + productId;</span>
<a href="#l68.235"></a><span id="l68.235" class="difflineminus">-  let len = buf.length;</span>
<a href="#l68.236"></a><span id="l68.236" class="difflineminus">-  let modLen = len % 8;</span>
<a href="#l68.237"></a><span id="l68.237" class="difflineminus">-  if (modLen != 0) {</span>
<a href="#l68.238"></a><span id="l68.238" class="difflineminus">-    let fix = 8 - modLen;</span>
<a href="#l68.239"></a><span id="l68.239" class="difflineminus">-    buf += &quot;0&quot;.repeat(fix);</span>
<a href="#l68.240"></a><span id="l68.240" class="difflineminus">-    len += fix;</span>
<a href="#l68.241"></a><span id="l68.241" class="difflineminus">-  }</span>
<a href="#l68.242"></a><span id="l68.242" class="difflineminus">-</span>
<a href="#l68.243"></a><span id="l68.243" class="difflineminus">-  // Split into integers.</span>
<a href="#l68.244"></a><span id="l68.244" class="difflineminus">-  view = new DataView(StringToArrayBuffer(buf));</span>
<a href="#l68.245"></a><span id="l68.245" class="difflineminus">-</span>
<a href="#l68.246"></a><span id="l68.246" class="difflineminus">-  // This is magic.</span>
<a href="#l68.247"></a><span id="l68.247" class="difflineminus">-  let nHigh = bigInt(0);</span>
<a href="#l68.248"></a><span id="l68.248" class="difflineminus">-  let nLow = bigInt(0);</span>
<a href="#l68.249"></a><span id="l68.249" class="difflineminus">-  for (let i = 0; i &lt; len / 4; i += 2) {</span>
<a href="#l68.250"></a><span id="l68.250" class="difflineminus">-    let temp = bigInt(0x0e79a9c1)</span>
<a href="#l68.251"></a><span id="l68.251" class="difflineminus">-      .times(view.getUint32(i * 4, true))</span>
<a href="#l68.252"></a><span id="l68.252" class="difflineminus">-      .divmod(0x7fffffff).remainder;</span>
<a href="#l68.253"></a><span id="l68.253" class="difflineminus">-    temp = temp</span>
<a href="#l68.254"></a><span id="l68.254" class="difflineminus">-      .plus(nLow)</span>
<a href="#l68.255"></a><span id="l68.255" class="difflineminus">-      .times(sha256Parts[0])</span>
<a href="#l68.256"></a><span id="l68.256" class="difflineminus">-      .plus(sha256Parts[1])</span>
<a href="#l68.257"></a><span id="l68.257" class="difflineminus">-      .divmod(0x7fffffff).remainder;</span>
<a href="#l68.258"></a><span id="l68.258" class="difflineminus">-    nHigh = nHigh.plus(temp);</span>
<a href="#l68.259"></a><span id="l68.259" class="difflineminus">-</span>
<a href="#l68.260"></a><span id="l68.260" class="difflineminus">-    temp = temp.plus(view.getUint32((i + 1) * 4, true)).divmod(0x7fffffff)</span>
<a href="#l68.261"></a><span id="l68.261" class="difflineminus">-      .remainder;</span>
<a href="#l68.262"></a><span id="l68.262" class="difflineminus">-    nLow = temp</span>
<a href="#l68.263"></a><span id="l68.263" class="difflineminus">-      .times(sha256Parts[2])</span>
<a href="#l68.264"></a><span id="l68.264" class="difflineminus">-      .plus(sha256Parts[3])</span>
<a href="#l68.265"></a><span id="l68.265" class="difflineminus">-      .divmod(0x7fffffff).remainder;</span>
<a href="#l68.266"></a><span id="l68.266" class="difflineminus">-    nHigh = nHigh.plus(nLow);</span>
<a href="#l68.267"></a><span id="l68.267" class="difflineminus">-  }</span>
<a href="#l68.268"></a><span id="l68.268" class="difflineminus">-  nLow = nLow</span>
<a href="#l68.269"></a><span id="l68.269" class="difflineminus">-    .plus(sha256Parts[1])</span>
<a href="#l68.270"></a><span id="l68.270" class="difflineminus">-    .divmod(0x7fffffff)</span>
<a href="#l68.271"></a><span id="l68.271" class="difflineminus">-    .remainder.toJSNumber();</span>
<a href="#l68.272"></a><span id="l68.272" class="difflineminus">-  nHigh = nHigh</span>
<a href="#l68.273"></a><span id="l68.273" class="difflineminus">-    .plus(sha256Parts[3])</span>
<a href="#l68.274"></a><span id="l68.274" class="difflineminus">-    .divmod(0x7fffffff)</span>
<a href="#l68.275"></a><span id="l68.275" class="difflineminus">-    .remainder.toJSNumber();</span>
<a href="#l68.276"></a><span id="l68.276" class="difflineminus">-</span>
<a href="#l68.277"></a><span id="l68.277" class="difflineminus">-  newHashParts[0] ^= nLow;</span>
<a href="#l68.278"></a><span id="l68.278" class="difflineminus">-  newHashParts[1] ^= nHigh;</span>
<a href="#l68.279"></a><span id="l68.279" class="difflineminus">-  newHashParts[2] ^= nLow;</span>
<a href="#l68.280"></a><span id="l68.280" class="difflineminus">-  newHashParts[3] ^= nHigh;</span>
<a href="#l68.281"></a><span id="l68.281" class="difflineminus">-</span>
<a href="#l68.282"></a><span id="l68.282" class="difflineminus">-  // Make a string of the parts and convert to hexadecimal.</span>
<a href="#l68.283"></a><span id="l68.283" class="difflineminus">-  let output = &quot;&quot;;</span>
<a href="#l68.284"></a><span id="l68.284" class="difflineminus">-  for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l68.285"></a><span id="l68.285" class="difflineminus">-    let part = newHashParts[i];</span>
<a href="#l68.286"></a><span id="l68.286" class="difflineminus">-    // Adjust to little-endianness.</span>
<a href="#l68.287"></a><span id="l68.287" class="difflineminus">-    part =</span>
<a href="#l68.288"></a><span id="l68.288" class="difflineminus">-      ((part &amp; 0xff) &lt;&lt; 24) |</span>
<a href="#l68.289"></a><span id="l68.289" class="difflineminus">-      ((part &amp; 0xff00) &lt;&lt; 8) |</span>
<a href="#l68.290"></a><span id="l68.290" class="difflineminus">-      ((part &gt;&gt; 8) &amp; 0xff00) |</span>
<a href="#l68.291"></a><span id="l68.291" class="difflineminus">-      ((part &gt;&gt; 24) &amp; 0xff);</span>
<a href="#l68.292"></a><span id="l68.292" class="difflineminus">-</span>
<a href="#l68.293"></a><span id="l68.293" class="difflineminus">-    // JavaScript likes to use signed numbers, force this to give us the</span>
<a href="#l68.294"></a><span id="l68.294" class="difflineminus">-    // unsigned representation.</span>
<a href="#l68.295"></a><span id="l68.295" class="difflineminus">-    if (part &lt; 0) {</span>
<a href="#l68.296"></a><span id="l68.296" class="difflineminus">-      part += 0xffffffff + 1;</span>
<a href="#l68.297"></a><span id="l68.297" class="difflineminus">-    }</span>
<a href="#l68.298"></a><span id="l68.298" class="difflineminus">-</span>
<a href="#l68.299"></a><span id="l68.299" class="difflineminus">-    let hexPart = part.toString(16);</span>
<a href="#l68.300"></a><span id="l68.300" class="difflineminus">-    // Ensure that the string has 8 characters (4 bytes).</span>
<a href="#l68.301"></a><span id="l68.301" class="difflineminus">-    output += &quot;0&quot;.repeat(8 - hexPart.length) + hexPart;</span>
<a href="#l68.302"></a><span id="l68.302" class="difflineminus">-  }</span>
<a href="#l68.303"></a><span id="l68.303" class="difflineminus">-</span>
<a href="#l68.304"></a><span id="l68.304" class="difflineminus">-  return output;</span>
<a href="#l68.305"></a><span id="l68.305" class="difflineminus">-}</span>
<a href="#l68.306"></a><span id="l68.306" class="difflineminus">-</span>
<a href="#l68.307"></a><span id="l68.307" class="difflineminus">-// TODO Add tests for this function.</span>
<a href="#l68.308"></a><span id="l68.308" class="difflineminus">-// Calculate the timezone offset of the local computer as [+-]HH:MM.</span>
<a href="#l68.309"></a><span id="l68.309" class="difflineminus">-function getTimezone() {</span>
<a href="#l68.310"></a><span id="l68.310" class="difflineminus">-  /*</span>
<a href="#l68.311"></a><span id="l68.311" class="difflineminus">-   * Zero-pad aNum to the length of aLen.</span>
<a href="#l68.312"></a><span id="l68.312" class="difflineminus">-   */</span>
<a href="#l68.313"></a><span id="l68.313" class="difflineminus">-  function zeroPad(aNum, aLen) {</span>
<a href="#l68.314"></a><span id="l68.314" class="difflineminus">-    let nStr = aNum.toString();</span>
<a href="#l68.315"></a><span id="l68.315" class="difflineminus">-    let nLen = nStr.length;</span>
<a href="#l68.316"></a><span id="l68.316" class="difflineminus">-</span>
<a href="#l68.317"></a><span id="l68.317" class="difflineminus">-    if (nLen &gt; aLen) {</span>
<a href="#l68.318"></a><span id="l68.318" class="difflineminus">-      throw new Error(</span>
<a href="#l68.319"></a><span id="l68.319" class="difflineminus">-        &quot;Can't zero-pad when longer than expected length: &quot; +</span>
<a href="#l68.320"></a><span id="l68.320" class="difflineminus">-          nStr +</span>
<a href="#l68.321"></a><span id="l68.321" class="difflineminus">-          &quot;.length &gt; &quot; +</span>
<a href="#l68.322"></a><span id="l68.322" class="difflineminus">-          aLen</span>
<a href="#l68.323"></a><span id="l68.323" class="difflineminus">-      );</span>
<a href="#l68.324"></a><span id="l68.324" class="difflineminus">-    }</span>
<a href="#l68.325"></a><span id="l68.325" class="difflineminus">-</span>
<a href="#l68.326"></a><span id="l68.326" class="difflineminus">-    return &quot;0&quot;.repeat(aLen - nLen) + nStr;</span>
<a href="#l68.327"></a><span id="l68.327" class="difflineminus">-  }</span>
<a href="#l68.328"></a><span id="l68.328" class="difflineminus">-</span>
<a href="#l68.329"></a><span id="l68.329" class="difflineminus">-  // Invert the sign of the timezone from JavaScript's date object.</span>
<a href="#l68.330"></a><span id="l68.330" class="difflineminus">-  let sign = &quot;+&quot;;</span>
<a href="#l68.331"></a><span id="l68.331" class="difflineminus">-  let timezone = new Date().getTimezoneOffset() * -1;</span>
<a href="#l68.332"></a><span id="l68.332" class="difflineminus">-  if (timezone &lt; 0) {</span>
<a href="#l68.333"></a><span id="l68.333" class="difflineminus">-    sign = &quot;-&quot;;</span>
<a href="#l68.334"></a><span id="l68.334" class="difflineminus">-  }</span>
<a href="#l68.335"></a><span id="l68.335" class="difflineminus">-  timezone = Math.abs(timezone);</span>
<a href="#l68.336"></a><span id="l68.336" class="difflineminus">-</span>
<a href="#l68.337"></a><span id="l68.337" class="difflineminus">-  // Separate the timezone into hours and minutes.</span>
<a href="#l68.338"></a><span id="l68.338" class="difflineminus">-  let minutes = timezone % 60;</span>
<a href="#l68.339"></a><span id="l68.339" class="difflineminus">-  let hours = (timezone - minutes) / 60;</span>
<a href="#l68.340"></a><span id="l68.340" class="difflineminus">-</span>
<a href="#l68.341"></a><span id="l68.341" class="difflineminus">-  // Ensure both hours and minutes are two digits long.</span>
<a href="#l68.342"></a><span id="l68.342" class="difflineminus">-  minutes = zeroPad(minutes, 2);</span>
<a href="#l68.343"></a><span id="l68.343" class="difflineminus">-  hours = zeroPad(hours, 2);</span>
<a href="#l68.344"></a><span id="l68.344" class="difflineminus">-</span>
<a href="#l68.345"></a><span id="l68.345" class="difflineminus">-  // The final timezone string.</span>
<a href="#l68.346"></a><span id="l68.346" class="difflineminus">-  return sign + hours + &quot;|&quot; + minutes;</span>
<a href="#l68.347"></a><span id="l68.347" class="difflineminus">-}</span>
<a href="#l68.348"></a><span id="l68.348" class="difflineminus">-</span>
<a href="#l68.349"></a><span id="l68.349" class="difflineminus">-function SkypeAccount(aProtoInstance, aImAccount) {</span>
<a href="#l68.350"></a><span id="l68.350" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l68.351"></a><span id="l68.351" class="difflineminus">-</span>
<a href="#l68.352"></a><span id="l68.352" class="difflineminus">-  // Initialize some maps.</span>
<a href="#l68.353"></a><span id="l68.353" class="difflineminus">-  this._buddies = new Map();</span>
<a href="#l68.354"></a><span id="l68.354" class="difflineminus">-  this._conversations = new Map();</span>
<a href="#l68.355"></a><span id="l68.355" class="difflineminus">-  this._chats = new Map();</span>
<a href="#l68.356"></a><span id="l68.356" class="difflineminus">-</span>
<a href="#l68.357"></a><span id="l68.357" class="difflineminus">-  this._logger = { log: this.LOG.bind(this), debug: this.DEBUG.bind(this) };</span>
<a href="#l68.358"></a><span id="l68.358" class="difflineminus">-}</span>
<a href="#l68.359"></a><span id="l68.359" class="difflineminus">-SkypeAccount.prototype = {</span>
<a href="#l68.360"></a><span id="l68.360" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l68.361"></a><span id="l68.361" class="difflineminus">-  // A Map holding the list of buddies associated with their usernames.</span>
<a href="#l68.362"></a><span id="l68.362" class="difflineminus">-  _buddies: null,</span>
<a href="#l68.363"></a><span id="l68.363" class="difflineminus">-  // A Map holding the list of open conversations by the username of the buddy.</span>
<a href="#l68.364"></a><span id="l68.364" class="difflineminus">-  _conversations: null,</span>
<a href="#l68.365"></a><span id="l68.365" class="difflineminus">-  // A Map holding the list of open (multiple user) chats by name.</span>
<a href="#l68.366"></a><span id="l68.366" class="difflineminus">-  _chats: null,</span>
<a href="#l68.367"></a><span id="l68.367" class="difflineminus">-  // The current request in the polling loop.</span>
<a href="#l68.368"></a><span id="l68.368" class="difflineminus">-  _request: null,</span>
<a href="#l68.369"></a><span id="l68.369" class="difflineminus">-  // The timer for the next poll.</span>
<a href="#l68.370"></a><span id="l68.370" class="difflineminus">-  _poller: null,</span>
<a href="#l68.371"></a><span id="l68.371" class="difflineminus">-</span>
<a href="#l68.372"></a><span id="l68.372" class="difflineminus">-  // Some tokens.</span>
<a href="#l68.373"></a><span id="l68.373" class="difflineminus">-  _skypeToken: null,</span>
<a href="#l68.374"></a><span id="l68.374" class="difflineminus">-  _registrationToken: null,</span>
<a href="#l68.375"></a><span id="l68.375" class="difflineminus">-</span>
<a href="#l68.376"></a><span id="l68.376" class="difflineminus">-  // Logger used for HTTP requests.</span>
<a href="#l68.377"></a><span id="l68.377" class="difflineminus">-  _logger: null,</span>
<a href="#l68.378"></a><span id="l68.378" class="difflineminus">-</span>
<a href="#l68.379"></a><span id="l68.379" class="difflineminus">-  mapStatusString(aStatus) {</span>
<a href="#l68.380"></a><span id="l68.380" class="difflineminus">-    if (aStatus in kStatusMap) {</span>
<a href="#l68.381"></a><span id="l68.381" class="difflineminus">-      return Ci.imIStatusInfo[&quot;STATUS_&quot; + kStatusMap[aStatus]];</span>
<a href="#l68.382"></a><span id="l68.382" class="difflineminus">-    }</span>
<a href="#l68.383"></a><span id="l68.383" class="difflineminus">-</span>
<a href="#l68.384"></a><span id="l68.384" class="difflineminus">-    // Uh-oh, we got something not in the map.</span>
<a href="#l68.385"></a><span id="l68.385" class="difflineminus">-    this.WARN(&quot;Received unknown status type: &quot; + aStatus);</span>
<a href="#l68.386"></a><span id="l68.386" class="difflineminus">-    return Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l68.387"></a><span id="l68.387" class="difflineminus">-  },</span>
<a href="#l68.388"></a><span id="l68.388" class="difflineminus">-</span>
<a href="#l68.389"></a><span id="l68.389" class="difflineminus">-  connect() {</span>
<a href="#l68.390"></a><span id="l68.390" class="difflineminus">-    this.reportConnecting();</span>
<a href="#l68.391"></a><span id="l68.391" class="difflineminus">-</span>
<a href="#l68.392"></a><span id="l68.392" class="difflineminus">-    this.LOG(&quot;STARTING Login&quot;);</span>
<a href="#l68.393"></a><span id="l68.393" class="difflineminus">-</span>
<a href="#l68.394"></a><span id="l68.394" class="difflineminus">-    // Perform the request to get the session token values.</span>
<a href="#l68.395"></a><span id="l68.395" class="difflineminus">-    let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l68.396"></a><span id="l68.396" class="difflineminus">-    let options = {</span>
<a href="#l68.397"></a><span id="l68.397" class="difflineminus">-      onLoad: this._onPieResponse.bind(this),</span>
<a href="#l68.398"></a><span id="l68.398" class="difflineminus">-      onError: this._onHttpFailure(&quot;requesting pie&quot;),</span>
<a href="#l68.399"></a><span id="l68.399" class="difflineminus">-      logger: this.logger,</span>
<a href="#l68.400"></a><span id="l68.400" class="difflineminus">-    };</span>
<a href="#l68.401"></a><span id="l68.401" class="difflineminus">-    httpRequest(loginUrl, options);</span>
<a href="#l68.402"></a><span id="l68.402" class="difflineminus">-  },</span>
<a href="#l68.403"></a><span id="l68.403" class="difflineminus">-</span>
<a href="#l68.404"></a><span id="l68.404" class="difflineminus">-  /*</span>
<a href="#l68.405"></a><span id="l68.405" class="difflineminus">-   * Generates a callback which causes the account to enter an error state with</span>
<a href="#l68.406"></a><span id="l68.406" class="difflineminus">-   * the given error string.</span>
<a href="#l68.407"></a><span id="l68.407" class="difflineminus">-   */</span>
<a href="#l68.408"></a><span id="l68.408" class="difflineminus">-  _onHttpFailure(aErrorStr) {</span>
<a href="#l68.409"></a><span id="l68.409" class="difflineminus">-    return (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l68.410"></a><span id="l68.410" class="difflineminus">-      this.ERROR(&quot;HTTP failure occurred: &quot; + aErrorStr + &quot;\n&quot; + aError);</span>
<a href="#l68.411"></a><span id="l68.411" class="difflineminus">-      this._disconnectWithAuthFailure();</span>
<a href="#l68.412"></a><span id="l68.412" class="difflineminus">-    };</span>
<a href="#l68.413"></a><span id="l68.413" class="difflineminus">-  },</span>
<a href="#l68.414"></a><span id="l68.414" class="difflineminus">-</span>
<a href="#l68.415"></a><span id="l68.415" class="difflineminus">-  _onHttpError(aError, aResponse, aXhr) {</span>
<a href="#l68.416"></a><span id="l68.416" class="difflineminus">-    this.ERROR(&quot;Received error response:\n&quot; + aError);</span>
<a href="#l68.417"></a><span id="l68.417" class="difflineminus">-  },</span>
<a href="#l68.418"></a><span id="l68.418" class="difflineminus">-</span>
<a href="#l68.419"></a><span id="l68.419" class="difflineminus">-  // Mmmmm...pie.</span>
<a href="#l68.420"></a><span id="l68.420" class="difflineminus">-  _onPieResponse(aResponse, aXhr) {</span>
<a href="#l68.421"></a><span id="l68.421" class="difflineminus">-    this.reportConnecting(_(&quot;connecting.authenticating&quot;));</span>
<a href="#l68.422"></a><span id="l68.422" class="difflineminus">-</span>
<a href="#l68.423"></a><span id="l68.423" class="difflineminus">-    // Parse the pie/etm and do the actual login.</span>
<a href="#l68.424"></a><span id="l68.424" class="difflineminus">-    let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l68.425"></a><span id="l68.425" class="difflineminus">-</span>
<a href="#l68.426"></a><span id="l68.426" class="difflineminus">-    let params = [</span>
<a href="#l68.427"></a><span id="l68.427" class="difflineminus">-      [&quot;client_id&quot;, kClientId],</span>
<a href="#l68.428"></a><span id="l68.428" class="difflineminus">-      [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l68.429"></a><span id="l68.429" class="difflineminus">-    ];</span>
<a href="#l68.430"></a><span id="l68.430" class="difflineminus">-    loginUrl +=</span>
<a href="#l68.431"></a><span id="l68.431" class="difflineminus">-      &quot;?&quot; + params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l68.432"></a><span id="l68.432" class="difflineminus">-</span>
<a href="#l68.433"></a><span id="l68.433" class="difflineminus">-    this.LOG(&quot;Received PIE response:\n&quot; + aResponse);</span>
<a href="#l68.434"></a><span id="l68.434" class="difflineminus">-</span>
<a href="#l68.435"></a><span id="l68.435" class="difflineminus">-    // Note that the response is really just an HTML page with some JavaScript</span>
<a href="#l68.436"></a><span id="l68.436" class="difflineminus">-    // and forms that these values are being pulled from.</span>
<a href="#l68.437"></a><span id="l68.437" class="difflineminus">-    let pie = extractString(aResponse, '=&quot;pie&quot; value=&quot;', '&quot;');</span>
<a href="#l68.438"></a><span id="l68.438" class="difflineminus">-    if (!pie) {</span>
<a href="#l68.439"></a><span id="l68.439" class="difflineminus">-      this.ERROR(&quot;pie value not found.&quot;);</span>
<a href="#l68.440"></a><span id="l68.440" class="difflineminus">-      this._disconnectWithAuthFailure();</span>
<a href="#l68.441"></a><span id="l68.441" class="difflineminus">-      return;</span>
<a href="#l68.442"></a><span id="l68.442" class="difflineminus">-    }</span>
<a href="#l68.443"></a><span id="l68.443" class="difflineminus">-    let etm = extractString(aResponse, '=&quot;etm&quot; value=&quot;', '&quot;');</span>
<a href="#l68.444"></a><span id="l68.444" class="difflineminus">-    if (!etm) {</span>
<a href="#l68.445"></a><span id="l68.445" class="difflineminus">-      this.ERROR(&quot;etm value not found.&quot;);</span>
<a href="#l68.446"></a><span id="l68.446" class="difflineminus">-      this._disconnectWithAuthFailure();</span>
<a href="#l68.447"></a><span id="l68.447" class="difflineminus">-      return;</span>
<a href="#l68.448"></a><span id="l68.448" class="difflineminus">-    }</span>
<a href="#l68.449"></a><span id="l68.449" class="difflineminus">-</span>
<a href="#l68.450"></a><span id="l68.450" class="difflineminus">-    let options = {</span>
<a href="#l68.451"></a><span id="l68.451" class="difflineminus">-      onLoad: this._onLoginResponse.bind(this),</span>
<a href="#l68.452"></a><span id="l68.452" class="difflineminus">-      onError: this._onHttpFailure(&quot;requesting skypetoken&quot;),</span>
<a href="#l68.453"></a><span id="l68.453" class="difflineminus">-      postData: [</span>
<a href="#l68.454"></a><span id="l68.454" class="difflineminus">-        [&quot;username&quot;, this.name],</span>
<a href="#l68.455"></a><span id="l68.455" class="difflineminus">-        [&quot;password&quot;, this.imAccount.password],</span>
<a href="#l68.456"></a><span id="l68.456" class="difflineminus">-        [&quot;timezone_field&quot;, getTimezone()],</span>
<a href="#l68.457"></a><span id="l68.457" class="difflineminus">-        [&quot;pie&quot;, pie],</span>
<a href="#l68.458"></a><span id="l68.458" class="difflineminus">-        [&quot;etm&quot;, etm],</span>
<a href="#l68.459"></a><span id="l68.459" class="difflineminus">-        [&quot;js_time&quot;, Date.now()],</span>
<a href="#l68.460"></a><span id="l68.460" class="difflineminus">-        [&quot;client_id&quot;, kClientId],</span>
<a href="#l68.461"></a><span id="l68.461" class="difflineminus">-        [&quot;redirect_uri&quot;, &quot;https://web.skype.com/&quot;],</span>
<a href="#l68.462"></a><span id="l68.462" class="difflineminus">-      ],</span>
<a href="#l68.463"></a><span id="l68.463" class="difflineminus">-      headers: [</span>
<a href="#l68.464"></a><span id="l68.464" class="difflineminus">-        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l68.465"></a><span id="l68.465" class="difflineminus">-        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l68.466"></a><span id="l68.466" class="difflineminus">-        // response from doing a 302 Found Location redirect, since</span>
<a href="#l68.467"></a><span id="l68.467" class="difflineminus">-        // there are important headers that need to be plucked before</span>
<a href="#l68.468"></a><span id="l68.468" class="difflineminus">-        // the redirect happens.</span>
<a href="#l68.469"></a><span id="l68.469" class="difflineminus">-        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l68.470"></a><span id="l68.470" class="difflineminus">-      ],</span>
<a href="#l68.471"></a><span id="l68.471" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.472"></a><span id="l68.472" class="difflineminus">-    };</span>
<a href="#l68.473"></a><span id="l68.473" class="difflineminus">-    httpRequest(loginUrl, options);</span>
<a href="#l68.474"></a><span id="l68.474" class="difflineminus">-  },</span>
<a href="#l68.475"></a><span id="l68.475" class="difflineminus">-  _onLoginResponse(aResponse, aXhr) {</span>
<a href="#l68.476"></a><span id="l68.476" class="difflineminus">-    this.LOG(&quot;Received LOGIN response:\n&quot; + aResponse);</span>
<a href="#l68.477"></a><span id="l68.477" class="difflineminus">-</span>
<a href="#l68.478"></a><span id="l68.478" class="difflineminus">-    let refreshToken = extractString(aResponse, '=&quot;skypetoken&quot; value=&quot;', '&quot;');</span>
<a href="#l68.479"></a><span id="l68.479" class="difflineminus">-    if (!refreshToken) {</span>
<a href="#l68.480"></a><span id="l68.480" class="difflineminus">-      this.ERROR(&quot;skypetoken value not found.&quot;);</span>
<a href="#l68.481"></a><span id="l68.481" class="difflineminus">-      this._disconnectWithAuthFailure();</span>
<a href="#l68.482"></a><span id="l68.482" class="difflineminus">-      return;</span>
<a href="#l68.483"></a><span id="l68.483" class="difflineminus">-    }</span>
<a href="#l68.484"></a><span id="l68.484" class="difflineminus">-</span>
<a href="#l68.485"></a><span id="l68.485" class="difflineminus">-    // All done!</span>
<a href="#l68.486"></a><span id="l68.486" class="difflineminus">-    this._skypeToken = refreshToken;</span>
<a href="#l68.487"></a><span id="l68.487" class="difflineminus">-    this.LOG(&quot;Received Skype token: &quot; + this._skypeToken);</span>
<a href="#l68.488"></a><span id="l68.488" class="difflineminus">-</span>
<a href="#l68.489"></a><span id="l68.489" class="difflineminus">-    if (this._registrationToken) {</span>
<a href="#l68.490"></a><span id="l68.490" class="difflineminus">-      // Subscribe to receive particular events.</span>
<a href="#l68.491"></a><span id="l68.491" class="difflineminus">-      this._subscribe();</span>
<a href="#l68.492"></a><span id="l68.492" class="difflineminus">-      return;</span>
<a href="#l68.493"></a><span id="l68.493" class="difflineminus">-    }</span>
<a href="#l68.494"></a><span id="l68.494" class="difflineminus">-</span>
<a href="#l68.495"></a><span id="l68.495" class="difflineminus">-    this.reportConnecting(_(&quot;connecting.registrationToken&quot;));</span>
<a href="#l68.496"></a><span id="l68.496" class="difflineminus">-</span>
<a href="#l68.497"></a><span id="l68.497" class="difflineminus">-    // Request the registration token.</span>
<a href="#l68.498"></a><span id="l68.498" class="difflineminus">-    let messagesUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints&quot;;</span>
<a href="#l68.499"></a><span id="l68.499" class="difflineminus">-    // The current time in seconds, converted to a string.</span>
<a href="#l68.500"></a><span id="l68.500" class="difflineminus">-    let curTime = String(Math.floor(Date.now() / 1000));</span>
<a href="#l68.501"></a><span id="l68.501" class="difflineminus">-    let response = magicSha256(curTime);</span>
<a href="#l68.502"></a><span id="l68.502" class="difflineminus">-    let options = {</span>
<a href="#l68.503"></a><span id="l68.503" class="difflineminus">-      onLoad: this._onRegistrationTokenReceived.bind(this),</span>
<a href="#l68.504"></a><span id="l68.504" class="difflineminus">-      onError: (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l68.505"></a><span id="l68.505" class="difflineminus">-        this.ERROR(</span>
<a href="#l68.506"></a><span id="l68.506" class="difflineminus">-          &quot;HTTP failure occurred: requesting registration token\n&quot; + aError</span>
<a href="#l68.507"></a><span id="l68.507" class="difflineminus">-        );</span>
<a href="#l68.508"></a><span id="l68.508" class="difflineminus">-        this._disconnectWithAuthFailure(&quot;error.registrationToken&quot;);</span>
<a href="#l68.509"></a><span id="l68.509" class="difflineminus">-      },</span>
<a href="#l68.510"></a><span id="l68.510" class="difflineminus">-      postData: &quot;{}&quot;, // Empty JSON object.</span>
<a href="#l68.511"></a><span id="l68.511" class="difflineminus">-      headers: [</span>
<a href="#l68.512"></a><span id="l68.512" class="difflineminus">-        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l68.513"></a><span id="l68.513" class="difflineminus">-        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l68.514"></a><span id="l68.514" class="difflineminus">-        // response from doing a 302 Found Location redirect, since</span>
<a href="#l68.515"></a><span id="l68.515" class="difflineminus">-        // there are important headers that need to be plucked before</span>
<a href="#l68.516"></a><span id="l68.516" class="difflineminus">-        // the redirect happens.</span>
<a href="#l68.517"></a><span id="l68.517" class="difflineminus">-        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l68.518"></a><span id="l68.518" class="difflineminus">-        [</span>
<a href="#l68.519"></a><span id="l68.519" class="difflineminus">-          &quot;LockAndKey&quot;,</span>
<a href="#l68.520"></a><span id="l68.520" class="difflineminus">-          &quot;appId=&quot; +</span>
<a href="#l68.521"></a><span id="l68.521" class="difflineminus">-            kLockAndKeyAppId +</span>
<a href="#l68.522"></a><span id="l68.522" class="difflineminus">-            &quot;; time=&quot; +</span>
<a href="#l68.523"></a><span id="l68.523" class="difflineminus">-            curTime +</span>
<a href="#l68.524"></a><span id="l68.524" class="difflineminus">-            &quot;; lockAndKeyResponse=&quot; +</span>
<a href="#l68.525"></a><span id="l68.525" class="difflineminus">-            response,</span>
<a href="#l68.526"></a><span id="l68.526" class="difflineminus">-        ],</span>
<a href="#l68.527"></a><span id="l68.527" class="difflineminus">-        [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l68.528"></a><span id="l68.528" class="difflineminus">-        [&quot;Authentication&quot;, &quot;skypetoken=&quot; + this._skypeToken],</span>
<a href="#l68.529"></a><span id="l68.529" class="difflineminus">-      ],</span>
<a href="#l68.530"></a><span id="l68.530" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.531"></a><span id="l68.531" class="difflineminus">-    };</span>
<a href="#l68.532"></a><span id="l68.532" class="difflineminus">-    httpRequest(messagesUrl, options);</span>
<a href="#l68.533"></a><span id="l68.533" class="difflineminus">-  },</span>
<a href="#l68.534"></a><span id="l68.534" class="difflineminus">-  _onRegistrationTokenReceived(aResponse, aXhr) {</span>
<a href="#l68.535"></a><span id="l68.535" class="difflineminus">-    this.LOG(&quot;Registration token received: &quot; + aResponse);</span>
<a href="#l68.536"></a><span id="l68.536" class="difflineminus">-</span>
<a href="#l68.537"></a><span id="l68.537" class="difflineminus">-    let registrationToken = aXhr.getResponseHeader(&quot;Set-RegistrationToken&quot;);</span>
<a href="#l68.538"></a><span id="l68.538" class="difflineminus">-    this.LOG(&quot;regToken: &quot; + registrationToken);</span>
<a href="#l68.539"></a><span id="l68.539" class="difflineminus">-    if (!registrationToken) {</span>
<a href="#l68.540"></a><span id="l68.540" class="difflineminus">-      this.ERROR(&quot;registraation token value not found.&quot;);</span>
<a href="#l68.541"></a><span id="l68.541" class="difflineminus">-      this._disconnectWithAuthFailure();</span>
<a href="#l68.542"></a><span id="l68.542" class="difflineminus">-      return;</span>
<a href="#l68.543"></a><span id="l68.543" class="difflineminus">-    }</span>
<a href="#l68.544"></a><span id="l68.544" class="difflineminus">-</span>
<a href="#l68.545"></a><span id="l68.545" class="difflineminus">-    this._registrationToken = registrationToken;</span>
<a href="#l68.546"></a><span id="l68.546" class="difflineminus">-    this._subscribe();</span>
<a href="#l68.547"></a><span id="l68.547" class="difflineminus">-  },</span>
<a href="#l68.548"></a><span id="l68.548" class="difflineminus">-</span>
<a href="#l68.549"></a><span id="l68.549" class="difflineminus">-  // Subscribe to the events we want to see.</span>
<a href="#l68.550"></a><span id="l68.550" class="difflineminus">-  _subscribe() {</span>
<a href="#l68.551"></a><span id="l68.551" class="difflineminus">-    this.LOG(&quot;Sending subscription.&quot;);</span>
<a href="#l68.552"></a><span id="l68.552" class="difflineminus">-</span>
<a href="#l68.553"></a><span id="l68.553" class="difflineminus">-    // Subscribe to particular events.</span>
<a href="#l68.554"></a><span id="l68.554" class="difflineminus">-    let messagesUrl =</span>
<a href="#l68.555"></a><span id="l68.555" class="difflineminus">-      &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints/SELF/subscriptions&quot;;</span>
<a href="#l68.556"></a><span id="l68.556" class="difflineminus">-    // The endpoints to subscribe to.</span>
<a href="#l68.557"></a><span id="l68.557" class="difflineminus">-    let subscriptions = {</span>
<a href="#l68.558"></a><span id="l68.558" class="difflineminus">-      interestedResources: [</span>
<a href="#l68.559"></a><span id="l68.559" class="difflineminus">-        &quot;/v1/users/ME/conversations/ALL/properties&quot;,</span>
<a href="#l68.560"></a><span id="l68.560" class="difflineminus">-        &quot;/v1/users/ME/conversations/ALL/messages&quot;,</span>
<a href="#l68.561"></a><span id="l68.561" class="difflineminus">-        &quot;/v1/users/ME/contacts/ALL&quot;,</span>
<a href="#l68.562"></a><span id="l68.562" class="difflineminus">-        &quot;/v1/threads/ALL&quot;,</span>
<a href="#l68.563"></a><span id="l68.563" class="difflineminus">-      ],</span>
<a href="#l68.564"></a><span id="l68.564" class="difflineminus">-      template: &quot;raw&quot;,</span>
<a href="#l68.565"></a><span id="l68.565" class="difflineminus">-      channelType: &quot;httpLongPoll&quot;,</span>
<a href="#l68.566"></a><span id="l68.566" class="difflineminus">-    };</span>
<a href="#l68.567"></a><span id="l68.567" class="difflineminus">-    let options = {</span>
<a href="#l68.568"></a><span id="l68.568" class="difflineminus">-      onLoad: this._onSubscription.bind(this),</span>
<a href="#l68.569"></a><span id="l68.569" class="difflineminus">-      onError: this._onHttpFailure(&quot;subscribing to notifications&quot;),</span>
<a href="#l68.570"></a><span id="l68.570" class="difflineminus">-      postData: JSON.stringify(subscriptions),</span>
<a href="#l68.571"></a><span id="l68.571" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.572"></a><span id="l68.572" class="difflineminus">-    };</span>
<a href="#l68.573"></a><span id="l68.573" class="difflineminus">-    this._messagesRequest(messagesUrl, options);</span>
<a href="#l68.574"></a><span id="l68.574" class="difflineminus">-  },</span>
<a href="#l68.575"></a><span id="l68.575" class="difflineminus">-</span>
<a href="#l68.576"></a><span id="l68.576" class="difflineminus">-  _onSubscription(aResponse, aXhr) {</span>
<a href="#l68.577"></a><span id="l68.577" class="difflineminus">-    this.LOG(&quot;Got subscription response: &quot; + aResponse);</span>
<a href="#l68.578"></a><span id="l68.578" class="difflineminus">-    this.reportConnected();</span>
<a href="#l68.579"></a><span id="l68.579" class="difflineminus">-</span>
<a href="#l68.580"></a><span id="l68.580" class="difflineminus">-    // TODO Check auth requests.</span>
<a href="#l68.581"></a><span id="l68.581" class="difflineminus">-</span>
<a href="#l68.582"></a><span id="l68.582" class="difflineminus">-    // Get friends list.</span>
<a href="#l68.583"></a><span id="l68.583" class="difflineminus">-    let contactListUrl = &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts&quot;;</span>
<a href="#l68.584"></a><span id="l68.584" class="difflineminus">-    let options = {</span>
<a href="#l68.585"></a><span id="l68.585" class="difflineminus">-      onLoad: this._onContactsList.bind(this),</span>
<a href="#l68.586"></a><span id="l68.586" class="difflineminus">-      onError: this._onHttpError.bind(this),</span>
<a href="#l68.587"></a><span id="l68.587" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.588"></a><span id="l68.588" class="difflineminus">-    };</span>
<a href="#l68.589"></a><span id="l68.589" class="difflineminus">-    this._contactsRequest(contactListUrl, options);</span>
<a href="#l68.590"></a><span id="l68.590" class="difflineminus">-</span>
<a href="#l68.591"></a><span id="l68.591" class="difflineminus">-    // Poll for messages.</span>
<a href="#l68.592"></a><span id="l68.592" class="difflineminus">-    this._getMessages();</span>
<a href="#l68.593"></a><span id="l68.593" class="difflineminus">-  },</span>
<a href="#l68.594"></a><span id="l68.594" class="difflineminus">-</span>
<a href="#l68.595"></a><span id="l68.595" class="difflineminus">-  _onContactsList(aResponse, aXhr) {</span>
<a href="#l68.596"></a><span id="l68.596" class="difflineminus">-    this.LOG(&quot;Contacts list: &quot; + aResponse);</span>
<a href="#l68.597"></a><span id="l68.597" class="difflineminus">-</span>
<a href="#l68.598"></a><span id="l68.598" class="difflineminus">-    let buddies = JSON.parse(aResponse);</span>
<a href="#l68.599"></a><span id="l68.599" class="difflineminus">-    if (!buddies) {</span>
<a href="#l68.600"></a><span id="l68.600" class="difflineminus">-      this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l68.601"></a><span id="l68.601" class="difflineminus">-      return;</span>
<a href="#l68.602"></a><span id="l68.602" class="difflineminus">-    }</span>
<a href="#l68.603"></a><span id="l68.603" class="difflineminus">-</span>
<a href="#l68.604"></a><span id="l68.604" class="difflineminus">-    // You have no friends. :( Nothing to do, just move along.</span>
<a href="#l68.605"></a><span id="l68.605" class="difflineminus">-    if (!buddies.length) {</span>
<a href="#l68.606"></a><span id="l68.606" class="difflineminus">-      return;</span>
<a href="#l68.607"></a><span id="l68.607" class="difflineminus">-    }</span>
<a href="#l68.608"></a><span id="l68.608" class="difflineminus">-</span>
<a href="#l68.609"></a><span id="l68.609" class="difflineminus">-    // This gets a little confusing, buddyObj refers to the JSON that was parsed</span>
<a href="#l68.610"></a><span id="l68.610" class="difflineminus">-    // and returned from the server, buddy refers to the prplIAccountBuddy.</span>
<a href="#l68.611"></a><span id="l68.611" class="difflineminus">-    for (let buddyObj of buddies) {</span>
<a href="#l68.612"></a><span id="l68.612" class="difflineminus">-      let buddy = this._buddies.get(buddyObj.skypename);</span>
<a href="#l68.613"></a><span id="l68.613" class="difflineminus">-      if (!buddy) {</span>
<a href="#l68.614"></a><span id="l68.614" class="difflineminus">-        buddy = new SkypeAccountBuddy(</span>
<a href="#l68.615"></a><span id="l68.615" class="difflineminus">-          this,</span>
<a href="#l68.616"></a><span id="l68.616" class="difflineminus">-          null,</span>
<a href="#l68.617"></a><span id="l68.617" class="difflineminus">-          Services.tags.defaultTag,</span>
<a href="#l68.618"></a><span id="l68.618" class="difflineminus">-          buddyObj.skypename</span>
<a href="#l68.619"></a><span id="l68.619" class="difflineminus">-        );</span>
<a href="#l68.620"></a><span id="l68.620" class="difflineminus">-</span>
<a href="#l68.621"></a><span id="l68.621" class="difflineminus">-        // Store the buddy for later.</span>
<a href="#l68.622"></a><span id="l68.622" class="difflineminus">-        this._buddies.set(buddyObj.skypename, buddy);</span>
<a href="#l68.623"></a><span id="l68.623" class="difflineminus">-</span>
<a href="#l68.624"></a><span id="l68.624" class="difflineminus">-        // Notify the UI of the buddy.</span>
<a href="#l68.625"></a><span id="l68.625" class="difflineminus">-        Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l68.626"></a><span id="l68.626" class="difflineminus">-      }</span>
<a href="#l68.627"></a><span id="l68.627" class="difflineminus">-</span>
<a href="#l68.628"></a><span id="l68.628" class="difflineminus">-      // TODO There is also fullname / skypename.</span>
<a href="#l68.629"></a><span id="l68.629" class="difflineminus">-      // Note that display_name is the public alias that the buddy has set for</span>
<a href="#l68.630"></a><span id="l68.630" class="difflineminus">-      // themselves, skypename is the buddy's unique ID name, fullname is their</span>
<a href="#l68.631"></a><span id="l68.631" class="difflineminus">-      // real name.</span>
<a href="#l68.632"></a><span id="l68.632" class="difflineminus">-      if (buddyObj.display_name) {</span>
<a href="#l68.633"></a><span id="l68.633" class="difflineminus">-        buddy.serverAlias = buddyObj.display_name;</span>
<a href="#l68.634"></a><span id="l68.634" class="difflineminus">-      }</span>
<a href="#l68.635"></a><span id="l68.635" class="difflineminus">-      // Store the buddy info into the object for tooltips.</span>
<a href="#l68.636"></a><span id="l68.636" class="difflineminus">-      buddy._info = buddyObj;</span>
<a href="#l68.637"></a><span id="l68.637" class="difflineminus">-</span>
<a href="#l68.638"></a><span id="l68.638" class="difflineminus">-      // Set the buddy's status to offline until we get an update.</span>
<a href="#l68.639"></a><span id="l68.639" class="difflineminus">-      buddy.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l68.640"></a><span id="l68.640" class="difflineminus">-    }</span>
<a href="#l68.641"></a><span id="l68.641" class="difflineminus">-</span>
<a href="#l68.642"></a><span id="l68.642" class="difflineminus">-    // Download profiles.</span>
<a href="#l68.643"></a><span id="l68.643" class="difflineminus">-    let profilesUrl =</span>
<a href="#l68.644"></a><span id="l68.644" class="difflineminus">-      &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts/profiles&quot;;</span>
<a href="#l68.645"></a><span id="l68.645" class="difflineminus">-    let options = {</span>
<a href="#l68.646"></a><span id="l68.646" class="difflineminus">-      postData: buddies.map(b =&gt; [&quot;contacts[]&quot;, b.skypename]),</span>
<a href="#l68.647"></a><span id="l68.647" class="difflineminus">-      onLoad: this._onProfiles.bind(this),</span>
<a href="#l68.648"></a><span id="l68.648" class="difflineminus">-      onError: this._onHttpError.bind(this),</span>
<a href="#l68.649"></a><span id="l68.649" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.650"></a><span id="l68.650" class="difflineminus">-    };</span>
<a href="#l68.651"></a><span id="l68.651" class="difflineminus">-    this.LOG(JSON.stringify(options));</span>
<a href="#l68.652"></a><span id="l68.652" class="difflineminus">-    this._contactsRequest(profilesUrl, options);</span>
<a href="#l68.653"></a><span id="l68.653" class="difflineminus">-</span>
<a href="#l68.654"></a><span id="l68.654" class="difflineminus">-    // Subscribe to user statuses.</span>
<a href="#l68.655"></a><span id="l68.655" class="difflineminus">-    let contactsUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/contacts&quot;;</span>
<a href="#l68.656"></a><span id="l68.656" class="difflineminus">-    let contacts = buddies.map(b =&gt; {</span>
<a href="#l68.657"></a><span id="l68.657" class="difflineminus">-      return { id: &quot;8:&quot; + b.skypename };</span>
<a href="#l68.658"></a><span id="l68.658" class="difflineminus">-    });</span>
<a href="#l68.659"></a><span id="l68.659" class="difflineminus">-    options = {</span>
<a href="#l68.660"></a><span id="l68.660" class="difflineminus">-      postData: JSON.stringify({ contacts }),</span>
<a href="#l68.661"></a><span id="l68.661" class="difflineminus">-      onLoad: (aResponse, aXhr) =&gt;</span>
<a href="#l68.662"></a><span id="l68.662" class="difflineminus">-        this.LOG(&quot;Successfully subscribed to contacts.&quot;),</span>
<a href="#l68.663"></a><span id="l68.663" class="difflineminus">-      onError: this._onHttpError.bind(this),</span>
<a href="#l68.664"></a><span id="l68.664" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.665"></a><span id="l68.665" class="difflineminus">-    };</span>
<a href="#l68.666"></a><span id="l68.666" class="difflineminus">-    this.LOG(JSON.stringify(options));</span>
<a href="#l68.667"></a><span id="l68.667" class="difflineminus">-    this._messagesRequest(contactsUrl, options);</span>
<a href="#l68.668"></a><span id="l68.668" class="difflineminus">-  },</span>
<a href="#l68.669"></a><span id="l68.669" class="difflineminus">-</span>
<a href="#l68.670"></a><span id="l68.670" class="difflineminus">-  _onProfiles(aResponse, aXhr) {</span>
<a href="#l68.671"></a><span id="l68.671" class="difflineminus">-    this.LOG(&quot;Profiles: &quot; + aResponse);</span>
<a href="#l68.672"></a><span id="l68.672" class="difflineminus">-</span>
<a href="#l68.673"></a><span id="l68.673" class="difflineminus">-    let skypeContacts = JSON.parse(aResponse);</span>
<a href="#l68.674"></a><span id="l68.674" class="difflineminus">-</span>
<a href="#l68.675"></a><span id="l68.675" class="difflineminus">-    // TODO Error checking.</span>
<a href="#l68.676"></a><span id="l68.676" class="difflineminus">-</span>
<a href="#l68.677"></a><span id="l68.677" class="difflineminus">-    for (let skypeContact of skypeContacts) {</span>
<a href="#l68.678"></a><span id="l68.678" class="difflineminus">-      let username = skypeContact.username;</span>
<a href="#l68.679"></a><span id="l68.679" class="difflineminus">-</span>
<a href="#l68.680"></a><span id="l68.680" class="difflineminus">-      let buddy = this._buddies.get(username);</span>
<a href="#l68.681"></a><span id="l68.681" class="difflineminus">-      if (!buddy) {</span>
<a href="#l68.682"></a><span id="l68.682" class="difflineminus">-        continue;</span>
<a href="#l68.683"></a><span id="l68.683" class="difflineminus">-      }</span>
<a href="#l68.684"></a><span id="l68.684" class="difflineminus">-</span>
<a href="#l68.685"></a><span id="l68.685" class="difflineminus">-      // Set some properties on the buddy.</span>
<a href="#l68.686"></a><span id="l68.686" class="difflineminus">-      buddy.serverAlias = skypeContact.displayname;</span>
<a href="#l68.687"></a><span id="l68.687" class="difflineminus">-      // TODO There's also firstname and lastname fields.</span>
<a href="#l68.688"></a><span id="l68.688" class="difflineminus">-      buddy.mood = skypeContact.mood;</span>
<a href="#l68.689"></a><span id="l68.689" class="difflineminus">-</span>
<a href="#l68.690"></a><span id="l68.690" class="difflineminus">-      // TODO Download the file and store it in the profile.</span>
<a href="#l68.691"></a><span id="l68.691" class="difflineminus">-      let avatarUrl = skypeContact.avatarUrl;</span>
<a href="#l68.692"></a><span id="l68.692" class="difflineminus">-      if (!avatarUrl) {</span>
<a href="#l68.693"></a><span id="l68.693" class="difflineminus">-        avatarUrl =</span>
<a href="#l68.694"></a><span id="l68.694" class="difflineminus">-          &quot;https://&quot; +</span>
<a href="#l68.695"></a><span id="l68.695" class="difflineminus">-          kContactsHost +</span>
<a href="#l68.696"></a><span id="l68.696" class="difflineminus">-          &quot;/users/&quot; +</span>
<a href="#l68.697"></a><span id="l68.697" class="difflineminus">-          buddy.userName +</span>
<a href="#l68.698"></a><span id="l68.698" class="difflineminus">-          &quot;/profile/avatar&quot;;</span>
<a href="#l68.699"></a><span id="l68.699" class="difflineminus">-      }</span>
<a href="#l68.700"></a><span id="l68.700" class="difflineminus">-      buddy.buddyIconFilename = skypeContact.avatarUrl;</span>
<a href="#l68.701"></a><span id="l68.701" class="difflineminus">-    }</span>
<a href="#l68.702"></a><span id="l68.702" class="difflineminus">-  },</span>
<a href="#l68.703"></a><span id="l68.703" class="difflineminus">-</span>
<a href="#l68.704"></a><span id="l68.704" class="difflineminus">-  /*</span>
<a href="#l68.705"></a><span id="l68.705" class="difflineminus">-   * Download the actual messages, this will recurse through its callback.</span>
<a href="#l68.706"></a><span id="l68.706" class="difflineminus">-   */</span>
<a href="#l68.707"></a><span id="l68.707" class="difflineminus">-  _getMessages() {</span>
<a href="#l68.708"></a><span id="l68.708" class="difflineminus">-    let messagesUrl =</span>
<a href="#l68.709"></a><span id="l68.709" class="difflineminus">-      &quot;https://&quot; +</span>
<a href="#l68.710"></a><span id="l68.710" class="difflineminus">-      kMessagesHost +</span>
<a href="#l68.711"></a><span id="l68.711" class="difflineminus">-      &quot;/v1/users/ME/endpoints/SELF/subscriptions/0/poll&quot;;</span>
<a href="#l68.712"></a><span id="l68.712" class="difflineminus">-    let options = {</span>
<a href="#l68.713"></a><span id="l68.713" class="difflineminus">-      method: &quot;POST&quot;,</span>
<a href="#l68.714"></a><span id="l68.714" class="difflineminus">-      onLoad: this._onMessages.bind(this),</span>
<a href="#l68.715"></a><span id="l68.715" class="difflineminus">-      onError: this._onHttpError.bind(this),</span>
<a href="#l68.716"></a><span id="l68.716" class="difflineminus">-      logger: this._logger,</span>
<a href="#l68.717"></a><span id="l68.717" class="difflineminus">-    };</span>
<a href="#l68.718"></a><span id="l68.718" class="difflineminus">-    this._request = this._messagesRequest(messagesUrl, options);</span>
<a href="#l68.719"></a><span id="l68.719" class="difflineminus">-  },</span>
<a href="#l68.720"></a><span id="l68.720" class="difflineminus">-</span>
<a href="#l68.721"></a><span id="l68.721" class="difflineminus">-  _onMessages(aResponse, aXhr) {</span>
<a href="#l68.722"></a><span id="l68.722" class="difflineminus">-    this.LOG(&quot;Messages: &quot; + aResponse);</span>
<a href="#l68.723"></a><span id="l68.723" class="difflineminus">-</span>
<a href="#l68.724"></a><span id="l68.724" class="difflineminus">-    // Poll for new events by performing another XHR in 1 second.</span>
<a href="#l68.725"></a><span id="l68.725" class="difflineminus">-    this._request = null;</span>
<a href="#l68.726"></a><span id="l68.726" class="difflineminus">-    this._poller = setTimeout(this._getMessages.bind(this), 1000);</span>
<a href="#l68.727"></a><span id="l68.727" class="difflineminus">-</span>
<a href="#l68.728"></a><span id="l68.728" class="difflineminus">-    // Empty responses are received as keep alives.</span>
<a href="#l68.729"></a><span id="l68.729" class="difflineminus">-    if (!aResponse) {</span>
<a href="#l68.730"></a><span id="l68.730" class="difflineminus">-      return;</span>
<a href="#l68.731"></a><span id="l68.731" class="difflineminus">-    }</span>
<a href="#l68.732"></a><span id="l68.732" class="difflineminus">-</span>
<a href="#l68.733"></a><span id="l68.733" class="difflineminus">-    // Otherwise, parse the response as JSON.</span>
<a href="#l68.734"></a><span id="l68.734" class="difflineminus">-    let obj = JSON.parse(aResponse);</span>
<a href="#l68.735"></a><span id="l68.735" class="difflineminus">-    if (!obj) {</span>
<a href="#l68.736"></a><span id="l68.736" class="difflineminus">-      this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l68.737"></a><span id="l68.737" class="difflineminus">-      return;</span>
<a href="#l68.738"></a><span id="l68.738" class="difflineminus">-    }</span>
<a href="#l68.739"></a><span id="l68.739" class="difflineminus">-</span>
<a href="#l68.740"></a><span id="l68.740" class="difflineminus">-    // If no messages, nothing to do.</span>
<a href="#l68.741"></a><span id="l68.741" class="difflineminus">-    if (!(&quot;eventMessages&quot; in obj)) {</span>
<a href="#l68.742"></a><span id="l68.742" class="difflineminus">-      return;</span>
<a href="#l68.743"></a><span id="l68.743" class="difflineminus">-    }</span>
<a href="#l68.744"></a><span id="l68.744" class="difflineminus">-</span>
<a href="#l68.745"></a><span id="l68.745" class="difflineminus">-    for (let message of obj.eventMessages) {</span>
<a href="#l68.746"></a><span id="l68.746" class="difflineminus">-      // The type of message (e.g. new message, new status).</span>
<a href="#l68.747"></a><span id="l68.747" class="difflineminus">-      let resourceType = message.resourceType;</span>
<a href="#l68.748"></a><span id="l68.748" class="difflineminus">-      // The message object.</span>
<a href="#l68.749"></a><span id="l68.749" class="difflineminus">-      let resource = message.resource;</span>
<a href="#l68.750"></a><span id="l68.750" class="difflineminus">-</span>
<a href="#l68.751"></a><span id="l68.751" class="difflineminus">-      // Based on what the message is, totally different things are done below.</span>
<a href="#l68.752"></a><span id="l68.752" class="difflineminus">-      // Sorry for the mess. We can probably abstract this better.</span>
<a href="#l68.753"></a><span id="l68.753" class="difflineminus">-      if (resourceType == &quot;NewMessage&quot;) {</span>
<a href="#l68.754"></a><span id="l68.754" class="difflineminus">-        let messageType = resource.messagetype;</span>
<a href="#l68.755"></a><span id="l68.755" class="difflineminus">-        let from = contactUrlToName(resource.from);</span>
<a href="#l68.756"></a><span id="l68.756" class="difflineminus">-        if (!from) {</span>
<a href="#l68.757"></a><span id="l68.757" class="difflineminus">-          this.WARN(</span>
<a href="#l68.758"></a><span id="l68.758" class="difflineminus">-            &quot;Received a message without a parseable from field: &quot; +</span>
<a href="#l68.759"></a><span id="l68.759" class="difflineminus">-              resource.from</span>
<a href="#l68.760"></a><span id="l68.760" class="difflineminus">-          );</span>
<a href="#l68.761"></a><span id="l68.761" class="difflineminus">-          return;</span>
<a href="#l68.762"></a><span id="l68.762" class="difflineminus">-        }</span>
<a href="#l68.763"></a><span id="l68.763" class="difflineminus">-</span>
<a href="#l68.764"></a><span id="l68.764" class="difflineminus">-        // TODO Handle composetime field?</span>
<a href="#l68.765"></a><span id="l68.765" class="difflineminus">-        let conversationLink = resource.conversationLink;</span>
<a href="#l68.766"></a><span id="l68.766" class="difflineminus">-</span>
<a href="#l68.767"></a><span id="l68.767" class="difflineminus">-        // Check if the conversation is a chat.</span>
<a href="#l68.768"></a><span id="l68.768" class="difflineminus">-        if (conversationLink.includes(&quot;/19:&quot;)) {</span>
<a href="#l68.769"></a><span id="l68.769" class="difflineminus">-          // TODO</span>
<a href="#l68.770"></a><span id="l68.770" class="difflineminus">-          this.WARN(&quot;Received message from MUC.&quot;);</span>
<a href="#l68.771"></a><span id="l68.771" class="difflineminus">-          continue;</span>
<a href="#l68.772"></a><span id="l68.772" class="difflineminus">-        }</span>
<a href="#l68.773"></a><span id="l68.773" class="difflineminus">-</span>
<a href="#l68.774"></a><span id="l68.774" class="difflineminus">-        // Get or create the conversation.</span>
<a href="#l68.775"></a><span id="l68.775" class="difflineminus">-        let conversationName = contactUrlToName(conversationLink);</span>
<a href="#l68.776"></a><span id="l68.776" class="difflineminus">-        let conv = this._conversations.get(conversationName);</span>
<a href="#l68.777"></a><span id="l68.777" class="difflineminus">-</span>
<a href="#l68.778"></a><span id="l68.778" class="difflineminus">-        let messageTypeParts = messageType.split(&quot;/&quot;);</span>
<a href="#l68.779"></a><span id="l68.779" class="difflineminus">-        // Set the typing state (if the conversation exists).</span>
<a href="#l68.780"></a><span id="l68.780" class="difflineminus">-        if (messageTypeParts[0] == &quot;Control&quot; &amp;&amp; conv) {</span>
<a href="#l68.781"></a><span id="l68.781" class="difflineminus">-          let typingState = null;</span>
<a href="#l68.782"></a><span id="l68.782" class="difflineminus">-          // NotTyping or Typing.</span>
<a href="#l68.783"></a><span id="l68.783" class="difflineminus">-          if (messageTypeParts[1] == &quot;Typing&quot;) {</span>
<a href="#l68.784"></a><span id="l68.784" class="difflineminus">-            typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l68.785"></a><span id="l68.785" class="difflineminus">-          } else if (messageTypeParts[1] == &quot;ClearTyping&quot;) {</span>
<a href="#l68.786"></a><span id="l68.786" class="difflineminus">-            typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l68.787"></a><span id="l68.787" class="difflineminus">-          }</span>
<a href="#l68.788"></a><span id="l68.788" class="difflineminus">-          if (typingState !== null) {</span>
<a href="#l68.789"></a><span id="l68.789" class="difflineminus">-            conv.updateTyping(typingState);</span>
<a href="#l68.790"></a><span id="l68.790" class="difflineminus">-          }</span>
<a href="#l68.791"></a><span id="l68.791" class="difflineminus">-          // TODO There doesn't seem to be a &quot;typed&quot; state.</span>
<a href="#l68.792"></a><span id="l68.792" class="difflineminus">-        } else if (messageType == &quot;RichText&quot; || messageType == &quot;Text&quot;) {</span>
<a href="#l68.793"></a><span id="l68.793" class="difflineminus">-          // Create a conversation if it doesn't exist.</span>
<a href="#l68.794"></a><span id="l68.794" class="difflineminus">-          if (!conv) {</span>
<a href="#l68.795"></a><span id="l68.795" class="difflineminus">-            conv = this.createConversation(conversationName);</span>
<a href="#l68.796"></a><span id="l68.796" class="difflineminus">-          }</span>
<a href="#l68.797"></a><span id="l68.797" class="difflineminus">-</span>
<a href="#l68.798"></a><span id="l68.798" class="difflineminus">-          // TODO Handle RichText vs. Text.</span>
<a href="#l68.799"></a><span id="l68.799" class="difflineminus">-</span>
<a href="#l68.800"></a><span id="l68.800" class="difflineminus">-          // Put the message into the conversation.</span>
<a href="#l68.801"></a><span id="l68.801" class="difflineminus">-          let options = {};</span>
<a href="#l68.802"></a><span id="l68.802" class="difflineminus">-          if (from == this.name) {</span>
<a href="#l68.803"></a><span id="l68.803" class="difflineminus">-            options.outgoing = true;</span>
<a href="#l68.804"></a><span id="l68.804" class="difflineminus">-          } else {</span>
<a href="#l68.805"></a><span id="l68.805" class="difflineminus">-            options.incoming = true;</span>
<a href="#l68.806"></a><span id="l68.806" class="difflineminus">-          }</span>
<a href="#l68.807"></a><span id="l68.807" class="difflineminus">-          conv.writeMessage(from, resource.content, options);</span>
<a href="#l68.808"></a><span id="l68.808" class="difflineminus">-        }</span>
<a href="#l68.809"></a><span id="l68.809" class="difflineminus">-      } else if (resourceType == &quot;UserPresence&quot;) {</span>
<a href="#l68.810"></a><span id="l68.810" class="difflineminus">-        // Ignore our own statuses.</span>
<a href="#l68.811"></a><span id="l68.811" class="difflineminus">-        let from = contactUrlToName(resource.selfLink);</span>
<a href="#l68.812"></a><span id="l68.812" class="difflineminus">-        if (!from) {</span>
<a href="#l68.813"></a><span id="l68.813" class="difflineminus">-          continue;</span>
<a href="#l68.814"></a><span id="l68.814" class="difflineminus">-        }</span>
<a href="#l68.815"></a><span id="l68.815" class="difflineminus">-</span>
<a href="#l68.816"></a><span id="l68.816" class="difflineminus">-        // Get the buddy and update the status.</span>
<a href="#l68.817"></a><span id="l68.817" class="difflineminus">-        let buddy = this._buddies.get(from);</span>
<a href="#l68.818"></a><span id="l68.818" class="difflineminus">-        if (buddy) {</span>
<a href="#l68.819"></a><span id="l68.819" class="difflineminus">-          buddy.setStatus(this.mapStatusString(resource.status), &quot;&quot;);</span>
<a href="#l68.820"></a><span id="l68.820" class="difflineminus">-        }</span>
<a href="#l68.821"></a><span id="l68.821" class="difflineminus">-      } else if (resourceType == &quot;EndpointPresence&quot;) {</span>
<a href="#l68.822"></a><span id="l68.822" class="difflineminus">-        // Nothing to do.</span>
<a href="#l68.823"></a><span id="l68.823" class="difflineminus">-      } else if (resourceType == &quot;ConversationUpdate&quot;) {</span>
<a href="#l68.824"></a><span id="l68.824" class="difflineminus">-        // Nothing to do.</span>
<a href="#l68.825"></a><span id="l68.825" class="difflineminus">-      } else if (resourceType == &quot;ThreadUpdate&quot;) {</span>
<a href="#l68.826"></a><span id="l68.826" class="difflineminus">-        // Nothing to do.</span>
<a href="#l68.827"></a><span id="l68.827" class="difflineminus">-      } else {</span>
<a href="#l68.828"></a><span id="l68.828" class="difflineminus">-        this.WARN(&quot;Unhandled resource type: &quot; + resourceType);</span>
<a href="#l68.829"></a><span id="l68.829" class="difflineminus">-      }</span>
<a href="#l68.830"></a><span id="l68.830" class="difflineminus">-    }</span>
<a href="#l68.831"></a><span id="l68.831" class="difflineminus">-  },</span>
<a href="#l68.832"></a><span id="l68.832" class="difflineminus">-</span>
<a href="#l68.833"></a><span id="l68.833" class="difflineminus">-  /*</span>
<a href="#l68.834"></a><span id="l68.834" class="difflineminus">-   * Make a request to the Skype contacts API, this is essentially just</span>
<a href="#l68.835"></a><span id="l68.835" class="difflineminus">-   * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l68.836"></a><span id="l68.836" class="difflineminus">-   */</span>
<a href="#l68.837"></a><span id="l68.837" class="difflineminus">-  _contactsRequest(aUrl, aOptions = {}) {</span>
<a href="#l68.838"></a><span id="l68.838" class="difflineminus">-    let headers = aOptions.headers || [];</span>
<a href="#l68.839"></a><span id="l68.839" class="difflineminus">-</span>
<a href="#l68.840"></a><span id="l68.840" class="difflineminus">-    // Add some special Skype headers.</span>
<a href="#l68.841"></a><span id="l68.841" class="difflineminus">-    headers = headers.concat([</span>
<a href="#l68.842"></a><span id="l68.842" class="difflineminus">-      [&quot;X-Skypetoken&quot;, this._skypeToken],</span>
<a href="#l68.843"></a><span id="l68.843" class="difflineminus">-      [&quot;X-Stratus-Caller&quot;, &quot;swx-skype.com&quot;],</span>
<a href="#l68.844"></a><span id="l68.844" class="difflineminus">-      [&quot;X-Stratus-Request&quot;, &quot;abcd1234&quot;],</span>
<a href="#l68.845"></a><span id="l68.845" class="difflineminus">-      [&quot;Origin&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l68.846"></a><span id="l68.846" class="difflineminus">-      [&quot;Referer&quot;, &quot;https://web.skype.com/main&quot;],</span>
<a href="#l68.847"></a><span id="l68.847" class="difflineminus">-      [&quot;Accept&quot;, &quot;application/json; ver=1.0;&quot;],</span>
<a href="#l68.848"></a><span id="l68.848" class="difflineminus">-    ]);</span>
<a href="#l68.849"></a><span id="l68.849" class="difflineminus">-</span>
<a href="#l68.850"></a><span id="l68.850" class="difflineminus">-    aOptions.headers = headers;</span>
<a href="#l68.851"></a><span id="l68.851" class="difflineminus">-</span>
<a href="#l68.852"></a><span id="l68.852" class="difflineminus">-    return httpRequest(aUrl, aOptions);</span>
<a href="#l68.853"></a><span id="l68.853" class="difflineminus">-  },</span>
<a href="#l68.854"></a><span id="l68.854" class="difflineminus">-</span>
<a href="#l68.855"></a><span id="l68.855" class="difflineminus">-  /*</span>
<a href="#l68.856"></a><span id="l68.856" class="difflineminus">-   * Make a request to the Skype messages API, this is essentially just</span>
<a href="#l68.857"></a><span id="l68.857" class="difflineminus">-   * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l68.858"></a><span id="l68.858" class="difflineminus">-   */</span>
<a href="#l68.859"></a><span id="l68.859" class="difflineminus">-  _messagesRequest(aUrl, aOptions = {}) {</span>
<a href="#l68.860"></a><span id="l68.860" class="difflineminus">-    let headers = aOptions.headers || [];</span>
<a href="#l68.861"></a><span id="l68.861" class="difflineminus">-</span>
<a href="#l68.862"></a><span id="l68.862" class="difflineminus">-    // Add some special Skype headers.</span>
<a href="#l68.863"></a><span id="l68.863" class="difflineminus">-    headers = headers.concat([</span>
<a href="#l68.864"></a><span id="l68.864" class="difflineminus">-      [&quot;RegistrationToken&quot;, this._registrationToken],</span>
<a href="#l68.865"></a><span id="l68.865" class="difflineminus">-      [&quot;Referer&quot;, &quot;https://web.skype.com/main&quot;],</span>
<a href="#l68.866"></a><span id="l68.866" class="difflineminus">-      [&quot;Accept&quot;, &quot;application/json; ver=1.0;&quot;],</span>
<a href="#l68.867"></a><span id="l68.867" class="difflineminus">-      [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l68.868"></a><span id="l68.868" class="difflineminus">-    ]);</span>
<a href="#l68.869"></a><span id="l68.869" class="difflineminus">-</span>
<a href="#l68.870"></a><span id="l68.870" class="difflineminus">-    aOptions.headers = headers;</span>
<a href="#l68.871"></a><span id="l68.871" class="difflineminus">-</span>
<a href="#l68.872"></a><span id="l68.872" class="difflineminus">-    return httpRequest(aUrl, aOptions);</span>
<a href="#l68.873"></a><span id="l68.873" class="difflineminus">-  },</span>
<a href="#l68.874"></a><span id="l68.874" class="difflineminus">-</span>
<a href="#l68.875"></a><span id="l68.875" class="difflineminus">-  // Helper function to disconnect with authentication failed.</span>
<a href="#l68.876"></a><span id="l68.876" class="difflineminus">-  _disconnectWithAuthFailure(aMessageId = &quot;error.auth&quot;) {</span>
<a href="#l68.877"></a><span id="l68.877" class="difflineminus">-    this.reportDisconnecting(</span>
<a href="#l68.878"></a><span id="l68.878" class="difflineminus">-      Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l68.879"></a><span id="l68.879" class="difflineminus">-      _(aMessageId)</span>
<a href="#l68.880"></a><span id="l68.880" class="difflineminus">-    );</span>
<a href="#l68.881"></a><span id="l68.881" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l68.882"></a><span id="l68.882" class="difflineminus">-  },</span>
<a href="#l68.883"></a><span id="l68.883" class="difflineminus">-</span>
<a href="#l68.884"></a><span id="l68.884" class="difflineminus">-  disconnect() {</span>
<a href="#l68.885"></a><span id="l68.885" class="difflineminus">-    if (this.disconnected || this.disconnecting) {</span>
<a href="#l68.886"></a><span id="l68.886" class="difflineminus">-      return;</span>
<a href="#l68.887"></a><span id="l68.887" class="difflineminus">-    }</span>
<a href="#l68.888"></a><span id="l68.888" class="difflineminus">-</span>
<a href="#l68.889"></a><span id="l68.889" class="difflineminus">-    clearTimeout(this._poller);</span>
<a href="#l68.890"></a><span id="l68.890" class="difflineminus">-    if (this._request) {</span>
<a href="#l68.891"></a><span id="l68.891" class="difflineminus">-      this._request.abort();</span>
<a href="#l68.892"></a><span id="l68.892" class="difflineminus">-    }</span>
<a href="#l68.893"></a><span id="l68.893" class="difflineminus">-</span>
<a href="#l68.894"></a><span id="l68.894" class="difflineminus">-    this._request = null;</span>
<a href="#l68.895"></a><span id="l68.895" class="difflineminus">-    this._poller = null;</span>
<a href="#l68.896"></a><span id="l68.896" class="difflineminus">-</span>
<a href="#l68.897"></a><span id="l68.897" class="difflineminus">-    // Mark all contacts on the account as having an unknown status.</span>
<a href="#l68.898"></a><span id="l68.898" class="difflineminus">-    this._buddies.forEach(aBuddy =&gt;</span>
<a href="#l68.899"></a><span id="l68.899" class="difflineminus">-      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l68.900"></a><span id="l68.900" class="difflineminus">-    );</span>
<a href="#l68.901"></a><span id="l68.901" class="difflineminus">-</span>
<a href="#l68.902"></a><span id="l68.902" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l68.903"></a><span id="l68.903" class="difflineminus">-  },</span>
<a href="#l68.904"></a><span id="l68.904" class="difflineminus">-</span>
<a href="#l68.905"></a><span id="l68.905" class="difflineminus">-  // TODO?</span>
<a href="#l68.906"></a><span id="l68.906" class="difflineminus">-  observe(aSubject, aTopic, aData) {},</span>
<a href="#l68.907"></a><span id="l68.907" class="difflineminus">-</span>
<a href="#l68.908"></a><span id="l68.908" class="difflineminus">-  remove() {</span>
<a href="#l68.909"></a><span id="l68.909" class="difflineminus">-    this._conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l68.910"></a><span id="l68.910" class="difflineminus">-    delete this._conversations;</span>
<a href="#l68.911"></a><span id="l68.911" class="difflineminus">-    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l68.912"></a><span id="l68.912" class="difflineminus">-    delete this.buddies;</span>
<a href="#l68.913"></a><span id="l68.913" class="difflineminus">-  },</span>
<a href="#l68.914"></a><span id="l68.914" class="difflineminus">-</span>
<a href="#l68.915"></a><span id="l68.915" class="difflineminus">-  unInit() {</span>
<a href="#l68.916"></a><span id="l68.916" class="difflineminus">-    delete this.imAccount;</span>
<a href="#l68.917"></a><span id="l68.917" class="difflineminus">-    clearTimeout(this._poller);</span>
<a href="#l68.918"></a><span id="l68.918" class="difflineminus">-  },</span>
<a href="#l68.919"></a><span id="l68.919" class="difflineminus">-</span>
<a href="#l68.920"></a><span id="l68.920" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l68.921"></a><span id="l68.921" class="difflineminus">-    let conv = new SkypeConversation(this, aName);</span>
<a href="#l68.922"></a><span id="l68.922" class="difflineminus">-    this._conversations.set(aName, conv);</span>
<a href="#l68.923"></a><span id="l68.923" class="difflineminus">-    return conv;</span>
<a href="#l68.924"></a><span id="l68.924" class="difflineminus">-  },</span>
<a href="#l68.925"></a><span id="l68.925" class="difflineminus">-</span>
<a href="#l68.926"></a><span id="l68.926" class="difflineminus">-  // Called when the user adds or authorizes a new contact.</span>
<a href="#l68.927"></a><span id="l68.927" class="difflineminus">-  addBuddy(aTag, aName) {},</span>
<a href="#l68.928"></a><span id="l68.928" class="difflineminus">-</span>
<a href="#l68.929"></a><span id="l68.929" class="difflineminus">-  loadBuddy(aBuddy, aTag) {</span>
<a href="#l68.930"></a><span id="l68.930" class="difflineminus">-    let buddy = new SkypeAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l68.931"></a><span id="l68.931" class="difflineminus">-    this._buddies.set(buddy.userName, buddy);</span>
<a href="#l68.932"></a><span id="l68.932" class="difflineminus">-</span>
<a href="#l68.933"></a><span id="l68.933" class="difflineminus">-    return buddy;</span>
<a href="#l68.934"></a><span id="l68.934" class="difflineminus">-  },</span>
<a href="#l68.935"></a><span id="l68.935" class="difflineminus">-</span>
<a href="#l68.936"></a><span id="l68.936" class="difflineminus">-  // TODO Add support for MUCs.</span>
<a href="#l68.937"></a><span id="l68.937" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l68.938"></a><span id="l68.938" class="difflineminus">-    return false;</span>
<a href="#l68.939"></a><span id="l68.939" class="difflineminus">-  },</span>
<a href="#l68.940"></a><span id="l68.940" class="difflineminus">-  chatRoomFields: {},</span>
<a href="#l68.941"></a><span id="l68.941" class="difflineminus">-  joinChat(aComponents) {},</span>
<a href="#l68.942"></a><span id="l68.942" class="difflineminus">-};</span>
<a href="#l68.943"></a><span id="l68.943" class="difflineminus">-</span>
<a href="#l68.944"></a><span id="l68.944" class="difflineminus">-function SkypeProtocol() {}</span>
<a href="#l68.945"></a><span id="l68.945" class="difflineminus">-SkypeProtocol.prototype = {</span>
<a href="#l68.946"></a><span id="l68.946" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l68.947"></a><span id="l68.947" class="difflineminus">-  get name() {</span>
<a href="#l68.948"></a><span id="l68.948" class="difflineminus">-    return &quot;Skype&quot;;</span>
<a href="#l68.949"></a><span id="l68.949" class="difflineminus">-  },</span>
<a href="#l68.950"></a><span id="l68.950" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l68.951"></a><span id="l68.951" class="difflineminus">-    return &quot;chrome://prpl-skype/skin/&quot;;</span>
<a href="#l68.952"></a><span id="l68.952" class="difflineminus">-  },</span>
<a href="#l68.953"></a><span id="l68.953" class="difflineminus">-  get baseId() {</span>
<a href="#l68.954"></a><span id="l68.954" class="difflineminus">-    return &quot;prpl-skype&quot;;</span>
<a href="#l68.955"></a><span id="l68.955" class="difflineminus">-  },</span>
<a href="#l68.956"></a><span id="l68.956" class="difflineminus">-</span>
<a href="#l68.957"></a><span id="l68.957" class="difflineminus">-  get passwordOptional() {</span>
<a href="#l68.958"></a><span id="l68.958" class="difflineminus">-    return false;</span>
<a href="#l68.959"></a><span id="l68.959" class="difflineminus">-  },</span>
<a href="#l68.960"></a><span id="l68.960" class="difflineminus">-</span>
<a href="#l68.961"></a><span id="l68.961" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l68.962"></a><span id="l68.962" class="difflineminus">-    return new SkypeAccount(this, aImAccount);</span>
<a href="#l68.963"></a><span id="l68.963" class="difflineminus">-  },</span>
<a href="#l68.964"></a><span id="l68.964" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1">deleted file mode 100644</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineminus">--- a/chat/protocols/skype/components.conf</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineplus">+++ /dev/null</span>
<a href="#l69.4"></a><span id="l69.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l69.5"></a><span id="l69.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l69.6"></a><span id="l69.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l69.7"></a><span id="l69.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l69.8"></a><span id="l69.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.9"></a><span id="l69.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l69.10"></a><span id="l69.10" class="difflineminus">-</span>
<a href="#l69.11"></a><span id="l69.11" class="difflineminus">-Classes = [</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-  {</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-    'cid': '{8446c0f6-9f59-4710-844e-eaa6c1f49d35}',</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/skype;1'],</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-    'jsm': 'resource:///modules/Skype.jsm',</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-    'constructor': 'SkypeProtocol',</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-skype'},</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineminus">-  },</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/chat/protocols/skype/moz.build</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/chat/protocols/skype/moz.build</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -1,16 +1,13 @@</span>
<a href="#l70.4"></a><span id="l70.4"> # vim: set filetype=python:</span>
<a href="#l70.5"></a><span id="l70.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l70.6"></a><span id="l70.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l70.7"></a><span id="l70.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l70.8"></a><span id="l70.8"> </span>
<a href="#l70.9"></a><span id="l70.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineminus">-    'Skype.jsm',</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineplus">+    'skype.js',</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineplus">+    'skype.manifest',</span>
<a href="#l70.18"></a><span id="l70.18"> ]</span>
<a href="#l70.19"></a><span id="l70.19"> </span>
<a href="#l70.20"></a><span id="l70.20" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineminus">-    'components.conf',</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineminus">-]</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">new file mode 100644</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineminus">--- /dev/null</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineplus">+++ b/chat/protocols/skype/skype.js</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineat">@@ -0,0 +1,962 @@</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l71.6"></a><span id="l71.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l71.7"></a><span id="l71.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l71.8"></a><span id="l71.8" class="difflineplus">+</span>
<a href="#l71.9"></a><span id="l71.9" class="difflineplus">+var { httpRequest } = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l71.10"></a><span id="l71.10" class="difflineplus">+var { StringToArrayBuffer } = ChromeUtils.import(</span>
<a href="#l71.11"></a><span id="l71.11" class="difflineplus">+  &quot;resource:///modules/ArrayBufferUtils.jsm&quot;</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineplus">+);</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+var { bigInt } = ChromeUtils.import(&quot;resource:///modules/BigInteger.jsm&quot;);</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l71.15"></a><span id="l71.15" class="difflineplus">+var {</span>
<a href="#l71.16"></a><span id="l71.16" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l71.17"></a><span id="l71.17" class="difflineplus">+  setTimeout,</span>
<a href="#l71.18"></a><span id="l71.18" class="difflineplus">+  clearTimeout,</span>
<a href="#l71.19"></a><span id="l71.19" class="difflineplus">+  l10nHelper,</span>
<a href="#l71.20"></a><span id="l71.20" class="difflineplus">+  nsSimpleEnumerator,</span>
<a href="#l71.21"></a><span id="l71.21" class="difflineplus">+  EmptyEnumerator,</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineplus">+var {</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+  GenericAccountBuddyPrototype,</span>
<a href="#l71.26"></a><span id="l71.26" class="difflineplus">+  GenericConvIMPrototype,</span>
<a href="#l71.27"></a><span id="l71.27" class="difflineplus">+  GenericProtocolPrototype,</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+  TooltipInfo,</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+// Constants used by the login process. This emulates a captured session using</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+// official means.</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+var kLockAndKeyAppId = &quot;msmsgs@msnmsgr.com&quot;;</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+var kLockAndKeySecret = &quot;Q1P7W2E4J9R8U3S5&quot;;</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+var kClientId = &quot;578134&quot;;</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+var kClientInfo =</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+  &quot;os=Windows; osVer=8.1; proc=Win32; lcid=en-us; &quot; +</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineplus">+  &quot;deviceType=1; country=n/a; clientName=swx-skype.com; clientVer=908/1.0.0.20&quot;;</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineplus">+var kLoginHost = &quot;login.skype.com&quot;;</span>
<a href="#l71.41"></a><span id="l71.41" class="difflineplus">+var kContactsHost = &quot;api.skype.com&quot;;</span>
<a href="#l71.42"></a><span id="l71.42" class="difflineplus">+var kMessagesHost = &quot;client-s.gateway.messenger.live.com&quot;;</span>
<a href="#l71.43"></a><span id="l71.43" class="difflineplus">+</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineplus">+// Map from strings returned by the SkypeWeb API to statuses.</span>
<a href="#l71.45"></a><span id="l71.45" class="difflineplus">+var kStatusMap = {</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineplus">+  Online: &quot;AVAILABLE&quot;,</span>
<a href="#l71.47"></a><span id="l71.47" class="difflineplus">+  Offline: &quot;OFFLINE&quot;,</span>
<a href="#l71.48"></a><span id="l71.48" class="difflineplus">+  Idle: &quot;IDLE&quot;,</span>
<a href="#l71.49"></a><span id="l71.49" class="difflineplus">+  Away: &quot;AWAY&quot;,</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineplus">+  Hidden: &quot;INVISIBLE&quot;,</span>
<a href="#l71.51"></a><span id="l71.51" class="difflineplus">+};</span>
<a href="#l71.52"></a><span id="l71.52" class="difflineplus">+</span>
<a href="#l71.53"></a><span id="l71.53" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l71.54"></a><span id="l71.54" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/skype.properties&quot;)</span>
<a href="#l71.55"></a><span id="l71.55" class="difflineplus">+);</span>
<a href="#l71.56"></a><span id="l71.56" class="difflineplus">+</span>
<a href="#l71.57"></a><span id="l71.57" class="difflineplus">+/*</span>
<a href="#l71.58"></a><span id="l71.58" class="difflineplus">+ * Convert a URL to a user's name.</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineplus">+ *</span>
<a href="#l71.60"></a><span id="l71.60" class="difflineplus">+ * E.g. https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep</span>
<a href="#l71.61"></a><span id="l71.61" class="difflineplus">+ *      https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService</span>
<a href="#l71.62"></a><span id="l71.62" class="difflineplus">+ *</span>
<a href="#l71.63"></a><span id="l71.63" class="difflineplus">+ *</span>
<a href="#l71.64"></a><span id="l71.64" class="difflineplus">+ * Note that some contacts might have a /1: in them (instead of a /8:), that's</span>
<a href="#l71.65"></a><span id="l71.65" class="difflineplus">+ * for MSN linked contacts.</span>
<a href="#l71.66"></a><span id="l71.66" class="difflineplus">+ */</span>
<a href="#l71.67"></a><span id="l71.67" class="difflineplus">+function contactUrlToName(aUrl) {</span>
<a href="#l71.68"></a><span id="l71.68" class="difflineplus">+  let start = aUrl.indexOf(&quot;/8:&quot;);</span>
<a href="#l71.69"></a><span id="l71.69" class="difflineplus">+  if (start == -1) {</span>
<a href="#l71.70"></a><span id="l71.70" class="difflineplus">+    return null;</span>
<a href="#l71.71"></a><span id="l71.71" class="difflineplus">+  }</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineplus">+  // Skip over the separator.</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineplus">+  start += &quot;/8:&quot;.length;</span>
<a href="#l71.74"></a><span id="l71.74" class="difflineplus">+</span>
<a href="#l71.75"></a><span id="l71.75" class="difflineplus">+  let end = aUrl.indexOf(&quot;/&quot;, start);</span>
<a href="#l71.76"></a><span id="l71.76" class="difflineplus">+  if (end == -1) {</span>
<a href="#l71.77"></a><span id="l71.77" class="difflineplus">+    end = undefined;</span>
<a href="#l71.78"></a><span id="l71.78" class="difflineplus">+  }</span>
<a href="#l71.79"></a><span id="l71.79" class="difflineplus">+</span>
<a href="#l71.80"></a><span id="l71.80" class="difflineplus">+  return aUrl.slice(start, end);</span>
<a href="#l71.81"></a><span id="l71.81" class="difflineplus">+}</span>
<a href="#l71.82"></a><span id="l71.82" class="difflineplus">+</span>
<a href="#l71.83"></a><span id="l71.83" class="difflineplus">+function SkypeConversation(aAccount, aName) {</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineplus">+  this.buddy = aAccount._buddies.get(aName);</span>
<a href="#l71.85"></a><span id="l71.85" class="difflineplus">+  this._init(aAccount, aName);</span>
<a href="#l71.86"></a><span id="l71.86" class="difflineplus">+}</span>
<a href="#l71.87"></a><span id="l71.87" class="difflineplus">+SkypeConversation.prototype = {</span>
<a href="#l71.88"></a><span id="l71.88" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l71.89"></a><span id="l71.89" class="difflineplus">+  _account: null,</span>
<a href="#l71.90"></a><span id="l71.90" class="difflineplus">+</span>
<a href="#l71.91"></a><span id="l71.91" class="difflineplus">+  sendMsg(aMessage) {</span>
<a href="#l71.92"></a><span id="l71.92" class="difflineplus">+    if (!aMessage.length) {</span>
<a href="#l71.93"></a><span id="l71.93" class="difflineplus">+      return;</span>
<a href="#l71.94"></a><span id="l71.94" class="difflineplus">+    }</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineplus">+</span>
<a href="#l71.96"></a><span id="l71.96" class="difflineplus">+    let target = &quot;8:&quot; + this.name;</span>
<a href="#l71.97"></a><span id="l71.97" class="difflineplus">+    let url =</span>
<a href="#l71.98"></a><span id="l71.98" class="difflineplus">+      &quot;https://&quot; +</span>
<a href="#l71.99"></a><span id="l71.99" class="difflineplus">+      kMessagesHost +</span>
<a href="#l71.100"></a><span id="l71.100" class="difflineplus">+      &quot;/v1/users/ME/conversations/&quot; +</span>
<a href="#l71.101"></a><span id="l71.101" class="difflineplus">+      target +</span>
<a href="#l71.102"></a><span id="l71.102" class="difflineplus">+      &quot;/messages&quot;;</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineplus">+</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineplus">+    let clientMessageId = Date.now().toString();</span>
<a href="#l71.105"></a><span id="l71.105" class="difflineplus">+    let message = {</span>
<a href="#l71.106"></a><span id="l71.106" class="difflineplus">+      clientmessageid: clientMessageId,</span>
<a href="#l71.107"></a><span id="l71.107" class="difflineplus">+      content: aMessage,</span>
<a href="#l71.108"></a><span id="l71.108" class="difflineplus">+      messagetype: &quot;RichText&quot;,</span>
<a href="#l71.109"></a><span id="l71.109" class="difflineplus">+      contenttype: &quot;text&quot;,</span>
<a href="#l71.110"></a><span id="l71.110" class="difflineplus">+    };</span>
<a href="#l71.111"></a><span id="l71.111" class="difflineplus">+    let options = {</span>
<a href="#l71.112"></a><span id="l71.112" class="difflineplus">+      onLoad: (aResponse, aXhr) =&gt; {</span>
<a href="#l71.113"></a><span id="l71.113" class="difflineplus">+        this._account.LOG(&quot;Message response: &quot; + aResponse);</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineplus">+        this._account.LOG(&quot;Successfully sent message: &quot; + aMessage);</span>
<a href="#l71.115"></a><span id="l71.115" class="difflineplus">+      },</span>
<a href="#l71.116"></a><span id="l71.116" class="difflineplus">+      onError: this._account._onHttpFailure(&quot;sending message&quot;),</span>
<a href="#l71.117"></a><span id="l71.117" class="difflineplus">+      postData: JSON.stringify(message),</span>
<a href="#l71.118"></a><span id="l71.118" class="difflineplus">+      logger: this._account.logger,</span>
<a href="#l71.119"></a><span id="l71.119" class="difflineplus">+    };</span>
<a href="#l71.120"></a><span id="l71.120" class="difflineplus">+</span>
<a href="#l71.121"></a><span id="l71.121" class="difflineplus">+    // TODO Track the messages we sent?</span>
<a href="#l71.122"></a><span id="l71.122" class="difflineplus">+    this._account._messagesRequest(url, options);</span>
<a href="#l71.123"></a><span id="l71.123" class="difflineplus">+  },</span>
<a href="#l71.124"></a><span id="l71.124" class="difflineplus">+};</span>
<a href="#l71.125"></a><span id="l71.125" class="difflineplus">+</span>
<a href="#l71.126"></a><span id="l71.126" class="difflineplus">+function SkypeAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l71.127"></a><span id="l71.127" class="difflineplus">+  aAccount.LOG(&quot;Creating account buddy for &quot; + aUserName);</span>
<a href="#l71.128"></a><span id="l71.128" class="difflineplus">+</span>
<a href="#l71.129"></a><span id="l71.129" class="difflineplus">+  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l71.130"></a><span id="l71.130" class="difflineplus">+}</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineplus">+SkypeAccountBuddy.prototype = {</span>
<a href="#l71.132"></a><span id="l71.132" class="difflineplus">+  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l71.133"></a><span id="l71.133" class="difflineplus">+  _info: null,</span>
<a href="#l71.134"></a><span id="l71.134" class="difflineplus">+  mood: null,</span>
<a href="#l71.135"></a><span id="l71.135" class="difflineplus">+</span>
<a href="#l71.136"></a><span id="l71.136" class="difflineplus">+  // Called when the user wants to chat with the buddy.</span>
<a href="#l71.137"></a><span id="l71.137" class="difflineplus">+  createConversation() {</span>
<a href="#l71.138"></a><span id="l71.138" class="difflineplus">+    return this._account.createConversation(this.userName);</span>
<a href="#l71.139"></a><span id="l71.139" class="difflineplus">+  },</span>
<a href="#l71.140"></a><span id="l71.140" class="difflineplus">+</span>
<a href="#l71.141"></a><span id="l71.141" class="difflineplus">+  // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineplus">+  // hovers over the buddy.</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineplus">+  getTooltipInfo() {</span>
<a href="#l71.144"></a><span id="l71.144" class="difflineplus">+    if (!this._info) {</span>
<a href="#l71.145"></a><span id="l71.145" class="difflineplus">+      return EmptyEnumerator;</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineplus">+    }</span>
<a href="#l71.147"></a><span id="l71.147" class="difflineplus">+</span>
<a href="#l71.148"></a><span id="l71.148" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l71.149"></a><span id="l71.149" class="difflineplus">+    for (let info in this._info) {</span>
<a href="#l71.150"></a><span id="l71.150" class="difflineplus">+      // If there's no value, skip the element.</span>
<a href="#l71.151"></a><span id="l71.151" class="difflineplus">+      if (!this._info[info]) {</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineplus">+        continue;</span>
<a href="#l71.153"></a><span id="l71.153" class="difflineplus">+      }</span>
<a href="#l71.154"></a><span id="l71.154" class="difflineplus">+</span>
<a href="#l71.155"></a><span id="l71.155" class="difflineplus">+      // TODO Put real labels on here.</span>
<a href="#l71.156"></a><span id="l71.156" class="difflineplus">+      tooltipInfo.push(new TooltipInfo(info, this._info[info]));</span>
<a href="#l71.157"></a><span id="l71.157" class="difflineplus">+    }</span>
<a href="#l71.158"></a><span id="l71.158" class="difflineplus">+    if (this.mood) {</span>
<a href="#l71.159"></a><span id="l71.159" class="difflineplus">+      tooltipInfo.push(new TooltipInfo(&quot;Mood&quot;, this.mood));</span>
<a href="#l71.160"></a><span id="l71.160" class="difflineplus">+    }</span>
<a href="#l71.161"></a><span id="l71.161" class="difflineplus">+</span>
<a href="#l71.162"></a><span id="l71.162" class="difflineplus">+    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l71.163"></a><span id="l71.163" class="difflineplus">+  },</span>
<a href="#l71.164"></a><span id="l71.164" class="difflineplus">+</span>
<a href="#l71.165"></a><span id="l71.165" class="difflineplus">+  remove() {</span>
<a href="#l71.166"></a><span id="l71.166" class="difflineplus">+    this._account.removeBuddy(this);</span>
<a href="#l71.167"></a><span id="l71.167" class="difflineplus">+    GenericAccountBuddyPrototype.remove.call(this);</span>
<a href="#l71.168"></a><span id="l71.168" class="difflineplus">+  },</span>
<a href="#l71.169"></a><span id="l71.169" class="difflineplus">+};</span>
<a href="#l71.170"></a><span id="l71.170" class="difflineplus">+</span>
<a href="#l71.171"></a><span id="l71.171" class="difflineplus">+/*</span>
<a href="#l71.172"></a><span id="l71.172" class="difflineplus">+ * Cut out a part of a larger string bordered by aStart and aEnd. Returns an</span>
<a href="#l71.173"></a><span id="l71.173" class="difflineplus">+ * empty string if the needle is not found.</span>
<a href="#l71.174"></a><span id="l71.174" class="difflineplus">+ */</span>
<a href="#l71.175"></a><span id="l71.175" class="difflineplus">+function extractString(aStr, aStart, aEnd) {</span>
<a href="#l71.176"></a><span id="l71.176" class="difflineplus">+  // First find the start index, then offset by the string length.</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineplus">+  let startIndex = aStr.indexOf(aStart) + aStart.length;</span>
<a href="#l71.178"></a><span id="l71.178" class="difflineplus">+  if (startIndex == -1) {</span>
<a href="#l71.179"></a><span id="l71.179" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l71.180"></a><span id="l71.180" class="difflineplus">+  }</span>
<a href="#l71.181"></a><span id="l71.181" class="difflineplus">+  // Now find the next occurrence of end after the start.</span>
<a href="#l71.182"></a><span id="l71.182" class="difflineplus">+  let endIndex = aStr.indexOf(aEnd, startIndex);</span>
<a href="#l71.183"></a><span id="l71.183" class="difflineplus">+  if (endIndex == -1) {</span>
<a href="#l71.184"></a><span id="l71.184" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l71.185"></a><span id="l71.185" class="difflineplus">+  }</span>
<a href="#l71.186"></a><span id="l71.186" class="difflineplus">+</span>
<a href="#l71.187"></a><span id="l71.187" class="difflineplus">+  return aStr.slice(startIndex, endIndex);</span>
<a href="#l71.188"></a><span id="l71.188" class="difflineplus">+}</span>
<a href="#l71.189"></a><span id="l71.189" class="difflineplus">+</span>
<a href="#l71.190"></a><span id="l71.190" class="difflineplus">+/*</span>
<a href="#l71.191"></a><span id="l71.191" class="difflineplus">+ * A magic method (originally from MSN) to stop 3rd parties from connecting.</span>
<a href="#l71.192"></a><span id="l71.192" class="difflineplus">+ * Differs from MSN by swapping MD5 for SHA256.</span>
<a href="#l71.193"></a><span id="l71.193" class="difflineplus">+ *</span>
<a href="#l71.194"></a><span id="l71.194" class="difflineplus">+ * A pre-emptive apology is necessary for those about to embark on the journey</span>
<a href="#l71.195"></a><span id="l71.195" class="difflineplus">+ * of understanding this code. I wish you luck and God's speed.</span>
<a href="#l71.196"></a><span id="l71.196" class="difflineplus">+ */</span>
<a href="#l71.197"></a><span id="l71.197" class="difflineplus">+function magicSha256(aInput) {</span>
<a href="#l71.198"></a><span id="l71.198" class="difflineplus">+  let productId = kLockAndKeyAppId;</span>
<a href="#l71.199"></a><span id="l71.199" class="difflineplus">+</span>
<a href="#l71.200"></a><span id="l71.200" class="difflineplus">+  // Create a SHA 256 hash.</span>
<a href="#l71.201"></a><span id="l71.201" class="difflineplus">+  let converter = Cc[</span>
<a href="#l71.202"></a><span id="l71.202" class="difflineplus">+    &quot;@mozilla.org/intl/scriptableunicodeconverter&quot;</span>
<a href="#l71.203"></a><span id="l71.203" class="difflineplus">+  ].createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l71.204"></a><span id="l71.204" class="difflineplus">+  converter.charset = &quot;UTF-8&quot;;</span>
<a href="#l71.205"></a><span id="l71.205" class="difflineplus">+  let data = converter.convertToByteArray(aInput);</span>
<a href="#l71.206"></a><span id="l71.206" class="difflineplus">+  let productKey = converter.convertToByteArray(kLockAndKeySecret);</span>
<a href="#l71.207"></a><span id="l71.207" class="difflineplus">+</span>
<a href="#l71.208"></a><span id="l71.208" class="difflineplus">+  let hash = Cc[&quot;@mozilla.org/security/hash;1&quot;].createInstance(</span>
<a href="#l71.209"></a><span id="l71.209" class="difflineplus">+    Ci.nsICryptoHash</span>
<a href="#l71.210"></a><span id="l71.210" class="difflineplus">+  );</span>
<a href="#l71.211"></a><span id="l71.211" class="difflineplus">+  hash.init(hash.SHA256);</span>
<a href="#l71.212"></a><span id="l71.212" class="difflineplus">+  hash.update(data, data.length);</span>
<a href="#l71.213"></a><span id="l71.213" class="difflineplus">+  hash.update(productKey, productKey.length);</span>
<a href="#l71.214"></a><span id="l71.214" class="difflineplus">+  // Finalize the hash as a set of bytes.</span>
<a href="#l71.215"></a><span id="l71.215" class="difflineplus">+  let sha256Hash = hash.finish(false);</span>
<a href="#l71.216"></a><span id="l71.216" class="difflineplus">+</span>
<a href="#l71.217"></a><span id="l71.217" class="difflineplus">+  // Split it into four integers (note that this ignores the second half of the</span>
<a href="#l71.218"></a><span id="l71.218" class="difflineplus">+  // hash).</span>
<a href="#l71.219"></a><span id="l71.219" class="difflineplus">+  let sha256Buffer = StringToArrayBuffer(sha256Hash);</span>
<a href="#l71.220"></a><span id="l71.220" class="difflineplus">+  let view = new DataView(sha256Buffer, 0, 16);</span>
<a href="#l71.221"></a><span id="l71.221" class="difflineplus">+</span>
<a href="#l71.222"></a><span id="l71.222" class="difflineplus">+  let sha256Parts = [];</span>
<a href="#l71.223"></a><span id="l71.223" class="difflineplus">+  let newHashParts = [];</span>
<a href="#l71.224"></a><span id="l71.224" class="difflineplus">+  for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l71.225"></a><span id="l71.225" class="difflineplus">+    // Ensure little-endianness is used.</span>
<a href="#l71.226"></a><span id="l71.226" class="difflineplus">+    sha256Parts.push(view.getUint32(i * 4, true));</span>
<a href="#l71.227"></a><span id="l71.227" class="difflineplus">+</span>
<a href="#l71.228"></a><span id="l71.228" class="difflineplus">+    newHashParts.push(sha256Parts[i]);</span>
<a href="#l71.229"></a><span id="l71.229" class="difflineplus">+    sha256Parts[i] &amp;= 0x7fffffff;</span>
<a href="#l71.230"></a><span id="l71.230" class="difflineplus">+  }</span>
<a href="#l71.231"></a><span id="l71.231" class="difflineplus">+</span>
<a href="#l71.232"></a><span id="l71.232" class="difflineplus">+  // Make a new string and pad with '0' to a length that's a multiple of 8.</span>
<a href="#l71.233"></a><span id="l71.233" class="difflineplus">+  let buf = aInput + productId;</span>
<a href="#l71.234"></a><span id="l71.234" class="difflineplus">+  let len = buf.length;</span>
<a href="#l71.235"></a><span id="l71.235" class="difflineplus">+  let modLen = len % 8;</span>
<a href="#l71.236"></a><span id="l71.236" class="difflineplus">+  if (modLen != 0) {</span>
<a href="#l71.237"></a><span id="l71.237" class="difflineplus">+    let fix = 8 - modLen;</span>
<a href="#l71.238"></a><span id="l71.238" class="difflineplus">+    buf += &quot;0&quot;.repeat(fix);</span>
<a href="#l71.239"></a><span id="l71.239" class="difflineplus">+    len += fix;</span>
<a href="#l71.240"></a><span id="l71.240" class="difflineplus">+  }</span>
<a href="#l71.241"></a><span id="l71.241" class="difflineplus">+</span>
<a href="#l71.242"></a><span id="l71.242" class="difflineplus">+  // Split into integers.</span>
<a href="#l71.243"></a><span id="l71.243" class="difflineplus">+  view = new DataView(StringToArrayBuffer(buf));</span>
<a href="#l71.244"></a><span id="l71.244" class="difflineplus">+</span>
<a href="#l71.245"></a><span id="l71.245" class="difflineplus">+  // This is magic.</span>
<a href="#l71.246"></a><span id="l71.246" class="difflineplus">+  let nHigh = bigInt(0);</span>
<a href="#l71.247"></a><span id="l71.247" class="difflineplus">+  let nLow = bigInt(0);</span>
<a href="#l71.248"></a><span id="l71.248" class="difflineplus">+  for (let i = 0; i &lt; len / 4; i += 2) {</span>
<a href="#l71.249"></a><span id="l71.249" class="difflineplus">+    let temp = bigInt(0x0e79a9c1)</span>
<a href="#l71.250"></a><span id="l71.250" class="difflineplus">+      .times(view.getUint32(i * 4, true))</span>
<a href="#l71.251"></a><span id="l71.251" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l71.252"></a><span id="l71.252" class="difflineplus">+    temp = temp</span>
<a href="#l71.253"></a><span id="l71.253" class="difflineplus">+      .plus(nLow)</span>
<a href="#l71.254"></a><span id="l71.254" class="difflineplus">+      .times(sha256Parts[0])</span>
<a href="#l71.255"></a><span id="l71.255" class="difflineplus">+      .plus(sha256Parts[1])</span>
<a href="#l71.256"></a><span id="l71.256" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l71.257"></a><span id="l71.257" class="difflineplus">+    nHigh = nHigh.plus(temp);</span>
<a href="#l71.258"></a><span id="l71.258" class="difflineplus">+</span>
<a href="#l71.259"></a><span id="l71.259" class="difflineplus">+    temp = temp.plus(view.getUint32((i + 1) * 4, true)).divmod(0x7fffffff)</span>
<a href="#l71.260"></a><span id="l71.260" class="difflineplus">+      .remainder;</span>
<a href="#l71.261"></a><span id="l71.261" class="difflineplus">+    nLow = temp</span>
<a href="#l71.262"></a><span id="l71.262" class="difflineplus">+      .times(sha256Parts[2])</span>
<a href="#l71.263"></a><span id="l71.263" class="difflineplus">+      .plus(sha256Parts[3])</span>
<a href="#l71.264"></a><span id="l71.264" class="difflineplus">+      .divmod(0x7fffffff).remainder;</span>
<a href="#l71.265"></a><span id="l71.265" class="difflineplus">+    nHigh = nHigh.plus(nLow);</span>
<a href="#l71.266"></a><span id="l71.266" class="difflineplus">+  }</span>
<a href="#l71.267"></a><span id="l71.267" class="difflineplus">+  nLow = nLow</span>
<a href="#l71.268"></a><span id="l71.268" class="difflineplus">+    .plus(sha256Parts[1])</span>
<a href="#l71.269"></a><span id="l71.269" class="difflineplus">+    .divmod(0x7fffffff)</span>
<a href="#l71.270"></a><span id="l71.270" class="difflineplus">+    .remainder.toJSNumber();</span>
<a href="#l71.271"></a><span id="l71.271" class="difflineplus">+  nHigh = nHigh</span>
<a href="#l71.272"></a><span id="l71.272" class="difflineplus">+    .plus(sha256Parts[3])</span>
<a href="#l71.273"></a><span id="l71.273" class="difflineplus">+    .divmod(0x7fffffff)</span>
<a href="#l71.274"></a><span id="l71.274" class="difflineplus">+    .remainder.toJSNumber();</span>
<a href="#l71.275"></a><span id="l71.275" class="difflineplus">+</span>
<a href="#l71.276"></a><span id="l71.276" class="difflineplus">+  newHashParts[0] ^= nLow;</span>
<a href="#l71.277"></a><span id="l71.277" class="difflineplus">+  newHashParts[1] ^= nHigh;</span>
<a href="#l71.278"></a><span id="l71.278" class="difflineplus">+  newHashParts[2] ^= nLow;</span>
<a href="#l71.279"></a><span id="l71.279" class="difflineplus">+  newHashParts[3] ^= nHigh;</span>
<a href="#l71.280"></a><span id="l71.280" class="difflineplus">+</span>
<a href="#l71.281"></a><span id="l71.281" class="difflineplus">+  // Make a string of the parts and convert to hexadecimal.</span>
<a href="#l71.282"></a><span id="l71.282" class="difflineplus">+  let output = &quot;&quot;;</span>
<a href="#l71.283"></a><span id="l71.283" class="difflineplus">+  for (let i = 0; i &lt; 4; ++i) {</span>
<a href="#l71.284"></a><span id="l71.284" class="difflineplus">+    let part = newHashParts[i];</span>
<a href="#l71.285"></a><span id="l71.285" class="difflineplus">+    // Adjust to little-endianness.</span>
<a href="#l71.286"></a><span id="l71.286" class="difflineplus">+    part =</span>
<a href="#l71.287"></a><span id="l71.287" class="difflineplus">+      ((part &amp; 0xff) &lt;&lt; 24) |</span>
<a href="#l71.288"></a><span id="l71.288" class="difflineplus">+      ((part &amp; 0xff00) &lt;&lt; 8) |</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineplus">+      ((part &gt;&gt; 8) &amp; 0xff00) |</span>
<a href="#l71.290"></a><span id="l71.290" class="difflineplus">+      ((part &gt;&gt; 24) &amp; 0xff);</span>
<a href="#l71.291"></a><span id="l71.291" class="difflineplus">+</span>
<a href="#l71.292"></a><span id="l71.292" class="difflineplus">+    // JavaScript likes to use signed numbers, force this to give us the</span>
<a href="#l71.293"></a><span id="l71.293" class="difflineplus">+    // unsigned representation.</span>
<a href="#l71.294"></a><span id="l71.294" class="difflineplus">+    if (part &lt; 0) {</span>
<a href="#l71.295"></a><span id="l71.295" class="difflineplus">+      part += 0xffffffff + 1;</span>
<a href="#l71.296"></a><span id="l71.296" class="difflineplus">+    }</span>
<a href="#l71.297"></a><span id="l71.297" class="difflineplus">+</span>
<a href="#l71.298"></a><span id="l71.298" class="difflineplus">+    let hexPart = part.toString(16);</span>
<a href="#l71.299"></a><span id="l71.299" class="difflineplus">+    // Ensure that the string has 8 characters (4 bytes).</span>
<a href="#l71.300"></a><span id="l71.300" class="difflineplus">+    output += &quot;0&quot;.repeat(8 - hexPart.length) + hexPart;</span>
<a href="#l71.301"></a><span id="l71.301" class="difflineplus">+  }</span>
<a href="#l71.302"></a><span id="l71.302" class="difflineplus">+</span>
<a href="#l71.303"></a><span id="l71.303" class="difflineplus">+  return output;</span>
<a href="#l71.304"></a><span id="l71.304" class="difflineplus">+}</span>
<a href="#l71.305"></a><span id="l71.305" class="difflineplus">+</span>
<a href="#l71.306"></a><span id="l71.306" class="difflineplus">+// TODO Add tests for this function.</span>
<a href="#l71.307"></a><span id="l71.307" class="difflineplus">+// Calculate the timezone offset of the local computer as [+-]HH:MM.</span>
<a href="#l71.308"></a><span id="l71.308" class="difflineplus">+function getTimezone() {</span>
<a href="#l71.309"></a><span id="l71.309" class="difflineplus">+  /*</span>
<a href="#l71.310"></a><span id="l71.310" class="difflineplus">+   * Zero-pad aNum to the length of aLen.</span>
<a href="#l71.311"></a><span id="l71.311" class="difflineplus">+   */</span>
<a href="#l71.312"></a><span id="l71.312" class="difflineplus">+  function zeroPad(aNum, aLen) {</span>
<a href="#l71.313"></a><span id="l71.313" class="difflineplus">+    let nStr = aNum.toString();</span>
<a href="#l71.314"></a><span id="l71.314" class="difflineplus">+    let nLen = nStr.length;</span>
<a href="#l71.315"></a><span id="l71.315" class="difflineplus">+</span>
<a href="#l71.316"></a><span id="l71.316" class="difflineplus">+    if (nLen &gt; aLen) {</span>
<a href="#l71.317"></a><span id="l71.317" class="difflineplus">+      throw new Error(</span>
<a href="#l71.318"></a><span id="l71.318" class="difflineplus">+        &quot;Can't zero-pad when longer than expected length: &quot; +</span>
<a href="#l71.319"></a><span id="l71.319" class="difflineplus">+          nStr +</span>
<a href="#l71.320"></a><span id="l71.320" class="difflineplus">+          &quot;.length &gt; &quot; +</span>
<a href="#l71.321"></a><span id="l71.321" class="difflineplus">+          aLen</span>
<a href="#l71.322"></a><span id="l71.322" class="difflineplus">+      );</span>
<a href="#l71.323"></a><span id="l71.323" class="difflineplus">+    }</span>
<a href="#l71.324"></a><span id="l71.324" class="difflineplus">+</span>
<a href="#l71.325"></a><span id="l71.325" class="difflineplus">+    return &quot;0&quot;.repeat(aLen - nLen) + nStr;</span>
<a href="#l71.326"></a><span id="l71.326" class="difflineplus">+  }</span>
<a href="#l71.327"></a><span id="l71.327" class="difflineplus">+</span>
<a href="#l71.328"></a><span id="l71.328" class="difflineplus">+  // Invert the sign of the timezone from JavaScript's date object.</span>
<a href="#l71.329"></a><span id="l71.329" class="difflineplus">+  let sign = &quot;+&quot;;</span>
<a href="#l71.330"></a><span id="l71.330" class="difflineplus">+  let timezone = new Date().getTimezoneOffset() * -1;</span>
<a href="#l71.331"></a><span id="l71.331" class="difflineplus">+  if (timezone &lt; 0) {</span>
<a href="#l71.332"></a><span id="l71.332" class="difflineplus">+    sign = &quot;-&quot;;</span>
<a href="#l71.333"></a><span id="l71.333" class="difflineplus">+  }</span>
<a href="#l71.334"></a><span id="l71.334" class="difflineplus">+  timezone = Math.abs(timezone);</span>
<a href="#l71.335"></a><span id="l71.335" class="difflineplus">+</span>
<a href="#l71.336"></a><span id="l71.336" class="difflineplus">+  // Separate the timezone into hours and minutes.</span>
<a href="#l71.337"></a><span id="l71.337" class="difflineplus">+  let minutes = timezone % 60;</span>
<a href="#l71.338"></a><span id="l71.338" class="difflineplus">+  let hours = (timezone - minutes) / 60;</span>
<a href="#l71.339"></a><span id="l71.339" class="difflineplus">+</span>
<a href="#l71.340"></a><span id="l71.340" class="difflineplus">+  // Ensure both hours and minutes are two digits long.</span>
<a href="#l71.341"></a><span id="l71.341" class="difflineplus">+  minutes = zeroPad(minutes, 2);</span>
<a href="#l71.342"></a><span id="l71.342" class="difflineplus">+  hours = zeroPad(hours, 2);</span>
<a href="#l71.343"></a><span id="l71.343" class="difflineplus">+</span>
<a href="#l71.344"></a><span id="l71.344" class="difflineplus">+  // The final timezone string.</span>
<a href="#l71.345"></a><span id="l71.345" class="difflineplus">+  return sign + hours + &quot;|&quot; + minutes;</span>
<a href="#l71.346"></a><span id="l71.346" class="difflineplus">+}</span>
<a href="#l71.347"></a><span id="l71.347" class="difflineplus">+</span>
<a href="#l71.348"></a><span id="l71.348" class="difflineplus">+function SkypeAccount(aProtoInstance, aImAccount) {</span>
<a href="#l71.349"></a><span id="l71.349" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l71.350"></a><span id="l71.350" class="difflineplus">+</span>
<a href="#l71.351"></a><span id="l71.351" class="difflineplus">+  // Initialize some maps.</span>
<a href="#l71.352"></a><span id="l71.352" class="difflineplus">+  this._buddies = new Map();</span>
<a href="#l71.353"></a><span id="l71.353" class="difflineplus">+  this._conversations = new Map();</span>
<a href="#l71.354"></a><span id="l71.354" class="difflineplus">+  this._chats = new Map();</span>
<a href="#l71.355"></a><span id="l71.355" class="difflineplus">+</span>
<a href="#l71.356"></a><span id="l71.356" class="difflineplus">+  this._logger = { log: this.LOG.bind(this), debug: this.DEBUG.bind(this) };</span>
<a href="#l71.357"></a><span id="l71.357" class="difflineplus">+}</span>
<a href="#l71.358"></a><span id="l71.358" class="difflineplus">+SkypeAccount.prototype = {</span>
<a href="#l71.359"></a><span id="l71.359" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l71.360"></a><span id="l71.360" class="difflineplus">+  // A Map holding the list of buddies associated with their usernames.</span>
<a href="#l71.361"></a><span id="l71.361" class="difflineplus">+  _buddies: null,</span>
<a href="#l71.362"></a><span id="l71.362" class="difflineplus">+  // A Map holding the list of open conversations by the username of the buddy.</span>
<a href="#l71.363"></a><span id="l71.363" class="difflineplus">+  _conversations: null,</span>
<a href="#l71.364"></a><span id="l71.364" class="difflineplus">+  // A Map holding the list of open (multiple user) chats by name.</span>
<a href="#l71.365"></a><span id="l71.365" class="difflineplus">+  _chats: null,</span>
<a href="#l71.366"></a><span id="l71.366" class="difflineplus">+  // The current request in the polling loop.</span>
<a href="#l71.367"></a><span id="l71.367" class="difflineplus">+  _request: null,</span>
<a href="#l71.368"></a><span id="l71.368" class="difflineplus">+  // The timer for the next poll.</span>
<a href="#l71.369"></a><span id="l71.369" class="difflineplus">+  _poller: null,</span>
<a href="#l71.370"></a><span id="l71.370" class="difflineplus">+</span>
<a href="#l71.371"></a><span id="l71.371" class="difflineplus">+  // Some tokens.</span>
<a href="#l71.372"></a><span id="l71.372" class="difflineplus">+  _skypeToken: null,</span>
<a href="#l71.373"></a><span id="l71.373" class="difflineplus">+  _registrationToken: null,</span>
<a href="#l71.374"></a><span id="l71.374" class="difflineplus">+</span>
<a href="#l71.375"></a><span id="l71.375" class="difflineplus">+  // Logger used for HTTP requests.</span>
<a href="#l71.376"></a><span id="l71.376" class="difflineplus">+  _logger: null,</span>
<a href="#l71.377"></a><span id="l71.377" class="difflineplus">+</span>
<a href="#l71.378"></a><span id="l71.378" class="difflineplus">+  mapStatusString(aStatus) {</span>
<a href="#l71.379"></a><span id="l71.379" class="difflineplus">+    if (aStatus in kStatusMap) {</span>
<a href="#l71.380"></a><span id="l71.380" class="difflineplus">+      return Ci.imIStatusInfo[&quot;STATUS_&quot; + kStatusMap[aStatus]];</span>
<a href="#l71.381"></a><span id="l71.381" class="difflineplus">+    }</span>
<a href="#l71.382"></a><span id="l71.382" class="difflineplus">+</span>
<a href="#l71.383"></a><span id="l71.383" class="difflineplus">+    // Uh-oh, we got something not in the map.</span>
<a href="#l71.384"></a><span id="l71.384" class="difflineplus">+    this.WARN(&quot;Received unknown status type: &quot; + aStatus);</span>
<a href="#l71.385"></a><span id="l71.385" class="difflineplus">+    return Ci.imIStatusInfo.STATUS_UNKNOWN;</span>
<a href="#l71.386"></a><span id="l71.386" class="difflineplus">+  },</span>
<a href="#l71.387"></a><span id="l71.387" class="difflineplus">+</span>
<a href="#l71.388"></a><span id="l71.388" class="difflineplus">+  connect() {</span>
<a href="#l71.389"></a><span id="l71.389" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l71.390"></a><span id="l71.390" class="difflineplus">+</span>
<a href="#l71.391"></a><span id="l71.391" class="difflineplus">+    this.LOG(&quot;STARTING Login&quot;);</span>
<a href="#l71.392"></a><span id="l71.392" class="difflineplus">+</span>
<a href="#l71.393"></a><span id="l71.393" class="difflineplus">+    // Perform the request to get the session token values.</span>
<a href="#l71.394"></a><span id="l71.394" class="difflineplus">+    let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l71.395"></a><span id="l71.395" class="difflineplus">+    let options = {</span>
<a href="#l71.396"></a><span id="l71.396" class="difflineplus">+      onLoad: this._onPieResponse.bind(this),</span>
<a href="#l71.397"></a><span id="l71.397" class="difflineplus">+      onError: this._onHttpFailure(&quot;requesting pie&quot;),</span>
<a href="#l71.398"></a><span id="l71.398" class="difflineplus">+      logger: this.logger,</span>
<a href="#l71.399"></a><span id="l71.399" class="difflineplus">+    };</span>
<a href="#l71.400"></a><span id="l71.400" class="difflineplus">+    httpRequest(loginUrl, options);</span>
<a href="#l71.401"></a><span id="l71.401" class="difflineplus">+  },</span>
<a href="#l71.402"></a><span id="l71.402" class="difflineplus">+</span>
<a href="#l71.403"></a><span id="l71.403" class="difflineplus">+  /*</span>
<a href="#l71.404"></a><span id="l71.404" class="difflineplus">+   * Generates a callback which causes the account to enter an error state with</span>
<a href="#l71.405"></a><span id="l71.405" class="difflineplus">+   * the given error string.</span>
<a href="#l71.406"></a><span id="l71.406" class="difflineplus">+   */</span>
<a href="#l71.407"></a><span id="l71.407" class="difflineplus">+  _onHttpFailure(aErrorStr) {</span>
<a href="#l71.408"></a><span id="l71.408" class="difflineplus">+    return (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l71.409"></a><span id="l71.409" class="difflineplus">+      this.ERROR(&quot;HTTP failure occurred: &quot; + aErrorStr + &quot;\n&quot; + aError);</span>
<a href="#l71.410"></a><span id="l71.410" class="difflineplus">+      this._disconnectWithAuthFailure();</span>
<a href="#l71.411"></a><span id="l71.411" class="difflineplus">+    };</span>
<a href="#l71.412"></a><span id="l71.412" class="difflineplus">+  },</span>
<a href="#l71.413"></a><span id="l71.413" class="difflineplus">+</span>
<a href="#l71.414"></a><span id="l71.414" class="difflineplus">+  _onHttpError(aError, aResponse, aXhr) {</span>
<a href="#l71.415"></a><span id="l71.415" class="difflineplus">+    this.ERROR(&quot;Received error response:\n&quot; + aError);</span>
<a href="#l71.416"></a><span id="l71.416" class="difflineplus">+  },</span>
<a href="#l71.417"></a><span id="l71.417" class="difflineplus">+</span>
<a href="#l71.418"></a><span id="l71.418" class="difflineplus">+  // Mmmmm...pie.</span>
<a href="#l71.419"></a><span id="l71.419" class="difflineplus">+  _onPieResponse(aResponse, aXhr) {</span>
<a href="#l71.420"></a><span id="l71.420" class="difflineplus">+    this.reportConnecting(_(&quot;connecting.authenticating&quot;));</span>
<a href="#l71.421"></a><span id="l71.421" class="difflineplus">+</span>
<a href="#l71.422"></a><span id="l71.422" class="difflineplus">+    // Parse the pie/etm and do the actual login.</span>
<a href="#l71.423"></a><span id="l71.423" class="difflineplus">+    let loginUrl = &quot;https://&quot; + kLoginHost + &quot;/login&quot;;</span>
<a href="#l71.424"></a><span id="l71.424" class="difflineplus">+</span>
<a href="#l71.425"></a><span id="l71.425" class="difflineplus">+    let params = [</span>
<a href="#l71.426"></a><span id="l71.426" class="difflineplus">+      [&quot;client_id&quot;, kClientId],</span>
<a href="#l71.427"></a><span id="l71.427" class="difflineplus">+      [&quot;redirect_uri&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l71.428"></a><span id="l71.428" class="difflineplus">+    ];</span>
<a href="#l71.429"></a><span id="l71.429" class="difflineplus">+    loginUrl +=</span>
<a href="#l71.430"></a><span id="l71.430" class="difflineplus">+      &quot;?&quot; + params.map(p =&gt; p.map(encodeURIComponent).join(&quot;=&quot;)).join(&quot;&amp;&quot;);</span>
<a href="#l71.431"></a><span id="l71.431" class="difflineplus">+</span>
<a href="#l71.432"></a><span id="l71.432" class="difflineplus">+    this.LOG(&quot;Received PIE response:\n&quot; + aResponse);</span>
<a href="#l71.433"></a><span id="l71.433" class="difflineplus">+</span>
<a href="#l71.434"></a><span id="l71.434" class="difflineplus">+    // Note that the response is really just an HTML page with some JavaScript</span>
<a href="#l71.435"></a><span id="l71.435" class="difflineplus">+    // and forms that these values are being pulled from.</span>
<a href="#l71.436"></a><span id="l71.436" class="difflineplus">+    let pie = extractString(aResponse, '=&quot;pie&quot; value=&quot;', '&quot;');</span>
<a href="#l71.437"></a><span id="l71.437" class="difflineplus">+    if (!pie) {</span>
<a href="#l71.438"></a><span id="l71.438" class="difflineplus">+      this.ERROR(&quot;pie value not found.&quot;);</span>
<a href="#l71.439"></a><span id="l71.439" class="difflineplus">+      this._disconnectWithAuthFailure();</span>
<a href="#l71.440"></a><span id="l71.440" class="difflineplus">+      return;</span>
<a href="#l71.441"></a><span id="l71.441" class="difflineplus">+    }</span>
<a href="#l71.442"></a><span id="l71.442" class="difflineplus">+    let etm = extractString(aResponse, '=&quot;etm&quot; value=&quot;', '&quot;');</span>
<a href="#l71.443"></a><span id="l71.443" class="difflineplus">+    if (!etm) {</span>
<a href="#l71.444"></a><span id="l71.444" class="difflineplus">+      this.ERROR(&quot;etm value not found.&quot;);</span>
<a href="#l71.445"></a><span id="l71.445" class="difflineplus">+      this._disconnectWithAuthFailure();</span>
<a href="#l71.446"></a><span id="l71.446" class="difflineplus">+      return;</span>
<a href="#l71.447"></a><span id="l71.447" class="difflineplus">+    }</span>
<a href="#l71.448"></a><span id="l71.448" class="difflineplus">+</span>
<a href="#l71.449"></a><span id="l71.449" class="difflineplus">+    let options = {</span>
<a href="#l71.450"></a><span id="l71.450" class="difflineplus">+      onLoad: this._onLoginResponse.bind(this),</span>
<a href="#l71.451"></a><span id="l71.451" class="difflineplus">+      onError: this._onHttpFailure(&quot;requesting skypetoken&quot;),</span>
<a href="#l71.452"></a><span id="l71.452" class="difflineplus">+      postData: [</span>
<a href="#l71.453"></a><span id="l71.453" class="difflineplus">+        [&quot;username&quot;, this.name],</span>
<a href="#l71.454"></a><span id="l71.454" class="difflineplus">+        [&quot;password&quot;, this.imAccount.password],</span>
<a href="#l71.455"></a><span id="l71.455" class="difflineplus">+        [&quot;timezone_field&quot;, getTimezone()],</span>
<a href="#l71.456"></a><span id="l71.456" class="difflineplus">+        [&quot;pie&quot;, pie],</span>
<a href="#l71.457"></a><span id="l71.457" class="difflineplus">+        [&quot;etm&quot;, etm],</span>
<a href="#l71.458"></a><span id="l71.458" class="difflineplus">+        [&quot;js_time&quot;, Date.now()],</span>
<a href="#l71.459"></a><span id="l71.459" class="difflineplus">+        [&quot;client_id&quot;, kClientId],</span>
<a href="#l71.460"></a><span id="l71.460" class="difflineplus">+        [&quot;redirect_uri&quot;, &quot;https://web.skype.com/&quot;],</span>
<a href="#l71.461"></a><span id="l71.461" class="difflineplus">+      ],</span>
<a href="#l71.462"></a><span id="l71.462" class="difflineplus">+      headers: [</span>
<a href="#l71.463"></a><span id="l71.463" class="difflineplus">+        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l71.464"></a><span id="l71.464" class="difflineplus">+        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l71.465"></a><span id="l71.465" class="difflineplus">+        // response from doing a 302 Found Location redirect, since</span>
<a href="#l71.466"></a><span id="l71.466" class="difflineplus">+        // there are important headers that need to be plucked before</span>
<a href="#l71.467"></a><span id="l71.467" class="difflineplus">+        // the redirect happens.</span>
<a href="#l71.468"></a><span id="l71.468" class="difflineplus">+        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l71.469"></a><span id="l71.469" class="difflineplus">+      ],</span>
<a href="#l71.470"></a><span id="l71.470" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.471"></a><span id="l71.471" class="difflineplus">+    };</span>
<a href="#l71.472"></a><span id="l71.472" class="difflineplus">+    httpRequest(loginUrl, options);</span>
<a href="#l71.473"></a><span id="l71.473" class="difflineplus">+  },</span>
<a href="#l71.474"></a><span id="l71.474" class="difflineplus">+  _onLoginResponse(aResponse, aXhr) {</span>
<a href="#l71.475"></a><span id="l71.475" class="difflineplus">+    this.LOG(&quot;Received LOGIN response:\n&quot; + aResponse);</span>
<a href="#l71.476"></a><span id="l71.476" class="difflineplus">+</span>
<a href="#l71.477"></a><span id="l71.477" class="difflineplus">+    let refreshToken = extractString(aResponse, '=&quot;skypetoken&quot; value=&quot;', '&quot;');</span>
<a href="#l71.478"></a><span id="l71.478" class="difflineplus">+    if (!refreshToken) {</span>
<a href="#l71.479"></a><span id="l71.479" class="difflineplus">+      this.ERROR(&quot;skypetoken value not found.&quot;);</span>
<a href="#l71.480"></a><span id="l71.480" class="difflineplus">+      this._disconnectWithAuthFailure();</span>
<a href="#l71.481"></a><span id="l71.481" class="difflineplus">+      return;</span>
<a href="#l71.482"></a><span id="l71.482" class="difflineplus">+    }</span>
<a href="#l71.483"></a><span id="l71.483" class="difflineplus">+</span>
<a href="#l71.484"></a><span id="l71.484" class="difflineplus">+    // All done!</span>
<a href="#l71.485"></a><span id="l71.485" class="difflineplus">+    this._skypeToken = refreshToken;</span>
<a href="#l71.486"></a><span id="l71.486" class="difflineplus">+    this.LOG(&quot;Received Skype token: &quot; + this._skypeToken);</span>
<a href="#l71.487"></a><span id="l71.487" class="difflineplus">+</span>
<a href="#l71.488"></a><span id="l71.488" class="difflineplus">+    if (this._registrationToken) {</span>
<a href="#l71.489"></a><span id="l71.489" class="difflineplus">+      // Subscribe to receive particular events.</span>
<a href="#l71.490"></a><span id="l71.490" class="difflineplus">+      this._subscribe();</span>
<a href="#l71.491"></a><span id="l71.491" class="difflineplus">+      return;</span>
<a href="#l71.492"></a><span id="l71.492" class="difflineplus">+    }</span>
<a href="#l71.493"></a><span id="l71.493" class="difflineplus">+</span>
<a href="#l71.494"></a><span id="l71.494" class="difflineplus">+    this.reportConnecting(_(&quot;connecting.registrationToken&quot;));</span>
<a href="#l71.495"></a><span id="l71.495" class="difflineplus">+</span>
<a href="#l71.496"></a><span id="l71.496" class="difflineplus">+    // Request the registration token.</span>
<a href="#l71.497"></a><span id="l71.497" class="difflineplus">+    let messagesUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints&quot;;</span>
<a href="#l71.498"></a><span id="l71.498" class="difflineplus">+    // The current time in seconds, converted to a string.</span>
<a href="#l71.499"></a><span id="l71.499" class="difflineplus">+    let curTime = String(Math.floor(Date.now() / 1000));</span>
<a href="#l71.500"></a><span id="l71.500" class="difflineplus">+    let response = magicSha256(curTime);</span>
<a href="#l71.501"></a><span id="l71.501" class="difflineplus">+    let options = {</span>
<a href="#l71.502"></a><span id="l71.502" class="difflineplus">+      onLoad: this._onRegistrationTokenReceived.bind(this),</span>
<a href="#l71.503"></a><span id="l71.503" class="difflineplus">+      onError: (aError, aResponse, aXhr) =&gt; {</span>
<a href="#l71.504"></a><span id="l71.504" class="difflineplus">+        this.ERROR(</span>
<a href="#l71.505"></a><span id="l71.505" class="difflineplus">+          &quot;HTTP failure occurred: requesting registration token\n&quot; + aError</span>
<a href="#l71.506"></a><span id="l71.506" class="difflineplus">+        );</span>
<a href="#l71.507"></a><span id="l71.507" class="difflineplus">+        this._disconnectWithAuthFailure(&quot;error.registrationToken&quot;);</span>
<a href="#l71.508"></a><span id="l71.508" class="difflineplus">+      },</span>
<a href="#l71.509"></a><span id="l71.509" class="difflineplus">+      postData: &quot;{}&quot;, // Empty JSON object.</span>
<a href="#l71.510"></a><span id="l71.510" class="difflineplus">+      headers: [</span>
<a href="#l71.511"></a><span id="l71.511" class="difflineplus">+        [&quot;Connection&quot;, &quot;close&quot;],</span>
<a href="#l71.512"></a><span id="l71.512" class="difflineplus">+        // BehaviorOverride is a custom microsoft header. It stops the</span>
<a href="#l71.513"></a><span id="l71.513" class="difflineplus">+        // response from doing a 302 Found Location redirect, since</span>
<a href="#l71.514"></a><span id="l71.514" class="difflineplus">+        // there are important headers that need to be plucked before</span>
<a href="#l71.515"></a><span id="l71.515" class="difflineplus">+        // the redirect happens.</span>
<a href="#l71.516"></a><span id="l71.516" class="difflineplus">+        [&quot;BehaviorOverride&quot;, &quot;redirectAs404&quot;],</span>
<a href="#l71.517"></a><span id="l71.517" class="difflineplus">+        [</span>
<a href="#l71.518"></a><span id="l71.518" class="difflineplus">+          &quot;LockAndKey&quot;,</span>
<a href="#l71.519"></a><span id="l71.519" class="difflineplus">+          &quot;appId=&quot; +</span>
<a href="#l71.520"></a><span id="l71.520" class="difflineplus">+            kLockAndKeyAppId +</span>
<a href="#l71.521"></a><span id="l71.521" class="difflineplus">+            &quot;; time=&quot; +</span>
<a href="#l71.522"></a><span id="l71.522" class="difflineplus">+            curTime +</span>
<a href="#l71.523"></a><span id="l71.523" class="difflineplus">+            &quot;; lockAndKeyResponse=&quot; +</span>
<a href="#l71.524"></a><span id="l71.524" class="difflineplus">+            response,</span>
<a href="#l71.525"></a><span id="l71.525" class="difflineplus">+        ],</span>
<a href="#l71.526"></a><span id="l71.526" class="difflineplus">+        [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l71.527"></a><span id="l71.527" class="difflineplus">+        [&quot;Authentication&quot;, &quot;skypetoken=&quot; + this._skypeToken],</span>
<a href="#l71.528"></a><span id="l71.528" class="difflineplus">+      ],</span>
<a href="#l71.529"></a><span id="l71.529" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.530"></a><span id="l71.530" class="difflineplus">+    };</span>
<a href="#l71.531"></a><span id="l71.531" class="difflineplus">+    httpRequest(messagesUrl, options);</span>
<a href="#l71.532"></a><span id="l71.532" class="difflineplus">+  },</span>
<a href="#l71.533"></a><span id="l71.533" class="difflineplus">+  _onRegistrationTokenReceived(aResponse, aXhr) {</span>
<a href="#l71.534"></a><span id="l71.534" class="difflineplus">+    this.LOG(&quot;Registration token received: &quot; + aResponse);</span>
<a href="#l71.535"></a><span id="l71.535" class="difflineplus">+</span>
<a href="#l71.536"></a><span id="l71.536" class="difflineplus">+    let registrationToken = aXhr.getResponseHeader(&quot;Set-RegistrationToken&quot;);</span>
<a href="#l71.537"></a><span id="l71.537" class="difflineplus">+    this.LOG(&quot;regToken: &quot; + registrationToken);</span>
<a href="#l71.538"></a><span id="l71.538" class="difflineplus">+    if (!registrationToken) {</span>
<a href="#l71.539"></a><span id="l71.539" class="difflineplus">+      this.ERROR(&quot;registraation token value not found.&quot;);</span>
<a href="#l71.540"></a><span id="l71.540" class="difflineplus">+      this._disconnectWithAuthFailure();</span>
<a href="#l71.541"></a><span id="l71.541" class="difflineplus">+      return;</span>
<a href="#l71.542"></a><span id="l71.542" class="difflineplus">+    }</span>
<a href="#l71.543"></a><span id="l71.543" class="difflineplus">+</span>
<a href="#l71.544"></a><span id="l71.544" class="difflineplus">+    this._registrationToken = registrationToken;</span>
<a href="#l71.545"></a><span id="l71.545" class="difflineplus">+    this._subscribe();</span>
<a href="#l71.546"></a><span id="l71.546" class="difflineplus">+  },</span>
<a href="#l71.547"></a><span id="l71.547" class="difflineplus">+</span>
<a href="#l71.548"></a><span id="l71.548" class="difflineplus">+  // Subscribe to the events we want to see.</span>
<a href="#l71.549"></a><span id="l71.549" class="difflineplus">+  _subscribe() {</span>
<a href="#l71.550"></a><span id="l71.550" class="difflineplus">+    this.LOG(&quot;Sending subscription.&quot;);</span>
<a href="#l71.551"></a><span id="l71.551" class="difflineplus">+</span>
<a href="#l71.552"></a><span id="l71.552" class="difflineplus">+    // Subscribe to particular events.</span>
<a href="#l71.553"></a><span id="l71.553" class="difflineplus">+    let messagesUrl =</span>
<a href="#l71.554"></a><span id="l71.554" class="difflineplus">+      &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/endpoints/SELF/subscriptions&quot;;</span>
<a href="#l71.555"></a><span id="l71.555" class="difflineplus">+    // The endpoints to subscribe to.</span>
<a href="#l71.556"></a><span id="l71.556" class="difflineplus">+    let subscriptions = {</span>
<a href="#l71.557"></a><span id="l71.557" class="difflineplus">+      interestedResources: [</span>
<a href="#l71.558"></a><span id="l71.558" class="difflineplus">+        &quot;/v1/users/ME/conversations/ALL/properties&quot;,</span>
<a href="#l71.559"></a><span id="l71.559" class="difflineplus">+        &quot;/v1/users/ME/conversations/ALL/messages&quot;,</span>
<a href="#l71.560"></a><span id="l71.560" class="difflineplus">+        &quot;/v1/users/ME/contacts/ALL&quot;,</span>
<a href="#l71.561"></a><span id="l71.561" class="difflineplus">+        &quot;/v1/threads/ALL&quot;,</span>
<a href="#l71.562"></a><span id="l71.562" class="difflineplus">+      ],</span>
<a href="#l71.563"></a><span id="l71.563" class="difflineplus">+      template: &quot;raw&quot;,</span>
<a href="#l71.564"></a><span id="l71.564" class="difflineplus">+      channelType: &quot;httpLongPoll&quot;,</span>
<a href="#l71.565"></a><span id="l71.565" class="difflineplus">+    };</span>
<a href="#l71.566"></a><span id="l71.566" class="difflineplus">+    let options = {</span>
<a href="#l71.567"></a><span id="l71.567" class="difflineplus">+      onLoad: this._onSubscription.bind(this),</span>
<a href="#l71.568"></a><span id="l71.568" class="difflineplus">+      onError: this._onHttpFailure(&quot;subscribing to notifications&quot;),</span>
<a href="#l71.569"></a><span id="l71.569" class="difflineplus">+      postData: JSON.stringify(subscriptions),</span>
<a href="#l71.570"></a><span id="l71.570" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.571"></a><span id="l71.571" class="difflineplus">+    };</span>
<a href="#l71.572"></a><span id="l71.572" class="difflineplus">+    this._messagesRequest(messagesUrl, options);</span>
<a href="#l71.573"></a><span id="l71.573" class="difflineplus">+  },</span>
<a href="#l71.574"></a><span id="l71.574" class="difflineplus">+</span>
<a href="#l71.575"></a><span id="l71.575" class="difflineplus">+  _onSubscription(aResponse, aXhr) {</span>
<a href="#l71.576"></a><span id="l71.576" class="difflineplus">+    this.LOG(&quot;Got subscription response: &quot; + aResponse);</span>
<a href="#l71.577"></a><span id="l71.577" class="difflineplus">+    this.reportConnected();</span>
<a href="#l71.578"></a><span id="l71.578" class="difflineplus">+</span>
<a href="#l71.579"></a><span id="l71.579" class="difflineplus">+    // TODO Check auth requests.</span>
<a href="#l71.580"></a><span id="l71.580" class="difflineplus">+</span>
<a href="#l71.581"></a><span id="l71.581" class="difflineplus">+    // Get friends list.</span>
<a href="#l71.582"></a><span id="l71.582" class="difflineplus">+    let contactListUrl = &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts&quot;;</span>
<a href="#l71.583"></a><span id="l71.583" class="difflineplus">+    let options = {</span>
<a href="#l71.584"></a><span id="l71.584" class="difflineplus">+      onLoad: this._onContactsList.bind(this),</span>
<a href="#l71.585"></a><span id="l71.585" class="difflineplus">+      onError: this._onHttpError.bind(this),</span>
<a href="#l71.586"></a><span id="l71.586" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.587"></a><span id="l71.587" class="difflineplus">+    };</span>
<a href="#l71.588"></a><span id="l71.588" class="difflineplus">+    this._contactsRequest(contactListUrl, options);</span>
<a href="#l71.589"></a><span id="l71.589" class="difflineplus">+</span>
<a href="#l71.590"></a><span id="l71.590" class="difflineplus">+    // Poll for messages.</span>
<a href="#l71.591"></a><span id="l71.591" class="difflineplus">+    this._getMessages();</span>
<a href="#l71.592"></a><span id="l71.592" class="difflineplus">+  },</span>
<a href="#l71.593"></a><span id="l71.593" class="difflineplus">+</span>
<a href="#l71.594"></a><span id="l71.594" class="difflineplus">+  _onContactsList(aResponse, aXhr) {</span>
<a href="#l71.595"></a><span id="l71.595" class="difflineplus">+    this.LOG(&quot;Contacts list: &quot; + aResponse);</span>
<a href="#l71.596"></a><span id="l71.596" class="difflineplus">+</span>
<a href="#l71.597"></a><span id="l71.597" class="difflineplus">+    let buddies = JSON.parse(aResponse);</span>
<a href="#l71.598"></a><span id="l71.598" class="difflineplus">+    if (!buddies) {</span>
<a href="#l71.599"></a><span id="l71.599" class="difflineplus">+      this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l71.600"></a><span id="l71.600" class="difflineplus">+      return;</span>
<a href="#l71.601"></a><span id="l71.601" class="difflineplus">+    }</span>
<a href="#l71.602"></a><span id="l71.602" class="difflineplus">+</span>
<a href="#l71.603"></a><span id="l71.603" class="difflineplus">+    // You have no friends. :( Nothing to do, just move along.</span>
<a href="#l71.604"></a><span id="l71.604" class="difflineplus">+    if (!buddies.length) {</span>
<a href="#l71.605"></a><span id="l71.605" class="difflineplus">+      return;</span>
<a href="#l71.606"></a><span id="l71.606" class="difflineplus">+    }</span>
<a href="#l71.607"></a><span id="l71.607" class="difflineplus">+</span>
<a href="#l71.608"></a><span id="l71.608" class="difflineplus">+    // This gets a little confusing, buddyObj refers to the JSON that was parsed</span>
<a href="#l71.609"></a><span id="l71.609" class="difflineplus">+    // and returned from the server, buddy refers to the prplIAccountBuddy.</span>
<a href="#l71.610"></a><span id="l71.610" class="difflineplus">+    for (let buddyObj of buddies) {</span>
<a href="#l71.611"></a><span id="l71.611" class="difflineplus">+      let buddy = this._buddies.get(buddyObj.skypename);</span>
<a href="#l71.612"></a><span id="l71.612" class="difflineplus">+      if (!buddy) {</span>
<a href="#l71.613"></a><span id="l71.613" class="difflineplus">+        buddy = new SkypeAccountBuddy(</span>
<a href="#l71.614"></a><span id="l71.614" class="difflineplus">+          this,</span>
<a href="#l71.615"></a><span id="l71.615" class="difflineplus">+          null,</span>
<a href="#l71.616"></a><span id="l71.616" class="difflineplus">+          Services.tags.defaultTag,</span>
<a href="#l71.617"></a><span id="l71.617" class="difflineplus">+          buddyObj.skypename</span>
<a href="#l71.618"></a><span id="l71.618" class="difflineplus">+        );</span>
<a href="#l71.619"></a><span id="l71.619" class="difflineplus">+</span>
<a href="#l71.620"></a><span id="l71.620" class="difflineplus">+        // Store the buddy for later.</span>
<a href="#l71.621"></a><span id="l71.621" class="difflineplus">+        this._buddies.set(buddyObj.skypename, buddy);</span>
<a href="#l71.622"></a><span id="l71.622" class="difflineplus">+</span>
<a href="#l71.623"></a><span id="l71.623" class="difflineplus">+        // Notify the UI of the buddy.</span>
<a href="#l71.624"></a><span id="l71.624" class="difflineplus">+        Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l71.625"></a><span id="l71.625" class="difflineplus">+      }</span>
<a href="#l71.626"></a><span id="l71.626" class="difflineplus">+</span>
<a href="#l71.627"></a><span id="l71.627" class="difflineplus">+      // TODO There is also fullname / skypename.</span>
<a href="#l71.628"></a><span id="l71.628" class="difflineplus">+      // Note that display_name is the public alias that the buddy has set for</span>
<a href="#l71.629"></a><span id="l71.629" class="difflineplus">+      // themselves, skypename is the buddy's unique ID name, fullname is their</span>
<a href="#l71.630"></a><span id="l71.630" class="difflineplus">+      // real name.</span>
<a href="#l71.631"></a><span id="l71.631" class="difflineplus">+      if (buddyObj.display_name) {</span>
<a href="#l71.632"></a><span id="l71.632" class="difflineplus">+        buddy.serverAlias = buddyObj.display_name;</span>
<a href="#l71.633"></a><span id="l71.633" class="difflineplus">+      }</span>
<a href="#l71.634"></a><span id="l71.634" class="difflineplus">+      // Store the buddy info into the object for tooltips.</span>
<a href="#l71.635"></a><span id="l71.635" class="difflineplus">+      buddy._info = buddyObj;</span>
<a href="#l71.636"></a><span id="l71.636" class="difflineplus">+</span>
<a href="#l71.637"></a><span id="l71.637" class="difflineplus">+      // Set the buddy's status to offline until we get an update.</span>
<a href="#l71.638"></a><span id="l71.638" class="difflineplus">+      buddy.setStatus(Ci.imIStatusInfo.STATUS_OFFLINE, &quot;&quot;);</span>
<a href="#l71.639"></a><span id="l71.639" class="difflineplus">+    }</span>
<a href="#l71.640"></a><span id="l71.640" class="difflineplus">+</span>
<a href="#l71.641"></a><span id="l71.641" class="difflineplus">+    // Download profiles.</span>
<a href="#l71.642"></a><span id="l71.642" class="difflineplus">+    let profilesUrl =</span>
<a href="#l71.643"></a><span id="l71.643" class="difflineplus">+      &quot;https://&quot; + kContactsHost + &quot;/users/self/contacts/profiles&quot;;</span>
<a href="#l71.644"></a><span id="l71.644" class="difflineplus">+    let options = {</span>
<a href="#l71.645"></a><span id="l71.645" class="difflineplus">+      postData: buddies.map(b =&gt; [&quot;contacts[]&quot;, b.skypename]),</span>
<a href="#l71.646"></a><span id="l71.646" class="difflineplus">+      onLoad: this._onProfiles.bind(this),</span>
<a href="#l71.647"></a><span id="l71.647" class="difflineplus">+      onError: this._onHttpError.bind(this),</span>
<a href="#l71.648"></a><span id="l71.648" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.649"></a><span id="l71.649" class="difflineplus">+    };</span>
<a href="#l71.650"></a><span id="l71.650" class="difflineplus">+    this.LOG(JSON.stringify(options));</span>
<a href="#l71.651"></a><span id="l71.651" class="difflineplus">+    this._contactsRequest(profilesUrl, options);</span>
<a href="#l71.652"></a><span id="l71.652" class="difflineplus">+</span>
<a href="#l71.653"></a><span id="l71.653" class="difflineplus">+    // Subscribe to user statuses.</span>
<a href="#l71.654"></a><span id="l71.654" class="difflineplus">+    let contactsUrl = &quot;https://&quot; + kMessagesHost + &quot;/v1/users/ME/contacts&quot;;</span>
<a href="#l71.655"></a><span id="l71.655" class="difflineplus">+    let contacts = buddies.map(b =&gt; {</span>
<a href="#l71.656"></a><span id="l71.656" class="difflineplus">+      return { id: &quot;8:&quot; + b.skypename };</span>
<a href="#l71.657"></a><span id="l71.657" class="difflineplus">+    });</span>
<a href="#l71.658"></a><span id="l71.658" class="difflineplus">+    options = {</span>
<a href="#l71.659"></a><span id="l71.659" class="difflineplus">+      postData: JSON.stringify({ contacts }),</span>
<a href="#l71.660"></a><span id="l71.660" class="difflineplus">+      onLoad: (aResponse, aXhr) =&gt;</span>
<a href="#l71.661"></a><span id="l71.661" class="difflineplus">+        this.LOG(&quot;Successfully subscribed to contacts.&quot;),</span>
<a href="#l71.662"></a><span id="l71.662" class="difflineplus">+      onError: this._onHttpError.bind(this),</span>
<a href="#l71.663"></a><span id="l71.663" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.664"></a><span id="l71.664" class="difflineplus">+    };</span>
<a href="#l71.665"></a><span id="l71.665" class="difflineplus">+    this.LOG(JSON.stringify(options));</span>
<a href="#l71.666"></a><span id="l71.666" class="difflineplus">+    this._messagesRequest(contactsUrl, options);</span>
<a href="#l71.667"></a><span id="l71.667" class="difflineplus">+  },</span>
<a href="#l71.668"></a><span id="l71.668" class="difflineplus">+</span>
<a href="#l71.669"></a><span id="l71.669" class="difflineplus">+  _onProfiles(aResponse, aXhr) {</span>
<a href="#l71.670"></a><span id="l71.670" class="difflineplus">+    this.LOG(&quot;Profiles: &quot; + aResponse);</span>
<a href="#l71.671"></a><span id="l71.671" class="difflineplus">+</span>
<a href="#l71.672"></a><span id="l71.672" class="difflineplus">+    let skypeContacts = JSON.parse(aResponse);</span>
<a href="#l71.673"></a><span id="l71.673" class="difflineplus">+</span>
<a href="#l71.674"></a><span id="l71.674" class="difflineplus">+    // TODO Error checking.</span>
<a href="#l71.675"></a><span id="l71.675" class="difflineplus">+</span>
<a href="#l71.676"></a><span id="l71.676" class="difflineplus">+    for (let skypeContact of skypeContacts) {</span>
<a href="#l71.677"></a><span id="l71.677" class="difflineplus">+      let username = skypeContact.username;</span>
<a href="#l71.678"></a><span id="l71.678" class="difflineplus">+</span>
<a href="#l71.679"></a><span id="l71.679" class="difflineplus">+      let buddy = this._buddies.get(username);</span>
<a href="#l71.680"></a><span id="l71.680" class="difflineplus">+      if (!buddy) {</span>
<a href="#l71.681"></a><span id="l71.681" class="difflineplus">+        continue;</span>
<a href="#l71.682"></a><span id="l71.682" class="difflineplus">+      }</span>
<a href="#l71.683"></a><span id="l71.683" class="difflineplus">+</span>
<a href="#l71.684"></a><span id="l71.684" class="difflineplus">+      // Set some properties on the buddy.</span>
<a href="#l71.685"></a><span id="l71.685" class="difflineplus">+      buddy.serverAlias = skypeContact.displayname;</span>
<a href="#l71.686"></a><span id="l71.686" class="difflineplus">+      // TODO There's also firstname and lastname fields.</span>
<a href="#l71.687"></a><span id="l71.687" class="difflineplus">+      buddy.mood = skypeContact.mood;</span>
<a href="#l71.688"></a><span id="l71.688" class="difflineplus">+</span>
<a href="#l71.689"></a><span id="l71.689" class="difflineplus">+      // TODO Download the file and store it in the profile.</span>
<a href="#l71.690"></a><span id="l71.690" class="difflineplus">+      let avatarUrl = skypeContact.avatarUrl;</span>
<a href="#l71.691"></a><span id="l71.691" class="difflineplus">+      if (!avatarUrl) {</span>
<a href="#l71.692"></a><span id="l71.692" class="difflineplus">+        avatarUrl =</span>
<a href="#l71.693"></a><span id="l71.693" class="difflineplus">+          &quot;https://&quot; +</span>
<a href="#l71.694"></a><span id="l71.694" class="difflineplus">+          kContactsHost +</span>
<a href="#l71.695"></a><span id="l71.695" class="difflineplus">+          &quot;/users/&quot; +</span>
<a href="#l71.696"></a><span id="l71.696" class="difflineplus">+          buddy.userName +</span>
<a href="#l71.697"></a><span id="l71.697" class="difflineplus">+          &quot;/profile/avatar&quot;;</span>
<a href="#l71.698"></a><span id="l71.698" class="difflineplus">+      }</span>
<a href="#l71.699"></a><span id="l71.699" class="difflineplus">+      buddy.buddyIconFilename = skypeContact.avatarUrl;</span>
<a href="#l71.700"></a><span id="l71.700" class="difflineplus">+    }</span>
<a href="#l71.701"></a><span id="l71.701" class="difflineplus">+  },</span>
<a href="#l71.702"></a><span id="l71.702" class="difflineplus">+</span>
<a href="#l71.703"></a><span id="l71.703" class="difflineplus">+  /*</span>
<a href="#l71.704"></a><span id="l71.704" class="difflineplus">+   * Download the actual messages, this will recurse through its callback.</span>
<a href="#l71.705"></a><span id="l71.705" class="difflineplus">+   */</span>
<a href="#l71.706"></a><span id="l71.706" class="difflineplus">+  _getMessages() {</span>
<a href="#l71.707"></a><span id="l71.707" class="difflineplus">+    let messagesUrl =</span>
<a href="#l71.708"></a><span id="l71.708" class="difflineplus">+      &quot;https://&quot; +</span>
<a href="#l71.709"></a><span id="l71.709" class="difflineplus">+      kMessagesHost +</span>
<a href="#l71.710"></a><span id="l71.710" class="difflineplus">+      &quot;/v1/users/ME/endpoints/SELF/subscriptions/0/poll&quot;;</span>
<a href="#l71.711"></a><span id="l71.711" class="difflineplus">+    let options = {</span>
<a href="#l71.712"></a><span id="l71.712" class="difflineplus">+      method: &quot;POST&quot;,</span>
<a href="#l71.713"></a><span id="l71.713" class="difflineplus">+      onLoad: this._onMessages.bind(this),</span>
<a href="#l71.714"></a><span id="l71.714" class="difflineplus">+      onError: this._onHttpError.bind(this),</span>
<a href="#l71.715"></a><span id="l71.715" class="difflineplus">+      logger: this._logger,</span>
<a href="#l71.716"></a><span id="l71.716" class="difflineplus">+    };</span>
<a href="#l71.717"></a><span id="l71.717" class="difflineplus">+    this._request = this._messagesRequest(messagesUrl, options);</span>
<a href="#l71.718"></a><span id="l71.718" class="difflineplus">+  },</span>
<a href="#l71.719"></a><span id="l71.719" class="difflineplus">+</span>
<a href="#l71.720"></a><span id="l71.720" class="difflineplus">+  _onMessages(aResponse, aXhr) {</span>
<a href="#l71.721"></a><span id="l71.721" class="difflineplus">+    this.LOG(&quot;Messages: &quot; + aResponse);</span>
<a href="#l71.722"></a><span id="l71.722" class="difflineplus">+</span>
<a href="#l71.723"></a><span id="l71.723" class="difflineplus">+    // Poll for new events by performing another XHR in 1 second.</span>
<a href="#l71.724"></a><span id="l71.724" class="difflineplus">+    this._request = null;</span>
<a href="#l71.725"></a><span id="l71.725" class="difflineplus">+    this._poller = setTimeout(this._getMessages.bind(this), 1000);</span>
<a href="#l71.726"></a><span id="l71.726" class="difflineplus">+</span>
<a href="#l71.727"></a><span id="l71.727" class="difflineplus">+    // Empty responses are received as keep alives.</span>
<a href="#l71.728"></a><span id="l71.728" class="difflineplus">+    if (!aResponse) {</span>
<a href="#l71.729"></a><span id="l71.729" class="difflineplus">+      return;</span>
<a href="#l71.730"></a><span id="l71.730" class="difflineplus">+    }</span>
<a href="#l71.731"></a><span id="l71.731" class="difflineplus">+</span>
<a href="#l71.732"></a><span id="l71.732" class="difflineplus">+    // Otherwise, parse the response as JSON.</span>
<a href="#l71.733"></a><span id="l71.733" class="difflineplus">+    let obj = JSON.parse(aResponse);</span>
<a href="#l71.734"></a><span id="l71.734" class="difflineplus">+    if (!obj) {</span>
<a href="#l71.735"></a><span id="l71.735" class="difflineplus">+      this.ERROR(&quot;Unable to parse JSON response: &quot; + aResponse);</span>
<a href="#l71.736"></a><span id="l71.736" class="difflineplus">+      return;</span>
<a href="#l71.737"></a><span id="l71.737" class="difflineplus">+    }</span>
<a href="#l71.738"></a><span id="l71.738" class="difflineplus">+</span>
<a href="#l71.739"></a><span id="l71.739" class="difflineplus">+    // If no messages, nothing to do.</span>
<a href="#l71.740"></a><span id="l71.740" class="difflineplus">+    if (!(&quot;eventMessages&quot; in obj)) {</span>
<a href="#l71.741"></a><span id="l71.741" class="difflineplus">+      return;</span>
<a href="#l71.742"></a><span id="l71.742" class="difflineplus">+    }</span>
<a href="#l71.743"></a><span id="l71.743" class="difflineplus">+</span>
<a href="#l71.744"></a><span id="l71.744" class="difflineplus">+    for (let message of obj.eventMessages) {</span>
<a href="#l71.745"></a><span id="l71.745" class="difflineplus">+      // The type of message (e.g. new message, new status).</span>
<a href="#l71.746"></a><span id="l71.746" class="difflineplus">+      let resourceType = message.resourceType;</span>
<a href="#l71.747"></a><span id="l71.747" class="difflineplus">+      // The message object.</span>
<a href="#l71.748"></a><span id="l71.748" class="difflineplus">+      let resource = message.resource;</span>
<a href="#l71.749"></a><span id="l71.749" class="difflineplus">+</span>
<a href="#l71.750"></a><span id="l71.750" class="difflineplus">+      // Based on what the message is, totally different things are done below.</span>
<a href="#l71.751"></a><span id="l71.751" class="difflineplus">+      // Sorry for the mess. We can probably abstract this better.</span>
<a href="#l71.752"></a><span id="l71.752" class="difflineplus">+      if (resourceType == &quot;NewMessage&quot;) {</span>
<a href="#l71.753"></a><span id="l71.753" class="difflineplus">+        let messageType = resource.messagetype;</span>
<a href="#l71.754"></a><span id="l71.754" class="difflineplus">+        let from = contactUrlToName(resource.from);</span>
<a href="#l71.755"></a><span id="l71.755" class="difflineplus">+        if (!from) {</span>
<a href="#l71.756"></a><span id="l71.756" class="difflineplus">+          this.WARN(</span>
<a href="#l71.757"></a><span id="l71.757" class="difflineplus">+            &quot;Received a message without a parseable from field: &quot; +</span>
<a href="#l71.758"></a><span id="l71.758" class="difflineplus">+              resource.from</span>
<a href="#l71.759"></a><span id="l71.759" class="difflineplus">+          );</span>
<a href="#l71.760"></a><span id="l71.760" class="difflineplus">+          return;</span>
<a href="#l71.761"></a><span id="l71.761" class="difflineplus">+        }</span>
<a href="#l71.762"></a><span id="l71.762" class="difflineplus">+</span>
<a href="#l71.763"></a><span id="l71.763" class="difflineplus">+        // TODO Handle composetime field?</span>
<a href="#l71.764"></a><span id="l71.764" class="difflineplus">+        let conversationLink = resource.conversationLink;</span>
<a href="#l71.765"></a><span id="l71.765" class="difflineplus">+</span>
<a href="#l71.766"></a><span id="l71.766" class="difflineplus">+        // Check if the conversation is a chat.</span>
<a href="#l71.767"></a><span id="l71.767" class="difflineplus">+        if (conversationLink.includes(&quot;/19:&quot;)) {</span>
<a href="#l71.768"></a><span id="l71.768" class="difflineplus">+          // TODO</span>
<a href="#l71.769"></a><span id="l71.769" class="difflineplus">+          this.WARN(&quot;Received message from MUC.&quot;);</span>
<a href="#l71.770"></a><span id="l71.770" class="difflineplus">+          continue;</span>
<a href="#l71.771"></a><span id="l71.771" class="difflineplus">+        }</span>
<a href="#l71.772"></a><span id="l71.772" class="difflineplus">+</span>
<a href="#l71.773"></a><span id="l71.773" class="difflineplus">+        // Get or create the conversation.</span>
<a href="#l71.774"></a><span id="l71.774" class="difflineplus">+        let conversationName = contactUrlToName(conversationLink);</span>
<a href="#l71.775"></a><span id="l71.775" class="difflineplus">+        let conv = this._conversations.get(conversationName);</span>
<a href="#l71.776"></a><span id="l71.776" class="difflineplus">+</span>
<a href="#l71.777"></a><span id="l71.777" class="difflineplus">+        let messageTypeParts = messageType.split(&quot;/&quot;);</span>
<a href="#l71.778"></a><span id="l71.778" class="difflineplus">+        // Set the typing state (if the conversation exists).</span>
<a href="#l71.779"></a><span id="l71.779" class="difflineplus">+        if (messageTypeParts[0] == &quot;Control&quot; &amp;&amp; conv) {</span>
<a href="#l71.780"></a><span id="l71.780" class="difflineplus">+          let typingState = null;</span>
<a href="#l71.781"></a><span id="l71.781" class="difflineplus">+          // NotTyping or Typing.</span>
<a href="#l71.782"></a><span id="l71.782" class="difflineplus">+          if (messageTypeParts[1] == &quot;Typing&quot;) {</span>
<a href="#l71.783"></a><span id="l71.783" class="difflineplus">+            typingState = Ci.prplIConvIM.TYPING;</span>
<a href="#l71.784"></a><span id="l71.784" class="difflineplus">+          } else if (messageTypeParts[1] == &quot;ClearTyping&quot;) {</span>
<a href="#l71.785"></a><span id="l71.785" class="difflineplus">+            typingState = Ci.prplIConvIM.NOT_TYPING;</span>
<a href="#l71.786"></a><span id="l71.786" class="difflineplus">+          }</span>
<a href="#l71.787"></a><span id="l71.787" class="difflineplus">+          if (typingState !== null) {</span>
<a href="#l71.788"></a><span id="l71.788" class="difflineplus">+            conv.updateTyping(typingState);</span>
<a href="#l71.789"></a><span id="l71.789" class="difflineplus">+          }</span>
<a href="#l71.790"></a><span id="l71.790" class="difflineplus">+          // TODO There doesn't seem to be a &quot;typed&quot; state.</span>
<a href="#l71.791"></a><span id="l71.791" class="difflineplus">+        } else if (messageType == &quot;RichText&quot; || messageType == &quot;Text&quot;) {</span>
<a href="#l71.792"></a><span id="l71.792" class="difflineplus">+          // Create a conversation if it doesn't exist.</span>
<a href="#l71.793"></a><span id="l71.793" class="difflineplus">+          if (!conv) {</span>
<a href="#l71.794"></a><span id="l71.794" class="difflineplus">+            conv = this.createConversation(conversationName);</span>
<a href="#l71.795"></a><span id="l71.795" class="difflineplus">+          }</span>
<a href="#l71.796"></a><span id="l71.796" class="difflineplus">+</span>
<a href="#l71.797"></a><span id="l71.797" class="difflineplus">+          // TODO Handle RichText vs. Text.</span>
<a href="#l71.798"></a><span id="l71.798" class="difflineplus">+</span>
<a href="#l71.799"></a><span id="l71.799" class="difflineplus">+          // Put the message into the conversation.</span>
<a href="#l71.800"></a><span id="l71.800" class="difflineplus">+          let options = {};</span>
<a href="#l71.801"></a><span id="l71.801" class="difflineplus">+          if (from == this.name) {</span>
<a href="#l71.802"></a><span id="l71.802" class="difflineplus">+            options.outgoing = true;</span>
<a href="#l71.803"></a><span id="l71.803" class="difflineplus">+          } else {</span>
<a href="#l71.804"></a><span id="l71.804" class="difflineplus">+            options.incoming = true;</span>
<a href="#l71.805"></a><span id="l71.805" class="difflineplus">+          }</span>
<a href="#l71.806"></a><span id="l71.806" class="difflineplus">+          conv.writeMessage(from, resource.content, options);</span>
<a href="#l71.807"></a><span id="l71.807" class="difflineplus">+        }</span>
<a href="#l71.808"></a><span id="l71.808" class="difflineplus">+      } else if (resourceType == &quot;UserPresence&quot;) {</span>
<a href="#l71.809"></a><span id="l71.809" class="difflineplus">+        // Ignore our own statuses.</span>
<a href="#l71.810"></a><span id="l71.810" class="difflineplus">+        let from = contactUrlToName(resource.selfLink);</span>
<a href="#l71.811"></a><span id="l71.811" class="difflineplus">+        if (!from) {</span>
<a href="#l71.812"></a><span id="l71.812" class="difflineplus">+          continue;</span>
<a href="#l71.813"></a><span id="l71.813" class="difflineplus">+        }</span>
<a href="#l71.814"></a><span id="l71.814" class="difflineplus">+</span>
<a href="#l71.815"></a><span id="l71.815" class="difflineplus">+        // Get the buddy and update the status.</span>
<a href="#l71.816"></a><span id="l71.816" class="difflineplus">+        let buddy = this._buddies.get(from);</span>
<a href="#l71.817"></a><span id="l71.817" class="difflineplus">+        if (buddy) {</span>
<a href="#l71.818"></a><span id="l71.818" class="difflineplus">+          buddy.setStatus(this.mapStatusString(resource.status), &quot;&quot;);</span>
<a href="#l71.819"></a><span id="l71.819" class="difflineplus">+        }</span>
<a href="#l71.820"></a><span id="l71.820" class="difflineplus">+      } else if (resourceType == &quot;EndpointPresence&quot;) {</span>
<a href="#l71.821"></a><span id="l71.821" class="difflineplus">+        // Nothing to do.</span>
<a href="#l71.822"></a><span id="l71.822" class="difflineplus">+      } else if (resourceType == &quot;ConversationUpdate&quot;) {</span>
<a href="#l71.823"></a><span id="l71.823" class="difflineplus">+        // Nothing to do.</span>
<a href="#l71.824"></a><span id="l71.824" class="difflineplus">+      } else if (resourceType == &quot;ThreadUpdate&quot;) {</span>
<a href="#l71.825"></a><span id="l71.825" class="difflineplus">+        // Nothing to do.</span>
<a href="#l71.826"></a><span id="l71.826" class="difflineplus">+      } else {</span>
<a href="#l71.827"></a><span id="l71.827" class="difflineplus">+        this.WARN(&quot;Unhandled resource type: &quot; + resourceType);</span>
<a href="#l71.828"></a><span id="l71.828" class="difflineplus">+      }</span>
<a href="#l71.829"></a><span id="l71.829" class="difflineplus">+    }</span>
<a href="#l71.830"></a><span id="l71.830" class="difflineplus">+  },</span>
<a href="#l71.831"></a><span id="l71.831" class="difflineplus">+</span>
<a href="#l71.832"></a><span id="l71.832" class="difflineplus">+  /*</span>
<a href="#l71.833"></a><span id="l71.833" class="difflineplus">+   * Make a request to the Skype contacts API, this is essentially just</span>
<a href="#l71.834"></a><span id="l71.834" class="difflineplus">+   * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l71.835"></a><span id="l71.835" class="difflineplus">+   */</span>
<a href="#l71.836"></a><span id="l71.836" class="difflineplus">+  _contactsRequest(aUrl, aOptions = {}) {</span>
<a href="#l71.837"></a><span id="l71.837" class="difflineplus">+    let headers = aOptions.headers || [];</span>
<a href="#l71.838"></a><span id="l71.838" class="difflineplus">+</span>
<a href="#l71.839"></a><span id="l71.839" class="difflineplus">+    // Add some special Skype headers.</span>
<a href="#l71.840"></a><span id="l71.840" class="difflineplus">+    headers = headers.concat([</span>
<a href="#l71.841"></a><span id="l71.841" class="difflineplus">+      [&quot;X-Skypetoken&quot;, this._skypeToken],</span>
<a href="#l71.842"></a><span id="l71.842" class="difflineplus">+      [&quot;X-Stratus-Caller&quot;, &quot;swx-skype.com&quot;],</span>
<a href="#l71.843"></a><span id="l71.843" class="difflineplus">+      [&quot;X-Stratus-Request&quot;, &quot;abcd1234&quot;],</span>
<a href="#l71.844"></a><span id="l71.844" class="difflineplus">+      [&quot;Origin&quot;, &quot;https://web.skype.com&quot;],</span>
<a href="#l71.845"></a><span id="l71.845" class="difflineplus">+      [&quot;Referer&quot;, &quot;https://web.skype.com/main&quot;],</span>
<a href="#l71.846"></a><span id="l71.846" class="difflineplus">+      [&quot;Accept&quot;, &quot;application/json; ver=1.0;&quot;],</span>
<a href="#l71.847"></a><span id="l71.847" class="difflineplus">+    ]);</span>
<a href="#l71.848"></a><span id="l71.848" class="difflineplus">+</span>
<a href="#l71.849"></a><span id="l71.849" class="difflineplus">+    aOptions.headers = headers;</span>
<a href="#l71.850"></a><span id="l71.850" class="difflineplus">+</span>
<a href="#l71.851"></a><span id="l71.851" class="difflineplus">+    return httpRequest(aUrl, aOptions);</span>
<a href="#l71.852"></a><span id="l71.852" class="difflineplus">+  },</span>
<a href="#l71.853"></a><span id="l71.853" class="difflineplus">+</span>
<a href="#l71.854"></a><span id="l71.854" class="difflineplus">+  /*</span>
<a href="#l71.855"></a><span id="l71.855" class="difflineplus">+   * Make a request to the Skype messages API, this is essentially just</span>
<a href="#l71.856"></a><span id="l71.856" class="difflineplus">+   * httpRequest, but auto-adds a bunch of headers that are necessary.</span>
<a href="#l71.857"></a><span id="l71.857" class="difflineplus">+   */</span>
<a href="#l71.858"></a><span id="l71.858" class="difflineplus">+  _messagesRequest(aUrl, aOptions = {}) {</span>
<a href="#l71.859"></a><span id="l71.859" class="difflineplus">+    let headers = aOptions.headers || [];</span>
<a href="#l71.860"></a><span id="l71.860" class="difflineplus">+</span>
<a href="#l71.861"></a><span id="l71.861" class="difflineplus">+    // Add some special Skype headers.</span>
<a href="#l71.862"></a><span id="l71.862" class="difflineplus">+    headers = headers.concat([</span>
<a href="#l71.863"></a><span id="l71.863" class="difflineplus">+      [&quot;RegistrationToken&quot;, this._registrationToken],</span>
<a href="#l71.864"></a><span id="l71.864" class="difflineplus">+      [&quot;Referer&quot;, &quot;https://web.skype.com/main&quot;],</span>
<a href="#l71.865"></a><span id="l71.865" class="difflineplus">+      [&quot;Accept&quot;, &quot;application/json; ver=1.0;&quot;],</span>
<a href="#l71.866"></a><span id="l71.866" class="difflineplus">+      [&quot;ClientInfo&quot;, kClientInfo],</span>
<a href="#l71.867"></a><span id="l71.867" class="difflineplus">+    ]);</span>
<a href="#l71.868"></a><span id="l71.868" class="difflineplus">+</span>
<a href="#l71.869"></a><span id="l71.869" class="difflineplus">+    aOptions.headers = headers;</span>
<a href="#l71.870"></a><span id="l71.870" class="difflineplus">+</span>
<a href="#l71.871"></a><span id="l71.871" class="difflineplus">+    return httpRequest(aUrl, aOptions);</span>
<a href="#l71.872"></a><span id="l71.872" class="difflineplus">+  },</span>
<a href="#l71.873"></a><span id="l71.873" class="difflineplus">+</span>
<a href="#l71.874"></a><span id="l71.874" class="difflineplus">+  // Helper function to disconnect with authentication failed.</span>
<a href="#l71.875"></a><span id="l71.875" class="difflineplus">+  _disconnectWithAuthFailure(aMessageId = &quot;error.auth&quot;) {</span>
<a href="#l71.876"></a><span id="l71.876" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l71.877"></a><span id="l71.877" class="difflineplus">+      Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l71.878"></a><span id="l71.878" class="difflineplus">+      _(aMessageId)</span>
<a href="#l71.879"></a><span id="l71.879" class="difflineplus">+    );</span>
<a href="#l71.880"></a><span id="l71.880" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l71.881"></a><span id="l71.881" class="difflineplus">+  },</span>
<a href="#l71.882"></a><span id="l71.882" class="difflineplus">+</span>
<a href="#l71.883"></a><span id="l71.883" class="difflineplus">+  disconnect() {</span>
<a href="#l71.884"></a><span id="l71.884" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l71.885"></a><span id="l71.885" class="difflineplus">+      return;</span>
<a href="#l71.886"></a><span id="l71.886" class="difflineplus">+    }</span>
<a href="#l71.887"></a><span id="l71.887" class="difflineplus">+</span>
<a href="#l71.888"></a><span id="l71.888" class="difflineplus">+    clearTimeout(this._poller);</span>
<a href="#l71.889"></a><span id="l71.889" class="difflineplus">+    if (this._request) {</span>
<a href="#l71.890"></a><span id="l71.890" class="difflineplus">+      this._request.abort();</span>
<a href="#l71.891"></a><span id="l71.891" class="difflineplus">+    }</span>
<a href="#l71.892"></a><span id="l71.892" class="difflineplus">+</span>
<a href="#l71.893"></a><span id="l71.893" class="difflineplus">+    this._request = null;</span>
<a href="#l71.894"></a><span id="l71.894" class="difflineplus">+    this._poller = null;</span>
<a href="#l71.895"></a><span id="l71.895" class="difflineplus">+</span>
<a href="#l71.896"></a><span id="l71.896" class="difflineplus">+    // Mark all contacts on the account as having an unknown status.</span>
<a href="#l71.897"></a><span id="l71.897" class="difflineplus">+    this._buddies.forEach(aBuddy =&gt;</span>
<a href="#l71.898"></a><span id="l71.898" class="difflineplus">+      aBuddy.setStatus(Ci.imIStatusInfo.STATUS_UNKNOWN, &quot;&quot;)</span>
<a href="#l71.899"></a><span id="l71.899" class="difflineplus">+    );</span>
<a href="#l71.900"></a><span id="l71.900" class="difflineplus">+</span>
<a href="#l71.901"></a><span id="l71.901" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l71.902"></a><span id="l71.902" class="difflineplus">+  },</span>
<a href="#l71.903"></a><span id="l71.903" class="difflineplus">+</span>
<a href="#l71.904"></a><span id="l71.904" class="difflineplus">+  // TODO?</span>
<a href="#l71.905"></a><span id="l71.905" class="difflineplus">+  observe(aSubject, aTopic, aData) {},</span>
<a href="#l71.906"></a><span id="l71.906" class="difflineplus">+</span>
<a href="#l71.907"></a><span id="l71.907" class="difflineplus">+  remove() {</span>
<a href="#l71.908"></a><span id="l71.908" class="difflineplus">+    this._conversations.forEach(conv =&gt; conv.close());</span>
<a href="#l71.909"></a><span id="l71.909" class="difflineplus">+    delete this._conversations;</span>
<a href="#l71.910"></a><span id="l71.910" class="difflineplus">+    this.buddies.forEach(aBuddy =&gt; aBuddy.remove());</span>
<a href="#l71.911"></a><span id="l71.911" class="difflineplus">+    delete this.buddies;</span>
<a href="#l71.912"></a><span id="l71.912" class="difflineplus">+  },</span>
<a href="#l71.913"></a><span id="l71.913" class="difflineplus">+</span>
<a href="#l71.914"></a><span id="l71.914" class="difflineplus">+  unInit() {</span>
<a href="#l71.915"></a><span id="l71.915" class="difflineplus">+    delete this.imAccount;</span>
<a href="#l71.916"></a><span id="l71.916" class="difflineplus">+    clearTimeout(this._poller);</span>
<a href="#l71.917"></a><span id="l71.917" class="difflineplus">+  },</span>
<a href="#l71.918"></a><span id="l71.918" class="difflineplus">+</span>
<a href="#l71.919"></a><span id="l71.919" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l71.920"></a><span id="l71.920" class="difflineplus">+    let conv = new SkypeConversation(this, aName);</span>
<a href="#l71.921"></a><span id="l71.921" class="difflineplus">+    this._conversations.set(aName, conv);</span>
<a href="#l71.922"></a><span id="l71.922" class="difflineplus">+    return conv;</span>
<a href="#l71.923"></a><span id="l71.923" class="difflineplus">+  },</span>
<a href="#l71.924"></a><span id="l71.924" class="difflineplus">+</span>
<a href="#l71.925"></a><span id="l71.925" class="difflineplus">+  // Called when the user adds or authorizes a new contact.</span>
<a href="#l71.926"></a><span id="l71.926" class="difflineplus">+  addBuddy(aTag, aName) {},</span>
<a href="#l71.927"></a><span id="l71.927" class="difflineplus">+</span>
<a href="#l71.928"></a><span id="l71.928" class="difflineplus">+  loadBuddy(aBuddy, aTag) {</span>
<a href="#l71.929"></a><span id="l71.929" class="difflineplus">+    let buddy = new SkypeAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l71.930"></a><span id="l71.930" class="difflineplus">+    this._buddies.set(buddy.userName, buddy);</span>
<a href="#l71.931"></a><span id="l71.931" class="difflineplus">+</span>
<a href="#l71.932"></a><span id="l71.932" class="difflineplus">+    return buddy;</span>
<a href="#l71.933"></a><span id="l71.933" class="difflineplus">+  },</span>
<a href="#l71.934"></a><span id="l71.934" class="difflineplus">+</span>
<a href="#l71.935"></a><span id="l71.935" class="difflineplus">+  // TODO Add support for MUCs.</span>
<a href="#l71.936"></a><span id="l71.936" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l71.937"></a><span id="l71.937" class="difflineplus">+    return false;</span>
<a href="#l71.938"></a><span id="l71.938" class="difflineplus">+  },</span>
<a href="#l71.939"></a><span id="l71.939" class="difflineplus">+  chatRoomFields: {},</span>
<a href="#l71.940"></a><span id="l71.940" class="difflineplus">+  joinChat(aComponents) {},</span>
<a href="#l71.941"></a><span id="l71.941" class="difflineplus">+};</span>
<a href="#l71.942"></a><span id="l71.942" class="difflineplus">+</span>
<a href="#l71.943"></a><span id="l71.943" class="difflineplus">+function SkypeProtocol() {}</span>
<a href="#l71.944"></a><span id="l71.944" class="difflineplus">+SkypeProtocol.prototype = {</span>
<a href="#l71.945"></a><span id="l71.945" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l71.946"></a><span id="l71.946" class="difflineplus">+  get name() {</span>
<a href="#l71.947"></a><span id="l71.947" class="difflineplus">+    return &quot;Skype&quot;;</span>
<a href="#l71.948"></a><span id="l71.948" class="difflineplus">+  },</span>
<a href="#l71.949"></a><span id="l71.949" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l71.950"></a><span id="l71.950" class="difflineplus">+    return &quot;chrome://prpl-skype/skin/&quot;;</span>
<a href="#l71.951"></a><span id="l71.951" class="difflineplus">+  },</span>
<a href="#l71.952"></a><span id="l71.952" class="difflineplus">+  get baseId() {</span>
<a href="#l71.953"></a><span id="l71.953" class="difflineplus">+    return &quot;prpl-skype&quot;;</span>
<a href="#l71.954"></a><span id="l71.954" class="difflineplus">+  },</span>
<a href="#l71.955"></a><span id="l71.955" class="difflineplus">+</span>
<a href="#l71.956"></a><span id="l71.956" class="difflineplus">+  get passwordOptional() {</span>
<a href="#l71.957"></a><span id="l71.957" class="difflineplus">+    return false;</span>
<a href="#l71.958"></a><span id="l71.958" class="difflineplus">+  },</span>
<a href="#l71.959"></a><span id="l71.959" class="difflineplus">+</span>
<a href="#l71.960"></a><span id="l71.960" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l71.961"></a><span id="l71.961" class="difflineplus">+    return new SkypeAccount(this, aImAccount);</span>
<a href="#l71.962"></a><span id="l71.962" class="difflineplus">+  },</span>
<a href="#l71.963"></a><span id="l71.963" class="difflineplus">+  classID: Components.ID(&quot;{8446c0f6-9f59-4710-844e-eaa6c1f49d35}&quot;),</span>
<a href="#l71.964"></a><span id="l71.964" class="difflineplus">+};</span>
<a href="#l71.965"></a><span id="l71.965" class="difflineplus">+</span>
<a href="#l71.966"></a><span id="l71.966" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([SkypeProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1">new file mode 100644</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineminus">--- /dev/null</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineplus">+++ b/chat/protocols/skype/skype.manifest</span>
<a href="#l72.4"></a><span id="l72.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l72.5"></a><span id="l72.5" class="difflineplus">+component {8446c0f6-9f59-4710-844e-eaa6c1f49d35} skype.js</span>
<a href="#l72.6"></a><span id="l72.6" class="difflineplus">+contract @mozilla.org/chat/skype;1 {8446c0f6-9f59-4710-844e-eaa6c1f49d35}</span>
<a href="#l72.7"></a><span id="l72.7" class="difflineplus">+category im-protocol-plugin prpl-skype @mozilla.org/chat/skype;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_MagicSha256.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -1,25 +1,26 @@</span>
<a href="#l73.4"></a><span id="l73.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l73.5"></a><span id="l73.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l73.6"></a><span id="l73.6"> </span>
<a href="#l73.7"></a><span id="l73.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l73.8"></a><span id="l73.8" class="difflineminus">-var { magicSha256 } = ChromeUtils.import(&quot;resource:///modules/Skype.jsm&quot;);</span>
<a href="#l73.9"></a><span id="l73.9" class="difflineplus">+var skype = {};</span>
<a href="#l73.10"></a><span id="l73.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12"> var data = {</span>
<a href="#l73.13"></a><span id="l73.13">   &quot;1416264993&quot;: &quot;3a33ac47fe2ec1a33d569f4be5c69ddc&quot;,</span>
<a href="#l73.14"></a><span id="l73.14">   &quot;1416387358&quot;: &quot;eca9716e1eedcbe93320ba794cea3388&quot;,</span>
<a href="#l73.15"></a><span id="l73.15">   &quot;1416392361&quot;: &quot;2ed6fc80c3303caa137ae3fd4fcc7d80&quot;,</span>
<a href="#l73.16"></a><span id="l73.16"> };</span>
<a href="#l73.17"></a><span id="l73.17"> </span>
<a href="#l73.18"></a><span id="l73.18"> function run_test() {</span>
<a href="#l73.19"></a><span id="l73.19">   add_test(test_MagicSha256);</span>
<a href="#l73.20"></a><span id="l73.20"> </span>
<a href="#l73.21"></a><span id="l73.21">   run_next_test();</span>
<a href="#l73.22"></a><span id="l73.22"> }</span>
<a href="#l73.23"></a><span id="l73.23"> </span>
<a href="#l73.24"></a><span id="l73.24"> function test_MagicSha256() {</span>
<a href="#l73.25"></a><span id="l73.25">   for (let input in data) {</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineminus">-    equal(data[input], magicSha256(input));</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+    equal(data[input], skype.magicSha256(input));</span>
<a href="#l73.28"></a><span id="l73.28">   }</span>
<a href="#l73.29"></a><span id="l73.29"> </span>
<a href="#l73.30"></a><span id="l73.30">   run_next_test();</span>
<a href="#l73.31"></a><span id="l73.31"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/chat/protocols/skype/test/test_contactUrlToName.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -1,26 +1,27 @@</span>
<a href="#l74.4"></a><span id="l74.4"> /* Any copyright is dedicated to the Public Domain.</span>
<a href="#l74.5"></a><span id="l74.5">  * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l74.6"></a><span id="l74.6"> </span>
<a href="#l74.7"></a><span id="l74.7"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l74.8"></a><span id="l74.8" class="difflineminus">-var { contactUrlToName } = ChromeUtils.import(&quot;resource:///modules/Skype.jsm&quot;);</span>
<a href="#l74.9"></a><span id="l74.9" class="difflineplus">+var skype = {};</span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+Services.scriptloader.loadSubScript(&quot;resource:///components/skype.js&quot;, skype);</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12"> var data = {</span>
<a href="#l74.13"></a><span id="l74.13">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/ME/contacts/8:clokep&quot;:</span>
<a href="#l74.14"></a><span id="l74.14">     &quot;clokep&quot;,</span>
<a href="#l74.15"></a><span id="l74.15">   &quot;https://bay-client-s.gateway.messenger.live.com/v1/users/8:clokep/presenceDocs/messagingService&quot;:</span>
<a href="#l74.16"></a><span id="l74.16">     &quot;clokep&quot;,</span>
<a href="#l74.17"></a><span id="l74.17"> };</span>
<a href="#l74.18"></a><span id="l74.18"> </span>
<a href="#l74.19"></a><span id="l74.19"> function run_test() {</span>
<a href="#l74.20"></a><span id="l74.20">   add_test(test_contactUrlToName);</span>
<a href="#l74.21"></a><span id="l74.21"> </span>
<a href="#l74.22"></a><span id="l74.22">   run_next_test();</span>
<a href="#l74.23"></a><span id="l74.23"> }</span>
<a href="#l74.24"></a><span id="l74.24"> </span>
<a href="#l74.25"></a><span id="l74.25"> function test_contactUrlToName() {</span>
<a href="#l74.26"></a><span id="l74.26">   for (let input in data) {</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineminus">-    equal(data[input], contactUrlToName(input));</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+    equal(data[input], skype.contactUrlToName(input));</span>
<a href="#l74.29"></a><span id="l74.29">   }</span>
<a href="#l74.30"></a><span id="l74.30"> </span>
<a href="#l74.31"></a><span id="l74.31">   run_next_test();</span>
<a href="#l74.32"></a><span id="l74.32"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">deleted file mode 100644</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineminus">--- a/chat/protocols/twitter/Twitter.jsm</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineplus">+++ /dev/null</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineat">@@ -1,1577 +0,0 @@</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l75.6"></a><span id="l75.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l75.7"></a><span id="l75.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l75.8"></a><span id="l75.8" class="difflineminus">-</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;TwitterProtocol&quot;];</span>
<a href="#l75.10"></a><span id="l75.10" class="difflineminus">-</span>
<a href="#l75.11"></a><span id="l75.11" class="difflineminus">-var { httpRequest, percentEncode } = ChromeUtils.import(</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-  &quot;resource://gre/modules/Http.jsm&quot;</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-);</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineminus">-var {</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineminus">-  XPCOMUtils,</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-  setTimeout,</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineminus">-  clearTimeout,</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineminus">-  nsSimpleEnumerator,</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineminus">-  ClassInfo,</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineminus">-  l10nHelper,</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineminus">-  initLogModule,</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineminus">-var {</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineminus">-  GenericAccountPrototype,</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineminus">-  GenericConvIMPrototype,</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineminus">-  GenericConvChatPrototype,</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-  GenericConvChatBuddyPrototype,</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineminus">-  GenericConversationPrototype,</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineminus">-  GenericMessagePrototype,</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineminus">-  GenericProtocolPrototype,</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineminus">-  TooltipInfo,</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineminus">-} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineminus">-var { twttr } = ChromeUtils.import(&quot;resource:///modules/twitter-text.jsm&quot;);</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineminus">-</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineminus">-var NS_PREFBRANCH_PREFCHANGE_TOPIC_ID = &quot;nsPref:changed&quot;;</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineminus">-</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/twitter.properties&quot;)</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineminus">-);</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_lang&quot;, () =&gt;</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineminus">-  l10nHelper(&quot;chrome://global/locale/languageNames.properties&quot;)</span>
<a href="#l75.43"></a><span id="l75.43" class="difflineminus">-);</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineminus">-initLogModule(&quot;twitter&quot;, this);</span>
<a href="#l75.45"></a><span id="l75.45" class="difflineminus">-</span>
<a href="#l75.46"></a><span id="l75.46" class="difflineminus">-function ChatBuddy(aName, aAccount) {</span>
<a href="#l75.47"></a><span id="l75.47" class="difflineminus">-  this._name = aName;</span>
<a href="#l75.48"></a><span id="l75.48" class="difflineminus">-  this._account = aAccount;</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineminus">-}</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineminus">-ChatBuddy.prototype = {</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineminus">-  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineminus">-  get buddyIconFilename() {</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineminus">-    let userInfo = this._account._userInfo.get(this.name);</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineminus">-    if (userInfo) {</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineminus">-      return userInfo.profile_image_url;</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineminus">-    }</span>
<a href="#l75.57"></a><span id="l75.57" class="difflineminus">-    return undefined;</span>
<a href="#l75.58"></a><span id="l75.58" class="difflineminus">-  },</span>
<a href="#l75.59"></a><span id="l75.59" class="difflineminus">-  set buddyIconFilename(aName) {</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineminus">-    // Prevent accidental removal of the getter.</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineminus">-    throw new Error(</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-      &quot;Don't set chatBuddy.buddyIconFilename directly for Twitter.&quot;</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineminus">-    );</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineminus">-  },</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineminus">-  createConversation() {</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineminus">-    return this._account.createConversation(this._name);</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineminus">-  },</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineminus">-};</span>
<a href="#l75.69"></a><span id="l75.69" class="difflineminus">-</span>
<a href="#l75.70"></a><span id="l75.70" class="difflineminus">-function Tweet(aTweet, aWho, aMessage, aObject) {</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineminus">-  this._tweet = aTweet;</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineminus">-  this._init(aWho, aMessage, aObject);</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineminus">-}</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineminus">-Tweet.prototype = {</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineminus">-  __proto__: GenericMessagePrototype,</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineminus">-  _deleted: false,</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineminus">-  getActions() {</span>
<a href="#l75.78"></a><span id="l75.78" class="difflineminus">-    // Direct messages have no actions.</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineminus">-    if (!this.conversation.isChat) {</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineminus">-      return [];</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineminus">-    }</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineminus">-</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineminus">-    let account = this.conversation._account;</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineminus">-    let actions = [];</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineminus">-</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineminus">-    if (account.connected) {</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineminus">-      actions.push(</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineminus">-        new Action(</span>
<a href="#l75.89"></a><span id="l75.89" class="difflineminus">-          _(&quot;action.reply&quot;),</span>
<a href="#l75.90"></a><span id="l75.90" class="difflineminus">-          function() {</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineminus">-            this.conversation.startReply(this._tweet);</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineminus">-          },</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineminus">-          this</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineminus">-        )</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineminus">-      );</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineminus">-      actions.push(</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineminus">-        new Action(</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineminus">-          _(&quot;action.retweet&quot;),</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineminus">-          function() {</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineminus">-            this.conversation.reTweet(this._tweet);</span>
<a href="#l75.101"></a><span id="l75.101" class="difflineminus">-          },</span>
<a href="#l75.102"></a><span id="l75.102" class="difflineminus">-          this</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineminus">-        )</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineminus">-      );</span>
<a href="#l75.105"></a><span id="l75.105" class="difflineminus">-      if (this.incoming) {</span>
<a href="#l75.106"></a><span id="l75.106" class="difflineminus">-        let isFriend = account._friends.has(this._tweet.user.id_str);</span>
<a href="#l75.107"></a><span id="l75.107" class="difflineminus">-        let action = isFriend ? &quot;stopFollowing&quot; : &quot;follow&quot;;</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineminus">-        let screenName = this._tweet.user.screen_name;</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineminus">-        actions.push(</span>
<a href="#l75.110"></a><span id="l75.110" class="difflineminus">-          new Action(_(&quot;action.&quot; + action, screenName), function() {</span>
<a href="#l75.111"></a><span id="l75.111" class="difflineminus">-            account[action](screenName);</span>
<a href="#l75.112"></a><span id="l75.112" class="difflineminus">-          })</span>
<a href="#l75.113"></a><span id="l75.113" class="difflineminus">-        );</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineminus">-</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineminus">-        const favAction = this._tweet.favorited ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l75.116"></a><span id="l75.116" class="difflineminus">-        actions.push(</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineminus">-          new Action(</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineminus">-            _(&quot;action.&quot; + favAction),</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineminus">-            () =&gt; {</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineminus">-              this.conversation.like(this._tweet, this._tweet.favorited);</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineminus">-            },</span>
<a href="#l75.122"></a><span id="l75.122" class="difflineminus">-            this</span>
<a href="#l75.123"></a><span id="l75.123" class="difflineminus">-          )</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineminus">-        );</span>
<a href="#l75.125"></a><span id="l75.125" class="difflineminus">-      } else if (this.outgoing &amp;&amp; !this._deleted) {</span>
<a href="#l75.126"></a><span id="l75.126" class="difflineminus">-        actions.push(</span>
<a href="#l75.127"></a><span id="l75.127" class="difflineminus">-          new Action(</span>
<a href="#l75.128"></a><span id="l75.128" class="difflineminus">-            _(&quot;action.delete&quot;),</span>
<a href="#l75.129"></a><span id="l75.129" class="difflineminus">-            function() {</span>
<a href="#l75.130"></a><span id="l75.130" class="difflineminus">-              this.destroy();</span>
<a href="#l75.131"></a><span id="l75.131" class="difflineminus">-            },</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineminus">-            this</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineminus">-          )</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineminus">-        );</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineminus">-      }</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineminus">-    }</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineminus">-    actions.push(</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineminus">-      new Action(</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineminus">-        _(&quot;action.copyLink&quot;),</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineminus">-        function() {</span>
<a href="#l75.141"></a><span id="l75.141" class="difflineminus">-          let href =</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineminus">-            &quot;https://twitter.com/&quot; +</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineminus">-            this._tweet.user.screen_name +</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineminus">-            &quot;/status/&quot; +</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineminus">-            this._tweet.id_str;</span>
<a href="#l75.146"></a><span id="l75.146" class="difflineminus">-          Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineminus">-            .getService(Ci.nsIClipboardHelper)</span>
<a href="#l75.148"></a><span id="l75.148" class="difflineminus">-            .copyString(href);</span>
<a href="#l75.149"></a><span id="l75.149" class="difflineminus">-        },</span>
<a href="#l75.150"></a><span id="l75.150" class="difflineminus">-        this</span>
<a href="#l75.151"></a><span id="l75.151" class="difflineminus">-      )</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineminus">-    );</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineminus">-    return actions;</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineminus">-  },</span>
<a href="#l75.155"></a><span id="l75.155" class="difflineminus">-  destroy() {</span>
<a href="#l75.156"></a><span id="l75.156" class="difflineminus">-    // Mark the tweet as deleted until we receive a response.</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineminus">-    this._deleted = true;</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineminus">-</span>
<a href="#l75.159"></a><span id="l75.159" class="difflineminus">-    this.conversation._account.destroy(</span>
<a href="#l75.160"></a><span id="l75.160" class="difflineminus">-      this._tweet,</span>
<a href="#l75.161"></a><span id="l75.161" class="difflineminus">-      this.onDestroyCallback,</span>
<a href="#l75.162"></a><span id="l75.162" class="difflineminus">-      this.onDestroyErrorCallback,</span>
<a href="#l75.163"></a><span id="l75.163" class="difflineminus">-      this</span>
<a href="#l75.164"></a><span id="l75.164" class="difflineminus">-    );</span>
<a href="#l75.165"></a><span id="l75.165" class="difflineminus">-  },</span>
<a href="#l75.166"></a><span id="l75.166" class="difflineminus">-  onDestroyErrorCallback(aException, aData) {</span>
<a href="#l75.167"></a><span id="l75.167" class="difflineminus">-    // The tweet was not successfully deleted.</span>
<a href="#l75.168"></a><span id="l75.168" class="difflineminus">-    delete this._deleted;</span>
<a href="#l75.169"></a><span id="l75.169" class="difflineminus">-    let error = this.conversation._parseError(aData);</span>
<a href="#l75.170"></a><span id="l75.170" class="difflineminus">-    this.conversation.systemMessage(</span>
<a href="#l75.171"></a><span id="l75.171" class="difflineminus">-      _(&quot;error.delete&quot;, error, this.originalMessage),</span>
<a href="#l75.172"></a><span id="l75.172" class="difflineminus">-      true</span>
<a href="#l75.173"></a><span id="l75.173" class="difflineminus">-    );</span>
<a href="#l75.174"></a><span id="l75.174" class="difflineminus">-  },</span>
<a href="#l75.175"></a><span id="l75.175" class="difflineminus">-  onDestroyCallback(aData) {</span>
<a href="#l75.176"></a><span id="l75.176" class="difflineminus">-    let tweet = JSON.parse(aData);</span>
<a href="#l75.177"></a><span id="l75.177" class="difflineminus">-    // If Twitter responds with an error, throw to call the error callback.</span>
<a href="#l75.178"></a><span id="l75.178" class="difflineminus">-    if (&quot;error&quot; in tweet) {</span>
<a href="#l75.179"></a><span id="l75.179" class="difflineminus">-      throw tweet.error;</span>
<a href="#l75.180"></a><span id="l75.180" class="difflineminus">-    }</span>
<a href="#l75.181"></a><span id="l75.181" class="difflineminus">-</span>
<a href="#l75.182"></a><span id="l75.182" class="difflineminus">-    // Create a new system message saying the tweet has been deleted.</span>
<a href="#l75.183"></a><span id="l75.183" class="difflineminus">-    this.conversation.systemMessage(_(&quot;event.deleted&quot;, this.originalMessage));</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineminus">-  },</span>
<a href="#l75.185"></a><span id="l75.185" class="difflineminus">-};</span>
<a href="#l75.186"></a><span id="l75.186" class="difflineminus">-</span>
<a href="#l75.187"></a><span id="l75.187" class="difflineminus">-function Action(aLabel, aAction, aTweet) {</span>
<a href="#l75.188"></a><span id="l75.188" class="difflineminus">-  this.label = aLabel;</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineminus">-  this._action = aAction;</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineminus">-  this._tweet = aTweet;</span>
<a href="#l75.191"></a><span id="l75.191" class="difflineminus">-}</span>
<a href="#l75.192"></a><span id="l75.192" class="difflineminus">-Action.prototype = {</span>
<a href="#l75.193"></a><span id="l75.193" class="difflineminus">-  __proto__: ClassInfo(&quot;prplIMessageAction&quot;, &quot;generic message action object&quot;),</span>
<a href="#l75.194"></a><span id="l75.194" class="difflineminus">-  get run() {</span>
<a href="#l75.195"></a><span id="l75.195" class="difflineminus">-    return this._action.bind(this._tweet);</span>
<a href="#l75.196"></a><span id="l75.196" class="difflineminus">-  },</span>
<a href="#l75.197"></a><span id="l75.197" class="difflineminus">-};</span>
<a href="#l75.198"></a><span id="l75.198" class="difflineminus">-</span>
<a href="#l75.199"></a><span id="l75.199" class="difflineminus">-// Properties / methods shared by both DirectMessageConversation and</span>
<a href="#l75.200"></a><span id="l75.200" class="difflineminus">-// TimelineConversation.</span>
<a href="#l75.201"></a><span id="l75.201" class="difflineminus">-var GenericTwitterConversation = {</span>
<a href="#l75.202"></a><span id="l75.202" class="difflineminus">-  getTweetLength(aString) {</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineminus">-    // Use the Twitter library to calculate the length.</span>
<a href="#l75.204"></a><span id="l75.204" class="difflineminus">-    let parsed = twttr.txt.parseTweet(aString);</span>
<a href="#l75.205"></a><span id="l75.205" class="difflineminus">-    return parsed.weightedLength;</span>
<a href="#l75.206"></a><span id="l75.206" class="difflineminus">-  },</span>
<a href="#l75.207"></a><span id="l75.207" class="difflineminus">-  systemMessage(aMessage, aIsError, aDate) {</span>
<a href="#l75.208"></a><span id="l75.208" class="difflineminus">-    let flags = { system: true };</span>
<a href="#l75.209"></a><span id="l75.209" class="difflineminus">-    if (aIsError) {</span>
<a href="#l75.210"></a><span id="l75.210" class="difflineminus">-      flags.error = true;</span>
<a href="#l75.211"></a><span id="l75.211" class="difflineminus">-    }</span>
<a href="#l75.212"></a><span id="l75.212" class="difflineminus">-    if (aDate) {</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineminus">-      flags.time = aDate;</span>
<a href="#l75.214"></a><span id="l75.214" class="difflineminus">-    }</span>
<a href="#l75.215"></a><span id="l75.215" class="difflineminus">-    this.writeMessage(&quot;twitter.com&quot;, aMessage, flags);</span>
<a href="#l75.216"></a><span id="l75.216" class="difflineminus">-  },</span>
<a href="#l75.217"></a><span id="l75.217" class="difflineminus">-  onSentCallback(aMsg, aData) {</span>
<a href="#l75.218"></a><span id="l75.218" class="difflineminus">-    // The conversation may have been uninitialized in the time it takes for</span>
<a href="#l75.219"></a><span id="l75.219" class="difflineminus">-    // the async callback to fire.  Use `_observers` as a proxy for uninit'd.</span>
<a href="#l75.220"></a><span id="l75.220" class="difflineminus">-    if (!this._observers) {</span>
<a href="#l75.221"></a><span id="l75.221" class="difflineminus">-      return;</span>
<a href="#l75.222"></a><span id="l75.222" class="difflineminus">-    }</span>
<a href="#l75.223"></a><span id="l75.223" class="difflineminus">-</span>
<a href="#l75.224"></a><span id="l75.224" class="difflineminus">-    let tweet = JSON.parse(aData);</span>
<a href="#l75.225"></a><span id="l75.225" class="difflineminus">-    // The OTR extension requires that the protocol not modify the message</span>
<a href="#l75.226"></a><span id="l75.226" class="difflineminus">-    // (see the notes at `imIOutgoingMessage`).  That's the contract we made.</span>
<a href="#l75.227"></a><span id="l75.227" class="difflineminus">-    // Unfortunately, Twitter trims tweets and substitutes links.</span>
<a href="#l75.228"></a><span id="l75.228" class="difflineminus">-    tweet.text = aMsg;</span>
<a href="#l75.229"></a><span id="l75.229" class="difflineminus">-    this.displayMessages([tweet]);</span>
<a href="#l75.230"></a><span id="l75.230" class="difflineminus">-  },</span>
<a href="#l75.231"></a><span id="l75.231" class="difflineminus">-  prepareForDisplaying(aMsg) {</span>
<a href="#l75.232"></a><span id="l75.232" class="difflineminus">-    if (!this._tweets.has(aMsg.id)) {</span>
<a href="#l75.233"></a><span id="l75.233" class="difflineminus">-      return;</span>
<a href="#l75.234"></a><span id="l75.234" class="difflineminus">-    }</span>
<a href="#l75.235"></a><span id="l75.235" class="difflineminus">-    let tweet = this._tweets.get(aMsg.id)._tweet;</span>
<a href="#l75.236"></a><span id="l75.236" class="difflineminus">-    this._tweets.delete(aMsg.id);</span>
<a href="#l75.237"></a><span id="l75.237" class="difflineminus">-</span>
<a href="#l75.238"></a><span id="l75.238" class="difflineminus">-    let text = aMsg.displayMessage;</span>
<a href="#l75.239"></a><span id="l75.239" class="difflineminus">-    let entities = {};</span>
<a href="#l75.240"></a><span id="l75.240" class="difflineminus">-</span>
<a href="#l75.241"></a><span id="l75.241" class="difflineminus">-    // Handle retweets: retweeted_status contains the object for the original</span>
<a href="#l75.242"></a><span id="l75.242" class="difflineminus">-    // tweet that is being retweeted.</span>
<a href="#l75.243"></a><span id="l75.243" class="difflineminus">-    // If the retweet prefix (&quot;RT @&lt;username&gt;: &quot;) causes the tweet to be over</span>
<a href="#l75.244"></a><span id="l75.244" class="difflineminus">-    // 140 characters, ellipses will be added. In this case, we want to get</span>
<a href="#l75.245"></a><span id="l75.245" class="difflineminus">-    // the FULL text from the original tweet and update the entities to match.</span>
<a href="#l75.246"></a><span id="l75.246" class="difflineminus">-    // Note: the truncated flag is not always set correctly by twitter, so we</span>
<a href="#l75.247"></a><span id="l75.247" class="difflineminus">-    // always make use of the original tweet.</span>
<a href="#l75.248"></a><span id="l75.248" class="difflineminus">-    if (&quot;retweeted_status&quot; in tweet) {</span>
<a href="#l75.249"></a><span id="l75.249" class="difflineminus">-      let retweet = tweet.retweeted_status;</span>
<a href="#l75.250"></a><span id="l75.250" class="difflineminus">-      let retweetText,</span>
<a href="#l75.251"></a><span id="l75.251" class="difflineminus">-        retweetEntities = {};</span>
<a href="#l75.252"></a><span id="l75.252" class="difflineminus">-</span>
<a href="#l75.253"></a><span id="l75.253" class="difflineminus">-      if (&quot;extended_tweet&quot; in retweet) {</span>
<a href="#l75.254"></a><span id="l75.254" class="difflineminus">-        // Note that if an extended tweet is retweeted, only the</span>
<a href="#l75.255"></a><span id="l75.255" class="difflineminus">-        // retweeted_status part will be extended, not the tweet itself.</span>
<a href="#l75.256"></a><span id="l75.256" class="difflineminus">-        let extended = retweet.extended_tweet;</span>
<a href="#l75.257"></a><span id="l75.257" class="difflineminus">-        retweetText = extended.full_text;</span>
<a href="#l75.258"></a><span id="l75.258" class="difflineminus">-        if (&quot;entities&quot; in extended) {</span>
<a href="#l75.259"></a><span id="l75.259" class="difflineminus">-          retweetEntities = extended.entities;</span>
<a href="#l75.260"></a><span id="l75.260" class="difflineminus">-        }</span>
<a href="#l75.261"></a><span id="l75.261" class="difflineminus">-      } else {</span>
<a href="#l75.262"></a><span id="l75.262" class="difflineminus">-        retweetText = retweet.text;</span>
<a href="#l75.263"></a><span id="l75.263" class="difflineminus">-        if (&quot;entities&quot; in retweet) {</span>
<a href="#l75.264"></a><span id="l75.264" class="difflineminus">-          retweetEntities = retweet.entities;</span>
<a href="#l75.265"></a><span id="l75.265" class="difflineminus">-        }</span>
<a href="#l75.266"></a><span id="l75.266" class="difflineminus">-      }</span>
<a href="#l75.267"></a><span id="l75.267" class="difflineminus">-</span>
<a href="#l75.268"></a><span id="l75.268" class="difflineminus">-      // We're going to take portions of the retweeted status and replace parts</span>
<a href="#l75.269"></a><span id="l75.269" class="difflineminus">-      // of the original tweet, the retweeted status prepends the original</span>
<a href="#l75.270"></a><span id="l75.270" class="difflineminus">-      // status with &quot;RT @&lt;username&gt;: &quot;, we need to keep the prefix.</span>
<a href="#l75.271"></a><span id="l75.271" class="difflineminus">-      // Note: this doesn't play nice with extensions that may have altered</span>
<a href="#l75.272"></a><span id="l75.272" class="difflineminus">-      // `text` to this point, but at least OTR doesn't act on `isChat`.</span>
<a href="#l75.273"></a><span id="l75.273" class="difflineminus">-      let offset = text.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l75.274"></a><span id="l75.274" class="difflineminus">-      text = text.slice(0, offset) + retweetText;</span>
<a href="#l75.275"></a><span id="l75.275" class="difflineminus">-</span>
<a href="#l75.276"></a><span id="l75.276" class="difflineminus">-      // Keep any entities that refer to the prefix (we can refer directly to</span>
<a href="#l75.277"></a><span id="l75.277" class="difflineminus">-      // the tweet for these since they are not edited).</span>
<a href="#l75.278"></a><span id="l75.278" class="difflineminus">-      if (&quot;entities&quot; in tweet) {</span>
<a href="#l75.279"></a><span id="l75.279" class="difflineminus">-        for (let type in tweet.entities) {</span>
<a href="#l75.280"></a><span id="l75.280" class="difflineminus">-          let filteredEntities = tweet.entities[type].filter(</span>
<a href="#l75.281"></a><span id="l75.281" class="difflineminus">-            e =&gt; e.indices[0] &lt; offset</span>
<a href="#l75.282"></a><span id="l75.282" class="difflineminus">-          );</span>
<a href="#l75.283"></a><span id="l75.283" class="difflineminus">-          if (filteredEntities.length) {</span>
<a href="#l75.284"></a><span id="l75.284" class="difflineminus">-            entities[type] = filteredEntities;</span>
<a href="#l75.285"></a><span id="l75.285" class="difflineminus">-          }</span>
<a href="#l75.286"></a><span id="l75.286" class="difflineminus">-        }</span>
<a href="#l75.287"></a><span id="l75.287" class="difflineminus">-      }</span>
<a href="#l75.288"></a><span id="l75.288" class="difflineminus">-</span>
<a href="#l75.289"></a><span id="l75.289" class="difflineminus">-      // Add the entities from the retweet (a copy of these must be made since</span>
<a href="#l75.290"></a><span id="l75.290" class="difflineminus">-      // they will be edited and we do not wish to change the tweet).</span>
<a href="#l75.291"></a><span id="l75.291" class="difflineminus">-      for (let type in retweetEntities) {</span>
<a href="#l75.292"></a><span id="l75.292" class="difflineminus">-        if (!(type in entities)) {</span>
<a href="#l75.293"></a><span id="l75.293" class="difflineminus">-          entities[type] = [];</span>
<a href="#l75.294"></a><span id="l75.294" class="difflineminus">-        }</span>
<a href="#l75.295"></a><span id="l75.295" class="difflineminus">-</span>
<a href="#l75.296"></a><span id="l75.296" class="difflineminus">-        // Append the entities from the original status.</span>
<a href="#l75.297"></a><span id="l75.297" class="difflineminus">-        entities[type] = entities[type].concat(</span>
<a href="#l75.298"></a><span id="l75.298" class="difflineminus">-          retweetEntities[type].map(function(aEntity) {</span>
<a href="#l75.299"></a><span id="l75.299" class="difflineminus">-            let entity = Object.create(aEntity);</span>
<a href="#l75.300"></a><span id="l75.300" class="difflineminus">-            // Add the offset to the indices to account for the prefix.</span>
<a href="#l75.301"></a><span id="l75.301" class="difflineminus">-            entity.indices = entity.indices.map(i =&gt; i + offset);</span>
<a href="#l75.302"></a><span id="l75.302" class="difflineminus">-            return entity;</span>
<a href="#l75.303"></a><span id="l75.303" class="difflineminus">-          })</span>
<a href="#l75.304"></a><span id="l75.304" class="difflineminus">-        );</span>
<a href="#l75.305"></a><span id="l75.305" class="difflineminus">-      }</span>
<a href="#l75.306"></a><span id="l75.306" class="difflineminus">-    } else if (&quot;extended_tweet&quot; in tweet) {</span>
<a href="#l75.307"></a><span id="l75.307" class="difflineminus">-      // Bare bones extended tweet handling.</span>
<a href="#l75.308"></a><span id="l75.308" class="difflineminus">-      let extended = tweet.extended_tweet;</span>
<a href="#l75.309"></a><span id="l75.309" class="difflineminus">-      text = extended.full_text;</span>
<a href="#l75.310"></a><span id="l75.310" class="difflineminus">-      if (&quot;entities&quot; in extended) {</span>
<a href="#l75.311"></a><span id="l75.311" class="difflineminus">-        entities = extended.entities;</span>
<a href="#l75.312"></a><span id="l75.312" class="difflineminus">-      }</span>
<a href="#l75.313"></a><span id="l75.313" class="difflineminus">-    } else if (&quot;entities&quot; in tweet) {</span>
<a href="#l75.314"></a><span id="l75.314" class="difflineminus">-      // For non-retweets, we just want to use the entities that are given.</span>
<a href="#l75.315"></a><span id="l75.315" class="difflineminus">-      entities = tweet.entities;</span>
<a href="#l75.316"></a><span id="l75.316" class="difflineminus">-    }</span>
<a href="#l75.317"></a><span id="l75.317" class="difflineminus">-</span>
<a href="#l75.318"></a><span id="l75.318" class="difflineminus">-    this._account.LOG(&quot;Tweet: &quot; + text);</span>
<a href="#l75.319"></a><span id="l75.319" class="difflineminus">-</span>
<a href="#l75.320"></a><span id="l75.320" class="difflineminus">-    aMsg.displayMessage = twttr.txt.autoLink(text, {</span>
<a href="#l75.321"></a><span id="l75.321" class="difflineminus">-      usernameClass: &quot;ib-person&quot;,</span>
<a href="#l75.322"></a><span id="l75.322" class="difflineminus">-      usernameIncludeSymbol: true,</span>
<a href="#l75.323"></a><span id="l75.323" class="difflineminus">-      // Pass in the url entities so the t.co links are replaced.</span>
<a href="#l75.324"></a><span id="l75.324" class="difflineminus">-      urlEntities: tweet.entities.urls.map(function(u) {</span>
<a href="#l75.325"></a><span id="l75.325" class="difflineminus">-        let o = Object.assign(u);</span>
<a href="#l75.326"></a><span id="l75.326" class="difflineminus">-        // But remove the indices so they apply in the face of modifications.</span>
<a href="#l75.327"></a><span id="l75.327" class="difflineminus">-        delete o.indices;</span>
<a href="#l75.328"></a><span id="l75.328" class="difflineminus">-        return o;</span>
<a href="#l75.329"></a><span id="l75.329" class="difflineminus">-      }),</span>
<a href="#l75.330"></a><span id="l75.330" class="difflineminus">-    });</span>
<a href="#l75.331"></a><span id="l75.331" class="difflineminus">-</span>
<a href="#l75.332"></a><span id="l75.332" class="difflineminus">-    GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l75.333"></a><span id="l75.333" class="difflineminus">-  },</span>
<a href="#l75.334"></a><span id="l75.334" class="difflineminus">-  displayTweet(aTweet, aUser) {</span>
<a href="#l75.335"></a><span id="l75.335" class="difflineminus">-    let name = aUser.screen_name;</span>
<a href="#l75.336"></a><span id="l75.336" class="difflineminus">-</span>
<a href="#l75.337"></a><span id="l75.337" class="difflineminus">-    let flags = name == this.nick ? { outgoing: true } : { incoming: true };</span>
<a href="#l75.338"></a><span id="l75.338" class="difflineminus">-    flags.time = Math.floor(new Date(aTweet.created_at) / 1000);</span>
<a href="#l75.339"></a><span id="l75.339" class="difflineminus">-    flags._iconURL = aUser.profile_image_url;</span>
<a href="#l75.340"></a><span id="l75.340" class="difflineminus">-    if (aTweet.delayed) {</span>
<a href="#l75.341"></a><span id="l75.341" class="difflineminus">-      flags.delayed = true;</span>
<a href="#l75.342"></a><span id="l75.342" class="difflineminus">-    }</span>
<a href="#l75.343"></a><span id="l75.343" class="difflineminus">-    if (</span>
<a href="#l75.344"></a><span id="l75.344" class="difflineminus">-      aTweet.entities &amp;&amp;</span>
<a href="#l75.345"></a><span id="l75.345" class="difflineminus">-      aTweet.entities.user_mentions &amp;&amp;</span>
<a href="#l75.346"></a><span id="l75.346" class="difflineminus">-      Array.isArray(aTweet.entities.user_mentions) &amp;&amp;</span>
<a href="#l75.347"></a><span id="l75.347" class="difflineminus">-      aTweet.entities.user_mentions.some(</span>
<a href="#l75.348"></a><span id="l75.348" class="difflineminus">-        mention =&gt; mention.screen_name == this.nick</span>
<a href="#l75.349"></a><span id="l75.349" class="difflineminus">-      )</span>
<a href="#l75.350"></a><span id="l75.350" class="difflineminus">-    ) {</span>
<a href="#l75.351"></a><span id="l75.351" class="difflineminus">-      flags.containsNick = true;</span>
<a href="#l75.352"></a><span id="l75.352" class="difflineminus">-    }</span>
<a href="#l75.353"></a><span id="l75.353" class="difflineminus">-</span>
<a href="#l75.354"></a><span id="l75.354" class="difflineminus">-    let tweet = new Tweet(aTweet, name, aTweet.text, flags);</span>
<a href="#l75.355"></a><span id="l75.355" class="difflineminus">-    this._tweets.set(tweet.id, tweet);</span>
<a href="#l75.356"></a><span id="l75.356" class="difflineminus">-    tweet.conversation = this;</span>
<a href="#l75.357"></a><span id="l75.357" class="difflineminus">-  },</span>
<a href="#l75.358"></a><span id="l75.358" class="difflineminus">-  _parseError(aData) {</span>
<a href="#l75.359"></a><span id="l75.359" class="difflineminus">-    let error = &quot;&quot;;</span>
<a href="#l75.360"></a><span id="l75.360" class="difflineminus">-    try {</span>
<a href="#l75.361"></a><span id="l75.361" class="difflineminus">-      let data = JSON.parse(aData);</span>
<a href="#l75.362"></a><span id="l75.362" class="difflineminus">-      if (&quot;error&quot; in data) {</span>
<a href="#l75.363"></a><span id="l75.363" class="difflineminus">-        error = data.error;</span>
<a href="#l75.364"></a><span id="l75.364" class="difflineminus">-      } else if (&quot;errors&quot; in data) {</span>
<a href="#l75.365"></a><span id="l75.365" class="difflineminus">-        error = data.errors[0].message;</span>
<a href="#l75.366"></a><span id="l75.366" class="difflineminus">-      }</span>
<a href="#l75.367"></a><span id="l75.367" class="difflineminus">-      if (error) {</span>
<a href="#l75.368"></a><span id="l75.368" class="difflineminus">-        error = &quot;(&quot; + error + &quot;)&quot;;</span>
<a href="#l75.369"></a><span id="l75.369" class="difflineminus">-      }</span>
<a href="#l75.370"></a><span id="l75.370" class="difflineminus">-    } catch (e) {}</span>
<a href="#l75.371"></a><span id="l75.371" class="difflineminus">-    return error;</span>
<a href="#l75.372"></a><span id="l75.372" class="difflineminus">-  },</span>
<a href="#l75.373"></a><span id="l75.373" class="difflineminus">-  getNormalizedChatBuddyName: aNick =&gt; aNick.replace(/^@/, &quot;&quot;),</span>
<a href="#l75.374"></a><span id="l75.374" class="difflineminus">-};</span>
<a href="#l75.375"></a><span id="l75.375" class="difflineminus">-</span>
<a href="#l75.376"></a><span id="l75.376" class="difflineminus">-function TimelineConversation(aAccount) {</span>
<a href="#l75.377"></a><span id="l75.377" class="difflineminus">-  this._init(aAccount);</span>
<a href="#l75.378"></a><span id="l75.378" class="difflineminus">-  this._ensureParticipantExists(aAccount.name);</span>
<a href="#l75.379"></a><span id="l75.379" class="difflineminus">-  // We need the screen names for the IDs in _friends, but _userInfo is</span>
<a href="#l75.380"></a><span id="l75.380" class="difflineminus">-  // indexed by name, so we build an ID -&gt; name map.</span>
<a href="#l75.381"></a><span id="l75.381" class="difflineminus">-  let entries = [];</span>
<a href="#l75.382"></a><span id="l75.382" class="difflineminus">-  for (let [name, userInfo] of aAccount._userInfo) {</span>
<a href="#l75.383"></a><span id="l75.383" class="difflineminus">-    entries.push([userInfo.id_str, name]);</span>
<a href="#l75.384"></a><span id="l75.384" class="difflineminus">-  }</span>
<a href="#l75.385"></a><span id="l75.385" class="difflineminus">-  let names = new Map(entries);</span>
<a href="#l75.386"></a><span id="l75.386" class="difflineminus">-  for (let id_str of aAccount._friends) {</span>
<a href="#l75.387"></a><span id="l75.387" class="difflineminus">-    this._ensureParticipantExists(names.get(id_str));</span>
<a href="#l75.388"></a><span id="l75.388" class="difflineminus">-  }</span>
<a href="#l75.389"></a><span id="l75.389" class="difflineminus">-</span>
<a href="#l75.390"></a><span id="l75.390" class="difflineminus">-  // If the user's info has already been received, update the timeline topic.</span>
<a href="#l75.391"></a><span id="l75.391" class="difflineminus">-  if (aAccount._userInfo.has(aAccount.name)) {</span>
<a href="#l75.392"></a><span id="l75.392" class="difflineminus">-    let userInfo = aAccount._userInfo.get(aAccount.name);</span>
<a href="#l75.393"></a><span id="l75.393" class="difflineminus">-    if (&quot;description&quot; in userInfo) {</span>
<a href="#l75.394"></a><span id="l75.394" class="difflineminus">-      this.setTopic(userInfo.description, aAccount.name, true);</span>
<a href="#l75.395"></a><span id="l75.395" class="difflineminus">-    }</span>
<a href="#l75.396"></a><span id="l75.396" class="difflineminus">-  }</span>
<a href="#l75.397"></a><span id="l75.397" class="difflineminus">-</span>
<a href="#l75.398"></a><span id="l75.398" class="difflineminus">-  // Store messages by message id.</span>
<a href="#l75.399"></a><span id="l75.399" class="difflineminus">-  this._tweets = new Map();</span>
<a href="#l75.400"></a><span id="l75.400" class="difflineminus">-}</span>
<a href="#l75.401"></a><span id="l75.401" class="difflineminus">-TimelineConversation.prototype = {</span>
<a href="#l75.402"></a><span id="l75.402" class="difflineminus">-  __proto__: GenericConvChatPrototype,</span>
<a href="#l75.403"></a><span id="l75.403" class="difflineminus">-  unInit() {</span>
<a href="#l75.404"></a><span id="l75.404" class="difflineminus">-    delete this._account._timeline;</span>
<a href="#l75.405"></a><span id="l75.405" class="difflineminus">-    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l75.406"></a><span id="l75.406" class="difflineminus">-  },</span>
<a href="#l75.407"></a><span id="l75.407" class="difflineminus">-  inReplyToStatusId: null,</span>
<a href="#l75.408"></a><span id="l75.408" class="difflineminus">-  startReply(aTweet) {</span>
<a href="#l75.409"></a><span id="l75.409" class="difflineminus">-    this.inReplyToStatusId = aTweet.id_str;</span>
<a href="#l75.410"></a><span id="l75.410" class="difflineminus">-    let entities = aTweet.entities;</span>
<a href="#l75.411"></a><span id="l75.411" class="difflineminus">-</span>
<a href="#l75.412"></a><span id="l75.412" class="difflineminus">-    // Twitter replies go to all the users mentioned in the tweet.</span>
<a href="#l75.413"></a><span id="l75.413" class="difflineminus">-    let nicks = [aTweet.user.screen_name];</span>
<a href="#l75.414"></a><span id="l75.414" class="difflineminus">-    if (&quot;user_mentions&quot; in entities &amp;&amp; Array.isArray(entities.user_mentions)) {</span>
<a href="#l75.415"></a><span id="l75.415" class="difflineminus">-      nicks = nicks.concat(entities.user_mentions.map(um =&gt; um.screen_name));</span>
<a href="#l75.416"></a><span id="l75.416" class="difflineminus">-    }</span>
<a href="#l75.417"></a><span id="l75.417" class="difflineminus">-    // Ignore duplicates and the user's nick.</span>
<a href="#l75.418"></a><span id="l75.418" class="difflineminus">-    let prompt =</span>
<a href="#l75.419"></a><span id="l75.419" class="difflineminus">-      nicks</span>
<a href="#l75.420"></a><span id="l75.420" class="difflineminus">-        .filter(function(aNick, aPos) {</span>
<a href="#l75.421"></a><span id="l75.421" class="difflineminus">-          return nicks.indexOf(aNick) == aPos &amp;&amp; aNick != this._account.name;</span>
<a href="#l75.422"></a><span id="l75.422" class="difflineminus">-        }, this)</span>
<a href="#l75.423"></a><span id="l75.423" class="difflineminus">-        .map(aNick =&gt; &quot;@&quot; + aNick)</span>
<a href="#l75.424"></a><span id="l75.424" class="difflineminus">-        .join(&quot; &quot;) + &quot; &quot;;</span>
<a href="#l75.425"></a><span id="l75.425" class="difflineminus">-</span>
<a href="#l75.426"></a><span id="l75.426" class="difflineminus">-    this.notifyObservers(null, &quot;replying-to-prompt&quot;, prompt);</span>
<a href="#l75.427"></a><span id="l75.427" class="difflineminus">-    this.notifyObservers(</span>
<a href="#l75.428"></a><span id="l75.428" class="difflineminus">-      null,</span>
<a href="#l75.429"></a><span id="l75.429" class="difflineminus">-      &quot;status-text-changed&quot;,</span>
<a href="#l75.430"></a><span id="l75.430" class="difflineminus">-      _(&quot;replyingToStatusText&quot;, aTweet.text)</span>
<a href="#l75.431"></a><span id="l75.431" class="difflineminus">-    );</span>
<a href="#l75.432"></a><span id="l75.432" class="difflineminus">-  },</span>
<a href="#l75.433"></a><span id="l75.433" class="difflineminus">-  reTweet(aTweet) {</span>
<a href="#l75.434"></a><span id="l75.434" class="difflineminus">-    this._account.reTweet(</span>
<a href="#l75.435"></a><span id="l75.435" class="difflineminus">-      aTweet,</span>
<a href="#l75.436"></a><span id="l75.436" class="difflineminus">-      null,</span>
<a href="#l75.437"></a><span id="l75.437" class="difflineminus">-      function(aException, aData) {</span>
<a href="#l75.438"></a><span id="l75.438" class="difflineminus">-        this.systemMessage(</span>
<a href="#l75.439"></a><span id="l75.439" class="difflineminus">-          _(&quot;error.retweet&quot;, this._parseError(aData), aTweet.text),</span>
<a href="#l75.440"></a><span id="l75.440" class="difflineminus">-          true</span>
<a href="#l75.441"></a><span id="l75.441" class="difflineminus">-        );</span>
<a href="#l75.442"></a><span id="l75.442" class="difflineminus">-      },</span>
<a href="#l75.443"></a><span id="l75.443" class="difflineminus">-      this</span>
<a href="#l75.444"></a><span id="l75.444" class="difflineminus">-    );</span>
<a href="#l75.445"></a><span id="l75.445" class="difflineminus">-  },</span>
<a href="#l75.446"></a><span id="l75.446" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l75.447"></a><span id="l75.447" class="difflineminus">-    let parsed = twttr.txt.parseTweet(aMsg);</span>
<a href="#l75.448"></a><span id="l75.448" class="difflineminus">-    if (!parsed.valid) {</span>
<a href="#l75.449"></a><span id="l75.449" class="difflineminus">-      this.systemMessage(_(&quot;error.tooLong&quot;), true);</span>
<a href="#l75.450"></a><span id="l75.450" class="difflineminus">-      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l75.451"></a><span id="l75.451" class="difflineminus">-    }</span>
<a href="#l75.452"></a><span id="l75.452" class="difflineminus">-    this._account.tweet(</span>
<a href="#l75.453"></a><span id="l75.453" class="difflineminus">-      aMsg,</span>
<a href="#l75.454"></a><span id="l75.454" class="difflineminus">-      this.inReplyToStatusId,</span>
<a href="#l75.455"></a><span id="l75.455" class="difflineminus">-      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l75.456"></a><span id="l75.456" class="difflineminus">-      function(aException, aData) {</span>
<a href="#l75.457"></a><span id="l75.457" class="difflineminus">-        let error = this._parseError(aData);</span>
<a href="#l75.458"></a><span id="l75.458" class="difflineminus">-        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l75.459"></a><span id="l75.459" class="difflineminus">-      },</span>
<a href="#l75.460"></a><span id="l75.460" class="difflineminus">-      this</span>
<a href="#l75.461"></a><span id="l75.461" class="difflineminus">-    );</span>
<a href="#l75.462"></a><span id="l75.462" class="difflineminus">-    this.sendTyping(&quot;&quot;);</span>
<a href="#l75.463"></a><span id="l75.463" class="difflineminus">-  },</span>
<a href="#l75.464"></a><span id="l75.464" class="difflineminus">-  like(aTweet, aRemoveLike = false) {</span>
<a href="#l75.465"></a><span id="l75.465" class="difflineminus">-    this._account.like(</span>
<a href="#l75.466"></a><span id="l75.466" class="difflineminus">-      aTweet,</span>
<a href="#l75.467"></a><span id="l75.467" class="difflineminus">-      aRemoveLike,</span>
<a href="#l75.468"></a><span id="l75.468" class="difflineminus">-      function() {</span>
<a href="#l75.469"></a><span id="l75.469" class="difflineminus">-        aTweet.favorited = !aRemoveLike;</span>
<a href="#l75.470"></a><span id="l75.470" class="difflineminus">-      },</span>
<a href="#l75.471"></a><span id="l75.471" class="difflineminus">-      function(aException, aData) {</span>
<a href="#l75.472"></a><span id="l75.472" class="difflineminus">-        const messageName = aRemoveLike ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l75.473"></a><span id="l75.473" class="difflineminus">-        this.systemMessage(</span>
<a href="#l75.474"></a><span id="l75.474" class="difflineminus">-          _(&quot;error.&quot; + messageName, this.parseError(aData), aTweet.text),</span>
<a href="#l75.475"></a><span id="l75.475" class="difflineminus">-          true</span>
<a href="#l75.476"></a><span id="l75.476" class="difflineminus">-        );</span>
<a href="#l75.477"></a><span id="l75.477" class="difflineminus">-      },</span>
<a href="#l75.478"></a><span id="l75.478" class="difflineminus">-      this</span>
<a href="#l75.479"></a><span id="l75.479" class="difflineminus">-    );</span>
<a href="#l75.480"></a><span id="l75.480" class="difflineminus">-  },</span>
<a href="#l75.481"></a><span id="l75.481" class="difflineminus">-  sendTyping(aString) {</span>
<a href="#l75.482"></a><span id="l75.482" class="difflineminus">-    let maxlen = twttr.txt.configs.defaults.maxWeightedTweetLength;</span>
<a href="#l75.483"></a><span id="l75.483" class="difflineminus">-    if (aString.length == 0 &amp;&amp; this.inReplyToStatusId) {</span>
<a href="#l75.484"></a><span id="l75.484" class="difflineminus">-      delete this.inReplyToStatusId;</span>
<a href="#l75.485"></a><span id="l75.485" class="difflineminus">-      this.notifyObservers(null, &quot;status-text-changed&quot;);</span>
<a href="#l75.486"></a><span id="l75.486" class="difflineminus">-      return maxlen;</span>
<a href="#l75.487"></a><span id="l75.487" class="difflineminus">-    }</span>
<a href="#l75.488"></a><span id="l75.488" class="difflineminus">-    return maxlen - this.getTweetLength(aString);</span>
<a href="#l75.489"></a><span id="l75.489" class="difflineminus">-  },</span>
<a href="#l75.490"></a><span id="l75.490" class="difflineminus">-  displayMessages(aMessages) {</span>
<a href="#l75.491"></a><span id="l75.491" class="difflineminus">-    let account = this._account;</span>
<a href="#l75.492"></a><span id="l75.492" class="difflineminus">-    let lastMsgId = account._lastMsgId;</span>
<a href="#l75.493"></a><span id="l75.493" class="difflineminus">-    for (let tweet of aMessages) {</span>
<a href="#l75.494"></a><span id="l75.494" class="difflineminus">-      if (</span>
<a href="#l75.495"></a><span id="l75.495" class="difflineminus">-        !(&quot;user&quot; in tweet) ||</span>
<a href="#l75.496"></a><span id="l75.496" class="difflineminus">-        !(&quot;text&quot; in tweet) ||</span>
<a href="#l75.497"></a><span id="l75.497" class="difflineminus">-        !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l75.498"></a><span id="l75.498" class="difflineminus">-        account._knownMessageIds.has(tweet.id_str)</span>
<a href="#l75.499"></a><span id="l75.499" class="difflineminus">-      ) {</span>
<a href="#l75.500"></a><span id="l75.500" class="difflineminus">-        continue;</span>
<a href="#l75.501"></a><span id="l75.501" class="difflineminus">-      }</span>
<a href="#l75.502"></a><span id="l75.502" class="difflineminus">-      let id = tweet.id_str;</span>
<a href="#l75.503"></a><span id="l75.503" class="difflineminus">-      // Update the last known message.</span>
<a href="#l75.504"></a><span id="l75.504" class="difflineminus">-      // Compare the length of the ids first, and then the text.</span>
<a href="#l75.505"></a><span id="l75.505" class="difflineminus">-      // This avoids converting tweet ids into rounded numbers.</span>
<a href="#l75.506"></a><span id="l75.506" class="difflineminus">-      if (</span>
<a href="#l75.507"></a><span id="l75.507" class="difflineminus">-        id.length &gt; lastMsgId.length ||</span>
<a href="#l75.508"></a><span id="l75.508" class="difflineminus">-        (id.length == lastMsgId.length &amp;&amp; id &gt; lastMsgId)</span>
<a href="#l75.509"></a><span id="l75.509" class="difflineminus">-      ) {</span>
<a href="#l75.510"></a><span id="l75.510" class="difflineminus">-        lastMsgId = id;</span>
<a href="#l75.511"></a><span id="l75.511" class="difflineminus">-      }</span>
<a href="#l75.512"></a><span id="l75.512" class="difflineminus">-      account._knownMessageIds.add(id);</span>
<a href="#l75.513"></a><span id="l75.513" class="difflineminus">-      account.setUserInfo(tweet.user);</span>
<a href="#l75.514"></a><span id="l75.514" class="difflineminus">-      this._ensureParticipantExists(tweet.user.screen_name);</span>
<a href="#l75.515"></a><span id="l75.515" class="difflineminus">-      this.displayTweet(tweet, tweet.user);</span>
<a href="#l75.516"></a><span id="l75.516" class="difflineminus">-    }</span>
<a href="#l75.517"></a><span id="l75.517" class="difflineminus">-    if (lastMsgId != account._lastMsgId) {</span>
<a href="#l75.518"></a><span id="l75.518" class="difflineminus">-      account._lastMsgId = lastMsgId;</span>
<a href="#l75.519"></a><span id="l75.519" class="difflineminus">-      account.prefs.setCharPref(&quot;lastMessageId&quot;, account._lastMsgId);</span>
<a href="#l75.520"></a><span id="l75.520" class="difflineminus">-    }</span>
<a href="#l75.521"></a><span id="l75.521" class="difflineminus">-  },</span>
<a href="#l75.522"></a><span id="l75.522" class="difflineminus">-  _ensureParticipantExists(aNick) {</span>
<a href="#l75.523"></a><span id="l75.523" class="difflineminus">-    if (this._participants.has(aNick)) {</span>
<a href="#l75.524"></a><span id="l75.524" class="difflineminus">-      return;</span>
<a href="#l75.525"></a><span id="l75.525" class="difflineminus">-    }</span>
<a href="#l75.526"></a><span id="l75.526" class="difflineminus">-</span>
<a href="#l75.527"></a><span id="l75.527" class="difflineminus">-    let chatBuddy = new ChatBuddy(aNick, this._account);</span>
<a href="#l75.528"></a><span id="l75.528" class="difflineminus">-    this._participants.set(aNick, chatBuddy);</span>
<a href="#l75.529"></a><span id="l75.529" class="difflineminus">-    this.notifyObservers(new nsSimpleEnumerator([chatBuddy]), &quot;chat-buddy-add&quot;);</span>
<a href="#l75.530"></a><span id="l75.530" class="difflineminus">-  },</span>
<a href="#l75.531"></a><span id="l75.531" class="difflineminus">-  get name() {</span>
<a href="#l75.532"></a><span id="l75.532" class="difflineminus">-    return this.nick + &quot; timeline&quot;;</span>
<a href="#l75.533"></a><span id="l75.533" class="difflineminus">-  },</span>
<a href="#l75.534"></a><span id="l75.534" class="difflineminus">-  get title() {</span>
<a href="#l75.535"></a><span id="l75.535" class="difflineminus">-    return _(&quot;timeline&quot;, this.nick);</span>
<a href="#l75.536"></a><span id="l75.536" class="difflineminus">-  },</span>
<a href="#l75.537"></a><span id="l75.537" class="difflineminus">-  get nick() {</span>
<a href="#l75.538"></a><span id="l75.538" class="difflineminus">-    return this._account.name;</span>
<a href="#l75.539"></a><span id="l75.539" class="difflineminus">-  },</span>
<a href="#l75.540"></a><span id="l75.540" class="difflineminus">-  set nick(aNick) {},</span>
<a href="#l75.541"></a><span id="l75.541" class="difflineminus">-  get topicSettable() {</span>
<a href="#l75.542"></a><span id="l75.542" class="difflineminus">-    return this.nick == this._account.name;</span>
<a href="#l75.543"></a><span id="l75.543" class="difflineminus">-  },</span>
<a href="#l75.544"></a><span id="l75.544" class="difflineminus">-  get topic() {</span>
<a href="#l75.545"></a><span id="l75.545" class="difflineminus">-    return this._topic;</span>
<a href="#l75.546"></a><span id="l75.546" class="difflineminus">-  }, // can't add a setter without redefining the getter</span>
<a href="#l75.547"></a><span id="l75.547" class="difflineminus">-  set topic(aTopic) {</span>
<a href="#l75.548"></a><span id="l75.548" class="difflineminus">-    if (this.topicSettable) {</span>
<a href="#l75.549"></a><span id="l75.549" class="difflineminus">-      this._account.setUserDescription(aTopic);</span>
<a href="#l75.550"></a><span id="l75.550" class="difflineminus">-    }</span>
<a href="#l75.551"></a><span id="l75.551" class="difflineminus">-  },</span>
<a href="#l75.552"></a><span id="l75.552" class="difflineminus">-};</span>
<a href="#l75.553"></a><span id="l75.553" class="difflineminus">-Object.assign(TimelineConversation.prototype, GenericTwitterConversation);</span>
<a href="#l75.554"></a><span id="l75.554" class="difflineminus">-</span>
<a href="#l75.555"></a><span id="l75.555" class="difflineminus">-function DirectMessageConversation(aAccount, aName) {</span>
<a href="#l75.556"></a><span id="l75.556" class="difflineminus">-  this._init(aAccount, aName);</span>
<a href="#l75.557"></a><span id="l75.557" class="difflineminus">-</span>
<a href="#l75.558"></a><span id="l75.558" class="difflineminus">-  // Store messages by message id.</span>
<a href="#l75.559"></a><span id="l75.559" class="difflineminus">-  this._tweets = new Map();</span>
<a href="#l75.560"></a><span id="l75.560" class="difflineminus">-}</span>
<a href="#l75.561"></a><span id="l75.561" class="difflineminus">-DirectMessageConversation.prototype = {</span>
<a href="#l75.562"></a><span id="l75.562" class="difflineminus">-  __proto__: GenericConvIMPrototype,</span>
<a href="#l75.563"></a><span id="l75.563" class="difflineminus">-  sendMsg(aMsg) {</span>
<a href="#l75.564"></a><span id="l75.564" class="difflineminus">-    this._account.directMessage(</span>
<a href="#l75.565"></a><span id="l75.565" class="difflineminus">-      aMsg,</span>
<a href="#l75.566"></a><span id="l75.566" class="difflineminus">-      this.name,</span>
<a href="#l75.567"></a><span id="l75.567" class="difflineminus">-      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l75.568"></a><span id="l75.568" class="difflineminus">-      function(aException, aData) {</span>
<a href="#l75.569"></a><span id="l75.569" class="difflineminus">-        let error = this._parseError(aData);</span>
<a href="#l75.570"></a><span id="l75.570" class="difflineminus">-        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l75.571"></a><span id="l75.571" class="difflineminus">-      },</span>
<a href="#l75.572"></a><span id="l75.572" class="difflineminus">-      this</span>
<a href="#l75.573"></a><span id="l75.573" class="difflineminus">-    );</span>
<a href="#l75.574"></a><span id="l75.574" class="difflineminus">-  },</span>
<a href="#l75.575"></a><span id="l75.575" class="difflineminus">-  displayMessages(aMessages) {</span>
<a href="#l75.576"></a><span id="l75.576" class="difflineminus">-    let account = this._account;</span>
<a href="#l75.577"></a><span id="l75.577" class="difflineminus">-    for (let tweet of aMessages) {</span>
<a href="#l75.578"></a><span id="l75.578" class="difflineminus">-      if (</span>
<a href="#l75.579"></a><span id="l75.579" class="difflineminus">-        !(&quot;sender&quot; in tweet) ||</span>
<a href="#l75.580"></a><span id="l75.580" class="difflineminus">-        !(&quot;recipient&quot; in tweet) ||</span>
<a href="#l75.581"></a><span id="l75.581" class="difflineminus">-        !(&quot;text&quot; in tweet) ||</span>
<a href="#l75.582"></a><span id="l75.582" class="difflineminus">-        !(&quot;id_str&quot; in tweet)</span>
<a href="#l75.583"></a><span id="l75.583" class="difflineminus">-      ) {</span>
<a href="#l75.584"></a><span id="l75.584" class="difflineminus">-        continue;</span>
<a href="#l75.585"></a><span id="l75.585" class="difflineminus">-      }</span>
<a href="#l75.586"></a><span id="l75.586" class="difflineminus">-      account.setUserInfo(tweet.sender);</span>
<a href="#l75.587"></a><span id="l75.587" class="difflineminus">-      account.setUserInfo(tweet.recipient);</span>
<a href="#l75.588"></a><span id="l75.588" class="difflineminus">-      this.displayTweet(tweet, tweet.sender);</span>
<a href="#l75.589"></a><span id="l75.589" class="difflineminus">-    }</span>
<a href="#l75.590"></a><span id="l75.590" class="difflineminus">-  },</span>
<a href="#l75.591"></a><span id="l75.591" class="difflineminus">-  unInit() {</span>
<a href="#l75.592"></a><span id="l75.592" class="difflineminus">-    this._account.removeConversation(this.name);</span>
<a href="#l75.593"></a><span id="l75.593" class="difflineminus">-    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l75.594"></a><span id="l75.594" class="difflineminus">-  },</span>
<a href="#l75.595"></a><span id="l75.595" class="difflineminus">-  get nick() {</span>
<a href="#l75.596"></a><span id="l75.596" class="difflineminus">-    return this._account.name;</span>
<a href="#l75.597"></a><span id="l75.597" class="difflineminus">-  },</span>
<a href="#l75.598"></a><span id="l75.598" class="difflineminus">-  set nick(aNick) {},</span>
<a href="#l75.599"></a><span id="l75.599" class="difflineminus">-};</span>
<a href="#l75.600"></a><span id="l75.600" class="difflineminus">-Object.assign(DirectMessageConversation.prototype, GenericTwitterConversation);</span>
<a href="#l75.601"></a><span id="l75.601" class="difflineminus">-</span>
<a href="#l75.602"></a><span id="l75.602" class="difflineminus">-function Account(aProtocol, aImAccount) {</span>
<a href="#l75.603"></a><span id="l75.603" class="difflineminus">-  this._init(aProtocol, aImAccount);</span>
<a href="#l75.604"></a><span id="l75.604" class="difflineminus">-  this._knownMessageIds = new Set();</span>
<a href="#l75.605"></a><span id="l75.605" class="difflineminus">-  this._userInfo = new Map();</span>
<a href="#l75.606"></a><span id="l75.606" class="difflineminus">-  this._friends = new Set();</span>
<a href="#l75.607"></a><span id="l75.607" class="difflineminus">-  // Contains just `DirectMessageConversation`s</span>
<a href="#l75.608"></a><span id="l75.608" class="difflineminus">-  this._conversations = new Map();</span>
<a href="#l75.609"></a><span id="l75.609" class="difflineminus">-}</span>
<a href="#l75.610"></a><span id="l75.610" class="difflineminus">-Account.prototype = {</span>
<a href="#l75.611"></a><span id="l75.611" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l75.612"></a><span id="l75.612" class="difflineminus">-</span>
<a href="#l75.613"></a><span id="l75.613" class="difflineminus">-  // The correct normalization for twitter would be just toLowerCase().</span>
<a href="#l75.614"></a><span id="l75.614" class="difflineminus">-  // Unfortunately, for backwards compatibility we retain this normalization,</span>
<a href="#l75.615"></a><span id="l75.615" class="difflineminus">-  // which can cause edge cases for usernames with underscores.</span>
<a href="#l75.616"></a><span id="l75.616" class="difflineminus">-  normalize: aString =&gt; aString.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(),</span>
<a href="#l75.617"></a><span id="l75.617" class="difflineminus">-</span>
<a href="#l75.618"></a><span id="l75.618" class="difflineminus">-  consumerKey: Services.prefs.getCharPref(&quot;chat.twitter.consumerKey&quot;),</span>
<a href="#l75.619"></a><span id="l75.619" class="difflineminus">-  consumerSecret: Services.prefs.getCharPref(&quot;chat.twitter.consumerSecret&quot;),</span>
<a href="#l75.620"></a><span id="l75.620" class="difflineminus">-  completionURI: &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l75.621"></a><span id="l75.621" class="difflineminus">-  baseURI: &quot;https://api.twitter.com/&quot;,</span>
<a href="#l75.622"></a><span id="l75.622" class="difflineminus">-  _lastMsgId: &quot;&quot;,</span>
<a href="#l75.623"></a><span id="l75.623" class="difflineminus">-</span>
<a href="#l75.624"></a><span id="l75.624" class="difflineminus">-  // Use this to keep track of the pending timeline requests. We attempt to fetch</span>
<a href="#l75.625"></a><span id="l75.625" class="difflineminus">-  // home_timeline, @ mentions and tracked keywords (i.e. 3 timelines)</span>
<a href="#l75.626"></a><span id="l75.626" class="difflineminus">-  _pendingRequests: [],</span>
<a href="#l75.627"></a><span id="l75.627" class="difflineminus">-  _timelineBuffer: [],</span>
<a href="#l75.628"></a><span id="l75.628" class="difflineminus">-  _timelineAuthError: 0,</span>
<a href="#l75.629"></a><span id="l75.629" class="difflineminus">-</span>
<a href="#l75.630"></a><span id="l75.630" class="difflineminus">-  token: &quot;&quot;,</span>
<a href="#l75.631"></a><span id="l75.631" class="difflineminus">-  tokenSecret: &quot;&quot;,</span>
<a href="#l75.632"></a><span id="l75.632" class="difflineminus">-  connect() {</span>
<a href="#l75.633"></a><span id="l75.633" class="difflineminus">-    if (this.connected || this.connecting) {</span>
<a href="#l75.634"></a><span id="l75.634" class="difflineminus">-      return;</span>
<a href="#l75.635"></a><span id="l75.635" class="difflineminus">-    }</span>
<a href="#l75.636"></a><span id="l75.636" class="difflineminus">-</span>
<a href="#l75.637"></a><span id="l75.637" class="difflineminus">-    this.reportConnecting();</span>
<a href="#l75.638"></a><span id="l75.638" class="difflineminus">-</span>
<a href="#l75.639"></a><span id="l75.639" class="difflineminus">-    // Read the OAuth token from the prefs</span>
<a href="#l75.640"></a><span id="l75.640" class="difflineminus">-    let prefValue = {};</span>
<a href="#l75.641"></a><span id="l75.641" class="difflineminus">-    try {</span>
<a href="#l75.642"></a><span id="l75.642" class="difflineminus">-      prefValue = JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l75.643"></a><span id="l75.643" class="difflineminus">-    } catch (e) {}</span>
<a href="#l75.644"></a><span id="l75.644" class="difflineminus">-    if (prefValue.hasOwnProperty(this.consumerKey)) {</span>
<a href="#l75.645"></a><span id="l75.645" class="difflineminus">-      let result = prefValue[this.consumerKey];</span>
<a href="#l75.646"></a><span id="l75.646" class="difflineminus">-      this.token = result.oauth_token;</span>
<a href="#l75.647"></a><span id="l75.647" class="difflineminus">-      this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l75.648"></a><span id="l75.648" class="difflineminus">-      if (!this.fixAccountName(result)) {</span>
<a href="#l75.649"></a><span id="l75.649" class="difflineminus">-        return;</span>
<a href="#l75.650"></a><span id="l75.650" class="difflineminus">-      }</span>
<a href="#l75.651"></a><span id="l75.651" class="difflineminus">-    }</span>
<a href="#l75.652"></a><span id="l75.652" class="difflineminus">-</span>
<a href="#l75.653"></a><span id="l75.653" class="difflineminus">-    // Get a new token if needed...</span>
<a href="#l75.654"></a><span id="l75.654" class="difflineminus">-    if (!this.token || !this.tokenSecret) {</span>
<a href="#l75.655"></a><span id="l75.655" class="difflineminus">-      this.requestToken();</span>
<a href="#l75.656"></a><span id="l75.656" class="difflineminus">-      return;</span>
<a href="#l75.657"></a><span id="l75.657" class="difflineminus">-    }</span>
<a href="#l75.658"></a><span id="l75.658" class="difflineminus">-</span>
<a href="#l75.659"></a><span id="l75.659" class="difflineminus">-    this.LOG(&quot;Connecting using existing token&quot;);</span>
<a href="#l75.660"></a><span id="l75.660" class="difflineminus">-    this.getTimelines();</span>
<a href="#l75.661"></a><span id="l75.661" class="difflineminus">-  },</span>
<a href="#l75.662"></a><span id="l75.662" class="difflineminus">-</span>
<a href="#l75.663"></a><span id="l75.663" class="difflineminus">-  observe(aSubject, aTopic, aMsg) {</span>
<a href="#l75.664"></a><span id="l75.664" class="difflineminus">-    // Twitter doesn't broadcast the user's availability, so we can ignore</span>
<a href="#l75.665"></a><span id="l75.665" class="difflineminus">-    // imIUserStatusInfo's status notifications.</span>
<a href="#l75.666"></a><span id="l75.666" class="difflineminus">-    if (aTopic != NS_PREFBRANCH_PREFCHANGE_TOPIC_ID) {</span>
<a href="#l75.667"></a><span id="l75.667" class="difflineminus">-      return;</span>
<a href="#l75.668"></a><span id="l75.668" class="difflineminus">-    }</span>
<a href="#l75.669"></a><span id="l75.669" class="difflineminus">-</span>
<a href="#l75.670"></a><span id="l75.670" class="difflineminus">-    // Reopen the stream with the new tracked keywords.</span>
<a href="#l75.671"></a><span id="l75.671" class="difflineminus">-    this.DEBUG(&quot;Twitter tracked keywords modified: &quot; + this.getString(&quot;track&quot;));</span>
<a href="#l75.672"></a><span id="l75.672" class="difflineminus">-</span>
<a href="#l75.673"></a><span id="l75.673" class="difflineminus">-    // Close the stream and reopen it.</span>
<a href="#l75.674"></a><span id="l75.674" class="difflineminus">-    this._streamingRequest.abort();</span>
<a href="#l75.675"></a><span id="l75.675" class="difflineminus">-    this.openStream();</span>
<a href="#l75.676"></a><span id="l75.676" class="difflineminus">-  },</span>
<a href="#l75.677"></a><span id="l75.677" class="difflineminus">-</span>
<a href="#l75.678"></a><span id="l75.678" class="difflineminus">-  signAndSend(</span>
<a href="#l75.679"></a><span id="l75.679" class="difflineminus">-    aUrl,</span>
<a href="#l75.680"></a><span id="l75.680" class="difflineminus">-    aHeaders,</span>
<a href="#l75.681"></a><span id="l75.681" class="difflineminus">-    aPOSTData,</span>
<a href="#l75.682"></a><span id="l75.682" class="difflineminus">-    aOnLoad,</span>
<a href="#l75.683"></a><span id="l75.683" class="difflineminus">-    aOnError,</span>
<a href="#l75.684"></a><span id="l75.684" class="difflineminus">-    aThis,</span>
<a href="#l75.685"></a><span id="l75.685" class="difflineminus">-    aOAuthParams</span>
<a href="#l75.686"></a><span id="l75.686" class="difflineminus">-  ) {</span>
<a href="#l75.687"></a><span id="l75.687" class="difflineminus">-    const kChars =</span>
<a href="#l75.688"></a><span id="l75.688" class="difflineminus">-      &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&quot;;</span>
<a href="#l75.689"></a><span id="l75.689" class="difflineminus">-    const kNonceLength = 6;</span>
<a href="#l75.690"></a><span id="l75.690" class="difflineminus">-    let nonce = &quot;&quot;;</span>
<a href="#l75.691"></a><span id="l75.691" class="difflineminus">-    for (let i = 0; i &lt; kNonceLength; ++i) {</span>
<a href="#l75.692"></a><span id="l75.692" class="difflineminus">-      nonce += kChars[Math.floor(Math.random() * kChars.length)];</span>
<a href="#l75.693"></a><span id="l75.693" class="difflineminus">-    }</span>
<a href="#l75.694"></a><span id="l75.694" class="difflineminus">-</span>
<a href="#l75.695"></a><span id="l75.695" class="difflineminus">-    let params = (aOAuthParams || []).concat([</span>
<a href="#l75.696"></a><span id="l75.696" class="difflineminus">-      [&quot;oauth_consumer_key&quot;, this.consumerKey],</span>
<a href="#l75.697"></a><span id="l75.697" class="difflineminus">-      [&quot;oauth_nonce&quot;, nonce],</span>
<a href="#l75.698"></a><span id="l75.698" class="difflineminus">-      [&quot;oauth_signature_method&quot;, &quot;HMAC-SHA1&quot;],</span>
<a href="#l75.699"></a><span id="l75.699" class="difflineminus">-      [&quot;oauth_token&quot;, this.token],</span>
<a href="#l75.700"></a><span id="l75.700" class="difflineminus">-      [&quot;oauth_timestamp&quot;, Math.floor(new Date().getTime() / 1000)],</span>
<a href="#l75.701"></a><span id="l75.701" class="difflineminus">-      [&quot;oauth_version&quot;, &quot;1.0&quot;],</span>
<a href="#l75.702"></a><span id="l75.702" class="difflineminus">-    ]);</span>
<a href="#l75.703"></a><span id="l75.703" class="difflineminus">-</span>
<a href="#l75.704"></a><span id="l75.704" class="difflineminus">-    let dataParams = [];</span>
<a href="#l75.705"></a><span id="l75.705" class="difflineminus">-    let url = /^https?:/.test(aUrl) ? aUrl : this.baseURI + aUrl;</span>
<a href="#l75.706"></a><span id="l75.706" class="difflineminus">-    let urlSpec = url;</span>
<a href="#l75.707"></a><span id="l75.707" class="difflineminus">-    let queryIndex = url.indexOf(&quot;?&quot;);</span>
<a href="#l75.708"></a><span id="l75.708" class="difflineminus">-    if (queryIndex != -1) {</span>
<a href="#l75.709"></a><span id="l75.709" class="difflineminus">-      urlSpec = url.slice(0, queryIndex);</span>
<a href="#l75.710"></a><span id="l75.710" class="difflineminus">-      dataParams = url</span>
<a href="#l75.711"></a><span id="l75.711" class="difflineminus">-        .slice(queryIndex + 1)</span>
<a href="#l75.712"></a><span id="l75.712" class="difflineminus">-        .split(&quot;&amp;&quot;)</span>
<a href="#l75.713"></a><span id="l75.713" class="difflineminus">-        .map(p =&gt; p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l75.714"></a><span id="l75.714" class="difflineminus">-    }</span>
<a href="#l75.715"></a><span id="l75.715" class="difflineminus">-    let method = &quot;GET&quot;;</span>
<a href="#l75.716"></a><span id="l75.716" class="difflineminus">-    if (aPOSTData) {</span>
<a href="#l75.717"></a><span id="l75.717" class="difflineminus">-      method = &quot;POST&quot;;</span>
<a href="#l75.718"></a><span id="l75.718" class="difflineminus">-      aPOSTData.forEach(function(p) {</span>
<a href="#l75.719"></a><span id="l75.719" class="difflineminus">-        dataParams.push(p.map(percentEncode));</span>
<a href="#l75.720"></a><span id="l75.720" class="difflineminus">-      });</span>
<a href="#l75.721"></a><span id="l75.721" class="difflineminus">-    }</span>
<a href="#l75.722"></a><span id="l75.722" class="difflineminus">-</span>
<a href="#l75.723"></a><span id="l75.723" class="difflineminus">-    let signatureKey = this.consumerSecret + &quot;&amp;&quot; + this.tokenSecret;</span>
<a href="#l75.724"></a><span id="l75.724" class="difflineminus">-    let signatureBase =</span>
<a href="#l75.725"></a><span id="l75.725" class="difflineminus">-      method +</span>
<a href="#l75.726"></a><span id="l75.726" class="difflineminus">-      &quot;&amp;&quot; +</span>
<a href="#l75.727"></a><span id="l75.727" class="difflineminus">-      encodeURIComponent(urlSpec) +</span>
<a href="#l75.728"></a><span id="l75.728" class="difflineminus">-      &quot;&amp;&quot; +</span>
<a href="#l75.729"></a><span id="l75.729" class="difflineminus">-      params</span>
<a href="#l75.730"></a><span id="l75.730" class="difflineminus">-        .concat(dataParams)</span>
<a href="#l75.731"></a><span id="l75.731" class="difflineminus">-        .sort((a, b) =&gt; {</span>
<a href="#l75.732"></a><span id="l75.732" class="difflineminus">-          if (a[0] &lt; b[0]) {</span>
<a href="#l75.733"></a><span id="l75.733" class="difflineminus">-            return -1;</span>
<a href="#l75.734"></a><span id="l75.734" class="difflineminus">-          }</span>
<a href="#l75.735"></a><span id="l75.735" class="difflineminus">-          return a[0] &gt; b[0] ? 1 : 0;</span>
<a href="#l75.736"></a><span id="l75.736" class="difflineminus">-        })</span>
<a href="#l75.737"></a><span id="l75.737" class="difflineminus">-        .map(p =&gt; p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l75.738"></a><span id="l75.738" class="difflineminus">-        .join(&quot;%26&quot;);</span>
<a href="#l75.739"></a><span id="l75.739" class="difflineminus">-</span>
<a href="#l75.740"></a><span id="l75.740" class="difflineminus">-    let keyFactory = Cc[&quot;@mozilla.org/security/keyobjectfactory;1&quot;].getService(</span>
<a href="#l75.741"></a><span id="l75.741" class="difflineminus">-      Ci.nsIKeyObjectFactory</span>
<a href="#l75.742"></a><span id="l75.742" class="difflineminus">-    );</span>
<a href="#l75.743"></a><span id="l75.743" class="difflineminus">-    let hmac = Cc[&quot;@mozilla.org/security/hmac;1&quot;].createInstance(</span>
<a href="#l75.744"></a><span id="l75.744" class="difflineminus">-      Ci.nsICryptoHMAC</span>
<a href="#l75.745"></a><span id="l75.745" class="difflineminus">-    );</span>
<a href="#l75.746"></a><span id="l75.746" class="difflineminus">-    hmac.init(</span>
<a href="#l75.747"></a><span id="l75.747" class="difflineminus">-      hmac.SHA1,</span>
<a href="#l75.748"></a><span id="l75.748" class="difflineminus">-      keyFactory.keyFromString(Ci.nsIKeyObject.HMAC, signatureKey)</span>
<a href="#l75.749"></a><span id="l75.749" class="difflineminus">-    );</span>
<a href="#l75.750"></a><span id="l75.750" class="difflineminus">-    // No UTF-8 encoding, special chars are already escaped.</span>
<a href="#l75.751"></a><span id="l75.751" class="difflineminus">-    let bytes = [...signatureBase].map(b =&gt; b.charCodeAt());</span>
<a href="#l75.752"></a><span id="l75.752" class="difflineminus">-    hmac.update(bytes, bytes.length);</span>
<a href="#l75.753"></a><span id="l75.753" class="difflineminus">-    let signature = hmac.finish(true);</span>
<a href="#l75.754"></a><span id="l75.754" class="difflineminus">-</span>
<a href="#l75.755"></a><span id="l75.755" class="difflineminus">-    params.push([&quot;oauth_signature&quot;, encodeURIComponent(signature)]);</span>
<a href="#l75.756"></a><span id="l75.756" class="difflineminus">-</span>
<a href="#l75.757"></a><span id="l75.757" class="difflineminus">-    let authorization =</span>
<a href="#l75.758"></a><span id="l75.758" class="difflineminus">-      &quot;OAuth &quot; + params.map(p =&gt; p[0] + '=&quot;' + p[1] + '&quot;').join(&quot;, &quot;);</span>
<a href="#l75.759"></a><span id="l75.759" class="difflineminus">-</span>
<a href="#l75.760"></a><span id="l75.760" class="difflineminus">-    let options = {</span>
<a href="#l75.761"></a><span id="l75.761" class="difflineminus">-      headers: (aHeaders || []).concat([[&quot;Authorization&quot;, authorization]]),</span>
<a href="#l75.762"></a><span id="l75.762" class="difflineminus">-      postData: aPOSTData,</span>
<a href="#l75.763"></a><span id="l75.763" class="difflineminus">-      onLoad: aOnLoad ? aOnLoad.bind(aThis) : null,</span>
<a href="#l75.764"></a><span id="l75.764" class="difflineminus">-      onError: aOnError ? aOnError.bind(aThis) : null,</span>
<a href="#l75.765"></a><span id="l75.765" class="difflineminus">-      logger: {</span>
<a href="#l75.766"></a><span id="l75.766" class="difflineminus">-        log: this.LOG.bind(this),</span>
<a href="#l75.767"></a><span id="l75.767" class="difflineminus">-        debug: this.DEBUG.bind(this),</span>
<a href="#l75.768"></a><span id="l75.768" class="difflineminus">-      },</span>
<a href="#l75.769"></a><span id="l75.769" class="difflineminus">-    };</span>
<a href="#l75.770"></a><span id="l75.770" class="difflineminus">-    return httpRequest(url, options);</span>
<a href="#l75.771"></a><span id="l75.771" class="difflineminus">-  },</span>
<a href="#l75.772"></a><span id="l75.772" class="difflineminus">-  _parseURLData(aData) {</span>
<a href="#l75.773"></a><span id="l75.773" class="difflineminus">-    let result = {};</span>
<a href="#l75.774"></a><span id="l75.774" class="difflineminus">-    aData.split(&quot;&amp;&quot;).forEach(function(aParam) {</span>
<a href="#l75.775"></a><span id="l75.775" class="difflineminus">-      let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l75.776"></a><span id="l75.776" class="difflineminus">-      result[key] = value;</span>
<a href="#l75.777"></a><span id="l75.777" class="difflineminus">-    });</span>
<a href="#l75.778"></a><span id="l75.778" class="difflineminus">-    return result;</span>
<a href="#l75.779"></a><span id="l75.779" class="difflineminus">-  },</span>
<a href="#l75.780"></a><span id="l75.780" class="difflineminus">-</span>
<a href="#l75.781"></a><span id="l75.781" class="difflineminus">-  tweet(aMsg, aInReplyToId, aOnSent, aOnError, aThis) {</span>
<a href="#l75.782"></a><span id="l75.782" class="difflineminus">-    let POSTData = [[&quot;status&quot;, aMsg]];</span>
<a href="#l75.783"></a><span id="l75.783" class="difflineminus">-    if (aInReplyToId) {</span>
<a href="#l75.784"></a><span id="l75.784" class="difflineminus">-      POSTData.push([&quot;in_reply_to_status_id&quot;, aInReplyToId]);</span>
<a href="#l75.785"></a><span id="l75.785" class="difflineminus">-    }</span>
<a href="#l75.786"></a><span id="l75.786" class="difflineminus">-    this.signAndSend(</span>
<a href="#l75.787"></a><span id="l75.787" class="difflineminus">-      &quot;1.1/statuses/update.json&quot;,</span>
<a href="#l75.788"></a><span id="l75.788" class="difflineminus">-      null,</span>
<a href="#l75.789"></a><span id="l75.789" class="difflineminus">-      POSTData,</span>
<a href="#l75.790"></a><span id="l75.790" class="difflineminus">-      aOnSent,</span>
<a href="#l75.791"></a><span id="l75.791" class="difflineminus">-      aOnError,</span>
<a href="#l75.792"></a><span id="l75.792" class="difflineminus">-      aThis</span>
<a href="#l75.793"></a><span id="l75.793" class="difflineminus">-    );</span>
<a href="#l75.794"></a><span id="l75.794" class="difflineminus">-  },</span>
<a href="#l75.795"></a><span id="l75.795" class="difflineminus">-  reTweet(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l75.796"></a><span id="l75.796" class="difflineminus">-    let url = &quot;1.1/statuses/retweet/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l75.797"></a><span id="l75.797" class="difflineminus">-    this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l75.798"></a><span id="l75.798" class="difflineminus">-  },</span>
<a href="#l75.799"></a><span id="l75.799" class="difflineminus">-  destroy(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l75.800"></a><span id="l75.800" class="difflineminus">-    let url = &quot;1.1/statuses/destroy/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l75.801"></a><span id="l75.801" class="difflineminus">-    this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l75.802"></a><span id="l75.802" class="difflineminus">-  },</span>
<a href="#l75.803"></a><span id="l75.803" class="difflineminus">-  directMessage(aMsg, aName, aOnSent, aOnError, aThis) {</span>
<a href="#l75.804"></a><span id="l75.804" class="difflineminus">-    let POSTData = [[&quot;text&quot;, aMsg], [&quot;screen_name&quot;, aName]];</span>
<a href="#l75.805"></a><span id="l75.805" class="difflineminus">-    this.signAndSend(</span>
<a href="#l75.806"></a><span id="l75.806" class="difflineminus">-      &quot;1.1/direct_messages/new.json&quot;,</span>
<a href="#l75.807"></a><span id="l75.807" class="difflineminus">-      null,</span>
<a href="#l75.808"></a><span id="l75.808" class="difflineminus">-      POSTData,</span>
<a href="#l75.809"></a><span id="l75.809" class="difflineminus">-      aOnSent,</span>
<a href="#l75.810"></a><span id="l75.810" class="difflineminus">-      aOnError,</span>
<a href="#l75.811"></a><span id="l75.811" class="difflineminus">-      aThis</span>
<a href="#l75.812"></a><span id="l75.812" class="difflineminus">-    );</span>
<a href="#l75.813"></a><span id="l75.813" class="difflineminus">-  },</span>
<a href="#l75.814"></a><span id="l75.814" class="difflineminus">-  like(aTweet, aRemoveLike, aOnSent, aOnError, aThis) {</span>
<a href="#l75.815"></a><span id="l75.815" class="difflineminus">-    const action = aRemoveLike ? &quot;destroy&quot; : &quot;create&quot;;</span>
<a href="#l75.816"></a><span id="l75.816" class="difflineminus">-    const url = `1.1/favorites/${action}.json`;</span>
<a href="#l75.817"></a><span id="l75.817" class="difflineminus">-    const POSTData = [[&quot;id&quot;, aTweet.id_str]];</span>
<a href="#l75.818"></a><span id="l75.818" class="difflineminus">-    this.signAndSend(url, null, POSTData, aOnSent, aOnError, aThis);</span>
<a href="#l75.819"></a><span id="l75.819" class="difflineminus">-  },</span>
<a href="#l75.820"></a><span id="l75.820" class="difflineminus">-</span>
<a href="#l75.821"></a><span id="l75.821" class="difflineminus">-  _friends: null,</span>
<a href="#l75.822"></a><span id="l75.822" class="difflineminus">-  follow(aUserName) {</span>
<a href="#l75.823"></a><span id="l75.823" class="difflineminus">-    this.signAndSend(&quot;1.1/friendships/create.json&quot;, null, [</span>
<a href="#l75.824"></a><span id="l75.824" class="difflineminus">-      [&quot;screen_name&quot;, aUserName],</span>
<a href="#l75.825"></a><span id="l75.825" class="difflineminus">-    ]);</span>
<a href="#l75.826"></a><span id="l75.826" class="difflineminus">-  },</span>
<a href="#l75.827"></a><span id="l75.827" class="difflineminus">-  stopFollowing(aUserName) {</span>
<a href="#l75.828"></a><span id="l75.828" class="difflineminus">-    // friendships/destroy will return the user in case of success.</span>
<a href="#l75.829"></a><span id="l75.829" class="difflineminus">-    // Error cases would return a non 200 HTTP code and not call our callback.</span>
<a href="#l75.830"></a><span id="l75.830" class="difflineminus">-    this.signAndSend(</span>
<a href="#l75.831"></a><span id="l75.831" class="difflineminus">-      &quot;1.1/friendships/destroy.json&quot;,</span>
<a href="#l75.832"></a><span id="l75.832" class="difflineminus">-      null,</span>
<a href="#l75.833"></a><span id="l75.833" class="difflineminus">-      [[&quot;screen_name&quot;, aUserName]],</span>
<a href="#l75.834"></a><span id="l75.834" class="difflineminus">-      function(aData, aXHR) {</span>
<a href="#l75.835"></a><span id="l75.835" class="difflineminus">-        let user = JSON.parse(aData);</span>
<a href="#l75.836"></a><span id="l75.836" class="difflineminus">-        if (!(&quot;id_str&quot; in user)) {</span>
<a href="#l75.837"></a><span id="l75.837" class="difflineminus">-          // Unexpected response...</span>
<a href="#l75.838"></a><span id="l75.838" class="difflineminus">-          return;</span>
<a href="#l75.839"></a><span id="l75.839" class="difflineminus">-        }</span>
<a href="#l75.840"></a><span id="l75.840" class="difflineminus">-        this._friends.delete(user.id_str);</span>
<a href="#l75.841"></a><span id="l75.841" class="difflineminus">-        this.timeline.removeParticipant(user.screen_name);</span>
<a href="#l75.842"></a><span id="l75.842" class="difflineminus">-        let date = aXHR.getResponseHeader(&quot;Date&quot;);</span>
<a href="#l75.843"></a><span id="l75.843" class="difflineminus">-        this.timeline.systemMessage(</span>
<a href="#l75.844"></a><span id="l75.844" class="difflineminus">-          _(&quot;event.unfollow&quot;, user.screen_name),</span>
<a href="#l75.845"></a><span id="l75.845" class="difflineminus">-          false,</span>
<a href="#l75.846"></a><span id="l75.846" class="difflineminus">-          new Date(date) / 1000</span>
<a href="#l75.847"></a><span id="l75.847" class="difflineminus">-        );</span>
<a href="#l75.848"></a><span id="l75.848" class="difflineminus">-      },</span>
<a href="#l75.849"></a><span id="l75.849" class="difflineminus">-      null,</span>
<a href="#l75.850"></a><span id="l75.850" class="difflineminus">-      this</span>
<a href="#l75.851"></a><span id="l75.851" class="difflineminus">-    );</span>
<a href="#l75.852"></a><span id="l75.852" class="difflineminus">-  },</span>
<a href="#l75.853"></a><span id="l75.853" class="difflineminus">-  addBuddy(aTag, aName) {</span>
<a href="#l75.854"></a><span id="l75.854" class="difflineminus">-    this.follow(aName);</span>
<a href="#l75.855"></a><span id="l75.855" class="difflineminus">-  },</span>
<a href="#l75.856"></a><span id="l75.856" class="difflineminus">-</span>
<a href="#l75.857"></a><span id="l75.857" class="difflineminus">-  getTimelines() {</span>
<a href="#l75.858"></a><span id="l75.858" class="difflineminus">-    this.reportConnecting(_(&quot;connection.requestTimelines&quot;));</span>
<a href="#l75.859"></a><span id="l75.859" class="difflineminus">-</span>
<a href="#l75.860"></a><span id="l75.860" class="difflineminus">-    // If we have a last known message ID, append it as a get parameter.</span>
<a href="#l75.861"></a><span id="l75.861" class="difflineminus">-    let lastMsgParam = &quot;&quot;;</span>
<a href="#l75.862"></a><span id="l75.862" class="difflineminus">-    if (this.prefs.prefHasUserValue(&quot;lastMessageId&quot;)) {</span>
<a href="#l75.863"></a><span id="l75.863" class="difflineminus">-      let lastMsgId = this.prefs.getCharPref(&quot;lastMessageId&quot;);</span>
<a href="#l75.864"></a><span id="l75.864" class="difflineminus">-      // Check that the ID is made up of all digits, otherwise the server will</span>
<a href="#l75.865"></a><span id="l75.865" class="difflineminus">-      // croak on our request.</span>
<a href="#l75.866"></a><span id="l75.866" class="difflineminus">-      if (/^\d+$/.test(lastMsgId)) {</span>
<a href="#l75.867"></a><span id="l75.867" class="difflineminus">-        lastMsgParam = &quot;&amp;since_id=&quot; + lastMsgId;</span>
<a href="#l75.868"></a><span id="l75.868" class="difflineminus">-        this._lastMsgId = lastMsgId;</span>
<a href="#l75.869"></a><span id="l75.869" class="difflineminus">-      } else {</span>
<a href="#l75.870"></a><span id="l75.870" class="difflineminus">-        this.WARN(</span>
<a href="#l75.871"></a><span id="l75.871" class="difflineminus">-          &quot;invalid value for the lastMessageId preference: &quot; + lastMsgId</span>
<a href="#l75.872"></a><span id="l75.872" class="difflineminus">-        );</span>
<a href="#l75.873"></a><span id="l75.873" class="difflineminus">-      }</span>
<a href="#l75.874"></a><span id="l75.874" class="difflineminus">-    }</span>
<a href="#l75.875"></a><span id="l75.875" class="difflineminus">-    let getParams = &quot;?count=200&quot; + lastMsgParam;</span>
<a href="#l75.876"></a><span id="l75.876" class="difflineminus">-    this._pendingRequests = [</span>
<a href="#l75.877"></a><span id="l75.877" class="difflineminus">-      this.signAndSend(</span>
<a href="#l75.878"></a><span id="l75.878" class="difflineminus">-        &quot;1.1/statuses/home_timeline.json&quot; + getParams,</span>
<a href="#l75.879"></a><span id="l75.879" class="difflineminus">-        null,</span>
<a href="#l75.880"></a><span id="l75.880" class="difflineminus">-        null,</span>
<a href="#l75.881"></a><span id="l75.881" class="difflineminus">-        this.onTimelineReceived,</span>
<a href="#l75.882"></a><span id="l75.882" class="difflineminus">-        this.onTimelineError,</span>
<a href="#l75.883"></a><span id="l75.883" class="difflineminus">-        this</span>
<a href="#l75.884"></a><span id="l75.884" class="difflineminus">-      ),</span>
<a href="#l75.885"></a><span id="l75.885" class="difflineminus">-      this.signAndSend(</span>
<a href="#l75.886"></a><span id="l75.886" class="difflineminus">-        &quot;1.1/statuses/mentions_timeline.json&quot; + getParams,</span>
<a href="#l75.887"></a><span id="l75.887" class="difflineminus">-        null,</span>
<a href="#l75.888"></a><span id="l75.888" class="difflineminus">-        null,</span>
<a href="#l75.889"></a><span id="l75.889" class="difflineminus">-        this.onTimelineReceived,</span>
<a href="#l75.890"></a><span id="l75.890" class="difflineminus">-        this.onTimelineError,</span>
<a href="#l75.891"></a><span id="l75.891" class="difflineminus">-        this</span>
<a href="#l75.892"></a><span id="l75.892" class="difflineminus">-      ),</span>
<a href="#l75.893"></a><span id="l75.893" class="difflineminus">-    ];</span>
<a href="#l75.894"></a><span id="l75.894" class="difflineminus">-</span>
<a href="#l75.895"></a><span id="l75.895" class="difflineminus">-    let track = this.getString(&quot;track&quot;);</span>
<a href="#l75.896"></a><span id="l75.896" class="difflineminus">-    if (track) {</span>
<a href="#l75.897"></a><span id="l75.897" class="difflineminus">-      let trackQuery = track</span>
<a href="#l75.898"></a><span id="l75.898" class="difflineminus">-        .split(&quot;,&quot;)</span>
<a href="#l75.899"></a><span id="l75.899" class="difflineminus">-        .map(encodeURIComponent)</span>
<a href="#l75.900"></a><span id="l75.900" class="difflineminus">-        .join(&quot; OR &quot;);</span>
<a href="#l75.901"></a><span id="l75.901" class="difflineminus">-      getParams = &quot;?q=&quot; + trackQuery + lastMsgParam + &quot;&amp;count=100&quot;;</span>
<a href="#l75.902"></a><span id="l75.902" class="difflineminus">-      let url = &quot;1.1/search/tweets.json&quot; + getParams;</span>
<a href="#l75.903"></a><span id="l75.903" class="difflineminus">-      this._pendingRequests.push(</span>
<a href="#l75.904"></a><span id="l75.904" class="difflineminus">-        this.signAndSend(</span>
<a href="#l75.905"></a><span id="l75.905" class="difflineminus">-          url,</span>
<a href="#l75.906"></a><span id="l75.906" class="difflineminus">-          null,</span>
<a href="#l75.907"></a><span id="l75.907" class="difflineminus">-          null,</span>
<a href="#l75.908"></a><span id="l75.908" class="difflineminus">-          this.onTimelineReceived,</span>
<a href="#l75.909"></a><span id="l75.909" class="difflineminus">-          this.onTimelineError,</span>
<a href="#l75.910"></a><span id="l75.910" class="difflineminus">-          this,</span>
<a href="#l75.911"></a><span id="l75.911" class="difflineminus">-          null</span>
<a href="#l75.912"></a><span id="l75.912" class="difflineminus">-        )</span>
<a href="#l75.913"></a><span id="l75.913" class="difflineminus">-      );</span>
<a href="#l75.914"></a><span id="l75.914" class="difflineminus">-    }</span>
<a href="#l75.915"></a><span id="l75.915" class="difflineminus">-  },</span>
<a href="#l75.916"></a><span id="l75.916" class="difflineminus">-</span>
<a href="#l75.917"></a><span id="l75.917" class="difflineminus">-  get timeline() {</span>
<a href="#l75.918"></a><span id="l75.918" class="difflineminus">-    return this._timeline || (this._timeline = new TimelineConversation(this));</span>
<a href="#l75.919"></a><span id="l75.919" class="difflineminus">-  },</span>
<a href="#l75.920"></a><span id="l75.920" class="difflineminus">-</span>
<a href="#l75.921"></a><span id="l75.921" class="difflineminus">-  onTimelineError(aError, aResponseText, aRequest) {</span>
<a href="#l75.922"></a><span id="l75.922" class="difflineminus">-    this.ERROR(aError);</span>
<a href="#l75.923"></a><span id="l75.923" class="difflineminus">-    if (aRequest.status == 401) {</span>
<a href="#l75.924"></a><span id="l75.924" class="difflineminus">-      ++this._timelineAuthError;</span>
<a href="#l75.925"></a><span id="l75.925" class="difflineminus">-    }</span>
<a href="#l75.926"></a><span id="l75.926" class="difflineminus">-    this._doneWithTimelineRequest(aRequest);</span>
<a href="#l75.927"></a><span id="l75.927" class="difflineminus">-  },</span>
<a href="#l75.928"></a><span id="l75.928" class="difflineminus">-</span>
<a href="#l75.929"></a><span id="l75.929" class="difflineminus">-  onTimelineReceived(aData, aRequest) {</span>
<a href="#l75.930"></a><span id="l75.930" class="difflineminus">-    this._timelineBuffer = this._timelineBuffer.concat(JSON.parse(aData));</span>
<a href="#l75.931"></a><span id="l75.931" class="difflineminus">-    this._doneWithTimelineRequest(aRequest);</span>
<a href="#l75.932"></a><span id="l75.932" class="difflineminus">-  },</span>
<a href="#l75.933"></a><span id="l75.933" class="difflineminus">-</span>
<a href="#l75.934"></a><span id="l75.934" class="difflineminus">-  _doneWithTimelineRequest(aRequest) {</span>
<a href="#l75.935"></a><span id="l75.935" class="difflineminus">-    this._pendingRequests = this._pendingRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l75.936"></a><span id="l75.936" class="difflineminus">-</span>
<a href="#l75.937"></a><span id="l75.937" class="difflineminus">-    // If we are still waiting for more data, return early</span>
<a href="#l75.938"></a><span id="l75.938" class="difflineminus">-    if (this._pendingRequests.length != 0) {</span>
<a href="#l75.939"></a><span id="l75.939" class="difflineminus">-      return;</span>
<a href="#l75.940"></a><span id="l75.940" class="difflineminus">-    }</span>
<a href="#l75.941"></a><span id="l75.941" class="difflineminus">-</span>
<a href="#l75.942"></a><span id="l75.942" class="difflineminus">-    if (this._timelineAuthError &gt;= 2) {</span>
<a href="#l75.943"></a><span id="l75.943" class="difflineminus">-      // 2 out of the 3 timeline requests are authenticated.</span>
<a href="#l75.944"></a><span id="l75.944" class="difflineminus">-      // With at least 2 '401 - Unauthorized' errors, we are sure</span>
<a href="#l75.945"></a><span id="l75.945" class="difflineminus">-      // that our OAuth token is consistently rejected.</span>
<a href="#l75.946"></a><span id="l75.946" class="difflineminus">-      delete this._timelineAuthError;</span>
<a href="#l75.947"></a><span id="l75.947" class="difflineminus">-      delete this._timelineBuffer;</span>
<a href="#l75.948"></a><span id="l75.948" class="difflineminus">-      delete this._pendingRequests;</span>
<a href="#l75.949"></a><span id="l75.949" class="difflineminus">-      delete this.token;</span>
<a href="#l75.950"></a><span id="l75.950" class="difflineminus">-      delete this.tokenSecret;</span>
<a href="#l75.951"></a><span id="l75.951" class="difflineminus">-      this.requestToken();</span>
<a href="#l75.952"></a><span id="l75.952" class="difflineminus">-      return;</span>
<a href="#l75.953"></a><span id="l75.953" class="difflineminus">-    }</span>
<a href="#l75.954"></a><span id="l75.954" class="difflineminus">-</span>
<a href="#l75.955"></a><span id="l75.955" class="difflineminus">-    // Less than 2 auth errors is probably just some flakiness of the</span>
<a href="#l75.956"></a><span id="l75.956" class="difflineminus">-    // twitter servers, ignore and reset this._timelineAuthError.</span>
<a href="#l75.957"></a><span id="l75.957" class="difflineminus">-    if (this._timelineAuthError) {</span>
<a href="#l75.958"></a><span id="l75.958" class="difflineminus">-      delete this._timelineAuthError;</span>
<a href="#l75.959"></a><span id="l75.959" class="difflineminus">-    }</span>
<a href="#l75.960"></a><span id="l75.960" class="difflineminus">-</span>
<a href="#l75.961"></a><span id="l75.961" class="difflineminus">-    this.reportConnected();</span>
<a href="#l75.962"></a><span id="l75.962" class="difflineminus">-</span>
<a href="#l75.963"></a><span id="l75.963" class="difflineminus">-    // If the conversation already exists, notify it we are back online.</span>
<a href="#l75.964"></a><span id="l75.964" class="difflineminus">-    if (this._timeline) {</span>
<a href="#l75.965"></a><span id="l75.965" class="difflineminus">-      this._timeline.notifyObservers(this._timeline, &quot;update-buddy-status&quot;);</span>
<a href="#l75.966"></a><span id="l75.966" class="difflineminus">-    }</span>
<a href="#l75.967"></a><span id="l75.967" class="difflineminus">-</span>
<a href="#l75.968"></a><span id="l75.968" class="difflineminus">-    this._timelineBuffer.sort(this.sortByDate);</span>
<a href="#l75.969"></a><span id="l75.969" class="difflineminus">-    this._timelineBuffer.forEach(aTweet =&gt; (aTweet.delayed = true));</span>
<a href="#l75.970"></a><span id="l75.970" class="difflineminus">-    this.timeline.displayMessages(this._timelineBuffer);</span>
<a href="#l75.971"></a><span id="l75.971" class="difflineminus">-</span>
<a href="#l75.972"></a><span id="l75.972" class="difflineminus">-    // Fetch userInfo for the user if we don't already have it.</span>
<a href="#l75.973"></a><span id="l75.973" class="difflineminus">-    this.requestBuddyInfo(this.name);</span>
<a href="#l75.974"></a><span id="l75.974" class="difflineminus">-</span>
<a href="#l75.975"></a><span id="l75.975" class="difflineminus">-    // Reset in case we get disconnected</span>
<a href="#l75.976"></a><span id="l75.976" class="difflineminus">-    delete this._timelineBuffer;</span>
<a href="#l75.977"></a><span id="l75.977" class="difflineminus">-    delete this._pendingRequests;</span>
<a href="#l75.978"></a><span id="l75.978" class="difflineminus">-</span>
<a href="#l75.979"></a><span id="l75.979" class="difflineminus">-    // Open the streams to get the live data.</span>
<a href="#l75.980"></a><span id="l75.980" class="difflineminus">-    this.openStream();</span>
<a href="#l75.981"></a><span id="l75.981" class="difflineminus">-  },</span>
<a href="#l75.982"></a><span id="l75.982" class="difflineminus">-</span>
<a href="#l75.983"></a><span id="l75.983" class="difflineminus">-  sortByDate: (a, b) =&gt; new Date(a.created_at) - new Date(b.created_at),</span>
<a href="#l75.984"></a><span id="l75.984" class="difflineminus">-</span>
<a href="#l75.985"></a><span id="l75.985" class="difflineminus">-  _streamingRequest: null,</span>
<a href="#l75.986"></a><span id="l75.986" class="difflineminus">-  _pendingData: &quot;&quot;,</span>
<a href="#l75.987"></a><span id="l75.987" class="difflineminus">-  openStream() {</span>
<a href="#l75.988"></a><span id="l75.988" class="difflineminus">-    let track = this.getString(&quot;track&quot;);</span>
<a href="#l75.989"></a><span id="l75.989" class="difflineminus">-    this._streamingRequest = this.signAndSend(</span>
<a href="#l75.990"></a><span id="l75.990" class="difflineminus">-      &quot;https://userstream.twitter.com/1.1/user.json&quot;,</span>
<a href="#l75.991"></a><span id="l75.991" class="difflineminus">-      null,</span>
<a href="#l75.992"></a><span id="l75.992" class="difflineminus">-      track ? [[&quot;track&quot;, track]] : [],</span>
<a href="#l75.993"></a><span id="l75.993" class="difflineminus">-      this.openStream,</span>
<a href="#l75.994"></a><span id="l75.994" class="difflineminus">-      this.onStreamError,</span>
<a href="#l75.995"></a><span id="l75.995" class="difflineminus">-      this</span>
<a href="#l75.996"></a><span id="l75.996" class="difflineminus">-    );</span>
<a href="#l75.997"></a><span id="l75.997" class="difflineminus">-    this._streamingRequest.responseType = &quot;moz-chunked-text&quot;;</span>
<a href="#l75.998"></a><span id="l75.998" class="difflineminus">-    this._streamingRequest.onprogress = this.onDataAvailable.bind(this);</span>
<a href="#l75.999"></a><span id="l75.999" class="difflineminus">-    this.resetStreamTimeout();</span>
<a href="#l75.1000"></a><span id="l75.1000" class="difflineminus">-    this.prefs.addObserver(&quot;track&quot;, this);</span>
<a href="#l75.1001"></a><span id="l75.1001" class="difflineminus">-  },</span>
<a href="#l75.1002"></a><span id="l75.1002" class="difflineminus">-  _streamTimeout: null,</span>
<a href="#l75.1003"></a><span id="l75.1003" class="difflineminus">-  resetStreamTimeout() {</span>
<a href="#l75.1004"></a><span id="l75.1004" class="difflineminus">-    if (this._streamTimeout) {</span>
<a href="#l75.1005"></a><span id="l75.1005" class="difflineminus">-      clearTimeout(this._streamTimeout);</span>
<a href="#l75.1006"></a><span id="l75.1006" class="difflineminus">-    }</span>
<a href="#l75.1007"></a><span id="l75.1007" class="difflineminus">-    // The twitter Streaming API sends a keep-alive newline every 30 seconds</span>
<a href="#l75.1008"></a><span id="l75.1008" class="difflineminus">-    // so if we haven't received anything for 90s, we should disconnect and try</span>
<a href="#l75.1009"></a><span id="l75.1009" class="difflineminus">-    // to reconnect.</span>
<a href="#l75.1010"></a><span id="l75.1010" class="difflineminus">-    this._streamTimeout = setTimeout(this.onStreamTimeout.bind(this), 90000);</span>
<a href="#l75.1011"></a><span id="l75.1011" class="difflineminus">-  },</span>
<a href="#l75.1012"></a><span id="l75.1012" class="difflineminus">-  onStreamError(aError) {</span>
<a href="#l75.1013"></a><span id="l75.1013" class="difflineminus">-    delete this._streamingRequest;</span>
<a href="#l75.1014"></a><span id="l75.1014" class="difflineminus">-    // _streamTimeout is cleared by cleanUp called by gotDisconnected.</span>
<a href="#l75.1015"></a><span id="l75.1015" class="difflineminus">-    this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, aError);</span>
<a href="#l75.1016"></a><span id="l75.1016" class="difflineminus">-  },</span>
<a href="#l75.1017"></a><span id="l75.1017" class="difflineminus">-  onStreamTimeout() {</span>
<a href="#l75.1018"></a><span id="l75.1018" class="difflineminus">-    this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, &quot;timeout&quot;);</span>
<a href="#l75.1019"></a><span id="l75.1019" class="difflineminus">-  },</span>
<a href="#l75.1020"></a><span id="l75.1020" class="difflineminus">-  onDataAvailable(aRequest) {</span>
<a href="#l75.1021"></a><span id="l75.1021" class="difflineminus">-    this.resetStreamTimeout();</span>
<a href="#l75.1022"></a><span id="l75.1022" class="difflineminus">-    let newText = this._pendingData + aRequest.target.response;</span>
<a href="#l75.1023"></a><span id="l75.1023" class="difflineminus">-    if (newText.trim()) {</span>
<a href="#l75.1024"></a><span id="l75.1024" class="difflineminus">-      this.DEBUG(&quot;Received data: &quot; + newText);</span>
<a href="#l75.1025"></a><span id="l75.1025" class="difflineminus">-    } else {</span>
<a href="#l75.1026"></a><span id="l75.1026" class="difflineminus">-      this.DEBUG(&quot;Received ping&quot;);</span>
<a href="#l75.1027"></a><span id="l75.1027" class="difflineminus">-    }</span>
<a href="#l75.1028"></a><span id="l75.1028" class="difflineminus">-    let messages = newText.split(/\r\n?/);</span>
<a href="#l75.1029"></a><span id="l75.1029" class="difflineminus">-    this._pendingData = messages.pop();</span>
<a href="#l75.1030"></a><span id="l75.1030" class="difflineminus">-    for (let message of messages) {</span>
<a href="#l75.1031"></a><span id="l75.1031" class="difflineminus">-      if (!message.trim()) {</span>
<a href="#l75.1032"></a><span id="l75.1032" class="difflineminus">-        continue;</span>
<a href="#l75.1033"></a><span id="l75.1033" class="difflineminus">-      }</span>
<a href="#l75.1034"></a><span id="l75.1034" class="difflineminus">-      let msg;</span>
<a href="#l75.1035"></a><span id="l75.1035" class="difflineminus">-      try {</span>
<a href="#l75.1036"></a><span id="l75.1036" class="difflineminus">-        msg = JSON.parse(message);</span>
<a href="#l75.1037"></a><span id="l75.1037" class="difflineminus">-      } catch (e) {</span>
<a href="#l75.1038"></a><span id="l75.1038" class="difflineminus">-        this.ERROR(e + &quot; while parsing &quot; + message);</span>
<a href="#l75.1039"></a><span id="l75.1039" class="difflineminus">-        continue;</span>
<a href="#l75.1040"></a><span id="l75.1040" class="difflineminus">-      }</span>
<a href="#l75.1041"></a><span id="l75.1041" class="difflineminus">-      if (&quot;direct_message&quot; in msg) {</span>
<a href="#l75.1042"></a><span id="l75.1042" class="difflineminus">-        let dm = msg.direct_message;</span>
<a href="#l75.1043"></a><span id="l75.1043" class="difflineminus">-        if (dm.sender_screen_name !== this.name) {</span>
<a href="#l75.1044"></a><span id="l75.1044" class="difflineminus">-          // These are displayed on send.</span>
<a href="#l75.1045"></a><span id="l75.1045" class="difflineminus">-          this.getConversation(dm.sender_screen_name).displayMessages([dm]);</span>
<a href="#l75.1046"></a><span id="l75.1046" class="difflineminus">-        }</span>
<a href="#l75.1047"></a><span id="l75.1047" class="difflineminus">-      } else if (&quot;text&quot; in msg) {</span>
<a href="#l75.1048"></a><span id="l75.1048" class="difflineminus">-        this.timeline.displayMessages([msg]);</span>
<a href="#l75.1049"></a><span id="l75.1049" class="difflineminus">-      } else if (&quot;friends&quot; in msg) {</span>
<a href="#l75.1050"></a><span id="l75.1050" class="difflineminus">-        // Filter out the IDs that info has already been received from (e.g. a</span>
<a href="#l75.1051"></a><span id="l75.1051" class="difflineminus">-        // tweet has been received as part of the timeline request).</span>
<a href="#l75.1052"></a><span id="l75.1052" class="difflineminus">-        let userInfoIds = new Set();</span>
<a href="#l75.1053"></a><span id="l75.1053" class="difflineminus">-        for (let userInfo of this._userInfo.values()) {</span>
<a href="#l75.1054"></a><span id="l75.1054" class="difflineminus">-          userInfoIds.add(userInfo.id_str);</span>
<a href="#l75.1055"></a><span id="l75.1055" class="difflineminus">-        }</span>
<a href="#l75.1056"></a><span id="l75.1056" class="difflineminus">-        let ids = msg.friends.filter(aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l75.1057"></a><span id="l75.1057" class="difflineminus">-</span>
<a href="#l75.1058"></a><span id="l75.1058" class="difflineminus">-        while (ids.length) {</span>
<a href="#l75.1059"></a><span id="l75.1059" class="difflineminus">-          // Take the first 100 elements, turn them into a comma separated list.</span>
<a href="#l75.1060"></a><span id="l75.1060" class="difflineminus">-          this.signAndSend(</span>
<a href="#l75.1061"></a><span id="l75.1061" class="difflineminus">-            &quot;1.1/users/lookup.json&quot;,</span>
<a href="#l75.1062"></a><span id="l75.1062" class="difflineminus">-            null,</span>
<a href="#l75.1063"></a><span id="l75.1063" class="difflineminus">-            [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l75.1064"></a><span id="l75.1064" class="difflineminus">-            this.onLookupReceived,</span>
<a href="#l75.1065"></a><span id="l75.1065" class="difflineminus">-            null,</span>
<a href="#l75.1066"></a><span id="l75.1066" class="difflineminus">-            this</span>
<a href="#l75.1067"></a><span id="l75.1067" class="difflineminus">-          );</span>
<a href="#l75.1068"></a><span id="l75.1068" class="difflineminus">-          // Remove the first 100 elements.</span>
<a href="#l75.1069"></a><span id="l75.1069" class="difflineminus">-          ids = ids.slice(100);</span>
<a href="#l75.1070"></a><span id="l75.1070" class="difflineminus">-        }</span>
<a href="#l75.1071"></a><span id="l75.1071" class="difflineminus">-</span>
<a href="#l75.1072"></a><span id="l75.1072" class="difflineminus">-        // Overwrite the existing _friends list (if any).</span>
<a href="#l75.1073"></a><span id="l75.1073" class="difflineminus">-        this._friends = new Set(msg.friends.map(aId =&gt; aId.toString()));</span>
<a href="#l75.1074"></a><span id="l75.1074" class="difflineminus">-      } else if (&quot;event&quot; in msg) {</span>
<a href="#l75.1075"></a><span id="l75.1075" class="difflineminus">-        let user, event;</span>
<a href="#l75.1076"></a><span id="l75.1076" class="difflineminus">-        switch (msg.event) {</span>
<a href="#l75.1077"></a><span id="l75.1077" class="difflineminus">-          case &quot;follow&quot;:</span>
<a href="#l75.1078"></a><span id="l75.1078" class="difflineminus">-            if (msg.source.screen_name == this.name) {</span>
<a href="#l75.1079"></a><span id="l75.1079" class="difflineminus">-              user = msg.target;</span>
<a href="#l75.1080"></a><span id="l75.1080" class="difflineminus">-              event = &quot;follow&quot;;</span>
<a href="#l75.1081"></a><span id="l75.1081" class="difflineminus">-              this.setUserInfo(user);</span>
<a href="#l75.1082"></a><span id="l75.1082" class="difflineminus">-              this._friends.add(user.id_str);</span>
<a href="#l75.1083"></a><span id="l75.1083" class="difflineminus">-              this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l75.1084"></a><span id="l75.1084" class="difflineminus">-            } else if (msg.target.screen_name == this.name) {</span>
<a href="#l75.1085"></a><span id="l75.1085" class="difflineminus">-              user = msg.source;</span>
<a href="#l75.1086"></a><span id="l75.1086" class="difflineminus">-              event = &quot;followed&quot;;</span>
<a href="#l75.1087"></a><span id="l75.1087" class="difflineminus">-            }</span>
<a href="#l75.1088"></a><span id="l75.1088" class="difflineminus">-            if (user) {</span>
<a href="#l75.1089"></a><span id="l75.1089" class="difflineminus">-              this.setUserInfo(user);</span>
<a href="#l75.1090"></a><span id="l75.1090" class="difflineminus">-              this.timeline.systemMessage(</span>
<a href="#l75.1091"></a><span id="l75.1091" class="difflineminus">-                _(&quot;event.&quot; + event, user.screen_name),</span>
<a href="#l75.1092"></a><span id="l75.1092" class="difflineminus">-                false,</span>
<a href="#l75.1093"></a><span id="l75.1093" class="difflineminus">-                new Date(msg.created_at) / 1000</span>
<a href="#l75.1094"></a><span id="l75.1094" class="difflineminus">-              );</span>
<a href="#l75.1095"></a><span id="l75.1095" class="difflineminus">-            }</span>
<a href="#l75.1096"></a><span id="l75.1096" class="difflineminus">-            break;</span>
<a href="#l75.1097"></a><span id="l75.1097" class="difflineminus">-          case &quot;user_update&quot;:</span>
<a href="#l75.1098"></a><span id="l75.1098" class="difflineminus">-            this.setUserInfo(msg.target);</span>
<a href="#l75.1099"></a><span id="l75.1099" class="difflineminus">-            break;</span>
<a href="#l75.1100"></a><span id="l75.1100" class="difflineminus">-        }</span>
<a href="#l75.1101"></a><span id="l75.1101" class="difflineminus">-      }</span>
<a href="#l75.1102"></a><span id="l75.1102" class="difflineminus">-    }</span>
<a href="#l75.1103"></a><span id="l75.1103" class="difflineminus">-  },</span>
<a href="#l75.1104"></a><span id="l75.1104" class="difflineminus">-</span>
<a href="#l75.1105"></a><span id="l75.1105" class="difflineminus">-  requestToken() {</span>
<a href="#l75.1106"></a><span id="l75.1106" class="difflineminus">-    this.reportConnecting(_(&quot;connection.initAuth&quot;));</span>
<a href="#l75.1107"></a><span id="l75.1107" class="difflineminus">-    let oauthParams = [</span>
<a href="#l75.1108"></a><span id="l75.1108" class="difflineminus">-      [&quot;oauth_callback&quot;, encodeURIComponent(this.completionURI)],</span>
<a href="#l75.1109"></a><span id="l75.1109" class="difflineminus">-    ];</span>
<a href="#l75.1110"></a><span id="l75.1110" class="difflineminus">-    this.signAndSend(</span>
<a href="#l75.1111"></a><span id="l75.1111" class="difflineminus">-      &quot;oauth/request_token&quot;,</span>
<a href="#l75.1112"></a><span id="l75.1112" class="difflineminus">-      null,</span>
<a href="#l75.1113"></a><span id="l75.1113" class="difflineminus">-      [],</span>
<a href="#l75.1114"></a><span id="l75.1114" class="difflineminus">-      this.onRequestTokenReceived,</span>
<a href="#l75.1115"></a><span id="l75.1115" class="difflineminus">-      this.onError,</span>
<a href="#l75.1116"></a><span id="l75.1116" class="difflineminus">-      this,</span>
<a href="#l75.1117"></a><span id="l75.1117" class="difflineminus">-      oauthParams</span>
<a href="#l75.1118"></a><span id="l75.1118" class="difflineminus">-    );</span>
<a href="#l75.1119"></a><span id="l75.1119" class="difflineminus">-  },</span>
<a href="#l75.1120"></a><span id="l75.1120" class="difflineminus">-  onRequestTokenReceived(aData) {</span>
<a href="#l75.1121"></a><span id="l75.1121" class="difflineminus">-    this.LOG(&quot;Received request token.&quot;);</span>
<a href="#l75.1122"></a><span id="l75.1122" class="difflineminus">-    let data = this._parseURLData(aData);</span>
<a href="#l75.1123"></a><span id="l75.1123" class="difflineminus">-    if (</span>
<a href="#l75.1124"></a><span id="l75.1124" class="difflineminus">-      !data.oauth_callback_confirmed ||</span>
<a href="#l75.1125"></a><span id="l75.1125" class="difflineminus">-      !data.oauth_token ||</span>
<a href="#l75.1126"></a><span id="l75.1126" class="difflineminus">-      !data.oauth_token_secret</span>
<a href="#l75.1127"></a><span id="l75.1127" class="difflineminus">-    ) {</span>
<a href="#l75.1128"></a><span id="l75.1128" class="difflineminus">-      this.gotDisconnected(</span>
<a href="#l75.1129"></a><span id="l75.1129" class="difflineminus">-        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l75.1130"></a><span id="l75.1130" class="difflineminus">-        _(&quot;connection.failedToken&quot;)</span>
<a href="#l75.1131"></a><span id="l75.1131" class="difflineminus">-      );</span>
<a href="#l75.1132"></a><span id="l75.1132" class="difflineminus">-      return;</span>
<a href="#l75.1133"></a><span id="l75.1133" class="difflineminus">-    }</span>
<a href="#l75.1134"></a><span id="l75.1134" class="difflineminus">-    this.token = data.oauth_token;</span>
<a href="#l75.1135"></a><span id="l75.1135" class="difflineminus">-    this.tokenSecret = data.oauth_token_secret;</span>
<a href="#l75.1136"></a><span id="l75.1136" class="difflineminus">-</span>
<a href="#l75.1137"></a><span id="l75.1137" class="difflineminus">-    this.requestAuthorization();</span>
<a href="#l75.1138"></a><span id="l75.1138" class="difflineminus">-  },</span>
<a href="#l75.1139"></a><span id="l75.1139" class="difflineminus">-  requestAuthorization() {</span>
<a href="#l75.1140"></a><span id="l75.1140" class="difflineminus">-    this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l75.1141"></a><span id="l75.1141" class="difflineminus">-    let url =</span>
<a href="#l75.1142"></a><span id="l75.1142" class="difflineminus">-      this.baseURI +</span>
<a href="#l75.1143"></a><span id="l75.1143" class="difflineminus">-      &quot;oauth/authorize?&quot; +</span>
<a href="#l75.1144"></a><span id="l75.1144" class="difflineminus">-      &quot;force_login=true&amp;&quot; + // ignore cookies</span>
<a href="#l75.1145"></a><span id="l75.1145" class="difflineminus">-      &quot;screen_name=&quot; +</span>
<a href="#l75.1146"></a><span id="l75.1146" class="difflineminus">-      this.name +</span>
<a href="#l75.1147"></a><span id="l75.1147" class="difflineminus">-      &quot;&amp;&quot; + // prefill the user name input box</span>
<a href="#l75.1148"></a><span id="l75.1148" class="difflineminus">-      &quot;oauth_token=&quot; +</span>
<a href="#l75.1149"></a><span id="l75.1149" class="difflineminus">-      this.token;</span>
<a href="#l75.1150"></a><span id="l75.1150" class="difflineminus">-    this._browserRequest = {</span>
<a href="#l75.1151"></a><span id="l75.1151" class="difflineminus">-      get promptText() {</span>
<a href="#l75.1152"></a><span id="l75.1152" class="difflineminus">-        return _(&quot;authPrompt&quot;);</span>
<a href="#l75.1153"></a><span id="l75.1153" class="difflineminus">-      },</span>
<a href="#l75.1154"></a><span id="l75.1154" class="difflineminus">-      account: this,</span>
<a href="#l75.1155"></a><span id="l75.1155" class="difflineminus">-      url,</span>
<a href="#l75.1156"></a><span id="l75.1156" class="difflineminus">-      _active: true,</span>
<a href="#l75.1157"></a><span id="l75.1157" class="difflineminus">-      cancelled() {</span>
<a href="#l75.1158"></a><span id="l75.1158" class="difflineminus">-        if (!this._active) {</span>
<a href="#l75.1159"></a><span id="l75.1159" class="difflineminus">-          return;</span>
<a href="#l75.1160"></a><span id="l75.1160" class="difflineminus">-        }</span>
<a href="#l75.1161"></a><span id="l75.1161" class="difflineminus">-</span>
<a href="#l75.1162"></a><span id="l75.1162" class="difflineminus">-        this.account.gotDisconnected(</span>
<a href="#l75.1163"></a><span id="l75.1163" class="difflineminus">-          Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l75.1164"></a><span id="l75.1164" class="difflineminus">-          _(&quot;connection.error.authCancelled&quot;)</span>
<a href="#l75.1165"></a><span id="l75.1165" class="difflineminus">-        );</span>
<a href="#l75.1166"></a><span id="l75.1166" class="difflineminus">-      },</span>
<a href="#l75.1167"></a><span id="l75.1167" class="difflineminus">-      loaded(aWindow, aWebProgress) {</span>
<a href="#l75.1168"></a><span id="l75.1168" class="difflineminus">-        if (!this._active) {</span>
<a href="#l75.1169"></a><span id="l75.1169" class="difflineminus">-          return;</span>
<a href="#l75.1170"></a><span id="l75.1170" class="difflineminus">-        }</span>
<a href="#l75.1171"></a><span id="l75.1171" class="difflineminus">-</span>
<a href="#l75.1172"></a><span id="l75.1172" class="difflineminus">-        this._listener = {</span>
<a href="#l75.1173"></a><span id="l75.1173" class="difflineminus">-          QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l75.1174"></a><span id="l75.1174" class="difflineminus">-            Ci.nsIWebProgressListener,</span>
<a href="#l75.1175"></a><span id="l75.1175" class="difflineminus">-            Ci.nsISupportsWeakReference,</span>
<a href="#l75.1176"></a><span id="l75.1176" class="difflineminus">-          ]),</span>
<a href="#l75.1177"></a><span id="l75.1177" class="difflineminus">-          _cleanUp() {</span>
<a href="#l75.1178"></a><span id="l75.1178" class="difflineminus">-            this.webProgress.removeProgressListener(this);</span>
<a href="#l75.1179"></a><span id="l75.1179" class="difflineminus">-            this.window.close();</span>
<a href="#l75.1180"></a><span id="l75.1180" class="difflineminus">-            delete this.window;</span>
<a href="#l75.1181"></a><span id="l75.1181" class="difflineminus">-          },</span>
<a href="#l75.1182"></a><span id="l75.1182" class="difflineminus">-          _checkForRedirect(aURL) {</span>
<a href="#l75.1183"></a><span id="l75.1183" class="difflineminus">-            if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l75.1184"></a><span id="l75.1184" class="difflineminus">-              return;</span>
<a href="#l75.1185"></a><span id="l75.1185" class="difflineminus">-            }</span>
<a href="#l75.1186"></a><span id="l75.1186" class="difflineminus">-</span>
<a href="#l75.1187"></a><span id="l75.1187" class="difflineminus">-            this._parent.finishAuthorizationRequest();</span>
<a href="#l75.1188"></a><span id="l75.1188" class="difflineminus">-            this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l75.1189"></a><span id="l75.1189" class="difflineminus">-          },</span>
<a href="#l75.1190"></a><span id="l75.1190" class="difflineminus">-          onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l75.1191"></a><span id="l75.1191" class="difflineminus">-            const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l75.1192"></a><span id="l75.1192" class="difflineminus">-            if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l75.1193"></a><span id="l75.1193" class="difflineminus">-              this._checkForRedirect(aRequest.name);</span>
<a href="#l75.1194"></a><span id="l75.1194" class="difflineminus">-            }</span>
<a href="#l75.1195"></a><span id="l75.1195" class="difflineminus">-          },</span>
<a href="#l75.1196"></a><span id="l75.1196" class="difflineminus">-          onLocationChange(aWebProgress, aRequest, aLocation) {</span>
<a href="#l75.1197"></a><span id="l75.1197" class="difflineminus">-            this._checkForRedirect(aLocation.spec);</span>
<a href="#l75.1198"></a><span id="l75.1198" class="difflineminus">-          },</span>
<a href="#l75.1199"></a><span id="l75.1199" class="difflineminus">-          onProgressChange() {},</span>
<a href="#l75.1200"></a><span id="l75.1200" class="difflineminus">-          onStatusChange() {},</span>
<a href="#l75.1201"></a><span id="l75.1201" class="difflineminus">-          onSecurityChange() {},</span>
<a href="#l75.1202"></a><span id="l75.1202" class="difflineminus">-</span>
<a href="#l75.1203"></a><span id="l75.1203" class="difflineminus">-          window: aWindow,</span>
<a href="#l75.1204"></a><span id="l75.1204" class="difflineminus">-          webProgress: aWebProgress,</span>
<a href="#l75.1205"></a><span id="l75.1205" class="difflineminus">-          _parent: this.account,</span>
<a href="#l75.1206"></a><span id="l75.1206" class="difflineminus">-        };</span>
<a href="#l75.1207"></a><span id="l75.1207" class="difflineminus">-        aWebProgress.addProgressListener(</span>
<a href="#l75.1208"></a><span id="l75.1208" class="difflineminus">-          this._listener,</span>
<a href="#l75.1209"></a><span id="l75.1209" class="difflineminus">-          Ci.nsIWebProgress.NOTIFY_ALL</span>
<a href="#l75.1210"></a><span id="l75.1210" class="difflineminus">-        );</span>
<a href="#l75.1211"></a><span id="l75.1211" class="difflineminus">-      },</span>
<a href="#l75.1212"></a><span id="l75.1212" class="difflineminus">-      QueryInterface: ChromeUtils.generateQI([Ci.prplIRequestBrowser]),</span>
<a href="#l75.1213"></a><span id="l75.1213" class="difflineminus">-    };</span>
<a href="#l75.1214"></a><span id="l75.1214" class="difflineminus">-    Services.obs.notifyObservers(this._browserRequest, &quot;browser-request&quot;);</span>
<a href="#l75.1215"></a><span id="l75.1215" class="difflineminus">-  },</span>
<a href="#l75.1216"></a><span id="l75.1216" class="difflineminus">-  finishAuthorizationRequest() {</span>
<a href="#l75.1217"></a><span id="l75.1217" class="difflineminus">-    // Clean up the cookies, so that several twitter OAuth dialogs can work</span>
<a href="#l75.1218"></a><span id="l75.1218" class="difflineminus">-    // during the same session (bug 954308).</span>
<a href="#l75.1219"></a><span id="l75.1219" class="difflineminus">-    let cookies = Services.cookies.getCookiesFromHost(&quot;twitter.com&quot;, {});</span>
<a href="#l75.1220"></a><span id="l75.1220" class="difflineminus">-    while (cookies.hasMoreElements()) {</span>
<a href="#l75.1221"></a><span id="l75.1221" class="difflineminus">-      let cookie = cookies.getNext().QueryInterface(Ci.nsICookie);</span>
<a href="#l75.1222"></a><span id="l75.1222" class="difflineminus">-      Services.cookies.remove(</span>
<a href="#l75.1223"></a><span id="l75.1223" class="difflineminus">-        cookie.host,</span>
<a href="#l75.1224"></a><span id="l75.1224" class="difflineminus">-        cookie.name,</span>
<a href="#l75.1225"></a><span id="l75.1225" class="difflineminus">-        cookie.path,</span>
<a href="#l75.1226"></a><span id="l75.1226" class="difflineminus">-        false,</span>
<a href="#l75.1227"></a><span id="l75.1227" class="difflineminus">-        cookie.originAttributes</span>
<a href="#l75.1228"></a><span id="l75.1228" class="difflineminus">-      );</span>
<a href="#l75.1229"></a><span id="l75.1229" class="difflineminus">-    }</span>
<a href="#l75.1230"></a><span id="l75.1230" class="difflineminus">-</span>
<a href="#l75.1231"></a><span id="l75.1231" class="difflineminus">-    if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l75.1232"></a><span id="l75.1232" class="difflineminus">-      return;</span>
<a href="#l75.1233"></a><span id="l75.1233" class="difflineminus">-    }</span>
<a href="#l75.1234"></a><span id="l75.1234" class="difflineminus">-    this._browserRequest._active = false;</span>
<a href="#l75.1235"></a><span id="l75.1235" class="difflineminus">-    if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l75.1236"></a><span id="l75.1236" class="difflineminus">-      this._browserRequest._listener._cleanUp();</span>
<a href="#l75.1237"></a><span id="l75.1237" class="difflineminus">-    }</span>
<a href="#l75.1238"></a><span id="l75.1238" class="difflineminus">-    delete this._browserRequest;</span>
<a href="#l75.1239"></a><span id="l75.1239" class="difflineminus">-  },</span>
<a href="#l75.1240"></a><span id="l75.1240" class="difflineminus">-  onAuthorizationReceived(aData) {</span>
<a href="#l75.1241"></a><span id="l75.1241" class="difflineminus">-    let data = this._parseURLData(aData.split(&quot;?&quot;)[1]);</span>
<a href="#l75.1242"></a><span id="l75.1242" class="difflineminus">-    if (data.oauth_token != this.token || !data.oauth_verifier) {</span>
<a href="#l75.1243"></a><span id="l75.1243" class="difflineminus">-      this.gotDisconnected(</span>
<a href="#l75.1244"></a><span id="l75.1244" class="difflineminus">-        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l75.1245"></a><span id="l75.1245" class="difflineminus">-        _(&quot;connection.error.authFailed&quot;)</span>
<a href="#l75.1246"></a><span id="l75.1246" class="difflineminus">-      );</span>
<a href="#l75.1247"></a><span id="l75.1247" class="difflineminus">-      return;</span>
<a href="#l75.1248"></a><span id="l75.1248" class="difflineminus">-    }</span>
<a href="#l75.1249"></a><span id="l75.1249" class="difflineminus">-    this.requestAccessToken(data.oauth_verifier);</span>
<a href="#l75.1250"></a><span id="l75.1250" class="difflineminus">-  },</span>
<a href="#l75.1251"></a><span id="l75.1251" class="difflineminus">-  requestAccessToken(aTokenVerifier) {</span>
<a href="#l75.1252"></a><span id="l75.1252" class="difflineminus">-    this.reportConnecting(_(&quot;connection.requestAccess&quot;));</span>
<a href="#l75.1253"></a><span id="l75.1253" class="difflineminus">-    this.signAndSend(</span>
<a href="#l75.1254"></a><span id="l75.1254" class="difflineminus">-      &quot;oauth/access_token&quot;,</span>
<a href="#l75.1255"></a><span id="l75.1255" class="difflineminus">-      null,</span>
<a href="#l75.1256"></a><span id="l75.1256" class="difflineminus">-      [],</span>
<a href="#l75.1257"></a><span id="l75.1257" class="difflineminus">-      this.onAccessTokenReceived,</span>
<a href="#l75.1258"></a><span id="l75.1258" class="difflineminus">-      this.onError,</span>
<a href="#l75.1259"></a><span id="l75.1259" class="difflineminus">-      this,</span>
<a href="#l75.1260"></a><span id="l75.1260" class="difflineminus">-      [[&quot;oauth_verifier&quot;, aTokenVerifier]]</span>
<a href="#l75.1261"></a><span id="l75.1261" class="difflineminus">-    );</span>
<a href="#l75.1262"></a><span id="l75.1262" class="difflineminus">-  },</span>
<a href="#l75.1263"></a><span id="l75.1263" class="difflineminus">-  onAccessTokenReceived(aData) {</span>
<a href="#l75.1264"></a><span id="l75.1264" class="difflineminus">-    this.LOG(&quot;Received access token.&quot;);</span>
<a href="#l75.1265"></a><span id="l75.1265" class="difflineminus">-    let result = this._parseURLData(aData);</span>
<a href="#l75.1266"></a><span id="l75.1266" class="difflineminus">-    if (!this.fixAccountName(result)) {</span>
<a href="#l75.1267"></a><span id="l75.1267" class="difflineminus">-      return;</span>
<a href="#l75.1268"></a><span id="l75.1268" class="difflineminus">-    }</span>
<a href="#l75.1269"></a><span id="l75.1269" class="difflineminus">-</span>
<a href="#l75.1270"></a><span id="l75.1270" class="difflineminus">-    let prefValue = {};</span>
<a href="#l75.1271"></a><span id="l75.1271" class="difflineminus">-    try {</span>
<a href="#l75.1272"></a><span id="l75.1272" class="difflineminus">-      JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l75.1273"></a><span id="l75.1273" class="difflineminus">-    } catch (e) {}</span>
<a href="#l75.1274"></a><span id="l75.1274" class="difflineminus">-    prefValue[this.consumerKey] = result;</span>
<a href="#l75.1275"></a><span id="l75.1275" class="difflineminus">-    this.prefs.setCharPref(&quot;oauth&quot;, JSON.stringify(prefValue));</span>
<a href="#l75.1276"></a><span id="l75.1276" class="difflineminus">-</span>
<a href="#l75.1277"></a><span id="l75.1277" class="difflineminus">-    this.token = result.oauth_token;</span>
<a href="#l75.1278"></a><span id="l75.1278" class="difflineminus">-    this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l75.1279"></a><span id="l75.1279" class="difflineminus">-</span>
<a href="#l75.1280"></a><span id="l75.1280" class="difflineminus">-    this.getTimelines();</span>
<a href="#l75.1281"></a><span id="l75.1281" class="difflineminus">-  },</span>
<a href="#l75.1282"></a><span id="l75.1282" class="difflineminus">-  fixAccountName(aAuthResult) {</span>
<a href="#l75.1283"></a><span id="l75.1283" class="difflineminus">-    if (!aAuthResult.screen_name || aAuthResult.screen_name == this.name) {</span>
<a href="#l75.1284"></a><span id="l75.1284" class="difflineminus">-      return true;</span>
<a href="#l75.1285"></a><span id="l75.1285" class="difflineminus">-    }</span>
<a href="#l75.1286"></a><span id="l75.1286" class="difflineminus">-</span>
<a href="#l75.1287"></a><span id="l75.1287" class="difflineminus">-    if (aAuthResult.screen_name.toLowerCase() != this.name.toLowerCase()) {</span>
<a href="#l75.1288"></a><span id="l75.1288" class="difflineminus">-      this.onError(_(&quot;connection.error.userMismatch&quot;));</span>
<a href="#l75.1289"></a><span id="l75.1289" class="difflineminus">-      return false;</span>
<a href="#l75.1290"></a><span id="l75.1290" class="difflineminus">-    }</span>
<a href="#l75.1291"></a><span id="l75.1291" class="difflineminus">-</span>
<a href="#l75.1292"></a><span id="l75.1292" class="difflineminus">-    this.LOG(</span>
<a href="#l75.1293"></a><span id="l75.1293" class="difflineminus">-      &quot;Fixing the case of the account name: &quot; +</span>
<a href="#l75.1294"></a><span id="l75.1294" class="difflineminus">-        this.name +</span>
<a href="#l75.1295"></a><span id="l75.1295" class="difflineminus">-        &quot; -&gt; &quot; +</span>
<a href="#l75.1296"></a><span id="l75.1296" class="difflineminus">-        aAuthResult.screen_name</span>
<a href="#l75.1297"></a><span id="l75.1297" class="difflineminus">-    );</span>
<a href="#l75.1298"></a><span id="l75.1298" class="difflineminus">-    this.__defineGetter__(&quot;name&quot;, () =&gt; aAuthResult.screen_name);</span>
<a href="#l75.1299"></a><span id="l75.1299" class="difflineminus">-    return true;</span>
<a href="#l75.1300"></a><span id="l75.1300" class="difflineminus">-  },</span>
<a href="#l75.1301"></a><span id="l75.1301" class="difflineminus">-</span>
<a href="#l75.1302"></a><span id="l75.1302" class="difflineminus">-  cleanUp() {</span>
<a href="#l75.1303"></a><span id="l75.1303" class="difflineminus">-    this.finishAuthorizationRequest();</span>
<a href="#l75.1304"></a><span id="l75.1304" class="difflineminus">-    if (this._pendingRequests.length != 0) {</span>
<a href="#l75.1305"></a><span id="l75.1305" class="difflineminus">-      for (let request of this._pendingRequests) {</span>
<a href="#l75.1306"></a><span id="l75.1306" class="difflineminus">-        request.abort();</span>
<a href="#l75.1307"></a><span id="l75.1307" class="difflineminus">-      }</span>
<a href="#l75.1308"></a><span id="l75.1308" class="difflineminus">-      delete this._pendingRequests;</span>
<a href="#l75.1309"></a><span id="l75.1309" class="difflineminus">-    }</span>
<a href="#l75.1310"></a><span id="l75.1310" class="difflineminus">-    if (this._streamTimeout) {</span>
<a href="#l75.1311"></a><span id="l75.1311" class="difflineminus">-      clearTimeout(this._streamTimeout);</span>
<a href="#l75.1312"></a><span id="l75.1312" class="difflineminus">-      delete this._streamTimeout;</span>
<a href="#l75.1313"></a><span id="l75.1313" class="difflineminus">-      // Remove the preference observer that is added when the user stream is</span>
<a href="#l75.1314"></a><span id="l75.1314" class="difflineminus">-      // opened. (This needs to be removed even if an error occurs, in which</span>
<a href="#l75.1315"></a><span id="l75.1315" class="difflineminus">-      // case _streamingRequest is immediately deleted.)</span>
<a href="#l75.1316"></a><span id="l75.1316" class="difflineminus">-      this.prefs.removeObserver(&quot;track&quot;, this);</span>
<a href="#l75.1317"></a><span id="l75.1317" class="difflineminus">-    }</span>
<a href="#l75.1318"></a><span id="l75.1318" class="difflineminus">-    if (this._streamingRequest) {</span>
<a href="#l75.1319"></a><span id="l75.1319" class="difflineminus">-      this._streamingRequest.abort();</span>
<a href="#l75.1320"></a><span id="l75.1320" class="difflineminus">-      delete this._streamingRequest;</span>
<a href="#l75.1321"></a><span id="l75.1321" class="difflineminus">-    }</span>
<a href="#l75.1322"></a><span id="l75.1322" class="difflineminus">-    delete this._pendingData;</span>
<a href="#l75.1323"></a><span id="l75.1323" class="difflineminus">-    delete this.token;</span>
<a href="#l75.1324"></a><span id="l75.1324" class="difflineminus">-    delete this.tokenSecret;</span>
<a href="#l75.1325"></a><span id="l75.1325" class="difflineminus">-  },</span>
<a href="#l75.1326"></a><span id="l75.1326" class="difflineminus">-  gotDisconnected(aError, aErrorMessage) {</span>
<a href="#l75.1327"></a><span id="l75.1327" class="difflineminus">-    if (this.disconnected || this.disconnecting) {</span>
<a href="#l75.1328"></a><span id="l75.1328" class="difflineminus">-      return;</span>
<a href="#l75.1329"></a><span id="l75.1329" class="difflineminus">-    }</span>
<a href="#l75.1330"></a><span id="l75.1330" class="difflineminus">-</span>
<a href="#l75.1331"></a><span id="l75.1331" class="difflineminus">-    if (aError === undefined) {</span>
<a href="#l75.1332"></a><span id="l75.1332" class="difflineminus">-      aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l75.1333"></a><span id="l75.1333" class="difflineminus">-    }</span>
<a href="#l75.1334"></a><span id="l75.1334" class="difflineminus">-    let connected = this.connected;</span>
<a href="#l75.1335"></a><span id="l75.1335" class="difflineminus">-    this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l75.1336"></a><span id="l75.1336" class="difflineminus">-    this.cleanUp();</span>
<a href="#l75.1337"></a><span id="l75.1337" class="difflineminus">-    if (this._timeline &amp;&amp; connected) {</span>
<a href="#l75.1338"></a><span id="l75.1338" class="difflineminus">-      this._timeline.notifyObservers(this._timeline, &quot;update-conv-chatleft&quot;);</span>
<a href="#l75.1339"></a><span id="l75.1339" class="difflineminus">-    }</span>
<a href="#l75.1340"></a><span id="l75.1340" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l75.1341"></a><span id="l75.1341" class="difflineminus">-  },</span>
<a href="#l75.1342"></a><span id="l75.1342" class="difflineminus">-  remove() {</span>
<a href="#l75.1343"></a><span id="l75.1343" class="difflineminus">-    if (!this._timeline) {</span>
<a href="#l75.1344"></a><span id="l75.1344" class="difflineminus">-      return;</span>
<a href="#l75.1345"></a><span id="l75.1345" class="difflineminus">-    }</span>
<a href="#l75.1346"></a><span id="l75.1346" class="difflineminus">-    this._timeline.close();</span>
<a href="#l75.1347"></a><span id="l75.1347" class="difflineminus">-    delete this._timeline;</span>
<a href="#l75.1348"></a><span id="l75.1348" class="difflineminus">-  },</span>
<a href="#l75.1349"></a><span id="l75.1349" class="difflineminus">-  unInit() {</span>
<a href="#l75.1350"></a><span id="l75.1350" class="difflineminus">-    this.cleanUp();</span>
<a href="#l75.1351"></a><span id="l75.1351" class="difflineminus">-  },</span>
<a href="#l75.1352"></a><span id="l75.1352" class="difflineminus">-  disconnect() {</span>
<a href="#l75.1353"></a><span id="l75.1353" class="difflineminus">-    this.gotDisconnected();</span>
<a href="#l75.1354"></a><span id="l75.1354" class="difflineminus">-  },</span>
<a href="#l75.1355"></a><span id="l75.1355" class="difflineminus">-</span>
<a href="#l75.1356"></a><span id="l75.1356" class="difflineminus">-  onError(aException) {</span>
<a href="#l75.1357"></a><span id="l75.1357" class="difflineminus">-    if (aException == &quot;offline&quot;) {</span>
<a href="#l75.1358"></a><span id="l75.1358" class="difflineminus">-      this.gotDisconnected(</span>
<a href="#l75.1359"></a><span id="l75.1359" class="difflineminus">-        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l75.1360"></a><span id="l75.1360" class="difflineminus">-        _(&quot;connection.error.noNetwork&quot;)</span>
<a href="#l75.1361"></a><span id="l75.1361" class="difflineminus">-      );</span>
<a href="#l75.1362"></a><span id="l75.1362" class="difflineminus">-    } else {</span>
<a href="#l75.1363"></a><span id="l75.1363" class="difflineminus">-      this.gotDisconnected(</span>
<a href="#l75.1364"></a><span id="l75.1364" class="difflineminus">-        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l75.1365"></a><span id="l75.1365" class="difflineminus">-        aException.toString()</span>
<a href="#l75.1366"></a><span id="l75.1366" class="difflineminus">-      );</span>
<a href="#l75.1367"></a><span id="l75.1367" class="difflineminus">-    }</span>
<a href="#l75.1368"></a><span id="l75.1368" class="difflineminus">-  },</span>
<a href="#l75.1369"></a><span id="l75.1369" class="difflineminus">-</span>
<a href="#l75.1370"></a><span id="l75.1370" class="difflineminus">-  setUserDescription(aDescription) {</span>
<a href="#l75.1371"></a><span id="l75.1371" class="difflineminus">-    const kMaxUserDescriptionLength = 160;</span>
<a href="#l75.1372"></a><span id="l75.1372" class="difflineminus">-    if (aDescription.length &gt; kMaxUserDescriptionLength) {</span>
<a href="#l75.1373"></a><span id="l75.1373" class="difflineminus">-      aDescription = aDescription.substr(0, kMaxUserDescriptionLength);</span>
<a href="#l75.1374"></a><span id="l75.1374" class="difflineminus">-      this.WARN(</span>
<a href="#l75.1375"></a><span id="l75.1375" class="difflineminus">-        &quot;Description too long (over &quot; +</span>
<a href="#l75.1376"></a><span id="l75.1376" class="difflineminus">-          kMaxUserDescriptionLength +</span>
<a href="#l75.1377"></a><span id="l75.1377" class="difflineminus">-          &quot; characters):\n&quot; +</span>
<a href="#l75.1378"></a><span id="l75.1378" class="difflineminus">-          aDescription +</span>
<a href="#l75.1379"></a><span id="l75.1379" class="difflineminus">-          &quot;.&quot;</span>
<a href="#l75.1380"></a><span id="l75.1380" class="difflineminus">-      );</span>
<a href="#l75.1381"></a><span id="l75.1381" class="difflineminus">-      this.timeline.systemMessage(_(&quot;error.descriptionTooLong&quot;, aDescription));</span>
<a href="#l75.1382"></a><span id="l75.1382" class="difflineminus">-    }</span>
<a href="#l75.1383"></a><span id="l75.1383" class="difflineminus">-    // Don't need to catch the reply since the stream receives user_update.</span>
<a href="#l75.1384"></a><span id="l75.1384" class="difflineminus">-    this.signAndSend(&quot;1.1/account/update_profile.json&quot;, null, [</span>
<a href="#l75.1385"></a><span id="l75.1385" class="difflineminus">-      [&quot;description&quot;, aDescription],</span>
<a href="#l75.1386"></a><span id="l75.1386" class="difflineminus">-    ]);</span>
<a href="#l75.1387"></a><span id="l75.1387" class="difflineminus">-  },</span>
<a href="#l75.1388"></a><span id="l75.1388" class="difflineminus">-</span>
<a href="#l75.1389"></a><span id="l75.1389" class="difflineminus">-  setUserInfo(aUser) {</span>
<a href="#l75.1390"></a><span id="l75.1390" class="difflineminus">-    let nick = aUser.screen_name;</span>
<a href="#l75.1391"></a><span id="l75.1391" class="difflineminus">-    this._userInfo.set(nick, aUser);</span>
<a href="#l75.1392"></a><span id="l75.1392" class="difflineminus">-</span>
<a href="#l75.1393"></a><span id="l75.1393" class="difflineminus">-    // If it's the user's userInfo, update the timeline topic.</span>
<a href="#l75.1394"></a><span id="l75.1394" class="difflineminus">-    if (nick == this.name &amp;&amp; &quot;description&quot; in aUser) {</span>
<a href="#l75.1395"></a><span id="l75.1395" class="difflineminus">-      this.timeline.setTopic(aUser.description, nick, true);</span>
<a href="#l75.1396"></a><span id="l75.1396" class="difflineminus">-    }</span>
<a href="#l75.1397"></a><span id="l75.1397" class="difflineminus">-  },</span>
<a href="#l75.1398"></a><span id="l75.1398" class="difflineminus">-  onRequestedInfoReceived(aData) {</span>
<a href="#l75.1399"></a><span id="l75.1399" class="difflineminus">-    let user = JSON.parse(aData);</span>
<a href="#l75.1400"></a><span id="l75.1400" class="difflineminus">-    this.setUserInfo(user);</span>
<a href="#l75.1401"></a><span id="l75.1401" class="difflineminus">-    this.requestBuddyInfo(user.screen_name);</span>
<a href="#l75.1402"></a><span id="l75.1402" class="difflineminus">-  },</span>
<a href="#l75.1403"></a><span id="l75.1403" class="difflineminus">-  requestBuddyInfo(aBuddyName) {</span>
<a href="#l75.1404"></a><span id="l75.1404" class="difflineminus">-    let userInfo = this._userInfo.get(aBuddyName);</span>
<a href="#l75.1405"></a><span id="l75.1405" class="difflineminus">-    if (!userInfo) {</span>
<a href="#l75.1406"></a><span id="l75.1406" class="difflineminus">-      this.signAndSend(</span>
<a href="#l75.1407"></a><span id="l75.1407" class="difflineminus">-        &quot;1.1/users/show.json?screen_name=&quot; + aBuddyName,</span>
<a href="#l75.1408"></a><span id="l75.1408" class="difflineminus">-        null,</span>
<a href="#l75.1409"></a><span id="l75.1409" class="difflineminus">-        null,</span>
<a href="#l75.1410"></a><span id="l75.1410" class="difflineminus">-        this.onRequestedInfoReceived,</span>
<a href="#l75.1411"></a><span id="l75.1411" class="difflineminus">-        null,</span>
<a href="#l75.1412"></a><span id="l75.1412" class="difflineminus">-        this</span>
<a href="#l75.1413"></a><span id="l75.1413" class="difflineminus">-      );</span>
<a href="#l75.1414"></a><span id="l75.1414" class="difflineminus">-      return;</span>
<a href="#l75.1415"></a><span id="l75.1415" class="difflineminus">-    }</span>
<a href="#l75.1416"></a><span id="l75.1416" class="difflineminus">-</span>
<a href="#l75.1417"></a><span id="l75.1417" class="difflineminus">-    // List of the names of the info to actually show in the tooltip and</span>
<a href="#l75.1418"></a><span id="l75.1418" class="difflineminus">-    // optionally a transform function to apply to the value.</span>
<a href="#l75.1419"></a><span id="l75.1419" class="difflineminus">-    // See https://dev.twitter.com/docs/api/1/get/users/show for the options.</span>
<a href="#l75.1420"></a><span id="l75.1420" class="difflineminus">-    let normalizeBool = isFollowing =&gt; _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l75.1421"></a><span id="l75.1421" class="difflineminus">-    const kFields = {</span>
<a href="#l75.1422"></a><span id="l75.1422" class="difflineminus">-      name: null,</span>
<a href="#l75.1423"></a><span id="l75.1423" class="difflineminus">-      following: normalizeBool,</span>
<a href="#l75.1424"></a><span id="l75.1424" class="difflineminus">-      description: null,</span>
<a href="#l75.1425"></a><span id="l75.1425" class="difflineminus">-      url: null,</span>
<a href="#l75.1426"></a><span id="l75.1426" class="difflineminus">-      location: null,</span>
<a href="#l75.1427"></a><span id="l75.1427" class="difflineminus">-      lang(aLang) {</span>
<a href="#l75.1428"></a><span id="l75.1428" class="difflineminus">-        try {</span>
<a href="#l75.1429"></a><span id="l75.1429" class="difflineminus">-          return _lang(aLang);</span>
<a href="#l75.1430"></a><span id="l75.1430" class="difflineminus">-        } catch (e) {</span>
<a href="#l75.1431"></a><span id="l75.1431" class="difflineminus">-          return aLang;</span>
<a href="#l75.1432"></a><span id="l75.1432" class="difflineminus">-        }</span>
<a href="#l75.1433"></a><span id="l75.1433" class="difflineminus">-      },</span>
<a href="#l75.1434"></a><span id="l75.1434" class="difflineminus">-      time_zone: null,</span>
<a href="#l75.1435"></a><span id="l75.1435" class="difflineminus">-      protected: normalizeBool,</span>
<a href="#l75.1436"></a><span id="l75.1436" class="difflineminus">-      created_at(aDate) {</span>
<a href="#l75.1437"></a><span id="l75.1437" class="difflineminus">-        const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l75.1438"></a><span id="l75.1438" class="difflineminus">-          dateStyle: &quot;short&quot;,</span>
<a href="#l75.1439"></a><span id="l75.1439" class="difflineminus">-        });</span>
<a href="#l75.1440"></a><span id="l75.1440" class="difflineminus">-        return dateFormatter.format(new Date(aDate));</span>
<a href="#l75.1441"></a><span id="l75.1441" class="difflineminus">-      },</span>
<a href="#l75.1442"></a><span id="l75.1442" class="difflineminus">-      statuses_count: null,</span>
<a href="#l75.1443"></a><span id="l75.1443" class="difflineminus">-      friends_count: null,</span>
<a href="#l75.1444"></a><span id="l75.1444" class="difflineminus">-      followers_count: null,</span>
<a href="#l75.1445"></a><span id="l75.1445" class="difflineminus">-      listed_count: null,</span>
<a href="#l75.1446"></a><span id="l75.1446" class="difflineminus">-    };</span>
<a href="#l75.1447"></a><span id="l75.1447" class="difflineminus">-</span>
<a href="#l75.1448"></a><span id="l75.1448" class="difflineminus">-    let tooltipInfo = [];</span>
<a href="#l75.1449"></a><span id="l75.1449" class="difflineminus">-    for (let field in kFields) {</span>
<a href="#l75.1450"></a><span id="l75.1450" class="difflineminus">-      if (</span>
<a href="#l75.1451"></a><span id="l75.1451" class="difflineminus">-        Object.prototype.hasOwnProperty.call(userInfo, field) &amp;&amp;</span>
<a href="#l75.1452"></a><span id="l75.1452" class="difflineminus">-        userInfo[field]</span>
<a href="#l75.1453"></a><span id="l75.1453" class="difflineminus">-      ) {</span>
<a href="#l75.1454"></a><span id="l75.1454" class="difflineminus">-        let value = userInfo[field];</span>
<a href="#l75.1455"></a><span id="l75.1455" class="difflineminus">-        if (kFields[field]) {</span>
<a href="#l75.1456"></a><span id="l75.1456" class="difflineminus">-          value = kFields[field](value);</span>
<a href="#l75.1457"></a><span id="l75.1457" class="difflineminus">-        }</span>
<a href="#l75.1458"></a><span id="l75.1458" class="difflineminus">-        tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l75.1459"></a><span id="l75.1459" class="difflineminus">-      }</span>
<a href="#l75.1460"></a><span id="l75.1460" class="difflineminus">-    }</span>
<a href="#l75.1461"></a><span id="l75.1461" class="difflineminus">-    tooltipInfo.push(</span>
<a href="#l75.1462"></a><span id="l75.1462" class="difflineminus">-      new TooltipInfo(</span>
<a href="#l75.1463"></a><span id="l75.1463" class="difflineminus">-        null,</span>
<a href="#l75.1464"></a><span id="l75.1464" class="difflineminus">-        userInfo.profile_image_url,</span>
<a href="#l75.1465"></a><span id="l75.1465" class="difflineminus">-        Ci.prplITooltipInfo.icon</span>
<a href="#l75.1466"></a><span id="l75.1466" class="difflineminus">-      )</span>
<a href="#l75.1467"></a><span id="l75.1467" class="difflineminus">-    );</span>
<a href="#l75.1468"></a><span id="l75.1468" class="difflineminus">-</span>
<a href="#l75.1469"></a><span id="l75.1469" class="difflineminus">-    Services.obs.notifyObservers(</span>
<a href="#l75.1470"></a><span id="l75.1470" class="difflineminus">-      new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l75.1471"></a><span id="l75.1471" class="difflineminus">-      &quot;user-info-received&quot;,</span>
<a href="#l75.1472"></a><span id="l75.1472" class="difflineminus">-      aBuddyName</span>
<a href="#l75.1473"></a><span id="l75.1473" class="difflineminus">-    );</span>
<a href="#l75.1474"></a><span id="l75.1474" class="difflineminus">-  },</span>
<a href="#l75.1475"></a><span id="l75.1475" class="difflineminus">-</span>
<a href="#l75.1476"></a><span id="l75.1476" class="difflineminus">-  // Handle the full user info for each received friend. Set the user info and</span>
<a href="#l75.1477"></a><span id="l75.1477" class="difflineminus">-  // create the participant.</span>
<a href="#l75.1478"></a><span id="l75.1478" class="difflineminus">-  onLookupReceived(aData) {</span>
<a href="#l75.1479"></a><span id="l75.1479" class="difflineminus">-    let users = JSON.parse(aData);</span>
<a href="#l75.1480"></a><span id="l75.1480" class="difflineminus">-    for (let user of users) {</span>
<a href="#l75.1481"></a><span id="l75.1481" class="difflineminus">-      this.setUserInfo(user);</span>
<a href="#l75.1482"></a><span id="l75.1482" class="difflineminus">-      this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l75.1483"></a><span id="l75.1483" class="difflineminus">-    }</span>
<a href="#l75.1484"></a><span id="l75.1484" class="difflineminus">-  },</span>
<a href="#l75.1485"></a><span id="l75.1485" class="difflineminus">-</span>
<a href="#l75.1486"></a><span id="l75.1486" class="difflineminus">-  // Allow us to reopen the timeline via the join chat menu.</span>
<a href="#l75.1487"></a><span id="l75.1487" class="difflineminus">-  get canJoinChat() {</span>
<a href="#l75.1488"></a><span id="l75.1488" class="difflineminus">-    return true;</span>
<a href="#l75.1489"></a><span id="l75.1489" class="difflineminus">-  },</span>
<a href="#l75.1490"></a><span id="l75.1490" class="difflineminus">-  joinChat(aComponents) {</span>
<a href="#l75.1491"></a><span id="l75.1491" class="difflineminus">-    // The 'timeline' getter opens a timeline conversation if none exists.</span>
<a href="#l75.1492"></a><span id="l75.1492" class="difflineminus">-    this.timeline;</span>
<a href="#l75.1493"></a><span id="l75.1493" class="difflineminus">-  },</span>
<a href="#l75.1494"></a><span id="l75.1494" class="difflineminus">-</span>
<a href="#l75.1495"></a><span id="l75.1495" class="difflineminus">-  getConversation(aName) {</span>
<a href="#l75.1496"></a><span id="l75.1496" class="difflineminus">-    if (!this._conversations.has(aName)) {</span>
<a href="#l75.1497"></a><span id="l75.1497" class="difflineminus">-      this._conversations.set(</span>
<a href="#l75.1498"></a><span id="l75.1498" class="difflineminus">-        aName,</span>
<a href="#l75.1499"></a><span id="l75.1499" class="difflineminus">-        new DirectMessageConversation(this, aName)</span>
<a href="#l75.1500"></a><span id="l75.1500" class="difflineminus">-      );</span>
<a href="#l75.1501"></a><span id="l75.1501" class="difflineminus">-    }</span>
<a href="#l75.1502"></a><span id="l75.1502" class="difflineminus">-    return this._conversations.get(aName);</span>
<a href="#l75.1503"></a><span id="l75.1503" class="difflineminus">-  },</span>
<a href="#l75.1504"></a><span id="l75.1504" class="difflineminus">-  removeConversation(aName) {</span>
<a href="#l75.1505"></a><span id="l75.1505" class="difflineminus">-    if (this._conversations.has(aName)) {</span>
<a href="#l75.1506"></a><span id="l75.1506" class="difflineminus">-      this._conversations.delete(aName);</span>
<a href="#l75.1507"></a><span id="l75.1507" class="difflineminus">-    }</span>
<a href="#l75.1508"></a><span id="l75.1508" class="difflineminus">-  },</span>
<a href="#l75.1509"></a><span id="l75.1509" class="difflineminus">-  createConversation(aName) {</span>
<a href="#l75.1510"></a><span id="l75.1510" class="difflineminus">-    return this.getConversation(aName);</span>
<a href="#l75.1511"></a><span id="l75.1511" class="difflineminus">-  },</span>
<a href="#l75.1512"></a><span id="l75.1512" class="difflineminus">-};</span>
<a href="#l75.1513"></a><span id="l75.1513" class="difflineminus">-</span>
<a href="#l75.1514"></a><span id="l75.1514" class="difflineminus">-// Shortcut to get the JavaScript account object.</span>
<a href="#l75.1515"></a><span id="l75.1515" class="difflineminus">-function getAccount(aConv) {</span>
<a href="#l75.1516"></a><span id="l75.1516" class="difflineminus">-  return aConv.wrappedJSObject._account;</span>
<a href="#l75.1517"></a><span id="l75.1517" class="difflineminus">-}</span>
<a href="#l75.1518"></a><span id="l75.1518" class="difflineminus">-</span>
<a href="#l75.1519"></a><span id="l75.1519" class="difflineminus">-function TwitterProtocol() {</span>
<a href="#l75.1520"></a><span id="l75.1520" class="difflineminus">-  this.registerCommands();</span>
<a href="#l75.1521"></a><span id="l75.1521" class="difflineminus">-}</span>
<a href="#l75.1522"></a><span id="l75.1522" class="difflineminus">-TwitterProtocol.prototype = {</span>
<a href="#l75.1523"></a><span id="l75.1523" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l75.1524"></a><span id="l75.1524" class="difflineminus">-  get normalizedName() {</span>
<a href="#l75.1525"></a><span id="l75.1525" class="difflineminus">-    return &quot;twitter&quot;;</span>
<a href="#l75.1526"></a><span id="l75.1526" class="difflineminus">-  },</span>
<a href="#l75.1527"></a><span id="l75.1527" class="difflineminus">-  get name() {</span>
<a href="#l75.1528"></a><span id="l75.1528" class="difflineminus">-    return _(&quot;twitter.protocolName&quot;);</span>
<a href="#l75.1529"></a><span id="l75.1529" class="difflineminus">-  },</span>
<a href="#l75.1530"></a><span id="l75.1530" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l75.1531"></a><span id="l75.1531" class="difflineminus">-    return &quot;chrome://prpl-twitter/skin/&quot;;</span>
<a href="#l75.1532"></a><span id="l75.1532" class="difflineminus">-  },</span>
<a href="#l75.1533"></a><span id="l75.1533" class="difflineminus">-  get noPassword() {</span>
<a href="#l75.1534"></a><span id="l75.1534" class="difflineminus">-    return true;</span>
<a href="#l75.1535"></a><span id="l75.1535" class="difflineminus">-  },</span>
<a href="#l75.1536"></a><span id="l75.1536" class="difflineminus">-  options: {</span>
<a href="#l75.1537"></a><span id="l75.1537" class="difflineminus">-    track: {</span>
<a href="#l75.1538"></a><span id="l75.1538" class="difflineminus">-      get label() {</span>
<a href="#l75.1539"></a><span id="l75.1539" class="difflineminus">-        return _(&quot;options.track&quot;);</span>
<a href="#l75.1540"></a><span id="l75.1540" class="difflineminus">-      },</span>
<a href="#l75.1541"></a><span id="l75.1541" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l75.1542"></a><span id="l75.1542" class="difflineminus">-    },</span>
<a href="#l75.1543"></a><span id="l75.1543" class="difflineminus">-  },</span>
<a href="#l75.1544"></a><span id="l75.1544" class="difflineminus">-  // Replace the command name in the help string so translators do not attempt</span>
<a href="#l75.1545"></a><span id="l75.1545" class="difflineminus">-  // to translate it.</span>
<a href="#l75.1546"></a><span id="l75.1546" class="difflineminus">-  commands: [</span>
<a href="#l75.1547"></a><span id="l75.1547" class="difflineminus">-    {</span>
<a href="#l75.1548"></a><span id="l75.1548" class="difflineminus">-      name: &quot;follow&quot;,</span>
<a href="#l75.1549"></a><span id="l75.1549" class="difflineminus">-      get helpString() {</span>
<a href="#l75.1550"></a><span id="l75.1550" class="difflineminus">-        return _(&quot;command.follow&quot;, &quot;follow&quot;);</span>
<a href="#l75.1551"></a><span id="l75.1551" class="difflineminus">-      },</span>
<a href="#l75.1552"></a><span id="l75.1552" class="difflineminus">-      run(aMsg, aConv) {</span>
<a href="#l75.1553"></a><span id="l75.1553" class="difflineminus">-        aMsg = aMsg.trim();</span>
<a href="#l75.1554"></a><span id="l75.1554" class="difflineminus">-        if (!aMsg) {</span>
<a href="#l75.1555"></a><span id="l75.1555" class="difflineminus">-          return false;</span>
<a href="#l75.1556"></a><span id="l75.1556" class="difflineminus">-        }</span>
<a href="#l75.1557"></a><span id="l75.1557" class="difflineminus">-        let account = getAccount(aConv);</span>
<a href="#l75.1558"></a><span id="l75.1558" class="difflineminus">-        aMsg.split(&quot; &quot;).forEach(account.follow, account);</span>
<a href="#l75.1559"></a><span id="l75.1559" class="difflineminus">-        return true;</span>
<a href="#l75.1560"></a><span id="l75.1560" class="difflineminus">-      },</span>
<a href="#l75.1561"></a><span id="l75.1561" class="difflineminus">-    },</span>
<a href="#l75.1562"></a><span id="l75.1562" class="difflineminus">-    {</span>
<a href="#l75.1563"></a><span id="l75.1563" class="difflineminus">-      name: &quot;unfollow&quot;,</span>
<a href="#l75.1564"></a><span id="l75.1564" class="difflineminus">-      get helpString() {</span>
<a href="#l75.1565"></a><span id="l75.1565" class="difflineminus">-        return _(&quot;command.unfollow&quot;, &quot;unfollow&quot;);</span>
<a href="#l75.1566"></a><span id="l75.1566" class="difflineminus">-      },</span>
<a href="#l75.1567"></a><span id="l75.1567" class="difflineminus">-      run(aMsg, aConv) {</span>
<a href="#l75.1568"></a><span id="l75.1568" class="difflineminus">-        aMsg = aMsg.trim();</span>
<a href="#l75.1569"></a><span id="l75.1569" class="difflineminus">-        if (!aMsg) {</span>
<a href="#l75.1570"></a><span id="l75.1570" class="difflineminus">-          return false;</span>
<a href="#l75.1571"></a><span id="l75.1571" class="difflineminus">-        }</span>
<a href="#l75.1572"></a><span id="l75.1572" class="difflineminus">-        let account = getAccount(aConv);</span>
<a href="#l75.1573"></a><span id="l75.1573" class="difflineminus">-        aMsg.split(&quot; &quot;).forEach(account.stopFollowing, account);</span>
<a href="#l75.1574"></a><span id="l75.1574" class="difflineminus">-        return true;</span>
<a href="#l75.1575"></a><span id="l75.1575" class="difflineminus">-      },</span>
<a href="#l75.1576"></a><span id="l75.1576" class="difflineminus">-    },</span>
<a href="#l75.1577"></a><span id="l75.1577" class="difflineminus">-  ],</span>
<a href="#l75.1578"></a><span id="l75.1578" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l75.1579"></a><span id="l75.1579" class="difflineminus">-    return new Account(this, aImAccount);</span>
<a href="#l75.1580"></a><span id="l75.1580" class="difflineminus">-  },</span>
<a href="#l75.1581"></a><span id="l75.1581" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">deleted file mode 100644</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineminus">--- a/chat/protocols/twitter/components.conf</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineplus">+++ /dev/null</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineminus">-</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineminus">-Classes = [</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-  {</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineminus">-    'cid': '{31082ff6-1de8-422b-ab60-ca0ac0b2af13}',</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/twitter;1'],</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineminus">-    'jsm': 'resource:///modules/Twitter.jsm',</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineminus">-    'constructor': 'TwitterProtocol',</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-twitter'},</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineminus">-  },</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/chat/protocols/twitter/moz.build</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/chat/protocols/twitter/moz.build</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -1,15 +1,14 @@</span>
<a href="#l77.4"></a><span id="l77.4"> # vim: set filetype=python:</span>
<a href="#l77.5"></a><span id="l77.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l77.6"></a><span id="l77.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l77.7"></a><span id="l77.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l77.8"></a><span id="l77.8"> </span>
<a href="#l77.9"></a><span id="l77.9" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineminus">-    'twitter-text.jsm',</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineminus">-    'Twitter.jsm',</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+    'twitter.js',</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+    'twitter.manifest',</span>
<a href="#l77.15"></a><span id="l77.15"> ]</span>
<a href="#l77.16"></a><span id="l77.16"> </span>
<a href="#l77.17"></a><span id="l77.17" class="difflineplus">+EXTRA_JS_MODULES += [</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+    'twitter-text.jsm',</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+]</span>
<a href="#l77.20"></a><span id="l77.20"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineminus">-</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineminus">-    'components.conf',</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">new file mode 100644</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineminus">--- /dev/null</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineplus">+++ b/chat/protocols/twitter/twitter.js</span>
<a href="#l78.4"></a><span id="l78.4" class="difflineat">@@ -0,0 +1,1578 @@</span>
<a href="#l78.5"></a><span id="l78.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l78.6"></a><span id="l78.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l78.7"></a><span id="l78.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l78.8"></a><span id="l78.8" class="difflineplus">+</span>
<a href="#l78.9"></a><span id="l78.9" class="difflineplus">+var { httpRequest, percentEncode } = ChromeUtils.import(</span>
<a href="#l78.10"></a><span id="l78.10" class="difflineplus">+  &quot;resource://gre/modules/Http.jsm&quot;</span>
<a href="#l78.11"></a><span id="l78.11" class="difflineplus">+);</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+var {</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+  XPCOMUtils,</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+  setTimeout,</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+  clearTimeout,</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+  nsSimpleEnumerator,</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+  ClassInfo,</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+  l10nHelper,</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+  initLogModule,</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineplus">+var {</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineplus">+  GenericAccountPrototype,</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineplus">+  GenericConvIMPrototype,</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+  GenericConvChatPrototype,</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+  GenericConvChatBuddyPrototype,</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+  GenericConversationPrototype,</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+  GenericMessagePrototype,</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineplus">+  GenericProtocolPrototype,</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+  TooltipInfo,</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+} = ChromeUtils.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+var { twttr } = ChromeUtils.import(&quot;resource:///modules/twitter-text.jsm&quot;);</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+var NS_PREFBRANCH_PREFCHANGE_TOPIC_ID = &quot;nsPref:changed&quot;;</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/twitter.properties&quot;)</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineplus">+);</span>
<a href="#l78.39"></a><span id="l78.39" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_lang&quot;, () =&gt;</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineplus">+  l10nHelper(&quot;chrome://global/locale/languageNames.properties&quot;)</span>
<a href="#l78.41"></a><span id="l78.41" class="difflineplus">+);</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineplus">+initLogModule(&quot;twitter&quot;, this);</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+function ChatBuddy(aName, aAccount) {</span>
<a href="#l78.45"></a><span id="l78.45" class="difflineplus">+  this._name = aName;</span>
<a href="#l78.46"></a><span id="l78.46" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineplus">+}</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+ChatBuddy.prototype = {</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineplus">+  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+  get buddyIconFilename() {</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineplus">+    let userInfo = this._account._userInfo.get(this.name);</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+    if (userInfo) {</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineplus">+      return userInfo.profile_image_url;</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+    }</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+    return undefined;</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+  },</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineplus">+  set buddyIconFilename(aName) {</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+    // Prevent accidental removal of the getter.</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineplus">+    throw new Error(</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineplus">+      &quot;Don't set chatBuddy.buddyIconFilename directly for Twitter.&quot;</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+    );</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+  },</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineplus">+  createConversation() {</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+    return this._account.createConversation(this._name);</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+  },</span>
<a href="#l78.66"></a><span id="l78.66" class="difflineplus">+};</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineplus">+</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+function Tweet(aTweet, aWho, aMessage, aObject) {</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineplus">+  this._tweet = aTweet;</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineplus">+  this._init(aWho, aMessage, aObject);</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineplus">+}</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineplus">+Tweet.prototype = {</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+  __proto__: GenericMessagePrototype,</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+  _deleted: false,</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+  getActions() {</span>
<a href="#l78.76"></a><span id="l78.76" class="difflineplus">+    // Direct messages have no actions.</span>
<a href="#l78.77"></a><span id="l78.77" class="difflineplus">+    if (!this.conversation.isChat) {</span>
<a href="#l78.78"></a><span id="l78.78" class="difflineplus">+      return [];</span>
<a href="#l78.79"></a><span id="l78.79" class="difflineplus">+    }</span>
<a href="#l78.80"></a><span id="l78.80" class="difflineplus">+</span>
<a href="#l78.81"></a><span id="l78.81" class="difflineplus">+    let account = this.conversation._account;</span>
<a href="#l78.82"></a><span id="l78.82" class="difflineplus">+    let actions = [];</span>
<a href="#l78.83"></a><span id="l78.83" class="difflineplus">+</span>
<a href="#l78.84"></a><span id="l78.84" class="difflineplus">+    if (account.connected) {</span>
<a href="#l78.85"></a><span id="l78.85" class="difflineplus">+      actions.push(</span>
<a href="#l78.86"></a><span id="l78.86" class="difflineplus">+        new Action(</span>
<a href="#l78.87"></a><span id="l78.87" class="difflineplus">+          _(&quot;action.reply&quot;),</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineplus">+          function() {</span>
<a href="#l78.89"></a><span id="l78.89" class="difflineplus">+            this.conversation.startReply(this._tweet);</span>
<a href="#l78.90"></a><span id="l78.90" class="difflineplus">+          },</span>
<a href="#l78.91"></a><span id="l78.91" class="difflineplus">+          this</span>
<a href="#l78.92"></a><span id="l78.92" class="difflineplus">+        )</span>
<a href="#l78.93"></a><span id="l78.93" class="difflineplus">+      );</span>
<a href="#l78.94"></a><span id="l78.94" class="difflineplus">+      actions.push(</span>
<a href="#l78.95"></a><span id="l78.95" class="difflineplus">+        new Action(</span>
<a href="#l78.96"></a><span id="l78.96" class="difflineplus">+          _(&quot;action.retweet&quot;),</span>
<a href="#l78.97"></a><span id="l78.97" class="difflineplus">+          function() {</span>
<a href="#l78.98"></a><span id="l78.98" class="difflineplus">+            this.conversation.reTweet(this._tweet);</span>
<a href="#l78.99"></a><span id="l78.99" class="difflineplus">+          },</span>
<a href="#l78.100"></a><span id="l78.100" class="difflineplus">+          this</span>
<a href="#l78.101"></a><span id="l78.101" class="difflineplus">+        )</span>
<a href="#l78.102"></a><span id="l78.102" class="difflineplus">+      );</span>
<a href="#l78.103"></a><span id="l78.103" class="difflineplus">+      if (this.incoming) {</span>
<a href="#l78.104"></a><span id="l78.104" class="difflineplus">+        let isFriend = account._friends.has(this._tweet.user.id_str);</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineplus">+        let action = isFriend ? &quot;stopFollowing&quot; : &quot;follow&quot;;</span>
<a href="#l78.106"></a><span id="l78.106" class="difflineplus">+        let screenName = this._tweet.user.screen_name;</span>
<a href="#l78.107"></a><span id="l78.107" class="difflineplus">+        actions.push(</span>
<a href="#l78.108"></a><span id="l78.108" class="difflineplus">+          new Action(_(&quot;action.&quot; + action, screenName), function() {</span>
<a href="#l78.109"></a><span id="l78.109" class="difflineplus">+            account[action](screenName);</span>
<a href="#l78.110"></a><span id="l78.110" class="difflineplus">+          })</span>
<a href="#l78.111"></a><span id="l78.111" class="difflineplus">+        );</span>
<a href="#l78.112"></a><span id="l78.112" class="difflineplus">+</span>
<a href="#l78.113"></a><span id="l78.113" class="difflineplus">+        const favAction = this._tweet.favorited ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l78.114"></a><span id="l78.114" class="difflineplus">+        actions.push(</span>
<a href="#l78.115"></a><span id="l78.115" class="difflineplus">+          new Action(</span>
<a href="#l78.116"></a><span id="l78.116" class="difflineplus">+            _(&quot;action.&quot; + favAction),</span>
<a href="#l78.117"></a><span id="l78.117" class="difflineplus">+            () =&gt; {</span>
<a href="#l78.118"></a><span id="l78.118" class="difflineplus">+              this.conversation.like(this._tweet, this._tweet.favorited);</span>
<a href="#l78.119"></a><span id="l78.119" class="difflineplus">+            },</span>
<a href="#l78.120"></a><span id="l78.120" class="difflineplus">+            this</span>
<a href="#l78.121"></a><span id="l78.121" class="difflineplus">+          )</span>
<a href="#l78.122"></a><span id="l78.122" class="difflineplus">+        );</span>
<a href="#l78.123"></a><span id="l78.123" class="difflineplus">+      } else if (this.outgoing &amp;&amp; !this._deleted) {</span>
<a href="#l78.124"></a><span id="l78.124" class="difflineplus">+        actions.push(</span>
<a href="#l78.125"></a><span id="l78.125" class="difflineplus">+          new Action(</span>
<a href="#l78.126"></a><span id="l78.126" class="difflineplus">+            _(&quot;action.delete&quot;),</span>
<a href="#l78.127"></a><span id="l78.127" class="difflineplus">+            function() {</span>
<a href="#l78.128"></a><span id="l78.128" class="difflineplus">+              this.destroy();</span>
<a href="#l78.129"></a><span id="l78.129" class="difflineplus">+            },</span>
<a href="#l78.130"></a><span id="l78.130" class="difflineplus">+            this</span>
<a href="#l78.131"></a><span id="l78.131" class="difflineplus">+          )</span>
<a href="#l78.132"></a><span id="l78.132" class="difflineplus">+        );</span>
<a href="#l78.133"></a><span id="l78.133" class="difflineplus">+      }</span>
<a href="#l78.134"></a><span id="l78.134" class="difflineplus">+    }</span>
<a href="#l78.135"></a><span id="l78.135" class="difflineplus">+    actions.push(</span>
<a href="#l78.136"></a><span id="l78.136" class="difflineplus">+      new Action(</span>
<a href="#l78.137"></a><span id="l78.137" class="difflineplus">+        _(&quot;action.copyLink&quot;),</span>
<a href="#l78.138"></a><span id="l78.138" class="difflineplus">+        function() {</span>
<a href="#l78.139"></a><span id="l78.139" class="difflineplus">+          let href =</span>
<a href="#l78.140"></a><span id="l78.140" class="difflineplus">+            &quot;https://twitter.com/&quot; +</span>
<a href="#l78.141"></a><span id="l78.141" class="difflineplus">+            this._tweet.user.screen_name +</span>
<a href="#l78.142"></a><span id="l78.142" class="difflineplus">+            &quot;/status/&quot; +</span>
<a href="#l78.143"></a><span id="l78.143" class="difflineplus">+            this._tweet.id_str;</span>
<a href="#l78.144"></a><span id="l78.144" class="difflineplus">+          Cc[&quot;@mozilla.org/widget/clipboardhelper;1&quot;]</span>
<a href="#l78.145"></a><span id="l78.145" class="difflineplus">+            .getService(Ci.nsIClipboardHelper)</span>
<a href="#l78.146"></a><span id="l78.146" class="difflineplus">+            .copyString(href);</span>
<a href="#l78.147"></a><span id="l78.147" class="difflineplus">+        },</span>
<a href="#l78.148"></a><span id="l78.148" class="difflineplus">+        this</span>
<a href="#l78.149"></a><span id="l78.149" class="difflineplus">+      )</span>
<a href="#l78.150"></a><span id="l78.150" class="difflineplus">+    );</span>
<a href="#l78.151"></a><span id="l78.151" class="difflineplus">+    return actions;</span>
<a href="#l78.152"></a><span id="l78.152" class="difflineplus">+  },</span>
<a href="#l78.153"></a><span id="l78.153" class="difflineplus">+  destroy() {</span>
<a href="#l78.154"></a><span id="l78.154" class="difflineplus">+    // Mark the tweet as deleted until we receive a response.</span>
<a href="#l78.155"></a><span id="l78.155" class="difflineplus">+    this._deleted = true;</span>
<a href="#l78.156"></a><span id="l78.156" class="difflineplus">+</span>
<a href="#l78.157"></a><span id="l78.157" class="difflineplus">+    this.conversation._account.destroy(</span>
<a href="#l78.158"></a><span id="l78.158" class="difflineplus">+      this._tweet,</span>
<a href="#l78.159"></a><span id="l78.159" class="difflineplus">+      this.onDestroyCallback,</span>
<a href="#l78.160"></a><span id="l78.160" class="difflineplus">+      this.onDestroyErrorCallback,</span>
<a href="#l78.161"></a><span id="l78.161" class="difflineplus">+      this</span>
<a href="#l78.162"></a><span id="l78.162" class="difflineplus">+    );</span>
<a href="#l78.163"></a><span id="l78.163" class="difflineplus">+  },</span>
<a href="#l78.164"></a><span id="l78.164" class="difflineplus">+  onDestroyErrorCallback(aException, aData) {</span>
<a href="#l78.165"></a><span id="l78.165" class="difflineplus">+    // The tweet was not successfully deleted.</span>
<a href="#l78.166"></a><span id="l78.166" class="difflineplus">+    delete this._deleted;</span>
<a href="#l78.167"></a><span id="l78.167" class="difflineplus">+    let error = this.conversation._parseError(aData);</span>
<a href="#l78.168"></a><span id="l78.168" class="difflineplus">+    this.conversation.systemMessage(</span>
<a href="#l78.169"></a><span id="l78.169" class="difflineplus">+      _(&quot;error.delete&quot;, error, this.originalMessage),</span>
<a href="#l78.170"></a><span id="l78.170" class="difflineplus">+      true</span>
<a href="#l78.171"></a><span id="l78.171" class="difflineplus">+    );</span>
<a href="#l78.172"></a><span id="l78.172" class="difflineplus">+  },</span>
<a href="#l78.173"></a><span id="l78.173" class="difflineplus">+  onDestroyCallback(aData) {</span>
<a href="#l78.174"></a><span id="l78.174" class="difflineplus">+    let tweet = JSON.parse(aData);</span>
<a href="#l78.175"></a><span id="l78.175" class="difflineplus">+    // If Twitter responds with an error, throw to call the error callback.</span>
<a href="#l78.176"></a><span id="l78.176" class="difflineplus">+    if (&quot;error&quot; in tweet) {</span>
<a href="#l78.177"></a><span id="l78.177" class="difflineplus">+      throw tweet.error;</span>
<a href="#l78.178"></a><span id="l78.178" class="difflineplus">+    }</span>
<a href="#l78.179"></a><span id="l78.179" class="difflineplus">+</span>
<a href="#l78.180"></a><span id="l78.180" class="difflineplus">+    // Create a new system message saying the tweet has been deleted.</span>
<a href="#l78.181"></a><span id="l78.181" class="difflineplus">+    this.conversation.systemMessage(_(&quot;event.deleted&quot;, this.originalMessage));</span>
<a href="#l78.182"></a><span id="l78.182" class="difflineplus">+  },</span>
<a href="#l78.183"></a><span id="l78.183" class="difflineplus">+};</span>
<a href="#l78.184"></a><span id="l78.184" class="difflineplus">+</span>
<a href="#l78.185"></a><span id="l78.185" class="difflineplus">+function Action(aLabel, aAction, aTweet) {</span>
<a href="#l78.186"></a><span id="l78.186" class="difflineplus">+  this.label = aLabel;</span>
<a href="#l78.187"></a><span id="l78.187" class="difflineplus">+  this._action = aAction;</span>
<a href="#l78.188"></a><span id="l78.188" class="difflineplus">+  this._tweet = aTweet;</span>
<a href="#l78.189"></a><span id="l78.189" class="difflineplus">+}</span>
<a href="#l78.190"></a><span id="l78.190" class="difflineplus">+Action.prototype = {</span>
<a href="#l78.191"></a><span id="l78.191" class="difflineplus">+  __proto__: ClassInfo(&quot;prplIMessageAction&quot;, &quot;generic message action object&quot;),</span>
<a href="#l78.192"></a><span id="l78.192" class="difflineplus">+  get run() {</span>
<a href="#l78.193"></a><span id="l78.193" class="difflineplus">+    return this._action.bind(this._tweet);</span>
<a href="#l78.194"></a><span id="l78.194" class="difflineplus">+  },</span>
<a href="#l78.195"></a><span id="l78.195" class="difflineplus">+};</span>
<a href="#l78.196"></a><span id="l78.196" class="difflineplus">+</span>
<a href="#l78.197"></a><span id="l78.197" class="difflineplus">+// Properties / methods shared by both DirectMessageConversation and</span>
<a href="#l78.198"></a><span id="l78.198" class="difflineplus">+// TimelineConversation.</span>
<a href="#l78.199"></a><span id="l78.199" class="difflineplus">+var GenericTwitterConversation = {</span>
<a href="#l78.200"></a><span id="l78.200" class="difflineplus">+  getTweetLength(aString) {</span>
<a href="#l78.201"></a><span id="l78.201" class="difflineplus">+    // Use the Twitter library to calculate the length.</span>
<a href="#l78.202"></a><span id="l78.202" class="difflineplus">+    let parsed = twttr.txt.parseTweet(aString);</span>
<a href="#l78.203"></a><span id="l78.203" class="difflineplus">+    return parsed.weightedLength;</span>
<a href="#l78.204"></a><span id="l78.204" class="difflineplus">+  },</span>
<a href="#l78.205"></a><span id="l78.205" class="difflineplus">+  systemMessage(aMessage, aIsError, aDate) {</span>
<a href="#l78.206"></a><span id="l78.206" class="difflineplus">+    let flags = { system: true };</span>
<a href="#l78.207"></a><span id="l78.207" class="difflineplus">+    if (aIsError) {</span>
<a href="#l78.208"></a><span id="l78.208" class="difflineplus">+      flags.error = true;</span>
<a href="#l78.209"></a><span id="l78.209" class="difflineplus">+    }</span>
<a href="#l78.210"></a><span id="l78.210" class="difflineplus">+    if (aDate) {</span>
<a href="#l78.211"></a><span id="l78.211" class="difflineplus">+      flags.time = aDate;</span>
<a href="#l78.212"></a><span id="l78.212" class="difflineplus">+    }</span>
<a href="#l78.213"></a><span id="l78.213" class="difflineplus">+    this.writeMessage(&quot;twitter.com&quot;, aMessage, flags);</span>
<a href="#l78.214"></a><span id="l78.214" class="difflineplus">+  },</span>
<a href="#l78.215"></a><span id="l78.215" class="difflineplus">+  onSentCallback(aMsg, aData) {</span>
<a href="#l78.216"></a><span id="l78.216" class="difflineplus">+    // The conversation may have been uninitialized in the time it takes for</span>
<a href="#l78.217"></a><span id="l78.217" class="difflineplus">+    // the async callback to fire.  Use `_observers` as a proxy for uninit'd.</span>
<a href="#l78.218"></a><span id="l78.218" class="difflineplus">+    if (!this._observers) {</span>
<a href="#l78.219"></a><span id="l78.219" class="difflineplus">+      return;</span>
<a href="#l78.220"></a><span id="l78.220" class="difflineplus">+    }</span>
<a href="#l78.221"></a><span id="l78.221" class="difflineplus">+</span>
<a href="#l78.222"></a><span id="l78.222" class="difflineplus">+    let tweet = JSON.parse(aData);</span>
<a href="#l78.223"></a><span id="l78.223" class="difflineplus">+    // The OTR extension requires that the protocol not modify the message</span>
<a href="#l78.224"></a><span id="l78.224" class="difflineplus">+    // (see the notes at `imIOutgoingMessage`).  That's the contract we made.</span>
<a href="#l78.225"></a><span id="l78.225" class="difflineplus">+    // Unfortunately, Twitter trims tweets and substitutes links.</span>
<a href="#l78.226"></a><span id="l78.226" class="difflineplus">+    tweet.text = aMsg;</span>
<a href="#l78.227"></a><span id="l78.227" class="difflineplus">+    this.displayMessages([tweet]);</span>
<a href="#l78.228"></a><span id="l78.228" class="difflineplus">+  },</span>
<a href="#l78.229"></a><span id="l78.229" class="difflineplus">+  prepareForDisplaying(aMsg) {</span>
<a href="#l78.230"></a><span id="l78.230" class="difflineplus">+    if (!this._tweets.has(aMsg.id)) {</span>
<a href="#l78.231"></a><span id="l78.231" class="difflineplus">+      return;</span>
<a href="#l78.232"></a><span id="l78.232" class="difflineplus">+    }</span>
<a href="#l78.233"></a><span id="l78.233" class="difflineplus">+    let tweet = this._tweets.get(aMsg.id)._tweet;</span>
<a href="#l78.234"></a><span id="l78.234" class="difflineplus">+    this._tweets.delete(aMsg.id);</span>
<a href="#l78.235"></a><span id="l78.235" class="difflineplus">+</span>
<a href="#l78.236"></a><span id="l78.236" class="difflineplus">+    let text = aMsg.displayMessage;</span>
<a href="#l78.237"></a><span id="l78.237" class="difflineplus">+    let entities = {};</span>
<a href="#l78.238"></a><span id="l78.238" class="difflineplus">+</span>
<a href="#l78.239"></a><span id="l78.239" class="difflineplus">+    // Handle retweets: retweeted_status contains the object for the original</span>
<a href="#l78.240"></a><span id="l78.240" class="difflineplus">+    // tweet that is being retweeted.</span>
<a href="#l78.241"></a><span id="l78.241" class="difflineplus">+    // If the retweet prefix (&quot;RT @&lt;username&gt;: &quot;) causes the tweet to be over</span>
<a href="#l78.242"></a><span id="l78.242" class="difflineplus">+    // 140 characters, ellipses will be added. In this case, we want to get</span>
<a href="#l78.243"></a><span id="l78.243" class="difflineplus">+    // the FULL text from the original tweet and update the entities to match.</span>
<a href="#l78.244"></a><span id="l78.244" class="difflineplus">+    // Note: the truncated flag is not always set correctly by twitter, so we</span>
<a href="#l78.245"></a><span id="l78.245" class="difflineplus">+    // always make use of the original tweet.</span>
<a href="#l78.246"></a><span id="l78.246" class="difflineplus">+    if (&quot;retweeted_status&quot; in tweet) {</span>
<a href="#l78.247"></a><span id="l78.247" class="difflineplus">+      let retweet = tweet.retweeted_status;</span>
<a href="#l78.248"></a><span id="l78.248" class="difflineplus">+      let retweetText,</span>
<a href="#l78.249"></a><span id="l78.249" class="difflineplus">+        retweetEntities = {};</span>
<a href="#l78.250"></a><span id="l78.250" class="difflineplus">+</span>
<a href="#l78.251"></a><span id="l78.251" class="difflineplus">+      if (&quot;extended_tweet&quot; in retweet) {</span>
<a href="#l78.252"></a><span id="l78.252" class="difflineplus">+        // Note that if an extended tweet is retweeted, only the</span>
<a href="#l78.253"></a><span id="l78.253" class="difflineplus">+        // retweeted_status part will be extended, not the tweet itself.</span>
<a href="#l78.254"></a><span id="l78.254" class="difflineplus">+        let extended = retweet.extended_tweet;</span>
<a href="#l78.255"></a><span id="l78.255" class="difflineplus">+        retweetText = extended.full_text;</span>
<a href="#l78.256"></a><span id="l78.256" class="difflineplus">+        if (&quot;entities&quot; in extended) {</span>
<a href="#l78.257"></a><span id="l78.257" class="difflineplus">+          retweetEntities = extended.entities;</span>
<a href="#l78.258"></a><span id="l78.258" class="difflineplus">+        }</span>
<a href="#l78.259"></a><span id="l78.259" class="difflineplus">+      } else {</span>
<a href="#l78.260"></a><span id="l78.260" class="difflineplus">+        retweetText = retweet.text;</span>
<a href="#l78.261"></a><span id="l78.261" class="difflineplus">+        if (&quot;entities&quot; in retweet) {</span>
<a href="#l78.262"></a><span id="l78.262" class="difflineplus">+          retweetEntities = retweet.entities;</span>
<a href="#l78.263"></a><span id="l78.263" class="difflineplus">+        }</span>
<a href="#l78.264"></a><span id="l78.264" class="difflineplus">+      }</span>
<a href="#l78.265"></a><span id="l78.265" class="difflineplus">+</span>
<a href="#l78.266"></a><span id="l78.266" class="difflineplus">+      // We're going to take portions of the retweeted status and replace parts</span>
<a href="#l78.267"></a><span id="l78.267" class="difflineplus">+      // of the original tweet, the retweeted status prepends the original</span>
<a href="#l78.268"></a><span id="l78.268" class="difflineplus">+      // status with &quot;RT @&lt;username&gt;: &quot;, we need to keep the prefix.</span>
<a href="#l78.269"></a><span id="l78.269" class="difflineplus">+      // Note: this doesn't play nice with extensions that may have altered</span>
<a href="#l78.270"></a><span id="l78.270" class="difflineplus">+      // `text` to this point, but at least OTR doesn't act on `isChat`.</span>
<a href="#l78.271"></a><span id="l78.271" class="difflineplus">+      let offset = text.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l78.272"></a><span id="l78.272" class="difflineplus">+      text = text.slice(0, offset) + retweetText;</span>
<a href="#l78.273"></a><span id="l78.273" class="difflineplus">+</span>
<a href="#l78.274"></a><span id="l78.274" class="difflineplus">+      // Keep any entities that refer to the prefix (we can refer directly to</span>
<a href="#l78.275"></a><span id="l78.275" class="difflineplus">+      // the tweet for these since they are not edited).</span>
<a href="#l78.276"></a><span id="l78.276" class="difflineplus">+      if (&quot;entities&quot; in tweet) {</span>
<a href="#l78.277"></a><span id="l78.277" class="difflineplus">+        for (let type in tweet.entities) {</span>
<a href="#l78.278"></a><span id="l78.278" class="difflineplus">+          let filteredEntities = tweet.entities[type].filter(</span>
<a href="#l78.279"></a><span id="l78.279" class="difflineplus">+            e =&gt; e.indices[0] &lt; offset</span>
<a href="#l78.280"></a><span id="l78.280" class="difflineplus">+          );</span>
<a href="#l78.281"></a><span id="l78.281" class="difflineplus">+          if (filteredEntities.length) {</span>
<a href="#l78.282"></a><span id="l78.282" class="difflineplus">+            entities[type] = filteredEntities;</span>
<a href="#l78.283"></a><span id="l78.283" class="difflineplus">+          }</span>
<a href="#l78.284"></a><span id="l78.284" class="difflineplus">+        }</span>
<a href="#l78.285"></a><span id="l78.285" class="difflineplus">+      }</span>
<a href="#l78.286"></a><span id="l78.286" class="difflineplus">+</span>
<a href="#l78.287"></a><span id="l78.287" class="difflineplus">+      // Add the entities from the retweet (a copy of these must be made since</span>
<a href="#l78.288"></a><span id="l78.288" class="difflineplus">+      // they will be edited and we do not wish to change the tweet).</span>
<a href="#l78.289"></a><span id="l78.289" class="difflineplus">+      for (let type in retweetEntities) {</span>
<a href="#l78.290"></a><span id="l78.290" class="difflineplus">+        if (!(type in entities)) {</span>
<a href="#l78.291"></a><span id="l78.291" class="difflineplus">+          entities[type] = [];</span>
<a href="#l78.292"></a><span id="l78.292" class="difflineplus">+        }</span>
<a href="#l78.293"></a><span id="l78.293" class="difflineplus">+</span>
<a href="#l78.294"></a><span id="l78.294" class="difflineplus">+        // Append the entities from the original status.</span>
<a href="#l78.295"></a><span id="l78.295" class="difflineplus">+        entities[type] = entities[type].concat(</span>
<a href="#l78.296"></a><span id="l78.296" class="difflineplus">+          retweetEntities[type].map(function(aEntity) {</span>
<a href="#l78.297"></a><span id="l78.297" class="difflineplus">+            let entity = Object.create(aEntity);</span>
<a href="#l78.298"></a><span id="l78.298" class="difflineplus">+            // Add the offset to the indices to account for the prefix.</span>
<a href="#l78.299"></a><span id="l78.299" class="difflineplus">+            entity.indices = entity.indices.map(i =&gt; i + offset);</span>
<a href="#l78.300"></a><span id="l78.300" class="difflineplus">+            return entity;</span>
<a href="#l78.301"></a><span id="l78.301" class="difflineplus">+          })</span>
<a href="#l78.302"></a><span id="l78.302" class="difflineplus">+        );</span>
<a href="#l78.303"></a><span id="l78.303" class="difflineplus">+      }</span>
<a href="#l78.304"></a><span id="l78.304" class="difflineplus">+    } else if (&quot;extended_tweet&quot; in tweet) {</span>
<a href="#l78.305"></a><span id="l78.305" class="difflineplus">+      // Bare bones extended tweet handling.</span>
<a href="#l78.306"></a><span id="l78.306" class="difflineplus">+      let extended = tweet.extended_tweet;</span>
<a href="#l78.307"></a><span id="l78.307" class="difflineplus">+      text = extended.full_text;</span>
<a href="#l78.308"></a><span id="l78.308" class="difflineplus">+      if (&quot;entities&quot; in extended) {</span>
<a href="#l78.309"></a><span id="l78.309" class="difflineplus">+        entities = extended.entities;</span>
<a href="#l78.310"></a><span id="l78.310" class="difflineplus">+      }</span>
<a href="#l78.311"></a><span id="l78.311" class="difflineplus">+    } else if (&quot;entities&quot; in tweet) {</span>
<a href="#l78.312"></a><span id="l78.312" class="difflineplus">+      // For non-retweets, we just want to use the entities that are given.</span>
<a href="#l78.313"></a><span id="l78.313" class="difflineplus">+      entities = tweet.entities;</span>
<a href="#l78.314"></a><span id="l78.314" class="difflineplus">+    }</span>
<a href="#l78.315"></a><span id="l78.315" class="difflineplus">+</span>
<a href="#l78.316"></a><span id="l78.316" class="difflineplus">+    this._account.LOG(&quot;Tweet: &quot; + text);</span>
<a href="#l78.317"></a><span id="l78.317" class="difflineplus">+</span>
<a href="#l78.318"></a><span id="l78.318" class="difflineplus">+    aMsg.displayMessage = twttr.txt.autoLink(text, {</span>
<a href="#l78.319"></a><span id="l78.319" class="difflineplus">+      usernameClass: &quot;ib-person&quot;,</span>
<a href="#l78.320"></a><span id="l78.320" class="difflineplus">+      usernameIncludeSymbol: true,</span>
<a href="#l78.321"></a><span id="l78.321" class="difflineplus">+      // Pass in the url entities so the t.co links are replaced.</span>
<a href="#l78.322"></a><span id="l78.322" class="difflineplus">+      urlEntities: tweet.entities.urls.map(function(u) {</span>
<a href="#l78.323"></a><span id="l78.323" class="difflineplus">+        let o = Object.assign(u);</span>
<a href="#l78.324"></a><span id="l78.324" class="difflineplus">+        // But remove the indices so they apply in the face of modifications.</span>
<a href="#l78.325"></a><span id="l78.325" class="difflineplus">+        delete o.indices;</span>
<a href="#l78.326"></a><span id="l78.326" class="difflineplus">+        return o;</span>
<a href="#l78.327"></a><span id="l78.327" class="difflineplus">+      }),</span>
<a href="#l78.328"></a><span id="l78.328" class="difflineplus">+    });</span>
<a href="#l78.329"></a><span id="l78.329" class="difflineplus">+</span>
<a href="#l78.330"></a><span id="l78.330" class="difflineplus">+    GenericConversationPrototype.prepareForDisplaying.apply(this, arguments);</span>
<a href="#l78.331"></a><span id="l78.331" class="difflineplus">+  },</span>
<a href="#l78.332"></a><span id="l78.332" class="difflineplus">+  displayTweet(aTweet, aUser) {</span>
<a href="#l78.333"></a><span id="l78.333" class="difflineplus">+    let name = aUser.screen_name;</span>
<a href="#l78.334"></a><span id="l78.334" class="difflineplus">+</span>
<a href="#l78.335"></a><span id="l78.335" class="difflineplus">+    let flags = name == this.nick ? { outgoing: true } : { incoming: true };</span>
<a href="#l78.336"></a><span id="l78.336" class="difflineplus">+    flags.time = Math.floor(new Date(aTweet.created_at) / 1000);</span>
<a href="#l78.337"></a><span id="l78.337" class="difflineplus">+    flags._iconURL = aUser.profile_image_url;</span>
<a href="#l78.338"></a><span id="l78.338" class="difflineplus">+    if (aTweet.delayed) {</span>
<a href="#l78.339"></a><span id="l78.339" class="difflineplus">+      flags.delayed = true;</span>
<a href="#l78.340"></a><span id="l78.340" class="difflineplus">+    }</span>
<a href="#l78.341"></a><span id="l78.341" class="difflineplus">+    if (</span>
<a href="#l78.342"></a><span id="l78.342" class="difflineplus">+      aTweet.entities &amp;&amp;</span>
<a href="#l78.343"></a><span id="l78.343" class="difflineplus">+      aTweet.entities.user_mentions &amp;&amp;</span>
<a href="#l78.344"></a><span id="l78.344" class="difflineplus">+      Array.isArray(aTweet.entities.user_mentions) &amp;&amp;</span>
<a href="#l78.345"></a><span id="l78.345" class="difflineplus">+      aTweet.entities.user_mentions.some(</span>
<a href="#l78.346"></a><span id="l78.346" class="difflineplus">+        mention =&gt; mention.screen_name == this.nick</span>
<a href="#l78.347"></a><span id="l78.347" class="difflineplus">+      )</span>
<a href="#l78.348"></a><span id="l78.348" class="difflineplus">+    ) {</span>
<a href="#l78.349"></a><span id="l78.349" class="difflineplus">+      flags.containsNick = true;</span>
<a href="#l78.350"></a><span id="l78.350" class="difflineplus">+    }</span>
<a href="#l78.351"></a><span id="l78.351" class="difflineplus">+</span>
<a href="#l78.352"></a><span id="l78.352" class="difflineplus">+    let tweet = new Tweet(aTweet, name, aTweet.text, flags);</span>
<a href="#l78.353"></a><span id="l78.353" class="difflineplus">+    this._tweets.set(tweet.id, tweet);</span>
<a href="#l78.354"></a><span id="l78.354" class="difflineplus">+    tweet.conversation = this;</span>
<a href="#l78.355"></a><span id="l78.355" class="difflineplus">+  },</span>
<a href="#l78.356"></a><span id="l78.356" class="difflineplus">+  _parseError(aData) {</span>
<a href="#l78.357"></a><span id="l78.357" class="difflineplus">+    let error = &quot;&quot;;</span>
<a href="#l78.358"></a><span id="l78.358" class="difflineplus">+    try {</span>
<a href="#l78.359"></a><span id="l78.359" class="difflineplus">+      let data = JSON.parse(aData);</span>
<a href="#l78.360"></a><span id="l78.360" class="difflineplus">+      if (&quot;error&quot; in data) {</span>
<a href="#l78.361"></a><span id="l78.361" class="difflineplus">+        error = data.error;</span>
<a href="#l78.362"></a><span id="l78.362" class="difflineplus">+      } else if (&quot;errors&quot; in data) {</span>
<a href="#l78.363"></a><span id="l78.363" class="difflineplus">+        error = data.errors[0].message;</span>
<a href="#l78.364"></a><span id="l78.364" class="difflineplus">+      }</span>
<a href="#l78.365"></a><span id="l78.365" class="difflineplus">+      if (error) {</span>
<a href="#l78.366"></a><span id="l78.366" class="difflineplus">+        error = &quot;(&quot; + error + &quot;)&quot;;</span>
<a href="#l78.367"></a><span id="l78.367" class="difflineplus">+      }</span>
<a href="#l78.368"></a><span id="l78.368" class="difflineplus">+    } catch (e) {}</span>
<a href="#l78.369"></a><span id="l78.369" class="difflineplus">+    return error;</span>
<a href="#l78.370"></a><span id="l78.370" class="difflineplus">+  },</span>
<a href="#l78.371"></a><span id="l78.371" class="difflineplus">+  getNormalizedChatBuddyName: aNick =&gt; aNick.replace(/^@/, &quot;&quot;),</span>
<a href="#l78.372"></a><span id="l78.372" class="difflineplus">+};</span>
<a href="#l78.373"></a><span id="l78.373" class="difflineplus">+</span>
<a href="#l78.374"></a><span id="l78.374" class="difflineplus">+function TimelineConversation(aAccount) {</span>
<a href="#l78.375"></a><span id="l78.375" class="difflineplus">+  this._init(aAccount);</span>
<a href="#l78.376"></a><span id="l78.376" class="difflineplus">+  this._ensureParticipantExists(aAccount.name);</span>
<a href="#l78.377"></a><span id="l78.377" class="difflineplus">+  // We need the screen names for the IDs in _friends, but _userInfo is</span>
<a href="#l78.378"></a><span id="l78.378" class="difflineplus">+  // indexed by name, so we build an ID -&gt; name map.</span>
<a href="#l78.379"></a><span id="l78.379" class="difflineplus">+  let entries = [];</span>
<a href="#l78.380"></a><span id="l78.380" class="difflineplus">+  for (let [name, userInfo] of aAccount._userInfo) {</span>
<a href="#l78.381"></a><span id="l78.381" class="difflineplus">+    entries.push([userInfo.id_str, name]);</span>
<a href="#l78.382"></a><span id="l78.382" class="difflineplus">+  }</span>
<a href="#l78.383"></a><span id="l78.383" class="difflineplus">+  let names = new Map(entries);</span>
<a href="#l78.384"></a><span id="l78.384" class="difflineplus">+  for (let id_str of aAccount._friends) {</span>
<a href="#l78.385"></a><span id="l78.385" class="difflineplus">+    this._ensureParticipantExists(names.get(id_str));</span>
<a href="#l78.386"></a><span id="l78.386" class="difflineplus">+  }</span>
<a href="#l78.387"></a><span id="l78.387" class="difflineplus">+</span>
<a href="#l78.388"></a><span id="l78.388" class="difflineplus">+  // If the user's info has already been received, update the timeline topic.</span>
<a href="#l78.389"></a><span id="l78.389" class="difflineplus">+  if (aAccount._userInfo.has(aAccount.name)) {</span>
<a href="#l78.390"></a><span id="l78.390" class="difflineplus">+    let userInfo = aAccount._userInfo.get(aAccount.name);</span>
<a href="#l78.391"></a><span id="l78.391" class="difflineplus">+    if (&quot;description&quot; in userInfo) {</span>
<a href="#l78.392"></a><span id="l78.392" class="difflineplus">+      this.setTopic(userInfo.description, aAccount.name, true);</span>
<a href="#l78.393"></a><span id="l78.393" class="difflineplus">+    }</span>
<a href="#l78.394"></a><span id="l78.394" class="difflineplus">+  }</span>
<a href="#l78.395"></a><span id="l78.395" class="difflineplus">+</span>
<a href="#l78.396"></a><span id="l78.396" class="difflineplus">+  // Store messages by message id.</span>
<a href="#l78.397"></a><span id="l78.397" class="difflineplus">+  this._tweets = new Map();</span>
<a href="#l78.398"></a><span id="l78.398" class="difflineplus">+}</span>
<a href="#l78.399"></a><span id="l78.399" class="difflineplus">+TimelineConversation.prototype = {</span>
<a href="#l78.400"></a><span id="l78.400" class="difflineplus">+  __proto__: GenericConvChatPrototype,</span>
<a href="#l78.401"></a><span id="l78.401" class="difflineplus">+  unInit() {</span>
<a href="#l78.402"></a><span id="l78.402" class="difflineplus">+    delete this._account._timeline;</span>
<a href="#l78.403"></a><span id="l78.403" class="difflineplus">+    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l78.404"></a><span id="l78.404" class="difflineplus">+  },</span>
<a href="#l78.405"></a><span id="l78.405" class="difflineplus">+  inReplyToStatusId: null,</span>
<a href="#l78.406"></a><span id="l78.406" class="difflineplus">+  startReply(aTweet) {</span>
<a href="#l78.407"></a><span id="l78.407" class="difflineplus">+    this.inReplyToStatusId = aTweet.id_str;</span>
<a href="#l78.408"></a><span id="l78.408" class="difflineplus">+    let entities = aTweet.entities;</span>
<a href="#l78.409"></a><span id="l78.409" class="difflineplus">+</span>
<a href="#l78.410"></a><span id="l78.410" class="difflineplus">+    // Twitter replies go to all the users mentioned in the tweet.</span>
<a href="#l78.411"></a><span id="l78.411" class="difflineplus">+    let nicks = [aTweet.user.screen_name];</span>
<a href="#l78.412"></a><span id="l78.412" class="difflineplus">+    if (&quot;user_mentions&quot; in entities &amp;&amp; Array.isArray(entities.user_mentions)) {</span>
<a href="#l78.413"></a><span id="l78.413" class="difflineplus">+      nicks = nicks.concat(entities.user_mentions.map(um =&gt; um.screen_name));</span>
<a href="#l78.414"></a><span id="l78.414" class="difflineplus">+    }</span>
<a href="#l78.415"></a><span id="l78.415" class="difflineplus">+    // Ignore duplicates and the user's nick.</span>
<a href="#l78.416"></a><span id="l78.416" class="difflineplus">+    let prompt =</span>
<a href="#l78.417"></a><span id="l78.417" class="difflineplus">+      nicks</span>
<a href="#l78.418"></a><span id="l78.418" class="difflineplus">+        .filter(function(aNick, aPos) {</span>
<a href="#l78.419"></a><span id="l78.419" class="difflineplus">+          return nicks.indexOf(aNick) == aPos &amp;&amp; aNick != this._account.name;</span>
<a href="#l78.420"></a><span id="l78.420" class="difflineplus">+        }, this)</span>
<a href="#l78.421"></a><span id="l78.421" class="difflineplus">+        .map(aNick =&gt; &quot;@&quot; + aNick)</span>
<a href="#l78.422"></a><span id="l78.422" class="difflineplus">+        .join(&quot; &quot;) + &quot; &quot;;</span>
<a href="#l78.423"></a><span id="l78.423" class="difflineplus">+</span>
<a href="#l78.424"></a><span id="l78.424" class="difflineplus">+    this.notifyObservers(null, &quot;replying-to-prompt&quot;, prompt);</span>
<a href="#l78.425"></a><span id="l78.425" class="difflineplus">+    this.notifyObservers(</span>
<a href="#l78.426"></a><span id="l78.426" class="difflineplus">+      null,</span>
<a href="#l78.427"></a><span id="l78.427" class="difflineplus">+      &quot;status-text-changed&quot;,</span>
<a href="#l78.428"></a><span id="l78.428" class="difflineplus">+      _(&quot;replyingToStatusText&quot;, aTweet.text)</span>
<a href="#l78.429"></a><span id="l78.429" class="difflineplus">+    );</span>
<a href="#l78.430"></a><span id="l78.430" class="difflineplus">+  },</span>
<a href="#l78.431"></a><span id="l78.431" class="difflineplus">+  reTweet(aTweet) {</span>
<a href="#l78.432"></a><span id="l78.432" class="difflineplus">+    this._account.reTweet(</span>
<a href="#l78.433"></a><span id="l78.433" class="difflineplus">+      aTweet,</span>
<a href="#l78.434"></a><span id="l78.434" class="difflineplus">+      null,</span>
<a href="#l78.435"></a><span id="l78.435" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l78.436"></a><span id="l78.436" class="difflineplus">+        this.systemMessage(</span>
<a href="#l78.437"></a><span id="l78.437" class="difflineplus">+          _(&quot;error.retweet&quot;, this._parseError(aData), aTweet.text),</span>
<a href="#l78.438"></a><span id="l78.438" class="difflineplus">+          true</span>
<a href="#l78.439"></a><span id="l78.439" class="difflineplus">+        );</span>
<a href="#l78.440"></a><span id="l78.440" class="difflineplus">+      },</span>
<a href="#l78.441"></a><span id="l78.441" class="difflineplus">+      this</span>
<a href="#l78.442"></a><span id="l78.442" class="difflineplus">+    );</span>
<a href="#l78.443"></a><span id="l78.443" class="difflineplus">+  },</span>
<a href="#l78.444"></a><span id="l78.444" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l78.445"></a><span id="l78.445" class="difflineplus">+    let parsed = twttr.txt.parseTweet(aMsg);</span>
<a href="#l78.446"></a><span id="l78.446" class="difflineplus">+    if (!parsed.valid) {</span>
<a href="#l78.447"></a><span id="l78.447" class="difflineplus">+      this.systemMessage(_(&quot;error.tooLong&quot;), true);</span>
<a href="#l78.448"></a><span id="l78.448" class="difflineplus">+      throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l78.449"></a><span id="l78.449" class="difflineplus">+    }</span>
<a href="#l78.450"></a><span id="l78.450" class="difflineplus">+    this._account.tweet(</span>
<a href="#l78.451"></a><span id="l78.451" class="difflineplus">+      aMsg,</span>
<a href="#l78.452"></a><span id="l78.452" class="difflineplus">+      this.inReplyToStatusId,</span>
<a href="#l78.453"></a><span id="l78.453" class="difflineplus">+      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l78.454"></a><span id="l78.454" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l78.455"></a><span id="l78.455" class="difflineplus">+        let error = this._parseError(aData);</span>
<a href="#l78.456"></a><span id="l78.456" class="difflineplus">+        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l78.457"></a><span id="l78.457" class="difflineplus">+      },</span>
<a href="#l78.458"></a><span id="l78.458" class="difflineplus">+      this</span>
<a href="#l78.459"></a><span id="l78.459" class="difflineplus">+    );</span>
<a href="#l78.460"></a><span id="l78.460" class="difflineplus">+    this.sendTyping(&quot;&quot;);</span>
<a href="#l78.461"></a><span id="l78.461" class="difflineplus">+  },</span>
<a href="#l78.462"></a><span id="l78.462" class="difflineplus">+  like(aTweet, aRemoveLike = false) {</span>
<a href="#l78.463"></a><span id="l78.463" class="difflineplus">+    this._account.like(</span>
<a href="#l78.464"></a><span id="l78.464" class="difflineplus">+      aTweet,</span>
<a href="#l78.465"></a><span id="l78.465" class="difflineplus">+      aRemoveLike,</span>
<a href="#l78.466"></a><span id="l78.466" class="difflineplus">+      function() {</span>
<a href="#l78.467"></a><span id="l78.467" class="difflineplus">+        aTweet.favorited = !aRemoveLike;</span>
<a href="#l78.468"></a><span id="l78.468" class="difflineplus">+      },</span>
<a href="#l78.469"></a><span id="l78.469" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l78.470"></a><span id="l78.470" class="difflineplus">+        const messageName = aRemoveLike ? &quot;unlike&quot; : &quot;like&quot;;</span>
<a href="#l78.471"></a><span id="l78.471" class="difflineplus">+        this.systemMessage(</span>
<a href="#l78.472"></a><span id="l78.472" class="difflineplus">+          _(&quot;error.&quot; + messageName, this.parseError(aData), aTweet.text),</span>
<a href="#l78.473"></a><span id="l78.473" class="difflineplus">+          true</span>
<a href="#l78.474"></a><span id="l78.474" class="difflineplus">+        );</span>
<a href="#l78.475"></a><span id="l78.475" class="difflineplus">+      },</span>
<a href="#l78.476"></a><span id="l78.476" class="difflineplus">+      this</span>
<a href="#l78.477"></a><span id="l78.477" class="difflineplus">+    );</span>
<a href="#l78.478"></a><span id="l78.478" class="difflineplus">+  },</span>
<a href="#l78.479"></a><span id="l78.479" class="difflineplus">+  sendTyping(aString) {</span>
<a href="#l78.480"></a><span id="l78.480" class="difflineplus">+    let maxlen = twttr.txt.configs.defaults.maxWeightedTweetLength;</span>
<a href="#l78.481"></a><span id="l78.481" class="difflineplus">+    if (aString.length == 0 &amp;&amp; this.inReplyToStatusId) {</span>
<a href="#l78.482"></a><span id="l78.482" class="difflineplus">+      delete this.inReplyToStatusId;</span>
<a href="#l78.483"></a><span id="l78.483" class="difflineplus">+      this.notifyObservers(null, &quot;status-text-changed&quot;);</span>
<a href="#l78.484"></a><span id="l78.484" class="difflineplus">+      return maxlen;</span>
<a href="#l78.485"></a><span id="l78.485" class="difflineplus">+    }</span>
<a href="#l78.486"></a><span id="l78.486" class="difflineplus">+    return maxlen - this.getTweetLength(aString);</span>
<a href="#l78.487"></a><span id="l78.487" class="difflineplus">+  },</span>
<a href="#l78.488"></a><span id="l78.488" class="difflineplus">+  displayMessages(aMessages) {</span>
<a href="#l78.489"></a><span id="l78.489" class="difflineplus">+    let account = this._account;</span>
<a href="#l78.490"></a><span id="l78.490" class="difflineplus">+    let lastMsgId = account._lastMsgId;</span>
<a href="#l78.491"></a><span id="l78.491" class="difflineplus">+    for (let tweet of aMessages) {</span>
<a href="#l78.492"></a><span id="l78.492" class="difflineplus">+      if (</span>
<a href="#l78.493"></a><span id="l78.493" class="difflineplus">+        !(&quot;user&quot; in tweet) ||</span>
<a href="#l78.494"></a><span id="l78.494" class="difflineplus">+        !(&quot;text&quot; in tweet) ||</span>
<a href="#l78.495"></a><span id="l78.495" class="difflineplus">+        !(&quot;id_str&quot; in tweet) ||</span>
<a href="#l78.496"></a><span id="l78.496" class="difflineplus">+        account._knownMessageIds.has(tweet.id_str)</span>
<a href="#l78.497"></a><span id="l78.497" class="difflineplus">+      ) {</span>
<a href="#l78.498"></a><span id="l78.498" class="difflineplus">+        continue;</span>
<a href="#l78.499"></a><span id="l78.499" class="difflineplus">+      }</span>
<a href="#l78.500"></a><span id="l78.500" class="difflineplus">+      let id = tweet.id_str;</span>
<a href="#l78.501"></a><span id="l78.501" class="difflineplus">+      // Update the last known message.</span>
<a href="#l78.502"></a><span id="l78.502" class="difflineplus">+      // Compare the length of the ids first, and then the text.</span>
<a href="#l78.503"></a><span id="l78.503" class="difflineplus">+      // This avoids converting tweet ids into rounded numbers.</span>
<a href="#l78.504"></a><span id="l78.504" class="difflineplus">+      if (</span>
<a href="#l78.505"></a><span id="l78.505" class="difflineplus">+        id.length &gt; lastMsgId.length ||</span>
<a href="#l78.506"></a><span id="l78.506" class="difflineplus">+        (id.length == lastMsgId.length &amp;&amp; id &gt; lastMsgId)</span>
<a href="#l78.507"></a><span id="l78.507" class="difflineplus">+      ) {</span>
<a href="#l78.508"></a><span id="l78.508" class="difflineplus">+        lastMsgId = id;</span>
<a href="#l78.509"></a><span id="l78.509" class="difflineplus">+      }</span>
<a href="#l78.510"></a><span id="l78.510" class="difflineplus">+      account._knownMessageIds.add(id);</span>
<a href="#l78.511"></a><span id="l78.511" class="difflineplus">+      account.setUserInfo(tweet.user);</span>
<a href="#l78.512"></a><span id="l78.512" class="difflineplus">+      this._ensureParticipantExists(tweet.user.screen_name);</span>
<a href="#l78.513"></a><span id="l78.513" class="difflineplus">+      this.displayTweet(tweet, tweet.user);</span>
<a href="#l78.514"></a><span id="l78.514" class="difflineplus">+    }</span>
<a href="#l78.515"></a><span id="l78.515" class="difflineplus">+    if (lastMsgId != account._lastMsgId) {</span>
<a href="#l78.516"></a><span id="l78.516" class="difflineplus">+      account._lastMsgId = lastMsgId;</span>
<a href="#l78.517"></a><span id="l78.517" class="difflineplus">+      account.prefs.setCharPref(&quot;lastMessageId&quot;, account._lastMsgId);</span>
<a href="#l78.518"></a><span id="l78.518" class="difflineplus">+    }</span>
<a href="#l78.519"></a><span id="l78.519" class="difflineplus">+  },</span>
<a href="#l78.520"></a><span id="l78.520" class="difflineplus">+  _ensureParticipantExists(aNick) {</span>
<a href="#l78.521"></a><span id="l78.521" class="difflineplus">+    if (this._participants.has(aNick)) {</span>
<a href="#l78.522"></a><span id="l78.522" class="difflineplus">+      return;</span>
<a href="#l78.523"></a><span id="l78.523" class="difflineplus">+    }</span>
<a href="#l78.524"></a><span id="l78.524" class="difflineplus">+</span>
<a href="#l78.525"></a><span id="l78.525" class="difflineplus">+    let chatBuddy = new ChatBuddy(aNick, this._account);</span>
<a href="#l78.526"></a><span id="l78.526" class="difflineplus">+    this._participants.set(aNick, chatBuddy);</span>
<a href="#l78.527"></a><span id="l78.527" class="difflineplus">+    this.notifyObservers(new nsSimpleEnumerator([chatBuddy]), &quot;chat-buddy-add&quot;);</span>
<a href="#l78.528"></a><span id="l78.528" class="difflineplus">+  },</span>
<a href="#l78.529"></a><span id="l78.529" class="difflineplus">+  get name() {</span>
<a href="#l78.530"></a><span id="l78.530" class="difflineplus">+    return this.nick + &quot; timeline&quot;;</span>
<a href="#l78.531"></a><span id="l78.531" class="difflineplus">+  },</span>
<a href="#l78.532"></a><span id="l78.532" class="difflineplus">+  get title() {</span>
<a href="#l78.533"></a><span id="l78.533" class="difflineplus">+    return _(&quot;timeline&quot;, this.nick);</span>
<a href="#l78.534"></a><span id="l78.534" class="difflineplus">+  },</span>
<a href="#l78.535"></a><span id="l78.535" class="difflineplus">+  get nick() {</span>
<a href="#l78.536"></a><span id="l78.536" class="difflineplus">+    return this._account.name;</span>
<a href="#l78.537"></a><span id="l78.537" class="difflineplus">+  },</span>
<a href="#l78.538"></a><span id="l78.538" class="difflineplus">+  set nick(aNick) {},</span>
<a href="#l78.539"></a><span id="l78.539" class="difflineplus">+  get topicSettable() {</span>
<a href="#l78.540"></a><span id="l78.540" class="difflineplus">+    return this.nick == this._account.name;</span>
<a href="#l78.541"></a><span id="l78.541" class="difflineplus">+  },</span>
<a href="#l78.542"></a><span id="l78.542" class="difflineplus">+  get topic() {</span>
<a href="#l78.543"></a><span id="l78.543" class="difflineplus">+    return this._topic;</span>
<a href="#l78.544"></a><span id="l78.544" class="difflineplus">+  }, // can't add a setter without redefining the getter</span>
<a href="#l78.545"></a><span id="l78.545" class="difflineplus">+  set topic(aTopic) {</span>
<a href="#l78.546"></a><span id="l78.546" class="difflineplus">+    if (this.topicSettable) {</span>
<a href="#l78.547"></a><span id="l78.547" class="difflineplus">+      this._account.setUserDescription(aTopic);</span>
<a href="#l78.548"></a><span id="l78.548" class="difflineplus">+    }</span>
<a href="#l78.549"></a><span id="l78.549" class="difflineplus">+  },</span>
<a href="#l78.550"></a><span id="l78.550" class="difflineplus">+};</span>
<a href="#l78.551"></a><span id="l78.551" class="difflineplus">+Object.assign(TimelineConversation.prototype, GenericTwitterConversation);</span>
<a href="#l78.552"></a><span id="l78.552" class="difflineplus">+</span>
<a href="#l78.553"></a><span id="l78.553" class="difflineplus">+function DirectMessageConversation(aAccount, aName) {</span>
<a href="#l78.554"></a><span id="l78.554" class="difflineplus">+  this._init(aAccount, aName);</span>
<a href="#l78.555"></a><span id="l78.555" class="difflineplus">+</span>
<a href="#l78.556"></a><span id="l78.556" class="difflineplus">+  // Store messages by message id.</span>
<a href="#l78.557"></a><span id="l78.557" class="difflineplus">+  this._tweets = new Map();</span>
<a href="#l78.558"></a><span id="l78.558" class="difflineplus">+}</span>
<a href="#l78.559"></a><span id="l78.559" class="difflineplus">+DirectMessageConversation.prototype = {</span>
<a href="#l78.560"></a><span id="l78.560" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l78.561"></a><span id="l78.561" class="difflineplus">+  sendMsg(aMsg) {</span>
<a href="#l78.562"></a><span id="l78.562" class="difflineplus">+    this._account.directMessage(</span>
<a href="#l78.563"></a><span id="l78.563" class="difflineplus">+      aMsg,</span>
<a href="#l78.564"></a><span id="l78.564" class="difflineplus">+      this.name,</span>
<a href="#l78.565"></a><span id="l78.565" class="difflineplus">+      this.onSentCallback.bind(this, aMsg),</span>
<a href="#l78.566"></a><span id="l78.566" class="difflineplus">+      function(aException, aData) {</span>
<a href="#l78.567"></a><span id="l78.567" class="difflineplus">+        let error = this._parseError(aData);</span>
<a href="#l78.568"></a><span id="l78.568" class="difflineplus">+        this.systemMessage(_(&quot;error.general&quot;, error, aMsg), true);</span>
<a href="#l78.569"></a><span id="l78.569" class="difflineplus">+      },</span>
<a href="#l78.570"></a><span id="l78.570" class="difflineplus">+      this</span>
<a href="#l78.571"></a><span id="l78.571" class="difflineplus">+    );</span>
<a href="#l78.572"></a><span id="l78.572" class="difflineplus">+  },</span>
<a href="#l78.573"></a><span id="l78.573" class="difflineplus">+  displayMessages(aMessages) {</span>
<a href="#l78.574"></a><span id="l78.574" class="difflineplus">+    let account = this._account;</span>
<a href="#l78.575"></a><span id="l78.575" class="difflineplus">+    for (let tweet of aMessages) {</span>
<a href="#l78.576"></a><span id="l78.576" class="difflineplus">+      if (</span>
<a href="#l78.577"></a><span id="l78.577" class="difflineplus">+        !(&quot;sender&quot; in tweet) ||</span>
<a href="#l78.578"></a><span id="l78.578" class="difflineplus">+        !(&quot;recipient&quot; in tweet) ||</span>
<a href="#l78.579"></a><span id="l78.579" class="difflineplus">+        !(&quot;text&quot; in tweet) ||</span>
<a href="#l78.580"></a><span id="l78.580" class="difflineplus">+        !(&quot;id_str&quot; in tweet)</span>
<a href="#l78.581"></a><span id="l78.581" class="difflineplus">+      ) {</span>
<a href="#l78.582"></a><span id="l78.582" class="difflineplus">+        continue;</span>
<a href="#l78.583"></a><span id="l78.583" class="difflineplus">+      }</span>
<a href="#l78.584"></a><span id="l78.584" class="difflineplus">+      account.setUserInfo(tweet.sender);</span>
<a href="#l78.585"></a><span id="l78.585" class="difflineplus">+      account.setUserInfo(tweet.recipient);</span>
<a href="#l78.586"></a><span id="l78.586" class="difflineplus">+      this.displayTweet(tweet, tweet.sender);</span>
<a href="#l78.587"></a><span id="l78.587" class="difflineplus">+    }</span>
<a href="#l78.588"></a><span id="l78.588" class="difflineplus">+  },</span>
<a href="#l78.589"></a><span id="l78.589" class="difflineplus">+  unInit() {</span>
<a href="#l78.590"></a><span id="l78.590" class="difflineplus">+    this._account.removeConversation(this.name);</span>
<a href="#l78.591"></a><span id="l78.591" class="difflineplus">+    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l78.592"></a><span id="l78.592" class="difflineplus">+  },</span>
<a href="#l78.593"></a><span id="l78.593" class="difflineplus">+  get nick() {</span>
<a href="#l78.594"></a><span id="l78.594" class="difflineplus">+    return this._account.name;</span>
<a href="#l78.595"></a><span id="l78.595" class="difflineplus">+  },</span>
<a href="#l78.596"></a><span id="l78.596" class="difflineplus">+  set nick(aNick) {},</span>
<a href="#l78.597"></a><span id="l78.597" class="difflineplus">+};</span>
<a href="#l78.598"></a><span id="l78.598" class="difflineplus">+Object.assign(DirectMessageConversation.prototype, GenericTwitterConversation);</span>
<a href="#l78.599"></a><span id="l78.599" class="difflineplus">+</span>
<a href="#l78.600"></a><span id="l78.600" class="difflineplus">+function Account(aProtocol, aImAccount) {</span>
<a href="#l78.601"></a><span id="l78.601" class="difflineplus">+  this._init(aProtocol, aImAccount);</span>
<a href="#l78.602"></a><span id="l78.602" class="difflineplus">+  this._knownMessageIds = new Set();</span>
<a href="#l78.603"></a><span id="l78.603" class="difflineplus">+  this._userInfo = new Map();</span>
<a href="#l78.604"></a><span id="l78.604" class="difflineplus">+  this._friends = new Set();</span>
<a href="#l78.605"></a><span id="l78.605" class="difflineplus">+  // Contains just `DirectMessageConversation`s</span>
<a href="#l78.606"></a><span id="l78.606" class="difflineplus">+  this._conversations = new Map();</span>
<a href="#l78.607"></a><span id="l78.607" class="difflineplus">+}</span>
<a href="#l78.608"></a><span id="l78.608" class="difflineplus">+Account.prototype = {</span>
<a href="#l78.609"></a><span id="l78.609" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l78.610"></a><span id="l78.610" class="difflineplus">+</span>
<a href="#l78.611"></a><span id="l78.611" class="difflineplus">+  // The correct normalization for twitter would be just toLowerCase().</span>
<a href="#l78.612"></a><span id="l78.612" class="difflineplus">+  // Unfortunately, for backwards compatibility we retain this normalization,</span>
<a href="#l78.613"></a><span id="l78.613" class="difflineplus">+  // which can cause edge cases for usernames with underscores.</span>
<a href="#l78.614"></a><span id="l78.614" class="difflineplus">+  normalize: aString =&gt; aString.replace(/[^a-z0-9]/gi, &quot;&quot;).toLowerCase(),</span>
<a href="#l78.615"></a><span id="l78.615" class="difflineplus">+</span>
<a href="#l78.616"></a><span id="l78.616" class="difflineplus">+  consumerKey: Services.prefs.getCharPref(&quot;chat.twitter.consumerKey&quot;),</span>
<a href="#l78.617"></a><span id="l78.617" class="difflineplus">+  consumerSecret: Services.prefs.getCharPref(&quot;chat.twitter.consumerSecret&quot;),</span>
<a href="#l78.618"></a><span id="l78.618" class="difflineplus">+  completionURI: &quot;http://oauthcallback.local/&quot;,</span>
<a href="#l78.619"></a><span id="l78.619" class="difflineplus">+  baseURI: &quot;https://api.twitter.com/&quot;,</span>
<a href="#l78.620"></a><span id="l78.620" class="difflineplus">+  _lastMsgId: &quot;&quot;,</span>
<a href="#l78.621"></a><span id="l78.621" class="difflineplus">+</span>
<a href="#l78.622"></a><span id="l78.622" class="difflineplus">+  // Use this to keep track of the pending timeline requests. We attempt to fetch</span>
<a href="#l78.623"></a><span id="l78.623" class="difflineplus">+  // home_timeline, @ mentions and tracked keywords (i.e. 3 timelines)</span>
<a href="#l78.624"></a><span id="l78.624" class="difflineplus">+  _pendingRequests: [],</span>
<a href="#l78.625"></a><span id="l78.625" class="difflineplus">+  _timelineBuffer: [],</span>
<a href="#l78.626"></a><span id="l78.626" class="difflineplus">+  _timelineAuthError: 0,</span>
<a href="#l78.627"></a><span id="l78.627" class="difflineplus">+</span>
<a href="#l78.628"></a><span id="l78.628" class="difflineplus">+  token: &quot;&quot;,</span>
<a href="#l78.629"></a><span id="l78.629" class="difflineplus">+  tokenSecret: &quot;&quot;,</span>
<a href="#l78.630"></a><span id="l78.630" class="difflineplus">+  connect() {</span>
<a href="#l78.631"></a><span id="l78.631" class="difflineplus">+    if (this.connected || this.connecting) {</span>
<a href="#l78.632"></a><span id="l78.632" class="difflineplus">+      return;</span>
<a href="#l78.633"></a><span id="l78.633" class="difflineplus">+    }</span>
<a href="#l78.634"></a><span id="l78.634" class="difflineplus">+</span>
<a href="#l78.635"></a><span id="l78.635" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l78.636"></a><span id="l78.636" class="difflineplus">+</span>
<a href="#l78.637"></a><span id="l78.637" class="difflineplus">+    // Read the OAuth token from the prefs</span>
<a href="#l78.638"></a><span id="l78.638" class="difflineplus">+    let prefValue = {};</span>
<a href="#l78.639"></a><span id="l78.639" class="difflineplus">+    try {</span>
<a href="#l78.640"></a><span id="l78.640" class="difflineplus">+      prefValue = JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l78.641"></a><span id="l78.641" class="difflineplus">+    } catch (e) {}</span>
<a href="#l78.642"></a><span id="l78.642" class="difflineplus">+    if (prefValue.hasOwnProperty(this.consumerKey)) {</span>
<a href="#l78.643"></a><span id="l78.643" class="difflineplus">+      let result = prefValue[this.consumerKey];</span>
<a href="#l78.644"></a><span id="l78.644" class="difflineplus">+      this.token = result.oauth_token;</span>
<a href="#l78.645"></a><span id="l78.645" class="difflineplus">+      this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l78.646"></a><span id="l78.646" class="difflineplus">+      if (!this.fixAccountName(result)) {</span>
<a href="#l78.647"></a><span id="l78.647" class="difflineplus">+        return;</span>
<a href="#l78.648"></a><span id="l78.648" class="difflineplus">+      }</span>
<a href="#l78.649"></a><span id="l78.649" class="difflineplus">+    }</span>
<a href="#l78.650"></a><span id="l78.650" class="difflineplus">+</span>
<a href="#l78.651"></a><span id="l78.651" class="difflineplus">+    // Get a new token if needed...</span>
<a href="#l78.652"></a><span id="l78.652" class="difflineplus">+    if (!this.token || !this.tokenSecret) {</span>
<a href="#l78.653"></a><span id="l78.653" class="difflineplus">+      this.requestToken();</span>
<a href="#l78.654"></a><span id="l78.654" class="difflineplus">+      return;</span>
<a href="#l78.655"></a><span id="l78.655" class="difflineplus">+    }</span>
<a href="#l78.656"></a><span id="l78.656" class="difflineplus">+</span>
<a href="#l78.657"></a><span id="l78.657" class="difflineplus">+    this.LOG(&quot;Connecting using existing token&quot;);</span>
<a href="#l78.658"></a><span id="l78.658" class="difflineplus">+    this.getTimelines();</span>
<a href="#l78.659"></a><span id="l78.659" class="difflineplus">+  },</span>
<a href="#l78.660"></a><span id="l78.660" class="difflineplus">+</span>
<a href="#l78.661"></a><span id="l78.661" class="difflineplus">+  observe(aSubject, aTopic, aMsg) {</span>
<a href="#l78.662"></a><span id="l78.662" class="difflineplus">+    // Twitter doesn't broadcast the user's availability, so we can ignore</span>
<a href="#l78.663"></a><span id="l78.663" class="difflineplus">+    // imIUserStatusInfo's status notifications.</span>
<a href="#l78.664"></a><span id="l78.664" class="difflineplus">+    if (aTopic != NS_PREFBRANCH_PREFCHANGE_TOPIC_ID) {</span>
<a href="#l78.665"></a><span id="l78.665" class="difflineplus">+      return;</span>
<a href="#l78.666"></a><span id="l78.666" class="difflineplus">+    }</span>
<a href="#l78.667"></a><span id="l78.667" class="difflineplus">+</span>
<a href="#l78.668"></a><span id="l78.668" class="difflineplus">+    // Reopen the stream with the new tracked keywords.</span>
<a href="#l78.669"></a><span id="l78.669" class="difflineplus">+    this.DEBUG(&quot;Twitter tracked keywords modified: &quot; + this.getString(&quot;track&quot;));</span>
<a href="#l78.670"></a><span id="l78.670" class="difflineplus">+</span>
<a href="#l78.671"></a><span id="l78.671" class="difflineplus">+    // Close the stream and reopen it.</span>
<a href="#l78.672"></a><span id="l78.672" class="difflineplus">+    this._streamingRequest.abort();</span>
<a href="#l78.673"></a><span id="l78.673" class="difflineplus">+    this.openStream();</span>
<a href="#l78.674"></a><span id="l78.674" class="difflineplus">+  },</span>
<a href="#l78.675"></a><span id="l78.675" class="difflineplus">+</span>
<a href="#l78.676"></a><span id="l78.676" class="difflineplus">+  signAndSend(</span>
<a href="#l78.677"></a><span id="l78.677" class="difflineplus">+    aUrl,</span>
<a href="#l78.678"></a><span id="l78.678" class="difflineplus">+    aHeaders,</span>
<a href="#l78.679"></a><span id="l78.679" class="difflineplus">+    aPOSTData,</span>
<a href="#l78.680"></a><span id="l78.680" class="difflineplus">+    aOnLoad,</span>
<a href="#l78.681"></a><span id="l78.681" class="difflineplus">+    aOnError,</span>
<a href="#l78.682"></a><span id="l78.682" class="difflineplus">+    aThis,</span>
<a href="#l78.683"></a><span id="l78.683" class="difflineplus">+    aOAuthParams</span>
<a href="#l78.684"></a><span id="l78.684" class="difflineplus">+  ) {</span>
<a href="#l78.685"></a><span id="l78.685" class="difflineplus">+    const kChars =</span>
<a href="#l78.686"></a><span id="l78.686" class="difflineplus">+      &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&quot;;</span>
<a href="#l78.687"></a><span id="l78.687" class="difflineplus">+    const kNonceLength = 6;</span>
<a href="#l78.688"></a><span id="l78.688" class="difflineplus">+    let nonce = &quot;&quot;;</span>
<a href="#l78.689"></a><span id="l78.689" class="difflineplus">+    for (let i = 0; i &lt; kNonceLength; ++i) {</span>
<a href="#l78.690"></a><span id="l78.690" class="difflineplus">+      nonce += kChars[Math.floor(Math.random() * kChars.length)];</span>
<a href="#l78.691"></a><span id="l78.691" class="difflineplus">+    }</span>
<a href="#l78.692"></a><span id="l78.692" class="difflineplus">+</span>
<a href="#l78.693"></a><span id="l78.693" class="difflineplus">+    let params = (aOAuthParams || []).concat([</span>
<a href="#l78.694"></a><span id="l78.694" class="difflineplus">+      [&quot;oauth_consumer_key&quot;, this.consumerKey],</span>
<a href="#l78.695"></a><span id="l78.695" class="difflineplus">+      [&quot;oauth_nonce&quot;, nonce],</span>
<a href="#l78.696"></a><span id="l78.696" class="difflineplus">+      [&quot;oauth_signature_method&quot;, &quot;HMAC-SHA1&quot;],</span>
<a href="#l78.697"></a><span id="l78.697" class="difflineplus">+      [&quot;oauth_token&quot;, this.token],</span>
<a href="#l78.698"></a><span id="l78.698" class="difflineplus">+      [&quot;oauth_timestamp&quot;, Math.floor(new Date().getTime() / 1000)],</span>
<a href="#l78.699"></a><span id="l78.699" class="difflineplus">+      [&quot;oauth_version&quot;, &quot;1.0&quot;],</span>
<a href="#l78.700"></a><span id="l78.700" class="difflineplus">+    ]);</span>
<a href="#l78.701"></a><span id="l78.701" class="difflineplus">+</span>
<a href="#l78.702"></a><span id="l78.702" class="difflineplus">+    let dataParams = [];</span>
<a href="#l78.703"></a><span id="l78.703" class="difflineplus">+    let url = /^https?:/.test(aUrl) ? aUrl : this.baseURI + aUrl;</span>
<a href="#l78.704"></a><span id="l78.704" class="difflineplus">+    let urlSpec = url;</span>
<a href="#l78.705"></a><span id="l78.705" class="difflineplus">+    let queryIndex = url.indexOf(&quot;?&quot;);</span>
<a href="#l78.706"></a><span id="l78.706" class="difflineplus">+    if (queryIndex != -1) {</span>
<a href="#l78.707"></a><span id="l78.707" class="difflineplus">+      urlSpec = url.slice(0, queryIndex);</span>
<a href="#l78.708"></a><span id="l78.708" class="difflineplus">+      dataParams = url</span>
<a href="#l78.709"></a><span id="l78.709" class="difflineplus">+        .slice(queryIndex + 1)</span>
<a href="#l78.710"></a><span id="l78.710" class="difflineplus">+        .split(&quot;&amp;&quot;)</span>
<a href="#l78.711"></a><span id="l78.711" class="difflineplus">+        .map(p =&gt; p.split(&quot;=&quot;).map(percentEncode));</span>
<a href="#l78.712"></a><span id="l78.712" class="difflineplus">+    }</span>
<a href="#l78.713"></a><span id="l78.713" class="difflineplus">+    let method = &quot;GET&quot;;</span>
<a href="#l78.714"></a><span id="l78.714" class="difflineplus">+    if (aPOSTData) {</span>
<a href="#l78.715"></a><span id="l78.715" class="difflineplus">+      method = &quot;POST&quot;;</span>
<a href="#l78.716"></a><span id="l78.716" class="difflineplus">+      aPOSTData.forEach(function(p) {</span>
<a href="#l78.717"></a><span id="l78.717" class="difflineplus">+        dataParams.push(p.map(percentEncode));</span>
<a href="#l78.718"></a><span id="l78.718" class="difflineplus">+      });</span>
<a href="#l78.719"></a><span id="l78.719" class="difflineplus">+    }</span>
<a href="#l78.720"></a><span id="l78.720" class="difflineplus">+</span>
<a href="#l78.721"></a><span id="l78.721" class="difflineplus">+    let signatureKey = this.consumerSecret + &quot;&amp;&quot; + this.tokenSecret;</span>
<a href="#l78.722"></a><span id="l78.722" class="difflineplus">+    let signatureBase =</span>
<a href="#l78.723"></a><span id="l78.723" class="difflineplus">+      method +</span>
<a href="#l78.724"></a><span id="l78.724" class="difflineplus">+      &quot;&amp;&quot; +</span>
<a href="#l78.725"></a><span id="l78.725" class="difflineplus">+      encodeURIComponent(urlSpec) +</span>
<a href="#l78.726"></a><span id="l78.726" class="difflineplus">+      &quot;&amp;&quot; +</span>
<a href="#l78.727"></a><span id="l78.727" class="difflineplus">+      params</span>
<a href="#l78.728"></a><span id="l78.728" class="difflineplus">+        .concat(dataParams)</span>
<a href="#l78.729"></a><span id="l78.729" class="difflineplus">+        .sort((a, b) =&gt; {</span>
<a href="#l78.730"></a><span id="l78.730" class="difflineplus">+          if (a[0] &lt; b[0]) {</span>
<a href="#l78.731"></a><span id="l78.731" class="difflineplus">+            return -1;</span>
<a href="#l78.732"></a><span id="l78.732" class="difflineplus">+          }</span>
<a href="#l78.733"></a><span id="l78.733" class="difflineplus">+          return a[0] &gt; b[0] ? 1 : 0;</span>
<a href="#l78.734"></a><span id="l78.734" class="difflineplus">+        })</span>
<a href="#l78.735"></a><span id="l78.735" class="difflineplus">+        .map(p =&gt; p.map(encodeURIComponent).join(&quot;%3D&quot;))</span>
<a href="#l78.736"></a><span id="l78.736" class="difflineplus">+        .join(&quot;%26&quot;);</span>
<a href="#l78.737"></a><span id="l78.737" class="difflineplus">+</span>
<a href="#l78.738"></a><span id="l78.738" class="difflineplus">+    let keyFactory = Cc[&quot;@mozilla.org/security/keyobjectfactory;1&quot;].getService(</span>
<a href="#l78.739"></a><span id="l78.739" class="difflineplus">+      Ci.nsIKeyObjectFactory</span>
<a href="#l78.740"></a><span id="l78.740" class="difflineplus">+    );</span>
<a href="#l78.741"></a><span id="l78.741" class="difflineplus">+    let hmac = Cc[&quot;@mozilla.org/security/hmac;1&quot;].createInstance(</span>
<a href="#l78.742"></a><span id="l78.742" class="difflineplus">+      Ci.nsICryptoHMAC</span>
<a href="#l78.743"></a><span id="l78.743" class="difflineplus">+    );</span>
<a href="#l78.744"></a><span id="l78.744" class="difflineplus">+    hmac.init(</span>
<a href="#l78.745"></a><span id="l78.745" class="difflineplus">+      hmac.SHA1,</span>
<a href="#l78.746"></a><span id="l78.746" class="difflineplus">+      keyFactory.keyFromString(Ci.nsIKeyObject.HMAC, signatureKey)</span>
<a href="#l78.747"></a><span id="l78.747" class="difflineplus">+    );</span>
<a href="#l78.748"></a><span id="l78.748" class="difflineplus">+    // No UTF-8 encoding, special chars are already escaped.</span>
<a href="#l78.749"></a><span id="l78.749" class="difflineplus">+    let bytes = [...signatureBase].map(b =&gt; b.charCodeAt());</span>
<a href="#l78.750"></a><span id="l78.750" class="difflineplus">+    hmac.update(bytes, bytes.length);</span>
<a href="#l78.751"></a><span id="l78.751" class="difflineplus">+    let signature = hmac.finish(true);</span>
<a href="#l78.752"></a><span id="l78.752" class="difflineplus">+</span>
<a href="#l78.753"></a><span id="l78.753" class="difflineplus">+    params.push([&quot;oauth_signature&quot;, encodeURIComponent(signature)]);</span>
<a href="#l78.754"></a><span id="l78.754" class="difflineplus">+</span>
<a href="#l78.755"></a><span id="l78.755" class="difflineplus">+    let authorization =</span>
<a href="#l78.756"></a><span id="l78.756" class="difflineplus">+      &quot;OAuth &quot; + params.map(p =&gt; p[0] + '=&quot;' + p[1] + '&quot;').join(&quot;, &quot;);</span>
<a href="#l78.757"></a><span id="l78.757" class="difflineplus">+</span>
<a href="#l78.758"></a><span id="l78.758" class="difflineplus">+    let options = {</span>
<a href="#l78.759"></a><span id="l78.759" class="difflineplus">+      headers: (aHeaders || []).concat([[&quot;Authorization&quot;, authorization]]),</span>
<a href="#l78.760"></a><span id="l78.760" class="difflineplus">+      postData: aPOSTData,</span>
<a href="#l78.761"></a><span id="l78.761" class="difflineplus">+      onLoad: aOnLoad ? aOnLoad.bind(aThis) : null,</span>
<a href="#l78.762"></a><span id="l78.762" class="difflineplus">+      onError: aOnError ? aOnError.bind(aThis) : null,</span>
<a href="#l78.763"></a><span id="l78.763" class="difflineplus">+      logger: {</span>
<a href="#l78.764"></a><span id="l78.764" class="difflineplus">+        log: this.LOG.bind(this),</span>
<a href="#l78.765"></a><span id="l78.765" class="difflineplus">+        debug: this.DEBUG.bind(this),</span>
<a href="#l78.766"></a><span id="l78.766" class="difflineplus">+      },</span>
<a href="#l78.767"></a><span id="l78.767" class="difflineplus">+    };</span>
<a href="#l78.768"></a><span id="l78.768" class="difflineplus">+    return httpRequest(url, options);</span>
<a href="#l78.769"></a><span id="l78.769" class="difflineplus">+  },</span>
<a href="#l78.770"></a><span id="l78.770" class="difflineplus">+  _parseURLData(aData) {</span>
<a href="#l78.771"></a><span id="l78.771" class="difflineplus">+    let result = {};</span>
<a href="#l78.772"></a><span id="l78.772" class="difflineplus">+    aData.split(&quot;&amp;&quot;).forEach(function(aParam) {</span>
<a href="#l78.773"></a><span id="l78.773" class="difflineplus">+      let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l78.774"></a><span id="l78.774" class="difflineplus">+      result[key] = value;</span>
<a href="#l78.775"></a><span id="l78.775" class="difflineplus">+    });</span>
<a href="#l78.776"></a><span id="l78.776" class="difflineplus">+    return result;</span>
<a href="#l78.777"></a><span id="l78.777" class="difflineplus">+  },</span>
<a href="#l78.778"></a><span id="l78.778" class="difflineplus">+</span>
<a href="#l78.779"></a><span id="l78.779" class="difflineplus">+  tweet(aMsg, aInReplyToId, aOnSent, aOnError, aThis) {</span>
<a href="#l78.780"></a><span id="l78.780" class="difflineplus">+    let POSTData = [[&quot;status&quot;, aMsg]];</span>
<a href="#l78.781"></a><span id="l78.781" class="difflineplus">+    if (aInReplyToId) {</span>
<a href="#l78.782"></a><span id="l78.782" class="difflineplus">+      POSTData.push([&quot;in_reply_to_status_id&quot;, aInReplyToId]);</span>
<a href="#l78.783"></a><span id="l78.783" class="difflineplus">+    }</span>
<a href="#l78.784"></a><span id="l78.784" class="difflineplus">+    this.signAndSend(</span>
<a href="#l78.785"></a><span id="l78.785" class="difflineplus">+      &quot;1.1/statuses/update.json&quot;,</span>
<a href="#l78.786"></a><span id="l78.786" class="difflineplus">+      null,</span>
<a href="#l78.787"></a><span id="l78.787" class="difflineplus">+      POSTData,</span>
<a href="#l78.788"></a><span id="l78.788" class="difflineplus">+      aOnSent,</span>
<a href="#l78.789"></a><span id="l78.789" class="difflineplus">+      aOnError,</span>
<a href="#l78.790"></a><span id="l78.790" class="difflineplus">+      aThis</span>
<a href="#l78.791"></a><span id="l78.791" class="difflineplus">+    );</span>
<a href="#l78.792"></a><span id="l78.792" class="difflineplus">+  },</span>
<a href="#l78.793"></a><span id="l78.793" class="difflineplus">+  reTweet(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l78.794"></a><span id="l78.794" class="difflineplus">+    let url = &quot;1.1/statuses/retweet/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l78.795"></a><span id="l78.795" class="difflineplus">+    this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l78.796"></a><span id="l78.796" class="difflineplus">+  },</span>
<a href="#l78.797"></a><span id="l78.797" class="difflineplus">+  destroy(aTweet, aOnSent, aOnError, aThis) {</span>
<a href="#l78.798"></a><span id="l78.798" class="difflineplus">+    let url = &quot;1.1/statuses/destroy/&quot; + aTweet.id_str + &quot;.json&quot;;</span>
<a href="#l78.799"></a><span id="l78.799" class="difflineplus">+    this.signAndSend(url, null, [], aOnSent, aOnError, aThis);</span>
<a href="#l78.800"></a><span id="l78.800" class="difflineplus">+  },</span>
<a href="#l78.801"></a><span id="l78.801" class="difflineplus">+  directMessage(aMsg, aName, aOnSent, aOnError, aThis) {</span>
<a href="#l78.802"></a><span id="l78.802" class="difflineplus">+    let POSTData = [[&quot;text&quot;, aMsg], [&quot;screen_name&quot;, aName]];</span>
<a href="#l78.803"></a><span id="l78.803" class="difflineplus">+    this.signAndSend(</span>
<a href="#l78.804"></a><span id="l78.804" class="difflineplus">+      &quot;1.1/direct_messages/new.json&quot;,</span>
<a href="#l78.805"></a><span id="l78.805" class="difflineplus">+      null,</span>
<a href="#l78.806"></a><span id="l78.806" class="difflineplus">+      POSTData,</span>
<a href="#l78.807"></a><span id="l78.807" class="difflineplus">+      aOnSent,</span>
<a href="#l78.808"></a><span id="l78.808" class="difflineplus">+      aOnError,</span>
<a href="#l78.809"></a><span id="l78.809" class="difflineplus">+      aThis</span>
<a href="#l78.810"></a><span id="l78.810" class="difflineplus">+    );</span>
<a href="#l78.811"></a><span id="l78.811" class="difflineplus">+  },</span>
<a href="#l78.812"></a><span id="l78.812" class="difflineplus">+  like(aTweet, aRemoveLike, aOnSent, aOnError, aThis) {</span>
<a href="#l78.813"></a><span id="l78.813" class="difflineplus">+    const action = aRemoveLike ? &quot;destroy&quot; : &quot;create&quot;;</span>
<a href="#l78.814"></a><span id="l78.814" class="difflineplus">+    const url = `1.1/favorites/${action}.json`;</span>
<a href="#l78.815"></a><span id="l78.815" class="difflineplus">+    const POSTData = [[&quot;id&quot;, aTweet.id_str]];</span>
<a href="#l78.816"></a><span id="l78.816" class="difflineplus">+    this.signAndSend(url, null, POSTData, aOnSent, aOnError, aThis);</span>
<a href="#l78.817"></a><span id="l78.817" class="difflineplus">+  },</span>
<a href="#l78.818"></a><span id="l78.818" class="difflineplus">+</span>
<a href="#l78.819"></a><span id="l78.819" class="difflineplus">+  _friends: null,</span>
<a href="#l78.820"></a><span id="l78.820" class="difflineplus">+  follow(aUserName) {</span>
<a href="#l78.821"></a><span id="l78.821" class="difflineplus">+    this.signAndSend(&quot;1.1/friendships/create.json&quot;, null, [</span>
<a href="#l78.822"></a><span id="l78.822" class="difflineplus">+      [&quot;screen_name&quot;, aUserName],</span>
<a href="#l78.823"></a><span id="l78.823" class="difflineplus">+    ]);</span>
<a href="#l78.824"></a><span id="l78.824" class="difflineplus">+  },</span>
<a href="#l78.825"></a><span id="l78.825" class="difflineplus">+  stopFollowing(aUserName) {</span>
<a href="#l78.826"></a><span id="l78.826" class="difflineplus">+    // friendships/destroy will return the user in case of success.</span>
<a href="#l78.827"></a><span id="l78.827" class="difflineplus">+    // Error cases would return a non 200 HTTP code and not call our callback.</span>
<a href="#l78.828"></a><span id="l78.828" class="difflineplus">+    this.signAndSend(</span>
<a href="#l78.829"></a><span id="l78.829" class="difflineplus">+      &quot;1.1/friendships/destroy.json&quot;,</span>
<a href="#l78.830"></a><span id="l78.830" class="difflineplus">+      null,</span>
<a href="#l78.831"></a><span id="l78.831" class="difflineplus">+      [[&quot;screen_name&quot;, aUserName]],</span>
<a href="#l78.832"></a><span id="l78.832" class="difflineplus">+      function(aData, aXHR) {</span>
<a href="#l78.833"></a><span id="l78.833" class="difflineplus">+        let user = JSON.parse(aData);</span>
<a href="#l78.834"></a><span id="l78.834" class="difflineplus">+        if (!(&quot;id_str&quot; in user)) {</span>
<a href="#l78.835"></a><span id="l78.835" class="difflineplus">+          // Unexpected response...</span>
<a href="#l78.836"></a><span id="l78.836" class="difflineplus">+          return;</span>
<a href="#l78.837"></a><span id="l78.837" class="difflineplus">+        }</span>
<a href="#l78.838"></a><span id="l78.838" class="difflineplus">+        this._friends.delete(user.id_str);</span>
<a href="#l78.839"></a><span id="l78.839" class="difflineplus">+        this.timeline.removeParticipant(user.screen_name);</span>
<a href="#l78.840"></a><span id="l78.840" class="difflineplus">+        let date = aXHR.getResponseHeader(&quot;Date&quot;);</span>
<a href="#l78.841"></a><span id="l78.841" class="difflineplus">+        this.timeline.systemMessage(</span>
<a href="#l78.842"></a><span id="l78.842" class="difflineplus">+          _(&quot;event.unfollow&quot;, user.screen_name),</span>
<a href="#l78.843"></a><span id="l78.843" class="difflineplus">+          false,</span>
<a href="#l78.844"></a><span id="l78.844" class="difflineplus">+          new Date(date) / 1000</span>
<a href="#l78.845"></a><span id="l78.845" class="difflineplus">+        );</span>
<a href="#l78.846"></a><span id="l78.846" class="difflineplus">+      },</span>
<a href="#l78.847"></a><span id="l78.847" class="difflineplus">+      null,</span>
<a href="#l78.848"></a><span id="l78.848" class="difflineplus">+      this</span>
<a href="#l78.849"></a><span id="l78.849" class="difflineplus">+    );</span>
<a href="#l78.850"></a><span id="l78.850" class="difflineplus">+  },</span>
<a href="#l78.851"></a><span id="l78.851" class="difflineplus">+  addBuddy(aTag, aName) {</span>
<a href="#l78.852"></a><span id="l78.852" class="difflineplus">+    this.follow(aName);</span>
<a href="#l78.853"></a><span id="l78.853" class="difflineplus">+  },</span>
<a href="#l78.854"></a><span id="l78.854" class="difflineplus">+</span>
<a href="#l78.855"></a><span id="l78.855" class="difflineplus">+  getTimelines() {</span>
<a href="#l78.856"></a><span id="l78.856" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestTimelines&quot;));</span>
<a href="#l78.857"></a><span id="l78.857" class="difflineplus">+</span>
<a href="#l78.858"></a><span id="l78.858" class="difflineplus">+    // If we have a last known message ID, append it as a get parameter.</span>
<a href="#l78.859"></a><span id="l78.859" class="difflineplus">+    let lastMsgParam = &quot;&quot;;</span>
<a href="#l78.860"></a><span id="l78.860" class="difflineplus">+    if (this.prefs.prefHasUserValue(&quot;lastMessageId&quot;)) {</span>
<a href="#l78.861"></a><span id="l78.861" class="difflineplus">+      let lastMsgId = this.prefs.getCharPref(&quot;lastMessageId&quot;);</span>
<a href="#l78.862"></a><span id="l78.862" class="difflineplus">+      // Check that the ID is made up of all digits, otherwise the server will</span>
<a href="#l78.863"></a><span id="l78.863" class="difflineplus">+      // croak on our request.</span>
<a href="#l78.864"></a><span id="l78.864" class="difflineplus">+      if (/^\d+$/.test(lastMsgId)) {</span>
<a href="#l78.865"></a><span id="l78.865" class="difflineplus">+        lastMsgParam = &quot;&amp;since_id=&quot; + lastMsgId;</span>
<a href="#l78.866"></a><span id="l78.866" class="difflineplus">+        this._lastMsgId = lastMsgId;</span>
<a href="#l78.867"></a><span id="l78.867" class="difflineplus">+      } else {</span>
<a href="#l78.868"></a><span id="l78.868" class="difflineplus">+        this.WARN(</span>
<a href="#l78.869"></a><span id="l78.869" class="difflineplus">+          &quot;invalid value for the lastMessageId preference: &quot; + lastMsgId</span>
<a href="#l78.870"></a><span id="l78.870" class="difflineplus">+        );</span>
<a href="#l78.871"></a><span id="l78.871" class="difflineplus">+      }</span>
<a href="#l78.872"></a><span id="l78.872" class="difflineplus">+    }</span>
<a href="#l78.873"></a><span id="l78.873" class="difflineplus">+    let getParams = &quot;?count=200&quot; + lastMsgParam;</span>
<a href="#l78.874"></a><span id="l78.874" class="difflineplus">+    this._pendingRequests = [</span>
<a href="#l78.875"></a><span id="l78.875" class="difflineplus">+      this.signAndSend(</span>
<a href="#l78.876"></a><span id="l78.876" class="difflineplus">+        &quot;1.1/statuses/home_timeline.json&quot; + getParams,</span>
<a href="#l78.877"></a><span id="l78.877" class="difflineplus">+        null,</span>
<a href="#l78.878"></a><span id="l78.878" class="difflineplus">+        null,</span>
<a href="#l78.879"></a><span id="l78.879" class="difflineplus">+        this.onTimelineReceived,</span>
<a href="#l78.880"></a><span id="l78.880" class="difflineplus">+        this.onTimelineError,</span>
<a href="#l78.881"></a><span id="l78.881" class="difflineplus">+        this</span>
<a href="#l78.882"></a><span id="l78.882" class="difflineplus">+      ),</span>
<a href="#l78.883"></a><span id="l78.883" class="difflineplus">+      this.signAndSend(</span>
<a href="#l78.884"></a><span id="l78.884" class="difflineplus">+        &quot;1.1/statuses/mentions_timeline.json&quot; + getParams,</span>
<a href="#l78.885"></a><span id="l78.885" class="difflineplus">+        null,</span>
<a href="#l78.886"></a><span id="l78.886" class="difflineplus">+        null,</span>
<a href="#l78.887"></a><span id="l78.887" class="difflineplus">+        this.onTimelineReceived,</span>
<a href="#l78.888"></a><span id="l78.888" class="difflineplus">+        this.onTimelineError,</span>
<a href="#l78.889"></a><span id="l78.889" class="difflineplus">+        this</span>
<a href="#l78.890"></a><span id="l78.890" class="difflineplus">+      ),</span>
<a href="#l78.891"></a><span id="l78.891" class="difflineplus">+    ];</span>
<a href="#l78.892"></a><span id="l78.892" class="difflineplus">+</span>
<a href="#l78.893"></a><span id="l78.893" class="difflineplus">+    let track = this.getString(&quot;track&quot;);</span>
<a href="#l78.894"></a><span id="l78.894" class="difflineplus">+    if (track) {</span>
<a href="#l78.895"></a><span id="l78.895" class="difflineplus">+      let trackQuery = track</span>
<a href="#l78.896"></a><span id="l78.896" class="difflineplus">+        .split(&quot;,&quot;)</span>
<a href="#l78.897"></a><span id="l78.897" class="difflineplus">+        .map(encodeURIComponent)</span>
<a href="#l78.898"></a><span id="l78.898" class="difflineplus">+        .join(&quot; OR &quot;);</span>
<a href="#l78.899"></a><span id="l78.899" class="difflineplus">+      getParams = &quot;?q=&quot; + trackQuery + lastMsgParam + &quot;&amp;count=100&quot;;</span>
<a href="#l78.900"></a><span id="l78.900" class="difflineplus">+      let url = &quot;1.1/search/tweets.json&quot; + getParams;</span>
<a href="#l78.901"></a><span id="l78.901" class="difflineplus">+      this._pendingRequests.push(</span>
<a href="#l78.902"></a><span id="l78.902" class="difflineplus">+        this.signAndSend(</span>
<a href="#l78.903"></a><span id="l78.903" class="difflineplus">+          url,</span>
<a href="#l78.904"></a><span id="l78.904" class="difflineplus">+          null,</span>
<a href="#l78.905"></a><span id="l78.905" class="difflineplus">+          null,</span>
<a href="#l78.906"></a><span id="l78.906" class="difflineplus">+          this.onTimelineReceived,</span>
<a href="#l78.907"></a><span id="l78.907" class="difflineplus">+          this.onTimelineError,</span>
<a href="#l78.908"></a><span id="l78.908" class="difflineplus">+          this,</span>
<a href="#l78.909"></a><span id="l78.909" class="difflineplus">+          null</span>
<a href="#l78.910"></a><span id="l78.910" class="difflineplus">+        )</span>
<a href="#l78.911"></a><span id="l78.911" class="difflineplus">+      );</span>
<a href="#l78.912"></a><span id="l78.912" class="difflineplus">+    }</span>
<a href="#l78.913"></a><span id="l78.913" class="difflineplus">+  },</span>
<a href="#l78.914"></a><span id="l78.914" class="difflineplus">+</span>
<a href="#l78.915"></a><span id="l78.915" class="difflineplus">+  get timeline() {</span>
<a href="#l78.916"></a><span id="l78.916" class="difflineplus">+    return this._timeline || (this._timeline = new TimelineConversation(this));</span>
<a href="#l78.917"></a><span id="l78.917" class="difflineplus">+  },</span>
<a href="#l78.918"></a><span id="l78.918" class="difflineplus">+</span>
<a href="#l78.919"></a><span id="l78.919" class="difflineplus">+  onTimelineError(aError, aResponseText, aRequest) {</span>
<a href="#l78.920"></a><span id="l78.920" class="difflineplus">+    this.ERROR(aError);</span>
<a href="#l78.921"></a><span id="l78.921" class="difflineplus">+    if (aRequest.status == 401) {</span>
<a href="#l78.922"></a><span id="l78.922" class="difflineplus">+      ++this._timelineAuthError;</span>
<a href="#l78.923"></a><span id="l78.923" class="difflineplus">+    }</span>
<a href="#l78.924"></a><span id="l78.924" class="difflineplus">+    this._doneWithTimelineRequest(aRequest);</span>
<a href="#l78.925"></a><span id="l78.925" class="difflineplus">+  },</span>
<a href="#l78.926"></a><span id="l78.926" class="difflineplus">+</span>
<a href="#l78.927"></a><span id="l78.927" class="difflineplus">+  onTimelineReceived(aData, aRequest) {</span>
<a href="#l78.928"></a><span id="l78.928" class="difflineplus">+    this._timelineBuffer = this._timelineBuffer.concat(JSON.parse(aData));</span>
<a href="#l78.929"></a><span id="l78.929" class="difflineplus">+    this._doneWithTimelineRequest(aRequest);</span>
<a href="#l78.930"></a><span id="l78.930" class="difflineplus">+  },</span>
<a href="#l78.931"></a><span id="l78.931" class="difflineplus">+</span>
<a href="#l78.932"></a><span id="l78.932" class="difflineplus">+  _doneWithTimelineRequest(aRequest) {</span>
<a href="#l78.933"></a><span id="l78.933" class="difflineplus">+    this._pendingRequests = this._pendingRequests.filter(r =&gt; r !== aRequest);</span>
<a href="#l78.934"></a><span id="l78.934" class="difflineplus">+</span>
<a href="#l78.935"></a><span id="l78.935" class="difflineplus">+    // If we are still waiting for more data, return early</span>
<a href="#l78.936"></a><span id="l78.936" class="difflineplus">+    if (this._pendingRequests.length != 0) {</span>
<a href="#l78.937"></a><span id="l78.937" class="difflineplus">+      return;</span>
<a href="#l78.938"></a><span id="l78.938" class="difflineplus">+    }</span>
<a href="#l78.939"></a><span id="l78.939" class="difflineplus">+</span>
<a href="#l78.940"></a><span id="l78.940" class="difflineplus">+    if (this._timelineAuthError &gt;= 2) {</span>
<a href="#l78.941"></a><span id="l78.941" class="difflineplus">+      // 2 out of the 3 timeline requests are authenticated.</span>
<a href="#l78.942"></a><span id="l78.942" class="difflineplus">+      // With at least 2 '401 - Unauthorized' errors, we are sure</span>
<a href="#l78.943"></a><span id="l78.943" class="difflineplus">+      // that our OAuth token is consistently rejected.</span>
<a href="#l78.944"></a><span id="l78.944" class="difflineplus">+      delete this._timelineAuthError;</span>
<a href="#l78.945"></a><span id="l78.945" class="difflineplus">+      delete this._timelineBuffer;</span>
<a href="#l78.946"></a><span id="l78.946" class="difflineplus">+      delete this._pendingRequests;</span>
<a href="#l78.947"></a><span id="l78.947" class="difflineplus">+      delete this.token;</span>
<a href="#l78.948"></a><span id="l78.948" class="difflineplus">+      delete this.tokenSecret;</span>
<a href="#l78.949"></a><span id="l78.949" class="difflineplus">+      this.requestToken();</span>
<a href="#l78.950"></a><span id="l78.950" class="difflineplus">+      return;</span>
<a href="#l78.951"></a><span id="l78.951" class="difflineplus">+    }</span>
<a href="#l78.952"></a><span id="l78.952" class="difflineplus">+</span>
<a href="#l78.953"></a><span id="l78.953" class="difflineplus">+    // Less than 2 auth errors is probably just some flakiness of the</span>
<a href="#l78.954"></a><span id="l78.954" class="difflineplus">+    // twitter servers, ignore and reset this._timelineAuthError.</span>
<a href="#l78.955"></a><span id="l78.955" class="difflineplus">+    if (this._timelineAuthError) {</span>
<a href="#l78.956"></a><span id="l78.956" class="difflineplus">+      delete this._timelineAuthError;</span>
<a href="#l78.957"></a><span id="l78.957" class="difflineplus">+    }</span>
<a href="#l78.958"></a><span id="l78.958" class="difflineplus">+</span>
<a href="#l78.959"></a><span id="l78.959" class="difflineplus">+    this.reportConnected();</span>
<a href="#l78.960"></a><span id="l78.960" class="difflineplus">+</span>
<a href="#l78.961"></a><span id="l78.961" class="difflineplus">+    // If the conversation already exists, notify it we are back online.</span>
<a href="#l78.962"></a><span id="l78.962" class="difflineplus">+    if (this._timeline) {</span>
<a href="#l78.963"></a><span id="l78.963" class="difflineplus">+      this._timeline.notifyObservers(this._timeline, &quot;update-buddy-status&quot;);</span>
<a href="#l78.964"></a><span id="l78.964" class="difflineplus">+    }</span>
<a href="#l78.965"></a><span id="l78.965" class="difflineplus">+</span>
<a href="#l78.966"></a><span id="l78.966" class="difflineplus">+    this._timelineBuffer.sort(this.sortByDate);</span>
<a href="#l78.967"></a><span id="l78.967" class="difflineplus">+    this._timelineBuffer.forEach(aTweet =&gt; (aTweet.delayed = true));</span>
<a href="#l78.968"></a><span id="l78.968" class="difflineplus">+    this.timeline.displayMessages(this._timelineBuffer);</span>
<a href="#l78.969"></a><span id="l78.969" class="difflineplus">+</span>
<a href="#l78.970"></a><span id="l78.970" class="difflineplus">+    // Fetch userInfo for the user if we don't already have it.</span>
<a href="#l78.971"></a><span id="l78.971" class="difflineplus">+    this.requestBuddyInfo(this.name);</span>
<a href="#l78.972"></a><span id="l78.972" class="difflineplus">+</span>
<a href="#l78.973"></a><span id="l78.973" class="difflineplus">+    // Reset in case we get disconnected</span>
<a href="#l78.974"></a><span id="l78.974" class="difflineplus">+    delete this._timelineBuffer;</span>
<a href="#l78.975"></a><span id="l78.975" class="difflineplus">+    delete this._pendingRequests;</span>
<a href="#l78.976"></a><span id="l78.976" class="difflineplus">+</span>
<a href="#l78.977"></a><span id="l78.977" class="difflineplus">+    // Open the streams to get the live data.</span>
<a href="#l78.978"></a><span id="l78.978" class="difflineplus">+    this.openStream();</span>
<a href="#l78.979"></a><span id="l78.979" class="difflineplus">+  },</span>
<a href="#l78.980"></a><span id="l78.980" class="difflineplus">+</span>
<a href="#l78.981"></a><span id="l78.981" class="difflineplus">+  sortByDate: (a, b) =&gt; new Date(a.created_at) - new Date(b.created_at),</span>
<a href="#l78.982"></a><span id="l78.982" class="difflineplus">+</span>
<a href="#l78.983"></a><span id="l78.983" class="difflineplus">+  _streamingRequest: null,</span>
<a href="#l78.984"></a><span id="l78.984" class="difflineplus">+  _pendingData: &quot;&quot;,</span>
<a href="#l78.985"></a><span id="l78.985" class="difflineplus">+  openStream() {</span>
<a href="#l78.986"></a><span id="l78.986" class="difflineplus">+    let track = this.getString(&quot;track&quot;);</span>
<a href="#l78.987"></a><span id="l78.987" class="difflineplus">+    this._streamingRequest = this.signAndSend(</span>
<a href="#l78.988"></a><span id="l78.988" class="difflineplus">+      &quot;https://userstream.twitter.com/1.1/user.json&quot;,</span>
<a href="#l78.989"></a><span id="l78.989" class="difflineplus">+      null,</span>
<a href="#l78.990"></a><span id="l78.990" class="difflineplus">+      track ? [[&quot;track&quot;, track]] : [],</span>
<a href="#l78.991"></a><span id="l78.991" class="difflineplus">+      this.openStream,</span>
<a href="#l78.992"></a><span id="l78.992" class="difflineplus">+      this.onStreamError,</span>
<a href="#l78.993"></a><span id="l78.993" class="difflineplus">+      this</span>
<a href="#l78.994"></a><span id="l78.994" class="difflineplus">+    );</span>
<a href="#l78.995"></a><span id="l78.995" class="difflineplus">+    this._streamingRequest.responseType = &quot;moz-chunked-text&quot;;</span>
<a href="#l78.996"></a><span id="l78.996" class="difflineplus">+    this._streamingRequest.onprogress = this.onDataAvailable.bind(this);</span>
<a href="#l78.997"></a><span id="l78.997" class="difflineplus">+    this.resetStreamTimeout();</span>
<a href="#l78.998"></a><span id="l78.998" class="difflineplus">+    this.prefs.addObserver(&quot;track&quot;, this);</span>
<a href="#l78.999"></a><span id="l78.999" class="difflineplus">+  },</span>
<a href="#l78.1000"></a><span id="l78.1000" class="difflineplus">+  _streamTimeout: null,</span>
<a href="#l78.1001"></a><span id="l78.1001" class="difflineplus">+  resetStreamTimeout() {</span>
<a href="#l78.1002"></a><span id="l78.1002" class="difflineplus">+    if (this._streamTimeout) {</span>
<a href="#l78.1003"></a><span id="l78.1003" class="difflineplus">+      clearTimeout(this._streamTimeout);</span>
<a href="#l78.1004"></a><span id="l78.1004" class="difflineplus">+    }</span>
<a href="#l78.1005"></a><span id="l78.1005" class="difflineplus">+    // The twitter Streaming API sends a keep-alive newline every 30 seconds</span>
<a href="#l78.1006"></a><span id="l78.1006" class="difflineplus">+    // so if we haven't received anything for 90s, we should disconnect and try</span>
<a href="#l78.1007"></a><span id="l78.1007" class="difflineplus">+    // to reconnect.</span>
<a href="#l78.1008"></a><span id="l78.1008" class="difflineplus">+    this._streamTimeout = setTimeout(this.onStreamTimeout.bind(this), 90000);</span>
<a href="#l78.1009"></a><span id="l78.1009" class="difflineplus">+  },</span>
<a href="#l78.1010"></a><span id="l78.1010" class="difflineplus">+  onStreamError(aError) {</span>
<a href="#l78.1011"></a><span id="l78.1011" class="difflineplus">+    delete this._streamingRequest;</span>
<a href="#l78.1012"></a><span id="l78.1012" class="difflineplus">+    // _streamTimeout is cleared by cleanUp called by gotDisconnected.</span>
<a href="#l78.1013"></a><span id="l78.1013" class="difflineplus">+    this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, aError);</span>
<a href="#l78.1014"></a><span id="l78.1014" class="difflineplus">+  },</span>
<a href="#l78.1015"></a><span id="l78.1015" class="difflineplus">+  onStreamTimeout() {</span>
<a href="#l78.1016"></a><span id="l78.1016" class="difflineplus">+    this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR, &quot;timeout&quot;);</span>
<a href="#l78.1017"></a><span id="l78.1017" class="difflineplus">+  },</span>
<a href="#l78.1018"></a><span id="l78.1018" class="difflineplus">+  onDataAvailable(aRequest) {</span>
<a href="#l78.1019"></a><span id="l78.1019" class="difflineplus">+    this.resetStreamTimeout();</span>
<a href="#l78.1020"></a><span id="l78.1020" class="difflineplus">+    let newText = this._pendingData + aRequest.target.response;</span>
<a href="#l78.1021"></a><span id="l78.1021" class="difflineplus">+    if (newText.trim()) {</span>
<a href="#l78.1022"></a><span id="l78.1022" class="difflineplus">+      this.DEBUG(&quot;Received data: &quot; + newText);</span>
<a href="#l78.1023"></a><span id="l78.1023" class="difflineplus">+    } else {</span>
<a href="#l78.1024"></a><span id="l78.1024" class="difflineplus">+      this.DEBUG(&quot;Received ping&quot;);</span>
<a href="#l78.1025"></a><span id="l78.1025" class="difflineplus">+    }</span>
<a href="#l78.1026"></a><span id="l78.1026" class="difflineplus">+    let messages = newText.split(/\r\n?/);</span>
<a href="#l78.1027"></a><span id="l78.1027" class="difflineplus">+    this._pendingData = messages.pop();</span>
<a href="#l78.1028"></a><span id="l78.1028" class="difflineplus">+    for (let message of messages) {</span>
<a href="#l78.1029"></a><span id="l78.1029" class="difflineplus">+      if (!message.trim()) {</span>
<a href="#l78.1030"></a><span id="l78.1030" class="difflineplus">+        continue;</span>
<a href="#l78.1031"></a><span id="l78.1031" class="difflineplus">+      }</span>
<a href="#l78.1032"></a><span id="l78.1032" class="difflineplus">+      let msg;</span>
<a href="#l78.1033"></a><span id="l78.1033" class="difflineplus">+      try {</span>
<a href="#l78.1034"></a><span id="l78.1034" class="difflineplus">+        msg = JSON.parse(message);</span>
<a href="#l78.1035"></a><span id="l78.1035" class="difflineplus">+      } catch (e) {</span>
<a href="#l78.1036"></a><span id="l78.1036" class="difflineplus">+        this.ERROR(e + &quot; while parsing &quot; + message);</span>
<a href="#l78.1037"></a><span id="l78.1037" class="difflineplus">+        continue;</span>
<a href="#l78.1038"></a><span id="l78.1038" class="difflineplus">+      }</span>
<a href="#l78.1039"></a><span id="l78.1039" class="difflineplus">+      if (&quot;direct_message&quot; in msg) {</span>
<a href="#l78.1040"></a><span id="l78.1040" class="difflineplus">+        let dm = msg.direct_message;</span>
<a href="#l78.1041"></a><span id="l78.1041" class="difflineplus">+        if (dm.sender_screen_name !== this.name) {</span>
<a href="#l78.1042"></a><span id="l78.1042" class="difflineplus">+          // These are displayed on send.</span>
<a href="#l78.1043"></a><span id="l78.1043" class="difflineplus">+          this.getConversation(dm.sender_screen_name).displayMessages([dm]);</span>
<a href="#l78.1044"></a><span id="l78.1044" class="difflineplus">+        }</span>
<a href="#l78.1045"></a><span id="l78.1045" class="difflineplus">+      } else if (&quot;text&quot; in msg) {</span>
<a href="#l78.1046"></a><span id="l78.1046" class="difflineplus">+        this.timeline.displayMessages([msg]);</span>
<a href="#l78.1047"></a><span id="l78.1047" class="difflineplus">+      } else if (&quot;friends&quot; in msg) {</span>
<a href="#l78.1048"></a><span id="l78.1048" class="difflineplus">+        // Filter out the IDs that info has already been received from (e.g. a</span>
<a href="#l78.1049"></a><span id="l78.1049" class="difflineplus">+        // tweet has been received as part of the timeline request).</span>
<a href="#l78.1050"></a><span id="l78.1050" class="difflineplus">+        let userInfoIds = new Set();</span>
<a href="#l78.1051"></a><span id="l78.1051" class="difflineplus">+        for (let userInfo of this._userInfo.values()) {</span>
<a href="#l78.1052"></a><span id="l78.1052" class="difflineplus">+          userInfoIds.add(userInfo.id_str);</span>
<a href="#l78.1053"></a><span id="l78.1053" class="difflineplus">+        }</span>
<a href="#l78.1054"></a><span id="l78.1054" class="difflineplus">+        let ids = msg.friends.filter(aId =&gt; !userInfoIds.has(aId.toString()));</span>
<a href="#l78.1055"></a><span id="l78.1055" class="difflineplus">+</span>
<a href="#l78.1056"></a><span id="l78.1056" class="difflineplus">+        while (ids.length) {</span>
<a href="#l78.1057"></a><span id="l78.1057" class="difflineplus">+          // Take the first 100 elements, turn them into a comma separated list.</span>
<a href="#l78.1058"></a><span id="l78.1058" class="difflineplus">+          this.signAndSend(</span>
<a href="#l78.1059"></a><span id="l78.1059" class="difflineplus">+            &quot;1.1/users/lookup.json&quot;,</span>
<a href="#l78.1060"></a><span id="l78.1060" class="difflineplus">+            null,</span>
<a href="#l78.1061"></a><span id="l78.1061" class="difflineplus">+            [[&quot;user_id&quot;, ids.slice(0, 99).join(&quot;,&quot;)]],</span>
<a href="#l78.1062"></a><span id="l78.1062" class="difflineplus">+            this.onLookupReceived,</span>
<a href="#l78.1063"></a><span id="l78.1063" class="difflineplus">+            null,</span>
<a href="#l78.1064"></a><span id="l78.1064" class="difflineplus">+            this</span>
<a href="#l78.1065"></a><span id="l78.1065" class="difflineplus">+          );</span>
<a href="#l78.1066"></a><span id="l78.1066" class="difflineplus">+          // Remove the first 100 elements.</span>
<a href="#l78.1067"></a><span id="l78.1067" class="difflineplus">+          ids = ids.slice(100);</span>
<a href="#l78.1068"></a><span id="l78.1068" class="difflineplus">+        }</span>
<a href="#l78.1069"></a><span id="l78.1069" class="difflineplus">+</span>
<a href="#l78.1070"></a><span id="l78.1070" class="difflineplus">+        // Overwrite the existing _friends list (if any).</span>
<a href="#l78.1071"></a><span id="l78.1071" class="difflineplus">+        this._friends = new Set(msg.friends.map(aId =&gt; aId.toString()));</span>
<a href="#l78.1072"></a><span id="l78.1072" class="difflineplus">+      } else if (&quot;event&quot; in msg) {</span>
<a href="#l78.1073"></a><span id="l78.1073" class="difflineplus">+        let user, event;</span>
<a href="#l78.1074"></a><span id="l78.1074" class="difflineplus">+        switch (msg.event) {</span>
<a href="#l78.1075"></a><span id="l78.1075" class="difflineplus">+          case &quot;follow&quot;:</span>
<a href="#l78.1076"></a><span id="l78.1076" class="difflineplus">+            if (msg.source.screen_name == this.name) {</span>
<a href="#l78.1077"></a><span id="l78.1077" class="difflineplus">+              user = msg.target;</span>
<a href="#l78.1078"></a><span id="l78.1078" class="difflineplus">+              event = &quot;follow&quot;;</span>
<a href="#l78.1079"></a><span id="l78.1079" class="difflineplus">+              this.setUserInfo(user);</span>
<a href="#l78.1080"></a><span id="l78.1080" class="difflineplus">+              this._friends.add(user.id_str);</span>
<a href="#l78.1081"></a><span id="l78.1081" class="difflineplus">+              this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l78.1082"></a><span id="l78.1082" class="difflineplus">+            } else if (msg.target.screen_name == this.name) {</span>
<a href="#l78.1083"></a><span id="l78.1083" class="difflineplus">+              user = msg.source;</span>
<a href="#l78.1084"></a><span id="l78.1084" class="difflineplus">+              event = &quot;followed&quot;;</span>
<a href="#l78.1085"></a><span id="l78.1085" class="difflineplus">+            }</span>
<a href="#l78.1086"></a><span id="l78.1086" class="difflineplus">+            if (user) {</span>
<a href="#l78.1087"></a><span id="l78.1087" class="difflineplus">+              this.setUserInfo(user);</span>
<a href="#l78.1088"></a><span id="l78.1088" class="difflineplus">+              this.timeline.systemMessage(</span>
<a href="#l78.1089"></a><span id="l78.1089" class="difflineplus">+                _(&quot;event.&quot; + event, user.screen_name),</span>
<a href="#l78.1090"></a><span id="l78.1090" class="difflineplus">+                false,</span>
<a href="#l78.1091"></a><span id="l78.1091" class="difflineplus">+                new Date(msg.created_at) / 1000</span>
<a href="#l78.1092"></a><span id="l78.1092" class="difflineplus">+              );</span>
<a href="#l78.1093"></a><span id="l78.1093" class="difflineplus">+            }</span>
<a href="#l78.1094"></a><span id="l78.1094" class="difflineplus">+            break;</span>
<a href="#l78.1095"></a><span id="l78.1095" class="difflineplus">+          case &quot;user_update&quot;:</span>
<a href="#l78.1096"></a><span id="l78.1096" class="difflineplus">+            this.setUserInfo(msg.target);</span>
<a href="#l78.1097"></a><span id="l78.1097" class="difflineplus">+            break;</span>
<a href="#l78.1098"></a><span id="l78.1098" class="difflineplus">+        }</span>
<a href="#l78.1099"></a><span id="l78.1099" class="difflineplus">+      }</span>
<a href="#l78.1100"></a><span id="l78.1100" class="difflineplus">+    }</span>
<a href="#l78.1101"></a><span id="l78.1101" class="difflineplus">+  },</span>
<a href="#l78.1102"></a><span id="l78.1102" class="difflineplus">+</span>
<a href="#l78.1103"></a><span id="l78.1103" class="difflineplus">+  requestToken() {</span>
<a href="#l78.1104"></a><span id="l78.1104" class="difflineplus">+    this.reportConnecting(_(&quot;connection.initAuth&quot;));</span>
<a href="#l78.1105"></a><span id="l78.1105" class="difflineplus">+    let oauthParams = [</span>
<a href="#l78.1106"></a><span id="l78.1106" class="difflineplus">+      [&quot;oauth_callback&quot;, encodeURIComponent(this.completionURI)],</span>
<a href="#l78.1107"></a><span id="l78.1107" class="difflineplus">+    ];</span>
<a href="#l78.1108"></a><span id="l78.1108" class="difflineplus">+    this.signAndSend(</span>
<a href="#l78.1109"></a><span id="l78.1109" class="difflineplus">+      &quot;oauth/request_token&quot;,</span>
<a href="#l78.1110"></a><span id="l78.1110" class="difflineplus">+      null,</span>
<a href="#l78.1111"></a><span id="l78.1111" class="difflineplus">+      [],</span>
<a href="#l78.1112"></a><span id="l78.1112" class="difflineplus">+      this.onRequestTokenReceived,</span>
<a href="#l78.1113"></a><span id="l78.1113" class="difflineplus">+      this.onError,</span>
<a href="#l78.1114"></a><span id="l78.1114" class="difflineplus">+      this,</span>
<a href="#l78.1115"></a><span id="l78.1115" class="difflineplus">+      oauthParams</span>
<a href="#l78.1116"></a><span id="l78.1116" class="difflineplus">+    );</span>
<a href="#l78.1117"></a><span id="l78.1117" class="difflineplus">+  },</span>
<a href="#l78.1118"></a><span id="l78.1118" class="difflineplus">+  onRequestTokenReceived(aData) {</span>
<a href="#l78.1119"></a><span id="l78.1119" class="difflineplus">+    this.LOG(&quot;Received request token.&quot;);</span>
<a href="#l78.1120"></a><span id="l78.1120" class="difflineplus">+    let data = this._parseURLData(aData);</span>
<a href="#l78.1121"></a><span id="l78.1121" class="difflineplus">+    if (</span>
<a href="#l78.1122"></a><span id="l78.1122" class="difflineplus">+      !data.oauth_callback_confirmed ||</span>
<a href="#l78.1123"></a><span id="l78.1123" class="difflineplus">+      !data.oauth_token ||</span>
<a href="#l78.1124"></a><span id="l78.1124" class="difflineplus">+      !data.oauth_token_secret</span>
<a href="#l78.1125"></a><span id="l78.1125" class="difflineplus">+    ) {</span>
<a href="#l78.1126"></a><span id="l78.1126" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l78.1127"></a><span id="l78.1127" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l78.1128"></a><span id="l78.1128" class="difflineplus">+        _(&quot;connection.failedToken&quot;)</span>
<a href="#l78.1129"></a><span id="l78.1129" class="difflineplus">+      );</span>
<a href="#l78.1130"></a><span id="l78.1130" class="difflineplus">+      return;</span>
<a href="#l78.1131"></a><span id="l78.1131" class="difflineplus">+    }</span>
<a href="#l78.1132"></a><span id="l78.1132" class="difflineplus">+    this.token = data.oauth_token;</span>
<a href="#l78.1133"></a><span id="l78.1133" class="difflineplus">+    this.tokenSecret = data.oauth_token_secret;</span>
<a href="#l78.1134"></a><span id="l78.1134" class="difflineplus">+</span>
<a href="#l78.1135"></a><span id="l78.1135" class="difflineplus">+    this.requestAuthorization();</span>
<a href="#l78.1136"></a><span id="l78.1136" class="difflineplus">+  },</span>
<a href="#l78.1137"></a><span id="l78.1137" class="difflineplus">+  requestAuthorization() {</span>
<a href="#l78.1138"></a><span id="l78.1138" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestAuth&quot;));</span>
<a href="#l78.1139"></a><span id="l78.1139" class="difflineplus">+    let url =</span>
<a href="#l78.1140"></a><span id="l78.1140" class="difflineplus">+      this.baseURI +</span>
<a href="#l78.1141"></a><span id="l78.1141" class="difflineplus">+      &quot;oauth/authorize?&quot; +</span>
<a href="#l78.1142"></a><span id="l78.1142" class="difflineplus">+      &quot;force_login=true&amp;&quot; + // ignore cookies</span>
<a href="#l78.1143"></a><span id="l78.1143" class="difflineplus">+      &quot;screen_name=&quot; +</span>
<a href="#l78.1144"></a><span id="l78.1144" class="difflineplus">+      this.name +</span>
<a href="#l78.1145"></a><span id="l78.1145" class="difflineplus">+      &quot;&amp;&quot; + // prefill the user name input box</span>
<a href="#l78.1146"></a><span id="l78.1146" class="difflineplus">+      &quot;oauth_token=&quot; +</span>
<a href="#l78.1147"></a><span id="l78.1147" class="difflineplus">+      this.token;</span>
<a href="#l78.1148"></a><span id="l78.1148" class="difflineplus">+    this._browserRequest = {</span>
<a href="#l78.1149"></a><span id="l78.1149" class="difflineplus">+      get promptText() {</span>
<a href="#l78.1150"></a><span id="l78.1150" class="difflineplus">+        return _(&quot;authPrompt&quot;);</span>
<a href="#l78.1151"></a><span id="l78.1151" class="difflineplus">+      },</span>
<a href="#l78.1152"></a><span id="l78.1152" class="difflineplus">+      account: this,</span>
<a href="#l78.1153"></a><span id="l78.1153" class="difflineplus">+      url,</span>
<a href="#l78.1154"></a><span id="l78.1154" class="difflineplus">+      _active: true,</span>
<a href="#l78.1155"></a><span id="l78.1155" class="difflineplus">+      cancelled() {</span>
<a href="#l78.1156"></a><span id="l78.1156" class="difflineplus">+        if (!this._active) {</span>
<a href="#l78.1157"></a><span id="l78.1157" class="difflineplus">+          return;</span>
<a href="#l78.1158"></a><span id="l78.1158" class="difflineplus">+        }</span>
<a href="#l78.1159"></a><span id="l78.1159" class="difflineplus">+</span>
<a href="#l78.1160"></a><span id="l78.1160" class="difflineplus">+        this.account.gotDisconnected(</span>
<a href="#l78.1161"></a><span id="l78.1161" class="difflineplus">+          Ci.prplIAccount.ERROR_AUTHENTICATION_FAILED,</span>
<a href="#l78.1162"></a><span id="l78.1162" class="difflineplus">+          _(&quot;connection.error.authCancelled&quot;)</span>
<a href="#l78.1163"></a><span id="l78.1163" class="difflineplus">+        );</span>
<a href="#l78.1164"></a><span id="l78.1164" class="difflineplus">+      },</span>
<a href="#l78.1165"></a><span id="l78.1165" class="difflineplus">+      loaded(aWindow, aWebProgress) {</span>
<a href="#l78.1166"></a><span id="l78.1166" class="difflineplus">+        if (!this._active) {</span>
<a href="#l78.1167"></a><span id="l78.1167" class="difflineplus">+          return;</span>
<a href="#l78.1168"></a><span id="l78.1168" class="difflineplus">+        }</span>
<a href="#l78.1169"></a><span id="l78.1169" class="difflineplus">+</span>
<a href="#l78.1170"></a><span id="l78.1170" class="difflineplus">+        this._listener = {</span>
<a href="#l78.1171"></a><span id="l78.1171" class="difflineplus">+          QueryInterface: ChromeUtils.generateQI([</span>
<a href="#l78.1172"></a><span id="l78.1172" class="difflineplus">+            Ci.nsIWebProgressListener,</span>
<a href="#l78.1173"></a><span id="l78.1173" class="difflineplus">+            Ci.nsISupportsWeakReference,</span>
<a href="#l78.1174"></a><span id="l78.1174" class="difflineplus">+          ]),</span>
<a href="#l78.1175"></a><span id="l78.1175" class="difflineplus">+          _cleanUp() {</span>
<a href="#l78.1176"></a><span id="l78.1176" class="difflineplus">+            this.webProgress.removeProgressListener(this);</span>
<a href="#l78.1177"></a><span id="l78.1177" class="difflineplus">+            this.window.close();</span>
<a href="#l78.1178"></a><span id="l78.1178" class="difflineplus">+            delete this.window;</span>
<a href="#l78.1179"></a><span id="l78.1179" class="difflineplus">+          },</span>
<a href="#l78.1180"></a><span id="l78.1180" class="difflineplus">+          _checkForRedirect(aURL) {</span>
<a href="#l78.1181"></a><span id="l78.1181" class="difflineplus">+            if (!aURL.startsWith(this._parent.completionURI)) {</span>
<a href="#l78.1182"></a><span id="l78.1182" class="difflineplus">+              return;</span>
<a href="#l78.1183"></a><span id="l78.1183" class="difflineplus">+            }</span>
<a href="#l78.1184"></a><span id="l78.1184" class="difflineplus">+</span>
<a href="#l78.1185"></a><span id="l78.1185" class="difflineplus">+            this._parent.finishAuthorizationRequest();</span>
<a href="#l78.1186"></a><span id="l78.1186" class="difflineplus">+            this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l78.1187"></a><span id="l78.1187" class="difflineplus">+          },</span>
<a href="#l78.1188"></a><span id="l78.1188" class="difflineplus">+          onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l78.1189"></a><span id="l78.1189" class="difflineplus">+            const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l78.1190"></a><span id="l78.1190" class="difflineplus">+            if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK)) {</span>
<a href="#l78.1191"></a><span id="l78.1191" class="difflineplus">+              this._checkForRedirect(aRequest.name);</span>
<a href="#l78.1192"></a><span id="l78.1192" class="difflineplus">+            }</span>
<a href="#l78.1193"></a><span id="l78.1193" class="difflineplus">+          },</span>
<a href="#l78.1194"></a><span id="l78.1194" class="difflineplus">+          onLocationChange(aWebProgress, aRequest, aLocation) {</span>
<a href="#l78.1195"></a><span id="l78.1195" class="difflineplus">+            this._checkForRedirect(aLocation.spec);</span>
<a href="#l78.1196"></a><span id="l78.1196" class="difflineplus">+          },</span>
<a href="#l78.1197"></a><span id="l78.1197" class="difflineplus">+          onProgressChange() {},</span>
<a href="#l78.1198"></a><span id="l78.1198" class="difflineplus">+          onStatusChange() {},</span>
<a href="#l78.1199"></a><span id="l78.1199" class="difflineplus">+          onSecurityChange() {},</span>
<a href="#l78.1200"></a><span id="l78.1200" class="difflineplus">+</span>
<a href="#l78.1201"></a><span id="l78.1201" class="difflineplus">+          window: aWindow,</span>
<a href="#l78.1202"></a><span id="l78.1202" class="difflineplus">+          webProgress: aWebProgress,</span>
<a href="#l78.1203"></a><span id="l78.1203" class="difflineplus">+          _parent: this.account,</span>
<a href="#l78.1204"></a><span id="l78.1204" class="difflineplus">+        };</span>
<a href="#l78.1205"></a><span id="l78.1205" class="difflineplus">+        aWebProgress.addProgressListener(</span>
<a href="#l78.1206"></a><span id="l78.1206" class="difflineplus">+          this._listener,</span>
<a href="#l78.1207"></a><span id="l78.1207" class="difflineplus">+          Ci.nsIWebProgress.NOTIFY_ALL</span>
<a href="#l78.1208"></a><span id="l78.1208" class="difflineplus">+        );</span>
<a href="#l78.1209"></a><span id="l78.1209" class="difflineplus">+      },</span>
<a href="#l78.1210"></a><span id="l78.1210" class="difflineplus">+      QueryInterface: ChromeUtils.generateQI([Ci.prplIRequestBrowser]),</span>
<a href="#l78.1211"></a><span id="l78.1211" class="difflineplus">+    };</span>
<a href="#l78.1212"></a><span id="l78.1212" class="difflineplus">+    Services.obs.notifyObservers(this._browserRequest, &quot;browser-request&quot;);</span>
<a href="#l78.1213"></a><span id="l78.1213" class="difflineplus">+  },</span>
<a href="#l78.1214"></a><span id="l78.1214" class="difflineplus">+  finishAuthorizationRequest() {</span>
<a href="#l78.1215"></a><span id="l78.1215" class="difflineplus">+    // Clean up the cookies, so that several twitter OAuth dialogs can work</span>
<a href="#l78.1216"></a><span id="l78.1216" class="difflineplus">+    // during the same session (bug 954308).</span>
<a href="#l78.1217"></a><span id="l78.1217" class="difflineplus">+    let cookies = Services.cookies.getCookiesFromHost(&quot;twitter.com&quot;, {});</span>
<a href="#l78.1218"></a><span id="l78.1218" class="difflineplus">+    while (cookies.hasMoreElements()) {</span>
<a href="#l78.1219"></a><span id="l78.1219" class="difflineplus">+      let cookie = cookies.getNext().QueryInterface(Ci.nsICookie);</span>
<a href="#l78.1220"></a><span id="l78.1220" class="difflineplus">+      Services.cookies.remove(</span>
<a href="#l78.1221"></a><span id="l78.1221" class="difflineplus">+        cookie.host,</span>
<a href="#l78.1222"></a><span id="l78.1222" class="difflineplus">+        cookie.name,</span>
<a href="#l78.1223"></a><span id="l78.1223" class="difflineplus">+        cookie.path,</span>
<a href="#l78.1224"></a><span id="l78.1224" class="difflineplus">+        false,</span>
<a href="#l78.1225"></a><span id="l78.1225" class="difflineplus">+        cookie.originAttributes</span>
<a href="#l78.1226"></a><span id="l78.1226" class="difflineplus">+      );</span>
<a href="#l78.1227"></a><span id="l78.1227" class="difflineplus">+    }</span>
<a href="#l78.1228"></a><span id="l78.1228" class="difflineplus">+</span>
<a href="#l78.1229"></a><span id="l78.1229" class="difflineplus">+    if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l78.1230"></a><span id="l78.1230" class="difflineplus">+      return;</span>
<a href="#l78.1231"></a><span id="l78.1231" class="difflineplus">+    }</span>
<a href="#l78.1232"></a><span id="l78.1232" class="difflineplus">+    this._browserRequest._active = false;</span>
<a href="#l78.1233"></a><span id="l78.1233" class="difflineplus">+    if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l78.1234"></a><span id="l78.1234" class="difflineplus">+      this._browserRequest._listener._cleanUp();</span>
<a href="#l78.1235"></a><span id="l78.1235" class="difflineplus">+    }</span>
<a href="#l78.1236"></a><span id="l78.1236" class="difflineplus">+    delete this._browserRequest;</span>
<a href="#l78.1237"></a><span id="l78.1237" class="difflineplus">+  },</span>
<a href="#l78.1238"></a><span id="l78.1238" class="difflineplus">+  onAuthorizationReceived(aData) {</span>
<a href="#l78.1239"></a><span id="l78.1239" class="difflineplus">+    let data = this._parseURLData(aData.split(&quot;?&quot;)[1]);</span>
<a href="#l78.1240"></a><span id="l78.1240" class="difflineplus">+    if (data.oauth_token != this.token || !data.oauth_verifier) {</span>
<a href="#l78.1241"></a><span id="l78.1241" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l78.1242"></a><span id="l78.1242" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l78.1243"></a><span id="l78.1243" class="difflineplus">+        _(&quot;connection.error.authFailed&quot;)</span>
<a href="#l78.1244"></a><span id="l78.1244" class="difflineplus">+      );</span>
<a href="#l78.1245"></a><span id="l78.1245" class="difflineplus">+      return;</span>
<a href="#l78.1246"></a><span id="l78.1246" class="difflineplus">+    }</span>
<a href="#l78.1247"></a><span id="l78.1247" class="difflineplus">+    this.requestAccessToken(data.oauth_verifier);</span>
<a href="#l78.1248"></a><span id="l78.1248" class="difflineplus">+  },</span>
<a href="#l78.1249"></a><span id="l78.1249" class="difflineplus">+  requestAccessToken(aTokenVerifier) {</span>
<a href="#l78.1250"></a><span id="l78.1250" class="difflineplus">+    this.reportConnecting(_(&quot;connection.requestAccess&quot;));</span>
<a href="#l78.1251"></a><span id="l78.1251" class="difflineplus">+    this.signAndSend(</span>
<a href="#l78.1252"></a><span id="l78.1252" class="difflineplus">+      &quot;oauth/access_token&quot;,</span>
<a href="#l78.1253"></a><span id="l78.1253" class="difflineplus">+      null,</span>
<a href="#l78.1254"></a><span id="l78.1254" class="difflineplus">+      [],</span>
<a href="#l78.1255"></a><span id="l78.1255" class="difflineplus">+      this.onAccessTokenReceived,</span>
<a href="#l78.1256"></a><span id="l78.1256" class="difflineplus">+      this.onError,</span>
<a href="#l78.1257"></a><span id="l78.1257" class="difflineplus">+      this,</span>
<a href="#l78.1258"></a><span id="l78.1258" class="difflineplus">+      [[&quot;oauth_verifier&quot;, aTokenVerifier]]</span>
<a href="#l78.1259"></a><span id="l78.1259" class="difflineplus">+    );</span>
<a href="#l78.1260"></a><span id="l78.1260" class="difflineplus">+  },</span>
<a href="#l78.1261"></a><span id="l78.1261" class="difflineplus">+  onAccessTokenReceived(aData) {</span>
<a href="#l78.1262"></a><span id="l78.1262" class="difflineplus">+    this.LOG(&quot;Received access token.&quot;);</span>
<a href="#l78.1263"></a><span id="l78.1263" class="difflineplus">+    let result = this._parseURLData(aData);</span>
<a href="#l78.1264"></a><span id="l78.1264" class="difflineplus">+    if (!this.fixAccountName(result)) {</span>
<a href="#l78.1265"></a><span id="l78.1265" class="difflineplus">+      return;</span>
<a href="#l78.1266"></a><span id="l78.1266" class="difflineplus">+    }</span>
<a href="#l78.1267"></a><span id="l78.1267" class="difflineplus">+</span>
<a href="#l78.1268"></a><span id="l78.1268" class="difflineplus">+    let prefValue = {};</span>
<a href="#l78.1269"></a><span id="l78.1269" class="difflineplus">+    try {</span>
<a href="#l78.1270"></a><span id="l78.1270" class="difflineplus">+      JSON.parse(this.prefs.getCharPref(&quot;oauth&quot;));</span>
<a href="#l78.1271"></a><span id="l78.1271" class="difflineplus">+    } catch (e) {}</span>
<a href="#l78.1272"></a><span id="l78.1272" class="difflineplus">+    prefValue[this.consumerKey] = result;</span>
<a href="#l78.1273"></a><span id="l78.1273" class="difflineplus">+    this.prefs.setCharPref(&quot;oauth&quot;, JSON.stringify(prefValue));</span>
<a href="#l78.1274"></a><span id="l78.1274" class="difflineplus">+</span>
<a href="#l78.1275"></a><span id="l78.1275" class="difflineplus">+    this.token = result.oauth_token;</span>
<a href="#l78.1276"></a><span id="l78.1276" class="difflineplus">+    this.tokenSecret = result.oauth_token_secret;</span>
<a href="#l78.1277"></a><span id="l78.1277" class="difflineplus">+</span>
<a href="#l78.1278"></a><span id="l78.1278" class="difflineplus">+    this.getTimelines();</span>
<a href="#l78.1279"></a><span id="l78.1279" class="difflineplus">+  },</span>
<a href="#l78.1280"></a><span id="l78.1280" class="difflineplus">+  fixAccountName(aAuthResult) {</span>
<a href="#l78.1281"></a><span id="l78.1281" class="difflineplus">+    if (!aAuthResult.screen_name || aAuthResult.screen_name == this.name) {</span>
<a href="#l78.1282"></a><span id="l78.1282" class="difflineplus">+      return true;</span>
<a href="#l78.1283"></a><span id="l78.1283" class="difflineplus">+    }</span>
<a href="#l78.1284"></a><span id="l78.1284" class="difflineplus">+</span>
<a href="#l78.1285"></a><span id="l78.1285" class="difflineplus">+    if (aAuthResult.screen_name.toLowerCase() != this.name.toLowerCase()) {</span>
<a href="#l78.1286"></a><span id="l78.1286" class="difflineplus">+      this.onError(_(&quot;connection.error.userMismatch&quot;));</span>
<a href="#l78.1287"></a><span id="l78.1287" class="difflineplus">+      return false;</span>
<a href="#l78.1288"></a><span id="l78.1288" class="difflineplus">+    }</span>
<a href="#l78.1289"></a><span id="l78.1289" class="difflineplus">+</span>
<a href="#l78.1290"></a><span id="l78.1290" class="difflineplus">+    this.LOG(</span>
<a href="#l78.1291"></a><span id="l78.1291" class="difflineplus">+      &quot;Fixing the case of the account name: &quot; +</span>
<a href="#l78.1292"></a><span id="l78.1292" class="difflineplus">+        this.name +</span>
<a href="#l78.1293"></a><span id="l78.1293" class="difflineplus">+        &quot; -&gt; &quot; +</span>
<a href="#l78.1294"></a><span id="l78.1294" class="difflineplus">+        aAuthResult.screen_name</span>
<a href="#l78.1295"></a><span id="l78.1295" class="difflineplus">+    );</span>
<a href="#l78.1296"></a><span id="l78.1296" class="difflineplus">+    this.__defineGetter__(&quot;name&quot;, () =&gt; aAuthResult.screen_name);</span>
<a href="#l78.1297"></a><span id="l78.1297" class="difflineplus">+    return true;</span>
<a href="#l78.1298"></a><span id="l78.1298" class="difflineplus">+  },</span>
<a href="#l78.1299"></a><span id="l78.1299" class="difflineplus">+</span>
<a href="#l78.1300"></a><span id="l78.1300" class="difflineplus">+  cleanUp() {</span>
<a href="#l78.1301"></a><span id="l78.1301" class="difflineplus">+    this.finishAuthorizationRequest();</span>
<a href="#l78.1302"></a><span id="l78.1302" class="difflineplus">+    if (this._pendingRequests.length != 0) {</span>
<a href="#l78.1303"></a><span id="l78.1303" class="difflineplus">+      for (let request of this._pendingRequests) {</span>
<a href="#l78.1304"></a><span id="l78.1304" class="difflineplus">+        request.abort();</span>
<a href="#l78.1305"></a><span id="l78.1305" class="difflineplus">+      }</span>
<a href="#l78.1306"></a><span id="l78.1306" class="difflineplus">+      delete this._pendingRequests;</span>
<a href="#l78.1307"></a><span id="l78.1307" class="difflineplus">+    }</span>
<a href="#l78.1308"></a><span id="l78.1308" class="difflineplus">+    if (this._streamTimeout) {</span>
<a href="#l78.1309"></a><span id="l78.1309" class="difflineplus">+      clearTimeout(this._streamTimeout);</span>
<a href="#l78.1310"></a><span id="l78.1310" class="difflineplus">+      delete this._streamTimeout;</span>
<a href="#l78.1311"></a><span id="l78.1311" class="difflineplus">+      // Remove the preference observer that is added when the user stream is</span>
<a href="#l78.1312"></a><span id="l78.1312" class="difflineplus">+      // opened. (This needs to be removed even if an error occurs, in which</span>
<a href="#l78.1313"></a><span id="l78.1313" class="difflineplus">+      // case _streamingRequest is immediately deleted.)</span>
<a href="#l78.1314"></a><span id="l78.1314" class="difflineplus">+      this.prefs.removeObserver(&quot;track&quot;, this);</span>
<a href="#l78.1315"></a><span id="l78.1315" class="difflineplus">+    }</span>
<a href="#l78.1316"></a><span id="l78.1316" class="difflineplus">+    if (this._streamingRequest) {</span>
<a href="#l78.1317"></a><span id="l78.1317" class="difflineplus">+      this._streamingRequest.abort();</span>
<a href="#l78.1318"></a><span id="l78.1318" class="difflineplus">+      delete this._streamingRequest;</span>
<a href="#l78.1319"></a><span id="l78.1319" class="difflineplus">+    }</span>
<a href="#l78.1320"></a><span id="l78.1320" class="difflineplus">+    delete this._pendingData;</span>
<a href="#l78.1321"></a><span id="l78.1321" class="difflineplus">+    delete this.token;</span>
<a href="#l78.1322"></a><span id="l78.1322" class="difflineplus">+    delete this.tokenSecret;</span>
<a href="#l78.1323"></a><span id="l78.1323" class="difflineplus">+  },</span>
<a href="#l78.1324"></a><span id="l78.1324" class="difflineplus">+  gotDisconnected(aError, aErrorMessage) {</span>
<a href="#l78.1325"></a><span id="l78.1325" class="difflineplus">+    if (this.disconnected || this.disconnecting) {</span>
<a href="#l78.1326"></a><span id="l78.1326" class="difflineplus">+      return;</span>
<a href="#l78.1327"></a><span id="l78.1327" class="difflineplus">+    }</span>
<a href="#l78.1328"></a><span id="l78.1328" class="difflineplus">+</span>
<a href="#l78.1329"></a><span id="l78.1329" class="difflineplus">+    if (aError === undefined) {</span>
<a href="#l78.1330"></a><span id="l78.1330" class="difflineplus">+      aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l78.1331"></a><span id="l78.1331" class="difflineplus">+    }</span>
<a href="#l78.1332"></a><span id="l78.1332" class="difflineplus">+    let connected = this.connected;</span>
<a href="#l78.1333"></a><span id="l78.1333" class="difflineplus">+    this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l78.1334"></a><span id="l78.1334" class="difflineplus">+    this.cleanUp();</span>
<a href="#l78.1335"></a><span id="l78.1335" class="difflineplus">+    if (this._timeline &amp;&amp; connected) {</span>
<a href="#l78.1336"></a><span id="l78.1336" class="difflineplus">+      this._timeline.notifyObservers(this._timeline, &quot;update-conv-chatleft&quot;);</span>
<a href="#l78.1337"></a><span id="l78.1337" class="difflineplus">+    }</span>
<a href="#l78.1338"></a><span id="l78.1338" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l78.1339"></a><span id="l78.1339" class="difflineplus">+  },</span>
<a href="#l78.1340"></a><span id="l78.1340" class="difflineplus">+  remove() {</span>
<a href="#l78.1341"></a><span id="l78.1341" class="difflineplus">+    if (!this._timeline) {</span>
<a href="#l78.1342"></a><span id="l78.1342" class="difflineplus">+      return;</span>
<a href="#l78.1343"></a><span id="l78.1343" class="difflineplus">+    }</span>
<a href="#l78.1344"></a><span id="l78.1344" class="difflineplus">+    this._timeline.close();</span>
<a href="#l78.1345"></a><span id="l78.1345" class="difflineplus">+    delete this._timeline;</span>
<a href="#l78.1346"></a><span id="l78.1346" class="difflineplus">+  },</span>
<a href="#l78.1347"></a><span id="l78.1347" class="difflineplus">+  unInit() {</span>
<a href="#l78.1348"></a><span id="l78.1348" class="difflineplus">+    this.cleanUp();</span>
<a href="#l78.1349"></a><span id="l78.1349" class="difflineplus">+  },</span>
<a href="#l78.1350"></a><span id="l78.1350" class="difflineplus">+  disconnect() {</span>
<a href="#l78.1351"></a><span id="l78.1351" class="difflineplus">+    this.gotDisconnected();</span>
<a href="#l78.1352"></a><span id="l78.1352" class="difflineplus">+  },</span>
<a href="#l78.1353"></a><span id="l78.1353" class="difflineplus">+</span>
<a href="#l78.1354"></a><span id="l78.1354" class="difflineplus">+  onError(aException) {</span>
<a href="#l78.1355"></a><span id="l78.1355" class="difflineplus">+    if (aException == &quot;offline&quot;) {</span>
<a href="#l78.1356"></a><span id="l78.1356" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l78.1357"></a><span id="l78.1357" class="difflineplus">+        Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l78.1358"></a><span id="l78.1358" class="difflineplus">+        _(&quot;connection.error.noNetwork&quot;)</span>
<a href="#l78.1359"></a><span id="l78.1359" class="difflineplus">+      );</span>
<a href="#l78.1360"></a><span id="l78.1360" class="difflineplus">+    } else {</span>
<a href="#l78.1361"></a><span id="l78.1361" class="difflineplus">+      this.gotDisconnected(</span>
<a href="#l78.1362"></a><span id="l78.1362" class="difflineplus">+        Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l78.1363"></a><span id="l78.1363" class="difflineplus">+        aException.toString()</span>
<a href="#l78.1364"></a><span id="l78.1364" class="difflineplus">+      );</span>
<a href="#l78.1365"></a><span id="l78.1365" class="difflineplus">+    }</span>
<a href="#l78.1366"></a><span id="l78.1366" class="difflineplus">+  },</span>
<a href="#l78.1367"></a><span id="l78.1367" class="difflineplus">+</span>
<a href="#l78.1368"></a><span id="l78.1368" class="difflineplus">+  setUserDescription(aDescription) {</span>
<a href="#l78.1369"></a><span id="l78.1369" class="difflineplus">+    const kMaxUserDescriptionLength = 160;</span>
<a href="#l78.1370"></a><span id="l78.1370" class="difflineplus">+    if (aDescription.length &gt; kMaxUserDescriptionLength) {</span>
<a href="#l78.1371"></a><span id="l78.1371" class="difflineplus">+      aDescription = aDescription.substr(0, kMaxUserDescriptionLength);</span>
<a href="#l78.1372"></a><span id="l78.1372" class="difflineplus">+      this.WARN(</span>
<a href="#l78.1373"></a><span id="l78.1373" class="difflineplus">+        &quot;Description too long (over &quot; +</span>
<a href="#l78.1374"></a><span id="l78.1374" class="difflineplus">+          kMaxUserDescriptionLength +</span>
<a href="#l78.1375"></a><span id="l78.1375" class="difflineplus">+          &quot; characters):\n&quot; +</span>
<a href="#l78.1376"></a><span id="l78.1376" class="difflineplus">+          aDescription +</span>
<a href="#l78.1377"></a><span id="l78.1377" class="difflineplus">+          &quot;.&quot;</span>
<a href="#l78.1378"></a><span id="l78.1378" class="difflineplus">+      );</span>
<a href="#l78.1379"></a><span id="l78.1379" class="difflineplus">+      this.timeline.systemMessage(_(&quot;error.descriptionTooLong&quot;, aDescription));</span>
<a href="#l78.1380"></a><span id="l78.1380" class="difflineplus">+    }</span>
<a href="#l78.1381"></a><span id="l78.1381" class="difflineplus">+    // Don't need to catch the reply since the stream receives user_update.</span>
<a href="#l78.1382"></a><span id="l78.1382" class="difflineplus">+    this.signAndSend(&quot;1.1/account/update_profile.json&quot;, null, [</span>
<a href="#l78.1383"></a><span id="l78.1383" class="difflineplus">+      [&quot;description&quot;, aDescription],</span>
<a href="#l78.1384"></a><span id="l78.1384" class="difflineplus">+    ]);</span>
<a href="#l78.1385"></a><span id="l78.1385" class="difflineplus">+  },</span>
<a href="#l78.1386"></a><span id="l78.1386" class="difflineplus">+</span>
<a href="#l78.1387"></a><span id="l78.1387" class="difflineplus">+  setUserInfo(aUser) {</span>
<a href="#l78.1388"></a><span id="l78.1388" class="difflineplus">+    let nick = aUser.screen_name;</span>
<a href="#l78.1389"></a><span id="l78.1389" class="difflineplus">+    this._userInfo.set(nick, aUser);</span>
<a href="#l78.1390"></a><span id="l78.1390" class="difflineplus">+</span>
<a href="#l78.1391"></a><span id="l78.1391" class="difflineplus">+    // If it's the user's userInfo, update the timeline topic.</span>
<a href="#l78.1392"></a><span id="l78.1392" class="difflineplus">+    if (nick == this.name &amp;&amp; &quot;description&quot; in aUser) {</span>
<a href="#l78.1393"></a><span id="l78.1393" class="difflineplus">+      this.timeline.setTopic(aUser.description, nick, true);</span>
<a href="#l78.1394"></a><span id="l78.1394" class="difflineplus">+    }</span>
<a href="#l78.1395"></a><span id="l78.1395" class="difflineplus">+  },</span>
<a href="#l78.1396"></a><span id="l78.1396" class="difflineplus">+  onRequestedInfoReceived(aData) {</span>
<a href="#l78.1397"></a><span id="l78.1397" class="difflineplus">+    let user = JSON.parse(aData);</span>
<a href="#l78.1398"></a><span id="l78.1398" class="difflineplus">+    this.setUserInfo(user);</span>
<a href="#l78.1399"></a><span id="l78.1399" class="difflineplus">+    this.requestBuddyInfo(user.screen_name);</span>
<a href="#l78.1400"></a><span id="l78.1400" class="difflineplus">+  },</span>
<a href="#l78.1401"></a><span id="l78.1401" class="difflineplus">+  requestBuddyInfo(aBuddyName) {</span>
<a href="#l78.1402"></a><span id="l78.1402" class="difflineplus">+    let userInfo = this._userInfo.get(aBuddyName);</span>
<a href="#l78.1403"></a><span id="l78.1403" class="difflineplus">+    if (!userInfo) {</span>
<a href="#l78.1404"></a><span id="l78.1404" class="difflineplus">+      this.signAndSend(</span>
<a href="#l78.1405"></a><span id="l78.1405" class="difflineplus">+        &quot;1.1/users/show.json?screen_name=&quot; + aBuddyName,</span>
<a href="#l78.1406"></a><span id="l78.1406" class="difflineplus">+        null,</span>
<a href="#l78.1407"></a><span id="l78.1407" class="difflineplus">+        null,</span>
<a href="#l78.1408"></a><span id="l78.1408" class="difflineplus">+        this.onRequestedInfoReceived,</span>
<a href="#l78.1409"></a><span id="l78.1409" class="difflineplus">+        null,</span>
<a href="#l78.1410"></a><span id="l78.1410" class="difflineplus">+        this</span>
<a href="#l78.1411"></a><span id="l78.1411" class="difflineplus">+      );</span>
<a href="#l78.1412"></a><span id="l78.1412" class="difflineplus">+      return;</span>
<a href="#l78.1413"></a><span id="l78.1413" class="difflineplus">+    }</span>
<a href="#l78.1414"></a><span id="l78.1414" class="difflineplus">+</span>
<a href="#l78.1415"></a><span id="l78.1415" class="difflineplus">+    // List of the names of the info to actually show in the tooltip and</span>
<a href="#l78.1416"></a><span id="l78.1416" class="difflineplus">+    // optionally a transform function to apply to the value.</span>
<a href="#l78.1417"></a><span id="l78.1417" class="difflineplus">+    // See https://dev.twitter.com/docs/api/1/get/users/show for the options.</span>
<a href="#l78.1418"></a><span id="l78.1418" class="difflineplus">+    let normalizeBool = isFollowing =&gt; _(isFollowing ? &quot;yes&quot; : &quot;no&quot;);</span>
<a href="#l78.1419"></a><span id="l78.1419" class="difflineplus">+    const kFields = {</span>
<a href="#l78.1420"></a><span id="l78.1420" class="difflineplus">+      name: null,</span>
<a href="#l78.1421"></a><span id="l78.1421" class="difflineplus">+      following: normalizeBool,</span>
<a href="#l78.1422"></a><span id="l78.1422" class="difflineplus">+      description: null,</span>
<a href="#l78.1423"></a><span id="l78.1423" class="difflineplus">+      url: null,</span>
<a href="#l78.1424"></a><span id="l78.1424" class="difflineplus">+      location: null,</span>
<a href="#l78.1425"></a><span id="l78.1425" class="difflineplus">+      lang(aLang) {</span>
<a href="#l78.1426"></a><span id="l78.1426" class="difflineplus">+        try {</span>
<a href="#l78.1427"></a><span id="l78.1427" class="difflineplus">+          return _lang(aLang);</span>
<a href="#l78.1428"></a><span id="l78.1428" class="difflineplus">+        } catch (e) {</span>
<a href="#l78.1429"></a><span id="l78.1429" class="difflineplus">+          return aLang;</span>
<a href="#l78.1430"></a><span id="l78.1430" class="difflineplus">+        }</span>
<a href="#l78.1431"></a><span id="l78.1431" class="difflineplus">+      },</span>
<a href="#l78.1432"></a><span id="l78.1432" class="difflineplus">+      time_zone: null,</span>
<a href="#l78.1433"></a><span id="l78.1433" class="difflineplus">+      protected: normalizeBool,</span>
<a href="#l78.1434"></a><span id="l78.1434" class="difflineplus">+      created_at(aDate) {</span>
<a href="#l78.1435"></a><span id="l78.1435" class="difflineplus">+        const dateFormatter = new Services.intl.DateTimeFormat(undefined, {</span>
<a href="#l78.1436"></a><span id="l78.1436" class="difflineplus">+          dateStyle: &quot;short&quot;,</span>
<a href="#l78.1437"></a><span id="l78.1437" class="difflineplus">+        });</span>
<a href="#l78.1438"></a><span id="l78.1438" class="difflineplus">+        return dateFormatter.format(new Date(aDate));</span>
<a href="#l78.1439"></a><span id="l78.1439" class="difflineplus">+      },</span>
<a href="#l78.1440"></a><span id="l78.1440" class="difflineplus">+      statuses_count: null,</span>
<a href="#l78.1441"></a><span id="l78.1441" class="difflineplus">+      friends_count: null,</span>
<a href="#l78.1442"></a><span id="l78.1442" class="difflineplus">+      followers_count: null,</span>
<a href="#l78.1443"></a><span id="l78.1443" class="difflineplus">+      listed_count: null,</span>
<a href="#l78.1444"></a><span id="l78.1444" class="difflineplus">+    };</span>
<a href="#l78.1445"></a><span id="l78.1445" class="difflineplus">+</span>
<a href="#l78.1446"></a><span id="l78.1446" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l78.1447"></a><span id="l78.1447" class="difflineplus">+    for (let field in kFields) {</span>
<a href="#l78.1448"></a><span id="l78.1448" class="difflineplus">+      if (</span>
<a href="#l78.1449"></a><span id="l78.1449" class="difflineplus">+        Object.prototype.hasOwnProperty.call(userInfo, field) &amp;&amp;</span>
<a href="#l78.1450"></a><span id="l78.1450" class="difflineplus">+        userInfo[field]</span>
<a href="#l78.1451"></a><span id="l78.1451" class="difflineplus">+      ) {</span>
<a href="#l78.1452"></a><span id="l78.1452" class="difflineplus">+        let value = userInfo[field];</span>
<a href="#l78.1453"></a><span id="l78.1453" class="difflineplus">+        if (kFields[field]) {</span>
<a href="#l78.1454"></a><span id="l78.1454" class="difflineplus">+          value = kFields[field](value);</span>
<a href="#l78.1455"></a><span id="l78.1455" class="difflineplus">+        }</span>
<a href="#l78.1456"></a><span id="l78.1456" class="difflineplus">+        tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l78.1457"></a><span id="l78.1457" class="difflineplus">+      }</span>
<a href="#l78.1458"></a><span id="l78.1458" class="difflineplus">+    }</span>
<a href="#l78.1459"></a><span id="l78.1459" class="difflineplus">+    tooltipInfo.push(</span>
<a href="#l78.1460"></a><span id="l78.1460" class="difflineplus">+      new TooltipInfo(</span>
<a href="#l78.1461"></a><span id="l78.1461" class="difflineplus">+        null,</span>
<a href="#l78.1462"></a><span id="l78.1462" class="difflineplus">+        userInfo.profile_image_url,</span>
<a href="#l78.1463"></a><span id="l78.1463" class="difflineplus">+        Ci.prplITooltipInfo.icon</span>
<a href="#l78.1464"></a><span id="l78.1464" class="difflineplus">+      )</span>
<a href="#l78.1465"></a><span id="l78.1465" class="difflineplus">+    );</span>
<a href="#l78.1466"></a><span id="l78.1466" class="difflineplus">+</span>
<a href="#l78.1467"></a><span id="l78.1467" class="difflineplus">+    Services.obs.notifyObservers(</span>
<a href="#l78.1468"></a><span id="l78.1468" class="difflineplus">+      new nsSimpleEnumerator(tooltipInfo),</span>
<a href="#l78.1469"></a><span id="l78.1469" class="difflineplus">+      &quot;user-info-received&quot;,</span>
<a href="#l78.1470"></a><span id="l78.1470" class="difflineplus">+      aBuddyName</span>
<a href="#l78.1471"></a><span id="l78.1471" class="difflineplus">+    );</span>
<a href="#l78.1472"></a><span id="l78.1472" class="difflineplus">+  },</span>
<a href="#l78.1473"></a><span id="l78.1473" class="difflineplus">+</span>
<a href="#l78.1474"></a><span id="l78.1474" class="difflineplus">+  // Handle the full user info for each received friend. Set the user info and</span>
<a href="#l78.1475"></a><span id="l78.1475" class="difflineplus">+  // create the participant.</span>
<a href="#l78.1476"></a><span id="l78.1476" class="difflineplus">+  onLookupReceived(aData) {</span>
<a href="#l78.1477"></a><span id="l78.1477" class="difflineplus">+    let users = JSON.parse(aData);</span>
<a href="#l78.1478"></a><span id="l78.1478" class="difflineplus">+    for (let user of users) {</span>
<a href="#l78.1479"></a><span id="l78.1479" class="difflineplus">+      this.setUserInfo(user);</span>
<a href="#l78.1480"></a><span id="l78.1480" class="difflineplus">+      this.timeline._ensureParticipantExists(user.screen_name);</span>
<a href="#l78.1481"></a><span id="l78.1481" class="difflineplus">+    }</span>
<a href="#l78.1482"></a><span id="l78.1482" class="difflineplus">+  },</span>
<a href="#l78.1483"></a><span id="l78.1483" class="difflineplus">+</span>
<a href="#l78.1484"></a><span id="l78.1484" class="difflineplus">+  // Allow us to reopen the timeline via the join chat menu.</span>
<a href="#l78.1485"></a><span id="l78.1485" class="difflineplus">+  get canJoinChat() {</span>
<a href="#l78.1486"></a><span id="l78.1486" class="difflineplus">+    return true;</span>
<a href="#l78.1487"></a><span id="l78.1487" class="difflineplus">+  },</span>
<a href="#l78.1488"></a><span id="l78.1488" class="difflineplus">+  joinChat(aComponents) {</span>
<a href="#l78.1489"></a><span id="l78.1489" class="difflineplus">+    // The 'timeline' getter opens a timeline conversation if none exists.</span>
<a href="#l78.1490"></a><span id="l78.1490" class="difflineplus">+    this.timeline;</span>
<a href="#l78.1491"></a><span id="l78.1491" class="difflineplus">+  },</span>
<a href="#l78.1492"></a><span id="l78.1492" class="difflineplus">+</span>
<a href="#l78.1493"></a><span id="l78.1493" class="difflineplus">+  getConversation(aName) {</span>
<a href="#l78.1494"></a><span id="l78.1494" class="difflineplus">+    if (!this._conversations.has(aName)) {</span>
<a href="#l78.1495"></a><span id="l78.1495" class="difflineplus">+      this._conversations.set(</span>
<a href="#l78.1496"></a><span id="l78.1496" class="difflineplus">+        aName,</span>
<a href="#l78.1497"></a><span id="l78.1497" class="difflineplus">+        new DirectMessageConversation(this, aName)</span>
<a href="#l78.1498"></a><span id="l78.1498" class="difflineplus">+      );</span>
<a href="#l78.1499"></a><span id="l78.1499" class="difflineplus">+    }</span>
<a href="#l78.1500"></a><span id="l78.1500" class="difflineplus">+    return this._conversations.get(aName);</span>
<a href="#l78.1501"></a><span id="l78.1501" class="difflineplus">+  },</span>
<a href="#l78.1502"></a><span id="l78.1502" class="difflineplus">+  removeConversation(aName) {</span>
<a href="#l78.1503"></a><span id="l78.1503" class="difflineplus">+    if (this._conversations.has(aName)) {</span>
<a href="#l78.1504"></a><span id="l78.1504" class="difflineplus">+      this._conversations.delete(aName);</span>
<a href="#l78.1505"></a><span id="l78.1505" class="difflineplus">+    }</span>
<a href="#l78.1506"></a><span id="l78.1506" class="difflineplus">+  },</span>
<a href="#l78.1507"></a><span id="l78.1507" class="difflineplus">+  createConversation(aName) {</span>
<a href="#l78.1508"></a><span id="l78.1508" class="difflineplus">+    return this.getConversation(aName);</span>
<a href="#l78.1509"></a><span id="l78.1509" class="difflineplus">+  },</span>
<a href="#l78.1510"></a><span id="l78.1510" class="difflineplus">+};</span>
<a href="#l78.1511"></a><span id="l78.1511" class="difflineplus">+</span>
<a href="#l78.1512"></a><span id="l78.1512" class="difflineplus">+// Shortcut to get the JavaScript account object.</span>
<a href="#l78.1513"></a><span id="l78.1513" class="difflineplus">+function getAccount(aConv) {</span>
<a href="#l78.1514"></a><span id="l78.1514" class="difflineplus">+  return aConv.wrappedJSObject._account;</span>
<a href="#l78.1515"></a><span id="l78.1515" class="difflineplus">+}</span>
<a href="#l78.1516"></a><span id="l78.1516" class="difflineplus">+</span>
<a href="#l78.1517"></a><span id="l78.1517" class="difflineplus">+function TwitterProtocol() {</span>
<a href="#l78.1518"></a><span id="l78.1518" class="difflineplus">+  this.registerCommands();</span>
<a href="#l78.1519"></a><span id="l78.1519" class="difflineplus">+}</span>
<a href="#l78.1520"></a><span id="l78.1520" class="difflineplus">+TwitterProtocol.prototype = {</span>
<a href="#l78.1521"></a><span id="l78.1521" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l78.1522"></a><span id="l78.1522" class="difflineplus">+  get normalizedName() {</span>
<a href="#l78.1523"></a><span id="l78.1523" class="difflineplus">+    return &quot;twitter&quot;;</span>
<a href="#l78.1524"></a><span id="l78.1524" class="difflineplus">+  },</span>
<a href="#l78.1525"></a><span id="l78.1525" class="difflineplus">+  get name() {</span>
<a href="#l78.1526"></a><span id="l78.1526" class="difflineplus">+    return _(&quot;twitter.protocolName&quot;);</span>
<a href="#l78.1527"></a><span id="l78.1527" class="difflineplus">+  },</span>
<a href="#l78.1528"></a><span id="l78.1528" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l78.1529"></a><span id="l78.1529" class="difflineplus">+    return &quot;chrome://prpl-twitter/skin/&quot;;</span>
<a href="#l78.1530"></a><span id="l78.1530" class="difflineplus">+  },</span>
<a href="#l78.1531"></a><span id="l78.1531" class="difflineplus">+  get noPassword() {</span>
<a href="#l78.1532"></a><span id="l78.1532" class="difflineplus">+    return true;</span>
<a href="#l78.1533"></a><span id="l78.1533" class="difflineplus">+  },</span>
<a href="#l78.1534"></a><span id="l78.1534" class="difflineplus">+  options: {</span>
<a href="#l78.1535"></a><span id="l78.1535" class="difflineplus">+    track: {</span>
<a href="#l78.1536"></a><span id="l78.1536" class="difflineplus">+      get label() {</span>
<a href="#l78.1537"></a><span id="l78.1537" class="difflineplus">+        return _(&quot;options.track&quot;);</span>
<a href="#l78.1538"></a><span id="l78.1538" class="difflineplus">+      },</span>
<a href="#l78.1539"></a><span id="l78.1539" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l78.1540"></a><span id="l78.1540" class="difflineplus">+    },</span>
<a href="#l78.1541"></a><span id="l78.1541" class="difflineplus">+  },</span>
<a href="#l78.1542"></a><span id="l78.1542" class="difflineplus">+  // Replace the command name in the help string so translators do not attempt</span>
<a href="#l78.1543"></a><span id="l78.1543" class="difflineplus">+  // to translate it.</span>
<a href="#l78.1544"></a><span id="l78.1544" class="difflineplus">+  commands: [</span>
<a href="#l78.1545"></a><span id="l78.1545" class="difflineplus">+    {</span>
<a href="#l78.1546"></a><span id="l78.1546" class="difflineplus">+      name: &quot;follow&quot;,</span>
<a href="#l78.1547"></a><span id="l78.1547" class="difflineplus">+      get helpString() {</span>
<a href="#l78.1548"></a><span id="l78.1548" class="difflineplus">+        return _(&quot;command.follow&quot;, &quot;follow&quot;);</span>
<a href="#l78.1549"></a><span id="l78.1549" class="difflineplus">+      },</span>
<a href="#l78.1550"></a><span id="l78.1550" class="difflineplus">+      run(aMsg, aConv) {</span>
<a href="#l78.1551"></a><span id="l78.1551" class="difflineplus">+        aMsg = aMsg.trim();</span>
<a href="#l78.1552"></a><span id="l78.1552" class="difflineplus">+        if (!aMsg) {</span>
<a href="#l78.1553"></a><span id="l78.1553" class="difflineplus">+          return false;</span>
<a href="#l78.1554"></a><span id="l78.1554" class="difflineplus">+        }</span>
<a href="#l78.1555"></a><span id="l78.1555" class="difflineplus">+        let account = getAccount(aConv);</span>
<a href="#l78.1556"></a><span id="l78.1556" class="difflineplus">+        aMsg.split(&quot; &quot;).forEach(account.follow, account);</span>
<a href="#l78.1557"></a><span id="l78.1557" class="difflineplus">+        return true;</span>
<a href="#l78.1558"></a><span id="l78.1558" class="difflineplus">+      },</span>
<a href="#l78.1559"></a><span id="l78.1559" class="difflineplus">+    },</span>
<a href="#l78.1560"></a><span id="l78.1560" class="difflineplus">+    {</span>
<a href="#l78.1561"></a><span id="l78.1561" class="difflineplus">+      name: &quot;unfollow&quot;,</span>
<a href="#l78.1562"></a><span id="l78.1562" class="difflineplus">+      get helpString() {</span>
<a href="#l78.1563"></a><span id="l78.1563" class="difflineplus">+        return _(&quot;command.unfollow&quot;, &quot;unfollow&quot;);</span>
<a href="#l78.1564"></a><span id="l78.1564" class="difflineplus">+      },</span>
<a href="#l78.1565"></a><span id="l78.1565" class="difflineplus">+      run(aMsg, aConv) {</span>
<a href="#l78.1566"></a><span id="l78.1566" class="difflineplus">+        aMsg = aMsg.trim();</span>
<a href="#l78.1567"></a><span id="l78.1567" class="difflineplus">+        if (!aMsg) {</span>
<a href="#l78.1568"></a><span id="l78.1568" class="difflineplus">+          return false;</span>
<a href="#l78.1569"></a><span id="l78.1569" class="difflineplus">+        }</span>
<a href="#l78.1570"></a><span id="l78.1570" class="difflineplus">+        let account = getAccount(aConv);</span>
<a href="#l78.1571"></a><span id="l78.1571" class="difflineplus">+        aMsg.split(&quot; &quot;).forEach(account.stopFollowing, account);</span>
<a href="#l78.1572"></a><span id="l78.1572" class="difflineplus">+        return true;</span>
<a href="#l78.1573"></a><span id="l78.1573" class="difflineplus">+      },</span>
<a href="#l78.1574"></a><span id="l78.1574" class="difflineplus">+    },</span>
<a href="#l78.1575"></a><span id="l78.1575" class="difflineplus">+  ],</span>
<a href="#l78.1576"></a><span id="l78.1576" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l78.1577"></a><span id="l78.1577" class="difflineplus">+    return new Account(this, aImAccount);</span>
<a href="#l78.1578"></a><span id="l78.1578" class="difflineplus">+  },</span>
<a href="#l78.1579"></a><span id="l78.1579" class="difflineplus">+  classID: Components.ID(&quot;{31082ff6-1de8-422b-ab60-ca0ac0b2af13}&quot;),</span>
<a href="#l78.1580"></a><span id="l78.1580" class="difflineplus">+};</span>
<a href="#l78.1581"></a><span id="l78.1581" class="difflineplus">+</span>
<a href="#l78.1582"></a><span id="l78.1582" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([TwitterProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1">new file mode 100644</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineminus">--- /dev/null</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineplus">+++ b/chat/protocols/twitter/twitter.manifest</span>
<a href="#l79.4"></a><span id="l79.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l79.5"></a><span id="l79.5" class="difflineplus">+component {31082ff6-1de8-422b-ab60-ca0ac0b2af13} twitter.js</span>
<a href="#l79.6"></a><span id="l79.6" class="difflineplus">+contract @mozilla.org/chat/twitter;1 {31082ff6-1de8-422b-ab60-ca0ac0b2af13}</span>
<a href="#l79.7"></a><span id="l79.7" class="difflineplus">+category im-protocol-plugin prpl-twitter @mozilla.org/chat/twitter;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1">deleted file mode 100644</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineminus">--- a/chat/protocols/xmpp/XMPPProtocol.jsm</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineplus">+++ /dev/null</span>
<a href="#l80.4"></a><span id="l80.4" class="difflineat">@@ -1,104 +0,0 @@</span>
<a href="#l80.5"></a><span id="l80.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l80.6"></a><span id="l80.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l80.7"></a><span id="l80.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l80.8"></a><span id="l80.8" class="difflineminus">-</span>
<a href="#l80.9"></a><span id="l80.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;XMPPProtocol&quot;];</span>
<a href="#l80.10"></a><span id="l80.10" class="difflineminus">-</span>
<a href="#l80.11"></a><span id="l80.11" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineminus">-);</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineminus">-var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l80.16"></a><span id="l80.16" class="difflineminus">-);</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineminus">-var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineminus">-  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineminus">-);</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineminus">-</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l80.23"></a><span id="l80.23" class="difflineminus">-);</span>
<a href="#l80.24"></a><span id="l80.24" class="difflineminus">-</span>
<a href="#l80.25"></a><span id="l80.25" class="difflineminus">-function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l80.26"></a><span id="l80.26" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-}</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineminus">-XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l80.29"></a><span id="l80.29" class="difflineminus">-</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">-function XMPPProtocol() {</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineminus">-  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l80.32"></a><span id="l80.32" class="difflineminus">-  this.registerCommands();</span>
<a href="#l80.33"></a><span id="l80.33" class="difflineminus">-}</span>
<a href="#l80.34"></a><span id="l80.34" class="difflineminus">-XMPPProtocol.prototype = {</span>
<a href="#l80.35"></a><span id="l80.35" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l80.36"></a><span id="l80.36" class="difflineminus">-  get normalizedName() {</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineminus">-    return &quot;jabber&quot;;</span>
<a href="#l80.38"></a><span id="l80.38" class="difflineminus">-  },</span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-  get name() {</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineminus">-    return &quot;XMPP&quot;;</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineminus">-  },</span>
<a href="#l80.42"></a><span id="l80.42" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineminus">-    return &quot;chrome://prpl-jabber/skin/&quot;;</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineminus">-  },</span>
<a href="#l80.45"></a><span id="l80.45" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineminus">-    return new XMPPAccount(this, aImAccount);</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineminus">-  },</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineminus">-</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineminus">-  usernameSplits: [</span>
<a href="#l80.50"></a><span id="l80.50" class="difflineminus">-    {</span>
<a href="#l80.51"></a><span id="l80.51" class="difflineminus">-      get label() {</span>
<a href="#l80.52"></a><span id="l80.52" class="difflineminus">-        return _(&quot;options.domain&quot;);</span>
<a href="#l80.53"></a><span id="l80.53" class="difflineminus">-      },</span>
<a href="#l80.54"></a><span id="l80.54" class="difflineminus">-      separator: &quot;@&quot;,</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineminus">-      defaultValue: &quot;jabber.org&quot;,</span>
<a href="#l80.56"></a><span id="l80.56" class="difflineminus">-      reverse: true,</span>
<a href="#l80.57"></a><span id="l80.57" class="difflineminus">-    },</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineminus">-  ],</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineminus">-</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineminus">-  options: {</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineminus">-    resource: {</span>
<a href="#l80.62"></a><span id="l80.62" class="difflineminus">-      get label() {</span>
<a href="#l80.63"></a><span id="l80.63" class="difflineminus">-        return _(&quot;options.resource&quot;);</span>
<a href="#l80.64"></a><span id="l80.64" class="difflineminus">-      },</span>
<a href="#l80.65"></a><span id="l80.65" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l80.66"></a><span id="l80.66" class="difflineminus">-    },</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineminus">-    priority: {</span>
<a href="#l80.68"></a><span id="l80.68" class="difflineminus">-      get label() {</span>
<a href="#l80.69"></a><span id="l80.69" class="difflineminus">-        return _(&quot;options.priority&quot;);</span>
<a href="#l80.70"></a><span id="l80.70" class="difflineminus">-      },</span>
<a href="#l80.71"></a><span id="l80.71" class="difflineminus">-      default: 0,</span>
<a href="#l80.72"></a><span id="l80.72" class="difflineminus">-    },</span>
<a href="#l80.73"></a><span id="l80.73" class="difflineminus">-    connection_security: {</span>
<a href="#l80.74"></a><span id="l80.74" class="difflineminus">-      get label() {</span>
<a href="#l80.75"></a><span id="l80.75" class="difflineminus">-        return _(&quot;options.connectionSecurity&quot;);</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineminus">-      },</span>
<a href="#l80.77"></a><span id="l80.77" class="difflineminus">-      listValues: {</span>
<a href="#l80.78"></a><span id="l80.78" class="difflineminus">-        get require_tls() {</span>
<a href="#l80.79"></a><span id="l80.79" class="difflineminus">-          return _(&quot;options.connectionSecurity.requireEncryption&quot;);</span>
<a href="#l80.80"></a><span id="l80.80" class="difflineminus">-        },</span>
<a href="#l80.81"></a><span id="l80.81" class="difflineminus">-        get opportunistic_tls() {</span>
<a href="#l80.82"></a><span id="l80.82" class="difflineminus">-          return _(&quot;options.connectionSecurity.opportunisticTLS&quot;);</span>
<a href="#l80.83"></a><span id="l80.83" class="difflineminus">-        },</span>
<a href="#l80.84"></a><span id="l80.84" class="difflineminus">-        get allow_unencrypted_plain_auth() {</span>
<a href="#l80.85"></a><span id="l80.85" class="difflineminus">-          return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;);</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineminus">-        },</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineminus">-        // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineminus">-        // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineminus">-      },</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineminus">-      default: &quot;require_tls&quot;,</span>
<a href="#l80.91"></a><span id="l80.91" class="difflineminus">-    },</span>
<a href="#l80.92"></a><span id="l80.92" class="difflineminus">-    server: {</span>
<a href="#l80.93"></a><span id="l80.93" class="difflineminus">-      get label() {</span>
<a href="#l80.94"></a><span id="l80.94" class="difflineminus">-        return _(&quot;options.connectServer&quot;);</span>
<a href="#l80.95"></a><span id="l80.95" class="difflineminus">-      },</span>
<a href="#l80.96"></a><span id="l80.96" class="difflineminus">-      default: &quot;&quot;,</span>
<a href="#l80.97"></a><span id="l80.97" class="difflineminus">-    },</span>
<a href="#l80.98"></a><span id="l80.98" class="difflineminus">-    port: {</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineminus">-      get label() {</span>
<a href="#l80.100"></a><span id="l80.100" class="difflineminus">-        return _(&quot;options.connectPort&quot;);</span>
<a href="#l80.101"></a><span id="l80.101" class="difflineminus">-      },</span>
<a href="#l80.102"></a><span id="l80.102" class="difflineminus">-      default: 5222,</span>
<a href="#l80.103"></a><span id="l80.103" class="difflineminus">-    },</span>
<a href="#l80.104"></a><span id="l80.104" class="difflineminus">-  },</span>
<a href="#l80.105"></a><span id="l80.105" class="difflineminus">-  get chatHasTopic() {</span>
<a href="#l80.106"></a><span id="l80.106" class="difflineminus">-    return true;</span>
<a href="#l80.107"></a><span id="l80.107" class="difflineminus">-  },</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1">deleted file mode 100644</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineminus">--- a/chat/protocols/xmpp/components.conf</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineplus">+++ /dev/null</span>
<a href="#l81.4"></a><span id="l81.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l81.5"></a><span id="l81.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l81.6"></a><span id="l81.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l81.7"></a><span id="l81.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l81.8"></a><span id="l81.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l81.9"></a><span id="l81.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l81.10"></a><span id="l81.10" class="difflineminus">-</span>
<a href="#l81.11"></a><span id="l81.11" class="difflineminus">-Classes = [</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-  {</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineminus">-    'cid': '{dde786d1-6f59-43d0-9bc8-b505a757fb30}',</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/xmpp;1'],</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineminus">-    'jsm': 'resource:///modules/XMPPProtocol.jsm',</span>
<a href="#l81.16"></a><span id="l81.16" class="difflineminus">-    'constructor': 'XMPPProtocol',</span>
<a href="#l81.17"></a><span id="l81.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-jabber'},</span>
<a href="#l81.18"></a><span id="l81.18" class="difflineminus">-  },</span>
<a href="#l81.19"></a><span id="l81.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/chat/protocols/xmpp/moz.build</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/chat/protocols/xmpp/moz.build</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -1,21 +1,21 @@</span>
<a href="#l82.4"></a><span id="l82.4"> # vim: set filetype=python:</span>
<a href="#l82.5"></a><span id="l82.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l82.6"></a><span id="l82.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l82.7"></a><span id="l82.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l82.8"></a><span id="l82.8"> </span>
<a href="#l82.9"></a><span id="l82.9"> XPCSHELL_TESTS_MANIFESTS += ['test/xpcshell.ini']</span>
<a href="#l82.10"></a><span id="l82.10"> </span>
<a href="#l82.11"></a><span id="l82.11" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineplus">+    'xmpp.js',</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+    'xmpp.manifest',</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+]</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+</span>
<a href="#l82.16"></a><span id="l82.16"> EXTRA_JS_MODULES += [</span>
<a href="#l82.17"></a><span id="l82.17">     'xmpp-authmechs.jsm',</span>
<a href="#l82.18"></a><span id="l82.18">     'xmpp-commands.jsm',</span>
<a href="#l82.19"></a><span id="l82.19">     'xmpp-session.jsm',</span>
<a href="#l82.20"></a><span id="l82.20">     'xmpp-xml.jsm',</span>
<a href="#l82.21"></a><span id="l82.21">     'xmpp.jsm',</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineminus">-    'XMPPProtocol.jsm',</span>
<a href="#l82.23"></a><span id="l82.23"> ]</span>
<a href="#l82.24"></a><span id="l82.24"> </span>
<a href="#l82.25"></a><span id="l82.25"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineminus">-</span>
<a href="#l82.27"></a><span id="l82.27" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineminus">-    'components.conf',</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1">new file mode 100644</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineminus">--- /dev/null</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.js</span>
<a href="#l83.4"></a><span id="l83.4" class="difflineat">@@ -0,0 +1,106 @@</span>
<a href="#l83.5"></a><span id="l83.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l83.6"></a><span id="l83.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l83.7"></a><span id="l83.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l83.8"></a><span id="l83.8" class="difflineplus">+</span>
<a href="#l83.9"></a><span id="l83.9" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l83.10"></a><span id="l83.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l83.11"></a><span id="l83.11" class="difflineplus">+);</span>
<a href="#l83.12"></a><span id="l83.12" class="difflineplus">+var { GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineplus">+);</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineplus">+var { XMPPAccountPrototype } = ChromeUtils.import(</span>
<a href="#l83.16"></a><span id="l83.16" class="difflineplus">+  &quot;resource:///modules/xmpp.jsm&quot;</span>
<a href="#l83.17"></a><span id="l83.17" class="difflineplus">+);</span>
<a href="#l83.18"></a><span id="l83.18" class="difflineplus">+</span>
<a href="#l83.19"></a><span id="l83.19" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l83.20"></a><span id="l83.20" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/xmpp.properties&quot;)</span>
<a href="#l83.21"></a><span id="l83.21" class="difflineplus">+);</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineplus">+</span>
<a href="#l83.23"></a><span id="l83.23" class="difflineplus">+function XMPPAccount(aProtoInstance, aImAccount) {</span>
<a href="#l83.24"></a><span id="l83.24" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l83.25"></a><span id="l83.25" class="difflineplus">+}</span>
<a href="#l83.26"></a><span id="l83.26" class="difflineplus">+XMPPAccount.prototype = XMPPAccountPrototype;</span>
<a href="#l83.27"></a><span id="l83.27" class="difflineplus">+</span>
<a href="#l83.28"></a><span id="l83.28" class="difflineplus">+function XMPPProtocol() {</span>
<a href="#l83.29"></a><span id="l83.29" class="difflineplus">+  ChromeUtils.import(&quot;resource:///modules/xmpp-commands.jsm&quot;, this);</span>
<a href="#l83.30"></a><span id="l83.30" class="difflineplus">+  this.registerCommands();</span>
<a href="#l83.31"></a><span id="l83.31" class="difflineplus">+}</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+XMPPProtocol.prototype = {</span>
<a href="#l83.33"></a><span id="l83.33" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l83.34"></a><span id="l83.34" class="difflineplus">+  get normalizedName() {</span>
<a href="#l83.35"></a><span id="l83.35" class="difflineplus">+    return &quot;jabber&quot;;</span>
<a href="#l83.36"></a><span id="l83.36" class="difflineplus">+  },</span>
<a href="#l83.37"></a><span id="l83.37" class="difflineplus">+  get name() {</span>
<a href="#l83.38"></a><span id="l83.38" class="difflineplus">+    return &quot;XMPP&quot;;</span>
<a href="#l83.39"></a><span id="l83.39" class="difflineplus">+  },</span>
<a href="#l83.40"></a><span id="l83.40" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l83.41"></a><span id="l83.41" class="difflineplus">+    return &quot;chrome://prpl-jabber/skin/&quot;;</span>
<a href="#l83.42"></a><span id="l83.42" class="difflineplus">+  },</span>
<a href="#l83.43"></a><span id="l83.43" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l83.44"></a><span id="l83.44" class="difflineplus">+    return new XMPPAccount(this, aImAccount);</span>
<a href="#l83.45"></a><span id="l83.45" class="difflineplus">+  },</span>
<a href="#l83.46"></a><span id="l83.46" class="difflineplus">+</span>
<a href="#l83.47"></a><span id="l83.47" class="difflineplus">+  usernameSplits: [</span>
<a href="#l83.48"></a><span id="l83.48" class="difflineplus">+    {</span>
<a href="#l83.49"></a><span id="l83.49" class="difflineplus">+      get label() {</span>
<a href="#l83.50"></a><span id="l83.50" class="difflineplus">+        return _(&quot;options.domain&quot;);</span>
<a href="#l83.51"></a><span id="l83.51" class="difflineplus">+      },</span>
<a href="#l83.52"></a><span id="l83.52" class="difflineplus">+      separator: &quot;@&quot;,</span>
<a href="#l83.53"></a><span id="l83.53" class="difflineplus">+      defaultValue: &quot;jabber.org&quot;,</span>
<a href="#l83.54"></a><span id="l83.54" class="difflineplus">+      reverse: true,</span>
<a href="#l83.55"></a><span id="l83.55" class="difflineplus">+    },</span>
<a href="#l83.56"></a><span id="l83.56" class="difflineplus">+  ],</span>
<a href="#l83.57"></a><span id="l83.57" class="difflineplus">+</span>
<a href="#l83.58"></a><span id="l83.58" class="difflineplus">+  options: {</span>
<a href="#l83.59"></a><span id="l83.59" class="difflineplus">+    resource: {</span>
<a href="#l83.60"></a><span id="l83.60" class="difflineplus">+      get label() {</span>
<a href="#l83.61"></a><span id="l83.61" class="difflineplus">+        return _(&quot;options.resource&quot;);</span>
<a href="#l83.62"></a><span id="l83.62" class="difflineplus">+      },</span>
<a href="#l83.63"></a><span id="l83.63" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l83.64"></a><span id="l83.64" class="difflineplus">+    },</span>
<a href="#l83.65"></a><span id="l83.65" class="difflineplus">+    priority: {</span>
<a href="#l83.66"></a><span id="l83.66" class="difflineplus">+      get label() {</span>
<a href="#l83.67"></a><span id="l83.67" class="difflineplus">+        return _(&quot;options.priority&quot;);</span>
<a href="#l83.68"></a><span id="l83.68" class="difflineplus">+      },</span>
<a href="#l83.69"></a><span id="l83.69" class="difflineplus">+      default: 0,</span>
<a href="#l83.70"></a><span id="l83.70" class="difflineplus">+    },</span>
<a href="#l83.71"></a><span id="l83.71" class="difflineplus">+    connection_security: {</span>
<a href="#l83.72"></a><span id="l83.72" class="difflineplus">+      get label() {</span>
<a href="#l83.73"></a><span id="l83.73" class="difflineplus">+        return _(&quot;options.connectionSecurity&quot;);</span>
<a href="#l83.74"></a><span id="l83.74" class="difflineplus">+      },</span>
<a href="#l83.75"></a><span id="l83.75" class="difflineplus">+      listValues: {</span>
<a href="#l83.76"></a><span id="l83.76" class="difflineplus">+        get require_tls() {</span>
<a href="#l83.77"></a><span id="l83.77" class="difflineplus">+          return _(&quot;options.connectionSecurity.requireEncryption&quot;);</span>
<a href="#l83.78"></a><span id="l83.78" class="difflineplus">+        },</span>
<a href="#l83.79"></a><span id="l83.79" class="difflineplus">+        get opportunistic_tls() {</span>
<a href="#l83.80"></a><span id="l83.80" class="difflineplus">+          return _(&quot;options.connectionSecurity.opportunisticTLS&quot;);</span>
<a href="#l83.81"></a><span id="l83.81" class="difflineplus">+        },</span>
<a href="#l83.82"></a><span id="l83.82" class="difflineplus">+        get allow_unencrypted_plain_auth() {</span>
<a href="#l83.83"></a><span id="l83.83" class="difflineplus">+          return _(&quot;options.connectionSecurity.allowUnencryptedAuth&quot;);</span>
<a href="#l83.84"></a><span id="l83.84" class="difflineplus">+        },</span>
<a href="#l83.85"></a><span id="l83.85" class="difflineplus">+        // &quot;old_ssl&quot; and &quot;none&quot; are also supported, but not exposed in the UI.</span>
<a href="#l83.86"></a><span id="l83.86" class="difflineplus">+        // Any unknown value will fallback to the opportunistic_tls behavior.</span>
<a href="#l83.87"></a><span id="l83.87" class="difflineplus">+      },</span>
<a href="#l83.88"></a><span id="l83.88" class="difflineplus">+      default: &quot;require_tls&quot;,</span>
<a href="#l83.89"></a><span id="l83.89" class="difflineplus">+    },</span>
<a href="#l83.90"></a><span id="l83.90" class="difflineplus">+    server: {</span>
<a href="#l83.91"></a><span id="l83.91" class="difflineplus">+      get label() {</span>
<a href="#l83.92"></a><span id="l83.92" class="difflineplus">+        return _(&quot;options.connectServer&quot;);</span>
<a href="#l83.93"></a><span id="l83.93" class="difflineplus">+      },</span>
<a href="#l83.94"></a><span id="l83.94" class="difflineplus">+      default: &quot;&quot;,</span>
<a href="#l83.95"></a><span id="l83.95" class="difflineplus">+    },</span>
<a href="#l83.96"></a><span id="l83.96" class="difflineplus">+    port: {</span>
<a href="#l83.97"></a><span id="l83.97" class="difflineplus">+      get label() {</span>
<a href="#l83.98"></a><span id="l83.98" class="difflineplus">+        return _(&quot;options.connectPort&quot;);</span>
<a href="#l83.99"></a><span id="l83.99" class="difflineplus">+      },</span>
<a href="#l83.100"></a><span id="l83.100" class="difflineplus">+      default: 5222,</span>
<a href="#l83.101"></a><span id="l83.101" class="difflineplus">+    },</span>
<a href="#l83.102"></a><span id="l83.102" class="difflineplus">+  },</span>
<a href="#l83.103"></a><span id="l83.103" class="difflineplus">+  get chatHasTopic() {</span>
<a href="#l83.104"></a><span id="l83.104" class="difflineplus">+    return true;</span>
<a href="#l83.105"></a><span id="l83.105" class="difflineplus">+  },</span>
<a href="#l83.106"></a><span id="l83.106" class="difflineplus">+</span>
<a href="#l83.107"></a><span id="l83.107" class="difflineplus">+  classID: Components.ID(&quot;{dde786d1-6f59-43d0-9bc8-b505a757fb30}&quot;),</span>
<a href="#l83.108"></a><span id="l83.108" class="difflineplus">+};</span>
<a href="#l83.109"></a><span id="l83.109" class="difflineplus">+</span>
<a href="#l83.110"></a><span id="l83.110" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([XMPPProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1">new file mode 100644</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineminus">--- /dev/null</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineplus">+++ b/chat/protocols/xmpp/xmpp.manifest</span>
<a href="#l84.4"></a><span id="l84.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l84.5"></a><span id="l84.5" class="difflineplus">+component {dde786d1-6f59-43d0-9bc8-b505a757fb30} xmpp.js</span>
<a href="#l84.6"></a><span id="l84.6" class="difflineplus">+contract @mozilla.org/chat/xmpp;1 {dde786d1-6f59-43d0-9bc8-b505a757fb30}</span>
<a href="#l84.7"></a><span id="l84.7" class="difflineplus">+category im-protocol-plugin prpl-jabber @mozilla.org/chat/xmpp;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1">deleted file mode 100644</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineminus">--- a/chat/protocols/yahoo/Yahoo.jsm</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineplus">+++ /dev/null</span>
<a href="#l85.4"></a><span id="l85.4" class="difflineat">@@ -1,56 +0,0 @@</span>
<a href="#l85.5"></a><span id="l85.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l85.6"></a><span id="l85.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l85.7"></a><span id="l85.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l85.8"></a><span id="l85.8" class="difflineminus">-</span>
<a href="#l85.9"></a><span id="l85.9" class="difflineminus">-var EXPORTED_SYMBOLS = [&quot;YahooProtocol&quot;];</span>
<a href="#l85.10"></a><span id="l85.10" class="difflineminus">-</span>
<a href="#l85.11"></a><span id="l85.11" class="difflineminus">-var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineminus">-);</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineminus">-var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l85.15"></a><span id="l85.15" class="difflineminus">-  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l85.16"></a><span id="l85.16" class="difflineminus">-);</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineminus">-</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineminus">-XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineminus">-  l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineminus">-);</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineminus">-</span>
<a href="#l85.22"></a><span id="l85.22" class="difflineminus">-function YahooAccount(aProtoInstance, aImAccount) {</span>
<a href="#l85.23"></a><span id="l85.23" class="difflineminus">-  this._init(aProtoInstance, aImAccount);</span>
<a href="#l85.24"></a><span id="l85.24" class="difflineminus">-}</span>
<a href="#l85.25"></a><span id="l85.25" class="difflineminus">-YahooAccount.prototype = {</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-  __proto__: GenericAccountPrototype,</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineminus">-</span>
<a href="#l85.28"></a><span id="l85.28" class="difflineminus">-  connect() {</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineminus">-    this.WARN(</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineminus">-      &quot;The legacy versions of Yahoo Messenger was disabled on August &quot; +</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineminus">-        &quot;5, 2016. It is currently not possible to connect to Yahoo &quot; +</span>
<a href="#l85.32"></a><span id="l85.32" class="difflineminus">-        &quot;Messenger. See bug 1316000&quot;</span>
<a href="#l85.33"></a><span id="l85.33" class="difflineminus">-    );</span>
<a href="#l85.34"></a><span id="l85.34" class="difflineminus">-    this.reportDisconnecting(</span>
<a href="#l85.35"></a><span id="l85.35" class="difflineminus">-      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l85.36"></a><span id="l85.36" class="difflineminus">-      _(&quot;yahoo.disabled&quot;)</span>
<a href="#l85.37"></a><span id="l85.37" class="difflineminus">-    );</span>
<a href="#l85.38"></a><span id="l85.38" class="difflineminus">-    this.reportDisconnected();</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineminus">-  },</span>
<a href="#l85.40"></a><span id="l85.40" class="difflineminus">-</span>
<a href="#l85.41"></a><span id="l85.41" class="difflineminus">-  // Nothing to do.</span>
<a href="#l85.42"></a><span id="l85.42" class="difflineminus">-  unInit() {},</span>
<a href="#l85.43"></a><span id="l85.43" class="difflineminus">-};</span>
<a href="#l85.44"></a><span id="l85.44" class="difflineminus">-</span>
<a href="#l85.45"></a><span id="l85.45" class="difflineminus">-function YahooProtocol() {}</span>
<a href="#l85.46"></a><span id="l85.46" class="difflineminus">-YahooProtocol.prototype = {</span>
<a href="#l85.47"></a><span id="l85.47" class="difflineminus">-  __proto__: GenericProtocolPrototype,</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineminus">-  get id() {</span>
<a href="#l85.49"></a><span id="l85.49" class="difflineminus">-    return &quot;prpl-yahoo&quot;;</span>
<a href="#l85.50"></a><span id="l85.50" class="difflineminus">-  },</span>
<a href="#l85.51"></a><span id="l85.51" class="difflineminus">-  get name() {</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineminus">-    return &quot;Yahoo&quot;;</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineminus">-  },</span>
<a href="#l85.54"></a><span id="l85.54" class="difflineminus">-  get iconBaseURI() {</span>
<a href="#l85.55"></a><span id="l85.55" class="difflineminus">-    return &quot;chrome://prpl-yahoo/skin/&quot;;</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineminus">-  },</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineminus">-  getAccount(aImAccount) {</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineminus">-    return new YahooAccount(this, aImAccount);</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineminus">-  },</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">deleted file mode 100644</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineminus">--- a/chat/protocols/yahoo/components.conf</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineplus">+++ /dev/null</span>
<a href="#l86.4"></a><span id="l86.4" class="difflineat">@@ -1,15 +0,0 @@</span>
<a href="#l86.5"></a><span id="l86.5" class="difflineminus">-# -*- Mode: python; indent-tabs-mode: nil; tab-width: 40 -*-</span>
<a href="#l86.6"></a><span id="l86.6" class="difflineminus">-# vim: set filetype=python:</span>
<a href="#l86.7"></a><span id="l86.7" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l86.8"></a><span id="l86.8" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l86.9"></a><span id="l86.9" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l86.10"></a><span id="l86.10" class="difflineminus">-</span>
<a href="#l86.11"></a><span id="l86.11" class="difflineminus">-Classes = [</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-  {</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineminus">-    'cid': '{50ea817e-5d79-4657-91ae-aa0a52bdb98c}',</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineminus">-    'contract_ids': ['@mozilla.org/chat/yahoo;1'],</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineminus">-    'jsm': 'resource:///modules/Yahoo.jsm',</span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-    'constructor': 'YahooProtocol',</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-    'categories': {'im-protocol-plugin': 'prpl-yahoo'},</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-  },</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineminus">-]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/chat/protocols/yahoo/moz.build</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/chat/protocols/yahoo/moz.build</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -1,14 +1,11 @@</span>
<a href="#l87.4"></a><span id="l87.4"> # vim: set filetype=python:</span>
<a href="#l87.5"></a><span id="l87.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l87.6"></a><span id="l87.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l87.7"></a><span id="l87.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l87.8"></a><span id="l87.8"> </span>
<a href="#l87.9"></a><span id="l87.9" class="difflineminus">-JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l87.10"></a><span id="l87.10" class="difflineminus">-</span>
<a href="#l87.11"></a><span id="l87.11" class="difflineminus">-EXTRA_JS_MODULES += [</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-    'Yahoo.jsm',</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+EXTRA_COMPONENTS += [</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineplus">+    'yahoo.js',</span>
<a href="#l87.15"></a><span id="l87.15" class="difflineplus">+    'yahoo.manifest',</span>
<a href="#l87.16"></a><span id="l87.16"> ]</span>
<a href="#l87.17"></a><span id="l87.17"> </span>
<a href="#l87.18"></a><span id="l87.18" class="difflineminus">-XPCOM_MANIFESTS += [</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineminus">-    'components.conf',</span>
<a href="#l87.20"></a><span id="l87.20" class="difflineminus">-]</span>
<a href="#l87.21"></a><span id="l87.21" class="difflineplus">+JAR_MANIFESTS += ['jar.mn']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1">new file mode 100644</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineminus">--- /dev/null</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.js</span>
<a href="#l88.4"></a><span id="l88.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l88.5"></a><span id="l88.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l88.6"></a><span id="l88.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l88.7"></a><span id="l88.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l88.8"></a><span id="l88.8" class="difflineplus">+</span>
<a href="#l88.9"></a><span id="l88.9" class="difflineplus">+var { XPCOMUtils, l10nHelper } = ChromeUtils.import(</span>
<a href="#l88.10"></a><span id="l88.10" class="difflineplus">+  &quot;resource:///modules/imXPCOMUtils.jsm&quot;</span>
<a href="#l88.11"></a><span id="l88.11" class="difflineplus">+);</span>
<a href="#l88.12"></a><span id="l88.12" class="difflineplus">+var { GenericAccountPrototype, GenericProtocolPrototype } = ChromeUtils.import(</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+  &quot;resource:///modules/jsProtoHelper.jsm&quot;</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineplus">+);</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineplus">+</span>
<a href="#l88.16"></a><span id="l88.16" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, () =&gt;</span>
<a href="#l88.17"></a><span id="l88.17" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/yahoo.properties&quot;)</span>
<a href="#l88.18"></a><span id="l88.18" class="difflineplus">+);</span>
<a href="#l88.19"></a><span id="l88.19" class="difflineplus">+</span>
<a href="#l88.20"></a><span id="l88.20" class="difflineplus">+function YahooAccount(aProtoInstance, aImAccount) {</span>
<a href="#l88.21"></a><span id="l88.21" class="difflineplus">+  this._init(aProtoInstance, aImAccount);</span>
<a href="#l88.22"></a><span id="l88.22" class="difflineplus">+}</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineplus">+YahooAccount.prototype = {</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l88.25"></a><span id="l88.25" class="difflineplus">+</span>
<a href="#l88.26"></a><span id="l88.26" class="difflineplus">+  connect() {</span>
<a href="#l88.27"></a><span id="l88.27" class="difflineplus">+    this.WARN(</span>
<a href="#l88.28"></a><span id="l88.28" class="difflineplus">+      &quot;The legacy versions of Yahoo Messenger was disabled on August &quot; +</span>
<a href="#l88.29"></a><span id="l88.29" class="difflineplus">+        &quot;5, 2016. It is currently not possible to connect to Yahoo &quot; +</span>
<a href="#l88.30"></a><span id="l88.30" class="difflineplus">+        &quot;Messenger. See bug 1316000&quot;</span>
<a href="#l88.31"></a><span id="l88.31" class="difflineplus">+    );</span>
<a href="#l88.32"></a><span id="l88.32" class="difflineplus">+    this.reportDisconnecting(</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineplus">+      Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineplus">+      _(&quot;yahoo.disabled&quot;)</span>
<a href="#l88.35"></a><span id="l88.35" class="difflineplus">+    );</span>
<a href="#l88.36"></a><span id="l88.36" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l88.37"></a><span id="l88.37" class="difflineplus">+  },</span>
<a href="#l88.38"></a><span id="l88.38" class="difflineplus">+</span>
<a href="#l88.39"></a><span id="l88.39" class="difflineplus">+  // Nothing to do.</span>
<a href="#l88.40"></a><span id="l88.40" class="difflineplus">+  unInit() {},</span>
<a href="#l88.41"></a><span id="l88.41" class="difflineplus">+};</span>
<a href="#l88.42"></a><span id="l88.42" class="difflineplus">+</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineplus">+function YahooProtocol() {}</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineplus">+YahooProtocol.prototype = {</span>
<a href="#l88.45"></a><span id="l88.45" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l88.46"></a><span id="l88.46" class="difflineplus">+  get id() {</span>
<a href="#l88.47"></a><span id="l88.47" class="difflineplus">+    return &quot;prpl-yahoo&quot;;</span>
<a href="#l88.48"></a><span id="l88.48" class="difflineplus">+  },</span>
<a href="#l88.49"></a><span id="l88.49" class="difflineplus">+  get name() {</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineplus">+    return &quot;Yahoo&quot;;</span>
<a href="#l88.51"></a><span id="l88.51" class="difflineplus">+  },</span>
<a href="#l88.52"></a><span id="l88.52" class="difflineplus">+  get iconBaseURI() {</span>
<a href="#l88.53"></a><span id="l88.53" class="difflineplus">+    return &quot;chrome://prpl-yahoo/skin/&quot;;</span>
<a href="#l88.54"></a><span id="l88.54" class="difflineplus">+  },</span>
<a href="#l88.55"></a><span id="l88.55" class="difflineplus">+  getAccount(aImAccount) {</span>
<a href="#l88.56"></a><span id="l88.56" class="difflineplus">+    return new YahooAccount(this, aImAccount);</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineplus">+  },</span>
<a href="#l88.58"></a><span id="l88.58" class="difflineplus">+  classID: Components.ID(&quot;{50ea817e-5d79-4657-91ae-aa0a52bdb98c}&quot;),</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineplus">+};</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineplus">+</span>
<a href="#l88.61"></a><span id="l88.61" class="difflineplus">+var NSGetFactory = XPCOMUtils.generateNSGetFactory([YahooProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1">new file mode 100644</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineminus">--- /dev/null</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineplus">+++ b/chat/protocols/yahoo/yahoo.manifest</span>
<a href="#l89.4"></a><span id="l89.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l89.5"></a><span id="l89.5" class="difflineplus">+component {50ea817e-5d79-4657-91ae-aa0a52bdb98c} yahoo.js</span>
<a href="#l89.6"></a><span id="l89.6" class="difflineplus">+contract @mozilla.org/chat/yahoo;1 {50ea817e-5d79-4657-91ae-aa0a52bdb98c}</span>
<a href="#l89.7"></a><span id="l89.7" class="difflineplus">+category im-protocol-plugin prpl-yahoo @mozilla.org/chat/yahoo;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -242,16 +242,48 @@</span>
<a href="#l90.4"></a><span id="l90.4"> @RESPATH@/components/smime-service.manifest</span>
<a href="#l90.5"></a><span id="l90.5"> </span>
<a href="#l90.6"></a><span id="l90.6"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l90.7"></a><span id="l90.7"> ; instant messaging</span>
<a href="#l90.8"></a><span id="l90.8"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l90.9"></a><span id="l90.9"> @RESPATH@/@PREF_DIR@/chat-prefs.js</span>
<a href="#l90.10"></a><span id="l90.10"> @RESPATH@/chrome/chat@JAREXT@</span>
<a href="#l90.11"></a><span id="l90.11"> @RESPATH@/chrome/chat.manifest</span>
<a href="#l90.12"></a><span id="l90.12" class="difflineplus">+@RESPATH@/components/imAccounts.js</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+@RESPATH@/components/imAccounts.manifest</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineplus">+@RESPATH@/components/imCommands.js</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineplus">+@RESPATH@/components/imCommands.manifest</span>
<a href="#l90.16"></a><span id="l90.16" class="difflineplus">+@RESPATH@/components/imContacts.js</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineplus">+@RESPATH@/components/imContacts.manifest</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineplus">+@RESPATH@/components/imConversations.js</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+@RESPATH@/components/imConversations.manifest</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+@RESPATH@/components/imCore.js</span>
<a href="#l90.21"></a><span id="l90.21" class="difflineplus">+@RESPATH@/components/imCore.manifest</span>
<a href="#l90.22"></a><span id="l90.22" class="difflineplus">+@RESPATH@/components/facebook.js</span>
<a href="#l90.23"></a><span id="l90.23" class="difflineplus">+@RESPATH@/components/facebook.manifest</span>
<a href="#l90.24"></a><span id="l90.24" class="difflineplus">+@RESPATH@/components/gtalk.js</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineplus">+@RESPATH@/components/gtalk.manifest</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+@RESPATH@/components/irc.js</span>
<a href="#l90.27"></a><span id="l90.27" class="difflineplus">+@RESPATH@/components/irc.manifest</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineplus">+@RESPATH@/components/matrix.js</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineplus">+@RESPATH@/components/matrix.manifest</span>
<a href="#l90.30"></a><span id="l90.30" class="difflineplus">+@RESPATH@/components/odnoklassniki.js</span>
<a href="#l90.31"></a><span id="l90.31" class="difflineplus">+@RESPATH@/components/odnoklassniki.manifest</span>
<a href="#l90.32"></a><span id="l90.32" class="difflineplus">+@RESPATH@/components/skype.js</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineplus">+@RESPATH@/components/skype.manifest</span>
<a href="#l90.34"></a><span id="l90.34" class="difflineplus">+@RESPATH@/components/twitter.js</span>
<a href="#l90.35"></a><span id="l90.35" class="difflineplus">+@RESPATH@/components/twitter.manifest</span>
<a href="#l90.36"></a><span id="l90.36" class="difflineplus">+@RESPATH@/components/xmpp.js</span>
<a href="#l90.37"></a><span id="l90.37" class="difflineplus">+@RESPATH@/components/xmpp.manifest</span>
<a href="#l90.38"></a><span id="l90.38" class="difflineplus">+@RESPATH@/components/yahoo.js</span>
<a href="#l90.39"></a><span id="l90.39" class="difflineplus">+@RESPATH@/components/yahoo.manifest</span>
<a href="#l90.40"></a><span id="l90.40" class="difflineplus">+@RESPATH@/components/smileProtocolHandler.js</span>
<a href="#l90.41"></a><span id="l90.41" class="difflineplus">+@RESPATH@/components/smileProtocolHandler.manifest</span>
<a href="#l90.42"></a><span id="l90.42" class="difflineplus">+@RESPATH@/components/logger.js</span>
<a href="#l90.43"></a><span id="l90.43" class="difflineplus">+@RESPATH@/components/logger.manifest</span>
<a href="#l90.44"></a><span id="l90.44"> </span>
<a href="#l90.45"></a><span id="l90.45"> ; Thunderbird specific</span>
<a href="#l90.46"></a><span id="l90.46"> @RESPATH@/@PREF_DIR@/all-im.js</span>
<a href="#l90.47"></a><span id="l90.47"> </span>
<a href="#l90.48"></a><span id="l90.48"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l90.49"></a><span id="l90.49"> ; Chrome Files</span>
<a href="#l90.50"></a><span id="l90.50"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l90.51"></a><span id="l90.51"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

