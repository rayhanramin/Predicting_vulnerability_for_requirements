<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 623:74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107" />
<meta property="og:url" content="/comm-central/rev/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107" />
<meta property="og:description" content="Bug 459000 - Address book comment cleanup; r=bugzilla" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">shortlog</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">files</a> |
changeset |
<a href="/comm-central/raw-rev/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">raw</a>  | <a href="/comm-central/archive/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459000">Bug 459000</a> - Address book comment cleanup; r=bugzilla
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#97;&#114;&#121;&#32;&#75;&#119;&#111;&#110;&#103;&#32;&#60;&#110;&#116;&#104;&#49;&#48;&#115;&#100;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 16 Oct 2008 17:18:01 +0200</td></tr>

<tr>
 <td>changeset 623</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107</a></td>
</tr>



<tr>
<td>parent 622</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5d69c7b6e83ce8039e202198ca209f75e326161b">5d69c7b6e83ce8039e202198ca209f75e326161b</a>
</td>
</tr>

<tr>
<td>child 624</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/10f00472446b535994ef7b9fb4aea1c28f27f6b6">10f00472446b535994ef7b9fb4aea1c28f27f6b6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">554</a></td></tr>
<tr><td>push user</td><td>sgautherie.bz@free.fr</td></tr>
<tr><td>push date</td><td class="date age">Thu, 16 Oct 2008 15:18:21 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@74eeeb2edbe1 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&newProject=comm-central&newRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&newProject=comm-central&newRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&newProject=comm-central&newRevision=74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bugzilla%29&revcount=50">bugzilla</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459000">459000</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=459000">Bug 459000</a> - Address book comment cleanup; r=bugzilla</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">mailnews/addrbook/prefs/resources/content/pref-editdirectories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">mailnews/addrbook/public/nsAbBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/public/nsAbBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">mailnews/addrbook/resources/content/abCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/abCommon.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">mailnews/addrbook/resources/content/addressbook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/resources/content/addressbook.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">mailnews/addrbook/src/nsAbAddressCollecter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbAddressCollecter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">mailnews/addrbook/src/nsAbCardProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbCardProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">mailnews/addrbook/src/nsAbDirProperty.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbDirProperty.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">mailnews/addrbook/src/nsAbMDBCard.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbMDBCard.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">mailnews/addrbook/src/nsAbManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">mailnews/addrbook/src/nsAbOSXDirectory.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOSXDirectory.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">mailnews/addrbook/src/nsAbOutlookCard.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbOutlookCard.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">mailnews/addrbook/src/nsAbView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">mailnews/addrbook/src/nsAbWinHelper.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAbWinHelper.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">mailnews/addrbook/src/nsAddbookProtocolHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsAddbookProtocolHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">mailnews/addrbook/test/unit/test_collection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/addrbook/test/unit/test_collection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">mailnews/base/public/nsIMessenger.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessenger.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">mailnews/base/public/nsIMessengerOSIntegration.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">file</a> |
<a href="/comm-central/annotate/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">annotate</a> |
<a href="/comm-central/diff/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">diff</a> |
<a href="/comm-central/comparison/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">comparison</a> |
<a href="/comm-central/log/74eeeb2edbe1bca9dabda2b8edbab36bd1ba5107/mailnews/base/public/nsIMessengerOSIntegration.idl">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/prefs/resources/content/pref-editdirectories.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -144,17 +144,17 @@ function selectDirectory()</span>
<a href="#l1.4"></a><span id="l1.4">                           .getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l1.5"></a><span id="l1.5">     var ab = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l1.6"></a><span id="l1.6">                        .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l1.7"></a><span id="l1.7">                        .getDirectory(abList.value);</span>
<a href="#l1.8"></a><span id="l1.8">     try {</span>
<a href="#l1.9"></a><span id="l1.9">       disable = prefs.getBoolPref(ab.dirPrefId + &quot;.disable_delete&quot;);</span>
<a href="#l1.10"></a><span id="l1.10">     }</span>
<a href="#l1.11"></a><span id="l1.11">     catch(ex){</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      // if this preference is not set its ok.</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      // If this preference is not set, it's ok.</span>
<a href="#l1.14"></a><span id="l1.14">     }</span>
<a href="#l1.15"></a><span id="l1.15">     if (disable)</span>
<a href="#l1.16"></a><span id="l1.16">       removeButton.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l1.17"></a><span id="l1.17">     else</span>
<a href="#l1.18"></a><span id="l1.18">       removeButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l1.19"></a><span id="l1.19">   }</span>
<a href="#l1.20"></a><span id="l1.20">   else {</span>
<a href="#l1.21"></a><span id="l1.21">     editButton.setAttribute(&quot;disabled&quot;, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/public/nsAbBaseCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -348,17 +348,17 @@</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> #define NS_ABLDAPDIRFACTORY_CID                                \</span>
<a href="#l2.6"></a><span id="l2.6"> {  /* {8e3701af-8828-426c-84ac-124825c778f8} */			\</span>
<a href="#l2.7"></a><span id="l2.7">         0x8e3701af, 0x8828, 0x426c,                             \</span>
<a href="#l2.8"></a><span id="l2.8">         {0x84, 0xac, 0x12, 0x48, 0x25, 0xc7, 0x78, 0xf8}        \</span>
<a href="#l2.9"></a><span id="l2.9"> }</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> //</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// LDAP autcomplete directory factory</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// LDAP autocomplete directory factory</span>
<a href="#l2.14"></a><span id="l2.14"> //</span>
<a href="#l2.15"></a><span id="l2.15"> #define NS_ABLDAPACDIRFACTORY_CONTRACTID \</span>
<a href="#l2.16"></a><span id="l2.16">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;ldap&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #define NS_ABLDAPSACDIRFACTORY_CONTRACTID \</span>
<a href="#l2.18"></a><span id="l2.18">   NS_AB_DIRECTORY_FACTORY_CONTRACTID_PREFIX &quot;ldaps&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> // nsAbLDAPAutoCompFormatter</span>
<a href="#l2.21"></a><span id="l2.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/abCommon.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/abCommon.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -609,17 +609,17 @@ function GetParentDirectoryFromMailingLi</span>
<a href="#l3.4"></a><span id="l3.4">     return abURIArr[0] + &quot;/&quot; + abURIArr[1] + &quot;/&quot; + abURIArr[2];</span>
<a href="#l3.5"></a><span id="l3.5">   }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7">   return null;</span>
<a href="#l3.8"></a><span id="l3.8"> } </span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> function DirPaneHasFocus()</span>
<a href="#l3.11"></a><span id="l3.11"> {</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  // returns true if diectory pane has the focus. Returns false, otherwise.</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  // Returns true if directory pane has the focus. Returns false, otherwise.</span>
<a href="#l3.14"></a><span id="l3.14">   return (top.document.commandDispatcher.focusedElement == dirTree)</span>
<a href="#l3.15"></a><span id="l3.15"> }</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> function GetSelectedDirectory()</span>
<a href="#l3.18"></a><span id="l3.18"> {</span>
<a href="#l3.19"></a><span id="l3.19">   if (abList)</span>
<a href="#l3.20"></a><span id="l3.20">     return abList.value;</span>
<a href="#l3.21"></a><span id="l3.21">   else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/addrbook/resources/content/addressbook.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/addrbook/resources/content/addressbook.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -96,17 +96,17 @@ var gAddressBookAbListener = {</span>
<a href="#l4.4"></a><span id="l4.4">           // Now get the parent of the row.</span>
<a href="#l4.5"></a><span id="l4.5">           var newRow = dirTree.view.getParentIndex(gPreviousDirTreeIndex);</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7">           // if we have no parent (i.e. we are an address book), use the</span>
<a href="#l4.8"></a><span id="l4.8">           // previous index.</span>
<a href="#l4.9"></a><span id="l4.9">           if (newRow == -1)</span>
<a href="#l4.10"></a><span id="l4.10">             newRow = gPreviousDirTreeIndex;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-          // Fall back to the first adddress book if we're not in a valid range</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+          // Fall back to the first address book if we're not in a valid range</span>
<a href="#l4.14"></a><span id="l4.14">           if (newRow &gt;= dirTree.view.rowCount)</span>
<a href="#l4.15"></a><span id="l4.15">             newRow = 0;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">           // Now select the new item.</span>
<a href="#l4.18"></a><span id="l4.18">           dirTree.view.selection.select(newRow);</span>
<a href="#l4.19"></a><span id="l4.19">         }</span>
<a href="#l4.20"></a><span id="l4.20">       }</span>
<a href="#l4.21"></a><span id="l4.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbAddressCollecter.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbAddressCollecter.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -69,17 +69,17 @@ nsAbAddressCollecter::~nsAbAddressCollec</span>
<a href="#l5.4"></a><span id="l5.4">     pPrefBranchInt-&gt;RemoveObserver(PREF_MAIL_COLLECT_ADDRESSBOOK, this);</span>
<a href="#l5.5"></a><span id="l5.5"> }</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> NS_IMETHODIMP nsAbAddressCollecter::GetCardFromAttribute(const nsACString &amp;aName, const nsACString &amp;aValue, nsIAbCard **aCard)</span>
<a href="#l5.8"></a><span id="l5.8"> {</span>
<a href="#l5.9"></a><span id="l5.9">   NS_ENSURE_ARG_POINTER(aCard);</span>
<a href="#l5.10"></a><span id="l5.10">   if (m_database)</span>
<a href="#l5.11"></a><span id="l5.11">     // Please DO NOT change the 3rd param of GetCardFromAttribute() call to </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    // PR_TRUE (ie, case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+    // PR_TRUE (i.e. case insensitive) without reading bugs #128535 and #121478.</span>
<a href="#l5.14"></a><span id="l5.14">     return m_database-&gt;GetCardFromAttribute(m_directory.get(),</span>
<a href="#l5.15"></a><span id="l5.15">                                             PromiseFlatCString(aName).get(),</span>
<a href="#l5.16"></a><span id="l5.16">                                             aValue, PR_FALSE /* retain case */,</span>
<a href="#l5.17"></a><span id="l5.17">                                             aCard);</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   return NS_ERROR_FAILURE;</span>
<a href="#l5.20"></a><span id="l5.20"> }</span>
<a href="#l5.21"></a><span id="l5.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbCardProperty.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -395,17 +395,17 @@ NS_IMETHODIMP nsAbCardProperty::HasEmail</span>
<a href="#l6.4"></a><span id="l6.4">   if (rv != NS_ERROR_NOT_AVAILABLE &amp;&amp;</span>
<a href="#l6.5"></a><span id="l6.5">       emailAddress.Equals(aEmailAddress, CaseInsensitiveCompare))</span>
<a href="#l6.6"></a><span id="l6.6"> #endif</span>
<a href="#l6.7"></a><span id="l6.7">     *aResult = PR_TRUE;</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   return NS_OK;</span>
<a href="#l6.10"></a><span id="l6.10"> }</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-// This function may be overriden by derived classes for</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+// This function may be overridden by derived classes for</span>
<a href="#l6.14"></a><span id="l6.14"> // nsAb*Card specific implementations.</span>
<a href="#l6.15"></a><span id="l6.15"> NS_IMETHODIMP nsAbCardProperty::Copy(nsIAbCard* srcCard)</span>
<a href="#l6.16"></a><span id="l6.16"> {</span>
<a href="#l6.17"></a><span id="l6.17">   NS_ENSURE_ARG_POINTER(srcCard);</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   nsCOMPtr&lt;nsISimpleEnumerator&gt; properties;</span>
<a href="#l6.20"></a><span id="l6.20">   nsresult rv = srcCard-&gt;GetProperties(getter_AddRefs(properties));</span>
<a href="#l6.21"></a><span id="l6.21">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbDirProperty.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -105,17 +105,17 @@ NS_IMETHODIMP nsAbDirProperty::GetDirNam</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   CopyUTF8toUTF16(dirName, aDirName);</span>
<a href="#l7.6"></a><span id="l7.6">   return NS_OK;</span>
<a href="#l7.7"></a><span id="l7.7"> }</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> // XXX Although mailing lists could use the NotifyItemPropertyChanged</span>
<a href="#l7.10"></a><span id="l7.10"> // mechanism here, it requires some rework on how we write/save data</span>
<a href="#l7.11"></a><span id="l7.11"> // relating to mailing lists, so we're just using the old method of a</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-// local variable to store tha mailing list name.</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+// local variable to store the mailing list name.</span>
<a href="#l7.14"></a><span id="l7.14"> NS_IMETHODIMP nsAbDirProperty::SetDirName(const nsAString &amp;aDirName)</span>
<a href="#l7.15"></a><span id="l7.15"> {</span>
<a href="#l7.16"></a><span id="l7.16">   if (m_DirPrefId.IsEmpty())</span>
<a href="#l7.17"></a><span id="l7.17">   {</span>
<a href="#l7.18"></a><span id="l7.18">     m_ListDirName = aDirName;</span>
<a href="#l7.19"></a><span id="l7.19">     return NS_OK;</span>
<a href="#l7.20"></a><span id="l7.20">   }</span>
<a href="#l7.21"></a><span id="l7.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPChangeLogData.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -53,17 +53,17 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;plstr.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsILDAPErrors.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;prmem.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-// defined here since to be used </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+// Defined here since to be used</span>
<a href="#l8.14"></a><span id="l8.14"> // only locally to this file.</span>
<a href="#l8.15"></a><span id="l8.15"> enum UpdateOp {</span>
<a href="#l8.16"></a><span id="l8.16">  NO_OP,</span>
<a href="#l8.17"></a><span id="l8.17">  ENTRY_ADD,</span>
<a href="#l8.18"></a><span id="l8.18">  ENTRY_DELETE,</span>
<a href="#l8.19"></a><span id="l8.19">  ENTRY_MODIFY</span>
<a href="#l8.20"></a><span id="l8.20"> };</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -80,24 +80,24 @@ nsAbLDAPProcessChangeLogData::~nsAbLDAPP</span>
<a href="#l8.23"></a><span id="l8.23"> {</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> }</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> NS_IMETHODIMP nsAbLDAPProcessChangeLogData::Init(nsIAbLDAPReplicationQuery * query, nsIWebProgressListener *progressListener)</span>
<a href="#l8.28"></a><span id="l8.28"> {</span>
<a href="#l8.29"></a><span id="l8.29">    NS_ENSURE_ARG_POINTER(query);</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-   // here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery object,</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+   // Here we are assuming that the caller will pass a nsAbLDAPChangeLogQuery object,</span>
<a href="#l8.33"></a><span id="l8.33">    // an implementation derived from the implementation of nsIAbLDAPReplicationQuery.</span>
<a href="#l8.34"></a><span id="l8.34">    nsresult rv = NS_OK;</span>
<a href="#l8.35"></a><span id="l8.35">    mChangeLogQuery = do_QueryInterface(query, &amp;rv);</span>
<a href="#l8.36"></a><span id="l8.36">    if(NS_FAILED(rv))</span>
<a href="#l8.37"></a><span id="l8.37">        return rv;</span>
<a href="#l8.38"></a><span id="l8.38">    </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-   // call the parent's Init now</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+   // Call the parent's Init now.</span>
<a href="#l8.41"></a><span id="l8.41">    return nsAbLDAPProcessReplicationData::Init(query, progressListener);</span>
<a href="#l8.42"></a><span id="l8.42"> }</span>
<a href="#l8.43"></a><span id="l8.43"> </span>
<a href="#l8.44"></a><span id="l8.44"> nsresult nsAbLDAPProcessChangeLogData::OnLDAPBind(nsILDAPMessage *aMessage)</span>
<a href="#l8.45"></a><span id="l8.45"> {</span>
<a href="#l8.46"></a><span id="l8.46">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l8.47"></a><span id="l8.47"> 	if(!mInitialized) </span>
<a href="#l8.48"></a><span id="l8.48">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineat">@@ -155,17 +155,17 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.50"></a><span id="l8.50">         }</span>
<a href="#l8.51"></a><span id="l8.51">         break;</span>
<a href="#l8.52"></a><span id="l8.52">     case kSearchingRootDSE:</span>
<a href="#l8.53"></a><span id="l8.53">         rv = ParseRootDSEEntry(aMessage);</span>
<a href="#l8.54"></a><span id="l8.54">         break;</span>
<a href="#l8.55"></a><span id="l8.55">     case kFindingChanges:</span>
<a href="#l8.56"></a><span id="l8.56">         rv = ParseChangeLogEntries(aMessage);</span>
<a href="#l8.57"></a><span id="l8.57">         break;</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    // fall through since we only add (for updates we delete and add)</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    // Fall through since we only add (for updates we delete and add)</span>
<a href="#l8.60"></a><span id="l8.60">     case kReplicatingChanges:</span>
<a href="#l8.61"></a><span id="l8.61">     case kReplicatingAll :</span>
<a href="#l8.62"></a><span id="l8.62">         return nsAbLDAPProcessReplicationData::OnLDAPSearchEntry(aMessage);</span>
<a href="#l8.63"></a><span id="l8.63">     }</span>
<a href="#l8.64"></a><span id="l8.64"> </span>
<a href="#l8.65"></a><span id="l8.65">     if(NS_FAILED(rv))</span>
<a href="#l8.66"></a><span id="l8.66">         Abort();</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68" class="difflineat">@@ -186,17 +186,17 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.69"></a><span id="l8.69">     {</span>
<a href="#l8.70"></a><span id="l8.70">         if(errorCode == nsILDAPErrors::SUCCESS || errorCode == nsILDAPErrors::SIZELIMIT_EXCEEDED) {</span>
<a href="#l8.71"></a><span id="l8.71">             switch(mState) {</span>
<a href="#l8.72"></a><span id="l8.72">             case kSearchingAuthDN :</span>
<a href="#l8.73"></a><span id="l8.73">                 rv = OnSearchAuthDNDone();</span>
<a href="#l8.74"></a><span id="l8.74">                 break;</span>
<a href="#l8.75"></a><span id="l8.75">             case kSearchingRootDSE:</span>
<a href="#l8.76"></a><span id="l8.76">              {</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineminus">-                // before starting the changeLog check the DB file, if its not there or bogus</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+                // Before starting the changeLog check the DB file, if its not there or bogus</span>
<a href="#l8.79"></a><span id="l8.79">                 // we need to create a new one and set to all.</span>
<a href="#l8.80"></a><span id="l8.80">                 nsCOMPtr&lt;nsIAddrBookSession&gt; abSession = do_GetService(NS_ADDRBOOKSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l8.81"></a><span id="l8.81">                 if (NS_FAILED(rv)) </span>
<a href="#l8.82"></a><span id="l8.82">                     break;</span>
<a href="#l8.83"></a><span id="l8.83">                 nsCOMPtr&lt;nsILocalFile&gt; dbPath;</span>
<a href="#l8.84"></a><span id="l8.84">                 rv = abSession-&gt;GetUserProfileDirectory(getter_AddRefs(dbPath));</span>
<a href="#l8.85"></a><span id="l8.85">                 if (NS_FAILED(rv)) </span>
<a href="#l8.86"></a><span id="l8.86">                     break;</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineat">@@ -218,44 +218,44 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.88"></a><span id="l8.88">                 PRInt64 fileSize;</span>
<a href="#l8.89"></a><span id="l8.89">                 rv = dbPath-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l8.90"></a><span id="l8.90">                 if(NS_FAILED(rv)) </span>
<a href="#l8.91"></a><span id="l8.91">                     break;</span>
<a href="#l8.92"></a><span id="l8.92"> </span>
<a href="#l8.93"></a><span id="l8.93">                 if (!fileExists || !fileSize)</span>
<a href="#l8.94"></a><span id="l8.94">                     mUseChangeLog = PR_FALSE;</span>
<a href="#l8.95"></a><span id="l8.95"> </span>
<a href="#l8.96"></a><span id="l8.96" class="difflineminus">-                // open / create the AB here since it calls Done,</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-                // just return from here. </span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+                // Open / create the AB here since it calls Done,</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+                // just return from here.</span>
<a href="#l8.100"></a><span id="l8.100">                 if (mUseChangeLog)</span>
<a href="#l8.101"></a><span id="l8.101">                    rv = OpenABForReplicatedDir(PR_FALSE);</span>
<a href="#l8.102"></a><span id="l8.102">                 else</span>
<a href="#l8.103"></a><span id="l8.103">                    rv = OpenABForReplicatedDir(PR_TRUE);</span>
<a href="#l8.104"></a><span id="l8.104">                 if (NS_FAILED(rv))</span>
<a href="#l8.105"></a><span id="l8.105">                    return rv;</span>
<a href="#l8.106"></a><span id="l8.106">                 </span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-                // now start the appropriate query</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+                // Now start the appropriate query</span>
<a href="#l8.109"></a><span id="l8.109">                 rv = OnSearchRootDSEDone();</span>
<a href="#l8.110"></a><span id="l8.110">                 break;</span>
<a href="#l8.111"></a><span id="l8.111">              }</span>
<a href="#l8.112"></a><span id="l8.112">             case kFindingChanges:</span>
<a href="#l8.113"></a><span id="l8.113">                 rv = OnFindingChangesDone();</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-                // if success we return from here since</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+                // If success we return from here since</span>
<a href="#l8.116"></a><span id="l8.116">                 // this changes state to kReplicatingChanges</span>
<a href="#l8.117"></a><span id="l8.117">                 // and it falls thru into the if clause below.</span>
<a href="#l8.118"></a><span id="l8.118">                 if (NS_SUCCEEDED(rv))</span>
<a href="#l8.119"></a><span id="l8.119">                     return rv;</span>
<a href="#l8.120"></a><span id="l8.120">                 break;</span>
<a href="#l8.121"></a><span id="l8.121">             case kReplicatingAll :</span>
<a href="#l8.122"></a><span id="l8.122">                 return nsAbLDAPProcessReplicationData::OnLDAPSearchResult(aMessage);</span>
<a href="#l8.123"></a><span id="l8.123">             } // end of switch</span>
<a href="#l8.124"></a><span id="l8.124">         }</span>
<a href="#l8.125"></a><span id="l8.125">         else</span>
<a href="#l8.126"></a><span id="l8.126">             rv = NS_ERROR_FAILURE;</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-        // if one of the changed entry in changelog is not found, </span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+        // If one of the changed entry in changelog is not found,</span>
<a href="#l8.129"></a><span id="l8.129">         // continue with replicating the next one.</span>
<a href="#l8.130"></a><span id="l8.130">         if(mState == kReplicatingChanges)</span>
<a href="#l8.131"></a><span id="l8.131">             rv = OnReplicatingChangeDone();</span>
<a href="#l8.132"></a><span id="l8.132">     } // end of outer if</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134">     if(NS_FAILED(rv))</span>
<a href="#l8.135"></a><span id="l8.135">         Abort();</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137" class="difflineat">@@ -342,20 +342,20 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.138"></a><span id="l8.138"> }</span>
<a href="#l8.139"></a><span id="l8.139"> </span>
<a href="#l8.140"></a><span id="l8.140"> nsresult nsAbLDAPProcessChangeLogData::ParseRootDSEEntry(nsILDAPMessage *aMessage)</span>
<a href="#l8.141"></a><span id="l8.141"> {</span>
<a href="#l8.142"></a><span id="l8.142">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l8.143"></a><span id="l8.143">     if (!mInitialized)</span>
<a href="#l8.144"></a><span id="l8.144">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    // populate the RootDSEChangeLogEntry</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+    // Populate the RootDSEChangeLogEntry</span>
<a href="#l8.148"></a><span id="l8.148">     CharPtrArrayGuard attrs;</span>
<a href="#l8.149"></a><span id="l8.149">     nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-    // no attributes !!!</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+    // No attributes</span>
<a href="#l8.152"></a><span id="l8.152">     if(NS_FAILED(rv)) </span>
<a href="#l8.153"></a><span id="l8.153">         return rv;</span>
<a href="#l8.154"></a><span id="l8.154"> </span>
<a href="#l8.155"></a><span id="l8.155">     for(PRInt32 i=attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l8.156"></a><span id="l8.156">         PRUnicharPtrArrayGuard vals;</span>
<a href="#l8.157"></a><span id="l8.157">         rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l8.158"></a><span id="l8.158">         if(NS_FAILED(rv))</span>
<a href="#l8.159"></a><span id="l8.159">             continue;</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineat">@@ -376,17 +376,17 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l8.161"></a><span id="l8.161"> </span>
<a href="#l8.162"></a><span id="l8.162">     if ((mRootDSEEntry.lastChangeNumber &gt; 0) &amp;&amp;</span>
<a href="#l8.163"></a><span id="l8.163">         (lastChangeNumber &lt; mRootDSEEntry.lastChangeNumber) &amp;&amp;</span>
<a href="#l8.164"></a><span id="l8.164">         (lastChangeNumber &gt; mRootDSEEntry.firstChangeNumber))</span>
<a href="#l8.165"></a><span id="l8.165">         mUseChangeLog = PR_TRUE;</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167">     if (mRootDSEEntry.lastChangeNumber &amp;&amp;</span>
<a href="#l8.168"></a><span id="l8.168">         (lastChangeNumber == mRootDSEEntry.lastChangeNumber)) {</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-        Done(PR_TRUE); // we are up to date no need to replicate, db not open yet so call Done</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+        Done(PR_TRUE); // We are up to date no need to replicate, db not open yet so call Done</span>
<a href="#l8.171"></a><span id="l8.171">         return NS_OK;</span>
<a href="#l8.172"></a><span id="l8.172">     }</span>
<a href="#l8.173"></a><span id="l8.173"> </span>
<a href="#l8.174"></a><span id="l8.174">     return rv;</span>
<a href="#l8.175"></a><span id="l8.175"> }</span>
<a href="#l8.176"></a><span id="l8.176"> </span>
<a href="#l8.177"></a><span id="l8.177"> nsresult nsAbLDAPProcessChangeLogData::OnSearchRootDSEDone()</span>
<a href="#l8.178"></a><span id="l8.178"> {</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineat">@@ -421,20 +421,20 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.180"></a><span id="l8.180"> }</span>
<a href="#l8.181"></a><span id="l8.181"> </span>
<a href="#l8.182"></a><span id="l8.182"> nsresult nsAbLDAPProcessChangeLogData::ParseChangeLogEntries(nsILDAPMessage *aMessage)</span>
<a href="#l8.183"></a><span id="l8.183"> {</span>
<a href="#l8.184"></a><span id="l8.184">     NS_ENSURE_ARG_POINTER(aMessage);</span>
<a href="#l8.185"></a><span id="l8.185">     if(!mInitialized) </span>
<a href="#l8.186"></a><span id="l8.186">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.187"></a><span id="l8.187"> </span>
<a href="#l8.188"></a><span id="l8.188" class="difflineminus">-    // populate the RootDSEChangeLogEntry</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineplus">+    // Populate the RootDSEChangeLogEntry</span>
<a href="#l8.190"></a><span id="l8.190">     CharPtrArrayGuard attrs;</span>
<a href="#l8.191"></a><span id="l8.191">     nsresult rv = aMessage-&gt;GetAttributes(attrs.GetSizeAddr(), attrs.GetArrayAddr());</span>
<a href="#l8.192"></a><span id="l8.192" class="difflineminus">-    // no attributes</span>
<a href="#l8.193"></a><span id="l8.193" class="difflineplus">+    // No attributes</span>
<a href="#l8.194"></a><span id="l8.194">     if(NS_FAILED(rv)) </span>
<a href="#l8.195"></a><span id="l8.195">         return rv;</span>
<a href="#l8.196"></a><span id="l8.196"> </span>
<a href="#l8.197"></a><span id="l8.197">     nsAutoString targetDN;</span>
<a href="#l8.198"></a><span id="l8.198">     UpdateOp operation = NO_OP;</span>
<a href="#l8.199"></a><span id="l8.199">     for(PRInt32 i = attrs.GetSize()-1; i &gt;= 0; i--) {</span>
<a href="#l8.200"></a><span id="l8.200">         PRUnicharPtrArrayGuard vals;</span>
<a href="#l8.201"></a><span id="l8.201">         rv = aMessage-&gt;GetValues(attrs.GetArray()[i], vals.GetSizeAddr(), vals.GetArrayAddr());</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineat">@@ -450,93 +450,93 @@ nsresult nsAbLDAPProcessChangeLogData::P</span>
<a href="#l8.203"></a><span id="l8.203">                     operation = ENTRY_MODIFY;</span>
<a href="#l8.204"></a><span id="l8.204">                 if (!Compare(nsDependentString(vals[0]), NS_LITERAL_STRING(&quot;delete&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l8.205"></a><span id="l8.205">                     operation = ENTRY_DELETE;</span>
<a href="#l8.206"></a><span id="l8.206">             }</span>
<a href="#l8.207"></a><span id="l8.207">         }</span>
<a href="#l8.208"></a><span id="l8.208">     }</span>
<a href="#l8.209"></a><span id="l8.209"> </span>
<a href="#l8.210"></a><span id="l8.210">     mChangeLogEntriesCount++;</span>
<a href="#l8.211"></a><span id="l8.211" class="difflineminus">-    if(!(mChangeLogEntriesCount % 10)) { // inform the listener every 10 entries</span>
<a href="#l8.212"></a><span id="l8.212" class="difflineplus">+    if(!(mChangeLogEntriesCount % 10)) { // Inform the listener every 10 entries</span>
<a href="#l8.213"></a><span id="l8.213">         mListener-&gt;OnProgressChange(nsnull,nsnull,mChangeLogEntriesCount, -1, mChangeLogEntriesCount, -1);</span>
<a href="#l8.214"></a><span id="l8.214" class="difflineminus">-        // in case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l8.215"></a><span id="l8.215" class="difflineplus">+        // In case if the LDAP Connection thread is starved and causes problem</span>
<a href="#l8.216"></a><span id="l8.216">         // uncomment this one and try.</span>
<a href="#l8.217"></a><span id="l8.217">         // PR_Sleep(PR_INTERVAL_NO_WAIT); // give others a chance</span>
<a href="#l8.218"></a><span id="l8.218">     }</span>
<a href="#l8.219"></a><span id="l8.219"> </span>
<a href="#l8.220"></a><span id="l8.220"> #ifdef DEBUG_rdayal</span>
<a href="#l8.221"></a><span id="l8.221">     printf (&quot;ChangeLog Replication : Updated Entry : %s for OpType : %u\n&quot;, </span>
<a href="#l8.222"></a><span id="l8.222">                                     NS_ConvertUTF16toUTF8(targetDN).get(), operation);</span>
<a href="#l8.223"></a><span id="l8.223"> #endif</span>
<a href="#l8.224"></a><span id="l8.224"> </span>
<a href="#l8.225"></a><span id="l8.225">     switch(operation) {</span>
<a href="#l8.226"></a><span id="l8.226">     case ENTRY_ADD:</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-        // add the DN to the add list if not already in the list</span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+        // Add the DN to the add list if not already in the list</span>
<a href="#l8.229"></a><span id="l8.229">         if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l8.230"></a><span id="l8.230">             mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l8.231"></a><span id="l8.231">         break;</span>
<a href="#l8.232"></a><span id="l8.232">     case ENTRY_DELETE:</span>
<a href="#l8.233"></a><span id="l8.233" class="difflineminus">-        // donot check the return here since delete may fail if </span>
<a href="#l8.234"></a><span id="l8.234" class="difflineminus">-        // entry deleted in changelog doesnot exist in DB </span>
<a href="#l8.235"></a><span id="l8.235" class="difflineplus">+        // Do not check the return here since delete may fail if</span>
<a href="#l8.236"></a><span id="l8.236" class="difflineplus">+        // entry deleted in changelog does not exist in DB</span>
<a href="#l8.237"></a><span id="l8.237">         // for e.g if the user specifies a filter, so go next entry</span>
<a href="#l8.238"></a><span id="l8.238">         DeleteCard(targetDN);</span>
<a href="#l8.239"></a><span id="l8.239">         break;</span>
<a href="#l8.240"></a><span id="l8.240">     case ENTRY_MODIFY:</span>
<a href="#l8.241"></a><span id="l8.241" class="difflineminus">-        // for modify, delte the entry from DB and add updated entry</span>
<a href="#l8.242"></a><span id="l8.242" class="difflineplus">+        // For modify, delete the entry from DB and add updated entry</span>
<a href="#l8.243"></a><span id="l8.243">         // we do this since we cannot access the changes attribs of changelog</span>
<a href="#l8.244"></a><span id="l8.244">         rv = DeleteCard(targetDN);</span>
<a href="#l8.245"></a><span id="l8.245">         if (NS_SUCCEEDED(rv)) </span>
<a href="#l8.246"></a><span id="l8.246">             if(!(mEntriesToAdd.IndexOf(targetDN) &gt;= 0))</span>
<a href="#l8.247"></a><span id="l8.247">                 mEntriesToAdd.AppendString(targetDN);</span>
<a href="#l8.248"></a><span id="l8.248">         break;</span>
<a href="#l8.249"></a><span id="l8.249">     default:</span>
<a href="#l8.250"></a><span id="l8.250" class="difflineminus">-        // should not come here, would come here only</span>
<a href="#l8.251"></a><span id="l8.251" class="difflineplus">+        // Should not come here, would come here only</span>
<a href="#l8.252"></a><span id="l8.252">         // if the entry is not a changeLog entry</span>
<a href="#l8.253"></a><span id="l8.253">         NS_WARNING(&quot;nsAbLDAPProcessChangeLogData::ParseChangeLogEntries&quot;</span>
<a href="#l8.254"></a><span id="l8.254">            &quot;Not an changelog entry&quot;);</span>
<a href="#l8.255"></a><span id="l8.255">     }</span>
<a href="#l8.256"></a><span id="l8.256"> </span>
<a href="#l8.257"></a><span id="l8.257" class="difflineminus">-    // go ahead processing the next entry,  a modify or delete DB operation </span>
<a href="#l8.258"></a><span id="l8.258" class="difflineminus">-    // can 'correctly' fail if the entry is not present in the DB. </span>
<a href="#l8.259"></a><span id="l8.259" class="difflineminus">-    // eg : in case a filter is specified.</span>
<a href="#l8.260"></a><span id="l8.260" class="difflineplus">+    // Go ahead processing the next entry, a modify or delete DB operation</span>
<a href="#l8.261"></a><span id="l8.261" class="difflineplus">+    // can 'correctly' fail if the entry is not present in the DB,</span>
<a href="#l8.262"></a><span id="l8.262" class="difflineplus">+    // e.g. in case a filter is specified.</span>
<a href="#l8.263"></a><span id="l8.263">     return NS_OK;</span>
<a href="#l8.264"></a><span id="l8.264"> }</span>
<a href="#l8.265"></a><span id="l8.265"> </span>
<a href="#l8.266"></a><span id="l8.266"> nsresult nsAbLDAPProcessChangeLogData::OnFindingChangesDone()</span>
<a href="#l8.267"></a><span id="l8.267"> {</span>
<a href="#l8.268"></a><span id="l8.268">     if(!mInitialized) </span>
<a href="#l8.269"></a><span id="l8.269">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.270"></a><span id="l8.270"> </span>
<a href="#l8.271"></a><span id="l8.271"> #ifdef DEBUG_rdayal</span>
<a href="#l8.272"></a><span id="l8.272">     printf (&quot;ChangeLog Replication : Finding Changes Done \n&quot;);</span>
<a href="#l8.273"></a><span id="l8.273"> #endif</span>
<a href="#l8.274"></a><span id="l8.274"> </span>
<a href="#l8.275"></a><span id="l8.275">     nsresult rv = NS_OK;</span>
<a href="#l8.276"></a><span id="l8.276"> </span>
<a href="#l8.277"></a><span id="l8.277" class="difflineminus">-    // no entries to add/update (for updates too we delete and add) entries,</span>
<a href="#l8.278"></a><span id="l8.278" class="difflineplus">+    // No entries to add/update (for updates too we delete and add) entries,</span>
<a href="#l8.279"></a><span id="l8.279">     // we took care of deletes in ParseChangeLogEntries, all Done!</span>
<a href="#l8.280"></a><span id="l8.280">     mEntriesAddedQueryCount = mEntriesToAdd.Count();</span>
<a href="#l8.281"></a><span id="l8.281">     if(mEntriesAddedQueryCount &lt;= 0) {</span>
<a href="#l8.282"></a><span id="l8.282">         if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l8.283"></a><span id="l8.283" class="difflineminus">-            // close the DB, no need to commit since we have not made</span>
<a href="#l8.284"></a><span id="l8.284" class="difflineplus">+            // Close the DB, no need to commit since we have not made</span>
<a href="#l8.285"></a><span id="l8.285">             // any changes yet to the DB.</span>
<a href="#l8.286"></a><span id="l8.286">             rv = mReplicationDB-&gt;Close(PR_FALSE);</span>
<a href="#l8.287"></a><span id="l8.287">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB Close(no commit) on Success failed&quot;);</span>
<a href="#l8.288"></a><span id="l8.288">             mDBOpen = PR_FALSE;</span>
<a href="#l8.289"></a><span id="l8.289" class="difflineminus">-            // once are done with the replication file, delete the backup file</span>
<a href="#l8.290"></a><span id="l8.290" class="difflineplus">+            // Once are done with the replication file, delete the backup file</span>
<a href="#l8.291"></a><span id="l8.291">             if(mBackupReplicationFile) {</span>
<a href="#l8.292"></a><span id="l8.292">                 rv = mBackupReplicationFile-&gt;Remove(PR_FALSE);</span>
<a href="#l8.293"></a><span id="l8.293">                 NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l8.294"></a><span id="l8.294">             }</span>
<a href="#l8.295"></a><span id="l8.295">         }</span>
<a href="#l8.296"></a><span id="l8.296">         Done(PR_TRUE);</span>
<a href="#l8.297"></a><span id="l8.297">         return NS_OK;</span>
<a href="#l8.298"></a><span id="l8.298">     }</span>
<a href="#l8.299"></a><span id="l8.299"> </span>
<a href="#l8.300"></a><span id="l8.300" class="difflineminus">-    // decrement the count first to get the correct array element</span>
<a href="#l8.301"></a><span id="l8.301" class="difflineplus">+    // Decrement the count first to get the correct array element</span>
<a href="#l8.302"></a><span id="l8.302">     mEntriesAddedQueryCount--;</span>
<a href="#l8.303"></a><span id="l8.303">     rv = mChangeLogQuery-&gt;QueryChangedEntries(NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l8.304"></a><span id="l8.304">     if (NS_FAILED(rv))</span>
<a href="#l8.305"></a><span id="l8.305">         return rv;</span>
<a href="#l8.306"></a><span id="l8.306"> </span>
<a href="#l8.307"></a><span id="l8.307">     if(mListener &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l8.308"></a><span id="l8.308">         mListener-&gt;OnStateChange(nsnull, nsnull, nsIWebProgressListener::STATE_START, PR_TRUE);</span>
<a href="#l8.309"></a><span id="l8.309"> </span>
<a href="#l8.310"></a><span id="l8.310" class="difflineat">@@ -549,30 +549,30 @@ nsresult nsAbLDAPProcessChangeLogData::O</span>
<a href="#l8.311"></a><span id="l8.311">     if(!mInitialized) </span>
<a href="#l8.312"></a><span id="l8.312">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l8.313"></a><span id="l8.313"> </span>
<a href="#l8.314"></a><span id="l8.314">     nsresult rv = NS_OK;</span>
<a href="#l8.315"></a><span id="l8.315"> </span>
<a href="#l8.316"></a><span id="l8.316">     if(!mEntriesAddedQueryCount)</span>
<a href="#l8.317"></a><span id="l8.317">     {</span>
<a href="#l8.318"></a><span id="l8.318">         if(mReplicationDB &amp;&amp; mDBOpen) {</span>
<a href="#l8.319"></a><span id="l8.319" class="difflineminus">-            rv = mReplicationDB-&gt;Close(PR_TRUE); // commit and close the DB</span>
<a href="#l8.320"></a><span id="l8.320" class="difflineplus">+            rv = mReplicationDB-&gt;Close(PR_TRUE); // Commit and close the DB</span>
<a href="#l8.321"></a><span id="l8.321">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication DB Close (commit) on Success failed&quot;);</span>
<a href="#l8.322"></a><span id="l8.322">             mDBOpen = PR_FALSE;</span>
<a href="#l8.323"></a><span id="l8.323">         }</span>
<a href="#l8.324"></a><span id="l8.324" class="difflineminus">-        // once we done with the replication file, delete the backup file</span>
<a href="#l8.325"></a><span id="l8.325" class="difflineplus">+        // Once we done with the replication file, delete the backup file.</span>
<a href="#l8.326"></a><span id="l8.326">         if(mBackupReplicationFile) {</span>
<a href="#l8.327"></a><span id="l8.327">             rv = mBackupReplicationFile-&gt;Remove(PR_FALSE);</span>
<a href="#l8.328"></a><span id="l8.328">             NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Replication BackupFile Remove on Success failed&quot;);</span>
<a href="#l8.329"></a><span id="l8.329">         }</span>
<a href="#l8.330"></a><span id="l8.330" class="difflineminus">-        Done(PR_TRUE);  // all data is received</span>
<a href="#l8.331"></a><span id="l8.331" class="difflineplus">+        Done(PR_TRUE);  // All data is received</span>
<a href="#l8.332"></a><span id="l8.332">         return NS_OK;</span>
<a href="#l8.333"></a><span id="l8.333">     }</span>
<a href="#l8.334"></a><span id="l8.334"> </span>
<a href="#l8.335"></a><span id="l8.335" class="difflineminus">-    // remove the entry already added from the list and query the next one</span>
<a href="#l8.336"></a><span id="l8.336" class="difflineplus">+    // Remove the entry already added from the list and query the next one.</span>
<a href="#l8.337"></a><span id="l8.337">     if(mEntriesAddedQueryCount &lt; mEntriesToAdd.Count() &amp;&amp; mEntriesAddedQueryCount &gt;= 0)</span>
<a href="#l8.338"></a><span id="l8.338">         mEntriesToAdd.RemoveStringAt(mEntriesAddedQueryCount);</span>
<a href="#l8.339"></a><span id="l8.339">     mEntriesAddedQueryCount--;</span>
<a href="#l8.340"></a><span id="l8.340">     rv = mChangeLogQuery-&gt;QueryChangedEntries(NS_ConvertUTF16toUTF8(*(mEntriesToAdd[mEntriesAddedQueryCount])));</span>
<a href="#l8.341"></a><span id="l8.341"> </span>
<a href="#l8.342"></a><span id="l8.342">     return rv;</span>
<a href="#l8.343"></a><span id="l8.343"> }</span>
<a href="#l8.344"></a><span id="l8.344"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationService.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -65,17 +65,17 @@ NS_IMETHODIMP nsAbLDAPReplicationService</span>
<a href="#l9.4"></a><span id="l9.4"> 							   nsIWebProgressListener *progressListener)</span>
<a href="#l9.5"></a><span id="l9.5"> {</span>
<a href="#l9.6"></a><span id="l9.6">   NS_ENSURE_ARG_POINTER(aDirectory);</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> #ifdef DEBUG_rdayal</span>
<a href="#l9.9"></a><span id="l9.9">   printf(&quot;Start Replication called&quot;);</span>
<a href="#l9.10"></a><span id="l9.10"> #endif</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  // makes sure to allow only one replication at a time</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  // Makes sure to allow only one replication at a time.</span>
<a href="#l9.14"></a><span id="l9.14">   if(mReplicating)</span>
<a href="#l9.15"></a><span id="l9.15">     return NS_ERROR_FAILURE;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   mDirectory = aDirectory;</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   nsresult rv = NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l9.20"></a><span id="l9.20"> </span>
<a href="#l9.21"></a><span id="l9.21">   switch (DecideProtocol())</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -127,42 +127,42 @@ NS_IMETHODIMP nsAbLDAPReplicationService</span>
<a href="#l9.23"></a><span id="l9.23">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l9.24"></a><span id="l9.24"> </span>
<a href="#l9.25"></a><span id="l9.25">   if (aDirectory == mDirectory)</span>
<a href="#l9.26"></a><span id="l9.26">   {</span>
<a href="#l9.27"></a><span id="l9.27">     if (mQuery &amp;&amp; mReplicating)</span>
<a href="#l9.28"></a><span id="l9.28">       rv = mQuery-&gt;CancelQuery();  </span>
<a href="#l9.29"></a><span id="l9.29">   }</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-  // if query has been cancelled successfully</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+  // If query has been cancelled successfully</span>
<a href="#l9.33"></a><span id="l9.33">   if (NS_SUCCEEDED(rv))</span>
<a href="#l9.34"></a><span id="l9.34">     Done(PR_FALSE);</span>
<a href="#l9.35"></a><span id="l9.35"> </span>
<a href="#l9.36"></a><span id="l9.36">   return rv;</span>
<a href="#l9.37"></a><span id="l9.37"> }</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39"> NS_IMETHODIMP nsAbLDAPReplicationService::Done(PRBool aSuccess)</span>
<a href="#l9.40"></a><span id="l9.40"> {</span>
<a href="#l9.41"></a><span id="l9.41">   mReplicating = PR_FALSE;</span>
<a href="#l9.42"></a><span id="l9.42">   if (mQuery)</span>
<a href="#l9.43"></a><span id="l9.43">   {</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-    mQuery = nsnull;  // release query obj</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-    mDirectory = nsnull; // release directory</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    mQuery = nsnull;  // Release query obj</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    mDirectory = nsnull; // Release directory</span>
<a href="#l9.48"></a><span id="l9.48">   }</span>
<a href="#l9.49"></a><span id="l9.49"> </span>
<a href="#l9.50"></a><span id="l9.50">   return NS_OK;</span>
<a href="#l9.51"></a><span id="l9.51"> }</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-// XXX: This method should query the RootDSE for the changeLog attribute, </span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+// XXX: This method should query the RootDSE for the changeLog attribute,</span>
<a href="#l9.56"></a><span id="l9.56"> // if it exists ChangeLog protocol is supported.</span>
<a href="#l9.57"></a><span id="l9.57"> PRInt32 nsAbLDAPReplicationService::DecideProtocol()</span>
<a href="#l9.58"></a><span id="l9.58"> {</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-  // do the changeLog, it will decide if there is a need to replicate all</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineminus">-  // entries or only update existing DB and will do the approprite thing.</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+  // Do the changeLog, it will decide if there is a need to replicate all</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+  // entries or only update existing DB and will do the appropriate thing.</span>
<a href="#l9.63"></a><span id="l9.63">   //</span>
<a href="#l9.64"></a><span id="l9.64">   // XXX: Bug 231965 changed this from kChangeLogProtocol to</span>
<a href="#l9.65"></a><span id="l9.65">   // kDefaultDownloadAll because of a problem with ldap replication not</span>
<a href="#l9.66"></a><span id="l9.66">   // working correctly. We need to change this back at some stage (bug 311632).</span>
<a href="#l9.67"></a><span id="l9.67">   return nsIAbLDAPProcessReplicationData::kDefaultDownloadAll;</span>
<a href="#l9.68"></a><span id="l9.68"> }</span>
<a href="#l9.69"></a><span id="l9.69"> </span>
<a href="#l9.70"></a><span id="l9.70"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbMDBCard.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -56,17 +56,17 @@ NS_IMETHODIMP nsAbMDBCard::Equals(nsIAbC</span>
<a href="#l10.4"></a><span id="l10.4">   }</span>
<a href="#l10.5"></a><span id="l10.5"> </span>
<a href="#l10.6"></a><span id="l10.6">   // If we have the same directory, we will equal the other card merely given</span>
<a href="#l10.7"></a><span id="l10.7">   // the row IDs. If not, we are never equal. But we are dumb in that we don't</span>
<a href="#l10.8"></a><span id="l10.8">   // know who our directory is, which may change in the future. For now,</span>
<a href="#l10.9"></a><span id="l10.9">   // however, the only known users of this method are for locating us in a list</span>
<a href="#l10.10"></a><span id="l10.10">   // of cards, most commonly mailing lists; a warning on the IDL has also</span>
<a href="#l10.11"></a><span id="l10.11">   // notified consumers that this method is not generally safe to use. In this</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  // respect, it is safe to assume that the directory portion is satisified when</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  // respect, it is safe to assume that the directory portion is satisfied when</span>
<a href="#l10.14"></a><span id="l10.14">   // making this call.</span>
<a href="#l10.15"></a><span id="l10.15">   // However, if we make the wrong assumption, one of two things will happen.</span>
<a href="#l10.16"></a><span id="l10.16">   // If the other directory is a local address book, we could return a spurious</span>
<a href="#l10.17"></a><span id="l10.17">   // true result. If not, then DbRowID should be unset and we can definitively</span>
<a href="#l10.18"></a><span id="l10.18">   // return false.</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20">   PRUint32 row;</span>
<a href="#l10.21"></a><span id="l10.21">   nsresult rv = card-&gt;GetPropertyAsUint32(&quot;DbRowID&quot;, &amp;row);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbManager.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -166,17 +166,17 @@ NS_IMPL_QUERY_INTERFACE2(nsAbManager,</span>
<a href="#l11.4"></a><span id="l11.4"> // nsIAbManager</span>
<a href="#l11.5"></a><span id="l11.5"> //</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7"> NS_IMETHODIMP nsAbManager::GetDirectories(nsISimpleEnumerator **aResult)</span>
<a href="#l11.8"></a><span id="l11.8"> {</span>
<a href="#l11.9"></a><span id="l11.9">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11">   // We cache the top level AB to ensure that nsIAbDirectory items are not</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  // created and dumped every time GetDirectores is called. This was causing</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  // created and dumped every time GetDirectories is called. This was causing</span>
<a href="#l11.14"></a><span id="l11.14">   // performance problems, especially with the content policy on messages</span>
<a href="#l11.15"></a><span id="l11.15">   // with lots of urls.</span>
<a href="#l11.16"></a><span id="l11.16">   if (!mCacheTopLevelAb)</span>
<a href="#l11.17"></a><span id="l11.17">   {</span>
<a href="#l11.18"></a><span id="l11.18">     nsresult rv;</span>
<a href="#l11.19"></a><span id="l11.19">     nsCOMPtr&lt;nsIRDFService&gt; rdfService(do_GetService(NS_RDF_CONTRACTID &quot;/rdf-service;1&quot;, &amp;rv));</span>
<a href="#l11.20"></a><span id="l11.20">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22" class="difflineat">@@ -498,40 +498,40 @@ NS_IMETHODIMP nsAbManager::ExportAddress</span>
<a href="#l11.23"></a><span id="l11.23">   {</span>
<a href="#l11.24"></a><span id="l11.24">     default:</span>
<a href="#l11.25"></a><span id="l11.25">     case LDIF_EXPORT_TYPE: // ldif</span>
<a href="#l11.26"></a><span id="l11.26">       // If filename does not have the correct ext, add one.</span>
<a href="#l11.27"></a><span id="l11.27">       if ((fileName.Find(LDIF_FILE_EXTENSION, fileName.Length() - strlen(LDIF_FILE_EXTENSION), PR_TRUE) == -1) &amp;&amp; </span>
<a href="#l11.28"></a><span id="l11.28">           (fileName.Find(LDIF_FILE_EXTENSION2, fileName.Length() - strlen(LDIF_FILE_EXTENSION2), PR_TRUE) == -1)) {</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-       // Add the extenstion and build a new localFile.</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+       // Add the extension and build a new localFile.</span>
<a href="#l11.33"></a><span id="l11.33">        fileName.AppendLiteral(LDIF_FILE_EXTENSION2);</span>
<a href="#l11.34"></a><span id="l11.34">        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l11.35"></a><span id="l11.35">     }</span>
<a href="#l11.36"></a><span id="l11.36">       rv = ExportDirectoryToLDIF(aDirectory, localFile);</span>
<a href="#l11.37"></a><span id="l11.37">       break;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39">     case CSV_EXPORT_TYPE: // csv</span>
<a href="#l11.40"></a><span id="l11.40">       // If filename does not have the correct ext, add one.</span>
<a href="#l11.41"></a><span id="l11.41">       if (fileName.Find(CSV_FILE_EXTENSION, fileName.Length() - strlen(CSV_FILE_EXTENSION), PR_TRUE) == -1) {</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-       // Add the extenstion and build a new localFile.</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+       // Add the extension and build a new localFile.</span>
<a href="#l11.45"></a><span id="l11.45">        fileName.AppendLiteral(CSV_FILE_EXTENSION);</span>
<a href="#l11.46"></a><span id="l11.46">        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l11.47"></a><span id="l11.47">     }</span>
<a href="#l11.48"></a><span id="l11.48">       rv = ExportDirectoryToDelimitedText(aDirectory, CSV_DELIM, CSV_DELIM_LEN, localFile);</span>
<a href="#l11.49"></a><span id="l11.49">       break;</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">     case TAB_EXPORT_TYPE: // tab &amp; text</span>
<a href="#l11.52"></a><span id="l11.52">       // If filename does not have the correct ext, add one.</span>
<a href="#l11.53"></a><span id="l11.53">       if ((fileName.Find(TXT_FILE_EXTENSION, fileName.Length() - strlen(TXT_FILE_EXTENSION), PR_TRUE) == -1) &amp;&amp; </span>
<a href="#l11.54"></a><span id="l11.54">           (fileName.Find(TAB_FILE_EXTENSION, fileName.Length() - strlen(TAB_FILE_EXTENSION), PR_TRUE) == -1)) {</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-       // Add the extenstion and build a new localFile.</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+       // Add the extension and build a new localFile.</span>
<a href="#l11.58"></a><span id="l11.58">        fileName.AppendLiteral(TXT_FILE_EXTENSION);</span>
<a href="#l11.59"></a><span id="l11.59">        localFile-&gt;SetLeafName(fileName);</span>
<a href="#l11.60"></a><span id="l11.60">   }</span>
<a href="#l11.61"></a><span id="l11.61">       rv = ExportDirectoryToDelimitedText(aDirectory, TAB_DELIM, TAB_DELIM_LEN, localFile);</span>
<a href="#l11.62"></a><span id="l11.62">       break;</span>
<a href="#l11.63"></a><span id="l11.63">   };</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65">   return rv;</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineat">@@ -828,17 +828,17 @@ nsAbManager::ExportDirectoryToLDIF(nsIAb</span>
<a href="#l11.67"></a><span id="l11.67">                 NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.68"></a><span id="l11.68">                 if (length != writeCount)</span>
<a href="#l11.69"></a><span id="l11.69">                   return NS_ERROR_FAILURE;</span>
<a href="#l11.70"></a><span id="l11.70">               }</span>
<a href="#l11.71"></a><span id="l11.71">               valueCStr.Truncate();</span>
<a href="#l11.72"></a><span id="l11.72">             }</span>
<a href="#l11.73"></a><span id="l11.73">             else {</span>
<a href="#l11.74"></a><span id="l11.74">               // something we don't support yet</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-              // ldif doesn't export mutliple addresses</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+              // ldif doesn't export multiple addresses</span>
<a href="#l11.77"></a><span id="l11.77">             }</span>
<a href="#l11.78"></a><span id="l11.78">           }</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80">           // write out the linebreak that separates the cards</span>
<a href="#l11.81"></a><span id="l11.81">           rv = outputStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;writeCount);</span>
<a href="#l11.82"></a><span id="l11.82">           NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.83"></a><span id="l11.83">           if (MSG_LINEBREAK_LEN != writeCount)</span>
<a href="#l11.84"></a><span id="l11.84">             return NS_ERROR_FAILURE;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOSXDirectory.h</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -125,13 +125,13 @@ private:</span>
<a href="#l12.4"></a><span id="l12.4">   // - nsIAbDirectory items that are mailing lists, must keep a list of</span>
<a href="#l12.5"></a><span id="l12.5">   //   nsIAbCards in m_AddressList, however</span>
<a href="#l12.6"></a><span id="l12.6">   // - nsIAbDirectory items that are address books, must keep a list of</span>
<a href="#l12.7"></a><span id="l12.7">   //   nsIAbDirectory (i.e. mailing lists) in m_AddressList, AND no nsIAbCards.</span>
<a href="#l12.8"></a><span id="l12.8">   //</span>
<a href="#l12.9"></a><span id="l12.9">   // This wasn't too bad for mork, as that just gets a list from its database,</span>
<a href="#l12.10"></a><span id="l12.10">   // but because we store our own copy of the list, we must store a separate</span>
<a href="#l12.11"></a><span id="l12.11">   // list of nsIAbCards here. nsIMutableArray is used, because then it is</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  // interchangable with m_AddressList.</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  // interchangeable with m_AddressList.</span>
<a href="#l12.14"></a><span id="l12.14">   nsCOMPtr&lt;nsIMutableArray&gt; mCardList;</span>
<a href="#l12.15"></a><span id="l12.15"> };</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> #endif // nsAbOSXDirectory_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbOutlookCard.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbOutlookCard.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -115,9 +115,9 @@ public:</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> protected:</span>
<a href="#l13.6"></a><span id="l13.6">     nsMapiEntry *mMapiData ;</span>
<a href="#l13.7"></a><span id="l13.7">     PRUint32 mAbWinType ;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> private:</span>
<a href="#l13.10"></a><span id="l13.10"> };</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#endif // nsAbOultlookCard_h___</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+#endif // nsAbOutlookCard_h___</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbView.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -62,17 +62,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> </span>
<a href="#l14.5"></a><span id="l14.5"> #define CARD_NOT_FOUND -1</span>
<a href="#l14.6"></a><span id="l14.6"> #define ALL_ROWS -1</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> #define PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST &quot;mail.addr_book.lastnamefirst&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION &quot;mail.addr_book.displayName.autoGeneration&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #define PREF_MAIL_ADDR_BOOK_DISPLAYNAME_LASTNAMEFIRST &quot;mail.addr_book.displayName.lastnamefirst&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-// also, our default primary sort</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+// Also, our default primary sort</span>
<a href="#l14.14"></a><span id="l14.14"> #define GENERATED_NAME_COLUMN_ID &quot;GeneratedName&quot; </span>
<a href="#l14.15"></a><span id="l14.15"> </span>
<a href="#l14.16"></a><span id="l14.16"> NS_IMPL_ISUPPORTS4(nsAbView, nsIAbView, nsITreeView, nsIAbListener, nsIObserver)</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18"> nsAbView::nsAbView() : mInitialized(PR_FALSE),</span>
<a href="#l14.19"></a><span id="l14.19">                        mSuppressSelectionChange(PR_FALSE),</span>
<a href="#l14.20"></a><span id="l14.20">                        mSuppressCountChange(PR_FALSE),</span>
<a href="#l14.21"></a><span id="l14.21">                        mGeneratedNameFormat(0)</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -129,17 +129,17 @@ nsresult nsAbView::RemoveCardAt(PRInt32 </span>
<a href="#l14.23"></a><span id="l14.23">   AbCard *abcard = (AbCard*) (mCards.ElementAt(row));</span>
<a href="#l14.24"></a><span id="l14.24">   NS_IF_RELEASE(abcard-&gt;card);</span>
<a href="#l14.25"></a><span id="l14.25">   mCards.RemoveElementAt(row);</span>
<a href="#l14.26"></a><span id="l14.26">   PR_FREEIF(abcard-&gt;primaryCollationKey);</span>
<a href="#l14.27"></a><span id="l14.27">   PR_FREEIF(abcard-&gt;secondaryCollationKey);</span>
<a href="#l14.28"></a><span id="l14.28">   PR_FREEIF(abcard);</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30">   </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  // this needs to happen after we remove the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  // This needs to happen after we remove the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l14.33"></a><span id="l14.33">   if (mTree) {</span>
<a href="#l14.34"></a><span id="l14.34">     rv = mTree-&gt;RowCountChanged(row, -1);</span>
<a href="#l14.35"></a><span id="l14.35">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.36"></a><span id="l14.36">   }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">   if (mAbViewListener &amp;&amp; !mSuppressCountChange) {</span>
<a href="#l14.39"></a><span id="l14.39">     rv = mAbViewListener-&gt;OnCountChanged(mCards.Count());</span>
<a href="#l14.40"></a><span id="l14.40">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineat">@@ -196,47 +196,47 @@ NS_IMETHODIMP nsAbView::SetView(nsIAbDir</span>
<a href="#l14.42"></a><span id="l14.42">                                 nsAString &amp;aResult)</span>
<a href="#l14.43"></a><span id="l14.43"> {</span>
<a href="#l14.44"></a><span id="l14.44">   // Ensure we are initialized</span>
<a href="#l14.45"></a><span id="l14.45">   nsresult rv = Initialize();</span>
<a href="#l14.46"></a><span id="l14.46"> </span>
<a href="#l14.47"></a><span id="l14.47">   mAbViewListener = nsnull;</span>
<a href="#l14.48"></a><span id="l14.48">   if (mTree)</span>
<a href="#l14.49"></a><span id="l14.49">   {</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-    // try and speed deletion of old cards by disconnecting the tree from us</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+    // Try and speed deletion of old cards by disconnecting the tree from us.</span>
<a href="#l14.52"></a><span id="l14.52">     mTreeSelection-&gt;ClearSelection();</span>
<a href="#l14.53"></a><span id="l14.53">     mTree-&gt;SetView(nsnull);</span>
<a href="#l14.54"></a><span id="l14.54">   }</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-  // clear out old cards</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  // Clear out old cards</span>
<a href="#l14.58"></a><span id="l14.58">   PRInt32 i = mCards.Count();</span>
<a href="#l14.59"></a><span id="l14.59">   while(i-- &gt; 0)</span>
<a href="#l14.60"></a><span id="l14.60">   {</span>
<a href="#l14.61"></a><span id="l14.61">     rv = RemoveCardAt(i);</span>
<a href="#l14.62"></a><span id="l14.62">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed\n&quot;);</span>
<a href="#l14.63"></a><span id="l14.63">   }</span>
<a href="#l14.64"></a><span id="l14.64"> </span>
<a href="#l14.65"></a><span id="l14.65">   mDirectory = aAddressBook;</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67">   rv = EnumerateCards();</span>
<a href="#l14.68"></a><span id="l14.68">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.69"></a><span id="l14.69"> </span>
<a href="#l14.70"></a><span id="l14.70">   NS_NAMED_LITERAL_STRING(generatedNameColumnId, GENERATED_NAME_COLUMN_ID);</span>
<a href="#l14.71"></a><span id="l14.71"> </span>
<a href="#l14.72"></a><span id="l14.72" class="difflineminus">-  // see if the persisted sortColumn is valid.</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineminus">-  // it may not be, if you migrated from older versions, or switched between</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  // See if the persisted sortColumn is valid.</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  // It may not be, if you migrated from older versions, or switched between</span>
<a href="#l14.76"></a><span id="l14.76">   // a mozilla build and a commercial build, which have different columns.</span>
<a href="#l14.77"></a><span id="l14.77">   nsAutoString actualSortColumn;</span>
<a href="#l14.78"></a><span id="l14.78">   if (!generatedNameColumnId.Equals(aSortColumn) &amp;&amp; mCards.Count()) {</span>
<a href="#l14.79"></a><span id="l14.79">     nsIAbCard *card = ((AbCard *)(mCards.ElementAt(0)))-&gt;card;</span>
<a href="#l14.80"></a><span id="l14.80">     nsString value;</span>
<a href="#l14.81"></a><span id="l14.81">     // XXX todo</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-    // need to check if _Generic is valid.  GetCardValue() will always return NS_OK for _Generic</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-    // we're going to have to ask mDirectory if it is.</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineminus">-    // it might not be.  example:  _ScreenName is valid in Netscape, but not Mozilla.</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+    // Need to check if _Generic is valid.  GetCardValue() will always return NS_OK for _Generic</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+    // We're going to have to ask mDirectory if it is.</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+    // It might not be.  example:  _ScreenName is valid in Netscape, but not Mozilla.</span>
<a href="#l14.88"></a><span id="l14.88">     rv = GetCardValue(card, PromiseFlatString(aSortColumn).get(), value);</span>
<a href="#l14.89"></a><span id="l14.89">     if (NS_FAILED(rv))</span>
<a href="#l14.90"></a><span id="l14.90">       actualSortColumn = generatedNameColumnId;</span>
<a href="#l14.91"></a><span id="l14.91">     else</span>
<a href="#l14.92"></a><span id="l14.92">       actualSortColumn = aSortColumn;</span>
<a href="#l14.93"></a><span id="l14.93">   }</span>
<a href="#l14.94"></a><span id="l14.94">   else</span>
<a href="#l14.95"></a><span id="l14.95">     actualSortColumn = aSortColumn;</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineat">@@ -276,30 +276,30 @@ nsresult nsAbView::EnumerateCards()</span>
<a href="#l14.97"></a><span id="l14.97">     nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l14.98"></a><span id="l14.98">     PRBool more;</span>
<a href="#l14.99"></a><span id="l14.99">     while (NS_SUCCEEDED(cardsEnumerator-&gt;HasMoreElements(&amp;more)) &amp;&amp; more)</span>
<a href="#l14.100"></a><span id="l14.100">     {</span>
<a href="#l14.101"></a><span id="l14.101">       rv = cardsEnumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l14.102"></a><span id="l14.102">       if (NS_SUCCEEDED(rv))</span>
<a href="#l14.103"></a><span id="l14.103">       {</span>
<a href="#l14.104"></a><span id="l14.104">         nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineminus">-        // malloc these from an arena</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+        // Malloc these from an arena</span>
<a href="#l14.107"></a><span id="l14.107">         AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l14.108"></a><span id="l14.108">         if (!abcard) </span>
<a href="#l14.109"></a><span id="l14.109">           return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.110"></a><span id="l14.110"> </span>
<a href="#l14.111"></a><span id="l14.111">         abcard-&gt;card = card;</span>
<a href="#l14.112"></a><span id="l14.112">         NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l14.113"></a><span id="l14.113"> </span>
<a href="#l14.114"></a><span id="l14.114">         // XXX todo</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineminus">-        // would it be better to do an insertion sort, than append and sort?</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+        // Would it be better to do an insertion sort, than append and sort?</span>
<a href="#l14.117"></a><span id="l14.117">         // XXX todo</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-        // if we knew how many cards there was going to be</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-        // we could allocate an array of the size, </span>
<a href="#l14.120"></a><span id="l14.120" class="difflineminus">-        // instead of growing and copying as we append</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+        // If we knew how many cards there was going to be</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+        // we could allocate an array of the size,</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+        // instead of growing and copying as we append.</span>
<a href="#l14.124"></a><span id="l14.124">         rv = mCards.AppendElement((void *)abcard);</span>
<a href="#l14.125"></a><span id="l14.125">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to append card&quot;);</span>
<a href="#l14.126"></a><span id="l14.126">       }</span>
<a href="#l14.127"></a><span id="l14.127">     }</span>
<a href="#l14.128"></a><span id="l14.128">   }</span>
<a href="#l14.129"></a><span id="l14.129"> </span>
<a href="#l14.130"></a><span id="l14.130">   return NS_OK;</span>
<a href="#l14.131"></a><span id="l14.131"> }</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineat">@@ -432,46 +432,46 @@ nsresult nsAbView::GetCardValue(nsIAbCar</span>
<a href="#l14.133"></a><span id="l14.133">                                 nsAString &amp;_retval)</span>
<a href="#l14.134"></a><span id="l14.134"> {</span>
<a href="#l14.135"></a><span id="l14.135">   // &quot;G&quot; == &quot;GeneratedName&quot;, &quot;_P&quot; == &quot;_PhoneticName&quot;</span>
<a href="#l14.136"></a><span id="l14.136">   // else, standard column (like PrimaryEmail and _AimScreenName)</span>
<a href="#l14.137"></a><span id="l14.137">   if (colID[0] == PRUnichar('G'))</span>
<a href="#l14.138"></a><span id="l14.138">     return card-&gt;GenerateName(mGeneratedNameFormat, mABBundle, _retval);</span>
<a href="#l14.139"></a><span id="l14.139"> </span>
<a href="#l14.140"></a><span id="l14.140">   if (colID[0] == PRUnichar('_') &amp;&amp; colID[1] == PRUnichar('P'))</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineminus">-    // use LN/FN order for the phonetic name</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    // Use LN/FN order for the phonetic name</span>
<a href="#l14.143"></a><span id="l14.143">     return card-&gt;GeneratePhoneticName(PR_TRUE, _retval);</span>
<a href="#l14.144"></a><span id="l14.144"> </span>
<a href="#l14.145"></a><span id="l14.145">   nsresult rv = card-&gt;GetPropertyAsAString(NS_ConvertUTF16toUTF8(colID).get(), _retval);</span>
<a href="#l14.146"></a><span id="l14.146">   if (rv == NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l14.147"></a><span id="l14.147">     rv = NS_OK;</span>
<a href="#l14.148"></a><span id="l14.148">     _retval.Truncate();</span>
<a href="#l14.149"></a><span id="l14.149">   }</span>
<a href="#l14.150"></a><span id="l14.150">   return rv;</span>
<a href="#l14.151"></a><span id="l14.151"> }</span>
<a href="#l14.152"></a><span id="l14.152"> </span>
<a href="#l14.153"></a><span id="l14.153"> nsresult nsAbView::RefreshTree()</span>
<a href="#l14.154"></a><span id="l14.154"> {</span>
<a href="#l14.155"></a><span id="l14.155">   nsresult rv;</span>
<a href="#l14.156"></a><span id="l14.156"> </span>
<a href="#l14.157"></a><span id="l14.157" class="difflineminus">-  // the PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName column looks.</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+  // The PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST pref affects how the GeneratedName column looks.</span>
<a href="#l14.159"></a><span id="l14.159">   // so if the GeneratedName is our primary or secondary sort,</span>
<a href="#l14.160"></a><span id="l14.160">   // we need to resort.</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineminus">-  // the same applies for kPhoneticNameColumn </span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+  // the same applies for kPhoneticNameColumn</span>
<a href="#l14.163"></a><span id="l14.163">   //</span>
<a href="#l14.164"></a><span id="l14.164">   // XXX optimize me</span>
<a href="#l14.165"></a><span id="l14.165">   // PrimaryEmail is always the secondary sort, unless it is currently the</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineminus">-  // primary sort.  So, if PrimaryEmail is the primary sort, </span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+  // primary sort.  So, if PrimaryEmail is the primary sort,</span>
<a href="#l14.168"></a><span id="l14.168">   // GeneratedName might be the secondary sort.</span>
<a href="#l14.169"></a><span id="l14.169">   //</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineminus">-  // one day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineminus">-  // we do that, we can fix this code.  at best, it will turn a sort into a invalidate.</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+  // One day, we can get fancy and remember what the secondary sort is.</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+  // We do that, we can fix this code. At best, it will turn a sort into a invalidate.</span>
<a href="#l14.174"></a><span id="l14.174">   // </span>
<a href="#l14.175"></a><span id="l14.175" class="difflineminus">-  // if neither the primary nor the secondary sorts are GeneratedName (or kPhoneticNameColumn), </span>
<a href="#l14.176"></a><span id="l14.176" class="difflineminus">-  // all we have to do is invalidate (to show the new GeneratedNames), </span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+  // If neither the primary nor the secondary sorts are GeneratedName (or kPhoneticNameColumn),</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+  // all we have to do is invalidate (to show the new GeneratedNames),</span>
<a href="#l14.179"></a><span id="l14.179">   // but the sort will not change.</span>
<a href="#l14.180"></a><span id="l14.180">   if (mSortColumn.EqualsLiteral(GENERATED_NAME_COLUMN_ID) ||</span>
<a href="#l14.181"></a><span id="l14.181">       mSortColumn.EqualsLiteral(kPriEmailProperty) ||</span>
<a href="#l14.182"></a><span id="l14.182">       mSortColumn.EqualsLiteral(kPhoneticNameColumn)) {</span>
<a href="#l14.183"></a><span id="l14.183">     rv = SortBy(mSortColumn.get(), mSortDirection.get());</span>
<a href="#l14.184"></a><span id="l14.184">   }</span>
<a href="#l14.185"></a><span id="l14.185">   else {</span>
<a href="#l14.186"></a><span id="l14.186">     rv = InvalidateTree(ALL_ROWS);</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineat">@@ -603,18 +603,18 @@ inplaceSortCallback(const void *data1, c</span>
<a href="#l14.188"></a><span id="l14.188"> {</span>
<a href="#l14.189"></a><span id="l14.189">   AbCard *card1 = (AbCard *)data1;</span>
<a href="#l14.190"></a><span id="l14.190">   AbCard *card2 = (AbCard *)data2;</span>
<a href="#l14.191"></a><span id="l14.191">   </span>
<a href="#l14.192"></a><span id="l14.192">   SortClosure *closure = (SortClosure *) privateData;</span>
<a href="#l14.193"></a><span id="l14.193">   </span>
<a href="#l14.194"></a><span id="l14.194">   PRInt32 sortValue;</span>
<a href="#l14.195"></a><span id="l14.195">   </span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-  // if we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the secondary is always the </span>
<a href="#l14.197"></a><span id="l14.197" class="difflineminus">-  // PrimaryEmail.  use the last primary key as the secondary key.</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+  // If we are sorting the &quot;PrimaryEmail&quot;, swap the collation keys, as the secondary is always the</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  // PrimaryEmail. Use the last primary key as the secondary key.</span>
<a href="#l14.200"></a><span id="l14.200">   //</span>
<a href="#l14.201"></a><span id="l14.201">   // &quot;Pr&quot; to distinguish &quot;PrimaryEmail&quot; from &quot;PagerNumber&quot;</span>
<a href="#l14.202"></a><span id="l14.202">   if (closure-&gt;colID[0] == PRUnichar('P') &amp;&amp; closure-&gt;colID[1] == PRUnichar('r')) {</span>
<a href="#l14.203"></a><span id="l14.203">     sortValue = closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;secondaryCollationKey,card1-&gt;secondaryCollationKeyLen,card2-&gt;secondaryCollationKey,card2-&gt;secondaryCollationKeyLen);</span>
<a href="#l14.204"></a><span id="l14.204">     if (sortValue)</span>
<a href="#l14.205"></a><span id="l14.205">       return sortValue * closure-&gt;factor;</span>
<a href="#l14.206"></a><span id="l14.206">     else</span>
<a href="#l14.207"></a><span id="l14.207">       return closure-&gt;abView-&gt;CompareCollationKeys(card1-&gt;primaryCollationKey,card1-&gt;primaryCollationKeyLen,card2-&gt;primaryCollationKey,card2-&gt;primaryCollationKeyLen) * (closure-&gt;factor);</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineat">@@ -649,40 +649,40 @@ NS_IMETHODIMP nsAbView::SortBy(const PRU</span>
<a href="#l14.209"></a><span id="l14.209"> </span>
<a href="#l14.210"></a><span id="l14.210">   nsAutoString sortColumn;</span>
<a href="#l14.211"></a><span id="l14.211">   if (!colID) </span>
<a href="#l14.212"></a><span id="l14.212">     sortColumn = NS_LITERAL_STRING(GENERATED_NAME_COLUMN_ID).get();  // default sort</span>
<a href="#l14.213"></a><span id="l14.213">   else</span>
<a href="#l14.214"></a><span id="l14.214">     sortColumn = colID;</span>
<a href="#l14.215"></a><span id="l14.215"> </span>
<a href="#l14.216"></a><span id="l14.216">   PRInt32 i;</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineminus">-  // this function does not optimize for the case when sortColumn and sortDirection</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+  // This function does not optimize for the case when sortColumn and sortDirection</span>
<a href="#l14.219"></a><span id="l14.219">   // are identical since the last call, the caller is responsible optimizing</span>
<a href="#l14.220"></a><span id="l14.220">   // for that case</span>
<a href="#l14.221"></a><span id="l14.221"> </span>
<a href="#l14.222"></a><span id="l14.222" class="difflineminus">-  // if we are sorting by how we are already sorted, </span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+  // If we are sorting by how we are already sorted,</span>
<a href="#l14.224"></a><span id="l14.224">   // and just the sort direction changes, just reverse</span>
<a href="#l14.225"></a><span id="l14.225">   //</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineminus">-  // note, we'll call SortBy() with the existing sort column and the</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+  // Note, we'll call SortBy() with the existing sort column and the</span>
<a href="#l14.228"></a><span id="l14.228">   // existing sort direction, and that needs to do a complete resort.</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineminus">-  // for example, we do that when the PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST changes</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  // For example, we do that when the PREF_MAIL_ADDR_BOOK_LASTNAMEFIRST changes</span>
<a href="#l14.231"></a><span id="l14.231">   if (!NS_strcmp(mSortColumn.get(),sortColumn.get()) &amp;&amp; NS_strcmp(mSortDirection.get(), sortDir)) {</span>
<a href="#l14.232"></a><span id="l14.232">     PRInt32 halfPoint = count / 2;</span>
<a href="#l14.233"></a><span id="l14.233">     for (i=0; i &lt; halfPoint; i++) {</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineminus">-      // swap the elements.</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+      // Swap the elements.</span>
<a href="#l14.236"></a><span id="l14.236">       void *ptr1 = mCards.ElementAt(i);</span>
<a href="#l14.237"></a><span id="l14.237">       void *ptr2 = mCards.ElementAt(count - i - 1);</span>
<a href="#l14.238"></a><span id="l14.238">       mCards.ReplaceElementAt(ptr2, i);</span>
<a href="#l14.239"></a><span id="l14.239">       mCards.ReplaceElementAt(ptr1, count - i - 1);</span>
<a href="#l14.240"></a><span id="l14.240">     }</span>
<a href="#l14.241"></a><span id="l14.241"> </span>
<a href="#l14.242"></a><span id="l14.242">     mSortDirection = sortDir;</span>
<a href="#l14.243"></a><span id="l14.243">   }</span>
<a href="#l14.244"></a><span id="l14.244">   else {</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineminus">-    // generate collation keys</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+    // Generate collation keys</span>
<a href="#l14.247"></a><span id="l14.247">     for (i=0; i &lt; count; i++) {</span>
<a href="#l14.248"></a><span id="l14.248">       AbCard *abcard = (AbCard *)(mCards.ElementAt(i));</span>
<a href="#l14.249"></a><span id="l14.249"> </span>
<a href="#l14.250"></a><span id="l14.250">       rv = GenerateCollationKeysForCard(sortColumn.get(), abcard);</span>
<a href="#l14.251"></a><span id="l14.251">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.252"></a><span id="l14.252">     }</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254">     nsAutoString sortDirection;</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineat">@@ -787,17 +787,17 @@ NS_IMETHODIMP nsAbView::OnItemAdded(nsIS</span>
<a href="#l14.256"></a><span id="l14.256"> {</span>
<a href="#l14.257"></a><span id="l14.257">   nsresult rv;</span>
<a href="#l14.258"></a><span id="l14.258">   nsCOMPtr &lt;nsIAbDirectory&gt; directory = do_QueryInterface(parentDir,&amp;rv);</span>
<a href="#l14.259"></a><span id="l14.259">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.260"></a><span id="l14.260"> </span>
<a href="#l14.261"></a><span id="l14.261">   if (directory.get() == mDirectory.get()) {</span>
<a href="#l14.262"></a><span id="l14.262">     nsCOMPtr &lt;nsIAbCard&gt; addedCard = do_QueryInterface(item);</span>
<a href="#l14.263"></a><span id="l14.263">     if (addedCard) {</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineminus">-      // malloc these from an arena</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+      // Malloc these from an arena</span>
<a href="#l14.266"></a><span id="l14.266">       AbCard *abcard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l14.267"></a><span id="l14.267">       if (!abcard) </span>
<a href="#l14.268"></a><span id="l14.268">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.269"></a><span id="l14.269"> </span>
<a href="#l14.270"></a><span id="l14.270">       abcard-&gt;card = addedCard;</span>
<a href="#l14.271"></a><span id="l14.271">       NS_IF_ADDREF(abcard-&gt;card);</span>
<a href="#l14.272"></a><span id="l14.272">     </span>
<a href="#l14.273"></a><span id="l14.273">       rv = GenerateCollationKeysForCard(mSortColumn.get(), abcard);</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineat">@@ -829,17 +829,17 @@ nsresult nsAbView::AddCard(AbCard *abcar</span>
<a href="#l14.275"></a><span id="l14.275"> {</span>
<a href="#l14.276"></a><span id="l14.276">   nsresult rv = NS_OK;</span>
<a href="#l14.277"></a><span id="l14.277">   NS_ENSURE_ARG_POINTER(abcard);</span>
<a href="#l14.278"></a><span id="l14.278">   </span>
<a href="#l14.279"></a><span id="l14.279">   *index = FindIndexForInsert(abcard);</span>
<a href="#l14.280"></a><span id="l14.280">   rv = mCards.InsertElementAt((void *)abcard, *index);</span>
<a href="#l14.281"></a><span id="l14.281">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.282"></a><span id="l14.282">     </span>
<a href="#l14.283"></a><span id="l14.283" class="difflineminus">-  // this needs to happen after we insert the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+  // This needs to happen after we insert the card, as RowCountChanged() will call GetRowCount()</span>
<a href="#l14.285"></a><span id="l14.285">   if (mTree)</span>
<a href="#l14.286"></a><span id="l14.286">     rv = mTree-&gt;RowCountChanged(*index, 1);</span>
<a href="#l14.287"></a><span id="l14.287"> </span>
<a href="#l14.288"></a><span id="l14.288">   if (selectCardAfterAdding &amp;&amp; mTreeSelection) {</span>
<a href="#l14.289"></a><span id="l14.289">     mTreeSelection-&gt;SetCurrentIndex(*index);</span>
<a href="#l14.290"></a><span id="l14.290">     mTreeSelection-&gt;RangedSelect(*index, *index, PR_FALSE /* augment */);</span>
<a href="#l14.291"></a><span id="l14.291">   }</span>
<a href="#l14.292"></a><span id="l14.292"> </span>
<a href="#l14.293"></a><span id="l14.293" class="difflineat">@@ -857,21 +857,21 @@ PRInt32 nsAbView::FindIndexForInsert(AbC</span>
<a href="#l14.294"></a><span id="l14.294">   PRInt32 i;</span>
<a href="#l14.295"></a><span id="l14.295"> </span>
<a href="#l14.296"></a><span id="l14.296">   void *item = (void *)abcard;</span>
<a href="#l14.297"></a><span id="l14.297">   </span>
<a href="#l14.298"></a><span id="l14.298">   SortClosure closure;</span>
<a href="#l14.299"></a><span id="l14.299">   SetSortClosure(mSortColumn.get(), mSortDirection.get(), this, &amp;closure);</span>
<a href="#l14.300"></a><span id="l14.300">   </span>
<a href="#l14.301"></a><span id="l14.301">   // XXX todo</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineminus">-  // make this a binary search</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+  // Make this a binary search</span>
<a href="#l14.304"></a><span id="l14.304">   for (i=0; i &lt; count; i++) {</span>
<a href="#l14.305"></a><span id="l14.305">     void *current = mCards.ElementAt(i);</span>
<a href="#l14.306"></a><span id="l14.306">     PRInt32 value = inplaceSortCallback(item, current, (void *)(&amp;closure));</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineminus">-    // XXX fix me, this is not right for both ascending and descending</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+    // XXX Fix me, this is not right for both ascending and descending</span>
<a href="#l14.309"></a><span id="l14.309">     if (value &lt;= 0) </span>
<a href="#l14.310"></a><span id="l14.310">       break;</span>
<a href="#l14.311"></a><span id="l14.311">   }</span>
<a href="#l14.312"></a><span id="l14.312">   return i;</span>
<a href="#l14.313"></a><span id="l14.313"> }</span>
<a href="#l14.314"></a><span id="l14.314"> </span>
<a href="#l14.315"></a><span id="l14.315"> NS_IMETHODIMP nsAbView::OnItemRemoved(nsISupports *parentDir, nsISupports *item)</span>
<a href="#l14.316"></a><span id="l14.316"> {</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineat">@@ -893,29 +893,29 @@ nsresult nsAbView::RemoveCardAndSelectNe</span>
<a href="#l14.318"></a><span id="l14.318">   nsCOMPtr &lt;nsIAbCard&gt; card = do_QueryInterface(item);</span>
<a href="#l14.319"></a><span id="l14.319">   if (card) {</span>
<a href="#l14.320"></a><span id="l14.320">     PRInt32 index = FindIndexForCard(card);</span>
<a href="#l14.321"></a><span id="l14.321">     if (index != CARD_NOT_FOUND) {</span>
<a href="#l14.322"></a><span id="l14.322">       PRBool selectNextCard = PR_FALSE;</span>
<a href="#l14.323"></a><span id="l14.323">       if (mTreeSelection) {</span>
<a href="#l14.324"></a><span id="l14.324">         PRInt32 selectedIndex;</span>
<a href="#l14.325"></a><span id="l14.325">         // XXX todo</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineminus">-        // make sure it works if nothing selected</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+        // Make sure it works if nothing selected</span>
<a href="#l14.328"></a><span id="l14.328">         mTreeSelection-&gt;GetCurrentIndex(&amp;selectedIndex);</span>
<a href="#l14.329"></a><span id="l14.329">         if (index == selectedIndex)</span>
<a href="#l14.330"></a><span id="l14.330">           selectNextCard = PR_TRUE;</span>
<a href="#l14.331"></a><span id="l14.331">       }</span>
<a href="#l14.332"></a><span id="l14.332"> </span>
<a href="#l14.333"></a><span id="l14.333">       rv = RemoveCardAt(index);</span>
<a href="#l14.334"></a><span id="l14.334">       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.335"></a><span id="l14.335"> </span>
<a href="#l14.336"></a><span id="l14.336">       if (selectNextCard) {</span>
<a href="#l14.337"></a><span id="l14.337">       PRInt32 count = mCards.Count();</span>
<a href="#l14.338"></a><span id="l14.338">       if (count &amp;&amp; mTreeSelection) {</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineminus">-        // if we deleted the last card, adjust so we select the new &quot;last&quot; card</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+        // If we deleted the last card, adjust so we select the new &quot;last&quot; card</span>
<a href="#l14.341"></a><span id="l14.341">         if (index &gt;= (count - 1)) {</span>
<a href="#l14.342"></a><span id="l14.342">           index = count -1;</span>
<a href="#l14.343"></a><span id="l14.343">         }</span>
<a href="#l14.344"></a><span id="l14.344">         mTreeSelection-&gt;SetCurrentIndex(index);</span>
<a href="#l14.345"></a><span id="l14.345">         mTreeSelection-&gt;RangedSelect(index, index, PR_FALSE /* augment */);</span>
<a href="#l14.346"></a><span id="l14.346">       }</span>
<a href="#l14.347"></a><span id="l14.347">     }</span>
<a href="#l14.348"></a><span id="l14.348">   }</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineat">@@ -923,17 +923,17 @@ nsresult nsAbView::RemoveCardAndSelectNe</span>
<a href="#l14.350"></a><span id="l14.350">   return rv;</span>
<a href="#l14.351"></a><span id="l14.351"> }</span>
<a href="#l14.352"></a><span id="l14.352"> </span>
<a href="#l14.353"></a><span id="l14.353"> PRInt32 nsAbView::FindIndexForCard(nsIAbCard *card)</span>
<a href="#l14.354"></a><span id="l14.354"> {</span>
<a href="#l14.355"></a><span id="l14.355">   PRInt32 count = mCards.Count();</span>
<a href="#l14.356"></a><span id="l14.356">   PRInt32 i;</span>
<a href="#l14.357"></a><span id="l14.357">  </span>
<a href="#l14.358"></a><span id="l14.358" class="difflineminus">-  // you can't implement the binary search here, as all you have is the nsIAbCard</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+  // You can't implement the binary search here, as all you have is the nsIAbCard</span>
<a href="#l14.360"></a><span id="l14.360">   // you might be here because one of the card properties has changed, and that property</span>
<a href="#l14.361"></a><span id="l14.361">   // could be the collation key.</span>
<a href="#l14.362"></a><span id="l14.362">   for (i=0; i &lt; count; i++) {</span>
<a href="#l14.363"></a><span id="l14.363">     AbCard *abcard = (AbCard*) (mCards.ElementAt(i));</span>
<a href="#l14.364"></a><span id="l14.364">     PRBool equals;</span>
<a href="#l14.365"></a><span id="l14.365">     nsresult rv = card-&gt;Equals(abcard-&gt;card, &amp;equals);</span>
<a href="#l14.366"></a><span id="l14.366">     if (NS_SUCCEEDED(rv) &amp;&amp; equals) {</span>
<a href="#l14.367"></a><span id="l14.367">       return i;</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineat">@@ -951,17 +951,17 @@ NS_IMETHODIMP nsAbView::OnItemPropertyCh</span>
<a href="#l14.369"></a><span id="l14.369">     return NS_OK;</span>
<a href="#l14.370"></a><span id="l14.370"> </span>
<a href="#l14.371"></a><span id="l14.371">   PRInt32 index = FindIndexForCard(card);</span>
<a href="#l14.372"></a><span id="l14.372">   if (index == -1)</span>
<a href="#l14.373"></a><span id="l14.373">     return NS_OK;</span>
<a href="#l14.374"></a><span id="l14.374"> </span>
<a href="#l14.375"></a><span id="l14.375">   AbCard *oldCard = (AbCard*) (mCards.ElementAt(index));</span>
<a href="#l14.376"></a><span id="l14.376"> </span>
<a href="#l14.377"></a><span id="l14.377" class="difflineminus">-  // malloc these from an arena</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+  // Malloc these from an arena</span>
<a href="#l14.379"></a><span id="l14.379">   AbCard *newCard = (AbCard *) PR_Calloc(1, sizeof(struct AbCard));</span>
<a href="#l14.380"></a><span id="l14.380">   if (!newCard)</span>
<a href="#l14.381"></a><span id="l14.381">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l14.382"></a><span id="l14.382"> </span>
<a href="#l14.383"></a><span id="l14.383">   newCard-&gt;card = card;</span>
<a href="#l14.384"></a><span id="l14.384">   NS_IF_ADDREF(newCard-&gt;card);</span>
<a href="#l14.385"></a><span id="l14.385">     </span>
<a href="#l14.386"></a><span id="l14.386">   rv = GenerateCollationKeysForCard(mSortColumn.get(), newCard);</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineat">@@ -971,46 +971,46 @@ NS_IMETHODIMP nsAbView::OnItemPropertyCh</span>
<a href="#l14.388"></a><span id="l14.388"> </span>
<a href="#l14.389"></a><span id="l14.389">   if (mTreeSelection) {</span>
<a href="#l14.390"></a><span id="l14.390">     rv = mTreeSelection-&gt;IsSelected(index, &amp;cardWasSelected);</span>
<a href="#l14.391"></a><span id="l14.391">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.392"></a><span id="l14.392">   }</span>
<a href="#l14.393"></a><span id="l14.393">   </span>
<a href="#l14.394"></a><span id="l14.394">   if (!CompareCollationKeys(newCard-&gt;primaryCollationKey,newCard-&gt;primaryCollationKeyLen,oldCard-&gt;primaryCollationKey,oldCard-&gt;primaryCollationKeyLen)</span>
<a href="#l14.395"></a><span id="l14.395">     &amp;&amp; CompareCollationKeys(newCard-&gt;secondaryCollationKey,newCard-&gt;secondaryCollationKeyLen,oldCard-&gt;secondaryCollationKey,oldCard-&gt;secondaryCollationKeyLen)) {</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineminus">-    // no need to remove and add, since the collation keys haven't change.</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineminus">-    // since they haven't chagned, the card will sort to the same place.</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineminus">-    // we just need to clean up what we allocated.</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+    // No need to remove and add, since the collation keys haven't changed.</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+    // Since they haven't changed, the card will sort to the same place.</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+    // We just need to clean up what we allocated.</span>
<a href="#l14.402"></a><span id="l14.402">     NS_IF_RELEASE(newCard-&gt;card);</span>
<a href="#l14.403"></a><span id="l14.403">     if (newCard-&gt;primaryCollationKey)</span>
<a href="#l14.404"></a><span id="l14.404">       nsMemory::Free(newCard-&gt;primaryCollationKey);</span>
<a href="#l14.405"></a><span id="l14.405">     if (newCard-&gt;secondaryCollationKey)</span>
<a href="#l14.406"></a><span id="l14.406">       nsMemory::Free(newCard-&gt;secondaryCollationKey);</span>
<a href="#l14.407"></a><span id="l14.407">     PR_FREEIF(newCard);</span>
<a href="#l14.408"></a><span id="l14.408"> </span>
<a href="#l14.409"></a><span id="l14.409" class="difflineminus">-    // still need to invalidate, as the other columns may have changed</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+    // Still need to invalidate, as the other columns may have changed.</span>
<a href="#l14.411"></a><span id="l14.411">     rv = InvalidateTree(index);</span>
<a href="#l14.412"></a><span id="l14.412">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l14.413"></a><span id="l14.413">   }</span>
<a href="#l14.414"></a><span id="l14.414">   else {</span>
<a href="#l14.415"></a><span id="l14.415">     mSuppressSelectionChange = PR_TRUE;</span>
<a href="#l14.416"></a><span id="l14.416">     mSuppressCountChange = PR_TRUE;</span>
<a href="#l14.417"></a><span id="l14.417"> </span>
<a href="#l14.418"></a><span id="l14.418" class="difflineminus">-    // remove the old card</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+    // Remove the old card.</span>
<a href="#l14.420"></a><span id="l14.420">     rv = RemoveCardAt(index);</span>
<a href="#l14.421"></a><span id="l14.421">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;remove card failed\n&quot;);</span>
<a href="#l14.422"></a><span id="l14.422"> </span>
<a href="#l14.423"></a><span id="l14.423" class="difflineminus">-    // add the card we created, and select it (to restore selection) if it was selected</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+    // Add the card we created, and select it (to restore selection) if it was selected.</span>
<a href="#l14.425"></a><span id="l14.425">     rv = AddCard(newCard, cardWasSelected /* select card */, &amp;index);</span>
<a href="#l14.426"></a><span id="l14.426">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;add card failed\n&quot;);</span>
<a href="#l14.427"></a><span id="l14.427"> </span>
<a href="#l14.428"></a><span id="l14.428">     mSuppressSelectionChange = PR_FALSE;</span>
<a href="#l14.429"></a><span id="l14.429">     mSuppressCountChange = PR_FALSE;</span>
<a href="#l14.430"></a><span id="l14.430"> </span>
<a href="#l14.431"></a><span id="l14.431" class="difflineminus">-    // ensure restored selection is visible</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+    // Ensure restored selection is visible</span>
<a href="#l14.433"></a><span id="l14.433">     if (cardWasSelected &amp;&amp; mTree) </span>
<a href="#l14.434"></a><span id="l14.434">       mTree-&gt;EnsureRowIsVisible(index);</span>
<a href="#l14.435"></a><span id="l14.435">   }</span>
<a href="#l14.436"></a><span id="l14.436"> </span>
<a href="#l14.437"></a><span id="l14.437">   // Although the selection hasn't changed, the card that is selected may need</span>
<a href="#l14.438"></a><span id="l14.438">   // to be displayed differently, therefore pretend that the selection has</span>
<a href="#l14.439"></a><span id="l14.439">   // changed to force that update.</span>
<a href="#l14.440"></a><span id="l14.440">   if (cardWasSelected)</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineat">@@ -1059,17 +1059,17 @@ nsresult nsAbView::ReselectCards(nsIArra</span>
<a href="#l14.442"></a><span id="l14.442">     if (card) {</span>
<a href="#l14.443"></a><span id="l14.443">       PRInt32 index = FindIndexForCard(card);</span>
<a href="#l14.444"></a><span id="l14.444">       if (index != CARD_NOT_FOUND) {</span>
<a href="#l14.445"></a><span id="l14.445">         mTreeSelection-&gt;RangedSelect(index, index, PR_TRUE /* augment */);</span>
<a href="#l14.446"></a><span id="l14.446">       }</span>
<a href="#l14.447"></a><span id="l14.447">     }</span>
<a href="#l14.448"></a><span id="l14.448">   }</span>
<a href="#l14.449"></a><span id="l14.449"> </span>
<a href="#l14.450"></a><span id="l14.450" class="difflineminus">-  // reset the index card, and ensure it is visible</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+  // Reset the index card, and ensure it is visible.</span>
<a href="#l14.452"></a><span id="l14.452">   if (aIndexCard) {</span>
<a href="#l14.453"></a><span id="l14.453">     PRInt32 currentIndex = FindIndexForCard(aIndexCard);</span>
<a href="#l14.454"></a><span id="l14.454">     rv = mTreeSelection-&gt;SetCurrentIndex(currentIndex);</span>
<a href="#l14.455"></a><span id="l14.455">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.456"></a><span id="l14.456">   </span>
<a href="#l14.457"></a><span id="l14.457">     if (mTree) {</span>
<a href="#l14.458"></a><span id="l14.458">       rv = mTree-&gt;EnsureRowIsVisible(currentIndex);</span>
<a href="#l14.459"></a><span id="l14.459">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineat">@@ -1082,17 +1082,17 @@ nsresult nsAbView::ReselectCards(nsIArra</span>
<a href="#l14.461"></a><span id="l14.461"> NS_IMETHODIMP nsAbView::DeleteSelectedCards()</span>
<a href="#l14.462"></a><span id="l14.462"> {</span>
<a href="#l14.463"></a><span id="l14.463">   nsCOMPtr&lt;nsIArray&gt; cardsToDelete;</span>
<a href="#l14.464"></a><span id="l14.464">   </span>
<a href="#l14.465"></a><span id="l14.465">   nsresult rv = GetSelectedCards(getter_AddRefs(cardsToDelete));</span>
<a href="#l14.466"></a><span id="l14.466">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.467"></a><span id="l14.467"> </span>
<a href="#l14.468"></a><span id="l14.468">   // mDirectory should not be null</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineminus">-  // bullet proof (and assert) to help figure out bug #127748</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+  // Bullet proof (and assert) to help figure out bug #127748</span>
<a href="#l14.471"></a><span id="l14.471">   NS_ENSURE_TRUE(mDirectory, NS_ERROR_UNEXPECTED);</span>
<a href="#l14.472"></a><span id="l14.472"> </span>
<a href="#l14.473"></a><span id="l14.473">   rv = mDirectory-&gt;DeleteCards(cardsToDelete);</span>
<a href="#l14.474"></a><span id="l14.474">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.475"></a><span id="l14.475">   return rv;</span>
<a href="#l14.476"></a><span id="l14.476"> }</span>
<a href="#l14.477"></a><span id="l14.477"> </span>
<a href="#l14.478"></a><span id="l14.478"> nsresult nsAbView::GetSelectedCards(nsIArray **aSelectedCards)</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineat">@@ -1143,18 +1143,18 @@ NS_IMETHODIMP nsAbView::SwapFirstNameLas</span>
<a href="#l14.480"></a><span id="l14.480">   </span>
<a href="#l14.481"></a><span id="l14.481">   PRInt32 selectionCount; </span>
<a href="#l14.482"></a><span id="l14.482">   nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l14.483"></a><span id="l14.483">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.484"></a><span id="l14.484">   </span>
<a href="#l14.485"></a><span id="l14.485">   if (!selectionCount)</span>
<a href="#l14.486"></a><span id="l14.486">     return NS_OK;</span>
<a href="#l14.487"></a><span id="l14.487">   </span>
<a href="#l14.488"></a><span id="l14.488" class="difflineminus">-  // prepare for displayname generation</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineminus">-  // no cache for pref and bundle since the swap operation is not executed frequently</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+  // Prepare for displayname generation</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+  // No cache for pref and bundle since the swap operation is not executed frequently</span>
<a href="#l14.492"></a><span id="l14.492">   PRBool displayNameAutoGeneration;</span>
<a href="#l14.493"></a><span id="l14.493">   PRBool displayNameLastnamefirst = PR_FALSE;</span>
<a href="#l14.494"></a><span id="l14.494"> </span>
<a href="#l14.495"></a><span id="l14.495">   nsCOMPtr&lt;nsIPrefBranch2&gt; pPrefBranchInt(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l14.496"></a><span id="l14.496">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.497"></a><span id="l14.497"> </span>
<a href="#l14.498"></a><span id="l14.498">   rv = pPrefBranchInt-&gt;GetBoolPref(PREF_MAIL_ADDR_BOOK_DISPLAYNAME_AUTOGENERATION, &amp;displayNameAutoGeneration);</span>
<a href="#l14.499"></a><span id="l14.499">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineat">@@ -1187,87 +1187,87 @@ NS_IMETHODIMP nsAbView::SwapFirstNameLas</span>
<a href="#l14.501"></a><span id="l14.501">     PRInt32 totalCards = mCards.Count();</span>
<a href="#l14.502"></a><span id="l14.502">     if (startRange &gt;= 0 &amp;&amp; startRange &lt; totalCards)</span>
<a href="#l14.503"></a><span id="l14.503">     {</span>
<a href="#l14.504"></a><span id="l14.504">       for (PRInt32 rangeIndex = startRange; rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; totalCards; rangeIndex++) {</span>
<a href="#l14.505"></a><span id="l14.505">         nsCOMPtr&lt;nsIAbCard&gt; abCard;</span>
<a href="#l14.506"></a><span id="l14.506">         rv = GetCardFromRow(rangeIndex, getter_AddRefs(abCard));</span>
<a href="#l14.507"></a><span id="l14.507">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.508"></a><span id="l14.508"> </span>
<a href="#l14.509"></a><span id="l14.509" class="difflineminus">-        // swap FN/LN</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+        // Swap FN/LN</span>
<a href="#l14.511"></a><span id="l14.511">         nsAutoString fn, ln;</span>
<a href="#l14.512"></a><span id="l14.512">         abCard-&gt;GetFirstName(fn);</span>
<a href="#l14.513"></a><span id="l14.513">         abCard-&gt;GetLastName(ln);</span>
<a href="#l14.514"></a><span id="l14.514">         if (!fn.IsEmpty() || !ln.IsEmpty())</span>
<a href="#l14.515"></a><span id="l14.515">         {</span>
<a href="#l14.516"></a><span id="l14.516">           abCard-&gt;SetFirstName(ln);</span>
<a href="#l14.517"></a><span id="l14.517">           abCard-&gt;SetLastName(fn);</span>
<a href="#l14.518"></a><span id="l14.518"> </span>
<a href="#l14.519"></a><span id="l14.519" class="difflineminus">-          // generate display name using the new order</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+          // Generate display name using the new order</span>
<a href="#l14.521"></a><span id="l14.521">           if (displayNameAutoGeneration &amp;&amp;</span>
<a href="#l14.522"></a><span id="l14.522">               !fn.IsEmpty() &amp;&amp; !ln.IsEmpty())</span>
<a href="#l14.523"></a><span id="l14.523">           {</span>
<a href="#l14.524"></a><span id="l14.524">             nsString dnLnFn;</span>
<a href="#l14.525"></a><span id="l14.525">             nsString dnFnLn;</span>
<a href="#l14.526"></a><span id="l14.526">             const PRUnichar *nameString[2];</span>
<a href="#l14.527"></a><span id="l14.527">             const PRUnichar *formatString;</span>
<a href="#l14.528"></a><span id="l14.528"> </span>
<a href="#l14.529"></a><span id="l14.529" class="difflineminus">-            // the format should stays the same before/after we swap the names</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineplus">+            // The format should stays the same before/after we swap the names</span>
<a href="#l14.531"></a><span id="l14.531">             formatString = displayNameLastnamefirst ?</span>
<a href="#l14.532"></a><span id="l14.532">                               NS_LITERAL_STRING(&quot;lastFirstFormat&quot;).get() :</span>
<a href="#l14.533"></a><span id="l14.533">                               NS_LITERAL_STRING(&quot;firstLastFormat&quot;).get();</span>
<a href="#l14.534"></a><span id="l14.534"> </span>
<a href="#l14.535"></a><span id="l14.535" class="difflineminus">-            // generate both ln/fn and fn/ln combination since we need both later</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+            // Generate both ln/fn and fn/ln combination since we need both later</span>
<a href="#l14.537"></a><span id="l14.537">             // to check to see if the current display name was edited</span>
<a href="#l14.538"></a><span id="l14.538">             // note that fn/ln still hold the values before the swap</span>
<a href="#l14.539"></a><span id="l14.539">             nameString[0] = ln.get();</span>
<a href="#l14.540"></a><span id="l14.540">             nameString[1] = fn.get();</span>
<a href="#l14.541"></a><span id="l14.541">             rv = bundle-&gt;FormatStringFromName(formatString,</span>
<a href="#l14.542"></a><span id="l14.542">                                               nameString, 2, getter_Copies(dnLnFn));</span>
<a href="#l14.543"></a><span id="l14.543">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.544"></a><span id="l14.544">             nameString[0] = fn.get();</span>
<a href="#l14.545"></a><span id="l14.545">             nameString[1] = ln.get();</span>
<a href="#l14.546"></a><span id="l14.546">             rv = bundle-&gt;FormatStringFromName(formatString,</span>
<a href="#l14.547"></a><span id="l14.547">                                               nameString, 2, getter_Copies(dnFnLn));</span>
<a href="#l14.548"></a><span id="l14.548">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.549"></a><span id="l14.549"> </span>
<a href="#l14.550"></a><span id="l14.550" class="difflineminus">-            // get the current display name</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+            // Get the current display name</span>
<a href="#l14.552"></a><span id="l14.552">             nsAutoString dn;</span>
<a href="#l14.553"></a><span id="l14.553">             rv = abCard-&gt;GetDisplayName(dn);</span>
<a href="#l14.554"></a><span id="l14.554">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.555"></a><span id="l14.555"> </span>
<a href="#l14.556"></a><span id="l14.556" class="difflineminus">-            // swap the display name if not edited</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineplus">+            // Swap the display name if not edited</span>
<a href="#l14.558"></a><span id="l14.558">             if (displayNameLastnamefirst)</span>
<a href="#l14.559"></a><span id="l14.559">             {</span>
<a href="#l14.560"></a><span id="l14.560">               if (dn.Equals(dnLnFn))</span>
<a href="#l14.561"></a><span id="l14.561">                 abCard-&gt;SetDisplayName(dnFnLn);</span>
<a href="#l14.562"></a><span id="l14.562">             }</span>
<a href="#l14.563"></a><span id="l14.563">             else</span>
<a href="#l14.564"></a><span id="l14.564">             {</span>
<a href="#l14.565"></a><span id="l14.565">               if (dn.Equals(dnFnLn))</span>
<a href="#l14.566"></a><span id="l14.566">                 abCard-&gt;SetDisplayName(dnLnFn);</span>
<a href="#l14.567"></a><span id="l14.567">             }</span>
<a href="#l14.568"></a><span id="l14.568">           }</span>
<a href="#l14.569"></a><span id="l14.569"> </span>
<a href="#l14.570"></a><span id="l14.570" class="difflineminus">-          // swap phonetic names</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+          // Swap phonetic names</span>
<a href="#l14.572"></a><span id="l14.572">           rv = abCard-&gt;GetPropertyAsAString(kPhoneticFirstNameProperty, fn);</span>
<a href="#l14.573"></a><span id="l14.573">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.574"></a><span id="l14.574">           rv = abCard-&gt;GetPropertyAsAString(kPhoneticLastNameProperty, ln);</span>
<a href="#l14.575"></a><span id="l14.575">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.576"></a><span id="l14.576">           if (!fn.IsEmpty() || !ln.IsEmpty())</span>
<a href="#l14.577"></a><span id="l14.577">           {</span>
<a href="#l14.578"></a><span id="l14.578">             abCard-&gt;SetPropertyAsAString(kPhoneticFirstNameProperty, ln);</span>
<a href="#l14.579"></a><span id="l14.579">             abCard-&gt;SetPropertyAsAString(kPhoneticLastNameProperty, fn);</span>
<a href="#l14.580"></a><span id="l14.580">           }</span>
<a href="#l14.581"></a><span id="l14.581">         }</span>
<a href="#l14.582"></a><span id="l14.582">       }</span>
<a href="#l14.583"></a><span id="l14.583">     }</span>
<a href="#l14.584"></a><span id="l14.584">   }</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineminus">-  // update the tree</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineminus">-  // re-sort if either generated or phonetic name is primary or secondary sort,</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+  // Update the tree</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+  // Re-sort if either generated or phonetic name is primary or secondary sort,</span>
<a href="#l14.589"></a><span id="l14.589">   // otherwise invalidate to reflect the change</span>
<a href="#l14.590"></a><span id="l14.590">   rv = RefreshTree();</span>
<a href="#l14.591"></a><span id="l14.591"> </span>
<a href="#l14.592"></a><span id="l14.592">   return rv;</span>
<a href="#l14.593"></a><span id="l14.593"> }</span>
<a href="#l14.594"></a><span id="l14.594"> </span>
<a href="#l14.595"></a><span id="l14.595"> NS_IMETHODIMP nsAbView::GetSelectedAddresses(nsIArray **_retval)</span>
<a href="#l14.596"></a><span id="l14.596"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbWinHelper.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -491,17 +491,17 @@ BOOL nsAbWinHelper::GetPropertyBin(const</span>
<a href="#l15.4"></a><span id="l15.4">                       reinterpret_cast&lt;LPENTRYID&gt;(values-&gt;Value.bin.lpb)) ;</span>
<a href="#l15.5"></a><span id="l15.5">     }</span>
<a href="#l15.6"></a><span id="l15.6">     FreeBuffer(values) ;</span>
<a href="#l15.7"></a><span id="l15.7">     return TRUE ;</span>
<a href="#l15.8"></a><span id="l15.8"> }</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> // This function, supposedly indicating whether a particular entry was</span>
<a href="#l15.11"></a><span id="l15.11"> // in a particular container, doesn't seem to work very well (has</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-// a tendancy to return TRUE even if we're talking to different containers...).</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+// a tendency to return TRUE even if we're talking to different containers...).</span>
<a href="#l15.14"></a><span id="l15.14"> BOOL nsAbWinHelper::TestOpenEntry(const nsMapiEntry&amp; aContainer, const nsMapiEntry&amp; aEntry)</span>
<a href="#l15.15"></a><span id="l15.15"> {</span>
<a href="#l15.16"></a><span id="l15.16">     nsMapiInterfaceWrapper&lt;LPMAPICONTAINER&gt; container ;</span>
<a href="#l15.17"></a><span id="l15.17">     nsMapiInterfaceWrapper&lt;LPMAPIPROP&gt; subObject ;</span>
<a href="#l15.18"></a><span id="l15.18">     ULONG objType = 0 ;</span>
<a href="#l15.19"></a><span id="l15.19">     </span>
<a href="#l15.20"></a><span id="l15.20">     mLastError = mAddressBook-&gt;OpenEntry(aContainer.mByteCount, aContainer.mEntryId,</span>
<a href="#l15.21"></a><span id="l15.21">                                          &amp;IID_IMAPIContainer, 0, &amp;objType, </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.h</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -48,19 +48,19 @@</span>
<a href="#l16.4"></a><span id="l16.4"> class nsAddbookProtocolHandler : public nsIProtocolHandler</span>
<a href="#l16.5"></a><span id="l16.5"> {</span>
<a href="#l16.6"></a><span id="l16.6"> public:</span>
<a href="#l16.7"></a><span id="l16.7"> 	nsAddbookProtocolHandler();</span>
<a href="#l16.8"></a><span id="l16.8"> 	virtual ~nsAddbookProtocolHandler();</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">   NS_DECL_ISUPPORTS</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-	// we suppport the nsIProtocolHandler interface </span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-	//////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+  // We support the nsIProtocolHandler interface.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+  //////////////////////////////////////////////////////////////////////////</span>
<a href="#l16.18"></a><span id="l16.18">   NS_DECL_NSIPROTOCOLHANDLER</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> private:</span>
<a href="#l16.21"></a><span id="l16.21">   nsresult    GenerateXMLOutputChannel(nsString &amp;aOutput,</span>
<a href="#l16.22"></a><span id="l16.22">                                          nsIAddbookUrl *addbookUrl,</span>
<a href="#l16.23"></a><span id="l16.23">                                          nsIURI *aURI, </span>
<a href="#l16.24"></a><span id="l16.24">                                          nsIChannel **_retval);</span>
<a href="#l16.25"></a><span id="l16.25"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsLDAPAutoCompleteSession.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -88,210 +88,199 @@ nsLDAPAutoCompleteSession::~nsLDAPAutoCo</span>
<a href="#l17.4"></a><span id="l17.4"> #define IS_CJK_CHAR_FOR_LDAP(u)  (0x2e80 &lt;= (u) &amp;&amp; (u) &lt;= 0xd7ff)</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> /* void onStartLookup (in wstring searchString, in nsIAutoCompleteResults previousSearchResult, in nsIAutoCompleteListener listener); */</span>
<a href="#l17.7"></a><span id="l17.7"> NS_IMETHODIMP </span>
<a href="#l17.8"></a><span id="l17.8"> nsLDAPAutoCompleteSession::OnStartLookup(const PRUnichar *searchString, </span>
<a href="#l17.9"></a><span id="l17.9">                                          nsIAutoCompleteResults *previousSearchResult,</span>
<a href="#l17.10"></a><span id="l17.10">                                          nsIAutoCompleteListener *listener)</span>
<a href="#l17.11"></a><span id="l17.11"> {</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    nsresult rv; // hold return values from XPCOM calls</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    nsresult rv; // Hold return values from XPCOM calls</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> #ifdef PR_LOGGING</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-    // initialize logging, if it hasn't been already</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-    //</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+    // Initialize logging, if it hasn't been already.</span>
<a href="#l17.19"></a><span id="l17.19">     if (!sLDAPAutoCompleteLogModule) {</span>
<a href="#l17.20"></a><span id="l17.20">         sLDAPAutoCompleteLogModule = PR_NewLogModule(&quot;ldapautocomplete&quot;);</span>
<a href="#l17.21"></a><span id="l17.21"> </span>
<a href="#l17.22"></a><span id="l17.22">         NS_ABORT_IF_FALSE(sLDAPAutoCompleteLogModule, </span>
<a href="#l17.23"></a><span id="l17.23">                           &quot;failed to initialize ldapautocomplete log module&quot;);</span>
<a href="#l17.24"></a><span id="l17.24">     }</span>
<a href="#l17.25"></a><span id="l17.25"> #endif</span>
<a href="#l17.26"></a><span id="l17.26"> </span>
<a href="#l17.27"></a><span id="l17.27">     PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.28"></a><span id="l17.28">            (&quot;nsLDAPAutoCompleteSession::OnStartLookup entered\n&quot;));</span>
<a href="#l17.29"></a><span id="l17.29">     </span>
<a href="#l17.30"></a><span id="l17.30">     if (!listener) {</span>
<a href="#l17.31"></a><span id="l17.31">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnStartLookup(): NULL listener&quot;</span>
<a href="#l17.32"></a><span id="l17.32">                  &quot;passed in&quot;);</span>
<a href="#l17.33"></a><span id="l17.33">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.34"></a><span id="l17.34">     } else {</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-        mListener = listener;   // save it for later callbacks</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+        mListener = listener;   // Save it for later callbacks</span>
<a href="#l17.37"></a><span id="l17.37">     }</span>
<a href="#l17.38"></a><span id="l17.38"> </span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-    // ignore the empty string, strings with @ in them, and strings</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-    // that are too short</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-    //</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+    // Ignore the empty string, strings with @ in them, and strings</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+    // that are too short.</span>
<a href="#l17.44"></a><span id="l17.44">     if (searchString[0] == 0 ||</span>
<a href="#l17.45"></a><span id="l17.45">         nsDependentString(searchString).FindChar(PRUnichar('@'), 0) != -1 || </span>
<a href="#l17.46"></a><span id="l17.46">         nsDependentString(searchString).FindChar(PRUnichar(','), 0) != -1 || </span>
<a href="#l17.47"></a><span id="l17.47">         ( !IS_CJK_CHAR_FOR_LDAP(searchString[0]) ?</span>
<a href="#l17.48"></a><span id="l17.48">           mMinStringLength &amp;&amp; NS_strlen(searchString) &lt; mMinStringLength :</span>
<a href="#l17.49"></a><span id="l17.49">           mCjkMinStringLength &amp;&amp; NS_strlen(searchString) &lt; </span>
<a href="#l17.50"></a><span id="l17.50">           mCjkMinStringLength ) ) {</span>
<a href="#l17.51"></a><span id="l17.51"> </span>
<a href="#l17.52"></a><span id="l17.52">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::ignored, 0, mState);</span>
<a href="#l17.53"></a><span id="l17.53">         return NS_OK;</span>
<a href="#l17.54"></a><span id="l17.54">     } else {</span>
<a href="#l17.55"></a><span id="l17.55">         mSearchString = searchString;        // save it for later use</span>
<a href="#l17.56"></a><span id="l17.56">     }</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58" class="difflineminus">-    // make sure this was called appropriately.</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineminus">-    //</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+    // Make sure this was called appropriately.</span>
<a href="#l17.61"></a><span id="l17.61">     if (mState == SEARCHING || mState == BINDING) {</span>
<a href="#l17.62"></a><span id="l17.62">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnStartLookup(): called while &quot;</span>
<a href="#l17.63"></a><span id="l17.63">                  &quot;search already in progress; no lookup started.&quot;);</span>
<a href="#l17.64"></a><span id="l17.64">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems,</span>
<a href="#l17.65"></a><span id="l17.65">                                  NS_ERROR_FAILURE, mState);</span>
<a href="#l17.66"></a><span id="l17.66">         return NS_ERROR_FAILURE;</span>
<a href="#l17.67"></a><span id="l17.67">     }</span>
<a href="#l17.68"></a><span id="l17.68"> </span>
<a href="#l17.69"></a><span id="l17.69">     NS_ASSERTION(mFormatter, &quot;nsLDAPAutoCompleteSession::OnStartLookup(): &quot;</span>
<a href="#l17.70"></a><span id="l17.70">                  &quot;formatter attribute has not been set&quot;);</span>
<a href="#l17.71"></a><span id="l17.71"> </span>
<a href="#l17.72"></a><span id="l17.72" class="difflineminus">-    // see if this is a narrow search that we could potentially do locally</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineminus">-    //</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+    // See if this is a narrow search that we could potentially do locally.</span>
<a href="#l17.75"></a><span id="l17.75">     if (previousSearchResult) {</span>
<a href="#l17.76"></a><span id="l17.76"> </span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-        // get the string representing previous search results</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-        //</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+        // Get the string representing previous search results.</span>
<a href="#l17.80"></a><span id="l17.80">         nsString prevSearchStr;</span>
<a href="#l17.81"></a><span id="l17.81"> </span>
<a href="#l17.82"></a><span id="l17.82">         rv = previousSearchResult-&gt;GetSearchString(</span>
<a href="#l17.83"></a><span id="l17.83">             getter_Copies(prevSearchStr));</span>
<a href="#l17.84"></a><span id="l17.84">         if ( NS_FAILED(rv) ) {</span>
<a href="#l17.85"></a><span id="l17.85">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnStartLookup(): couldn't &quot;</span>
<a href="#l17.86"></a><span id="l17.86">                      &quot;get search string from previousSearchResult&quot;);</span>
<a href="#l17.87"></a><span id="l17.87">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, </span>
<a href="#l17.88"></a><span id="l17.88">                                      NS_ERROR_FAILURE, mState);</span>
<a href="#l17.89"></a><span id="l17.89">             return NS_ERROR_FAILURE;</span>
<a href="#l17.90"></a><span id="l17.90">         }</span>
<a href="#l17.91"></a><span id="l17.91"> </span>
<a href="#l17.92"></a><span id="l17.92" class="difflineminus">-        // does the string actually contain anything?</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-        //</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+        // Does the string actually contain anything?</span>
<a href="#l17.95"></a><span id="l17.95">         if ( prevSearchStr.get() &amp;&amp; prevSearchStr.get()[0]) {</span>
<a href="#l17.96"></a><span id="l17.96"> </span>
<a href="#l17.97"></a><span id="l17.97">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.98"></a><span id="l17.98">                    (&quot;nsLDAPAutoCompleteSession::OnStartLookup(): starting &quot;</span>
<a href="#l17.99"></a><span id="l17.99">                     &quot;narrowing search\n&quot;));</span>
<a href="#l17.100"></a><span id="l17.100"> </span>
<a href="#l17.101"></a><span id="l17.101" class="difflineminus">-            // XXXdmose for performance, we should really do a local, </span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-            // synchronous search against the existing dataset instead of </span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+            // XXXdmose for performance, we should really do a local,</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+            // synchronous search against the existing dataset instead of</span>
<a href="#l17.105"></a><span id="l17.105">             // just kicking off a new LDAP search here.  When implementing</span>
<a href="#l17.106"></a><span id="l17.106">             // this, need to be sure that only previous results which did not</span>
<a href="#l17.107"></a><span id="l17.107">             // hit the size limit and were successfully completed are used.</span>
<a href="#l17.108"></a><span id="l17.108">             //</span>
<a href="#l17.109"></a><span id="l17.109">             mState = SEARCHING;</span>
<a href="#l17.110"></a><span id="l17.110">             return DoTask();</span>
<a href="#l17.111"></a><span id="l17.111">         }</span>
<a href="#l17.112"></a><span id="l17.112">     }</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114" class="difflineminus">-    // init connection if necesary</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+    // Init connection if necessary</span>
<a href="#l17.116"></a><span id="l17.116">     //</span>
<a href="#l17.117"></a><span id="l17.117">     switch (mState) {</span>
<a href="#l17.118"></a><span id="l17.118">     case UNBOUND:</span>
<a href="#l17.119"></a><span id="l17.119"> </span>
<a href="#l17.120"></a><span id="l17.120" class="difflineminus">-        // initialize the connection.  </span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+        // Initialize the connection.  </span>
<a href="#l17.122"></a><span id="l17.122">         //</span>
<a href="#l17.123"></a><span id="l17.123">         rv = InitConnection();</span>
<a href="#l17.124"></a><span id="l17.124">         if (NS_FAILED(rv)) {</span>
<a href="#l17.125"></a><span id="l17.125"> </span>
<a href="#l17.126"></a><span id="l17.126" class="difflineminus">-            // InitConnection() will have already called </span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+            // InitConnection() will have already called</span>
<a href="#l17.128"></a><span id="l17.128">             // FinishAutoCompleteLookup for us as necessary</span>
<a href="#l17.129"></a><span id="l17.129">             //</span>
<a href="#l17.130"></a><span id="l17.130">             return rv;</span>
<a href="#l17.131"></a><span id="l17.131">         }</span>
<a href="#l17.132"></a><span id="l17.132"> </span>
<a href="#l17.133"></a><span id="l17.133">         return NS_OK;</span>
<a href="#l17.134"></a><span id="l17.134"> </span>
<a href="#l17.135"></a><span id="l17.135">     case BOUND:</span>
<a href="#l17.136"></a><span id="l17.136"> </span>
<a href="#l17.137"></a><span id="l17.137">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.138"></a><span id="l17.138">                (&quot;nsLDAPAutoComplete::OnStartLookup(): subsequent search &quot;</span>
<a href="#l17.139"></a><span id="l17.139">                 &quot;starting&quot;));</span>
<a href="#l17.140"></a><span id="l17.140"> </span>
<a href="#l17.141"></a><span id="l17.141" class="difflineminus">-        // kick off an LDAP search</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+        // Kick off an LDAP search</span>
<a href="#l17.143"></a><span id="l17.143">         mState = SEARCHING;</span>
<a href="#l17.144"></a><span id="l17.144">         return DoTask();</span>
<a href="#l17.145"></a><span id="l17.145"> </span>
<a href="#l17.146"></a><span id="l17.146">     case INITIALIZING:</span>
<a href="#l17.147"></a><span id="l17.147">         // We don't need to do anything here (for now at least), because</span>
<a href="#l17.148"></a><span id="l17.148">         // we can't really abandon the initialization. If we allowed the</span>
<a href="#l17.149"></a><span id="l17.149">         // initialization to be aborted, we could potentially lock the</span>
<a href="#l17.150"></a><span id="l17.150">         // UI thread again, since the DNS service might be stalled.</span>
<a href="#l17.151"></a><span id="l17.151">         //</span>
<a href="#l17.152"></a><span id="l17.152">         return NS_OK;</span>
<a href="#l17.153"></a><span id="l17.153"> </span>
<a href="#l17.154"></a><span id="l17.154">     case BINDING:</span>
<a href="#l17.155"></a><span id="l17.155">     case SEARCHING:</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineminus">-        // we should never get here</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+        // We should never get here</span>
<a href="#l17.158"></a><span id="l17.158">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnStartLookup(): unexpected &quot;</span>
<a href="#l17.159"></a><span id="l17.159">                  &quot;value of mStatus&quot;);</span>
<a href="#l17.160"></a><span id="l17.160">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.161"></a><span id="l17.161">     }</span>
<a href="#l17.162"></a><span id="l17.162">     </span>
<a href="#l17.163"></a><span id="l17.163">     return NS_ERROR_UNEXPECTED;     /*NOTREACHED*/</span>
<a href="#l17.164"></a><span id="l17.164"> }</span>
<a href="#l17.165"></a><span id="l17.165"> </span>
<a href="#l17.166"></a><span id="l17.166"> /* void onStopLookup (); */</span>
<a href="#l17.167"></a><span id="l17.167"> NS_IMETHODIMP </span>
<a href="#l17.168"></a><span id="l17.168"> nsLDAPAutoCompleteSession::OnStopLookup()</span>
<a href="#l17.169"></a><span id="l17.169"> {</span>
<a href="#l17.170"></a><span id="l17.170"> #ifdef PR_LOGGING</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineminus">-    // initialize logging, if it hasn't been already</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineminus">-    //</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+    // Initialize logging, if it hasn't been already.</span>
<a href="#l17.174"></a><span id="l17.174">     if (!sLDAPAutoCompleteLogModule) {</span>
<a href="#l17.175"></a><span id="l17.175">         sLDAPAutoCompleteLogModule = PR_NewLogModule(&quot;ldapautocomplete&quot;);</span>
<a href="#l17.176"></a><span id="l17.176"> </span>
<a href="#l17.177"></a><span id="l17.177">         NS_ABORT_IF_FALSE(sLDAPAutoCompleteLogModule, </span>
<a href="#l17.178"></a><span id="l17.178">                           &quot;failed to initialize ldapautocomplete log module&quot;);</span>
<a href="#l17.179"></a><span id="l17.179">     }</span>
<a href="#l17.180"></a><span id="l17.180"> #endif</span>
<a href="#l17.181"></a><span id="l17.181"> </span>
<a href="#l17.182"></a><span id="l17.182">     PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.183"></a><span id="l17.183">            (&quot;nsLDAPAutoCompleteSession::OnStopLookup entered\n&quot;));</span>
<a href="#l17.184"></a><span id="l17.184"> </span>
<a href="#l17.185"></a><span id="l17.185">     switch (mState) {</span>
<a href="#l17.186"></a><span id="l17.186">     case UNBOUND:</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineminus">-        // nothing to stop</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+        // Nothing to stop</span>
<a href="#l17.189"></a><span id="l17.189">         return NS_OK;</span>
<a href="#l17.190"></a><span id="l17.190"> </span>
<a href="#l17.191"></a><span id="l17.191">     case BOUND:</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineminus">-        // nothing to stop</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+        // Nothing to stop</span>
<a href="#l17.194"></a><span id="l17.194">         return NS_OK;</span>
<a href="#l17.195"></a><span id="l17.195"> </span>
<a href="#l17.196"></a><span id="l17.196">     case INITIALIZING:</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineminus">-        // We can't or shouldn't abor the initialization, because then the</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+        // We can't or shouldn't abort the initialization, because then the</span>
<a href="#l17.199"></a><span id="l17.199">         // DNS service can hang again...</span>
<a href="#l17.200"></a><span id="l17.200">         //</span>
<a href="#l17.201"></a><span id="l17.201">         return NS_OK;</span>
<a href="#l17.202"></a><span id="l17.202"> </span>
<a href="#l17.203"></a><span id="l17.203">     case BINDING:</span>
<a href="#l17.204"></a><span id="l17.204">     case SEARCHING:</span>
<a href="#l17.205"></a><span id="l17.205">         // Abandon the operation, if there is one</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineminus">-        //</span>
<a href="#l17.207"></a><span id="l17.207">         if (mOperation) {</span>
<a href="#l17.208"></a><span id="l17.208">             nsresult rv = mOperation-&gt;AbandonExt();</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210">             if (NS_FAILED(rv)) {</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineminus">-                // since there's nothing interesting that can or should be</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+                // Since there's nothing interesting that can or should be</span>
<a href="#l17.213"></a><span id="l17.213">                 // done if this abandon failed, warn about it and move on</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineminus">-                //</span>
<a href="#l17.215"></a><span id="l17.215">                 NS_WARNING(&quot;nsLDAPAutoCompleteSession::OnStopLookup(): &quot;</span>
<a href="#l17.216"></a><span id="l17.216">                            &quot;error calling mOperation-&gt;AbandonExt()&quot;);</span>
<a href="#l17.217"></a><span id="l17.217">             }</span>
<a href="#l17.218"></a><span id="l17.218"> </span>
<a href="#l17.219"></a><span id="l17.219" class="difflineminus">-            // force nsCOMPtr to release mOperation</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineminus">-            //</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+            // Force nsCOMPtr to release mOperation</span>
<a href="#l17.222"></a><span id="l17.222">             mOperation = 0;</span>
<a href="#l17.223"></a><span id="l17.223">         }</span>
<a href="#l17.224"></a><span id="l17.224"> </span>
<a href="#l17.225"></a><span id="l17.225">         // Set the status properly, set to UNBOUND of we were binding, or</span>
<a href="#l17.226"></a><span id="l17.226">         // to BOUND if we were searching.</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineminus">-        //</span>
<a href="#l17.228"></a><span id="l17.228">         mState = (mState == BINDING ? UNBOUND : BOUND);</span>
<a href="#l17.229"></a><span id="l17.229">         if (mState == UNBOUND)</span>
<a href="#l17.230"></a><span id="l17.230">           NS_IF_RELEASE(mConnection);</span>
<a href="#l17.231"></a><span id="l17.231">     }</span>
<a href="#l17.232"></a><span id="l17.232"> </span>
<a href="#l17.233"></a><span id="l17.233">     mResultsArray = 0;</span>
<a href="#l17.234"></a><span id="l17.234">     mResults = 0;</span>
<a href="#l17.235"></a><span id="l17.235">     mListener = 0;</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineat">@@ -301,20 +290,20 @@ nsLDAPAutoCompleteSession::OnStopLookup(</span>
<a href="#l17.237"></a><span id="l17.237"> </span>
<a href="#l17.238"></a><span id="l17.238"> /* void onAutoComplete (in wstring searchString, in nsIAutoCompleteResults previousSearchResult, in nsIAutoCompleteListener listener); */</span>
<a href="#l17.239"></a><span id="l17.239"> NS_IMETHODIMP </span>
<a href="#l17.240"></a><span id="l17.240"> nsLDAPAutoCompleteSession::OnAutoComplete(const PRUnichar *searchString, </span>
<a href="#l17.241"></a><span id="l17.241">                                  nsIAutoCompleteResults *previousSearchResult, </span>
<a href="#l17.242"></a><span id="l17.242">                                           nsIAutoCompleteListener *listener)</span>
<a href="#l17.243"></a><span id="l17.243"> {</span>
<a href="#l17.244"></a><span id="l17.244">     // OnStopLookup should have already been called, so there's nothing to</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineminus">-    // free here.  Additionally, as of this writing, noone is hanging around </span>
<a href="#l17.246"></a><span id="l17.246" class="difflineminus">-    // waiting for mListener-&gt;OnAutoComplete() to be called either, and if </span>
<a href="#l17.247"></a><span id="l17.247" class="difflineminus">-    // they were, it's unclear what we'd return, since we're not guaranteed </span>
<a href="#l17.248"></a><span id="l17.248" class="difflineminus">-    // to be in any particular state.  My suspicion is that this method </span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+    // free here.  Additionally, as of this writing, no one is hanging around</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+    // waiting for mListener-&gt;OnAutoComplete() to be called either, and if</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+    // they were, it's unclear what we'd return, since we're not guaranteed</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+    // to be in any particular state.  My suspicion is that this method</span>
<a href="#l17.253"></a><span id="l17.253">     // (nsIAutoCompleteSession::OnAutoComplete) should probably be removed</span>
<a href="#l17.254"></a><span id="l17.254">     // from the interface.</span>
<a href="#l17.255"></a><span id="l17.255"> </span>
<a href="#l17.256"></a><span id="l17.256">     return NS_OK;</span>
<a href="#l17.257"></a><span id="l17.257"> }</span>
<a href="#l17.258"></a><span id="l17.258"> </span>
<a href="#l17.259"></a><span id="l17.259"> /**</span>
<a href="#l17.260"></a><span id="l17.260">  * Messages received are passed back via this function.</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineat">@@ -323,78 +312,72 @@ nsLDAPAutoCompleteSession::OnAutoComplet</span>
<a href="#l17.262"></a><span id="l17.262">  *</span>
<a href="#l17.263"></a><span id="l17.263">  * void OnLDAPMessage (in nsILDAPMessage aMessage)</span>
<a href="#l17.264"></a><span id="l17.264">  */</span>
<a href="#l17.265"></a><span id="l17.265"> NS_IMETHODIMP </span>
<a href="#l17.266"></a><span id="l17.266"> nsLDAPAutoCompleteSession::OnLDAPMessage(nsILDAPMessage *aMessage)</span>
<a href="#l17.267"></a><span id="l17.267"> {</span>
<a href="#l17.268"></a><span id="l17.268">     PRInt32 messageType;</span>
<a href="#l17.269"></a><span id="l17.269"> </span>
<a href="#l17.270"></a><span id="l17.270" class="difflineminus">-    // just in case.</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+    // Just in case.</span>
<a href="#l17.272"></a><span id="l17.272">     // XXXdmose the semantics of NULL are currently undefined, but are likely</span>
<a href="#l17.273"></a><span id="l17.273">     // to be defined once we insert timeout handling code into the XPCOM SDK</span>
<a href="#l17.274"></a><span id="l17.274">     // At that time we should figure out if this still the right thing to do.</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-    // </span>
<a href="#l17.276"></a><span id="l17.276">     if (!aMessage) {</span>
<a href="#l17.277"></a><span id="l17.277">         return NS_OK;</span>
<a href="#l17.278"></a><span id="l17.278">     }</span>
<a href="#l17.279"></a><span id="l17.279"> </span>
<a href="#l17.280"></a><span id="l17.280" class="difflineminus">-    // figure out what sort of message was returned</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineminus">-    //</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+    // Figure out what sort of message was returned.</span>
<a href="#l17.283"></a><span id="l17.283">     nsresult rv = aMessage-&gt;GetType(&amp;messageType);</span>
<a href="#l17.284"></a><span id="l17.284">     if (NS_FAILED(rv)) {</span>
<a href="#l17.285"></a><span id="l17.285">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): unexpected &quot;</span>
<a href="#l17.286"></a><span id="l17.286">                  &quot;error in aMessage-&gt;GetType()&quot;);</span>
<a href="#l17.287"></a><span id="l17.287">        </span>
<a href="#l17.288"></a><span id="l17.288" class="difflineminus">-        // don't call FinishAutoCompleteLookup(), as this could conceivably </span>
<a href="#l17.289"></a><span id="l17.289" class="difflineminus">-        // be an anomaly, and perhaps the next message will be ok.  if this</span>
<a href="#l17.290"></a><span id="l17.290" class="difflineplus">+        // Don't call FinishAutoCompleteLookup(), as this could conceivably </span>
<a href="#l17.291"></a><span id="l17.291" class="difflineplus">+        // be an anomaly, and perhaps the next message will be ok. If this</span>
<a href="#l17.292"></a><span id="l17.292">         // really was a problem, this search should eventually get</span>
<a href="#l17.293"></a><span id="l17.293">         // reaped by a timeout (once that code gets implemented).</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-        //</span>
<a href="#l17.295"></a><span id="l17.295">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.296"></a><span id="l17.296">     }</span>
<a href="#l17.297"></a><span id="l17.297"> </span>
<a href="#l17.298"></a><span id="l17.298" class="difflineminus">-    // if this message is not associated with the current operation, </span>
<a href="#l17.299"></a><span id="l17.299" class="difflineminus">-    // discard it, since it is probably from a previous (aborted) </span>
<a href="#l17.300"></a><span id="l17.300" class="difflineminus">-    // operation</span>
<a href="#l17.301"></a><span id="l17.301" class="difflineminus">-    //</span>
<a href="#l17.302"></a><span id="l17.302" class="difflineplus">+    // If this message is not associated with the current operation,</span>
<a href="#l17.303"></a><span id="l17.303" class="difflineplus">+    // discard it, since it is probably from a previous (aborted)</span>
<a href="#l17.304"></a><span id="l17.304" class="difflineplus">+    // operation.</span>
<a href="#l17.305"></a><span id="l17.305">     PRBool isCurrent;</span>
<a href="#l17.306"></a><span id="l17.306">     rv = IsMessageCurrent(aMessage, &amp;isCurrent);</span>
<a href="#l17.307"></a><span id="l17.307">     if (NS_FAILED(rv)) {</span>
<a href="#l17.308"></a><span id="l17.308">         // IsMessageCurrent will have logged any necessary errors</span>
<a href="#l17.309"></a><span id="l17.309">         return rv;</span>
<a href="#l17.310"></a><span id="l17.310">     }</span>
<a href="#l17.311"></a><span id="l17.311">     if ( ! isCurrent ) {</span>
<a href="#l17.312"></a><span id="l17.312">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG,</span>
<a href="#l17.313"></a><span id="l17.313">                (&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): received message &quot;</span>
<a href="#l17.314"></a><span id="l17.314">                 &quot;from operation other than current one; discarded&quot;));</span>
<a href="#l17.315"></a><span id="l17.315">         return NS_OK;</span>
<a href="#l17.316"></a><span id="l17.316">     }</span>
<a href="#l17.317"></a><span id="l17.317"> </span>
<a href="#l17.318"></a><span id="l17.318">     // XXXdmose - we may want a small state machine either here or</span>
<a href="#l17.319"></a><span id="l17.319" class="difflineminus">-    // or in the nsLDAPConnection object, to make sure that things are </span>
<a href="#l17.320"></a><span id="l17.320" class="difflineminus">-    // happening in the right order and timing out appropriately.  this will</span>
<a href="#l17.321"></a><span id="l17.321" class="difflineplus">+    // or in the nsLDAPConnection object, to make sure that things are</span>
<a href="#l17.322"></a><span id="l17.322" class="difflineplus">+    // happening in the right order and timing out appropriately. This will</span>
<a href="#l17.323"></a><span id="l17.323">     // certainly depend on how timeouts are implemented, and how binding</span>
<a href="#l17.324"></a><span id="l17.324" class="difflineminus">-    // gets is dealt with by nsILDAPService.  also need to deal with the case</span>
<a href="#l17.325"></a><span id="l17.325" class="difflineplus">+    // gets is dealt with by nsILDAPService. Also need to deal with the case</span>
<a href="#l17.326"></a><span id="l17.326">     // where a bind callback happens after onStopLookup was called.</span>
<a href="#l17.327"></a><span id="l17.327" class="difflineminus">-    // </span>
<a href="#l17.328"></a><span id="l17.328">     switch (messageType) {</span>
<a href="#l17.329"></a><span id="l17.329"> </span>
<a href="#l17.330"></a><span id="l17.330">     case nsILDAPMessage::RES_BIND:</span>
<a href="#l17.331"></a><span id="l17.331"> </span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-        // a bind has completed</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineminus">-        //</span>
<a href="#l17.334"></a><span id="l17.334" class="difflineplus">+        // A bind has completed</span>
<a href="#l17.335"></a><span id="l17.335">         if (mState != BINDING) {</span>
<a href="#l17.336"></a><span id="l17.336">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.337"></a><span id="l17.337">                    (&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): LDAP bind &quot;</span>
<a href="#l17.338"></a><span id="l17.338">                     &quot;entry returned after OnStopLookup() called; ignoring&quot;));</span>
<a href="#l17.339"></a><span id="l17.339"> </span>
<a href="#l17.340"></a><span id="l17.340" class="difflineminus">-            // XXXdmose when nsLDAPService integration happens, need to make </span>
<a href="#l17.341"></a><span id="l17.341" class="difflineminus">-            // sure that the possibility of having an already bound </span>
<a href="#l17.342"></a><span id="l17.342" class="difflineminus">-            // connection, due to a previously unaborted bind, doesn't cause </span>
<a href="#l17.343"></a><span id="l17.343" class="difflineplus">+            // XXXdmose when nsLDAPService integration happens, need to make</span>
<a href="#l17.344"></a><span id="l17.344" class="difflineplus">+            // sure that the possibility of having an already bound</span>
<a href="#l17.345"></a><span id="l17.345" class="difflineplus">+            // connection, due to a previously unaborted bind, doesn't cause</span>
<a href="#l17.346"></a><span id="l17.346">             // any problems.</span>
<a href="#l17.347"></a><span id="l17.347"> </span>
<a href="#l17.348"></a><span id="l17.348">             return NS_OK;</span>
<a href="#l17.349"></a><span id="l17.349">         }</span>
<a href="#l17.350"></a><span id="l17.350"> </span>
<a href="#l17.351"></a><span id="l17.351">         rv = OnLDAPMessageBind(aMessage);</span>
<a href="#l17.352"></a><span id="l17.352">         if (NS_FAILED(rv)) {</span>
<a href="#l17.353"></a><span id="l17.353">           mState = UNBOUND;</span>
<a href="#l17.354"></a><span id="l17.354" class="difflineat">@@ -403,67 +386,62 @@ nsLDAPAutoCompleteSession::OnLDAPMessage</span>
<a href="#l17.355"></a><span id="l17.355">         }</span>
<a href="#l17.356"></a><span id="l17.356">         else</span>
<a href="#l17.357"></a><span id="l17.357">           mState = SEARCHING;</span>
<a href="#l17.358"></a><span id="l17.358"> </span>
<a href="#l17.359"></a><span id="l17.359">         return rv;</span>
<a href="#l17.360"></a><span id="l17.360"> </span>
<a href="#l17.361"></a><span id="l17.361">     case nsILDAPMessage::RES_SEARCH_ENTRY:</span>
<a href="#l17.362"></a><span id="l17.362">         </span>
<a href="#l17.363"></a><span id="l17.363" class="difflineminus">-        // ignore this if OnStopLookup was already called</span>
<a href="#l17.364"></a><span id="l17.364" class="difflineminus">-        //</span>
<a href="#l17.365"></a><span id="l17.365" class="difflineplus">+        // Ignore this if OnStopLookup was already called.</span>
<a href="#l17.366"></a><span id="l17.366">         if (mState != SEARCHING) {</span>
<a href="#l17.367"></a><span id="l17.367">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.368"></a><span id="l17.368">                    (&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): LDAP search &quot;</span>
<a href="#l17.369"></a><span id="l17.369">                     &quot;entry returned after OnStopLoookup() called; ignoring&quot;));</span>
<a href="#l17.370"></a><span id="l17.370">             return NS_OK;</span>
<a href="#l17.371"></a><span id="l17.371">         }</span>
<a href="#l17.372"></a><span id="l17.372"> </span>
<a href="#l17.373"></a><span id="l17.373" class="difflineminus">-        // a search entry has been returned</span>
<a href="#l17.374"></a><span id="l17.374" class="difflineminus">-        //</span>
<a href="#l17.375"></a><span id="l17.375" class="difflineplus">+        // A search entry has been returned.</span>
<a href="#l17.376"></a><span id="l17.376">         return OnLDAPSearchEntry(aMessage);</span>
<a href="#l17.377"></a><span id="l17.377"> </span>
<a href="#l17.378"></a><span id="l17.378">     case nsILDAPMessage::RES_SEARCH_RESULT:</span>
<a href="#l17.379"></a><span id="l17.379"> </span>
<a href="#l17.380"></a><span id="l17.380" class="difflineminus">-        // ignore this if OnStopLookup was already called</span>
<a href="#l17.381"></a><span id="l17.381" class="difflineminus">-        //</span>
<a href="#l17.382"></a><span id="l17.382" class="difflineplus">+        // Ignore this if OnStopLookup was already called.</span>
<a href="#l17.383"></a><span id="l17.383">         if (mState != SEARCHING) {</span>
<a href="#l17.384"></a><span id="l17.384">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG,</span>
<a href="#l17.385"></a><span id="l17.385">                    (&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): LDAP search &quot;</span>
<a href="#l17.386"></a><span id="l17.386">                     &quot;result returned after OnStopLookup called; ignoring&quot;));</span>
<a href="#l17.387"></a><span id="l17.387">             return NS_OK;</span>
<a href="#l17.388"></a><span id="l17.388">         }</span>
<a href="#l17.389"></a><span id="l17.389"> </span>
<a href="#l17.390"></a><span id="l17.390" class="difflineminus">-        // the search is finished; we're all done</span>
<a href="#l17.391"></a><span id="l17.391" class="difflineminus">-        //  </span>
<a href="#l17.392"></a><span id="l17.392" class="difflineplus">+        // The search is finished; we're all done.</span>
<a href="#l17.393"></a><span id="l17.393">         return OnLDAPSearchResult(aMessage);</span>
<a href="#l17.394"></a><span id="l17.394"> </span>
<a href="#l17.395"></a><span id="l17.395">     default:</span>
<a href="#l17.396"></a><span id="l17.396">         </span>
<a href="#l17.397"></a><span id="l17.397">         // Given the LDAP operations nsLDAPAutoCompleteSession uses, we should</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-        // never get here.  If we do get here in a release build, it's</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineplus">+        // never get here. If we do get here in a release build, it's</span>
<a href="#l17.400"></a><span id="l17.400">         // probably a bug, but maybe it's the LDAP server doing something</span>
<a href="#l17.401"></a><span id="l17.401" class="difflineminus">-        // weird.  Might as well try and continue anyway.  The session should</span>
<a href="#l17.402"></a><span id="l17.402" class="difflineplus">+        // weird. Might as well try and continue anyway. The session should</span>
<a href="#l17.403"></a><span id="l17.403">         // eventually get reaped by the timeout code, if necessary.</span>
<a href="#l17.404"></a><span id="l17.404">         //</span>
<a href="#l17.405"></a><span id="l17.405">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnLDAPMessage(): unexpected &quot;</span>
<a href="#l17.406"></a><span id="l17.406">                  &quot;LDAP message received&quot;);</span>
<a href="#l17.407"></a><span id="l17.407">         return NS_OK;</span>
<a href="#l17.408"></a><span id="l17.408">     }</span>
<a href="#l17.409"></a><span id="l17.409"> }</span>
<a href="#l17.410"></a><span id="l17.410"> </span>
<a href="#l17.411"></a><span id="l17.411"> void</span>
<a href="#l17.412"></a><span id="l17.412"> nsLDAPAutoCompleteSession::InitFailed(PRBool aCancelled)</span>
<a href="#l17.413"></a><span id="l17.413"> {</span>
<a href="#l17.414"></a><span id="l17.414">   FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, 0,</span>
<a href="#l17.415"></a><span id="l17.415">                            UNBOUND);</span>
<a href="#l17.416"></a><span id="l17.416"> }</span>
<a href="#l17.417"></a><span id="l17.417"> </span>
<a href="#l17.418"></a><span id="l17.418"> // void onLDAPInit (in nsresult aStatus);</span>
<a href="#l17.419"></a><span id="l17.419" class="difflineminus">-//</span>
<a href="#l17.420"></a><span id="l17.420"> NS_IMETHODIMP</span>
<a href="#l17.421"></a><span id="l17.421"> nsLDAPAutoCompleteSession::OnLDAPInit(nsILDAPConnection *aConn, nsresult aStatus)</span>
<a href="#l17.422"></a><span id="l17.422"> {</span>
<a href="#l17.423"></a><span id="l17.423">   nsresult rv = nsAbLDAPListenerBase::OnLDAPInit(aConn, aStatus);</span>
<a href="#l17.424"></a><span id="l17.424"> </span>
<a href="#l17.425"></a><span id="l17.425">   if (NS_SUCCEEDED(rv))</span>
<a href="#l17.426"></a><span id="l17.426">     mState = BINDING;</span>
<a href="#l17.427"></a><span id="l17.427"> </span>
<a href="#l17.428"></a><span id="l17.428" class="difflineat">@@ -471,147 +449,138 @@ nsLDAPAutoCompleteSession::OnLDAPInit(ns</span>
<a href="#l17.429"></a><span id="l17.429"> }</span>
<a href="#l17.430"></a><span id="l17.430"> </span>
<a href="#l17.431"></a><span id="l17.431"> nsresult</span>
<a href="#l17.432"></a><span id="l17.432"> nsLDAPAutoCompleteSession::OnLDAPSearchEntry(nsILDAPMessage *aMessage)</span>
<a href="#l17.433"></a><span id="l17.433"> {</span>
<a href="#l17.434"></a><span id="l17.434">     PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.435"></a><span id="l17.435">            (&quot;nsLDAPAutoCompleteSession::OnLDAPSearchEntry entered\n&quot;));</span>
<a href="#l17.436"></a><span id="l17.436"> </span>
<a href="#l17.437"></a><span id="l17.437" class="difflineminus">-    // make sure this is only getting called after DoTask has </span>
<a href="#l17.438"></a><span id="l17.438" class="difflineminus">-    // initialized the result set</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineminus">-    //</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineplus">+    // Make sure this is only getting called after DoTask has</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineplus">+    // initialized the result set.</span>
<a href="#l17.442"></a><span id="l17.442">     NS_ASSERTION(mResultsArray,</span>
<a href="#l17.443"></a><span id="l17.443">                  &quot;nsLDAPAutoCompleteSession::OnLDAPSearchEntry(): &quot;</span>
<a href="#l17.444"></a><span id="l17.444">                  &quot;mResultsArrayItems is uninitialized&quot;);</span>
<a href="#l17.445"></a><span id="l17.445"> </span>
<a href="#l17.446"></a><span id="l17.446">     // Errors in this method return an error (which ultimately gets</span>
<a href="#l17.447"></a><span id="l17.447">     // ignored, since this is being called through an async proxy).</span>
<a href="#l17.448"></a><span id="l17.448">     // But the important thing is that we're bailing out here rather</span>
<a href="#l17.449"></a><span id="l17.449" class="difflineminus">-    // than trying to generate a bogus nsIAutoCompleteItem.  Also note</span>
<a href="#l17.450"></a><span id="l17.450" class="difflineplus">+    // than trying to generate a bogus nsIAutoCompleteItem. Also note</span>
<a href="#l17.451"></a><span id="l17.451">     // that FinishAutoCompleteLookup is _NOT_ being called here, because</span>
<a href="#l17.452"></a><span id="l17.452">     // this error may just have to do with this particular item.</span>
<a href="#l17.453"></a><span id="l17.453"> </span>
<a href="#l17.454"></a><span id="l17.454" class="difflineminus">-    // generate an autocomplete item from this message by calling the</span>
<a href="#l17.455"></a><span id="l17.455" class="difflineminus">-    // formatter</span>
<a href="#l17.456"></a><span id="l17.456" class="difflineminus">-    //</span>
<a href="#l17.457"></a><span id="l17.457" class="difflineplus">+    // Generate an autocomplete item from this message by calling the</span>
<a href="#l17.458"></a><span id="l17.458" class="difflineplus">+    // formatter.</span>
<a href="#l17.459"></a><span id="l17.459">     nsCOMPtr&lt;nsIAutoCompleteItem&gt; item;</span>
<a href="#l17.460"></a><span id="l17.460">     nsresult rv = mFormatter-&gt;Format(aMessage, getter_AddRefs(item));</span>
<a href="#l17.461"></a><span id="l17.461">     if (NS_FAILED(rv)) {</span>
<a href="#l17.462"></a><span id="l17.462">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG,</span>
<a href="#l17.463"></a><span id="l17.463">                (&quot;nsLDAPAutoCompleteSession::OnLDAPSearchEntry(): &quot;</span>
<a href="#l17.464"></a><span id="l17.464">                 &quot;mFormatter-&gt;Format() failed&quot;));</span>
<a href="#l17.465"></a><span id="l17.465">         return NS_ERROR_FAILURE;</span>
<a href="#l17.466"></a><span id="l17.466">     }</span>
<a href="#l17.467"></a><span id="l17.467"> </span>
<a href="#l17.468"></a><span id="l17.468">     rv = mResultsArray-&gt;AppendElement(item);</span>
<a href="#l17.469"></a><span id="l17.469">     if (NS_FAILED(rv)) {</span>
<a href="#l17.470"></a><span id="l17.470">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnLDAPSearchEntry(): &quot;</span>
<a href="#l17.471"></a><span id="l17.471">                  &quot;mItems-&gt;AppendElement() failed&quot;);</span>
<a href="#l17.472"></a><span id="l17.472">         return NS_ERROR_FAILURE;</span>
<a href="#l17.473"></a><span id="l17.473">     }</span>
<a href="#l17.474"></a><span id="l17.474"> </span>
<a href="#l17.475"></a><span id="l17.475" class="difflineminus">-    // remember that something has been returned</span>
<a href="#l17.476"></a><span id="l17.476" class="difflineminus">-    //</span>
<a href="#l17.477"></a><span id="l17.477" class="difflineplus">+    // Remember that something has been returned.</span>
<a href="#l17.478"></a><span id="l17.478">     mEntriesReturned++;</span>
<a href="#l17.479"></a><span id="l17.479"> </span>
<a href="#l17.480"></a><span id="l17.480">     return NS_OK;</span>
<a href="#l17.481"></a><span id="l17.481"> }</span>
<a href="#l17.482"></a><span id="l17.482"> </span>
<a href="#l17.483"></a><span id="l17.483"> nsresult</span>
<a href="#l17.484"></a><span id="l17.484"> nsLDAPAutoCompleteSession::OnLDAPSearchResult(nsILDAPMessage *aMessage)</span>
<a href="#l17.485"></a><span id="l17.485"> {</span>
<a href="#l17.486"></a><span id="l17.486" class="difflineminus">-    nsresult rv;        // temp for return vals</span>
<a href="#l17.487"></a><span id="l17.487" class="difflineplus">+    nsresult rv;        // Temp for return vals</span>
<a href="#l17.488"></a><span id="l17.488"> </span>
<a href="#l17.489"></a><span id="l17.489">     PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.490"></a><span id="l17.490">            (&quot;nsLDAPAutoCompleteSession::OnLDAPSearchResult entered\n&quot;));</span>
<a href="#l17.491"></a><span id="l17.491"> </span>
<a href="#l17.492"></a><span id="l17.492" class="difflineminus">-    // figure out if we succeeded or failed, and set the status </span>
<a href="#l17.493"></a><span id="l17.493" class="difflineminus">-    // and default index appropriately</span>
<a href="#l17.494"></a><span id="l17.494" class="difflineminus">-    //</span>
<a href="#l17.495"></a><span id="l17.495" class="difflineplus">+    // Figure out if we succeeded or failed, and set the status</span>
<a href="#l17.496"></a><span id="l17.496" class="difflineplus">+    // and default index appropriately.</span>
<a href="#l17.497"></a><span id="l17.497">     AutoCompleteStatus status;</span>
<a href="#l17.498"></a><span id="l17.498">     PRInt32 lderrno;</span>
<a href="#l17.499"></a><span id="l17.499"> </span>
<a href="#l17.500"></a><span id="l17.500">     if (mEntriesReturned) {</span>
<a href="#l17.501"></a><span id="l17.501"> </span>
<a href="#l17.502"></a><span id="l17.502">         status = nsIAutoCompleteStatus::matchFound;</span>
<a href="#l17.503"></a><span id="l17.503"> </span>
<a href="#l17.504"></a><span id="l17.504" class="difflineminus">-        // there's at least one match, so the default index should</span>
<a href="#l17.505"></a><span id="l17.505" class="difflineplus">+        // There's at least one match, so the default index should</span>
<a href="#l17.506"></a><span id="l17.506">         // point to the first thing here.  This ensures that if the local</span>
<a href="#l17.507"></a><span id="l17.507" class="difflineminus">-        // addressbook autocomplete session only found foo@local.domain, </span>
<a href="#l17.508"></a><span id="l17.508" class="difflineminus">-        // this will be given preference</span>
<a href="#l17.509"></a><span id="l17.509" class="difflineminus">-        //</span>
<a href="#l17.510"></a><span id="l17.510" class="difflineplus">+        // addressbook autocomplete session only found foo@local.domain,</span>
<a href="#l17.511"></a><span id="l17.511" class="difflineplus">+        // this will be given preference.</span>
<a href="#l17.512"></a><span id="l17.512">         rv = mResults-&gt;SetDefaultItemIndex(0);</span>
<a href="#l17.513"></a><span id="l17.513">         if (NS_FAILED(rv)) {</span>
<a href="#l17.514"></a><span id="l17.514">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnLDAPSearchResult(): &quot;</span>
<a href="#l17.515"></a><span id="l17.515">                      &quot;mResults-&gt;SetDefaultItemIndex(0) failed&quot;);</span>
<a href="#l17.516"></a><span id="l17.516">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.517"></a><span id="l17.517">                                      BOUND);</span>
<a href="#l17.518"></a><span id="l17.518">         }</span>
<a href="#l17.519"></a><span id="l17.519">     } else {</span>
<a href="#l17.520"></a><span id="l17.520" class="difflineminus">-        // note that we only look at the error code if there are no results for</span>
<a href="#l17.521"></a><span id="l17.521" class="difflineplus">+        // Note that we only look at the error code if there are no results for</span>
<a href="#l17.522"></a><span id="l17.522">         // this session; if we got results and then an error happened, this</span>
<a href="#l17.523"></a><span id="l17.523">         // is ignored, in part because it seems likely to be confusing to the</span>
<a href="#l17.524"></a><span id="l17.524" class="difflineminus">-        // user, and in part because it is likely to be scrolled out of view </span>
<a href="#l17.525"></a><span id="l17.525" class="difflineminus">-        // anyway</span>
<a href="#l17.526"></a><span id="l17.526" class="difflineminus">-        //</span>
<a href="#l17.527"></a><span id="l17.527" class="difflineplus">+        // user, and in part because it is likely to be scrolled out of view</span>
<a href="#l17.528"></a><span id="l17.528" class="difflineplus">+        // anyway.</span>
<a href="#l17.529"></a><span id="l17.529">         aMessage-&gt;GetErrorCode(&amp;lderrno);</span>
<a href="#l17.530"></a><span id="l17.530">         if (lderrno != nsILDAPErrors::SUCCESS) {</span>
<a href="#l17.531"></a><span id="l17.531"> </span>
<a href="#l17.532"></a><span id="l17.532">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.533"></a><span id="l17.533">                    (&quot;nsLDAPAutoCompleteSession::OnLDAPSearchResult(): &quot;</span>
<a href="#l17.534"></a><span id="l17.534">                     &quot;lderrno=%d\n&quot;, lderrno));</span>
<a href="#l17.535"></a><span id="l17.535">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, </span>
<a href="#l17.536"></a><span id="l17.536">                                      NS_ERROR_GENERATE_FAILURE(</span>
<a href="#l17.537"></a><span id="l17.537">                                          NS_ERROR_MODULE_LDAP, lderrno), </span>
<a href="#l17.538"></a><span id="l17.538">                                      BOUND);</span>
<a href="#l17.539"></a><span id="l17.539">             return NS_OK;</span>
<a href="#l17.540"></a><span id="l17.540">         }</span>
<a href="#l17.541"></a><span id="l17.541"> </span>
<a href="#l17.542"></a><span id="l17.542" class="difflineminus">-        // we could potentially keep track of non-fatal errors to the </span>
<a href="#l17.543"></a><span id="l17.543" class="difflineplus">+        // We could potentially keep track of non-fatal errors to the</span>
<a href="#l17.544"></a><span id="l17.544">         // search, and if there has been more than 1, and there are no entries,</span>
<a href="#l17.545"></a><span id="l17.545" class="difflineminus">-        // we could return |failed| instead of |noMatch|.  It's unclear to me</span>
<a href="#l17.546"></a><span id="l17.546" class="difflineplus">+        // we could return |failed| instead of |noMatch|. It's unclear to me</span>
<a href="#l17.547"></a><span id="l17.547">         // that this actually buys us anything though.</span>
<a href="#l17.548"></a><span id="l17.548" class="difflineminus">-        //</span>
<a href="#l17.549"></a><span id="l17.549">         status = nsIAutoCompleteStatus::noMatch;</span>
<a href="#l17.550"></a><span id="l17.550">     }</span>
<a href="#l17.551"></a><span id="l17.551"> </span>
<a href="#l17.552"></a><span id="l17.552" class="difflineminus">-    // call the mListener's OnAutoComplete and clean up</span>
<a href="#l17.553"></a><span id="l17.553" class="difflineplus">+    // Call the mListener's OnAutoComplete and clean up</span>
<a href="#l17.554"></a><span id="l17.554">     //</span>
<a href="#l17.555"></a><span id="l17.555">     // XXXdmose should we really leave the connection BOUND here?</span>
<a href="#l17.556"></a><span id="l17.556">     FinishAutoCompleteLookup(status, NS_OK, BOUND);</span>
<a href="#l17.557"></a><span id="l17.557"> </span>
<a href="#l17.558"></a><span id="l17.558">     return NS_OK;</span>
<a href="#l17.559"></a><span id="l17.559"> }</span>
<a href="#l17.560"></a><span id="l17.560"> </span>
<a href="#l17.561"></a><span id="l17.561"> nsresult</span>
<a href="#l17.562"></a><span id="l17.562"> nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.563"></a><span id="l17.563"> {</span>
<a href="#l17.564"></a><span id="l17.564">     nsresult rv; // temp for xpcom return values</span>
<a href="#l17.565"></a><span id="l17.565">     nsCOMPtr&lt;nsILDAPMessageListener&gt; selfProxy; // for callback</span>
<a href="#l17.566"></a><span id="l17.566"> </span>
<a href="#l17.567"></a><span id="l17.567">     PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.568"></a><span id="l17.568">            (&quot;nsLDAPAutoCompleteSession::DoTask entered\n&quot;));</span>
<a href="#l17.569"></a><span id="l17.569"> </span>
<a href="#l17.570"></a><span id="l17.570" class="difflineminus">-    // create and initialize an LDAP operation (to be used for the search</span>
<a href="#l17.571"></a><span id="l17.571" class="difflineminus">-    //  </span>
<a href="#l17.572"></a><span id="l17.572" class="difflineplus">+    // Create and initialize an LDAP operation (to be used for the search).</span>
<a href="#l17.573"></a><span id="l17.573">     mOperation = </span>
<a href="#l17.574"></a><span id="l17.574">         do_CreateInstance(&quot;@mozilla.org/network/ldap-operation;1&quot;, &amp;rv);</span>
<a href="#l17.575"></a><span id="l17.575"> </span>
<a href="#l17.576"></a><span id="l17.576">     if (NS_FAILED(rv)) {</span>
<a href="#l17.577"></a><span id="l17.577">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.578"></a><span id="l17.578">                  &quot;create @mozilla.org/network/ldap-operation;1&quot;);</span>
<a href="#l17.579"></a><span id="l17.579"> </span>
<a href="#l17.580"></a><span id="l17.580">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.581"></a><span id="l17.581">                                  BOUND);</span>
<a href="#l17.582"></a><span id="l17.582">         return NS_ERROR_FAILURE;</span>
<a href="#l17.583"></a><span id="l17.583">     }</span>
<a href="#l17.584"></a><span id="l17.584"> </span>
<a href="#l17.585"></a><span id="l17.585" class="difflineminus">-    // get a proxy object so the callback happens on the main thread</span>
<a href="#l17.586"></a><span id="l17.586" class="difflineminus">-    //</span>
<a href="#l17.587"></a><span id="l17.587" class="difflineplus">+    // Get a proxy object so the callback happens on the main thread.</span>
<a href="#l17.588"></a><span id="l17.588">     nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr = do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l17.589"></a><span id="l17.589">     if (NS_FAILED(rv)) {</span>
<a href="#l17.590"></a><span id="l17.590">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, UNBOUND);</span>
<a href="#l17.591"></a><span id="l17.591">         return NS_ERROR_FAILURE;</span>
<a href="#l17.592"></a><span id="l17.592">     }</span>
<a href="#l17.593"></a><span id="l17.593">     rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD,</span>
<a href="#l17.594"></a><span id="l17.594">                               NS_GET_IID(nsILDAPMessageListener), </span>
<a href="#l17.595"></a><span id="l17.595">                               static_cast&lt;nsILDAPMessageListener *&gt;(this), </span>
<a href="#l17.596"></a><span id="l17.596" class="difflineat">@@ -620,28 +589,27 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.597"></a><span id="l17.597">     if (NS_FAILED(rv)) {</span>
<a href="#l17.598"></a><span id="l17.598">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.599"></a><span id="l17.599">                  &quot;create proxy to this object for callback&quot;);</span>
<a href="#l17.600"></a><span id="l17.600">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.601"></a><span id="l17.601">                                  BOUND);</span>
<a href="#l17.602"></a><span id="l17.602">         return NS_ERROR_FAILURE;</span>
<a href="#l17.603"></a><span id="l17.603">     }</span>
<a href="#l17.604"></a><span id="l17.604"> </span>
<a href="#l17.605"></a><span id="l17.605" class="difflineminus">-    // initialize the LDAP operation object</span>
<a href="#l17.606"></a><span id="l17.606" class="difflineminus">-    //</span>
<a href="#l17.607"></a><span id="l17.607" class="difflineplus">+    // Initialize the LDAP operation object.</span>
<a href="#l17.608"></a><span id="l17.608">     rv = mOperation-&gt;Init(mConnection, selfProxy, nsnull);</span>
<a href="#l17.609"></a><span id="l17.609">     if (NS_FAILED(rv)) {</span>
<a href="#l17.610"></a><span id="l17.610">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.611"></a><span id="l17.611">                  &quot;initialize LDAP operation&quot;);</span>
<a href="#l17.612"></a><span id="l17.612">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.613"></a><span id="l17.613">                                  BOUND);</span>
<a href="#l17.614"></a><span id="l17.614">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.615"></a><span id="l17.615">     }</span>
<a href="#l17.616"></a><span id="l17.616"> </span>
<a href="#l17.617"></a><span id="l17.617" class="difflineminus">-    // set the server and client controls on the operation</span>
<a href="#l17.618"></a><span id="l17.618" class="difflineplus">+    // Set the server and client controls on the operation.</span>
<a href="#l17.619"></a><span id="l17.619">     if (mSearchServerControls) {</span>
<a href="#l17.620"></a><span id="l17.620">         rv = mOperation-&gt;SetServerControls(mSearchServerControls);</span>
<a href="#l17.621"></a><span id="l17.621">         if (NS_FAILED(rv)) {</span>
<a href="#l17.622"></a><span id="l17.622">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.623"></a><span id="l17.623">                      &quot;initialize LDAP search operation server controls&quot;);</span>
<a href="#l17.624"></a><span id="l17.624">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.625"></a><span id="l17.625">                                      BOUND);</span>
<a href="#l17.626"></a><span id="l17.626">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.627"></a><span id="l17.627" class="difflineat">@@ -653,63 +621,58 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.628"></a><span id="l17.628">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.629"></a><span id="l17.629">                      &quot;initialize LDAP search operation client controls&quot;);</span>
<a href="#l17.630"></a><span id="l17.630">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.631"></a><span id="l17.631">                                      BOUND);</span>
<a href="#l17.632"></a><span id="l17.632">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.633"></a><span id="l17.633">         }</span>
<a href="#l17.634"></a><span id="l17.634">     }</span>
<a href="#l17.635"></a><span id="l17.635"> </span>
<a href="#l17.636"></a><span id="l17.636" class="difflineminus">-    // get the search filter associated with the directory server url; </span>
<a href="#l17.637"></a><span id="l17.637" class="difflineplus">+    // Get the search filter associated with the directory server url;</span>
<a href="#l17.638"></a><span id="l17.638">     // it will be ANDed with the rest of the search filter that we're using.</span>
<a href="#l17.639"></a><span id="l17.639" class="difflineminus">-    //</span>
<a href="#l17.640"></a><span id="l17.640">     nsCAutoString urlFilter;</span>
<a href="#l17.641"></a><span id="l17.641">     rv = mDirectoryUrl-&gt;GetFilter(urlFilter);</span>
<a href="#l17.642"></a><span id="l17.642">     if ( NS_FAILED(rv) ){</span>
<a href="#l17.643"></a><span id="l17.643">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv,</span>
<a href="#l17.644"></a><span id="l17.644">                                  BOUND);</span>
<a href="#l17.645"></a><span id="l17.645">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.646"></a><span id="l17.646">     }</span>
<a href="#l17.647"></a><span id="l17.647"> </span>
<a href="#l17.648"></a><span id="l17.648" class="difflineminus">-    // get the LDAP service, since createFilter is called through it.</span>
<a href="#l17.649"></a><span id="l17.649" class="difflineminus">-    //</span>
<a href="#l17.650"></a><span id="l17.650" class="difflineplus">+    // Get the LDAP service, since createFilter is called through it.</span>
<a href="#l17.651"></a><span id="l17.651">     nsCOMPtr&lt;nsILDAPService&gt; ldapSvc = do_GetService(</span>
<a href="#l17.652"></a><span id="l17.652">         &quot;@mozilla.org/network/ldap-service;1&quot;, &amp;rv);</span>
<a href="#l17.653"></a><span id="l17.653">     if (NS_FAILED(rv)) {</span>
<a href="#l17.654"></a><span id="l17.654">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): couldn't &quot;</span>
<a href="#l17.655"></a><span id="l17.655">                  &quot;get @mozilla.org/network/ldap-service;1&quot;);</span>
<a href="#l17.656"></a><span id="l17.656">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv,</span>
<a href="#l17.657"></a><span id="l17.657">                                  BOUND);</span>
<a href="#l17.658"></a><span id="l17.658">         return NS_ERROR_FAILURE;</span>
<a href="#l17.659"></a><span id="l17.659">     }</span>
<a href="#l17.660"></a><span id="l17.660"> </span>
<a href="#l17.661"></a><span id="l17.661" class="difflineminus">-    // if urlFilter is unset (or set to the default &quot;objectclass=*&quot;), there's</span>
<a href="#l17.662"></a><span id="l17.662" class="difflineminus">-    // no need to AND in an empty search term, so leave prefix and suffix empty</span>
<a href="#l17.663"></a><span id="l17.663" class="difflineminus">-    //</span>
<a href="#l17.664"></a><span id="l17.664" class="difflineplus">+    // If urlFilter is unset (or set to the default &quot;objectclass=*&quot;), there's</span>
<a href="#l17.665"></a><span id="l17.665" class="difflineplus">+    // no need to AND in an empty search term, so leave prefix and suffix empty.</span>
<a href="#l17.666"></a><span id="l17.666">     nsCAutoString prefix, suffix;</span>
<a href="#l17.667"></a><span id="l17.667">     if (urlFilter.Length() &amp;&amp; !urlFilter.Equals(NS_LITERAL_CSTRING(&quot;(objectclass=*)&quot;))) {</span>
<a href="#l17.668"></a><span id="l17.668"> </span>
<a href="#l17.669"></a><span id="l17.669" class="difflineminus">-        // if urlFilter isn't parenthesized, we need to add in parens so that</span>
<a href="#l17.670"></a><span id="l17.670" class="difflineplus">+        // If urlFilter isn't parenthesized, we need to add in parens so that</span>
<a href="#l17.671"></a><span id="l17.671">         // the filter works as a term to &amp;</span>
<a href="#l17.672"></a><span id="l17.672" class="difflineminus">-        //</span>
<a href="#l17.673"></a><span id="l17.673">         if (urlFilter[0] != '(') {</span>
<a href="#l17.674"></a><span id="l17.674">             prefix.AssignLiteral(&quot;(&amp;(&quot;);</span>
<a href="#l17.675"></a><span id="l17.675">             prefix.Append(urlFilter);</span>
<a href="#l17.676"></a><span id="l17.676">             prefix.AppendLiteral(&quot;)&quot;);</span>
<a href="#l17.677"></a><span id="l17.677">         } else {</span>
<a href="#l17.678"></a><span id="l17.678">             prefix.AssignLiteral(&quot;(&amp;&quot;);</span>
<a href="#l17.679"></a><span id="l17.679">             prefix.Append(urlFilter);</span>
<a href="#l17.680"></a><span id="l17.680">         }</span>
<a href="#l17.681"></a><span id="l17.681">         </span>
<a href="#l17.682"></a><span id="l17.682">         suffix = ')';</span>
<a href="#l17.683"></a><span id="l17.683">     }</span>
<a href="#l17.684"></a><span id="l17.684"> </span>
<a href="#l17.685"></a><span id="l17.685" class="difflineminus">-    // generate an LDAP search filter from mFilterTemplate.  If it's unset,</span>
<a href="#l17.686"></a><span id="l17.686" class="difflineplus">+    // Generate an LDAP search filter from mFilterTemplate. If it's unset,</span>
<a href="#l17.687"></a><span id="l17.687">     // use the default.</span>
<a href="#l17.688"></a><span id="l17.688" class="difflineminus">-    //</span>
<a href="#l17.689"></a><span id="l17.689"> #define MAX_AUTOCOMPLETE_FILTER_SIZE 1024</span>
<a href="#l17.690"></a><span id="l17.690">     nsCAutoString searchFilter;</span>
<a href="#l17.691"></a><span id="l17.691">     rv = ldapSvc-&gt;CreateFilter(MAX_AUTOCOMPLETE_FILTER_SIZE,</span>
<a href="#l17.692"></a><span id="l17.692">                                mFilterTemplate,</span>
<a href="#l17.693"></a><span id="l17.693">                                prefix, suffix, EmptyCString(), </span>
<a href="#l17.694"></a><span id="l17.694">                                NS_ConvertUTF16toUTF8(mSearchString),</span>
<a href="#l17.695"></a><span id="l17.695">                                searchFilter);</span>
<a href="#l17.696"></a><span id="l17.696">     if (NS_FAILED(rv)) {</span>
<a href="#l17.697"></a><span id="l17.697" class="difflineat">@@ -728,62 +691,57 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.698"></a><span id="l17.698">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv,</span>
<a href="#l17.699"></a><span id="l17.699">                                      BOUND);</span>
<a href="#l17.700"></a><span id="l17.700">             return rv;</span>
<a href="#l17.701"></a><span id="l17.701"> </span>
<a href="#l17.702"></a><span id="l17.702">         case NS_ERROR_INVALID_ARG:</span>
<a href="#l17.703"></a><span id="l17.703">         case NS_ERROR_UNEXPECTED:</span>
<a href="#l17.704"></a><span id="l17.704">         default:</span>
<a href="#l17.705"></a><span id="l17.705"> </span>
<a href="#l17.706"></a><span id="l17.706" class="difflineminus">-            // all this stuff indicates code bugs</span>
<a href="#l17.707"></a><span id="l17.707" class="difflineminus">-            //</span>
<a href="#l17.708"></a><span id="l17.708" class="difflineplus">+            // All this stuff indicates code bugs.</span>
<a href="#l17.709"></a><span id="l17.709">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): &quot;</span>
<a href="#l17.710"></a><span id="l17.710">                      &quot;createFilter returned unexpected value&quot;);</span>
<a href="#l17.711"></a><span id="l17.711">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.712"></a><span id="l17.712">                                      BOUND);</span>
<a href="#l17.713"></a><span id="l17.713">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.714"></a><span id="l17.714">         }</span>
<a href="#l17.715"></a><span id="l17.715"> </span>
<a href="#l17.716"></a><span id="l17.716">     }</span>
<a href="#l17.717"></a><span id="l17.717"> </span>
<a href="#l17.718"></a><span id="l17.718">     // If the results array for this search hasn't already been created, do</span>
<a href="#l17.719"></a><span id="l17.719" class="difflineminus">-    // so now.  Note that we don't return ::failureItems here, because if</span>
<a href="#l17.720"></a><span id="l17.720" class="difflineplus">+    // so now. Note that we don't return ::failureItems here, because if</span>
<a href="#l17.721"></a><span id="l17.721">     // there's no array, there's nowhere to put the items.</span>
<a href="#l17.722"></a><span id="l17.722" class="difflineminus">-    //</span>
<a href="#l17.723"></a><span id="l17.723">     rv = CreateResultsArray();</span>
<a href="#l17.724"></a><span id="l17.724">     if (NS_FAILED(rv)) {</span>
<a href="#l17.725"></a><span id="l17.725">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failed, rv, BOUND);</span>
<a href="#l17.726"></a><span id="l17.726">     }</span>
<a href="#l17.727"></a><span id="l17.727"> </span>
<a href="#l17.728"></a><span id="l17.728" class="difflineminus">-    // nothing returned yet!</span>
<a href="#l17.729"></a><span id="l17.729" class="difflineminus">-    //</span>
<a href="#l17.730"></a><span id="l17.730" class="difflineplus">+    // Nothing returned yet!</span>
<a href="#l17.731"></a><span id="l17.731">     mEntriesReturned = 0;</span>
<a href="#l17.732"></a><span id="l17.732">     </span>
<a href="#l17.733"></a><span id="l17.733" class="difflineminus">-    // get the base dn to search</span>
<a href="#l17.734"></a><span id="l17.734" class="difflineminus">-    //</span>
<a href="#l17.735"></a><span id="l17.735" class="difflineplus">+    // Get the base dn to search</span>
<a href="#l17.736"></a><span id="l17.736">     nsCAutoString dn;</span>
<a href="#l17.737"></a><span id="l17.737">     rv = mDirectoryUrl-&gt;GetDn(dn);</span>
<a href="#l17.738"></a><span id="l17.738">     if ( NS_FAILED(rv) ){</span>
<a href="#l17.739"></a><span id="l17.739">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv,</span>
<a href="#l17.740"></a><span id="l17.740">                                  BOUND);</span>
<a href="#l17.741"></a><span id="l17.741">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.742"></a><span id="l17.742">     }</span>
<a href="#l17.743"></a><span id="l17.743"> </span>
<a href="#l17.744"></a><span id="l17.744" class="difflineminus">-    // and the scope</span>
<a href="#l17.745"></a><span id="l17.745" class="difflineminus">-    //</span>
<a href="#l17.746"></a><span id="l17.746" class="difflineplus">+    // And the scope</span>
<a href="#l17.747"></a><span id="l17.747">     PRInt32 scope;</span>
<a href="#l17.748"></a><span id="l17.748">     rv = mDirectoryUrl-&gt;GetScope(&amp;scope);</span>
<a href="#l17.749"></a><span id="l17.749">     if ( NS_FAILED(rv) ){</span>
<a href="#l17.750"></a><span id="l17.750">         mState = BOUND;</span>
<a href="#l17.751"></a><span id="l17.751">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.752"></a><span id="l17.752">                                  BOUND);</span>
<a href="#l17.753"></a><span id="l17.753">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.754"></a><span id="l17.754">     }</span>
<a href="#l17.755"></a><span id="l17.755"> </span>
<a href="#l17.756"></a><span id="l17.756" class="difflineminus">-    // take the relevant controls on this object and set them</span>
<a href="#l17.757"></a><span id="l17.757" class="difflineplus">+    // Take the relevant controls on this object and set them</span>
<a href="#l17.758"></a><span id="l17.758">     // on the operation</span>
<a href="#l17.759"></a><span id="l17.759">     rv = mOperation-&gt;SetServerControls(mSearchServerControls.get());</span>
<a href="#l17.760"></a><span id="l17.760">     if ( NS_FAILED(rv) ){</span>
<a href="#l17.761"></a><span id="l17.761">         mState = BOUND;</span>
<a href="#l17.762"></a><span id="l17.762">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.763"></a><span id="l17.763">                                  BOUND);</span>
<a href="#l17.764"></a><span id="l17.764">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.765"></a><span id="l17.765">     }</span>
<a href="#l17.766"></a><span id="l17.766" class="difflineat">@@ -791,17 +749,17 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.767"></a><span id="l17.767">     rv = mOperation-&gt;SetClientControls(mSearchClientControls.get());</span>
<a href="#l17.768"></a><span id="l17.768">     if ( NS_FAILED(rv) ){</span>
<a href="#l17.769"></a><span id="l17.769">         mState = BOUND;</span>
<a href="#l17.770"></a><span id="l17.770">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.771"></a><span id="l17.771">                                  BOUND);</span>
<a href="#l17.772"></a><span id="l17.772">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.773"></a><span id="l17.773">     }</span>
<a href="#l17.774"></a><span id="l17.774"> </span>
<a href="#l17.775"></a><span id="l17.775" class="difflineminus">-    // time to kick off the search.</span>
<a href="#l17.776"></a><span id="l17.776" class="difflineplus">+    // Time to kick off the search.</span>
<a href="#l17.777"></a><span id="l17.777">     //</span>
<a href="#l17.778"></a><span id="l17.778">     // XXXdmose what about timeouts? </span>
<a href="#l17.779"></a><span id="l17.779">     //</span>
<a href="#l17.780"></a><span id="l17.780">     rv = mOperation-&gt;SearchExt(dn, scope, searchFilter, mSearchAttrsSize,</span>
<a href="#l17.781"></a><span id="l17.781">                                const_cast&lt;const char **&gt;(mSearchAttrs),</span>
<a href="#l17.782"></a><span id="l17.782">                                0, mMaxHits);</span>
<a href="#l17.783"></a><span id="l17.783">     if (NS_FAILED(rv)) {</span>
<a href="#l17.784"></a><span id="l17.784">         switch(rv) {</span>
<a href="#l17.785"></a><span id="l17.785" class="difflineat">@@ -818,18 +776,18 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.786"></a><span id="l17.786">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.787"></a><span id="l17.787">                    (&quot;nsLDAPAutoCompleteSession::DoTask(): SearchExt &quot;</span>
<a href="#l17.788"></a><span id="l17.788">                     &quot;returned NS_ERROR_LDAP_FILTER_ERROR&quot;));</span>
<a href="#l17.789"></a><span id="l17.789">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.790"></a><span id="l17.790">                                      BOUND);</span>
<a href="#l17.791"></a><span id="l17.791">             return NS_OK;</span>
<a href="#l17.792"></a><span id="l17.792"> </span>
<a href="#l17.793"></a><span id="l17.793">         case NS_ERROR_LDAP_SERVER_DOWN:</span>
<a href="#l17.794"></a><span id="l17.794" class="difflineminus">-            // XXXdmose discuss with leif how to handle this in general in the </span>
<a href="#l17.795"></a><span id="l17.795" class="difflineminus">-            // LDAP XPCOM SDK.  </span>
<a href="#l17.796"></a><span id="l17.796" class="difflineplus">+            // XXXdmose discuss with leif how to handle this in general in the</span>
<a href="#l17.797"></a><span id="l17.797" class="difflineplus">+            // LDAP XPCOM SDK.</span>
<a href="#l17.798"></a><span id="l17.798"> </span>
<a href="#l17.799"></a><span id="l17.799">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.800"></a><span id="l17.800">                    (&quot;nsLDAPAutoCompleteSession::DoTask(): SearchExt &quot;</span>
<a href="#l17.801"></a><span id="l17.801">                     &quot;returned NS_ERROR_LDAP_SERVER_DOWN&quot;));</span>
<a href="#l17.802"></a><span id="l17.802">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv,</span>
<a href="#l17.803"></a><span id="l17.803">                                      UNBOUND);</span>
<a href="#l17.804"></a><span id="l17.804">             return NS_OK;</span>
<a href="#l17.805"></a><span id="l17.805"> </span>
<a href="#l17.806"></a><span id="l17.806" class="difflineat">@@ -838,18 +796,17 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.807"></a><span id="l17.807">                                      BOUND);</span>
<a href="#l17.808"></a><span id="l17.808">             return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l17.809"></a><span id="l17.809"> </span>
<a href="#l17.810"></a><span id="l17.810">         case NS_ERROR_LDAP_NOT_SUPPORTED:</span>
<a href="#l17.811"></a><span id="l17.811">         case NS_ERROR_NOT_INITIALIZED:        </span>
<a href="#l17.812"></a><span id="l17.812">         case NS_ERROR_INVALID_ARG:</span>
<a href="#l17.813"></a><span id="l17.813">         default:</span>
<a href="#l17.814"></a><span id="l17.814"> </span>
<a href="#l17.815"></a><span id="l17.815" class="difflineminus">-            // all this stuff indicates code bugs</span>
<a href="#l17.816"></a><span id="l17.816" class="difflineminus">-            //</span>
<a href="#l17.817"></a><span id="l17.817" class="difflineplus">+            // All this stuff indicates code bugs.</span>
<a href="#l17.818"></a><span id="l17.818">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask(): SearchExt &quot;</span>
<a href="#l17.819"></a><span id="l17.819">                      &quot;returned unexpected value&quot;);</span>
<a href="#l17.820"></a><span id="l17.820">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.821"></a><span id="l17.821">                                      BOUND);</span>
<a href="#l17.822"></a><span id="l17.822">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.823"></a><span id="l17.823">         }</span>
<a href="#l17.824"></a><span id="l17.824">     }</span>
<a href="#l17.825"></a><span id="l17.825"> </span>
<a href="#l17.826"></a><span id="l17.826" class="difflineat">@@ -861,42 +818,39 @@ nsLDAPAutoCompleteSession::DoTask()</span>
<a href="#l17.827"></a><span id="l17.827"> nsresult</span>
<a href="#l17.828"></a><span id="l17.828"> nsLDAPAutoCompleteSession::InitConnection()</span>
<a href="#l17.829"></a><span id="l17.829"> {</span>
<a href="#l17.830"></a><span id="l17.830">     nsresult rv;        // temp for xpcom return values</span>
<a href="#l17.831"></a><span id="l17.831">     nsCOMPtr&lt;nsILDAPMessageListener&gt; selfProxy;</span>
<a href="#l17.832"></a><span id="l17.832">     </span>
<a href="#l17.833"></a><span id="l17.833">     NS_ASSERTION(!mConnection, &quot;in InitConnection w/ existing connection&quot;);</span>
<a href="#l17.834"></a><span id="l17.834"> </span>
<a href="#l17.835"></a><span id="l17.835" class="difflineminus">-    // create an LDAP connection</span>
<a href="#l17.836"></a><span id="l17.836" class="difflineminus">-    //</span>
<a href="#l17.837"></a><span id="l17.837" class="difflineplus">+    // Create an LDAP connection</span>
<a href="#l17.838"></a><span id="l17.838">     nsCOMPtr&lt;nsILDAPConnection&gt; connection =</span>
<a href="#l17.839"></a><span id="l17.839">       do_CreateInstance(&quot;@mozilla.org/network/ldap-connection;1&quot;, &amp;rv);</span>
<a href="#l17.840"></a><span id="l17.840">     if (NS_FAILED(rv)) {</span>
<a href="#l17.841"></a><span id="l17.841">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::InitConnection(): could &quot;</span>
<a href="#l17.842"></a><span id="l17.842">                  &quot;not create @mozilla.org/network/ldap-connection;1&quot;);</span>
<a href="#l17.843"></a><span id="l17.843">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.844"></a><span id="l17.844">                                  UNBOUND);</span>
<a href="#l17.845"></a><span id="l17.845">         return NS_ERROR_FAILURE;</span>
<a href="#l17.846"></a><span id="l17.846">     }</span>
<a href="#l17.847"></a><span id="l17.847"> </span>
<a href="#l17.848"></a><span id="l17.848">     NS_ADDREF(mConnection = connection);</span>
<a href="#l17.849"></a><span id="l17.849"> </span>
<a href="#l17.850"></a><span id="l17.850" class="difflineminus">-    // have we been properly initialized?</span>
<a href="#l17.851"></a><span id="l17.851" class="difflineminus">-    //</span>
<a href="#l17.852"></a><span id="l17.852" class="difflineplus">+    // Have we been properly initialized?</span>
<a href="#l17.853"></a><span id="l17.853">     if (!mDirectoryUrl) {</span>
<a href="#l17.854"></a><span id="l17.854">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::InitConnection(): mDirectoryUrl &quot;</span>
<a href="#l17.855"></a><span id="l17.855">                  &quot;is NULL&quot;);</span>
<a href="#l17.856"></a><span id="l17.856">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.857"></a><span id="l17.857">                                  UNBOUND);</span>
<a href="#l17.858"></a><span id="l17.858">         return NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.859"></a><span id="l17.859">     }</span>
<a href="#l17.860"></a><span id="l17.860"> </span>
<a href="#l17.861"></a><span id="l17.861" class="difflineminus">-    // get a proxy object so the callback happens on the main thread</span>
<a href="#l17.862"></a><span id="l17.862" class="difflineminus">-    //</span>
<a href="#l17.863"></a><span id="l17.863" class="difflineplus">+    // Get a proxy object so the callback happens on the main thread.</span>
<a href="#l17.864"></a><span id="l17.864">     nsCOMPtr&lt;nsIProxyObjectManager&gt; proxyObjMgr = do_GetService(NS_XPCOMPROXY_CONTRACTID, &amp;rv);</span>
<a href="#l17.865"></a><span id="l17.865">     if (NS_FAILED(rv)) {</span>
<a href="#l17.866"></a><span id="l17.866">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, UNBOUND);</span>
<a href="#l17.867"></a><span id="l17.867">         return NS_ERROR_FAILURE;</span>
<a href="#l17.868"></a><span id="l17.868">     }</span>
<a href="#l17.869"></a><span id="l17.869">     rv = proxyObjMgr-&gt;GetProxyForObject(NS_PROXY_TO_MAIN_THREAD, </span>
<a href="#l17.870"></a><span id="l17.870">                               NS_GET_IID(nsILDAPMessageListener), </span>
<a href="#l17.871"></a><span id="l17.871">                               static_cast&lt;nsILDAPMessageListener *&gt;(this), </span>
<a href="#l17.872"></a><span id="l17.872" class="difflineat">@@ -908,17 +862,16 @@ nsLDAPAutoCompleteSession::InitConnectio</span>
<a href="#l17.873"></a><span id="l17.873">         FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.874"></a><span id="l17.874">                                  UNBOUND);</span>
<a href="#l17.875"></a><span id="l17.875">         return NS_ERROR_FAILURE;</span>
<a href="#l17.876"></a><span id="l17.876">     }</span>
<a href="#l17.877"></a><span id="l17.877"> </span>
<a href="#l17.878"></a><span id="l17.878">     // Initialize the connection. This will cause an asynchronous DNS</span>
<a href="#l17.879"></a><span id="l17.879">     // lookup to occur, and we'll finish the binding of the connection</span>
<a href="#l17.880"></a><span id="l17.880">     // in the OnLDAPInit() listener function.</span>
<a href="#l17.881"></a><span id="l17.881" class="difflineminus">-    //</span>
<a href="#l17.882"></a><span id="l17.882">     rv = mConnection-&gt;Init(mDirectoryUrl, mLogin, selfProxy, nsnull, mVersion);</span>
<a href="#l17.883"></a><span id="l17.883">     if (NS_FAILED(rv)) {</span>
<a href="#l17.884"></a><span id="l17.884">         switch (rv) {</span>
<a href="#l17.885"></a><span id="l17.885"> </span>
<a href="#l17.886"></a><span id="l17.886">         case NS_ERROR_OUT_OF_MEMORY:</span>
<a href="#l17.887"></a><span id="l17.887">         case NS_ERROR_NOT_AVAILABLE:</span>
<a href="#l17.888"></a><span id="l17.888">         case NS_ERROR_FAILURE:</span>
<a href="#l17.889"></a><span id="l17.889">             PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.890"></a><span id="l17.890" class="difflineat">@@ -931,51 +884,47 @@ nsLDAPAutoCompleteSession::InitConnectio</span>
<a href="#l17.891"></a><span id="l17.891">         case NS_ERROR_ILLEGAL_VALUE:</span>
<a href="#l17.892"></a><span id="l17.892">         default:</span>
<a href="#l17.893"></a><span id="l17.893">             FinishAutoCompleteLookup(nsIAutoCompleteStatus::failureItems, rv, </span>
<a href="#l17.894"></a><span id="l17.894">                                      UNBOUND);</span>
<a href="#l17.895"></a><span id="l17.895">             return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.896"></a><span id="l17.896">         }</span>
<a href="#l17.897"></a><span id="l17.897">     }</span>
<a href="#l17.898"></a><span id="l17.898"> </span>
<a href="#l17.899"></a><span id="l17.899" class="difflineminus">-    // set our state</span>
<a href="#l17.900"></a><span id="l17.900" class="difflineminus">-    //</span>
<a href="#l17.901"></a><span id="l17.901" class="difflineplus">+    // Set our state</span>
<a href="#l17.902"></a><span id="l17.902">     mState = INITIALIZING;</span>
<a href="#l17.903"></a><span id="l17.903"> </span>
<a href="#l17.904"></a><span id="l17.904">     return NS_OK;</span>
<a href="#l17.905"></a><span id="l17.905"> }</span>
<a href="#l17.906"></a><span id="l17.906"> </span>
<a href="#l17.907"></a><span id="l17.907"> nsresult</span>
<a href="#l17.908"></a><span id="l17.908"> nsLDAPAutoCompleteSession::CreateResultsArray(void)</span>
<a href="#l17.909"></a><span id="l17.909"> {</span>
<a href="#l17.910"></a><span id="l17.910">     nsresult rv;</span>
<a href="#l17.911"></a><span id="l17.911"> </span>
<a href="#l17.912"></a><span id="l17.912" class="difflineminus">-    // create a result set</span>
<a href="#l17.913"></a><span id="l17.913" class="difflineminus">-    //</span>
<a href="#l17.914"></a><span id="l17.914" class="difflineplus">+    // Create a result set</span>
<a href="#l17.915"></a><span id="l17.915">     mResults = do_CreateInstance(NS_AUTOCOMPLETERESULTS_CONTRACTID, &amp;rv);</span>
<a href="#l17.916"></a><span id="l17.916"> </span>
<a href="#l17.917"></a><span id="l17.917">     if (NS_FAILED(rv)) {</span>
<a href="#l17.918"></a><span id="l17.918">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask() couldn't&quot;</span>
<a href="#l17.919"></a><span id="l17.919">                  &quot; create &quot; NS_AUTOCOMPLETERESULTS_CONTRACTID);</span>
<a href="#l17.920"></a><span id="l17.920">         return NS_ERROR_FAILURE;</span>
<a href="#l17.921"></a><span id="l17.921">     }</span>
<a href="#l17.922"></a><span id="l17.922"> </span>
<a href="#l17.923"></a><span id="l17.923">     // This seems to be necessary for things to work, though I'm not sure</span>
<a href="#l17.924"></a><span id="l17.924">     // why that's true.</span>
<a href="#l17.925"></a><span id="l17.925" class="difflineminus">-    //</span>
<a href="#l17.926"></a><span id="l17.926">     rv = mResults-&gt;SetSearchString(mSearchString.get());</span>
<a href="#l17.927"></a><span id="l17.927">     if (NS_FAILED(rv)) {</span>
<a href="#l17.928"></a><span id="l17.928">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::OnLDAPSearchResult(): couldn't &quot;</span>
<a href="#l17.929"></a><span id="l17.929">                  &quot;set search string in results object&quot;);</span>
<a href="#l17.930"></a><span id="l17.930">         return NS_ERROR_FAILURE;</span>
<a href="#l17.931"></a><span id="l17.931">     }</span>
<a href="#l17.932"></a><span id="l17.932"> </span>
<a href="#l17.933"></a><span id="l17.933" class="difflineminus">-    // get a pointer to the array in question now, so that we don't have to</span>
<a href="#l17.934"></a><span id="l17.934" class="difflineminus">-    // keep re-fetching it every time an entry callback happens</span>
<a href="#l17.935"></a><span id="l17.935" class="difflineminus">-    //</span>
<a href="#l17.936"></a><span id="l17.936" class="difflineplus">+    // Get a pointer to the array in question now, so that we don't have to</span>
<a href="#l17.937"></a><span id="l17.937" class="difflineplus">+    // keep re-fetching it every time an entry callback happens.</span>
<a href="#l17.938"></a><span id="l17.938">     rv = mResults-&gt;GetItems(getter_AddRefs(mResultsArray));</span>
<a href="#l17.939"></a><span id="l17.939">     if (NS_FAILED(rv)) {</span>
<a href="#l17.940"></a><span id="l17.940">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::DoTask() couldn't &quot;</span>
<a href="#l17.941"></a><span id="l17.941">                  &quot;get results array.&quot;);</span>
<a href="#l17.942"></a><span id="l17.942">         return NS_ERROR_FAILURE;</span>
<a href="#l17.943"></a><span id="l17.943">     }</span>
<a href="#l17.944"></a><span id="l17.944"> </span>
<a href="#l17.945"></a><span id="l17.945">     return NS_OK;</span>
<a href="#l17.946"></a><span id="l17.946" class="difflineat">@@ -984,115 +933,107 @@ nsLDAPAutoCompleteSession::CreateResults</span>
<a href="#l17.947"></a><span id="l17.947"> void</span>
<a href="#l17.948"></a><span id="l17.948"> nsLDAPAutoCompleteSession::FinishAutoCompleteLookup(</span>
<a href="#l17.949"></a><span id="l17.949">     AutoCompleteStatus aACStatus, const nsresult aResult,</span>
<a href="#l17.950"></a><span id="l17.950">     enum SessionState aEndState)</span>
<a href="#l17.951"></a><span id="l17.951"> {</span>
<a href="#l17.952"></a><span id="l17.952">     nsCOMPtr&lt;nsIAutoCompleteItem&gt; errorItem; // pointer to item we may create</span>
<a href="#l17.953"></a><span id="l17.953">     nsresult rv; // temp for return value </span>
<a href="#l17.954"></a><span id="l17.954"> </span>
<a href="#l17.955"></a><span id="l17.955" class="difflineminus">-    // if there's a listener, inform the listener that the search is over</span>
<a href="#l17.956"></a><span id="l17.956" class="difflineminus">-    //</span>
<a href="#l17.957"></a><span id="l17.957" class="difflineplus">+    // If there's a listener, inform the listener that the search is over.</span>
<a href="#l17.958"></a><span id="l17.958">     rv = NS_OK;</span>
<a href="#l17.959"></a><span id="l17.959">     if (mListener) {</span>
<a href="#l17.960"></a><span id="l17.960">         </span>
<a href="#l17.961"></a><span id="l17.961">         switch (aACStatus) {</span>
<a href="#l17.962"></a><span id="l17.962"> </span>
<a href="#l17.963"></a><span id="l17.963">         case nsIAutoCompleteStatus::matchFound:</span>
<a href="#l17.964"></a><span id="l17.964">             rv = mListener-&gt;OnAutoComplete(mResults, aACStatus);</span>
<a href="#l17.965"></a><span id="l17.965">             break;</span>
<a href="#l17.966"></a><span id="l17.966"> </span>
<a href="#l17.967"></a><span id="l17.967">         case nsIAutoCompleteStatus::failureItems:</span>
<a href="#l17.968"></a><span id="l17.968" class="difflineminus">-            // if the results array hasn't already been created, make one</span>
<a href="#l17.969"></a><span id="l17.969" class="difflineplus">+            // If the results array hasn't already been created, make one</span>
<a href="#l17.970"></a><span id="l17.970">             // to return the error message.  If there's an error, fallback</span>
<a href="#l17.971"></a><span id="l17.971">             // to ::failed</span>
<a href="#l17.972"></a><span id="l17.972" class="difflineminus">-            //</span>
<a href="#l17.973"></a><span id="l17.973">             if (!mResults) {</span>
<a href="#l17.974"></a><span id="l17.974">                 rv = CreateResultsArray();</span>
<a href="#l17.975"></a><span id="l17.975">                 if (NS_FAILED(rv)) {</span>
<a href="#l17.976"></a><span id="l17.976">                     NS_ERROR(&quot;nsLDAPAutoCompleteSession::&quot;</span>
<a href="#l17.977"></a><span id="l17.977">                              &quot;FinishAutoCompleteLookup():&quot;</span>
<a href="#l17.978"></a><span id="l17.978">                              &quot; CreateResultsArray() failed&quot;);</span>
<a href="#l17.979"></a><span id="l17.979">                     rv = mListener-&gt;OnAutoComplete(0, </span>
<a href="#l17.980"></a><span id="l17.980">                                                 nsIAutoCompleteStatus::failed);</span>
<a href="#l17.981"></a><span id="l17.981">                     break;</span>
<a href="#l17.982"></a><span id="l17.982">                 }</span>
<a href="#l17.983"></a><span id="l17.983">             }</span>
<a href="#l17.984"></a><span id="l17.984"> </span>
<a href="#l17.985"></a><span id="l17.985" class="difflineminus">-            // create the error item</span>
<a href="#l17.986"></a><span id="l17.986" class="difflineminus">-            //</span>
<a href="#l17.987"></a><span id="l17.987" class="difflineplus">+            // Create the error item.</span>
<a href="#l17.988"></a><span id="l17.988">             rv = mFormatter-&gt;FormatException(mState, aResult,</span>
<a href="#l17.989"></a><span id="l17.989">                                              getter_AddRefs(errorItem));</span>
<a href="#l17.990"></a><span id="l17.990">             if (NS_SUCCEEDED(rv)) {</span>
<a href="#l17.991"></a><span id="l17.991"> </span>
<a href="#l17.992"></a><span id="l17.992" class="difflineminus">-                // try and append the error item; falling back to ::failed</span>
<a href="#l17.993"></a><span id="l17.993" class="difflineminus">-                // if there's a problem </span>
<a href="#l17.994"></a><span id="l17.994" class="difflineplus">+                // Try and append the error item; falling back to ::failed</span>
<a href="#l17.995"></a><span id="l17.995" class="difflineplus">+                // if there's a problem.</span>
<a href="#l17.996"></a><span id="l17.996">                 //</span>
<a href="#l17.997"></a><span id="l17.997">                 rv = mResultsArray-&gt;AppendElement(errorItem);</span>
<a href="#l17.998"></a><span id="l17.998">                 if (NS_FAILED(rv)) {</span>
<a href="#l17.999"></a><span id="l17.999">                     NS_ERROR(&quot;nsLDAPAutoCompleteSession::&quot;</span>
<a href="#l17.1000"></a><span id="l17.1000">                              &quot;FinishAutoCompleteLookup():&quot;</span>
<a href="#l17.1001"></a><span id="l17.1001">                              &quot; mItems-&gt;AppendElement() failed&quot;);</span>
<a href="#l17.1002"></a><span id="l17.1002">                     rv = mListener-&gt;OnAutoComplete(0, </span>
<a href="#l17.1003"></a><span id="l17.1003">                                                 nsIAutoCompleteStatus::failed);</span>
<a href="#l17.1004"></a><span id="l17.1004">                     break;</span>
<a href="#l17.1005"></a><span id="l17.1005">                 } </span>
<a href="#l17.1006"></a><span id="l17.1006"> </span>
<a href="#l17.1007"></a><span id="l17.1007" class="difflineminus">-                // we don't want the autocomplete widget trying to </span>
<a href="#l17.1008"></a><span id="l17.1008" class="difflineminus">-                // automagically use the error item for anything.  If </span>
<a href="#l17.1009"></a><span id="l17.1009" class="difflineplus">+                // We don't want the autocomplete widget trying to</span>
<a href="#l17.1010"></a><span id="l17.1010" class="difflineplus">+                // automagically use the error item for anything. If</span>
<a href="#l17.1011"></a><span id="l17.1011">                 // something goes wrong here, continue on anyway.</span>
<a href="#l17.1012"></a><span id="l17.1012">                 //</span>
<a href="#l17.1013"></a><span id="l17.1013">                 (void)mResults-&gt;SetDefaultItemIndex(-1);</span>
<a href="#l17.1014"></a><span id="l17.1014"> </span>
<a href="#l17.1015"></a><span id="l17.1015">                 rv = mListener-&gt;OnAutoComplete(mResults, </span>
<a href="#l17.1016"></a><span id="l17.1016">                                           nsIAutoCompleteStatus::failureItems);</span>
<a href="#l17.1017"></a><span id="l17.1017">                 break;</span>
<a href="#l17.1018"></a><span id="l17.1018">             } </span>
<a href="#l17.1019"></a><span id="l17.1019"> </span>
<a href="#l17.1020"></a><span id="l17.1020" class="difflineminus">-            // fallback to ::failed</span>
<a href="#l17.1021"></a><span id="l17.1021" class="difflineplus">+            // Fallback to ::failed</span>
<a href="#l17.1022"></a><span id="l17.1022">             NS_ERROR(&quot;nsLDAPAutoCompleteSession::FinishAutoCompleteLookup(): &quot;</span>
<a href="#l17.1023"></a><span id="l17.1023">                      &quot;error calling FormatException()&quot;);</span>
<a href="#l17.1024"></a><span id="l17.1024"> </span>
<a href="#l17.1025"></a><span id="l17.1025">             rv = mListener-&gt;OnAutoComplete(0, nsIAutoCompleteStatus::failed);</span>
<a href="#l17.1026"></a><span id="l17.1026">             break;</span>
<a href="#l17.1027"></a><span id="l17.1027">         </span>
<a href="#l17.1028"></a><span id="l17.1028">         case nsIAutoCompleteStatus::failed:</span>
<a href="#l17.1029"></a><span id="l17.1029">         default:</span>
<a href="#l17.1030"></a><span id="l17.1030">             rv = mListener-&gt;OnAutoComplete(0, aACStatus);</span>
<a href="#l17.1031"></a><span id="l17.1031">             break;</span>
<a href="#l17.1032"></a><span id="l17.1032">         }</span>
<a href="#l17.1033"></a><span id="l17.1033"> </span>
<a href="#l17.1034"></a><span id="l17.1034">     } else {</span>
<a href="#l17.1035"></a><span id="l17.1035" class="difflineminus">-        // if there's no listener, something's wrong </span>
<a href="#l17.1036"></a><span id="l17.1036" class="difflineminus">-        // </span>
<a href="#l17.1037"></a><span id="l17.1037" class="difflineplus">+        // If there's no listener, something's wrong.</span>
<a href="#l17.1038"></a><span id="l17.1038">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::FinishAutoCompleteLookup(): &quot;</span>
<a href="#l17.1039"></a><span id="l17.1039">                  &quot;called with mListener unset!&quot;);</span>
<a href="#l17.1040"></a><span id="l17.1040">     }</span>
<a href="#l17.1041"></a><span id="l17.1041"> </span>
<a href="#l17.1042"></a><span id="l17.1042">     if (NS_FAILED(rv)) {</span>
<a href="#l17.1043"></a><span id="l17.1043"> </span>
<a href="#l17.1044"></a><span id="l17.1044" class="difflineminus">-        // there's nothing we can actually do here other than warn</span>
<a href="#l17.1045"></a><span id="l17.1045" class="difflineminus">-        //</span>
<a href="#l17.1046"></a><span id="l17.1046" class="difflineplus">+        // There's nothing we can actually do here other than warn.</span>
<a href="#l17.1047"></a><span id="l17.1047">         NS_WARNING(&quot;nsLDAPAutoCompleteSession::FinishAutoCompleteLookup(): &quot;</span>
<a href="#l17.1048"></a><span id="l17.1048">                    &quot;error calling mListener-&gt;OnAutoComplete()&quot;);</span>
<a href="#l17.1049"></a><span id="l17.1049">     }</span>
<a href="#l17.1050"></a><span id="l17.1050"> </span>
<a href="#l17.1051"></a><span id="l17.1051" class="difflineminus">-    // set the state appropriately</span>
<a href="#l17.1052"></a><span id="l17.1052" class="difflineminus">-    //</span>
<a href="#l17.1053"></a><span id="l17.1053" class="difflineplus">+    // Set the state appropriately.</span>
<a href="#l17.1054"></a><span id="l17.1054">     mState = aEndState;</span>
<a href="#l17.1055"></a><span id="l17.1055"> </span>
<a href="#l17.1056"></a><span id="l17.1056" class="difflineminus">-    // we're done with various things; cause nsCOMPtr to release them</span>
<a href="#l17.1057"></a><span id="l17.1057" class="difflineminus">-    //</span>
<a href="#l17.1058"></a><span id="l17.1058" class="difflineplus">+    // We're done with various things; cause nsCOMPtr to release them.</span>
<a href="#l17.1059"></a><span id="l17.1059">     mResultsArray = 0;</span>
<a href="#l17.1060"></a><span id="l17.1060">     mResults = 0;</span>
<a href="#l17.1061"></a><span id="l17.1061">     mListener = 0;</span>
<a href="#l17.1062"></a><span id="l17.1062">     mOperation = 0;</span>
<a href="#l17.1063"></a><span id="l17.1063"> </span>
<a href="#l17.1064"></a><span id="l17.1064" class="difflineminus">-    // If we are unbound, drop the connection (if any)</span>
<a href="#l17.1065"></a><span id="l17.1065" class="difflineminus">-    //</span>
<a href="#l17.1066"></a><span id="l17.1066" class="difflineplus">+    // If we are unbound, drop the connection (if any).</span>
<a href="#l17.1067"></a><span id="l17.1067">     if (mState == UNBOUND) {</span>
<a href="#l17.1068"></a><span id="l17.1068">         NS_IF_RELEASE(mConnection);</span>
<a href="#l17.1069"></a><span id="l17.1069">     }</span>
<a href="#l17.1070"></a><span id="l17.1070"> }</span>
<a href="#l17.1071"></a><span id="l17.1071"> </span>
<a href="#l17.1072"></a><span id="l17.1072"> // methods for nsILDAPAutoCompleteSession</span>
<a href="#l17.1073"></a><span id="l17.1073"> </span>
<a href="#l17.1074"></a><span id="l17.1074"> // attribute AUTF8String searchFilter;</span>
<a href="#l17.1075"></a><span id="l17.1075" class="difflineat">@@ -1150,23 +1091,22 @@ NS_IMETHODIMP</span>
<a href="#l17.1076"></a><span id="l17.1076"> nsLDAPAutoCompleteSession::SetServerURL(nsILDAPURL * aServerURL)</span>
<a href="#l17.1077"></a><span id="l17.1077"> {</span>
<a href="#l17.1078"></a><span id="l17.1078">     if (! aServerURL ) {</span>
<a href="#l17.1079"></a><span id="l17.1079">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l17.1080"></a><span id="l17.1080">     }</span>
<a href="#l17.1081"></a><span id="l17.1081"> </span>
<a href="#l17.1082"></a><span id="l17.1082">     mDirectoryUrl = aServerURL;</span>
<a href="#l17.1083"></a><span id="l17.1083"> </span>
<a href="#l17.1084"></a><span id="l17.1084" class="difflineminus">-    // the following line will cause the next call to OnStartLookup to </span>
<a href="#l17.1085"></a><span id="l17.1085" class="difflineminus">-    // call InitConnection again.  This will reinitialize all the relevant</span>
<a href="#l17.1086"></a><span id="l17.1086" class="difflineminus">-    // member variables and kick off an LDAP bind.  By virtue of the magic of </span>
<a href="#l17.1087"></a><span id="l17.1087" class="difflineplus">+    // The following line will cause the next call to OnStartLookup to</span>
<a href="#l17.1088"></a><span id="l17.1088" class="difflineplus">+    // call InitConnection again. This will reinitialize all the relevant</span>
<a href="#l17.1089"></a><span id="l17.1089" class="difflineplus">+    // member variables and kick off an LDAP bind. By virtue of the magic of</span>
<a href="#l17.1090"></a><span id="l17.1090">     // nsCOMPtrs, doing this will cause all the nsISupports-based stuff to</span>
<a href="#l17.1091"></a><span id="l17.1091">     // be Released, which will eventually result in the old connection being</span>
<a href="#l17.1092"></a><span id="l17.1092">     // destroyed, and the destructor for that calls ldap_unbind()</span>
<a href="#l17.1093"></a><span id="l17.1093" class="difflineminus">-    //</span>
<a href="#l17.1094"></a><span id="l17.1094">     mState = UNBOUND;</span>
<a href="#l17.1095"></a><span id="l17.1095"> </span>
<a href="#l17.1096"></a><span id="l17.1096">     return NS_OK;</span>
<a href="#l17.1097"></a><span id="l17.1097"> }</span>
<a href="#l17.1098"></a><span id="l17.1098"> </span>
<a href="#l17.1099"></a><span id="l17.1099"> // attribute unsigned long minStringLength</span>
<a href="#l17.1100"></a><span id="l17.1100"> NS_IMETHODIMP</span>
<a href="#l17.1101"></a><span id="l17.1101"> nsLDAPAutoCompleteSession::GetMinStringLength(PRUint32 *aMinStringLength)</span>
<a href="#l17.1102"></a><span id="l17.1102" class="difflineat">@@ -1200,54 +1140,49 @@ nsLDAPAutoCompleteSession::GetCjkMinStri</span>
<a href="#l17.1103"></a><span id="l17.1103"> NS_IMETHODIMP</span>
<a href="#l17.1104"></a><span id="l17.1104"> nsLDAPAutoCompleteSession::SetCjkMinStringLength(PRUint32 aCjkMinStringLength)</span>
<a href="#l17.1105"></a><span id="l17.1105"> {</span>
<a href="#l17.1106"></a><span id="l17.1106">     mCjkMinStringLength = aCjkMinStringLength;</span>
<a href="#l17.1107"></a><span id="l17.1107"> </span>
<a href="#l17.1108"></a><span id="l17.1108">     return NS_OK;</span>
<a href="#l17.1109"></a><span id="l17.1109"> }</span>
<a href="#l17.1110"></a><span id="l17.1110"> </span>
<a href="#l17.1111"></a><span id="l17.1111" class="difflineminus">-// check to see if the message returned is related to our current operation</span>
<a href="#l17.1112"></a><span id="l17.1112" class="difflineminus">-// if there is no current operation, it's not.  :-)</span>
<a href="#l17.1113"></a><span id="l17.1113" class="difflineminus">-//</span>
<a href="#l17.1114"></a><span id="l17.1114" class="difflineplus">+// Check to see if the message returned is related to our current operation</span>
<a href="#l17.1115"></a><span id="l17.1115" class="difflineplus">+// if there is no current operation, it's not. :-)</span>
<a href="#l17.1116"></a><span id="l17.1116"> nsresult </span>
<a href="#l17.1117"></a><span id="l17.1117"> nsLDAPAutoCompleteSession::IsMessageCurrent(nsILDAPMessage *aMessage, </span>
<a href="#l17.1118"></a><span id="l17.1118">                                             PRBool *aIsCurrent)</span>
<a href="#l17.1119"></a><span id="l17.1119"> {</span>
<a href="#l17.1120"></a><span id="l17.1120" class="difflineminus">-    // if there's no operation, this message must be stale (ie non-current)</span>
<a href="#l17.1121"></a><span id="l17.1121" class="difflineminus">-    //</span>
<a href="#l17.1122"></a><span id="l17.1122" class="difflineplus">+    // If there's no operation, this message must be stale (ie non-current).</span>
<a href="#l17.1123"></a><span id="l17.1123">     if ( !mOperation ) {</span>
<a href="#l17.1124"></a><span id="l17.1124">         *aIsCurrent = PR_FALSE;</span>
<a href="#l17.1125"></a><span id="l17.1125">         return NS_OK;</span>
<a href="#l17.1126"></a><span id="l17.1126">     }</span>
<a href="#l17.1127"></a><span id="l17.1127"> </span>
<a href="#l17.1128"></a><span id="l17.1128" class="difflineminus">-    // get the message id from the current operation</span>
<a href="#l17.1129"></a><span id="l17.1129" class="difflineminus">-    //</span>
<a href="#l17.1130"></a><span id="l17.1130" class="difflineplus">+    // Get the message id from the current operation.</span>
<a href="#l17.1131"></a><span id="l17.1131">     PRInt32 currentId;</span>
<a href="#l17.1132"></a><span id="l17.1132">     nsresult rv = mOperation-&gt;GetMessageID(&amp;currentId);</span>
<a href="#l17.1133"></a><span id="l17.1133">     if (NS_FAILED(rv)) {</span>
<a href="#l17.1134"></a><span id="l17.1134">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.1135"></a><span id="l17.1135">                (&quot;nsLDAPAutoCompleteSession::IsMessageCurrent(): unexpected &quot;</span>
<a href="#l17.1136"></a><span id="l17.1136">                 &quot;error 0x%lx calling mOperation-&gt;GetMessageId()&quot;, rv));</span>
<a href="#l17.1137"></a><span id="l17.1137">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.1138"></a><span id="l17.1138">     }</span>
<a href="#l17.1139"></a><span id="l17.1139"> </span>
<a href="#l17.1140"></a><span id="l17.1140" class="difflineminus">-    // get the message operation from the message</span>
<a href="#l17.1141"></a><span id="l17.1141" class="difflineminus">-    //</span>
<a href="#l17.1142"></a><span id="l17.1142" class="difflineplus">+    // Get the message operation from the message.</span>
<a href="#l17.1143"></a><span id="l17.1143">     nsCOMPtr&lt;nsILDAPOperation&gt; msgOp;</span>
<a href="#l17.1144"></a><span id="l17.1144">     rv = aMessage-&gt;GetOperation(getter_AddRefs(msgOp));</span>
<a href="#l17.1145"></a><span id="l17.1145">     if (NS_FAILED(rv)) {</span>
<a href="#l17.1146"></a><span id="l17.1146">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.1147"></a><span id="l17.1147">                (&quot;nsLDAPAutoCompleteSession::IsMessageCurrent(): unexpected &quot;</span>
<a href="#l17.1148"></a><span id="l17.1148">                 &quot;error 0x%lx calling aMessage-&gt;GetOperation()&quot;, rv));</span>
<a href="#l17.1149"></a><span id="l17.1149">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.1150"></a><span id="l17.1150">     }</span>
<a href="#l17.1151"></a><span id="l17.1151"> </span>
<a href="#l17.1152"></a><span id="l17.1152" class="difflineminus">-    // get the message operation id from the message operation</span>
<a href="#l17.1153"></a><span id="l17.1153" class="difflineminus">-    //</span>
<a href="#l17.1154"></a><span id="l17.1154" class="difflineplus">+    // Get the message operation id from the message operation.</span>
<a href="#l17.1155"></a><span id="l17.1155">     PRInt32 msgOpId;</span>
<a href="#l17.1156"></a><span id="l17.1156">     rv = msgOp-&gt;GetMessageID(&amp;msgOpId);</span>
<a href="#l17.1157"></a><span id="l17.1157">     if (NS_FAILED(rv)) {</span>
<a href="#l17.1158"></a><span id="l17.1158">         PR_LOG(sLDAPAutoCompleteLogModule, PR_LOG_DEBUG, </span>
<a href="#l17.1159"></a><span id="l17.1159">                (&quot;nsLDAPAutoCompleteSession::IsMessageCurrent(): unexpected &quot;</span>
<a href="#l17.1160"></a><span id="l17.1160">                 &quot;error 0x%lx calling msgOp-&gt;GetMessageId()&quot;, rv));</span>
<a href="#l17.1161"></a><span id="l17.1161">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l17.1162"></a><span id="l17.1162">     }</span>
<a href="#l17.1163"></a><span id="l17.1163" class="difflineat">@@ -1283,18 +1218,17 @@ nsLDAPAutoCompleteSession::SetFormatter(</span>
<a href="#l17.1164"></a><span id="l17.1164">     mFormatter = aFormatter;</span>
<a href="#l17.1165"></a><span id="l17.1165"> </span>
<a href="#l17.1166"></a><span id="l17.1166">     // Ensure any old data is freed if necessary.</span>
<a href="#l17.1167"></a><span id="l17.1167">     if (mSearchAttrs) {</span>
<a href="#l17.1168"></a><span id="l17.1168">         NS_FREE_XPCOM_ALLOCATED_POINTER_ARRAY(mSearchAttrsSize, mSearchAttrs);</span>
<a href="#l17.1169"></a><span id="l17.1169">         mSearchAttrs = nsnull;</span>
<a href="#l17.1170"></a><span id="l17.1170">     }</span>
<a href="#l17.1171"></a><span id="l17.1171"> </span>
<a href="#l17.1172"></a><span id="l17.1172" class="difflineminus">-    // get and cache the attributes that will be used to do lookups</span>
<a href="#l17.1173"></a><span id="l17.1173" class="difflineminus">-    //</span>
<a href="#l17.1174"></a><span id="l17.1174" class="difflineplus">+    // Get and cache the attributes that will be used to do lookups.</span>
<a href="#l17.1175"></a><span id="l17.1175">     nsresult rv = mFormatter-&gt;GetAttributes(&amp;mSearchAttrsSize, &amp;mSearchAttrs);</span>
<a href="#l17.1176"></a><span id="l17.1176">     if (NS_FAILED(rv)) {</span>
<a href="#l17.1177"></a><span id="l17.1177">         NS_ERROR(&quot;nsLDAPAutoCompleteSession::SetFormatter(): &quot;</span>
<a href="#l17.1178"></a><span id="l17.1178">                  &quot; mFormatter-&gt;GetAttributes failed&quot;);</span>
<a href="#l17.1179"></a><span id="l17.1179">         return NS_ERROR_FAILURE;</span>
<a href="#l17.1180"></a><span id="l17.1180">     }</span>
<a href="#l17.1181"></a><span id="l17.1181">     </span>
<a href="#l17.1182"></a><span id="l17.1182">     return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/addrbook/test/unit/test_collection.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l18.4"></a><span id="l18.4">  * nsIAbAddressCollecter::getCardFromAttribute if its kept.</span>
<a href="#l18.5"></a><span id="l18.5">  */</span>
<a href="#l18.6"></a><span id="l18.6"> </span>
<a href="#l18.7"></a><span id="l18.7"> const nsIAbPMF = Components.interfaces.nsIAbPreferMailFormat;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9"> // Source fields (emailHeader/mailFormat) and expected results for use for</span>
<a href="#l18.10"></a><span id="l18.10"> // testing the addition of new addresses to the database.</span>
<a href="#l18.11"></a><span id="l18.11"> //</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-// Note: these email addressess should be different to allow collecting an</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+// Note: these email addresses should be different to allow collecting an</span>
<a href="#l18.14"></a><span id="l18.14"> // address to add a different card each time.</span>
<a href="#l18.15"></a><span id="l18.15"> var addEmailChecks =</span>
<a href="#l18.16"></a><span id="l18.16">   // First 3 items aimed at basic collection and mail format.</span>
<a href="#l18.17"></a><span id="l18.17">   [ { emailHeader: &quot;test0@invalid.com&quot;,</span>
<a href="#l18.18"></a><span id="l18.18">       primaryEmail: &quot;test0@invalid.com&quot;,</span>
<a href="#l18.19"></a><span id="l18.19">       mailFormat: nsIAbPMF.unknown,</span>
<a href="#l18.20"></a><span id="l18.20">       displayName: &quot;&quot;,</span>
<a href="#l18.21"></a><span id="l18.21">       firstName: &quot;&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/public/nsIMessenger.idl</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/public/nsIMessenger.idl</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -89,34 +89,34 @@ interface nsIMessenger : nsISupports {</span>
<a href="#l19.4"></a><span id="l19.4">     void saveAttachmentToFile(in nsIFile aFile, in ACString aUrl, in ACString aMessageUri, </span>
<a href="#l19.5"></a><span id="l19.5">                               in ACString aContentType, in nsIUrlListener aListener);</span>
<a href="#l19.6"></a><span id="l19.6">     </span>
<a href="#l19.7"></a><span id="l19.7">     void detachAttachment(in string contentTpe, in string url, in string displayName, in string messageUri, in boolean saveFirst, [optional] in boolean withoutWarning);</span>
<a href="#l19.8"></a><span id="l19.8">     void detachAllAttachments(in unsigned long count, [array, size_is(count)] in string contentTypeArray,</span>
<a href="#l19.9"></a><span id="l19.9">                              [array, size_is(count)] in string urlArray, [array, size_is(count)] in string displayNameArray,</span>
<a href="#l19.10"></a><span id="l19.10">                              [array, size_is(count)] in string messageUriArray, in boolean saveFirst, [optional] in boolean withoutWarning);</span>
<a href="#l19.11"></a><span id="l19.11">     // saveAttachmentToFolder is used by the drag and drop code to drop an attachment to a destination folder</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-    // we need to return the actual file path (including the filename).</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+    // We need to return the actual file path (including the filename).</span>
<a href="#l19.14"></a><span id="l19.14">     nsILocalFile saveAttachmentToFolder(in ACString contentType, in ACString url, in ACString displayName, in ACString messageUri, in nsILocalFile aDestFolder);</span>
<a href="#l19.15"></a><span id="l19.15"> </span>
<a href="#l19.16"></a><span id="l19.16">     attribute boolean sendingUnsentMsgs;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18">     readonly attribute ACString lastDisplayedMessageUri;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">     nsIMsgMessageService messageServiceFromURI(in ACString aUri);</span>
<a href="#l19.21"></a><span id="l19.21">     nsIMsgDBHdr msgHdrFromURI(in ACString aUri);</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-    // for back forward history, we need a list of visited messages,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+    // For back forward history, we need a list of visited messages,</span>
<a href="#l19.24"></a><span id="l19.24">     // and where we are in the list.</span>
<a href="#l19.25"></a><span id="l19.25">     </span>
<a href="#l19.26"></a><span id="l19.26">     // aPos is relative to the current history cursor - 1 is forward, -1 is back.</span>
<a href="#l19.27"></a><span id="l19.27">     // Unfortunately, you must call this before navigating to this position,</span>
<a href="#l19.28"></a><span id="l19.28">     // because calling this has the side effect of making us adjust our current</span>
<a href="#l19.29"></a><span id="l19.29">     // history pos, and *not* adding the loaded message to the history queue.</span>
<a href="#l19.30"></a><span id="l19.30">     ACString getMsgUriAtNavigatePos(in long aPos);</span>
<a href="#l19.31"></a><span id="l19.31">     ACString getFolderUriAtNavigatePos(in long aPos);</span>
<a href="#l19.32"></a><span id="l19.32">     attribute long navigatePos;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-    // if caller just wants the count and cur pos, they can pass in a null history pointer, which will be more efficent</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    // If caller just wants the count and cur pos, they can pass in a null history pointer, which will be more efficient</span>
<a href="#l19.35"></a><span id="l19.35">     // if they want a list suitable for display in a back/forward menu drop down, they should pass in a aHistory pointer,</span>
<a href="#l19.36"></a><span id="l19.36">     // and they'll get returned an array with strings containing something like subject and sender of the message - </span>
<a href="#l19.37"></a><span id="l19.37">     // other possible info is the folder containing the message, and the preview text, if available.</span>
<a href="#l19.38"></a><span id="l19.38">     void getNavigateHistory(out unsigned long aCurPos, out unsigned long aCount, [array, size_is(aCount)] out string aHistory);</span>
<a href="#l19.39"></a><span id="l19.39"> };</span>
<a href="#l19.40"></a><span id="l19.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/public/nsIMessengerOSIntegration.idl</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/public/nsIMessengerOSIntegration.idl</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -36,12 +36,12 @@</span>
<a href="#l20.4"></a><span id="l20.4">  *</span>
<a href="#l20.5"></a><span id="l20.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsISupports.idl&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> </span>
<a href="#l20.9"></a><span id="l20.9"> [scriptable, uuid(d9e45fee-1dd1-11b2-938c-9147855ed837)]</span>
<a href="#l20.10"></a><span id="l20.10"> interface nsIMessengerOSIntegration : nsISupports {</span>
<a href="#l20.11"></a><span id="l20.11">   // for now, nothing.  it's up to the implementation to </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  // do all the work of registering itsself as listeners</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  // do all the work of registering itself as listeners</span>
<a href="#l20.14"></a><span id="l20.14">   // all we guarantee is your service will be created</span>
<a href="#l20.15"></a><span id="l20.15">   // when accounts are loaded by the account manager</span>
<a href="#l20.16"></a><span id="l20.16"> };</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

