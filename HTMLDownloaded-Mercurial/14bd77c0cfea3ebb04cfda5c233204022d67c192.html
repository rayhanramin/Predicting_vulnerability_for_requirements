<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7459:14bd77c0cfea3ebb04cfda5c233204022d67c192</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 14bd77c0cfea3ebb04cfda5c233204022d67c192" />
<meta property="og:url" content="/comm-central/rev/14bd77c0cfea3ebb04cfda5c233204022d67c192" />
<meta property="og:description" content="account creation wizard, guessConfig(), add POP3 option to result -- bug 560051, r=bwinton" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 14bd77c0cfea3ebb04cfda5c233204022d67c192 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/14bd77c0cfea3ebb04cfda5c233204022d67c192">shortlog</a> |
<a href="/comm-central/log/14bd77c0cfea3ebb04cfda5c233204022d67c192">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/14bd77c0cfea3ebb04cfda5c233204022d67c192">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/14bd77c0cfea3ebb04cfda5c233204022d67c192">files</a> |
changeset |
<a href="/comm-central/raw-rev/14bd77c0cfea3ebb04cfda5c233204022d67c192">raw</a>  | <a href="/comm-central/archive/14bd77c0cfea3ebb04cfda5c233204022d67c192.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
account creation wizard, guessConfig(), add POP3 option to result -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=560051">bug 560051</a>, r=bwinton
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 29 Mar 2011 16:05:45 +0200</td></tr>

<tr>
 <td>changeset 7459</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/14bd77c0cfea3ebb04cfda5c233204022d67c192">14bd77c0cfea3ebb04cfda5c233204022d67c192</a></td>
</tr>



<tr>
<td>parent 7458</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/66cac0e9d9d5ce7804bd168a6c1aea258e845026">66cac0e9d9d5ce7804bd168a6c1aea258e845026</a>
</td>
</tr>

<tr>
<td>child 7460</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cec7e6a809ad815d4f7e12bc6bb695e700a4c45e">cec7e6a809ad815d4f7e12bc6bb695e700a4c45e</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=14bd77c0cfea3ebb04cfda5c233204022d67c192">5721</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Tue, 29 Mar 2011 14:05:54 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@14bd77c0cfea [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=14bd77c0cfea3ebb04cfda5c233204022d67c192">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=14bd77c0cfea3ebb04cfda5c233204022d67c192&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&newProject=comm-central&newRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&newProject=comm-central&newRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&newProject=comm-central&newRevision=14bd77c0cfea3ebb04cfda5c233204022d67c192&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=560051">560051</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=532590">532590</a></td></tr>




</table></div>

<div class="page_body description">account creation wizard, guessConfig(), add POP3 option to result -- <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=560051">bug 560051</a>, r=bwinton

Situation:
Before this change, the guessConfig() function only returned the most
preferred server config, and we prefer IMAP over POP, so if we found
both IMAP and POP servers, we returned only the IMAP server.
In <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=532590">bug 532590</a>, we added the ability for the user to choose between IMAP and POP.
So far, we had this implemented for configs coming from ISPDB, but not for
guessed configs.

This change:
Now, we try to find both a POP and IMAP config, and if we do, we return them
both.

Result:
Thanks to the previous changes, they will be shown in the dialog,
the user can select either POP or IMAP, even if the config was guessed.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">mailnews/base/prefs/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/14bd77c0cfea3ebb04cfda5c233204022d67c192/mailnews/base/prefs/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -148,54 +148,75 @@ function guessConfig(domain, progressCal</span>
<a href="#l1.4"></a><span id="l1.4">         try {</span>
<a href="#l1.5"></a><span id="l1.5">           errorCallback(e);</span>
<a href="#l1.6"></a><span id="l1.6">         } catch (e) { errorInCallback(e); }</span>
<a href="#l1.7"></a><span id="l1.7">       }</span>
<a href="#l1.8"></a><span id="l1.8">       return;</span>
<a href="#l1.9"></a><span id="l1.9">     }</span>
<a href="#l1.10"></a><span id="l1.10">   };</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  var outgoingSuccess = function(thisTry)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  var logger = Log4Moz.getConfiguredLogger(&quot;mail.wizard&quot;);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+  var HostTryToAccountServer = function(thisTry, server)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+  {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    server.type = protocolToString(thisTry.protocol);</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+    server.hostname = thisTry.hostname;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+    server.port = thisTry.port;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    server.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    server.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    server.authAlternatives = thisTry.authMethods;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+    // TODO</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+    // cert is also bad when targetSite is set. (Same below for incoming.)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+    // Fix SSLErrorHandler and security warning dialog in emailWizard.js.</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+    server.badCert = thisTry.selfSignedCert;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+    server.targetSite = thisTry.targetSite;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    logger.info(&quot;CHOOSING &quot; + server.type + &quot; &quot;+ server.hostname + &quot;:&quot; +</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+          server.port + &quot;, auth method &quot; + server.auth + &quot; &quot; +</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+          server.authAlternatives.join(&quot;,&quot;) + &quot;, SSL &quot; + server.socketType +</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+          (server.badCert ? &quot; (bad cert!)&quot; : &quot;&quot;));</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  };</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  var outgoingSuccess = function(thisTry, alternativeTries)</span>
<a href="#l1.34"></a><span id="l1.34">   {</span>
<a href="#l1.35"></a><span id="l1.35">     assert(thisTry.protocol == SMTP, &quot;I only know SMTP for outgoing&quot;);</span>
<a href="#l1.36"></a><span id="l1.36">     // Ensure there are no previously saved outgoing errors, if we've got</span>
<a href="#l1.37"></a><span id="l1.37">     // success here.</span>
<a href="#l1.38"></a><span id="l1.38">     outgoingEx = null;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    resultConfig.outgoing.type = &quot;smtp&quot;;</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineminus">-    resultConfig.outgoing.hostname = thisTry.hostname;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineminus">-    resultConfig.outgoing.port = thisTry.port;</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineminus">-    resultConfig.outgoing.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    resultConfig.outgoing.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-    resultConfig.outgoing.authAlternatives = thisTry.authMethods;</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineminus">-    // TODO</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-    // cert is also bad when targetSite is set. (Same below for incoming.)</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineminus">-    // Fix SSLErrorHandler and security warning dialog in emailWizard.js.</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-    resultConfig.outgoing.badCert = thisTry.selfSignedCert;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-    resultConfig.outgoing.targetSite = thisTry.targetSite;</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+    HostTryToAccountServer(thisTry, resultConfig.outgoing);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    for each (let alternativeTry in alternativeTries)</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+    {</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+      // resultConfig.createNewOutgoing(); misses username etc., so copy</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+      let altServer = deepCopy(resultConfig.outgoing);</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+      HostTryToAccountServer(alternativeTry, altServer);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+      assert(resultConfig.outgoingAlternatives);</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+      resultConfig.outgoingAlternatives.push(altServer);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    }</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61">     progressCallback(resultConfig.outgoing.type,</span>
<a href="#l1.62"></a><span id="l1.62">         resultConfig.outgoing.hostname, resultConfig.outgoing.port,</span>
<a href="#l1.63"></a><span id="l1.63">         resultConfig.outgoing.socketType, true, resultConfig);</span>
<a href="#l1.64"></a><span id="l1.64">     outgoingDone = true;</span>
<a href="#l1.65"></a><span id="l1.65">     checkDone();</span>
<a href="#l1.66"></a><span id="l1.66">   };</span>
<a href="#l1.67"></a><span id="l1.67"> </span>
<a href="#l1.68"></a><span id="l1.68" class="difflineminus">-  var incomingSuccess = function(thisTry)</span>
<a href="#l1.69"></a><span id="l1.69" class="difflineplus">+  var incomingSuccess = function(thisTry, alternativeTries)</span>
<a href="#l1.70"></a><span id="l1.70">   {</span>
<a href="#l1.71"></a><span id="l1.71">     // Ensure there are no previously saved incoming errors, if we've got</span>
<a href="#l1.72"></a><span id="l1.72">     // success here.</span>
<a href="#l1.73"></a><span id="l1.73">     incomingEx = null;</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineminus">-    resultConfig.incoming.type = protocolToString(thisTry.protocol);</span>
<a href="#l1.75"></a><span id="l1.75" class="difflineminus">-    resultConfig.incoming.hostname = thisTry.hostname;</span>
<a href="#l1.76"></a><span id="l1.76" class="difflineminus">-    resultConfig.incoming.port = thisTry.port;</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-    resultConfig.incoming.socketType = sslConvertToSocketType(thisTry.ssl);</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-    resultConfig.incoming.auth = chooseBestAuthMethod(thisTry.authMethods);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-    resultConfig.incoming.authAlternatives = thisTry.authMethods;</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-    resultConfig.incoming.badCert = thisTry.selfSignedCert;</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-    resultConfig.incoming.targetSite = thisTry.targetSite;</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineplus">+    HostTryToAccountServer(thisTry, resultConfig.incoming);</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    for each (let alternativeTry in alternativeTries)</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+    {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+      // resultConfig.createNewIncoming(); misses username etc., so copy</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+      let altServer = deepCopy(resultConfig.incoming);</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineplus">+      HostTryToAccountServer(alternativeTry, altServer);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineplus">+      assert(resultConfig.incomingAlternatives);</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineplus">+      resultConfig.incomingAlternatives.push(altServer);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+    }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">     progressCallback(resultConfig.incoming.type,</span>
<a href="#l1.94"></a><span id="l1.94">         resultConfig.incoming.hostname, resultConfig.incoming.port,</span>
<a href="#l1.95"></a><span id="l1.95">         resultConfig.incoming.socketType, true, resultConfig);</span>
<a href="#l1.96"></a><span id="l1.96">     incomingDone = true;</span>
<a href="#l1.97"></a><span id="l1.97">     checkDone();</span>
<a href="#l1.98"></a><span id="l1.98">   };</span>
<a href="#l1.99"></a><span id="l1.99"> </span>
<a href="#l1.100"></a><span id="l1.100" class="difflineat">@@ -315,18 +336,21 @@ HostTry.prototype =</span>
<a href="#l1.101"></a><span id="l1.101"> function CancelOthersException()</span>
<a href="#l1.102"></a><span id="l1.102"> {</span>
<a href="#l1.103"></a><span id="l1.103">   CancelledException.call(this, &quot;we're done, cancelling the other probes&quot;);</span>
<a href="#l1.104"></a><span id="l1.104"> }</span>
<a href="#l1.105"></a><span id="l1.105"> CancelOthersException.prototype = {}</span>
<a href="#l1.106"></a><span id="l1.106"> extend(CancelOthersException, CancelledException);</span>
<a href="#l1.107"></a><span id="l1.107"> </span>
<a href="#l1.108"></a><span id="l1.108"> /**</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">- * @param successCallback {function(result {HostTry})}</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineplus">+ * @param successCallback {function(result {HostTry}, alts {Array of HostTry})}</span>
<a href="#l1.111"></a><span id="l1.111">  *    Called when the config is OK</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+ *    |result| is the most preferred server.</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineplus">+ *    |alts| currently exists only for |IncomingHostDetector| and contains</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineplus">+ *    some servers of the other type (POP3 instead of IMAP), if available.</span>
<a href="#l1.115"></a><span id="l1.115">  * @param errorCallback {function(ex)} Called when we could not find a config</span>
<a href="#l1.116"></a><span id="l1.116">  * @param progressCallback { function(server {HostTry}) } Called when we tried</span>
<a href="#l1.117"></a><span id="l1.117">  *    (will try?) a new hostname and port</span>
<a href="#l1.118"></a><span id="l1.118">  */</span>
<a href="#l1.119"></a><span id="l1.119"> function HostDetector(progressCallback, successCallback, errorCallback)</span>
<a href="#l1.120"></a><span id="l1.120"> {</span>
<a href="#l1.121"></a><span id="l1.121">   this.mSuccessCallback = successCallback;</span>
<a href="#l1.122"></a><span id="l1.122">   this.mProgressCallback = progressCallback;</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineat">@@ -515,39 +539,44 @@ HostDetector.prototype =</span>
<a href="#l1.124"></a><span id="l1.124">         &quot; ssl &quot; + thisTry.ssl +</span>
<a href="#l1.125"></a><span id="l1.125">         (thisTry.selfSignedCert ? &quot; (selfSignedCert)&quot; : &quot;&quot;));</span>
<a href="#l1.126"></a><span id="l1.126">     thisTry.status = kSuccess;</span>
<a href="#l1.127"></a><span id="l1.127">   },</span>
<a href="#l1.128"></a><span id="l1.128"> </span>
<a href="#l1.129"></a><span id="l1.129">   _checkFinished : function()</span>
<a href="#l1.130"></a><span id="l1.130">   {</span>
<a href="#l1.131"></a><span id="l1.131">     var successfulTry = null;</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineminus">-    var successfulTryNonSSL = null;</span>
<a href="#l1.133"></a><span id="l1.133" class="difflineplus">+    var successfulTryAlternative = null; // POP3</span>
<a href="#l1.134"></a><span id="l1.134">     var unfinishedBusiness = false;</span>
<a href="#l1.135"></a><span id="l1.135">     // this._hostsToTry is ordered by decreasing preference</span>
<a href="#l1.136"></a><span id="l1.136">     for (let i = 0; i &lt; this._hostsToTry.length; i++)</span>
<a href="#l1.137"></a><span id="l1.137">     {</span>
<a href="#l1.138"></a><span id="l1.138">       let thisTry = this._hostsToTry[i];</span>
<a href="#l1.139"></a><span id="l1.139">       if (thisTry.status == kNotTried || thisTry.status == kOngoing)</span>
<a href="#l1.140"></a><span id="l1.140">         unfinishedBusiness = true;</span>
<a href="#l1.141"></a><span id="l1.141">       // thisTry is good, and all higher preference tries failed, so use this</span>
<a href="#l1.142"></a><span id="l1.142">       else if (thisTry.status == kSuccess &amp;&amp; !unfinishedBusiness)</span>
<a href="#l1.143"></a><span id="l1.143">       {</span>
<a href="#l1.144"></a><span id="l1.144" class="difflineminus">-        successfulTry = thisTry;</span>
<a href="#l1.145"></a><span id="l1.145" class="difflineminus">-        break;</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineplus">+        if (!successfulTry)</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineplus">+        {</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+          successfulTry = thisTry;</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineplus">+          if (successfulTry.protocol == SMTP)</span>
<a href="#l1.150"></a><span id="l1.150" class="difflineplus">+            break;</span>
<a href="#l1.151"></a><span id="l1.151" class="difflineplus">+        }</span>
<a href="#l1.152"></a><span id="l1.152" class="difflineplus">+        else if (successfulTry.protocol != thisTry.protocol)</span>
<a href="#l1.153"></a><span id="l1.153" class="difflineplus">+        {</span>
<a href="#l1.154"></a><span id="l1.154" class="difflineplus">+          successfulTryAlternative = thisTry;</span>
<a href="#l1.155"></a><span id="l1.155" class="difflineplus">+          break;</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineplus">+        }</span>
<a href="#l1.157"></a><span id="l1.157">       }</span>
<a href="#l1.158"></a><span id="l1.158">     }</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineminus">-    if (successfulTry)</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    if (successfulTry &amp;&amp; (successfulTryAlternative || !unfinishedBusiness))</span>
<a href="#l1.161"></a><span id="l1.161">     {</span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-      this._log.info(&quot;CHOOSING &quot; + successfulTry.hostname + &quot;:&quot; +</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-          successfulTry.port + &quot; &quot; +</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-          protocolToString(successfulTry.protocol) + &quot; auth methods [&quot; +</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-          successfulTry.authMethods.join(&quot;,&quot;) + &quot;] ssl &quot; + successfulTry.ssl +</span>
<a href="#l1.166"></a><span id="l1.166" class="difflineminus">-          (successfulTry.selfSignedCert ? &quot; (selfSignedCert)&quot; : &quot;&quot;));</span>
<a href="#l1.167"></a><span id="l1.167" class="difflineminus">-      this.mSuccessCallback(successfulTry);</span>
<a href="#l1.168"></a><span id="l1.168" class="difflineplus">+      this.mSuccessCallback(successfulTry,</span>
<a href="#l1.169"></a><span id="l1.169" class="difflineplus">+          successfulTryAlternative ? [ successfulTryAlternative ] : []);</span>
<a href="#l1.170"></a><span id="l1.170">       this.cancel(new CancelOthersException());</span>
<a href="#l1.171"></a><span id="l1.171">     }</span>
<a href="#l1.172"></a><span id="l1.172">     else if (!unfinishedBusiness) // all failed</span>
<a href="#l1.173"></a><span id="l1.173">     {</span>
<a href="#l1.174"></a><span id="l1.174">       this._log.info(&quot;ran out of options&quot;);</span>
<a href="#l1.175"></a><span id="l1.175">       var errorMsg = getStringBundle(</span>
<a href="#l1.176"></a><span id="l1.176">           &quot;chrome://messenger/locale/accountCreationModel.properties&quot;)</span>
<a href="#l1.177"></a><span id="l1.177">           .GetStringFromName(&quot;cannot_find_server.error&quot;);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

