<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 27972:b65ea98044afd29e3161c05f2d762ef5ee9e58d2</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b65ea98044afd29e3161c05f2d762ef5ee9e58d2" />
<meta property="og:url" content="/comm-central/rev/b65ea98044afd29e3161c05f2d762ef5ee9e58d2" />
<meta property="og:description" content="Bug 1584808 - remove unused functions from ComposerCommands.js and editor.js. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b65ea98044afd29e3161c05f2d762ef5ee9e58d2 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">shortlog</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">files</a> |
changeset |
<a href="/comm-central/raw-rev/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">raw</a>  | <a href="/comm-central/archive/b65ea98044afd29e3161c05f2d762ef5ee9e58d2.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584808">Bug 1584808</a> - remove unused functions from ComposerCommands.js and editor.js. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#104;&#117;&#115;&#104;&#105;&#108;&#32;&#77;&#105;&#115;&#116;&#114;&#121;&#32;&#60;&#107;&#104;&#117;&#115;&#104;&#105;&#108;&#51;&#50;&#52;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 21 Oct 2019 11:24:38 +0200</td></tr>

<tr>
 <td>changeset 27972</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b65ea98044afd29e3161c05f2d762ef5ee9e58d2">b65ea98044afd29e3161c05f2d762ef5ee9e58d2</a></td>
</tr>



<tr>
<td>parent 27971</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/caa4039d835ac06a1e65a1b23f6951c92a7e3c73">caa4039d835ac06a1e65a1b23f6951c92a7e3c73</a>
</td>
</tr>

<tr>
<td>child 27973</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/1edda72532b435446b2a07bcb54f62039ebf506d">1edda72532b435446b2a07bcb54f62039ebf506d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b65ea98044afd29e3161c05f2d762ef5ee9e58d2">16585</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 21 Oct 2019 09:32:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b65ea98044af [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&newProject=comm-central&newRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&newProject=comm-central&newRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&newProject=comm-central&newRevision=b65ea98044afd29e3161c05f2d762ef5ee9e58d2&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584808">1584808</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1584808">Bug 1584808</a> - remove unused functions from ComposerCommands.js and editor.js. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">mail/components/compose/content/ComposerCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">file</a> |
<a href="/comm-central/annotate/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">annotate</a> |
<a href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">diff</a> |
<a href="/comm-central/comparison/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">comparison</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/ComposerCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">mail/components/compose/content/dialogs/EdDialogCommon.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">file</a> |
<a href="/comm-central/annotate/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">annotate</a> |
<a href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">diff</a> |
<a href="/comm-central/comparison/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">comparison</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/dialogs/EdDialogCommon.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">mail/components/compose/content/editor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">file</a> |
<a href="/comm-central/annotate/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">annotate</a> |
<a href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">diff</a> |
<a href="/comm-central/comparison/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">comparison</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">mail/components/compose/content/editorUtilities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">file</a> |
<a href="/comm-central/annotate/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">annotate</a> |
<a href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">diff</a> |
<a href="/comm-central/comparison/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">comparison</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/editorUtilities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">mail/components/compose/content/messengercompose.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">file</a> |
<a href="/comm-central/annotate/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">annotate</a> |
<a href="/comm-central/diff/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">diff</a> |
<a href="/comm-central/comparison/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">comparison</a> |
<a href="/comm-central/log/b65ea98044afd29e3161c05f2d762ef5ee9e58d2/mail/components/compose/content/messengercompose.xul">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/compose/content/ComposerCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/compose/content/ComposerCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -29,30 +29,24 @@ function SetupHTMLEditorCommands() {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   commandTable.registerCommand(&quot;cmd_renderedHTMLEnabler&quot;, nsDummyHTMLCommand);</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">   commandTable.registerCommand(&quot;cmd_listProperties&quot;, nsListPropertiesCommand);</span>
<a href="#l1.8"></a><span id="l1.8">   commandTable.registerCommand(&quot;cmd_colorProperties&quot;, nsColorPropertiesCommand);</span>
<a href="#l1.9"></a><span id="l1.9">   commandTable.registerCommand(&quot;cmd_increaseFontStep&quot;, nsIncreaseFontCommand);</span>
<a href="#l1.10"></a><span id="l1.10">   commandTable.registerCommand(&quot;cmd_decreaseFontStep&quot;, nsDecreaseFontCommand);</span>
<a href="#l1.11"></a><span id="l1.11">   commandTable.registerCommand(</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    &quot;cmd_advancedProperties&quot;,</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    nsAdvancedPropertiesCommand</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-  );</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-  commandTable.registerCommand(</span>
<a href="#l1.16"></a><span id="l1.16">     &quot;cmd_objectProperties&quot;,</span>
<a href="#l1.17"></a><span id="l1.17">     nsObjectPropertiesCommand</span>
<a href="#l1.18"></a><span id="l1.18">   );</span>
<a href="#l1.19"></a><span id="l1.19">   commandTable.registerCommand(</span>
<a href="#l1.20"></a><span id="l1.20">     &quot;cmd_removeNamedAnchors&quot;,</span>
<a href="#l1.21"></a><span id="l1.21">     nsRemoveNamedAnchorsCommand</span>
<a href="#l1.22"></a><span id="l1.22">   );</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_editLink&quot;, nsEditLinkCommand);</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_isindex&quot;, nsIsIndexCommand);</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+</span>
<a href="#l1.27"></a><span id="l1.27">   commandTable.registerCommand(&quot;cmd_image&quot;, nsImageCommand);</span>
<a href="#l1.28"></a><span id="l1.28">   commandTable.registerCommand(&quot;cmd_hline&quot;, nsHLineCommand);</span>
<a href="#l1.29"></a><span id="l1.29">   commandTable.registerCommand(&quot;cmd_link&quot;, nsLinkCommand);</span>
<a href="#l1.30"></a><span id="l1.30">   commandTable.registerCommand(&quot;cmd_anchor&quot;, nsAnchorCommand);</span>
<a href="#l1.31"></a><span id="l1.31">   commandTable.registerCommand(</span>
<a href="#l1.32"></a><span id="l1.32">     &quot;cmd_insertHTMLWithDialog&quot;,</span>
<a href="#l1.33"></a><span id="l1.33">     nsInsertHTMLWithDialogCommand</span>
<a href="#l1.34"></a><span id="l1.34">   );</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineat">@@ -107,52 +101,46 @@ function SetupHTMLEditorCommands() {</span>
<a href="#l1.36"></a><span id="l1.36">     nsDeleteTableCellContentsCommand</span>
<a href="#l1.37"></a><span id="l1.37">   );</span>
<a href="#l1.38"></a><span id="l1.38">   commandTable.registerCommand(&quot;cmd_JoinTableCells&quot;, nsJoinTableCellsCommand);</span>
<a href="#l1.39"></a><span id="l1.39">   commandTable.registerCommand(&quot;cmd_SplitTableCell&quot;, nsSplitTableCellCommand);</span>
<a href="#l1.40"></a><span id="l1.40">   commandTable.registerCommand(</span>
<a href="#l1.41"></a><span id="l1.41">     &quot;cmd_TableOrCellColor&quot;,</span>
<a href="#l1.42"></a><span id="l1.42">     nsTableOrCellColorCommand</span>
<a href="#l1.43"></a><span id="l1.43">   );</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_NormalizeTable&quot;, nsNormalizeTableCommand);</span>
<a href="#l1.45"></a><span id="l1.45">   commandTable.registerCommand(&quot;cmd_smiley&quot;, nsSetSmiley);</span>
<a href="#l1.46"></a><span id="l1.46">   commandTable.registerCommand(&quot;cmd_ConvertToTable&quot;, nsConvertToTable);</span>
<a href="#l1.47"></a><span id="l1.47"> }</span>
<a href="#l1.48"></a><span id="l1.48"> </span>
<a href="#l1.49"></a><span id="l1.49"> function SetupTextEditorCommands() {</span>
<a href="#l1.50"></a><span id="l1.50">   var commandTable = GetComposerCommandTable();</span>
<a href="#l1.51"></a><span id="l1.51">   if (!commandTable) {</span>
<a href="#l1.52"></a><span id="l1.52">     return;</span>
<a href="#l1.53"></a><span id="l1.53">   }</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-</span>
<a href="#l1.55"></a><span id="l1.55">   // dump(&quot;Registering plain text editor commands\n&quot;);</span>
<a href="#l1.56"></a><span id="l1.56"> </span>
<a href="#l1.57"></a><span id="l1.57">   commandTable.registerCommand(&quot;cmd_findReplace&quot;, nsFindReplaceCommand);</span>
<a href="#l1.58"></a><span id="l1.58">   commandTable.registerCommand(&quot;cmd_find&quot;, nsFindCommand);</span>
<a href="#l1.59"></a><span id="l1.59">   commandTable.registerCommand(&quot;cmd_findNext&quot;, nsFindAgainCommand);</span>
<a href="#l1.60"></a><span id="l1.60">   commandTable.registerCommand(&quot;cmd_findPrev&quot;, nsFindAgainCommand);</span>
<a href="#l1.61"></a><span id="l1.61">   commandTable.registerCommand(&quot;cmd_rewrap&quot;, nsRewrapCommand);</span>
<a href="#l1.62"></a><span id="l1.62">   commandTable.registerCommand(&quot;cmd_spelling&quot;, nsSpellingCommand);</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_validate&quot;, nsValidateCommand);</span>
<a href="#l1.64"></a><span id="l1.64">   commandTable.registerCommand(&quot;cmd_insertChars&quot;, nsInsertCharsCommand);</span>
<a href="#l1.65"></a><span id="l1.65"> }</span>
<a href="#l1.66"></a><span id="l1.66"> </span>
<a href="#l1.67"></a><span id="l1.67"> function SetupComposerWindowCommands() {</span>
<a href="#l1.68"></a><span id="l1.68">   // Don't need to do this if already done</span>
<a href="#l1.69"></a><span id="l1.69">   if (gComposerWindowControllerID) {</span>
<a href="#l1.70"></a><span id="l1.70">     return;</span>
<a href="#l1.71"></a><span id="l1.71">   }</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73">   // Create a command controller and register commands</span>
<a href="#l1.74"></a><span id="l1.74">   //   specific to Web Composer window (file-related commands, HTML Source...)</span>
<a href="#l1.75"></a><span id="l1.75">   //   We can't use the composer controller created on the content window else</span>
<a href="#l1.76"></a><span id="l1.76">   //     we can't process commands when in HTMLSource editor</span>
<a href="#l1.77"></a><span id="l1.77" class="difflineminus">-  // IMPORTANT: For each of these commands, the doCommand method</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-  //            must first call SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-  //            to go from HTML Source mode to any other edit mode</span>
<a href="#l1.80"></a><span id="l1.80"> </span>
<a href="#l1.81"></a><span id="l1.81">   var windowControllers = window.controllers;</span>
<a href="#l1.82"></a><span id="l1.82"> </span>
<a href="#l1.83"></a><span id="l1.83">   if (!windowControllers) {</span>
<a href="#l1.84"></a><span id="l1.84">     return;</span>
<a href="#l1.85"></a><span id="l1.85">   }</span>
<a href="#l1.86"></a><span id="l1.86"> </span>
<a href="#l1.87"></a><span id="l1.87">   var commandTable;</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineat">@@ -183,43 +171,20 @@ function SetupComposerWindowCommands() {</span>
<a href="#l1.89"></a><span id="l1.89">     dump(&quot;Failed to get interface for nsIControllerCommandManager\n&quot;);</span>
<a href="#l1.90"></a><span id="l1.90">     return;</span>
<a href="#l1.91"></a><span id="l1.91">   }</span>
<a href="#l1.92"></a><span id="l1.92"> </span>
<a href="#l1.93"></a><span id="l1.93">   // File-related commands</span>
<a href="#l1.94"></a><span id="l1.94">   commandTable.registerCommand(&quot;cmd_open&quot;, nsOpenCommand);</span>
<a href="#l1.95"></a><span id="l1.95">   commandTable.registerCommand(&quot;cmd_save&quot;, nsSaveCommand);</span>
<a href="#l1.96"></a><span id="l1.96">   commandTable.registerCommand(&quot;cmd_saveAs&quot;, nsSaveAsCommand);</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_exportToText&quot;, nsExportToTextCommand);</span>
<a href="#l1.98"></a><span id="l1.98" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publish&quot;, nsPublishCommand);</span>
<a href="#l1.99"></a><span id="l1.99" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publishAs&quot;, nsPublishAsCommand);</span>
<a href="#l1.100"></a><span id="l1.100" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_publishSettings&quot;, nsPublishSettingsCommand);</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_revert&quot;, nsRevertCommand);</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_openRemote&quot;, nsOpenRemoteCommand);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_preview&quot;, nsPreviewCommand);</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_editSendPage&quot;, nsSendPageCommand);</span>
<a href="#l1.105"></a><span id="l1.105">   commandTable.registerCommand(&quot;cmd_print&quot;, nsPrintCommand);</span>
<a href="#l1.106"></a><span id="l1.106">   commandTable.registerCommand(&quot;cmd_printpreview&quot;, nsPrintPreviewCommand);</span>
<a href="#l1.107"></a><span id="l1.107">   commandTable.registerCommand(&quot;cmd_printSetup&quot;, nsPrintSetupCommand);</span>
<a href="#l1.108"></a><span id="l1.108">   commandTable.registerCommand(&quot;cmd_close&quot;, nsCloseCommand);</span>
<a href="#l1.109"></a><span id="l1.109" class="difflineminus">-  commandTable.registerCommand(&quot;cmd_preferences&quot;, nsPreferencesCommand);</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  // Edit Mode commands</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineminus">-  if (GetCurrentEditorType() == &quot;html&quot;) {</span>
<a href="#l1.113"></a><span id="l1.113" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_NormalMode&quot;, nsNormalModeCommand);</span>
<a href="#l1.114"></a><span id="l1.114" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_AllTagsMode&quot;, nsAllTagsModeCommand);</span>
<a href="#l1.115"></a><span id="l1.115" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_HTMLSourceMode&quot;, nsHTMLSourceModeCommand);</span>
<a href="#l1.116"></a><span id="l1.116" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_PreviewMode&quot;, nsPreviewModeCommand);</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_FinishHTMLSource&quot;, nsFinishHTMLSource);</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-    commandTable.registerCommand(&quot;cmd_CancelHTMLSource&quot;, nsCancelHTMLSource);</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-    commandTable.registerCommand(</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineminus">-      &quot;cmd_updateStructToolbar&quot;,</span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-      nsUpdateStructToolbarCommand</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-    );</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-  }</span>
<a href="#l1.124"></a><span id="l1.124"> </span>
<a href="#l1.125"></a><span id="l1.125">   windowControllers.insertControllerAt(0, editorController);</span>
<a href="#l1.126"></a><span id="l1.126"> </span>
<a href="#l1.127"></a><span id="l1.127">   // Store the controller ID so we can be sure to get the right one later</span>
<a href="#l1.128"></a><span id="l1.128">   gComposerWindowControllerID = windowControllers.getControllerId(</span>
<a href="#l1.129"></a><span id="l1.129">     editorController</span>
<a href="#l1.130"></a><span id="l1.130">   );</span>
<a href="#l1.131"></a><span id="l1.131"> }</span>
<a href="#l1.132"></a><span id="l1.132" class="difflineat">@@ -298,23 +263,19 @@ function goUpdateCommandState(command) {</span>
<a href="#l1.133"></a><span id="l1.133">         break;</span>
<a href="#l1.134"></a><span id="l1.134"> </span>
<a href="#l1.135"></a><span id="l1.135">       case &quot;cmd_paragraphState&quot;:</span>
<a href="#l1.136"></a><span id="l1.136">       case &quot;cmd_align&quot;:</span>
<a href="#l1.137"></a><span id="l1.137">       case &quot;cmd_highlight&quot;:</span>
<a href="#l1.138"></a><span id="l1.138">       case &quot;cmd_backgroundColor&quot;:</span>
<a href="#l1.139"></a><span id="l1.139">       case &quot;cmd_fontColor&quot;:</span>
<a href="#l1.140"></a><span id="l1.140">       case &quot;cmd_fontFace&quot;:</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-      case &quot;cmd_fontSize&quot;:</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineminus">-      case &quot;cmd_absPos&quot;:</span>
<a href="#l1.143"></a><span id="l1.143">         pokeMultiStateUI(command, params);</span>
<a href="#l1.144"></a><span id="l1.144">         break;</span>
<a href="#l1.145"></a><span id="l1.145"> </span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-      case &quot;cmd_decreaseZIndex&quot;:</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-      case &quot;cmd_increaseZIndex&quot;:</span>
<a href="#l1.148"></a><span id="l1.148">       case &quot;cmd_indent&quot;:</span>
<a href="#l1.149"></a><span id="l1.149">       case &quot;cmd_outdent&quot;:</span>
<a href="#l1.150"></a><span id="l1.150">       case &quot;cmd_increaseFont&quot;:</span>
<a href="#l1.151"></a><span id="l1.151">       case &quot;cmd_decreaseFont&quot;:</span>
<a href="#l1.152"></a><span id="l1.152">       case &quot;cmd_increaseFontStep&quot;:</span>
<a href="#l1.153"></a><span id="l1.153">       case &quot;cmd_decreaseFontStep&quot;:</span>
<a href="#l1.154"></a><span id="l1.154">       case &quot;cmd_removeStyles&quot;:</span>
<a href="#l1.155"></a><span id="l1.155">       case &quot;cmd_smiley&quot;:</span>
<a href="#l1.156"></a><span id="l1.156" class="difflineat">@@ -354,17 +315,16 @@ function goDoCommandParams(command, para</span>
<a href="#l1.157"></a><span id="l1.157"> </span>
<a href="#l1.158"></a><span id="l1.158">         // the following two lines should be removed when we implement observers</span>
<a href="#l1.159"></a><span id="l1.159">         if (params) {</span>
<a href="#l1.160"></a><span id="l1.160">           controller.getCommandStateWithParams(command, params);</span>
<a href="#l1.161"></a><span id="l1.161">         }</span>
<a href="#l1.162"></a><span id="l1.162">       } else {</span>
<a href="#l1.163"></a><span id="l1.163">         controller.doCommand(command);</span>
<a href="#l1.164"></a><span id="l1.164">       }</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineminus">-      ResetStructToolbar();</span>
<a href="#l1.166"></a><span id="l1.166">     }</span>
<a href="#l1.167"></a><span id="l1.167">   } catch (e) {</span>
<a href="#l1.168"></a><span id="l1.168">     Cu.reportError(e);</span>
<a href="#l1.169"></a><span id="l1.169">   }</span>
<a href="#l1.170"></a><span id="l1.170"> }</span>
<a href="#l1.171"></a><span id="l1.171"> </span>
<a href="#l1.172"></a><span id="l1.172"> /**</span>
<a href="#l1.173"></a><span id="l1.173">  * Update the UI to reflect setting a given state for a command.</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineat">@@ -407,18 +367,16 @@ function pokeStyleUI(uiID, desiredState)</span>
<a href="#l1.175"></a><span id="l1.175"> </span>
<a href="#l1.176"></a><span id="l1.176"> function doStyleUICommand(cmdStr) {</span>
<a href="#l1.177"></a><span id="l1.177">   try {</span>
<a href="#l1.178"></a><span id="l1.178">     var cmdParams = newCommandParams();</span>
<a href="#l1.179"></a><span id="l1.179">     goDoCommandParams(cmdStr, cmdParams);</span>
<a href="#l1.180"></a><span id="l1.180">     if (cmdParams) {</span>
<a href="#l1.181"></a><span id="l1.181">       pokeStyleUI(cmdStr, cmdParams.getBooleanValue(&quot;state_all&quot;));</span>
<a href="#l1.182"></a><span id="l1.182">     }</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineminus">-</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-    ResetStructToolbar();</span>
<a href="#l1.185"></a><span id="l1.185">   } catch (e) {}</span>
<a href="#l1.186"></a><span id="l1.186"> }</span>
<a href="#l1.187"></a><span id="l1.187"> </span>
<a href="#l1.188"></a><span id="l1.188"> // Copied from jsmime.js.</span>
<a href="#l1.189"></a><span id="l1.189"> function stringToTypedArray(buffer) {</span>
<a href="#l1.190"></a><span id="l1.190">   var typedarray = new Uint8Array(buffer.length);</span>
<a href="#l1.191"></a><span id="l1.191">   for (var i = 0; i &lt; buffer.length; i++) {</span>
<a href="#l1.192"></a><span id="l1.192">     typedarray[i] = buffer.charCodeAt(i);</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineat">@@ -490,18 +448,16 @@ function doStatefulCommand(commandID, ne</span>
<a href="#l1.194"></a><span id="l1.194">     if (!cmdParams) {</span>
<a href="#l1.195"></a><span id="l1.195">       return;</span>
<a href="#l1.196"></a><span id="l1.196">     }</span>
<a href="#l1.197"></a><span id="l1.197"> </span>
<a href="#l1.198"></a><span id="l1.198">     cmdParams.setStringValue(&quot;state_attribute&quot;, newState);</span>
<a href="#l1.199"></a><span id="l1.199">     goDoCommandParams(commandID, cmdParams);</span>
<a href="#l1.200"></a><span id="l1.200"> </span>
<a href="#l1.201"></a><span id="l1.201">     pokeMultiStateUI(commandID, cmdParams);</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-</span>
<a href="#l1.203"></a><span id="l1.203" class="difflineminus">-    ResetStructToolbar();</span>
<a href="#l1.204"></a><span id="l1.204">   } catch (e) {</span>
<a href="#l1.205"></a><span id="l1.205">     dump(&quot;error thrown in doStatefulCommand: &quot; + e + &quot;\n&quot;);</span>
<a href="#l1.206"></a><span id="l1.206">   }</span>
<a href="#l1.207"></a><span id="l1.207"> }</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209"> function PrintObject(obj) {</span>
<a href="#l1.210"></a><span id="l1.210">   dump(&quot;-----&quot; + obj + &quot;------\n&quot;);</span>
<a href="#l1.211"></a><span id="l1.211">   var names = &quot;&quot;;</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineat">@@ -571,29 +527,16 @@ var nsOpenCommand = {</span>
<a href="#l1.213"></a><span id="l1.213">       if (fp.fileURL.spec) {</span>
<a href="#l1.214"></a><span id="l1.214">         SaveFilePickerDirectory(fp, fileType);</span>
<a href="#l1.215"></a><span id="l1.215">         editPage(fp.fileURL.spec, fileType);</span>
<a href="#l1.216"></a><span id="l1.216">       }</span>
<a href="#l1.217"></a><span id="l1.217">     });</span>
<a href="#l1.218"></a><span id="l1.218">   },</span>
<a href="#l1.219"></a><span id="l1.219"> };</span>
<a href="#l1.220"></a><span id="l1.220"> </span>
<a href="#l1.221"></a><span id="l1.221" class="difflineminus">-// STRUCTURE TOOLBAR</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineminus">-//</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineminus">-var nsUpdateStructToolbarCommand = {</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineminus">-    UpdateStructToolbar();</span>
<a href="#l1.226"></a><span id="l1.226" class="difflineminus">-    return true;</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-  },</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.231"></a><span id="l1.231" class="difflineminus">-  doCommand(aCommand) {},</span>
<a href="#l1.232"></a><span id="l1.232" class="difflineminus">-};</span>
<a href="#l1.233"></a><span id="l1.233" class="difflineminus">-</span>
<a href="#l1.234"></a><span id="l1.234"> // ******* File output commands and utilities ******** //</span>
<a href="#l1.235"></a><span id="l1.235"> var nsSaveCommand = {</span>
<a href="#l1.236"></a><span id="l1.236">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.237"></a><span id="l1.237">     // Always allow saving when editing a remote document,</span>
<a href="#l1.238"></a><span id="l1.238">     //  otherwise the document modified state would prevent that</span>
<a href="#l1.239"></a><span id="l1.239">     //  when you first open a remote file.</span>
<a href="#l1.240"></a><span id="l1.240">     try {</span>
<a href="#l1.241"></a><span id="l1.241">       var docUrl = GetDocumentUrl();</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineat">@@ -610,19 +553,16 @@ var nsSaveCommand = {</span>
<a href="#l1.243"></a><span id="l1.243">   },</span>
<a href="#l1.244"></a><span id="l1.244"> </span>
<a href="#l1.245"></a><span id="l1.245">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.246"></a><span id="l1.246">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.247"></a><span id="l1.247"> </span>
<a href="#l1.248"></a><span id="l1.248">   doCommand(aCommand) {</span>
<a href="#l1.249"></a><span id="l1.249">     var editor = GetCurrentEditor();</span>
<a href="#l1.250"></a><span id="l1.250">     if (editor) {</span>
<a href="#l1.251"></a><span id="l1.251" class="difflineminus">-      if (IsHTMLEditor()) {</span>
<a href="#l1.252"></a><span id="l1.252" class="difflineminus">-        SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.253"></a><span id="l1.253" class="difflineminus">-      }</span>
<a href="#l1.254"></a><span id="l1.254">       SaveDocument(</span>
<a href="#l1.255"></a><span id="l1.255">         IsUrlAboutBlank(GetDocumentUrl()),</span>
<a href="#l1.256"></a><span id="l1.256">         false,</span>
<a href="#l1.257"></a><span id="l1.257">         editor.contentsMIMEType</span>
<a href="#l1.258"></a><span id="l1.258">       );</span>
<a href="#l1.259"></a><span id="l1.259">     }</span>
<a href="#l1.260"></a><span id="l1.260">   },</span>
<a href="#l1.261"></a><span id="l1.261"> };</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineat">@@ -633,149 +573,21 @@ var nsSaveAsCommand = {</span>
<a href="#l1.263"></a><span id="l1.263">   },</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.266"></a><span id="l1.266">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.267"></a><span id="l1.267"> </span>
<a href="#l1.268"></a><span id="l1.268">   doCommand(aCommand) {</span>
<a href="#l1.269"></a><span id="l1.269">     var editor = GetCurrentEditor();</span>
<a href="#l1.270"></a><span id="l1.270">     if (editor) {</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineminus">-      if (IsHTMLEditor()) {</span>
<a href="#l1.272"></a><span id="l1.272" class="difflineminus">-        SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.273"></a><span id="l1.273" class="difflineminus">-      }</span>
<a href="#l1.274"></a><span id="l1.274">       SaveDocument(true, false, editor.contentsMIMEType);</span>
<a href="#l1.275"></a><span id="l1.275">     }</span>
<a href="#l1.276"></a><span id="l1.276">   },</span>
<a href="#l1.277"></a><span id="l1.277"> };</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279" class="difflineminus">-var nsExportToTextCommand = {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-    return IsDocumentEditable();</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineminus">-  },</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineminus">-</span>
<a href="#l1.284"></a><span id="l1.284" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.285"></a><span id="l1.285" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.286"></a><span id="l1.286" class="difflineminus">-</span>
<a href="#l1.287"></a><span id="l1.287" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.288"></a><span id="l1.288" class="difflineminus">-    if (GetCurrentEditor()) {</span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-      SaveDocument(true, true, &quot;text/plain&quot;);</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-    }</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-  },</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-};</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-var nsPublishCommand = {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-    if (IsDocumentEditable()) {</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-      // Always allow publishing when editing a local document,</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-      //  otherwise the document modified state would prevent that</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineminus">-      //  when you first open any local file.</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineminus">-      try {</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineminus">-        var docUrl = GetDocumentUrl();</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineminus">-        return (</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineminus">-          IsDocumentModified() ||</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-          IsHTMLSourceChanged() ||</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-          IsUrlAboutBlank(docUrl) ||</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineminus">-          GetScheme(docUrl) == &quot;file&quot;</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineminus">-        );</span>
<a href="#l1.309"></a><span id="l1.309" class="difflineminus">-      } catch (e) {</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-        return false;</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-      }</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-    }</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-    return false;</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-  },</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.320"></a><span id="l1.320" class="difflineminus">-    if (GetCurrentEditor()) {</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-      let docUrl = GetDocumentUrl();</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-      let filename = GetFilename(docUrl);</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-      let publishData;</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineminus">-      // First check pref to always show publish dialog</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineminus">-      let showPublishDialog = Services.prefs.getBoolPref(</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineminus">-        &quot;editor.always_show_publish_dialog&quot;</span>
<a href="#l1.328"></a><span id="l1.328" class="difflineminus">-      );</span>
<a href="#l1.329"></a><span id="l1.329" class="difflineminus">-</span>
<a href="#l1.330"></a><span id="l1.330" class="difflineminus">-      if (!showPublishDialog &amp;&amp; filename) {</span>
<a href="#l1.331"></a><span id="l1.331" class="difflineminus">-        // Try to get publish data from the document url</span>
<a href="#l1.332"></a><span id="l1.332" class="difflineminus">-        publishData = CreatePublishDataFromUrl(docUrl);</span>
<a href="#l1.333"></a><span id="l1.333" class="difflineminus">-</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineminus">-        // If none, use default publishing site? Need a pref for this</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineminus">-        // if (!publishData)</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineminus">-        //  publishData = GetPublishDataFromSiteName(GetDefaultPublishSiteName(), filename);</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-      }</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-      if (showPublishDialog || !publishData) {</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-        // Show the publish dialog</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-        publishData = {};</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineminus">-        window.ok = false;</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineminus">-        let oldTitle = GetDocumentTitle();</span>
<a href="#l1.344"></a><span id="l1.344" class="difflineminus">-        window.openDialog(</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineminus">-          &quot;chrome://messenger/content/messengercompose/EditorPublish.xul&quot;,</span>
<a href="#l1.346"></a><span id="l1.346" class="difflineminus">-          &quot;_blank&quot;,</span>
<a href="#l1.347"></a><span id="l1.347" class="difflineminus">-          &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-          &quot;&quot;,</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-          &quot;&quot;,</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineminus">-          publishData</span>
<a href="#l1.351"></a><span id="l1.351" class="difflineminus">-        );</span>
<a href="#l1.352"></a><span id="l1.352" class="difflineminus">-        if (GetDocumentTitle() != oldTitle) {</span>
<a href="#l1.353"></a><span id="l1.353" class="difflineminus">-          UpdateWindowTitle();</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-        }</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-        if (!window.ok) {</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-          return false;</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-        }</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-      }</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-      if (publishData) {</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-        SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-        return Publish(publishData);</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineminus">-      }</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineminus">-    }</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineminus">-    return false;</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineminus">-  },</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineminus">-};</span>
<a href="#l1.368"></a><span id="l1.368" class="difflineminus">-</span>
<a href="#l1.369"></a><span id="l1.369" class="difflineminus">-var nsPublishAsCommand = {</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.371"></a><span id="l1.371" class="difflineminus">-    return IsDocumentEditable();</span>
<a href="#l1.372"></a><span id="l1.372" class="difflineminus">-  },</span>
<a href="#l1.373"></a><span id="l1.373" class="difflineminus">-</span>
<a href="#l1.374"></a><span id="l1.374" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.375"></a><span id="l1.375" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.376"></a><span id="l1.376" class="difflineminus">-</span>
<a href="#l1.377"></a><span id="l1.377" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.378"></a><span id="l1.378" class="difflineminus">-    if (GetCurrentEditor()) {</span>
<a href="#l1.379"></a><span id="l1.379" class="difflineminus">-      SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-      window.ok = false;</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-      var publishData = {};</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-      var oldTitle = GetDocumentTitle();</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-      window.openDialog(</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-        &quot;chrome://messenger/content/messengercompose/EditorPublish.xul&quot;,</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-        &quot;_blank&quot;,</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineminus">-        &quot;&quot;,</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineminus">-        &quot;&quot;,</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineminus">-        publishData</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineminus">-      );</span>
<a href="#l1.392"></a><span id="l1.392" class="difflineminus">-      if (GetDocumentTitle() != oldTitle) {</span>
<a href="#l1.393"></a><span id="l1.393" class="difflineminus">-        UpdateWindowTitle();</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineminus">-      }</span>
<a href="#l1.395"></a><span id="l1.395" class="difflineminus">-</span>
<a href="#l1.396"></a><span id="l1.396" class="difflineminus">-      if (window.ok) {</span>
<a href="#l1.397"></a><span id="l1.397" class="difflineminus">-        return Publish(publishData);</span>
<a href="#l1.398"></a><span id="l1.398" class="difflineminus">-      }</span>
<a href="#l1.399"></a><span id="l1.399" class="difflineminus">-    }</span>
<a href="#l1.400"></a><span id="l1.400" class="difflineminus">-    return false;</span>
<a href="#l1.401"></a><span id="l1.401" class="difflineminus">-  },</span>
<a href="#l1.402"></a><span id="l1.402" class="difflineminus">-};</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-</span>
<a href="#l1.404"></a><span id="l1.404"> // ------- output utilities   ----- //</span>
<a href="#l1.405"></a><span id="l1.405"> </span>
<a href="#l1.406"></a><span id="l1.406"> // returns a fileExtension string</span>
<a href="#l1.407"></a><span id="l1.407"> function GetExtensionBasedOnMimeType(aMIMEType) {</span>
<a href="#l1.408"></a><span id="l1.408">   try {</span>
<a href="#l1.409"></a><span id="l1.409">     var mimeService = null;</span>
<a href="#l1.410"></a><span id="l1.410">     mimeService = Cc[&quot;@mozilla.org/mime;1&quot;].getService(Ci.nsIMIMEService);</span>
<a href="#l1.411"></a><span id="l1.411"> </span>
<a href="#l1.412"></a><span id="l1.412" class="difflineat">@@ -1289,20 +1101,17 @@ var gEditorOutputProgressListener = {</span>
<a href="#l1.413"></a><span id="l1.413">               Services.io.newURI(docUrl, editor.documentCharacterSet)</span>
<a href="#l1.414"></a><span id="l1.414">             );</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416">             UpdateWindowTitle();</span>
<a href="#l1.417"></a><span id="l1.417"> </span>
<a href="#l1.418"></a><span id="l1.418">             // this should cause notification to listeners that doc has changed</span>
<a href="#l1.419"></a><span id="l1.419">             editor.resetModificationCount();</span>
<a href="#l1.420"></a><span id="l1.420"> </span>
<a href="#l1.421"></a><span id="l1.421" class="difflineminus">-            // Set UI based on whether we're editing a remote or local url</span>
<a href="#l1.422"></a><span id="l1.422" class="difflineminus">-            // Why is urlstring undefined?</span>
<a href="#l1.423"></a><span id="l1.423" class="difflineminus">-            /* eslint-disable-next-line no-undef */</span>
<a href="#l1.424"></a><span id="l1.424" class="difflineminus">-            SetSaveAndPublishUI(urlstring);</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineplus">+            goUpdateCommand(&quot;cmd_save&quot;);</span>
<a href="#l1.426"></a><span id="l1.426">           } catch (e) {}</span>
<a href="#l1.427"></a><span id="l1.427"> </span>
<a href="#l1.428"></a><span id="l1.428">           // Save publishData to prefs</span>
<a href="#l1.429"></a><span id="l1.429">           if (gPublishData) {</span>
<a href="#l1.430"></a><span id="l1.430">             if (gPublishData.savePublishData) {</span>
<a href="#l1.431"></a><span id="l1.431">               // We published successfully, so we can safely</span>
<a href="#l1.432"></a><span id="l1.432">               //  save docDir and otherDir to prefs</span>
<a href="#l1.433"></a><span id="l1.433">               gPublishData.saveDirs = true;</span>
<a href="#l1.434"></a><span id="l1.434" class="difflineat">@@ -1961,17 +1770,17 @@ async function SaveDocument(aSaveAs, aSa</span>
<a href="#l1.435"></a><span id="l1.435">       UpdateWindowTitle();</span>
<a href="#l1.436"></a><span id="l1.436"> </span>
<a href="#l1.437"></a><span id="l1.437">       if (!aSaveCopy) {</span>
<a href="#l1.438"></a><span id="l1.438">         editor.resetModificationCount();</span>
<a href="#l1.439"></a><span id="l1.439">       }</span>
<a href="#l1.440"></a><span id="l1.440">       // this should cause notification to listeners that document has changed</span>
<a href="#l1.441"></a><span id="l1.441"> </span>
<a href="#l1.442"></a><span id="l1.442">       // Set UI based on whether we're editing a remote or local url</span>
<a href="#l1.443"></a><span id="l1.443" class="difflineminus">-      SetSaveAndPublishUI(urlstring);</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineplus">+      goUpdateCommand(&quot;cmd_save&quot;);</span>
<a href="#l1.445"></a><span id="l1.445">     } catch (e) {}</span>
<a href="#l1.446"></a><span id="l1.446">   } else {</span>
<a href="#l1.447"></a><span id="l1.447">     Services.prompt.alert(</span>
<a href="#l1.448"></a><span id="l1.448">       window,</span>
<a href="#l1.449"></a><span id="l1.449">       GetString(&quot;SaveDocument&quot;),</span>
<a href="#l1.450"></a><span id="l1.450">       GetString(&quot;SaveFileFailed&quot;)</span>
<a href="#l1.451"></a><span id="l1.451">     );</span>
<a href="#l1.452"></a><span id="l1.452">   }</span>
<a href="#l1.453"></a><span id="l1.453" class="difflineat">@@ -2209,102 +2018,31 @@ function GetDocUrlFromPublishData(publis</span>
<a href="#l1.454"></a><span id="l1.454"> </span>
<a href="#l1.455"></a><span id="l1.455">   if (GetScheme(url) == &quot;ftp&quot;) {</span>
<a href="#l1.456"></a><span id="l1.456">     url = InsertUsernameIntoUrl(url, publishData.username);</span>
<a href="#l1.457"></a><span id="l1.457">   }</span>
<a href="#l1.458"></a><span id="l1.458"> </span>
<a href="#l1.459"></a><span id="l1.459">   return url;</span>
<a href="#l1.460"></a><span id="l1.460"> }</span>
<a href="#l1.461"></a><span id="l1.461"> </span>
<a href="#l1.462"></a><span id="l1.462" class="difflineminus">-function SetSaveAndPublishUI(urlstring) {</span>
<a href="#l1.463"></a><span id="l1.463" class="difflineminus">-  // Be sure enabled state of toolbar buttons are correct</span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-  goUpdateCommand(&quot;cmd_save&quot;);</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineminus">-  goUpdateCommand(&quot;cmd_publish&quot;);</span>
<a href="#l1.466"></a><span id="l1.466" class="difflineminus">-}</span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-</span>
<a href="#l1.468"></a><span id="l1.468"> function SetDocumentEditable(isDocEditable) {</span>
<a href="#l1.469"></a><span id="l1.469">   var editor = GetCurrentEditor();</span>
<a href="#l1.470"></a><span id="l1.470">   if (editor &amp;&amp; editor.document) {</span>
<a href="#l1.471"></a><span id="l1.471">     try {</span>
<a href="#l1.472"></a><span id="l1.472">       var flags = editor.flags;</span>
<a href="#l1.473"></a><span id="l1.473">       editor.flags = isDocEditable</span>
<a href="#l1.474"></a><span id="l1.474">         ? (flags &amp;= ~nsIPlaintextEditor.eEditorReadonlyMask)</span>
<a href="#l1.475"></a><span id="l1.475">         : flags | nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l1.476"></a><span id="l1.476">     } catch (e) {}</span>
<a href="#l1.477"></a><span id="l1.477"> </span>
<a href="#l1.478"></a><span id="l1.478">     // update all commands</span>
<a href="#l1.479"></a><span id="l1.479">     window.updateCommands(&quot;create&quot;);</span>
<a href="#l1.480"></a><span id="l1.480">   }</span>
<a href="#l1.481"></a><span id="l1.481"> }</span>
<a href="#l1.482"></a><span id="l1.482"> </span>
<a href="#l1.483"></a><span id="l1.483" class="difflineminus">-// ****** end of save / publish **********//</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineminus">-</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-var nsPublishSettingsCommand = {</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineminus">-    return IsDocumentEditable();</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineminus">-  },</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineminus">-</span>
<a href="#l1.493"></a><span id="l1.493" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.494"></a><span id="l1.494" class="difflineminus">-    if (GetCurrentEditor()) {</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-      // Launch Publish Settings dialog</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineminus">-      window.ok = window.openDialog(</span>
<a href="#l1.498"></a><span id="l1.498" class="difflineminus">-        &quot;chrome://messenger/content/messengercompose/EditorPublishSettings.xul&quot;,</span>
<a href="#l1.499"></a><span id="l1.499" class="difflineminus">-        &quot;_blank&quot;,</span>
<a href="#l1.500"></a><span id="l1.500" class="difflineminus">-        &quot;chrome,close,titlebar,modal&quot;,</span>
<a href="#l1.501"></a><span id="l1.501" class="difflineminus">-        &quot;&quot;</span>
<a href="#l1.502"></a><span id="l1.502" class="difflineminus">-      );</span>
<a href="#l1.503"></a><span id="l1.503" class="difflineminus">-      return window.ok;</span>
<a href="#l1.504"></a><span id="l1.504" class="difflineminus">-    }</span>
<a href="#l1.505"></a><span id="l1.505" class="difflineminus">-    return false;</span>
<a href="#l1.506"></a><span id="l1.506" class="difflineminus">-  },</span>
<a href="#l1.507"></a><span id="l1.507" class="difflineminus">-};</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-var nsRevertCommand = {</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-    return (</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineminus">-      IsDocumentEditable() &amp;&amp;</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineminus">-      IsDocumentModified() &amp;&amp;</span>
<a href="#l1.514"></a><span id="l1.514" class="difflineminus">-      !IsUrlAboutBlank(GetDocumentUrl())</span>
<a href="#l1.515"></a><span id="l1.515" class="difflineminus">-    );</span>
<a href="#l1.516"></a><span id="l1.516" class="difflineminus">-  },</span>
<a href="#l1.517"></a><span id="l1.517" class="difflineminus">-</span>
<a href="#l1.518"></a><span id="l1.518" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.519"></a><span id="l1.519" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.520"></a><span id="l1.520" class="difflineminus">-</span>
<a href="#l1.521"></a><span id="l1.521" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineminus">-    // Confirm with the user to abandon current changes</span>
<a href="#l1.523"></a><span id="l1.523" class="difflineminus">-    // Put the page title in the message string</span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-    let title = GetDocumentTitle();</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-    let msg = GetString(&quot;AbandonChanges&quot;).replace(/%title%/, title);</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineminus">-</span>
<a href="#l1.527"></a><span id="l1.527" class="difflineminus">-    let result = Services.prompt.confirmEx(</span>
<a href="#l1.528"></a><span id="l1.528" class="difflineminus">-      window,</span>
<a href="#l1.529"></a><span id="l1.529" class="difflineminus">-      GetString(&quot;RevertCaption&quot;),</span>
<a href="#l1.530"></a><span id="l1.530" class="difflineminus">-      msg,</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineminus">-      Services.prompt.BUTTON_TITLE_REVERT * Services.prompt.BUTTON_POS_0 +</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-        Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1,</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-      null,</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineminus">-      null,</span>
<a href="#l1.535"></a><span id="l1.535" class="difflineminus">-      null,</span>
<a href="#l1.536"></a><span id="l1.536" class="difflineminus">-      null,</span>
<a href="#l1.537"></a><span id="l1.537" class="difflineminus">-      { value: 0 }</span>
<a href="#l1.538"></a><span id="l1.538" class="difflineminus">-    );</span>
<a href="#l1.539"></a><span id="l1.539" class="difflineminus">-</span>
<a href="#l1.540"></a><span id="l1.540" class="difflineminus">-    // Reload page if first button (Revert) was pressed</span>
<a href="#l1.541"></a><span id="l1.541" class="difflineminus">-    if (result == 0) {</span>
<a href="#l1.542"></a><span id="l1.542" class="difflineminus">-      CancelHTMLSource();</span>
<a href="#l1.543"></a><span id="l1.543" class="difflineminus">-      EditorLoadUrl(GetDocumentUrl());</span>
<a href="#l1.544"></a><span id="l1.544" class="difflineminus">-    }</span>
<a href="#l1.545"></a><span id="l1.545" class="difflineminus">-  },</span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-};</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-</span>
<a href="#l1.548"></a><span id="l1.548"> var nsCloseCommand = {</span>
<a href="#l1.549"></a><span id="l1.549">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.550"></a><span id="l1.550">     return GetCurrentEditor() != null;</span>
<a href="#l1.551"></a><span id="l1.551">   },</span>
<a href="#l1.552"></a><span id="l1.552"> </span>
<a href="#l1.553"></a><span id="l1.553">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.554"></a><span id="l1.554">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.555"></a><span id="l1.555"> </span>
<a href="#l1.556"></a><span id="l1.556" class="difflineat">@@ -2327,171 +2065,25 @@ async function CloseWindow() {</span>
<a href="#l1.557"></a><span id="l1.557">         .QueryInterface(Ci.nsIDocShellTreeItem)</span>
<a href="#l1.558"></a><span id="l1.558">         .treeOwner.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l1.559"></a><span id="l1.559">         .getInterface(Ci.nsIBaseWindow);</span>
<a href="#l1.560"></a><span id="l1.560">       basewin.destroy();</span>
<a href="#l1.561"></a><span id="l1.561">     } catch (e) {}</span>
<a href="#l1.562"></a><span id="l1.562">   }</span>
<a href="#l1.563"></a><span id="l1.563"> }</span>
<a href="#l1.564"></a><span id="l1.564"> </span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-var nsOpenRemoteCommand = {</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineminus">-    // We can always do this.</span>
<a href="#l1.568"></a><span id="l1.568" class="difflineminus">-    return true;</span>
<a href="#l1.569"></a><span id="l1.569" class="difflineminus">-  },</span>
<a href="#l1.570"></a><span id="l1.570" class="difflineminus">-</span>
<a href="#l1.571"></a><span id="l1.571" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.572"></a><span id="l1.572" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.573"></a><span id="l1.573" class="difflineminus">-</span>
<a href="#l1.574"></a><span id="l1.574" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-    var params = { action: &quot;2&quot;, url: &quot;&quot; };</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-    openDialog(</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineminus">-      &quot;chrome://communicator/content/openLocation.xul&quot;,</span>
<a href="#l1.578"></a><span id="l1.578" class="difflineminus">-      &quot;_blank&quot;,</span>
<a href="#l1.579"></a><span id="l1.579" class="difflineminus">-      &quot;chrome,modal,titlebar&quot;,</span>
<a href="#l1.580"></a><span id="l1.580" class="difflineminus">-      params</span>
<a href="#l1.581"></a><span id="l1.581" class="difflineminus">-    );</span>
<a href="#l1.582"></a><span id="l1.582" class="difflineminus">-    var win = getTopWin();</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-    switch (params.action) {</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineminus">-      case &quot;0&quot;: // current window</span>
<a href="#l1.585"></a><span id="l1.585" class="difflineminus">-        win.focus();</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineminus">-        win.loadURI(params.url, null, null, true);</span>
<a href="#l1.587"></a><span id="l1.587" class="difflineminus">-        break;</span>
<a href="#l1.588"></a><span id="l1.588" class="difflineminus">-      case &quot;1&quot;: // new window</span>
<a href="#l1.589"></a><span id="l1.589" class="difflineminus">-        openDialog(</span>
<a href="#l1.590"></a><span id="l1.590" class="difflineminus">-          getBrowserURL(),</span>
<a href="#l1.591"></a><span id="l1.591" class="difflineminus">-          &quot;_blank&quot;,</span>
<a href="#l1.592"></a><span id="l1.592" class="difflineminus">-          &quot;all,dialog=no&quot;,</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineminus">-          params.url,</span>
<a href="#l1.594"></a><span id="l1.594" class="difflineminus">-          null,</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-          null,</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-          null,</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineminus">-          true</span>
<a href="#l1.598"></a><span id="l1.598" class="difflineminus">-        );</span>
<a href="#l1.599"></a><span id="l1.599" class="difflineminus">-        break;</span>
<a href="#l1.600"></a><span id="l1.600" class="difflineminus">-      case &quot;2&quot;: // edit</span>
<a href="#l1.601"></a><span id="l1.601" class="difflineminus">-        editPage(params.url);</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-        break;</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-      case &quot;3&quot;: // new tab</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineminus">-        win.focus();</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineminus">-        var browser = win.getBrowser();</span>
<a href="#l1.606"></a><span id="l1.606" class="difflineminus">-        browser.selectedTab = browser.addTab(params.url, {</span>
<a href="#l1.607"></a><span id="l1.607" class="difflineminus">-          allowThirdPartyFixup: true,</span>
<a href="#l1.608"></a><span id="l1.608" class="difflineminus">-        });</span>
<a href="#l1.609"></a><span id="l1.609" class="difflineminus">-        break;</span>
<a href="#l1.610"></a><span id="l1.610" class="difflineminus">-      case &quot;4&quot;: // private</span>
<a href="#l1.611"></a><span id="l1.611" class="difflineminus">-        openNewPrivateWith(params.url);</span>
<a href="#l1.612"></a><span id="l1.612" class="difflineminus">-        break;</span>
<a href="#l1.613"></a><span id="l1.613" class="difflineminus">-      default:</span>
<a href="#l1.614"></a><span id="l1.614" class="difflineminus">-        break;</span>
<a href="#l1.615"></a><span id="l1.615" class="difflineminus">-    }</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-  },</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-};</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-var nsPreviewCommand = {</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-    return (</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-      IsDocumentEditable() &amp;&amp;</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-      IsHTMLEditor() &amp;&amp;</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineminus">-      (DocumentHasBeenSaved() || IsDocumentModified())</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineminus">-    );</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineminus">-  },</span>
<a href="#l1.627"></a><span id="l1.627" class="difflineminus">-</span>
<a href="#l1.628"></a><span id="l1.628" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.629"></a><span id="l1.629" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.630"></a><span id="l1.630" class="difflineminus">-</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-  async doCommand(aCommand) {</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-    // Don't continue if user canceled during prompt for saving</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-    // DocumentHasBeenSaved will test if we have a URL and suppress &quot;Don't Save&quot; button if not</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineminus">-    if (!(await CheckAndSaveDocument(&quot;cmd_preview&quot;, DocumentHasBeenSaved()))) {</span>
<a href="#l1.635"></a><span id="l1.635" class="difflineminus">-      return;</span>
<a href="#l1.636"></a><span id="l1.636" class="difflineminus">-    }</span>
<a href="#l1.637"></a><span id="l1.637" class="difflineminus">-</span>
<a href="#l1.638"></a><span id="l1.638" class="difflineminus">-    // Check if we saved again just in case?</span>
<a href="#l1.639"></a><span id="l1.639" class="difflineminus">-    if (DocumentHasBeenSaved()) {</span>
<a href="#l1.640"></a><span id="l1.640" class="difflineminus">-      let browser;</span>
<a href="#l1.641"></a><span id="l1.641" class="difflineminus">-      try {</span>
<a href="#l1.642"></a><span id="l1.642" class="difflineminus">-        // Find a browser with this URL</span>
<a href="#l1.643"></a><span id="l1.643" class="difflineminus">-        let enumerator = Services.wm.getEnumerator(&quot;navigator:browser&quot;);</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-        var documentURI = GetDocumentUrl();</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-        while (enumerator.hasMoreElements()) {</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-          browser = enumerator.getNext();</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-          if (</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineminus">-            browser &amp;&amp;</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineminus">-            !browser.closed &amp;&amp;</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineminus">-            documentURI == browser.getBrowser().currentURI.spec</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineminus">-          ) {</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineminus">-            break;</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineminus">-          }</span>
<a href="#l1.655"></a><span id="l1.655" class="difflineminus">-</span>
<a href="#l1.656"></a><span id="l1.656" class="difflineminus">-          browser = null;</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-        }</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-      } catch (ex) {}</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineminus">-</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineminus">-      // If none found, open a new browser</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-      if (!browser) {</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-        browser = window.openDialog(</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-          getBrowserURL(),</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-          &quot;_blank&quot;,</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-          &quot;chrome,all,dialog=no&quot;,</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-          documentURI</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-        );</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineminus">-      } else {</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineminus">-        try {</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineminus">-          browser.BrowserReloadSkipCache();</span>
<a href="#l1.671"></a><span id="l1.671" class="difflineminus">-          browser.focus();</span>
<a href="#l1.672"></a><span id="l1.672" class="difflineminus">-        } catch (ex) {}</span>
<a href="#l1.673"></a><span id="l1.673" class="difflineminus">-      }</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-    }</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineminus">-  },</span>
<a href="#l1.676"></a><span id="l1.676" class="difflineminus">-};</span>
<a href="#l1.677"></a><span id="l1.677" class="difflineminus">-</span>
<a href="#l1.678"></a><span id="l1.678" class="difflineminus">-var nsSendPageCommand = {</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-    return (</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-      IsDocumentEditable() &amp;&amp; (DocumentHasBeenSaved() || IsDocumentModified())</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineminus">-    );</span>
<a href="#l1.683"></a><span id="l1.683" class="difflineminus">-  },</span>
<a href="#l1.684"></a><span id="l1.684" class="difflineminus">-</span>
<a href="#l1.685"></a><span id="l1.685" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.686"></a><span id="l1.686" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-  async doCommand(aCommand) {</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineminus">-    // Don't continue if user canceled during prompt for saving</span>
<a href="#l1.690"></a><span id="l1.690" class="difflineminus">-    // DocumentHasBeenSaved will test if we have a URL and suppress &quot;Don't Save&quot; button if not</span>
<a href="#l1.691"></a><span id="l1.691" class="difflineminus">-    if (</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-      !(await CheckAndSaveDocument(&quot;cmd_editSendPage&quot;, DocumentHasBeenSaved()))</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-    ) {</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-      return;</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-    }</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-    // Check if we saved again just in case?</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-    if (DocumentHasBeenSaved()) {</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineminus">-      // Launch Messenger Composer window with current page as contents</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineminus">-      try {</span>
<a href="#l1.701"></a><span id="l1.701" class="difflineminus">-        openComposeWindow(GetDocumentUrl(), GetDocumentTitle());</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-      } catch (ex) {</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-        dump(&quot;Cannot Send Page: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-      }</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineminus">-    }</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineminus">-  },</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-};</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineminus">-</span>
<a href="#l1.709"></a><span id="l1.709"> var nsPrintCommand = {</span>
<a href="#l1.710"></a><span id="l1.710">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.711"></a><span id="l1.711">     return true; // we can always do this</span>
<a href="#l1.712"></a><span id="l1.712">   },</span>
<a href="#l1.713"></a><span id="l1.713"> </span>
<a href="#l1.714"></a><span id="l1.714">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.715"></a><span id="l1.715">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.716"></a><span id="l1.716"> </span>
<a href="#l1.717"></a><span id="l1.717">   doCommand(aCommand) {</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-    // In editor.js</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-    SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.720"></a><span id="l1.720">     try {</span>
<a href="#l1.721"></a><span id="l1.721">       let browser = GetCurrentEditorElement();</span>
<a href="#l1.722"></a><span id="l1.722">       PrintUtils.printWindow(browser.outerWindowID, browser);</span>
<a href="#l1.723"></a><span id="l1.723">     } catch (e) {}</span>
<a href="#l1.724"></a><span id="l1.724">   },</span>
<a href="#l1.725"></a><span id="l1.725"> };</span>
<a href="#l1.726"></a><span id="l1.726"> </span>
<a href="#l1.727"></a><span id="l1.727"> var nsPrintPreviewCommand = {</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineat">@@ -2499,35 +2091,31 @@ var nsPrintPreviewCommand = {</span>
<a href="#l1.729"></a><span id="l1.729">     // We can always do this.</span>
<a href="#l1.730"></a><span id="l1.730">     return true;</span>
<a href="#l1.731"></a><span id="l1.731">   },</span>
<a href="#l1.732"></a><span id="l1.732"> </span>
<a href="#l1.733"></a><span id="l1.733">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.734"></a><span id="l1.734">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.735"></a><span id="l1.735"> </span>
<a href="#l1.736"></a><span id="l1.736">   doCommand(aCommand) {</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-    // In editor.js</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-    SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.739"></a><span id="l1.739">     try {</span>
<a href="#l1.740"></a><span id="l1.740">       PrintUtils.printPreview(PrintPreviewListener);</span>
<a href="#l1.741"></a><span id="l1.741">     } catch (e) {}</span>
<a href="#l1.742"></a><span id="l1.742">   },</span>
<a href="#l1.743"></a><span id="l1.743"> };</span>
<a href="#l1.744"></a><span id="l1.744"> </span>
<a href="#l1.745"></a><span id="l1.745"> var nsPrintSetupCommand = {</span>
<a href="#l1.746"></a><span id="l1.746">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.747"></a><span id="l1.747">     return true; // we can always do this</span>
<a href="#l1.748"></a><span id="l1.748">   },</span>
<a href="#l1.749"></a><span id="l1.749"> </span>
<a href="#l1.750"></a><span id="l1.750">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.751"></a><span id="l1.751">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.752"></a><span id="l1.752"> </span>
<a href="#l1.753"></a><span id="l1.753">   doCommand(aCommand) {</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-    // In editor.js</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-    SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.756"></a><span id="l1.756">     PrintUtils.showPageSetup();</span>
<a href="#l1.757"></a><span id="l1.757">   },</span>
<a href="#l1.758"></a><span id="l1.758"> };</span>
<a href="#l1.759"></a><span id="l1.759"> </span>
<a href="#l1.760"></a><span id="l1.760"> var nsFindReplaceCommand = {</span>
<a href="#l1.761"></a><span id="l1.761">   isCommandEnabled(aCommand, editorElement) {</span>
<a href="#l1.762"></a><span id="l1.762">     return editorElement.getEditor(editorElement.contentWindow) != null;</span>
<a href="#l1.763"></a><span id="l1.763">   },</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineat">@@ -2616,93 +2204,16 @@ var nsSpellingCommand = {</span>
<a href="#l1.765"></a><span id="l1.765">         false,</span>
<a href="#l1.766"></a><span id="l1.766">         skipBlockQuotes,</span>
<a href="#l1.767"></a><span id="l1.767">         true</span>
<a href="#l1.768"></a><span id="l1.768">       );</span>
<a href="#l1.769"></a><span id="l1.769">     } catch (ex) {}</span>
<a href="#l1.770"></a><span id="l1.770">   },</span>
<a href="#l1.771"></a><span id="l1.771"> };</span>
<a href="#l1.772"></a><span id="l1.772"> </span>
<a href="#l1.773"></a><span id="l1.773" class="difflineminus">-// Validate using http://validator.w3.org/file-upload.html</span>
<a href="#l1.774"></a><span id="l1.774" class="difflineminus">-var URL2Validate;</span>
<a href="#l1.775"></a><span id="l1.775" class="difflineminus">-var nsValidateCommand = {</span>
<a href="#l1.776"></a><span id="l1.776" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-    return GetCurrentEditor() != null;</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-  },</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineminus">-</span>
<a href="#l1.780"></a><span id="l1.780" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.781"></a><span id="l1.781" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineminus">-  async doCommand(aCommand) {</span>
<a href="#l1.784"></a><span id="l1.784" class="difflineminus">-    // If the document hasn't been modified,</span>
<a href="#l1.785"></a><span id="l1.785" class="difflineminus">-    // then just validate the current url.</span>
<a href="#l1.786"></a><span id="l1.786" class="difflineminus">-    if (IsDocumentModified() || IsHTMLSourceChanged()) {</span>
<a href="#l1.787"></a><span id="l1.787" class="difflineminus">-      if (!(await CheckAndSaveDocument(&quot;cmd_validate&quot;, false))) {</span>
<a href="#l1.788"></a><span id="l1.788" class="difflineminus">-        return;</span>
<a href="#l1.789"></a><span id="l1.789" class="difflineminus">-      }</span>
<a href="#l1.790"></a><span id="l1.790" class="difflineminus">-</span>
<a href="#l1.791"></a><span id="l1.791" class="difflineminus">-      // Check if we saved again just in case?</span>
<a href="#l1.792"></a><span id="l1.792" class="difflineminus">-      if (!DocumentHasBeenSaved()) {</span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-        // user hit cancel?</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-        return;</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-      }</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-    }</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineminus">-</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineminus">-    URL2Validate = GetDocumentUrl();</span>
<a href="#l1.799"></a><span id="l1.799" class="difflineminus">-    // See if it's a file:</span>
<a href="#l1.800"></a><span id="l1.800" class="difflineminus">-    var ifile;</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineminus">-    try {</span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-      var fileHandler = GetFileProtocolHandler();</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-      ifile = fileHandler.getFileFromURLSpec(URL2Validate);</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineminus">-      // nsIFile throws an exception if it's not a file url</span>
<a href="#l1.805"></a><span id="l1.805" class="difflineminus">-    } catch (e) {</span>
<a href="#l1.806"></a><span id="l1.806" class="difflineminus">-      ifile = null;</span>
<a href="#l1.807"></a><span id="l1.807" class="difflineminus">-    }</span>
<a href="#l1.808"></a><span id="l1.808" class="difflineminus">-    if (ifile) {</span>
<a href="#l1.809"></a><span id="l1.809" class="difflineminus">-      URL2Validate = ifile.path;</span>
<a href="#l1.810"></a><span id="l1.810" class="difflineminus">-      var vwin = window.open(</span>
<a href="#l1.811"></a><span id="l1.811" class="difflineminus">-        &quot;http://validator.w3.org/file-upload.html&quot;,</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-        &quot;EditorValidate&quot;</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineminus">-      );</span>
<a href="#l1.814"></a><span id="l1.814" class="difflineminus">-      // Window loads asynchronously, so pass control to the load listener:</span>
<a href="#l1.815"></a><span id="l1.815" class="difflineminus">-      vwin.addEventListener(&quot;load&quot;, this.validateFilePageLoaded);</span>
<a href="#l1.816"></a><span id="l1.816" class="difflineminus">-    } else {</span>
<a href="#l1.817"></a><span id="l1.817" class="difflineminus">-      window.open(</span>
<a href="#l1.818"></a><span id="l1.818" class="difflineminus">-        `http://validator.w3.org/check?uri=${URL2Validate}&amp;doctype=Inline`,</span>
<a href="#l1.819"></a><span id="l1.819" class="difflineminus">-        &quot;EditorValidate&quot;</span>
<a href="#l1.820"></a><span id="l1.820" class="difflineminus">-      );</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineminus">-      // This does the validation, no need to wait for page loaded.</span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-    }</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-  },</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-  validateFilePageLoaded(event) {</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-    event.target.forms[0].uploaded_file.value = URL2Validate;</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineminus">-  },</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineminus">-};</span>
<a href="#l1.828"></a><span id="l1.828" class="difflineminus">-</span>
<a href="#l1.829"></a><span id="l1.829" class="difflineminus">-var nsIsIndexCommand = {</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineminus">-  },</span>
<a href="#l1.833"></a><span id="l1.833" class="difflineminus">-</span>
<a href="#l1.834"></a><span id="l1.834" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.835"></a><span id="l1.835" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.836"></a><span id="l1.836" class="difflineminus">-</span>
<a href="#l1.837"></a><span id="l1.837" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.838"></a><span id="l1.838" class="difflineminus">-    try {</span>
<a href="#l1.839"></a><span id="l1.839" class="difflineminus">-      var editor = GetCurrentEditor();</span>
<a href="#l1.840"></a><span id="l1.840" class="difflineminus">-      var isindexElement = editor.createElementWithDefaults(&quot;isindex&quot;);</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-      isindexElement.setAttribute(</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-        &quot;prompt&quot;,</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineminus">-        editor.outputToString(&quot;text/plain&quot;, kOutputSelectionOnly)</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineminus">-      );</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-      editor.insertElementAtSelection(isindexElement, true);</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-  },</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-};</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-</span>
<a href="#l1.850"></a><span id="l1.850"> var nsImageCommand = {</span>
<a href="#l1.851"></a><span id="l1.851">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.852"></a><span id="l1.852">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.853"></a><span id="l1.853">   },</span>
<a href="#l1.854"></a><span id="l1.854"> </span>
<a href="#l1.855"></a><span id="l1.855">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.856"></a><span id="l1.856">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.857"></a><span id="l1.857"> </span>
<a href="#l1.858"></a><span id="l1.858" class="difflineat">@@ -3098,33 +2609,16 @@ function doAdvancedProperties(element) {</span>
<a href="#l1.859"></a><span id="l1.859">       &quot;_blank&quot;,</span>
<a href="#l1.860"></a><span id="l1.860">       &quot;chrome,close,titlebar,modal,resizable=yes&quot;,</span>
<a href="#l1.861"></a><span id="l1.861">       &quot;&quot;,</span>
<a href="#l1.862"></a><span id="l1.862">       element</span>
<a href="#l1.863"></a><span id="l1.863">     );</span>
<a href="#l1.864"></a><span id="l1.864">   }</span>
<a href="#l1.865"></a><span id="l1.865"> }</span>
<a href="#l1.866"></a><span id="l1.866"> </span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-var nsAdvancedPropertiesCommand = {</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineminus">-  },</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineminus">-</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.873"></a><span id="l1.873" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.874"></a><span id="l1.874" class="difflineminus">-</span>
<a href="#l1.875"></a><span id="l1.875" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.876"></a><span id="l1.876" class="difflineminus">-    // Launch AdvancedEdit dialog for the selected element</span>
<a href="#l1.877"></a><span id="l1.877" class="difflineminus">-    try {</span>
<a href="#l1.878"></a><span id="l1.878" class="difflineminus">-      var element = GetCurrentEditor().getSelectedElement(&quot;&quot;);</span>
<a href="#l1.879"></a><span id="l1.879" class="difflineminus">-      doAdvancedProperties(element);</span>
<a href="#l1.880"></a><span id="l1.880" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-  },</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-};</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineminus">-</span>
<a href="#l1.884"></a><span id="l1.884"> var nsColorPropertiesCommand = {</span>
<a href="#l1.885"></a><span id="l1.885">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.886"></a><span id="l1.886">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.887"></a><span id="l1.887">   },</span>
<a href="#l1.888"></a><span id="l1.888"> </span>
<a href="#l1.889"></a><span id="l1.889">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.890"></a><span id="l1.890">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.891"></a><span id="l1.891"> </span>
<a href="#l1.892"></a><span id="l1.892" class="difflineat">@@ -3193,88 +2687,16 @@ var nsRemoveNamedAnchorsCommand = {</span>
<a href="#l1.893"></a><span id="l1.893">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.894"></a><span id="l1.894"> </span>
<a href="#l1.895"></a><span id="l1.895">   doCommand(aCommand) {</span>
<a href="#l1.896"></a><span id="l1.896">     EditorRemoveTextProperty(&quot;name&quot;, &quot;&quot;);</span>
<a href="#l1.897"></a><span id="l1.897">     window.content.focus();</span>
<a href="#l1.898"></a><span id="l1.898">   },</span>
<a href="#l1.899"></a><span id="l1.899"> };</span>
<a href="#l1.900"></a><span id="l1.900"> </span>
<a href="#l1.901"></a><span id="l1.901" class="difflineminus">-var nsEditLinkCommand = {</span>
<a href="#l1.902"></a><span id="l1.902" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.903"></a><span id="l1.903" class="difflineminus">-    // Not really used -- this command is only in context menu, and we do enabling there</span>
<a href="#l1.904"></a><span id="l1.904" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.905"></a><span id="l1.905" class="difflineminus">-  },</span>
<a href="#l1.906"></a><span id="l1.906" class="difflineminus">-</span>
<a href="#l1.907"></a><span id="l1.907" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.908"></a><span id="l1.908" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.909"></a><span id="l1.909" class="difflineminus">-</span>
<a href="#l1.910"></a><span id="l1.910" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.911"></a><span id="l1.911" class="difflineminus">-    try {</span>
<a href="#l1.912"></a><span id="l1.912" class="difflineminus">-      var element = GetCurrentEditor().getSelectedElement(&quot;href&quot;);</span>
<a href="#l1.913"></a><span id="l1.913" class="difflineminus">-      if (element) {</span>
<a href="#l1.914"></a><span id="l1.914" class="difflineminus">-        editPage(element.href);</span>
<a href="#l1.915"></a><span id="l1.915" class="difflineminus">-      }</span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-    window.content.focus();</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-  },</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-};</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineminus">-</span>
<a href="#l1.921"></a><span id="l1.921" class="difflineminus">-var nsNormalModeCommand = {</span>
<a href="#l1.922"></a><span id="l1.922" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-    return IsHTMLEditor() &amp;&amp; IsDocumentEditable();</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-  },</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineminus">-</span>
<a href="#l1.926"></a><span id="l1.926" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.927"></a><span id="l1.927" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.928"></a><span id="l1.928" class="difflineminus">-</span>
<a href="#l1.929"></a><span id="l1.929" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.930"></a><span id="l1.930" class="difflineminus">-    SetEditMode(kDisplayModeNormal);</span>
<a href="#l1.931"></a><span id="l1.931" class="difflineminus">-  },</span>
<a href="#l1.932"></a><span id="l1.932" class="difflineminus">-};</span>
<a href="#l1.933"></a><span id="l1.933" class="difflineminus">-</span>
<a href="#l1.934"></a><span id="l1.934" class="difflineminus">-var nsAllTagsModeCommand = {</span>
<a href="#l1.935"></a><span id="l1.935" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-  },</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineminus">-</span>
<a href="#l1.939"></a><span id="l1.939" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineminus">-</span>
<a href="#l1.942"></a><span id="l1.942" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.943"></a><span id="l1.943" class="difflineminus">-    SetEditMode(kDisplayModeAllTags);</span>
<a href="#l1.944"></a><span id="l1.944" class="difflineminus">-  },</span>
<a href="#l1.945"></a><span id="l1.945" class="difflineminus">-};</span>
<a href="#l1.946"></a><span id="l1.946" class="difflineminus">-</span>
<a href="#l1.947"></a><span id="l1.947" class="difflineminus">-var nsHTMLSourceModeCommand = {</span>
<a href="#l1.948"></a><span id="l1.948" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.949"></a><span id="l1.949" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-  },</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.953"></a><span id="l1.953" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-    SetEditMode(kDisplayModeSource);</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-  },</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineminus">-};</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineminus">-</span>
<a href="#l1.960"></a><span id="l1.960" class="difflineminus">-var nsPreviewModeCommand = {</span>
<a href="#l1.961"></a><span id="l1.961" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.962"></a><span id="l1.962" class="difflineminus">-    return IsDocumentEditable() &amp;&amp; IsHTMLEditor();</span>
<a href="#l1.963"></a><span id="l1.963" class="difflineminus">-  },</span>
<a href="#l1.964"></a><span id="l1.964" class="difflineminus">-</span>
<a href="#l1.965"></a><span id="l1.965" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.966"></a><span id="l1.966" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.967"></a><span id="l1.967" class="difflineminus">-</span>
<a href="#l1.968"></a><span id="l1.968" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-    SetEditMode(kDisplayModePreview);</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-  },</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-};</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-</span>
<a href="#l1.973"></a><span id="l1.973"> var nsInsertOrEditTableCommand = {</span>
<a href="#l1.974"></a><span id="l1.974">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.975"></a><span id="l1.975">     return IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML();</span>
<a href="#l1.976"></a><span id="l1.976">   },</span>
<a href="#l1.977"></a><span id="l1.977"> </span>
<a href="#l1.978"></a><span id="l1.978">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.979"></a><span id="l1.979">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.980"></a><span id="l1.980"> </span>
<a href="#l1.981"></a><span id="l1.981" class="difflineat">@@ -3594,33 +3016,16 @@ var nsDeleteTableCellContentsCommand = {</span>
<a href="#l1.982"></a><span id="l1.982">   doCommand(aCommand) {</span>
<a href="#l1.983"></a><span id="l1.983">     try {</span>
<a href="#l1.984"></a><span id="l1.984">       GetCurrentTableEditor().deleteTableCellContents();</span>
<a href="#l1.985"></a><span id="l1.985">     } catch (e) {}</span>
<a href="#l1.986"></a><span id="l1.986">     window.content.focus();</span>
<a href="#l1.987"></a><span id="l1.987">   },</span>
<a href="#l1.988"></a><span id="l1.988"> };</span>
<a href="#l1.989"></a><span id="l1.989"> </span>
<a href="#l1.990"></a><span id="l1.990" class="difflineminus">-var nsNormalizeTableCommand = {</span>
<a href="#l1.991"></a><span id="l1.991" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.992"></a><span id="l1.992" class="difflineminus">-    return IsInTable();</span>
<a href="#l1.993"></a><span id="l1.993" class="difflineminus">-  },</span>
<a href="#l1.994"></a><span id="l1.994" class="difflineminus">-</span>
<a href="#l1.995"></a><span id="l1.995" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.996"></a><span id="l1.996" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.997"></a><span id="l1.997" class="difflineminus">-</span>
<a href="#l1.998"></a><span id="l1.998" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-    // Use nullptr to let editor find table enclosing current selection</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-    try {</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-      GetCurrentTableEditor().normalizeTable(null);</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineminus">-    } catch (e) {}</span>
<a href="#l1.1003"></a><span id="l1.1003" class="difflineminus">-    window.content.focus();</span>
<a href="#l1.1004"></a><span id="l1.1004" class="difflineminus">-  },</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-};</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-</span>
<a href="#l1.1007"></a><span id="l1.1007"> var nsJoinTableCellsCommand = {</span>
<a href="#l1.1008"></a><span id="l1.1008">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.1009"></a><span id="l1.1009">     if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l1.1010"></a><span id="l1.1010">       try {</span>
<a href="#l1.1011"></a><span id="l1.1011">         var editor = GetCurrentTableEditor();</span>
<a href="#l1.1012"></a><span id="l1.1012">         var tagNameObj = { value: &quot;&quot; };</span>
<a href="#l1.1013"></a><span id="l1.1013">         var countObj = { value: 0 };</span>
<a href="#l1.1014"></a><span id="l1.1014">         var cell = editor.getSelectedOrParentTableElement(tagNameObj, countObj);</span>
<a href="#l1.1015"></a><span id="l1.1015" class="difflineat">@@ -3728,57 +3133,16 @@ var nsTableOrCellColorCommand = {</span>
<a href="#l1.1016"></a><span id="l1.1016">   getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1017"></a><span id="l1.1017">   doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1018"></a><span id="l1.1018"> </span>
<a href="#l1.1019"></a><span id="l1.1019">   doCommand(aCommand) {</span>
<a href="#l1.1020"></a><span id="l1.1020">     EditorSelectColor(&quot;TableOrCell&quot;);</span>
<a href="#l1.1021"></a><span id="l1.1021">   },</span>
<a href="#l1.1022"></a><span id="l1.1022"> };</span>
<a href="#l1.1023"></a><span id="l1.1023"> </span>
<a href="#l1.1024"></a><span id="l1.1024" class="difflineminus">-var nsPreferencesCommand = {</span>
<a href="#l1.1025"></a><span id="l1.1025" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.1026"></a><span id="l1.1026" class="difflineminus">-    return true;</span>
<a href="#l1.1027"></a><span id="l1.1027" class="difflineminus">-  },</span>
<a href="#l1.1028"></a><span id="l1.1028" class="difflineminus">-</span>
<a href="#l1.1029"></a><span id="l1.1029" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1031"></a><span id="l1.1031" class="difflineminus">-</span>
<a href="#l1.1032"></a><span id="l1.1032" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.1033"></a><span id="l1.1033" class="difflineminus">-    goPreferences(&quot;composer_pane&quot;);</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-  },</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-};</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-var nsFinishHTMLSource = {</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineminus">-    return true;</span>
<a href="#l1.1040"></a><span id="l1.1040" class="difflineminus">-  },</span>
<a href="#l1.1041"></a><span id="l1.1041" class="difflineminus">-</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-    // In editor.js</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineminus">-    SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineminus">-  },</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineminus">-};</span>
<a href="#l1.1050"></a><span id="l1.1050" class="difflineminus">-</span>
<a href="#l1.1051"></a><span id="l1.1051" class="difflineminus">-var nsCancelHTMLSource = {</span>
<a href="#l1.1052"></a><span id="l1.1052" class="difflineminus">-  isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.1053"></a><span id="l1.1053" class="difflineminus">-    return true;</span>
<a href="#l1.1054"></a><span id="l1.1054" class="difflineminus">-  },</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-  getCommandStateParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineminus">-  doCommandParams(aCommand, aParams, aRefCon) {},</span>
<a href="#l1.1058"></a><span id="l1.1058" class="difflineminus">-</span>
<a href="#l1.1059"></a><span id="l1.1059" class="difflineminus">-  doCommand(aCommand) {</span>
<a href="#l1.1060"></a><span id="l1.1060" class="difflineminus">-    // In editor.js</span>
<a href="#l1.1061"></a><span id="l1.1061" class="difflineminus">-    CancelHTMLSource();</span>
<a href="#l1.1062"></a><span id="l1.1062" class="difflineminus">-  },</span>
<a href="#l1.1063"></a><span id="l1.1063" class="difflineminus">-};</span>
<a href="#l1.1064"></a><span id="l1.1064" class="difflineminus">-</span>
<a href="#l1.1065"></a><span id="l1.1065"> var nsConvertToTable = {</span>
<a href="#l1.1066"></a><span id="l1.1066">   isCommandEnabled(aCommand, dummy) {</span>
<a href="#l1.1067"></a><span id="l1.1067">     if (IsDocumentEditable() &amp;&amp; IsEditingRenderedHTML()) {</span>
<a href="#l1.1068"></a><span id="l1.1068">       var selection;</span>
<a href="#l1.1069"></a><span id="l1.1069">       try {</span>
<a href="#l1.1070"></a><span id="l1.1070">         selection = GetCurrentEditor().selection;</span>
<a href="#l1.1071"></a><span id="l1.1071">       } catch (e) {}</span>
<a href="#l1.1072"></a><span id="l1.1072"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/compose/content/dialogs/EdDialogCommon.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/compose/content/dialogs/EdDialogCommon.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -356,35 +356,16 @@ function setColorWell(ColorWellID, color</span>
<a href="#l2.4"></a><span id="l2.4">     } else {</span>
<a href="#l2.5"></a><span id="l2.5">       colorWell.removeAttribute(&quot;default&quot;);</span>
<a href="#l2.6"></a><span id="l2.6">       // Use setAttribute so colorwell can be a XUL element, such as button</span>
<a href="#l2.7"></a><span id="l2.7">       colorWell.setAttribute(&quot;style&quot;, &quot;background-color:&quot; + color);</span>
<a href="#l2.8"></a><span id="l2.8">     }</span>
<a href="#l2.9"></a><span id="l2.9">   }</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function getColorAndSetColorWell(ColorPickerID, ColorWellID) {</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  var color = getColor(ColorPickerID);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  setColorWell(ColorWellID, color);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  return color;</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-}</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-function InitMoreFewer() {</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-  // Set SeeMore bool to the OPPOSITE of the current state,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  //   which is automatically saved by using the 'persist=&quot;more&quot;'</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-  //   attribute on the gDialog.MoreFewerButton button</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-  //   onMoreFewer will toggle it and redraw the dialog</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-  SeeMore = gDialog.MoreFewerButton.getAttribute(&quot;more&quot;) != &quot;1&quot;;</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-  onMoreFewer();</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  gDialog.MoreFewerButton.setAttribute(</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    &quot;accesskey&quot;,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-    GetString(&quot;PropertiesAccessKey&quot;)</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  );</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-}</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-</span>
<a href="#l2.31"></a><span id="l2.31"> function onMoreFewer() {</span>
<a href="#l2.32"></a><span id="l2.32">   if (SeeMore) {</span>
<a href="#l2.33"></a><span id="l2.33">     gDialog.MoreSection.collapsed = true;</span>
<a href="#l2.34"></a><span id="l2.34">     gDialog.MoreFewerButton.setAttribute(&quot;more&quot;, &quot;0&quot;);</span>
<a href="#l2.35"></a><span id="l2.35">     gDialog.MoreFewerButton.setAttribute(&quot;label&quot;, GetString(&quot;MoreProperties&quot;));</span>
<a href="#l2.36"></a><span id="l2.36">     SeeMore = false;</span>
<a href="#l2.37"></a><span id="l2.37">   } else {</span>
<a href="#l2.38"></a><span id="l2.38">     gDialog.MoreSection.collapsed = false;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineat">@@ -441,104 +422,16 @@ function GetLocalFileURL(filterType) {</span>
<a href="#l2.40"></a><span id="l2.40">         return;</span>
<a href="#l2.41"></a><span id="l2.41">       }</span>
<a href="#l2.42"></a><span id="l2.42">       SaveFilePickerDirectory(fp, fileType);</span>
<a href="#l2.43"></a><span id="l2.43">       resolve(fp.fileURL.spec);</span>
<a href="#l2.44"></a><span id="l2.44">     });</span>
<a href="#l2.45"></a><span id="l2.45">   });</span>
<a href="#l2.46"></a><span id="l2.46"> }</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-function GetMetaElementByAttribute(name, value) {</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-  if (name) {</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-    name = name.toLowerCase();</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    let editor = GetCurrentEditor();</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    try {</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-      return editor.document.querySelector(</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-        &quot;meta[&quot; + name + '=&quot;' + value + '&quot;]'</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-      );</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    } catch (e) {}</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  }</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  return null;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-}</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-function CreateMetaElementWithAttribute(name, value) {</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-  let editor = GetCurrentEditor();</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  try {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    let metaElement = editor.createElementWithDefaults(&quot;meta&quot;);</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    if (name) {</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-      metaElement.setAttribute(name, value);</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    }</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    return metaElement;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  } catch (e) {}</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  return null;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-}</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-// Change &quot;content&quot; attribute on a META element,</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-//   or delete entire element it if content is empty</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-// This uses undoable editor transactions</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-function SetMetaElementContent(metaElement, content, insertNew, prepend) {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  if (metaElement) {</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    var editor = GetCurrentEditor();</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    try {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-      if (!content || content == &quot;&quot;) {</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-        if (!insertNew) {</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-          editor.deleteNode(metaElement);</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-        }</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-      } else if (insertNew) {</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-        metaElement.setAttribute(&quot;content&quot;, content);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-        if (prepend) {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-          PrependHeadElement(metaElement);</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-        } else {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-          AppendHeadElement(metaElement);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-        }</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-      } else {</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-        editor.setAttribute(metaElement, &quot;content&quot;, content);</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-      }</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    } catch (e) {}</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-  }</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-}</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-function GetHeadElement() {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-  try {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    return editor.document.querySelector(&quot;head&quot;);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-  } catch (e) {}</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-  return null;</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-}</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-function PrependHeadElement(element) {</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-  var head = GetHeadElement();</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-  if (head) {</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-    var editor = GetCurrentEditor();</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    try {</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-      // Use editor's undoable transaction</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      // Last param &quot;true&quot; says &quot;don't change the selection&quot;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-      editor.insertNode(element, head, 0, true);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    } catch (e) {}</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-  }</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-}</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-function AppendHeadElement(element) {</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-  var head = GetHeadElement();</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-  if (head) {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-    var position = 0;</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-    if (head.hasChildNodes()) {</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-      position = head.childNodes.length;</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    }</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-    var editor = GetCurrentEditor();</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    try {</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-      // Use editor's undoable transaction</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-      // Last param &quot;true&quot; says &quot;don't change the selection&quot;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-      editor.insertNode(element, head, position, true);</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    } catch (e) {}</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  }</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-}</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-</span>
<a href="#l2.136"></a><span id="l2.136"> function SetWindowLocation() {</span>
<a href="#l2.137"></a><span id="l2.137">   gLocation = document.getElementById(&quot;location&quot;);</span>
<a href="#l2.138"></a><span id="l2.138">   if (gLocation) {</span>
<a href="#l2.139"></a><span id="l2.139">     window.screenX = Math.max(</span>
<a href="#l2.140"></a><span id="l2.140">       0,</span>
<a href="#l2.141"></a><span id="l2.141">       Math.min(</span>
<a href="#l2.142"></a><span id="l2.142">         window.opener.screenX + Number(gLocation.getAttribute(&quot;offsetX&quot;)),</span>
<a href="#l2.143"></a><span id="l2.143">         screen.availWidth - window.outerWidth</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineat">@@ -673,233 +566,16 @@ var NotAnInlineParent = [</span>
<a href="#l2.145"></a><span id="l2.145">   &quot;table&quot;,</span>
<a href="#l2.146"></a><span id="l2.146">   &quot;tbody&quot;,</span>
<a href="#l2.147"></a><span id="l2.147">   &quot;tfoot&quot;,</span>
<a href="#l2.148"></a><span id="l2.148">   &quot;thead&quot;,</span>
<a href="#l2.149"></a><span id="l2.149">   &quot;tr&quot;,</span>
<a href="#l2.150"></a><span id="l2.150">   &quot;ul&quot;,</span>
<a href="#l2.151"></a><span id="l2.151"> ];</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-function nodeIsBreak(editor, node) {</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-  // XXX This doesn't work because .localName is lowercase (see bug 1306060).</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-  return !node || node.localName == &quot;BR&quot; || editor.nodeIsBlock(node);</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-}</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-function InsertElementAroundSelection(element) {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-  editor.beginTransaction();</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-  try {</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    // First get the selection as a single range</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    var range, start, end, offset;</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-    var count = editor.selection.rangeCount;</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-    if (count == 1) {</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-      range = editor.selection.getRangeAt(0).cloneRange();</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-    } else {</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-      range = editor.document.createRange();</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-      start = editor.selection.getRangeAt(0);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-      range.setStart(start.startContainer, start.startOffset);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-      end = editor.selection.getRangeAt(--count);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-      range.setEnd(end.endContainer, end.endOffset);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    }</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    // Flatten the selection to child nodes of the common ancestor</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    while (range.startContainer != range.commonAncestorContainer) {</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-      range.setStartBefore(range.startContainer);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-    }</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    while (range.endContainer != range.commonAncestorContainer) {</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-      range.setEndAfter(range.endContainer);</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    }</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-    if (editor.nodeIsBlock(element)) {</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-      // Block element parent must be a valid block</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-      while (!IsBlockParent.includes(range.commonAncestorContainer.localName)) {</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-        range.selectNode(range.commonAncestorContainer);</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-      }</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    } else if (!nodeIsBreak(editor, range.commonAncestorContainer)) {</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-      // Fail if we're not inserting a block (use setInlineProperty instead)</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-      return false;</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-    } else if (</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-      NotAnInlineParent.includes(range.commonAncestorContainer.localName)</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    ) {</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-      // Inline element parent must not be an invalid block</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-      do {</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-        range.selectNode(range.commonAncestorContainer);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-      } while (</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-        NotAnInlineParent.includes(range.commonAncestorContainer.localName)</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-      );</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-    } else {</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-      // Further insert block check</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-      for (var i = range.startOffset; ; i++) {</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-        if (i == range.endOffset) {</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-          return false;</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-        } else if (</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-          nodeIsBreak(editor, range.commonAncestorContainer.childNodes[i])</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-        ) {</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-          break;</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-        }</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-      }</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-    }</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-    // The range may be contained by body text, which should all be selected.</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    offset = range.startOffset;</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    start = range.startContainer.childNodes[offset];</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-    if (!nodeIsBreak(editor, start)) {</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-      while (!nodeIsBreak(editor, start.previousSibling)) {</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-        start = start.previousSibling;</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-        offset--;</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-      }</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-    }</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-    end = range.endContainer.childNodes[range.endOffset];</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-    if (end &amp;&amp; !nodeIsBreak(editor, end.previousSibling)) {</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-      while (!nodeIsBreak(editor, end)) {</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-        end = end.nextSibling;</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-      }</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-    }</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    // Now insert the node</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-    editor.insertNode(element, range.commonAncestorContainer, offset, true);</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-    offset = element.childNodes.length;</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-    if (!editor.nodeIsBlock(element)) {</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-      editor.setShouldTxnSetSelection(false);</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-    }</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-    // Move all the old child nodes to the element</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    var empty = true;</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    while (start != end) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-      var next = start.nextSibling;</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-      editor.deleteNode(start);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-      editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-      empty = false;</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-      start = next;</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    }</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-    if (!editor.nodeIsBlock(element)) {</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-      editor.setShouldTxnSetSelection(true);</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    } else {</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-      // Also move a trailing &lt;br&gt;</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-      // XXX This doesn't work because .localName is lowercase (see bug 1306060).</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-      if (start &amp;&amp; start.localName == &quot;BR&quot;) {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-        editor.deleteNode(start);</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-        editor.insertNode(start, element, element.childNodes.length);</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-        empty = false;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-      }</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-      // Still nothing? Insert a &lt;br&gt; so the node is not empty</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-      if (empty) {</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-        editor.insertNode(</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-          editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-          element,</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-          element.childNodes.length</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-        );</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-      }</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-      // Hack to set the selection just inside the element</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-      editor.insertNode(editor.document.createTextNode(&quot;&quot;), element, offset);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-    }</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-  } finally {</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    editor.endTransaction();</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-  }</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-  return true;</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-}</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-function nodeIsBlank(node) {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-  return node &amp;&amp; node.nodeType == Node.TEXT_NODE &amp;&amp; !/\S/.test(node.data);</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-}</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-function nodeBeginsBlock(editor, node) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-  while (nodeIsBlank(node)) {</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-    node = node.nextSibling;</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-  }</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  return nodeIsBreak(editor, node);</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-}</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-function nodeEndsBlock(editor, node) {</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-  while (nodeIsBlank(node)) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-    node = node.previousSibling;</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-  }</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-  return nodeIsBreak(editor, node);</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-}</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-// C++ function isn't exposed to JS :-(</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-function RemoveBlockContainer(element) {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-  editor.beginTransaction();</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-  try {</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-    var range = editor.document.createRange();</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    range.selectNode(element);</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-    var offset = range.startOffset;</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-    var parent = element.parentNode;</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-    // May need to insert a break after the removed element</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    if (</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-      !nodeBeginsBlock(editor, element.nextSibling) &amp;&amp;</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-      !nodeEndsBlock(editor, element.lastChild)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    ) {</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-      editor.insertNode(</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-        editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-        parent,</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-        range.endOffset</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-      );</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-    }</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-    // May need to insert a break before the removed element, or if it was empty</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-    if (</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-      !nodeEndsBlock(editor, element.previousSibling) &amp;&amp;</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-      !nodeBeginsBlock(editor, element.firstChild || element.nextSibling)</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-    ) {</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-      editor.insertNode(</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-        editor.createElementWithDefaults(&quot;br&quot;),</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-        parent,</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-        offset++</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-      );</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-    }</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-    // Now remove the element</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-    editor.deleteNode(element);</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    // Need to copy the contained nodes?</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-    for (var i = 0; i &lt; element.childNodes.length; i++) {</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-      editor.insertNode(</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-        element.childNodes[i].cloneNode(true),</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-        parent,</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-        offset++</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-      );</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-    }</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-  } finally {</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-    editor.endTransaction();</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-  }</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-}</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-// C++ function isn't exposed to JS :-(</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-function RemoveContainer(element) {</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-  editor.beginTransaction();</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-  try {</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-    var range = editor.document.createRange();</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-    var parent = element.parentNode;</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-    // Allow for automatic joining of text nodes</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-    // so we can't delete the container yet</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-    // so we need to copy the contained nodes</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-    for (var i = 0; i &lt; element.childNodes.length; i++) {</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-      range.selectNode(element);</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-      editor.insertNode(</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-        element.childNodes[i].cloneNode(true),</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-        parent,</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-        range.startOffset</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-      );</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-    }</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-    // Now remove the element</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-    editor.deleteNode(element);</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-  } finally {</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-    editor.endTransaction();</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-  }</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-}</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-</span>
<a href="#l2.370"></a><span id="l2.370"> function FillLinkMenulist(linkMenulist, headingsArray) {</span>
<a href="#l2.371"></a><span id="l2.371">   var menupopup = linkMenulist.firstElementChild;</span>
<a href="#l2.372"></a><span id="l2.372">   var editor = GetCurrentEditor();</span>
<a href="#l2.373"></a><span id="l2.373">   try {</span>
<a href="#l2.374"></a><span id="l2.374">     var treeWalker = editor.document.createTreeWalker(</span>
<a href="#l2.375"></a><span id="l2.375">       editor.document,</span>
<a href="#l2.376"></a><span id="l2.376">       1,</span>
<a href="#l2.377"></a><span id="l2.377">       null,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/compose/content/editor.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/compose/content/editor.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -92,126 +92,19 @@ var gFontSizeNames = [</span>
<a href="#l3.4"></a><span id="l3.4">   &quot;medium&quot;,</span>
<a href="#l3.5"></a><span id="l3.5">   &quot;large&quot;,</span>
<a href="#l3.6"></a><span id="l3.6">   &quot;x-large&quot;,</span>
<a href="#l3.7"></a><span id="l3.7">   &quot;xx-large&quot;,</span>
<a href="#l3.8"></a><span id="l3.8"> ];</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> var nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-var kEditorToolbarPrefs = &quot;editor.toolbars.showbutton.&quot;;</span>
<a href="#l3.13"></a><span id="l3.13"> var kUseCssPref = &quot;editor.use_css&quot;;</span>
<a href="#l3.14"></a><span id="l3.14"> var kCRInParagraphsPref = &quot;editor.CR_creates_new_p&quot;;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-function ShowHideToolbarSeparators(toolbar) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  // Make sure the toolbar actually exists.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-  if (!toolbar) {</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    return;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-  }</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-  var children = toolbar.children;</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-  var separator = null;</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-  var hideSeparator = true;</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-  for (var i = 0; children[i].localName != &quot;spacer&quot;; i++) {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-    if (children[i].localName == &quot;toolbarseparator&quot;) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-      if (separator) {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-        separator.hidden = true;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-      }</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineminus">-      separator = children[i];</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-    } else if (!children[i].hidden) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-      if (separator) {</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineminus">-        separator.hidden = hideSeparator;</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineminus">-      }</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-      separator = null;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-      hideSeparator = false;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    }</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineminus">-  }</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-}</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-function ShowHideToolbarButtons() {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-  let array = Services.prefs.getChildList(kEditorToolbarPrefs);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-  for (let i in array) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    let prefName = array[i];</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-    let id = prefName.substr(kEditorToolbarPrefs.length);</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-    let button =</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-      document.getElementById(id + &quot;Button&quot;) ||</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-      document.getElementById(id + &quot;-button&quot;);</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-    if (button) {</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-      button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    }</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-  }</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-  ShowHideToolbarSeparators(document.getElementById(&quot;EditToolbar&quot;));</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-  ShowHideToolbarSeparators(document.getElementById(&quot;FormatToolbar&quot;));</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-}</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-function nsPrefListener(prefName) {</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-  this.startup(prefName);</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-}</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">-// implements nsIObserver</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">-nsPrefListener.prototype = {</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-  domain: &quot;&quot;,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-  startup(prefName) {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-    this.domain = prefName;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineminus">-    try {</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      Services.prefs.addObserver(this.domain, this);</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineminus">-    } catch (ex) {</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineminus">-      dump(&quot;Failed to observe prefs: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineminus">-    }</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineminus">-  },</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-  shutdown() {</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    try {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-      Services.prefs.removeObserver(this.domain, this);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-    } catch (ex) {</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineminus">-      dump(&quot;Failed to remove pref observers: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.76"></a><span id="l3.76" class="difflineminus">-    }</span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-  },</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-  observe(subject, topic, prefName) {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineminus">-    if (!IsHTMLEditor()) {</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-      return;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    }</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineminus">-    // verify that we're changing a button pref</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-    if (topic != &quot;nsPref:changed&quot;) {</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineminus">-      return;</span>
<a href="#l3.85"></a><span id="l3.85" class="difflineminus">-    }</span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    let editor = GetCurrentEditor();</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineminus">-    if (prefName == kUseCssPref) {</span>
<a href="#l3.89"></a><span id="l3.89" class="difflineminus">-      let cmd = document.getElementById(&quot;cmd_highlight&quot;);</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-      if (cmd) {</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-        let useCSS = Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineminus">-</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-        if (useCSS &amp;&amp; editor) {</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineminus">-          let mixedObj = {};</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-          let state = editor.getHighlightColorState(mixedObj);</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineminus">-          cmd.setAttribute(&quot;state&quot;, state);</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineminus">-          cmd.collapsed = false;</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineminus">-        } else {</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineminus">-          cmd.setAttribute(&quot;state&quot;, &quot;transparent&quot;);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-          cmd.collapsed = true;</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-        }</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-</span>
<a href="#l3.103"></a><span id="l3.103" class="difflineminus">-        if (editor) {</span>
<a href="#l3.104"></a><span id="l3.104" class="difflineminus">-          editor.isCSSEnabled = useCSS;</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-        }</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-      }</span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    } else if (prefName.startsWith(kEditorToolbarPrefs)) {</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-      let id = prefName.substr(kEditorToolbarPrefs.length) + &quot;Button&quot;;</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-      let button = document.getElementById(id);</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-      if (button) {</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-        button.hidden = !Services.prefs.getBoolPref(prefName);</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-        ShowHideToolbarSeparators(button.parentNode);</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineminus">-      }</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineminus">-    } else if (editor &amp;&amp; prefName == kCRInParagraphsPref) {</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-      editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineminus">-        prefName</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineminus">-      );</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineminus">-    }</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineminus">-  },</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-};</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-</span>
<a href="#l3.122"></a><span id="l3.122"> const gSourceTextListener = {</span>
<a href="#l3.123"></a><span id="l3.123">   NotifyDocumentCreated() {},</span>
<a href="#l3.124"></a><span id="l3.124">   NotifyDocumentWillBeDestroyed() {},</span>
<a href="#l3.125"></a><span id="l3.125">   NotifyDocumentStateChanged(isChanged) {</span>
<a href="#l3.126"></a><span id="l3.126">     window.updateCommands(&quot;save&quot;);</span>
<a href="#l3.127"></a><span id="l3.127">   },</span>
<a href="#l3.128"></a><span id="l3.128"> };</span>
<a href="#l3.129"></a><span id="l3.129"> </span>
<a href="#l3.130"></a><span id="l3.130" class="difflineat">@@ -312,102 +205,16 @@ var gEditorDocumentObserver = {</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">           //  and extra styles for showing anchors, table borders, smileys, etc</span>
<a href="#l3.133"></a><span id="l3.133">           editor.addOverrideStyleSheet(kNormalStyleSheet);</span>
<a href="#l3.134"></a><span id="l3.134"> </span>
<a href="#l3.135"></a><span id="l3.135">           // remove contenteditable stylesheets if they were applied by the</span>
<a href="#l3.136"></a><span id="l3.136">           // editingSession</span>
<a href="#l3.137"></a><span id="l3.137">           editor.removeOverrideStyleSheet(kContentEditableStyleSheet);</span>
<a href="#l3.138"></a><span id="l3.138">         } catch (e) {}</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-        // Things for just the Web Composer application</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineminus">-        if (IsWebComposer()) {</span>
<a href="#l3.142"></a><span id="l3.142" class="difflineminus">-          InlineSpellCheckerUI.init(editor);</span>
<a href="#l3.143"></a><span id="l3.143" class="difflineminus">-          document</span>
<a href="#l3.144"></a><span id="l3.144" class="difflineminus">-            .getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l3.145"></a><span id="l3.145" class="difflineminus">-            .setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l3.146"></a><span id="l3.146" class="difflineminus">-</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineminus">-          editor.returnInParagraphCreatesNewParagraph = Services.prefs.getBoolPref(</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-            kCRInParagraphsPref</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-          );</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineminus">-</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineminus">-          // Set focus to content window if not a mail composer</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineminus">-          // Race conditions prevent us from setting focus here</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-          //   when loading a url into blank window</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineminus">-          setTimeout(SetFocusOnStartup, 0);</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineminus">-</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-          // Call EditorSetDefaultPrefsAndDoctype first so it gets the default author before initing toolbars</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineminus">-          editor.enableUndo(false);</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineminus">-          EditorSetDefaultPrefsAndDoctype();</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineminus">-          editor.resetModificationCount();</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineminus">-          editor.enableUndo(true);</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineminus">-</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-          // We may load a text document into an html editor,</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineminus">-          //   so be sure editortype is set correctly</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-          // XXX We really should use the &quot;real&quot; plaintext editor for this!</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineminus">-          if (editor.contentsMIMEType == &quot;text/plain&quot;) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineminus">-            try {</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-              GetCurrentEditorElement().editortype = &quot;text&quot;;</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineminus">-            } catch (e) {</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineminus">-              dump(e) + &quot;\n&quot;;</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineminus">-            }</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineminus">-            // Hide or disable UI not used for plaintext editing</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineminus">-            HideItem(&quot;FormatToolbar&quot;);</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineminus">-            HideItem(&quot;EditModeToolbar&quot;);</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-            HideItem(&quot;formatMenu&quot;);</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineminus">-            HideItem(&quot;tableMenu&quot;);</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineminus">-            HideItem(&quot;menu_validate&quot;);</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-            HideItem(&quot;sep_validate&quot;);</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-            HideItem(&quot;previewButton&quot;);</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineminus">-            HideItem(&quot;imageButton&quot;);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-            HideItem(&quot;linkButton&quot;);</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-            HideItem(&quot;namedAnchorButton&quot;);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-            HideItem(&quot;hlineButton&quot;);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-            HideItem(&quot;tableButton&quot;);</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-            HideItem(&quot;fileExportToText&quot;);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-            HideItem(&quot;previewInBrowser&quot;);</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-            /* XXX When paste actually converts formatted rich text to pretty formatted plain text</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineminus">-       and pasteNoFormatting is fixed to paste the text without formatting (what paste</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineminus">-       currently does), then this item shouldn't be hidden: */</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineminus">-            HideItem(&quot;menu_pasteNoFormatting&quot;);</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineminus">-</span>
<a href="#l3.194"></a><span id="l3.194" class="difflineminus">-            HideItem(&quot;cmd_viewFormatToolbar&quot;);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineminus">-            HideItem(&quot;cmd_viewEditModeToolbar&quot;);</span>
<a href="#l3.196"></a><span id="l3.196" class="difflineminus">-</span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-            HideItem(&quot;viewSep1&quot;);</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-            HideItem(&quot;viewNormalMode&quot;);</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineminus">-            HideItem(&quot;viewAllTagsMode&quot;);</span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-            HideItem(&quot;viewSourceMode&quot;);</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineminus">-            HideItem(&quot;viewPreviewMode&quot;);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineminus">-            HideItem(&quot;structSpacer&quot;);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineminus">-            // Hide everything in &quot;Insert&quot; except for &quot;Symbols&quot;</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-            let menuPopupChildren = document.querySelectorAll(</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineminus">-              '[id=&quot;insertMenuPopup&quot;] &gt; :not(#insertChars)'</span>
<a href="#l3.208"></a><span id="l3.208" class="difflineminus">-            );</span>
<a href="#l3.209"></a><span id="l3.209" class="difflineminus">-            for (let i = 0; i &lt; menuPopupChildren.length; i++) {</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineminus">-              menuPopupChildren.item(i).hidden = true;</span>
<a href="#l3.211"></a><span id="l3.211" class="difflineminus">-            }</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineminus">-          }</span>
<a href="#l3.213"></a><span id="l3.213" class="difflineminus">-</span>
<a href="#l3.214"></a><span id="l3.214" class="difflineminus">-          // Set window title</span>
<a href="#l3.215"></a><span id="l3.215" class="difflineminus">-          UpdateWindowTitle();</span>
<a href="#l3.216"></a><span id="l3.216" class="difflineminus">-</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-          // We must wait until document is created to get proper Url</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-          // (Windows may load with local file paths)</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-          SetSaveAndPublishUI(GetDocumentUrl());</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-          // Start in &quot;Normal&quot; edit mode</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineminus">-          SetDisplayMode(kDisplayModeNormal);</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineminus">-        }</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineminus">-</span>
<a href="#l3.225"></a><span id="l3.225">         // Add mouse click watcher if right type of editor</span>
<a href="#l3.226"></a><span id="l3.226">         if (IsHTMLEditor()) {</span>
<a href="#l3.227"></a><span id="l3.227">           // Force color widgets to update</span>
<a href="#l3.228"></a><span id="l3.228">           onFontColorChange();</span>
<a href="#l3.229"></a><span id="l3.229">           onBackgroundColorChange();</span>
<a href="#l3.230"></a><span id="l3.230">         }</span>
<a href="#l3.231"></a><span id="l3.231">         break;</span>
<a href="#l3.232"></a><span id="l3.232"> </span>
<a href="#l3.233"></a><span id="l3.233" class="difflineat">@@ -542,32 +349,16 @@ function EditorSharedStartup() {</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235"> function SafeSetAttribute(nodeID, attributeName, attributeValue) {</span>
<a href="#l3.236"></a><span id="l3.236">   var theNode = document.getElementById(nodeID);</span>
<a href="#l3.237"></a><span id="l3.237">   if (theNode) {</span>
<a href="#l3.238"></a><span id="l3.238">     theNode.setAttribute(attributeName, attributeValue);</span>
<a href="#l3.239"></a><span id="l3.239">   }</span>
<a href="#l3.240"></a><span id="l3.240"> }</span>
<a href="#l3.241"></a><span id="l3.241"> </span>
<a href="#l3.242"></a><span id="l3.242" class="difflineminus">-function DocumentHasBeenSaved() {</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineminus">-  var fileurl = &quot;&quot;;</span>
<a href="#l3.244"></a><span id="l3.244" class="difflineminus">-  try {</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-    fileurl = GetDocumentUrl();</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-  } catch (e) {</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-    return false;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineminus">-  }</span>
<a href="#l3.249"></a><span id="l3.249" class="difflineminus">-</span>
<a href="#l3.250"></a><span id="l3.250" class="difflineminus">-  if (!fileurl || IsUrlAboutBlank(fileurl)) {</span>
<a href="#l3.251"></a><span id="l3.251" class="difflineminus">-    return false;</span>
<a href="#l3.252"></a><span id="l3.252" class="difflineminus">-  }</span>
<a href="#l3.253"></a><span id="l3.253" class="difflineminus">-</span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-  // We have a file URL already</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-  return true;</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineminus">-}</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-</span>
<a href="#l3.258"></a><span id="l3.258"> async function CheckAndSaveDocument(command, allowDontSave) {</span>
<a href="#l3.259"></a><span id="l3.259">   var document;</span>
<a href="#l3.260"></a><span id="l3.260">   try {</span>
<a href="#l3.261"></a><span id="l3.261">     // if we don't have an editor or an document, bail</span>
<a href="#l3.262"></a><span id="l3.262">     var editor = GetCurrentEditor();</span>
<a href="#l3.263"></a><span id="l3.263">     document = editor.document;</span>
<a href="#l3.264"></a><span id="l3.264">     if (!document) {</span>
<a href="#l3.265"></a><span id="l3.265">       return true;</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineat">@@ -579,123 +370,74 @@ async function CheckAndSaveDocument(comm</span>
<a href="#l3.267"></a><span id="l3.267">   if (!IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged()) {</span>
<a href="#l3.268"></a><span id="l3.268">     return true;</span>
<a href="#l3.269"></a><span id="l3.269">   }</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">   // call window.focus, since we need to pop up a dialog</span>
<a href="#l3.272"></a><span id="l3.272">   // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l3.273"></a><span id="l3.273">   top.document.commandDispatcher.focusedWindow.focus();</span>
<a href="#l3.274"></a><span id="l3.274"> </span>
<a href="#l3.275"></a><span id="l3.275" class="difflineminus">-  var scheme = GetScheme(GetDocumentUrl());</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-  var doPublish = scheme &amp;&amp; scheme != &quot;file&quot;;</span>
<a href="#l3.277"></a><span id="l3.277" class="difflineminus">-</span>
<a href="#l3.278"></a><span id="l3.278">   var strID;</span>
<a href="#l3.279"></a><span id="l3.279">   switch (command) {</span>
<a href="#l3.280"></a><span id="l3.280">     case &quot;cmd_close&quot;:</span>
<a href="#l3.281"></a><span id="l3.281">       strID = &quot;BeforeClosing&quot;;</span>
<a href="#l3.282"></a><span id="l3.282">       break;</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineminus">-    case &quot;cmd_preview&quot;:</span>
<a href="#l3.284"></a><span id="l3.284" class="difflineminus">-      strID = &quot;BeforePreview&quot;;</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineminus">-      break;</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-    case &quot;cmd_editSendPage&quot;:</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineminus">-      strID = &quot;SendPageReason&quot;;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineminus">-      break;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-    case &quot;cmd_validate&quot;:</span>
<a href="#l3.290"></a><span id="l3.290" class="difflineminus">-      strID = &quot;BeforeValidate&quot;;</span>
<a href="#l3.291"></a><span id="l3.291" class="difflineminus">-      break;</span>
<a href="#l3.292"></a><span id="l3.292">   }</span>
<a href="#l3.293"></a><span id="l3.293"> </span>
<a href="#l3.294"></a><span id="l3.294">   var reasonToSave = strID ? GetString(strID) : &quot;&quot;;</span>
<a href="#l3.295"></a><span id="l3.295"> </span>
<a href="#l3.296"></a><span id="l3.296">   var title = document.title || GetString(&quot;untitledDefaultFilename&quot;);</span>
<a href="#l3.297"></a><span id="l3.297"> </span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-  var dialogTitle = GetString(doPublish ? &quot;PublishPage&quot; : &quot;SaveDocument&quot;);</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineminus">-  var dialogMsg = GetString(doPublish ? &quot;PublishPrompt&quot; : &quot;SaveFilePrompt&quot;);</span>
<a href="#l3.300"></a><span id="l3.300" class="difflineplus">+  var dialogTitle = GetString(&quot;SaveDocument&quot;);</span>
<a href="#l3.301"></a><span id="l3.301" class="difflineplus">+  var dialogMsg = GetString(&quot;SaveFilePrompt&quot;);</span>
<a href="#l3.302"></a><span id="l3.302">   dialogMsg = dialogMsg</span>
<a href="#l3.303"></a><span id="l3.303">     .replace(/%title%/, title)</span>
<a href="#l3.304"></a><span id="l3.304">     .replace(/%reason%/, reasonToSave);</span>
<a href="#l3.305"></a><span id="l3.305"> </span>
<a href="#l3.306"></a><span id="l3.306">   let result = { value: 0 };</span>
<a href="#l3.307"></a><span id="l3.307">   let promptFlags =</span>
<a href="#l3.308"></a><span id="l3.308">     Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1;</span>
<a href="#l3.309"></a><span id="l3.309">   let button1Title = null;</span>
<a href="#l3.310"></a><span id="l3.310">   let button3Title = null;</span>
<a href="#l3.311"></a><span id="l3.311"> </span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-  if (doPublish) {</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    promptFlags +=</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineminus">-      Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineminus">-    button1Title = GetString(&quot;Publish&quot;);</span>
<a href="#l3.316"></a><span id="l3.316" class="difflineminus">-    button3Title = GetString(&quot;DontPublish&quot;);</span>
<a href="#l3.317"></a><span id="l3.317" class="difflineminus">-  } else {</span>
<a href="#l3.318"></a><span id="l3.318" class="difflineminus">-    promptFlags +=</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-      Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-  }</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineplus">+  promptFlags +=</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+    Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0;</span>
<a href="#l3.323"></a><span id="l3.323"> </span>
<a href="#l3.324"></a><span id="l3.324">   // If allowing &quot;Don't...&quot; button, add that</span>
<a href="#l3.325"></a><span id="l3.325">   if (allowDontSave) {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-    promptFlags += doPublish</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineminus">-      ? Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineminus">-      : Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2;</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+    promptFlags +=</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+      Services.prompt.BUTTON_TITLE_DONT_SAVE * Services.prompt.BUTTON_POS_2;</span>
<a href="#l3.331"></a><span id="l3.331">   }</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">   result = Services.prompt.confirmEx(</span>
<a href="#l3.334"></a><span id="l3.334">     window,</span>
<a href="#l3.335"></a><span id="l3.335">     dialogTitle,</span>
<a href="#l3.336"></a><span id="l3.336">     dialogMsg,</span>
<a href="#l3.337"></a><span id="l3.337">     promptFlags,</span>
<a href="#l3.338"></a><span id="l3.338">     button1Title,</span>
<a href="#l3.339"></a><span id="l3.339">     null,</span>
<a href="#l3.340"></a><span id="l3.340">     button3Title,</span>
<a href="#l3.341"></a><span id="l3.341">     null,</span>
<a href="#l3.342"></a><span id="l3.342">     { value: 0 }</span>
<a href="#l3.343"></a><span id="l3.343">   );</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">   if (result == 0) {</span>
<a href="#l3.346"></a><span id="l3.346" class="difflineminus">-    // Save, but first finish HTML source mode</span>
<a href="#l3.347"></a><span id="l3.347" class="difflineminus">-    SetEditMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">-    if (doPublish) {</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-      // We save the command the user wanted to do in a global</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-      // and return as if user canceled because publishing is asynchronous</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineminus">-      // This command will be fired when publishing finishes</span>
<a href="#l3.352"></a><span id="l3.352" class="difflineminus">-      gCommandAfterPublishing = command;</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-      goDoCommand(&quot;cmd_publish&quot;);</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-      return false;</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineminus">-    }</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineminus">-</span>
<a href="#l3.357"></a><span id="l3.357">     // Save to local disk</span>
<a href="#l3.358"></a><span id="l3.358">     return SaveDocument(false, false, editor.contentsMIMEType);</span>
<a href="#l3.359"></a><span id="l3.359">   }</span>
<a href="#l3.360"></a><span id="l3.360"> </span>
<a href="#l3.361"></a><span id="l3.361">   if (result == 2) {</span>
<a href="#l3.362"></a><span id="l3.362">     // &quot;Don't Save&quot;</span>
<a href="#l3.363"></a><span id="l3.363">     return true;</span>
<a href="#l3.364"></a><span id="l3.364">   }</span>
<a href="#l3.365"></a><span id="l3.365"> </span>
<a href="#l3.366"></a><span id="l3.366">   // Default or result == 1 (Cancel)</span>
<a href="#l3.367"></a><span id="l3.367">   return false;</span>
<a href="#l3.368"></a><span id="l3.368"> }</span>
<a href="#l3.369"></a><span id="l3.369"> </span>
<a href="#l3.370"></a><span id="l3.370" class="difflineminus">-// --------------------------- View menu ---------------------------</span>
<a href="#l3.371"></a><span id="l3.371" class="difflineminus">-</span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-function EditorSetCharacterSet(aEvent) {</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-  try {</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineminus">-    var editor = GetCurrentEditor();</span>
<a href="#l3.375"></a><span id="l3.375" class="difflineminus">-    if (aEvent.target.hasAttribute(&quot;charset&quot;)) {</span>
<a href="#l3.376"></a><span id="l3.376" class="difflineminus">-      editor.documentCharacterSet = aEvent.target.getAttribute(&quot;charset&quot;);</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-    }</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-    var docUrl = GetDocumentUrl();</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-    if (!IsUrlAboutBlank(docUrl)) {</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineminus">-      // reloading the document will reverse any changes to the META charset,</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-      // we need to put them back in, which is achieved by a dedicated listener</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-      editor.addDocumentStateListener(DocumentReloadListener);</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-      EditorLoadUrl(docUrl);</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-    }</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-  } catch (e) {}</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-}</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-</span>
<a href="#l3.388"></a><span id="l3.388"> // --------------------------- Text style ---------------------------</span>
<a href="#l3.389"></a><span id="l3.389"> </span>
<a href="#l3.390"></a><span id="l3.390"> function onParagraphFormatChange(paraMenuList, commandID) {</span>
<a href="#l3.391"></a><span id="l3.391">   if (!paraMenuList) {</span>
<a href="#l3.392"></a><span id="l3.392">     return;</span>
<a href="#l3.393"></a><span id="l3.393">   }</span>
<a href="#l3.394"></a><span id="l3.394"> </span>
<a href="#l3.395"></a><span id="l3.395">   var commandNode = document.getElementById(commandID);</span>
<a href="#l3.396"></a><span id="l3.396" class="difflineat">@@ -912,67 +654,16 @@ function onFontFaceChange(fontFaceMenuLi</span>
<a href="#l3.397"></a><span id="l3.397">     foundFont = createFontFaceMenuitem(fontLabel, editorFont, menuPopup);</span>
<a href="#l3.398"></a><span id="l3.398">     foundFont.setAttribute(&quot;used&quot;, &quot;true&quot;);</span>
<a href="#l3.399"></a><span id="l3.399">     usedFontsSep.hidden = false;</span>
<a href="#l3.400"></a><span id="l3.400">     menuPopup.insertBefore(foundFont, usedFontsSep);</span>
<a href="#l3.401"></a><span id="l3.401">   }</span>
<a href="#l3.402"></a><span id="l3.402">   fontFaceMenuList.selectedItem = foundFont;</span>
<a href="#l3.403"></a><span id="l3.403"> }</span>
<a href="#l3.404"></a><span id="l3.404"> </span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-/**</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">- * Clears the used fonts list from all the font face menulists.</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">- */</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-function ClearUsedFonts() {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  let userFontSeps = document.querySelectorAll(</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineminus">-    &quot;menuseparator.fontFaceMenuAfterDefaultFonts&quot;</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineminus">-  );</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-  for (let userFontSep of userFontSeps) {</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineminus">-    while (true) {</span>
<a href="#l3.414"></a><span id="l3.414" class="difflineminus">-      let nextNode = userFontSep.nextElementSibling;</span>
<a href="#l3.415"></a><span id="l3.415" class="difflineminus">-      if (nextNode.tagName != &quot;menuseparator&quot;) {</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-        nextNode.remove();</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-      } else if (nextNode.classList.contains(&quot;fontFaceMenuAfterUsedFonts&quot;)) {</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-        nextNode.hidden = true;</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineminus">-        break;</span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-      }</span>
<a href="#l3.421"></a><span id="l3.421" class="difflineminus">-    }</span>
<a href="#l3.422"></a><span id="l3.422" class="difflineminus">-  }</span>
<a href="#l3.423"></a><span id="l3.423" class="difflineminus">-}</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-function EditorSelectFontSize() {</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-  var select = document.getElementById(&quot;FontSizeSelect&quot;);</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-  if (select) {</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-    if (select.selectedIndex == -1) {</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-      return;</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineminus">-    }</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineminus">-</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-    EditorSetFontSize(gFontSizeNames[select.selectedIndex]);</span>
<a href="#l3.433"></a><span id="l3.433" class="difflineminus">-  }</span>
<a href="#l3.434"></a><span id="l3.434" class="difflineminus">-}</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-function onFontSizeChange(fontSizeMenulist, commandID) {</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineminus">-  // If we don't match anything, set to &quot;0 (normal)&quot;</span>
<a href="#l3.438"></a><span id="l3.438" class="difflineminus">-  var newIndex = 2;</span>
<a href="#l3.439"></a><span id="l3.439" class="difflineminus">-  var size = fontSizeMenulist.getAttribute(&quot;size&quot;);</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-  if (size == &quot;mixed&quot;) {</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-    // No single type selected</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineminus">-    newIndex = -1;</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineminus">-  } else {</span>
<a href="#l3.444"></a><span id="l3.444" class="difflineminus">-    for (var i = 0; i &lt; gFontSizeNames.length; i++) {</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-      if (gFontSizeNames[i] == size) {</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineminus">-        newIndex = i;</span>
<a href="#l3.447"></a><span id="l3.447" class="difflineminus">-        break;</span>
<a href="#l3.448"></a><span id="l3.448" class="difflineminus">-      }</span>
<a href="#l3.449"></a><span id="l3.449" class="difflineminus">-    }</span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-  }</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-  if (fontSizeMenulist.selectedIndex != newIndex) {</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineminus">-    fontSizeMenulist.selectedIndex = newIndex;</span>
<a href="#l3.453"></a><span id="l3.453" class="difflineminus">-  }</span>
<a href="#l3.454"></a><span id="l3.454" class="difflineminus">-}</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-</span>
<a href="#l3.456"></a><span id="l3.456"> function EditorSetFontSize(size) {</span>
<a href="#l3.457"></a><span id="l3.457">   if (size == &quot;0&quot; || size == &quot;normal&quot; || size == &quot;medium&quot;) {</span>
<a href="#l3.458"></a><span id="l3.458">     EditorRemoveTextProperty(&quot;font&quot;, &quot;size&quot;);</span>
<a href="#l3.459"></a><span id="l3.459">     // Also remove big and small,</span>
<a href="#l3.460"></a><span id="l3.460">     //  else it will seem like size isn't changing correctly</span>
<a href="#l3.461"></a><span id="l3.461">     EditorRemoveTextProperty(&quot;small&quot;, &quot;&quot;);</span>
<a href="#l3.462"></a><span id="l3.462">     EditorRemoveTextProperty(&quot;big&quot;, &quot;&quot;);</span>
<a href="#l3.463"></a><span id="l3.463">   } else {</span>
<a href="#l3.464"></a><span id="l3.464" class="difflineat">@@ -1269,20 +960,16 @@ function initFontSizeMenu(menuPopup, ful</span>
<a href="#l3.465"></a><span id="l3.465">       menuPopup.lastElementChild.setAttribute(&quot;label&quot;, &quot;HTML: &quot; + htmlInfo);</span>
<a href="#l3.466"></a><span id="l3.466">       menuPopup.lastElementChild.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.467"></a><span id="l3.467">     } else {</span>
<a href="#l3.468"></a><span id="l3.468">       menuPopup.lastElementChild.hidden = true;</span>
<a href="#l3.469"></a><span id="l3.469">     }</span>
<a href="#l3.470"></a><span id="l3.470">   }</span>
<a href="#l3.471"></a><span id="l3.471"> }</span>
<a href="#l3.472"></a><span id="l3.472"> </span>
<a href="#l3.473"></a><span id="l3.473" class="difflineminus">-function onHighlightColorChange() {</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineminus">-  ChangeButtonColor(&quot;cmd_highlight&quot;, &quot;HighlightColorButton&quot;, &quot;transparent&quot;);</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-}</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineminus">-</span>
<a href="#l3.477"></a><span id="l3.477"> function onFontColorChange() {</span>
<a href="#l3.478"></a><span id="l3.478">   ChangeButtonColor(&quot;cmd_fontColor&quot;, &quot;TextColorButton&quot;, gDefaultTextColor);</span>
<a href="#l3.479"></a><span id="l3.479"> }</span>
<a href="#l3.480"></a><span id="l3.480"> </span>
<a href="#l3.481"></a><span id="l3.481"> function onBackgroundColorChange() {</span>
<a href="#l3.482"></a><span id="l3.482">   ChangeButtonColor(</span>
<a href="#l3.483"></a><span id="l3.483">     &quot;cmd_backgroundColor&quot;,</span>
<a href="#l3.484"></a><span id="l3.484">     &quot;BackgroundColorButton&quot;,</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineat">@@ -1422,23 +1109,16 @@ function GetBackgroundElementWithColor()</span>
<a href="#l3.486"></a><span id="l3.486">         );</span>
<a href="#l3.487"></a><span id="l3.487">       }</span>
<a href="#l3.488"></a><span id="l3.488">       gColorObj.PageColor = gColorObj.BackgroundColor;</span>
<a href="#l3.489"></a><span id="l3.489">     }</span>
<a href="#l3.490"></a><span id="l3.490">   }</span>
<a href="#l3.491"></a><span id="l3.491">   return element;</span>
<a href="#l3.492"></a><span id="l3.492"> }</span>
<a href="#l3.493"></a><span id="l3.493"> </span>
<a href="#l3.494"></a><span id="l3.494" class="difflineminus">-function SetSmiley(smileyText) {</span>
<a href="#l3.495"></a><span id="l3.495" class="difflineminus">-  try {</span>
<a href="#l3.496"></a><span id="l3.496" class="difflineminus">-    GetCurrentEditor().insertText(smileyText);</span>
<a href="#l3.497"></a><span id="l3.497" class="difflineminus">-    gContentWindow.focus();</span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-  } catch (e) {}</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-}</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineminus">-</span>
<a href="#l3.501"></a><span id="l3.501"> /* eslint-disable complexity */</span>
<a href="#l3.502"></a><span id="l3.502"> function EditorSelectColor(colorType, mouseEvent) {</span>
<a href="#l3.503"></a><span id="l3.503">   var editor = GetCurrentEditor();</span>
<a href="#l3.504"></a><span id="l3.504">   if (!editor || !gColorObj) {</span>
<a href="#l3.505"></a><span id="l3.505">     return;</span>
<a href="#l3.506"></a><span id="l3.506">   }</span>
<a href="#l3.507"></a><span id="l3.507"> </span>
<a href="#l3.508"></a><span id="l3.508">   // Shift + mouse click automatically applies last color, if available</span>
<a href="#l3.509"></a><span id="l3.509" class="difflineat">@@ -1705,34 +1385,16 @@ function EditorDblClick(event) {</span>
<a href="#l3.510"></a><span id="l3.510">       ].includes(element.nodeName.toLowerCase())</span>
<a href="#l3.511"></a><span id="l3.511">     ) {</span>
<a href="#l3.512"></a><span id="l3.512">       goDoCommand(&quot;cmd_objectProperties&quot;);</span>
<a href="#l3.513"></a><span id="l3.513">       event.preventDefault();</span>
<a href="#l3.514"></a><span id="l3.514">     }</span>
<a href="#l3.515"></a><span id="l3.515">   }</span>
<a href="#l3.516"></a><span id="l3.516"> }</span>
<a href="#l3.517"></a><span id="l3.517"> </span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-function EditorClick(event) {</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineminus">-  // For Web Composer: In Show All Tags Mode,</span>
<a href="#l3.520"></a><span id="l3.520" class="difflineminus">-  // single click selects entire element,</span>
<a href="#l3.521"></a><span id="l3.521" class="difflineminus">-  //  except for body and table elements</span>
<a href="#l3.522"></a><span id="l3.522" class="difflineminus">-  if (gEditorDisplayMode == kDisplayModeAllTags) {</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-    try {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineminus">-      // We check event.explicitOriginalTarget here because .target will never</span>
<a href="#l3.525"></a><span id="l3.525" class="difflineminus">-      // be a textnode (bug 193689)</span>
<a href="#l3.526"></a><span id="l3.526" class="difflineminus">-      var element = event.explicitOriginalTarget;</span>
<a href="#l3.527"></a><span id="l3.527" class="difflineminus">-      var name = element.localName;</span>
<a href="#l3.528"></a><span id="l3.528" class="difflineminus">-      if (![&quot;body&quot;, &quot;caption&quot;, &quot;table&quot;, &quot;td&quot;, &quot;th&quot;, &quot;tr&quot;].includes(name)) {</span>
<a href="#l3.529"></a><span id="l3.529" class="difflineminus">-        GetCurrentEditor().selectElement(event.explicitOriginalTarget);</span>
<a href="#l3.530"></a><span id="l3.530" class="difflineminus">-        event.preventDefault();</span>
<a href="#l3.531"></a><span id="l3.531" class="difflineminus">-      }</span>
<a href="#l3.532"></a><span id="l3.532" class="difflineminus">-    } catch (e) {}</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-  }</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineminus">-}</span>
<a href="#l3.535"></a><span id="l3.535" class="difflineminus">-</span>
<a href="#l3.536"></a><span id="l3.536"> /* TODO: We need an oncreate hook to do enabling/disabling for the</span>
<a href="#l3.537"></a><span id="l3.537">         Format menu. There should be code like this for the</span>
<a href="#l3.538"></a><span id="l3.538">         object-specific &quot;Properties&quot; item</span>
<a href="#l3.539"></a><span id="l3.539"> */</span>
<a href="#l3.540"></a><span id="l3.540"> // For property dialogs, we want the selected element,</span>
<a href="#l3.541"></a><span id="l3.541"> //  but will accept a parent link, list, or table cell if inside one</span>
<a href="#l3.542"></a><span id="l3.542"> function GetObjectForProperties() {</span>
<a href="#l3.543"></a><span id="l3.543">   var editor = GetCurrentEditor();</span>
<a href="#l3.544"></a><span id="l3.544" class="difflineat">@@ -1795,299 +1457,16 @@ function GetObjectForProperties() {</span>
<a href="#l3.545"></a><span id="l3.545">         return node;</span>
<a href="#l3.546"></a><span id="l3.546">       }</span>
<a href="#l3.547"></a><span id="l3.547">     }</span>
<a href="#l3.548"></a><span id="l3.548">     node = node.parentNode;</span>
<a href="#l3.549"></a><span id="l3.549">   }</span>
<a href="#l3.550"></a><span id="l3.550">   return null;</span>
<a href="#l3.551"></a><span id="l3.551"> }</span>
<a href="#l3.552"></a><span id="l3.552"> </span>
<a href="#l3.553"></a><span id="l3.553" class="difflineminus">-function SetEditMode(mode) {</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-  if (!IsHTMLEditor()) {</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineminus">-    return;</span>
<a href="#l3.556"></a><span id="l3.556" class="difflineminus">-  }</span>
<a href="#l3.557"></a><span id="l3.557" class="difflineminus">-</span>
<a href="#l3.558"></a><span id="l3.558" class="difflineminus">-  var bodyElement = GetBodyElement();</span>
<a href="#l3.559"></a><span id="l3.559" class="difflineminus">-  if (!bodyElement) {</span>
<a href="#l3.560"></a><span id="l3.560" class="difflineminus">-    dump(&quot;SetEditMode: We don't have a body node!\n&quot;);</span>
<a href="#l3.561"></a><span id="l3.561" class="difflineminus">-    return;</span>
<a href="#l3.562"></a><span id="l3.562" class="difflineminus">-  }</span>
<a href="#l3.563"></a><span id="l3.563" class="difflineminus">-</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-  // must have editor if here!</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l3.566"></a><span id="l3.566" class="difflineminus">-  var inlineSpellCheckItem = document.getElementById(&quot;menu_inlineSpellCheck&quot;);</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineminus">-  // Switch the UI mode before inserting contents</span>
<a href="#l3.569"></a><span id="l3.569" class="difflineminus">-  //   so user can't type in source window while new window is being filled</span>
<a href="#l3.570"></a><span id="l3.570" class="difflineminus">-  var previousMode = gEditorDisplayMode;</span>
<a href="#l3.571"></a><span id="l3.571" class="difflineminus">-  if (!SetDisplayMode(mode)) {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-    return;</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineminus">-  }</span>
<a href="#l3.574"></a><span id="l3.574" class="difflineminus">-</span>
<a href="#l3.575"></a><span id="l3.575" class="difflineminus">-  if (mode == kDisplayModeSource) {</span>
<a href="#l3.576"></a><span id="l3.576" class="difflineminus">-    // Display the DOCTYPE as a non-editable string above edit area</span>
<a href="#l3.577"></a><span id="l3.577" class="difflineminus">-    var domdoc;</span>
<a href="#l3.578"></a><span id="l3.578" class="difflineminus">-    try {</span>
<a href="#l3.579"></a><span id="l3.579" class="difflineminus">-      domdoc = editor.document;</span>
<a href="#l3.580"></a><span id="l3.580" class="difflineminus">-    } catch (e) {</span>
<a href="#l3.581"></a><span id="l3.581" class="difflineminus">-      dump(e + &quot;\n&quot;);</span>
<a href="#l3.582"></a><span id="l3.582" class="difflineminus">-    }</span>
<a href="#l3.583"></a><span id="l3.583" class="difflineminus">-    if (domdoc) {</span>
<a href="#l3.584"></a><span id="l3.584" class="difflineminus">-      var doctypeNode = document.getElementById(&quot;doctype-text&quot;);</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-      var dt = domdoc.doctype;</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineminus">-      if (doctypeNode) {</span>
<a href="#l3.587"></a><span id="l3.587" class="difflineminus">-        if (dt) {</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-          doctypeNode.collapsed = false;</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineminus">-          var doctypeText = &quot;&lt;!DOCTYPE &quot; + domdoc.doctype.name;</span>
<a href="#l3.590"></a><span id="l3.590" class="difflineminus">-          if (dt.publicId) {</span>
<a href="#l3.591"></a><span id="l3.591" class="difflineminus">-            doctypeText += ' PUBLIC &quot;' + domdoc.doctype.publicId;</span>
<a href="#l3.592"></a><span id="l3.592" class="difflineminus">-          }</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-          if (dt.systemId) {</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineminus">-            doctypeText += ' &quot;' + dt.systemId;</span>
<a href="#l3.595"></a><span id="l3.595" class="difflineminus">-          }</span>
<a href="#l3.596"></a><span id="l3.596" class="difflineminus">-          doctypeText += '&quot;&gt;';</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-          doctypeNode.setAttribute(&quot;value&quot;, doctypeText);</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineminus">-        } else {</span>
<a href="#l3.599"></a><span id="l3.599" class="difflineminus">-          doctypeNode.collapsed = true;</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-        }</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineminus">-      }</span>
<a href="#l3.602"></a><span id="l3.602" class="difflineminus">-    }</span>
<a href="#l3.603"></a><span id="l3.603" class="difflineminus">-    // Get the entire document's source string</span>
<a href="#l3.604"></a><span id="l3.604" class="difflineminus">-</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-    var flags =</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineminus">-      editor.documentCharacterSet == &quot;ISO-8859-1&quot;</span>
<a href="#l3.607"></a><span id="l3.607" class="difflineminus">-        ? kOutputEncodeLatin1Entities</span>
<a href="#l3.608"></a><span id="l3.608" class="difflineminus">-        : kOutputEncodeBasicEntities;</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-    try {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineminus">-      let encodeEntity = Services.prefs.getCharPref(&quot;editor.encode_entity&quot;);</span>
<a href="#l3.611"></a><span id="l3.611" class="difflineminus">-      switch (encodeEntity) {</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-        case &quot;basic&quot;:</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineminus">-          flags = kOutputEncodeBasicEntities;</span>
<a href="#l3.614"></a><span id="l3.614" class="difflineminus">-          break;</span>
<a href="#l3.615"></a><span id="l3.615" class="difflineminus">-        case &quot;latin1&quot;:</span>
<a href="#l3.616"></a><span id="l3.616" class="difflineminus">-          flags = kOutputEncodeLatin1Entities;</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-          break;</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineminus">-        case &quot;html&quot;:</span>
<a href="#l3.619"></a><span id="l3.619" class="difflineminus">-          flags = kOutputEncodeHTMLEntities;</span>
<a href="#l3.620"></a><span id="l3.620" class="difflineminus">-          break;</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-        case &quot;none&quot;:</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineminus">-          flags = 0;</span>
<a href="#l3.623"></a><span id="l3.623" class="difflineminus">-          break;</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-      }</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineminus">-    } catch (e) {}</span>
<a href="#l3.626"></a><span id="l3.626" class="difflineminus">-</span>
<a href="#l3.627"></a><span id="l3.627" class="difflineminus">-    if (Services.prefs.getBoolPref(&quot;editor.prettyprint&quot;)) {</span>
<a href="#l3.628"></a><span id="l3.628" class="difflineminus">-      flags |= kOutputFormatted;</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-    }</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineminus">-</span>
<a href="#l3.631"></a><span id="l3.631" class="difflineminus">-    flags |= kOutputLFLineBreak;</span>
<a href="#l3.632"></a><span id="l3.632" class="difflineminus">-    var source = editor.outputToString(editor.contentsMIMEType, flags);</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-    var start = source.search(/&lt;html/i);</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineminus">-    if (start == -1) {</span>
<a href="#l3.635"></a><span id="l3.635" class="difflineminus">-      start = 0;</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-    }</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineminus">-    gSourceTextEditor.insertText(source.slice(start));</span>
<a href="#l3.638"></a><span id="l3.638" class="difflineminus">-    gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.639"></a><span id="l3.639" class="difflineminus">-    gSourceTextEditor.addDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.640"></a><span id="l3.640" class="difflineminus">-    gSourceTextEditor.enableUndo(true);</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-    gSourceContentWindow.commandManager.addCommandObserver(</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineminus">-      gSourceTextObserver,</span>
<a href="#l3.643"></a><span id="l3.643" class="difflineminus">-      &quot;cmd_undo&quot;</span>
<a href="#l3.644"></a><span id="l3.644" class="difflineminus">-    );</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-    gSourceContentWindow.contentWindow.focus();</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineminus">-    goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.647"></a><span id="l3.647" class="difflineminus">-  } else if (previousMode == kDisplayModeSource) {</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-    // Only rebuild document if a change was made in source window</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineminus">-    if (IsHTMLSourceChanged()) {</span>
<a href="#l3.650"></a><span id="l3.650" class="difflineminus">-      // Disable spell checking when rebuilding source</span>
<a href="#l3.651"></a><span id="l3.651" class="difflineminus">-      InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.652"></a><span id="l3.652" class="difflineminus">-      inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineminus">-      // Reduce the undo count so we don't use too much memory</span>
<a href="#l3.655"></a><span id="l3.655" class="difflineminus">-      //   during multiple uses of source window</span>
<a href="#l3.656"></a><span id="l3.656" class="difflineminus">-      //   (reinserting entire doc caches all nodes)</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-      try {</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineminus">-        editor.transactionManager.maxTransactionCount = 1;</span>
<a href="#l3.659"></a><span id="l3.659" class="difflineminus">-      } catch (e) {}</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineminus">-      editor.beginTransaction();</span>
<a href="#l3.662"></a><span id="l3.662" class="difflineminus">-      try {</span>
<a href="#l3.663"></a><span id="l3.663" class="difflineminus">-        // We are coming from edit source mode,</span>
<a href="#l3.664"></a><span id="l3.664" class="difflineminus">-        //   so transfer that back into the document</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-        source = gSourceTextEditor</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineminus">-          .outputToString(kTextMimeType, kOutputLFLineBreak)</span>
<a href="#l3.667"></a><span id="l3.667" class="difflineminus">-          .trim();</span>
<a href="#l3.668"></a><span id="l3.668" class="difflineminus">-        if (editor.contentsMIMEType != kXHTMLMimeType) {</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-          editor.rebuildDocumentFromSource(source);</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineminus">-        } else {</span>
<a href="#l3.671"></a><span id="l3.671" class="difflineminus">-          /* eslint-disable-next-line no-unsanitized/method */</span>
<a href="#l3.672"></a><span id="l3.672" class="difflineminus">-          var fragment = editor.document</span>
<a href="#l3.673"></a><span id="l3.673" class="difflineminus">-            .createRange()</span>
<a href="#l3.674"></a><span id="l3.674" class="difflineminus">-            .createContextualFragment(source);</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-          editor.enableUndo(false);</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineminus">-          GetBodyElement().remove();</span>
<a href="#l3.677"></a><span id="l3.677" class="difflineminus">-          editor.document.replaceChild(</span>
<a href="#l3.678"></a><span id="l3.678" class="difflineminus">-            fragment.firstChild,</span>
<a href="#l3.679"></a><span id="l3.679" class="difflineminus">-            editor.document.documentElement</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-          );</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineminus">-          editor.enableUndo(true);</span>
<a href="#l3.682"></a><span id="l3.682" class="difflineminus">-        }</span>
<a href="#l3.683"></a><span id="l3.683" class="difflineminus">-</span>
<a href="#l3.684"></a><span id="l3.684" class="difflineminus">-        // Get the text for the &lt;title&gt; from the newly-parsed document</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-        // (must do this for proper conversion of &quot;escaped&quot; characters)</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineminus">-        let titleNode = editor.document.querySelector(&quot;title&quot;);</span>
<a href="#l3.687"></a><span id="l3.687" class="difflineminus">-        SetDocumentTitle(titleNode ? titleNode.textContent : &quot;&quot;);</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-      } catch (ex) {</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineminus">-        dump(ex);</span>
<a href="#l3.690"></a><span id="l3.690" class="difflineminus">-      }</span>
<a href="#l3.691"></a><span id="l3.691" class="difflineminus">-      editor.endTransaction();</span>
<a href="#l3.692"></a><span id="l3.692" class="difflineminus">-</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-      // Restore unlimited undo count</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineminus">-      try {</span>
<a href="#l3.695"></a><span id="l3.695" class="difflineminus">-        editor.transactionManager.maxTransactionCount = -1;</span>
<a href="#l3.696"></a><span id="l3.696" class="difflineminus">-      } catch (e) {}</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-    }</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineminus">-</span>
<a href="#l3.699"></a><span id="l3.699" class="difflineminus">-    // Clear out the string buffers</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-    gSourceContentWindow.commandManager.removeCommandObserver(</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineminus">-      gSourceTextObserver,</span>
<a href="#l3.702"></a><span id="l3.702" class="difflineminus">-      &quot;cmd_undo&quot;</span>
<a href="#l3.703"></a><span id="l3.703" class="difflineminus">-    );</span>
<a href="#l3.704"></a><span id="l3.704" class="difflineminus">-    gSourceTextEditor.removeDocumentStateListener(gSourceTextListener);</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-    gSourceTextEditor.enableUndo(false);</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineminus">-    gSourceTextEditor.selectAll();</span>
<a href="#l3.707"></a><span id="l3.707" class="difflineminus">-    gSourceTextEditor.deleteSelection(</span>
<a href="#l3.708"></a><span id="l3.708" class="difflineminus">-      gSourceTextEditor.eNone,</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-      gSourceTextEditor.eStrip</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineminus">-    );</span>
<a href="#l3.711"></a><span id="l3.711" class="difflineminus">-    gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineminus">-    gContentWindow.focus();</span>
<a href="#l3.714"></a><span id="l3.714" class="difflineminus">-    // goDoCommand(&quot;cmd_moveTop&quot;);</span>
<a href="#l3.715"></a><span id="l3.715" class="difflineminus">-  }</span>
<a href="#l3.716"></a><span id="l3.716" class="difflineminus">-</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-  switch (mode) {</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineminus">-    case kDisplayModePreview:</span>
<a href="#l3.719"></a><span id="l3.719" class="difflineminus">-      // Disable spell checking when previewing</span>
<a href="#l3.720"></a><span id="l3.720" class="difflineminus">-      InlineSpellCheckerUI.enabled = false;</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-      inlineSpellCheckItem.removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineminus">-    // fall through</span>
<a href="#l3.723"></a><span id="l3.723" class="difflineminus">-    case kDisplayModeSource:</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-      inlineSpellCheckItem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineminus">-      break;</span>
<a href="#l3.726"></a><span id="l3.726" class="difflineminus">-    default:</span>
<a href="#l3.727"></a><span id="l3.727" class="difflineminus">-      inlineSpellCheckItem.setAttribute(</span>
<a href="#l3.728"></a><span id="l3.728" class="difflineminus">-        &quot;disabled&quot;,</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-        !InlineSpellCheckerUI.canSpellCheck</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineminus">-      );</span>
<a href="#l3.731"></a><span id="l3.731" class="difflineminus">-      break;</span>
<a href="#l3.732"></a><span id="l3.732" class="difflineminus">-  }</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-}</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineminus">-</span>
<a href="#l3.735"></a><span id="l3.735" class="difflineminus">-function CancelHTMLSource() {</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-  // Don't convert source text back into the DOM document</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineminus">-  gSourceTextEditor.resetModificationCount();</span>
<a href="#l3.738"></a><span id="l3.738" class="difflineminus">-  SetDisplayMode(gPreviousNonSourceDisplayMode);</span>
<a href="#l3.739"></a><span id="l3.739" class="difflineminus">-}</span>
<a href="#l3.740"></a><span id="l3.740" class="difflineminus">-</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-function SetDisplayMode(mode) {</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineminus">-  if (!IsHTMLEditor()) {</span>
<a href="#l3.743"></a><span id="l3.743" class="difflineminus">-    return false;</span>
<a href="#l3.744"></a><span id="l3.744" class="difflineminus">-  }</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineminus">-  // Already in requested mode:</span>
<a href="#l3.747"></a><span id="l3.747" class="difflineminus">-  //  return false to indicate we didn't switch</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-  if (mode == gEditorDisplayMode) {</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineminus">-    return false;</span>
<a href="#l3.750"></a><span id="l3.750" class="difflineminus">-  }</span>
<a href="#l3.751"></a><span id="l3.751" class="difflineminus">-</span>
<a href="#l3.752"></a><span id="l3.752" class="difflineminus">-  var previousMode = gEditorDisplayMode;</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-  gEditorDisplayMode = mode;</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineminus">-</span>
<a href="#l3.755"></a><span id="l3.755" class="difflineminus">-  ResetStructToolbar();</span>
<a href="#l3.756"></a><span id="l3.756" class="difflineminus">-  if (mode == kDisplayModeSource) {</span>
<a href="#l3.757"></a><span id="l3.757" class="difflineminus">-    // Switch to the sourceWindow (second in the deck)</span>
<a href="#l3.758"></a><span id="l3.758" class="difflineminus">-    gContentWindowDeck.selectedIndex = 1;</span>
<a href="#l3.759"></a><span id="l3.759" class="difflineminus">-</span>
<a href="#l3.760"></a><span id="l3.760" class="difflineminus">-    // Hide the formatting toolbar if not already hidden</span>
<a href="#l3.761"></a><span id="l3.761" class="difflineminus">-    gFormatToolbarHidden = gFormatToolbar.hidden;</span>
<a href="#l3.762"></a><span id="l3.762" class="difflineminus">-    gFormatToolbar.hidden = true;</span>
<a href="#l3.763"></a><span id="l3.763" class="difflineminus">-    gViewFormatToolbar.hidden = true;</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-    gSourceContentWindow.contentWindow.focus();</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineminus">-  } else {</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineminus">-    // Save the last non-source mode so we can cancel source editing easily</span>
<a href="#l3.768"></a><span id="l3.768" class="difflineminus">-    gPreviousNonSourceDisplayMode = mode;</span>
<a href="#l3.769"></a><span id="l3.769" class="difflineminus">-</span>
<a href="#l3.770"></a><span id="l3.770" class="difflineminus">-    // Load/unload appropriate override style sheet</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-    try {</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineminus">-      var editor = GetCurrentEditor();</span>
<a href="#l3.773"></a><span id="l3.773" class="difflineminus">-      editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l3.774"></a><span id="l3.774" class="difflineminus">-      editor instanceof Ci.nsIHTMLObjectResizer;</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineminus">-      switch (mode) {</span>
<a href="#l3.777"></a><span id="l3.777" class="difflineminus">-        case kDisplayModePreview:</span>
<a href="#l3.778"></a><span id="l3.778" class="difflineminus">-          // Disable all extra &quot;edit mode&quot; style sheets</span>
<a href="#l3.779"></a><span id="l3.779" class="difflineminus">-          editor.enableStyleSheet(kNormalStyleSheet, false);</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-          editor.enableStyleSheet(kAllTagsStyleSheet, false);</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineminus">-          editor.objectResizingEnabled = true;</span>
<a href="#l3.782"></a><span id="l3.782" class="difflineminus">-          break;</span>
<a href="#l3.783"></a><span id="l3.783" class="difflineminus">-</span>
<a href="#l3.784"></a><span id="l3.784" class="difflineminus">-        case kDisplayModeNormal:</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-          editor.addOverrideStyleSheet(kNormalStyleSheet);</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineminus">-          // Disable ShowAllTags mode</span>
<a href="#l3.787"></a><span id="l3.787" class="difflineminus">-          editor.enableStyleSheet(kAllTagsStyleSheet, false);</span>
<a href="#l3.788"></a><span id="l3.788" class="difflineminus">-          editor.objectResizingEnabled = true;</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-          break;</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineminus">-</span>
<a href="#l3.791"></a><span id="l3.791" class="difflineminus">-        case kDisplayModeAllTags:</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-          editor.addOverrideStyleSheet(kNormalStyleSheet);</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineminus">-          editor.addOverrideStyleSheet(kAllTagsStyleSheet);</span>
<a href="#l3.794"></a><span id="l3.794" class="difflineminus">-          // don't allow resizing in AllTags mode because the visible tags</span>
<a href="#l3.795"></a><span id="l3.795" class="difflineminus">-          // change the computed size of images and tables...</span>
<a href="#l3.796"></a><span id="l3.796" class="difflineminus">-          if (editor.resizedObject) {</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-            editor.hideResizers();</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineminus">-          }</span>
<a href="#l3.799"></a><span id="l3.799" class="difflineminus">-          editor.objectResizingEnabled = false;</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-          break;</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineminus">-      }</span>
<a href="#l3.802"></a><span id="l3.802" class="difflineminus">-    } catch (e) {}</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineminus">-    // Switch to the normal editor (first in the deck)</span>
<a href="#l3.805"></a><span id="l3.805" class="difflineminus">-    gContentWindowDeck.selectedIndex = 0;</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineminus">-    // Restore menus and toolbars</span>
<a href="#l3.808"></a><span id="l3.808" class="difflineminus">-    gFormatToolbar.hidden = gFormatToolbarHidden;</span>
<a href="#l3.809"></a><span id="l3.809" class="difflineminus">-    gViewFormatToolbar.hidden = false;</span>
<a href="#l3.810"></a><span id="l3.810" class="difflineminus">-</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-    gContentWindow.focus();</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineminus">-  }</span>
<a href="#l3.813"></a><span id="l3.813" class="difflineminus">-</span>
<a href="#l3.814"></a><span id="l3.814" class="difflineminus">-  // update commands to disable or re-enable stuff</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-  window.updateCommands(&quot;mode_switch&quot;);</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineminus">-</span>
<a href="#l3.817"></a><span id="l3.817" class="difflineminus">-  // Set the selected tab at bottom of window:</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-  // (Note: Setting &quot;selectedIndex = mode&quot; won't redraw tabs when menu is used.)</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineminus">-  document.getElementById(</span>
<a href="#l3.820"></a><span id="l3.820" class="difflineminus">-    &quot;EditModeTabs&quot;</span>
<a href="#l3.821"></a><span id="l3.821" class="difflineminus">-  ).selectedItem = document.getElementById(kDisplayModeTabIDS[mode]);</span>
<a href="#l3.822"></a><span id="l3.822" class="difflineminus">-</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-  // Uncheck previous menuitem and set new check since toolbar may have been used</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineminus">-  if (previousMode &gt;= 0) {</span>
<a href="#l3.825"></a><span id="l3.825" class="difflineminus">-    document</span>
<a href="#l3.826"></a><span id="l3.826" class="difflineminus">-      .getElementById(kDisplayModeMenuIDs[previousMode])</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-      .setAttribute(&quot;checked&quot;, &quot;false&quot;);</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineminus">-  }</span>
<a href="#l3.829"></a><span id="l3.829" class="difflineminus">-  document</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-    .getElementById(kDisplayModeMenuIDs[mode])</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineminus">-    .setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.832"></a><span id="l3.832" class="difflineminus">-</span>
<a href="#l3.833"></a><span id="l3.833" class="difflineminus">-  return true;</span>
<a href="#l3.834"></a><span id="l3.834" class="difflineminus">-}</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-</span>
<a href="#l3.836"></a><span id="l3.836"> function UpdateWindowTitle() {</span>
<a href="#l3.837"></a><span id="l3.837">   try {</span>
<a href="#l3.838"></a><span id="l3.838">     var filename = &quot;&quot;;</span>
<a href="#l3.839"></a><span id="l3.839">     var windowTitle = &quot;&quot;;</span>
<a href="#l3.840"></a><span id="l3.840">     var title = GetDocumentTitle();</span>
<a href="#l3.841"></a><span id="l3.841"> </span>
<a href="#l3.842"></a><span id="l3.842">     // Append just the 'leaf' filename to the Doc. Title for the window caption</span>
<a href="#l3.843"></a><span id="l3.843">     var docUrl = GetDocumentUrl();</span>
<a href="#l3.844"></a><span id="l3.844" class="difflineat">@@ -2550,59 +1929,16 @@ function GetBodyElement() {</span>
<a href="#l3.845"></a><span id="l3.845">     return GetCurrentEditor().rootElement;</span>
<a href="#l3.846"></a><span id="l3.846">   } catch (ex) {</span>
<a href="#l3.847"></a><span id="l3.847">     dump(&quot;no body tag found?!\n&quot;);</span>
<a href="#l3.848"></a><span id="l3.848">     //  better have one, how can we blow things up here?</span>
<a href="#l3.849"></a><span id="l3.849">   }</span>
<a href="#l3.850"></a><span id="l3.850">   return null;</span>
<a href="#l3.851"></a><span id="l3.851"> }</span>
<a href="#l3.852"></a><span id="l3.852"> </span>
<a href="#l3.853"></a><span id="l3.853" class="difflineminus">-// --------------------------- Logging stuff ---------------------------</span>
<a href="#l3.854"></a><span id="l3.854" class="difflineminus">-</span>
<a href="#l3.855"></a><span id="l3.855" class="difflineminus">-function EditorGetNodeFromOffsets(offsets) {</span>
<a href="#l3.856"></a><span id="l3.856" class="difflineminus">-  var node = null;</span>
<a href="#l3.857"></a><span id="l3.857" class="difflineminus">-  try {</span>
<a href="#l3.858"></a><span id="l3.858" class="difflineminus">-    node = GetCurrentEditor().document;</span>
<a href="#l3.859"></a><span id="l3.859" class="difflineminus">-</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-    for (var i = 0; i &lt; offsets.length; i++) {</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineminus">-      node = node.childNodes[offsets[i]];</span>
<a href="#l3.862"></a><span id="l3.862" class="difflineminus">-    }</span>
<a href="#l3.863"></a><span id="l3.863" class="difflineminus">-  } catch (e) {}</span>
<a href="#l3.864"></a><span id="l3.864" class="difflineminus">-  return node;</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-}</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineminus">-</span>
<a href="#l3.867"></a><span id="l3.867" class="difflineminus">-function EditorSetSelectionFromOffsets(selRanges) {</span>
<a href="#l3.868"></a><span id="l3.868" class="difflineminus">-  try {</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-    var editor = GetCurrentEditor();</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineminus">-    var selection = editor.selection;</span>
<a href="#l3.871"></a><span id="l3.871" class="difflineminus">-    selection.removeAllRanges();</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineminus">-    var rangeArr, start, end, node, offset;</span>
<a href="#l3.874"></a><span id="l3.874" class="difflineminus">-    for (var i = 0; i &lt; selRanges.length; i++) {</span>
<a href="#l3.875"></a><span id="l3.875" class="difflineminus">-      rangeArr = selRanges[i];</span>
<a href="#l3.876"></a><span id="l3.876" class="difflineminus">-      start = rangeArr[0];</span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-      end = rangeArr[1];</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineminus">-</span>
<a href="#l3.879"></a><span id="l3.879" class="difflineminus">-      var range = editor.document.createRange();</span>
<a href="#l3.880"></a><span id="l3.880" class="difflineminus">-</span>
<a href="#l3.881"></a><span id="l3.881" class="difflineminus">-      node = EditorGetNodeFromOffsets(start[0]);</span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-      offset = start[1];</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineminus">-</span>
<a href="#l3.884"></a><span id="l3.884" class="difflineminus">-      range.setStart(node, offset);</span>
<a href="#l3.885"></a><span id="l3.885" class="difflineminus">-</span>
<a href="#l3.886"></a><span id="l3.886" class="difflineminus">-      node = EditorGetNodeFromOffsets(end[0]);</span>
<a href="#l3.887"></a><span id="l3.887" class="difflineminus">-      offset = end[1];</span>
<a href="#l3.888"></a><span id="l3.888" class="difflineminus">-</span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-      range.setEnd(node, offset);</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineminus">-</span>
<a href="#l3.891"></a><span id="l3.891" class="difflineminus">-      selection.addRange(range);</span>
<a href="#l3.892"></a><span id="l3.892" class="difflineminus">-    }</span>
<a href="#l3.893"></a><span id="l3.893" class="difflineminus">-  } catch (e) {}</span>
<a href="#l3.894"></a><span id="l3.894" class="difflineminus">-}</span>
<a href="#l3.895"></a><span id="l3.895" class="difflineminus">-</span>
<a href="#l3.896"></a><span id="l3.896"> // --------------------------------------------------------------------</span>
<a href="#l3.897"></a><span id="l3.897"> function initFontStyleMenu(menuPopup) {</span>
<a href="#l3.898"></a><span id="l3.898">   for (var i = 0; i &lt; menuPopup.children.length; i++) {</span>
<a href="#l3.899"></a><span id="l3.899">     var menuItem = menuPopup.children[i];</span>
<a href="#l3.900"></a><span id="l3.900">     var theStyle = menuItem.getAttribute(&quot;state&quot;);</span>
<a href="#l3.901"></a><span id="l3.901">     if (theStyle) {</span>
<a href="#l3.902"></a><span id="l3.902">       menuItem.setAttribute(&quot;checked&quot;, theStyle);</span>
<a href="#l3.903"></a><span id="l3.903">     }</span>
<a href="#l3.904"></a><span id="l3.904" class="difflineat">@@ -2611,44 +1947,16 @@ function initFontStyleMenu(menuPopup) {</span>
<a href="#l3.905"></a><span id="l3.905"> </span>
<a href="#l3.906"></a><span id="l3.906"> // --------------------------------------------------------------------</span>
<a href="#l3.907"></a><span id="l3.907"> function onButtonUpdate(button, commmandID) {</span>
<a href="#l3.908"></a><span id="l3.908">   var commandNode = document.getElementById(commmandID);</span>
<a href="#l3.909"></a><span id="l3.909">   var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.910"></a><span id="l3.910">   button.checked = state == &quot;true&quot;;</span>
<a href="#l3.911"></a><span id="l3.911"> }</span>
<a href="#l3.912"></a><span id="l3.912"> </span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-// --------------------------------------------------------------------</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineminus">-function onStateButtonUpdate(button, commmandID, onState) {</span>
<a href="#l3.915"></a><span id="l3.915" class="difflineminus">-  var commandNode = document.getElementById(commmandID);</span>
<a href="#l3.916"></a><span id="l3.916" class="difflineminus">-  var state = commandNode.getAttribute(&quot;state&quot;);</span>
<a href="#l3.917"></a><span id="l3.917" class="difflineminus">-</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-  button.checked = state == onState;</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineminus">-}</span>
<a href="#l3.920"></a><span id="l3.920" class="difflineminus">-</span>
<a href="#l3.921"></a><span id="l3.921" class="difflineminus">-// --------------------------- Status calls ---------------------------</span>
<a href="#l3.922"></a><span id="l3.922" class="difflineminus">-function getColorAndSetColorWell(ColorPickerID, ColorWellID) {</span>
<a href="#l3.923"></a><span id="l3.923" class="difflineminus">-  var colorWell;</span>
<a href="#l3.924"></a><span id="l3.924" class="difflineminus">-  if (ColorWellID) {</span>
<a href="#l3.925"></a><span id="l3.925" class="difflineminus">-    colorWell = document.getElementById(ColorWellID);</span>
<a href="#l3.926"></a><span id="l3.926" class="difflineminus">-  }</span>
<a href="#l3.927"></a><span id="l3.927" class="difflineminus">-</span>
<a href="#l3.928"></a><span id="l3.928" class="difflineminus">-  var colorPicker = document.getElementById(ColorPickerID);</span>
<a href="#l3.929"></a><span id="l3.929" class="difflineminus">-  if (colorPicker) {</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-    // Extract color from colorPicker and assign to colorWell.</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineminus">-    var color = colorPicker.getAttribute(&quot;color&quot;);</span>
<a href="#l3.932"></a><span id="l3.932" class="difflineminus">-</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-    if (colorWell &amp;&amp; color) {</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineminus">-      // Use setAttribute so colorwell can be a XUL element, such as button</span>
<a href="#l3.935"></a><span id="l3.935" class="difflineminus">-      colorWell.setAttribute(&quot;style&quot;, &quot;background-color: &quot; + color);</span>
<a href="#l3.936"></a><span id="l3.936" class="difflineminus">-    }</span>
<a href="#l3.937"></a><span id="l3.937" class="difflineminus">-  }</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-  return color;</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineminus">-}</span>
<a href="#l3.940"></a><span id="l3.940" class="difflineminus">-</span>
<a href="#l3.941"></a><span id="l3.941"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.942"></a><span id="l3.942"> function IsSpellCheckerInstalled() {</span>
<a href="#l3.943"></a><span id="l3.943">   return true; // Always installed.</span>
<a href="#l3.944"></a><span id="l3.944"> }</span>
<a href="#l3.945"></a><span id="l3.945"> </span>
<a href="#l3.946"></a><span id="l3.946"> // -----------------------------------------------------------------------------------</span>
<a href="#l3.947"></a><span id="l3.947"> function IsFindInstalled() {</span>
<a href="#l3.948"></a><span id="l3.948">   return (</span>
<a href="#l3.949"></a><span id="l3.949" class="difflineat">@@ -2840,17 +2148,16 @@ function goUpdateTableMenuItems(commands</span>
<a href="#l3.950"></a><span id="l3.950">         commandID == &quot;cmd_JoinTableCells&quot; ||</span>
<a href="#l3.951"></a><span id="l3.951">         commandID == &quot;cmd_SplitTableCell&quot; ||</span>
<a href="#l3.952"></a><span id="l3.952">         commandID == &quot;cmd_ConvertToTable&quot;</span>
<a href="#l3.953"></a><span id="l3.953">       ) {</span>
<a href="#l3.954"></a><span id="l3.954">         // Call the update method in the command class</span>
<a href="#l3.955"></a><span id="l3.955">         goUpdateCommand(commandID);</span>
<a href="#l3.956"></a><span id="l3.956">       } else if (</span>
<a href="#l3.957"></a><span id="l3.957">         commandID == &quot;cmd_DeleteTable&quot; ||</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineminus">-        commandID == &quot;cmd_NormalizeTable&quot; ||</span>
<a href="#l3.959"></a><span id="l3.959">         commandID == &quot;cmd_editTable&quot; ||</span>
<a href="#l3.960"></a><span id="l3.960">         commandID == &quot;cmd_TableOrCellColor&quot; ||</span>
<a href="#l3.961"></a><span id="l3.961">         commandID == &quot;cmd_SelectTable&quot;</span>
<a href="#l3.962"></a><span id="l3.962">       ) {</span>
<a href="#l3.963"></a><span id="l3.963">         // Directly set with the values calculated here</span>
<a href="#l3.964"></a><span id="l3.964">         goSetCommandEnabled(commandID, enabledIfTable);</span>
<a href="#l3.965"></a><span id="l3.965">       } else {</span>
<a href="#l3.966"></a><span id="l3.966">         goSetCommandEnabled(commandID, enabled);</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineat">@@ -3157,247 +2464,16 @@ function SwitchInsertCharToAnotherEditor</span>
<a href="#l3.968"></a><span id="l3.968">         return;</span>
<a href="#l3.969"></a><span id="l3.969">       }</span>
<a href="#l3.970"></a><span id="l3.970">     }</span>
<a href="#l3.971"></a><span id="l3.971">     // Didn't find another editor - close the dialog</span>
<a href="#l3.972"></a><span id="l3.972">     window.InsertCharWindow.close();</span>
<a href="#l3.973"></a><span id="l3.973">   }</span>
<a href="#l3.974"></a><span id="l3.974"> }</span>
<a href="#l3.975"></a><span id="l3.975"> </span>
<a href="#l3.976"></a><span id="l3.976" class="difflineminus">-function ResetStructToolbar() {</span>
<a href="#l3.977"></a><span id="l3.977" class="difflineminus">-  gLastFocusNode = null;</span>
<a href="#l3.978"></a><span id="l3.978" class="difflineminus">-  UpdateStructToolbar();</span>
<a href="#l3.979"></a><span id="l3.979" class="difflineminus">-}</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineminus">-function newCommandListener(element) {</span>
<a href="#l3.982"></a><span id="l3.982" class="difflineminus">-  return function() {</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-    return SelectFocusNodeAncestor(element);</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineminus">-  };</span>
<a href="#l3.985"></a><span id="l3.985" class="difflineminus">-}</span>
<a href="#l3.986"></a><span id="l3.986" class="difflineminus">-</span>
<a href="#l3.987"></a><span id="l3.987" class="difflineminus">-function newContextmenuListener(button, element) {</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-  /* globals InitStructBarContextMenu */ // SeaMonkey only.</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineminus">-  return function() {</span>
<a href="#l3.990"></a><span id="l3.990" class="difflineminus">-    return InitStructBarContextMenu(button, element);</span>
<a href="#l3.991"></a><span id="l3.991" class="difflineminus">-  };</span>
<a href="#l3.992"></a><span id="l3.992" class="difflineminus">-}</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineminus">-function UpdateStructToolbar() {</span>
<a href="#l3.995"></a><span id="l3.995" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-  if (!editor) {</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineminus">-    return;</span>
<a href="#l3.998"></a><span id="l3.998" class="difflineminus">-  }</span>
<a href="#l3.999"></a><span id="l3.999" class="difflineminus">-</span>
<a href="#l3.1000"></a><span id="l3.1000" class="difflineminus">-  var mixed = GetSelectionContainer();</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-  if (!mixed) {</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineminus">-    return;</span>
<a href="#l3.1003"></a><span id="l3.1003" class="difflineminus">-  }</span>
<a href="#l3.1004"></a><span id="l3.1004" class="difflineminus">-  var element = mixed.node;</span>
<a href="#l3.1005"></a><span id="l3.1005" class="difflineminus">-  var oneElementSelected = mixed.oneElementSelected;</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineminus">-  if (!element) {</span>
<a href="#l3.1008"></a><span id="l3.1008" class="difflineminus">-    return;</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-  }</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineminus">-</span>
<a href="#l3.1011"></a><span id="l3.1011" class="difflineminus">-  if (</span>
<a href="#l3.1012"></a><span id="l3.1012" class="difflineminus">-    element == gLastFocusNode &amp;&amp;</span>
<a href="#l3.1013"></a><span id="l3.1013" class="difflineminus">-    oneElementSelected == gLastFocusNodeWasSelected</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-  ) {</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineminus">-    return;</span>
<a href="#l3.1016"></a><span id="l3.1016" class="difflineminus">-  }</span>
<a href="#l3.1017"></a><span id="l3.1017" class="difflineminus">-</span>
<a href="#l3.1018"></a><span id="l3.1018" class="difflineminus">-  gLastFocusNode = element;</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-  gLastFocusNodeWasSelected = mixed.oneElementSelected;</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineminus">-</span>
<a href="#l3.1021"></a><span id="l3.1021" class="difflineminus">-  var toolbar = document.getElementById(&quot;structToolbar&quot;);</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-  if (!toolbar) {</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineminus">-    return;</span>
<a href="#l3.1024"></a><span id="l3.1024" class="difflineminus">-  }</span>
<a href="#l3.1025"></a><span id="l3.1025" class="difflineminus">-  // We need to leave the &lt;label&gt; to flex the buttons to the left.</span>
<a href="#l3.1026"></a><span id="l3.1026" class="difflineminus">-  for (let node of toolbar.querySelectorAll(&quot;toolbarbutton&quot;)) {</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-    node.remove();</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineminus">-  }</span>
<a href="#l3.1029"></a><span id="l3.1029" class="difflineminus">-</span>
<a href="#l3.1030"></a><span id="l3.1030" class="difflineminus">-  toolbar.removeAttribute(&quot;label&quot;);</span>
<a href="#l3.1031"></a><span id="l3.1031" class="difflineminus">-</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-  if (IsInHTMLSourceMode()) {</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineminus">-    // we have destroyed the contents of the status bar and are</span>
<a href="#l3.1034"></a><span id="l3.1034" class="difflineminus">-    // about to recreate it ; but we don't want to do that in</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-    // Source mode</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineminus">-    return;</span>
<a href="#l3.1037"></a><span id="l3.1037" class="difflineminus">-  }</span>
<a href="#l3.1038"></a><span id="l3.1038" class="difflineminus">-</span>
<a href="#l3.1039"></a><span id="l3.1039" class="difflineminus">-  var tag, button;</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-  var bodyElement = GetBodyElement();</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineminus">-  var isFocusNode = true;</span>
<a href="#l3.1042"></a><span id="l3.1042" class="difflineminus">-  var tmp;</span>
<a href="#l3.1043"></a><span id="l3.1043" class="difflineminus">-  do {</span>
<a href="#l3.1044"></a><span id="l3.1044" class="difflineminus">-    tag = element.nodeName.toLowerCase();</span>
<a href="#l3.1045"></a><span id="l3.1045" class="difflineminus">-</span>
<a href="#l3.1046"></a><span id="l3.1046" class="difflineminus">-    button = document.createXULElement(&quot;toolbarbutton&quot;);</span>
<a href="#l3.1047"></a><span id="l3.1047" class="difflineminus">-    button.setAttribute(&quot;label&quot;, &quot;&lt;&quot; + tag + &quot;&gt;&quot;);</span>
<a href="#l3.1048"></a><span id="l3.1048" class="difflineminus">-    button.setAttribute(&quot;value&quot;, tag);</span>
<a href="#l3.1049"></a><span id="l3.1049" class="difflineminus">-    button.setAttribute(&quot;context&quot;, &quot;structToolbarContext&quot;);</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineminus">-    button.className = &quot;struct-button&quot;;</span>
<a href="#l3.1051"></a><span id="l3.1051" class="difflineminus">-</span>
<a href="#l3.1052"></a><span id="l3.1052" class="difflineminus">-    toolbar.insertBefore(button, toolbar.firstElementChild);</span>
<a href="#l3.1053"></a><span id="l3.1053" class="difflineminus">-</span>
<a href="#l3.1054"></a><span id="l3.1054" class="difflineminus">-    button.addEventListener(&quot;command&quot;, newCommandListener(element));</span>
<a href="#l3.1055"></a><span id="l3.1055" class="difflineminus">-</span>
<a href="#l3.1056"></a><span id="l3.1056" class="difflineminus">-    button.addEventListener(</span>
<a href="#l3.1057"></a><span id="l3.1057" class="difflineminus">-      &quot;contextmenu&quot;,</span>
<a href="#l3.1058"></a><span id="l3.1058" class="difflineminus">-      newContextmenuListener(button, element)</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-    );</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineminus">-</span>
<a href="#l3.1061"></a><span id="l3.1061" class="difflineminus">-    if (isFocusNode &amp;&amp; oneElementSelected) {</span>
<a href="#l3.1062"></a><span id="l3.1062" class="difflineminus">-      button.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.1063"></a><span id="l3.1063" class="difflineminus">-      isFocusNode = false;</span>
<a href="#l3.1064"></a><span id="l3.1064" class="difflineminus">-    }</span>
<a href="#l3.1065"></a><span id="l3.1065" class="difflineminus">-</span>
<a href="#l3.1066"></a><span id="l3.1066" class="difflineminus">-    tmp = element;</span>
<a href="#l3.1067"></a><span id="l3.1067" class="difflineminus">-    element = element.parentNode;</span>
<a href="#l3.1068"></a><span id="l3.1068" class="difflineminus">-  } while (tmp != bodyElement);</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineminus">-}</span>
<a href="#l3.1070"></a><span id="l3.1070" class="difflineminus">-</span>
<a href="#l3.1071"></a><span id="l3.1071" class="difflineminus">-function SelectFocusNodeAncestor(element) {</span>
<a href="#l3.1072"></a><span id="l3.1072" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l3.1073"></a><span id="l3.1073" class="difflineminus">-  if (editor) {</span>
<a href="#l3.1074"></a><span id="l3.1074" class="difflineminus">-    if (element == GetBodyElement()) {</span>
<a href="#l3.1075"></a><span id="l3.1075" class="difflineminus">-      editor.selectAll();</span>
<a href="#l3.1076"></a><span id="l3.1076" class="difflineminus">-    } else {</span>
<a href="#l3.1077"></a><span id="l3.1077" class="difflineminus">-      editor.selectElement(element);</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-    }</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineminus">-  }</span>
<a href="#l3.1080"></a><span id="l3.1080" class="difflineminus">-  ResetStructToolbar();</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-}</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineminus">-</span>
<a href="#l3.1083"></a><span id="l3.1083" class="difflineminus">-function GetSelectionContainer() {</span>
<a href="#l3.1084"></a><span id="l3.1084" class="difflineminus">-  var editor = GetCurrentEditor();</span>
<a href="#l3.1085"></a><span id="l3.1085" class="difflineminus">-  if (!editor) {</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-    return null;</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineminus">-  }</span>
<a href="#l3.1088"></a><span id="l3.1088" class="difflineminus">-</span>
<a href="#l3.1089"></a><span id="l3.1089" class="difflineminus">-  var selection;</span>
<a href="#l3.1090"></a><span id="l3.1090" class="difflineminus">-  try {</span>
<a href="#l3.1091"></a><span id="l3.1091" class="difflineminus">-    selection = editor.selection;</span>
<a href="#l3.1092"></a><span id="l3.1092" class="difflineminus">-    if (!selection) {</span>
<a href="#l3.1093"></a><span id="l3.1093" class="difflineminus">-      return null;</span>
<a href="#l3.1094"></a><span id="l3.1094" class="difflineminus">-    }</span>
<a href="#l3.1095"></a><span id="l3.1095" class="difflineminus">-  } catch (e) {</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineminus">-    return null;</span>
<a href="#l3.1097"></a><span id="l3.1097" class="difflineminus">-  }</span>
<a href="#l3.1098"></a><span id="l3.1098" class="difflineminus">-</span>
<a href="#l3.1099"></a><span id="l3.1099" class="difflineminus">-  var result = { oneElementSelected: false };</span>
<a href="#l3.1100"></a><span id="l3.1100" class="difflineminus">-</span>
<a href="#l3.1101"></a><span id="l3.1101" class="difflineminus">-  if (selection.isCollapsed) {</span>
<a href="#l3.1102"></a><span id="l3.1102" class="difflineminus">-    result.node = selection.focusNode;</span>
<a href="#l3.1103"></a><span id="l3.1103" class="difflineminus">-  } else {</span>
<a href="#l3.1104"></a><span id="l3.1104" class="difflineminus">-    var rangeCount = selection.rangeCount;</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-    if (rangeCount == 1) {</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineminus">-      result.node = editor.getSelectedElement(&quot;&quot;);</span>
<a href="#l3.1107"></a><span id="l3.1107" class="difflineminus">-      var range = selection.getRangeAt(0);</span>
<a href="#l3.1108"></a><span id="l3.1108" class="difflineminus">-</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-      // check for a weird case : when we select a piece of text inside</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineminus">-      // a text node and apply an inline style to it, the selection starts</span>
<a href="#l3.1111"></a><span id="l3.1111" class="difflineminus">-      // at the end of the text node preceding the style and ends after the</span>
<a href="#l3.1112"></a><span id="l3.1112" class="difflineminus">-      // last char of the style. Assume the style element is selected for</span>
<a href="#l3.1113"></a><span id="l3.1113" class="difflineminus">-      // user's pleasure</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-      if (</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineminus">-        !result.node &amp;&amp;</span>
<a href="#l3.1116"></a><span id="l3.1116" class="difflineminus">-        range.startContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.1117"></a><span id="l3.1117" class="difflineminus">-        range.startOffset == range.startContainer.length &amp;&amp;</span>
<a href="#l3.1118"></a><span id="l3.1118" class="difflineminus">-        range.endContainer.nodeType == Node.TEXT_NODE &amp;&amp;</span>
<a href="#l3.1119"></a><span id="l3.1119" class="difflineminus">-        range.endOffset == range.endContainer.length &amp;&amp;</span>
<a href="#l3.1120"></a><span id="l3.1120" class="difflineminus">-        range.endContainer.nextElementSibling == null &amp;&amp;</span>
<a href="#l3.1121"></a><span id="l3.1121" class="difflineminus">-        range.startContainer.nextElementSibling == range.endContainer.parentNode</span>
<a href="#l3.1122"></a><span id="l3.1122" class="difflineminus">-      ) {</span>
<a href="#l3.1123"></a><span id="l3.1123" class="difflineminus">-        result.node = range.endContainer.parentNode;</span>
<a href="#l3.1124"></a><span id="l3.1124" class="difflineminus">-      }</span>
<a href="#l3.1125"></a><span id="l3.1125" class="difflineminus">-</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-      if (!result.node) {</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineminus">-        // let's rely on the common ancestor of the selection</span>
<a href="#l3.1128"></a><span id="l3.1128" class="difflineminus">-        result.node = range.commonAncestorContainer;</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-      } else {</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineminus">-        result.oneElementSelected = true;</span>
<a href="#l3.1131"></a><span id="l3.1131" class="difflineminus">-      }</span>
<a href="#l3.1132"></a><span id="l3.1132" class="difflineminus">-    } else {</span>
<a href="#l3.1133"></a><span id="l3.1133" class="difflineminus">-      // assume table cells !</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-      var i,</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineminus">-        container = null;</span>
<a href="#l3.1136"></a><span id="l3.1136" class="difflineminus">-      for (i = 0; i &lt; rangeCount; i++) {</span>
<a href="#l3.1137"></a><span id="l3.1137" class="difflineminus">-        range = selection.getRangeAt(i);</span>
<a href="#l3.1138"></a><span id="l3.1138" class="difflineminus">-        if (!container) {</span>
<a href="#l3.1139"></a><span id="l3.1139" class="difflineminus">-          container = range.startContainer;</span>
<a href="#l3.1140"></a><span id="l3.1140" class="difflineminus">-        } else if (container != range.startContainer) {</span>
<a href="#l3.1141"></a><span id="l3.1141" class="difflineminus">-          // all table cells don't belong to same row so let's</span>
<a href="#l3.1142"></a><span id="l3.1142" class="difflineminus">-          // select the parent of all rows</span>
<a href="#l3.1143"></a><span id="l3.1143" class="difflineminus">-          result.node = container.parentNode;</span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineminus">-          break;</span>
<a href="#l3.1145"></a><span id="l3.1145" class="difflineminus">-        }</span>
<a href="#l3.1146"></a><span id="l3.1146" class="difflineminus">-        result.node = container;</span>
<a href="#l3.1147"></a><span id="l3.1147" class="difflineminus">-      }</span>
<a href="#l3.1148"></a><span id="l3.1148" class="difflineminus">-    }</span>
<a href="#l3.1149"></a><span id="l3.1149" class="difflineminus">-  }</span>
<a href="#l3.1150"></a><span id="l3.1150" class="difflineminus">-</span>
<a href="#l3.1151"></a><span id="l3.1151" class="difflineminus">-  // make sure we have an element here</span>
<a href="#l3.1152"></a><span id="l3.1152" class="difflineminus">-  while (result.node.nodeType != Node.ELEMENT_NODE) {</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-    result.node = result.node.parentNode;</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineminus">-  }</span>
<a href="#l3.1155"></a><span id="l3.1155" class="difflineminus">-</span>
<a href="#l3.1156"></a><span id="l3.1156" class="difflineminus">-  // and make sure the element is not a special editor node like</span>
<a href="#l3.1157"></a><span id="l3.1157" class="difflineminus">-  // the &lt;br&gt; we insert in blank lines</span>
<a href="#l3.1158"></a><span id="l3.1158" class="difflineminus">-  // and don't select anonymous content !!! (fix for bug 190279)</span>
<a href="#l3.1159"></a><span id="l3.1159" class="difflineminus">-  while (</span>
<a href="#l3.1160"></a><span id="l3.1160" class="difflineminus">-    result.node.hasAttribute(&quot;_moz_editor_bogus_node&quot;) ||</span>
<a href="#l3.1161"></a><span id="l3.1161" class="difflineminus">-    editor.isAnonymousElement(result.node)</span>
<a href="#l3.1162"></a><span id="l3.1162" class="difflineminus">-  ) {</span>
<a href="#l3.1163"></a><span id="l3.1163" class="difflineminus">-    result.node = result.node.parentNode;</span>
<a href="#l3.1164"></a><span id="l3.1164" class="difflineminus">-  }</span>
<a href="#l3.1165"></a><span id="l3.1165" class="difflineminus">-</span>
<a href="#l3.1166"></a><span id="l3.1166" class="difflineminus">-  return result;</span>
<a href="#l3.1167"></a><span id="l3.1167" class="difflineminus">-}</span>
<a href="#l3.1168"></a><span id="l3.1168" class="difflineminus">-</span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-function FillInHTMLTooltipEditor(tooltip) {</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineminus">-  const XLinkNS = &quot;http://www.w3.org/1999/xlink&quot;;</span>
<a href="#l3.1171"></a><span id="l3.1171" class="difflineminus">-  var tooltipText = null;</span>
<a href="#l3.1172"></a><span id="l3.1172" class="difflineminus">-  var node;</span>
<a href="#l3.1173"></a><span id="l3.1173" class="difflineminus">-  if (IsInPreviewMode()) {</span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-    for (node = document.tooltipNode; node; node = node.parentNode) {</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineminus">-      if (node.nodeType == Node.ELEMENT_NODE) {</span>
<a href="#l3.1176"></a><span id="l3.1176" class="difflineminus">-        tooltipText = node.getAttributeNS(XLinkNS, &quot;title&quot;);</span>
<a href="#l3.1177"></a><span id="l3.1177" class="difflineminus">-        if (tooltipText &amp;&amp; /\S/.test(tooltipText)) {</span>
<a href="#l3.1178"></a><span id="l3.1178" class="difflineminus">-          tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.1179"></a><span id="l3.1179" class="difflineminus">-          return true;</span>
<a href="#l3.1180"></a><span id="l3.1180" class="difflineminus">-        }</span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-        tooltipText = node.getAttribute(&quot;title&quot;);</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineminus">-        if (tooltipText &amp;&amp; /\S/.test(tooltipText)) {</span>
<a href="#l3.1183"></a><span id="l3.1183" class="difflineminus">-          tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.1184"></a><span id="l3.1184" class="difflineminus">-          return true;</span>
<a href="#l3.1185"></a><span id="l3.1185" class="difflineminus">-        }</span>
<a href="#l3.1186"></a><span id="l3.1186" class="difflineminus">-      }</span>
<a href="#l3.1187"></a><span id="l3.1187" class="difflineminus">-    }</span>
<a href="#l3.1188"></a><span id="l3.1188" class="difflineminus">-  } else {</span>
<a href="#l3.1189"></a><span id="l3.1189" class="difflineminus">-    for (node = document.tooltipNode; node; node = node.parentNode) {</span>
<a href="#l3.1190"></a><span id="l3.1190" class="difflineminus">-      if (</span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-        ChromeUtils.getClassName(node) === &quot;HTMLImageElement&quot; ||</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineminus">-        ChromeUtils.getClassName(node) === &quot;HTMLInputElement&quot;</span>
<a href="#l3.1193"></a><span id="l3.1193" class="difflineminus">-      ) {</span>
<a href="#l3.1194"></a><span id="l3.1194" class="difflineminus">-        tooltipText = node.getAttribute(&quot;src&quot;);</span>
<a href="#l3.1195"></a><span id="l3.1195" class="difflineminus">-      } else if (ChromeUtils.getClassName(node) === &quot;HTMLAnchorElement&quot;) {</span>
<a href="#l3.1196"></a><span id="l3.1196" class="difflineminus">-        tooltipText = node.getAttribute(&quot;href&quot;) || node.getAttribute(&quot;name&quot;);</span>
<a href="#l3.1197"></a><span id="l3.1197" class="difflineminus">-      }</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-      if (tooltipText) {</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-        tooltip.setAttribute(&quot;label&quot;, tooltipText);</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineminus">-        return true;</span>
<a href="#l3.1201"></a><span id="l3.1201" class="difflineminus">-      }</span>
<a href="#l3.1202"></a><span id="l3.1202" class="difflineminus">-    }</span>
<a href="#l3.1203"></a><span id="l3.1203" class="difflineminus">-  }</span>
<a href="#l3.1204"></a><span id="l3.1204" class="difflineminus">-  return false;</span>
<a href="#l3.1205"></a><span id="l3.1205" class="difflineminus">-}</span>
<a href="#l3.1206"></a><span id="l3.1206" class="difflineminus">-</span>
<a href="#l3.1207"></a><span id="l3.1207"> function UpdateTOC() {</span>
<a href="#l3.1208"></a><span id="l3.1208">   window.openDialog(</span>
<a href="#l3.1209"></a><span id="l3.1209">     &quot;chrome://messenger/content/messengercompose/EdInsertTOC.xul&quot;,</span>
<a href="#l3.1210"></a><span id="l3.1210">     &quot;_blank&quot;,</span>
<a href="#l3.1211"></a><span id="l3.1211">     &quot;chrome,close,modal,titlebar&quot;</span>
<a href="#l3.1212"></a><span id="l3.1212">   );</span>
<a href="#l3.1213"></a><span id="l3.1213">   window.content.focus();</span>
<a href="#l3.1214"></a><span id="l3.1214"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/compose/content/editorUtilities.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/compose/content/editorUtilities.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -265,29 +265,21 @@ function IsHTMLEditor() {</span>
<a href="#l4.4"></a><span id="l4.4"> function PageIsEmptyAndUntouched() {</span>
<a href="#l4.5"></a><span id="l4.5">   return IsDocumentEmpty() &amp;&amp; !IsDocumentModified() &amp;&amp; !IsHTMLSourceChanged();</span>
<a href="#l4.6"></a><span id="l4.6"> }</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> function IsInHTMLSourceMode() {</span>
<a href="#l4.9"></a><span id="l4.9">   return gEditorDisplayMode == kDisplayModeSource;</span>
<a href="#l4.10"></a><span id="l4.10"> }</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-function IsInPreviewMode() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  return gEditorDisplayMode == kDisplayModePreview;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-}</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16"> // are we editing HTML (i.e. neither in HTML source mode, nor editing a text file)</span>
<a href="#l4.17"></a><span id="l4.17"> function IsEditingRenderedHTML() {</span>
<a href="#l4.18"></a><span id="l4.18">   return IsHTMLEditor() &amp;&amp; !IsInHTMLSourceMode();</span>
<a href="#l4.19"></a><span id="l4.19"> }</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-function IsWebComposer() {</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-  return document.documentElement.id == &quot;editorWindow&quot;;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-}</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineminus">-</span>
<a href="#l4.25"></a><span id="l4.25"> function IsDocumentEditable() {</span>
<a href="#l4.26"></a><span id="l4.26">   try {</span>
<a href="#l4.27"></a><span id="l4.27">     return GetCurrentEditor().isDocumentEditable;</span>
<a href="#l4.28"></a><span id="l4.28">   } catch (e) {}</span>
<a href="#l4.29"></a><span id="l4.29">   return false;</span>
<a href="#l4.30"></a><span id="l4.30"> }</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32"> function IsDocumentEmpty() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xul</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xul</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -134,40 +134,35 @@</span>
<a href="#l5.4"></a><span id="l5.4">     &lt;command id=&quot;cmd_listProperties&quot; oncommand=&quot;goDoCommand('cmd_listProperties')&quot;/&gt;</span>
<a href="#l5.5"></a><span id="l5.5">     &lt;command id=&quot;cmd_colorProperties&quot; oncommand=&quot;goDoCommand('cmd_colorProperties')&quot;/&gt;</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">     &lt;command id=&quot;cmd_link&quot; oncommand=&quot;goDoCommand('cmd_link')&quot;/&gt;</span>
<a href="#l5.8"></a><span id="l5.8">     &lt;command id=&quot;cmd_anchor&quot; oncommand=&quot;goDoCommand('cmd_anchor')&quot;/&gt;</span>
<a href="#l5.9"></a><span id="l5.9">     &lt;command id=&quot;cmd_image&quot; oncommand=&quot;goDoCommand('cmd_image')&quot;/&gt;</span>
<a href="#l5.10"></a><span id="l5.10">     &lt;command id=&quot;cmd_hline&quot; oncommand=&quot;goDoCommand('cmd_hline')&quot;/&gt;</span>
<a href="#l5.11"></a><span id="l5.11">     &lt;command id=&quot;cmd_table&quot; oncommand=&quot;goDoCommand('cmd_table')&quot;/&gt;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    &lt;command id=&quot;cmd_isindex&quot; oncommand=&quot;goDoCommand('cmd_isindex')&quot;/&gt;</span>
<a href="#l5.13"></a><span id="l5.13">     &lt;command id=&quot;cmd_objectProperties&quot; oncommand=&quot;goDoCommand('cmd_objectProperties')&quot;/&gt;</span>
<a href="#l5.14"></a><span id="l5.14">     &lt;command id=&quot;cmd_insertChars&quot; oncommand=&quot;goDoCommand('cmd_insertChars')&quot; label=&quot;&amp;insertCharsCmd.label;&quot;/&gt;</span>
<a href="#l5.15"></a><span id="l5.15">     &lt;command id=&quot;cmd_insertHTMLWithDialog&quot; oncommand=&quot;goDoCommand('cmd_insertHTMLWithDialog')&quot; label=&quot;&amp;insertHTMLCmd.label;&quot;/&gt;</span>
<a href="#l5.16"></a><span id="l5.16">     &lt;command id=&quot;cmd_insertMathWithDialog&quot; oncommand=&quot;goDoCommand('cmd_insertMathWithDialog')&quot; label=&quot;&amp;insertMathCmd.label;&quot;/&gt;</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18">     &lt;command id=&quot;cmd_insertBreak&quot; oncommand=&quot;goDoCommand('cmd_insertBreak')&quot;/&gt;</span>
<a href="#l5.19"></a><span id="l5.19">     &lt;command id=&quot;cmd_insertBreakAll&quot; oncommand=&quot;goDoCommand('cmd_insertBreakAll')&quot;/&gt;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-    &lt;!-- only used in context popup menu --&gt;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-    &lt;command id=&quot;cmd_editLink&quot; oncommand=&quot;goDoCommand('cmd_editLink')&quot;/&gt;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-</span>
<a href="#l5.24"></a><span id="l5.24">     &lt;!-- dummy command used just to disable things in non-HTML modes --&gt;</span>
<a href="#l5.25"></a><span id="l5.25">     &lt;command id=&quot;cmd_renderedHTMLEnabler&quot;/&gt;</span>
<a href="#l5.26"></a><span id="l5.26">   &lt;/commandset&gt;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   &lt;!-- edit menu commands. These get updated by code in globalOverlay.js --&gt;</span>
<a href="#l5.29"></a><span id="l5.29">   &lt;commandset id=&quot;composerEditMenuItems&quot;</span>
<a href="#l5.30"></a><span id="l5.30">           commandupdater=&quot;true&quot;</span>
<a href="#l5.31"></a><span id="l5.31">           events=&quot;create, mode_switch&quot;</span>
<a href="#l5.32"></a><span id="l5.32">           oncommandupdate=&quot;goUpdateComposerMenuItems(this)&quot;&gt;</span>
<a href="#l5.33"></a><span id="l5.33">     &lt;command id=&quot;cmd_pasteNoFormatting&quot; oncommand=&quot;goDoCommand('cmd_pasteNoFormatting')&quot;</span>
<a href="#l5.34"></a><span id="l5.34">              label=&quot;&amp;pasteNoFormatting.label;&quot; accesskey=&quot;&amp;pasteNoFormatting.accesskey;&quot;/&gt;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-    &lt;command id=&quot;cmd_preferences&quot; oncommand=&quot;goDoCommand('cmd_preferences')&quot;/&gt;</span>
<a href="#l5.36"></a><span id="l5.36">     &lt;command id=&quot;cmd_findReplace&quot; oncommand=&quot;goDoCommand('cmd_findReplace')&quot;/&gt;</span>
<a href="#l5.37"></a><span id="l5.37">     &lt;command id=&quot;cmd_find&quot; oncommand=&quot;goDoCommand('cmd_find')&quot;/&gt;</span>
<a href="#l5.38"></a><span id="l5.38">     &lt;command id=&quot;cmd_findNext&quot; oncommand=&quot;goDoCommand('cmd_findNext');&quot;/&gt;</span>
<a href="#l5.39"></a><span id="l5.39">     &lt;command id=&quot;cmd_findPrev&quot; oncommand=&quot;goDoCommand('cmd_findPrev');&quot;/&gt;</span>
<a href="#l5.40"></a><span id="l5.40">     &lt;command id=&quot;cmd_spelling&quot; oncommand=&quot;goDoCommand('cmd_spelling')&quot;/&gt;</span>
<a href="#l5.41"></a><span id="l5.41">     &lt;command id=&quot;cmd_pasteQuote&quot; oncommand=&quot;goDoCommand('cmd_pasteQuote')&quot; label=&quot;&amp;pasteAsQuotationCmd.label;&quot;/&gt;</span>
<a href="#l5.42"></a><span id="l5.42">   &lt;/commandset&gt;</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44" class="difflineat">@@ -206,25 +201,18 @@</span>
<a href="#l5.45"></a><span id="l5.45">     &lt;command id=&quot;cmd_paragraphState&quot; state=&quot;&quot; oncommand=&quot;doStatefulCommand('cmd_paragraphState', event.target.value)&quot;/&gt;</span>
<a href="#l5.46"></a><span id="l5.46">     &lt;command id=&quot;cmd_fontFace&quot; state=&quot;&quot; oncommand=&quot;doStatefulCommand('cmd_fontFace', event.target.value)&quot;/&gt;</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">     &lt;!-- No &quot;oncommand&quot;, use EditorSelectColor() to bring up color dialog --&gt;</span>
<a href="#l5.49"></a><span id="l5.49">     &lt;command id=&quot;cmd_fontColor&quot; state=&quot;&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l5.50"></a><span id="l5.50">     &lt;command id=&quot;cmd_backgroundColor&quot; state=&quot;&quot; disabled=&quot;false&quot;/&gt;</span>
<a href="#l5.51"></a><span id="l5.51">     &lt;command id=&quot;cmd_highlight&quot; state=&quot;transparent&quot; oncommand=&quot;EditorSelectColor('Highlight', event);&quot;/&gt;</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53" class="difflineminus">-    &lt;command id=&quot;cmd_fontSize&quot; oncommand=&quot;goDoCommand('cmd_fontSize')&quot;/&gt;</span>
<a href="#l5.54"></a><span id="l5.54">     &lt;command id=&quot;cmd_align&quot; state=&quot;&quot;/&gt;</span>
<a href="#l5.55"></a><span id="l5.55"> </span>
<a href="#l5.56"></a><span id="l5.56" class="difflineminus">-    &lt;command id=&quot;cmd_absPos&quot; state=&quot;&quot; oncommand=&quot;goDoCommand('cmd_absPos')&quot;/&gt;</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-    &lt;command id=&quot;cmd_increaseZIndex&quot; state=&quot;&quot; oncommand=&quot;goDoCommand('cmd_increaseZIndex')&quot;/&gt;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    &lt;command id=&quot;cmd_decreaseZIndex&quot; state=&quot;&quot; oncommand=&quot;goDoCommand('cmd_decreaseZIndex')&quot;/&gt;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-    &lt;command id=&quot;cmd_advancedProperties&quot; oncommand=&quot;goDoCommand('cmd_advancedProperties')&quot;/&gt;</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-</span>
<a href="#l5.62"></a><span id="l5.62">     &lt;command id=&quot;cmd_increaseFontStep&quot; oncommand=&quot;goDoCommand('cmd_increaseFontStep')&quot;/&gt;</span>
<a href="#l5.63"></a><span id="l5.63">     &lt;command id=&quot;cmd_decreaseFontStep&quot; oncommand=&quot;goDoCommand('cmd_decreaseFontStep')&quot;/&gt;</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65">     &lt;command id=&quot;cmd_removeStyles&quot; oncommand=&quot;goDoCommand('cmd_removeStyles')&quot;/&gt;</span>
<a href="#l5.66"></a><span id="l5.66">     &lt;command id=&quot;cmd_removeLinks&quot; oncommand=&quot;goDoCommand('cmd_removeLinks')&quot;/&gt;</span>
<a href="#l5.67"></a><span id="l5.67">     &lt;command id=&quot;cmd_removeNamedAnchors&quot; oncommand=&quot;goDoCommand('cmd_removeNamedAnchors')&quot;/&gt;</span>
<a href="#l5.68"></a><span id="l5.68">   &lt;/commandset&gt;</span>
<a href="#l5.69"></a><span id="l5.69"> </span>
<a href="#l5.70"></a><span id="l5.70" class="difflineat">@@ -245,17 +233,16 @@</span>
<a href="#l5.71"></a><span id="l5.71">     &lt;command id=&quot;cmd_InsertColumnAfter&quot; oncommand=&quot;goDoCommand('cmd_InsertColumnAfter')&quot;/&gt;</span>
<a href="#l5.72"></a><span id="l5.72">     &lt;command id=&quot;cmd_InsertCellBefore&quot; oncommand=&quot;goDoCommand('cmd_InsertCellBefore')&quot;/&gt;</span>
<a href="#l5.73"></a><span id="l5.73">     &lt;command id=&quot;cmd_InsertCellAfter&quot; oncommand=&quot;goDoCommand('cmd_InsertCellAfter')&quot;/&gt;</span>
<a href="#l5.74"></a><span id="l5.74">     &lt;command id=&quot;cmd_DeleteTable&quot; oncommand=&quot;goDoCommand('cmd_DeleteTable')&quot;/&gt;</span>
<a href="#l5.75"></a><span id="l5.75">     &lt;command id=&quot;cmd_DeleteRow&quot; oncommand=&quot;goDoCommand('cmd_DeleteRow')&quot;/&gt;</span>
<a href="#l5.76"></a><span id="l5.76">     &lt;command id=&quot;cmd_DeleteColumn&quot; oncommand=&quot;goDoCommand('cmd_DeleteColumn')&quot;/&gt;</span>
<a href="#l5.77"></a><span id="l5.77">     &lt;command id=&quot;cmd_DeleteCell&quot; oncommand=&quot;goDoCommand('cmd_DeleteCell')&quot;/&gt;</span>
<a href="#l5.78"></a><span id="l5.78">     &lt;command id=&quot;cmd_DeleteCellContents&quot; oncommand=&quot;goDoCommand('cmd_DeleteCellContents')&quot;/&gt;</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-    &lt;command id=&quot;cmd_NormalizeTable&quot; oncommand=&quot;goDoCommand('cmd_NormalizeTable')&quot;/&gt;</span>
<a href="#l5.80"></a><span id="l5.80">     &lt;command id=&quot;cmd_JoinTableCells&quot; oncommand=&quot;goDoCommand('cmd_JoinTableCells')&quot;/&gt;</span>
<a href="#l5.81"></a><span id="l5.81">     &lt;command id=&quot;cmd_SplitTableCell&quot; oncommand=&quot;goDoCommand('cmd_SplitTableCell')&quot;/&gt;</span>
<a href="#l5.82"></a><span id="l5.82">     &lt;command id=&quot;cmd_ConvertToTable&quot; oncommand=&quot;goDoCommand('cmd_ConvertToTable')&quot;/&gt;</span>
<a href="#l5.83"></a><span id="l5.83">     &lt;command id=&quot;cmd_TableOrCellColor&quot; oncommand=&quot;goDoCommand('cmd_TableOrCellColor')&quot;/&gt;</span>
<a href="#l5.84"></a><span id="l5.84">     &lt;command id=&quot;cmd_editTable&quot; oncommand=&quot;goDoCommand('cmd_editTable')&quot;/&gt;</span>
<a href="#l5.85"></a><span id="l5.85">   &lt;/commandset&gt;</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87">   &lt;!-- commands updated only when the menu gets created --&gt;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

