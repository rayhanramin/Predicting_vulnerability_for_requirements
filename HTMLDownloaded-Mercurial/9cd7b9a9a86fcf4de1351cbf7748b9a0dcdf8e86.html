<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15773:9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86" />
<meta property="og:url" content="/comm-central/rev/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86" />
<meta property="og:description" content="Bug 876548 Move the nsMsgDatabase cache to the nsMsgDBService r=irving" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">shortlog</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">files</a> |
changeset |
<a href="/comm-central/raw-rev/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">raw</a>  | <a href="/comm-central/archive/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=876548">Bug 876548</a> Move the nsMsgDatabase cache to the nsMsgDBService r=irving
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#78;&#101;&#105;&#108;&#32;&#82;&#97;&#115;&#104;&#98;&#114;&#111;&#111;&#107;&#32;&#60;&#110;&#101;&#105;&#108;&#64;&#112;&#97;&#114;&#107;&#119;&#97;&#121;&#99;&#99;&#46;&#99;&#111;&#46;&#117;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Feb 2014 01:02:50 +0000</td></tr>

<tr>
 <td>changeset 15773</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86</a></td>
</tr>



<tr>
<td>parent 15772</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0f442bc64c5a68b56eee812de1b5d0d25ffafe84">0f442bc64c5a68b56eee812de1b5d0d25ffafe84</a>
</td>
</tr>

<tr>
<td>child 15774</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ed8c317c7a96e15b4e3cd1e6d6e4748efe26606a">ed8c317c7a96e15b4e3cd1e6d6e4748efe26606a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86">9882</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Fri, 21 Feb 2014 01:04:19 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@01a9de9baf7a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=01a9de9baf7a55d26935b0ac847518c2c2fda3f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=01a9de9baf7a55d26935b0ac847518c2c2fda3f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01a9de9baf7a55d26935b0ac847518c2c2fda3f1&newProject=comm-central&newRevision=0f442bc64c5a68b56eee812de1b5d0d25ffafe84&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01a9de9baf7a55d26935b0ac847518c2c2fda3f1&newProject=comm-central&newRevision=0f442bc64c5a68b56eee812de1b5d0d25ffafe84&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=01a9de9baf7a55d26935b0ac847518c2c2fda3f1&newProject=comm-central&newRevision=0f442bc64c5a68b56eee812de1b5d0d25ffafe84&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28irving%29&revcount=50">irving</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=876548">876548</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=876548">Bug 876548</a> Move the nsMsgDatabase cache to the nsMsgDBService r=irving</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">mailnews/db/msgdb/public/nsMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">file</a> |
<a href="/comm-central/annotate/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">annotate</a> |
<a href="/comm-central/diff/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">diff</a> |
<a href="/comm-central/comparison/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">comparison</a> |
<a href="/comm-central/log/9cd7b9a9a86fcf4de1351cbf7748b9a0dcdf8e86/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -229,17 +229,17 @@ NS_IMETHODIMP nsMsgDBFolder::ForceDBClos</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   if (mDatabase)</span>
<a href="#l1.6"></a><span id="l1.6">   {</span>
<a href="#l1.7"></a><span id="l1.7">     mDatabase-&gt;ForceClosed();</span>
<a href="#l1.8"></a><span id="l1.8">     mDatabase = nullptr;</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10">   else</span>
<a href="#l1.11"></a><span id="l1.11">   {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory = do_CreateInstance(kCMailDB);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; mailDBFactory(do_GetService(NS_MSGDB_SERVICE_CONTRACTID));</span>
<a href="#l1.14"></a><span id="l1.14">     if (mailDBFactory)</span>
<a href="#l1.15"></a><span id="l1.15">       mailDBFactory-&gt;ForceFolderDBClosed(this);</span>
<a href="#l1.16"></a><span id="l1.16">   }</span>
<a href="#l1.17"></a><span id="l1.17">   return NS_OK;</span>
<a href="#l1.18"></a><span id="l1.18"> }</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> NS_IMETHODIMP nsMsgDBFolder::CloseAndBackupFolderDB(const nsACString&amp; newName)</span>
<a href="#l1.21"></a><span id="l1.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1282,17 +1282,16 @@ static const mozilla::Module::CategoryEn</span>
<a href="#l2.4"></a><span id="l2.4">   // Tokenizer Entries</span>
<a href="#l2.5"></a><span id="l2.5">   { NULL }</span>
<a href="#l2.6"></a><span id="l2.6"> };</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> static void</span>
<a href="#l2.9"></a><span id="l2.9"> msgMailNewsModuleDtor()</span>
<a href="#l2.10"></a><span id="l2.10"> {</span>
<a href="#l2.11"></a><span id="l2.11">   nsAddrDatabase::CleanupCache();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  nsMsgDatabase::CleanupCache();</span>
<a href="#l2.13"></a><span id="l2.13"> }</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> static const mozilla::Module kMailNewsModule = {</span>
<a href="#l2.16"></a><span id="l2.16">   mozilla::Module::kVersion,</span>
<a href="#l2.17"></a><span id="l2.17">   kMailNewsCIDs,</span>
<a href="#l2.18"></a><span id="l2.18">   kMailNewsContracts,</span>
<a href="#l2.19"></a><span id="l2.19">   kMailNewsCategories,</span>
<a href="#l2.20"></a><span id="l2.20">   NULL,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -98,17 +98,17 @@ interface nsMsgDBCommitType</span>
<a href="#l3.4"></a><span id="l3.4"> [ptr] native nsMsgKeyArrayPtr(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> /**</span>
<a href="#l3.7"></a><span id="l3.7">  * A service to open mail databases and manipulate listeners automatically.</span>
<a href="#l3.8"></a><span id="l3.8">  *</span>
<a href="#l3.9"></a><span id="l3.9">  * The contract ID for this component is</span>
<a href="#l3.10"></a><span id="l3.10">  * &lt;tt&gt;\@mozilla.org/msgDatabase/msgDBService;1&lt;/tt&gt;.</span>
<a href="#l3.11"></a><span id="l3.11">  */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-[scriptable, uuid(e4743a99-ca44-4647-87b4-d73a444226b3)]</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+[scriptable, uuid(4cbbf024-3760-402d-89f3-6ababafeb07d)]</span>
<a href="#l3.14"></a><span id="l3.14"> interface nsIMsgDBService : nsISupports</span>
<a href="#l3.15"></a><span id="l3.15"> {</span>
<a href="#l3.16"></a><span id="l3.16">   /**</span>
<a href="#l3.17"></a><span id="l3.17">    * Opens a database for a given folder.</span>
<a href="#l3.18"></a><span id="l3.18">    *</span>
<a href="#l3.19"></a><span id="l3.19">    * This method is preferred over nsIMsgDBService::openMailDBFromFile if the</span>
<a href="#l3.20"></a><span id="l3.20">    * caller has an actual nsIMsgFolder around. If the database detects that it</span>
<a href="#l3.21"></a><span id="l3.21">    * is unreadable or out of date (using nsIMsgDatabase::outOfDate) it will</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -229,23 +229,29 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l3.23"></a><span id="l3.23">    * Get the db for a folder, if already open.</span>
<a href="#l3.24"></a><span id="l3.24">    *</span>
<a href="#l3.25"></a><span id="l3.25">    * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l3.26"></a><span id="l3.26">    *</span>
<a href="#l3.27"></a><span id="l3.27">    * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l3.28"></a><span id="l3.28">    */</span>
<a href="#l3.29"></a><span id="l3.29">   nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  /**</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+   * Close the db for a folder, if already open.</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+   *</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+   * @param aFolder   The folder to close the cached (open) db for.</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+   */</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  void forceFolderDBClosed(in nsIMsgFolder aFolder);</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+</span>
<a href="#l3.38"></a><span id="l3.38">   /// an enumerator to iterate over the open dbs.</span>
<a href="#l3.39"></a><span id="l3.39">   readonly attribute nsIArray openDBs;</span>
<a href="#l3.40"></a><span id="l3.40"> };</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-[scriptable, uuid(09839bbb-d55c-4d38-a006-8f9eb4894774)]</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+[scriptable, uuid(2dbc9e31-5f8c-408c-960e-a91cecde368c)]</span>
<a href="#l3.44"></a><span id="l3.44"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-  void forceFolderDBClosed(in nsIMsgFolder aFolder);</span>
<a href="#l3.46"></a><span id="l3.46">   void Close(in boolean aForceCommit);</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48">   void Commit(in nsMsgDBCommit commitType);</span>
<a href="#l3.49"></a><span id="l3.49">   // Force closed is evil, and we should see if we can do without it.</span>
<a href="#l3.50"></a><span id="l3.50">   // In 4.x, it was mainly used to remove corrupted databases.</span>
<a href="#l3.51"></a><span id="l3.51">   void ForceClosed();</span>
<a href="#l3.52"></a><span id="l3.52">   void clearCachedHdrs();</span>
<a href="#l3.53"></a><span id="l3.53">   void resetHdrCacheSize(in unsigned long size);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -24,17 +24,17 @@ public:</span>
<a href="#l4.4"></a><span id="l4.4">   virtual ~nsMailDatabase();</span>
<a href="#l4.5"></a><span id="l4.5">   NS_IMETHOD  ForceClosed() MOZ_OVERRIDE;</span>
<a href="#l4.6"></a><span id="l4.6">   NS_IMETHOD DeleteMessages(uint32_t aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l4.7"></a><span id="l4.7">                             nsIDBChangeListener *instigator) MOZ_OVERRIDE;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9">   NS_IMETHOD StartBatch() MOZ_OVERRIDE;</span>
<a href="#l4.10"></a><span id="l4.10">   NS_IMETHOD EndBatch() MOZ_OVERRIDE;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsresult  Open(nsIFile *aSummaryFile, bool create, bool upgrading) MOZ_OVERRIDE;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsresult  Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile, bool create, bool upgrading) MOZ_OVERRIDE;</span>
<a href="#l4.14"></a><span id="l4.14">   virtual nsMailDatabase  *GetMailDB() {return this;}</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   virtual uint32_t  GetCurVersion() MOZ_OVERRIDE {return kMsgDBVersion;}</span>
<a href="#l4.17"></a><span id="l4.17">   </span>
<a href="#l4.18"></a><span id="l4.18">   NS_IMETHOD  GetOfflineOpForKey(nsMsgKey opKey, bool create,</span>
<a href="#l4.19"></a><span id="l4.19">                                  nsIMsgOfflineImapOperation **op) MOZ_OVERRIDE;</span>
<a href="#l4.20"></a><span id="l4.20">   NS_IMETHOD  RemoveOfflineOp(nsIMsgOfflineImapOperation *op) MOZ_OVERRIDE;</span>
<a href="#l4.21"></a><span id="l4.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -24,35 +24,56 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;pldhash.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> #include &quot;nsTArray.h&quot;</span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> class ListContext;</span>
<a href="#l5.10"></a><span id="l5.10"> class nsMsgKeySet;</span>
<a href="#l5.11"></a><span id="l5.11"> class nsMsgThread;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+class nsMsgDatabase;</span>
<a href="#l5.13"></a><span id="l5.13"> class nsIMsgThread;</span>
<a href="#l5.14"></a><span id="l5.14"> class nsIDBFolderInfo;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> const int32_t kMsgDBVersion = 1;</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+// Hopefully we're not opening up lots of databases at the same time, however</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+// this will give us a buffer before we need to start reallocating the cache</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+// array.</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+const uint32_t kInitialMsgDBCacheSize = 20;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+</span>
<a href="#l5.23"></a><span id="l5.23"> class nsMsgDBService : public nsIMsgDBService</span>
<a href="#l5.24"></a><span id="l5.24"> {</span>
<a href="#l5.25"></a><span id="l5.25"> public:</span>
<a href="#l5.26"></a><span id="l5.26">   NS_DECL_ISUPPORTS</span>
<a href="#l5.27"></a><span id="l5.27">   NS_DECL_NSIMSGDBSERVICE</span>
<a href="#l5.28"></a><span id="l5.28"> </span>
<a href="#l5.29"></a><span id="l5.29">   nsMsgDBService();</span>
<a href="#l5.30"></a><span id="l5.30">   ~nsMsgDBService();</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+  void AddToCache(nsMsgDatabase* pMessageDB);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  void DumpCache();</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  void EnsureCached(nsMsgDatabase* pMessageDB)</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+    if (!m_dbCache.Contains(pMessageDB))</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+      m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  }</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  void RemoveFromCache(nsMsgDatabase* pMessageDB)</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  {</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+    m_dbCache.RemoveElement(pMessageDB);</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+  }</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+</span>
<a href="#l5.44"></a><span id="l5.44"> protected:</span>
<a href="#l5.45"></a><span id="l5.45">   void HookupPendingListeners(nsIMsgDatabase *db, nsIMsgFolder *folder);</span>
<a href="#l5.46"></a><span id="l5.46">   void FinishDBOpen(nsIMsgFolder *aFolder, nsMsgDatabase *aMsgDB);</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  nsMsgDatabase* FindInCache(nsIFile *dbName);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">   nsCOMArray &lt;nsIMsgFolder&gt; m_foldersPendingListeners;</span>
<a href="#l5.50"></a><span id="l5.50">   nsCOMArray &lt;nsIDBChangeListener&gt; m_pendingListeners;</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  nsAutoTArray&lt;nsMsgDatabase*, kInitialMsgDBCacheSize&gt; m_dbCache;</span>
<a href="#l5.52"></a><span id="l5.52"> };</span>
<a href="#l5.53"></a><span id="l5.53"> </span>
<a href="#l5.54"></a><span id="l5.54"> class nsMsgDBEnumerator : public nsISimpleEnumerator {</span>
<a href="#l5.55"></a><span id="l5.55"> public:</span>
<a href="#l5.56"></a><span id="l5.56">     NS_DECL_ISUPPORTS</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">     // nsISimpleEnumerator methods:</span>
<a href="#l5.59"></a><span id="l5.59">     NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineat">@@ -126,24 +147,24 @@ public:</span>
<a href="#l5.61"></a><span id="l5.61">    *                        The file could not be created.</span>
<a href="#l5.62"></a><span id="l5.62">    * @exception NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE</span>
<a href="#l5.63"></a><span id="l5.63">    *                        The database is present (and was opened), but the</span>
<a href="#l5.64"></a><span id="l5.64">    *                        summary file is out of date.</span>
<a href="#l5.65"></a><span id="l5.65">    * @exception NS_MSG_ERROR_FOLDER_SUMMARY_MISSING</span>
<a href="#l5.66"></a><span id="l5.66">    *                        The database is present (and was opened), but the</span>
<a href="#l5.67"></a><span id="l5.67">    *                        summary file is missing.</span>
<a href="#l5.68"></a><span id="l5.68">    */</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  virtual nsresult Open(nsIFile *aFolderName, bool aCreate,</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-                        bool aLeaveInvalidDB);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  virtual nsresult Open(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                        bool aCreate, bool aLeaveInvalidDB);</span>
<a href="#l5.73"></a><span id="l5.73">   virtual nsresult IsHeaderRead(nsIMsgDBHdr *hdr, bool *pRead);</span>
<a href="#l5.74"></a><span id="l5.74">   virtual nsresult MarkHdrReadInDB(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l5.75"></a><span id="l5.75">                                nsIDBChangeListener *instigator);</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-  nsresult OpenInternal(nsIFile *aFolderName, bool aCreate,</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-                        bool aLeaveInvalidDB, bool sync);</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  nsresult CheckForErrors(nsresult err, bool sync, nsIFile *summaryFile);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  nsresult OpenInternal(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+                        bool aCreate, bool aLeaveInvalidDB, bool sync);</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  nsresult CheckForErrors(nsresult err, bool sync, nsMsgDBService *aDBService, nsIFile *summaryFile);</span>
<a href="#l5.82"></a><span id="l5.82">   virtual nsresult OpenMDB(const char *dbName, bool create, bool sync);</span>
<a href="#l5.83"></a><span id="l5.83">   virtual nsresult CloseMDB(bool commit);</span>
<a href="#l5.84"></a><span id="l5.84">   virtual nsresult CreateMsgHdr(nsIMdbRow* hdrRow, nsMsgKey key, nsIMsgDBHdr **result);</span>
<a href="#l5.85"></a><span id="l5.85">   virtual nsresult GetThreadForMsgKey(nsMsgKey msgKey, nsIMsgThread **result);</span>
<a href="#l5.86"></a><span id="l5.86">   virtual nsresult EnumerateMessagesWithFlag(nsISimpleEnumerator* *result, uint32_t *pFlag);</span>
<a href="#l5.87"></a><span id="l5.87">   nsresult         GetSearchResultsTable(const char *searchFolderUri, bool createIfMissing, nsIMdbTable **table);</span>
<a href="#l5.88"></a><span id="l5.88"> </span>
<a href="#l5.89"></a><span id="l5.89">   // this might just be for debugging - we'll see.</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineat">@@ -158,19 +179,16 @@ public:</span>
<a href="#l5.91"></a><span id="l5.91">   nsIMdbStore           *GetStore() {return m_mdbStore;}</span>
<a href="#l5.92"></a><span id="l5.92">   virtual uint32_t      GetCurVersion();</span>
<a href="#l5.93"></a><span id="l5.93">   nsresult              GetCollationKeyGenerator();</span>
<a href="#l5.94"></a><span id="l5.94">   nsIMimeConverter *    GetMimeConverter();</span>
<a href="#l5.95"></a><span id="l5.95"> </span>
<a href="#l5.96"></a><span id="l5.96">   nsresult GetTableCreateIfMissing(const char *scope, const char *kind, nsIMdbTable **table, </span>
<a href="#l5.97"></a><span id="l5.97">                                    mdb_token &amp;scopeToken, mdb_token &amp;kindToken);</span>
<a href="#l5.98"></a><span id="l5.98"> </span>
<a href="#l5.99"></a><span id="l5.99" class="difflineminus">-  static nsMsgDatabase* FindInCache(nsIFile *dbName);</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-  static nsIMsgDatabase* FindInCache(nsIMsgFolder *folder);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-</span>
<a href="#l5.102"></a><span id="l5.102">   //helper function to fill in nsStrings from hdr row cell contents.</span>
<a href="#l5.103"></a><span id="l5.103">   nsresult RowCellColumnTonsString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l5.104"></a><span id="l5.104">   nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, uint32_t *uint32Result, uint32_t defaultValue = 0);</span>
<a href="#l5.105"></a><span id="l5.105">   nsresult RowCellColumnToUInt32(nsIMdbRow *row, mdb_token columnToken, uint32_t &amp;uint32Result, uint32_t defaultValue = 0);</span>
<a href="#l5.106"></a><span id="l5.106">   nsresult RowCellColumnToUInt64(nsIMdbRow *row, mdb_token columnToken, uint64_t *uint64Result, uint64_t defaultValue = 0);</span>
<a href="#l5.107"></a><span id="l5.107">   nsresult RowCellColumnToMime2DecodedString(nsIMdbRow *row, mdb_token columnToken, nsAString &amp;resultStr);</span>
<a href="#l5.108"></a><span id="l5.108">   nsresult RowCellColumnToCollationKey(nsIMdbRow *row, mdb_token columnToken, uint8_t **result, uint32_t *len);</span>
<a href="#l5.109"></a><span id="l5.109">   nsresult RowCellColumnToConstCharPtr(nsIMdbRow *row, mdb_token columnToken, const char **ptr);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineat">@@ -202,18 +220,16 @@ public:</span>
<a href="#l5.111"></a><span id="l5.111">   static struct mdbYarn *nsStringToYarn(struct mdbYarn *yarn, const nsAString &amp;str);</span>
<a href="#l5.112"></a><span id="l5.112">   static struct mdbYarn *UInt32ToYarn(struct mdbYarn *yarn, uint32_t i);</span>
<a href="#l5.113"></a><span id="l5.113">   static struct mdbYarn *UInt64ToYarn(struct mdbYarn *yarn, uint64_t i);</span>
<a href="#l5.114"></a><span id="l5.114">   static void YarnTonsString(struct mdbYarn *yarn, nsAString &amp;str);</span>
<a href="#l5.115"></a><span id="l5.115">   static void YarnTonsCString(struct mdbYarn *yarn, nsACString &amp;str);</span>
<a href="#l5.116"></a><span id="l5.116">   static void YarnToUInt32(struct mdbYarn *yarn, uint32_t *i);</span>
<a href="#l5.117"></a><span id="l5.117">   static void YarnToUInt64(struct mdbYarn *yarn, uint64_t *i);</span>
<a href="#l5.118"></a><span id="l5.118"> </span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  static void   CleanupCache();</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-  static void   DumpCache();</span>
<a href="#l5.121"></a><span id="l5.121"> #ifdef DEBUG</span>
<a href="#l5.122"></a><span id="l5.122">   virtual nsresult DumpContents();</span>
<a href="#l5.123"></a><span id="l5.123">   nsresult DumpThread(nsMsgKey threadId);</span>
<a href="#l5.124"></a><span id="l5.124">   nsresult DumpMsgChildren(nsIMsgDBHdr *msgHdr);</span>
<a href="#l5.125"></a><span id="l5.125"> #endif</span>
<a href="#l5.126"></a><span id="l5.126">   </span>
<a href="#l5.127"></a><span id="l5.127">   friend class nsMsgHdr;  // use this to get access to cached tokens for hdr fields</span>
<a href="#l5.128"></a><span id="l5.128">   friend class nsMsgThread;  // use this to get access to cached tokens for hdr fields</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineat">@@ -235,37 +251,21 @@ protected:</span>
<a href="#l5.130"></a><span id="l5.130">   virtual nsresult CreateNewThread(nsMsgKey key, const char *subject, nsMsgThread **newThread);</span>
<a href="#l5.131"></a><span id="l5.131">   virtual bool    ThreadBySubjectWithoutRe();</span>
<a href="#l5.132"></a><span id="l5.132">   virtual bool    UseStrictThreading();</span>
<a href="#l5.133"></a><span id="l5.133">   virtual bool    UseCorrectThreading();</span>
<a href="#l5.134"></a><span id="l5.134">   virtual nsresult ThreadNewHdr(nsMsgHdr* hdr, bool &amp;newThread);</span>
<a href="#l5.135"></a><span id="l5.135">   virtual nsresult AddNewThread(nsMsgHdr *msgHdr);</span>
<a href="#l5.136"></a><span id="l5.136">   virtual nsresult AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread, nsIMsgDBHdr *pMsgHdr, bool threadInThread);</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138" class="difflineminus">-  static nsTArray&lt;nsMsgDatabase*&gt;* m_dbCache;</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineminus">-  static nsTArray&lt;nsMsgDatabase*&gt;* GetDBCache();</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineminus">-</span>
<a href="#l5.141"></a><span id="l5.141">   static PRTime gLastUseTime; // global last use time</span>
<a href="#l5.142"></a><span id="l5.142">   PRTime m_lastUseTime;       // last use time for this db</span>
<a href="#l5.143"></a><span id="l5.143">   // inline to make instrumentation as cheap as possible</span>
<a href="#l5.144"></a><span id="l5.144">   inline void RememberLastUseTime() {gLastUseTime = m_lastUseTime = PR_Now();}</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-  static void    AddToCache(nsMsgDatabase* pMessageDB) </span>
<a href="#l5.147"></a><span id="l5.147" class="difflineminus">-  {</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-#ifdef DEBUG_David_Bienvenu</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineminus">-//    NS_ASSERTION(GetDBCache()-&gt;Length() &lt; 50, &quot;50 or more open db's&quot;);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-#endif</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = pMessageDB-&gt;m_folder ?</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineminus">-                               dont_AddRef(FindInCache(pMessageDB-&gt;m_folder)) : nullptr;</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-    NS_ASSERTION(!msgDB, &quot;shouldn't have db in cache&quot;);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-#endif</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-    GetDBCache()-&gt;AppendElement(pMessageDB);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-  }</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineminus">-  static void    RemoveFromCache(nsMsgDatabase* pMessageDB);</span>
<a href="#l5.159"></a><span id="l5.159">   bool    MatchDbName(nsIFile *dbName);  // returns TRUE if they match</span>
<a href="#l5.160"></a><span id="l5.160"> </span>
<a href="#l5.161"></a><span id="l5.161">   // Flag handling routines</span>
<a href="#l5.162"></a><span id="l5.162">   virtual nsresult SetKeyFlag(nsMsgKey key, bool set, uint32_t flag,</span>
<a href="#l5.163"></a><span id="l5.163">                               nsIDBChangeListener *instigator = NULL);</span>
<a href="#l5.164"></a><span id="l5.164">   virtual nsresult SetMsgHdrFlag(nsIMsgDBHdr *msgHdr, bool set, uint32_t flag, </span>
<a href="#l5.165"></a><span id="l5.165">                                  nsIDBChangeListener *instigator);</span>
<a href="#l5.166"></a><span id="l5.166">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -32,27 +32,27 @@ nsMailDatabase::nsMailDatabase() : m_rep</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> nsMailDatabase::~nsMailDatabase()</span>
<a href="#l6.6"></a><span id="l6.6"> {</span>
<a href="#l6.7"></a><span id="l6.7"> }</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9"> // caller passes in upgrading==true if they want back a db even if the db is out of date.</span>
<a href="#l6.10"></a><span id="l6.10"> // If so, they'll extract out the interesting info from the db, close it, delete it, and</span>
<a href="#l6.11"></a><span id="l6.11"> // then try to open the db again, prior to reparsing.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-nsresult nsMailDatabase::Open(nsIFile *aSummaryFile, bool aCreate,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-                              bool aUpgrading)</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+nsresult nsMailDatabase::Open(nsMsgDBService* aDBService, nsIFile *aSummaryFile,</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+                              bool aCreate, bool aUpgrading)</span>
<a href="#l6.16"></a><span id="l6.16"> {</span>
<a href="#l6.17"></a><span id="l6.17"> #ifdef DEBUG</span>
<a href="#l6.18"></a><span id="l6.18">   nsString leafName;</span>
<a href="#l6.19"></a><span id="l6.19">   aSummaryFile-&gt;GetLeafName(leafName);</span>
<a href="#l6.20"></a><span id="l6.20">   if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.msf&quot;),</span>
<a href="#l6.21"></a><span id="l6.21">                      nsCaseInsensitiveStringComparator()))</span>
<a href="#l6.22"></a><span id="l6.22">     NS_ERROR(&quot;non summary file passed into open\n&quot;);</span>
<a href="#l6.23"></a><span id="l6.23"> #endif</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  return nsMsgDatabase::Open(aSummaryFile, aCreate, aUpgrading);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  return nsMsgDatabase::Open(aDBService, aSummaryFile, aCreate, aUpgrading);</span>
<a href="#l6.26"></a><span id="l6.26"> }</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> NS_IMETHODIMP nsMailDatabase::ForceClosed()</span>
<a href="#l6.29"></a><span id="l6.29"> {</span>
<a href="#l6.30"></a><span id="l6.30">   m_mdbAllOfflineOpsTable = nullptr;</span>
<a href="#l6.31"></a><span id="l6.31">   return nsMsgDatabase::ForceClosed();</span>
<a href="#l6.32"></a><span id="l6.32"> }</span>
<a href="#l6.33"></a><span id="l6.33"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -42,34 +42,30 @@</span>
<a href="#l7.4"></a><span id="l7.4"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l7.5"></a><span id="l7.5"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsIMemoryReporter.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+#include &quot;mozilla/mailnews/Services.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> #include &lt;algorithm&gt;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> using namespace mozilla::mailnews;</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)</span>
<a href="#l7.18"></a><span id="l7.18"> #define DEBUG_MSGKEYSET 1</span>
<a href="#l7.19"></a><span id="l7.19"> #endif</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21"> #define MSG_HASH_SIZE 512</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> // This will be used on discovery, since we don't know total.</span>
<a href="#l7.24"></a><span id="l7.24"> const int32_t kMaxHdrsInCache = 512;</span>
<a href="#l7.25"></a><span id="l7.25"> </span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-// Hopefully we're not opening up lots of databases at the same time, however</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-// this will give us a buffer before we need to start reallocating the cache</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineminus">-// array.</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-const uint32_t kInitialMsgDBCacheSize = 20;</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-</span>
<a href="#l7.31"></a><span id="l7.31"> // special keys</span>
<a href="#l7.32"></a><span id="l7.32"> static const nsMsgKey kAllMsgHdrsTableKey = 1;</span>
<a href="#l7.33"></a><span id="l7.33"> static const nsMsgKey kTableKeyForThreadOne = 0xfffffffe;</span>
<a href="#l7.34"></a><span id="l7.34"> static const nsMsgKey kAllThreadsTableKey = 0xfffffffd;</span>
<a href="#l7.35"></a><span id="l7.35"> static const nsMsgKey kFirstPseudoKey = 0xfffffff0;</span>
<a href="#l7.36"></a><span id="l7.36"> static const nsMsgKey kIdStartOfFake = 0xffffff80;</span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> static PRLogModuleInfo* DBLog;</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineat">@@ -81,16 +77,27 @@ NS_IMPL_ISUPPORTS1(nsMsgDBService, nsIMs</span>
<a href="#l7.40"></a><span id="l7.40"> nsMsgDBService::nsMsgDBService()</span>
<a href="#l7.41"></a><span id="l7.41"> {</span>
<a href="#l7.42"></a><span id="l7.42">   DBLog = PR_NewLogModule(&quot;MSGDB&quot;);</span>
<a href="#l7.43"></a><span id="l7.43"> }</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46"> nsMsgDBService::~nsMsgDBService()</span>
<a href="#l7.47"></a><span id="l7.47"> {</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  // If you hit this warning, it means that some code is holding onto</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  // a db at shutdown.</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+  NS_WARN_IF_FALSE(!m_dbCache.Length(), &quot;some msg dbs left open&quot;);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  {</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    nsMsgDatabase* pMessageDB = m_dbCache.ElementAt(i);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+    if (pMessageDB)</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+      printf(&quot;db left open %s\n&quot;, (const char *) pMessageDB-&gt;m_dbName.get());</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+  }</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineplus">+#endif</span>
<a href="#l7.59"></a><span id="l7.59"> }</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61"> NS_IMETHODIMP nsMsgDBService::OpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l7.62"></a><span id="l7.62">                                            bool aLeaveInvalidDB,</span>
<a href="#l7.63"></a><span id="l7.63">                                            nsIMsgDatabase **_retval)</span>
<a href="#l7.64"></a><span id="l7.64"> {</span>
<a href="#l7.65"></a><span id="l7.65">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l7.66"></a><span id="l7.66">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineat">@@ -99,43 +106,43 @@ NS_IMETHODIMP nsMsgDBService::OpenFolder</span>
<a href="#l7.68"></a><span id="l7.68"> </span>
<a href="#l7.69"></a><span id="l7.69">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l7.70"></a><span id="l7.70">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.71"></a><span id="l7.71">   rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l7.72"></a><span id="l7.72">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.73"></a><span id="l7.73">   rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l7.74"></a><span id="l7.74">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.75"></a><span id="l7.75"> </span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  nsMsgDatabase *cacheDB = nsMsgDatabase::FindInCache(summaryFilePath);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  nsMsgDatabase *cacheDB = FindInCache(summaryFilePath);</span>
<a href="#l7.78"></a><span id="l7.78">   if (cacheDB)</span>
<a href="#l7.79"></a><span id="l7.79">   {</span>
<a href="#l7.80"></a><span id="l7.80">     // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l7.81"></a><span id="l7.81">     // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l7.82"></a><span id="l7.82">     if (!cacheDB-&gt;m_folder)</span>
<a href="#l7.83"></a><span id="l7.83">       cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l7.84"></a><span id="l7.84">     cacheDB-&gt;RememberLastUseTime();</span>
<a href="#l7.85"></a><span id="l7.85">     *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l7.86"></a><span id="l7.86">     // if m_thumb is set, someone is asynchronously opening the db. But our</span>
<a href="#l7.87"></a><span id="l7.87">     // caller wants to synchronously open it, so just do it.</span>
<a href="#l7.88"></a><span id="l7.88">     if (cacheDB-&gt;m_thumb)</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-      return cacheDB-&gt;Open(summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+      return cacheDB-&gt;Open(this, summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l7.91"></a><span id="l7.91">     return NS_OK;</span>
<a href="#l7.92"></a><span id="l7.92">   }</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94">   nsCString localStoreType;</span>
<a href="#l7.95"></a><span id="l7.95">   incomingServer-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l7.96"></a><span id="l7.96">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l7.97"></a><span id="l7.97">   dbContractID.Append(localStoreType.get());</span>
<a href="#l7.98"></a><span id="l7.98">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l7.99"></a><span id="l7.99">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.100"></a><span id="l7.100"> </span>
<a href="#l7.101"></a><span id="l7.101">   // Don't try to create the database yet--let the createNewDB call do that.</span>
<a href="#l7.102"></a><span id="l7.102">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l7.103"></a><span id="l7.103">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineminus">-  rv = msgDatabase-&gt;Open(summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+  rv = msgDatabase-&gt;Open(this, summaryFilePath, false, aLeaveInvalidDB);</span>
<a href="#l7.106"></a><span id="l7.106">   if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l7.107"></a><span id="l7.107">     return rv;</span>
<a href="#l7.108"></a><span id="l7.108"> </span>
<a href="#l7.109"></a><span id="l7.109">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   if (NS_FAILED(rv))</span>
<a href="#l7.112"></a><span id="l7.112">   {</span>
<a href="#l7.113"></a><span id="l7.113"> #ifdef DEBUG</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineat">@@ -157,48 +164,50 @@ NS_IMETHODIMP nsMsgDBService::OpenFolder</span>
<a href="#l7.115"></a><span id="l7.115">   return rv;</span>
<a href="#l7.116"></a><span id="l7.116"> }</span>
<a href="#l7.117"></a><span id="l7.117"> </span>
<a href="#l7.118"></a><span id="l7.118"> NS_IMETHODIMP nsMsgDBService::AsyncOpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l7.119"></a><span id="l7.119">                                                 bool aLeaveInvalidDB,</span>
<a href="#l7.120"></a><span id="l7.120">                                                 nsIMsgDatabase **_retval)</span>
<a href="#l7.121"></a><span id="l7.121"> {</span>
<a href="#l7.122"></a><span id="l7.122">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineminus">-  nsMsgDatabase *cacheDB = (nsMsgDatabase *) nsMsgDatabase::FindInCache(aFolder);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+  nsresult rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+  nsCOMPtr &lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l7.130"></a><span id="l7.130" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l7.131"></a><span id="l7.131" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineplus">+</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineplus">+  nsMsgDatabase *cacheDB = FindInCache(summaryFilePath);</span>
<a href="#l7.134"></a><span id="l7.134">   if (cacheDB)</span>
<a href="#l7.135"></a><span id="l7.135">   {</span>
<a href="#l7.136"></a><span id="l7.136">     // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l7.137"></a><span id="l7.137">     // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l7.138"></a><span id="l7.138">     if (!cacheDB-&gt;m_folder)</span>
<a href="#l7.139"></a><span id="l7.139">       cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l7.140"></a><span id="l7.140">     *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l7.141"></a><span id="l7.141">     // We don't care if an other consumer is thumbing the store. In that</span>
<a href="#l7.142"></a><span id="l7.142">     // case, they'll both thumb the store.</span>
<a href="#l7.143"></a><span id="l7.143">     return NS_OK;</span>
<a href="#l7.144"></a><span id="l7.144">   }</span>
<a href="#l7.145"></a><span id="l7.145"> </span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-  nsresult rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-</span>
<a href="#l7.153"></a><span id="l7.153">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l7.154"></a><span id="l7.154">   rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l7.155"></a><span id="l7.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.156"></a><span id="l7.156">   nsCString localStoreType;</span>
<a href="#l7.157"></a><span id="l7.157">   incomingServer-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l7.158"></a><span id="l7.158">   nsAutoCString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l7.159"></a><span id="l7.159">   dbContractID.Append(localStoreType.get());</span>
<a href="#l7.160"></a><span id="l7.160">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l7.161"></a><span id="l7.161">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.162"></a><span id="l7.162"> </span>
<a href="#l7.163"></a><span id="l7.163">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-  rv = msgDatabase-&gt;OpenInternal(summaryFilePath, false, aLeaveInvalidDB,</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineplus">+  rv = msgDatabase-&gt;OpenInternal(this, summaryFilePath, false, aLeaveInvalidDB,</span>
<a href="#l7.166"></a><span id="l7.166">                                  false /* open asynchronously */);</span>
<a href="#l7.167"></a><span id="l7.167"> </span>
<a href="#l7.168"></a><span id="l7.168">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l7.169"></a><span id="l7.169">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171">   if (NS_FAILED(rv))</span>
<a href="#l7.172"></a><span id="l7.172">   {</span>
<a href="#l7.173"></a><span id="l7.173"> #ifdef DEBUG</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineat">@@ -257,17 +266,17 @@ NS_IMETHODIMP nsMsgDBService::OpenMore(n</span>
<a href="#l7.175"></a><span id="l7.175">       nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l7.176"></a><span id="l7.176">       (void) msgDatabase-&gt;m_folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l7.177"></a><span id="l7.177">       nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l7.178"></a><span id="l7.178">       (void) GetSummaryFileLocation(folderPath, getter_AddRefs(summaryFile));</span>
<a href="#l7.179"></a><span id="l7.179"> </span>
<a href="#l7.180"></a><span id="l7.180">       if (NS_SUCCEEDED(rv))</span>
<a href="#l7.181"></a><span id="l7.181">         rv = (msgDatabase-&gt;m_mdbStore) ? msgDatabase-&gt;InitExistingDB() : NS_ERROR_FAILURE;</span>
<a href="#l7.182"></a><span id="l7.182">       if (NS_SUCCEEDED(rv))</span>
<a href="#l7.183"></a><span id="l7.183" class="difflineminus">-        rv = msgDatabase-&gt;CheckForErrors(rv, false, summaryFile);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineplus">+        rv = msgDatabase-&gt;CheckForErrors(rv, false, this, summaryFile);</span>
<a href="#l7.185"></a><span id="l7.185"> </span>
<a href="#l7.186"></a><span id="l7.186">       FinishDBOpen(msgDatabase-&gt;m_folder, msgDatabase);</span>
<a href="#l7.187"></a><span id="l7.187">       break;</span>
<a href="#l7.188"></a><span id="l7.188">     }</span>
<a href="#l7.189"></a><span id="l7.189">   }</span>
<a href="#l7.190"></a><span id="l7.190">   while (PR_IntervalToMilliseconds(PR_IntervalNow() - startTime) &lt;= aTimeHint);</span>
<a href="#l7.191"></a><span id="l7.191">   *_retval = !msgDatabase-&gt;m_thumb;</span>
<a href="#l7.192"></a><span id="l7.192">   return rv;</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineat">@@ -307,16 +316,36 @@ void nsMsgDBService::FinishDBOpen(nsIMsg</span>
<a href="#l7.194"></a><span id="l7.194">     aMsgDB-&gt;m_dbFolderInfo-&gt;GetNumMessages(&amp;numMessages);</span>
<a href="#l7.195"></a><span id="l7.195">     if (numMessages != (int32_t) numHdrsInTable)</span>
<a href="#l7.196"></a><span id="l7.196">       aMsgDB-&gt;SyncCounts();</span>
<a href="#l7.197"></a><span id="l7.197">   }</span>
<a href="#l7.198"></a><span id="l7.198">   HookupPendingListeners(aMsgDB, aFolder);</span>
<a href="#l7.199"></a><span id="l7.199">   aMsgDB-&gt;RememberLastUseTime();</span>
<a href="#l7.200"></a><span id="l7.200"> }</span>
<a href="#l7.201"></a><span id="l7.201"> </span>
<a href="#l7.202"></a><span id="l7.202" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l7.203"></a><span id="l7.203" class="difflineplus">+// FindInCache - this addrefs the db it finds.</span>
<a href="#l7.204"></a><span id="l7.204" class="difflineplus">+//----------------------------------------------------------------------</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineplus">+nsMsgDatabase* nsMsgDBService::FindInCache(nsIFile *dbName)</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+{</span>
<a href="#l7.207"></a><span id="l7.207" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l7.208"></a><span id="l7.208" class="difflineplus">+  {</span>
<a href="#l7.209"></a><span id="l7.209" class="difflineplus">+    nsMsgDatabase* pMessageDB = m_dbCache[i];</span>
<a href="#l7.210"></a><span id="l7.210" class="difflineplus">+    if (pMessageDB-&gt;MatchDbName(dbName))</span>
<a href="#l7.211"></a><span id="l7.211" class="difflineplus">+    {</span>
<a href="#l7.212"></a><span id="l7.212" class="difflineplus">+      if (pMessageDB-&gt;m_mdbStore)  // don't return db without store</span>
<a href="#l7.213"></a><span id="l7.213" class="difflineplus">+      {</span>
<a href="#l7.214"></a><span id="l7.214" class="difflineplus">+        NS_ADDREF(pMessageDB);</span>
<a href="#l7.215"></a><span id="l7.215" class="difflineplus">+        return pMessageDB;</span>
<a href="#l7.216"></a><span id="l7.216" class="difflineplus">+      }</span>
<a href="#l7.217"></a><span id="l7.217" class="difflineplus">+    }</span>
<a href="#l7.218"></a><span id="l7.218" class="difflineplus">+  }</span>
<a href="#l7.219"></a><span id="l7.219" class="difflineplus">+  return nullptr;</span>
<a href="#l7.220"></a><span id="l7.220" class="difflineplus">+}</span>
<a href="#l7.221"></a><span id="l7.221" class="difflineplus">+</span>
<a href="#l7.222"></a><span id="l7.222"> // This method is called when the caller is trying to create a db without</span>
<a href="#l7.223"></a><span id="l7.223"> // having a corresponding nsIMsgFolder object.  This happens in a few</span>
<a href="#l7.224"></a><span id="l7.224"> // situations, including imap folder discovery, compacting local folders,</span>
<a href="#l7.225"></a><span id="l7.225"> // and copying local folders.</span>
<a href="#l7.226"></a><span id="l7.226"> NS_IMETHODIMP nsMsgDBService::OpenMailDBFromFile(nsIFile *aFolderName,</span>
<a href="#l7.227"></a><span id="l7.227">                                                  nsIMsgFolder *aFolder,</span>
<a href="#l7.228"></a><span id="l7.228">                                                  bool aCreate,</span>
<a href="#l7.229"></a><span id="l7.229">                                                  bool aLeaveInvalidDB,</span>
<a href="#l7.230"></a><span id="l7.230" class="difflineat">@@ -324,23 +353,23 @@ NS_IMETHODIMP nsMsgDBService::OpenMailDB</span>
<a href="#l7.231"></a><span id="l7.231"> {</span>
<a href="#l7.232"></a><span id="l7.232">   if (!aFolderName)</span>
<a href="#l7.233"></a><span id="l7.233">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l7.234"></a><span id="l7.234"> </span>
<a href="#l7.235"></a><span id="l7.235">   nsCOMPtr &lt;nsIFile&gt;  dbPath;</span>
<a href="#l7.236"></a><span id="l7.236">   nsresult rv = GetSummaryFileLocation(aFolderName, getter_AddRefs(dbPath));</span>
<a href="#l7.237"></a><span id="l7.237">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.238"></a><span id="l7.238"> </span>
<a href="#l7.239"></a><span id="l7.239" class="difflineminus">-  *pMessageDB = (nsMsgDatabase *) nsMsgDatabase::FindInCache(dbPath);</span>
<a href="#l7.240"></a><span id="l7.240" class="difflineplus">+  *pMessageDB = FindInCache(dbPath);</span>
<a href="#l7.241"></a><span id="l7.241">   if (*pMessageDB)</span>
<a href="#l7.242"></a><span id="l7.242">     return NS_OK;</span>
<a href="#l7.243"></a><span id="l7.243"> </span>
<a href="#l7.244"></a><span id="l7.244">   nsRefPtr&lt;nsMailDatabase&gt; msgDB = new nsMailDatabase;</span>
<a href="#l7.245"></a><span id="l7.245">   NS_ENSURE_TRUE(msgDB, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l7.246"></a><span id="l7.246" class="difflineminus">-  rv = msgDB-&gt;Open(dbPath, aCreate, aLeaveInvalidDB);</span>
<a href="#l7.247"></a><span id="l7.247" class="difflineplus">+  rv = msgDB-&gt;Open(this, dbPath, aCreate, aLeaveInvalidDB);</span>
<a href="#l7.248"></a><span id="l7.248">   if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l7.249"></a><span id="l7.249">     return rv;</span>
<a href="#l7.250"></a><span id="l7.250">   NS_IF_ADDREF(*pMessageDB = msgDB);</span>
<a href="#l7.251"></a><span id="l7.251">   if (aCreate &amp;&amp; msgDB &amp;&amp; rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l7.252"></a><span id="l7.252">     rv = NS_OK;</span>
<a href="#l7.253"></a><span id="l7.253">   if (NS_SUCCEEDED(rv))</span>
<a href="#l7.254"></a><span id="l7.254">     msgDB-&gt;m_folder = aFolder;</span>
<a href="#l7.255"></a><span id="l7.255">   return rv;</span>
<a href="#l7.256"></a><span id="l7.256" class="difflineat">@@ -368,17 +397,17 @@ NS_IMETHODIMP nsMsgDBService::CreateNewD</span>
<a href="#l7.257"></a><span id="l7.257">   dbContractID.Append(localStoreType.get());</span>
<a href="#l7.258"></a><span id="l7.258">   </span>
<a href="#l7.259"></a><span id="l7.259">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l7.260"></a><span id="l7.260">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.261"></a><span id="l7.261"> </span>
<a href="#l7.262"></a><span id="l7.262">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l7.263"></a><span id="l7.263"> </span>
<a href="#l7.264"></a><span id="l7.264">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l7.265"></a><span id="l7.265" class="difflineminus">-  rv = msgDatabase-&gt;Open(summaryFilePath, true, true);</span>
<a href="#l7.266"></a><span id="l7.266" class="difflineplus">+  rv = msgDatabase-&gt;Open(this, summaryFilePath, true, true);</span>
<a href="#l7.267"></a><span id="l7.267">   NS_ENSURE_TRUE(rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING, rv);</span>
<a href="#l7.268"></a><span id="l7.268"> </span>
<a href="#l7.269"></a><span id="l7.269">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l7.270"></a><span id="l7.270"> </span>
<a href="#l7.271"></a><span id="l7.271">   HookupPendingListeners(msgDB, aFolder);</span>
<a href="#l7.272"></a><span id="l7.272"> </span>
<a href="#l7.273"></a><span id="l7.273">   msgDatabase-&gt;RememberLastUseTime();</span>
<a href="#l7.274"></a><span id="l7.274"> </span>
<a href="#l7.275"></a><span id="l7.275" class="difflineat">@@ -387,57 +416,76 @@ NS_IMETHODIMP nsMsgDBService::CreateNewD</span>
<a href="#l7.276"></a><span id="l7.276"> </span>
<a href="#l7.277"></a><span id="l7.277"> /* void registerPendingListener (in nsIMsgFolder aFolder, in nsIDBChangeListener aListener); */</span>
<a href="#l7.278"></a><span id="l7.278"> NS_IMETHODIMP nsMsgDBService::RegisterPendingListener(nsIMsgFolder *aFolder, nsIDBChangeListener *aListener)</span>
<a href="#l7.279"></a><span id="l7.279"> {</span>
<a href="#l7.280"></a><span id="l7.280">   // need to make sure we don't hold onto these forever. Maybe a shutdown listener?</span>
<a href="#l7.281"></a><span id="l7.281">   // if there is a db open on this folder already, we should register the listener.</span>
<a href="#l7.282"></a><span id="l7.282">   m_foldersPendingListeners.AppendObject(aFolder);</span>
<a href="#l7.283"></a><span id="l7.283">   m_pendingListeners.AppendObject(aListener);</span>
<a href="#l7.284"></a><span id="l7.284" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; openDB = dont_AddRef((nsIMsgDatabase *) nsMsgDatabase::FindInCache(aFolder));</span>
<a href="#l7.285"></a><span id="l7.285" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDatabase&gt; openDB;</span>
<a href="#l7.286"></a><span id="l7.286" class="difflineplus">+  CachedDBForFolder(aFolder, getter_AddRefs(openDB));</span>
<a href="#l7.287"></a><span id="l7.287">   if (openDB)</span>
<a href="#l7.288"></a><span id="l7.288">     openDB-&gt;AddListener(aListener);</span>
<a href="#l7.289"></a><span id="l7.289">   return NS_OK;</span>
<a href="#l7.290"></a><span id="l7.290"> }</span>
<a href="#l7.291"></a><span id="l7.291"> </span>
<a href="#l7.292"></a><span id="l7.292"> /* void unregisterPendingListener (in nsIDBChangeListener aListener); */</span>
<a href="#l7.293"></a><span id="l7.293"> NS_IMETHODIMP nsMsgDBService::UnregisterPendingListener(nsIDBChangeListener *aListener)</span>
<a href="#l7.294"></a><span id="l7.294"> {</span>
<a href="#l7.295"></a><span id="l7.295">   int32_t listenerIndex = m_pendingListeners.IndexOfObject(aListener);</span>
<a href="#l7.296"></a><span id="l7.296">   if (listenerIndex != -1)</span>
<a href="#l7.297"></a><span id="l7.297">   {</span>
<a href="#l7.298"></a><span id="l7.298" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; folder = m_foldersPendingListeners[listenerIndex];</span>
<a href="#l7.299"></a><span id="l7.299" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = dont_AddRef(nsMsgDatabase::FindInCache(folder));</span>
<a href="#l7.300"></a><span id="l7.300" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l7.301"></a><span id="l7.301" class="difflineplus">+    CachedDBForFolder(m_foldersPendingListeners[listenerIndex], getter_AddRefs(msgDB));</span>
<a href="#l7.302"></a><span id="l7.302">     if (msgDB)</span>
<a href="#l7.303"></a><span id="l7.303">       msgDB-&gt;RemoveListener(aListener);</span>
<a href="#l7.304"></a><span id="l7.304">     m_foldersPendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l7.305"></a><span id="l7.305">     m_pendingListeners.RemoveObjectAt(listenerIndex);</span>
<a href="#l7.306"></a><span id="l7.306">     return NS_OK;</span>
<a href="#l7.307"></a><span id="l7.307">   }</span>
<a href="#l7.308"></a><span id="l7.308">   return NS_ERROR_FAILURE;</span>
<a href="#l7.309"></a><span id="l7.309"> }</span>
<a href="#l7.310"></a><span id="l7.310"> </span>
<a href="#l7.311"></a><span id="l7.311"> NS_IMETHODIMP nsMsgDBService::CachedDBForFolder(nsIMsgFolder *aFolder, nsIMsgDatabase **aRetDB)</span>
<a href="#l7.312"></a><span id="l7.312"> {</span>
<a href="#l7.313"></a><span id="l7.313">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l7.314"></a><span id="l7.314">   NS_ENSURE_ARG_POINTER(aRetDB);</span>
<a href="#l7.315"></a><span id="l7.315" class="difflineminus">-  *aRetDB = nsMsgDatabase::FindInCache(aFolder);</span>
<a href="#l7.316"></a><span id="l7.316" class="difflineplus">+</span>
<a href="#l7.317"></a><span id="l7.317" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l7.318"></a><span id="l7.318" class="difflineplus">+  nsresult rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l7.319"></a><span id="l7.319" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.320"></a><span id="l7.320" class="difflineplus">+</span>
<a href="#l7.321"></a><span id="l7.321" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; summaryFilePath;</span>
<a href="#l7.322"></a><span id="l7.322" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l7.323"></a><span id="l7.323" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.324"></a><span id="l7.324" class="difflineplus">+</span>
<a href="#l7.325"></a><span id="l7.325" class="difflineplus">+  *aRetDB = FindInCache(summaryFilePath);</span>
<a href="#l7.326"></a><span id="l7.326">   return NS_OK;</span>
<a href="#l7.327"></a><span id="l7.327"> }</span>
<a href="#l7.328"></a><span id="l7.328"> </span>
<a href="#l7.329"></a><span id="l7.329" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::ForceFolderDBClosed(nsIMsgFolder *aFolder)</span>
<a href="#l7.330"></a><span id="l7.330" class="difflineplus">+{</span>
<a href="#l7.331"></a><span id="l7.331" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; mailDB;</span>
<a href="#l7.332"></a><span id="l7.332" class="difflineplus">+  nsresult rv = CachedDBForFolder(aFolder, getter_AddRefs(mailDB));</span>
<a href="#l7.333"></a><span id="l7.333" class="difflineplus">+  if (mailDB)</span>
<a href="#l7.334"></a><span id="l7.334" class="difflineplus">+  {</span>
<a href="#l7.335"></a><span id="l7.335" class="difflineplus">+    mailDB-&gt;ForceClosed();</span>
<a href="#l7.336"></a><span id="l7.336" class="difflineplus">+  }</span>
<a href="#l7.337"></a><span id="l7.337" class="difflineplus">+  return rv;</span>
<a href="#l7.338"></a><span id="l7.338" class="difflineplus">+}</span>
<a href="#l7.339"></a><span id="l7.339" class="difflineplus">+</span>
<a href="#l7.340"></a><span id="l7.340"> NS_IMETHODIMP nsMsgDBService::GetOpenDBs(nsIArray **aOpenDBs)</span>
<a href="#l7.341"></a><span id="l7.341"> {</span>
<a href="#l7.342"></a><span id="l7.342">   NS_ENSURE_ARG_POINTER(aOpenDBs);</span>
<a href="#l7.343"></a><span id="l7.343">   nsresult rv;</span>
<a href="#l7.344"></a><span id="l7.344">   nsCOMPtr&lt;nsIMutableArray&gt; openDBs(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l7.345"></a><span id="l7.345">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.346"></a><span id="l7.346" class="difflineminus">-  nsMsgDatabase::GetDBCache();</span>
<a href="#l7.347"></a><span id="l7.347" class="difflineminus">-  NS_ENSURE_TRUE(nsMsgDatabase::m_dbCache, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l7.348"></a><span id="l7.348" class="difflineminus">-  for (uint32_t i = 0; i &lt; nsMsgDatabase::m_dbCache-&gt;Length(); i++)</span>
<a href="#l7.349"></a><span id="l7.349" class="difflineminus">-    openDBs-&gt;AppendElement(nsMsgDatabase::m_dbCache-&gt;ElementAt(i), false);</span>
<a href="#l7.350"></a><span id="l7.350" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l7.351"></a><span id="l7.351" class="difflineplus">+    openDBs-&gt;AppendElement(m_dbCache[i], false);</span>
<a href="#l7.352"></a><span id="l7.352"> </span>
<a href="#l7.353"></a><span id="l7.353">   openDBs.forget(aOpenDBs);</span>
<a href="#l7.354"></a><span id="l7.354">   return NS_OK;</span>
<a href="#l7.355"></a><span id="l7.355"> }</span>
<a href="#l7.356"></a><span id="l7.356"> </span>
<a href="#l7.357"></a><span id="l7.357"> static bool gGotGlobalPrefs = false;</span>
<a href="#l7.358"></a><span id="l7.358"> static bool gThreadWithoutRe = true;</span>
<a href="#l7.359"></a><span id="l7.359"> static bool gStrictThreading = false;</span>
<a href="#l7.360"></a><span id="l7.360" class="difflineat">@@ -887,117 +935,49 @@ NS_IMETHODIMP nsMsgDatabase::NotifyParen</span>
<a href="#l7.361"></a><span id="l7.361"> </span>
<a href="#l7.362"></a><span id="l7.362"> </span>
<a href="#l7.363"></a><span id="l7.363"> NS_IMETHODIMP nsMsgDatabase::NotifyAnnouncerGoingAway(void)</span>
<a href="#l7.364"></a><span id="l7.364"> {</span>
<a href="#l7.365"></a><span id="l7.365">   NOTIFY_LISTENERS(OnAnnouncerGoingAway, (this));</span>
<a href="#l7.366"></a><span id="l7.366">   return NS_OK;</span>
<a href="#l7.367"></a><span id="l7.367"> }</span>
<a href="#l7.368"></a><span id="l7.368"> </span>
<a href="#l7.369"></a><span id="l7.369" class="difflineminus">-// Apparently its not good for nsTArray to be allocated as static. Don't know</span>
<a href="#l7.370"></a><span id="l7.370" class="difflineminus">-// why it isn't but its not, so don't think about making it a static variable.</span>
<a href="#l7.371"></a><span id="l7.371" class="difflineminus">-// Maybe bz knows.</span>
<a href="#l7.372"></a><span id="l7.372" class="difflineminus">-nsTArray&lt;nsMsgDatabase*&gt;* nsMsgDatabase::m_dbCache;</span>
<a href="#l7.373"></a><span id="l7.373" class="difflineminus">-</span>
<a href="#l7.374"></a><span id="l7.374" class="difflineminus">-nsTArray&lt;nsMsgDatabase*&gt;*</span>
<a href="#l7.375"></a><span id="l7.375" class="difflineminus">-nsMsgDatabase::GetDBCache()</span>
<a href="#l7.376"></a><span id="l7.376" class="difflineminus">-{</span>
<a href="#l7.377"></a><span id="l7.377" class="difflineminus">-  if (!m_dbCache)</span>
<a href="#l7.378"></a><span id="l7.378" class="difflineminus">-    m_dbCache = new nsAutoTArray&lt;nsMsgDatabase*, kInitialMsgDBCacheSize&gt;;</span>
<a href="#l7.379"></a><span id="l7.379" class="difflineminus">-</span>
<a href="#l7.380"></a><span id="l7.380" class="difflineminus">-  return m_dbCache;</span>
<a href="#l7.381"></a><span id="l7.381" class="difflineminus">-}</span>
<a href="#l7.382"></a><span id="l7.382" class="difflineminus">-</span>
<a href="#l7.383"></a><span id="l7.383" class="difflineminus">-void</span>
<a href="#l7.384"></a><span id="l7.384" class="difflineminus">-nsMsgDatabase::CleanupCache()</span>
<a href="#l7.385"></a><span id="l7.385" class="difflineminus">-{</span>
<a href="#l7.386"></a><span id="l7.386" class="difflineminus">-  if (m_dbCache)</span>
<a href="#l7.387"></a><span id="l7.387" class="difflineminus">-  {</span>
<a href="#l7.388"></a><span id="l7.388" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l7.389"></a><span id="l7.389" class="difflineminus">-    // If you hit this warning, it means that some code is holding onto</span>
<a href="#l7.390"></a><span id="l7.390" class="difflineminus">-    // a db at shutdown.</span>
<a href="#l7.391"></a><span id="l7.391" class="difflineminus">-    NS_WARN_IF_FALSE(!m_dbCache-&gt;Length(), &quot;some msg dbs left open&quot;);</span>
<a href="#l7.392"></a><span id="l7.392" class="difflineminus">-    for (uint32_t i = 0; i &lt; m_dbCache-&gt;Length(); i++)</span>
<a href="#l7.393"></a><span id="l7.393" class="difflineminus">-    {</span>
<a href="#l7.394"></a><span id="l7.394" class="difflineminus">-      nsMsgDatabase* pMessageDB = m_dbCache-&gt;ElementAt(i);</span>
<a href="#l7.395"></a><span id="l7.395" class="difflineminus">-      if (pMessageDB)</span>
<a href="#l7.396"></a><span id="l7.396" class="difflineminus">-        printf(&quot;db left open %s\n&quot;, (const char *) pMessageDB-&gt;m_dbName.get());</span>
<a href="#l7.397"></a><span id="l7.397" class="difflineminus">-    }</span>
<a href="#l7.398"></a><span id="l7.398" class="difflineminus">-#endif</span>
<a href="#l7.399"></a><span id="l7.399" class="difflineminus">-    delete m_dbCache;</span>
<a href="#l7.400"></a><span id="l7.400" class="difflineminus">-    m_dbCache = nullptr;</span>
<a href="#l7.401"></a><span id="l7.401" class="difflineminus">-  }</span>
<a href="#l7.402"></a><span id="l7.402" class="difflineminus">-}</span>
<a href="#l7.403"></a><span id="l7.403" class="difflineminus">-</span>
<a href="#l7.404"></a><span id="l7.404" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.405"></a><span id="l7.405" class="difflineminus">-// FindInCache - this addrefs the db it finds.</span>
<a href="#l7.406"></a><span id="l7.406" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.407"></a><span id="l7.407" class="difflineminus">-nsMsgDatabase* nsMsgDatabase::FindInCache(nsIFile *dbName)</span>
<a href="#l7.408"></a><span id="l7.408" class="difflineminus">-{</span>
<a href="#l7.409"></a><span id="l7.409" class="difflineminus">-  nsTArray&lt;nsMsgDatabase*&gt;* dbCache = GetDBCache();</span>
<a href="#l7.410"></a><span id="l7.410" class="difflineminus">-  uint32_t length = dbCache-&gt;Length();</span>
<a href="#l7.411"></a><span id="l7.411" class="difflineminus">-  for (uint32_t i = 0; i &lt; length; i++)</span>
<a href="#l7.412"></a><span id="l7.412" class="difflineminus">-  {</span>
<a href="#l7.413"></a><span id="l7.413" class="difflineminus">-    nsMsgDatabase* pMessageDB = dbCache-&gt;ElementAt(i);</span>
<a href="#l7.414"></a><span id="l7.414" class="difflineminus">-    if (pMessageDB-&gt;MatchDbName(dbName))</span>
<a href="#l7.415"></a><span id="l7.415" class="difflineminus">-    {</span>
<a href="#l7.416"></a><span id="l7.416" class="difflineminus">-      if (pMessageDB-&gt;m_mdbStore)  // don't return db without store</span>
<a href="#l7.417"></a><span id="l7.417" class="difflineminus">-      {</span>
<a href="#l7.418"></a><span id="l7.418" class="difflineminus">-        NS_ADDREF(pMessageDB);</span>
<a href="#l7.419"></a><span id="l7.419" class="difflineminus">-        return pMessageDB;</span>
<a href="#l7.420"></a><span id="l7.420" class="difflineminus">-      }</span>
<a href="#l7.421"></a><span id="l7.421" class="difflineminus">-    }</span>
<a href="#l7.422"></a><span id="l7.422" class="difflineminus">-  }</span>
<a href="#l7.423"></a><span id="l7.423" class="difflineminus">-  return nullptr;</span>
<a href="#l7.424"></a><span id="l7.424" class="difflineminus">-}</span>
<a href="#l7.425"></a><span id="l7.425" class="difflineminus">-</span>
<a href="#l7.426"></a><span id="l7.426" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.427"></a><span id="l7.427" class="difflineminus">-// FindInCache(nsIMsgFolder) - this addrefs the db it finds.</span>
<a href="#l7.428"></a><span id="l7.428" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.429"></a><span id="l7.429" class="difflineminus">-nsIMsgDatabase* nsMsgDatabase::FindInCache(nsIMsgFolder *folder)</span>
<a href="#l7.430"></a><span id="l7.430" class="difflineminus">-{</span>
<a href="#l7.431"></a><span id="l7.431" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l7.432"></a><span id="l7.432" class="difflineminus">-</span>
<a href="#l7.433"></a><span id="l7.433" class="difflineminus">-  nsresult rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l7.434"></a><span id="l7.434" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l7.435"></a><span id="l7.435" class="difflineminus">-</span>
<a href="#l7.436"></a><span id="l7.436" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l7.437"></a><span id="l7.437" class="difflineminus">-  rv = GetSummaryFileLocation(folderPath, getter_AddRefs(summaryFile));</span>
<a href="#l7.438"></a><span id="l7.438" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l7.439"></a><span id="l7.439" class="difflineminus">-</span>
<a href="#l7.440"></a><span id="l7.440" class="difflineminus">-  return (nsIMsgDatabase *) FindInCache(summaryFile);</span>
<a href="#l7.441"></a><span id="l7.441" class="difflineminus">-}</span>
<a href="#l7.442"></a><span id="l7.442" class="difflineminus">-</span>
<a href="#l7.443"></a><span id="l7.443"> bool nsMsgDatabase::MatchDbName(nsIFile *dbName)  // returns true if they match</span>
<a href="#l7.444"></a><span id="l7.444"> {</span>
<a href="#l7.445"></a><span id="l7.445">   nsCString dbPath;</span>
<a href="#l7.446"></a><span id="l7.446">   dbName-&gt;GetNativePath(dbPath);</span>
<a href="#l7.447"></a><span id="l7.447">   return dbPath.Equals(m_dbName);</span>
<a href="#l7.448"></a><span id="l7.448"> }</span>
<a href="#l7.449"></a><span id="l7.449"> </span>
<a href="#l7.450"></a><span id="l7.450" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.451"></a><span id="l7.451" class="difflineminus">-// RemoveFromCache</span>
<a href="#l7.452"></a><span id="l7.452" class="difflineminus">-//----------------------------------------------------------------------</span>
<a href="#l7.453"></a><span id="l7.453" class="difflineminus">-void nsMsgDatabase::RemoveFromCache(nsMsgDatabase* pMessageDB)</span>
<a href="#l7.454"></a><span id="l7.454" class="difflineminus">-{</span>
<a href="#l7.455"></a><span id="l7.455" class="difflineminus">-  if (m_dbCache)</span>
<a href="#l7.456"></a><span id="l7.456" class="difflineminus">-    m_dbCache-&gt;RemoveElement(pMessageDB);</span>
<a href="#l7.457"></a><span id="l7.457" class="difflineplus">+void nsMsgDBService::AddToCache(nsMsgDatabase* pMessageDB)</span>
<a href="#l7.458"></a><span id="l7.458" class="difflineplus">+{</span>
<a href="#l7.459"></a><span id="l7.459" class="difflineplus">+#ifdef DEBUG_David_Bienvenu</span>
<a href="#l7.460"></a><span id="l7.460" class="difflineplus">+  NS_ASSERTION(m_dbCache.Length() &lt; 50, &quot;50 or more open db's&quot;);</span>
<a href="#l7.461"></a><span id="l7.461" class="difflineplus">+#endif</span>
<a href="#l7.462"></a><span id="l7.462" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l7.463"></a><span id="l7.463" class="difflineplus">+  if (pMessageDB-&gt;m_folder)</span>
<a href="#l7.464"></a><span id="l7.464" class="difflineplus">+  {</span>
<a href="#l7.465"></a><span id="l7.465" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB;</span>
<a href="#l7.466"></a><span id="l7.466" class="difflineplus">+    CachedDBForFolder(pMessageDB-&gt;m_folder, getter_AddRefs(msgDB));</span>
<a href="#l7.467"></a><span id="l7.467" class="difflineplus">+    NS_ASSERTION(!msgDB, &quot;shouldn't have db in cache&quot;);</span>
<a href="#l7.468"></a><span id="l7.468" class="difflineplus">+  }</span>
<a href="#l7.469"></a><span id="l7.469" class="difflineplus">+#endif</span>
<a href="#l7.470"></a><span id="l7.470" class="difflineplus">+  m_dbCache.AppendElement(pMessageDB);</span>
<a href="#l7.471"></a><span id="l7.471"> }</span>
<a href="#l7.472"></a><span id="l7.472"> </span>
<a href="#l7.473"></a><span id="l7.473"> /**</span>
<a href="#l7.474"></a><span id="l7.474">  * Log the open db's, and how many headers are in memory.</span>
<a href="#l7.475"></a><span id="l7.475">  */</span>
<a href="#l7.476"></a><span id="l7.476" class="difflineminus">-void nsMsgDatabase::DumpCache()</span>
<a href="#l7.477"></a><span id="l7.477" class="difflineminus">-{</span>
<a href="#l7.478"></a><span id="l7.478" class="difflineminus">-  nsTArray&lt;nsMsgDatabase*&gt;* dbCache = GetDBCache();</span>
<a href="#l7.479"></a><span id="l7.479" class="difflineplus">+void nsMsgDBService::DumpCache()</span>
<a href="#l7.480"></a><span id="l7.480" class="difflineplus">+{</span>
<a href="#l7.481"></a><span id="l7.481">   nsMsgDatabase* db = nullptr;</span>
<a href="#l7.482"></a><span id="l7.482" class="difflineminus">-  PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;%d open DB's\n&quot;, dbCache-&gt;Length()));</span>
<a href="#l7.483"></a><span id="l7.483" class="difflineminus">-  for (uint32_t i = 0; i &lt; dbCache-&gt;Length(); i++)</span>
<a href="#l7.484"></a><span id="l7.484" class="difflineplus">+  PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;%d open DB's\n&quot;, m_dbCache.Length()));</span>
<a href="#l7.485"></a><span id="l7.485" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_dbCache.Length(); i++)</span>
<a href="#l7.486"></a><span id="l7.486">   {</span>
<a href="#l7.487"></a><span id="l7.487" class="difflineminus">-    db = dbCache-&gt;ElementAt(i);</span>
<a href="#l7.488"></a><span id="l7.488" class="difflineplus">+    db = m_dbCache.ElementAt(i);</span>
<a href="#l7.489"></a><span id="l7.489">     PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;%s - %ld hdrs in use\n&quot;,</span>
<a href="#l7.490"></a><span id="l7.490">       (const char*)db-&gt;m_dbName.get(),</span>
<a href="#l7.491"></a><span id="l7.491">       db-&gt;m_headersInUse ? db-&gt;m_headersInUse-&gt;entryCount : 0));</span>
<a href="#l7.492"></a><span id="l7.492">   }</span>
<a href="#l7.493"></a><span id="l7.493"> }</span>
<a href="#l7.494"></a><span id="l7.494"> </span>
<a href="#l7.495"></a><span id="l7.495"> // Memory Reporting implementations</span>
<a href="#l7.496"></a><span id="l7.496"> </span>
<a href="#l7.497"></a><span id="l7.497" class="difflineat">@@ -1158,17 +1138,19 @@ nsMsgDatabase::~nsMsgDatabase()</span>
<a href="#l7.498"></a><span id="l7.498">   {</span>
<a href="#l7.499"></a><span id="l7.499">     PL_DHashTableDestroy(m_msgReferences);</span>
<a href="#l7.500"></a><span id="l7.500">     m_msgReferences = nullptr;</span>
<a href="#l7.501"></a><span id="l7.501">   }</span>
<a href="#l7.502"></a><span id="l7.502"> </span>
<a href="#l7.503"></a><span id="l7.503">   PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;closing database    %s\n&quot;,</span>
<a href="#l7.504"></a><span id="l7.504">     (const char*)m_dbName.get()));</span>
<a href="#l7.505"></a><span id="l7.505"> </span>
<a href="#l7.506"></a><span id="l7.506" class="difflineminus">-  RemoveFromCache(this);</span>
<a href="#l7.507"></a><span id="l7.507" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; serv(mozilla::services::GetDBService());</span>
<a href="#l7.508"></a><span id="l7.508" class="difflineplus">+  static_cast&lt;nsMsgDBService*&gt;(serv.get())-&gt;RemoveFromCache(this);</span>
<a href="#l7.509"></a><span id="l7.509" class="difflineplus">+</span>
<a href="#l7.510"></a><span id="l7.510">   // if the db folder info refers to the mdb db, we must clear it because</span>
<a href="#l7.511"></a><span id="l7.511">   // the reference will be a dangling one soon.</span>
<a href="#l7.512"></a><span id="l7.512">   if (m_dbFolderInfo)</span>
<a href="#l7.513"></a><span id="l7.513">     m_dbFolderInfo-&gt;ReleaseExternalReferences();</span>
<a href="#l7.514"></a><span id="l7.514"> </span>
<a href="#l7.515"></a><span id="l7.515">   NS_IF_RELEASE(m_dbFolderInfo);</span>
<a href="#l7.516"></a><span id="l7.516">   if (m_mdbAllMsgHeadersTable)</span>
<a href="#l7.517"></a><span id="l7.517">     m_mdbAllMsgHeadersTable-&gt;Release();</span>
<a href="#l7.518"></a><span id="l7.518" class="difflineat">@@ -1199,56 +1181,58 @@ void nsMsgDatabase::GetMDBFactory(nsIMdb</span>
<a href="#l7.519"></a><span id="l7.519">       mdbFactoryService-&gt;GetMdbFactory(getter_AddRefs(mMdbFactory));</span>
<a href="#l7.520"></a><span id="l7.520">   }</span>
<a href="#l7.521"></a><span id="l7.521">   NS_IF_ADDREF(*aMdbFactory = mMdbFactory);</span>
<a href="#l7.522"></a><span id="l7.522"> }</span>
<a href="#l7.523"></a><span id="l7.523"> </span>
<a href="#l7.524"></a><span id="l7.524"> // aLeaveInvalidDB: true if caller wants back a db even out of date.</span>
<a href="#l7.525"></a><span id="l7.525"> // If so, they'll extract out the interesting info from the db, close it,</span>
<a href="#l7.526"></a><span id="l7.526"> // delete it, and then try to open the db again, prior to reparsing.</span>
<a href="#l7.527"></a><span id="l7.527" class="difflineminus">-nsresult nsMsgDatabase::Open(nsIFile *aFolderName, bool aCreate,</span>
<a href="#l7.528"></a><span id="l7.528" class="difflineminus">-                             bool aLeaveInvalidDB)</span>
<a href="#l7.529"></a><span id="l7.529" class="difflineminus">-{</span>
<a href="#l7.530"></a><span id="l7.530" class="difflineminus">-  return nsMsgDatabase::OpenInternal(aFolderName, aCreate, aLeaveInvalidDB,</span>
<a href="#l7.531"></a><span id="l7.531" class="difflineplus">+nsresult nsMsgDatabase::Open(nsMsgDBService *aDBService, nsIFile *aFolderName,</span>
<a href="#l7.532"></a><span id="l7.532" class="difflineplus">+                             bool aCreate, bool aLeaveInvalidDB)</span>
<a href="#l7.533"></a><span id="l7.533" class="difflineplus">+{</span>
<a href="#l7.534"></a><span id="l7.534" class="difflineplus">+  return nsMsgDatabase::OpenInternal(aDBService, aFolderName, aCreate, aLeaveInvalidDB,</span>
<a href="#l7.535"></a><span id="l7.535">                                      true /* open synchronously */);</span>
<a href="#l7.536"></a><span id="l7.536"> }</span>
<a href="#l7.537"></a><span id="l7.537"> </span>
<a href="#l7.538"></a><span id="l7.538" class="difflineminus">-nsresult nsMsgDatabase::OpenInternal(nsIFile *summaryFile, bool aCreate,</span>
<a href="#l7.539"></a><span id="l7.539" class="difflineplus">+nsresult nsMsgDatabase::OpenInternal(nsMsgDBService *aDBService,</span>
<a href="#l7.540"></a><span id="l7.540" class="difflineplus">+                                     nsIFile *summaryFile, bool aCreate,</span>
<a href="#l7.541"></a><span id="l7.541">                                      bool aLeaveInvalidDB, bool sync)</span>
<a href="#l7.542"></a><span id="l7.542"> {</span>
<a href="#l7.543"></a><span id="l7.543">   nsAutoCString summaryFilePath;</span>
<a href="#l7.544"></a><span id="l7.544">   summaryFile-&gt;GetNativePath(summaryFilePath);</span>
<a href="#l7.545"></a><span id="l7.545"> </span>
<a href="#l7.546"></a><span id="l7.546">   PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l7.547"></a><span id="l7.547">     (const char*)summaryFilePath.get(), aCreate ? &quot;TRUE&quot;:&quot;FALSE&quot;,</span>
<a href="#l7.548"></a><span id="l7.548">     this, aLeaveInvalidDB ? &quot;TRUE&quot;:&quot;FALSE&quot;));</span>
<a href="#l7.549"></a><span id="l7.549"> </span>
<a href="#l7.550"></a><span id="l7.550"> </span>
<a href="#l7.551"></a><span id="l7.551">   nsresult rv = OpenMDB(summaryFilePath.get(), aCreate, sync);</span>
<a href="#l7.552"></a><span id="l7.552">   if (NS_FAILED(rv))</span>
<a href="#l7.553"></a><span id="l7.553">     PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;error opening db %lx&quot;, rv));</span>
<a href="#l7.554"></a><span id="l7.554"> </span>
<a href="#l7.555"></a><span id="l7.555">   if (PR_LOG_TEST(DBLog, PR_LOG_DEBUG))</span>
<a href="#l7.556"></a><span id="l7.556" class="difflineminus">-    DumpCache();</span>
<a href="#l7.557"></a><span id="l7.557" class="difflineplus">+    aDBService-&gt;DumpCache();</span>
<a href="#l7.558"></a><span id="l7.558"> </span>
<a href="#l7.559"></a><span id="l7.559">   if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l7.560"></a><span id="l7.560">     return rv;</span>
<a href="#l7.561"></a><span id="l7.561"> </span>
<a href="#l7.562"></a><span id="l7.562">   m_create = aCreate;</span>
<a href="#l7.563"></a><span id="l7.563">   m_leaveInvalidDB = aLeaveInvalidDB;</span>
<a href="#l7.564"></a><span id="l7.564">   if (!sync &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l7.565"></a><span id="l7.565">   {</span>
<a href="#l7.566"></a><span id="l7.566" class="difflineminus">-    AddToCache(this);</span>
<a href="#l7.567"></a><span id="l7.567" class="difflineplus">+    aDBService-&gt;AddToCache(this);</span>
<a href="#l7.568"></a><span id="l7.568">     // remember open options for when the parsing is complete.</span>
<a href="#l7.569"></a><span id="l7.569">     return rv;</span>
<a href="#l7.570"></a><span id="l7.570">   }</span>
<a href="#l7.571"></a><span id="l7.571" class="difflineminus">-  return CheckForErrors(rv, true, summaryFile);</span>
<a href="#l7.572"></a><span id="l7.572" class="difflineplus">+  return CheckForErrors(rv, true, aDBService, summaryFile);</span>
<a href="#l7.573"></a><span id="l7.573"> }</span>
<a href="#l7.574"></a><span id="l7.574"> </span>
<a href="#l7.575"></a><span id="l7.575"> nsresult nsMsgDatabase::CheckForErrors(nsresult err, bool sync,</span>
<a href="#l7.576"></a><span id="l7.576" class="difflineplus">+                                       nsMsgDBService *aDBService,</span>
<a href="#l7.577"></a><span id="l7.577">                                        nsIFile *summaryFile)</span>
<a href="#l7.578"></a><span id="l7.578"> {</span>
<a href="#l7.579"></a><span id="l7.579">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l7.580"></a><span id="l7.580">   bool summaryFileExists;</span>
<a href="#l7.581"></a><span id="l7.581">   bool newFile = false;</span>
<a href="#l7.582"></a><span id="l7.582">   bool deleteInvalidDB = false;</span>
<a href="#l7.583"></a><span id="l7.583"> </span>
<a href="#l7.584"></a><span id="l7.584">   bool exists;</span>
<a href="#l7.585"></a><span id="l7.585" class="difflineat">@@ -1309,17 +1293,17 @@ nsresult nsMsgDatabase::CheckForErrors(n</span>
<a href="#l7.586"></a><span id="l7.586">     }</span>
<a href="#l7.587"></a><span id="l7.587">     else if (NS_FAILED(err) &amp;&amp; err != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l7.588"></a><span id="l7.588">     {</span>
<a href="#l7.589"></a><span id="l7.589">       Close(false);</span>
<a href="#l7.590"></a><span id="l7.590">       summaryFile-&gt;Remove(false);  // blow away the db if it's corrupt.</span>
<a href="#l7.591"></a><span id="l7.591">     }</span>
<a href="#l7.592"></a><span id="l7.592">   }</span>
<a href="#l7.593"></a><span id="l7.593">   if (sync &amp;&amp; (NS_SUCCEEDED(err) || err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING))</span>
<a href="#l7.594"></a><span id="l7.594" class="difflineminus">-    AddToCache(this);</span>
<a href="#l7.595"></a><span id="l7.595" class="difflineplus">+    aDBService-&gt;AddToCache(this);</span>
<a href="#l7.596"></a><span id="l7.596">   return (summaryFileExists) ? err : NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l7.597"></a><span id="l7.597"> }</span>
<a href="#l7.598"></a><span id="l7.598"> </span>
<a href="#l7.599"></a><span id="l7.599"> /**</span>
<a href="#l7.600"></a><span id="l7.600">  * Open the MDB database synchronously or async based on sync argument.</span>
<a href="#l7.601"></a><span id="l7.601">  * If successful, this routine will set up the m_mdbStore and m_mdbEnv of</span>
<a href="#l7.602"></a><span id="l7.602">  * the database object so other database calls can work.</span>
<a href="#l7.603"></a><span id="l7.603">  */</span>
<a href="#l7.604"></a><span id="l7.604" class="difflineat">@@ -1438,38 +1422,16 @@ nsresult nsMsgDatabase::OpenMDB(const ch</span>
<a href="#l7.605"></a><span id="l7.605"> </span>
<a href="#l7.606"></a><span id="l7.606"> nsresult nsMsgDatabase::CloseMDB(bool commit)</span>
<a href="#l7.607"></a><span id="l7.607"> {</span>
<a href="#l7.608"></a><span id="l7.608">   if (commit)</span>
<a href="#l7.609"></a><span id="l7.609">     Commit(nsMsgDBCommitType::kSessionCommit);</span>
<a href="#l7.610"></a><span id="l7.610">   return(NS_OK);</span>
<a href="#l7.611"></a><span id="l7.611"> }</span>
<a href="#l7.612"></a><span id="l7.612"> </span>
<a href="#l7.613"></a><span id="l7.613" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::ForceFolderDBClosed(nsIMsgFolder *aFolder)</span>
<a href="#l7.614"></a><span id="l7.614" class="difflineminus">-{</span>
<a href="#l7.615"></a><span id="l7.615" class="difflineminus">-  NS_ENSURE_ARG(aFolder);</span>
<a href="#l7.616"></a><span id="l7.616" class="difflineminus">-</span>
<a href="#l7.617"></a><span id="l7.617" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; folderPath;</span>
<a href="#l7.618"></a><span id="l7.618" class="difflineminus">-  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l7.619"></a><span id="l7.619" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.620"></a><span id="l7.620" class="difflineminus">-</span>
<a href="#l7.621"></a><span id="l7.621" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; dbPath;</span>
<a href="#l7.622"></a><span id="l7.622" class="difflineminus">-  rv = GetSummaryFileLocation(folderPath, getter_AddRefs(dbPath));</span>
<a href="#l7.623"></a><span id="l7.623" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.624"></a><span id="l7.624" class="difflineminus">-</span>
<a href="#l7.625"></a><span id="l7.625" class="difflineminus">-  nsIMsgDatabase *mailDB = (nsMsgDatabase *) FindInCache(dbPath);</span>
<a href="#l7.626"></a><span id="l7.626" class="difflineminus">-  if (mailDB)</span>
<a href="#l7.627"></a><span id="l7.627" class="difflineminus">-  {</span>
<a href="#l7.628"></a><span id="l7.628" class="difflineminus">-    mailDB-&gt;ForceClosed();</span>
<a href="#l7.629"></a><span id="l7.629" class="difflineminus">-   //FindInCache AddRef's</span>
<a href="#l7.630"></a><span id="l7.630" class="difflineminus">-    mailDB-&gt;Release();</span>
<a href="#l7.631"></a><span id="l7.631" class="difflineminus">-  }</span>
<a href="#l7.632"></a><span id="l7.632" class="difflineminus">-  return(NS_OK);</span>
<a href="#l7.633"></a><span id="l7.633" class="difflineminus">- }</span>
<a href="#l7.634"></a><span id="l7.634" class="difflineminus">-</span>
<a href="#l7.635"></a><span id="l7.635"> </span>
<a href="#l7.636"></a><span id="l7.636"> // force the database to close - this'll flush out anybody holding onto</span>
<a href="#l7.637"></a><span id="l7.637"> // a database without having a listener!</span>
<a href="#l7.638"></a><span id="l7.638"> // This is evil in the com world, but there are times we need to delete the file.</span>
<a href="#l7.639"></a><span id="l7.639"> NS_IMETHODIMP nsMsgDatabase::ForceClosed()</span>
<a href="#l7.640"></a><span id="l7.640"> {</span>
<a href="#l7.641"></a><span id="l7.641">   nsresult  err = NS_OK;</span>
<a href="#l7.642"></a><span id="l7.642"> </span>
<a href="#l7.643"></a><span id="l7.643" class="difflineat">@@ -4105,19 +4067,18 @@ uint32_t nsMsgDatabase::GetCurVersion()</span>
<a href="#l7.644"></a><span id="l7.644"> }</span>
<a href="#l7.645"></a><span id="l7.645"> </span>
<a href="#l7.646"></a><span id="l7.646"> NS_IMETHODIMP nsMsgDatabase::SetSummaryValid(bool valid /* = true */)</span>
<a href="#l7.647"></a><span id="l7.647"> {</span>
<a href="#l7.648"></a><span id="l7.648">   // If the file was invalid when opened (for example in folder compact), then it may</span>
<a href="#l7.649"></a><span id="l7.649">   //  not have been added to the cache. Add it now if missing.</span>
<a href="#l7.650"></a><span id="l7.650">   if (valid)</span>
<a href="#l7.651"></a><span id="l7.651">   {</span>
<a href="#l7.652"></a><span id="l7.652" class="difflineminus">-    nsTArray&lt;nsMsgDatabase*&gt;* dbCache = GetDBCache();</span>
<a href="#l7.653"></a><span id="l7.653" class="difflineminus">-    if (dbCache &amp;&amp; !dbCache-&gt;Contains(this))</span>
<a href="#l7.654"></a><span id="l7.654" class="difflineminus">-      dbCache-&gt;AppendElement(this);</span>
<a href="#l7.655"></a><span id="l7.655" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; serv(mozilla::services::GetDBService());</span>
<a href="#l7.656"></a><span id="l7.656" class="difflineplus">+    static_cast&lt;nsMsgDBService*&gt;(serv.get())-&gt;EnsureCached(this);</span>
<a href="#l7.657"></a><span id="l7.657">   }</span>
<a href="#l7.658"></a><span id="l7.658">   // setting the version to 0 ought to make it pretty invalid.</span>
<a href="#l7.659"></a><span id="l7.659">   if (m_dbFolderInfo)</span>
<a href="#l7.660"></a><span id="l7.660">     m_dbFolderInfo-&gt;SetVersion(valid ? GetCurVersion() : 0);</span>
<a href="#l7.661"></a><span id="l7.661"> </span>
<a href="#l7.662"></a><span id="l7.662">   // for default db (and news), there's no nothing to set to make it it valid</span>
<a href="#l7.663"></a><span id="l7.663">   return NS_OK;</span>
<a href="#l7.664"></a><span id="l7.664"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/db/msgdb/test/unit/test_enumerator_cleanup.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -7,17 +7,19 @@ Components.utils.import(&quot;resource:///mod</span>
<a href="#l8.4"></a><span id="l8.4"> const anyOldMessage = do_get_file(&quot;../../../../data/bugmail1&quot;);</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> /**</span>
<a href="#l8.7"></a><span id="l8.7">  * Test closing a db with an outstanding enumerator.</span>
<a href="#l8.8"></a><span id="l8.8">  */</span>
<a href="#l8.9"></a><span id="l8.9"> function test_enumerator_cleanup() {</span>
<a href="#l8.10"></a><span id="l8.10">   let db = localAccountUtils.inboxFolder.msgDatabase;</span>
<a href="#l8.11"></a><span id="l8.11">   let enumerator = db.EnumerateMessages();</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  db.forceFolderDBClosed(localAccountUtils.inboxFolder);</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    .getService(Ci.nsIMsgDBService)</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    .forceFolderDBClosed(localAccountUtils.inboxFolder);</span>
<a href="#l8.16"></a><span id="l8.16">   localAccountUtils.inboxFolder.msgDatabase = null;</span>
<a href="#l8.17"></a><span id="l8.17">   db = null;</span>
<a href="#l8.18"></a><span id="l8.18">   gc();</span>
<a href="#l8.19"></a><span id="l8.19">   while (enumerator.hasMoreElements())</span>
<a href="#l8.20"></a><span id="l8.20">     var header = enumerator.getNext();</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   do_test_finished();</span>
<a href="#l8.23"></a><span id="l8.23"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

