<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26680:1ab5b794ee034948b7ff08ac7761c8e44c18039f</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 1ab5b794ee034948b7ff08ac7761c8e44c18039f" />
<meta property="og:url" content="/comm-central/rev/1ab5b794ee034948b7ff08ac7761c8e44c18039f" />
<meta property="og:description" content="Bug 1542991 - Add UI to reuse CloudFile uploads from the current session. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 1ab5b794ee034948b7ff08ac7761c8e44c18039f 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/1ab5b794ee034948b7ff08ac7761c8e44c18039f">shortlog</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/1ab5b794ee034948b7ff08ac7761c8e44c18039f">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f">files</a> |
changeset |
<a href="/comm-central/raw-rev/1ab5b794ee034948b7ff08ac7761c8e44c18039f">raw</a>  | <a href="/comm-central/archive/1ab5b794ee034948b7ff08ac7761c8e44c18039f.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542991">Bug 1542991</a> - Add UI to reuse CloudFile uploads from the current session. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 May 2019 23:31:31 +1200</td></tr>

<tr>
 <td>changeset 26680</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/1ab5b794ee034948b7ff08ac7761c8e44c18039f">1ab5b794ee034948b7ff08ac7761c8e44c18039f</a></td>
</tr>



<tr>
<td>parent 26679</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/369d4b8f0f0b2dfd6c841971f52ab007c066e455">369d4b8f0f0b2dfd6c841971f52ab007c066e455</a>
</td>
</tr>

<tr>
<td>child 26681</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/780e49e2d1a96135b41ea60ec3f6f0ae010262a6">780e49e2d1a96135b41ea60ec3f6f0ae010262a6</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=1ab5b794ee034948b7ff08ac7761c8e44c18039f">15943</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 May 2019 13:40:41 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@1fb0d1a549f3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1fb0d1a549f3dd9562f6404be18ca14573eac527">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=1fb0d1a549f3dd9562f6404be18ca14573eac527&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=1fb0d1a549f3dd9562f6404be18ca14573eac527&newProject=comm-central&newRevision=369d4b8f0f0b2dfd6c841971f52ab007c066e455&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542991">1542991</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1542991">Bug 1542991</a> - Add UI to reuse CloudFile uploads from the current session. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">mail/components/cloudfile/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">mail/components/cloudfile/test/browser/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">mail/components/cloudfile/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">mail/components/cloudfile/test/browser/browser_repeat_upload.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/browser_repeat_upload.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">mail/components/cloudfile/test/browser/files/green_eggs.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/green_eggs.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">mail/components/cloudfile/test/browser/files/icon.svg</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/icon.svg">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">mail/components/cloudfile/test/browser/files/management.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/files/management.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">mail/components/cloudfile/test/browser/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/cloudfile/test/browser/head.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">mail/components/compose/content/messengercompose.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/compose/content/messengercompose.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">mail/components/extensions/parent/ext-cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/parent/ext-cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/1ab5b794ee034948b7ff08ac7761c8e44c18039f/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2227,27 +2227,27 @@ function makePrettyName(aUri) {</span>
<a href="#l1.4"></a><span id="l1.4">  * the passed listItem as things progress.</span>
<a href="#l1.5"></a><span id="l1.5">  *</span>
<a href="#l1.6"></a><span id="l1.6">  * @param attachment        A calIAttachment to upload</span>
<a href="#l1.7"></a><span id="l1.7">  * @param cloudProvider     The clould provider to upload to</span>
<a href="#l1.8"></a><span id="l1.8">  * @param listItem          The listitem in attachment-link listbox to update.</span>
<a href="#l1.9"></a><span id="l1.9">  */</span>
<a href="#l1.10"></a><span id="l1.10"> function uploadCloudAttachment(attachment, cloudFileAccount, listItem) {</span>
<a href="#l1.11"></a><span id="l1.11">     let file = attachment.uri.QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    listItem.attachLocalFile = file;</span>
<a href="#l1.13"></a><span id="l1.13">     listItem.attachCloudFileAccount = cloudFileAccount;</span>
<a href="#l1.14"></a><span id="l1.14">     listItem.setAttribute(&quot;image&quot;, &quot;chrome://global/skin/icons/loading.png&quot;);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-    cloudFileAccount.uploadFile(file).then(() =&gt; {</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+    cloudFileAccount.uploadFile(file).then((upload) =&gt; {</span>
<a href="#l1.17"></a><span id="l1.17">         delete gAttachMap[attachment.hashId];</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-        attachment.uri = Services.io.newURI(cloudFileAccount.urlForFile(file));</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+        attachment.uri = Services.io.newURI(upload.url);</span>
<a href="#l1.20"></a><span id="l1.20">         attachment.setParameter(&quot;FILENAME&quot;, file.leafName);</span>
<a href="#l1.21"></a><span id="l1.21">         attachment.setParameter(&quot;PROVIDER&quot;, cloudFileAccount.type);</span>
<a href="#l1.22"></a><span id="l1.22">         listItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l1.23"></a><span id="l1.23">         gAttachMap[attachment.hashId] = attachment;</span>
<a href="#l1.24"></a><span id="l1.24">         listItem.setAttribute(&quot;image&quot;, cloudFileAccount.iconURL);</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+        listItem.attachCloudFileUpload = upload;</span>
<a href="#l1.26"></a><span id="l1.26">         updateAttachment();</span>
<a href="#l1.27"></a><span id="l1.27">     }, (statusCode) =&gt; {</span>
<a href="#l1.28"></a><span id="l1.28">         cal.ERROR(&quot;[calendar-event-dialog] Uploading cloud attachment &quot; +</span>
<a href="#l1.29"></a><span id="l1.29">                   &quot;failed. Status code: &quot; + statusCode);</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">         // Uploading failed. First of all, show an error icon. Also,</span>
<a href="#l1.32"></a><span id="l1.32">         // delete it from the attach map now, this will make sure it is</span>
<a href="#l1.33"></a><span id="l1.33">         // not serialized if the user saves.</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineat">@@ -2348,19 +2348,19 @@ function addAttachment(attachment, cloud</span>
<a href="#l1.35"></a><span id="l1.35">  *</span>
<a href="#l1.36"></a><span id="l1.36">  * XXX This could use a dialog maybe?</span>
<a href="#l1.37"></a><span id="l1.37">  */</span>
<a href="#l1.38"></a><span id="l1.38"> function deleteAttachment() {</span>
<a href="#l1.39"></a><span id="l1.39">     let documentLink = document.getElementById(&quot;attachment-link&quot;);</span>
<a href="#l1.40"></a><span id="l1.40">     let item = documentLink.selectedItem;</span>
<a href="#l1.41"></a><span id="l1.41">     delete gAttachMap[item.attachment.hashId];</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43" class="difflineminus">-    if (item.attachLocalFile &amp;&amp; item.attachCloudFileAccount) {</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    if (item.attachCloudFileAccount &amp;&amp; item.attachCloudFileUpload) {</span>
<a href="#l1.45"></a><span id="l1.45">         try {</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-            item.attachCloudFileAccount.deleteFile(item.attachLocalFile).catch((statusCode) =&gt; {</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+            item.attachCloudFileAccount.deleteFile(item.attachCloudFileUpload.id).catch((statusCode) =&gt; {</span>
<a href="#l1.48"></a><span id="l1.48">                 // TODO With a notification bar, we could actually show this error.</span>
<a href="#l1.49"></a><span id="l1.49">                 cal.ERROR(&quot;[calendar-event-dialog] Deleting cloud attachment &quot; +</span>
<a href="#l1.50"></a><span id="l1.50">                           &quot;failed, file will remain on server. &quot; +</span>
<a href="#l1.51"></a><span id="l1.51">                           &quot; Status code: &quot; + statusCode);</span>
<a href="#l1.52"></a><span id="l1.52">             });</span>
<a href="#l1.53"></a><span id="l1.53">         } catch (e) {</span>
<a href="#l1.54"></a><span id="l1.54">             cal.ERROR(&quot;[calendar-event-dialog] Deleting cloud attachment &quot; +</span>
<a href="#l1.55"></a><span id="l1.55">                       &quot;failed, file will remain on server. &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/components/cloudfile/moz.build</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/components/cloudfile/moz.build</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -7,8 +7,12 @@ EXTRA_JS_MODULES += [</span>
<a href="#l2.4"></a><span id="l2.4">     'cloudFileAccounts.jsm',</span>
<a href="#l2.5"></a><span id="l2.5"> ]</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> DIRS += [</span>
<a href="#l2.10"></a><span id="l2.10">     'wetransfer',</span>
<a href="#l2.11"></a><span id="l2.11"> ]</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    'test/browser/browser.ini',</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/.eslintrc.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+module.exports = {</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/browser-test&quot;,</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  },</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/browser.ini</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+head = head.js</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+prefs =</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+support-files = files/icon.svg files/management.html</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+[browser_repeat_upload.js]</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+support-files = files/green_eggs.txt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/browser_repeat_upload.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,153 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/* import-globals-from ../../../../base/content/mailWindowOverlay.js */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+const {BrowserTestUtils} = ChromeUtils.import(&quot;resource://testing-common/BrowserTestUtils.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+const ICON_URL = getRootDirectory(gTestPath) + &quot;files/icon.svg&quot;;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+const MANAGEMENT_URL = getRootDirectory(gTestPath) + &quot;files/management.html&quot;;</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+function getFileFromChromeURL(leafName) {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  let ChromeRegistry = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;].getService(Ci.nsIChromeRegistry);</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+  let url = Services.io.newURI(getRootDirectory(gTestPath) + &quot;files/&quot; + leafName);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+  let fileURL = ChromeRegistry.convertChromeURL(url).QueryInterface(Ci.nsIFileURL);</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  return fileURL.file;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+}</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  let uploadedFiles = [];</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  let provider = {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+    type: &quot;Mochitest&quot;,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+    displayName: &quot;Mochitest&quot;,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    iconURL: ICON_URL,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    initAccount(accountKey) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+      return {</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+        accountKey,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+        type: &quot;Mochitest&quot;,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+        get displayName() {</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+          return Services.prefs.getCharPref(</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+            `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+            &quot;Mochitest Account&quot;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+          );</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+        },</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+        getPreviousUploads() {</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+          return uploadedFiles;</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+        },</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+        urlForFile(file) {</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+          return &quot;https://mochi.test/&quot; + file.leafName;</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+        },</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+        iconURL: ICON_URL,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+        configured: true,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+        managementURL: MANAGEMENT_URL,</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      };</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+    },</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+  };</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+  cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  let account = cloudFileAccounts.createAccount(provider.type);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  let composeWindow = await new Promise((resolve) =&gt; {</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+    function onWindowOpen(win) {</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+      win.addEventListener(&quot;load&quot;, async () =&gt; {</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+        Services.ww.unregisterNotification(onWindowOpen);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+        await win.setTimeout(resolve, 500, win);</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+      }, { once: true });</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+    }</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+    Services.ww.registerNotification(onWindowOpen);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+    composeMsgByType(Ci.nsIMsgCompType.New);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+  });</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  is(</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineplus">+    composeWindow.location.href,</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+    &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  );</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+  let composeDocument = composeWindow.document;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  // Compose window loaded.</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+  // Check the attach dropdown has our account as a &lt;menuitem&gt;.</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+  let toolbarButton = composeDocument.getElementById(&quot;button-attach&quot;);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+  let rect = toolbarButton.getBoundingClientRect();</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+  EventUtils.synthesizeMouse(toolbarButton, rect.width - 5, 5, { clickCount: 1 }, composeWindow);</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineplus">+</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+  let menu = composeDocument.getElementById(&quot;button-attachPopup_attachCloudMenu&quot;);</span>
<a href="#l5.82"></a><span id="l5.82" class="difflineplus">+  ok(!BrowserTestUtils.is_hidden(menu));</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(menu, { clickCount: 1 }, composeWindow);</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+  let menuitems = menu.menupopup.children;</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+  is(menuitems.length, 1);</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+  is(menuitems[0].getAttribute(&quot;image&quot;), ICON_URL);</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  is(menuitems[0].getAttribute(&quot;label&quot;), &quot;Mochitest Account\u2026&quot;);</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  composeDocument.getElementById(&quot;button-attachPopup&quot;).hidePopup();</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+  // Pretend we uploaded some files before.</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  uploadedFiles = [{</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+    id: 1,</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+    leafName: &quot;green_eggs.txt&quot;,</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    path: getFileFromChromeURL(&quot;green_eggs.txt&quot;).path,</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    size: 30,</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+    url: &quot;https://mochi.test/green_eggs.txt&quot;,</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  }, {</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+    id: 2,</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+    leafName: &quot;ham.zip&quot;,</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+    path: getFileFromChromeURL(&quot;ham.zip&quot;).path,</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+    size: 1234,</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+    url: &quot;https://mochi.test/ham.zip&quot;,</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  }];</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+  is(account.getPreviousUploads().length, 2);</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+  // Check the attach dropdown has our account as a &lt;menu&gt;.</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  await new Promise((resolve) =&gt; {</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+    toolbarButton.addEventListener(&quot;popupshown&quot;, resolve, { once: true });</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+    EventUtils.synthesizeMouse(toolbarButton, rect.width - 5, 5, { clickCount: 1 }, composeWindow);</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+  });</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+  info(&quot;toolbar button menu opened&quot;);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  await new Promise((resolve) =&gt; {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    menu.menupopup.addEventListener(&quot;popupshown&quot;, resolve, { once: true });</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(menu, { clickCount: 1 }, composeWindow);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+  });</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+  info(&quot;file link menu opened&quot;);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  menuitems = menu.menupopup.children;</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  is(menuitems.length, 2);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+  is(menuitems[0].getAttribute(&quot;image&quot;), ICON_URL);</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  is(menuitems[0].getAttribute(&quot;label&quot;), &quot;Mochitest Account\u2026&quot;);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  is(menuitems[1].localName, &quot;menuitem&quot;);</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+  is(menuitems[1].getAttribute(&quot;image&quot;), &quot;moz-icon://green_eggs.txt&quot;);</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  is(menuitems[1].getAttribute(&quot;label&quot;), &quot;green_eggs.txt&quot;);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  // TODO: Enable this when we handle files that no longer exist on the filesystem.</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  // is(menuitems[2].localName, &quot;menuitem&quot;);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  // is(menuitems[2].getAttribute(&quot;image&quot;), &quot;moz-icon://ham.zip&quot;);</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  // is(menuitems[2].getAttribute(&quot;label&quot;), &quot;ham.zip&quot;);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+  // Select one of the previously-uploaded items and check the attachment is added.</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+  let bucket = composeDocument.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+  await new Promise((resolve) =&gt; {</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+    bucket.addEventListener(&quot;attachments-added&quot;, resolve, { once: true });</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    EventUtils.synthesizeMouseAtCenter(menuitems[1], { clickCount: 1 }, composeWindow);</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+  });</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+  info(&quot;attachment added&quot;);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  await promiseAnimationFrame(composeWindow);</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+  ok(toolbarButton.open === false);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+  is(bucket.itemCount, 1);</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+  let attachment = bucket.itemChildren[0];</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+  is(attachment.getAttribute(&quot;name&quot;), &quot;green_eggs.txt&quot;);</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  ok(attachment.attachment.sendViaCloud);</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+  is(attachment.attachment.cloudFileAccountKey, account.accountKey);</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+  is(attachment.attachment.contentLocation, &quot;https://mochi.test/green_eggs.txt&quot;);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+  composeWindow.close();</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">new file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- /dev/null</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/files/green_eggs.txt</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineplus">+I do not like them, Sam I Am!</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">copy from mail/components/preferences/test/browser/files/icon.svg</span>
<a href="#l7.2"></a><span id="l7.2">copy to mail/components/cloudfile/test/browser/files/icon.svg</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">copy from mail/components/preferences/test/browser/files/management.html</span>
<a href="#l8.2"></a><span id="l8.2">copy to mail/components/cloudfile/test/browser/files/management.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">new file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- /dev/null</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/head.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineplus">+</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+add_task(async function setup() {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+  let gAccount = createAccount();</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  addIdentity(gAccount);</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  let rootFolder = gAccount.incomingServer.rootFolder;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+  window.gFolderTreeView.selectFolder(rootFolder);</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineplus">+  await new Promise(resolve =&gt; executeSoon(resolve));</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineplus">+});</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineplus">+function createAccount() {</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+  registerCleanupFunction(() =&gt; {</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    [...MailServices.accounts.accounts.enumerate()].forEach(cleanUpAccount);</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  });</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  MailServices.accounts.createLocalMailAccount();</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  let account = MailServices.accounts.accounts.enumerate().getNext();</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+  info(`Created account ${account.toString()}`);</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineplus">+</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineplus">+  return account;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineplus">+}</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineplus">+</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineplus">+function cleanUpAccount(account) {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+  info(`Cleaning up account ${account.toString()}`);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+  MailServices.accounts.removeAccount(account, true);</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+}</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+function addIdentity(account) {</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+  let identity = MailServices.accounts.createIdentity();</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+  identity.email = &quot;mochitest@localhost&quot;;</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+  account.addIdentity(identity);</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+  account.defaultIdentity = identity;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+  info(`Created identity ${identity.toString()}`);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+}</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+async function promiseAnimationFrame(win = window) {</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+  await new Promise(win.requestAnimationFrame);</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+  // dispatchToMainThread throws if used as the first argument of Promise.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+  return new Promise(resolve =&gt; Services.tm.dispatchToMainThread(resolve));</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1104,16 +1104,18 @@ var attachmentBucketController = {</span>
<a href="#l10.4"></a><span id="l10.4">                       Services.io.offline;</span>
<a href="#l10.5"></a><span id="l10.5">         if (cmd.hidden)</span>
<a href="#l10.6"></a><span id="l10.6">           return false;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l10.9"></a><span id="l10.9">         for (let item of bucket.selectedItems) {</span>
<a href="#l10.10"></a><span id="l10.10">           if (item.uploading)</span>
<a href="#l10.11"></a><span id="l10.11">             return false;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+          if (item.cloudFileUpload &amp;&amp; item.cloudFileUpload.repeat)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+            return false;</span>
<a href="#l10.14"></a><span id="l10.14">         }</span>
<a href="#l10.15"></a><span id="l10.15">         return true;</span>
<a href="#l10.16"></a><span id="l10.16">       },</span>
<a href="#l10.17"></a><span id="l10.17">       doCommand() {</span>
<a href="#l10.18"></a><span id="l10.18">         // We should never actually call this, since the &lt;command&gt; node calls</span>
<a href="#l10.19"></a><span id="l10.19">         // a different function.</span>
<a href="#l10.20"></a><span id="l10.20">       },</span>
<a href="#l10.21"></a><span id="l10.21">     },</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineat">@@ -1122,16 +1124,18 @@ var attachmentBucketController = {</span>
<a href="#l10.23"></a><span id="l10.23">       isEnabled() {</span>
<a href="#l10.24"></a><span id="l10.24">         if (!Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;))</span>
<a href="#l10.25"></a><span id="l10.25">           return false;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l10.28"></a><span id="l10.28">         for (let item of bucket.selectedItems) {</span>
<a href="#l10.29"></a><span id="l10.29">           if (item.uploading)</span>
<a href="#l10.30"></a><span id="l10.30">             return false;</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+          if (item.cloudFileUpload &amp;&amp; item.cloudFileUpload.repeat)</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+            return false;</span>
<a href="#l10.33"></a><span id="l10.33">         }</span>
<a href="#l10.34"></a><span id="l10.34">         return true;</span>
<a href="#l10.35"></a><span id="l10.35">       },</span>
<a href="#l10.36"></a><span id="l10.36">       doCommand() {</span>
<a href="#l10.37"></a><span id="l10.37">         convertSelectedToRegularAttachment();</span>
<a href="#l10.38"></a><span id="l10.38">       },</span>
<a href="#l10.39"></a><span id="l10.39">     },</span>
<a href="#l10.40"></a><span id="l10.40"> </span>
<a href="#l10.41"></a><span id="l10.41" class="difflineat">@@ -1444,26 +1448,48 @@ function updateSendCommands(aHaveControl</span>
<a href="#l10.42"></a><span id="l10.42">   }</span>
<a href="#l10.43"></a><span id="l10.43"> }</span>
<a href="#l10.44"></a><span id="l10.44"> </span>
<a href="#l10.45"></a><span id="l10.45"> function addAttachCloudMenuItems(aParentMenu) {</span>
<a href="#l10.46"></a><span id="l10.46">   while (aParentMenu.hasChildNodes())</span>
<a href="#l10.47"></a><span id="l10.47">     aParentMenu.lastChild.remove();</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">   for (let account of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+    if (aParentMenu.lastChild &amp;&amp; aParentMenu.lastChild.cloudFileUpload) {</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+      aParentMenu.appendChild(document.createXULElement(&quot;menuseparator&quot;));</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+    }</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+</span>
<a href="#l10.54"></a><span id="l10.54">     let item = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l10.55"></a><span id="l10.55">     let iconURL = account.iconURL;</span>
<a href="#l10.56"></a><span id="l10.56">     item.cloudFileAccount = account;</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(account));</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+    item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(account) + &quot;\u2026&quot;);</span>
<a href="#l10.60"></a><span id="l10.60">     if (iconURL) {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-      item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+      item.setAttribute(&quot;class&quot;, `${item.localName}-iconic`);</span>
<a href="#l10.63"></a><span id="l10.63">       item.setAttribute(&quot;image&quot;, iconURL);</span>
<a href="#l10.64"></a><span id="l10.64">     }</span>
<a href="#l10.65"></a><span id="l10.65">     aParentMenu.appendChild(item);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+    let previousUploads = account.getPreviousUploads();</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+    for (let upload of previousUploads) {</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineplus">+      let file = Cc[&quot;@mozilla.org/file/local;1&quot;].createInstance(Ci.nsIFile);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineplus">+      file.initWithPath(upload.path);</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineplus">+</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineplus">+      // TODO: Figure out how to handle files that no longer exist on the filesystem.</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineplus">+      if (!file.exists()) {</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+        continue;</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+      }</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineplus">+</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+      let fileItem = document.createXULElement(&quot;menuitem&quot;);</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineplus">+      fileItem.cloudFileUpload = upload;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineplus">+      fileItem.cloudFileAccount = account;</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineplus">+      fileItem.setAttribute(&quot;label&quot;, file.leafName);</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+      fileItem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic&quot;);</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+      fileItem.setAttribute(&quot;image&quot;, &quot;moz-icon://&quot; + file.leafName);</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+      aParentMenu.appendChild(fileItem);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineplus">+    }</span>
<a href="#l10.85"></a><span id="l10.85">   }</span>
<a href="#l10.86"></a><span id="l10.86"> }</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88"> function addConvertCloudMenuItems(aParentMenu, aAfterNodeId, aRadioGroup) {</span>
<a href="#l10.89"></a><span id="l10.89">   let attachment = document.getElementById(&quot;attachmentBucket&quot;).selectedItem;</span>
<a href="#l10.90"></a><span id="l10.90">   let afterNode = document.getElementById(aAfterNodeId);</span>
<a href="#l10.91"></a><span id="l10.91">   while (afterNode.nextSibling)</span>
<a href="#l10.92"></a><span id="l10.92">     afterNode.nextSibling.remove();</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineat">@@ -1507,32 +1533,34 @@ async function uploadCloudAttachment(att</span>
<a href="#l10.94"></a><span id="l10.94">     attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l10.95"></a><span id="l10.95">       getComposeBundle().getFormattedString(&quot;cloudFileUploadingTooltip&quot;, [</span>
<a href="#l10.96"></a><span id="l10.96">         cloudFileAccounts.getDisplayName(cloudFileAccount),</span>
<a href="#l10.97"></a><span id="l10.97">       ]));</span>
<a href="#l10.98"></a><span id="l10.98">     attachmentItem.uploading = true;</span>
<a href="#l10.99"></a><span id="l10.99">     attachmentItem.cloudFileAccount = cloudFileAccount;</span>
<a href="#l10.100"></a><span id="l10.100">   }</span>
<a href="#l10.101"></a><span id="l10.101"> </span>
<a href="#l10.102"></a><span id="l10.102" class="difflineplus">+  let upload;</span>
<a href="#l10.103"></a><span id="l10.103">   let statusCode = Cr.NS_OK;</span>
<a href="#l10.104"></a><span id="l10.104">   try {</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    await cloudFileAccount.uploadFile(file);</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+    upload = await cloudFileAccount.uploadFile(file);</span>
<a href="#l10.107"></a><span id="l10.107">   } catch (ex) {</span>
<a href="#l10.108"></a><span id="l10.108">     statusCode = ex;</span>
<a href="#l10.109"></a><span id="l10.109">   }</span>
<a href="#l10.110"></a><span id="l10.110"> </span>
<a href="#l10.111"></a><span id="l10.111">   if (Components.isSuccessCode(statusCode)) {</span>
<a href="#l10.112"></a><span id="l10.112">     let originalUrl = attachment.url;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-    attachment.contentLocation = cloudFileAccount.urlForFile(file);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+    attachment.contentLocation = upload.url;</span>
<a href="#l10.115"></a><span id="l10.115">     attachment.cloudFileAccountKey = cloudFileAccount.accountKey;</span>
<a href="#l10.116"></a><span id="l10.116">     if (attachmentItem) {</span>
<a href="#l10.117"></a><span id="l10.117">       // Update relevant bits on the attachment list item.</span>
<a href="#l10.118"></a><span id="l10.118">       if (!attachmentItem.originalUrl) {</span>
<a href="#l10.119"></a><span id="l10.119">         attachmentItem.originalUrl = originalUrl;</span>
<a href="#l10.120"></a><span id="l10.120">       }</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+      attachmentItem.cloudFileUpload = upload;</span>
<a href="#l10.122"></a><span id="l10.122">       attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l10.123"></a><span id="l10.123">         getComposeBundle().getFormattedString(&quot;cloudFileUploadedTooltip&quot;, [</span>
<a href="#l10.124"></a><span id="l10.124">           cloudFileAccounts.getDisplayName(cloudFileAccount),</span>
<a href="#l10.125"></a><span id="l10.125">         ]));</span>
<a href="#l10.126"></a><span id="l10.126">       attachmentItem.uploading = false;</span>
<a href="#l10.127"></a><span id="l10.127"> </span>
<a href="#l10.128"></a><span id="l10.128">       // Set the icon for the attachment.</span>
<a href="#l10.129"></a><span id="l10.129">       let iconURL = cloudFileAccount.iconURL;</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineat">@@ -1622,36 +1650,79 @@ async function uploadCloudAttachment(att</span>
<a href="#l10.131"></a><span id="l10.131">       attachmentItem.dispatchEvent(event);</span>
<a href="#l10.132"></a><span id="l10.132">     }</span>
<a href="#l10.133"></a><span id="l10.133">   }</span>
<a href="#l10.134"></a><span id="l10.134"> </span>
<a href="#l10.135"></a><span id="l10.135">   gNumUploadingAttachments--;</span>
<a href="#l10.136"></a><span id="l10.136">   updateSendCommands(true);</span>
<a href="#l10.137"></a><span id="l10.137"> }</span>
<a href="#l10.138"></a><span id="l10.138"> </span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-async function deleteCloudAttachment(attachment, file, cloudFileAccount) {</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineplus">+async function deleteCloudAttachment(attachment, id, cloudFileAccount) {</span>
<a href="#l10.141"></a><span id="l10.141">   try {</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-    await cloudFileAccount.deleteFile(file);</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineplus">+    await cloudFileAccount.deleteFile(id);</span>
<a href="#l10.144"></a><span id="l10.144">   } catch (ex) {</span>
<a href="#l10.145"></a><span id="l10.145">     let bundle = getComposeBundle();</span>
<a href="#l10.146"></a><span id="l10.146">     let displayName = cloudFileAccounts.getDisplayName(cloudFileAccount);</span>
<a href="#l10.147"></a><span id="l10.147">     Services.prompt.alert(</span>
<a href="#l10.148"></a><span id="l10.148">       window,</span>
<a href="#l10.149"></a><span id="l10.149">       bundle.getString(&quot;errorCloudFileDeletion.title&quot;),</span>
<a href="#l10.150"></a><span id="l10.150">       bundle.getFormattedString(&quot;errorCloudFileDeletion.message&quot;, [displayName, attachment.name])</span>
<a href="#l10.151"></a><span id="l10.151">     );</span>
<a href="#l10.152"></a><span id="l10.152">   }</span>
<a href="#l10.153"></a><span id="l10.153"> }</span>
<a href="#l10.154"></a><span id="l10.154"> </span>
<a href="#l10.155"></a><span id="l10.155" class="difflineplus">+function attachToCloud(event) {</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineplus">+  if (event.target.cloudFileUpload) {</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineplus">+    attachToCloudRepeat(event.target.cloudFileUpload, event.target.cloudFileAccount);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+  } else {</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineplus">+    attachToCloudNew(event.target.cloudFileAccount);</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineplus">+  }</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineplus">+  event.stopPropagation();</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineplus">+}</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineplus">+</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineplus">+/**</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineplus">+ * Attach a file that has already been uploaded to a cloud provider.</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineplus">+ *</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineplus">+ * @param {string} filePath the original file path</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineplus">+ * @param {Object} account  the cloud provider to upload the files to</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineplus">+ */</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineplus">+function attachToCloudRepeat(upload, account) {</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineplus">+  let file = FileUtils.File(upload.path);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineplus">+  let attachment = FileToAttachment(file);</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineplus">+  attachment.contentLocation = upload.url;</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineplus">+  attachment.sendViaCloud = true;</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineplus">+  attachment.cloudFileAccountKey = account.accountKey;</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineplus">+</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineplus">+  AddAttachments([attachment], function(item) {</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineplus">+    item.account = account;</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineplus">+    item.setAttribute(&quot;name&quot;, upload.leafName);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineplus">+    item.cloudFileUpload = {</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineplus">+      ...upload,</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineplus">+      repeat: true,</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+    };</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineplus">+    let iconURL = account.iconURL;</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineplus">+    if (iconURL) {</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineplus">+      item.image = iconURL;</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineplus">+    } else {</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineplus">+      // Should we use a generic &quot;cloud&quot; icon here? Or an overlay icon?</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineplus">+      // I think the provider should provide an icon, end of story.</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineplus">+      item.image = null;</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineplus">+    }</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineplus">+    item.dispatchEvent(</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineplus">+      new CustomEvent(&quot;attachment-uploaded&quot;, { bubbles: true, cancelable: true })</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineplus">+    );</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineplus">+  });</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineplus">+}</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineplus">+</span>
<a href="#l10.198"></a><span id="l10.198"> /**</span>
<a href="#l10.199"></a><span id="l10.199">  * Prompt the user for a list of files to attach via a cloud provider.</span>
<a href="#l10.200"></a><span id="l10.200">  *</span>
<a href="#l10.201"></a><span id="l10.201">  * @param aAccount the cloud provider to upload the files to</span>
<a href="#l10.202"></a><span id="l10.202">  */</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-function attachToCloud(aAccount) {</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineplus">+function attachToCloudNew(aAccount) {</span>
<a href="#l10.205"></a><span id="l10.205">   // We need to let the user pick local file(s) to upload to the cloud and</span>
<a href="#l10.206"></a><span id="l10.206">   // gather url(s) to those files.</span>
<a href="#l10.207"></a><span id="l10.207">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l10.208"></a><span id="l10.208">              .createInstance(Ci.nsIFilePicker);</span>
<a href="#l10.209"></a><span id="l10.209">   fp.init(window, getComposeBundle().getFormattedString(</span>
<a href="#l10.210"></a><span id="l10.210">             &quot;chooseFileToAttachViaCloud&quot;,</span>
<a href="#l10.211"></a><span id="l10.211">             [cloudFileAccounts.getDisplayName(aAccount)]),</span>
<a href="#l10.212"></a><span id="l10.212">           Ci.nsIFilePicker.modeOpenMultiple);</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineat">@@ -1704,17 +1775,17 @@ function convertListItemsToCloudAttachme</span>
<a href="#l10.214"></a><span id="l10.214">       if (item.cloudFileAccount &amp;&amp; item.cloudFileAccount == aAccount) {</span>
<a href="#l10.215"></a><span id="l10.215">         continue;</span>
<a href="#l10.216"></a><span id="l10.216">       }</span>
<a href="#l10.217"></a><span id="l10.217">       url = item.originalUrl;</span>
<a href="#l10.218"></a><span id="l10.218">     }</span>
<a href="#l10.219"></a><span id="l10.219"> </span>
<a href="#l10.220"></a><span id="l10.220">     let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l10.221"></a><span id="l10.221">     if (item.cloudFileAccount) {</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-      deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+      deleteCloudAttachment(item.attachment, item.cloudFileUpload.id, item.cloudFileAccount);</span>
<a href="#l10.224"></a><span id="l10.224">     }</span>
<a href="#l10.225"></a><span id="l10.225"> </span>
<a href="#l10.226"></a><span id="l10.226">     uploadCloudAttachment(item.attachment, file, aAccount);</span>
<a href="#l10.227"></a><span id="l10.227">     convertedAttachments.push(item.attachment);</span>
<a href="#l10.228"></a><span id="l10.228">   }</span>
<a href="#l10.229"></a><span id="l10.229"> </span>
<a href="#l10.230"></a><span id="l10.230">   if (convertedAttachments.length &gt; 0) {</span>
<a href="#l10.231"></a><span id="l10.231">     dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineat">@@ -1751,31 +1822,28 @@ function convertToCloudAttachment(aAttac</span>
<a href="#l10.233"></a><span id="l10.233"> </span>
<a href="#l10.234"></a><span id="l10.234"> /**</span>
<a href="#l10.235"></a><span id="l10.235">  * Convert an array of attachments to regular (non-cloud) attachments.</span>
<a href="#l10.236"></a><span id="l10.236">  *</span>
<a href="#l10.237"></a><span id="l10.237">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l10.238"></a><span id="l10.238">  *        question</span>
<a href="#l10.239"></a><span id="l10.239">  */</span>
<a href="#l10.240"></a><span id="l10.240"> function convertListItemsToRegularAttachment(aItems) {</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-  let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-                            .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l10.243"></a><span id="l10.243">   let convertedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l10.244"></a><span id="l10.244">                                .createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.245"></a><span id="l10.245"> </span>
<a href="#l10.246"></a><span id="l10.246">   for (let item of aItems) {</span>
<a href="#l10.247"></a><span id="l10.247">     if (!item.attachment.sendViaCloud || !item.cloudFileAccount) {</span>
<a href="#l10.248"></a><span id="l10.248">       continue;</span>
<a href="#l10.249"></a><span id="l10.249">     }</span>
<a href="#l10.250"></a><span id="l10.250"> </span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-    let file = fileHandler.getFileFromURLSpec(item.originalUrl);</span>
<a href="#l10.252"></a><span id="l10.252">     try {</span>
<a href="#l10.253"></a><span id="l10.253">       // This will fail for drafts, but we can still send the message</span>
<a href="#l10.254"></a><span id="l10.254">       // with a normal attachment.</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-      deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineplus">+      deleteCloudAttachment(item.attachment, item.cloudFileUpload.id, item.cloudFileAccount);</span>
<a href="#l10.257"></a><span id="l10.257">     } catch (ex) {</span>
<a href="#l10.258"></a><span id="l10.258">        Cu.reportError(ex);</span>
<a href="#l10.259"></a><span id="l10.259">     }</span>
<a href="#l10.260"></a><span id="l10.260"> </span>
<a href="#l10.261"></a><span id="l10.261">     item.attachment.url = item.originalUrl;</span>
<a href="#l10.262"></a><span id="l10.262">     item.setAttribute(&quot;tooltiptext&quot;, item.attachment.url);</span>
<a href="#l10.263"></a><span id="l10.263">     item.attachment.sendViaCloud = false;</span>
<a href="#l10.264"></a><span id="l10.264"> </span>
<a href="#l10.265"></a><span id="l10.265" class="difflineat">@@ -4558,21 +4626,21 @@ function RemoveAllAttachments() {</span>
<a href="#l10.266"></a><span id="l10.266">     if (item.attachment.size != -1) {</span>
<a href="#l10.267"></a><span id="l10.267">       gAttachmentsSize -= item.attachment.size;</span>
<a href="#l10.268"></a><span id="l10.268">     }</span>
<a href="#l10.269"></a><span id="l10.269"> </span>
<a href="#l10.270"></a><span id="l10.270">     if (item.attachment.sendViaCloud &amp;&amp; item.cloudFileAccount) {</span>
<a href="#l10.271"></a><span id="l10.271">       let originalUrl = item.originalUrl;</span>
<a href="#l10.272"></a><span id="l10.272">       if (!originalUrl)</span>
<a href="#l10.273"></a><span id="l10.273">         originalUrl = item.attachment.url;</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-      let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l10.275"></a><span id="l10.275">       if (item.uploading) {</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineplus">+        let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l10.277"></a><span id="l10.277">         item.cloudFileAccount.cancelFileUpload(file);</span>
<a href="#l10.278"></a><span id="l10.278">       } else {</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-        deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineplus">+        deleteCloudAttachment(item.attachment, item.cloudFileUpload.id, item.cloudFileAccount);</span>
<a href="#l10.281"></a><span id="l10.281">       }</span>
<a href="#l10.282"></a><span id="l10.282">     }</span>
<a href="#l10.283"></a><span id="l10.283"> </span>
<a href="#l10.284"></a><span id="l10.284">     removedAttachments.appendElement(item.attachment);</span>
<a href="#l10.285"></a><span id="l10.285">     // Let's release the attachment object hold by the node else it won't go</span>
<a href="#l10.286"></a><span id="l10.286">     // away until the window is destroyed.</span>
<a href="#l10.287"></a><span id="l10.287">     item.attachment = null;</span>
<a href="#l10.288"></a><span id="l10.288">     item.remove();</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineat">@@ -4647,25 +4715,27 @@ function RemoveSelectedAttachment() {</span>
<a href="#l10.290"></a><span id="l10.290">                              .createInstance(Ci.nsIMutableArray);</span>
<a href="#l10.291"></a><span id="l10.291"> </span>
<a href="#l10.292"></a><span id="l10.292">   for (let i = bucket.selectedCount - 1; i &gt;= 0; i--) {</span>
<a href="#l10.293"></a><span id="l10.293">     let item = bucket.getSelectedItem(i);</span>
<a href="#l10.294"></a><span id="l10.294">     if (item.attachment.size != -1) {</span>
<a href="#l10.295"></a><span id="l10.295">       gAttachmentsSize -= item.attachment.size;</span>
<a href="#l10.296"></a><span id="l10.296">     }</span>
<a href="#l10.297"></a><span id="l10.297"> </span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-    if (item.attachment.sendViaCloud &amp;&amp; item.cloudFileAccount) {</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineplus">+    if (item.attachment.sendViaCloud &amp;&amp; item.cloudFileAccount &amp;&amp;</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineplus">+        (!item.cloudFileUpload || !item.cloudFileUpload.repeat)) {</span>
<a href="#l10.301"></a><span id="l10.301">       let originalUrl = item.originalUrl;</span>
<a href="#l10.302"></a><span id="l10.302">       if (!originalUrl)</span>
<a href="#l10.303"></a><span id="l10.303">         originalUrl = item.attachment.url;</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-      let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-      if (item.uploading)</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+      if (item.uploading) {</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+        let file = fileHandler.getFileFromURLSpec(originalUrl);</span>
<a href="#l10.308"></a><span id="l10.308">         item.cloudFileAccount.cancelFileUpload(file);</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-      else</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-        deleteCloudAttachment(item.attachment, file, item.cloudFileAccount);</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineplus">+      } else {</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineplus">+        deleteCloudAttachment(item.attachment, item.cloudFileUpload.id, item.cloudFileAccount);</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineplus">+      }</span>
<a href="#l10.314"></a><span id="l10.314">     }</span>
<a href="#l10.315"></a><span id="l10.315"> </span>
<a href="#l10.316"></a><span id="l10.316">     removedAttachments.appendElement(item.attachment);</span>
<a href="#l10.317"></a><span id="l10.317">     // Let's release the attachment object held by the node else it won't go</span>
<a href="#l10.318"></a><span id="l10.318">     // away until the window is destroyed</span>
<a href="#l10.319"></a><span id="l10.319">     item.attachment = null;</span>
<a href="#l10.320"></a><span id="l10.320">     item.remove();</span>
<a href="#l10.321"></a><span id="l10.321">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/components/compose/content/messengercompose.xul</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/components/compose/content/messengercompose.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -272,19 +272,17 @@</span>
<a href="#l11.4"></a><span id="l11.4">     &lt;command id=&quot;cmd_dd&quot; oncommand=&quot;doStyleUICommand('cmd_dd')&quot;/&gt;</span>
<a href="#l11.5"></a><span id="l11.5">     &lt;command id=&quot;cmd_removeList&quot; oncommand=&quot;goDoCommand('cmd_removeList')&quot;/&gt;</span>
<a href="#l11.6"></a><span id="l11.6">     &lt;!-- cmd_ul and cmd_ol are shared with toolbar and are in composerStyleMenuItems commandset --&gt;</span>
<a href="#l11.7"></a><span id="l11.7">   &lt;/commandset&gt;</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">   &lt;!-- File Menu --&gt;</span>
<a href="#l11.10"></a><span id="l11.10">   &lt;command id=&quot;cmd_new&quot; oncommand=&quot;goDoCommand('cmd_newMessage')&quot;/&gt;</span>
<a href="#l11.11"></a><span id="l11.11">   &lt;command id=&quot;cmd_attachFile&quot; oncommand=&quot;goDoCommand('cmd_attachFile')&quot;/&gt;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  &lt;command id=&quot;cmd_attachCloud&quot;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-           oncommand=&quot;attachToCloud(event.target.cloudFileAccount);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-                      event.stopPropagation();&quot;/&gt;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  &lt;command id=&quot;cmd_attachCloud&quot; oncommand=&quot;attachToCloud(event)&quot;/&gt;</span>
<a href="#l11.16"></a><span id="l11.16">   &lt;command id=&quot;cmd_attachPage&quot; oncommand=&quot;goDoCommand('cmd_attachPage')&quot;/&gt;</span>
<a href="#l11.17"></a><span id="l11.17">   &lt;command id=&quot;cmd_attachVCard&quot; checked=&quot;false&quot;</span>
<a href="#l11.18"></a><span id="l11.18">            oncommand=&quot;ToggleAttachVCard(event.target)&quot;/&gt;</span>
<a href="#l11.19"></a><span id="l11.19">   &lt;command id=&quot;cmd_remindLater&quot; checked=&quot;false&quot;</span>
<a href="#l11.20"></a><span id="l11.20">            oncommand=&quot;toggleAttachmentReminder()&quot;/&gt;</span>
<a href="#l11.21"></a><span id="l11.21">   &lt;command id=&quot;cmd_close&quot; oncommand=&quot;goDoCommand('cmd_close')&quot;/&gt;</span>
<a href="#l11.22"></a><span id="l11.22">   &lt;command id=&quot;cmd_saveDefault&quot; oncommand=&quot;goDoCommand('cmd_saveDefault')&quot;/&gt;</span>
<a href="#l11.23"></a><span id="l11.23">   &lt;command id=&quot;cmd_saveAsFile&quot; oncommand=&quot;goDoCommand('cmd_saveAsFile')&quot;/&gt;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineat">@@ -709,17 +707,17 @@</span>
<a href="#l11.25"></a><span id="l11.25">   &lt;menuitem id=&quot;attachmentListContext_attachFileItem&quot;</span>
<a href="#l11.26"></a><span id="l11.26">             label=&quot;&amp;attachFile.label;&quot;</span>
<a href="#l11.27"></a><span id="l11.27">             accesskey=&quot;&amp;attachFile.accesskey;&quot;</span>
<a href="#l11.28"></a><span id="l11.28">             command=&quot;cmd_attachFile&quot;/&gt;</span>
<a href="#l11.29"></a><span id="l11.29">   &lt;menu id=&quot;attachmentListContext_attachCloudMenu&quot;</span>
<a href="#l11.30"></a><span id="l11.30">         label=&quot;&amp;attachCloud.label;&quot;</span>
<a href="#l11.31"></a><span id="l11.31">         accesskey=&quot;&amp;attachCloud.accesskey;&quot;</span>
<a href="#l11.32"></a><span id="l11.32">         command=&quot;cmd_attachCloud&quot;&gt;</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    &lt;menupopup id=&quot;attachCloudMenu_attachCloudPopup&quot; onpopupshowing=&quot;addAttachCloudMenuItems(this);&quot;/&gt;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+    &lt;menupopup id=&quot;attachCloudMenu_attachCloudPopup&quot; onpopupshowing=&quot;if (event.target == this) { addAttachCloudMenuItems(this); }&quot;/&gt;</span>
<a href="#l11.35"></a><span id="l11.35">   &lt;/menu&gt;</span>
<a href="#l11.36"></a><span id="l11.36">   &lt;menuitem id=&quot;attachmentListContext_attachPageItem&quot;</span>
<a href="#l11.37"></a><span id="l11.37">             label=&quot;&amp;attachPage.label;&quot;</span>
<a href="#l11.38"></a><span id="l11.38">             accesskey=&quot;&amp;attachPage.accesskey;&quot;</span>
<a href="#l11.39"></a><span id="l11.39">             command=&quot;cmd_attachPage&quot;/&gt;</span>
<a href="#l11.40"></a><span id="l11.40">   &lt;menuseparator id=&quot;attachmentListContext_remindLaterSeparator&quot;/&gt;</span>
<a href="#l11.41"></a><span id="l11.41">   &lt;menuitem id=&quot;attachmentListContext_remindLaterItem&quot;</span>
<a href="#l11.42"></a><span id="l11.42">             type=&quot;checkbox&quot;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineat">@@ -822,17 +820,17 @@</span>
<a href="#l11.44"></a><span id="l11.44">             &lt;/menupopup&gt;</span>
<a href="#l11.45"></a><span id="l11.45">           &lt;/menu&gt;</span>
<a href="#l11.46"></a><span id="l11.46">           &lt;menu id=&quot;menu_Attach&quot; label=&quot;&amp;attachMenu.label;&quot; accesskey=&quot;&amp;attachMenu.accesskey;&quot;&gt;</span>
<a href="#l11.47"></a><span id="l11.47">             &lt;menupopup id=&quot;menu_AttachPopup&quot; onpopupshowing=&quot;updateAttachmentItems();&quot;&gt;</span>
<a href="#l11.48"></a><span id="l11.48">               &lt;menuitem label=&quot;&amp;attachFileCmd.label;&quot; accesskey=&quot;&amp;attachFileCmd.accesskey;&quot;</span>
<a href="#l11.49"></a><span id="l11.49">                         key=&quot;key_attachFile&quot; command=&quot;cmd_attachFile&quot;/&gt;</span>
<a href="#l11.50"></a><span id="l11.50">               &lt;menu label=&quot;&amp;attachCloudCmd.label;&quot; accesskey=&quot;&amp;attachCloudCmd.accesskey;&quot;</span>
<a href="#l11.51"></a><span id="l11.51">                     command=&quot;cmd_attachCloud&quot;&gt;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-                &lt;menupopup onpopupshowing=&quot;addAttachCloudMenuItems(this);&quot;/&gt;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+                &lt;menupopup onpopupshowing=&quot;if (event.target == this) { addAttachCloudMenuItems(this); }&quot;/&gt;</span>
<a href="#l11.54"></a><span id="l11.54">               &lt;/menu&gt;</span>
<a href="#l11.55"></a><span id="l11.55">               &lt;menuitem label=&quot;&amp;attachPageCmd.label;&quot;</span>
<a href="#l11.56"></a><span id="l11.56">                         accesskey=&quot;&amp;attachPageCmd.accesskey;&quot; command=&quot;cmd_attachPage&quot;/&gt;</span>
<a href="#l11.57"></a><span id="l11.57">               &lt;menuseparator/&gt;</span>
<a href="#l11.58"></a><span id="l11.58">               &lt;menuitem type=&quot;checkbox&quot;</span>
<a href="#l11.59"></a><span id="l11.59">                         label=&quot;&amp;attachVCardCmd.label;&quot; accesskey=&quot;&amp;attachVCardCmd.accesskey;&quot;</span>
<a href="#l11.60"></a><span id="l11.60">                         command=&quot;cmd_attachVCard&quot;/&gt;</span>
<a href="#l11.61"></a><span id="l11.61">               &lt;menuseparator id=&quot;menu_Attach_RemindLaterSeparator&quot;/&gt;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineat">@@ -1793,17 +1791,17 @@</span>
<a href="#l11.63"></a><span id="l11.63">         &lt;menuitem id=&quot;button-attachPopup_attachFileItem&quot;</span>
<a href="#l11.64"></a><span id="l11.64">                   label=&quot;&amp;attachFileCmd.label;&quot;</span>
<a href="#l11.65"></a><span id="l11.65">                   accesskey=&quot;&amp;attachFileCmd.accesskey;&quot;</span>
<a href="#l11.66"></a><span id="l11.66">                   command=&quot;cmd_attachFile&quot;/&gt;</span>
<a href="#l11.67"></a><span id="l11.67">         &lt;menu id=&quot;button-attachPopup_attachCloudMenu&quot;</span>
<a href="#l11.68"></a><span id="l11.68">               label=&quot;&amp;attachCloudCmd.label;&quot;</span>
<a href="#l11.69"></a><span id="l11.69">               accesskey=&quot;&amp;attachCloudCmd.accesskey;&quot;</span>
<a href="#l11.70"></a><span id="l11.70">               command=&quot;cmd_attachCloud&quot;&gt;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-          &lt;menupopup id=&quot;attachCloudMenu_popup&quot; onpopupshowing=&quot;addAttachCloudMenuItems(this);&quot;/&gt;</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+          &lt;menupopup id=&quot;attachCloudMenu_popup&quot; onpopupshowing=&quot;if (event.target == this) { addAttachCloudMenuItems(this); }&quot;/&gt;</span>
<a href="#l11.73"></a><span id="l11.73">         &lt;/menu&gt;</span>
<a href="#l11.74"></a><span id="l11.74">         &lt;menuitem id=&quot;button-attachPopup_attachPageItem&quot;</span>
<a href="#l11.75"></a><span id="l11.75">                   label=&quot;&amp;attachPageCmd.label;&quot;</span>
<a href="#l11.76"></a><span id="l11.76">                   accesskey=&quot;&amp;attachPageCmd.accesskey;&quot;</span>
<a href="#l11.77"></a><span id="l11.77">                   command=&quot;cmd_attachPage&quot;/&gt;</span>
<a href="#l11.78"></a><span id="l11.78">         &lt;menuseparator/&gt;</span>
<a href="#l11.79"></a><span id="l11.79">         &lt;menuitem id=&quot;button-attachPopup_attachVCardItem&quot;</span>
<a href="#l11.80"></a><span id="l11.80">                   type=&quot;checkbox&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -34,18 +34,17 @@ class CloudFileAccount {</span>
<a href="#l12.4"></a><span id="l12.4">     this.managementURL = this.extension.manifest.cloud_file.management_url;</span>
<a href="#l12.5"></a><span id="l12.5">     this.quota = {</span>
<a href="#l12.6"></a><span id="l12.6">       uploadSizeLimit: -1,</span>
<a href="#l12.7"></a><span id="l12.7">       spaceRemaining: -1,</span>
<a href="#l12.8"></a><span id="l12.8">       spaceUsed: -1,</span>
<a href="#l12.9"></a><span id="l12.9">     };</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11">     this._nextId = 1;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-    this._fileUrls = new Map();</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-    this._fileIds = new Map();</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+    this._uploads = new Map();</span>
<a href="#l12.15"></a><span id="l12.15">   }</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">   get type() {</span>
<a href="#l12.18"></a><span id="l12.18">     return `ext-${this.extension.id}`;</span>
<a href="#l12.19"></a><span id="l12.19">   }</span>
<a href="#l12.20"></a><span id="l12.20">   get displayName() {</span>
<a href="#l12.21"></a><span id="l12.21">     return Services.prefs.getCharPref(</span>
<a href="#l12.22"></a><span id="l12.22">       `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineat">@@ -81,66 +80,86 @@ class CloudFileAccount {</span>
<a href="#l12.24"></a><span id="l12.24">     }</span>
<a href="#l12.25"></a><span id="l12.25">   }</span>
<a href="#l12.26"></a><span id="l12.26">   get createNewAccountUrl() {</span>
<a href="#l12.27"></a><span id="l12.27">     return this.extension.manifest.cloud_file.new_account_url;</span>
<a href="#l12.28"></a><span id="l12.28">   }</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">   async uploadFile(file) {</span>
<a href="#l12.31"></a><span id="l12.31">     let id = this._nextId++;</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+    let upload = {</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+      id,</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+      leafName: file.leafName,</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+      path: file.path,</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+      size: file.fileSize,</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+    };</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+    this._uploads.set(id, upload);</span>
<a href="#l12.39"></a><span id="l12.39">     let results;</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">     try {</span>
<a href="#l12.42"></a><span id="l12.42">       let buffer = await promiseFileRead(file);</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineminus">-</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-      this._fileIds.set(file.path, id);</span>
<a href="#l12.45"></a><span id="l12.45">       results = await this.extension.emit(&quot;uploadFile&quot;, this, {</span>
<a href="#l12.46"></a><span id="l12.46">         id,</span>
<a href="#l12.47"></a><span id="l12.47">         name: file.leafName,</span>
<a href="#l12.48"></a><span id="l12.48">         data: buffer,</span>
<a href="#l12.49"></a><span id="l12.49">       });</span>
<a href="#l12.50"></a><span id="l12.50">     } catch (ex) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+      this._uploads.delete(id);</span>
<a href="#l12.52"></a><span id="l12.52">       if (ex.result == 0x80530014) { // NS_ERROR_DOM_ABORT_ERR</span>
<a href="#l12.53"></a><span id="l12.53">         throw cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l12.54"></a><span id="l12.54">       } else {</span>
<a href="#l12.55"></a><span id="l12.55">         console.error(ex);</span>
<a href="#l12.56"></a><span id="l12.56">         throw cloudFileAccounts.constants.uploadErr;</span>
<a href="#l12.57"></a><span id="l12.57">       }</span>
<a href="#l12.58"></a><span id="l12.58">     }</span>
<a href="#l12.59"></a><span id="l12.59"> </span>
<a href="#l12.60"></a><span id="l12.60">     if (results &amp;&amp; results.length &gt; 0) {</span>
<a href="#l12.61"></a><span id="l12.61">       if (results[0].aborted) {</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+        this._uploads.delete(id);</span>
<a href="#l12.63"></a><span id="l12.63">         throw cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l12.64"></a><span id="l12.64">       }</span>
<a href="#l12.65"></a><span id="l12.65"> </span>
<a href="#l12.66"></a><span id="l12.66" class="difflineminus">-      let url = results[0].url;</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-      this._fileUrls.set(file.path, url);</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    } else {</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-      console.error(`Missing cloudFile.onFileUpload listener for ${this.extension.id}`);</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineminus">-      throw cloudFileAccounts.constants.uploadErr;</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+      upload.url = results[0].url;</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+      return {...upload};</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+    }</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+    console.error(`Missing cloudFile.onFileUpload listener for ${this.extension.id}`);</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+    this._uploads.delete(id);</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+    throw cloudFileAccounts.constants.uploadErr;</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  }</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  urlForFile(uploadId) {</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+    return this._uploads.get(uploadId).url;</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+  }</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+  cancelFileUpload(file) {</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+    let path = file.path;</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+    let uploadId = -1;</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+    for (let upload of this._uploads.values()) {</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+      if (!upload.url &amp;&amp; upload.path == path) {</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+        uploadId = upload.id;</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+        break;</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+      }</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+    }</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+    if (uploadId != -1) {</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+      this.extension.emit(&quot;uploadAbort&quot;, this, { id: uploadId });</span>
<a href="#l12.95"></a><span id="l12.95">     }</span>
<a href="#l12.96"></a><span id="l12.96">   }</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98" class="difflineminus">-  urlForFile(file) {</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineminus">-    return this._fileUrls.get(file.path);</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  getPreviousUploads() {</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+    return [...this._uploads.values()].map(u =&gt; { return {...u}; });</span>
<a href="#l12.102"></a><span id="l12.102">   }</span>
<a href="#l12.103"></a><span id="l12.103"> </span>
<a href="#l12.104"></a><span id="l12.104" class="difflineminus">-  cancelFileUpload(file) {</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineminus">-    this.extension.emit(&quot;uploadAbort&quot;, this, {</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-      id: this._fileIds.get(file.path),</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineminus">-    });</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineminus">-  }</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineminus">-</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  async deleteFile(file) {</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  async deleteFile(uploadId) {</span>
<a href="#l12.112"></a><span id="l12.112">     let results;</span>
<a href="#l12.113"></a><span id="l12.113">     try {</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineminus">-      if (this._fileIds.has(file.path)) {</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineminus">-        let id = this._fileIds.get(file.path);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineminus">-        results = await this.extension.emit(&quot;deleteFile&quot;, this, { id });</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+      if (this._uploads.has(uploadId)) {</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+        results = await this.extension.emit(&quot;deleteFile&quot;, this, { id: uploadId });</span>
<a href="#l12.119"></a><span id="l12.119">       }</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+      this._uploads.delete(uploadId);</span>
<a href="#l12.121"></a><span id="l12.121">     } catch (ex) {</span>
<a href="#l12.122"></a><span id="l12.122">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l12.123"></a><span id="l12.123">     }</span>
<a href="#l12.124"></a><span id="l12.124"> </span>
<a href="#l12.125"></a><span id="l12.125">     if (!results || results.length == 0) {</span>
<a href="#l12.126"></a><span id="l12.126">       console.error(`Missing cloudFile.onFileDeleted listener for ${this.extension.id}`);</span>
<a href="#l12.127"></a><span id="l12.127">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l12.128"></a><span id="l12.128">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -151,16 +151,18 @@ add_task(async () =&gt; {</span>
<a href="#l13.4"></a><span id="l13.4">         async function fileListener(account, { id, name, data }) {</span>
<a href="#l13.5"></a><span id="l13.5">           browser.cloudFile.onFileUpload.removeListener(fileListener);</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">           // The listener won't return until onFileUploadAbort fires. When that happens,</span>
<a href="#l13.8"></a><span id="l13.8">           // we return an aborted message, which completes the abort cycle.</span>
<a href="#l13.9"></a><span id="l13.9">           await new Promise((resolveAbort) =&gt; {</span>
<a href="#l13.10"></a><span id="l13.10">             function abortListener(accountAccount, abortId) {</span>
<a href="#l13.11"></a><span id="l13.11">               browser.cloudFile.onFileUploadAbort.removeListener(abortListener);</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+              browser.test.assertEq(account.id, accountAccount.id);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+              browser.test.assertEq(id, abortId);</span>
<a href="#l13.14"></a><span id="l13.14">               resolveAbort();</span>
<a href="#l13.15"></a><span id="l13.15">             }</span>
<a href="#l13.16"></a><span id="l13.16">             browser.cloudFile.onFileUploadAbort.addListener(abortListener);</span>
<a href="#l13.17"></a><span id="l13.17">             browser.test.sendMessage(&quot;cancelUpload&quot;, createdAccount.id);</span>
<a href="#l13.18"></a><span id="l13.18">           });</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">           setTimeout(resolve);</span>
<a href="#l13.21"></a><span id="l13.21">           return { aborted: true };</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineat">@@ -207,47 +209,49 @@ add_task(async () =&gt; {</span>
<a href="#l13.23"></a><span id="l13.23">     },</span>
<a href="#l13.24"></a><span id="l13.24">   });</span>
<a href="#l13.25"></a><span id="l13.25"> </span>
<a href="#l13.26"></a><span id="l13.26">   let testFiles = {</span>
<a href="#l13.27"></a><span id="l13.27">     &quot;cloudFile1&quot;: do_get_file(&quot;data/cloudFile1.txt&quot;),</span>
<a href="#l13.28"></a><span id="l13.28">     &quot;cloudFile2&quot;: do_get_file(&quot;data/cloudFile2.txt&quot;),</span>
<a href="#l13.29"></a><span id="l13.29">   };</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31" class="difflineplus">+  let uploads = {};</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineplus">+</span>
<a href="#l13.33"></a><span id="l13.33">   extension.onMessage(&quot;createAccount&quot;, (id = &quot;ext-cloudfile@xpcshell&quot;) =&gt; {</span>
<a href="#l13.34"></a><span id="l13.34">     cloudFileAccounts.createAccount(id);</span>
<a href="#l13.35"></a><span id="l13.35">   });</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37">   extension.onMessage(&quot;removeAccount&quot;, (id) =&gt; {</span>
<a href="#l13.38"></a><span id="l13.38">     cloudFileAccounts.removeAccount(id);</span>
<a href="#l13.39"></a><span id="l13.39">   });</span>
<a href="#l13.40"></a><span id="l13.40"> </span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  extension.onMessage(&quot;uploadFile&quot;, (accountId, filename, expected = Cr.NS_OK) =&gt; {</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-    let account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+  extension.onMessage(&quot;uploadFile&quot;, (id, filename, expected = Cr.NS_OK) =&gt; {</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineplus">+    let account = cloudFileAccounts.getAccount(id);</span>
<a href="#l13.45"></a><span id="l13.45"> </span>
<a href="#l13.46"></a><span id="l13.46">     if (typeof expected == &quot;string&quot;) {</span>
<a href="#l13.47"></a><span id="l13.47">       expected = cloudFileAccounts.constants[expected];</span>
<a href="#l13.48"></a><span id="l13.48">     }</span>
<a href="#l13.49"></a><span id="l13.49"> </span>
<a href="#l13.50"></a><span id="l13.50" class="difflineminus">-    account.uploadFile(testFiles[filename]).then(() =&gt; {</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+    account.uploadFile(testFiles[filename]).then((upload) =&gt; {</span>
<a href="#l13.52"></a><span id="l13.52">       Assert.equal(Cr.NS_OK, expected);</span>
<a href="#l13.53"></a><span id="l13.53" class="difflineplus">+      uploads[filename] = upload;</span>
<a href="#l13.54"></a><span id="l13.54">     }, (status) =&gt; {</span>
<a href="#l13.55"></a><span id="l13.55">       Assert.equal(status, expected);</span>
<a href="#l13.56"></a><span id="l13.56">     });</span>
<a href="#l13.57"></a><span id="l13.57">   });</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">   extension.onMessage(&quot;cancelUpload&quot;, (id) =&gt; {</span>
<a href="#l13.60"></a><span id="l13.60">     let account = cloudFileAccounts.getAccount(id);</span>
<a href="#l13.61"></a><span id="l13.61">     account.cancelFileUpload(testFiles.cloudFile2);</span>
<a href="#l13.62"></a><span id="l13.62">   });</span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64">   extension.onMessage(&quot;deleteFile&quot;, (id) =&gt; {</span>
<a href="#l13.65"></a><span id="l13.65">     let account = cloudFileAccounts.getAccount(id);</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineminus">-    account.deleteFile(testFiles.cloudFile1);</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineplus">+    account.deleteFile(uploads.cloudFile1.id);</span>
<a href="#l13.69"></a><span id="l13.69">   });</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71">   Assert.ok(!cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l13.72"></a><span id="l13.72">   await extension.startup();</span>
<a href="#l13.73"></a><span id="l13.73">   Assert.ok(cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l13.74"></a><span id="l13.74">   Assert.equal(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76">   await extension.awaitFinish(&quot;cloudFile&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -270,17 +270,19 @@ function test_no_offer_on_conversion() {</span>
<a href="#l14.4"></a><span id="l14.4">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l14.5"></a><span id="l14.5">   let provider = new MockCloudfileAccount();</span>
<a href="#l14.6"></a><span id="l14.6">   provider.init(&quot;someKey&quot;);</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l14.9"></a><span id="l14.9">   // to worry about waiting for the onStopRequest method being called</span>
<a href="#l14.10"></a><span id="l14.10">   // asynchronously.</span>
<a href="#l14.11"></a><span id="l14.11">   provider.uploadFile = function(aFile) {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-    return Promise.resolve();</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+    return Promise.resolve({</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+      id: 1,</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+    });</span>
<a href="#l14.16"></a><span id="l14.16">   };</span>
<a href="#l14.17"></a><span id="l14.17"> </span>
<a href="#l14.18"></a><span id="l14.18">   let cw = open_compose_new_mail();</span>
<a href="#l14.19"></a><span id="l14.19">   add_cloud_attachments(cw, provider, false);</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">   assert_cloudfile_notification_displayed(cw, false);</span>
<a href="#l14.22"></a><span id="l14.22">   // Now convert the file back into a normal attachment</span>
<a href="#l14.23"></a><span id="l14.23">   select_attachments(cw, 0);</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineat">@@ -312,17 +314,19 @@ function test_offer_then_upload_notifica</span>
<a href="#l14.25"></a><span id="l14.25">   // Create our mock provider</span>
<a href="#l14.26"></a><span id="l14.26">   let provider = new MockCloudfileAccount();</span>
<a href="#l14.27"></a><span id="l14.27">   provider.init(&quot;someKey&quot;);</span>
<a href="#l14.28"></a><span id="l14.28"> </span>
<a href="#l14.29"></a><span id="l14.29">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l14.30"></a><span id="l14.30">   // to worry about waiting for the onStopRequest method being called</span>
<a href="#l14.31"></a><span id="l14.31">   // asynchronously.</span>
<a href="#l14.32"></a><span id="l14.32">   provider.uploadFile = function(aFile) {</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-    return Promise.resolve();</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+    return Promise.resolve({</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+      id: 1,</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+    });</span>
<a href="#l14.37"></a><span id="l14.37">   };</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   let cw = open_compose_new_mail();</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41">   // Attach the files, saying that each is 500 bytes large - which should</span>
<a href="#l14.42"></a><span id="l14.42">   // certainly trigger the offer.</span>
<a href="#l14.43"></a><span id="l14.43">   add_attachments(cw, fileURIs, [500, 500]);</span>
<a href="#l14.44"></a><span id="l14.44">   // Assert that the offer is displayed.</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineat">@@ -352,17 +356,21 @@ function test_privacy_warning_notificati</span>
<a href="#l14.46"></a><span id="l14.46">   gMockPromptService.register();</span>
<a href="#l14.47"></a><span id="l14.47">   gMockPromptService.returnValue = false;</span>
<a href="#l14.48"></a><span id="l14.48">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l14.49"></a><span id="l14.49">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l14.50"></a><span id="l14.50">   let provider = new MockCloudfileAccount();</span>
<a href="#l14.51"></a><span id="l14.51">   provider.init(&quot;aKey&quot;);</span>
<a href="#l14.52"></a><span id="l14.52"> </span>
<a href="#l14.53"></a><span id="l14.53">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(() =&gt; {</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+      resolve({</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+        id: 1,</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+      });</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+    }, 500));</span>
<a href="#l14.60"></a><span id="l14.60">   };</span>
<a href="#l14.61"></a><span id="l14.61">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l14.62"></a><span id="l14.62">   add_cloud_attachments(cwc, provider);</span>
<a href="#l14.63"></a><span id="l14.63"> </span>
<a href="#l14.64"></a><span id="l14.64">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l14.65"></a><span id="l14.65">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l14.66"></a><span id="l14.66"> </span>
<a href="#l14.67"></a><span id="l14.67">   // Assert that the warning is displayed.</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineat">@@ -389,17 +397,21 @@ function test_privacy_warning_notificati</span>
<a href="#l14.69"></a><span id="l14.69">   gMockPromptService.register();</span>
<a href="#l14.70"></a><span id="l14.70">   gMockPromptService.returnValue = false;</span>
<a href="#l14.71"></a><span id="l14.71">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l14.72"></a><span id="l14.72">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l14.73"></a><span id="l14.73">   let provider = new MockCloudfileAccount();</span>
<a href="#l14.74"></a><span id="l14.74">   provider.init(&quot;aKey&quot;);</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineminus">-    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(() =&gt; {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+      resolve({</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+        id: 1,</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+      });</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+    }, 500));</span>
<a href="#l14.83"></a><span id="l14.83">   };</span>
<a href="#l14.84"></a><span id="l14.84">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l14.85"></a><span id="l14.85">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l14.88"></a><span id="l14.88">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l14.89"></a><span id="l14.89"> </span>
<a href="#l14.90"></a><span id="l14.90">   // Assert that the warning is displayed.</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineat">@@ -426,17 +438,21 @@ function test_privacy_warning_notificati</span>
<a href="#l14.92"></a><span id="l14.92">   gMockPromptService.register();</span>
<a href="#l14.93"></a><span id="l14.93">   gMockPromptService.returnValue = false;</span>
<a href="#l14.94"></a><span id="l14.94">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l14.95"></a><span id="l14.95">                                               &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l14.96"></a><span id="l14.96">   let provider = new MockCloudfileAccount();</span>
<a href="#l14.97"></a><span id="l14.97">   provider.init(&quot;aKey&quot;);</span>
<a href="#l14.98"></a><span id="l14.98"> </span>
<a href="#l14.99"></a><span id="l14.99">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineminus">-    return new Promise(resolve =&gt; cwc.window.setTimeout(resolve, 500));</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+    return new Promise(resolve =&gt; cwc.window.setTimeout(() =&gt; {</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+      resolve({</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+        id: 1,</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+      });</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+    }, 500));</span>
<a href="#l14.106"></a><span id="l14.106">   };</span>
<a href="#l14.107"></a><span id="l14.107">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l14.108"></a><span id="l14.108">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l14.111"></a><span id="l14.111">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l14.112"></a><span id="l14.112"> </span>
<a href="#l14.113"></a><span id="l14.113">   // Assert that the warning is displayed.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -69,33 +69,42 @@ function collectFiles(aFiles, aFileRoot)</span>
<a href="#l15.4"></a><span id="l15.4"> }</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> function MockCloudfileAccount() {</span>
<a href="#l15.7"></a><span id="l15.7">   for (let someDefault in kDefaults)</span>
<a href="#l15.8"></a><span id="l15.8">     this[someDefault] = kDefaults[someDefault];</span>
<a href="#l15.9"></a><span id="l15.9"> }</span>
<a href="#l15.10"></a><span id="l15.10"> </span>
<a href="#l15.11"></a><span id="l15.11"> MockCloudfileAccount.prototype = {</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+  nextId: 1,</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+</span>
<a href="#l15.14"></a><span id="l15.14">   init(aAccountKey) {</span>
<a href="#l15.15"></a><span id="l15.15">     this.accountKey = aAccountKey;</span>
<a href="#l15.16"></a><span id="l15.16">   },</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18">   uploadFile(aFile) {</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-    return new Promise(resolve =&gt; fdh.mc.window.setTimeout(resolve));</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+    return new Promise(resolve =&gt; fdh.mc.window.setTimeout(() =&gt; {</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+      resolve({</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineplus">+        id: this.nextId++,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+        url: this.urlForFile(aFile),</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineplus">+        path: aFile.path,</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+        leafName: aFile.leafName,</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+      });</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+    }));</span>
<a href="#l15.28"></a><span id="l15.28">   },</span>
<a href="#l15.29"></a><span id="l15.29"> </span>
<a href="#l15.30"></a><span id="l15.30">   urlForFile(aFile) {</span>
<a href="#l15.31"></a><span id="l15.31">     return `http://www.example.com/${this.accountKey}/${aFile.leafName}`;</span>
<a href="#l15.32"></a><span id="l15.32">   },</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  cancelFileUpload(aFile) {</span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+  cancelFileUpload(aUploadId) {</span>
<a href="#l15.36"></a><span id="l15.36">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l15.37"></a><span id="l15.37">   },</span>
<a href="#l15.38"></a><span id="l15.38"> </span>
<a href="#l15.39"></a><span id="l15.39" class="difflineminus">-  deleteFile(aFile) {</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+  deleteFile(aUploadId) {</span>
<a href="#l15.41"></a><span id="l15.41">     return new Promise(resolve =&gt; fdh.mc.window.setTimeout(resolve));</span>
<a href="#l15.42"></a><span id="l15.42">   },</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">   get displayName() {</span>
<a href="#l15.45"></a><span id="l15.45">     return cloudFileAccounts.getDisplayName(this.accountKey);</span>
<a href="#l15.46"></a><span id="l15.46">   },</span>
<a href="#l15.47"></a><span id="l15.47"> };</span>
<a href="#l15.48"></a><span id="l15.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -406,17 +406,17 @@ function add_cloud_attachments(aControll</span>
<a href="#l16.4"></a><span id="l16.4">   }</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   let attachmentCount = 0;</span>
<a href="#l16.7"></a><span id="l16.7">   function collectUploadedAttachments(event) {</span>
<a href="#l16.8"></a><span id="l16.8">     attachmentCount--;</span>
<a href="#l16.9"></a><span id="l16.9">   }</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">   bucket.addEventListener(&quot;attachments-uploading&quot;, uploadAttachments, { once: true });</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  aController.window.attachToCloud(aProvider);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  aController.window.attachToCloudNew(aProvider);</span>
<a href="#l16.14"></a><span id="l16.14">   aController.waitFor(() =&gt; attachmentsSubmitted, &quot;Couldn't attach attachments for upload&quot;);</span>
<a href="#l16.15"></a><span id="l16.15">   if (aWaitUploaded) {</span>
<a href="#l16.16"></a><span id="l16.16">     aController.waitFor(() =&gt; attachmentCount == 0, &quot;Attachments uploading didn't finish&quot;);</span>
<a href="#l16.17"></a><span id="l16.17">   }</span>
<a href="#l16.18"></a><span id="l16.18">   aController.sleep(0);</span>
<a href="#l16.19"></a><span id="l16.19"> }</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21"> /**</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

