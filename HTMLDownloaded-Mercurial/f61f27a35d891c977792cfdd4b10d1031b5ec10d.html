<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28816:f61f27a35d891c977792cfdd4b10d1031b5ec10d</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f61f27a35d891c977792cfdd4b10d1031b5ec10d" />
<meta property="og:url" content="/comm-central/rev/f61f27a35d891c977792cfdd4b10d1031b5ec10d" />
<meta property="og:description" content="Bug 1616608 - Remove separate ESLint rules in calendar. r=mkmelin,pmorris,fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f61f27a35d891c977792cfdd4b10d1031b5ec10d 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f61f27a35d891c977792cfdd4b10d1031b5ec10d">shortlog</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f61f27a35d891c977792cfdd4b10d1031b5ec10d">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d">files</a> |
changeset |
<a href="/comm-central/raw-rev/f61f27a35d891c977792cfdd4b10d1031b5ec10d">raw</a>  | <a href="/comm-central/archive/f61f27a35d891c977792cfdd4b10d1031b5ec10d.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616608">Bug 1616608</a> - Remove separate ESLint rules in calendar. r=mkmelin,pmorris,fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 20 Feb 2020 11:24:47 +1300</td></tr>

<tr>
 <td>changeset 28816</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f61f27a35d891c977792cfdd4b10d1031b5ec10d">f61f27a35d891c977792cfdd4b10d1031b5ec10d</a></td>
</tr>



<tr>
<td>parent 28815</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7c243455ebe5e4bd08075abfe1f0b87a5c15dcf5">7c243455ebe5e4bd08075abfe1f0b87a5c15dcf5</a>
</td>
</tr>

<tr>
<td>child 28817</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/75aa7d5dbcfdf0b36ce508b1838ec209c09b230a">75aa7d5dbcfdf0b36ce508b1838ec209c09b230a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f61f27a35d891c977792cfdd4b10d1031b5ec10d">17052</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Fri, 21 Feb 2020 07:03:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f61f27a35d89 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f61f27a35d891c977792cfdd4b10d1031b5ec10d">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f61f27a35d891c977792cfdd4b10d1031b5ec10d&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f61f27a35d891c977792cfdd4b10d1031b5ec10d&newProject=comm-central&newRevision=7c243455ebe5e4bd08075abfe1f0b87a5c15dcf5&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f61f27a35d891c977792cfdd4b10d1031b5ec10d&newProject=comm-central&newRevision=7c243455ebe5e4bd08075abfe1f0b87a5c15dcf5&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f61f27a35d891c977792cfdd4b10d1031b5ec10d&newProject=comm-central&newRevision=7c243455ebe5e4bd08075abfe1f0b87a5c15dcf5&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28pmorris%29&revcount=50">pmorris</a>, <a href="/comm-central/log?rev=reviewer%28fallen%29&revcount=50">fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616608">1616608</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1616608">Bug 1616608</a> - Remove separate ESLint rules in calendar. r=mkmelin,pmorris,fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/.eslintrc.js">calendar/.eslintrc.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">calendar/base/backend/calBackendLoader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/calBackendLoader.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">calendar/base/backend/icaljs/calDateTime.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDateTime.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">calendar/base/backend/icaljs/calDuration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calDuration.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">calendar/base/backend/icaljs/calICSService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calICSService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">calendar/base/backend/icaljs/calPeriod.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calPeriod.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">calendar/base/backend/icaljs/calRecurrenceRule.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/backend/icaljs/calRecurrenceRule.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">calendar/base/content/agenda-listbox-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/agenda-listbox-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">calendar/base/content/calendar-chrome-startup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-chrome-startup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">calendar/base/content/calendar-command-controller.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-command-controller.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">calendar/base/content/calendar-dnd-listener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-dnd-listener.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">calendar/base/content/calendar-event-column.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-event-column.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">calendar/base/content/calendar-extract.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-extract.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">calendar/base/content/calendar-invitations-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-invitations-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">calendar/base/content/calendar-item-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-item-editing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">calendar/base/content/calendar-management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">calendar/base/content/calendar-migration.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-migration.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">calendar/base/content/calendar-multiday-base-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-multiday-base-view.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">calendar/base/content/calendar-statusbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-statusbar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">calendar/base/content/calendar-task-editing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-editing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">calendar/base/content/calendar-task-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">calendar/base/content/calendar-task-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-task-view.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">calendar/base/content/calendar-unifinder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-unifinder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">calendar/base/content/calendar-views-utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/calendar-views-utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">calendar/base/content/dialogs/calendar-event-dialog-attendees.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-attendees.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">calendar/base/content/dialogs/calendar-event-dialog-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-event-dialog-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">calendar/base/content/dialogs/calendar-invitations-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-invitations-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">calendar/base/content/dialogs/calendar-migration-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-migration-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">calendar/base/content/dialogs/calendar-print-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-print-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">calendar/base/content/dialogs/calendar-subscriptions-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/dialogs/calendar-subscriptions-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">calendar/base/content/import-export.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/import-export.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">calendar/base/content/preferences/alarms.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/alarms.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">calendar/base/content/preferences/categories.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/categories.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">calendar/base/content/preferences/general.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/general.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">calendar/base/content/preferences/views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/preferences/views.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">calendar/base/content/today-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/content/today-pane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">calendar/base/modules/calExtract.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calExtract.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">calendar/base/modules/calHashedArray.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calHashedArray.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">calendar/base/modules/calUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/calUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">calendar/base/modules/utils/calACLUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calACLUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">calendar/base/modules/utils/calAlarmUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAlarmUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">calendar/base/modules/utils/calAsyncUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAsyncUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">calendar/base/modules/utils/calAuthUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calAuthUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">calendar/base/modules/utils/calCategoryUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calCategoryUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">calendar/base/modules/utils/calDataUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDataUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">calendar/base/modules/utils/calDateTimeUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calDateTimeUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">calendar/base/modules/utils/calEmailUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calEmailUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">calendar/base/modules/utils/calItemUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItemUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">calendar/base/modules/utils/calIteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calIteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">calendar/base/modules/utils/calItipUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calItipUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">calendar/base/modules/utils/calL10NUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calL10NUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">calendar/base/modules/utils/calPrintUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calPrintUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">calendar/base/modules/utils/calProviderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calProviderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">calendar/base/modules/utils/calUnifinderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calUnifinderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">calendar/base/modules/utils/calViewUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calViewUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">calendar/base/modules/utils/calWindowUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calWindowUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">calendar/base/modules/utils/calXMLUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/modules/utils/calXMLUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">calendar/base/src/calAlarm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">calendar/base/src/calAlarmMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">calendar/base/src/calAlarmService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAlarmService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">calendar/base/src/calAttachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">calendar/base/src/calAttendee.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calAttendee.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">calendar/base/src/calCachedCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCachedCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">calendar/base/src/calCalendarManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">calendar/base/src/calCalendarSearchService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calCalendarSearchService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">calendar/base/src/calDateTimeFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDateTimeFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">calendar/base/src/calDefaultACLManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDefaultACLManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">calendar/base/src/calDeletedItems.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calDeletedItems.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">calendar/base/src/calEvent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calEvent.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">calendar/base/src/calFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFilter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">calendar/base/src/calFreeBusyService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calFreeBusyService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">calendar/base/src/calIcsParser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsParser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">calendar/base/src/calIcsSerializer.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calIcsSerializer.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">calendar/base/src/calItemBase.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItemBase.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">calendar/base/src/calItipItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calItipItem.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">calendar/base/src/calProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">calendar/base/src/calRecurrenceDate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceDate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">calendar/base/src/calRecurrenceInfo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRecurrenceInfo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">calendar/base/src/calRelation.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calRelation.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">calendar/base/src/calSleepMonitor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calSleepMonitor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">calendar/base/src/calStartupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calStartupService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">calendar/base/src/calTimezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezone.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">calendar/base/src/calTimezoneService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTimezoneService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">calendar/base/src/calTodo.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTodo.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">calendar/base/src/calTransactionManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calTransactionManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">calendar/base/src/calWeekInfoService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/base/src/calWeekInfoService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">calendar/import-export/calHtmlExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calHtmlExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">calendar/import-export/calIcsImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calIcsImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">calendar/import-export/calListFormatter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calListFormatter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">calendar/import-export/calMonthGridPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calMonthGridPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">calendar/import-export/calOutlookCSVImportExport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calOutlookCSVImportExport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">calendar/import-export/calWeekPrinter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/import-export/calWeekPrinter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">calendar/itip/calItipEmailTransport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/itip/calItipEmailTransport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">calendar/lightning/components/calItipProtocolHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/calItipProtocolHandler.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">calendar/lightning/components/lightningTextCalendarConverter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/components/lightningTextCalendarConverter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">calendar/lightning/content/html-item-editing/react-code.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/html-item-editing/react-code.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">calendar/lightning/content/imip-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/imip-bar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">calendar/lightning/content/messenger-overlay-preferences.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-preferences.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">calendar/lightning/content/messenger-overlay-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/content/messenger-overlay-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">calendar/lightning/modules/ltnInvitationUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/lightning/modules/ltnInvitationUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">calendar/providers/caldav/calDavCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">calendar/providers/caldav/calDavRequestHandlers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/caldav/calDavRequestHandlers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">calendar/providers/composite/calCompositeCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/composite/calCompositeCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">calendar/providers/ics/calICSCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/ics/calICSCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">calendar/providers/memory/calMemoryCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/memory/calMemoryCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">calendar/providers/storage/calStorageCalendar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageCalendar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">calendar/providers/storage/calStorageHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">calendar/providers/storage/calStorageUpgrade.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/providers/storage/calStorageUpgrade.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">calendar/resources/content/mouseoverPreviews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/mouseoverPreviews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">calendar/resources/content/publish.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publish.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">calendar/resources/content/publishDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/resources/content/publishDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">calendar/test/modules/CalendarUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/modules/CalendarUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">calendar/test/unit/head_consts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/head_consts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">calendar/test/unit/test_alarmservice.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmservice.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">calendar/test/unit/test_alarmutils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_alarmutils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">calendar/test/unit/test_bug494140.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_bug494140.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">calendar/test/unit/test_calmgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_calmgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">calendar/test/unit/test_data_bags.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_data_bags.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">calendar/test/unit/test_freebusy_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_freebusy_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">calendar/test/unit/test_hashedarray.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_hashedarray.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">calendar/test/unit/test_ics.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">calendar/test/unit/test_ics_parser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_ics_parser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">calendar/test/unit/test_items.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_items.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">calendar/test/unit/test_providers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_providers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">calendar/test/unit/test_search_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_search_service.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">calendar/test/unit/test_startup_service.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_startup_service.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">calendar/test/unit/test_storage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_storage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">calendar/test/unit/test_timezone.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_timezone.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">calendar/test/unit/test_utils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_utils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">calendar/test/unit/test_webcal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/calendar/test/unit/test_webcal.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">mailnews/extensions/newsblog/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/f61f27a35d891c977792cfdd4b10d1031b5ec10d/mailnews/extensions/newsblog/.eslintrc.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintrc.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintrc.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -27,16 +27,17 @@ module.exports = {</span>
<a href="#l1.4"></a><span id="l1.4">   // We would like the same base rules as provided by</span>
<a href="#l1.5"></a><span id="l1.5">   // mozilla/tools/lint/eslint/eslint-plugin-mozilla/lib/configs/recommended.js</span>
<a href="#l1.6"></a><span id="l1.6">   extends: [&quot;plugin:mozilla/recommended&quot;],</span>
<a href="#l1.7"></a><span id="l1.7"> </span>
<a href="#l1.8"></a><span id="l1.8">   // When adding items to this file please check for effects on sub-directories.</span>
<a href="#l1.9"></a><span id="l1.9">   plugins: [&quot;html&quot;, &quot;mozilla&quot;],</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   rules: {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    complexity: [&quot;error&quot;, 80],</span>
<a href="#l1.13"></a><span id="l1.13">     &quot;func-names&quot;: [&quot;error&quot;, &quot;never&quot;],</span>
<a href="#l1.14"></a><span id="l1.14">     &quot;mozilla/prefer-boolean-length-check&quot;: &quot;off&quot;,</span>
<a href="#l1.15"></a><span id="l1.15">   },</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   // To avoid bad interactions of the html plugin with the xml preprocessor in</span>
<a href="#l1.18"></a><span id="l1.18">   // eslint-plugin-mozilla, we turn off processing of the html plugin for .xml</span>
<a href="#l1.19"></a><span id="l1.19">   // files.</span>
<a href="#l1.20"></a><span id="l1.20">   settings: {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">deleted file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- a/calendar/.eslintrc.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ /dev/null</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -1,541 +0,0 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineminus">-</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineminus">-module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineminus">-  extends: [&quot;../../toolkit/.eslintrc.js&quot;],</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineminus">-  rules: {</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-    // Enforce newline at the end of file, with no multiple empty lines.</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">-    &quot;eol-last&quot;: 2,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    // Disallow using variables outside the blocks they are defined</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    &quot;block-scoped-var&quot;: 2,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-    // Allow trailing commas for easy list extension.  Having them does not</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-    // impair readability, but also not required either.</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    &quot;comma-dangle&quot;: 0,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-    // Enforce spacing before and after comma</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-    &quot;comma-spacing&quot;: [2, { before: false, after: true }],</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    // Enforce one true comma style.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-    &quot;comma-style&quot;: [2, &quot;last&quot;],</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    // We should get better at complexity, but at the moment it is what it is</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-    complexity: [2, 90],</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-    // Enforce curly brace conventions for all control statements.</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-    curly: 2,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    // Require space before/after arrow function's arrow</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    &quot;arrow-spacing&quot;: [2, { before: true, after: true }],</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    // Enforces spacing between keys and values in object literal properties.</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    &quot;key-spacing&quot;: [2, { beforeColon: false, afterColon: true, mode: &quot;minimum&quot; }],</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    // Disallow the omission of parentheses when invoking a constructor with no</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    // arguments.</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    &quot;new-parens&quot;: 2,</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    // Disallow use of the Array constructor.</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    &quot;no-array-constructor&quot;: 2,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-    // disallow use of the Object constructor</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-    &quot;no-new-object&quot;: 2,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-    // Disallow Primitive Wrapper Instances</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-    &quot;no-new-wrappers&quot;: 2,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-    // Disallow the catch clause parameter name being the same as a variable in</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-    // the outer scope, to avoid confusion.</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-    &quot;no-catch-shadow&quot;: 2,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineminus">-</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-    // Disallow assignment in conditional expressions.</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-    &quot;no-cond-assign&quot;: 2,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-    // Disallow use of debugger.</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-    &quot;no-debugger&quot;: 2,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-    // Disallow deletion of variables (deleting properties is fine).</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-    &quot;no-delete-var&quot;: 2,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-    // Disallow duplicate arguments in functions.</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-    &quot;no-dupe-args&quot;: 2,</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-    // Disallow duplicate keys when creating object literals.</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-    &quot;no-dupe-keys&quot;: 2,</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-    // Disallow a duplicate case label.</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-    &quot;no-duplicate-case&quot;: 2,</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-    // Disallow the use of empty character classes in regular expressions.</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    &quot;no-empty-character-class&quot;: 2,</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    // Disallow assigning to the exception in a catch block.</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-    &quot;no-ex-assign&quot;: 2,</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    // Disallow adding to native types</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-    &quot;no-extend-native&quot;: 2,</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-    // Disallow double-negation boolean casts in a boolean context.</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-    &quot;no-extra-boolean-cast&quot;: 2,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-    // Disallow unnecessary semicolons.</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-    &quot;no-extra-semi&quot;: 2,</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-    // Disallow mixed spaces and tabs for indentation.</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-    &quot;no-mixed-spaces-and-tabs&quot;: 2,</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineminus">-</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineminus">-    // Disallow reassignments of native objects.</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-    &quot;no-native-reassign&quot;: 2,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    // Disallow nested ternary expressions, they make the code hard to read.</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    &quot;no-nested-ternary&quot;: 2,</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    // Disallow use of octal literals.</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    &quot;no-octal&quot;: 2,</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineminus">-</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineminus">-    // Disallow comparisons where both sides are exactly the same.</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    &quot;no-self-compare&quot;: 2,</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineminus">-</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineminus">-    // Disallow sparse arrays, eg. let arr = [,,2].</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineminus">-    // Array destructuring is fine though:</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineminus">-    // for (let [, breakpointPromise] of aPromises)</span>
<a href="#l2.106"></a><span id="l2.106" class="difflineminus">-    &quot;no-sparse-arrays&quot;: 2,</span>
<a href="#l2.107"></a><span id="l2.107" class="difflineminus">-</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    // Disallow trailing whitespace at the end of lines.</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineminus">-    &quot;no-trailing-spaces&quot;: 2,</span>
<a href="#l2.110"></a><span id="l2.110" class="difflineminus">-</span>
<a href="#l2.111"></a><span id="l2.111" class="difflineminus">-    // Disallow use of the with statement.</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-    &quot;no-with&quot;: 2,</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-    // Disallow comparisons with the value NaN.</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-    &quot;use-isnan&quot;: 2,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-    // Ensure that the results of typeof are compared against a valid string.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-    &quot;valid-typeof&quot;: 2,</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-    // disallow the use of object properties of the global object (Math and</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-    // JSON) as functions</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-    &quot;no-obj-calls&quot;: 2,</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineminus">-    // disallow use of octal escape sequences in string literals, such as</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineminus">-    // var foo = &quot;Copyright \251&quot;;</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineminus">-    &quot;no-octal-escape&quot;: 2,</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineminus">-</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineminus">-    // disallow use of void operator</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-    &quot;no-void&quot;: 2,</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-    // Disallow Yoda conditions (where literal value comes first).</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-    yoda: 2,</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-    // Require a space immediately following the // in a line comment.</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-    &quot;spaced-comment&quot;: [2, &quot;always&quot;],</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    // Require use of the second argument for parseInt().</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-    radix: 2,</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-    // Require spaces before/after unary operators (words on by default,</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-    // nonwords off by default).</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-    &quot;space-unary-ops&quot;: [2, { words: true, nonwords: false }],</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineminus">-    // Enforce spacing after semicolons.</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineminus">-    &quot;semi-spacing&quot;: [2, { before: false, after: true }],</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineminus">-</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-    // Disallow the use of Boolean literals in conditional expressions.</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineminus">-    &quot;no-unneeded-ternary&quot;: 2,</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineminus">-</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineminus">-    // Disallow use of multiple spaces (sometimes used to align const values,</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    // array or object items, etc.). It's hard to maintain and doesn't add that</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    // much benefit.</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-    &quot;no-multi-spaces&quot;: [2, { ignoreEOLComments: true }],</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineminus">-</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineminus">-    // Require spaces around operators, except for a|0.</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineminus">-    // Disabled for now given eslint doesn't support default args yet</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-    // &quot;space-infix-ops&quot;: [2, { &quot;int32Hint&quot;: true }],</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-    &quot;space-infix-ops&quot;: 0,</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineminus">-    // Require a space around all keywords.</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineminus">-    &quot;keyword-spacing&quot;: 2,</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineminus">-</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineminus">-    // Disallow space between function identifier and application.</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-    &quot;no-spaced-func&quot;: 2,</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-    // Disallow shadowing of names such as arguments.</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-    &quot;no-shadow-restricted-names&quot;: 2,</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineminus">-    // Disallow use of comma operator.</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineminus">-    &quot;no-sequences&quot;: 2,</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-    // Disallow use of assignment in return statement. It is preferable for a</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-    // single line of code to have only one easily predictable effect.</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineminus">-    &quot;no-return-assign&quot;: 2,</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineminus">-</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineminus">-    // Require return statements to either always or never specify values</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-    &quot;consistent-return&quot;: 2,</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-    // Disallow padding within blocks.</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-    &quot;padded-blocks&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineminus">-    // Disallow spaces inside parentheses.</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineminus">-    &quot;space-in-parens&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineminus">-</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineminus">-    // Require space after keyword for anonymous functions, but disallow space</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-    // after name of named functions.</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-    &quot;space-before-function-paren&quot;: [2, { anonymous: &quot;never&quot;, named: &quot;never&quot; }],</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-    // Disallow unreachable statements after a return, throw, continue, or break</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-    // statement.</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-    &quot;no-unreachable&quot;: 2,</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineminus">-</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineminus">-    // Always require use of semicolons wherever they are valid.</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineminus">-    semi: [2, &quot;always&quot;],</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineminus">-</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineminus">-    // Disallow empty statements. This will report an error for:</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineminus">-    // try { something(); } catch (e) {}</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-    // but will not report it for:</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineminus">-    // try { something(); } catch (e) { /* Silencing the error because ...*/ }</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineminus">-    // which is a valid use case.</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineminus">-    &quot;no-empty&quot;: 2,</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineminus">-</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineminus">-    // Disallow declaring the same variable more than once (we use let anyway).</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineminus">-    &quot;no-redeclare&quot;: 2,</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-    // Warn about declaration of variables already declared in the outer scope.</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineminus">-    // This isn't an error because it sometimes is useful to use the same name</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineminus">-    // in a small helper function rather than having to come up with another</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineminus">-    // random name.  Still, making this a warning can help people avoid being</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineminus">-    // confused.</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-    &quot;no-shadow&quot;: 2,</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-    // We use var-only-at-top-level instead of no-var as we allow top level</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-    // vars.</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-    &quot;no-var&quot;: 0,</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-    &quot;mozilla/var-only-at-top-level&quot;: 1,</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineminus">-    // Disallow global and local variables that aren't used, but allow unused function arguments.</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineminus">-    &quot;no-unused-vars&quot;: [2, { vars: &quot;all&quot;, args: &quot;none&quot;, varsIgnorePattern: &quot;EXPORTED_SYMBOLS&quot; }],</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineminus">-</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineminus">-    &quot;mozilla/mark-test-function-used&quot;: 1,</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-    // Require padding inside curly braces</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-    &quot;object-curly-spacing&quot;: [2, &quot;always&quot;],</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineminus">-</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineminus">-    // Disallow spaces inside of brackets</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineminus">-    &quot;array-bracket-spacing&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineminus">-    // Disallow control characters in regular expressions</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineminus">-    &quot;no-control-regex&quot;: 2,</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineminus">-</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineminus">-    // Disallow invalid regular expression strings in RegExp constructors</span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-    &quot;no-invalid-regexp&quot;: 2,</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineminus">-</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineminus">-    // Disallow multiple spaces in regular expression literals</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-    &quot;no-regex-spaces&quot;: 2,</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineminus">-</span>
<a href="#l2.238"></a><span id="l2.238" class="difflineminus">-    // Disallow irregular whitespace</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-    &quot;no-irregular-whitespace&quot;: 2,</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineminus">-</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-    // Disallow negating the left operand in `in` expressions</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-    &quot;no-negated-in-lhs&quot;: 2,</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineminus">-    // Allow constant expressions in conditions</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineminus">-    // With 2.11.0 we can enable this with checkLoops: false</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineminus">-    &quot;no-constant-condition&quot;: [2, { checkLoops: false }],</span>
<a href="#l2.247"></a><span id="l2.247" class="difflineminus">-</span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-    // Disallow Regexs That Look Like Division</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-    &quot;no-div-regex&quot;: 2,</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineminus">-    // Disallow Iterator (using __iterator__)</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineminus">-    &quot;no-iterator&quot;: 2,</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineminus">-</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-    // Enforce consistent linebreak style</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-    &quot;linebreak-style&quot;: [2, &quot;unix&quot;],</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineminus">-    // Enforces return statements in callbacks of array's methods</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineminus">-    &quot;array-callback-return&quot;: 2,</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-    // Verify super() calls in constructors</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-    &quot;constructor-super&quot;: 2,</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-    // Disallow modifying variables of class declarations</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-    &quot;no-class-assign&quot;: 2,</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-    // Disallow modifying variables that are declared using const</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-    &quot;no-const-assign&quot;: 2,</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-    // Disallow duplicate name in class members</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-    &quot;no-dupe-class-members&quot;: 2,</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineminus">-</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineminus">-    // Disallow use of this/super before calling super() in constructors</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineminus">-    &quot;no-this-before-super&quot;: 2,</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineminus">-</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineminus">-    // Disallow duplicate imports</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-    &quot;no-duplicate-imports&quot;: 2,</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-    // Disallow empty destructuring patterns</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-    &quot;no-empty-pattern&quot;: 2,</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineminus">-</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineminus">-    // Disallow Labeled Statements</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-    &quot;no-labels&quot;: 2,</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-    // Disallow Multiline Strings</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-    &quot;no-multi-str&quot;: 2,</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-    // Disallow Symbol Constructor</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-    &quot;no-new-symbol&quot;: 2,</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-    // Disallow Initializing to undefined</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-    &quot;no-undef-init&quot;: 2,</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    // Disallow control flow statements in finally blocks</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-    &quot;no-unsafe-finally&quot;: 2,</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-    // Disallow Unused Labels</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    &quot;no-unused-labels&quot;: 2,</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-    // Disallow unnecessary computed property keys on objects</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-    &quot;no-useless-computed-key&quot;: 2,</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-    // Disallow unnecessary constructor</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-    &quot;no-useless-constructor&quot;: 2,</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    // Disallow renaming import, export, and destructured assignments to the</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-    // same name</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-    &quot;no-useless-rename&quot;: 2,</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-    // Enforce spacing between rest and spread operators and their expressions</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-    &quot;rest-spread-spacing&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-    // Disallow usage of spacing in template string expressions</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-    &quot;template-curly-spacing&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-    // Disallow the Unicode Byte Order Mark</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineminus">-    &quot;unicode-bom&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineminus">-</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-    // Enforce spacing around the * in yield* expressions</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-    &quot;yield-star-spacing&quot;: [2, &quot;after&quot;],</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineminus">-</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-    // Disallow Implied eval</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-    &quot;no-implied-eval&quot;: 2,</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineminus">-    // Disallow unnecessary function binding</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineminus">-    &quot;no-extra-bind&quot;: 2,</span>
<a href="#l2.326"></a><span id="l2.326" class="difflineminus">-</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-    // Disallow new For Side Effects</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-    &quot;no-new&quot;: 2,</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    // Disallow Self Assignment</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-    &quot;no-self-assign&quot;: 2,</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineminus">-</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineminus">-    // Disallow confusing multiline expressions</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-    &quot;no-unexpected-multiline&quot;: 2,</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-    // Require IIFEs to be Wrapped</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-    &quot;wrap-iife&quot;: [2, &quot;inside&quot;],</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-</span>
<a href="#l2.339"></a><span id="l2.339" class="difflineminus">-    // Disallow Unused Expressions</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-    &quot;no-unused-expressions&quot;: 2,</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-    // Disallow function or var declarations in nested blocks</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-    &quot;no-inner-declarations&quot;: 2,</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-    // Enforce newline before and after dot</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-    &quot;dot-location&quot;: [2, &quot;property&quot;],</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineminus">-    // Disallow Use of caller/callee</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineminus">-    &quot;no-caller&quot;: 2,</span>
<a href="#l2.350"></a><span id="l2.350" class="difflineminus">-</span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-    // Disallow Case Statement Fallthrough</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-    &quot;no-fallthrough&quot;: 2,</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineminus">-    // Disallow Floating Decimals</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineminus">-    &quot;no-floating-decimal&quot;: 2,</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-    // Require Space Before Blocks</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-    &quot;space-before-blocks&quot;: 2,</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-    // Operators always before the line break</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-    &quot;operator-linebreak&quot;: [2, &quot;after&quot;, { overrides: { &quot;:&quot;: &quot;before&quot;, &quot;?&quot;: &quot;ignore&quot; } }],</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-    // Restricts the use of parentheses to only where they are necessary</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineminus">-    // Disabled for now since this also removes parens around assignments, e.g. let foo = bar == baz</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineminus">-    // &quot;no-extra-parens&quot;: [2, &quot;all&quot;, { &quot;conditionalAssign&quot;: false, &quot;returnAssign&quot;: false, &quot;nestedBinaryExpressions&quot;: false }],</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineminus">-</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-    // Double quotes should be used.</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-    quotes: [2, &quot;double&quot;, { avoidEscape: true }],</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-    // Disallow if as the only statement in an else block.</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-    &quot;no-lonely-if&quot;: 2,</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-    // Not more than two empty lines with in the file, and no extra lines at</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-    // beginning or end of file.</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-    &quot;no-multiple-empty-lines&quot;: [2, { max: 2, maxEOF: 0, maxBOF: 0 }],</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineminus">-</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineminus">-    // Make sure all setters have a corresponding getter</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineminus">-    &quot;accessor-pairs&quot;: 2,</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-</span>
<a href="#l2.380"></a><span id="l2.380" class="difflineminus">-    // Enforce spaces inside of single line blocks</span>
<a href="#l2.381"></a><span id="l2.381" class="difflineminus">-    &quot;block-spacing&quot;: [2, &quot;always&quot;],</span>
<a href="#l2.382"></a><span id="l2.382" class="difflineminus">-</span>
<a href="#l2.383"></a><span id="l2.383" class="difflineminus">-    // Disallow spaces inside of computed properties</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-    &quot;computed-property-spacing&quot;: [2, &quot;never&quot;],</span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-    // Require consistent this (using |self|)</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-    &quot;consistent-this&quot;: [2, &quot;self&quot;],</span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-</span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-    // Disallow unnecessary .call() and .apply()</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineminus">-    &quot;no-useless-call&quot;: 2,</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineminus">-</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-    // Require dot notation when accessing properties</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineminus">-    &quot;dot-notation&quot;: 2,</span>
<a href="#l2.394"></a><span id="l2.394" class="difflineminus">-</span>
<a href="#l2.395"></a><span id="l2.395" class="difflineminus">-    // Enforce placing object properties on separate lines</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-    &quot;object-property-newline&quot;: [2, { allowMultiplePropertiesPerLine: true }],</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineminus">-    // Do Not Require Object Literal Shorthand Syntax</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-    // (Override the parent eslintrc setting for this.)</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-    &quot;object-shorthand&quot;: &quot;off&quot;,</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-    // Disallow whitespace before properties</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-    &quot;no-whitespace-before-property&quot;: 2,</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-    // Disallow unnecessary escape usage</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-    &quot;no-useless-escape&quot;: 2,</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineminus">-</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineminus">-    // Disallow mixes of different operators, but allow simple math operations.</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineminus">-    &quot;no-mixed-operators&quot;: [</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineminus">-      2,</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineminus">-      {</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-        groups: [</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineminus">-          /* [&quot;+&quot;, &quot;-&quot;, &quot;*&quot;, &quot;/&quot;, &quot;%&quot;, &quot;**&quot;], */</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineminus">-          [&quot;&amp;&quot;, &quot;|&quot;, &quot;^&quot;, &quot;~&quot;, &quot;&lt;&lt;&quot;, &quot;&gt;&gt;&quot;, &quot;&gt;&gt;&gt;&quot;],</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-          [&quot;==&quot;, &quot;!=&quot;, &quot;===&quot;, &quot;!==&quot;, &quot;&gt;&quot;, &quot;&gt;=&quot;, &quot;&lt;&quot;, &quot;&lt;=&quot;],</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-          [&quot;&amp;&amp;&quot;, &quot;||&quot;],</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-          [&quot;in&quot;, &quot;instanceof&quot;],</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-        ],</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-      },</span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-    ],</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-    // Disallow unnecessary concatenation of strings</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-    &quot;no-useless-concat&quot;: 2,</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-    // Disallow unmodified conditions of loops</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-    &quot;no-unmodified-loop-condition&quot;: 2,</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-    // Suggest using arrow functions as callbacks</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-    &quot;prefer-arrow-callback&quot;: [2, { allowNamedFunctions: true }],</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-    // Suggest using the spread operator instead of .apply()</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-    &quot;prefer-spread&quot;: 2,</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineminus">-</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-    // Disallow negated conditions</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineminus">-    &quot;no-negated-condition&quot;: 2,</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineminus">-</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineminus">-    // Enforce a maximum number of statements allowed per line</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineminus">-    &quot;max-statements-per-line&quot;: [2, { max: 2 }],</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineminus">-</span>
<a href="#l2.440"></a><span id="l2.440" class="difflineminus">-    // Disallow arrow functions where they could be confused with comparisons</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-    &quot;no-confusing-arrow&quot;: 2,</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineminus">-</span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-    // Disallow Unnecessary Nested Blocks</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-    &quot;no-lone-blocks&quot;: 2,</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-    // Enforce minimum identifier length</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineminus">-    &quot;id-length&quot;: [</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineminus">-      2,</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineminus">-      {</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineminus">-        min: 3,</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineminus">-        exceptions: [</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineminus">-          /* sorting */</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-          &quot;a&quot;,</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineminus">-          &quot;b&quot;,</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-          /* exceptions */</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineminus">-          &quot;e&quot;,</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineminus">-          &quot;ex&quot;,</span>
<a href="#l2.458"></a><span id="l2.458" class="difflineminus">-          /* loop indices */</span>
<a href="#l2.459"></a><span id="l2.459" class="difflineminus">-          &quot;i&quot;,</span>
<a href="#l2.460"></a><span id="l2.460" class="difflineminus">-          &quot;j&quot;,</span>
<a href="#l2.461"></a><span id="l2.461" class="difflineminus">-          &quot;k&quot;,</span>
<a href="#l2.462"></a><span id="l2.462" class="difflineminus">-          &quot;n&quot;,</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-          /* coordinates */</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-          &quot;x&quot;,</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineminus">-          &quot;y&quot;,</span>
<a href="#l2.466"></a><span id="l2.466" class="difflineminus">-          /* regexes */</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-          &quot;re&quot;,</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-          /* known words */</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-          &quot;rc&quot;,</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineminus">-          &quot;rv&quot;,</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineminus">-          &quot;id&quot;,</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineminus">-          &quot;OS&quot;,</span>
<a href="#l2.473"></a><span id="l2.473" class="difflineminus">-          &quot;os&quot;,</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-          &quot;db&quot;,</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineminus">-          &quot;is&quot;,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineminus">-          /* mail/calendar words */</span>
<a href="#l2.477"></a><span id="l2.477" class="difflineminus">-          &quot;to&quot;,</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-          &quot;cc&quot;,</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-          /* Components */</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-          &quot;Ci&quot;,</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-          &quot;Cc&quot;,</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-          &quot;Cu&quot;,</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-          &quot;Cr&quot;,</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-        ],</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-      },</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-    ],</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineminus">-    // Disallow lexical declarations in case/default clauses</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineminus">-    &quot;no-case-declarations&quot;: 2,</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineminus">-</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineminus">-    // The following rules will not be enabled currently, but are kept here for</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineminus">-    // easier updates in the future.</span>
<a href="#l2.493"></a><span id="l2.493" class="difflineminus">-    &quot;no-else-return&quot;: 0,</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-  },</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-  overrides: [</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-    {</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-      files: [</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-        &quot;base/modules/utils/calAuthUtils.jsm&quot;,</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-        &quot;base/modules/utils/calEmailUtils.jsm&quot;,</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineminus">-        &quot;base/modules/utils/calIteratorUtils.jsm&quot;,</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineminus">-        &quot;base/modules/utils/calItipUtils.jsm&quot;,</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineminus">-        &quot;base/modules/utils/calL10NUtils.jsm&quot;,</span>
<a href="#l2.503"></a><span id="l2.503" class="difflineminus">-        &quot;base/modules/utils/calProviderUtils.jsm&quot;,</span>
<a href="#l2.504"></a><span id="l2.504" class="difflineminus">-        &quot;base/modules/utils/calUnifinderUtils.jsm&quot;,</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-      ],</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-      rules: {</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-        &quot;require-jsdoc&quot;: [2, { require: { ClassDeclaration: true } }],</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-        &quot;valid-jsdoc&quot;: [</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-          2,</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineminus">-          {</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineminus">-            prefer: { returns: &quot;return&quot; },</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineminus">-            preferType: {</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineminus">-              boolean: &quot;Boolean&quot;,</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineminus">-              string: &quot;String&quot;,</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineminus">-              number: &quot;Number&quot;,</span>
<a href="#l2.517"></a><span id="l2.517" class="difflineminus">-              object: &quot;Object&quot;,</span>
<a href="#l2.518"></a><span id="l2.518" class="difflineminus">-              function: &quot;Function&quot;,</span>
<a href="#l2.519"></a><span id="l2.519" class="difflineminus">-              map: &quot;Map&quot;,</span>
<a href="#l2.520"></a><span id="l2.520" class="difflineminus">-              set: &quot;Set&quot;,</span>
<a href="#l2.521"></a><span id="l2.521" class="difflineminus">-              date: &quot;Date&quot;,</span>
<a href="#l2.522"></a><span id="l2.522" class="difflineminus">-            },</span>
<a href="#l2.523"></a><span id="l2.523" class="difflineminus">-            requireReturn: false,</span>
<a href="#l2.524"></a><span id="l2.524" class="difflineminus">-          },</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-        ],</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineminus">-      },</span>
<a href="#l2.527"></a><span id="l2.527" class="difflineminus">-    },</span>
<a href="#l2.528"></a><span id="l2.528" class="difflineminus">-    {</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-      // If it is a test head file, we turn off global unused variable checks, as it</span>
<a href="#l2.530"></a><span id="l2.530" class="difflineminus">-      // would require searching the other test files to know if they are used or not.</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-      // This would be expensive and slow, and it isn't worth it for head files.</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineminus">-      // We could get developers to declare as exported, but that doesn't seem worth it.</span>
<a href="#l2.533"></a><span id="l2.533" class="difflineminus">-      files: [&quot;test/**/head*.js&quot;],</span>
<a href="#l2.534"></a><span id="l2.534" class="difflineminus">-      rules: {</span>
<a href="#l2.535"></a><span id="l2.535" class="difflineminus">-        &quot;no-unused-vars&quot;: [</span>
<a href="#l2.536"></a><span id="l2.536" class="difflineminus">-          &quot;error&quot;,</span>
<a href="#l2.537"></a><span id="l2.537" class="difflineminus">-          {</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-            args: &quot;none&quot;,</span>
<a href="#l2.539"></a><span id="l2.539" class="difflineminus">-            vars: &quot;local&quot;,</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-          },</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-        ],</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineminus">-      },</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineminus">-    },</span>
<a href="#l2.544"></a><span id="l2.544" class="difflineminus">-  ],</span>
<a href="#l2.545"></a><span id="l2.545" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/calendar/base/backend/calBackendLoader.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/calendar/base/backend/calBackendLoader.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -15,21 +15,21 @@ function calBackendLoader() {</span>
<a href="#l3.4"></a><span id="l3.4"> }</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6"> calBackendLoader.prototype = {</span>
<a href="#l3.7"></a><span id="l3.7">   classID: Components.ID(&quot;{0314c271-7168-40fa-802e-83c8c46a557e}&quot;),</span>
<a href="#l3.8"></a><span id="l3.8">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">   loaded: false,</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  observe: function() {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  observe() {</span>
<a href="#l3.14"></a><span id="l3.14">     // Nothing to do here, just need the entry so this is instantiated</span>
<a href="#l3.15"></a><span id="l3.15">   },</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-  loadBackend: function() {</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  loadBackend() {</span>
<a href="#l3.19"></a><span id="l3.19">     if (this.loaded) {</span>
<a href="#l3.20"></a><span id="l3.20">       return;</span>
<a href="#l3.21"></a><span id="l3.21">     }</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">     if (Services.prefs.getBoolPref(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l3.24"></a><span id="l3.24">       let contracts = {</span>
<a href="#l3.25"></a><span id="l3.25">         &quot;@mozilla.org/calendar/datetime;1&quot;: &quot;{36783242-ec94-4d8a-9248-d2679edd55b9}&quot;,</span>
<a href="#l3.26"></a><span id="l3.26">         &quot;@mozilla.org/calendar/ics-service;1&quot;: &quot;{c61cb903-4408-41b3-bc22-da0b27efdfe1}&quot;,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineat">@@ -57,20 +57,20 @@ calBackendLoader.prototype = {</span>
<a href="#l3.28"></a><span id="l3.28">     }</span>
<a href="#l3.29"></a><span id="l3.29"> </span>
<a href="#l3.30"></a><span id="l3.30">     this.loaded = true;</span>
<a href="#l3.31"></a><span id="l3.31">   },</span>
<a href="#l3.32"></a><span id="l3.32"> };</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> function lazyFactoryFor(backendScope, classID) {</span>
<a href="#l3.35"></a><span id="l3.35">   return {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-    createInstance: function(aOuter, aIID) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    createInstance(aOuter, aIID) {</span>
<a href="#l3.38"></a><span id="l3.38">       let realFactory = backendScope.NSGetFactory(classID);</span>
<a href="#l3.39"></a><span id="l3.39">       return realFactory.createInstance(aOuter, aIID);</span>
<a href="#l3.40"></a><span id="l3.40">     },</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-    lockFactory: function(lock) {</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+    lockFactory(lock) {</span>
<a href="#l3.43"></a><span id="l3.43">       let realFactory = backendScope.NSGetFactory(classID);</span>
<a href="#l3.44"></a><span id="l3.44">       return realFactory.lockFactory(lock);</span>
<a href="#l3.45"></a><span id="l3.45">     },</span>
<a href="#l3.46"></a><span id="l3.46">   };</span>
<a href="#l3.47"></a><span id="l3.47"> }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calBackendLoader]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calDateTime.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calDateTime.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -13,20 +13,20 @@ function calDateTime(innerObject) {</span>
<a href="#l4.4"></a><span id="l4.4">   this.innerObject = innerObject || ICAL.Time.epochTime.clone();</span>
<a href="#l4.5"></a><span id="l4.5"> }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> calDateTime.prototype = {</span>
<a href="#l4.8"></a><span id="l4.8">   QueryInterface: ChromeUtils.generateQI([Ci.calIDateTime]),</span>
<a href="#l4.9"></a><span id="l4.9">   classID: Components.ID(&quot;{36783242-ec94-4d8a-9248-d2679edd55b9}&quot;),</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   isMutable: true,</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  makeImmutable() {</span>
<a href="#l4.14"></a><span id="l4.14">     this.isMutable = false;</span>
<a href="#l4.15"></a><span id="l4.15">   },</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  clone: function() {</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  clone() {</span>
<a href="#l4.18"></a><span id="l4.18">     return new calDateTime(this.innerObject.clone());</span>
<a href="#l4.19"></a><span id="l4.19">   },</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">   isValid: true,</span>
<a href="#l4.22"></a><span id="l4.22">   innerObject: null,</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   get nativeTime() {</span>
<a href="#l4.25"></a><span id="l4.25">     return this.innerObject.toUnixTime() * UNIX_TIME_TO_PRTIME;</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineat">@@ -87,29 +87,29 @@ calDateTime.prototype = {</span>
<a href="#l4.27"></a><span id="l4.27">       function(val) {</span>
<a href="#l4.28"></a><span id="l4.28">         this.innerObject.zone = val;</span>
<a href="#l4.29"></a><span id="l4.29">         return val;</span>
<a href="#l4.30"></a><span id="l4.30">       },</span>
<a href="#l4.31"></a><span id="l4.31">       this</span>
<a href="#l4.32"></a><span id="l4.32">     );</span>
<a href="#l4.33"></a><span id="l4.33">   },</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  resetTo: function(year, month, day, hour, minute, second, timezone) {</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+  resetTo(year, month, day, hour, minute, second, timezone) {</span>
<a href="#l4.37"></a><span id="l4.37">     this.innerObject.fromData({</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-      year: year,</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      year,</span>
<a href="#l4.40"></a><span id="l4.40">       month: month + 1,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-      day: day,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-      hour: hour,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-      minute: minute,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineminus">-      second: second,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+      day,</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+      hour,</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+      minute,</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+      second,</span>
<a href="#l4.49"></a><span id="l4.49">     });</span>
<a href="#l4.50"></a><span id="l4.50">     this.timezone = timezone;</span>
<a href="#l4.51"></a><span id="l4.51">   },</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53" class="difflineminus">-  reset: function() {</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+  reset() {</span>
<a href="#l4.55"></a><span id="l4.55">     this.innerObject.reset();</span>
<a href="#l4.56"></a><span id="l4.56">   },</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">   get timezoneOffset() {</span>
<a href="#l4.59"></a><span id="l4.59">     return this.innerObject.utcOffset();</span>
<a href="#l4.60"></a><span id="l4.60">   },</span>
<a href="#l4.61"></a><span id="l4.61">   get isDate() {</span>
<a href="#l4.62"></a><span id="l4.62">     return this.innerObject.isDate;</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineat">@@ -120,17 +120,17 @@ calDateTime.prototype = {</span>
<a href="#l4.64"></a><span id="l4.64"> </span>
<a href="#l4.65"></a><span id="l4.65">   get weekday() {</span>
<a href="#l4.66"></a><span id="l4.66">     return this.innerObject.dayOfWeek() - 1;</span>
<a href="#l4.67"></a><span id="l4.67">   },</span>
<a href="#l4.68"></a><span id="l4.68">   get yearday() {</span>
<a href="#l4.69"></a><span id="l4.69">     return this.innerObject.dayOfYear();</span>
<a href="#l4.70"></a><span id="l4.70">   },</span>
<a href="#l4.71"></a><span id="l4.71"> </span>
<a href="#l4.72"></a><span id="l4.72" class="difflineminus">-  toString: function() {</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+  toString() {</span>
<a href="#l4.74"></a><span id="l4.74">     return this.innerObject.toString();</span>
<a href="#l4.75"></a><span id="l4.75">   },</span>
<a href="#l4.76"></a><span id="l4.76"> </span>
<a href="#l4.77"></a><span id="l4.77">   getInTimezone: unwrap(ICAL.Timezone, function(val) {</span>
<a href="#l4.78"></a><span id="l4.78">     return new calDateTime(this.innerObject.convertToZone(val));</span>
<a href="#l4.79"></a><span id="l4.79">   }),</span>
<a href="#l4.80"></a><span id="l4.80"> </span>
<a href="#l4.81"></a><span id="l4.81">   addDuration: unwrap(ICAL.Duration, function(val) {</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineat">@@ -150,20 +150,19 @@ calDateTime.prototype = {</span>
<a href="#l4.83"></a><span id="l4.83">     if (a.zone == ICAL.Timezone.localTimezone || b.zone == ICAL.Timezone.localTimezone) {</span>
<a href="#l4.84"></a><span id="l4.84">       a = a.convertToZone(ICAL.Timezone.localTimezone);</span>
<a href="#l4.85"></a><span id="l4.85">       b = b.convertToZone(ICAL.Timezone.localTimezone);</span>
<a href="#l4.86"></a><span id="l4.86">     }</span>
<a href="#l4.87"></a><span id="l4.87"> </span>
<a href="#l4.88"></a><span id="l4.88">     if (a.isDate || b.isDate) {</span>
<a href="#l4.89"></a><span id="l4.89">       // Lightning expects 20120101 and 20120101T010101 to be equal</span>
<a href="#l4.90"></a><span id="l4.90">       return a.compareDateOnlyTz(b, a.zone);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-    } else {</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-      // If both are dates or date-times, then just do the normal compare</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-      return a.compare(b);</span>
<a href="#l4.94"></a><span id="l4.94">     }</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+    // If both are dates or date-times, then just do the normal compare</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+    return a.compare(b);</span>
<a href="#l4.97"></a><span id="l4.97">   }),</span>
<a href="#l4.98"></a><span id="l4.98"> </span>
<a href="#l4.99"></a><span id="l4.99">   get startOfWeek() {</span>
<a href="#l4.100"></a><span id="l4.100">     return new calDateTime(this.innerObject.startOfWeek());</span>
<a href="#l4.101"></a><span id="l4.101">   },</span>
<a href="#l4.102"></a><span id="l4.102">   get endOfWeek() {</span>
<a href="#l4.103"></a><span id="l4.103">     return new calDateTime(this.innerObject.endOfWeek());</span>
<a href="#l4.104"></a><span id="l4.104">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calDuration.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calDuration.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -16,20 +16,20 @@ calDuration.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">   get icalDuration() {</span>
<a href="#l5.5"></a><span id="l5.5">     return this.innerObject;</span>
<a href="#l5.6"></a><span id="l5.6">   },</span>
<a href="#l5.7"></a><span id="l5.7">   set icalDuration(val) {</span>
<a href="#l5.8"></a><span id="l5.8">     this.innerObject = val;</span>
<a href="#l5.9"></a><span id="l5.9">   },</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11">   isMutable: true,</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  makeImmutable() {</span>
<a href="#l5.14"></a><span id="l5.14">     this.isMutable = false;</span>
<a href="#l5.15"></a><span id="l5.15">   },</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  clone: function() {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  clone() {</span>
<a href="#l5.18"></a><span id="l5.18">     return new calDuration(this.innerObject.clone());</span>
<a href="#l5.19"></a><span id="l5.19">   },</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   get isNegative() {</span>
<a href="#l5.22"></a><span id="l5.22">     return this.innerObject.isNegative;</span>
<a href="#l5.23"></a><span id="l5.23">   },</span>
<a href="#l5.24"></a><span id="l5.24">   set isNegative(val) {</span>
<a href="#l5.25"></a><span id="l5.25">     this.innerObject.isNegative = val;</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineat">@@ -80,23 +80,23 @@ calDuration.prototype = {</span>
<a href="#l5.27"></a><span id="l5.27">   addDuration: unwrap(ICAL.Duration, function(val) {</span>
<a href="#l5.28"></a><span id="l5.28">     this.innerObject.fromSeconds(this.innerObject.toSeconds() + val.toSeconds());</span>
<a href="#l5.29"></a><span id="l5.29">   }),</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">   compare: unwrap(ICAL.Duration, function(val) {</span>
<a href="#l5.32"></a><span id="l5.32">     return this.innerObject.compare(val);</span>
<a href="#l5.33"></a><span id="l5.33">   }),</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  reset: function() {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  reset() {</span>
<a href="#l5.37"></a><span id="l5.37">     this.innerObject.reset();</span>
<a href="#l5.38"></a><span id="l5.38">   },</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-  normalize: function() {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  normalize() {</span>
<a href="#l5.41"></a><span id="l5.41">     this.innerObject.normalize();</span>
<a href="#l5.42"></a><span id="l5.42">   },</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-  toString: function() {</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+  toString() {</span>
<a href="#l5.45"></a><span id="l5.45">     return this.innerObject.toString();</span>
<a href="#l5.46"></a><span id="l5.46">   },</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   get icalString() {</span>
<a href="#l5.49"></a><span id="l5.49">     return this.innerObject.toString();</span>
<a href="#l5.50"></a><span id="l5.50">   },</span>
<a href="#l5.51"></a><span id="l5.51">   set icalString(val) {</span>
<a href="#l5.52"></a><span id="l5.52">     this.innerObject = ICAL.Duration.fromString(val);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calICSService.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -26,17 +26,17 @@ calIcalProperty.prototype = {</span>
<a href="#l6.4"></a><span id="l6.4">   },</span>
<a href="#l6.5"></a><span id="l6.5">   set icalProperty(val) {</span>
<a href="#l6.6"></a><span id="l6.6">     this.innerObject = val;</span>
<a href="#l6.7"></a><span id="l6.7">   },</span>
<a href="#l6.8"></a><span id="l6.8"> </span>
<a href="#l6.9"></a><span id="l6.9">   get parent() {</span>
<a href="#l6.10"></a><span id="l6.10">     return this.innerObject.parent;</span>
<a href="#l6.11"></a><span id="l6.11">   },</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  toString: function() {</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  toString() {</span>
<a href="#l6.14"></a><span id="l6.14">     return this.innerObject.toICAL();</span>
<a href="#l6.15"></a><span id="l6.15">   },</span>
<a href="#l6.16"></a><span id="l6.16"> </span>
<a href="#l6.17"></a><span id="l6.17">   get value() {</span>
<a href="#l6.18"></a><span id="l6.18">     // Unescaped value for properties of TEXT, escaped otherwise.</span>
<a href="#l6.19"></a><span id="l6.19">     if (this.innerObject.type == &quot;text&quot;) {</span>
<a href="#l6.20"></a><span id="l6.20">       return this.innerObject.getValues().join(&quot;,&quot;);</span>
<a href="#l6.21"></a><span id="l6.21">     }</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -58,19 +58,18 @@ calIcalProperty.prototype = {</span>
<a href="#l6.23"></a><span id="l6.23">       .getValues()</span>
<a href="#l6.24"></a><span id="l6.24">       .map(val =&gt; {</span>
<a href="#l6.25"></a><span id="l6.25">         if (type == &quot;text&quot;) {</span>
<a href="#l6.26"></a><span id="l6.26">           return ICAL.stringify.value(val, type, ICAL.design.icalendar);</span>
<a href="#l6.27"></a><span id="l6.27">         } else if (typeof val == &quot;number&quot; || typeof val == &quot;string&quot;) {</span>
<a href="#l6.28"></a><span id="l6.28">           return val;</span>
<a href="#l6.29"></a><span id="l6.29">         } else if (&quot;toICALString&quot; in val) {</span>
<a href="#l6.30"></a><span id="l6.30">           return val.toICALString();</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-        } else {</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-          return val.toString();</span>
<a href="#l6.33"></a><span id="l6.33">         }</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+        return val.toString();</span>
<a href="#l6.35"></a><span id="l6.35">       })</span>
<a href="#l6.36"></a><span id="l6.36">       .join(&quot;,&quot;);</span>
<a href="#l6.37"></a><span id="l6.37">   },</span>
<a href="#l6.38"></a><span id="l6.38">   set valueAsIcalString(val) {</span>
<a href="#l6.39"></a><span id="l6.39">     let mockLine = this.propertyName + &quot;:&quot; + val;</span>
<a href="#l6.40"></a><span id="l6.40">     let prop = ICAL.Property.fromString(mockLine, ICAL.design.icalendar);</span>
<a href="#l6.41"></a><span id="l6.41"> </span>
<a href="#l6.42"></a><span id="l6.42">     if (this.innerObject.isMultiValue) {</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineat">@@ -111,31 +110,31 @@ calIcalProperty.prototype = {</span>
<a href="#l6.44"></a><span id="l6.44">       this</span>
<a href="#l6.45"></a><span id="l6.45">     );</span>
<a href="#l6.46"></a><span id="l6.46">   },</span>
<a href="#l6.47"></a><span id="l6.47"> </span>
<a href="#l6.48"></a><span id="l6.48">   get propertyName() {</span>
<a href="#l6.49"></a><span id="l6.49">     return this.innerObject.name.toUpperCase();</span>
<a href="#l6.50"></a><span id="l6.50">   },</span>
<a href="#l6.51"></a><span id="l6.51"> </span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-  getParameter: function(name) {</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+  getParameter(name) {</span>
<a href="#l6.54"></a><span id="l6.54">     // Unfortunately getting the &quot;VALUE&quot; parameter won't work, since in</span>
<a href="#l6.55"></a><span id="l6.55">     // jCal it has been translated to the value type id.</span>
<a href="#l6.56"></a><span id="l6.56">     if (name == &quot;VALUE&quot;) {</span>
<a href="#l6.57"></a><span id="l6.57">       let defaultType = this.innerObject.getDefaultType();</span>
<a href="#l6.58"></a><span id="l6.58">       if (this.innerObject.type != defaultType) {</span>
<a href="#l6.59"></a><span id="l6.59">         // Default type doesn't match object type, so we have a VALUE</span>
<a href="#l6.60"></a><span id="l6.60">         // parameter</span>
<a href="#l6.61"></a><span id="l6.61">         return this.innerObject.type.toUpperCase();</span>
<a href="#l6.62"></a><span id="l6.62">       }</span>
<a href="#l6.63"></a><span id="l6.63">     }</span>
<a href="#l6.64"></a><span id="l6.64"> </span>
<a href="#l6.65"></a><span id="l6.65">     return this.innerObject.getParameter(name.toLowerCase());</span>
<a href="#l6.66"></a><span id="l6.66">   },</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-  setParameter: function(name, value) {</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+  setParameter(name, value) {</span>
<a href="#l6.69"></a><span id="l6.69">     // Similar problems for setting the value parameter. Lightning code</span>
<a href="#l6.70"></a><span id="l6.70">     // expects setting the value parameter to just change the value type</span>
<a href="#l6.71"></a><span id="l6.71">     // and attempt to use the previous value as the new one. To do this in</span>
<a href="#l6.72"></a><span id="l6.72">     // ICAL.js we need to save the value, reset the type and then try to</span>
<a href="#l6.73"></a><span id="l6.73">     // set the value again.</span>
<a href="#l6.74"></a><span id="l6.74">     if (name == &quot;VALUE&quot;) {</span>
<a href="#l6.75"></a><span id="l6.75">       let oldValues;</span>
<a href="#l6.76"></a><span id="l6.76">       let type = this.innerObject.type;</span>
<a href="#l6.77"></a><span id="l6.77" class="difflineat">@@ -167,81 +166,80 @@ calIcalProperty.prototype = {</span>
<a href="#l6.78"></a><span id="l6.78">         } else {</span>
<a href="#l6.79"></a><span id="l6.79">           this.innerObject.setValue(oldValues.join(&quot;,&quot;));</span>
<a href="#l6.80"></a><span id="l6.80">         }</span>
<a href="#l6.81"></a><span id="l6.81">       }</span>
<a href="#l6.82"></a><span id="l6.82">     } else {</span>
<a href="#l6.83"></a><span id="l6.83">       this.innerObject.setParameter(name.toLowerCase(), value);</span>
<a href="#l6.84"></a><span id="l6.84">     }</span>
<a href="#l6.85"></a><span id="l6.85">   },</span>
<a href="#l6.86"></a><span id="l6.86" class="difflineminus">-  removeParameter: function(name) {</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineplus">+  removeParameter(name) {</span>
<a href="#l6.88"></a><span id="l6.88">     // Again, VALUE needs special handling. Removing the value parameter is</span>
<a href="#l6.89"></a><span id="l6.89">     // kind of like resetting it to the default type. So find out the</span>
<a href="#l6.90"></a><span id="l6.90">     // default type and then set the value parameter to it.</span>
<a href="#l6.91"></a><span id="l6.91">     if (name == &quot;VALUE&quot;) {</span>
<a href="#l6.92"></a><span id="l6.92">       let propname = this.innerObject.name.toLowerCase();</span>
<a href="#l6.93"></a><span id="l6.93">       if (propname in ICAL.design.icalendar.property) {</span>
<a href="#l6.94"></a><span id="l6.94">         let details = ICAL.design.icalendar.property[propname];</span>
<a href="#l6.95"></a><span id="l6.95">         if (&quot;defaultType&quot; in details) {</span>
<a href="#l6.96"></a><span id="l6.96">           this.setParameter(&quot;VALUE&quot;, details.defaultType);</span>
<a href="#l6.97"></a><span id="l6.97">         }</span>
<a href="#l6.98"></a><span id="l6.98">       }</span>
<a href="#l6.99"></a><span id="l6.99">     } else {</span>
<a href="#l6.100"></a><span id="l6.100">       this.innerObject.removeParameter(name.toLowerCase());</span>
<a href="#l6.101"></a><span id="l6.101">     }</span>
<a href="#l6.102"></a><span id="l6.102">   },</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-  clearXParameters: function() {</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+  clearXParameters() {</span>
<a href="#l6.106"></a><span id="l6.106">     cal.WARN(</span>
<a href="#l6.107"></a><span id="l6.107">       &quot;calIICSService::clearXParameters is no longer implemented, please use removeParameter&quot;</span>
<a href="#l6.108"></a><span id="l6.108">     );</span>
<a href="#l6.109"></a><span id="l6.109">   },</span>
<a href="#l6.110"></a><span id="l6.110"> </span>
<a href="#l6.111"></a><span id="l6.111">   paramIterator: null,</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-  getFirstParameterName: function() {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  getFirstParameterName() {</span>
<a href="#l6.114"></a><span id="l6.114">     let innerObject = this.innerObject;</span>
<a href="#l6.115"></a><span id="l6.115">     this.paramIterator = (function*() {</span>
<a href="#l6.116"></a><span id="l6.116">       let defaultType = innerObject.getDefaultType();</span>
<a href="#l6.117"></a><span id="l6.117">       if (defaultType != innerObject.type) {</span>
<a href="#l6.118"></a><span id="l6.118">         yield &quot;VALUE&quot;;</span>
<a href="#l6.119"></a><span id="l6.119">       }</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121">       let paramNames = Object.keys(innerObject.jCal[1] || {});</span>
<a href="#l6.122"></a><span id="l6.122">       for (let name of paramNames) {</span>
<a href="#l6.123"></a><span id="l6.123">         yield name.toUpperCase();</span>
<a href="#l6.124"></a><span id="l6.124">       }</span>
<a href="#l6.125"></a><span id="l6.125">     })();</span>
<a href="#l6.126"></a><span id="l6.126">     return this.getNextParameterName();</span>
<a href="#l6.127"></a><span id="l6.127">   },</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129" class="difflineminus">-  getNextParameterName: function() {</span>
<a href="#l6.130"></a><span id="l6.130" class="difflineplus">+  getNextParameterName() {</span>
<a href="#l6.131"></a><span id="l6.131">     if (this.paramIterator) {</span>
<a href="#l6.132"></a><span id="l6.132">       let next = this.paramIterator.next();</span>
<a href="#l6.133"></a><span id="l6.133">       if (next.done) {</span>
<a href="#l6.134"></a><span id="l6.134">         this.paramIterator = null;</span>
<a href="#l6.135"></a><span id="l6.135">       }</span>
<a href="#l6.136"></a><span id="l6.136"> </span>
<a href="#l6.137"></a><span id="l6.137">       return next.value;</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-    } else {</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-      return this.getFirstParameterName();</span>
<a href="#l6.140"></a><span id="l6.140">     }</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineplus">+    return this.getFirstParameterName();</span>
<a href="#l6.142"></a><span id="l6.142">   },</span>
<a href="#l6.143"></a><span id="l6.143"> };</span>
<a href="#l6.144"></a><span id="l6.144"> </span>
<a href="#l6.145"></a><span id="l6.145"> function calIcalComponent(innerObject) {</span>
<a href="#l6.146"></a><span id="l6.146">   this.innerObject = innerObject || new ICAL.Component();</span>
<a href="#l6.147"></a><span id="l6.147">   this.wrappedJSObject = this;</span>
<a href="#l6.148"></a><span id="l6.148">   this.mReferencedZones = {};</span>
<a href="#l6.149"></a><span id="l6.149"> }</span>
<a href="#l6.150"></a><span id="l6.150"> </span>
<a href="#l6.151"></a><span id="l6.151"> calIcalComponent.prototype = {</span>
<a href="#l6.152"></a><span id="l6.152">   QueryInterface: ChromeUtils.generateQI([Ci.calIIcalComponent]),</span>
<a href="#l6.153"></a><span id="l6.153">   classID: Components.ID(&quot;{51ac96fd-1279-4439-a85b-6947b37f4cea}&quot;),</span>
<a href="#l6.154"></a><span id="l6.154"> </span>
<a href="#l6.155"></a><span id="l6.155" class="difflineminus">-  clone: function() {</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+  clone() {</span>
<a href="#l6.157"></a><span id="l6.157">     return new calIcalComponent(new ICAL.Component(this.innerObject.toJSON()));</span>
<a href="#l6.158"></a><span id="l6.158">   },</span>
<a href="#l6.159"></a><span id="l6.159"> </span>
<a href="#l6.160"></a><span id="l6.160">   get parent() {</span>
<a href="#l6.161"></a><span id="l6.161">     return wrapGetter(calIcalComponent, this.innerObject.parent);</span>
<a href="#l6.162"></a><span id="l6.162">   },</span>
<a href="#l6.163"></a><span id="l6.163"> </span>
<a href="#l6.164"></a><span id="l6.164">   get icalTimezone() {</span>
<a href="#l6.165"></a><span id="l6.165" class="difflineat">@@ -250,44 +248,43 @@ calIcalComponent.prototype = {</span>
<a href="#l6.166"></a><span id="l6.166">   get icalComponent() {</span>
<a href="#l6.167"></a><span id="l6.167">     return this.innerObject;</span>
<a href="#l6.168"></a><span id="l6.168">   },</span>
<a href="#l6.169"></a><span id="l6.169">   set icalComponent(val) {</span>
<a href="#l6.170"></a><span id="l6.170">     this.innerObject = val;</span>
<a href="#l6.171"></a><span id="l6.171">   },</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173">   componentIterator: null,</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-  getFirstSubcomponent: function(kind) {</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+  getFirstSubcomponent(kind) {</span>
<a href="#l6.176"></a><span id="l6.176">     if (kind == &quot;ANY&quot;) {</span>
<a href="#l6.177"></a><span id="l6.177">       kind = null;</span>
<a href="#l6.178"></a><span id="l6.178">     } else if (kind) {</span>
<a href="#l6.179"></a><span id="l6.179">       kind = kind.toLowerCase();</span>
<a href="#l6.180"></a><span id="l6.180">     }</span>
<a href="#l6.181"></a><span id="l6.181">     let innerObject = this.innerObject;</span>
<a href="#l6.182"></a><span id="l6.182">     this.componentIterator = (function*() {</span>
<a href="#l6.183"></a><span id="l6.183">       let comps = innerObject.getAllSubcomponents(kind);</span>
<a href="#l6.184"></a><span id="l6.184">       if (comps) {</span>
<a href="#l6.185"></a><span id="l6.185">         for (let comp of comps) {</span>
<a href="#l6.186"></a><span id="l6.186">           yield new calIcalComponent(comp);</span>
<a href="#l6.187"></a><span id="l6.187">         }</span>
<a href="#l6.188"></a><span id="l6.188">       }</span>
<a href="#l6.189"></a><span id="l6.189">     })();</span>
<a href="#l6.190"></a><span id="l6.190">     return this.getNextSubcomponent(kind);</span>
<a href="#l6.191"></a><span id="l6.191">   },</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-  getNextSubcomponent: function(kind) {</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineplus">+  getNextSubcomponent(kind) {</span>
<a href="#l6.194"></a><span id="l6.194">     if (this.componentIterator) {</span>
<a href="#l6.195"></a><span id="l6.195">       let next = this.componentIterator.next();</span>
<a href="#l6.196"></a><span id="l6.196">       if (next.done) {</span>
<a href="#l6.197"></a><span id="l6.197">         this.componentIterator = null;</span>
<a href="#l6.198"></a><span id="l6.198">       }</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200">       return next.value;</span>
<a href="#l6.201"></a><span id="l6.201" class="difflineminus">-    } else {</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-      return this.getFirstSubcomponent(kind);</span>
<a href="#l6.203"></a><span id="l6.203">     }</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+    return this.getFirstSubcomponent(kind);</span>
<a href="#l6.205"></a><span id="l6.205">   },</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207">   get componentType() {</span>
<a href="#l6.208"></a><span id="l6.208">     return this.innerObject.name.toUpperCase();</span>
<a href="#l6.209"></a><span id="l6.209">   },</span>
<a href="#l6.210"></a><span id="l6.210"> </span>
<a href="#l6.211"></a><span id="l6.211">   get uid() {</span>
<a href="#l6.212"></a><span id="l6.212">     return this.innerObject.getFirstPropertyValue(&quot;uid&quot;);</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineat">@@ -366,17 +363,17 @@ calIcalComponent.prototype = {</span>
<a href="#l6.214"></a><span id="l6.214">     let prop = this.innerObject.getFirstProperty(&quot;priority&quot;);</span>
<a href="#l6.215"></a><span id="l6.215">     let val = prop ? prop.getFirstValue() : null;</span>
<a href="#l6.216"></a><span id="l6.216">     return val === null ? INVALID_VALUE : val;</span>
<a href="#l6.217"></a><span id="l6.217">   },</span>
<a href="#l6.218"></a><span id="l6.218">   set priority(val) {</span>
<a href="#l6.219"></a><span id="l6.219">     this.innerObject.updatePropertyWithValue(&quot;priority&quot;, val);</span>
<a href="#l6.220"></a><span id="l6.220">   },</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222" class="difflineminus">-  _setTimeAttr: function(propName, val) {</span>
<a href="#l6.223"></a><span id="l6.223" class="difflineplus">+  _setTimeAttr(propName, val) {</span>
<a href="#l6.224"></a><span id="l6.224">     let prop = this.innerObject.updatePropertyWithValue(propName, val);</span>
<a href="#l6.225"></a><span id="l6.225">     if (</span>
<a href="#l6.226"></a><span id="l6.226">       val &amp;&amp;</span>
<a href="#l6.227"></a><span id="l6.227">       val.zone &amp;&amp;</span>
<a href="#l6.228"></a><span id="l6.228">       val.zone != ICAL.Timezone.utcTimezone &amp;&amp;</span>
<a href="#l6.229"></a><span id="l6.229">       val.zone != ICAL.Timezone.localTimezone</span>
<a href="#l6.230"></a><span id="l6.230">     ) {</span>
<a href="#l6.231"></a><span id="l6.231">       prop.setParameter(&quot;TZID&quot;, val.zone.tzid);</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineat">@@ -441,31 +438,31 @@ calIcalComponent.prototype = {</span>
<a href="#l6.233"></a><span id="l6.233"> </span>
<a href="#l6.234"></a><span id="l6.234">   get recurrenceId() {</span>
<a href="#l6.235"></a><span id="l6.235">     return wrapGetter(calDateTime, this.innerObject.getFirstPropertyValue(&quot;recurrence-id&quot;));</span>
<a href="#l6.236"></a><span id="l6.236">   },</span>
<a href="#l6.237"></a><span id="l6.237">   set recurrenceId(val) {</span>
<a href="#l6.238"></a><span id="l6.238">     unwrapSetter(ICAL.Time, val, this._setTimeAttr.bind(this, &quot;recurrence-id&quot;), this);</span>
<a href="#l6.239"></a><span id="l6.239">   },</span>
<a href="#l6.240"></a><span id="l6.240"> </span>
<a href="#l6.241"></a><span id="l6.241" class="difflineminus">-  serializeToICS: function() {</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+  serializeToICS() {</span>
<a href="#l6.243"></a><span id="l6.243">     return this.innerObject.toString() + ICAL.newLineChar;</span>
<a href="#l6.244"></a><span id="l6.244">   },</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineminus">-  toString: function() {</span>
<a href="#l6.246"></a><span id="l6.246" class="difflineplus">+  toString() {</span>
<a href="#l6.247"></a><span id="l6.247">     return this.innerObject.toString();</span>
<a href="#l6.248"></a><span id="l6.248">   },</span>
<a href="#l6.249"></a><span id="l6.249"> </span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-  addSubcomponent: function(comp) {</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+  addSubcomponent(comp) {</span>
<a href="#l6.252"></a><span id="l6.252">     comp.getReferencedTimezones().forEach(this.addTimezoneReference, this);</span>
<a href="#l6.253"></a><span id="l6.253">     let jscomp = unwrapSingle(ICAL.Component, comp);</span>
<a href="#l6.254"></a><span id="l6.254">     this.innerObject.addSubcomponent(jscomp);</span>
<a href="#l6.255"></a><span id="l6.255">   },</span>
<a href="#l6.256"></a><span id="l6.256"> </span>
<a href="#l6.257"></a><span id="l6.257">   propertyIterator: null,</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-  getFirstProperty: function(kind) {</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineplus">+  getFirstProperty(kind) {</span>
<a href="#l6.260"></a><span id="l6.260">     if (kind == &quot;ANY&quot;) {</span>
<a href="#l6.261"></a><span id="l6.261">       kind = null;</span>
<a href="#l6.262"></a><span id="l6.262">     } else if (kind) {</span>
<a href="#l6.263"></a><span id="l6.263">       kind = kind.toLowerCase();</span>
<a href="#l6.264"></a><span id="l6.264">     }</span>
<a href="#l6.265"></a><span id="l6.265">     let innerObject = this.innerObject;</span>
<a href="#l6.266"></a><span id="l6.266">     this.propertyIterator = (function*() {</span>
<a href="#l6.267"></a><span id="l6.267">       let props = innerObject.getAllProperties(kind);</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineat">@@ -487,94 +484,93 @@ calIcalComponent.prototype = {</span>
<a href="#l6.269"></a><span id="l6.269">           yield new calIcalProperty(prop);</span>
<a href="#l6.270"></a><span id="l6.270">         }</span>
<a href="#l6.271"></a><span id="l6.271">       }</span>
<a href="#l6.272"></a><span id="l6.272">     })();</span>
<a href="#l6.273"></a><span id="l6.273"> </span>
<a href="#l6.274"></a><span id="l6.274">     return this.getNextProperty(kind);</span>
<a href="#l6.275"></a><span id="l6.275">   },</span>
<a href="#l6.276"></a><span id="l6.276"> </span>
<a href="#l6.277"></a><span id="l6.277" class="difflineminus">-  getNextProperty: function(kind) {</span>
<a href="#l6.278"></a><span id="l6.278" class="difflineplus">+  getNextProperty(kind) {</span>
<a href="#l6.279"></a><span id="l6.279">     if (this.propertyIterator) {</span>
<a href="#l6.280"></a><span id="l6.280">       let next = this.propertyIterator.next();</span>
<a href="#l6.281"></a><span id="l6.281">       if (next.done) {</span>
<a href="#l6.282"></a><span id="l6.282">         this.propertyIterator = null;</span>
<a href="#l6.283"></a><span id="l6.283">       }</span>
<a href="#l6.284"></a><span id="l6.284"> </span>
<a href="#l6.285"></a><span id="l6.285">       return next.value;</span>
<a href="#l6.286"></a><span id="l6.286" class="difflineminus">-    } else {</span>
<a href="#l6.287"></a><span id="l6.287" class="difflineminus">-      return this.getFirstProperty(kind);</span>
<a href="#l6.288"></a><span id="l6.288">     }</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineplus">+    return this.getFirstProperty(kind);</span>
<a href="#l6.290"></a><span id="l6.290">   },</span>
<a href="#l6.291"></a><span id="l6.291"> </span>
<a href="#l6.292"></a><span id="l6.292" class="difflineminus">-  _getNextParentVCalendar: function() {</span>
<a href="#l6.293"></a><span id="l6.293" class="difflineplus">+  _getNextParentVCalendar() {</span>
<a href="#l6.294"></a><span id="l6.294">     let vcalendar = this; // eslint-disable-line consistent-this</span>
<a href="#l6.295"></a><span id="l6.295">     while (vcalendar &amp;&amp; vcalendar.componentType != &quot;VCALENDAR&quot;) {</span>
<a href="#l6.296"></a><span id="l6.296">       vcalendar = vcalendar.parent;</span>
<a href="#l6.297"></a><span id="l6.297">     }</span>
<a href="#l6.298"></a><span id="l6.298">     return vcalendar || this;</span>
<a href="#l6.299"></a><span id="l6.299">   },</span>
<a href="#l6.300"></a><span id="l6.300"> </span>
<a href="#l6.301"></a><span id="l6.301" class="difflineminus">-  addProperty: function(prop) {</span>
<a href="#l6.302"></a><span id="l6.302" class="difflineplus">+  addProperty(prop) {</span>
<a href="#l6.303"></a><span id="l6.303">     try {</span>
<a href="#l6.304"></a><span id="l6.304">       let datetime = prop.valueAsDatetime;</span>
<a href="#l6.305"></a><span id="l6.305">       if (datetime &amp;&amp; datetime.timezone) {</span>
<a href="#l6.306"></a><span id="l6.306">         this._getNextParentVCalendar().addTimezoneReference(datetime.timezone);</span>
<a href="#l6.307"></a><span id="l6.307">       }</span>
<a href="#l6.308"></a><span id="l6.308">     } catch (e) {</span>
<a href="#l6.309"></a><span id="l6.309">       // If there is an issue adding the timezone reference, don't make</span>
<a href="#l6.310"></a><span id="l6.310">       // that break adding the property.</span>
<a href="#l6.311"></a><span id="l6.311">     }</span>
<a href="#l6.312"></a><span id="l6.312"> </span>
<a href="#l6.313"></a><span id="l6.313">     let jsprop = unwrapSingle(ICAL.Property, prop);</span>
<a href="#l6.314"></a><span id="l6.314">     this.innerObject.addProperty(jsprop);</span>
<a href="#l6.315"></a><span id="l6.315">   },</span>
<a href="#l6.316"></a><span id="l6.316"> </span>
<a href="#l6.317"></a><span id="l6.317" class="difflineminus">-  addTimezoneReference: function(timezone) {</span>
<a href="#l6.318"></a><span id="l6.318" class="difflineplus">+  addTimezoneReference(timezone) {</span>
<a href="#l6.319"></a><span id="l6.319">     if (timezone) {</span>
<a href="#l6.320"></a><span id="l6.320">       if (!(timezone.tzid in this.mReferencedZones) &amp;&amp; this.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l6.321"></a><span id="l6.321">         let comp = timezone.icalComponent;</span>
<a href="#l6.322"></a><span id="l6.322">         if (comp) {</span>
<a href="#l6.323"></a><span id="l6.323">           this.addSubcomponent(comp);</span>
<a href="#l6.324"></a><span id="l6.324">         }</span>
<a href="#l6.325"></a><span id="l6.325">       }</span>
<a href="#l6.326"></a><span id="l6.326"> </span>
<a href="#l6.327"></a><span id="l6.327">       this.mReferencedZones[timezone.tzid] = timezone;</span>
<a href="#l6.328"></a><span id="l6.328">     }</span>
<a href="#l6.329"></a><span id="l6.329">   },</span>
<a href="#l6.330"></a><span id="l6.330"> </span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-  getReferencedTimezones: function(aCount) {</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineplus">+  getReferencedTimezones(aCount) {</span>
<a href="#l6.333"></a><span id="l6.333">     return Object.keys(this.mReferencedZones).map(timezone =&gt; this.mReferencedZones[timezone]);</span>
<a href="#l6.334"></a><span id="l6.334">   },</span>
<a href="#l6.335"></a><span id="l6.335"> </span>
<a href="#l6.336"></a><span id="l6.336" class="difflineminus">-  serializeToICSStream: function() {</span>
<a href="#l6.337"></a><span id="l6.337" class="difflineplus">+  serializeToICSStream() {</span>
<a href="#l6.338"></a><span id="l6.338">     let unicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].createInstance(</span>
<a href="#l6.339"></a><span id="l6.339">       Ci.nsIScriptableUnicodeConverter</span>
<a href="#l6.340"></a><span id="l6.340">     );</span>
<a href="#l6.341"></a><span id="l6.341">     unicodeConverter.charset = &quot;UTF-8&quot;;</span>
<a href="#l6.342"></a><span id="l6.342">     return unicodeConverter.convertToInputStream(this.innerObject.toString());</span>
<a href="#l6.343"></a><span id="l6.343">   },</span>
<a href="#l6.344"></a><span id="l6.344"> };</span>
<a href="#l6.345"></a><span id="l6.345"> </span>
<a href="#l6.346"></a><span id="l6.346"> function calICSService() {</span>
<a href="#l6.347"></a><span id="l6.347">   this.wrappedJSObject = this;</span>
<a href="#l6.348"></a><span id="l6.348"> }</span>
<a href="#l6.349"></a><span id="l6.349"> </span>
<a href="#l6.350"></a><span id="l6.350"> calICSService.prototype = {</span>
<a href="#l6.351"></a><span id="l6.351">   QueryInterface: ChromeUtils.generateQI([Ci.calIICSService]),</span>
<a href="#l6.352"></a><span id="l6.352">   classID: Components.ID(&quot;{c61cb903-4408-41b3-bc22-da0b27efdfe1}&quot;),</span>
<a href="#l6.353"></a><span id="l6.353"> </span>
<a href="#l6.354"></a><span id="l6.354" class="difflineminus">-  parseICS: function(serialized, tzProvider) {</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+  parseICS(serialized, tzProvider) {</span>
<a href="#l6.356"></a><span id="l6.356">     // TODO ical.js doesn't support tz providers, but this is usually null</span>
<a href="#l6.357"></a><span id="l6.357">     // or our timezone service anyway.</span>
<a href="#l6.358"></a><span id="l6.358">     let comp = ICAL.parse(serialized);</span>
<a href="#l6.359"></a><span id="l6.359">     return new calIcalComponent(new ICAL.Component(comp));</span>
<a href="#l6.360"></a><span id="l6.360">   },</span>
<a href="#l6.361"></a><span id="l6.361"> </span>
<a href="#l6.362"></a><span id="l6.362" class="difflineminus">-  parseICSAsync: function(serialized, tzProvider, listener) {</span>
<a href="#l6.363"></a><span id="l6.363" class="difflineplus">+  parseICSAsync(serialized, tzProvider, listener) {</span>
<a href="#l6.364"></a><span id="l6.364">     // There are way too many error checking messages here, but I had so</span>
<a href="#l6.365"></a><span id="l6.365">     // much pain with this method that I don't want it to break again.</span>
<a href="#l6.366"></a><span id="l6.366">     try {</span>
<a href="#l6.367"></a><span id="l6.367">       let worker = new ChromeWorker(&quot;resource:///components/calICSService-worker.js&quot;);</span>
<a href="#l6.368"></a><span id="l6.368">       worker.onmessage = function(event) {</span>
<a href="#l6.369"></a><span id="l6.369">         let rc = Cr.NS_ERROR_FAILURE;</span>
<a href="#l6.370"></a><span id="l6.370">         let icalComp = null;</span>
<a href="#l6.371"></a><span id="l6.371">         try {</span>
<a href="#l6.372"></a><span id="l6.372" class="difflineat">@@ -596,20 +592,20 @@ calICSService.prototype = {</span>
<a href="#l6.373"></a><span id="l6.373">       worker.postMessage(serialized);</span>
<a href="#l6.374"></a><span id="l6.374">     } catch (e) {</span>
<a href="#l6.375"></a><span id="l6.375">       // If an error occurs above, the calling code will hang. Catch the exception just in case</span>
<a href="#l6.376"></a><span id="l6.376">       cal.ERROR(&quot;[calICSService] Error starting parsing worker: &quot; + e);</span>
<a href="#l6.377"></a><span id="l6.377">       listener.onParsingComplete(Cr.NS_ERROR_FAILURE, null);</span>
<a href="#l6.378"></a><span id="l6.378">     }</span>
<a href="#l6.379"></a><span id="l6.379">   },</span>
<a href="#l6.380"></a><span id="l6.380"> </span>
<a href="#l6.381"></a><span id="l6.381" class="difflineminus">-  createIcalComponent: function(kind) {</span>
<a href="#l6.382"></a><span id="l6.382" class="difflineplus">+  createIcalComponent(kind) {</span>
<a href="#l6.383"></a><span id="l6.383">     return new calIcalComponent(new ICAL.Component(kind.toLowerCase()));</span>
<a href="#l6.384"></a><span id="l6.384">   },</span>
<a href="#l6.385"></a><span id="l6.385"> </span>
<a href="#l6.386"></a><span id="l6.386" class="difflineminus">-  createIcalProperty: function(kind) {</span>
<a href="#l6.387"></a><span id="l6.387" class="difflineplus">+  createIcalProperty(kind) {</span>
<a href="#l6.388"></a><span id="l6.388">     return new calIcalProperty(new ICAL.Property(kind.toLowerCase()));</span>
<a href="#l6.389"></a><span id="l6.389">   },</span>
<a href="#l6.390"></a><span id="l6.390"> </span>
<a href="#l6.391"></a><span id="l6.391" class="difflineminus">-  createIcalPropertyFromString: function(str) {</span>
<a href="#l6.392"></a><span id="l6.392" class="difflineplus">+  createIcalPropertyFromString(str) {</span>
<a href="#l6.393"></a><span id="l6.393">     return new calIcalProperty(ICAL.Property.fromString(str.trim(), ICAL.design.icalendar));</span>
<a href="#l6.394"></a><span id="l6.394">   },</span>
<a href="#l6.395"></a><span id="l6.395"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calPeriod.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calPeriod.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -22,20 +22,20 @@ calPeriod.prototype = {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   get icalPeriod() {</span>
<a href="#l7.6"></a><span id="l7.6">     return this.innerObject;</span>
<a href="#l7.7"></a><span id="l7.7">   },</span>
<a href="#l7.8"></a><span id="l7.8">   set icalPeriod(val) {</span>
<a href="#l7.9"></a><span id="l7.9">     this.innerObject = val;</span>
<a href="#l7.10"></a><span id="l7.10">   },</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  makeImmutable() {</span>
<a href="#l7.14"></a><span id="l7.14">     this.isMutable = false;</span>
<a href="#l7.15"></a><span id="l7.15">   },</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-  clone: function() {</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  clone() {</span>
<a href="#l7.18"></a><span id="l7.18">     return new calPeriod(this.innerObject.clone());</span>
<a href="#l7.19"></a><span id="l7.19">   },</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   get start() {</span>
<a href="#l7.22"></a><span id="l7.22">     return wrapGetter(calDateTime, this.innerObject.start);</span>
<a href="#l7.23"></a><span id="l7.23">   },</span>
<a href="#l7.24"></a><span id="l7.24">   set start(rawval) {</span>
<a href="#l7.25"></a><span id="l7.25">     unwrapSetter(</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineat">@@ -73,12 +73,12 @@ calPeriod.prototype = {</span>
<a href="#l7.27"></a><span id="l7.27">     return this.innerObject.toICALString();</span>
<a href="#l7.28"></a><span id="l7.28">   },</span>
<a href="#l7.29"></a><span id="l7.29">   set icalString(val) {</span>
<a href="#l7.30"></a><span id="l7.30">     let dates = ICAL.parse._parseValue(val, &quot;period&quot;, ICAL.design.icalendar);</span>
<a href="#l7.31"></a><span id="l7.31">     this.innerObject = ICAL.Period.fromString(dates.join(&quot;/&quot;));</span>
<a href="#l7.32"></a><span id="l7.32">     return val;</span>
<a href="#l7.33"></a><span id="l7.33">   },</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35" class="difflineminus">-  toString: function() {</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  toString() {</span>
<a href="#l7.37"></a><span id="l7.37">     return this.innerObject.toString();</span>
<a href="#l7.38"></a><span id="l7.38">   },</span>
<a href="#l7.39"></a><span id="l7.39"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/calendar/base/backend/icaljs/calRecurrenceRule.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -24,40 +24,40 @@ calRecurrenceRule.prototype = {</span>
<a href="#l8.4"></a><span id="l8.4">     classDescription: &quot;Calendar Recurrence Rule&quot;,</span>
<a href="#l8.5"></a><span id="l8.5">     classID: calRecurrenceRuleClassID,</span>
<a href="#l8.6"></a><span id="l8.6">     interfaces: calRecurrenceRuleInterfaces,</span>
<a href="#l8.7"></a><span id="l8.7">   }),</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   innerObject: null,</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11">   isMutable: true,</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  makeImmutable() {</span>
<a href="#l8.14"></a><span id="l8.14">     this.isMutable = false;</span>
<a href="#l8.15"></a><span id="l8.15">   },</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-  ensureMutable: function() {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  ensureMutable() {</span>
<a href="#l8.18"></a><span id="l8.18">     if (!this.isMutable) {</span>
<a href="#l8.19"></a><span id="l8.19">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l8.20"></a><span id="l8.20">     }</span>
<a href="#l8.21"></a><span id="l8.21">   },</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineminus">-  clone: function() {</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  clone() {</span>
<a href="#l8.24"></a><span id="l8.24">     return new calRecurrenceRule(new ICAL.Recur(this.innerObject));</span>
<a href="#l8.25"></a><span id="l8.25">   },</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   isNegative: false, // We don't support EXRULE anymore</span>
<a href="#l8.28"></a><span id="l8.28">   get isFinite() {</span>
<a href="#l8.29"></a><span id="l8.29">     return this.innerObject.isFinite();</span>
<a href="#l8.30"></a><span id="l8.30">   },</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  getNextOccurrence: function(aStartTime, aRecId) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  getNextOccurrence(aStartTime, aRecId) {</span>
<a href="#l8.34"></a><span id="l8.34">     aStartTime = unwrapSingle(ICAL.Time, aStartTime);</span>
<a href="#l8.35"></a><span id="l8.35">     aRecId = unwrapSingle(ICAL.Time, aRecId);</span>
<a href="#l8.36"></a><span id="l8.36">     return wrapGetter(calDateTime, this.innerObject.getNextOccurrence(aStartTime, aRecId));</span>
<a href="#l8.37"></a><span id="l8.37">   },</span>
<a href="#l8.38"></a><span id="l8.38"> </span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-  getOccurrences: function(aStartTime, aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+  getOccurrences(aStartTime, aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l8.41"></a><span id="l8.41">     aStartTime = unwrapSingle(ICAL.Time, aStartTime);</span>
<a href="#l8.42"></a><span id="l8.42">     aRangeStart = unwrapSingle(ICAL.Time, aRangeStart);</span>
<a href="#l8.43"></a><span id="l8.43">     aRangeEnd = unwrapSingle(ICAL.Time, aRangeEnd);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">     if (!aMaxCount &amp;&amp; !aRangeEnd &amp;&amp; this.count == 0 &amp;&amp; this.until == null) {</span>
<a href="#l8.46"></a><span id="l8.46">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l8.47"></a><span id="l8.47">     }</span>
<a href="#l8.48"></a><span id="l8.48"> </span>
<a href="#l8.49"></a><span id="l8.49" class="difflineat">@@ -157,19 +157,18 @@ calRecurrenceRule.prototype = {</span>
<a href="#l8.50"></a><span id="l8.50">   set count(val) {</span>
<a href="#l8.51"></a><span id="l8.51">     this.ensureMutable();</span>
<a href="#l8.52"></a><span id="l8.52">     this.innerObject.count = val &amp;&amp; val &gt; 0 ? val : null;</span>
<a href="#l8.53"></a><span id="l8.53">   },</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   get untilDate() {</span>
<a href="#l8.56"></a><span id="l8.56">     if (this.innerObject.until) {</span>
<a href="#l8.57"></a><span id="l8.57">       return new calDateTime(this.innerObject.until);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    } else {</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-      return null;</span>
<a href="#l8.60"></a><span id="l8.60">     }</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    return null;</span>
<a href="#l8.62"></a><span id="l8.62">   },</span>
<a href="#l8.63"></a><span id="l8.63">   set untilDate(rawval) {</span>
<a href="#l8.64"></a><span id="l8.64">     this.ensureMutable();</span>
<a href="#l8.65"></a><span id="l8.65">     unwrapSetter(</span>
<a href="#l8.66"></a><span id="l8.66">       ICAL.Time,</span>
<a href="#l8.67"></a><span id="l8.67">       rawval,</span>
<a href="#l8.68"></a><span id="l8.68">       function(val) {</span>
<a href="#l8.69"></a><span id="l8.69">         if (</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineat">@@ -192,17 +191,17 @@ calRecurrenceRule.prototype = {</span>
<a href="#l8.71"></a><span id="l8.71">   get weekStart() {</span>
<a href="#l8.72"></a><span id="l8.72">     return this.innerObject.wkst - 1;</span>
<a href="#l8.73"></a><span id="l8.73">   },</span>
<a href="#l8.74"></a><span id="l8.74">   set weekStart(val) {</span>
<a href="#l8.75"></a><span id="l8.75">     this.ensureMutable();</span>
<a href="#l8.76"></a><span id="l8.76">     this.innerObject.wkst = val + 1;</span>
<a href="#l8.77"></a><span id="l8.77">   },</span>
<a href="#l8.78"></a><span id="l8.78"> </span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-  getComponent: function(aType) {</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+  getComponent(aType) {</span>
<a href="#l8.81"></a><span id="l8.81">     let values = this.innerObject.getComponent(aType);</span>
<a href="#l8.82"></a><span id="l8.82">     if (aType == &quot;BYDAY&quot;) {</span>
<a href="#l8.83"></a><span id="l8.83">       // BYDAY values are alphanumeric: SU, MO, TU, etc..</span>
<a href="#l8.84"></a><span id="l8.84">       for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l8.85"></a><span id="l8.85">         let match = /^([+-])?(5[0-3]|[1-4][0-9]|[1-9])?(SU|MO|TU|WE|TH|FR|SA)$/.exec(values[i]);</span>
<a href="#l8.86"></a><span id="l8.86">         if (!match) {</span>
<a href="#l8.87"></a><span id="l8.87">           cal.ERROR(&quot;Malformed BYDAY rule\n&quot; + cal.STACK(10));</span>
<a href="#l8.88"></a><span id="l8.88">           return [];</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineat">@@ -217,17 +216,17 @@ calRecurrenceRule.prototype = {</span>
<a href="#l8.90"></a><span id="l8.90">           values[i] *= -1;</span>
<a href="#l8.91"></a><span id="l8.91">         }</span>
<a href="#l8.92"></a><span id="l8.92">       }</span>
<a href="#l8.93"></a><span id="l8.93">     }</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">     return values;</span>
<a href="#l8.96"></a><span id="l8.96">   },</span>
<a href="#l8.97"></a><span id="l8.97"> </span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  setComponent: function(aType, aValues) {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  setComponent(aType, aValues) {</span>
<a href="#l8.100"></a><span id="l8.100">     let values = aValues;</span>
<a href="#l8.101"></a><span id="l8.101">     if (aType == &quot;BYDAY&quot;) {</span>
<a href="#l8.102"></a><span id="l8.102">       // BYDAY values are alphanumeric: SU, MO, TU, etc..</span>
<a href="#l8.103"></a><span id="l8.103">       for (let i = 0; i &lt; values.length; i++) {</span>
<a href="#l8.104"></a><span id="l8.104">         let absValue = Math.abs(values[i]);</span>
<a href="#l8.105"></a><span id="l8.105">         if (absValue &gt; 7) {</span>
<a href="#l8.106"></a><span id="l8.106">           let ordinal = Math.trunc(values[i] / 8);</span>
<a href="#l8.107"></a><span id="l8.107">           let day = ICAL.Recur.numericDayToIcalDay(absValue % 8);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/calendar/base/content/agenda-listbox-utils.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/calendar/base/content/agenda-listbox-utils.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -46,17 +46,17 @@ agendaListbox.init = function() {</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   for (let header of [showTodayHeader, showTomorrowHeader, showSoonHeader]) {</span>
<a href="#l9.6"></a><span id="l9.6">     header.getCheckbox().addEventListener(&quot;CheckboxStateChange&quot;, this.onCheckboxChange, true);</span>
<a href="#l9.7"></a><span id="l9.7">   }</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   // At this point, we're ready and waiting for refreshPeriodDates to be called by TodayPane.</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   let prefObserver = {</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l9.14"></a><span id="l9.14">       switch (aPrefName) {</span>
<a href="#l9.15"></a><span id="l9.15">         case &quot;calendar.agendaListbox.soondays&quot;:</span>
<a href="#l9.16"></a><span id="l9.16">           agendaListbox.soonDays = getSoondaysPreference();</span>
<a href="#l9.17"></a><span id="l9.17">           agendaListbox.updateSoonSection();</span>
<a href="#l9.18"></a><span id="l9.18">           break;</span>
<a href="#l9.19"></a><span id="l9.19">       }</span>
<a href="#l9.20"></a><span id="l9.20">     },</span>
<a href="#l9.21"></a><span id="l9.21">   };</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineat">@@ -383,20 +383,19 @@ agendaListbox.isBefore = function(aItem,</span>
<a href="#l9.23"></a><span id="l9.23">         // starting day of an all-day events spannig multiple days</span>
<a href="#l9.24"></a><span id="l9.24">         return !compItemDate.isDate || aCompItem.duration.days != 1;</span>
<a href="#l9.25"></a><span id="l9.25">       } else if (aItem.endDate.compare(itemDateEndDate) == 0) {</span>
<a href="#l9.26"></a><span id="l9.26">         // ending day of an all-day events spannig multiple days</span>
<a href="#l9.27"></a><span id="l9.27">         return (</span>
<a href="#l9.28"></a><span id="l9.28">           !compItemDate.isDate ||</span>
<a href="#l9.29"></a><span id="l9.29">           (aCompItem.duration.days != 1 &amp;&amp; aCompItem.startDate.compare(compItemDate) != 0)</span>
<a href="#l9.30"></a><span id="l9.30">         );</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      } else {</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-        // intermediate day of an all-day events spannig multiple days</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-        return !compItemDate.isDate;</span>
<a href="#l9.34"></a><span id="l9.34">       }</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineplus">+      // intermediate day of an all-day events spannig multiple days</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineplus">+      return !compItemDate.isDate;</span>
<a href="#l9.37"></a><span id="l9.37">     } else if (aCompItem.startDate.isDate) {</span>
<a href="#l9.38"></a><span id="l9.38">       return false;</span>
<a href="#l9.39"></a><span id="l9.39">     }</span>
<a href="#l9.40"></a><span id="l9.40">   }</span>
<a href="#l9.41"></a><span id="l9.41">   // Non all-day event sorted by date-time. When equal, sorted by start</span>
<a href="#l9.42"></a><span id="l9.42">   // date-time then by end date-time.</span>
<a href="#l9.43"></a><span id="l9.43">   let comp = itemDate.compare(compItemDate);</span>
<a href="#l9.44"></a><span id="l9.44">   if (comp == 0) {</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineat">@@ -610,45 +609,45 @@ agendaListbox.refreshCalendarQuery = fun</span>
<a href="#l9.46"></a><span id="l9.46">   let refreshJob = {</span>
<a href="#l9.47"></a><span id="l9.47">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l9.48"></a><span id="l9.48">     agendaListbox: this,</span>
<a href="#l9.49"></a><span id="l9.49">     calendar: null,</span>
<a href="#l9.50"></a><span id="l9.50">     calId: null,</span>
<a href="#l9.51"></a><span id="l9.51">     operation: null,</span>
<a href="#l9.52"></a><span id="l9.52">     cancelled: false,</span>
<a href="#l9.53"></a><span id="l9.53"> </span>
<a href="#l9.54"></a><span id="l9.54" class="difflineminus">-    onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    onOperationComplete(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l9.56"></a><span id="l9.56">       if (this.agendaListbox.mPendingRefreshJobs.has(this.calId)) {</span>
<a href="#l9.57"></a><span id="l9.57">         this.agendaListbox.mPendingRefreshJobs.delete(this.calId);</span>
<a href="#l9.58"></a><span id="l9.58">       }</span>
<a href="#l9.59"></a><span id="l9.59"> </span>
<a href="#l9.60"></a><span id="l9.60">       if (!this.cancelled) {</span>
<a href="#l9.61"></a><span id="l9.61">         setCurrentEvent();</span>
<a href="#l9.62"></a><span id="l9.62">       }</span>
<a href="#l9.63"></a><span id="l9.63">     },</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-    onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    onGetResult(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l9.67"></a><span id="l9.67">       if (this.cancelled || !Components.isSuccessCode(aStatus)) {</span>
<a href="#l9.68"></a><span id="l9.68">         return;</span>
<a href="#l9.69"></a><span id="l9.69">       }</span>
<a href="#l9.70"></a><span id="l9.70">       for (let item of aItems) {</span>
<a href="#l9.71"></a><span id="l9.71">         this.agendaListbox.addItem(item);</span>
<a href="#l9.72"></a><span id="l9.72">       }</span>
<a href="#l9.73"></a><span id="l9.73">     },</span>
<a href="#l9.74"></a><span id="l9.74"> </span>
<a href="#l9.75"></a><span id="l9.75" class="difflineminus">-    cancel: function() {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+    cancel() {</span>
<a href="#l9.77"></a><span id="l9.77">       this.cancelled = true;</span>
<a href="#l9.78"></a><span id="l9.78">       let operation = cal.wrapInstance(this.operation, Ci.calIOperation);</span>
<a href="#l9.79"></a><span id="l9.79">       if (operation &amp;&amp; operation.isPending) {</span>
<a href="#l9.80"></a><span id="l9.80">         operation.cancel();</span>
<a href="#l9.81"></a><span id="l9.81">         this.operation = null;</span>
<a href="#l9.82"></a><span id="l9.82">       }</span>
<a href="#l9.83"></a><span id="l9.83">     },</span>
<a href="#l9.84"></a><span id="l9.84"> </span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-    execute: function() {</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+    execute() {</span>
<a href="#l9.87"></a><span id="l9.87">       if (!(aStart || aEnd || aCalendar)) {</span>
<a href="#l9.88"></a><span id="l9.88">         this.agendaListbox.removeListItems();</span>
<a href="#l9.89"></a><span id="l9.89">       }</span>
<a href="#l9.90"></a><span id="l9.90"> </span>
<a href="#l9.91"></a><span id="l9.91">       if (!aCalendar) {</span>
<a href="#l9.92"></a><span id="l9.92">         aCalendar = this.agendaListbox.calendar;</span>
<a href="#l9.93"></a><span id="l9.93">       }</span>
<a href="#l9.94"></a><span id="l9.94">       if (!aStart) {</span>
<a href="#l9.95"></a><span id="l9.95" class="difflineat">@@ -850,24 +849,24 @@ agendaListbox.getListItemByHashId = func</span>
<a href="#l9.96"></a><span id="l9.96">   } while (!leaveloop);</span>
<a href="#l9.97"></a><span id="l9.97">   return null;</span>
<a href="#l9.98"></a><span id="l9.98"> };</span>
<a href="#l9.99"></a><span id="l9.99"> </span>
<a href="#l9.100"></a><span id="l9.100"> /**</span>
<a href="#l9.101"></a><span id="l9.101">  * The operation listener used for calendar queries.</span>
<a href="#l9.102"></a><span id="l9.102">  * Implements calIOperationListener.</span>
<a href="#l9.103"></a><span id="l9.103">  */</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-agendaListbox.calendarOpListener = { agendaListbox: agendaListbox };</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+agendaListbox.calendarOpListener = { agendaListbox };</span>
<a href="#l9.106"></a><span id="l9.106"> </span>
<a href="#l9.107"></a><span id="l9.107"> /**</span>
<a href="#l9.108"></a><span id="l9.108">  * Calendar and composite observer, used to keep agenda listbox up to date.</span>
<a href="#l9.109"></a><span id="l9.109">  * @see calIObserver</span>
<a href="#l9.110"></a><span id="l9.110">  * @see calICompositeObserver</span>
<a href="#l9.111"></a><span id="l9.111">  */</span>
<a href="#l9.112"></a><span id="l9.112" class="difflineminus">-agendaListbox.calendarObserver = { agendaListbox: agendaListbox };</span>
<a href="#l9.113"></a><span id="l9.113" class="difflineplus">+agendaListbox.calendarObserver = { agendaListbox };</span>
<a href="#l9.114"></a><span id="l9.114"> </span>
<a href="#l9.115"></a><span id="l9.115"> agendaListbox.calendarObserver.QueryInterface = cal.generateQI([</span>
<a href="#l9.116"></a><span id="l9.116">   Ci.calIObserver,</span>
<a href="#l9.117"></a><span id="l9.117">   Ci.calICompositeObserver,</span>
<a href="#l9.118"></a><span id="l9.118"> ]);</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120"> // calIObserver:</span>
<a href="#l9.121"></a><span id="l9.121"> agendaListbox.calendarObserver.onStartBatch = function() {</span>
<a href="#l9.122"></a><span id="l9.122" class="difflineat">@@ -1068,27 +1067,27 @@ var gEventTimer;</span>
<a href="#l9.123"></a><span id="l9.123">  * @param aMsUntil              The number of milliseconds until the next event</span>
<a href="#l9.124"></a><span id="l9.124">  *                                is current.</span>
<a href="#l9.125"></a><span id="l9.125">  */</span>
<a href="#l9.126"></a><span id="l9.126"> function scheduleNextCurrentEventUpdate(aRefreshCallback, aMsUntil) {</span>
<a href="#l9.127"></a><span id="l9.127">   // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l9.128"></a><span id="l9.128">   // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l9.129"></a><span id="l9.129">   // stuck in an infinite loop.</span>
<a href="#l9.130"></a><span id="l9.130">   let udCallback = {</span>
<a href="#l9.131"></a><span id="l9.131" class="difflineminus">-    notify: function(timer) {</span>
<a href="#l9.132"></a><span id="l9.132" class="difflineplus">+    notify(timer) {</span>
<a href="#l9.133"></a><span id="l9.133">       aRefreshCallback();</span>
<a href="#l9.134"></a><span id="l9.134">     },</span>
<a href="#l9.135"></a><span id="l9.135">   };</span>
<a href="#l9.136"></a><span id="l9.136"> </span>
<a href="#l9.137"></a><span id="l9.137">   if (gEventTimer) {</span>
<a href="#l9.138"></a><span id="l9.138">     gEventTimer.cancel();</span>
<a href="#l9.139"></a><span id="l9.139">   } else {</span>
<a href="#l9.140"></a><span id="l9.140">     // Observer for wake after sleep/hibernate/standby to create new timers and refresh UI</span>
<a href="#l9.141"></a><span id="l9.141">     let wakeObserver = {</span>
<a href="#l9.142"></a><span id="l9.142" class="difflineminus">-      observe: function(aSubject, aTopic, aData) {</span>
<a href="#l9.143"></a><span id="l9.143" class="difflineplus">+      observe(aSubject, aTopic, aData) {</span>
<a href="#l9.144"></a><span id="l9.144">         if (aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l9.145"></a><span id="l9.145">           aRefreshCallback();</span>
<a href="#l9.146"></a><span id="l9.146">         }</span>
<a href="#l9.147"></a><span id="l9.147">       },</span>
<a href="#l9.148"></a><span id="l9.148">     };</span>
<a href="#l9.149"></a><span id="l9.149">     // Add observer</span>
<a href="#l9.150"></a><span id="l9.150">     Services.obs.addObserver(wakeObserver, &quot;wake_notification&quot;);</span>
<a href="#l9.151"></a><span id="l9.151"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/calendar/base/content/calendar-chrome-startup.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -101,36 +101,36 @@ function commonFinishCalendar() {</span>
<a href="#l10.4"></a><span id="l10.4">  * there are more prefs that need to be observed on a global basis that don't fit</span>
<a href="#l10.5"></a><span id="l10.5">  * into the calendar manager.</span>
<a href="#l10.6"></a><span id="l10.6">  */</span>
<a href="#l10.7"></a><span id="l10.7"> var calendarWindowPrefs = {</span>
<a href="#l10.8"></a><span id="l10.8">   /** nsISupports QueryInterface */</span>
<a href="#l10.9"></a><span id="l10.9">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11">   /** Initialize the preference observers */</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  init: function() {</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  init() {</span>
<a href="#l10.14"></a><span id="l10.14">     Services.prefs.addObserver(&quot;calendar.view.useSystemColors&quot;, this);</span>
<a href="#l10.15"></a><span id="l10.15">     Services.ww.registerNotification(this);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">     // Trigger setting pref on all open windows</span>
<a href="#l10.18"></a><span id="l10.18">     this.observe(null, &quot;nsPref:changed&quot;, &quot;calendar.view.useSystemColors&quot;);</span>
<a href="#l10.19"></a><span id="l10.19">   },</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">   /**  Cleanup the preference observers */</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  cleanup: function() {</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+  cleanup() {</span>
<a href="#l10.24"></a><span id="l10.24">     Services.prefs.removeObserver(&quot;calendar.view.useSystemColors&quot;, this);</span>
<a href="#l10.25"></a><span id="l10.25">     Services.ww.unregisterNotification(this);</span>
<a href="#l10.26"></a><span id="l10.26">   },</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">   /**</span>
<a href="#l10.29"></a><span id="l10.29">    * Observer function called when a pref has changed</span>
<a href="#l10.30"></a><span id="l10.30">    *</span>
<a href="#l10.31"></a><span id="l10.31">    * @see nsIObserver</span>
<a href="#l10.32"></a><span id="l10.32">    */</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l10.35"></a><span id="l10.35">     if (aTopic == &quot;nsPref:changed&quot;) {</span>
<a href="#l10.36"></a><span id="l10.36">       switch (aData) {</span>
<a href="#l10.37"></a><span id="l10.37">         case &quot;calendar.view.useSystemColors&quot;: {</span>
<a href="#l10.38"></a><span id="l10.38">           let attributeValue =</span>
<a href="#l10.39"></a><span id="l10.39">             Services.prefs.getBoolPref(&quot;calendar.view.useSystemColors&quot;, false) &amp;&amp; &quot;true&quot;;</span>
<a href="#l10.40"></a><span id="l10.40">           for (let win of Services.ww.getWindowEnumerator()) {</span>
<a href="#l10.41"></a><span id="l10.41">             setElementValue(win.document.documentElement, attributeValue, &quot;systemcolors&quot;);</span>
<a href="#l10.42"></a><span id="l10.42">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/calendar/base/content/calendar-command-controller.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/calendar/base/content/calendar-command-controller.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -105,33 +105,34 @@ var calendarController = {</span>
<a href="#l11.4"></a><span id="l11.4">     calendar_in_foreground: true,</span>
<a href="#l11.5"></a><span id="l11.5">     calendar_in_background: true,</span>
<a href="#l11.6"></a><span id="l11.6">     calendar_mode_calendar: true,</span>
<a href="#l11.7"></a><span id="l11.7">     calendar_mode_task: true,</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9">     cmd_selectAll: true,</span>
<a href="#l11.10"></a><span id="l11.10">   },</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  updateCommands: function() {</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  updateCommands() {</span>
<a href="#l11.14"></a><span id="l11.14">     for (let command in this.commands) {</span>
<a href="#l11.15"></a><span id="l11.15">       goUpdateCommand(command);</span>
<a href="#l11.16"></a><span id="l11.16">     }</span>
<a href="#l11.17"></a><span id="l11.17">   },</span>
<a href="#l11.18"></a><span id="l11.18"> </span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-  supportsCommand: function(aCommand) {</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+  supportsCommand(aCommand) {</span>
<a href="#l11.21"></a><span id="l11.21">     if (aCommand in this.commands) {</span>
<a href="#l11.22"></a><span id="l11.22">       return true;</span>
<a href="#l11.23"></a><span id="l11.23">     }</span>
<a href="#l11.24"></a><span id="l11.24">     if (this.defaultContoller) {</span>
<a href="#l11.25"></a><span id="l11.25">       return this.defaultContoller.supportsCommand(aCommand);</span>
<a href="#l11.26"></a><span id="l11.26">     }</span>
<a href="#l11.27"></a><span id="l11.27">     return false;</span>
<a href="#l11.28"></a><span id="l11.28">   },</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  /* eslint-disable complexity */</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l11.33"></a><span id="l11.33">     switch (aCommand) {</span>
<a href="#l11.34"></a><span id="l11.34">       case &quot;calendar_new_event_command&quot;:</span>
<a href="#l11.35"></a><span id="l11.35">       case &quot;calendar_new_event_context_command&quot;:</span>
<a href="#l11.36"></a><span id="l11.36">       case &quot;calendar_new_event_todaypane_command&quot;:</span>
<a href="#l11.37"></a><span id="l11.37">         return CalendarNewEventsCommandEnabled;</span>
<a href="#l11.38"></a><span id="l11.38">       case &quot;calendar_modify_focused_item_command&quot;:</span>
<a href="#l11.39"></a><span id="l11.39">         return this.item_selected;</span>
<a href="#l11.40"></a><span id="l11.40">       case &quot;calendar_modify_event_command&quot;:</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineat">@@ -275,18 +276,19 @@ var calendarController = {</span>
<a href="#l11.42"></a><span id="l11.42">         }</span>
<a href="#l11.43"></a><span id="l11.43">         if (aCommand in this.commands) {</span>
<a href="#l11.44"></a><span id="l11.44">           // All other commands we support should be enabled by default</span>
<a href="#l11.45"></a><span id="l11.45">           return true;</span>
<a href="#l11.46"></a><span id="l11.46">         }</span>
<a href="#l11.47"></a><span id="l11.47">     }</span>
<a href="#l11.48"></a><span id="l11.48">     return false;</span>
<a href="#l11.49"></a><span id="l11.49">   },</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+  /* eslint-enable complexity */</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l11.54"></a><span id="l11.54">     switch (aCommand) {</span>
<a href="#l11.55"></a><span id="l11.55">       // Common Commands</span>
<a href="#l11.56"></a><span id="l11.56">       case &quot;calendar_new_event_command&quot;:</span>
<a href="#l11.57"></a><span id="l11.57">         createEventWithDialog(</span>
<a href="#l11.58"></a><span id="l11.58">           getSelectedCalendar(),</span>
<a href="#l11.59"></a><span id="l11.59">           cal.dtz.getDefaultStartDate(currentView().selectedDay)</span>
<a href="#l11.60"></a><span id="l11.60">         );</span>
<a href="#l11.61"></a><span id="l11.61">         break;</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineat">@@ -457,35 +459,35 @@ var calendarController = {</span>
<a href="#l11.63"></a><span id="l11.63">         if (this.defaultController &amp;&amp; !this.isCalendarInForeground()) {</span>
<a href="#l11.64"></a><span id="l11.64">           // If calendar is not in foreground, let the default controller take</span>
<a href="#l11.65"></a><span id="l11.65">           // care. If we don't have a default controller, just continue.</span>
<a href="#l11.66"></a><span id="l11.66">           this.defaultController.doCommand(aCommand);</span>
<a href="#l11.67"></a><span id="l11.67">         }</span>
<a href="#l11.68"></a><span id="l11.68">     }</span>
<a href="#l11.69"></a><span id="l11.69">   },</span>
<a href="#l11.70"></a><span id="l11.70"> </span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-  onEvent: function(aEvent) {},</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+  onEvent(aEvent) {},</span>
<a href="#l11.73"></a><span id="l11.73"> </span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">-  isCalendarInForeground: function() {</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+  isCalendarInForeground() {</span>
<a href="#l11.76"></a><span id="l11.76">     return gCurrentMode &amp;&amp; gCurrentMode != &quot;mail&quot;;</span>
<a href="#l11.77"></a><span id="l11.77">   },</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-  isInMode: function(mode) {</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+  isInMode(mode) {</span>
<a href="#l11.81"></a><span id="l11.81">     switch (mode) {</span>
<a href="#l11.82"></a><span id="l11.82">       case &quot;mail&quot;:</span>
<a href="#l11.83"></a><span id="l11.83">         return !this.isCalendarInForeground();</span>
<a href="#l11.84"></a><span id="l11.84">       case &quot;calendar&quot;:</span>
<a href="#l11.85"></a><span id="l11.85">         return gCurrentMode &amp;&amp; gCurrentMode == &quot;calendar&quot;;</span>
<a href="#l11.86"></a><span id="l11.86">       case &quot;task&quot;:</span>
<a href="#l11.87"></a><span id="l11.87">         return gCurrentMode &amp;&amp; gCurrentMode == &quot;task&quot;;</span>
<a href="#l11.88"></a><span id="l11.88">     }</span>
<a href="#l11.89"></a><span id="l11.89">     return false;</span>
<a href="#l11.90"></a><span id="l11.90">   },</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92" class="difflineminus">-  onSelectionChanged: function(aEvent) {</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+  onSelectionChanged(aEvent) {</span>
<a href="#l11.94"></a><span id="l11.94">     let selectedItems = aEvent.detail;</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96">     calendarUpdateDeleteCommand(selectedItems);</span>
<a href="#l11.97"></a><span id="l11.97">     calendarController.item_selected = selectedItems &amp;&amp; selectedItems.length &gt; 0;</span>
<a href="#l11.98"></a><span id="l11.98"> </span>
<a href="#l11.99"></a><span id="l11.99">     let selLength = selectedItems === undefined ? 0 : selectedItems.length;</span>
<a href="#l11.100"></a><span id="l11.100">     let selected_events_readonly = 0;</span>
<a href="#l11.101"></a><span id="l11.101">     let selected_events_requires_network = 0;</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineat">@@ -704,17 +706,17 @@ var calendarController2 = {</span>
<a href="#l11.103"></a><span id="l11.103">     cmd_showQuickFilterBar: true,</span>
<a href="#l11.104"></a><span id="l11.104">   },</span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106">   // These functions can use the same from the calendar controller for now.</span>
<a href="#l11.107"></a><span id="l11.107">   updateCommands: calendarController.updateCommands,</span>
<a href="#l11.108"></a><span id="l11.108">   supportsCommand: calendarController.supportsCommand,</span>
<a href="#l11.109"></a><span id="l11.109">   onEvent: calendarController.onEvent,</span>
<a href="#l11.110"></a><span id="l11.110"> </span>
<a href="#l11.111"></a><span id="l11.111" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l11.113"></a><span id="l11.113">     switch (aCommand) {</span>
<a href="#l11.114"></a><span id="l11.114">       // Thunderbird Commands</span>
<a href="#l11.115"></a><span id="l11.115">       case &quot;cmd_cut&quot;:</span>
<a href="#l11.116"></a><span id="l11.116">         return calendarController.selected_items_writable;</span>
<a href="#l11.117"></a><span id="l11.117">       case &quot;cmd_copy&quot;:</span>
<a href="#l11.118"></a><span id="l11.118">         return calendarController.item_selected;</span>
<a href="#l11.119"></a><span id="l11.119">       case &quot;cmd_paste&quot;:</span>
<a href="#l11.120"></a><span id="l11.120">         return canPaste();</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineat">@@ -736,17 +738,17 @@ var calendarController2 = {</span>
<a href="#l11.122"></a><span id="l11.122">         return false;</span>
<a href="#l11.123"></a><span id="l11.123">       case &quot;cmd_showQuickFilterBar&quot;:</span>
<a href="#l11.124"></a><span id="l11.124">         return calendarController.isInMode(&quot;task&quot;);</span>
<a href="#l11.125"></a><span id="l11.125">       default:</span>
<a href="#l11.126"></a><span id="l11.126">         return true;</span>
<a href="#l11.127"></a><span id="l11.127">     }</span>
<a href="#l11.128"></a><span id="l11.128">   },</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l11.132"></a><span id="l11.132">     if (!this.isCommandEnabled(aCommand)) {</span>
<a href="#l11.133"></a><span id="l11.133">       // doCommand is triggered for cmd_cut even if the command is disabled</span>
<a href="#l11.134"></a><span id="l11.134">       // so we bail out here</span>
<a href="#l11.135"></a><span id="l11.135">       return;</span>
<a href="#l11.136"></a><span id="l11.136">     }</span>
<a href="#l11.137"></a><span id="l11.137">     switch (aCommand) {</span>
<a href="#l11.138"></a><span id="l11.138">       case &quot;cmd_cut&quot;:</span>
<a href="#l11.139"></a><span id="l11.139">         cutToClipboard();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/calendar/base/content/calendar-dnd-listener.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -18,17 +18,17 @@ var { AppConstants } = ChromeUtils.impor</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5"> var itemConversion = {</span>
<a href="#l12.6"></a><span id="l12.6">   /**</span>
<a href="#l12.7"></a><span id="l12.7">    * Converts an email message to a calendar item.</span>
<a href="#l12.8"></a><span id="l12.8">    *</span>
<a href="#l12.9"></a><span id="l12.9">    * @param aItem     The target calIItemBase.</span>
<a href="#l12.10"></a><span id="l12.10">    * @param aMessage  The nsIMsgHdr to convert from.</span>
<a href="#l12.11"></a><span id="l12.11">    */</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  calendarItemFromMessage: function(aItem, aMsgHdr) {</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  calendarItemFromMessage(aItem, aMsgHdr) {</span>
<a href="#l12.14"></a><span id="l12.14">     let msgFolder = aMsgHdr.folder;</span>
<a href="#l12.15"></a><span id="l12.15">     let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17">     aItem.calendar = getSelectedCalendar();</span>
<a href="#l12.18"></a><span id="l12.18">     aItem.title = aMsgHdr.mime2DecodedSubject;</span>
<a href="#l12.19"></a><span id="l12.19"> </span>
<a href="#l12.20"></a><span id="l12.20">     cal.dtz.setDefaultStartEndHour(aItem);</span>
<a href="#l12.21"></a><span id="l12.21">     cal.alarms.setDefaultValues(aItem);</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineat">@@ -57,17 +57,17 @@ var itemConversion = {</span>
<a href="#l12.23"></a><span id="l12.23">   /**</span>
<a href="#l12.24"></a><span id="l12.24">    * Copy base item properties from aItem to aTarget. This includes properties</span>
<a href="#l12.25"></a><span id="l12.25">    * like title, location, description, priority, transparency,</span>
<a href="#l12.26"></a><span id="l12.26">    * attendees, categories, calendar, recurrence and possibly more.</span>
<a href="#l12.27"></a><span id="l12.27">    *</span>
<a href="#l12.28"></a><span id="l12.28">    * @param aItem     The item to copy from.</span>
<a href="#l12.29"></a><span id="l12.29">    * @param aTarget   the item to copy to.</span>
<a href="#l12.30"></a><span id="l12.30">    */</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineminus">-  copyItemBase: function(aItem, aTarget) {</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+  copyItemBase(aItem, aTarget) {</span>
<a href="#l12.33"></a><span id="l12.33">     const copyProps = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;, &quot;DESCRIPTION&quot;, &quot;URL&quot;, &quot;CLASS&quot;, &quot;PRIORITY&quot;];</span>
<a href="#l12.34"></a><span id="l12.34"> </span>
<a href="#l12.35"></a><span id="l12.35">     for (let prop of copyProps) {</span>
<a href="#l12.36"></a><span id="l12.36">       aTarget.setProperty(prop, aItem.getProperty(prop));</span>
<a href="#l12.37"></a><span id="l12.37">     }</span>
<a href="#l12.38"></a><span id="l12.38"> </span>
<a href="#l12.39"></a><span id="l12.39">     // Attendees</span>
<a href="#l12.40"></a><span id="l12.40">     let attendees = aItem.getAttendees();</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineat">@@ -94,17 +94,17 @@ var itemConversion = {</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43">   /**</span>
<a href="#l12.44"></a><span id="l12.44">    * Creates a task from the passed event. This function copies the base item</span>
<a href="#l12.45"></a><span id="l12.45">    * and a few event specific properties (dates, alarms, ...).</span>
<a href="#l12.46"></a><span id="l12.46">    *</span>
<a href="#l12.47"></a><span id="l12.47">    * @param aEvent    The event to copy from.</span>
<a href="#l12.48"></a><span id="l12.48">    * @return          The resulting task.</span>
<a href="#l12.49"></a><span id="l12.49">    */</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-  taskFromEvent: function(aEvent) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+  taskFromEvent(aEvent) {</span>
<a href="#l12.52"></a><span id="l12.52">     let item = cal.createTodo();</span>
<a href="#l12.53"></a><span id="l12.53"> </span>
<a href="#l12.54"></a><span id="l12.54">     this.copyItemBase(aEvent, item);</span>
<a href="#l12.55"></a><span id="l12.55"> </span>
<a href="#l12.56"></a><span id="l12.56">     // Dates and alarms</span>
<a href="#l12.57"></a><span id="l12.57">     if (!aEvent.startDate.isDate &amp;&amp; !aEvent.endDate.isDate) {</span>
<a href="#l12.58"></a><span id="l12.58">       // Dates</span>
<a href="#l12.59"></a><span id="l12.59">       item.entryDate = aEvent.startDate.clone();</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineat">@@ -132,17 +132,17 @@ var itemConversion = {</span>
<a href="#l12.61"></a><span id="l12.61">   /**</span>
<a href="#l12.62"></a><span id="l12.62">    * Creates an event from the passed task. This function copies the base item</span>
<a href="#l12.63"></a><span id="l12.63">    * and a few task specific properties (dates, alarms, ...). If the task has</span>
<a href="#l12.64"></a><span id="l12.64">    * no due date, the default event length is used.</span>
<a href="#l12.65"></a><span id="l12.65">    *</span>
<a href="#l12.66"></a><span id="l12.66">    * @param aTask     The task to copy from.</span>
<a href="#l12.67"></a><span id="l12.67">    * @return          The resulting event.</span>
<a href="#l12.68"></a><span id="l12.68">    */</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineminus">-  eventFromTask: function(aTask) {</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+  eventFromTask(aTask) {</span>
<a href="#l12.71"></a><span id="l12.71">     let item = cal.createEvent();</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">     this.copyItemBase(aTask, item);</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">     // Dates and alarms</span>
<a href="#l12.76"></a><span id="l12.76">     item.startDate = aTask.entryDate;</span>
<a href="#l12.77"></a><span id="l12.77">     if (!item.startDate) {</span>
<a href="#l12.78"></a><span id="l12.78">       if (aTask.dueDate) {</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineat">@@ -186,33 +186,33 @@ var itemConversion = {</span>
<a href="#l12.80"></a><span id="l12.80">  * @class calDNDBaseObserver</span>
<a href="#l12.81"></a><span id="l12.81">  */</span>
<a href="#l12.82"></a><span id="l12.82"> function calDNDBaseObserver() {</span>
<a href="#l12.83"></a><span id="l12.83">   cal.ASSERT(false, &quot;Inheriting objects call calDNDBaseObserver!&quot;);</span>
<a href="#l12.84"></a><span id="l12.84"> }</span>
<a href="#l12.85"></a><span id="l12.85"> </span>
<a href="#l12.86"></a><span id="l12.86"> calDNDBaseObserver.prototype = {</span>
<a href="#l12.87"></a><span id="l12.87">   // initialize this class's members</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineminus">-  initBase: function() {},</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  initBase() {},</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  getSupportedFlavours: function() {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  getSupportedFlavours() {</span>
<a href="#l12.93"></a><span id="l12.93">     let flavourSet = new FlavourSet();</span>
<a href="#l12.94"></a><span id="l12.94">     flavourSet.appendFlavour(&quot;text/calendar&quot;);</span>
<a href="#l12.95"></a><span id="l12.95">     flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l12.96"></a><span id="l12.96">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l12.97"></a><span id="l12.97">     flavourSet.appendFlavour(&quot;text/unicode&quot;);</span>
<a href="#l12.98"></a><span id="l12.98">     flavourSet.appendFlavour(&quot;application/x-moz-file&quot;);</span>
<a href="#l12.99"></a><span id="l12.99">     return flavourSet;</span>
<a href="#l12.100"></a><span id="l12.100">   },</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102">   /**</span>
<a href="#l12.103"></a><span id="l12.103">    * Action to take when dropping the event.</span>
<a href="#l12.104"></a><span id="l12.104">    */</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  onDrop: function(aEvent, aTransferData, aDragSession) {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  onDrop(aEvent, aTransferData, aDragSession) {</span>
<a href="#l12.108"></a><span id="l12.108">     let transferable = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Ci.nsITransferable);</span>
<a href="#l12.109"></a><span id="l12.109">     transferable.init(null);</span>
<a href="#l12.110"></a><span id="l12.110">     transferable.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l12.111"></a><span id="l12.111">     transferable.addDataFlavor(&quot;text/x-moz-url&quot;);</span>
<a href="#l12.112"></a><span id="l12.112">     transferable.addDataFlavor(&quot;text/x-moz-message&quot;);</span>
<a href="#l12.113"></a><span id="l12.113">     transferable.addDataFlavor(&quot;text/unicode&quot;);</span>
<a href="#l12.114"></a><span id="l12.114">     transferable.addDataFlavor(&quot;application/x-moz-file&quot;);</span>
<a href="#l12.115"></a><span id="l12.115"> </span>
<a href="#l12.116"></a><span id="l12.116" class="difflineat">@@ -284,17 +284,17 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l12.117"></a><span id="l12.117">           Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l12.118"></a><span id="l12.118">           Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l12.119"></a><span id="l12.119">         );</span>
<a href="#l12.120"></a><span id="l12.120">         channel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l12.121"></a><span id="l12.121"> </span>
<a href="#l12.122"></a><span id="l12.122">         let self = this;</span>
<a href="#l12.123"></a><span id="l12.123"> </span>
<a href="#l12.124"></a><span id="l12.124">         let listener = {</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineminus">-          onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+          onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l12.127"></a><span id="l12.127">             let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l12.128"></a><span id="l12.128">             let encoding = channel.contentCharset || &quot;utf-8&quot;;</span>
<a href="#l12.129"></a><span id="l12.129">             let result = aResultLength</span>
<a href="#l12.130"></a><span id="l12.130">               ? new TextDecoder(encoding).decode(Uint8Array.from(aResult))</span>
<a href="#l12.131"></a><span id="l12.131">               : &quot;&quot;;</span>
<a href="#l12.132"></a><span id="l12.132">             parser.parseString(result);</span>
<a href="#l12.133"></a><span id="l12.133">             self.onDropItems(parser.getItems().concat(parser.getParentlessItems()));</span>
<a href="#l12.134"></a><span id="l12.134">           },</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineat">@@ -314,24 +314,24 @@ calDNDBaseObserver.prototype = {</span>
<a href="#l12.136"></a><span id="l12.136">         break;</span>
<a href="#l12.137"></a><span id="l12.137">       }</span>
<a href="#l12.138"></a><span id="l12.138">       default:</span>
<a href="#l12.139"></a><span id="l12.139">         cal.ASSERT(false, &quot;unknown data flavour:&quot; + bestFlavor.value + &quot;\n&quot;);</span>
<a href="#l12.140"></a><span id="l12.140">         break;</span>
<a href="#l12.141"></a><span id="l12.141">     }</span>
<a href="#l12.142"></a><span id="l12.142">   },</span>
<a href="#l12.143"></a><span id="l12.143"> </span>
<a href="#l12.144"></a><span id="l12.144" class="difflineminus">-  onDragStart: function(aEvent, aTransferData, aDragAction) {},</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineminus">-  onDragOver: function(aEvent, aFlavor, aDragSession) {},</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  onDragExit: function(aEvent, aDragSession) {},</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  onDragStart(aEvent, aTransferData, aDragAction) {},</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+  onDragOver(aEvent, aFlavor, aDragSession) {},</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+  onDragExit(aEvent, aDragSession) {},</span>
<a href="#l12.150"></a><span id="l12.150"> </span>
<a href="#l12.151"></a><span id="l12.151" class="difflineminus">-  onDropItems: function(aItems) {},</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineminus">-  onDropMessage: function(aMessage) {},</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+  onDropItems(aItems) {},</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+  onDropMessage(aMessage) {},</span>
<a href="#l12.155"></a><span id="l12.155"> </span>
<a href="#l12.156"></a><span id="l12.156" class="difflineminus">-  retrieveURLFromData: function(aData, aFlavor) {</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+  retrieveURLFromData(aData, aFlavor) {</span>
<a href="#l12.158"></a><span id="l12.158">     switch (aFlavor) {</span>
<a href="#l12.159"></a><span id="l12.159">       case &quot;text/unicode&quot;: {</span>
<a href="#l12.160"></a><span id="l12.160">         let data = aData.toString();</span>
<a href="#l12.161"></a><span id="l12.161">         let separator = data.indexOf(&quot;\n&quot;);</span>
<a href="#l12.162"></a><span id="l12.162">         if (separator != -1) {</span>
<a href="#l12.163"></a><span id="l12.163">           data = data.substr(0, separator);</span>
<a href="#l12.164"></a><span id="l12.164">         }</span>
<a href="#l12.165"></a><span id="l12.165">         return data;</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineat">@@ -360,17 +360,17 @@ calViewDNDObserver.prototype = {</span>
<a href="#l12.167"></a><span id="l12.167"> </span>
<a href="#l12.168"></a><span id="l12.168">   /**</span>
<a href="#l12.169"></a><span id="l12.169">    * calViewDNDObserver::onDropItems</span>
<a href="#l12.170"></a><span id="l12.170">    *</span>
<a href="#l12.171"></a><span id="l12.171">    * Gets called in case we're dropping an array of items</span>
<a href="#l12.172"></a><span id="l12.172">    * on one of the calendar views. In this case we just</span>
<a href="#l12.173"></a><span id="l12.173">    * try to add these items to the currently selected calendar.</span>
<a href="#l12.174"></a><span id="l12.174">    */</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineminus">-  onDropItems: function(aItems) {</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+  onDropItems(aItems) {</span>
<a href="#l12.177"></a><span id="l12.177">     let destCal = getSelectedCalendar();</span>
<a href="#l12.178"></a><span id="l12.178">     startBatchTransaction();</span>
<a href="#l12.179"></a><span id="l12.179">     // we fall back explicitly to the popup to ask whether to send a</span>
<a href="#l12.180"></a><span id="l12.180">     // notification to participants if required</span>
<a href="#l12.181"></a><span id="l12.181">     let extResp = { responseMode: Ci.calIItipItem.USER };</span>
<a href="#l12.182"></a><span id="l12.182">     try {</span>
<a href="#l12.183"></a><span id="l12.183">       for (let item of aItems) {</span>
<a href="#l12.184"></a><span id="l12.184">         doTransaction(&quot;add&quot;, item, destCal, null, null, extResp);</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineat">@@ -398,17 +398,17 @@ calMailButtonDNDObserver.prototype = {</span>
<a href="#l12.186"></a><span id="l12.186">   /**</span>
<a href="#l12.187"></a><span id="l12.187">    * calMailButtonDNDObserver::onDropItems</span>
<a href="#l12.188"></a><span id="l12.188">    *</span>
<a href="#l12.189"></a><span id="l12.189">    * Gets called in case we're dropping an array of items</span>
<a href="#l12.190"></a><span id="l12.190">    * on the 'mail mode'-button.</span>
<a href="#l12.191"></a><span id="l12.191">    *</span>
<a href="#l12.192"></a><span id="l12.192">    * @param aItems        An array of items to handle.</span>
<a href="#l12.193"></a><span id="l12.193">    */</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineminus">-  onDropItems: function(aItems) {</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  onDropItems(aItems) {</span>
<a href="#l12.196"></a><span id="l12.196">     if (aItems &amp;&amp; aItems.length &gt; 0) {</span>
<a href="#l12.197"></a><span id="l12.197">       let item = aItems[0];</span>
<a href="#l12.198"></a><span id="l12.198">       let identity = item.calendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l12.199"></a><span id="l12.199">       let parties = item.getAttendees();</span>
<a href="#l12.200"></a><span id="l12.200">       if (item.organizer) {</span>
<a href="#l12.201"></a><span id="l12.201">         parties.push(item.organizer);</span>
<a href="#l12.202"></a><span id="l12.202">       }</span>
<a href="#l12.203"></a><span id="l12.203">       if (identity) {</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineat">@@ -428,17 +428,17 @@ calMailButtonDNDObserver.prototype = {</span>
<a href="#l12.205"></a><span id="l12.205">   /**</span>
<a href="#l12.206"></a><span id="l12.206">    * calMailButtonDNDObserver::onDropMessage</span>
<a href="#l12.207"></a><span id="l12.207">    *</span>
<a href="#l12.208"></a><span id="l12.208">    * Gets called in case we're dropping a message</span>
<a href="#l12.209"></a><span id="l12.209">    * on the 'mail mode'-button.</span>
<a href="#l12.210"></a><span id="l12.210">    *</span>
<a href="#l12.211"></a><span id="l12.211">    * @param aMessage     The message to handle.</span>
<a href="#l12.212"></a><span id="l12.212">    */</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineminus">-  onDropMessage: function(aMessage) {},</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+  onDropMessage(aMessage) {},</span>
<a href="#l12.215"></a><span id="l12.215"> };</span>
<a href="#l12.216"></a><span id="l12.216"> </span>
<a href="#l12.217"></a><span id="l12.217"> /**</span>
<a href="#l12.218"></a><span id="l12.218">  * calCalendarButtonDNDObserver::calCalendarButtonDNDObserver</span>
<a href="#l12.219"></a><span id="l12.219">  *</span>
<a href="#l12.220"></a><span id="l12.220">  * Drag'n'drop handler for the 'calendar mode'-button. This handler is</span>
<a href="#l12.221"></a><span id="l12.221">  * derived from the base handler and just implements specific actions.</span>
<a href="#l12.222"></a><span id="l12.222">  */</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineat">@@ -453,17 +453,17 @@ calCalendarButtonDNDObserver.prototype =</span>
<a href="#l12.224"></a><span id="l12.224">   /**</span>
<a href="#l12.225"></a><span id="l12.225">    * calCalendarButtonDNDObserver::onDropItems</span>
<a href="#l12.226"></a><span id="l12.226">    *</span>
<a href="#l12.227"></a><span id="l12.227">    * Gets called in case we're dropping an array of items</span>
<a href="#l12.228"></a><span id="l12.228">    * on the 'calendar mode'-button.</span>
<a href="#l12.229"></a><span id="l12.229">    *</span>
<a href="#l12.230"></a><span id="l12.230">    * @param aItems        An array of items to handle.</span>
<a href="#l12.231"></a><span id="l12.231">    */</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineminus">-  onDropItems: function(aItems) {</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+  onDropItems(aItems) {</span>
<a href="#l12.234"></a><span id="l12.234">     for (let item of aItems) {</span>
<a href="#l12.235"></a><span id="l12.235">       let newItem = item;</span>
<a href="#l12.236"></a><span id="l12.236">       if (cal.item.isToDo(item)) {</span>
<a href="#l12.237"></a><span id="l12.237">         newItem = itemConversion.eventFromTask(item);</span>
<a href="#l12.238"></a><span id="l12.238">       }</span>
<a href="#l12.239"></a><span id="l12.239">       createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l12.240"></a><span id="l12.240">     }</span>
<a href="#l12.241"></a><span id="l12.241">   },</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineat">@@ -473,17 +473,17 @@ calCalendarButtonDNDObserver.prototype =</span>
<a href="#l12.243"></a><span id="l12.243">    *</span>
<a href="#l12.244"></a><span id="l12.244">    * Gets called in case we're dropping a message on the</span>
<a href="#l12.245"></a><span id="l12.245">    * 'calendar mode'-button. In this case we create a new</span>
<a href="#l12.246"></a><span id="l12.246">    * event from the mail. We open the default event dialog</span>
<a href="#l12.247"></a><span id="l12.247">    * and just use the subject of the message as the event title.</span>
<a href="#l12.248"></a><span id="l12.248">    *</span>
<a href="#l12.249"></a><span id="l12.249">    * @param aMessage     The message to handle.</span>
<a href="#l12.250"></a><span id="l12.250">    */</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineminus">-  onDropMessage: function(aMessage) {</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+  onDropMessage(aMessage) {</span>
<a href="#l12.253"></a><span id="l12.253">     let newItem = cal.createEvent();</span>
<a href="#l12.254"></a><span id="l12.254">     itemConversion.calendarItemFromMessage(newItem, aMessage);</span>
<a href="#l12.255"></a><span id="l12.255">     createEventWithDialog(null, null, null, null, newItem);</span>
<a href="#l12.256"></a><span id="l12.256">   },</span>
<a href="#l12.257"></a><span id="l12.257"> };</span>
<a href="#l12.258"></a><span id="l12.258"> </span>
<a href="#l12.259"></a><span id="l12.259"> /**</span>
<a href="#l12.260"></a><span id="l12.260">  * calTaskButtonDNDObserver::calTaskButtonDNDObserver</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineat">@@ -502,17 +502,17 @@ calTaskButtonDNDObserver.prototype = {</span>
<a href="#l12.262"></a><span id="l12.262">   /**</span>
<a href="#l12.263"></a><span id="l12.263">    * calTaskButtonDNDObserver::onDropItems</span>
<a href="#l12.264"></a><span id="l12.264">    *</span>
<a href="#l12.265"></a><span id="l12.265">    * Gets called in case we're dropping an array of items</span>
<a href="#l12.266"></a><span id="l12.266">    * on the 'task mode'-button.</span>
<a href="#l12.267"></a><span id="l12.267">    *</span>
<a href="#l12.268"></a><span id="l12.268">    * @param aItems        An array of items to handle.</span>
<a href="#l12.269"></a><span id="l12.269">    */</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineminus">-  onDropItems: function(aItems) {</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+  onDropItems(aItems) {</span>
<a href="#l12.272"></a><span id="l12.272">     for (let item of aItems) {</span>
<a href="#l12.273"></a><span id="l12.273">       let newItem = item;</span>
<a href="#l12.274"></a><span id="l12.274">       if (cal.item.isEvent(item)) {</span>
<a href="#l12.275"></a><span id="l12.275">         newItem = itemConversion.taskFromEvent(item);</span>
<a href="#l12.276"></a><span id="l12.276">       }</span>
<a href="#l12.277"></a><span id="l12.277">       createTodoWithDialog(null, null, null, newItem);</span>
<a href="#l12.278"></a><span id="l12.278">     }</span>
<a href="#l12.279"></a><span id="l12.279">   },</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineat">@@ -520,17 +520,17 @@ calTaskButtonDNDObserver.prototype = {</span>
<a href="#l12.281"></a><span id="l12.281">   /**</span>
<a href="#l12.282"></a><span id="l12.282">    * calTaskButtonDNDObserver::onDropMessage</span>
<a href="#l12.283"></a><span id="l12.283">    *</span>
<a href="#l12.284"></a><span id="l12.284">    * Gets called in case we're dropping a message</span>
<a href="#l12.285"></a><span id="l12.285">    * on the 'task mode'-button.</span>
<a href="#l12.286"></a><span id="l12.286">    *</span>
<a href="#l12.287"></a><span id="l12.287">    * @param aMessage     The message to handle.</span>
<a href="#l12.288"></a><span id="l12.288">    */</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineminus">-  onDropMessage: function(aMessage) {</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+  onDropMessage(aMessage) {</span>
<a href="#l12.291"></a><span id="l12.291">     let todo = cal.createTodo();</span>
<a href="#l12.292"></a><span id="l12.292">     itemConversion.calendarItemFromMessage(todo, aMessage);</span>
<a href="#l12.293"></a><span id="l12.293">     createTodoWithDialog(null, null, null, todo);</span>
<a href="#l12.294"></a><span id="l12.294">   },</span>
<a href="#l12.295"></a><span id="l12.295"> };</span>
<a href="#l12.296"></a><span id="l12.296"> </span>
<a href="#l12.297"></a><span id="l12.297"> /**</span>
<a href="#l12.298"></a><span id="l12.298">  * Invoke a drag session for the passed item. The passed box will be used as a</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineat">@@ -543,17 +543,17 @@ function invokeEventDragSession(aItem, a</span>
<a href="#l12.300"></a><span id="l12.300">   let transfer = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Ci.nsITransferable);</span>
<a href="#l12.301"></a><span id="l12.301">   transfer.init(null);</span>
<a href="#l12.302"></a><span id="l12.302">   transfer.addDataFlavor(&quot;text/calendar&quot;);</span>
<a href="#l12.303"></a><span id="l12.303"> </span>
<a href="#l12.304"></a><span id="l12.304">   let flavourProvider = {</span>
<a href="#l12.305"></a><span id="l12.305">     QueryInterface: ChromeUtils.generateQI([Ci.nsIFlavorDataProvider]),</span>
<a href="#l12.306"></a><span id="l12.306"> </span>
<a href="#l12.307"></a><span id="l12.307">     item: aItem,</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineminus">-    getFlavorData: function(aInTransferable, aInFlavor, aOutData) {</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+    getFlavorData(aInTransferable, aInFlavor, aOutData) {</span>
<a href="#l12.310"></a><span id="l12.310">       if (</span>
<a href="#l12.311"></a><span id="l12.311">         aInFlavor == &quot;application/vnd.x-moz-cal-event&quot; ||</span>
<a href="#l12.312"></a><span id="l12.312">         aInFlavor == &quot;application/vnd.x-moz-cal-task&quot;</span>
<a href="#l12.313"></a><span id="l12.313">       ) {</span>
<a href="#l12.314"></a><span id="l12.314">         aOutData.value = aItem;</span>
<a href="#l12.315"></a><span id="l12.315">       } else {</span>
<a href="#l12.316"></a><span id="l12.316">         cal.ASSERT(false, &quot;error:&quot; + aInFlavor);</span>
<a href="#l12.317"></a><span id="l12.317">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/calendar/base/content/calendar-event-column.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/calendar/base/content/calendar-event-column.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -425,18 +425,18 @@</span>
<a href="#l13.4"></a><span id="l13.4">       // if the event starts one or more days before the date of this column.</span>
<a href="#l13.5"></a><span id="l13.5">       let realStart = (durstart.days * 24 + durstart.hours) * 60 + durstart.minutes;</span>
<a href="#l13.6"></a><span id="l13.6">       realStart = durstart.isNegative ? -1 * realStart : realStart;</span>
<a href="#l13.7"></a><span id="l13.7">       let realEnd = (durend.days * 24 + durend.hours) * 60 + durend.minutes;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9">       return {</span>
<a href="#l13.10"></a><span id="l13.10">         start: startHour * 60 + startMinute,</span>
<a href="#l13.11"></a><span id="l13.11">         end: endHour * 60 + endMinute,</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-        realStart: realStart,</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-        realEnd: realEnd,</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+        realStart,</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+        realEnd,</span>
<a href="#l13.16"></a><span id="l13.16">       };</span>
<a href="#l13.17"></a><span id="l13.17">     }</span>
<a href="#l13.18"></a><span id="l13.18"> </span>
<a href="#l13.19"></a><span id="l13.19">     createChunk(occurrence) {</span>
<a href="#l13.20"></a><span id="l13.20">       let mins = this.getStartEndMinutesForOccurrence(occurrence);</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22">       let chunk = {</span>
<a href="#l13.23"></a><span id="l13.23">         startMinute: mins.start,</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineat">@@ -1101,19 +1101,19 @@</span>
<a href="#l13.25"></a><span id="l13.25">         startMin = this.mEndMin - (reminder ? reminder : this.mEndMin);</span>
<a href="#l13.26"></a><span id="l13.26">       } else {</span>
<a href="#l13.27"></a><span id="l13.27">         startMin = start;</span>
<a href="#l13.28"></a><span id="l13.28">       }</span>
<a href="#l13.29"></a><span id="l13.29">       shadows += Math.floor(end / this.mEndMin);</span>
<a href="#l13.30"></a><span id="l13.30"> </span>
<a href="#l13.31"></a><span id="l13.31">       // Return values needed to build the shadows while dragging.</span>
<a href="#l13.32"></a><span id="l13.32">       return {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-        shadows: shadows, // Number of shadows.</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-        offset: offset, // Offset first&lt;-&gt;selected shadows.</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-        startMin: startMin, // First shadow start minute.</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineplus">+        shadows, // Number of shadows.</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineplus">+        offset, // Offset first&lt;-&gt;selected shadows.</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineplus">+        startMin, // First shadow start minute.</span>
<a href="#l13.39"></a><span id="l13.39">         endMin: end % this.mEndMin, // Last shadow end minute.</span>
<a href="#l13.40"></a><span id="l13.40">       };</span>
<a href="#l13.41"></a><span id="l13.41">     }</span>
<a href="#l13.42"></a><span id="l13.42"> </span>
<a href="#l13.43"></a><span id="l13.43">     firstLastShadowColumns(offset, shadows) {</span>
<a href="#l13.44"></a><span id="l13.44">       let firstCol = this; // eslint-disable-line consistent-this</span>
<a href="#l13.45"></a><span id="l13.45">       let lastCol = this; // eslint-disable-line consistent-this</span>
<a href="#l13.46"></a><span id="l13.46">       let firstIndex = offset == null ? this.mDragState.offset : offset;</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineat">@@ -1127,20 +1127,20 @@</span>
<a href="#l13.48"></a><span id="l13.48">         lastCol = lastCol.nextElementSibling;</span>
<a href="#l13.49"></a><span id="l13.49">         lastIndex++;</span>
<a href="#l13.50"></a><span id="l13.50">       }</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">       // Returns first and last column with shadows that are visible in the</span>
<a href="#l13.53"></a><span id="l13.53">       // week and the positions of these (visible) columns in the set of</span>
<a href="#l13.54"></a><span id="l13.54">       // columns shadows of the occurrence.</span>
<a href="#l13.55"></a><span id="l13.55">       return {</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-        firstCol: firstCol,</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineminus">-        firstIndex: firstIndex,</span>
<a href="#l13.58"></a><span id="l13.58" class="difflineminus">-        lastCol: lastCol,</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineminus">-        lastIndex: lastIndex,</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineplus">+        firstCol,</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+        firstIndex,</span>
<a href="#l13.62"></a><span id="l13.62" class="difflineplus">+        lastCol,</span>
<a href="#l13.63"></a><span id="l13.63" class="difflineplus">+        lastIndex,</span>
<a href="#l13.64"></a><span id="l13.64">       };</span>
<a href="#l13.65"></a><span id="l13.65">     }</span>
<a href="#l13.66"></a><span id="l13.66"> </span>
<a href="#l13.67"></a><span id="l13.67">     updateShadowsBoxes(aStart, aEnd, aCurrentOffset, aCurrentShadows, aSizeattr) {</span>
<a href="#l13.68"></a><span id="l13.68">       let lateralColumns = this.firstLastShadowColumns(aCurrentOffset, aCurrentShadows);</span>
<a href="#l13.69"></a><span id="l13.69">       let firstCol = lateralColumns.firstCol;</span>
<a href="#l13.70"></a><span id="l13.70">       let firstIndex = lateralColumns.firstIndex;</span>
<a href="#l13.71"></a><span id="l13.71">       let lastCol = lateralColumns.lastCol;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/calendar/base/content/calendar-extract.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/calendar/base/content/calendar-extract.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* import-globals-from ../../../mail/base/content/msgMail3PaneWindow.js */</span>
<a href="#l14.5"></a><span id="l14.5"> /* import-globals-from calendar-item-editing.js */</span>
<a href="#l14.6"></a><span id="l14.6"> </span>
<a href="#l14.7"></a><span id="l14.7"> var { Extractor } = ChromeUtils.import(&quot;resource:///modules/calendar/calExtract.jsm&quot;);</span>
<a href="#l14.8"></a><span id="l14.8"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l14.9"></a><span id="l14.9"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> var calendarExtract = {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-  onShowLocaleMenu: function(target) {</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+  onShowLocaleMenu(target) {</span>
<a href="#l14.14"></a><span id="l14.14">     let localeList = document.getElementById(target.id);</span>
<a href="#l14.15"></a><span id="l14.15">     let langs = [];</span>
<a href="#l14.16"></a><span id="l14.16">     let chrome = Cc[&quot;@mozilla.org/chrome/chrome-registry;1&quot;]</span>
<a href="#l14.17"></a><span id="l14.17">       .getService(Ci.nsIXULChromeRegistry)</span>
<a href="#l14.18"></a><span id="l14.18">       .QueryInterface(Ci.nsIToolkitChromeRegistry);</span>
<a href="#l14.19"></a><span id="l14.19">     let langRegex = /^(([^-]+)-*(.*))$/;</span>
<a href="#l14.20"></a><span id="l14.20"> </span>
<a href="#l14.21"></a><span id="l14.21">     for (let locale of chrome.getLocalesForPackage(&quot;calendar&quot;)) {</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -45,34 +45,33 @@ var calendarExtract = {</span>
<a href="#l14.23"></a><span id="l14.23">       let idx_b = lastUsedLangs.indexOf(b[1]);</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">       if (idx_a == -1 &amp;&amp; idx_b == -1) {</span>
<a href="#l14.26"></a><span id="l14.26">         return a[0].localeCompare(b[0]);</span>
<a href="#l14.27"></a><span id="l14.27">       } else if (idx_a != -1 &amp;&amp; idx_b != -1) {</span>
<a href="#l14.28"></a><span id="l14.28">         return idx_a - idx_b;</span>
<a href="#l14.29"></a><span id="l14.29">       } else if (idx_a == -1) {</span>
<a href="#l14.30"></a><span id="l14.30">         return 1;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-      } else {</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-        return -1;</span>
<a href="#l14.33"></a><span id="l14.33">       }</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+      return -1;</span>
<a href="#l14.35"></a><span id="l14.35">     });</span>
<a href="#l14.36"></a><span id="l14.36">     removeChildren(localeList);</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38">     for (let lang of langs) {</span>
<a href="#l14.39"></a><span id="l14.39">       addMenuItem(localeList, lang[0], lang[1], null);</span>
<a href="#l14.40"></a><span id="l14.40">     }</span>
<a href="#l14.41"></a><span id="l14.41">   },</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-  extractWithLocale: function(event, isEvent) {</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+  extractWithLocale(event, isEvent) {</span>
<a href="#l14.45"></a><span id="l14.45">     event.stopPropagation();</span>
<a href="#l14.46"></a><span id="l14.46">     let locale = event.target.value;</span>
<a href="#l14.47"></a><span id="l14.47">     this.extractFromEmail(isEvent, true, locale);</span>
<a href="#l14.48"></a><span id="l14.48">   },</span>
<a href="#l14.49"></a><span id="l14.49"> </span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-  extractFromEmail: function(isEvent, fixedLang, fixedLocale) {</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+  extractFromEmail(isEvent, fixedLang, fixedLocale) {</span>
<a href="#l14.52"></a><span id="l14.52">     // TODO would be nice to handle multiple selected messages,</span>
<a href="#l14.53"></a><span id="l14.53">     // though old conversion functionality didn't</span>
<a href="#l14.54"></a><span id="l14.54">     let message = gFolderDisplay.selectedMessage;</span>
<a href="#l14.55"></a><span id="l14.55">     let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l14.56"></a><span id="l14.56">     let listener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;].createInstance(</span>
<a href="#l14.57"></a><span id="l14.57">       Ci.nsISyncStreamListener</span>
<a href="#l14.58"></a><span id="l14.58">     );</span>
<a href="#l14.59"></a><span id="l14.59">     let uri = message.folder.getUriForMsg(message);</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineat">@@ -212,34 +211,34 @@ var calendarExtract = {</span>
<a href="#l14.61"></a><span id="l14.61">     let timeSpent = new Date().getTime() - time;</span>
<a href="#l14.62"></a><span id="l14.62">     cal.LOG(</span>
<a href="#l14.63"></a><span id="l14.63">       &quot;[calExtract] Total time spent for conversion (including loading of dictionaries): &quot; +</span>
<a href="#l14.64"></a><span id="l14.64">         timeSpent +</span>
<a href="#l14.65"></a><span id="l14.65">         &quot;ms&quot;</span>
<a href="#l14.66"></a><span id="l14.66">     );</span>
<a href="#l14.67"></a><span id="l14.67">   },</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  addListeners: function() {</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+  addListeners() {</span>
<a href="#l14.71"></a><span id="l14.71">     if (window.top.document.location == &quot;chrome://messenger/content/messenger.xhtml&quot;) {</span>
<a href="#l14.72"></a><span id="l14.72">       // covers initial load and folder change</span>
<a href="#l14.73"></a><span id="l14.73">       let folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l14.74"></a><span id="l14.74">       folderTree.addEventListener(&quot;select&quot;, this.setState);</span>
<a href="#l14.75"></a><span id="l14.75"> </span>
<a href="#l14.76"></a><span id="l14.76">       // covers selection change in a folder</span>
<a href="#l14.77"></a><span id="l14.77">       let msgTree = window.top.GetThreadTree();</span>
<a href="#l14.78"></a><span id="l14.78">       msgTree.addEventListener(&quot;select&quot;, this.setState);</span>
<a href="#l14.79"></a><span id="l14.79"> </span>
<a href="#l14.80"></a><span id="l14.80">       window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l14.81"></a><span id="l14.81">         folderTree.removeEventListener(&quot;select&quot;, this.setState);</span>
<a href="#l14.82"></a><span id="l14.82">         msgTree.removeEventListener(&quot;select&quot;, this.setState);</span>
<a href="#l14.83"></a><span id="l14.83">       });</span>
<a href="#l14.84"></a><span id="l14.84">     }</span>
<a href="#l14.85"></a><span id="l14.85">   },</span>
<a href="#l14.86"></a><span id="l14.86"> </span>
<a href="#l14.87"></a><span id="l14.87" class="difflineminus">-  setState: function() {</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+  setState() {</span>
<a href="#l14.89"></a><span id="l14.89">     let eventButton = document.getElementById(&quot;extractEventButton&quot;);</span>
<a href="#l14.90"></a><span id="l14.90">     let taskButton = document.getElementById(&quot;extractTaskButton&quot;);</span>
<a href="#l14.91"></a><span id="l14.91">     let contextMenu = document.getElementById(&quot;mailContext-calendar-convert-menu&quot;);</span>
<a href="#l14.92"></a><span id="l14.92">     let contextMenuEvent = document.getElementById(&quot;mailContext-calendar-convert-event-menuitem&quot;);</span>
<a href="#l14.93"></a><span id="l14.93">     let contextMenuTask = document.getElementById(&quot;mailContext-calendar-convert-task-menuitem&quot;);</span>
<a href="#l14.94"></a><span id="l14.94">     let eventDisabled = gFolderDisplay.selectedCount == 0;</span>
<a href="#l14.95"></a><span id="l14.95">     let taskDisabled = gFolderDisplay.selectedCount == 0;</span>
<a href="#l14.96"></a><span id="l14.96">     let contextEventDisabled = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/calendar/base/content/calendar-invitations-manager.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -14,26 +14,26 @@ var gInvitationsRequestManager = {</span>
<a href="#l15.4"></a><span id="l15.4">   mRequestStatusList: {},</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6">   /**</span>
<a href="#l15.7"></a><span id="l15.7">    * Add a request to the request manager.</span>
<a href="#l15.8"></a><span id="l15.8">    *</span>
<a href="#l15.9"></a><span id="l15.9">    * @param calendar    The calendar to add for.</span>
<a href="#l15.10"></a><span id="l15.10">    * @param op          The operation to add</span>
<a href="#l15.11"></a><span id="l15.11">    */</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  addRequestStatus: function(calendar, operation) {</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  addRequestStatus(calendar, operation) {</span>
<a href="#l15.14"></a><span id="l15.14">     if (operation) {</span>
<a href="#l15.15"></a><span id="l15.15">       this.mRequestStatusList[calendar.id] = operation;</span>
<a href="#l15.16"></a><span id="l15.16">     }</span>
<a href="#l15.17"></a><span id="l15.17">   },</span>
<a href="#l15.18"></a><span id="l15.18"> </span>
<a href="#l15.19"></a><span id="l15.19">   /**</span>
<a href="#l15.20"></a><span id="l15.20">    * Cancel all pending requests</span>
<a href="#l15.21"></a><span id="l15.21">    */</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-  cancelPendingRequests: function() {</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+  cancelPendingRequests() {</span>
<a href="#l15.24"></a><span id="l15.24">     for (let id in this.mRequestStatusList) {</span>
<a href="#l15.25"></a><span id="l15.25">       let request = this.mRequestStatusList[id];</span>
<a href="#l15.26"></a><span id="l15.26">       if (request &amp;&amp; request.isPending) {</span>
<a href="#l15.27"></a><span id="l15.27">         request.cancel(null);</span>
<a href="#l15.28"></a><span id="l15.28">       }</span>
<a href="#l15.29"></a><span id="l15.29">     }</span>
<a href="#l15.30"></a><span id="l15.30">     this.mRequestStatusList = {};</span>
<a href="#l15.31"></a><span id="l15.31">   },</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineat">@@ -79,45 +79,45 @@ InvitationsManager.prototype = {</span>
<a href="#l15.33"></a><span id="l15.33">   mTimer: null,</span>
<a href="#l15.34"></a><span id="l15.34"> </span>
<a href="#l15.35"></a><span id="l15.35">   /**</span>
<a href="#l15.36"></a><span id="l15.36">    * Schedule an update for the invitations manager asynchronously.</span>
<a href="#l15.37"></a><span id="l15.37">    *</span>
<a href="#l15.38"></a><span id="l15.38">    * @param firstDelay          The timeout before the operation should start.</span>
<a href="#l15.39"></a><span id="l15.39">    * @param operationListener   The calIGenericOperationListener to notify.</span>
<a href="#l15.40"></a><span id="l15.40">    */</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineminus">-  scheduleInvitationsUpdate: function(firstDelay, operationListener) {</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+  scheduleInvitationsUpdate(firstDelay, operationListener) {</span>
<a href="#l15.43"></a><span id="l15.43">     this.cancelInvitationsUpdate();</span>
<a href="#l15.44"></a><span id="l15.44"> </span>
<a href="#l15.45"></a><span id="l15.45">     this.mTimer = setTimeout(() =&gt; {</span>
<a href="#l15.46"></a><span id="l15.46">       if (Services.prefs.getBoolPref(&quot;calendar.invitations.autorefresh.enabled&quot;, true)) {</span>
<a href="#l15.47"></a><span id="l15.47">         this.mTimer = setInterval(() =&gt; {</span>
<a href="#l15.48"></a><span id="l15.48">           this.getInvitations(operationListener);</span>
<a href="#l15.49"></a><span id="l15.49">         }, Services.prefs.getIntPref(&quot;calendar.invitations.autorefresh.timeout&quot;, 3) * 60000);</span>
<a href="#l15.50"></a><span id="l15.50">       }</span>
<a href="#l15.51"></a><span id="l15.51">       this.getInvitations(operationListener);</span>
<a href="#l15.52"></a><span id="l15.52">     }, firstDelay);</span>
<a href="#l15.53"></a><span id="l15.53">   },</span>
<a href="#l15.54"></a><span id="l15.54"> </span>
<a href="#l15.55"></a><span id="l15.55">   /**</span>
<a href="#l15.56"></a><span id="l15.56">    * Cancel pending any pending invitations update.</span>
<a href="#l15.57"></a><span id="l15.57">    */</span>
<a href="#l15.58"></a><span id="l15.58" class="difflineminus">-  cancelInvitationsUpdate: function() {</span>
<a href="#l15.59"></a><span id="l15.59" class="difflineplus">+  cancelInvitationsUpdate() {</span>
<a href="#l15.60"></a><span id="l15.60">     clearTimeout(this.mTimer);</span>
<a href="#l15.61"></a><span id="l15.61">   },</span>
<a href="#l15.62"></a><span id="l15.62"> </span>
<a href="#l15.63"></a><span id="l15.63">   /**</span>
<a href="#l15.64"></a><span id="l15.64">    * Retrieve invitations from all calendars. Notify all passed</span>
<a href="#l15.65"></a><span id="l15.65">    * operation listeners.</span>
<a href="#l15.66"></a><span id="l15.66">    *</span>
<a href="#l15.67"></a><span id="l15.67">    * @param operationListener1    The first operation listener to notify.</span>
<a href="#l15.68"></a><span id="l15.68">    * @param operationListener2    (optional) The second operation listener to</span>
<a href="#l15.69"></a><span id="l15.69">    *                                notify.</span>
<a href="#l15.70"></a><span id="l15.70">    */</span>
<a href="#l15.71"></a><span id="l15.71" class="difflineminus">-  getInvitations: function(operationListener1, operationListener2) {</span>
<a href="#l15.72"></a><span id="l15.72" class="difflineplus">+  getInvitations(operationListener1, operationListener2) {</span>
<a href="#l15.73"></a><span id="l15.73">     let listeners = [];</span>
<a href="#l15.74"></a><span id="l15.74">     if (operationListener1) {</span>
<a href="#l15.75"></a><span id="l15.75">       listeners.push(operationListener1);</span>
<a href="#l15.76"></a><span id="l15.76">     }</span>
<a href="#l15.77"></a><span id="l15.77">     if (operationListener2) {</span>
<a href="#l15.78"></a><span id="l15.78">       listeners.push(operationListener2);</span>
<a href="#l15.79"></a><span id="l15.79">     }</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81" class="difflineat">@@ -130,17 +130,17 @@ InvitationsManager.prototype = {</span>
<a href="#l15.82"></a><span id="l15.82">     let opListener = {</span>
<a href="#l15.83"></a><span id="l15.83">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l15.84"></a><span id="l15.84">       mCount: cals.length,</span>
<a href="#l15.85"></a><span id="l15.85">       mRequestManager: gInvitationsRequestManager,</span>
<a href="#l15.86"></a><span id="l15.86">       mInvitationsManager: this,</span>
<a href="#l15.87"></a><span id="l15.87">       mHandledItems: {},</span>
<a href="#l15.88"></a><span id="l15.88"> </span>
<a href="#l15.89"></a><span id="l15.89">       // calIOperationListener</span>
<a href="#l15.90"></a><span id="l15.90" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l15.91"></a><span id="l15.91" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l15.92"></a><span id="l15.92">         if (--this.mCount == 0) {</span>
<a href="#l15.93"></a><span id="l15.93">           this.mInvitationsManager.mItemList.sort((a, b) =&gt; {</span>
<a href="#l15.94"></a><span id="l15.94">             return a.startDate.compare(b.startDate);</span>
<a href="#l15.95"></a><span id="l15.95">           });</span>
<a href="#l15.96"></a><span id="l15.96">           for (let listener of listeners) {</span>
<a href="#l15.97"></a><span id="l15.97">             try {</span>
<a href="#l15.98"></a><span id="l15.98">               if (this.mInvitationsManager.mItemList.length) {</span>
<a href="#l15.99"></a><span id="l15.99">                 // Only call if there are actually items</span>
<a href="#l15.100"></a><span id="l15.100" class="difflineat">@@ -161,17 +161,17 @@ InvitationsManager.prototype = {</span>
<a href="#l15.101"></a><span id="l15.101">               );</span>
<a href="#l15.102"></a><span id="l15.102">             } catch (exc) {</span>
<a href="#l15.103"></a><span id="l15.103">               cal.ERROR(exc);</span>
<a href="#l15.104"></a><span id="l15.104">             }</span>
<a href="#l15.105"></a><span id="l15.105">           }</span>
<a href="#l15.106"></a><span id="l15.106">         }</span>
<a href="#l15.107"></a><span id="l15.107">       },</span>
<a href="#l15.108"></a><span id="l15.108"> </span>
<a href="#l15.109"></a><span id="l15.109" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l15.110"></a><span id="l15.110" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l15.111"></a><span id="l15.111">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l15.112"></a><span id="l15.112">           for (let item of aItems) {</span>
<a href="#l15.113"></a><span id="l15.113">             // we need to retrieve by occurrence to properly filter exceptions,</span>
<a href="#l15.114"></a><span id="l15.114">             // should be fixed with bug 416975</span>
<a href="#l15.115"></a><span id="l15.115">             item = item.parentItem;</span>
<a href="#l15.116"></a><span id="l15.116">             let hid = item.hashId;</span>
<a href="#l15.117"></a><span id="l15.117">             if (!this.mHandledItems[hid]) {</span>
<a href="#l15.118"></a><span id="l15.118">               this.mHandledItems[hid] = true;</span>
<a href="#l15.119"></a><span id="l15.119" class="difflineat">@@ -225,17 +225,17 @@ InvitationsManager.prototype = {</span>
<a href="#l15.120"></a><span id="l15.120">    * sounds fishy to me. Maybe there is a more encapsulated solution.</span>
<a href="#l15.121"></a><span id="l15.121">    *</span>
<a href="#l15.122"></a><span id="l15.122">    * @param onLoadOpListener          The operation listener to notify when</span>
<a href="#l15.123"></a><span id="l15.123">    *                                    getting invitations. Should be passed</span>
<a href="#l15.124"></a><span id="l15.124">    *                                    to this.getInvitations().</span>
<a href="#l15.125"></a><span id="l15.125">    * @param finishedCallBack          A callback function to call when the</span>
<a href="#l15.126"></a><span id="l15.126">    *                                    dialog has completed.</span>
<a href="#l15.127"></a><span id="l15.127">    */</span>
<a href="#l15.128"></a><span id="l15.128" class="difflineminus">-  openInvitationsDialog: function(onLoadOpListener, finishedCallBack) {</span>
<a href="#l15.129"></a><span id="l15.129" class="difflineplus">+  openInvitationsDialog(onLoadOpListener, finishedCallBack) {</span>
<a href="#l15.130"></a><span id="l15.130">     let args = {};</span>
<a href="#l15.131"></a><span id="l15.131">     args.onLoadOperationListener = onLoadOpListener;</span>
<a href="#l15.132"></a><span id="l15.132">     args.queue = [];</span>
<a href="#l15.133"></a><span id="l15.133">     args.finishedCallBack = finishedCallBack;</span>
<a href="#l15.134"></a><span id="l15.134">     args.requestManager = gInvitationsRequestManager;</span>
<a href="#l15.135"></a><span id="l15.135">     args.invitationsManager = this;</span>
<a href="#l15.136"></a><span id="l15.136">     // the dialog will reset this to auto when it is done loading</span>
<a href="#l15.137"></a><span id="l15.137">     window.setCursor(&quot;wait&quot;);</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineat">@@ -252,41 +252,41 @@ InvitationsManager.prototype = {</span>
<a href="#l15.139"></a><span id="l15.139">    * Process the passed job queue. A job is an object that consists of an</span>
<a href="#l15.140"></a><span id="l15.140">    * action, a newItem and and oldItem. This processor only takes &quot;modify&quot;</span>
<a href="#l15.141"></a><span id="l15.141">    * operations into account.</span>
<a href="#l15.142"></a><span id="l15.142">    *</span>
<a href="#l15.143"></a><span id="l15.143">    * @param queue                         The array of objects to process.</span>
<a href="#l15.144"></a><span id="l15.144">    * @param jobQueueFinishedCallBack      A callback function called when</span>
<a href="#l15.145"></a><span id="l15.145">    *                                        job has finished.</span>
<a href="#l15.146"></a><span id="l15.146">    */</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineminus">-  processJobQueue: function(queue, jobQueueFinishedCallBack) {</span>
<a href="#l15.148"></a><span id="l15.148" class="difflineplus">+  processJobQueue(queue, jobQueueFinishedCallBack) {</span>
<a href="#l15.149"></a><span id="l15.149">     // TODO: undo/redo</span>
<a href="#l15.150"></a><span id="l15.150">     function operationListener(mgr, queueCallback, oldItem_) {</span>
<a href="#l15.151"></a><span id="l15.151">       this.mInvitationsManager = mgr;</span>
<a href="#l15.152"></a><span id="l15.152">       this.mJobQueueFinishedCallBack = queueCallback;</span>
<a href="#l15.153"></a><span id="l15.153">       this.mOldItem = oldItem_;</span>
<a href="#l15.154"></a><span id="l15.154">     }</span>
<a href="#l15.155"></a><span id="l15.155">     operationListener.prototype = {</span>
<a href="#l15.156"></a><span id="l15.156">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l15.159"></a><span id="l15.159">         if (</span>
<a href="#l15.160"></a><span id="l15.160">           Components.isSuccessCode(aStatus) &amp;&amp;</span>
<a href="#l15.161"></a><span id="l15.161">           aOperationType == Ci.calIOperationListener.MODIFY</span>
<a href="#l15.162"></a><span id="l15.162">         ) {</span>
<a href="#l15.163"></a><span id="l15.163">           cal.itip.checkAndSend(aOperationType, aDetail, this.mOldItem);</span>
<a href="#l15.164"></a><span id="l15.164">           this.mInvitationsManager.deleteItem(aDetail);</span>
<a href="#l15.165"></a><span id="l15.165">           this.mInvitationsManager.addItem(aDetail);</span>
<a href="#l15.166"></a><span id="l15.166">         }</span>
<a href="#l15.167"></a><span id="l15.167">         this.mInvitationsManager.mJobsPending--;</span>
<a href="#l15.168"></a><span id="l15.168">         if (this.mInvitationsManager.mJobsPending == 0 &amp;&amp; this.mJobQueueFinishedCallBack) {</span>
<a href="#l15.169"></a><span id="l15.169">           this.mJobQueueFinishedCallBack();</span>
<a href="#l15.170"></a><span id="l15.170">         }</span>
<a href="#l15.171"></a><span id="l15.171">       },</span>
<a href="#l15.172"></a><span id="l15.172"> </span>
<a href="#l15.173"></a><span id="l15.173" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l15.174"></a><span id="l15.174" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l15.175"></a><span id="l15.175">     };</span>
<a href="#l15.176"></a><span id="l15.176"> </span>
<a href="#l15.177"></a><span id="l15.177">     this.mJobsPending = 0;</span>
<a href="#l15.178"></a><span id="l15.178">     for (let i = 0; i &lt; queue.length; i++) {</span>
<a href="#l15.179"></a><span id="l15.179">       let job = queue[i];</span>
<a href="#l15.180"></a><span id="l15.180">       let oldItem = job.oldItem;</span>
<a href="#l15.181"></a><span id="l15.181">       let newItem = job.newItem;</span>
<a href="#l15.182"></a><span id="l15.182">       switch (job.action) {</span>
<a href="#l15.183"></a><span id="l15.183" class="difflineat">@@ -309,28 +309,28 @@ InvitationsManager.prototype = {</span>
<a href="#l15.184"></a><span id="l15.184"> </span>
<a href="#l15.185"></a><span id="l15.185">   /**</span>
<a href="#l15.186"></a><span id="l15.186">    * Checks if the internal item list contains the given item</span>
<a href="#l15.187"></a><span id="l15.187">    * XXXdbo       Please document these correctly.</span>
<a href="#l15.188"></a><span id="l15.188">    *</span>
<a href="#l15.189"></a><span id="l15.189">    * @param item      The item to look for.</span>
<a href="#l15.190"></a><span id="l15.190">    * @return          A boolean value indicating if the item was found.</span>
<a href="#l15.191"></a><span id="l15.191">    */</span>
<a href="#l15.192"></a><span id="l15.192" class="difflineminus">-  hasItem: function(item) {</span>
<a href="#l15.193"></a><span id="l15.193" class="difflineplus">+  hasItem(item) {</span>
<a href="#l15.194"></a><span id="l15.194">     let hid = item.hashId;</span>
<a href="#l15.195"></a><span id="l15.195">     return this.mItemList.some(item_ =&gt; hid == item_.hashId);</span>
<a href="#l15.196"></a><span id="l15.196">   },</span>
<a href="#l15.197"></a><span id="l15.197"> </span>
<a href="#l15.198"></a><span id="l15.198">   /**</span>
<a href="#l15.199"></a><span id="l15.199">    * Adds an item to the internal item list.</span>
<a href="#l15.200"></a><span id="l15.200">    * XXXdbo       Please document these correctly.</span>
<a href="#l15.201"></a><span id="l15.201">    *</span>
<a href="#l15.202"></a><span id="l15.202">    * @param item      The item to add.</span>
<a href="#l15.203"></a><span id="l15.203">    */</span>
<a href="#l15.204"></a><span id="l15.204" class="difflineminus">-  addItem: function(item) {</span>
<a href="#l15.205"></a><span id="l15.205" class="difflineplus">+  addItem(item) {</span>
<a href="#l15.206"></a><span id="l15.206">     let recInfo = item.recurrenceInfo;</span>
<a href="#l15.207"></a><span id="l15.207">     if (recInfo &amp;&amp; !cal.itip.isOpenInvitation(item)) {</span>
<a href="#l15.208"></a><span id="l15.208">       // scan exceptions:</span>
<a href="#l15.209"></a><span id="l15.209">       let ids = recInfo.getExceptionIds();</span>
<a href="#l15.210"></a><span id="l15.210">       for (let id of ids) {</span>
<a href="#l15.211"></a><span id="l15.211">         let ex = recInfo.getExceptionFor(id);</span>
<a href="#l15.212"></a><span id="l15.212">         if (ex &amp;&amp; this.validateItem(ex) &amp;&amp; !this.hasItem(ex)) {</span>
<a href="#l15.213"></a><span id="l15.213">           this.mItemList.push(ex);</span>
<a href="#l15.214"></a><span id="l15.214" class="difflineat">@@ -342,49 +342,49 @@ InvitationsManager.prototype = {</span>
<a href="#l15.215"></a><span id="l15.215">   },</span>
<a href="#l15.216"></a><span id="l15.216"> </span>
<a href="#l15.217"></a><span id="l15.217">   /**</span>
<a href="#l15.218"></a><span id="l15.218">    * Removes an item from the internal item list</span>
<a href="#l15.219"></a><span id="l15.219">    * XXXdbo       Please document these correctly.</span>
<a href="#l15.220"></a><span id="l15.220">    *</span>
<a href="#l15.221"></a><span id="l15.221">    * @param item      The item to remove.</span>
<a href="#l15.222"></a><span id="l15.222">    */</span>
<a href="#l15.223"></a><span id="l15.223" class="difflineminus">-  deleteItem: function(item) {</span>
<a href="#l15.224"></a><span id="l15.224" class="difflineplus">+  deleteItem(item) {</span>
<a href="#l15.225"></a><span id="l15.225">     let id = item.id;</span>
<a href="#l15.226"></a><span id="l15.226">     this.mItemList.filter(item_ =&gt; id != item_.id);</span>
<a href="#l15.227"></a><span id="l15.227">   },</span>
<a href="#l15.228"></a><span id="l15.228"> </span>
<a href="#l15.229"></a><span id="l15.229">   /**</span>
<a href="#l15.230"></a><span id="l15.230">    * Remove all items from the internal item list</span>
<a href="#l15.231"></a><span id="l15.231">    * XXXdbo       Please document these correctly.</span>
<a href="#l15.232"></a><span id="l15.232">    */</span>
<a href="#l15.233"></a><span id="l15.233" class="difflineminus">-  deleteAllItems: function() {</span>
<a href="#l15.234"></a><span id="l15.234" class="difflineplus">+  deleteAllItems() {</span>
<a href="#l15.235"></a><span id="l15.235">     this.mItemList = [];</span>
<a href="#l15.236"></a><span id="l15.236">   },</span>
<a href="#l15.237"></a><span id="l15.237"> </span>
<a href="#l15.238"></a><span id="l15.238">   /**</span>
<a href="#l15.239"></a><span id="l15.239">    * Helper function to create a start date to search from. This date is the</span>
<a href="#l15.240"></a><span id="l15.240">    * current time with hour/minute/second set to zero.</span>
<a href="#l15.241"></a><span id="l15.241">    *</span>
<a href="#l15.242"></a><span id="l15.242">    * @return      Potential start date.</span>
<a href="#l15.243"></a><span id="l15.243">    */</span>
<a href="#l15.244"></a><span id="l15.244" class="difflineminus">-  getStartDate: function() {</span>
<a href="#l15.245"></a><span id="l15.245" class="difflineplus">+  getStartDate() {</span>
<a href="#l15.246"></a><span id="l15.246">     let date = cal.dtz.now();</span>
<a href="#l15.247"></a><span id="l15.247">     date.second = 0;</span>
<a href="#l15.248"></a><span id="l15.248">     date.minute = 0;</span>
<a href="#l15.249"></a><span id="l15.249">     date.hour = 0;</span>
<a href="#l15.250"></a><span id="l15.250">     return date;</span>
<a href="#l15.251"></a><span id="l15.251">   },</span>
<a href="#l15.252"></a><span id="l15.252"> </span>
<a href="#l15.253"></a><span id="l15.253">   /**</span>
<a href="#l15.254"></a><span id="l15.254">    * Updates the start date for the invitations manager to the date returned</span>
<a href="#l15.255"></a><span id="l15.255">    * from this.getStartDate(), unless the previously existing start date is</span>
<a href="#l15.256"></a><span id="l15.256">    * the same or after what getStartDate() returned.</span>
<a href="#l15.257"></a><span id="l15.257">    */</span>
<a href="#l15.258"></a><span id="l15.258" class="difflineminus">-  updateStartDate: function() {</span>
<a href="#l15.259"></a><span id="l15.259" class="difflineplus">+  updateStartDate() {</span>
<a href="#l15.260"></a><span id="l15.260">     if (this.mStartDate) {</span>
<a href="#l15.261"></a><span id="l15.261">       let startDate = this.getStartDate();</span>
<a href="#l15.262"></a><span id="l15.262">       if (startDate.compare(this.mStartDate) &gt; 0) {</span>
<a href="#l15.263"></a><span id="l15.263">         this.mStartDate = startDate;</span>
<a href="#l15.264"></a><span id="l15.264">       }</span>
<a href="#l15.265"></a><span id="l15.265">     } else {</span>
<a href="#l15.266"></a><span id="l15.266">       this.mStartDate = this.getStartDate();</span>
<a href="#l15.267"></a><span id="l15.267">     }</span>
<a href="#l15.268"></a><span id="l15.268" class="difflineat">@@ -393,16 +393,16 @@ InvitationsManager.prototype = {</span>
<a href="#l15.269"></a><span id="l15.269">   /**</span>
<a href="#l15.270"></a><span id="l15.270">    * Checks if the item is valid for the invitation manager. Checks if the</span>
<a href="#l15.271"></a><span id="l15.271">    * item is in the range of the invitation manager and if the item is a valid</span>
<a href="#l15.272"></a><span id="l15.272">    * invitation.</span>
<a href="#l15.273"></a><span id="l15.273">    *</span>
<a href="#l15.274"></a><span id="l15.274">    * @param item      The item to check</span>
<a href="#l15.275"></a><span id="l15.275">    * @return          A boolean indicating if the item is a valid invitation.</span>
<a href="#l15.276"></a><span id="l15.276">    */</span>
<a href="#l15.277"></a><span id="l15.277" class="difflineminus">-  validateItem: function(item) {</span>
<a href="#l15.278"></a><span id="l15.278" class="difflineplus">+  validateItem(item) {</span>
<a href="#l15.279"></a><span id="l15.279">     if (item.calendar instanceof Ci.calISchedulingSupport &amp;&amp; !item.calendar.isInvitation(item)) {</span>
<a href="#l15.280"></a><span id="l15.280">       return false; // exclude if organizer has invited himself</span>
<a href="#l15.281"></a><span id="l15.281">     }</span>
<a href="#l15.282"></a><span id="l15.282">     let start = item[cal.dtz.startDateProp(item)] || item[cal.dtz.endDateProp(item)];</span>
<a href="#l15.283"></a><span id="l15.283">     return cal.itip.isOpenInvitation(item) &amp;&amp; start.compare(this.mStartDate) &gt;= 0;</span>
<a href="#l15.284"></a><span id="l15.284">   },</span>
<a href="#l15.285"></a><span id="l15.285"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/calendar/base/content/calendar-item-editing.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/calendar/base/content/calendar-item-editing.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -465,25 +465,24 @@ function openEventDialog(</span>
<a href="#l16.4"></a><span id="l16.4">       !cal.acl.userCanAddItemsToCalendar(calendar) ||</span>
<a href="#l16.5"></a><span id="l16.5">       !isItemSupported(calendar))</span>
<a href="#l16.6"></a><span id="l16.6">   ) {</span>
<a href="#l16.7"></a><span id="l16.7">     if (calendars.length &lt; 1) {</span>
<a href="#l16.8"></a><span id="l16.8">       // There are no writable calendars or no calendar supports the given</span>
<a href="#l16.9"></a><span id="l16.9">       // item. Don't show the dialog.</span>
<a href="#l16.10"></a><span id="l16.10">       disposeJob(job);</span>
<a href="#l16.11"></a><span id="l16.11">       return;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    } else {</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-      // Pick the first calendar that supports the item and is writable</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-      calendar = calendars[0];</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-      if (calendarItem) {</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-        // XXX The dialog currently uses the items calendar as a first</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-        // choice. Since we are shortly before a release to keep</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-        // regression risk low, explicitly set the item's calendar here.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-        calendarItem.calendar = calendars[0];</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-      }</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+    }</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+    // Pick the first calendar that supports the item and is writable</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+    calendar = calendars[0];</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+    if (calendarItem) {</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+      // XXX The dialog currently uses the items calendar as a first</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+      // choice. Since we are shortly before a release to keep</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+      // regression risk low, explicitly set the item's calendar here.</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+      calendarItem.calendar = calendars[0];</span>
<a href="#l16.29"></a><span id="l16.29">     }</span>
<a href="#l16.30"></a><span id="l16.30">   }</span>
<a href="#l16.31"></a><span id="l16.31"> </span>
<a href="#l16.32"></a><span id="l16.32">   // Setup the window arguments</span>
<a href="#l16.33"></a><span id="l16.33">   let args = {};</span>
<a href="#l16.34"></a><span id="l16.34">   args.calendarEvent = calendarItem;</span>
<a href="#l16.35"></a><span id="l16.35">   args.calendar = calendar;</span>
<a href="#l16.36"></a><span id="l16.36">   args.mode = mode;</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineat">@@ -604,17 +603,17 @@ function promptOccurrenceModification(aI</span>
<a href="#l16.38"></a><span id="l16.38">   let items = Array.isArray(aItem) ? aItem : [aItem];</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40">   // Check if this actually is an instance of a recurring event</span>
<a href="#l16.41"></a><span id="l16.41">   if (items.every(item =&gt; item == item.parentItem)) {</span>
<a href="#l16.42"></a><span id="l16.42">     type = MODIFY_PARENT;</span>
<a href="#l16.43"></a><span id="l16.43">   } else if (aItem &amp;&amp; items.length) {</span>
<a href="#l16.44"></a><span id="l16.44">     // Prompt the user. Setting modal blocks the dialog until it is closed. We</span>
<a href="#l16.45"></a><span id="l16.45">     // use rv to pass our return value.</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-    let rv = { value: CANCEL, items: items, action: aAction };</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+    let rv = { value: CANCEL, items, action: aAction };</span>
<a href="#l16.48"></a><span id="l16.48">     window.openDialog(</span>
<a href="#l16.49"></a><span id="l16.49">       &quot;chrome://calendar/content/calendar-occurrence-prompt.xhtml&quot;,</span>
<a href="#l16.50"></a><span id="l16.50">       &quot;PromptOccurrenceModification&quot;,</span>
<a href="#l16.51"></a><span id="l16.51">       &quot;centerscreen,chrome,modal,titlebar&quot;,</span>
<a href="#l16.52"></a><span id="l16.52">       rv</span>
<a href="#l16.53"></a><span id="l16.53">     );</span>
<a href="#l16.54"></a><span id="l16.54">     type = rv.value;</span>
<a href="#l16.55"></a><span id="l16.55">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/calendar/base/content/calendar-management.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/calendar/base/content/calendar-management.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -607,43 +607,43 @@ function showOnlyCalendar(aCalendar) {</span>
<a href="#l17.4"></a><span id="l17.4">   }</span>
<a href="#l17.5"></a><span id="l17.5">   composite.addCalendar(aCalendar);</span>
<a href="#l17.6"></a><span id="l17.6">   composite.endBatch();</span>
<a href="#l17.7"></a><span id="l17.7"> }</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> var compositeObserver = {</span>
<a href="#l17.10"></a><span id="l17.10">   QueryInterface: cal.generateQI([Ci.calIObserver, Ci.calICompositeObserver]),</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-  onStartBatch: function() {},</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-  onEndBatch: function() {},</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">-  onAddItem: function() {},</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineminus">-  onModifyItem: function() {},</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineminus">-  onDeleteItem: function() {},</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-  onError: function() {},</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineminus">-  onPropertyChanged: function() {},</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-  onPropertyDeleting: function() {},</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+  onStartBatch() {},</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+  onEndBatch() {},</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+  onAddItem() {},</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+  onModifyItem() {},</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+  onDeleteItem() {},</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+  onError() {},</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+  onPropertyChanged() {},</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+  onPropertyDeleting() {},</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29" class="difflineminus">-  onLoad: function() {</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  onLoad() {</span>
<a href="#l17.31"></a><span id="l17.31">     calendarUpdateNewItemsCommand();</span>
<a href="#l17.32"></a><span id="l17.32">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l17.33"></a><span id="l17.33">   },</span>
<a href="#l17.34"></a><span id="l17.34"> </span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-  onCalendarAdded: function(aCalendar) {</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+  onCalendarAdded(aCalendar) {</span>
<a href="#l17.37"></a><span id="l17.37">     // Update the calendar commands for number of remote calendars and for</span>
<a href="#l17.38"></a><span id="l17.38">     // more than one calendar</span>
<a href="#l17.39"></a><span id="l17.39">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l17.40"></a><span id="l17.40">   },</span>
<a href="#l17.41"></a><span id="l17.41"> </span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-  onCalendarRemoved: function(aCalendar) {</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+  onCalendarRemoved(aCalendar) {</span>
<a href="#l17.44"></a><span id="l17.44">     // Update commands to disallow deleting the last calendar and only</span>
<a href="#l17.45"></a><span id="l17.45">     // allowing reload remote calendars when there are remote calendars.</span>
<a href="#l17.46"></a><span id="l17.46">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l17.47"></a><span id="l17.47">   },</span>
<a href="#l17.48"></a><span id="l17.48"> </span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  onDefaultCalendarChanged: function(aNewCalendar) {</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  onDefaultCalendarChanged(aNewCalendar) {</span>
<a href="#l17.51"></a><span id="l17.51">     // A new default calendar may mean that the new calendar has different</span>
<a href="#l17.52"></a><span id="l17.52">     // ACLs. Make sure the commands are updated.</span>
<a href="#l17.53"></a><span id="l17.53">     calendarUpdateNewItemsCommand();</span>
<a href="#l17.54"></a><span id="l17.54">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l17.55"></a><span id="l17.55">   },</span>
<a href="#l17.56"></a><span id="l17.56"> };</span>
<a href="#l17.57"></a><span id="l17.57"> </span>
<a href="#l17.58"></a><span id="l17.58"> /**</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineat">@@ -662,44 +662,44 @@ function openCalendarSubscriptionsDialog</span>
<a href="#l17.60"></a><span id="l17.60"> }</span>
<a href="#l17.61"></a><span id="l17.61"> </span>
<a href="#l17.62"></a><span id="l17.62"> /**</span>
<a href="#l17.63"></a><span id="l17.63">  * Calendar Offline Manager</span>
<a href="#l17.64"></a><span id="l17.64">  */</span>
<a href="#l17.65"></a><span id="l17.65"> var calendarOfflineManager = {</span>
<a href="#l17.66"></a><span id="l17.66">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l17.67"></a><span id="l17.67"> </span>
<a href="#l17.68"></a><span id="l17.68" class="difflineminus">-  init: function() {</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  init() {</span>
<a href="#l17.70"></a><span id="l17.70">     if (this.initialized) {</span>
<a href="#l17.71"></a><span id="l17.71">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l17.72"></a><span id="l17.72">     }</span>
<a href="#l17.73"></a><span id="l17.73">     Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l17.74"></a><span id="l17.74"> </span>
<a href="#l17.75"></a><span id="l17.75">     this.updateOfflineUI(!this.isOnline());</span>
<a href="#l17.76"></a><span id="l17.76">     this.initialized = true;</span>
<a href="#l17.77"></a><span id="l17.77">   },</span>
<a href="#l17.78"></a><span id="l17.78"> </span>
<a href="#l17.79"></a><span id="l17.79" class="difflineminus">-  uninit: function() {</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  uninit() {</span>
<a href="#l17.81"></a><span id="l17.81">     if (!this.initialized) {</span>
<a href="#l17.82"></a><span id="l17.82">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l17.83"></a><span id="l17.83">     }</span>
<a href="#l17.84"></a><span id="l17.84">     Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l17.85"></a><span id="l17.85">     this.initialized = false;</span>
<a href="#l17.86"></a><span id="l17.86">   },</span>
<a href="#l17.87"></a><span id="l17.87"> </span>
<a href="#l17.88"></a><span id="l17.88" class="difflineminus">-  isOnline: function() {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+  isOnline() {</span>
<a href="#l17.90"></a><span id="l17.90">     return !Services.io.offline;</span>
<a href="#l17.91"></a><span id="l17.91">   },</span>
<a href="#l17.92"></a><span id="l17.92"> </span>
<a href="#l17.93"></a><span id="l17.93" class="difflineminus">-  updateOfflineUI: function(aIsOffline) {</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  updateOfflineUI(aIsOffline) {</span>
<a href="#l17.95"></a><span id="l17.95">     // Refresh the current view</span>
<a href="#l17.96"></a><span id="l17.96">     currentView().goToDay(currentView().selectedDay);</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">     // Set up disabled locks for offline</span>
<a href="#l17.99"></a><span id="l17.99">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l17.100"></a><span id="l17.100">   },</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102" class="difflineminus">-  observe: function(aSubject, aTopic, aState) {</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+  observe(aSubject, aTopic, aState) {</span>
<a href="#l17.104"></a><span id="l17.104">     if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l17.105"></a><span id="l17.105">       this.updateOfflineUI(aState == &quot;offline&quot;);</span>
<a href="#l17.106"></a><span id="l17.106">     }</span>
<a href="#l17.107"></a><span id="l17.107">   },</span>
<a href="#l17.108"></a><span id="l17.108"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/calendar/base/content/calendar-migration.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/calendar/base/content/calendar-migration.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -42,17 +42,17 @@ var gDataMigrator = {</span>
<a href="#l18.4"></a><span id="l18.4"> </span>
<a href="#l18.5"></a><span id="l18.5">   /**</span>
<a href="#l18.6"></a><span id="l18.6">    * Call to do a general data migration (for a clean profile)  Will run</span>
<a href="#l18.7"></a><span id="l18.7">    * through all of the known migrator-checkers.  These checkers will return</span>
<a href="#l18.8"></a><span id="l18.8">    * an array of valid dataMigrator objects, for each kind of data they find.</span>
<a href="#l18.9"></a><span id="l18.9">    * If there is at least one valid migrator, we'll pop open the migration</span>
<a href="#l18.10"></a><span id="l18.10">    * wizard, otherwise, we'll return silently.</span>
<a href="#l18.11"></a><span id="l18.11">    */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  checkAndMigrate: function() {</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  checkAndMigrate() {</span>
<a href="#l18.14"></a><span id="l18.14">     if (Services.appinfo.ID == FIREFOX_UID) {</span>
<a href="#l18.15"></a><span id="l18.15">       this.mIsInFirefox = true;</span>
<a href="#l18.16"></a><span id="l18.16">       // We can't handle Firefox Lightning yet</span>
<a href="#l18.17"></a><span id="l18.17">       console.debug(&quot;Holy cow, you're Firefox-Lightning! sorry, can't help.&quot;);</span>
<a href="#l18.18"></a><span id="l18.18">       return;</span>
<a href="#l18.19"></a><span id="l18.19">     }</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">     this.mPlatform = Services.appinfo.OS.toLowerCase();</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineat">@@ -92,17 +92,17 @@ var gDataMigrator = {</span>
<a href="#l18.23"></a><span id="l18.23">       );</span>
<a href="#l18.24"></a><span id="l18.24">     }</span>
<a href="#l18.25"></a><span id="l18.25">   },</span>
<a href="#l18.26"></a><span id="l18.26"> </span>
<a href="#l18.27"></a><span id="l18.27">   /**</span>
<a href="#l18.28"></a><span id="l18.28">    * Checks to see if Apple's iCal is installed and offers to migrate any data</span>
<a href="#l18.29"></a><span id="l18.29">    * the user has created in it.</span>
<a href="#l18.30"></a><span id="l18.30">    */</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineminus">-  checkIcal: function() {</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+  checkIcal() {</span>
<a href="#l18.33"></a><span id="l18.33">     function icalMigrate(aDataDir, aCallback) {</span>
<a href="#l18.34"></a><span id="l18.34">       aDataDir.append(&quot;Sources&quot;);</span>
<a href="#l18.35"></a><span id="l18.35">       let calManager = cal.getCalendarManager();</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37">       let i = 1;</span>
<a href="#l18.38"></a><span id="l18.38">       for (let dataDir of aDataDir.directoryEntries) {</span>
<a href="#l18.39"></a><span id="l18.39">         let dataStore = dataDir.clone();</span>
<a href="#l18.40"></a><span id="l18.40">         dataStore.append(&quot;corestorage.ics&quot;);</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineat">@@ -181,17 +181,17 @@ var gDataMigrator = {</span>
<a href="#l18.42"></a><span id="l18.42"> </span>
<a href="#l18.43"></a><span id="l18.43">     return [];</span>
<a href="#l18.44"></a><span id="l18.44">   },</span>
<a href="#l18.45"></a><span id="l18.45"> </span>
<a href="#l18.46"></a><span id="l18.46">   /**</span>
<a href="#l18.47"></a><span id="l18.47">    * Checks to see if Evolution is installed and offers to migrate any data</span>
<a href="#l18.48"></a><span id="l18.48">    * stored there.</span>
<a href="#l18.49"></a><span id="l18.49">    */</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-  checkEvolution: function() {</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  checkEvolution() {</span>
<a href="#l18.52"></a><span id="l18.52">     function evoMigrate(aDataDir, aCallback) {</span>
<a href="#l18.53"></a><span id="l18.53">       let i = 1;</span>
<a href="#l18.54"></a><span id="l18.54">       let evoDataMigrate = function(dataStore) {</span>
<a href="#l18.55"></a><span id="l18.55">         console.debug(&quot;Migrating evolution data file in &quot; + dataStore.path);</span>
<a href="#l18.56"></a><span id="l18.56">         if (dataStore.exists()) {</span>
<a href="#l18.57"></a><span id="l18.57">           let calendar = gDataMigrator.importICSToStorage(dataStore);</span>
<a href="#l18.58"></a><span id="l18.58">           calendar.name = &quot;Evolution &quot; + i++;</span>
<a href="#l18.59"></a><span id="l18.59">           calManager.registerCalendar(calendar);</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineat">@@ -212,17 +212,17 @@ var gDataMigrator = {</span>
<a href="#l18.61"></a><span id="l18.61"> </span>
<a href="#l18.62"></a><span id="l18.62">     let evoDir = this.dirService.get(&quot;Home&quot;, Ci.nsIFile);</span>
<a href="#l18.63"></a><span id="l18.63">     evoDir.append(&quot;.evolution&quot;);</span>
<a href="#l18.64"></a><span id="l18.64">     evoDir.append(&quot;calendar&quot;);</span>
<a href="#l18.65"></a><span id="l18.65">     evoDir.append(&quot;local&quot;);</span>
<a href="#l18.66"></a><span id="l18.66">     return evoDir.exists() ? [new dataMigrator(&quot;Evolution&quot;, evoMigrate, [evoDir])] : [];</span>
<a href="#l18.67"></a><span id="l18.67">   },</span>
<a href="#l18.68"></a><span id="l18.68"> </span>
<a href="#l18.69"></a><span id="l18.69" class="difflineminus">-  checkWindowsMail: function() {</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+  checkWindowsMail() {</span>
<a href="#l18.71"></a><span id="l18.71">     function doMigrate(aCalendarNodes, aMailDir, aCallback) {</span>
<a href="#l18.72"></a><span id="l18.72">       let calManager = cal.getCalendarManager();</span>
<a href="#l18.73"></a><span id="l18.73"> </span>
<a href="#l18.74"></a><span id="l18.74">       for (let node of aCalendarNodes) {</span>
<a href="#l18.75"></a><span id="l18.75">         let name = node.getElementsByTagName(&quot;Name&quot;)[0].textContent;</span>
<a href="#l18.76"></a><span id="l18.76">         let color = node.getElementsByTagName(&quot;Color&quot;)[0].textContent;</span>
<a href="#l18.77"></a><span id="l18.77">         let enabled = node.getElementsByTagName(&quot;Enabled&quot;)[0].textContent == &quot;True&quot;;</span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79" class="difflineat">@@ -289,17 +289,17 @@ var gDataMigrator = {</span>
<a href="#l18.80"></a><span id="l18.80">     return migrators;</span>
<a href="#l18.81"></a><span id="l18.81">   },</span>
<a href="#l18.82"></a><span id="l18.82"> </span>
<a href="#l18.83"></a><span id="l18.83">   /**</span>
<a href="#l18.84"></a><span id="l18.84">    * Creates and registers a storage calendar and imports the given ics file into it.</span>
<a href="#l18.85"></a><span id="l18.85">    *</span>
<a href="#l18.86"></a><span id="l18.86">    * @param icsFile     The nsI(Local)File to import.</span>
<a href="#l18.87"></a><span id="l18.87">    */</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-  importICSToStorage: function(icsFile) {</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  importICSToStorage(icsFile) {</span>
<a href="#l18.90"></a><span id="l18.90">     const uri = &quot;moz-storage-calendar://&quot;;</span>
<a href="#l18.91"></a><span id="l18.91">     let calendar = cal.getCalendarManager().createCalendar(&quot;storage&quot;, Services.io.newURI(uri));</span>
<a href="#l18.92"></a><span id="l18.92">     let icsImporter = Cc[&quot;@mozilla.org/calendar/import;1?type=ics&quot;].getService(Ci.calIImporter);</span>
<a href="#l18.93"></a><span id="l18.93"> </span>
<a href="#l18.94"></a><span id="l18.94">     let inputStream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;].createInstance(</span>
<a href="#l18.95"></a><span id="l18.95">       Ci.nsIFileInputStream</span>
<a href="#l18.96"></a><span id="l18.96">     );</span>
<a href="#l18.97"></a><span id="l18.97">     let items = [];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/calendar/base/content/calendar-multiday-base-view.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/calendar/base/content/calendar-multiday-base-view.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -391,29 +391,27 @@</span>
<a href="#l19.4"></a><span id="l19.4">       return this.mDateList != null;</span>
<a href="#l19.5"></a><span id="l19.5">     }</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7">     get startDate() {</span>
<a href="#l19.8"></a><span id="l19.8">       if (this.mStartDate) {</span>
<a href="#l19.9"></a><span id="l19.9">         return this.mStartDate;</span>
<a href="#l19.10"></a><span id="l19.10">       } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l19.11"></a><span id="l19.11">         return this.mDateList[0];</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-      } else {</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-        return null;</span>
<a href="#l19.14"></a><span id="l19.14">       }</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+      return null;</span>
<a href="#l19.16"></a><span id="l19.16">     }</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18">     get endDate() {</span>
<a href="#l19.19"></a><span id="l19.19">       if (this.mEndDate) {</span>
<a href="#l19.20"></a><span id="l19.20">         return this.mEndDate;</span>
<a href="#l19.21"></a><span id="l19.21">       } else if (this.mDateList &amp;&amp; this.mDateList.length &gt; 0) {</span>
<a href="#l19.22"></a><span id="l19.22">         return this.mDateList[this.mDateList.length - 1];</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-      } else {</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-        return null;</span>
<a href="#l19.25"></a><span id="l19.25">       }</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+      return null;</span>
<a href="#l19.27"></a><span id="l19.27">     }</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29">     set selectedDay(day) {</span>
<a href="#l19.30"></a><span id="l19.30">       // Ignore if just 1 visible, it's always selected, but we don't indicate it.</span>
<a href="#l19.31"></a><span id="l19.31">       if (this.numVisibleDates == 1) {</span>
<a href="#l19.32"></a><span id="l19.32">         this.fireEvent(&quot;dayselect&quot;, day);</span>
<a href="#l19.33"></a><span id="l19.33">         return day;</span>
<a href="#l19.34"></a><span id="l19.34">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/calendar/base/content/calendar-statusbar.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/calendar/base/content/calendar-statusbar.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -20,36 +20,36 @@ var gCalendarStatusFeedback = {</span>
<a href="#l20.4"></a><span id="l20.4">   mThrobber: null,</span>
<a href="#l20.5"></a><span id="l20.5">   mProgressMode: Ci.calIStatusObserver.NO_PROGRESS,</span>
<a href="#l20.6"></a><span id="l20.6">   mCurIndex: 0,</span>
<a href="#l20.7"></a><span id="l20.7">   mInitialized: false,</span>
<a href="#l20.8"></a><span id="l20.8">   mCalendars: {},</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">   QueryInterface: ChromeUtils.generateQI([Ci.calIStatusObserver]),</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-  initialize: function(aWindow) {</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  initialize(aWindow) {</span>
<a href="#l20.14"></a><span id="l20.14">     if (!this.mInitialized) {</span>
<a href="#l20.15"></a><span id="l20.15">       this.mWindow = aWindow;</span>
<a href="#l20.16"></a><span id="l20.16">       this.mStatusText = this.mWindow.document.getElementById(&quot;statusText&quot;);</span>
<a href="#l20.17"></a><span id="l20.17">       this.mStatusBar = this.mWindow.document.getElementById(&quot;statusbar-icon&quot;);</span>
<a href="#l20.18"></a><span id="l20.18">       this.mStatusProgressPanel = this.mWindow.document.getElementById(&quot;statusbar-progresspanel&quot;);</span>
<a href="#l20.19"></a><span id="l20.19">       this.mThrobber = this.mWindow.document.getElementById(&quot;navigator-throbber&quot;);</span>
<a href="#l20.20"></a><span id="l20.20">       this.mInitialized = true;</span>
<a href="#l20.21"></a><span id="l20.21">     }</span>
<a href="#l20.22"></a><span id="l20.22">   },</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24" class="difflineminus">-  showStatusString: function(status) {</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+  showStatusString(status) {</span>
<a href="#l20.26"></a><span id="l20.26">     this.mStatusText.setAttribute(&quot;label&quot;, status);</span>
<a href="#l20.27"></a><span id="l20.27">   },</span>
<a href="#l20.28"></a><span id="l20.28"> </span>
<a href="#l20.29"></a><span id="l20.29">   get spinning() {</span>
<a href="#l20.30"></a><span id="l20.30">     return this.mProgressMode;</span>
<a href="#l20.31"></a><span id="l20.31">   },</span>
<a href="#l20.32"></a><span id="l20.32"> </span>
<a href="#l20.33"></a><span id="l20.33" class="difflineminus">-  startMeteors: function(aProgressMode, aCalendarCount) {</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  startMeteors(aProgressMode, aCalendarCount) {</span>
<a href="#l20.35"></a><span id="l20.35">     if (aProgressMode != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l20.36"></a><span id="l20.36">       if (!this.mInitialized) {</span>
<a href="#l20.37"></a><span id="l20.37">         Cu.reportError(&quot;StatusObserver has not been initialized!&quot;);</span>
<a href="#l20.38"></a><span id="l20.38">         return;</span>
<a href="#l20.39"></a><span id="l20.39">       }</span>
<a href="#l20.40"></a><span id="l20.40">       this.mCalendars = {};</span>
<a href="#l20.41"></a><span id="l20.41">       this.mCurIndex = 0;</span>
<a href="#l20.42"></a><span id="l20.42">       if (aCalendarCount) {</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineat">@@ -64,33 +64,33 @@ var gCalendarStatusFeedback = {</span>
<a href="#l20.44"></a><span id="l20.44">         this.showStatusString(commonStatus);</span>
<a href="#l20.45"></a><span id="l20.45">       }</span>
<a href="#l20.46"></a><span id="l20.46">       if (this.mThrobber) {</span>
<a href="#l20.47"></a><span id="l20.47">         this.mThrobber.setAttribute(&quot;busy&quot;, true);</span>
<a href="#l20.48"></a><span id="l20.48">       }</span>
<a href="#l20.49"></a><span id="l20.49">     }</span>
<a href="#l20.50"></a><span id="l20.50">   },</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52" class="difflineminus">-  stopMeteors: function() {</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+  stopMeteors() {</span>
<a href="#l20.54"></a><span id="l20.54">     if (!this.mInitialized) {</span>
<a href="#l20.55"></a><span id="l20.55">       return;</span>
<a href="#l20.56"></a><span id="l20.56">     }</span>
<a href="#l20.57"></a><span id="l20.57">     if (this.spinning != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l20.58"></a><span id="l20.58">       this.mProgressMode = Ci.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l20.59"></a><span id="l20.59">       this.mStatusProgressPanel.collapsed = true;</span>
<a href="#l20.60"></a><span id="l20.60">       this.mStatusBar.value = 0;</span>
<a href="#l20.61"></a><span id="l20.61">       this.mCalendarCount = 0;</span>
<a href="#l20.62"></a><span id="l20.62">       this.showStatusString(&quot;&quot;);</span>
<a href="#l20.63"></a><span id="l20.63">       if (this.mThrobber) {</span>
<a href="#l20.64"></a><span id="l20.64">         this.mThrobber.setAttribute(&quot;busy&quot;, false);</span>
<a href="#l20.65"></a><span id="l20.65">       }</span>
<a href="#l20.66"></a><span id="l20.66">     }</span>
<a href="#l20.67"></a><span id="l20.67">   },</span>
<a href="#l20.68"></a><span id="l20.68"> </span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-  calendarCompleted: function(aCalendar) {</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+  calendarCompleted(aCalendar) {</span>
<a href="#l20.71"></a><span id="l20.71">     if (!this.mInitialized) {</span>
<a href="#l20.72"></a><span id="l20.72">       return;</span>
<a href="#l20.73"></a><span id="l20.73">     }</span>
<a href="#l20.74"></a><span id="l20.74">     if (this.spinning != Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l20.75"></a><span id="l20.75">       if (this.spinning == Ci.calIStatusObserver.DETERMINED_PROGRESS) {</span>
<a href="#l20.76"></a><span id="l20.76">         if (!this.mCalendars[aCalendar.id] || this.mCalendars[aCalendar.id] === undefined) {</span>
<a href="#l20.77"></a><span id="l20.77">           this.mCalendars[aCalendar.id] = true;</span>
<a href="#l20.78"></a><span id="l20.78">           this.mStatusBar.value = parseInt(this.mStatusBar.value, 10) + this.mCalendarStep;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/calendar/base/content/calendar-task-editing.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-editing.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -45,28 +45,28 @@ var taskEdit = {</span>
<a href="#l21.4"></a><span id="l21.4">   /**</span>
<a href="#l21.5"></a><span id="l21.5">    * Helper function to set readonly and aria-disabled states and the value</span>
<a href="#l21.6"></a><span id="l21.6">    * for a given target.</span>
<a href="#l21.7"></a><span id="l21.7">    *</span>
<a href="#l21.8"></a><span id="l21.8">    * @param aTarget   The ID or XUL node to set the value</span>
<a href="#l21.9"></a><span id="l21.9">    * @param aDisable  A boolean if the target should be disabled.</span>
<a href="#l21.10"></a><span id="l21.10">    * @param aValue    The value that should be set on the target.</span>
<a href="#l21.11"></a><span id="l21.11">    */</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  setupTaskField: function(aTarget, aDisable, aValue) {</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+  setupTaskField(aTarget, aDisable, aValue) {</span>
<a href="#l21.14"></a><span id="l21.14">     aTarget.value = aValue;</span>
<a href="#l21.15"></a><span id="l21.15">     setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;readonly&quot;);</span>
<a href="#l21.16"></a><span id="l21.16">     setElementValue(aTarget, aDisable &amp;&amp; &quot;true&quot;, &quot;aria-disabled&quot;);</span>
<a href="#l21.17"></a><span id="l21.17">   },</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19">   /**</span>
<a href="#l21.20"></a><span id="l21.20">    * Handler function to call when the quick-add input gains focus.</span>
<a href="#l21.21"></a><span id="l21.21">    *</span>
<a href="#l21.22"></a><span id="l21.22">    * @param aEvent    The DOM focus event</span>
<a href="#l21.23"></a><span id="l21.23">    */</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineminus">-  onFocus: function(aEvent) {</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  onFocus(aEvent) {</span>
<a href="#l21.26"></a><span id="l21.26">     let edit = aEvent.target;</span>
<a href="#l21.27"></a><span id="l21.27">     let calendar = getSelectedCalendar();</span>
<a href="#l21.28"></a><span id="l21.28">     edit.showsInstructions = true;</span>
<a href="#l21.29"></a><span id="l21.29"> </span>
<a href="#l21.30"></a><span id="l21.30">     if (calendar.getProperty(&quot;capabilities.tasks.supported&quot;) === false) {</span>
<a href="#l21.31"></a><span id="l21.31">       taskEdit.setupTaskField(edit, true, cal.l10n.getCalString(&quot;taskEditInstructionsCapability&quot;));</span>
<a href="#l21.32"></a><span id="l21.32">     } else if (cal.acl.isCalendarWritable(calendar)) {</span>
<a href="#l21.33"></a><span id="l21.33">       edit.showsInstructions = false;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineat">@@ -76,17 +76,17 @@ var taskEdit = {</span>
<a href="#l21.35"></a><span id="l21.35">     }</span>
<a href="#l21.36"></a><span id="l21.36">   },</span>
<a href="#l21.37"></a><span id="l21.37"> </span>
<a href="#l21.38"></a><span id="l21.38">   /**</span>
<a href="#l21.39"></a><span id="l21.39">    * Handler function to call when the quick-add input loses focus.</span>
<a href="#l21.40"></a><span id="l21.40">    *</span>
<a href="#l21.41"></a><span id="l21.41">    * @param aEvent    The DOM blur event</span>
<a href="#l21.42"></a><span id="l21.42">    */</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-  onBlur: function(aEvent) {</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+  onBlur(aEvent) {</span>
<a href="#l21.45"></a><span id="l21.45">     let edit = aEvent.target;</span>
<a href="#l21.46"></a><span id="l21.46">     let calendar = getSelectedCalendar();</span>
<a href="#l21.47"></a><span id="l21.47">     if (!calendar) {</span>
<a href="#l21.48"></a><span id="l21.48">       // this must be a first run, we don't have a calendar yet</span>
<a href="#l21.49"></a><span id="l21.49">       return;</span>
<a href="#l21.50"></a><span id="l21.50">     }</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52">     if (calendar.getProperty(&quot;capabilities.tasks.supported&quot;) === false) {</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineat">@@ -102,17 +102,17 @@ var taskEdit = {</span>
<a href="#l21.54"></a><span id="l21.54">     edit.showsInstructions = true;</span>
<a href="#l21.55"></a><span id="l21.55">   },</span>
<a href="#l21.56"></a><span id="l21.56"> </span>
<a href="#l21.57"></a><span id="l21.57">   /**</span>
<a href="#l21.58"></a><span id="l21.58">    * Handler function to call on keypress for the quick-add input.</span>
<a href="#l21.59"></a><span id="l21.59">    *</span>
<a href="#l21.60"></a><span id="l21.60">    * @param aEvent    The DOM keypress event</span>
<a href="#l21.61"></a><span id="l21.61">    */</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineminus">-  onKeyPress: function(aEvent) {</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+  onKeyPress(aEvent) {</span>
<a href="#l21.64"></a><span id="l21.64">     if (aEvent.key == &quot;Enter&quot;) {</span>
<a href="#l21.65"></a><span id="l21.65">       let edit = aEvent.target;</span>
<a href="#l21.66"></a><span id="l21.66">       if (edit.value &amp;&amp; edit.value.length &gt; 0) {</span>
<a href="#l21.67"></a><span id="l21.67">         let item = cal.createTodo();</span>
<a href="#l21.68"></a><span id="l21.68">         setDefaultItemValues(item);</span>
<a href="#l21.69"></a><span id="l21.69">         item.title = edit.value;</span>
<a href="#l21.70"></a><span id="l21.70"> </span>
<a href="#l21.71"></a><span id="l21.71">         edit.value = &quot;&quot;;</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineat">@@ -120,53 +120,53 @@ var taskEdit = {</span>
<a href="#l21.73"></a><span id="l21.73">       }</span>
<a href="#l21.74"></a><span id="l21.74">     }</span>
<a href="#l21.75"></a><span id="l21.75">   },</span>
<a href="#l21.76"></a><span id="l21.76"> </span>
<a href="#l21.77"></a><span id="l21.77">   /**</span>
<a href="#l21.78"></a><span id="l21.78">    * Window load function to set up all quick-add inputs. The input must</span>
<a href="#l21.79"></a><span id="l21.79">    * have the class &quot;task-edit-field&quot;.</span>
<a href="#l21.80"></a><span id="l21.80">    */</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineminus">-  onLoad: function(aEvent) {</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+  onLoad(aEvent) {</span>
<a href="#l21.83"></a><span id="l21.83">     let taskEditFields = document.getElementsByClassName(&quot;task-edit-field&quot;);</span>
<a href="#l21.84"></a><span id="l21.84">     for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l21.85"></a><span id="l21.85">       taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l21.86"></a><span id="l21.86">     }</span>
<a href="#l21.87"></a><span id="l21.87"> </span>
<a href="#l21.88"></a><span id="l21.88">     cal.view.getCompositeCalendar(window).addObserver(taskEdit.compositeObserver);</span>
<a href="#l21.89"></a><span id="l21.89">     taskEdit.observedCalendar = getSelectedCalendar();</span>
<a href="#l21.90"></a><span id="l21.90">   },</span>
<a href="#l21.91"></a><span id="l21.91"> </span>
<a href="#l21.92"></a><span id="l21.92">   /**</span>
<a href="#l21.93"></a><span id="l21.93">    * Window load function to clean up all quick-add fields.</span>
<a href="#l21.94"></a><span id="l21.94">    */</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineminus">-  onUnload: function() {</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+  onUnload() {</span>
<a href="#l21.97"></a><span id="l21.97">     cal.view.getCompositeCalendar(window).removeObserver(taskEdit.compositeObserver);</span>
<a href="#l21.98"></a><span id="l21.98">     taskEdit.observedCalendar = null;</span>
<a href="#l21.99"></a><span id="l21.99">   },</span>
<a href="#l21.100"></a><span id="l21.100"> </span>
<a href="#l21.101"></a><span id="l21.101">   /**</span>
<a href="#l21.102"></a><span id="l21.102">    * Observer to watch for readonly, disabled and capability changes of the</span>
<a href="#l21.103"></a><span id="l21.103">    * observed calendar.</span>
<a href="#l21.104"></a><span id="l21.104">    *</span>
<a href="#l21.105"></a><span id="l21.105">    * @see calIObserver</span>
<a href="#l21.106"></a><span id="l21.106">    */</span>
<a href="#l21.107"></a><span id="l21.107">   calendarObserver: {</span>
<a href="#l21.108"></a><span id="l21.108">     QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l21.109"></a><span id="l21.109"> </span>
<a href="#l21.110"></a><span id="l21.110">     // calIObserver:</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineminus">-    onStartBatch: function() {},</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineminus">-    onEndBatch: function() {},</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineminus">-    onLoad: function(aCalendar) {},</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineminus">-    onAddItem: function(aItem) {},</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineminus">-    onModifyItem: function(aNewItem, aOldItem) {},</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineminus">-    onDeleteItem: function(aDeletedItem) {},</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-    onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+    onStartBatch() {},</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+    onEndBatch() {},</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+    onLoad(aCalendar) {},</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+    onAddItem(aItem) {},</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    onModifyItem(aNewItem, aOldItem) {},</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+    onDeleteItem(aDeletedItem) {},</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+    onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l21.125"></a><span id="l21.125"> </span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-    onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+    onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l21.128"></a><span id="l21.128">       if (aCalendar.id != getSelectedCalendar().id) {</span>
<a href="#l21.129"></a><span id="l21.129">         // Optimization: if the given calendar isn't the default calendar,</span>
<a href="#l21.130"></a><span id="l21.130">         // then we don't need to change any readonly/disabled states.</span>
<a href="#l21.131"></a><span id="l21.131">         return;</span>
<a href="#l21.132"></a><span id="l21.132">       }</span>
<a href="#l21.133"></a><span id="l21.133">       switch (aName) {</span>
<a href="#l21.134"></a><span id="l21.134">         case &quot;readOnly&quot;:</span>
<a href="#l21.135"></a><span id="l21.135">         case &quot;disabled&quot;: {</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineat">@@ -174,17 +174,17 @@ var taskEdit = {</span>
<a href="#l21.137"></a><span id="l21.137">           for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l21.138"></a><span id="l21.138">             taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l21.139"></a><span id="l21.139">           }</span>
<a href="#l21.140"></a><span id="l21.140">           break;</span>
<a href="#l21.141"></a><span id="l21.141">         }</span>
<a href="#l21.142"></a><span id="l21.142">       }</span>
<a href="#l21.143"></a><span id="l21.143">     },</span>
<a href="#l21.144"></a><span id="l21.144"> </span>
<a href="#l21.145"></a><span id="l21.145" class="difflineminus">-    onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+    onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l21.147"></a><span id="l21.147">       // Since the old value is not used directly in onPropertyChanged,</span>
<a href="#l21.148"></a><span id="l21.148">       // but should not be the same as the value, set it to a different</span>
<a href="#l21.149"></a><span id="l21.149">       // value.</span>
<a href="#l21.150"></a><span id="l21.150">       this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l21.151"></a><span id="l21.151">     },</span>
<a href="#l21.152"></a><span id="l21.152">   },</span>
<a href="#l21.153"></a><span id="l21.153"> </span>
<a href="#l21.154"></a><span id="l21.154">   /**</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineat">@@ -193,30 +193,30 @@ var taskEdit = {</span>
<a href="#l21.156"></a><span id="l21.156">    * XXX I think we don't need to implement calIObserver here.</span>
<a href="#l21.157"></a><span id="l21.157">    *</span>
<a href="#l21.158"></a><span id="l21.158">    * @see calICompositeObserver</span>
<a href="#l21.159"></a><span id="l21.159">    */</span>
<a href="#l21.160"></a><span id="l21.160">   compositeObserver: {</span>
<a href="#l21.161"></a><span id="l21.161">     QueryInterface: cal.generateQI([Ci.calIObserver, Ci.calICompositeObserver]),</span>
<a href="#l21.162"></a><span id="l21.162"> </span>
<a href="#l21.163"></a><span id="l21.163">     // calIObserver:</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineminus">-    onStartBatch: function() {},</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineminus">-    onEndBatch: function() {},</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineminus">-    onLoad: function(aCalendar) {},</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineminus">-    onAddItem: function(aItem) {},</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineminus">-    onModifyItem: function(aNewItem, aOldItem) {},</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineminus">-    onDeleteItem: function(aDeletedItem) {},</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineminus">-    onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineminus">-    onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {},</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineminus">-    onPropertyDeleting: function(aCalendar, aName) {},</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+    onStartBatch() {},</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+    onEndBatch() {},</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+    onLoad(aCalendar) {},</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineplus">+    onAddItem(aItem) {},</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineplus">+    onModifyItem(aNewItem, aOldItem) {},</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+    onDeleteItem(aDeletedItem) {},</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+    onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineplus">+    onPropertyChanged(aCalendar, aName, aValue, aOldValue) {},</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+    onPropertyDeleting(aCalendar, aName) {},</span>
<a href="#l21.182"></a><span id="l21.182"> </span>
<a href="#l21.183"></a><span id="l21.183">     // calICompositeObserver:</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineminus">-    onCalendarAdded: function(aCalendar) {},</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineminus">-    onCalendarRemoved: function(aCalendar) {},</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineminus">-    onDefaultCalendarChanged: function(aNewDefault) {</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineplus">+    onCalendarAdded(aCalendar) {},</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+    onCalendarRemoved(aCalendar) {},</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+    onDefaultCalendarChanged(aNewDefault) {</span>
<a href="#l21.190"></a><span id="l21.190">       let taskEditFields = document.getElementsByClassName(&quot;task-edit-field&quot;);</span>
<a href="#l21.191"></a><span id="l21.191">       for (let i = 0; i &lt; taskEditFields.length; i++) {</span>
<a href="#l21.192"></a><span id="l21.192">         taskEdit.onBlur({ target: taskEditFields[i] });</span>
<a href="#l21.193"></a><span id="l21.193">       }</span>
<a href="#l21.194"></a><span id="l21.194">       taskEdit.observedCalendar = aNewDefault;</span>
<a href="#l21.195"></a><span id="l21.195">     },</span>
<a href="#l21.196"></a><span id="l21.196">   },</span>
<a href="#l21.197"></a><span id="l21.197"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/calendar/base/content/calendar-task-tree.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-tree.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -419,20 +419,19 @@</span>
<a href="#l22.4"></a><span id="l22.4">           prefix + PluralForm.get(days, cal.l10n.getCalString(&quot;dueInDays&quot;)).replace(&quot;#1&quot;, days)</span>
<a href="#l22.5"></a><span id="l22.5">         );</span>
<a href="#l22.6"></a><span id="l22.6">       } else if (absMinutes &gt;= 60) {</span>
<a href="#l22.7"></a><span id="l22.7">         // 1 hour or more.</span>
<a href="#l22.8"></a><span id="l22.8">         return (</span>
<a href="#l22.9"></a><span id="l22.9">           prefix +</span>
<a href="#l22.10"></a><span id="l22.10">           PluralForm.get(dur.hours, cal.l10n.getCalString(&quot;dueInHours&quot;)).replace(&quot;#1&quot;, dur.hours)</span>
<a href="#l22.11"></a><span id="l22.11">         );</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-      } else {</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-        // Less than one hour.</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-        return cal.l10n.getCalString(&quot;dueInLessThanOneHour&quot;);</span>
<a href="#l22.15"></a><span id="l22.15">       }</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+      // Less than one hour.</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+      return cal.l10n.getCalString(&quot;dueInLessThanOneHour&quot;);</span>
<a href="#l22.18"></a><span id="l22.18">     }</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20">     /**</span>
<a href="#l22.21"></a><span id="l22.21">      * Return the task object at a given row.</span>
<a href="#l22.22"></a><span id="l22.22">      *</span>
<a href="#l22.23"></a><span id="l22.23">      * @param {number} row        The index number identifying the row.</span>
<a href="#l22.24"></a><span id="l22.24">      * @return {Object | null}    A task object or null if none found.</span>
<a href="#l22.25"></a><span id="l22.25">      */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/calendar/base/content/calendar-task-view.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/calendar/base/content/calendar-task-view.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -17,17 +17,17 @@ var { AppConstants } = ChromeUtils.impor</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> var taskDetailsView = {</span>
<a href="#l23.6"></a><span id="l23.6">   /**</span>
<a href="#l23.7"></a><span id="l23.7">    * Task Details Events</span>
<a href="#l23.8"></a><span id="l23.8">    *</span>
<a href="#l23.9"></a><span id="l23.9">    * XXXberend Please document this function, possibly also consolidate since</span>
<a href="#l23.10"></a><span id="l23.10">    * its the only function in taskDetailsView.</span>
<a href="#l23.11"></a><span id="l23.11">    */</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  onSelect: function(event) {</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  onSelect(event) {</span>
<a href="#l23.14"></a><span id="l23.14">     function displayElement(id, flag) {</span>
<a href="#l23.15"></a><span id="l23.15">       setBooleanAttribute(id, &quot;hidden&quot;, !flag);</span>
<a href="#l23.16"></a><span id="l23.16">       return flag;</span>
<a href="#l23.17"></a><span id="l23.17">     }</span>
<a href="#l23.18"></a><span id="l23.18"> </span>
<a href="#l23.19"></a><span id="l23.19">     let dateFormatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(</span>
<a href="#l23.20"></a><span id="l23.20">       Ci.calIDateTimeFormatter</span>
<a href="#l23.21"></a><span id="l23.21">     );</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -187,17 +187,17 @@ var taskDetailsView = {</span>
<a href="#l23.23"></a><span id="l23.23">           urlLabel.setAttribute(&quot;onclick&quot;, &quot;if (event.button != 2) launchBrowser(this.value);&quot;);</span>
<a href="#l23.24"></a><span id="l23.24">           urlLabel.setAttribute(&quot;context&quot;, &quot;taskview-link-context-menu&quot;);</span>
<a href="#l23.25"></a><span id="l23.25">           attachmentRows.appendChild(urlLabel);</span>
<a href="#l23.26"></a><span id="l23.26">         }</span>
<a href="#l23.27"></a><span id="l23.27">       }</span>
<a href="#l23.28"></a><span id="l23.28">     }</span>
<a href="#l23.29"></a><span id="l23.29">   },</span>
<a href="#l23.30"></a><span id="l23.30"> </span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  loadCategories: function() {</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+  loadCategories() {</span>
<a href="#l23.33"></a><span id="l23.33">     let categoryPopup = document.getElementById(&quot;task-actions-category-popup&quot;);</span>
<a href="#l23.34"></a><span id="l23.34">     let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36">     let itemCategories = item.getCategories();</span>
<a href="#l23.37"></a><span id="l23.37">     let categoryList = cal.category.fromPrefs();</span>
<a href="#l23.38"></a><span id="l23.38">     for (let cat of itemCategories) {</span>
<a href="#l23.39"></a><span id="l23.39">       if (!categoryList.includes(cat)) {</span>
<a href="#l23.40"></a><span id="l23.40">         categoryList.push(cat);</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineat">@@ -228,17 +228,17 @@ var taskDetailsView = {</span>
<a href="#l23.42"></a><span id="l23.42">       menuitem.setAttribute(&quot;type&quot;, maxCount === null || maxCount &gt; 1 ? &quot;checkbox&quot; : &quot;radio&quot;);</span>
<a href="#l23.43"></a><span id="l23.43">       if (itemCategories.includes(cat)) {</span>
<a href="#l23.44"></a><span id="l23.44">         menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l23.45"></a><span id="l23.45">       }</span>
<a href="#l23.46"></a><span id="l23.46">       categoryPopup.appendChild(menuitem);</span>
<a href="#l23.47"></a><span id="l23.47">     }</span>
<a href="#l23.48"></a><span id="l23.48">   },</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50" class="difflineminus">-  saveCategories: function(event) {</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+  saveCategories(event) {</span>
<a href="#l23.52"></a><span id="l23.52">     let categoryPopup = document.getElementById(&quot;task-actions-category-popup&quot;);</span>
<a href="#l23.53"></a><span id="l23.53">     let item = document.getElementById(&quot;calendar-task-tree&quot;).currentTask;</span>
<a href="#l23.54"></a><span id="l23.54"> </span>
<a href="#l23.55"></a><span id="l23.55">     let oldCategories = item.getCategories();</span>
<a href="#l23.56"></a><span id="l23.56">     let categories = Array.from(</span>
<a href="#l23.57"></a><span id="l23.57">       categoryPopup.querySelectorAll(&quot;menuitem.calendar-category[checked]&quot;),</span>
<a href="#l23.58"></a><span id="l23.58">       menuitem =&gt; menuitem.value</span>
<a href="#l23.59"></a><span id="l23.59">     );</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineat">@@ -252,17 +252,17 @@ var taskDetailsView = {</span>
<a href="#l23.61"></a><span id="l23.61">       newItem.setCategories(categories);</span>
<a href="#l23.62"></a><span id="l23.62">       doTransaction(&quot;modify&quot;, newItem, newItem.calendar, item, null);</span>
<a href="#l23.63"></a><span id="l23.63">       return false;</span>
<a href="#l23.64"></a><span id="l23.64">     }</span>
<a href="#l23.65"></a><span id="l23.65"> </span>
<a href="#l23.66"></a><span id="l23.66">     return true;</span>
<a href="#l23.67"></a><span id="l23.67">   },</span>
<a href="#l23.68"></a><span id="l23.68"> </span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-  categoryTextboxKeypress: function(event) {</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineplus">+  categoryTextboxKeypress(event) {</span>
<a href="#l23.71"></a><span id="l23.71">     let category = event.target.value;</span>
<a href="#l23.72"></a><span id="l23.72">     let categoryPopup = document.getElementById(&quot;task-actions-category-popup&quot;);</span>
<a href="#l23.73"></a><span id="l23.73"> </span>
<a href="#l23.74"></a><span id="l23.74">     switch (event.key) {</span>
<a href="#l23.75"></a><span id="l23.75">       case &quot; &quot;: {</span>
<a href="#l23.76"></a><span id="l23.76">         // The menu popup seems to eat this keypress.</span>
<a href="#l23.77"></a><span id="l23.77">         let start = event.target.selectionStart;</span>
<a href="#l23.78"></a><span id="l23.78">         event.target.value =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/calendar/base/content/calendar-unifinder.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/calendar/base/content/calendar-unifinder.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -62,93 +62,93 @@ function getCurrentUnifinderFilter() {</span>
<a href="#l24.4"></a><span id="l24.4">  *</span>
<a href="#l24.5"></a><span id="l24.5">  * @see calIObserver</span>
<a href="#l24.6"></a><span id="l24.6">  * @see calICompositeObserver</span>
<a href="#l24.7"></a><span id="l24.7">  */</span>
<a href="#l24.8"></a><span id="l24.8"> var unifinderObserver = {</span>
<a href="#l24.9"></a><span id="l24.9">   QueryInterface: cal.generateQI([Ci.calICompositeObserver, Ci.nsIObserver, Ci.calIObserver]),</span>
<a href="#l24.10"></a><span id="l24.10"> </span>
<a href="#l24.11"></a><span id="l24.11">   // calIObserver:</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  onStartBatch() {</span>
<a href="#l24.14"></a><span id="l24.14">     gUnifinderNeedsRefresh = true;</span>
<a href="#l24.15"></a><span id="l24.15">   },</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17" class="difflineminus">-  onEndBatch: function() {},</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  onEndBatch() {},</span>
<a href="#l24.19"></a><span id="l24.19"> </span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-  onLoad: function() {</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+  onLoad() {</span>
<a href="#l24.22"></a><span id="l24.22">     if (isUnifinderHidden()) {</span>
<a href="#l24.23"></a><span id="l24.23">       // If the unifinder is hidden, all further item operations might</span>
<a href="#l24.24"></a><span id="l24.24">       // produce invalid entries in the unifinder. From now on, ignore</span>
<a href="#l24.25"></a><span id="l24.25">       // those operations and refresh as soon as the unifinder is shown</span>
<a href="#l24.26"></a><span id="l24.26">       // again.</span>
<a href="#l24.27"></a><span id="l24.27">       gUnifinderNeedsRefresh = true;</span>
<a href="#l24.28"></a><span id="l24.28">       unifinderTreeView.clearItems();</span>
<a href="#l24.29"></a><span id="l24.29">     } else {</span>
<a href="#l24.30"></a><span id="l24.30">       refreshEventTree();</span>
<a href="#l24.31"></a><span id="l24.31">     }</span>
<a href="#l24.32"></a><span id="l24.32">   },</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l24.36"></a><span id="l24.36">     if (</span>
<a href="#l24.37"></a><span id="l24.37">       cal.item.isEvent(aItem) &amp;&amp;</span>
<a href="#l24.38"></a><span id="l24.38">       !gUnifinderNeedsRefresh &amp;&amp;</span>
<a href="#l24.39"></a><span id="l24.39">       unifinderTreeView.mFilter.isItemInFilters(aItem)</span>
<a href="#l24.40"></a><span id="l24.40">     ) {</span>
<a href="#l24.41"></a><span id="l24.41">       this.addItemToTree(aItem);</span>
<a href="#l24.42"></a><span id="l24.42">     }</span>
<a href="#l24.43"></a><span id="l24.43">   },</span>
<a href="#l24.44"></a><span id="l24.44"> </span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l24.47"></a><span id="l24.47">     this.onDeleteItem(aOldItem);</span>
<a href="#l24.48"></a><span id="l24.48">     this.onAddItem(aNewItem);</span>
<a href="#l24.49"></a><span id="l24.49">   },</span>
<a href="#l24.50"></a><span id="l24.50"> </span>
<a href="#l24.51"></a><span id="l24.51" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l24.53"></a><span id="l24.53">     if (cal.item.isEvent(aDeletedItem) &amp;&amp; !gUnifinderNeedsRefresh) {</span>
<a href="#l24.54"></a><span id="l24.54">       this.removeItemFromTree(aDeletedItem);</span>
<a href="#l24.55"></a><span id="l24.55">     }</span>
<a href="#l24.56"></a><span id="l24.56">   },</span>
<a href="#l24.57"></a><span id="l24.57"> </span>
<a href="#l24.58"></a><span id="l24.58" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l24.60"></a><span id="l24.60"> </span>
<a href="#l24.61"></a><span id="l24.61" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l24.63"></a><span id="l24.63">     switch (aName) {</span>
<a href="#l24.64"></a><span id="l24.64">       case &quot;disabled&quot;:</span>
<a href="#l24.65"></a><span id="l24.65">         refreshEventTree();</span>
<a href="#l24.66"></a><span id="l24.66">         break;</span>
<a href="#l24.67"></a><span id="l24.67">     }</span>
<a href="#l24.68"></a><span id="l24.68">   },</span>
<a href="#l24.69"></a><span id="l24.69"> </span>
<a href="#l24.70"></a><span id="l24.70" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l24.72"></a><span id="l24.72">     this.onPropertyChanged(aCalendar, aName, null, null);</span>
<a href="#l24.73"></a><span id="l24.73">   },</span>
<a href="#l24.74"></a><span id="l24.74"> </span>
<a href="#l24.75"></a><span id="l24.75">   // calICompositeObserver:</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineminus">-  onCalendarAdded: function(aAddedCalendar) {</span>
<a href="#l24.77"></a><span id="l24.77" class="difflineplus">+  onCalendarAdded(aAddedCalendar) {</span>
<a href="#l24.78"></a><span id="l24.78">     if (!aAddedCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l24.79"></a><span id="l24.79">       addItemsFromCalendar(aAddedCalendar, addItemsFromSingleCalendarInternal);</span>
<a href="#l24.80"></a><span id="l24.80">     }</span>
<a href="#l24.81"></a><span id="l24.81">   },</span>
<a href="#l24.82"></a><span id="l24.82"> </span>
<a href="#l24.83"></a><span id="l24.83" class="difflineminus">-  onCalendarRemoved: function(aDeletedCalendar) {</span>
<a href="#l24.84"></a><span id="l24.84" class="difflineplus">+  onCalendarRemoved(aDeletedCalendar) {</span>
<a href="#l24.85"></a><span id="l24.85">     if (!aDeletedCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l24.86"></a><span id="l24.86">       deleteItemsFromCalendar(aDeletedCalendar);</span>
<a href="#l24.87"></a><span id="l24.87">     }</span>
<a href="#l24.88"></a><span id="l24.88">   },</span>
<a href="#l24.89"></a><span id="l24.89"> </span>
<a href="#l24.90"></a><span id="l24.90" class="difflineminus">-  onDefaultCalendarChanged: function(aNewDefaultCalendar) {},</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineplus">+  onDefaultCalendarChanged(aNewDefaultCalendar) {},</span>
<a href="#l24.92"></a><span id="l24.92"> </span>
<a href="#l24.93"></a><span id="l24.93">   /**</span>
<a href="#l24.94"></a><span id="l24.94">    * Add an unifinder item to the tree. It is safe to call these for any</span>
<a href="#l24.95"></a><span id="l24.95">    * event. The functions will determine whether or not anything actually</span>
<a href="#l24.96"></a><span id="l24.96">    * needs to be done to the tree.</span>
<a href="#l24.97"></a><span id="l24.97">    *</span>
<a href="#l24.98"></a><span id="l24.98">    * @return aItem        The item to add to the tree.</span>
<a href="#l24.99"></a><span id="l24.99">    */</span>
<a href="#l24.100"></a><span id="l24.100" class="difflineminus">-  addItemToTree: function(aItem) {</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineplus">+  addItemToTree(aItem) {</span>
<a href="#l24.102"></a><span id="l24.102">     let items;</span>
<a href="#l24.103"></a><span id="l24.103">     let filter = unifinderTreeView.mFilter;</span>
<a href="#l24.104"></a><span id="l24.104"> </span>
<a href="#l24.105"></a><span id="l24.105">     if (filter.startDate &amp;&amp; filter.endDate) {</span>
<a href="#l24.106"></a><span id="l24.106">       items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate);</span>
<a href="#l24.107"></a><span id="l24.107">     } else {</span>
<a href="#l24.108"></a><span id="l24.108">       items = [aItem];</span>
<a href="#l24.109"></a><span id="l24.109">     }</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineat">@@ -157,29 +157,29 @@ var unifinderObserver = {</span>
<a href="#l24.111"></a><span id="l24.111"> </span>
<a href="#l24.112"></a><span id="l24.112">   /**</span>
<a href="#l24.113"></a><span id="l24.113">    * Remove an item from the unifinder tree. It is safe to call these for any</span>
<a href="#l24.114"></a><span id="l24.114">    * event. The functions will determine whether or not anything actually</span>
<a href="#l24.115"></a><span id="l24.115">    * needs to be done to the tree.</span>
<a href="#l24.116"></a><span id="l24.116">    *</span>
<a href="#l24.117"></a><span id="l24.117">    * @return aItem        The item to remove from the tree.</span>
<a href="#l24.118"></a><span id="l24.118">    */</span>
<a href="#l24.119"></a><span id="l24.119" class="difflineminus">-  removeItemFromTree: function(aItem) {</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineplus">+  removeItemFromTree(aItem) {</span>
<a href="#l24.121"></a><span id="l24.121">     let items;</span>
<a href="#l24.122"></a><span id="l24.122">     let filter = unifinderTreeView.mFilter;</span>
<a href="#l24.123"></a><span id="l24.123">     if (filter.startDate &amp;&amp; filter.endDate &amp;&amp; aItem.parentItem == aItem) {</span>
<a href="#l24.124"></a><span id="l24.124">       items = aItem.getOccurrencesBetween(filter.startDate, filter.endDate);</span>
<a href="#l24.125"></a><span id="l24.125">     } else {</span>
<a href="#l24.126"></a><span id="l24.126">       items = [aItem];</span>
<a href="#l24.127"></a><span id="l24.127">     }</span>
<a href="#l24.128"></a><span id="l24.128">     // XXX: do we really still need this, we are always checking it in the refreshInternal</span>
<a href="#l24.129"></a><span id="l24.129">     unifinderTreeView.removeItems(items.filter(filter.isItemInFilters, filter));</span>
<a href="#l24.130"></a><span id="l24.130">   },</span>
<a href="#l24.131"></a><span id="l24.131"> </span>
<a href="#l24.132"></a><span id="l24.132" class="difflineminus">-  observe: function() {</span>
<a href="#l24.133"></a><span id="l24.133" class="difflineplus">+  observe() {</span>
<a href="#l24.134"></a><span id="l24.134">     refreshEventTree();</span>
<a href="#l24.135"></a><span id="l24.135">   },</span>
<a href="#l24.136"></a><span id="l24.136"> };</span>
<a href="#l24.137"></a><span id="l24.137"> </span>
<a href="#l24.138"></a><span id="l24.138"> /**</span>
<a href="#l24.139"></a><span id="l24.139">  * Called when the window is loaded to prepare the unifinder. This function is</span>
<a href="#l24.140"></a><span id="l24.140">  * used to add observers, event listeners, etc.</span>
<a href="#l24.141"></a><span id="l24.141">  */</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineat">@@ -384,20 +384,20 @@ function unifinderKeyPress(aEvent) {</span>
<a href="#l24.143"></a><span id="l24.143">  * Tree controller for unifinder search results</span>
<a href="#l24.144"></a><span id="l24.144">  */</span>
<a href="#l24.145"></a><span id="l24.145"> var unifinderTreeView = {</span>
<a href="#l24.146"></a><span id="l24.146">   QueryInterface: ChromeUtils.generateQI([Ci.nsITreeView]),</span>
<a href="#l24.147"></a><span id="l24.147"> </span>
<a href="#l24.148"></a><span id="l24.148">   // Provide a default tree that holds all the functions used here to avoid</span>
<a href="#l24.149"></a><span id="l24.149">   // cludgy if (this.tree) { this.tree.rowCountChanged(...); } constructs.</span>
<a href="#l24.150"></a><span id="l24.150">   tree: {</span>
<a href="#l24.151"></a><span id="l24.151" class="difflineminus">-    rowCountChanged: function() {},</span>
<a href="#l24.152"></a><span id="l24.152" class="difflineminus">-    beginUpdateBatch: function() {},</span>
<a href="#l24.153"></a><span id="l24.153" class="difflineminus">-    endUpdateBatch: function() {},</span>
<a href="#l24.154"></a><span id="l24.154" class="difflineminus">-    invalidate: function() {},</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineplus">+    rowCountChanged() {},</span>
<a href="#l24.156"></a><span id="l24.156" class="difflineplus">+    beginUpdateBatch() {},</span>
<a href="#l24.157"></a><span id="l24.157" class="difflineplus">+    endUpdateBatch() {},</span>
<a href="#l24.158"></a><span id="l24.158" class="difflineplus">+    invalidate() {},</span>
<a href="#l24.159"></a><span id="l24.159">   },</span>
<a href="#l24.160"></a><span id="l24.160"> </span>
<a href="#l24.161"></a><span id="l24.161">   ready: false,</span>
<a href="#l24.162"></a><span id="l24.162">   treeElement: null,</span>
<a href="#l24.163"></a><span id="l24.163">   doingSelection: false,</span>
<a href="#l24.164"></a><span id="l24.164">   mFilter: null,</span>
<a href="#l24.165"></a><span id="l24.165">   mSelectedColumn: null,</span>
<a href="#l24.166"></a><span id="l24.166">   sortDirection: null,</span>
<a href="#l24.167"></a><span id="l24.167" class="difflineat">@@ -435,17 +435,17 @@ var unifinderTreeView = {</span>
<a href="#l24.168"></a><span id="l24.168">   eventArray: [],</span>
<a href="#l24.169"></a><span id="l24.169">   eventIndexMap: {},</span>
<a href="#l24.170"></a><span id="l24.170"> </span>
<a href="#l24.171"></a><span id="l24.171">   /**</span>
<a href="#l24.172"></a><span id="l24.172">    * Add an item to the unifinder tree.</span>
<a href="#l24.173"></a><span id="l24.173">    *</span>
<a href="#l24.174"></a><span id="l24.174">    * @param aItemArray        An array of items to add.</span>
<a href="#l24.175"></a><span id="l24.175">    */</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineminus">-  addItems: function(aItemArray) {</span>
<a href="#l24.177"></a><span id="l24.177" class="difflineplus">+  addItems(aItemArray) {</span>
<a href="#l24.178"></a><span id="l24.178">     this.tree.beginUpdateBatch();</span>
<a href="#l24.179"></a><span id="l24.179"> </span>
<a href="#l24.180"></a><span id="l24.180">     let bulkSort = aItemArray.length &gt; this.eventArray.length;</span>
<a href="#l24.181"></a><span id="l24.181">     if (bulkSort || !this.selectedColumn) {</span>
<a href="#l24.182"></a><span id="l24.182">       // If there's more items being added than already exist,</span>
<a href="#l24.183"></a><span id="l24.183">       // just append them and sort the whole list afterwards.</span>
<a href="#l24.184"></a><span id="l24.184">       // If there's no selected column, don't sort at all.</span>
<a href="#l24.185"></a><span id="l24.185">       let index = this.eventArray.length;</span>
<a href="#l24.186"></a><span id="l24.186" class="difflineat">@@ -483,17 +483,17 @@ var unifinderTreeView = {</span>
<a href="#l24.187"></a><span id="l24.187">     this.calculateIndexMap(true);</span>
<a href="#l24.188"></a><span id="l24.188">   },</span>
<a href="#l24.189"></a><span id="l24.189"> </span>
<a href="#l24.190"></a><span id="l24.190">   /**</span>
<a href="#l24.191"></a><span id="l24.191">    * Remove items from the unifinder tree.</span>
<a href="#l24.192"></a><span id="l24.192">    *</span>
<a href="#l24.193"></a><span id="l24.193">    * @param aItemArray        An array of items to remove.</span>
<a href="#l24.194"></a><span id="l24.194">    */</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineminus">-  removeItems: function(aItemArray) {</span>
<a href="#l24.196"></a><span id="l24.196" class="difflineplus">+  removeItems(aItemArray) {</span>
<a href="#l24.197"></a><span id="l24.197">     let indexesToRemove = [];</span>
<a href="#l24.198"></a><span id="l24.198">     // Removing items is a bit tricky. Our getItemRow function takes the</span>
<a href="#l24.199"></a><span id="l24.199">     // index from a cached map, so removing an item from the array will</span>
<a href="#l24.200"></a><span id="l24.200">     // remove the wrong indexes. We don't want to just invalidate the map,</span>
<a href="#l24.201"></a><span id="l24.201">     // since this will cause O(n^2) behavior. Instead, we keep a sorted</span>
<a href="#l24.202"></a><span id="l24.202">     // array of the indexes to remove:</span>
<a href="#l24.203"></a><span id="l24.203">     for (let item of aItemArray) {</span>
<a href="#l24.204"></a><span id="l24.204">       let row = this.getItemRow(item);</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineat">@@ -522,111 +522,111 @@ var unifinderTreeView = {</span>
<a href="#l24.206"></a><span id="l24.206">     // (given that Array.prototype.unshift doesn't loop but just prepends or</span>
<a href="#l24.207"></a><span id="l24.207">     // maps memory smartly) O(3n) behavior. Lets hope its worth it.</span>
<a href="#l24.208"></a><span id="l24.208">     this.calculateIndexMap(true);</span>
<a href="#l24.209"></a><span id="l24.209">   },</span>
<a href="#l24.210"></a><span id="l24.210"> </span>
<a href="#l24.211"></a><span id="l24.211">   /**</span>
<a href="#l24.212"></a><span id="l24.212">    * Clear all items from the unifinder.</span>
<a href="#l24.213"></a><span id="l24.213">    */</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineminus">-  clearItems: function() {</span>
<a href="#l24.215"></a><span id="l24.215" class="difflineplus">+  clearItems() {</span>
<a href="#l24.216"></a><span id="l24.216">     let oldCount = this.eventArray.length;</span>
<a href="#l24.217"></a><span id="l24.217">     this.eventArray = [];</span>
<a href="#l24.218"></a><span id="l24.218">     this.tree.rowCountChanged(0, -oldCount);</span>
<a href="#l24.219"></a><span id="l24.219">     this.calculateIndexMap();</span>
<a href="#l24.220"></a><span id="l24.220">   },</span>
<a href="#l24.221"></a><span id="l24.221"> </span>
<a href="#l24.222"></a><span id="l24.222">   /**</span>
<a href="#l24.223"></a><span id="l24.223">    * Sets the items that should be in the unifinder. This removes all items</span>
<a href="#l24.224"></a><span id="l24.224">    * that were previously in the unifinder.</span>
<a href="#l24.225"></a><span id="l24.225">    */</span>
<a href="#l24.226"></a><span id="l24.226" class="difflineminus">-  setItems: function(aItemArray) {</span>
<a href="#l24.227"></a><span id="l24.227" class="difflineplus">+  setItems(aItemArray) {</span>
<a href="#l24.228"></a><span id="l24.228">     let oldCount = this.eventArray.length;</span>
<a href="#l24.229"></a><span id="l24.229">     this.eventArray = aItemArray.slice(0);</span>
<a href="#l24.230"></a><span id="l24.230">     this.tree.rowCountChanged(oldCount - 1, this.eventArray.length - oldCount);</span>
<a href="#l24.231"></a><span id="l24.231">     this.sortItems();</span>
<a href="#l24.232"></a><span id="l24.232">   },</span>
<a href="#l24.233"></a><span id="l24.233"> </span>
<a href="#l24.234"></a><span id="l24.234">   /**</span>
<a href="#l24.235"></a><span id="l24.235">    * Recalculate the index map that improves performance when accessing</span>
<a href="#l24.236"></a><span id="l24.236">    * unifinder items. This is usually done automatically when adding/removing</span>
<a href="#l24.237"></a><span id="l24.237">    * items.</span>
<a href="#l24.238"></a><span id="l24.238">    *</span>
<a href="#l24.239"></a><span id="l24.239">    * @param aDontInvalidate       (optional) Don't invalidate the tree, i.e if</span>
<a href="#l24.240"></a><span id="l24.240">    *                                you correctly issued rowCountChanged</span>
<a href="#l24.241"></a><span id="l24.241">    *                                notices.</span>
<a href="#l24.242"></a><span id="l24.242">    */</span>
<a href="#l24.243"></a><span id="l24.243" class="difflineminus">-  calculateIndexMap: function(aDontInvalidate) {</span>
<a href="#l24.244"></a><span id="l24.244" class="difflineplus">+  calculateIndexMap(aDontInvalidate) {</span>
<a href="#l24.245"></a><span id="l24.245">     this.eventIndexMap = {};</span>
<a href="#l24.246"></a><span id="l24.246">     for (let i = 0; i &lt; this.eventArray.length; i++) {</span>
<a href="#l24.247"></a><span id="l24.247">       this.eventIndexMap[this.eventArray[i].hashId] = i;</span>
<a href="#l24.248"></a><span id="l24.248">     }</span>
<a href="#l24.249"></a><span id="l24.249"> </span>
<a href="#l24.250"></a><span id="l24.250">     if (!aDontInvalidate) {</span>
<a href="#l24.251"></a><span id="l24.251">       this.tree.invalidate();</span>
<a href="#l24.252"></a><span id="l24.252">     }</span>
<a href="#l24.253"></a><span id="l24.253">   },</span>
<a href="#l24.254"></a><span id="l24.254"> </span>
<a href="#l24.255"></a><span id="l24.255">   /**</span>
<a href="#l24.256"></a><span id="l24.256">    * Sort the items in the unifinder by the currently selected column.</span>
<a href="#l24.257"></a><span id="l24.257">    */</span>
<a href="#l24.258"></a><span id="l24.258" class="difflineminus">-  sortItems: function() {</span>
<a href="#l24.259"></a><span id="l24.259" class="difflineplus">+  sortItems() {</span>
<a href="#l24.260"></a><span id="l24.260">     if (this.selectedColumn) {</span>
<a href="#l24.261"></a><span id="l24.261">       let modifier = this.sortDirection == &quot;descending&quot; ? -1 : 1;</span>
<a href="#l24.262"></a><span id="l24.262">       let sortKey = unifinderTreeView.selectedColumn.getAttribute(&quot;itemproperty&quot;);</span>
<a href="#l24.263"></a><span id="l24.263"> </span>
<a href="#l24.264"></a><span id="l24.264">       cal.unifinder.sortItems(this.eventArray, sortKey, modifier);</span>
<a href="#l24.265"></a><span id="l24.265">     }</span>
<a href="#l24.266"></a><span id="l24.266">     this.calculateIndexMap();</span>
<a href="#l24.267"></a><span id="l24.267">   },</span>
<a href="#l24.268"></a><span id="l24.268"> </span>
<a href="#l24.269"></a><span id="l24.269">   /**</span>
<a href="#l24.270"></a><span id="l24.270">    * Get the index of the row associated with the passed item.</span>
<a href="#l24.271"></a><span id="l24.271">    *</span>
<a href="#l24.272"></a><span id="l24.272">    * @param item      The item to search for.</span>
<a href="#l24.273"></a><span id="l24.273">    * @return          The row index of the passed item.</span>
<a href="#l24.274"></a><span id="l24.274">    */</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-  getItemRow: function(item) {</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+  getItemRow(item) {</span>
<a href="#l24.277"></a><span id="l24.277">     if (this.eventIndexMap[item.hashId] === undefined) {</span>
<a href="#l24.278"></a><span id="l24.278">       return -1;</span>
<a href="#l24.279"></a><span id="l24.279">     }</span>
<a href="#l24.280"></a><span id="l24.280">     return this.eventIndexMap[item.hashId];</span>
<a href="#l24.281"></a><span id="l24.281">   },</span>
<a href="#l24.282"></a><span id="l24.282"> </span>
<a href="#l24.283"></a><span id="l24.283">   /**</span>
<a href="#l24.284"></a><span id="l24.284">    * Get the item at the given row index.</span>
<a href="#l24.285"></a><span id="l24.285">    *</span>
<a href="#l24.286"></a><span id="l24.286">    * @param item      The row index to get the item for.</span>
<a href="#l24.287"></a><span id="l24.287">    * @return          The item at the given row.</span>
<a href="#l24.288"></a><span id="l24.288">    */</span>
<a href="#l24.289"></a><span id="l24.289" class="difflineminus">-  getItemAt: function(aRow) {</span>
<a href="#l24.290"></a><span id="l24.290" class="difflineplus">+  getItemAt(aRow) {</span>
<a href="#l24.291"></a><span id="l24.291">     return this.eventArray[aRow];</span>
<a href="#l24.292"></a><span id="l24.292">   },</span>
<a href="#l24.293"></a><span id="l24.293"> </span>
<a href="#l24.294"></a><span id="l24.294">   /**</span>
<a href="#l24.295"></a><span id="l24.295">    * Get the calendar item from the given DOM event</span>
<a href="#l24.296"></a><span id="l24.296">    *</span>
<a href="#l24.297"></a><span id="l24.297">    * @param event     The DOM mouse event to get the item for.</span>
<a href="#l24.298"></a><span id="l24.298">    * @return          The item under the mouse position.</span>
<a href="#l24.299"></a><span id="l24.299">    */</span>
<a href="#l24.300"></a><span id="l24.300" class="difflineminus">-  getItemFromEvent: function(event) {</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineplus">+  getItemFromEvent(event) {</span>
<a href="#l24.302"></a><span id="l24.302">     let row = this.tree.getRowAt(event.clientX, event.clientY);</span>
<a href="#l24.303"></a><span id="l24.303"> </span>
<a href="#l24.304"></a><span id="l24.304">     if (row &gt; -1) {</span>
<a href="#l24.305"></a><span id="l24.305">       return this.getItemAt(row);</span>
<a href="#l24.306"></a><span id="l24.306">     }</span>
<a href="#l24.307"></a><span id="l24.307">     return null;</span>
<a href="#l24.308"></a><span id="l24.308">   },</span>
<a href="#l24.309"></a><span id="l24.309"> </span>
<a href="#l24.310"></a><span id="l24.310">   /**</span>
<a href="#l24.311"></a><span id="l24.311">    * Change the selection in the unifinder.</span>
<a href="#l24.312"></a><span id="l24.312">    *</span>
<a href="#l24.313"></a><span id="l24.313">    * @param aItemArray        An array of items to select.</span>
<a href="#l24.314"></a><span id="l24.314">    */</span>
<a href="#l24.315"></a><span id="l24.315" class="difflineminus">-  setSelectedItems: function(aItemArray) {</span>
<a href="#l24.316"></a><span id="l24.316" class="difflineplus">+  setSelectedItems(aItemArray) {</span>
<a href="#l24.317"></a><span id="l24.317">     if (</span>
<a href="#l24.318"></a><span id="l24.318">       this.doingSelection ||</span>
<a href="#l24.319"></a><span id="l24.319">       !this.tree ||</span>
<a href="#l24.320"></a><span id="l24.320">       !this.tree.view ||</span>
<a href="#l24.321"></a><span id="l24.321">       !(&quot;getSelectedItems&quot; in currentView())</span>
<a href="#l24.322"></a><span id="l24.322">     ) {</span>
<a href="#l24.323"></a><span id="l24.323">       return;</span>
<a href="#l24.324"></a><span id="l24.324">     }</span>
<a href="#l24.325"></a><span id="l24.325" class="difflineat">@@ -668,17 +668,17 @@ var unifinderTreeView = {</span>
<a href="#l24.326"></a><span id="l24.326">     // This needs to be in a setTimeout</span>
<a href="#l24.327"></a><span id="l24.327">     setTimeout(() =&gt; unifinderTreeView.resetAllowSelection(), 1);</span>
<a href="#l24.328"></a><span id="l24.328">   },</span>
<a href="#l24.329"></a><span id="l24.329"> </span>
<a href="#l24.330"></a><span id="l24.330">   /**</span>
<a href="#l24.331"></a><span id="l24.331">    * Due to a selection issue described in bug 168211 this method is needed to</span>
<a href="#l24.332"></a><span id="l24.332">    * re-add the selection listeners selection listeners.</span>
<a href="#l24.333"></a><span id="l24.333">    */</span>
<a href="#l24.334"></a><span id="l24.334" class="difflineminus">-  resetAllowSelection: function() {</span>
<a href="#l24.335"></a><span id="l24.335" class="difflineplus">+  resetAllowSelection() {</span>
<a href="#l24.336"></a><span id="l24.336">     if (!this.tree) {</span>
<a href="#l24.337"></a><span id="l24.337">       return;</span>
<a href="#l24.338"></a><span id="l24.338">     }</span>
<a href="#l24.339"></a><span id="l24.339">     /**</span>
<a href="#l24.340"></a><span id="l24.340">      * Do not change anything in the following lines, they are needed as</span>
<a href="#l24.341"></a><span id="l24.341">      * described in the selection observer above</span>
<a href="#l24.342"></a><span id="l24.342">      */</span>
<a href="#l24.343"></a><span id="l24.343">     this.doingSelection = false;</span>
<a href="#l24.344"></a><span id="l24.344" class="difflineat">@@ -694,22 +694,22 @@ var unifinderTreeView = {</span>
<a href="#l24.345"></a><span id="l24.345">   get rowCount() {</span>
<a href="#l24.346"></a><span id="l24.346">     return this.eventArray.length;</span>
<a href="#l24.347"></a><span id="l24.347">   },</span>
<a href="#l24.348"></a><span id="l24.348"> </span>
<a href="#l24.349"></a><span id="l24.349">   // TODO this code is currently identical to the task tree. We should create</span>
<a href="#l24.350"></a><span id="l24.350">   // an itemTreeView that these tree views can inherit, that contains this</span>
<a href="#l24.351"></a><span id="l24.351">   // code, and possibly other code related to sorting and storing items. See</span>
<a href="#l24.352"></a><span id="l24.352">   // bug 432582 for more details.</span>
<a href="#l24.353"></a><span id="l24.353" class="difflineminus">-  getCellProperties: function(aRow, aCol) {</span>
<a href="#l24.354"></a><span id="l24.354" class="difflineplus">+  getCellProperties(aRow, aCol) {</span>
<a href="#l24.355"></a><span id="l24.355">     let rowProps = this.getRowProperties(aRow);</span>
<a href="#l24.356"></a><span id="l24.356">     let colProps = this.getColumnProperties(aCol);</span>
<a href="#l24.357"></a><span id="l24.357">     return rowProps + (rowProps &amp;&amp; colProps ? &quot; &quot; : &quot;&quot;) + colProps;</span>
<a href="#l24.358"></a><span id="l24.358">   },</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineminus">-  getRowProperties: function(aRow) {</span>
<a href="#l24.360"></a><span id="l24.360" class="difflineplus">+  getRowProperties(aRow) {</span>
<a href="#l24.361"></a><span id="l24.361">     let properties = [];</span>
<a href="#l24.362"></a><span id="l24.362">     let item = this.eventArray[aRow];</span>
<a href="#l24.363"></a><span id="l24.363">     if (item.priority &gt; 0 &amp;&amp; item.priority &lt; 5) {</span>
<a href="#l24.364"></a><span id="l24.364">       properties.push(&quot;highpriority&quot;);</span>
<a href="#l24.365"></a><span id="l24.365">     } else if (item.priority &gt; 5 &amp;&amp; item.priority &lt; 10) {</span>
<a href="#l24.366"></a><span id="l24.366">       properties.push(&quot;lowpriority&quot;);</span>
<a href="#l24.367"></a><span id="l24.367">     }</span>
<a href="#l24.368"></a><span id="l24.368"> </span>
<a href="#l24.369"></a><span id="l24.369" class="difflineat">@@ -726,63 +726,63 @@ var unifinderTreeView = {</span>
<a href="#l24.370"></a><span id="l24.370">       properties.push(&quot;alarm&quot;);</span>
<a href="#l24.371"></a><span id="l24.371">     }</span>
<a href="#l24.372"></a><span id="l24.372"> </span>
<a href="#l24.373"></a><span id="l24.373">     // Task categories</span>
<a href="#l24.374"></a><span id="l24.374">     properties = properties.concat(item.getCategories().map(cal.view.formatStringForCSSRule));</span>
<a href="#l24.375"></a><span id="l24.375"> </span>
<a href="#l24.376"></a><span id="l24.376">     return properties.join(&quot; &quot;);</span>
<a href="#l24.377"></a><span id="l24.377">   },</span>
<a href="#l24.378"></a><span id="l24.378" class="difflineminus">-  getColumnProperties: function(aCol) {</span>
<a href="#l24.379"></a><span id="l24.379" class="difflineplus">+  getColumnProperties(aCol) {</span>
<a href="#l24.380"></a><span id="l24.380">     return &quot;&quot;;</span>
<a href="#l24.381"></a><span id="l24.381">   },</span>
<a href="#l24.382"></a><span id="l24.382"> </span>
<a href="#l24.383"></a><span id="l24.383" class="difflineminus">-  isContainer: function() {</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineplus">+  isContainer() {</span>
<a href="#l24.385"></a><span id="l24.385">     return false;</span>
<a href="#l24.386"></a><span id="l24.386">   },</span>
<a href="#l24.387"></a><span id="l24.387"> </span>
<a href="#l24.388"></a><span id="l24.388" class="difflineminus">-  isContainerOpen: function(aRow) {</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineplus">+  isContainerOpen(aRow) {</span>
<a href="#l24.390"></a><span id="l24.390">     return false;</span>
<a href="#l24.391"></a><span id="l24.391">   },</span>
<a href="#l24.392"></a><span id="l24.392"> </span>
<a href="#l24.393"></a><span id="l24.393" class="difflineminus">-  isContainerEmpty: function(aRow) {</span>
<a href="#l24.394"></a><span id="l24.394" class="difflineplus">+  isContainerEmpty(aRow) {</span>
<a href="#l24.395"></a><span id="l24.395">     return false;</span>
<a href="#l24.396"></a><span id="l24.396">   },</span>
<a href="#l24.397"></a><span id="l24.397"> </span>
<a href="#l24.398"></a><span id="l24.398" class="difflineminus">-  isSeparator: function(aRow) {</span>
<a href="#l24.399"></a><span id="l24.399" class="difflineplus">+  isSeparator(aRow) {</span>
<a href="#l24.400"></a><span id="l24.400">     return false;</span>
<a href="#l24.401"></a><span id="l24.401">   },</span>
<a href="#l24.402"></a><span id="l24.402"> </span>
<a href="#l24.403"></a><span id="l24.403" class="difflineminus">-  isSorted: function(aRow) {</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+  isSorted(aRow) {</span>
<a href="#l24.405"></a><span id="l24.405">     return false;</span>
<a href="#l24.406"></a><span id="l24.406">   },</span>
<a href="#l24.407"></a><span id="l24.407"> </span>
<a href="#l24.408"></a><span id="l24.408" class="difflineminus">-  canDrop: function(aRow, aOrientation) {</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineplus">+  canDrop(aRow, aOrientation) {</span>
<a href="#l24.410"></a><span id="l24.410">     return false;</span>
<a href="#l24.411"></a><span id="l24.411">   },</span>
<a href="#l24.412"></a><span id="l24.412"> </span>
<a href="#l24.413"></a><span id="l24.413" class="difflineminus">-  drop: function(aRow, aOrientation) {},</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineplus">+  drop(aRow, aOrientation) {},</span>
<a href="#l24.415"></a><span id="l24.415"> </span>
<a href="#l24.416"></a><span id="l24.416" class="difflineminus">-  getParentIndex: function(aRow) {</span>
<a href="#l24.417"></a><span id="l24.417" class="difflineplus">+  getParentIndex(aRow) {</span>
<a href="#l24.418"></a><span id="l24.418">     return -1;</span>
<a href="#l24.419"></a><span id="l24.419">   },</span>
<a href="#l24.420"></a><span id="l24.420"> </span>
<a href="#l24.421"></a><span id="l24.421" class="difflineminus">-  hasNextSibling: function(aRow, aAfterIndex) {},</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineplus">+  hasNextSibling(aRow, aAfterIndex) {},</span>
<a href="#l24.423"></a><span id="l24.423"> </span>
<a href="#l24.424"></a><span id="l24.424" class="difflineminus">-  getLevel: function(aRow) {</span>
<a href="#l24.425"></a><span id="l24.425" class="difflineplus">+  getLevel(aRow) {</span>
<a href="#l24.426"></a><span id="l24.426">     return 0;</span>
<a href="#l24.427"></a><span id="l24.427">   },</span>
<a href="#l24.428"></a><span id="l24.428"> </span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-  getImageSrc: function(aRow, aOrientation) {},</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineplus">+  getImageSrc(aRow, aOrientation) {},</span>
<a href="#l24.431"></a><span id="l24.431"> </span>
<a href="#l24.432"></a><span id="l24.432" class="difflineminus">-  getCellValue: function(aRow, aCol) {</span>
<a href="#l24.433"></a><span id="l24.433" class="difflineplus">+  getCellValue(aRow, aCol) {</span>
<a href="#l24.434"></a><span id="l24.434">     return null;</span>
<a href="#l24.435"></a><span id="l24.435">   },</span>
<a href="#l24.436"></a><span id="l24.436"> </span>
<a href="#l24.437"></a><span id="l24.437" class="difflineminus">-  getCellText: function(row, column) {</span>
<a href="#l24.438"></a><span id="l24.438" class="difflineplus">+  getCellText(row, column) {</span>
<a href="#l24.439"></a><span id="l24.439">     let calendarEvent = this.eventArray[row];</span>
<a href="#l24.440"></a><span id="l24.440"> </span>
<a href="#l24.441"></a><span id="l24.441">     switch (column.element.getAttribute(&quot;itemproperty&quot;)) {</span>
<a href="#l24.442"></a><span id="l24.442">       case &quot;title&quot;: {</span>
<a href="#l24.443"></a><span id="l24.443">         return calendarEvent.title ? calendarEvent.title.replace(/\n/g, &quot; &quot;) : &quot;&quot;;</span>
<a href="#l24.444"></a><span id="l24.444">       }</span>
<a href="#l24.445"></a><span id="l24.445">       case &quot;startDate&quot;: {</span>
<a href="#l24.446"></a><span id="l24.446">         return formatUnifinderEventDateTime(calendarEvent.startDate);</span>
<a href="#l24.447"></a><span id="l24.447" class="difflineat">@@ -810,40 +810,40 @@ var unifinderTreeView = {</span>
<a href="#l24.448"></a><span id="l24.448">         return calendarEvent.calendar.name;</span>
<a href="#l24.449"></a><span id="l24.449">       }</span>
<a href="#l24.450"></a><span id="l24.450">       default: {</span>
<a href="#l24.451"></a><span id="l24.451">         return false;</span>
<a href="#l24.452"></a><span id="l24.452">       }</span>
<a href="#l24.453"></a><span id="l24.453">     }</span>
<a href="#l24.454"></a><span id="l24.454">   },</span>
<a href="#l24.455"></a><span id="l24.455"> </span>
<a href="#l24.456"></a><span id="l24.456" class="difflineminus">-  setTree: function(tree) {</span>
<a href="#l24.457"></a><span id="l24.457" class="difflineplus">+  setTree(tree) {</span>
<a href="#l24.458"></a><span id="l24.458">     this.tree = tree;</span>
<a href="#l24.459"></a><span id="l24.459">   },</span>
<a href="#l24.460"></a><span id="l24.460"> </span>
<a href="#l24.461"></a><span id="l24.461" class="difflineminus">-  toggleOpenState: function(aRow) {},</span>
<a href="#l24.462"></a><span id="l24.462" class="difflineplus">+  toggleOpenState(aRow) {},</span>
<a href="#l24.463"></a><span id="l24.463"> </span>
<a href="#l24.464"></a><span id="l24.464" class="difflineminus">-  cycleHeader: function(col) {</span>
<a href="#l24.465"></a><span id="l24.465" class="difflineplus">+  cycleHeader(col) {</span>
<a href="#l24.466"></a><span id="l24.466">     if (!this.selectedColumn) {</span>
<a href="#l24.467"></a><span id="l24.467">       this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l24.468"></a><span id="l24.468">     } else if (!this.sortDirection || this.sortDirection == &quot;descending&quot;) {</span>
<a href="#l24.469"></a><span id="l24.469">       this.sortDirection = &quot;ascending&quot;;</span>
<a href="#l24.470"></a><span id="l24.470">     } else {</span>
<a href="#l24.471"></a><span id="l24.471">       this.sortDirection = &quot;descending&quot;;</span>
<a href="#l24.472"></a><span id="l24.472">     }</span>
<a href="#l24.473"></a><span id="l24.473">     this.selectedColumn = col.element;</span>
<a href="#l24.474"></a><span id="l24.474">     this.sortItems();</span>
<a href="#l24.475"></a><span id="l24.475">   },</span>
<a href="#l24.476"></a><span id="l24.476"> </span>
<a href="#l24.477"></a><span id="l24.477" class="difflineminus">-  isEditable: function(aRow, aCol) {</span>
<a href="#l24.478"></a><span id="l24.478" class="difflineplus">+  isEditable(aRow, aCol) {</span>
<a href="#l24.479"></a><span id="l24.479">     return false;</span>
<a href="#l24.480"></a><span id="l24.480">   },</span>
<a href="#l24.481"></a><span id="l24.481"> </span>
<a href="#l24.482"></a><span id="l24.482" class="difflineminus">-  setCellValue: function(aRow, aCol, aValue) {},</span>
<a href="#l24.483"></a><span id="l24.483" class="difflineminus">-  setCellText: function(aRow, aCol, aValue) {},</span>
<a href="#l24.484"></a><span id="l24.484" class="difflineplus">+  setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l24.485"></a><span id="l24.485" class="difflineplus">+  setCellText(aRow, aCol, aValue) {},</span>
<a href="#l24.486"></a><span id="l24.486"> </span>
<a href="#l24.487"></a><span id="l24.487">   outParameter: {}, // used to obtain dates during sort</span>
<a href="#l24.488"></a><span id="l24.488"> };</span>
<a href="#l24.489"></a><span id="l24.489"> </span>
<a href="#l24.490"></a><span id="l24.490"> /**</span>
<a href="#l24.491"></a><span id="l24.491">  * Refresh the unifinder tree by getting items from the composite calendar and</span>
<a href="#l24.492"></a><span id="l24.492">  * applying the current filter.</span>
<a href="#l24.493"></a><span id="l24.493">  */</span>
<a href="#l24.494"></a><span id="l24.494" class="difflineat">@@ -905,24 +905,24 @@ function addItemsFromCalendar(aCalendar,</span>
<a href="#l24.495"></a><span id="l24.495">     // If the unifinder is hidden, don't refresh the events to reduce needed</span>
<a href="#l24.496"></a><span id="l24.496">     // getItems calls.</span>
<a href="#l24.497"></a><span id="l24.497">     return;</span>
<a href="#l24.498"></a><span id="l24.498">   }</span>
<a href="#l24.499"></a><span id="l24.499">   let refreshListener = {</span>
<a href="#l24.500"></a><span id="l24.500">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l24.501"></a><span id="l24.501">     mEventArray: [],</span>
<a href="#l24.502"></a><span id="l24.502"> </span>
<a href="#l24.503"></a><span id="l24.503" class="difflineminus">-    onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l24.504"></a><span id="l24.504" class="difflineplus">+    onOperationComplete(aOpCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l24.505"></a><span id="l24.505">       let refreshTreeInternalFunc = function() {</span>
<a href="#l24.506"></a><span id="l24.506">         aAddItemsInternalFunc(refreshListener.mEventArray);</span>
<a href="#l24.507"></a><span id="l24.507">       };</span>
<a href="#l24.508"></a><span id="l24.508">       setTimeout(refreshTreeInternalFunc, 0);</span>
<a href="#l24.509"></a><span id="l24.509">     },</span>
<a href="#l24.510"></a><span id="l24.510"> </span>
<a href="#l24.511"></a><span id="l24.511" class="difflineminus">-    onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l24.512"></a><span id="l24.512" class="difflineplus">+    onGetResult(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l24.513"></a><span id="l24.513">       refreshListener.mEventArray = refreshListener.mEventArray.concat(aItems);</span>
<a href="#l24.514"></a><span id="l24.514">     },</span>
<a href="#l24.515"></a><span id="l24.515">   };</span>
<a href="#l24.516"></a><span id="l24.516"> </span>
<a href="#l24.517"></a><span id="l24.517">   let filter = 0;</span>
<a href="#l24.518"></a><span id="l24.518"> </span>
<a href="#l24.519"></a><span id="l24.519">   filter |= aCalendar.ITEM_FILTER_TYPE_EVENT;</span>
<a href="#l24.520"></a><span id="l24.520"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/calendar/base/content/calendar-views-utils.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/calendar/base/content/calendar-views-utils.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -25,33 +25,33 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l25.4"></a><span id="l25.4">  */</span>
<a href="#l25.5"></a><span id="l25.5"> var calendarViewController = {</span>
<a href="#l25.6"></a><span id="l25.6">   QueryInterface: ChromeUtils.generateQI([Ci.calICalendarViewController]),</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   /**</span>
<a href="#l25.9"></a><span id="l25.9">    * Creates a new event</span>
<a href="#l25.10"></a><span id="l25.10">    * @see calICalendarViewController</span>
<a href="#l25.11"></a><span id="l25.11">    */</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  createNewEvent: function(calendar, startTime, endTime, forceAllday) {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  createNewEvent(calendar, startTime, endTime, forceAllday) {</span>
<a href="#l25.14"></a><span id="l25.14">     // if we're given both times, skip the dialog</span>
<a href="#l25.15"></a><span id="l25.15">     if (startTime &amp;&amp; endTime &amp;&amp; !startTime.isDate &amp;&amp; !endTime.isDate) {</span>
<a href="#l25.16"></a><span id="l25.16">       let item = cal.createEvent();</span>
<a href="#l25.17"></a><span id="l25.17">       setDefaultItemValues(item, calendar, startTime, endTime);</span>
<a href="#l25.18"></a><span id="l25.18">       item.title = cal.l10n.getCalString(&quot;newEvent&quot;);</span>
<a href="#l25.19"></a><span id="l25.19">       doTransaction(&quot;add&quot;, item, item.calendar, null, null);</span>
<a href="#l25.20"></a><span id="l25.20">     } else {</span>
<a href="#l25.21"></a><span id="l25.21">       createEventWithDialog(calendar, startTime, null, null, null, forceAllday);</span>
<a href="#l25.22"></a><span id="l25.22">     }</span>
<a href="#l25.23"></a><span id="l25.23">   },</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">   /**</span>
<a href="#l25.26"></a><span id="l25.26">    * Modifies the given occurrence</span>
<a href="#l25.27"></a><span id="l25.27">    * @see calICalendarViewController</span>
<a href="#l25.28"></a><span id="l25.28">    */</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineminus">-  modifyOccurrence: function(occurrence, newStartTime, newEndTime, newTitle) {</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+  modifyOccurrence(occurrence, newStartTime, newEndTime, newTitle) {</span>
<a href="#l25.31"></a><span id="l25.31">     // if modifying this item directly (e.g. just dragged to new time),</span>
<a href="#l25.32"></a><span id="l25.32">     // then do so; otherwise pop up the dialog</span>
<a href="#l25.33"></a><span id="l25.33">     if (newStartTime || newEndTime || newTitle) {</span>
<a href="#l25.34"></a><span id="l25.34">       let instance = occurrence.clone();</span>
<a href="#l25.35"></a><span id="l25.35"> </span>
<a href="#l25.36"></a><span id="l25.36">       if (newTitle) {</span>
<a href="#l25.37"></a><span id="l25.37">         instance.title = newTitle;</span>
<a href="#l25.38"></a><span id="l25.38">       }</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineat">@@ -86,17 +86,17 @@ var calendarViewController = {</span>
<a href="#l25.40"></a><span id="l25.40">       modifyEventWithDialog(occurrence, null, true);</span>
<a href="#l25.41"></a><span id="l25.41">     }</span>
<a href="#l25.42"></a><span id="l25.42">   },</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44">   /**</span>
<a href="#l25.45"></a><span id="l25.45">    * Deletes the given occurrences</span>
<a href="#l25.46"></a><span id="l25.46">    * @see calICalendarViewController</span>
<a href="#l25.47"></a><span id="l25.47">    */</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineminus">-  deleteOccurrences: function(occurrencesArg, useParentItems, doNotConfirm, extResponseArg = null) {</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  deleteOccurrences(occurrencesArg, useParentItems, doNotConfirm, extResponseArg = null) {</span>
<a href="#l25.50"></a><span id="l25.50">     startBatchTransaction();</span>
<a href="#l25.51"></a><span id="l25.51">     let recurringItems = {};</span>
<a href="#l25.52"></a><span id="l25.52">     let extResponse = extResponseArg || { responseMode: Ci.calIItipItem.USER };</span>
<a href="#l25.53"></a><span id="l25.53"> </span>
<a href="#l25.54"></a><span id="l25.54">     let getSavedItem = function(itemToDelete) {</span>
<a href="#l25.55"></a><span id="l25.55">       // Get the parent item, saving it in our recurringItems object for</span>
<a href="#l25.56"></a><span id="l25.56">       // later use.</span>
<a href="#l25.57"></a><span id="l25.57">       let hashVal = itemToDelete.parentItem.hashId;</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineat">@@ -323,17 +323,17 @@ function scheduleMidnightUpdate(refreshC</span>
<a href="#l25.59"></a><span id="l25.59">   let jsNow = new Date();</span>
<a href="#l25.60"></a><span id="l25.60">   let tomorrow = new Date(jsNow.getFullYear(), jsNow.getMonth(), jsNow.getDate() + 1);</span>
<a href="#l25.61"></a><span id="l25.61">   let msUntilTomorrow = tomorrow.getTime() - jsNow.getTime();</span>
<a href="#l25.62"></a><span id="l25.62"> </span>
<a href="#l25.63"></a><span id="l25.63">   // Is an nsITimer/callback extreme overkill here? Yes, but it's necessary to</span>
<a href="#l25.64"></a><span id="l25.64">   // workaround bug 291386.  If we don't, we stand a decent chance of getting</span>
<a href="#l25.65"></a><span id="l25.65">   // stuck in an infinite loop.</span>
<a href="#l25.66"></a><span id="l25.66">   let udCallback = {</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineminus">-    notify: function(timer) {</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+    notify(timer) {</span>
<a href="#l25.69"></a><span id="l25.69">       refreshCallback();</span>
<a href="#l25.70"></a><span id="l25.70">     },</span>
<a href="#l25.71"></a><span id="l25.71">   };</span>
<a href="#l25.72"></a><span id="l25.72"> </span>
<a href="#l25.73"></a><span id="l25.73">   if (gMidnightTimer) {</span>
<a href="#l25.74"></a><span id="l25.74">     gMidnightTimer.cancel();</span>
<a href="#l25.75"></a><span id="l25.75">   } else {</span>
<a href="#l25.76"></a><span id="l25.76">     // Observer for wake after sleep/hibernate/standby to create new timers and refresh UI</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineat">@@ -557,20 +557,20 @@ function editSelectedEvents() {</span>
<a href="#l25.78"></a><span id="l25.78"> </span>
<a href="#l25.79"></a><span id="l25.79"> /**</span>
<a href="#l25.80"></a><span id="l25.80">  * Select all events from all calendars. Use with care.</span>
<a href="#l25.81"></a><span id="l25.81">  */</span>
<a href="#l25.82"></a><span id="l25.82"> function selectAllEvents() {</span>
<a href="#l25.83"></a><span id="l25.83">   let items = [];</span>
<a href="#l25.84"></a><span id="l25.84">   let listener = {</span>
<a href="#l25.85"></a><span id="l25.85">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineminus">-    onOperationComplete: function(calendar, status, operationType, id, detail) {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+    onOperationComplete(calendar, status, operationType, id, detail) {</span>
<a href="#l25.88"></a><span id="l25.88">       currentView().setSelectedItems(items, false);</span>
<a href="#l25.89"></a><span id="l25.89">     },</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineminus">-    onGetResult: function(calendar, status, itemType, detail, itemsArg) {</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+    onGetResult(calendar, status, itemType, detail, itemsArg) {</span>
<a href="#l25.92"></a><span id="l25.92">       for (let item of itemsArg) {</span>
<a href="#l25.93"></a><span id="l25.93">         items.push(item);</span>
<a href="#l25.94"></a><span id="l25.94">       }</span>
<a href="#l25.95"></a><span id="l25.95">     },</span>
<a href="#l25.96"></a><span id="l25.96">   };</span>
<a href="#l25.97"></a><span id="l25.97"> </span>
<a href="#l25.98"></a><span id="l25.98">   let composite = cal.view.getCompositeCalendar(window);</span>
<a href="#l25.99"></a><span id="l25.99">   let filter = composite.ITEM_FILTER_CLASS_OCCURRENCES;</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineat">@@ -589,17 +589,17 @@ function selectAllEvents() {</span>
<a href="#l25.101"></a><span id="l25.101">   // Need to move one day out to get all events</span>
<a href="#l25.102"></a><span id="l25.102">   let end = currentView().endDay.clone();</span>
<a href="#l25.103"></a><span id="l25.103">   end.day += 1;</span>
<a href="#l25.104"></a><span id="l25.104"> </span>
<a href="#l25.105"></a><span id="l25.105">   composite.getItems(filter, 0, currentView().startDay, end, listener);</span>
<a href="#l25.106"></a><span id="l25.106"> }</span>
<a href="#l25.107"></a><span id="l25.107"> </span>
<a href="#l25.108"></a><span id="l25.108"> var calendarNavigationBar = {</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineminus">-  setDateRange: function(startDate, endDate) {</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  setDateRange(startDate, endDate) {</span>
<a href="#l25.111"></a><span id="l25.111">     let docTitle = &quot;&quot;;</span>
<a href="#l25.112"></a><span id="l25.112">     if (startDate) {</span>
<a href="#l25.113"></a><span id="l25.113">       let intervalLabel = document.getElementById(&quot;intervalDescription&quot;);</span>
<a href="#l25.114"></a><span id="l25.114">       let firstWeekNo = cal.getWeekInfoService().getWeekTitle(startDate);</span>
<a href="#l25.115"></a><span id="l25.115">       let secondWeekNo = firstWeekNo;</span>
<a href="#l25.116"></a><span id="l25.116">       let weekLabel = document.getElementById(&quot;calendarWeek&quot;);</span>
<a href="#l25.117"></a><span id="l25.117">       if (startDate.nativeTime == endDate.nativeTime) {</span>
<a href="#l25.118"></a><span id="l25.118">         intervalLabel.value = cal.getDateFormatter().formatDate(startDate);</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineat">@@ -632,33 +632,33 @@ var calendarNavigationBar = {</span>
<a href="#l25.120"></a><span id="l25.120">   },</span>
<a href="#l25.121"></a><span id="l25.121"> };</span>
<a href="#l25.122"></a><span id="l25.122"> </span>
<a href="#l25.123"></a><span id="l25.123"> /*</span>
<a href="#l25.124"></a><span id="l25.124">  * Timer for the time indicator in day and week view.</span>
<a href="#l25.125"></a><span id="l25.125">  */</span>
<a href="#l25.126"></a><span id="l25.126"> var timeIndicator = {</span>
<a href="#l25.127"></a><span id="l25.127">   timer: null,</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineminus">-  start: function(interval, thisArg) {</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+  start(interval, thisArg) {</span>
<a href="#l25.130"></a><span id="l25.130">     timeIndicator.timer = setInterval(</span>
<a href="#l25.131"></a><span id="l25.131">       () =&gt; thisArg.updateTimeIndicatorPosition(false),</span>
<a href="#l25.132"></a><span id="l25.132">       interval * 1000</span>
<a href="#l25.133"></a><span id="l25.133">     );</span>
<a href="#l25.134"></a><span id="l25.134">   },</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineminus">-  cancel: function() {</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+  cancel() {</span>
<a href="#l25.137"></a><span id="l25.137">     if (timeIndicator.timer) {</span>
<a href="#l25.138"></a><span id="l25.138">       clearTimeout(timeIndicator.timer);</span>
<a href="#l25.139"></a><span id="l25.139">       timeIndicator.timer = null;</span>
<a href="#l25.140"></a><span id="l25.140">     }</span>
<a href="#l25.141"></a><span id="l25.141">   },</span>
<a href="#l25.142"></a><span id="l25.142">   lastView: null,</span>
<a href="#l25.143"></a><span id="l25.143"> };</span>
<a href="#l25.144"></a><span id="l25.144"> </span>
<a href="#l25.145"></a><span id="l25.145"> var timezoneObserver = {</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineminus">-  observe: function() {</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+  observe() {</span>
<a href="#l25.148"></a><span id="l25.148">     let minimonth = getMinimonth();</span>
<a href="#l25.149"></a><span id="l25.149">     minimonth.update(minimonth.value);</span>
<a href="#l25.150"></a><span id="l25.150">   },</span>
<a href="#l25.151"></a><span id="l25.151"> };</span>
<a href="#l25.152"></a><span id="l25.152"> Services.obs.addObserver(timezoneObserver, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l25.153"></a><span id="l25.153"> window.addEventListener(&quot;unload&quot;, () =&gt; {</span>
<a href="#l25.154"></a><span id="l25.154">   Services.obs.removeObserver(timezoneObserver, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l25.155"></a><span id="l25.155"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-attendees.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -94,17 +94,17 @@ function onLoad() {</span>
<a href="#l26.4"></a><span id="l26.4">   onResize();</span>
<a href="#l26.5"></a><span id="l26.5">   // Set the scroll bar at where the event is</span>
<a href="#l26.6"></a><span id="l26.6">   scrollToCurrentTime();</span>
<a href="#l26.7"></a><span id="l26.7">   updateButtons();</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">   // attach an observer to get notified of changes</span>
<a href="#l26.10"></a><span id="l26.10">   // that are relevant to this dialog.</span>
<a href="#l26.11"></a><span id="l26.11">   let prefObserver = {</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-    observe: function(aSubject, aTopic, aPrefName) {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+    observe(aSubject, aTopic, aPrefName) {</span>
<a href="#l26.14"></a><span id="l26.14">       switch (aPrefName) {</span>
<a href="#l26.15"></a><span id="l26.15">         case &quot;calendar.view.daystarthour&quot;:</span>
<a href="#l26.16"></a><span id="l26.16">         case &quot;calendar.view.dayendhour&quot;:</span>
<a href="#l26.17"></a><span id="l26.17">           initTimeRange();</span>
<a href="#l26.18"></a><span id="l26.18">           propagateDateTime();</span>
<a href="#l26.19"></a><span id="l26.19">           break;</span>
<a href="#l26.20"></a><span id="l26.20">       }</span>
<a href="#l26.21"></a><span id="l26.21">     },</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -955,17 +955,17 @@ function onTimeChange(event) {</span>
<a href="#l26.23"></a><span id="l26.23">  * calendar-event-freebusy-grid custom element.</span>
<a href="#l26.24"></a><span id="l26.24">  */</span>
<a href="#l26.25"></a><span id="l26.25"> function calFreeBusyListener(aFbElement, aBinding) {</span>
<a href="#l26.26"></a><span id="l26.26">   this.mFbElement = aFbElement;</span>
<a href="#l26.27"></a><span id="l26.27">   this.mBinding = aBinding;</span>
<a href="#l26.28"></a><span id="l26.28"> }</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30"> calFreeBusyListener.prototype = {</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-  onResult: function(aRequest, aEntries) {</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  onResult(aRequest, aEntries) {</span>
<a href="#l26.33"></a><span id="l26.33">     if (aRequest &amp;&amp; !aRequest.isPending) {</span>
<a href="#l26.34"></a><span id="l26.34">       // Find request in list of pending requests and remove from queue:</span>
<a href="#l26.35"></a><span id="l26.35">       this.mBinding.mPendingRequests = this.mBinding.mPendingRequests.filter(</span>
<a href="#l26.36"></a><span id="l26.36">         aOp =&gt; aRequest.id != aOp.id</span>
<a href="#l26.37"></a><span id="l26.37">       );</span>
<a href="#l26.38"></a><span id="l26.38">     }</span>
<a href="#l26.39"></a><span id="l26.39">     if (aEntries) {</span>
<a href="#l26.40"></a><span id="l26.40">       this.mFbElement.onFreeBusy(aEntries);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-event-dialog-reminder.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -378,19 +378,18 @@ function updateReminder(event) {</span>
<a href="#l27.4"></a><span id="l27.4">  * appends the item type, i.e |aPrefix + &quot;Event&quot;|.</span>
<a href="#l27.5"></a><span id="l27.5">  *</span>
<a href="#l27.6"></a><span id="l27.6">  * @param aPrefix       The prefix to prepend to the item type</span>
<a href="#l27.7"></a><span id="l27.7">  * @return              The full string name.</span>
<a href="#l27.8"></a><span id="l27.8">  */</span>
<a href="#l27.9"></a><span id="l27.9"> function getItemBundleStringName(aPrefix) {</span>
<a href="#l27.10"></a><span id="l27.10">   if (cal.item.isEvent(window.arguments[0].item)) {</span>
<a href="#l27.11"></a><span id="l27.11">     return aPrefix + &quot;Event&quot;;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  } else {</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-    return aPrefix + &quot;Task&quot;;</span>
<a href="#l27.14"></a><span id="l27.14">   }</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+  return aPrefix + &quot;Task&quot;;</span>
<a href="#l27.16"></a><span id="l27.16"> }</span>
<a href="#l27.17"></a><span id="l27.17"> </span>
<a href="#l27.18"></a><span id="l27.18"> /**</span>
<a href="#l27.19"></a><span id="l27.19">  * Handler function to be called when the &quot;new&quot; button is pressed, to create a</span>
<a href="#l27.20"></a><span id="l27.20">  * new reminder item.</span>
<a href="#l27.21"></a><span id="l27.21">  */</span>
<a href="#l27.22"></a><span id="l27.22"> function onNewReminder() {</span>
<a href="#l27.23"></a><span id="l27.23">   let itemType = cal.item.isEvent(window.arguments[0].item) ? &quot;event&quot; : &quot;todo&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-invitations-dialog.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -205,28 +205,28 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l28.4"></a><span id="l28.4"> </span>
<a href="#l28.5"></a><span id="l28.5"> /**</span>
<a href="#l28.6"></a><span id="l28.6">  * Sets up the invitations dialog from the window arguments, retrieves the</span>
<a href="#l28.7"></a><span id="l28.7">  * invitations from the invitations manager.</span>
<a href="#l28.8"></a><span id="l28.8">  */</span>
<a href="#l28.9"></a><span id="l28.9"> function onLoad() {</span>
<a href="#l28.10"></a><span id="l28.10">   let operationListener = {</span>
<a href="#l28.11"></a><span id="l28.11">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l28.14"></a><span id="l28.14">       let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l28.15"></a><span id="l28.15">       updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l28.16"></a><span id="l28.16">       let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l28.17"></a><span id="l28.17">       if (richListBox.getRowCount() &gt; 0) {</span>
<a href="#l28.18"></a><span id="l28.18">         richListBox.selectedIndex = 0;</span>
<a href="#l28.19"></a><span id="l28.19">       } else {</span>
<a href="#l28.20"></a><span id="l28.20">         let noInvitationsBox = document.getElementById(&quot;noinvitations-box&quot;);</span>
<a href="#l28.21"></a><span id="l28.21">         noInvitationsBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l28.22"></a><span id="l28.22">       }</span>
<a href="#l28.23"></a><span id="l28.23">     },</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+    onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l28.26"></a><span id="l28.26">       if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l28.27"></a><span id="l28.27">         return;</span>
<a href="#l28.28"></a><span id="l28.28">       }</span>
<a href="#l28.29"></a><span id="l28.29">       document.title = invitationsText + &quot; (&quot; + aItems.length + &quot;)&quot;;</span>
<a href="#l28.30"></a><span id="l28.30">       let updatingBox = document.getElementById(&quot;updating-box&quot;);</span>
<a href="#l28.31"></a><span id="l28.31">       updatingBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l28.32"></a><span id="l28.32">       let richListBox = document.getElementById(&quot;invitations-listbox&quot;);</span>
<a href="#l28.33"></a><span id="l28.33">       for (let item of aItems) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-migration-dialog.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l29.4"></a><span id="l29.4"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.5"></a><span id="l29.5"> </span>
<a href="#l29.6"></a><span id="l29.6"> var gMigrateWizard = {</span>
<a href="#l29.7"></a><span id="l29.7">   /**</span>
<a href="#l29.8"></a><span id="l29.8">    * Called from onload of the migrator window.  Takes all of the migrators</span>
<a href="#l29.9"></a><span id="l29.9">    * that were passed in via window.arguments and adds them to checklist. The</span>
<a href="#l29.10"></a><span id="l29.10">    * user can then check these off to migrate the data from those sources.</span>
<a href="#l29.11"></a><span id="l29.11">    */</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  loadMigrators: function() {</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  loadMigrators() {</span>
<a href="#l29.14"></a><span id="l29.14">     let wizardPage2 = document.getElementById(&quot;wizardPage2&quot;);</span>
<a href="#l29.15"></a><span id="l29.15">     wizardPage2.addEventListener(&quot;pageshow&quot;, gMigrateWizard.migrateChecked);</span>
<a href="#l29.16"></a><span id="l29.16"> </span>
<a href="#l29.17"></a><span id="l29.17">     let listbox = document.getElementById(&quot;datasource-list&quot;);</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19">     // XXX Once we have branding for lightning, this hack can go away</span>
<a href="#l29.20"></a><span id="l29.20">     let props = Services.strings.createBundle(&quot;chrome://calendar/locale/migration.properties&quot;);</span>
<a href="#l29.21"></a><span id="l29.21"> </span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -35,17 +35,17 @@ var gMigrateWizard = {</span>
<a href="#l29.23"></a><span id="l29.23">     }</span>
<a href="#l29.24"></a><span id="l29.24">   },</span>
<a href="#l29.25"></a><span id="l29.25"> </span>
<a href="#l29.26"></a><span id="l29.26">   /**</span>
<a href="#l29.27"></a><span id="l29.27">    * Called from the second page of the wizard.  Finds all of the migrators</span>
<a href="#l29.28"></a><span id="l29.28">    * that were checked and begins migrating their data.  Also controls the</span>
<a href="#l29.29"></a><span id="l29.29">    * progress dialog so the user can see what is happening. (somewhat)</span>
<a href="#l29.30"></a><span id="l29.30">    */</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-  migrateChecked: function() {</span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+  migrateChecked() {</span>
<a href="#l29.33"></a><span id="l29.33">     let migrators = [];</span>
<a href="#l29.34"></a><span id="l29.34"> </span>
<a href="#l29.35"></a><span id="l29.35">     // Get all the checked migrators into an array</span>
<a href="#l29.36"></a><span id="l29.36">     let listbox = document.getElementById(&quot;datasource-list&quot;);</span>
<a href="#l29.37"></a><span id="l29.37">     for (let i = listbox.children.length - 1; i &gt;= 0; i--) {</span>
<a href="#l29.38"></a><span id="l29.38">       if (listbox.children[i].getAttribute(&quot;checked&quot;)) {</span>
<a href="#l29.39"></a><span id="l29.39">         migrators.push(listbox.children[i].migrator);</span>
<a href="#l29.40"></a><span id="l29.40">       }</span>
<a href="#l29.41"></a><span id="l29.41" class="difflineat">@@ -100,12 +100,12 @@ var gMigrateWizard = {</span>
<a href="#l29.42"></a><span id="l29.42"> </span>
<a href="#l29.43"></a><span id="l29.43">     // And get the first migrator</span>
<a href="#l29.44"></a><span id="l29.44">     getNextMigrator();</span>
<a href="#l29.45"></a><span id="l29.45">   },</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47">   /**</span>
<a href="#l29.48"></a><span id="l29.48">    * Makes sure the wizard &quot;back&quot; button can not be pressed.</span>
<a href="#l29.49"></a><span id="l29.49">    */</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-  setCanRewindFalse: function() {</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+  setCanRewindFalse() {</span>
<a href="#l29.52"></a><span id="l29.52">     document.querySelector(&quot;wizard&quot;).canRewind = false;</span>
<a href="#l29.53"></a><span id="l29.53">   },</span>
<a href="#l29.54"></a><span id="l29.54"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-print-dialog.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -144,20 +144,20 @@ function getPrintSettings(receiverFunc) </span>
<a href="#l30.4"></a><span id="l30.4">     }</span>
<a href="#l30.5"></a><span id="l30.5">   }</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7">   // Some filters above might have filled the events list themselves. If not,</span>
<a href="#l30.8"></a><span id="l30.8">   // then fetch the items here.</span>
<a href="#l30.9"></a><span id="l30.9">   if (requiresFetch) {</span>
<a href="#l30.10"></a><span id="l30.10">     let listener = {</span>
<a href="#l30.11"></a><span id="l30.11">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDateTime) {</span>
<a href="#l30.14"></a><span id="l30.14">         receiverFunc(settings);</span>
<a href="#l30.15"></a><span id="l30.15">       },</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l30.18"></a><span id="l30.18">         settings.eventList = settings.eventList.concat(aItems);</span>
<a href="#l30.19"></a><span id="l30.19">         if (!settings.printTasksWithNoDueDate) {</span>
<a href="#l30.20"></a><span id="l30.20">           let eventWithDueDate = [];</span>
<a href="#l30.21"></a><span id="l30.21">           for (let item of settings.eventList) {</span>
<a href="#l30.22"></a><span id="l30.22">             if (item.dueDate || item.endDate) {</span>
<a href="#l30.23"></a><span id="l30.23">               eventWithDueDate.push(item);</span>
<a href="#l30.24"></a><span id="l30.24">             }</span>
<a href="#l30.25"></a><span id="l30.25">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/calendar/base/content/dialogs/calendar-subscriptions-dialog.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -95,17 +95,17 @@ function onSearch() {</span>
<a href="#l31.4"></a><span id="l31.4">   }</span>
<a href="#l31.5"></a><span id="l31.5"> </span>
<a href="#l31.6"></a><span id="l31.6">   let registeredCals = {};</span>
<a href="#l31.7"></a><span id="l31.7">   for (let calendar of cal.getCalendarManager().getCalendars()) {</span>
<a href="#l31.8"></a><span id="l31.8">     registeredCals[calendar.id] = true;</span>
<a href="#l31.9"></a><span id="l31.9">   }</span>
<a href="#l31.10"></a><span id="l31.10"> </span>
<a href="#l31.11"></a><span id="l31.11">   let opListener = {</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    onResult: function(operation, result) {</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    onResult(operation, result) {</span>
<a href="#l31.14"></a><span id="l31.14">       if (result) {</span>
<a href="#l31.15"></a><span id="l31.15">         for (let calendar of result) {</span>
<a href="#l31.16"></a><span id="l31.16">           let newNode = document.createXULElement(&quot;richlistitem&quot;, {</span>
<a href="#l31.17"></a><span id="l31.17">             is: &quot;calendar-subscriptions-richlistitem&quot;,</span>
<a href="#l31.18"></a><span id="l31.18">           });</span>
<a href="#l31.19"></a><span id="l31.19">           newNode.calendar = calendar;</span>
<a href="#l31.20"></a><span id="l31.20">           newNode.subscribed = registeredCals[calendar.id];</span>
<a href="#l31.21"></a><span id="l31.21">           richListBox.appendChild(newNode);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/calendar/base/content/import-export.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/calendar/base/content/import-export.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -300,20 +300,20 @@ function saveEventsToFile(calendarEventA</span>
<a href="#l32.4"></a><span id="l32.4">  * the user will be prompted with a list of calendars to choose which one to export.</span>
<a href="#l32.5"></a><span id="l32.5">  *</span>
<a href="#l32.6"></a><span id="l32.6">  * @param aCalendar     (optional) A specific calendar to export</span>
<a href="#l32.7"></a><span id="l32.7">  */</span>
<a href="#l32.8"></a><span id="l32.8"> function exportEntireCalendar(aCalendar) {</span>
<a href="#l32.9"></a><span id="l32.9">   let itemArray = [];</span>
<a href="#l32.10"></a><span id="l32.10">   let getListener = {</span>
<a href="#l32.11"></a><span id="l32.11">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-    onOperationComplete: function(aOpCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+    onOperationComplete(aOpCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l32.14"></a><span id="l32.14">       saveEventsToFile(itemArray, aOpCalendar.name);</span>
<a href="#l32.15"></a><span id="l32.15">     },</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-    onGetResult: function(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+    onGetResult(aOpCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l32.18"></a><span id="l32.18">       for (let item of aItems) {</span>
<a href="#l32.19"></a><span id="l32.19">         itemArray.push(item);</span>
<a href="#l32.20"></a><span id="l32.20">       }</span>
<a href="#l32.21"></a><span id="l32.21">     },</span>
<a href="#l32.22"></a><span id="l32.22">   };</span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24">   let getItemsFromCal = function(aCal) {</span>
<a href="#l32.25"></a><span id="l32.25">     aCal.getItems(Ci.calICalendar.ITEM_FILTER_ALL_ITEMS, 0, null, null, getListener);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/calendar/base/content/preferences/alarms.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/calendar/base/content/preferences/alarms.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -26,17 +26,17 @@ Preferences.addAll([</span>
<a href="#l33.4"></a><span id="l33.4"> /**</span>
<a href="#l33.5"></a><span id="l33.5">  * Global Object to hold methods for the alarms pref pane</span>
<a href="#l33.6"></a><span id="l33.6">  */</span>
<a href="#l33.7"></a><span id="l33.7"> var gAlarmsPane = {</span>
<a href="#l33.8"></a><span id="l33.8">   /**</span>
<a href="#l33.9"></a><span id="l33.9">    * Initialize the alarms pref pane. Sets up dialog controls to match the</span>
<a href="#l33.10"></a><span id="l33.10">    * values set in prefs.</span>
<a href="#l33.11"></a><span id="l33.11">    */</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  init: function() {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  init() {</span>
<a href="#l33.14"></a><span id="l33.14">     // Enable/disable the alarm sound URL box and buttons</span>
<a href="#l33.15"></a><span id="l33.15">     this.alarmsPlaySoundPrefChanged();</span>
<a href="#l33.16"></a><span id="l33.16"> </span>
<a href="#l33.17"></a><span id="l33.17">     // Set the correct singular/plural for the time units</span>
<a href="#l33.18"></a><span id="l33.18">     updateMenuLabelsPlural(&quot;eventdefalarmlen&quot;, &quot;eventdefalarmunit&quot;);</span>
<a href="#l33.19"></a><span id="l33.19">     updateMenuLabelsPlural(&quot;tododefalarmlen&quot;, &quot;tododefalarmunit&quot;);</span>
<a href="#l33.20"></a><span id="l33.20">     updateUnitLabelPlural(&quot;defaultsnoozelength&quot;, &quot;defaultsnoozelengthunit&quot;, &quot;minutes&quot;);</span>
<a href="#l33.21"></a><span id="l33.21"> </span>
<a href="#l33.22"></a><span id="l33.22" class="difflineat">@@ -46,56 +46,55 @@ var gAlarmsPane = {</span>
<a href="#l33.23"></a><span id="l33.23">   },</span>
<a href="#l33.24"></a><span id="l33.24"> </span>
<a href="#l33.25"></a><span id="l33.25">   /**</span>
<a href="#l33.26"></a><span id="l33.26">    * Converts the given file url to a nsIFile</span>
<a href="#l33.27"></a><span id="l33.27">    *</span>
<a href="#l33.28"></a><span id="l33.28">    * @param aFileURL    A string with a file:// url.</span>
<a href="#l33.29"></a><span id="l33.29">    * @return            The corresponding nsIFile.</span>
<a href="#l33.30"></a><span id="l33.30">    */</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineminus">-  convertURLToLocalFile: function(aFileURL) {</span>
<a href="#l33.32"></a><span id="l33.32" class="difflineplus">+  convertURLToLocalFile(aFileURL) {</span>
<a href="#l33.33"></a><span id="l33.33">     // Convert the file url into a nsIFile</span>
<a href="#l33.34"></a><span id="l33.34">     if (aFileURL) {</span>
<a href="#l33.35"></a><span id="l33.35">       let fph = Services.io.getProtocolHandler(&quot;file&quot;).QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l33.36"></a><span id="l33.36">       return fph.getFileFromURLSpec(aFileURL);</span>
<a href="#l33.37"></a><span id="l33.37" class="difflineminus">-    } else {</span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-      return null;</span>
<a href="#l33.39"></a><span id="l33.39">     }</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineplus">+    return null;</span>
<a href="#l33.41"></a><span id="l33.41">   },</span>
<a href="#l33.42"></a><span id="l33.42"> </span>
<a href="#l33.43"></a><span id="l33.43">   /**</span>
<a href="#l33.44"></a><span id="l33.44">    * Handler function to be called when the calendar.alarms.soundURL pref has</span>
<a href="#l33.45"></a><span id="l33.45">    * changed. Updates the label in the dialog.</span>
<a href="#l33.46"></a><span id="l33.46">    */</span>
<a href="#l33.47"></a><span id="l33.47" class="difflineminus">-  readSoundLocation: function() {</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineplus">+  readSoundLocation() {</span>
<a href="#l33.49"></a><span id="l33.49">     let soundUrl = document.getElementById(&quot;alarmSoundFileField&quot;);</span>
<a href="#l33.50"></a><span id="l33.50">     soundUrl.value = Preferences.get(&quot;calendar.alarms.soundURL&quot;).value;</span>
<a href="#l33.51"></a><span id="l33.51">     if (soundUrl.value.startsWith(&quot;file://&quot;)) {</span>
<a href="#l33.52"></a><span id="l33.52">       soundUrl.label = gAlarmsPane.convertURLToLocalFile(soundUrl.value).leafName;</span>
<a href="#l33.53"></a><span id="l33.53">     } else {</span>
<a href="#l33.54"></a><span id="l33.54">       soundUrl.label = soundUrl.value;</span>
<a href="#l33.55"></a><span id="l33.55">     }</span>
<a href="#l33.56"></a><span id="l33.56">     soundUrl.style.backgroundImage = &quot;url(moz-icon://&quot; + soundUrl.label + &quot;?size=16)&quot;;</span>
<a href="#l33.57"></a><span id="l33.57">     return undefined;</span>
<a href="#l33.58"></a><span id="l33.58">   },</span>
<a href="#l33.59"></a><span id="l33.59"> </span>
<a href="#l33.60"></a><span id="l33.60">   /**</span>
<a href="#l33.61"></a><span id="l33.61">    * Causes the default sound to be selected in the dialog controls</span>
<a href="#l33.62"></a><span id="l33.62">    */</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineminus">-  useDefaultSound: function() {</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+  useDefaultSound() {</span>
<a href="#l33.65"></a><span id="l33.65">     let defaultSoundUrl = &quot;chrome://calendar/content/sound.wav&quot;;</span>
<a href="#l33.66"></a><span id="l33.66">     Preferences.get(&quot;calendar.alarms.soundURL&quot;).value = defaultSoundUrl;</span>
<a href="#l33.67"></a><span id="l33.67">     document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l33.68"></a><span id="l33.68">     this.readSoundLocation();</span>
<a href="#l33.69"></a><span id="l33.69">   },</span>
<a href="#l33.70"></a><span id="l33.70"> </span>
<a href="#l33.71"></a><span id="l33.71">   /**</span>
<a href="#l33.72"></a><span id="l33.72">    * Opens a filepicker to open a local sound for the alarm.</span>
<a href="#l33.73"></a><span id="l33.73">    */</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-  browseAlarm: function() {</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+  browseAlarm() {</span>
<a href="#l33.76"></a><span id="l33.76">     let picker = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l33.77"></a><span id="l33.77"> </span>
<a href="#l33.78"></a><span id="l33.78">     // If we already have a sound file, then use the path for that sound file</span>
<a href="#l33.79"></a><span id="l33.79">     // as the initial path in the dialog.</span>
<a href="#l33.80"></a><span id="l33.80">     let currentValue = Preferences.get(&quot;calendar.alarms.soundURL&quot;).value;</span>
<a href="#l33.81"></a><span id="l33.81">     if (currentValue &amp;&amp; currentValue.startsWith(&quot;file://&quot;)) {</span>
<a href="#l33.82"></a><span id="l33.82">       let localFile = Services.io.newURI(currentValue).QueryInterface(Ci.nsIFileURL).file;</span>
<a href="#l33.83"></a><span id="l33.83">       picker.displayDirectory = localFile.parent;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineat">@@ -115,17 +114,17 @@ var gAlarmsPane = {</span>
<a href="#l33.85"></a><span id="l33.85">       document.getElementById(&quot;alarmSoundCheckbox&quot;).checked = true;</span>
<a href="#l33.86"></a><span id="l33.86">       this.readSoundLocation();</span>
<a href="#l33.87"></a><span id="l33.87">     });</span>
<a href="#l33.88"></a><span id="l33.88">   },</span>
<a href="#l33.89"></a><span id="l33.89"> </span>
<a href="#l33.90"></a><span id="l33.90">   /**</span>
<a href="#l33.91"></a><span id="l33.91">    * Plays the alarm sound currently selected.</span>
<a href="#l33.92"></a><span id="l33.92">    */</span>
<a href="#l33.93"></a><span id="l33.93" class="difflineminus">-  previewAlarm: function() {</span>
<a href="#l33.94"></a><span id="l33.94" class="difflineplus">+  previewAlarm() {</span>
<a href="#l33.95"></a><span id="l33.95">     let soundUrl;</span>
<a href="#l33.96"></a><span id="l33.96">     if (Preferences.get(&quot;calendar.alarms.soundType&quot;).value == 0) {</span>
<a href="#l33.97"></a><span id="l33.97">       soundUrl = &quot;chrome://calendar/content/sound.wav&quot;;</span>
<a href="#l33.98"></a><span id="l33.98">     } else {</span>
<a href="#l33.99"></a><span id="l33.99">       soundUrl = Preferences.get(&quot;calendar.alarms.soundURL&quot;).value;</span>
<a href="#l33.100"></a><span id="l33.100">     }</span>
<a href="#l33.101"></a><span id="l33.101">     let soundIfc = Cc[&quot;@mozilla.org/sound;1&quot;].createInstance(Ci.nsISound);</span>
<a href="#l33.102"></a><span id="l33.102">     let url;</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineat">@@ -142,17 +141,17 @@ var gAlarmsPane = {</span>
<a href="#l33.104"></a><span id="l33.104">     }</span>
<a href="#l33.105"></a><span id="l33.105">   },</span>
<a href="#l33.106"></a><span id="l33.106"> </span>
<a href="#l33.107"></a><span id="l33.107">   /**</span>
<a href="#l33.108"></a><span id="l33.108">    * Handler function to call when the calendar.alarms.playsound preference</span>
<a href="#l33.109"></a><span id="l33.109">    * has been changed. Updates the disabled state of fields that depend on</span>
<a href="#l33.110"></a><span id="l33.110">    * playing a sound.</span>
<a href="#l33.111"></a><span id="l33.111">    */</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-  alarmsPlaySoundPrefChanged: function() {</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+  alarmsPlaySoundPrefChanged() {</span>
<a href="#l33.114"></a><span id="l33.114">     let alarmsPlaySoundPref = Preferences.get(&quot;calendar.alarms.playsound&quot;);</span>
<a href="#l33.115"></a><span id="l33.115">     let alarmsSoundType = Preferences.get(&quot;calendar.alarms.soundType&quot;);</span>
<a href="#l33.116"></a><span id="l33.116"> </span>
<a href="#l33.117"></a><span id="l33.117">     for (let item of [&quot;alarmSoundType&quot;, &quot;calendar.prefs.alarm.sound.play&quot;]) {</span>
<a href="#l33.118"></a><span id="l33.118">       document.getElementById(item).disabled = !alarmsPlaySoundPref.value;</span>
<a href="#l33.119"></a><span id="l33.119">     }</span>
<a href="#l33.120"></a><span id="l33.120"> </span>
<a href="#l33.121"></a><span id="l33.121">     for (let item of [&quot;alarmSoundFileField&quot;, &quot;calendar.prefs.alarm.sound.browse&quot;]) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/calendar/base/content/preferences/categories.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/calendar/base/content/preferences/categories.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -23,17 +23,17 @@ var categoryPrefBranch = Services.prefs.</span>
<a href="#l34.4"></a><span id="l34.4"> var gCategoriesPane = {</span>
<a href="#l34.5"></a><span id="l34.5">   mCategoryDialog: null,</span>
<a href="#l34.6"></a><span id="l34.6">   mWinProp: null,</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8">   /**</span>
<a href="#l34.9"></a><span id="l34.9">    * Initialize the categories pref pane. Sets up dialog controls to show the</span>
<a href="#l34.10"></a><span id="l34.10">    * categories saved in preferences.</span>
<a href="#l34.11"></a><span id="l34.11">    */</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  init: function() {</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+  init() {</span>
<a href="#l34.14"></a><span id="l34.14">     // On non-instant-apply platforms, once this pane has been loaded,</span>
<a href="#l34.15"></a><span id="l34.15">     // attach our &quot;revert all changes&quot; function to the parent prefwindow's</span>
<a href="#l34.16"></a><span id="l34.16">     // &quot;ondialogcancel&quot; event.</span>
<a href="#l34.17"></a><span id="l34.17">     let parentPrefWindow = document.documentElement;</span>
<a href="#l34.18"></a><span id="l34.18">     if (!parentPrefWindow.instantApply) {</span>
<a href="#l34.19"></a><span id="l34.19">       let existingOnDialogCancel = parentPrefWindow.getAttribute(&quot;ondialogcancel&quot;);</span>
<a href="#l34.20"></a><span id="l34.20">       parentPrefWindow.setAttribute(</span>
<a href="#l34.21"></a><span id="l34.21">         &quot;ondialogcancel&quot;,</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -61,22 +61,22 @@ var gCategoriesPane = {</span>
<a href="#l34.23"></a><span id="l34.23">     }</span>
<a href="#l34.24"></a><span id="l34.24">   },</span>
<a href="#l34.25"></a><span id="l34.25"> </span>
<a href="#l34.26"></a><span id="l34.26">   /**</span>
<a href="#l34.27"></a><span id="l34.27">    * Updates the listbox containing the categories from the categories saved</span>
<a href="#l34.28"></a><span id="l34.28">    * in preferences.</span>
<a href="#l34.29"></a><span id="l34.29">    */</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  updatePrefs: function() {</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+  updatePrefs() {</span>
<a href="#l34.33"></a><span id="l34.33">     cal.l10n.sortArrayByLocaleCollator(gCategoryList);</span>
<a href="#l34.34"></a><span id="l34.34">     Preferences.get(&quot;calendar.categories.names&quot;).value = cal.category.arrayToString(gCategoryList);</span>
<a href="#l34.35"></a><span id="l34.35">   },</span>
<a href="#l34.36"></a><span id="l34.36"> </span>
<a href="#l34.37"></a><span id="l34.37" class="difflineminus">-  updateCategoryList: function() {</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+  updateCategoryList() {</span>
<a href="#l34.39"></a><span id="l34.39">     this.updatePrefs();</span>
<a href="#l34.40"></a><span id="l34.40">     let listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.41"></a><span id="l34.41"> </span>
<a href="#l34.42"></a><span id="l34.42">     listbox.clearSelection();</span>
<a href="#l34.43"></a><span id="l34.43">     this.updateButtons();</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45">     while (listbox.lastElementChild) {</span>
<a href="#l34.46"></a><span id="l34.46">       listbox.lastChild.remove();</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineat">@@ -102,32 +102,32 @@ var gCategoriesPane = {</span>
<a href="#l34.48"></a><span id="l34.48">       listbox.appendChild(newListItem);</span>
<a href="#l34.49"></a><span id="l34.49">     }</span>
<a href="#l34.50"></a><span id="l34.50">   },</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   /**</span>
<a href="#l34.53"></a><span id="l34.53">    * Adds a category, opening the edit category dialog to prompt the user to</span>
<a href="#l34.54"></a><span id="l34.54">    * set up the category.</span>
<a href="#l34.55"></a><span id="l34.55">    */</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineminus">-  addCategory: function() {</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+  addCategory() {</span>
<a href="#l34.58"></a><span id="l34.58">     let listbox = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.59"></a><span id="l34.59">     listbox.clearSelection();</span>
<a href="#l34.60"></a><span id="l34.60">     this.updateButtons();</span>
<a href="#l34.61"></a><span id="l34.61">     let params = {</span>
<a href="#l34.62"></a><span id="l34.62">       title: newTitle,</span>
<a href="#l34.63"></a><span id="l34.63">       category: &quot;&quot;,</span>
<a href="#l34.64"></a><span id="l34.64">       color: null,</span>
<a href="#l34.65"></a><span id="l34.65">     };</span>
<a href="#l34.66"></a><span id="l34.66">     gSubDialog.open(this.mCategoryDialog, &quot;resizable=no&quot;, params);</span>
<a href="#l34.67"></a><span id="l34.67">   },</span>
<a href="#l34.68"></a><span id="l34.68"> </span>
<a href="#l34.69"></a><span id="l34.69">   /**</span>
<a href="#l34.70"></a><span id="l34.70">    * Edits the currently selected category using the edit category dialog.</span>
<a href="#l34.71"></a><span id="l34.71">    */</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineminus">-  editCategory: function() {</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineplus">+  editCategory() {</span>
<a href="#l34.74"></a><span id="l34.74">     let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.75"></a><span id="l34.75">     let categoryNameFix = cal.view.formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l34.76"></a><span id="l34.76">     let currentColor = categoryPrefBranch.getCharPref(categoryNameFix, &quot;&quot;);</span>
<a href="#l34.77"></a><span id="l34.77"> </span>
<a href="#l34.78"></a><span id="l34.78">     let params = {</span>
<a href="#l34.79"></a><span id="l34.79">       title: editTitle,</span>
<a href="#l34.80"></a><span id="l34.80">       category: gCategoryList[list.selectedIndex],</span>
<a href="#l34.81"></a><span id="l34.81">       color: currentColor,</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineat">@@ -135,17 +135,17 @@ var gCategoriesPane = {</span>
<a href="#l34.83"></a><span id="l34.83">     if (list.selectedItem) {</span>
<a href="#l34.84"></a><span id="l34.84">       gSubDialog.open(this.mCategoryDialog, &quot;resizable=no&quot;, params);</span>
<a href="#l34.85"></a><span id="l34.85">     }</span>
<a href="#l34.86"></a><span id="l34.86">   },</span>
<a href="#l34.87"></a><span id="l34.87"> </span>
<a href="#l34.88"></a><span id="l34.88">   /**</span>
<a href="#l34.89"></a><span id="l34.89">    * Removes the selected category.</span>
<a href="#l34.90"></a><span id="l34.90">    */</span>
<a href="#l34.91"></a><span id="l34.91" class="difflineminus">-  deleteCategory: function() {</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineplus">+  deleteCategory() {</span>
<a href="#l34.93"></a><span id="l34.93">     let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.94"></a><span id="l34.94">     if (list.selectedCount &lt; 1) {</span>
<a href="#l34.95"></a><span id="l34.95">       return;</span>
<a href="#l34.96"></a><span id="l34.96">     }</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98">     let categoryNameFix = cal.view.formatStringForCSSRule(gCategoryList[list.selectedIndex]);</span>
<a href="#l34.99"></a><span id="l34.99">     this.backupData(categoryNameFix);</span>
<a href="#l34.100"></a><span id="l34.100">     try {</span>
<a href="#l34.101"></a><span id="l34.101" class="difflineat">@@ -174,17 +174,17 @@ var gCategoriesPane = {</span>
<a href="#l34.102"></a><span id="l34.102">   },</span>
<a href="#l34.103"></a><span id="l34.103"> </span>
<a href="#l34.104"></a><span id="l34.104">   /**</span>
<a href="#l34.105"></a><span id="l34.105">    * Saves the given category to the preferences.</span>
<a href="#l34.106"></a><span id="l34.106">    *</span>
<a href="#l34.107"></a><span id="l34.107">    * @param categoryName      The name of the category.</span>
<a href="#l34.108"></a><span id="l34.108">    * @param categoryColor     The color of the category</span>
<a href="#l34.109"></a><span id="l34.109">    */</span>
<a href="#l34.110"></a><span id="l34.110" class="difflineminus">-  saveCategory: function(categoryName, categoryColor) {</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineplus">+  saveCategory(categoryName, categoryColor) {</span>
<a href="#l34.112"></a><span id="l34.112">     let list = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.113"></a><span id="l34.113">     // Check to make sure another category doesn't have the same name</span>
<a href="#l34.114"></a><span id="l34.114">     let toBeDeleted = -1;</span>
<a href="#l34.115"></a><span id="l34.115">     for (let i = 0; i &lt; gCategoryList.length; i++) {</span>
<a href="#l34.116"></a><span id="l34.116">       if (i == list.selectedIndex) {</span>
<a href="#l34.117"></a><span id="l34.117">         continue;</span>
<a href="#l34.118"></a><span id="l34.118">       }</span>
<a href="#l34.119"></a><span id="l34.119"> </span>
<a href="#l34.120"></a><span id="l34.120" class="difflineat">@@ -230,29 +230,29 @@ var gCategoriesPane = {</span>
<a href="#l34.121"></a><span id="l34.121">     let updatedCategory = gCategoryList.indexOf(categoryName);</span>
<a href="#l34.122"></a><span id="l34.122">     list.ensureIndexIsVisible(updatedCategory);</span>
<a href="#l34.123"></a><span id="l34.123">     list.selectedIndex = updatedCategory;</span>
<a href="#l34.124"></a><span id="l34.124">   },</span>
<a href="#l34.125"></a><span id="l34.125"> </span>
<a href="#l34.126"></a><span id="l34.126">   /**</span>
<a href="#l34.127"></a><span id="l34.127">    * Enable the edit and delete category buttons.</span>
<a href="#l34.128"></a><span id="l34.128">    */</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineminus">-  updateButtons: function() {</span>
<a href="#l34.130"></a><span id="l34.130" class="difflineplus">+  updateButtons() {</span>
<a href="#l34.131"></a><span id="l34.131">     let categoriesList = document.getElementById(&quot;categorieslist&quot;);</span>
<a href="#l34.132"></a><span id="l34.132">     document.getElementById(&quot;deleteCButton&quot;).disabled = categoriesList.selectedCount &lt;= 0;</span>
<a href="#l34.133"></a><span id="l34.133">     document.getElementById(&quot;editCButton&quot;).disabled = categoriesList.selectedCount != 1;</span>
<a href="#l34.134"></a><span id="l34.134">   },</span>
<a href="#l34.135"></a><span id="l34.135"> </span>
<a href="#l34.136"></a><span id="l34.136">   /**</span>
<a href="#l34.137"></a><span id="l34.137">    * Backs up the category name in case the dialog is canceled.</span>
<a href="#l34.138"></a><span id="l34.138">    *</span>
<a href="#l34.139"></a><span id="l34.139">    * @see formatStringForCSSRule</span>
<a href="#l34.140"></a><span id="l34.140">    * @param categoryNameFix     The formatted category name.</span>
<a href="#l34.141"></a><span id="l34.141">    */</span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-  backupData: function(categoryNameFix) {</span>
<a href="#l34.143"></a><span id="l34.143" class="difflineplus">+  backupData(categoryNameFix) {</span>
<a href="#l34.144"></a><span id="l34.144">     let currentColor = categoryPrefBranch.getCharPref(categoryNameFix, &quot;##NEW&quot;);</span>
<a href="#l34.145"></a><span id="l34.145"> </span>
<a href="#l34.146"></a><span id="l34.146">     for (let i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l34.147"></a><span id="l34.147">       if (categoryNameFix == parent.backupPrefList[i].name) {</span>
<a href="#l34.148"></a><span id="l34.148">         return;</span>
<a href="#l34.149"></a><span id="l34.149">       }</span>
<a href="#l34.150"></a><span id="l34.150">     }</span>
<a href="#l34.151"></a><span id="l34.151">     parent.backupPrefList[parent.backupPrefList.length] = {</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineat">@@ -261,26 +261,26 @@ var gCategoriesPane = {</span>
<a href="#l34.153"></a><span id="l34.153">     };</span>
<a href="#l34.154"></a><span id="l34.154">   },</span>
<a href="#l34.155"></a><span id="l34.155"> </span>
<a href="#l34.156"></a><span id="l34.156">   /**</span>
<a href="#l34.157"></a><span id="l34.157">    * Event Handler function to be called on doubleclick of the categories</span>
<a href="#l34.158"></a><span id="l34.158">    * list. If the edit function is enabled and the user doubleclicked on a</span>
<a href="#l34.159"></a><span id="l34.159">    * list item, then edit the selected category.</span>
<a href="#l34.160"></a><span id="l34.160">    */</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-  listOnDblClick: function(event) {</span>
<a href="#l34.162"></a><span id="l34.162" class="difflineplus">+  listOnDblClick(event) {</span>
<a href="#l34.163"></a><span id="l34.163">     if (event.target.localName == &quot;listitem&quot; &amp;&amp; !document.getElementById(&quot;editCButton&quot;).disabled) {</span>
<a href="#l34.164"></a><span id="l34.164">       this.editCategory();</span>
<a href="#l34.165"></a><span id="l34.165">     }</span>
<a href="#l34.166"></a><span id="l34.166">   },</span>
<a href="#l34.167"></a><span id="l34.167"> </span>
<a href="#l34.168"></a><span id="l34.168">   /**</span>
<a href="#l34.169"></a><span id="l34.169">    * Reverts category preferences in case the cancel button is pressed.</span>
<a href="#l34.170"></a><span id="l34.170">    */</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineminus">-  panelOnCancel: function() {</span>
<a href="#l34.172"></a><span id="l34.172" class="difflineplus">+  panelOnCancel() {</span>
<a href="#l34.173"></a><span id="l34.173">     for (let i = 0; i &lt; parent.backupPrefList.length; i++) {</span>
<a href="#l34.174"></a><span id="l34.174">       if (parent.backupPrefList[i].color == &quot;##NEW&quot;) {</span>
<a href="#l34.175"></a><span id="l34.175">         try {</span>
<a href="#l34.176"></a><span id="l34.176">           categoryPrefBranch.clearUserPref(parent.backupPrefList[i].name);</span>
<a href="#l34.177"></a><span id="l34.177">         } catch (ex) {</span>
<a href="#l34.178"></a><span id="l34.178">           dump(&quot;Exception caught in 'panelOnCancel': &quot; + ex + &quot;\n&quot;);</span>
<a href="#l34.179"></a><span id="l34.179">         }</span>
<a href="#l34.180"></a><span id="l34.180">       } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/calendar/base/content/preferences/general.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/calendar/base/content/preferences/general.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -27,17 +27,17 @@ Preferences.addAll([</span>
<a href="#l35.4"></a><span id="l35.4"> /**</span>
<a href="#l35.5"></a><span id="l35.5">  * Global Object to hold methods for the general pref pane</span>
<a href="#l35.6"></a><span id="l35.6">  */</span>
<a href="#l35.7"></a><span id="l35.7"> var gCalendarGeneralPane = {</span>
<a href="#l35.8"></a><span id="l35.8">   /**</span>
<a href="#l35.9"></a><span id="l35.9">    * Initialize the general pref pane. Sets up dialog controls to match the</span>
<a href="#l35.10"></a><span id="l35.10">    * values set in prefs.</span>
<a href="#l35.11"></a><span id="l35.11">    */</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  init: function() {</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+  init() {</span>
<a href="#l35.14"></a><span id="l35.14">     let formatter = Cc[&quot;@mozilla.org/calendar/datetime-formatter;1&quot;].getService(</span>
<a href="#l35.15"></a><span id="l35.15">       Ci.calIDateTimeFormatter</span>
<a href="#l35.16"></a><span id="l35.16">     );</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">     let dateFormattedLong = formatter.formatDateLong(cal.dtz.now());</span>
<a href="#l35.19"></a><span id="l35.19">     let dateFormattedShort = formatter.formatDateShort(cal.dtz.now());</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21">     // menu items include examples of current date formats.</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineat">@@ -78,17 +78,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l35.23"></a><span id="l35.23">       prefValue = cal.dtz.defaultTimezone.tzid;</span>
<a href="#l35.24"></a><span id="l35.24">     }</span>
<a href="#l35.25"></a><span id="l35.25">     tzMenuList.value = prefValue;</span>
<a href="#l35.26"></a><span id="l35.26"> </span>
<a href="#l35.27"></a><span id="l35.27">     // Set the soondays menulist preference</span>
<a href="#l35.28"></a><span id="l35.28">     this.initializeTodaypaneMenu();</span>
<a href="#l35.29"></a><span id="l35.29">   },</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31" class="difflineminus">-  updateDefaultTodoDates: function() {</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+  updateDefaultTodoDates() {</span>
<a href="#l35.33"></a><span id="l35.33">     let defaultDue = document.getElementById(&quot;default_task_due&quot;).value;</span>
<a href="#l35.34"></a><span id="l35.34">     let defaultStart = document.getElementById(&quot;default_task_start&quot;).value;</span>
<a href="#l35.35"></a><span id="l35.35">     let offsetValues = [&quot;offsetcurrent&quot;, &quot;offsetnexthour&quot;];</span>
<a href="#l35.36"></a><span id="l35.36"> </span>
<a href="#l35.37"></a><span id="l35.37">     document.getElementById(&quot;default_task_due_offset&quot;).style.visibility = offsetValues.includes(</span>
<a href="#l35.38"></a><span id="l35.38">       defaultDue</span>
<a href="#l35.39"></a><span id="l35.39">     )</span>
<a href="#l35.40"></a><span id="l35.40">       ? &quot;&quot;</span>
<a href="#l35.41"></a><span id="l35.41" class="difflineat">@@ -98,17 +98,17 @@ var gCalendarGeneralPane = {</span>
<a href="#l35.42"></a><span id="l35.42">     )</span>
<a href="#l35.43"></a><span id="l35.43">       ? &quot;&quot;</span>
<a href="#l35.44"></a><span id="l35.44">       : &quot;hidden&quot;;</span>
<a href="#l35.45"></a><span id="l35.45"> </span>
<a href="#l35.46"></a><span id="l35.46">     updateMenuLabelsPlural(&quot;default_task_start_offset_text&quot;, &quot;default_task_start_offset_units&quot;);</span>
<a href="#l35.47"></a><span id="l35.47">     updateMenuLabelsPlural(&quot;default_task_due_offset_text&quot;, &quot;default_task_due_offset_units&quot;);</span>
<a href="#l35.48"></a><span id="l35.48">   },</span>
<a href="#l35.49"></a><span id="l35.49"> </span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-  initializeTodaypaneMenu: function() {</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineplus">+  initializeTodaypaneMenu() {</span>
<a href="#l35.52"></a><span id="l35.52">     // Assign the labels for the menuitem</span>
<a href="#l35.53"></a><span id="l35.53">     let soondaysMenu = document.getElementById(&quot;soondays-menulist&quot;);</span>
<a href="#l35.54"></a><span id="l35.54">     let items = soondaysMenu.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l35.55"></a><span id="l35.55">     for (let menuItem of items) {</span>
<a href="#l35.56"></a><span id="l35.56">       let menuitemValue = Number(menuItem.value);</span>
<a href="#l35.57"></a><span id="l35.57">       if (menuitemValue &gt; 7) {</span>
<a href="#l35.58"></a><span id="l35.58">         menuItem.label = unitPluralForm(menuitemValue / 7, &quot;weeks&quot;);</span>
<a href="#l35.59"></a><span id="l35.59">       } else {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/calendar/base/content/preferences/views.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/calendar/base/content/preferences/views.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -27,28 +27,28 @@ Preferences.addAll([</span>
<a href="#l36.4"></a><span id="l36.4"> /**</span>
<a href="#l36.5"></a><span id="l36.5">  * Global Object to hold methods for the views pref pane</span>
<a href="#l36.6"></a><span id="l36.6">  */</span>
<a href="#l36.7"></a><span id="l36.7"> var gViewsPane = {</span>
<a href="#l36.8"></a><span id="l36.8">   /**</span>
<a href="#l36.9"></a><span id="l36.9">    * Initialize the views pref pane. Sets up dialog controls to match the</span>
<a href="#l36.10"></a><span id="l36.10">    * values set in prefs.</span>
<a href="#l36.11"></a><span id="l36.11">    */</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-  init: function() {</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+  init() {</span>
<a href="#l36.14"></a><span id="l36.14">     this.updateViewEndMenu(Preferences.get(&quot;calendar.view.daystarthour&quot;).value);</span>
<a href="#l36.15"></a><span id="l36.15">     this.updateViewStartMenu(Preferences.get(&quot;calendar.view.dayendhour&quot;).value);</span>
<a href="#l36.16"></a><span id="l36.16">     this.updateViewWorkDayCheckboxes(Preferences.get(&quot;calendar.week.start&quot;).value);</span>
<a href="#l36.17"></a><span id="l36.17">     this.initializeViewStartEndMenus();</span>
<a href="#l36.18"></a><span id="l36.18">   },</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20">   /**</span>
<a href="#l36.21"></a><span id="l36.21">    * Initialize the strings for the  &quot;day starts at&quot; and &quot;day ends at&quot;</span>
<a href="#l36.22"></a><span id="l36.22">    * menulists. This is needed to respect locales that use AM/PM.</span>
<a href="#l36.23"></a><span id="l36.23">    */</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-  initializeViewStartEndMenus: function() {</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+  initializeViewStartEndMenus() {</span>
<a href="#l36.26"></a><span id="l36.26">     const { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28">     let calTime = cal.createDateTime();</span>
<a href="#l36.29"></a><span id="l36.29">     calTime.minute = 0;</span>
<a href="#l36.30"></a><span id="l36.30"> </span>
<a href="#l36.31"></a><span id="l36.31">     let timeFormatter = cal.getDateFormatter();</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33">     // 1 to 23 instead of 0 to 24 to keep midnight &amp; noon as the localized strings</span>
<a href="#l36.34"></a><span id="l36.34" class="difflineat">@@ -67,50 +67,50 @@ var gViewsPane = {</span>
<a href="#l36.35"></a><span id="l36.35">   },</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37">   /**</span>
<a href="#l36.38"></a><span id="l36.38">    * Updates the view end menu to only display hours after the selected view</span>
<a href="#l36.39"></a><span id="l36.39">    * start.</span>
<a href="#l36.40"></a><span id="l36.40">    *</span>
<a href="#l36.41"></a><span id="l36.41">    * @param aStartValue       The value selected for view start.</span>
<a href="#l36.42"></a><span id="l36.42">    */</span>
<a href="#l36.43"></a><span id="l36.43" class="difflineminus">-  updateViewEndMenu: function(aStartValue) {</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineplus">+  updateViewEndMenu(aStartValue) {</span>
<a href="#l36.45"></a><span id="l36.45">     let endMenuKids = document.getElementById(&quot;dayendhourpopup&quot;).children;</span>
<a href="#l36.46"></a><span id="l36.46">     for (let i = 0; i &lt; endMenuKids.length; i++) {</span>
<a href="#l36.47"></a><span id="l36.47">       if (Number(endMenuKids[i].value) &lt;= Number(aStartValue)) {</span>
<a href="#l36.48"></a><span id="l36.48">         endMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l36.49"></a><span id="l36.49">       } else {</span>
<a href="#l36.50"></a><span id="l36.50">         endMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l36.51"></a><span id="l36.51">       }</span>
<a href="#l36.52"></a><span id="l36.52">     }</span>
<a href="#l36.53"></a><span id="l36.53">   },</span>
<a href="#l36.54"></a><span id="l36.54"> </span>
<a href="#l36.55"></a><span id="l36.55">   /**</span>
<a href="#l36.56"></a><span id="l36.56">    * Updates the view start menu to only display hours before the selected view</span>
<a href="#l36.57"></a><span id="l36.57">    * end.</span>
<a href="#l36.58"></a><span id="l36.58">    *</span>
<a href="#l36.59"></a><span id="l36.59">    * @param aEndValue         The value selected for view end.</span>
<a href="#l36.60"></a><span id="l36.60">    */</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineminus">-  updateViewStartMenu: function(aEndValue) {</span>
<a href="#l36.62"></a><span id="l36.62" class="difflineplus">+  updateViewStartMenu(aEndValue) {</span>
<a href="#l36.63"></a><span id="l36.63">     let startMenuKids = document.getElementById(&quot;daystarthourpopup&quot;).children;</span>
<a href="#l36.64"></a><span id="l36.64">     for (let i = 0; i &lt; startMenuKids.length; i++) {</span>
<a href="#l36.65"></a><span id="l36.65">       if (Number(startMenuKids[i].value) &gt;= Number(aEndValue)) {</span>
<a href="#l36.66"></a><span id="l36.66">         startMenuKids[i].setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l36.67"></a><span id="l36.67">       } else {</span>
<a href="#l36.68"></a><span id="l36.68">         startMenuKids[i].removeAttribute(&quot;hidden&quot;);</span>
<a href="#l36.69"></a><span id="l36.69">       }</span>
<a href="#l36.70"></a><span id="l36.70">     }</span>
<a href="#l36.71"></a><span id="l36.71">   },</span>
<a href="#l36.72"></a><span id="l36.72"> </span>
<a href="#l36.73"></a><span id="l36.73">   /**</span>
<a href="#l36.74"></a><span id="l36.74">    * Update the workday checkboxes based on the start of the week.</span>
<a href="#l36.75"></a><span id="l36.75">    *</span>
<a href="#l36.76"></a><span id="l36.76">    * @Param weekStart         The (0-based) index of the weekday the week</span>
<a href="#l36.77"></a><span id="l36.77">    *                            should start at.</span>
<a href="#l36.78"></a><span id="l36.78">    */</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineminus">-  updateViewWorkDayCheckboxes: function(weekStart) {</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+  updateViewWorkDayCheckboxes(weekStart) {</span>
<a href="#l36.81"></a><span id="l36.81">     weekStart = Number(weekStart);</span>
<a href="#l36.82"></a><span id="l36.82">     for (let i = weekStart; i &lt; weekStart + 7; i++) {</span>
<a href="#l36.83"></a><span id="l36.83">       let checkbox = document.getElementById(&quot;dayoff&quot; + (i % 7));</span>
<a href="#l36.84"></a><span id="l36.84">       checkbox.parentNode.appendChild(checkbox);</span>
<a href="#l36.85"></a><span id="l36.85">     }</span>
<a href="#l36.86"></a><span id="l36.86">   },</span>
<a href="#l36.87"></a><span id="l36.87"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/calendar/base/content/today-pane.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/calendar/base/content/today-pane.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -24,17 +24,17 @@ var TodayPane = {</span>
<a href="#l37.4"></a><span id="l37.4">     startY: 0,</span>
<a href="#l37.5"></a><span id="l37.5">     distance: 0,</span>
<a href="#l37.6"></a><span id="l37.6">     session: false,</span>
<a href="#l37.7"></a><span id="l37.7">   },</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9">   /**</span>
<a href="#l37.10"></a><span id="l37.10">    * Load Handler, sets up the today pane controls.</span>
<a href="#l37.11"></a><span id="l37.11">    */</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  onLoad: async function() {</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  async onLoad() {</span>
<a href="#l37.14"></a><span id="l37.14">     await agendaListbox.init();</span>
<a href="#l37.15"></a><span id="l37.15"> </span>
<a href="#l37.16"></a><span id="l37.16">     TodayPane.paneViews = [</span>
<a href="#l37.17"></a><span id="l37.17">       cal.l10n.getCalString(&quot;eventsandtasks&quot;),</span>
<a href="#l37.18"></a><span id="l37.18">       cal.l10n.getCalString(&quot;tasksonly&quot;),</span>
<a href="#l37.19"></a><span id="l37.19">       cal.l10n.getCalString(&quot;eventsonly&quot;),</span>
<a href="#l37.20"></a><span id="l37.20">     ];</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -49,34 +49,34 @@ var TodayPane = {</span>
<a href="#l37.23"></a><span id="l37.23">     });</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25">     Services.obs.addObserver(TodayPane, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l37.26"></a><span id="l37.26">   },</span>
<a href="#l37.27"></a><span id="l37.27"> </span>
<a href="#l37.28"></a><span id="l37.28">   /**</span>
<a href="#l37.29"></a><span id="l37.29">    * Unload handler, cleans up the today pane on window unload.</span>
<a href="#l37.30"></a><span id="l37.30">    */</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-  onUnload: function() {</span>
<a href="#l37.32"></a><span id="l37.32" class="difflineplus">+  onUnload() {</span>
<a href="#l37.33"></a><span id="l37.33">     Services.obs.removeObserver(TodayPane, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l37.34"></a><span id="l37.34">   },</span>
<a href="#l37.35"></a><span id="l37.35"> </span>
<a href="#l37.36"></a><span id="l37.36">   /**</span>
<a href="#l37.37"></a><span id="l37.37">    * React if the default timezone changes.</span>
<a href="#l37.38"></a><span id="l37.38">    */</span>
<a href="#l37.39"></a><span id="l37.39" class="difflineminus">-  observe: function() {</span>
<a href="#l37.40"></a><span id="l37.40" class="difflineplus">+  observe() {</span>
<a href="#l37.41"></a><span id="l37.41">     if (this.start !== null) {</span>
<a href="#l37.42"></a><span id="l37.42">       this.setDay(this.start.getInTimezone(cal.dtz.defaultTimezone));</span>
<a href="#l37.43"></a><span id="l37.43">     }</span>
<a href="#l37.44"></a><span id="l37.44">   },</span>
<a href="#l37.45"></a><span id="l37.45"> </span>
<a href="#l37.46"></a><span id="l37.46">   /**</span>
<a href="#l37.47"></a><span id="l37.47">    * Sets up the label for the switcher that allows switching between today pane</span>
<a href="#l37.48"></a><span id="l37.48">    * views. (event+task, task only, event only)</span>
<a href="#l37.49"></a><span id="l37.49">    */</span>
<a href="#l37.50"></a><span id="l37.50" class="difflineminus">-  updateDisplay: function() {</span>
<a href="#l37.51"></a><span id="l37.51" class="difflineplus">+  updateDisplay() {</span>
<a href="#l37.52"></a><span id="l37.52">     let agendaIsVisible = document.getElementById(&quot;agenda-panel&quot;).isVisible(gCurrentMode);</span>
<a href="#l37.53"></a><span id="l37.53">     let todoIsVisible = document.getElementById(&quot;todo-tab-panel&quot;).isVisible(gCurrentMode);</span>
<a href="#l37.54"></a><span id="l37.54">     let index = 2;</span>
<a href="#l37.55"></a><span id="l37.55">     if (agendaIsVisible &amp;&amp; todoIsVisible) {</span>
<a href="#l37.56"></a><span id="l37.56">       index = 0;</span>
<a href="#l37.57"></a><span id="l37.57">     } else if (!agendaIsVisible &amp;&amp; todoIsVisible) {</span>
<a href="#l37.58"></a><span id="l37.58">       index = 1;</span>
<a href="#l37.59"></a><span id="l37.59">     } else if (agendaIsVisible &amp;&amp; !todoIsVisible) {</span>
<a href="#l37.60"></a><span id="l37.60" class="difflineat">@@ -131,17 +131,17 @@ var TodayPane = {</span>
<a href="#l37.61"></a><span id="l37.61">     document.dispatchEvent(new CustomEvent(&quot;viewresize&quot;, { bubbles: true }));</span>
<a href="#l37.62"></a><span id="l37.62">   },</span>
<a href="#l37.63"></a><span id="l37.63"> </span>
<a href="#l37.64"></a><span id="l37.64">   /**</span>
<a href="#l37.65"></a><span id="l37.65">    * Updates the applied filter and show completed view of the unifinder todo.</span>
<a href="#l37.66"></a><span id="l37.66">    *</span>
<a href="#l37.67"></a><span id="l37.67">    * @param {String} [filter] - The filter name to set.</span>
<a href="#l37.68"></a><span id="l37.68">    */</span>
<a href="#l37.69"></a><span id="l37.69" class="difflineminus">-  updateCalendarToDoUnifinder: function(filter) {</span>
<a href="#l37.70"></a><span id="l37.70" class="difflineplus">+  updateCalendarToDoUnifinder(filter) {</span>
<a href="#l37.71"></a><span id="l37.71">     let tree = document.getElementById(&quot;unifinder-todo-tree&quot;);</span>
<a href="#l37.72"></a><span id="l37.72"> </span>
<a href="#l37.73"></a><span id="l37.73">     // Set up hiding completed tasks for the unifinder-todo tree</span>
<a href="#l37.74"></a><span id="l37.74">     filter = filter || tree.getAttribute(&quot;filterValue&quot;) || &quot;throughcurrent&quot;;</span>
<a href="#l37.75"></a><span id="l37.75">     tree.setAttribute(&quot;filterValue&quot;, filter);</span>
<a href="#l37.76"></a><span id="l37.76"> </span>
<a href="#l37.77"></a><span id="l37.77">     document</span>
<a href="#l37.78"></a><span id="l37.78">       .querySelectorAll('menuitem[command=&quot;calendar_task_filter_todaypane_command&quot;][type=&quot;radio&quot;]')</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineat">@@ -167,40 +167,40 @@ var TodayPane = {</span>
<a href="#l37.80"></a><span id="l37.80">     // update the filter</span>
<a href="#l37.81"></a><span id="l37.81">     tree.showCompleted = showCompleted;</span>
<a href="#l37.82"></a><span id="l37.82">     tree.updateFilter(filter);</span>
<a href="#l37.83"></a><span id="l37.83">   },</span>
<a href="#l37.84"></a><span id="l37.84"> </span>
<a href="#l37.85"></a><span id="l37.85">   /**</span>
<a href="#l37.86"></a><span id="l37.86">    * Go to month/week/day views when double-clicking a label inside miniday</span>
<a href="#l37.87"></a><span id="l37.87">    */</span>
<a href="#l37.88"></a><span id="l37.88" class="difflineminus">-  onDoubleClick: function(aEvent) {</span>
<a href="#l37.89"></a><span id="l37.89" class="difflineplus">+  onDoubleClick(aEvent) {</span>
<a href="#l37.90"></a><span id="l37.90">     if (aEvent.button == 0) {</span>
<a href="#l37.91"></a><span id="l37.91">       if (aEvent.target.id == &quot;datevalue-label&quot;) {</span>
<a href="#l37.92"></a><span id="l37.92">         switchCalendarView(&quot;day&quot;, true);</span>
<a href="#l37.93"></a><span id="l37.93">       } else if (aEvent.target.parentNode.id == &quot;weekdayNameContainer&quot;) {</span>
<a href="#l37.94"></a><span id="l37.94">         switchCalendarView(&quot;day&quot;, true);</span>
<a href="#l37.95"></a><span id="l37.95">       } else if (aEvent.target.id == &quot;currentWeek-label&quot;) {</span>
<a href="#l37.96"></a><span id="l37.96">         switchCalendarView(&quot;week&quot;, true);</span>
<a href="#l37.97"></a><span id="l37.97">       } else if (aEvent.target.parentNode.id == &quot;monthNameContainer&quot;) {</span>
<a href="#l37.98"></a><span id="l37.98">         switchCalendarView(&quot;month&quot;, true);</span>
<a href="#l37.99"></a><span id="l37.99">       } else {</span>
<a href="#l37.100"></a><span id="l37.100">         return;</span>
<a href="#l37.101"></a><span id="l37.101">       }</span>
<a href="#l37.102"></a><span id="l37.102">       let title = document.getElementById(&quot;calendar-tab-button&quot;).getAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineminus">-      document.getElementById(&quot;tabmail&quot;).openTab(&quot;calendar&quot;, { title: title });</span>
<a href="#l37.104"></a><span id="l37.104" class="difflineplus">+      document.getElementById(&quot;tabmail&quot;).openTab(&quot;calendar&quot;, { title });</span>
<a href="#l37.105"></a><span id="l37.105">       currentView().goToDay(agendaListbox.today.start);</span>
<a href="#l37.106"></a><span id="l37.106">     }</span>
<a href="#l37.107"></a><span id="l37.107">   },</span>
<a href="#l37.108"></a><span id="l37.108"> </span>
<a href="#l37.109"></a><span id="l37.109">   /**</span>
<a href="#l37.110"></a><span id="l37.110">    * Set conditions about start dragging on day-label or start switching</span>
<a href="#l37.111"></a><span id="l37.111">    * with time on navigation buttons.</span>
<a href="#l37.112"></a><span id="l37.112">    */</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-  onMousedown: function(aEvent, aDir) {</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineplus">+  onMousedown(aEvent, aDir) {</span>
<a href="#l37.115"></a><span id="l37.115">     if (aEvent.button != 0) {</span>
<a href="#l37.116"></a><span id="l37.116">       return;</span>
<a href="#l37.117"></a><span id="l37.117">     }</span>
<a href="#l37.118"></a><span id="l37.118">     let element = aEvent.target;</span>
<a href="#l37.119"></a><span id="l37.119">     if (element.id == &quot;previous-day-button&quot; || element.id == &quot;next-day-button&quot;) {</span>
<a href="#l37.120"></a><span id="l37.120">       // Start switching days by pressing, without release, the navigation buttons</span>
<a href="#l37.121"></a><span id="l37.121">       element.addEventListener(&quot;mouseout&quot;, TodayPane.stopSwitching);</span>
<a href="#l37.122"></a><span id="l37.122">       element.addEventListener(&quot;mouseup&quot;, TodayPane.stopSwitching);</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineat">@@ -218,17 +218,17 @@ var TodayPane = {</span>
<a href="#l37.124"></a><span id="l37.124">   },</span>
<a href="#l37.125"></a><span id="l37.125"> </span>
<a href="#l37.126"></a><span id="l37.126">   /**</span>
<a href="#l37.127"></a><span id="l37.127">    * Figure out the mouse distance from the center of the day's label</span>
<a href="#l37.128"></a><span id="l37.128">    * to the current position.</span>
<a href="#l37.129"></a><span id="l37.129">    *</span>
<a href="#l37.130"></a><span id="l37.130">    * NOTE: This function is usually called without the correct this pointer.</span>
<a href="#l37.131"></a><span id="l37.131">    */</span>
<a href="#l37.132"></a><span id="l37.132" class="difflineminus">-  onMousemove: function(aEvent) {</span>
<a href="#l37.133"></a><span id="l37.133" class="difflineplus">+  onMousemove(aEvent) {</span>
<a href="#l37.134"></a><span id="l37.134">     const MIN_DRAG_DISTANCE_SQ = 49;</span>
<a href="#l37.135"></a><span id="l37.135">     let x = aEvent.clientX - TodayPane.minidayDrag.startX;</span>
<a href="#l37.136"></a><span id="l37.136">     let y = aEvent.clientY - TodayPane.minidayDrag.startY;</span>
<a href="#l37.137"></a><span id="l37.137">     if (TodayPane.minidayDrag.session) {</span>
<a href="#l37.138"></a><span id="l37.138">       if (x * x + y * y &gt;= MIN_DRAG_DISTANCE_SQ) {</span>
<a href="#l37.139"></a><span id="l37.139">         let distance = Math.floor(Math.sqrt(x * x + y * y) - Math.sqrt(MIN_DRAG_DISTANCE_SQ));</span>
<a href="#l37.140"></a><span id="l37.140">         // Dragging on the left/right side, the day date decrease/increase</span>
<a href="#l37.141"></a><span id="l37.141">         TodayPane.minidayDrag.distance = x &gt; 0 ? distance : -distance;</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineat">@@ -250,17 +250,17 @@ var TodayPane = {</span>
<a href="#l37.143"></a><span id="l37.143">       TodayPane.updateAdvanceTimer();</span>
<a href="#l37.144"></a><span id="l37.144">     }</span>
<a href="#l37.145"></a><span id="l37.145">   },</span>
<a href="#l37.146"></a><span id="l37.146"> </span>
<a href="#l37.147"></a><span id="l37.147">   /**</span>
<a href="#l37.148"></a><span id="l37.148">    * Figure out the days switching speed according to the position (when</span>
<a href="#l37.149"></a><span id="l37.149">    * dragging) or time elapsed (when pressing buttons).</span>
<a href="#l37.150"></a><span id="l37.150">    */</span>
<a href="#l37.151"></a><span id="l37.151" class="difflineminus">-  updateAdvanceTimer: function(aEvent, aDir) {</span>
<a href="#l37.152"></a><span id="l37.152" class="difflineplus">+  updateAdvanceTimer(aEvent, aDir) {</span>
<a href="#l37.153"></a><span id="l37.153">     const INITIAL_TIME = 400;</span>
<a href="#l37.154"></a><span id="l37.154">     const REL_DISTANCE = 8;</span>
<a href="#l37.155"></a><span id="l37.155">     const MINIMUM_TIME = 100;</span>
<a href="#l37.156"></a><span id="l37.156">     const ACCELERATE_COUNT_LIMIT = 7;</span>
<a href="#l37.157"></a><span id="l37.157">     const SECOND_STEP_TIME = 200;</span>
<a href="#l37.158"></a><span id="l37.158">     if (TodayPane.minidayDrag.session) {</span>
<a href="#l37.159"></a><span id="l37.159">       // Dragging the day label: days switch with cursor distance and time.</span>
<a href="#l37.160"></a><span id="l37.160">       let dir = (TodayPane.minidayDrag.distance &gt; 0) - (TodayPane.minidayDrag.distance &lt; 0);</span>
<a href="#l37.161"></a><span id="l37.161" class="difflineat">@@ -291,17 +291,17 @@ var TodayPane = {</span>
<a href="#l37.162"></a><span id="l37.162">   },</span>
<a href="#l37.163"></a><span id="l37.163"> </span>
<a href="#l37.164"></a><span id="l37.164">   /**</span>
<a href="#l37.165"></a><span id="l37.165">    * Stop automatic days switching when releasing the mouse button or the</span>
<a href="#l37.166"></a><span id="l37.166">    * position is outside the window.</span>
<a href="#l37.167"></a><span id="l37.167">    *</span>
<a href="#l37.168"></a><span id="l37.168">    * NOTE: This function is usually called without the correct this pointer.</span>
<a href="#l37.169"></a><span id="l37.169">    */</span>
<a href="#l37.170"></a><span id="l37.170" class="difflineminus">-  stopSwitching: function(aEvent) {</span>
<a href="#l37.171"></a><span id="l37.171" class="difflineplus">+  stopSwitching(aEvent) {</span>
<a href="#l37.172"></a><span id="l37.172">     let element = aEvent.target;</span>
<a href="#l37.173"></a><span id="l37.173">     if (</span>
<a href="#l37.174"></a><span id="l37.174">       TodayPane.minidayDrag.session &amp;&amp;</span>
<a href="#l37.175"></a><span id="l37.175">       aEvent.type == &quot;mouseout&quot; &amp;&amp;</span>
<a href="#l37.176"></a><span id="l37.176">       element.id != &quot;messengerWindow&quot;</span>
<a href="#l37.177"></a><span id="l37.177">     ) {</span>
<a href="#l37.178"></a><span id="l37.178">       return;</span>
<a href="#l37.179"></a><span id="l37.179">     }</span>
<a href="#l37.180"></a><span id="l37.180" class="difflineat">@@ -329,17 +329,17 @@ var TodayPane = {</span>
<a href="#l37.181"></a><span id="l37.181">   },</span>
<a href="#l37.182"></a><span id="l37.182"> </span>
<a href="#l37.183"></a><span id="l37.183">   /**</span>
<a href="#l37.184"></a><span id="l37.184">    * Cycle the view shown in the today pane (event+task, event, task).</span>
<a href="#l37.185"></a><span id="l37.185">    *</span>
<a href="#l37.186"></a><span id="l37.186">    * @param aCycleForward     If true, the views are cycled in the forward</span>
<a href="#l37.187"></a><span id="l37.187">    *                            direction, otherwise in the opposite direction</span>
<a href="#l37.188"></a><span id="l37.188">    */</span>
<a href="#l37.189"></a><span id="l37.189" class="difflineminus">-  cyclePaneView: function(aCycleForward) {</span>
<a href="#l37.190"></a><span id="l37.190" class="difflineplus">+  cyclePaneView(aCycleForward) {</span>
<a href="#l37.191"></a><span id="l37.191">     if (this.paneViews == null) {</span>
<a href="#l37.192"></a><span id="l37.192">       return;</span>
<a href="#l37.193"></a><span id="l37.193">     }</span>
<a href="#l37.194"></a><span id="l37.194">     let index = parseInt(document.getElementById(&quot;today-pane-header&quot;).getAttribute(&quot;index&quot;), 10);</span>
<a href="#l37.195"></a><span id="l37.195">     index = index + aCycleForward;</span>
<a href="#l37.196"></a><span id="l37.196">     let nViewLen = this.paneViews.length;</span>
<a href="#l37.197"></a><span id="l37.197">     if (index &gt;= nViewLen) {</span>
<a href="#l37.198"></a><span id="l37.198">       index = 0;</span>
<a href="#l37.199"></a><span id="l37.199" class="difflineat">@@ -353,44 +353,44 @@ var TodayPane = {</span>
<a href="#l37.200"></a><span id="l37.200">     todoPanel.setVisible(isTodoPanelVisible);</span>
<a href="#l37.201"></a><span id="l37.201">     agendaPanel.setVisible(isAgendaPanelVisible);</span>
<a href="#l37.202"></a><span id="l37.202">     this.updateDisplay();</span>
<a href="#l37.203"></a><span id="l37.203">   },</span>
<a href="#l37.204"></a><span id="l37.204"> </span>
<a href="#l37.205"></a><span id="l37.205">   /**</span>
<a href="#l37.206"></a><span id="l37.206">    * Shows short weekday names in the weekdayNameContainer</span>
<a href="#l37.207"></a><span id="l37.207">    */</span>
<a href="#l37.208"></a><span id="l37.208" class="difflineminus">-  setShortWeekdays: function() {</span>
<a href="#l37.209"></a><span id="l37.209" class="difflineplus">+  setShortWeekdays() {</span>
<a href="#l37.210"></a><span id="l37.210">     let weekdisplaydeck = document.getElementById(&quot;weekdayNameContainer&quot;);</span>
<a href="#l37.211"></a><span id="l37.211">     let children = weekdisplaydeck.children;</span>
<a href="#l37.212"></a><span id="l37.212"> </span>
<a href="#l37.213"></a><span id="l37.213">     for (let i = 0; i &lt; children.length; i++) {</span>
<a href="#l37.214"></a><span id="l37.214">       children[i].setAttribute(&quot;value&quot;, cal.l10n.getDateFmtString(`day.${i + 1}.Mmm`));</span>
<a href="#l37.215"></a><span id="l37.215">     }</span>
<a href="#l37.216"></a><span id="l37.216">   },</span>
<a href="#l37.217"></a><span id="l37.217"> </span>
<a href="#l37.218"></a><span id="l37.218">   /**</span>
<a href="#l37.219"></a><span id="l37.219">    * Sets the shown date from a JSDate.</span>
<a href="#l37.220"></a><span id="l37.220">    *</span>
<a href="#l37.221"></a><span id="l37.221">    * @param aNewDate      The date to show.</span>
<a href="#l37.222"></a><span id="l37.222">    */</span>
<a href="#l37.223"></a><span id="l37.223" class="difflineminus">-  setDaywithjsDate: function(aNewDate) {</span>
<a href="#l37.224"></a><span id="l37.224" class="difflineplus">+  setDaywithjsDate(aNewDate) {</span>
<a href="#l37.225"></a><span id="l37.225">     let newdatetime = cal.dtz.jsDateToDateTime(aNewDate, cal.dtz.floating);</span>
<a href="#l37.226"></a><span id="l37.226">     newdatetime = newdatetime.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l37.227"></a><span id="l37.227">     this.setDay(newdatetime, true);</span>
<a href="#l37.228"></a><span id="l37.228">   },</span>
<a href="#l37.229"></a><span id="l37.229"> </span>
<a href="#l37.230"></a><span id="l37.230">   /**</span>
<a href="#l37.231"></a><span id="l37.231">    * Sets the first day shown in the today pane.</span>
<a href="#l37.232"></a><span id="l37.232">    *</span>
<a href="#l37.233"></a><span id="l37.233">    * @param aNewDate                  The calIDateTime to set.</span>
<a href="#l37.234"></a><span id="l37.234">    * @param aDontUpdateMinimonth      If true, the minimonth will not be</span>
<a href="#l37.235"></a><span id="l37.235">    *                                    updated to show the same date.</span>
<a href="#l37.236"></a><span id="l37.236">    */</span>
<a href="#l37.237"></a><span id="l37.237" class="difflineminus">-  setDay: function(aNewDate, aDontUpdateMinimonth) {</span>
<a href="#l37.238"></a><span id="l37.238" class="difflineplus">+  setDay(aNewDate, aDontUpdateMinimonth) {</span>
<a href="#l37.239"></a><span id="l37.239">     if (this.setDay.alreadySettingDay) {</span>
<a href="#l37.240"></a><span id="l37.240">       // If we update the mini-month, this function gets called again.</span>
<a href="#l37.241"></a><span id="l37.241">       return;</span>
<a href="#l37.242"></a><span id="l37.242">     }</span>
<a href="#l37.243"></a><span id="l37.243">     if (!document.getElementById(&quot;agenda-panel&quot;).isVisible()) {</span>
<a href="#l37.244"></a><span id="l37.244">       // If the agenda panel isn't visible, there's no need to set the day.</span>
<a href="#l37.245"></a><span id="l37.245">       return;</span>
<a href="#l37.246"></a><span id="l37.246">     }</span>
<a href="#l37.247"></a><span id="l37.247" class="difflineat">@@ -431,61 +431,61 @@ var TodayPane = {</span>
<a href="#l37.248"></a><span id="l37.248">   },</span>
<a href="#l37.249"></a><span id="l37.249"> </span>
<a href="#l37.250"></a><span id="l37.250">   /**</span>
<a href="#l37.251"></a><span id="l37.251">    * Advance by a given number of days in the today pane.</span>
<a href="#l37.252"></a><span id="l37.252">    *</span>
<a href="#l37.253"></a><span id="l37.253">    * @param aDir      The number of days to advance. Negative numbers advance</span>
<a href="#l37.254"></a><span id="l37.254">    *                    backwards in time.</span>
<a href="#l37.255"></a><span id="l37.255">    */</span>
<a href="#l37.256"></a><span id="l37.256" class="difflineminus">-  advance: function(aDir) {</span>
<a href="#l37.257"></a><span id="l37.257" class="difflineplus">+  advance(aDir) {</span>
<a href="#l37.258"></a><span id="l37.258">     if (aDir != 0) {</span>
<a href="#l37.259"></a><span id="l37.259">       this.start.day += aDir;</span>
<a href="#l37.260"></a><span id="l37.260">       this.setDay(this.start);</span>
<a href="#l37.261"></a><span id="l37.261">     }</span>
<a href="#l37.262"></a><span id="l37.262">   },</span>
<a href="#l37.263"></a><span id="l37.263"> </span>
<a href="#l37.264"></a><span id="l37.264">   /**</span>
<a href="#l37.265"></a><span id="l37.265">    * Checks if the today pane is showing today's date.</span>
<a href="#l37.266"></a><span id="l37.266">    */</span>
<a href="#l37.267"></a><span id="l37.267" class="difflineminus">-  showsToday: function() {</span>
<a href="#l37.268"></a><span id="l37.268" class="difflineplus">+  showsToday() {</span>
<a href="#l37.269"></a><span id="l37.269">     return cal.dtz.sameDay(cal.dtz.now(), this.start);</span>
<a href="#l37.270"></a><span id="l37.270">   },</span>
<a href="#l37.271"></a><span id="l37.271"> </span>
<a href="#l37.272"></a><span id="l37.272">   /**</span>
<a href="#l37.273"></a><span id="l37.273">    * Update the period headers in the agenda listbox using the today pane's</span>
<a href="#l37.274"></a><span id="l37.274">    * start date.</span>
<a href="#l37.275"></a><span id="l37.275">    */</span>
<a href="#l37.276"></a><span id="l37.276" class="difflineminus">-  updatePeriod: function() {</span>
<a href="#l37.277"></a><span id="l37.277" class="difflineplus">+  updatePeriod() {</span>
<a href="#l37.278"></a><span id="l37.278">     agendaListbox.refreshPeriodDates(this.start.clone());</span>
<a href="#l37.279"></a><span id="l37.279">     if (document.getElementById(&quot;todo-tab-panel&quot;).isVisible()) {</span>
<a href="#l37.280"></a><span id="l37.280">       this.updateCalendarToDoUnifinder();</span>
<a href="#l37.281"></a><span id="l37.281">     }</span>
<a href="#l37.282"></a><span id="l37.282">   },</span>
<a href="#l37.283"></a><span id="l37.283"> </span>
<a href="#l37.284"></a><span id="l37.284">   /**</span>
<a href="#l37.285"></a><span id="l37.285">    * Display a certain section in the minday/minimonth part of the todaypane.</span>
<a href="#l37.286"></a><span id="l37.286">    *</span>
<a href="#l37.287"></a><span id="l37.287">    * @param aSection      The section to display</span>
<a href="#l37.288"></a><span id="l37.288">    */</span>
<a href="#l37.289"></a><span id="l37.289" class="difflineminus">-  displayMiniSection: function(aSection) {</span>
<a href="#l37.290"></a><span id="l37.290" class="difflineplus">+  displayMiniSection(aSection) {</span>
<a href="#l37.291"></a><span id="l37.291">     document.getElementById(&quot;today-minimonth-box&quot;).setVisible(aSection == &quot;minimonth&quot;);</span>
<a href="#l37.292"></a><span id="l37.292">     document.getElementById(&quot;mini-day-box&quot;).setVisible(aSection == &quot;miniday&quot;);</span>
<a href="#l37.293"></a><span id="l37.293">     document.getElementById(&quot;today-none-box&quot;).setVisible(aSection == &quot;none&quot;);</span>
<a href="#l37.294"></a><span id="l37.294">     setBooleanAttribute(</span>
<a href="#l37.295"></a><span id="l37.295">       document.getElementById(&quot;today-minimonth&quot;),</span>
<a href="#l37.296"></a><span id="l37.296">       &quot;freebusy&quot;,</span>
<a href="#l37.297"></a><span id="l37.297">       aSection == &quot;minimonth&quot;</span>
<a href="#l37.298"></a><span id="l37.298">     );</span>
<a href="#l37.299"></a><span id="l37.299">   },</span>
<a href="#l37.300"></a><span id="l37.300"> </span>
<a href="#l37.301"></a><span id="l37.301">   /**</span>
<a href="#l37.302"></a><span id="l37.302">    * Handler function to update the today-pane when the current mode changes.</span>
<a href="#l37.303"></a><span id="l37.303">    */</span>
<a href="#l37.304"></a><span id="l37.304" class="difflineminus">-  onModeModified: function() {</span>
<a href="#l37.305"></a><span id="l37.305" class="difflineplus">+  onModeModified() {</span>
<a href="#l37.306"></a><span id="l37.306">     let todayPanePanel = document.getElementById(&quot;today-pane-panel&quot;);</span>
<a href="#l37.307"></a><span id="l37.307">     // Store the previous mode panel's width.</span>
<a href="#l37.308"></a><span id="l37.308">     todayPanePanel.setModeAttribute(&quot;modewidths&quot;, todayPanePanel.width, TodayPane.previousMode);</span>
<a href="#l37.309"></a><span id="l37.309"> </span>
<a href="#l37.310"></a><span id="l37.310">     TodayPane.updateDisplay();</span>
<a href="#l37.311"></a><span id="l37.311">     TodayPane.updateSplitterState();</span>
<a href="#l37.312"></a><span id="l37.312">     todayPanePanel.width = todayPanePanel.getModeAttribute(&quot;modewidths&quot;);</span>
<a href="#l37.313"></a><span id="l37.313">     TodayPane.previousMode = gCurrentMode;</span>
<a href="#l37.314"></a><span id="l37.314" class="difflineat">@@ -495,55 +495,55 @@ var TodayPane = {</span>
<a href="#l37.315"></a><span id="l37.315">     return document.getElementById(&quot;today-pane-panel&quot;).isVisible();</span>
<a href="#l37.316"></a><span id="l37.316">   },</span>
<a href="#l37.317"></a><span id="l37.317"> </span>
<a href="#l37.318"></a><span id="l37.318">   /**</span>
<a href="#l37.319"></a><span id="l37.319">    * Toggle the today-pane and update its visual appearance.</span>
<a href="#l37.320"></a><span id="l37.320">    *</span>
<a href="#l37.321"></a><span id="l37.321">    * @param aEvent        The DOM event occurring on activated command.</span>
<a href="#l37.322"></a><span id="l37.322">    */</span>
<a href="#l37.323"></a><span id="l37.323" class="difflineminus">-  toggleVisibility: function(aEvent) {</span>
<a href="#l37.324"></a><span id="l37.324" class="difflineplus">+  toggleVisibility(aEvent) {</span>
<a href="#l37.325"></a><span id="l37.325">     document.getElementById(&quot;today-pane-panel&quot;).togglePane(aEvent);</span>
<a href="#l37.326"></a><span id="l37.326">     TodayPane.updateDisplay();</span>
<a href="#l37.327"></a><span id="l37.327">     TodayPane.updateSplitterState();</span>
<a href="#l37.328"></a><span id="l37.328">   },</span>
<a href="#l37.329"></a><span id="l37.329"> </span>
<a href="#l37.330"></a><span id="l37.330">   /**</span>
<a href="#l37.331"></a><span id="l37.331">    * Update the today-splitter state.</span>
<a href="#l37.332"></a><span id="l37.332">    */</span>
<a href="#l37.333"></a><span id="l37.333" class="difflineminus">-  updateSplitterState: function() {</span>
<a href="#l37.334"></a><span id="l37.334" class="difflineplus">+  updateSplitterState() {</span>
<a href="#l37.335"></a><span id="l37.335">     let splitter = document.getElementById(&quot;today-splitter&quot;);</span>
<a href="#l37.336"></a><span id="l37.336">     if (this.isVisible) {</span>
<a href="#l37.337"></a><span id="l37.337">       splitter.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l37.338"></a><span id="l37.338">       splitter.setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l37.339"></a><span id="l37.339">     } else {</span>
<a href="#l37.340"></a><span id="l37.340">       splitter.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l37.341"></a><span id="l37.341">     }</span>
<a href="#l37.342"></a><span id="l37.342">   },</span>
<a href="#l37.343"></a><span id="l37.343"> </span>
<a href="#l37.344"></a><span id="l37.344">   /**</span>
<a href="#l37.345"></a><span id="l37.345">    * Generates the todaypane toggle command when the today-splitter</span>
<a href="#l37.346"></a><span id="l37.346">    * is being collapsed or uncollapsed.</span>
<a href="#l37.347"></a><span id="l37.347">    */</span>
<a href="#l37.348"></a><span id="l37.348" class="difflineminus">-  onCommandTodaySplitter: function() {</span>
<a href="#l37.349"></a><span id="l37.349" class="difflineplus">+  onCommandTodaySplitter() {</span>
<a href="#l37.350"></a><span id="l37.350">     let todaypane = document.getElementById(&quot;today-pane-panel&quot;);</span>
<a href="#l37.351"></a><span id="l37.351">     let splitter = document.getElementById(&quot;today-splitter&quot;);</span>
<a href="#l37.352"></a><span id="l37.352">     let splitterCollapsed = splitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;;</span>
<a href="#l37.353"></a><span id="l37.353"> </span>
<a href="#l37.354"></a><span id="l37.354">     todaypane.setModeAttribute(&quot;modewidths&quot;, todaypane.getAttribute(&quot;width&quot;));</span>
<a href="#l37.355"></a><span id="l37.355"> </span>
<a href="#l37.356"></a><span id="l37.356">     if (splitterCollapsed == todaypane.isVisible()) {</span>
<a href="#l37.357"></a><span id="l37.357">       document.getElementById(&quot;calendar_toggle_todaypane_command&quot;).doCommand();</span>
<a href="#l37.358"></a><span id="l37.358">     }</span>
<a href="#l37.359"></a><span id="l37.359">   },</span>
<a href="#l37.360"></a><span id="l37.360"> </span>
<a href="#l37.361"></a><span id="l37.361">   /**</span>
<a href="#l37.362"></a><span id="l37.362">    * Checks if the todayPaneStatusLabel should be hidden.</span>
<a href="#l37.363"></a><span id="l37.363">    */</span>
<a href="#l37.364"></a><span id="l37.364" class="difflineminus">-  showTodayPaneStatusLabel: function() {</span>
<a href="#l37.365"></a><span id="l37.365" class="difflineplus">+  showTodayPaneStatusLabel() {</span>
<a href="#l37.366"></a><span id="l37.366">     let attributeValue =</span>
<a href="#l37.367"></a><span id="l37.367">       Services.prefs.getBoolPref(&quot;calendar.view.showTodayPaneStatusLabel&quot;, true) &amp;&amp; &quot;false&quot;;</span>
<a href="#l37.368"></a><span id="l37.368">     setElementValue(</span>
<a href="#l37.369"></a><span id="l37.369">       document.getElementById(&quot;calendar-status-todaypane-button&quot;),</span>
<a href="#l37.370"></a><span id="l37.370">       !attributeValue,</span>
<a href="#l37.371"></a><span id="l37.371">       &quot;hideLabel&quot;</span>
<a href="#l37.372"></a><span id="l37.372">     );</span>
<a href="#l37.373"></a><span id="l37.373">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/calendar/base/modules/calExtract.jsm</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/calendar/base/modules/calExtract.jsm</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -50,17 +50,17 @@ function Extractor(fallbackLocale, daySt</span>
<a href="#l38.4"></a><span id="l38.4">   }</span>
<a href="#l38.5"></a><span id="l38.5"> }</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> Extractor.prototype = {</span>
<a href="#l38.8"></a><span id="l38.8">   /**</span>
<a href="#l38.9"></a><span id="l38.9">    * Removes confusing data like urls, timezones and phone numbers from email</span>
<a href="#l38.10"></a><span id="l38.10">    * Also removes standard signatures and quoted content from previous emails</span>
<a href="#l38.11"></a><span id="l38.11">    */</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  cleanup: function() {</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+  cleanup() {</span>
<a href="#l38.14"></a><span id="l38.14">     // XXX remove earlier correspondence</span>
<a href="#l38.15"></a><span id="l38.15">     // ideally this should be considered with lower certainty to fill in</span>
<a href="#l38.16"></a><span id="l38.16">     // missing information</span>
<a href="#l38.17"></a><span id="l38.17"> </span>
<a href="#l38.18"></a><span id="l38.18">     // remove last line preceding quoted message and first line of the quote</span>
<a href="#l38.19"></a><span id="l38.19">     this.email = this.email.replace(/\r?\n[^&gt;].*\r?\n&gt;+.*$/m, &quot;&quot;);</span>
<a href="#l38.20"></a><span id="l38.20">     // remove the rest of quoted content</span>
<a href="#l38.21"></a><span id="l38.21">     this.email = this.email.replace(/^&gt;+.*$/gm, &quot;&quot;);</span>
<a href="#l38.22"></a><span id="l38.22" class="difflineat">@@ -75,46 +75,46 @@ Extractor.prototype = {</span>
<a href="#l38.23"></a><span id="l38.23"> </span>
<a href="#l38.24"></a><span id="l38.24">     // remove standard signature</span>
<a href="#l38.25"></a><span id="l38.25">     this.email = this.email.replace(/\r?\n-- \r?\n[\S\s]+$/, &quot;&quot;);</span>
<a href="#l38.26"></a><span id="l38.26"> </span>
<a href="#l38.27"></a><span id="l38.27">     // XXX remove timezone info, for now</span>
<a href="#l38.28"></a><span id="l38.28">     this.email = this.email.replace(/gmt[+-]\d{2}:\d{2}/gi, &quot;&quot;);</span>
<a href="#l38.29"></a><span id="l38.29">   },</span>
<a href="#l38.30"></a><span id="l38.30"> </span>
<a href="#l38.31"></a><span id="l38.31" class="difflineminus">-  checkBundle: function(locale) {</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineplus">+  checkBundle(locale) {</span>
<a href="#l38.33"></a><span id="l38.33">     let path = this.bundleUrl.replace(/LOCALE/g, locale);</span>
<a href="#l38.34"></a><span id="l38.34">     let bundle = Services.strings.createBundle(path);</span>
<a href="#l38.35"></a><span id="l38.35"> </span>
<a href="#l38.36"></a><span id="l38.36">     try {</span>
<a href="#l38.37"></a><span id="l38.37">       bundle.GetStringFromName(&quot;from.today&quot;);</span>
<a href="#l38.38"></a><span id="l38.38">       return true;</span>
<a href="#l38.39"></a><span id="l38.39">     } catch (ex) {</span>
<a href="#l38.40"></a><span id="l38.40">       return false;</span>
<a href="#l38.41"></a><span id="l38.41">     }</span>
<a href="#l38.42"></a><span id="l38.42">   },</span>
<a href="#l38.43"></a><span id="l38.43"> </span>
<a href="#l38.44"></a><span id="l38.44" class="difflineminus">-  avgNonAsciiCharCode: function() {</span>
<a href="#l38.45"></a><span id="l38.45" class="difflineplus">+  avgNonAsciiCharCode() {</span>
<a href="#l38.46"></a><span id="l38.46">     let sum = 0;</span>
<a href="#l38.47"></a><span id="l38.47">     let cnt = 0;</span>
<a href="#l38.48"></a><span id="l38.48"> </span>
<a href="#l38.49"></a><span id="l38.49">     for (let i = 0; i &lt; this.email.length; i++) {</span>
<a href="#l38.50"></a><span id="l38.50">       let char = this.email.charCodeAt(i);</span>
<a href="#l38.51"></a><span id="l38.51">       if (char &gt; 128) {</span>
<a href="#l38.52"></a><span id="l38.52">         sum += char;</span>
<a href="#l38.53"></a><span id="l38.53">         cnt++;</span>
<a href="#l38.54"></a><span id="l38.54">       }</span>
<a href="#l38.55"></a><span id="l38.55">     }</span>
<a href="#l38.56"></a><span id="l38.56"> </span>
<a href="#l38.57"></a><span id="l38.57">     let nonAscii = sum / cnt || 0;</span>
<a href="#l38.58"></a><span id="l38.58">     cal.LOG(&quot;[calExtract] Average non-ascii charcode: &quot; + nonAscii);</span>
<a href="#l38.59"></a><span id="l38.59">     return nonAscii;</span>
<a href="#l38.60"></a><span id="l38.60">   },</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-  setLanguage: function() {</span>
<a href="#l38.63"></a><span id="l38.63" class="difflineplus">+  setLanguage() {</span>
<a href="#l38.64"></a><span id="l38.64">     let path;</span>
<a href="#l38.65"></a><span id="l38.65"> </span>
<a href="#l38.66"></a><span id="l38.66">     if (this.fixedLang) {</span>
<a href="#l38.67"></a><span id="l38.67">       if (this.checkBundle(this.fallbackLocale)) {</span>
<a href="#l38.68"></a><span id="l38.68">         cal.LOG(</span>
<a href="#l38.69"></a><span id="l38.69">           &quot;[calExtract] Fixed locale was used to choose &quot; + this.fallbackLocale + &quot; patterns.&quot;</span>
<a href="#l38.70"></a><span id="l38.70">         );</span>
<a href="#l38.71"></a><span id="l38.71">       } else {</span>
<a href="#l38.72"></a><span id="l38.72" class="difflineat">@@ -246,17 +246,17 @@ Extractor.prototype = {</span>
<a href="#l38.73"></a><span id="l38.73">    * @param body  email body</span>
<a href="#l38.74"></a><span id="l38.74">    * @param now   reference time against which relative times are interpreted,</span>
<a href="#l38.75"></a><span id="l38.75">    *                  when null current time is used</span>
<a href="#l38.76"></a><span id="l38.76">    * @param sel   selection object of email content, when defined times</span>
<a href="#l38.77"></a><span id="l38.77">    *                  outside selection are disgarded</span>
<a href="#l38.78"></a><span id="l38.78">    * @param title email title</span>
<a href="#l38.79"></a><span id="l38.79">    * @return      sorted list of extracted datetime objects</span>
<a href="#l38.80"></a><span id="l38.80">    */</span>
<a href="#l38.81"></a><span id="l38.81" class="difflineminus">-  extract: function(title, body, now, sel) {</span>
<a href="#l38.82"></a><span id="l38.82" class="difflineplus">+  extract(title, body, now, sel) {</span>
<a href="#l38.83"></a><span id="l38.83">     let initial = {};</span>
<a href="#l38.84"></a><span id="l38.84">     this.collected = [];</span>
<a href="#l38.85"></a><span id="l38.85">     this.email = title + &quot;\r\n&quot; + body;</span>
<a href="#l38.86"></a><span id="l38.86">     if (now != null) {</span>
<a href="#l38.87"></a><span id="l38.87">       this.now = now;</span>
<a href="#l38.88"></a><span id="l38.88">     }</span>
<a href="#l38.89"></a><span id="l38.89"> </span>
<a href="#l38.90"></a><span id="l38.90">     initial.year = now.getFullYear();</span>
<a href="#l38.91"></a><span id="l38.91" class="difflineat">@@ -349,17 +349,17 @@ Extractor.prototype = {</span>
<a href="#l38.92"></a><span id="l38.92">       this.markSelected(sel, title);</span>
<a href="#l38.93"></a><span id="l38.93">     }</span>
<a href="#l38.94"></a><span id="l38.94">     this.markContained();</span>
<a href="#l38.95"></a><span id="l38.95">     this.collected = this.collected.sort(this.sort);</span>
<a href="#l38.96"></a><span id="l38.96"> </span>
<a href="#l38.97"></a><span id="l38.97">     return this.collected;</span>
<a href="#l38.98"></a><span id="l38.98">   },</span>
<a href="#l38.99"></a><span id="l38.99"> </span>
<a href="#l38.100"></a><span id="l38.100" class="difflineminus">-  extractDayMonthYear: function(pattern, relation) {</span>
<a href="#l38.101"></a><span id="l38.101" class="difflineplus">+  extractDayMonthYear(pattern, relation) {</span>
<a href="#l38.102"></a><span id="l38.102">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{1,2})&quot;, &quot;(\\d{2,4})&quot;]);</span>
<a href="#l38.103"></a><span id="l38.103"> </span>
<a href="#l38.104"></a><span id="l38.104">     let res;</span>
<a href="#l38.105"></a><span id="l38.105">     for (let alt in alts) {</span>
<a href="#l38.106"></a><span id="l38.106">       let positions = alts[alt].positions;</span>
<a href="#l38.107"></a><span id="l38.107">       let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l38.108"></a><span id="l38.108"> </span>
<a href="#l38.109"></a><span id="l38.109">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.110"></a><span id="l38.110" class="difflineat">@@ -383,17 +383,17 @@ Extractor.prototype = {</span>
<a href="#l38.111"></a><span id="l38.111">               pattern</span>
<a href="#l38.112"></a><span id="l38.112">             );</span>
<a href="#l38.113"></a><span id="l38.113">           }</span>
<a href="#l38.114"></a><span id="l38.114">         }</span>
<a href="#l38.115"></a><span id="l38.115">       }</span>
<a href="#l38.116"></a><span id="l38.116">     }</span>
<a href="#l38.117"></a><span id="l38.117">   },</span>
<a href="#l38.118"></a><span id="l38.118"> </span>
<a href="#l38.119"></a><span id="l38.119" class="difflineminus">-  extractDayMonthNameYear: function(pattern, relation) {</span>
<a href="#l38.120"></a><span id="l38.120" class="difflineplus">+  extractDayMonthNameYear(pattern, relation) {</span>
<a href="#l38.121"></a><span id="l38.121">     let alts = this.getRepPatterns(pattern, [</span>
<a href="#l38.122"></a><span id="l38.122">       &quot;(\\d{1,2})&quot;,</span>
<a href="#l38.123"></a><span id="l38.123">       &quot;(&quot; + this.allMonths + &quot;)&quot;,</span>
<a href="#l38.124"></a><span id="l38.124">       &quot;(\\d{2,4})&quot;,</span>
<a href="#l38.125"></a><span id="l38.125">     ]);</span>
<a href="#l38.126"></a><span id="l38.126"> </span>
<a href="#l38.127"></a><span id="l38.127">     let res;</span>
<a href="#l38.128"></a><span id="l38.128">     for (let alt in alts) {</span>
<a href="#l38.129"></a><span id="l38.129" class="difflineat">@@ -427,17 +427,17 @@ Extractor.prototype = {</span>
<a href="#l38.130"></a><span id="l38.130">               }</span>
<a href="#l38.131"></a><span id="l38.131">             }</span>
<a href="#l38.132"></a><span id="l38.132">           }</span>
<a href="#l38.133"></a><span id="l38.133">         }</span>
<a href="#l38.134"></a><span id="l38.134">       }</span>
<a href="#l38.135"></a><span id="l38.135">     }</span>
<a href="#l38.136"></a><span id="l38.136">   },</span>
<a href="#l38.137"></a><span id="l38.137"> </span>
<a href="#l38.138"></a><span id="l38.138" class="difflineminus">-  extractRelativeDay: function(pattern, relation, offset) {</span>
<a href="#l38.139"></a><span id="l38.139" class="difflineplus">+  extractRelativeDay(pattern, relation, offset) {</span>
<a href="#l38.140"></a><span id="l38.140">     let re = new RegExp(this.getPatterns(pattern), &quot;ig&quot;);</span>
<a href="#l38.141"></a><span id="l38.141">     let res;</span>
<a href="#l38.142"></a><span id="l38.142">     if ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.143"></a><span id="l38.143">       if (!this.limitChars(res, this.email)) {</span>
<a href="#l38.144"></a><span id="l38.144">         let item = new Date(this.now.getTime() + 60 * 60 * 24 * 1000 * offset);</span>
<a href="#l38.145"></a><span id="l38.145">         let rev = this.prefixSuffixStartEnd(res, relation, this.email);</span>
<a href="#l38.146"></a><span id="l38.146">         this.guess(</span>
<a href="#l38.147"></a><span id="l38.147">           item.getFullYear(),</span>
<a href="#l38.148"></a><span id="l38.148" class="difflineat">@@ -450,17 +450,17 @@ Extractor.prototype = {</span>
<a href="#l38.149"></a><span id="l38.149">           rev.pattern,</span>
<a href="#l38.150"></a><span id="l38.150">           rev.relation,</span>
<a href="#l38.151"></a><span id="l38.151">           pattern</span>
<a href="#l38.152"></a><span id="l38.152">         );</span>
<a href="#l38.153"></a><span id="l38.153">       }</span>
<a href="#l38.154"></a><span id="l38.154">     }</span>
<a href="#l38.155"></a><span id="l38.155">   },</span>
<a href="#l38.156"></a><span id="l38.156"> </span>
<a href="#l38.157"></a><span id="l38.157" class="difflineminus">-  extractDayMonthName: function(pattern, relation) {</span>
<a href="#l38.158"></a><span id="l38.158" class="difflineplus">+  extractDayMonthName(pattern, relation) {</span>
<a href="#l38.159"></a><span id="l38.159">     let alts = this.getRepPatterns(pattern, [</span>
<a href="#l38.160"></a><span id="l38.160">       &quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;,</span>
<a href="#l38.161"></a><span id="l38.161">       &quot;(&quot; + this.allMonths + &quot;)&quot;,</span>
<a href="#l38.162"></a><span id="l38.162">     ]);</span>
<a href="#l38.163"></a><span id="l38.163">     let res;</span>
<a href="#l38.164"></a><span id="l38.164">     for (let alt in alts) {</span>
<a href="#l38.165"></a><span id="l38.165">       let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l38.166"></a><span id="l38.166">       let positions = alts[alt].positions;</span>
<a href="#l38.167"></a><span id="l38.167" class="difflineat">@@ -470,17 +470,17 @@ Extractor.prototype = {</span>
<a href="#l38.168"></a><span id="l38.168">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.169"></a><span id="l38.169">           let day = this.parseNumber(res[positions[1]], this.numbers);</span>
<a href="#l38.170"></a><span id="l38.170">           let month = res[positions[2]];</span>
<a href="#l38.171"></a><span id="l38.171"> </span>
<a href="#l38.172"></a><span id="l38.172">           if (this.isValidDay(day)) {</span>
<a href="#l38.173"></a><span id="l38.173">             for (let i = 0; i &lt; 12; i++) {</span>
<a href="#l38.174"></a><span id="l38.174">               let months = this.unescape(this.months[i]).split(&quot;|&quot;);</span>
<a href="#l38.175"></a><span id="l38.175">               if (months.includes(month.toLowerCase())) {</span>
<a href="#l38.176"></a><span id="l38.176" class="difflineminus">-                let date = { year: this.now.getFullYear(), month: i + 1, day: day };</span>
<a href="#l38.177"></a><span id="l38.177" class="difflineplus">+                let date = { year: this.now.getFullYear(), month: i + 1, day };</span>
<a href="#l38.178"></a><span id="l38.178">                 if (this.isPastDate(date, this.now)) {</span>
<a href="#l38.179"></a><span id="l38.179">                   // find next such date</span>
<a href="#l38.180"></a><span id="l38.180">                   let item = new Date(this.now.getTime());</span>
<a href="#l38.181"></a><span id="l38.181">                   while (true) {</span>
<a href="#l38.182"></a><span id="l38.182">                     item.setDate(item.getDate() + 1);</span>
<a href="#l38.183"></a><span id="l38.183">                     if (item.getMonth() == date.month - 1 &amp;&amp; item.getDate() == date.day) {</span>
<a href="#l38.184"></a><span id="l38.184">                       date.year = item.getFullYear();</span>
<a href="#l38.185"></a><span id="l38.185">                       break;</span>
<a href="#l38.186"></a><span id="l38.186" class="difflineat">@@ -505,30 +505,30 @@ Extractor.prototype = {</span>
<a href="#l38.187"></a><span id="l38.187">               }</span>
<a href="#l38.188"></a><span id="l38.188">             }</span>
<a href="#l38.189"></a><span id="l38.189">           }</span>
<a href="#l38.190"></a><span id="l38.190">         }</span>
<a href="#l38.191"></a><span id="l38.191">       }</span>
<a href="#l38.192"></a><span id="l38.192">     }</span>
<a href="#l38.193"></a><span id="l38.193">   },</span>
<a href="#l38.194"></a><span id="l38.194"> </span>
<a href="#l38.195"></a><span id="l38.195" class="difflineminus">-  extractDayMonth: function(pattern, relation) {</span>
<a href="#l38.196"></a><span id="l38.196" class="difflineplus">+  extractDayMonth(pattern, relation) {</span>
<a href="#l38.197"></a><span id="l38.197">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{1,2})&quot;]);</span>
<a href="#l38.198"></a><span id="l38.198">     let res;</span>
<a href="#l38.199"></a><span id="l38.199">     for (let alt in alts) {</span>
<a href="#l38.200"></a><span id="l38.200">       let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l38.201"></a><span id="l38.201">       let positions = alts[alt].positions;</span>
<a href="#l38.202"></a><span id="l38.202"> </span>
<a href="#l38.203"></a><span id="l38.203">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.204"></a><span id="l38.204">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.205"></a><span id="l38.205">           let day = parseInt(res[positions[1]], 10);</span>
<a href="#l38.206"></a><span id="l38.206">           let month = parseInt(res[positions[2]], 10);</span>
<a href="#l38.207"></a><span id="l38.207"> </span>
<a href="#l38.208"></a><span id="l38.208">           if (this.isValidMonth(month) &amp;&amp; this.isValidDay(day)) {</span>
<a href="#l38.209"></a><span id="l38.209" class="difflineminus">-            let date = { year: this.now.getFullYear(), month: month, day: day };</span>
<a href="#l38.210"></a><span id="l38.210" class="difflineplus">+            let date = { year: this.now.getFullYear(), month, day };</span>
<a href="#l38.211"></a><span id="l38.211"> </span>
<a href="#l38.212"></a><span id="l38.212">             if (this.isPastDate(date, this.now)) {</span>
<a href="#l38.213"></a><span id="l38.213">               // find next such date</span>
<a href="#l38.214"></a><span id="l38.214">               let item = new Date(this.now.getTime());</span>
<a href="#l38.215"></a><span id="l38.215">               while (true) {</span>
<a href="#l38.216"></a><span id="l38.216">                 item.setDate(item.getDate() + 1);</span>
<a href="#l38.217"></a><span id="l38.217">                 if (item.getMonth() == date.month - 1 &amp;&amp; item.getDate() == date.day) {</span>
<a href="#l38.218"></a><span id="l38.218">                   date.year = item.getFullYear();</span>
<a href="#l38.219"></a><span id="l38.219" class="difflineat">@@ -551,17 +551,17 @@ Extractor.prototype = {</span>
<a href="#l38.220"></a><span id="l38.220">               pattern</span>
<a href="#l38.221"></a><span id="l38.221">             );</span>
<a href="#l38.222"></a><span id="l38.222">           }</span>
<a href="#l38.223"></a><span id="l38.223">         }</span>
<a href="#l38.224"></a><span id="l38.224">       }</span>
<a href="#l38.225"></a><span id="l38.225">     }</span>
<a href="#l38.226"></a><span id="l38.226">   },</span>
<a href="#l38.227"></a><span id="l38.227"> </span>
<a href="#l38.228"></a><span id="l38.228" class="difflineminus">-  extractDate: function(pattern, relation) {</span>
<a href="#l38.229"></a><span id="l38.229" class="difflineplus">+  extractDate(pattern, relation) {</span>
<a href="#l38.230"></a><span id="l38.230">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;]);</span>
<a href="#l38.231"></a><span id="l38.231">     let res;</span>
<a href="#l38.232"></a><span id="l38.232">     for (let alt in alts) {</span>
<a href="#l38.233"></a><span id="l38.233">       let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l38.234"></a><span id="l38.234">       let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l38.235"></a><span id="l38.235"> </span>
<a href="#l38.236"></a><span id="l38.236">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.237"></a><span id="l38.237">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.238"></a><span id="l38.238" class="difflineat">@@ -593,17 +593,17 @@ Extractor.prototype = {</span>
<a href="#l38.239"></a><span id="l38.239">               true</span>
<a href="#l38.240"></a><span id="l38.240">             );</span>
<a href="#l38.241"></a><span id="l38.241">           }</span>
<a href="#l38.242"></a><span id="l38.242">         }</span>
<a href="#l38.243"></a><span id="l38.243">       }</span>
<a href="#l38.244"></a><span id="l38.244">     }</span>
<a href="#l38.245"></a><span id="l38.245">   },</span>
<a href="#l38.246"></a><span id="l38.246"> </span>
<a href="#l38.247"></a><span id="l38.247" class="difflineminus">-  extractWeekDay: function(pattern, relation) {</span>
<a href="#l38.248"></a><span id="l38.248" class="difflineplus">+  extractWeekDay(pattern, relation) {</span>
<a href="#l38.249"></a><span id="l38.249">     let days = [];</span>
<a href="#l38.250"></a><span id="l38.250">     for (let i = 0; i &lt; 7; i++) {</span>
<a href="#l38.251"></a><span id="l38.251">       days[i] = this.getPatterns(pattern + i);</span>
<a href="#l38.252"></a><span id="l38.252">       let re = new RegExp(days[i], &quot;ig&quot;);</span>
<a href="#l38.253"></a><span id="l38.253">       let res = re.exec(this.email);</span>
<a href="#l38.254"></a><span id="l38.254">       if (res) {</span>
<a href="#l38.255"></a><span id="l38.255">         if (!this.limitChars(res, this.email)) {</span>
<a href="#l38.256"></a><span id="l38.256">           let date = new Date();</span>
<a href="#l38.257"></a><span id="l38.257" class="difflineat">@@ -628,17 +628,17 @@ Extractor.prototype = {</span>
<a href="#l38.258"></a><span id="l38.258">             pattern + i,</span>
<a href="#l38.259"></a><span id="l38.259">             true</span>
<a href="#l38.260"></a><span id="l38.260">           );</span>
<a href="#l38.261"></a><span id="l38.261">         }</span>
<a href="#l38.262"></a><span id="l38.262">       }</span>
<a href="#l38.263"></a><span id="l38.263">     }</span>
<a href="#l38.264"></a><span id="l38.264">   },</span>
<a href="#l38.265"></a><span id="l38.265"> </span>
<a href="#l38.266"></a><span id="l38.266" class="difflineminus">-  extractHour: function(pattern, relation, meridiem) {</span>
<a href="#l38.267"></a><span id="l38.267" class="difflineplus">+  extractHour(pattern, relation, meridiem) {</span>
<a href="#l38.268"></a><span id="l38.268">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2}&quot; + this.marker + this.hourlyNumbers + &quot;)&quot;]);</span>
<a href="#l38.269"></a><span id="l38.269">     let res;</span>
<a href="#l38.270"></a><span id="l38.270">     for (let alt in alts) {</span>
<a href="#l38.271"></a><span id="l38.271">       let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l38.272"></a><span id="l38.272">       let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l38.273"></a><span id="l38.273"> </span>
<a href="#l38.274"></a><span id="l38.274">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.275"></a><span id="l38.275">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.276"></a><span id="l38.276" class="difflineat">@@ -668,17 +668,17 @@ Extractor.prototype = {</span>
<a href="#l38.277"></a><span id="l38.277">               true</span>
<a href="#l38.278"></a><span id="l38.278">             );</span>
<a href="#l38.279"></a><span id="l38.279">           }</span>
<a href="#l38.280"></a><span id="l38.280">         }</span>
<a href="#l38.281"></a><span id="l38.281">       }</span>
<a href="#l38.282"></a><span id="l38.282">     }</span>
<a href="#l38.283"></a><span id="l38.283">   },</span>
<a href="#l38.284"></a><span id="l38.284"> </span>
<a href="#l38.285"></a><span id="l38.285" class="difflineminus">-  extractHalfHour: function(pattern, relation, direction) {</span>
<a href="#l38.286"></a><span id="l38.286" class="difflineplus">+  extractHalfHour(pattern, relation, direction) {</span>
<a href="#l38.287"></a><span id="l38.287">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2}&quot; + this.marker + this.hourlyNumbers + &quot;)&quot;]);</span>
<a href="#l38.288"></a><span id="l38.288">     let res;</span>
<a href="#l38.289"></a><span id="l38.289">     for (let alt in alts) {</span>
<a href="#l38.290"></a><span id="l38.290">       let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l38.291"></a><span id="l38.291">       let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l38.292"></a><span id="l38.292"> </span>
<a href="#l38.293"></a><span id="l38.293">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.294"></a><span id="l38.294">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.295"></a><span id="l38.295" class="difflineat">@@ -709,17 +709,17 @@ Extractor.prototype = {</span>
<a href="#l38.296"></a><span id="l38.296">               true</span>
<a href="#l38.297"></a><span id="l38.297">             );</span>
<a href="#l38.298"></a><span id="l38.298">           }</span>
<a href="#l38.299"></a><span id="l38.299">         }</span>
<a href="#l38.300"></a><span id="l38.300">       }</span>
<a href="#l38.301"></a><span id="l38.301">     }</span>
<a href="#l38.302"></a><span id="l38.302">   },</span>
<a href="#l38.303"></a><span id="l38.303"> </span>
<a href="#l38.304"></a><span id="l38.304" class="difflineminus">-  extractHourMinutes: function(pattern, relation, meridiem) {</span>
<a href="#l38.305"></a><span id="l38.305" class="difflineplus">+  extractHourMinutes(pattern, relation, meridiem) {</span>
<a href="#l38.306"></a><span id="l38.306">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2})&quot;, &quot;(\\d{2})&quot;]);</span>
<a href="#l38.307"></a><span id="l38.307">     let res;</span>
<a href="#l38.308"></a><span id="l38.308">     for (let alt in alts) {</span>
<a href="#l38.309"></a><span id="l38.309">       let positions = alts[alt].positions;</span>
<a href="#l38.310"></a><span id="l38.310">       let re = new RegExp(alts[alt].pattern, &quot;ig&quot;);</span>
<a href="#l38.311"></a><span id="l38.311"> </span>
<a href="#l38.312"></a><span id="l38.312">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.313"></a><span id="l38.313">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.314"></a><span id="l38.314" class="difflineat">@@ -749,17 +749,17 @@ Extractor.prototype = {</span>
<a href="#l38.315"></a><span id="l38.315">               pattern</span>
<a href="#l38.316"></a><span id="l38.316">             );</span>
<a href="#l38.317"></a><span id="l38.317">           }</span>
<a href="#l38.318"></a><span id="l38.318">         }</span>
<a href="#l38.319"></a><span id="l38.319">       }</span>
<a href="#l38.320"></a><span id="l38.320">     }</span>
<a href="#l38.321"></a><span id="l38.321">   },</span>
<a href="#l38.322"></a><span id="l38.322"> </span>
<a href="#l38.323"></a><span id="l38.323" class="difflineminus">-  extractTime: function(pattern, relation, hour, minute) {</span>
<a href="#l38.324"></a><span id="l38.324" class="difflineplus">+  extractTime(pattern, relation, hour, minute) {</span>
<a href="#l38.325"></a><span id="l38.325">     let re = new RegExp(this.getPatterns(pattern), &quot;ig&quot;);</span>
<a href="#l38.326"></a><span id="l38.326">     let res;</span>
<a href="#l38.327"></a><span id="l38.327">     if ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.328"></a><span id="l38.328">       if (!this.limitChars(res, this.email)) {</span>
<a href="#l38.329"></a><span id="l38.329">         let rev = this.prefixSuffixStartEnd(res, relation, this.email);</span>
<a href="#l38.330"></a><span id="l38.330">         this.guess(</span>
<a href="#l38.331"></a><span id="l38.331">           null,</span>
<a href="#l38.332"></a><span id="l38.332">           null,</span>
<a href="#l38.333"></a><span id="l38.333" class="difflineat">@@ -771,17 +771,17 @@ Extractor.prototype = {</span>
<a href="#l38.334"></a><span id="l38.334">           rev.pattern,</span>
<a href="#l38.335"></a><span id="l38.335">           rev.relation,</span>
<a href="#l38.336"></a><span id="l38.336">           pattern</span>
<a href="#l38.337"></a><span id="l38.337">         );</span>
<a href="#l38.338"></a><span id="l38.338">       }</span>
<a href="#l38.339"></a><span id="l38.339">     }</span>
<a href="#l38.340"></a><span id="l38.340">   },</span>
<a href="#l38.341"></a><span id="l38.341"> </span>
<a href="#l38.342"></a><span id="l38.342" class="difflineminus">-  extractDuration: function(pattern, unit) {</span>
<a href="#l38.343"></a><span id="l38.343" class="difflineplus">+  extractDuration(pattern, unit) {</span>
<a href="#l38.344"></a><span id="l38.344">     let alts = this.getRepPatterns(pattern, [&quot;(\\d{1,2}&quot; + this.marker + this.dailyNumbers + &quot;)&quot;]);</span>
<a href="#l38.345"></a><span id="l38.345">     let res;</span>
<a href="#l38.346"></a><span id="l38.346">     for (let alt in alts) {</span>
<a href="#l38.347"></a><span id="l38.347">       let exp = alts[alt].pattern.split(this.marker).join(&quot;|&quot;);</span>
<a href="#l38.348"></a><span id="l38.348">       let re = new RegExp(exp, &quot;ig&quot;);</span>
<a href="#l38.349"></a><span id="l38.349"> </span>
<a href="#l38.350"></a><span id="l38.350">       while ((res = re.exec(this.email)) != null) {</span>
<a href="#l38.351"></a><span id="l38.351">         if (!this.limitNums(res, this.email) &amp;&amp; !this.limitChars(res, this.email)) {</span>
<a href="#l38.352"></a><span id="l38.352" class="difflineat">@@ -795,17 +795,17 @@ Extractor.prototype = {</span>
<a href="#l38.353"></a><span id="l38.353">           guess.relation = rev.relation;</span>
<a href="#l38.354"></a><span id="l38.354">           guess.pattern = pattern;</span>
<a href="#l38.355"></a><span id="l38.355">           this.collected.push(guess);</span>
<a href="#l38.356"></a><span id="l38.356">         }</span>
<a href="#l38.357"></a><span id="l38.357">       }</span>
<a href="#l38.358"></a><span id="l38.358">     }</span>
<a href="#l38.359"></a><span id="l38.359">   },</span>
<a href="#l38.360"></a><span id="l38.360"> </span>
<a href="#l38.361"></a><span id="l38.361" class="difflineminus">-  markContained: function() {</span>
<a href="#l38.362"></a><span id="l38.362" class="difflineplus">+  markContained() {</span>
<a href="#l38.363"></a><span id="l38.363">     for (let outer = 0; outer &lt; this.collected.length; outer++) {</span>
<a href="#l38.364"></a><span id="l38.364">       for (let inner = 0; inner &lt; this.collected.length; inner++) {</span>
<a href="#l38.365"></a><span id="l38.365">         // included but not exactly the same</span>
<a href="#l38.366"></a><span id="l38.366">         if (</span>
<a href="#l38.367"></a><span id="l38.367">           outer != inner &amp;&amp;</span>
<a href="#l38.368"></a><span id="l38.368">           this.collected[outer].start &amp;&amp;</span>
<a href="#l38.369"></a><span id="l38.369">           this.collected[outer].end &amp;&amp;</span>
<a href="#l38.370"></a><span id="l38.370">           this.collected[inner].start &amp;&amp;</span>
<a href="#l38.371"></a><span id="l38.371" class="difflineat">@@ -824,17 +824,17 @@ Extractor.prototype = {</span>
<a href="#l38.372"></a><span id="l38.372">               this.collected[inner].str</span>
<a href="#l38.373"></a><span id="l38.373">           );</span>
<a href="#l38.374"></a><span id="l38.374">           this.collected[inner].relation = &quot;notadatetime&quot;;</span>
<a href="#l38.375"></a><span id="l38.375">         }</span>
<a href="#l38.376"></a><span id="l38.376">       }</span>
<a href="#l38.377"></a><span id="l38.377">     }</span>
<a href="#l38.378"></a><span id="l38.378">   },</span>
<a href="#l38.379"></a><span id="l38.379"> </span>
<a href="#l38.380"></a><span id="l38.380" class="difflineminus">-  markSelected: function(sel, title) {</span>
<a href="#l38.381"></a><span id="l38.381" class="difflineplus">+  markSelected(sel, title) {</span>
<a href="#l38.382"></a><span id="l38.382">     if (sel.rangeCount &gt; 0) {</span>
<a href="#l38.383"></a><span id="l38.383">       // mark the ones to not use</span>
<a href="#l38.384"></a><span id="l38.384">       for (let i = 0; i &lt; sel.rangeCount; i++) {</span>
<a href="#l38.385"></a><span id="l38.385">         cal.LOG(&quot;[calExtract] Selection &quot; + i + &quot; is &quot; + sel);</span>
<a href="#l38.386"></a><span id="l38.386">         for (let j = 0; j &lt; this.collected.length; j++) {</span>
<a href="#l38.387"></a><span id="l38.387">           let selection = sel.getRangeAt(i).toString();</span>
<a href="#l38.388"></a><span id="l38.388"> </span>
<a href="#l38.389"></a><span id="l38.389">           if (</span>
<a href="#l38.390"></a><span id="l38.390" class="difflineat">@@ -848,17 +848,17 @@ Extractor.prototype = {</span>
<a href="#l38.391"></a><span id="l38.391">             );</span>
<a href="#l38.392"></a><span id="l38.392">             this.collected[j].relation = &quot;notadatetime&quot;;</span>
<a href="#l38.393"></a><span id="l38.393">           }</span>
<a href="#l38.394"></a><span id="l38.394">         }</span>
<a href="#l38.395"></a><span id="l38.395">       }</span>
<a href="#l38.396"></a><span id="l38.396">     }</span>
<a href="#l38.397"></a><span id="l38.397">   },</span>
<a href="#l38.398"></a><span id="l38.398"> </span>
<a href="#l38.399"></a><span id="l38.399" class="difflineminus">-  sort: function(one, two) {</span>
<a href="#l38.400"></a><span id="l38.400" class="difflineplus">+  sort(one, two) {</span>
<a href="#l38.401"></a><span id="l38.401">     let rc;</span>
<a href="#l38.402"></a><span id="l38.402">     // sort the guess from email date as the last one</span>
<a href="#l38.403"></a><span id="l38.403">     if (one.start == null &amp;&amp; two.start != null) {</span>
<a href="#l38.404"></a><span id="l38.404">       return 1;</span>
<a href="#l38.405"></a><span id="l38.405">     } else if (one.start != null &amp;&amp; two.start == null) {</span>
<a href="#l38.406"></a><span id="l38.406">       return -1;</span>
<a href="#l38.407"></a><span id="l38.407">     } else if (one.start == null &amp;&amp; two.start == null) {</span>
<a href="#l38.408"></a><span id="l38.408">       return 0;</span>
<a href="#l38.409"></a><span id="l38.409" class="difflineat">@@ -871,32 +871,31 @@ Extractor.prototype = {</span>
<a href="#l38.410"></a><span id="l38.410">       rc = (one.year &gt; two.year) - (one.year &lt; two.year);</span>
<a href="#l38.411"></a><span id="l38.411">       if (rc == 0) {</span>
<a href="#l38.412"></a><span id="l38.412">         rc = (one.month &gt; two.month) - (one.month &lt; two.month);</span>
<a href="#l38.413"></a><span id="l38.413">         if (rc == 0) {</span>
<a href="#l38.414"></a><span id="l38.414">           rc = (one.day &gt; two.day) - (one.day &lt; two.day);</span>
<a href="#l38.415"></a><span id="l38.415">         }</span>
<a href="#l38.416"></a><span id="l38.416">       }</span>
<a href="#l38.417"></a><span id="l38.417">       return rc;</span>
<a href="#l38.418"></a><span id="l38.418" class="difflineminus">-    } else {</span>
<a href="#l38.419"></a><span id="l38.419" class="difflineminus">-      rc = (one.hour &gt; two.hour) - (one.hour &lt; two.hour);</span>
<a href="#l38.420"></a><span id="l38.420" class="difflineminus">-      if (rc == 0) {</span>
<a href="#l38.421"></a><span id="l38.421" class="difflineminus">-        rc = (one.minute &gt; two.minute) - (one.minute &lt; two.minute);</span>
<a href="#l38.422"></a><span id="l38.422" class="difflineminus">-      }</span>
<a href="#l38.423"></a><span id="l38.423" class="difflineminus">-      return rc;</span>
<a href="#l38.424"></a><span id="l38.424">     }</span>
<a href="#l38.425"></a><span id="l38.425" class="difflineplus">+    rc = (one.hour &gt; two.hour) - (one.hour &lt; two.hour);</span>
<a href="#l38.426"></a><span id="l38.426" class="difflineplus">+    if (rc == 0) {</span>
<a href="#l38.427"></a><span id="l38.427" class="difflineplus">+      rc = (one.minute &gt; two.minute) - (one.minute &lt; two.minute);</span>
<a href="#l38.428"></a><span id="l38.428" class="difflineplus">+    }</span>
<a href="#l38.429"></a><span id="l38.429" class="difflineplus">+    return rc;</span>
<a href="#l38.430"></a><span id="l38.430">   },</span>
<a href="#l38.431"></a><span id="l38.431"> </span>
<a href="#l38.432"></a><span id="l38.432">   /**</span>
<a href="#l38.433"></a><span id="l38.433">    * Guesses start time from list of guessed datetimes</span>
<a href="#l38.434"></a><span id="l38.434">    *</span>
<a href="#l38.435"></a><span id="l38.435">    * @param isTask    whether start time should be guessed for task or event</span>
<a href="#l38.436"></a><span id="l38.436">    * @return          datetime object for start time</span>
<a href="#l38.437"></a><span id="l38.437">    */</span>
<a href="#l38.438"></a><span id="l38.438" class="difflineminus">-  guessStart: function(isTask) {</span>
<a href="#l38.439"></a><span id="l38.439" class="difflineplus">+  guessStart(isTask) {</span>
<a href="#l38.440"></a><span id="l38.440">     let startTimes = this.collected.filter(val =&gt; val.relation == &quot;start&quot;);</span>
<a href="#l38.441"></a><span id="l38.441">     if (startTimes.length == 0) {</span>
<a href="#l38.442"></a><span id="l38.442">       return {};</span>
<a href="#l38.443"></a><span id="l38.443">     }</span>
<a href="#l38.444"></a><span id="l38.444"> </span>
<a href="#l38.445"></a><span id="l38.445">     for (let val in startTimes) {</span>
<a href="#l38.446"></a><span id="l38.446">       cal.LOG(&quot;[calExtract] Start: &quot; + JSON.stringify(startTimes[val]));</span>
<a href="#l38.447"></a><span id="l38.447">     }</span>
<a href="#l38.448"></a><span id="l38.448" class="difflineat">@@ -962,153 +961,152 @@ Extractor.prototype = {</span>
<a href="#l38.449"></a><span id="l38.449"> </span>
<a href="#l38.450"></a><span id="l38.450">   /**</span>
<a href="#l38.451"></a><span id="l38.451">    * Guesses end time from list of guessed datetimes relative to start time</span>
<a href="#l38.452"></a><span id="l38.452">    *</span>
<a href="#l38.453"></a><span id="l38.453">    * @param start         start time to consider when guessing</span>
<a href="#l38.454"></a><span id="l38.454">    * @param doGuessStart  whether start time should be guessed for task or event</span>
<a href="#l38.455"></a><span id="l38.455">    * @return              datetime object for end time</span>
<a href="#l38.456"></a><span id="l38.456">    */</span>
<a href="#l38.457"></a><span id="l38.457" class="difflineminus">-  guessEnd: function(start, doGuessStart) {</span>
<a href="#l38.458"></a><span id="l38.458" class="difflineplus">+  guessEnd(start, doGuessStart) {</span>
<a href="#l38.459"></a><span id="l38.459">     let guess = {};</span>
<a href="#l38.460"></a><span id="l38.460">     let endTimes = this.collected.filter(val =&gt; val.relation == &quot;end&quot;);</span>
<a href="#l38.461"></a><span id="l38.461">     let durations = this.collected.filter(val =&gt; val.relation == &quot;duration&quot;);</span>
<a href="#l38.462"></a><span id="l38.462">     if (endTimes.length == 0 &amp;&amp; durations.length == 0) {</span>
<a href="#l38.463"></a><span id="l38.463">       return {};</span>
<a href="#l38.464"></a><span id="l38.464" class="difflineminus">-    } else {</span>
<a href="#l38.465"></a><span id="l38.465" class="difflineminus">-      for (let val in endTimes) {</span>
<a href="#l38.466"></a><span id="l38.466" class="difflineminus">-        cal.LOG(&quot;[calExtract] End: &quot; + JSON.stringify(endTimes[val]));</span>
<a href="#l38.467"></a><span id="l38.467" class="difflineminus">-      }</span>
<a href="#l38.468"></a><span id="l38.468" class="difflineplus">+    }</span>
<a href="#l38.469"></a><span id="l38.469" class="difflineplus">+    for (let val in endTimes) {</span>
<a href="#l38.470"></a><span id="l38.470" class="difflineplus">+      cal.LOG(&quot;[calExtract] End: &quot; + JSON.stringify(endTimes[val]));</span>
<a href="#l38.471"></a><span id="l38.471" class="difflineplus">+    }</span>
<a href="#l38.472"></a><span id="l38.472"> </span>
<a href="#l38.473"></a><span id="l38.473" class="difflineminus">-      let wDay = endTimes.filter(val =&gt; val.day != null);</span>
<a href="#l38.474"></a><span id="l38.474" class="difflineminus">-      let wDayNA = wDay.filter(val =&gt; val.ambiguous === undefined);</span>
<a href="#l38.475"></a><span id="l38.475" class="difflineminus">-      let wMinute = endTimes.filter(val =&gt; val.minute != null);</span>
<a href="#l38.476"></a><span id="l38.476" class="difflineminus">-      let wMinuteNA = wMinute.filter(val =&gt; val.ambiguous === undefined);</span>
<a href="#l38.477"></a><span id="l38.477" class="difflineplus">+    let wDay = endTimes.filter(val =&gt; val.day != null);</span>
<a href="#l38.478"></a><span id="l38.478" class="difflineplus">+    let wDayNA = wDay.filter(val =&gt; val.ambiguous === undefined);</span>
<a href="#l38.479"></a><span id="l38.479" class="difflineplus">+    let wMinute = endTimes.filter(val =&gt; val.minute != null);</span>
<a href="#l38.480"></a><span id="l38.480" class="difflineplus">+    let wMinuteNA = wMinute.filter(val =&gt; val.ambiguous === undefined);</span>
<a href="#l38.481"></a><span id="l38.481"> </span>
<a href="#l38.482"></a><span id="l38.482" class="difflineminus">-      // first set non-ambiguous dates</span>
<a href="#l38.483"></a><span id="l38.483" class="difflineminus">-      let pos = doGuessStart ? 0 : wDayNA.length - 1;</span>
<a href="#l38.484"></a><span id="l38.484" class="difflineminus">-      if (wDayNA.length != 0) {</span>
<a href="#l38.485"></a><span id="l38.485" class="difflineminus">-        guess.year = wDayNA[pos].year;</span>
<a href="#l38.486"></a><span id="l38.486" class="difflineminus">-        guess.month = wDayNA[pos].month;</span>
<a href="#l38.487"></a><span id="l38.487" class="difflineminus">-        guess.day = wDayNA[pos].day;</span>
<a href="#l38.488"></a><span id="l38.488" class="difflineminus">-        // then ambiguous dates</span>
<a href="#l38.489"></a><span id="l38.489" class="difflineminus">-      } else if (wDay.length != 0) {</span>
<a href="#l38.490"></a><span id="l38.490" class="difflineminus">-        pos = doGuessStart ? 0 : wDay.length - 1;</span>
<a href="#l38.491"></a><span id="l38.491" class="difflineminus">-        guess.year = wDay[pos].year;</span>
<a href="#l38.492"></a><span id="l38.492" class="difflineminus">-        guess.month = wDay[pos].month;</span>
<a href="#l38.493"></a><span id="l38.493" class="difflineminus">-        guess.day = wDay[pos].day;</span>
<a href="#l38.494"></a><span id="l38.494" class="difflineminus">-      }</span>
<a href="#l38.495"></a><span id="l38.495" class="difflineplus">+    // first set non-ambiguous dates</span>
<a href="#l38.496"></a><span id="l38.496" class="difflineplus">+    let pos = doGuessStart ? 0 : wDayNA.length - 1;</span>
<a href="#l38.497"></a><span id="l38.497" class="difflineplus">+    if (wDayNA.length != 0) {</span>
<a href="#l38.498"></a><span id="l38.498" class="difflineplus">+      guess.year = wDayNA[pos].year;</span>
<a href="#l38.499"></a><span id="l38.499" class="difflineplus">+      guess.month = wDayNA[pos].month;</span>
<a href="#l38.500"></a><span id="l38.500" class="difflineplus">+      guess.day = wDayNA[pos].day;</span>
<a href="#l38.501"></a><span id="l38.501" class="difflineplus">+      // then ambiguous dates</span>
<a href="#l38.502"></a><span id="l38.502" class="difflineplus">+    } else if (wDay.length != 0) {</span>
<a href="#l38.503"></a><span id="l38.503" class="difflineplus">+      pos = doGuessStart ? 0 : wDay.length - 1;</span>
<a href="#l38.504"></a><span id="l38.504" class="difflineplus">+      guess.year = wDay[pos].year;</span>
<a href="#l38.505"></a><span id="l38.505" class="difflineplus">+      guess.month = wDay[pos].month;</span>
<a href="#l38.506"></a><span id="l38.506" class="difflineplus">+      guess.day = wDay[pos].day;</span>
<a href="#l38.507"></a><span id="l38.507" class="difflineplus">+    }</span>
<a href="#l38.508"></a><span id="l38.508"> </span>
<a href="#l38.509"></a><span id="l38.509" class="difflineminus">-      // then non-ambiguous times</span>
<a href="#l38.510"></a><span id="l38.510" class="difflineminus">-      if (wMinuteNA.length != 0) {</span>
<a href="#l38.511"></a><span id="l38.511" class="difflineminus">-        pos = doGuessStart ? 0 : wMinuteNA.length - 1;</span>
<a href="#l38.512"></a><span id="l38.512" class="difflineminus">-        guess.hour = wMinuteNA[pos].hour;</span>
<a href="#l38.513"></a><span id="l38.513" class="difflineminus">-        guess.minute = wMinuteNA[pos].minute;</span>
<a href="#l38.514"></a><span id="l38.514" class="difflineminus">-        if (guess.day == null || guess.day == start.day) {</span>
<a href="#l38.515"></a><span id="l38.515" class="difflineminus">-          if (</span>
<a href="#l38.516"></a><span id="l38.516" class="difflineminus">-            wMinuteNA[pos].hour &lt; start.hour ||</span>
<a href="#l38.517"></a><span id="l38.517" class="difflineminus">-            (wMinuteNA[pos].hour == start.hour &amp;&amp; wMinuteNA[pos].minute &lt; start.minute)</span>
<a href="#l38.518"></a><span id="l38.518" class="difflineminus">-          ) {</span>
<a href="#l38.519"></a><span id="l38.519" class="difflineminus">-            let nextDay = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.520"></a><span id="l38.520" class="difflineminus">-            nextDay.setTime(nextDay.getTime() + 60 * 60 * 24 * 1000);</span>
<a href="#l38.521"></a><span id="l38.521" class="difflineminus">-            guess.year = nextDay.getFullYear();</span>
<a href="#l38.522"></a><span id="l38.522" class="difflineminus">-            guess.month = nextDay.getMonth() + 1;</span>
<a href="#l38.523"></a><span id="l38.523" class="difflineminus">-            guess.day = nextDay.getDate();</span>
<a href="#l38.524"></a><span id="l38.524" class="difflineminus">-          }</span>
<a href="#l38.525"></a><span id="l38.525" class="difflineplus">+    // then non-ambiguous times</span>
<a href="#l38.526"></a><span id="l38.526" class="difflineplus">+    if (wMinuteNA.length != 0) {</span>
<a href="#l38.527"></a><span id="l38.527" class="difflineplus">+      pos = doGuessStart ? 0 : wMinuteNA.length - 1;</span>
<a href="#l38.528"></a><span id="l38.528" class="difflineplus">+      guess.hour = wMinuteNA[pos].hour;</span>
<a href="#l38.529"></a><span id="l38.529" class="difflineplus">+      guess.minute = wMinuteNA[pos].minute;</span>
<a href="#l38.530"></a><span id="l38.530" class="difflineplus">+      if (guess.day == null || guess.day == start.day) {</span>
<a href="#l38.531"></a><span id="l38.531" class="difflineplus">+        if (</span>
<a href="#l38.532"></a><span id="l38.532" class="difflineplus">+          wMinuteNA[pos].hour &lt; start.hour ||</span>
<a href="#l38.533"></a><span id="l38.533" class="difflineplus">+          (wMinuteNA[pos].hour == start.hour &amp;&amp; wMinuteNA[pos].minute &lt; start.minute)</span>
<a href="#l38.534"></a><span id="l38.534" class="difflineplus">+        ) {</span>
<a href="#l38.535"></a><span id="l38.535" class="difflineplus">+          let nextDay = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.536"></a><span id="l38.536" class="difflineplus">+          nextDay.setTime(nextDay.getTime() + 60 * 60 * 24 * 1000);</span>
<a href="#l38.537"></a><span id="l38.537" class="difflineplus">+          guess.year = nextDay.getFullYear();</span>
<a href="#l38.538"></a><span id="l38.538" class="difflineplus">+          guess.month = nextDay.getMonth() + 1;</span>
<a href="#l38.539"></a><span id="l38.539" class="difflineplus">+          guess.day = nextDay.getDate();</span>
<a href="#l38.540"></a><span id="l38.540">         }</span>
<a href="#l38.541"></a><span id="l38.541" class="difflineminus">-        // and ambiguous times</span>
<a href="#l38.542"></a><span id="l38.542" class="difflineminus">-      } else if (wMinute.length != 0) {</span>
<a href="#l38.543"></a><span id="l38.543" class="difflineminus">-        pos = doGuessStart ? 0 : wMinute.length - 1;</span>
<a href="#l38.544"></a><span id="l38.544" class="difflineminus">-        guess.hour = wMinute[pos].hour;</span>
<a href="#l38.545"></a><span id="l38.545" class="difflineminus">-        guess.minute = wMinute[pos].minute;</span>
<a href="#l38.546"></a><span id="l38.546" class="difflineminus">-        if (guess.day == null || guess.day == start.day) {</span>
<a href="#l38.547"></a><span id="l38.547" class="difflineminus">-          if (</span>
<a href="#l38.548"></a><span id="l38.548" class="difflineminus">-            wMinute[pos].hour &lt; start.hour ||</span>
<a href="#l38.549"></a><span id="l38.549" class="difflineminus">-            (wMinute[pos].hour == start.hour &amp;&amp; wMinute[pos].minute &lt; start.minute)</span>
<a href="#l38.550"></a><span id="l38.550" class="difflineminus">-          ) {</span>
<a href="#l38.551"></a><span id="l38.551" class="difflineminus">-            let nextDay = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.552"></a><span id="l38.552" class="difflineminus">-            nextDay.setTime(nextDay.getTime() + 60 * 60 * 24 * 1000);</span>
<a href="#l38.553"></a><span id="l38.553" class="difflineminus">-            guess.year = nextDay.getFullYear();</span>
<a href="#l38.554"></a><span id="l38.554" class="difflineminus">-            guess.month = nextDay.getMonth() + 1;</span>
<a href="#l38.555"></a><span id="l38.555" class="difflineminus">-            guess.day = nextDay.getDate();</span>
<a href="#l38.556"></a><span id="l38.556" class="difflineminus">-          }</span>
<a href="#l38.557"></a><span id="l38.557" class="difflineplus">+      }</span>
<a href="#l38.558"></a><span id="l38.558" class="difflineplus">+      // and ambiguous times</span>
<a href="#l38.559"></a><span id="l38.559" class="difflineplus">+    } else if (wMinute.length != 0) {</span>
<a href="#l38.560"></a><span id="l38.560" class="difflineplus">+      pos = doGuessStart ? 0 : wMinute.length - 1;</span>
<a href="#l38.561"></a><span id="l38.561" class="difflineplus">+      guess.hour = wMinute[pos].hour;</span>
<a href="#l38.562"></a><span id="l38.562" class="difflineplus">+      guess.minute = wMinute[pos].minute;</span>
<a href="#l38.563"></a><span id="l38.563" class="difflineplus">+      if (guess.day == null || guess.day == start.day) {</span>
<a href="#l38.564"></a><span id="l38.564" class="difflineplus">+        if (</span>
<a href="#l38.565"></a><span id="l38.565" class="difflineplus">+          wMinute[pos].hour &lt; start.hour ||</span>
<a href="#l38.566"></a><span id="l38.566" class="difflineplus">+          (wMinute[pos].hour == start.hour &amp;&amp; wMinute[pos].minute &lt; start.minute)</span>
<a href="#l38.567"></a><span id="l38.567" class="difflineplus">+        ) {</span>
<a href="#l38.568"></a><span id="l38.568" class="difflineplus">+          let nextDay = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.569"></a><span id="l38.569" class="difflineplus">+          nextDay.setTime(nextDay.getTime() + 60 * 60 * 24 * 1000);</span>
<a href="#l38.570"></a><span id="l38.570" class="difflineplus">+          guess.year = nextDay.getFullYear();</span>
<a href="#l38.571"></a><span id="l38.571" class="difflineplus">+          guess.month = nextDay.getMonth() + 1;</span>
<a href="#l38.572"></a><span id="l38.572" class="difflineplus">+          guess.day = nextDay.getDate();</span>
<a href="#l38.573"></a><span id="l38.573">         }</span>
<a href="#l38.574"></a><span id="l38.574">       }</span>
<a href="#l38.575"></a><span id="l38.575" class="difflineplus">+    }</span>
<a href="#l38.576"></a><span id="l38.576" class="difflineplus">+</span>
<a href="#l38.577"></a><span id="l38.577" class="difflineplus">+    // fill in date when time was guessed</span>
<a href="#l38.578"></a><span id="l38.578" class="difflineplus">+    if (guess.minute != null &amp;&amp; guess.day == null) {</span>
<a href="#l38.579"></a><span id="l38.579" class="difflineplus">+      guess.year = start.year;</span>
<a href="#l38.580"></a><span id="l38.580" class="difflineplus">+      guess.month = start.month;</span>
<a href="#l38.581"></a><span id="l38.581" class="difflineplus">+      guess.day = start.day;</span>
<a href="#l38.582"></a><span id="l38.582" class="difflineplus">+    }</span>
<a href="#l38.583"></a><span id="l38.583" class="difflineplus">+</span>
<a href="#l38.584"></a><span id="l38.584" class="difflineplus">+    // fill in end from total duration</span>
<a href="#l38.585"></a><span id="l38.585" class="difflineplus">+    if (guess.day == null &amp;&amp; guess.hour == null) {</span>
<a href="#l38.586"></a><span id="l38.586" class="difflineplus">+      let duration = 0;</span>
<a href="#l38.587"></a><span id="l38.587" class="difflineplus">+</span>
<a href="#l38.588"></a><span id="l38.588" class="difflineplus">+      for (let val in durations) {</span>
<a href="#l38.589"></a><span id="l38.589" class="difflineplus">+        duration += durations[val].duration;</span>
<a href="#l38.590"></a><span id="l38.590" class="difflineplus">+        cal.LOG(&quot;[calExtract] Dur: &quot; + JSON.stringify(durations[val]));</span>
<a href="#l38.591"></a><span id="l38.591" class="difflineplus">+      }</span>
<a href="#l38.592"></a><span id="l38.592"> </span>
<a href="#l38.593"></a><span id="l38.593" class="difflineminus">-      // fill in date when time was guessed</span>
<a href="#l38.594"></a><span id="l38.594" class="difflineminus">-      if (guess.minute != null &amp;&amp; guess.day == null) {</span>
<a href="#l38.595"></a><span id="l38.595" class="difflineminus">-        guess.year = start.year;</span>
<a href="#l38.596"></a><span id="l38.596" class="difflineminus">-        guess.month = start.month;</span>
<a href="#l38.597"></a><span id="l38.597" class="difflineminus">-        guess.day = start.day;</span>
<a href="#l38.598"></a><span id="l38.598" class="difflineminus">-      }</span>
<a href="#l38.599"></a><span id="l38.599" class="difflineminus">-</span>
<a href="#l38.600"></a><span id="l38.600" class="difflineminus">-      // fill in end from total duration</span>
<a href="#l38.601"></a><span id="l38.601" class="difflineminus">-      if (guess.day == null &amp;&amp; guess.hour == null) {</span>
<a href="#l38.602"></a><span id="l38.602" class="difflineminus">-        let duration = 0;</span>
<a href="#l38.603"></a><span id="l38.603" class="difflineminus">-</span>
<a href="#l38.604"></a><span id="l38.604" class="difflineminus">-        for (let val in durations) {</span>
<a href="#l38.605"></a><span id="l38.605" class="difflineminus">-          duration += durations[val].duration;</span>
<a href="#l38.606"></a><span id="l38.606" class="difflineminus">-          cal.LOG(&quot;[calExtract] Dur: &quot; + JSON.stringify(durations[val]));</span>
<a href="#l38.607"></a><span id="l38.607" class="difflineplus">+      if (duration != 0) {</span>
<a href="#l38.608"></a><span id="l38.608" class="difflineplus">+        let startDate = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.609"></a><span id="l38.609" class="difflineplus">+        if (&quot;hour&quot; in start) {</span>
<a href="#l38.610"></a><span id="l38.610" class="difflineplus">+          startDate.setHours(start.hour);</span>
<a href="#l38.611"></a><span id="l38.611" class="difflineplus">+          startDate.setMinutes(start.minute);</span>
<a href="#l38.612"></a><span id="l38.612" class="difflineplus">+        } else {</span>
<a href="#l38.613"></a><span id="l38.613" class="difflineplus">+          startDate.setHours(0);</span>
<a href="#l38.614"></a><span id="l38.614" class="difflineplus">+          startDate.setMinutes(0);</span>
<a href="#l38.615"></a><span id="l38.615">         }</span>
<a href="#l38.616"></a><span id="l38.616"> </span>
<a href="#l38.617"></a><span id="l38.617" class="difflineminus">-        if (duration != 0) {</span>
<a href="#l38.618"></a><span id="l38.618" class="difflineminus">-          let startDate = new Date(start.year, start.month - 1, start.day);</span>
<a href="#l38.619"></a><span id="l38.619" class="difflineminus">-          if (&quot;hour&quot; in start) {</span>
<a href="#l38.620"></a><span id="l38.620" class="difflineminus">-            startDate.setHours(start.hour);</span>
<a href="#l38.621"></a><span id="l38.621" class="difflineminus">-            startDate.setMinutes(start.minute);</span>
<a href="#l38.622"></a><span id="l38.622" class="difflineminus">-          } else {</span>
<a href="#l38.623"></a><span id="l38.623" class="difflineminus">-            startDate.setHours(0);</span>
<a href="#l38.624"></a><span id="l38.624" class="difflineminus">-            startDate.setMinutes(0);</span>
<a href="#l38.625"></a><span id="l38.625" class="difflineminus">-          }</span>
<a href="#l38.626"></a><span id="l38.626" class="difflineminus">-</span>
<a href="#l38.627"></a><span id="l38.627" class="difflineminus">-          let endTime = new Date(startDate.getTime() + duration * 60 * 1000);</span>
<a href="#l38.628"></a><span id="l38.628" class="difflineminus">-          guess.year = endTime.getFullYear();</span>
<a href="#l38.629"></a><span id="l38.629" class="difflineminus">-          guess.month = endTime.getMonth() + 1;</span>
<a href="#l38.630"></a><span id="l38.630" class="difflineminus">-          guess.day = endTime.getDate();</span>
<a href="#l38.631"></a><span id="l38.631" class="difflineminus">-          if (!(endTime.getHours() == 0 &amp;&amp; endTime.getMinutes() == 0)) {</span>
<a href="#l38.632"></a><span id="l38.632" class="difflineminus">-            guess.hour = endTime.getHours();</span>
<a href="#l38.633"></a><span id="l38.633" class="difflineminus">-            guess.minute = endTime.getMinutes();</span>
<a href="#l38.634"></a><span id="l38.634" class="difflineminus">-          }</span>
<a href="#l38.635"></a><span id="l38.635" class="difflineplus">+        let endTime = new Date(startDate.getTime() + duration * 60 * 1000);</span>
<a href="#l38.636"></a><span id="l38.636" class="difflineplus">+        guess.year = endTime.getFullYear();</span>
<a href="#l38.637"></a><span id="l38.637" class="difflineplus">+        guess.month = endTime.getMonth() + 1;</span>
<a href="#l38.638"></a><span id="l38.638" class="difflineplus">+        guess.day = endTime.getDate();</span>
<a href="#l38.639"></a><span id="l38.639" class="difflineplus">+        if (!(endTime.getHours() == 0 &amp;&amp; endTime.getMinutes() == 0)) {</span>
<a href="#l38.640"></a><span id="l38.640" class="difflineplus">+          guess.hour = endTime.getHours();</span>
<a href="#l38.641"></a><span id="l38.641" class="difflineplus">+          guess.minute = endTime.getMinutes();</span>
<a href="#l38.642"></a><span id="l38.642">         }</span>
<a href="#l38.643"></a><span id="l38.643">       }</span>
<a href="#l38.644"></a><span id="l38.644" class="difflineplus">+    }</span>
<a href="#l38.645"></a><span id="l38.645"> </span>
<a href="#l38.646"></a><span id="l38.646" class="difflineminus">-      // no zero or negative length events/tasks</span>
<a href="#l38.647"></a><span id="l38.647" class="difflineminus">-      let startTime = new Date(</span>
<a href="#l38.648"></a><span id="l38.648" class="difflineminus">-        start.year || 0,</span>
<a href="#l38.649"></a><span id="l38.649" class="difflineminus">-        start.month - 1 || 0,</span>
<a href="#l38.650"></a><span id="l38.650" class="difflineminus">-        start.day || 0,</span>
<a href="#l38.651"></a><span id="l38.651" class="difflineminus">-        start.hour || 0,</span>
<a href="#l38.652"></a><span id="l38.652" class="difflineminus">-        start.minute || 0</span>
<a href="#l38.653"></a><span id="l38.653" class="difflineminus">-      ).getTime();</span>
<a href="#l38.654"></a><span id="l38.654" class="difflineminus">-      let guessTime = new Date(</span>
<a href="#l38.655"></a><span id="l38.655" class="difflineminus">-        guess.year || 0,</span>
<a href="#l38.656"></a><span id="l38.656" class="difflineminus">-        guess.month - 1 || 0,</span>
<a href="#l38.657"></a><span id="l38.657" class="difflineminus">-        guess.day || 0,</span>
<a href="#l38.658"></a><span id="l38.658" class="difflineminus">-        guess.hour || 0,</span>
<a href="#l38.659"></a><span id="l38.659" class="difflineminus">-        guess.minute || 0</span>
<a href="#l38.660"></a><span id="l38.660" class="difflineminus">-      ).getTime();</span>
<a href="#l38.661"></a><span id="l38.661" class="difflineminus">-      if (guessTime &lt;= startTime) {</span>
<a href="#l38.662"></a><span id="l38.662" class="difflineminus">-        guess.year = null;</span>
<a href="#l38.663"></a><span id="l38.663" class="difflineminus">-        guess.month = null;</span>
<a href="#l38.664"></a><span id="l38.664" class="difflineminus">-        guess.day = null;</span>
<a href="#l38.665"></a><span id="l38.665" class="difflineminus">-        guess.hour = null;</span>
<a href="#l38.666"></a><span id="l38.666" class="difflineminus">-        guess.minute = null;</span>
<a href="#l38.667"></a><span id="l38.667" class="difflineminus">-      }</span>
<a href="#l38.668"></a><span id="l38.668" class="difflineplus">+    // no zero or negative length events/tasks</span>
<a href="#l38.669"></a><span id="l38.669" class="difflineplus">+    let startTime = new Date(</span>
<a href="#l38.670"></a><span id="l38.670" class="difflineplus">+      start.year || 0,</span>
<a href="#l38.671"></a><span id="l38.671" class="difflineplus">+      start.month - 1 || 0,</span>
<a href="#l38.672"></a><span id="l38.672" class="difflineplus">+      start.day || 0,</span>
<a href="#l38.673"></a><span id="l38.673" class="difflineplus">+      start.hour || 0,</span>
<a href="#l38.674"></a><span id="l38.674" class="difflineplus">+      start.minute || 0</span>
<a href="#l38.675"></a><span id="l38.675" class="difflineplus">+    ).getTime();</span>
<a href="#l38.676"></a><span id="l38.676" class="difflineplus">+    let guessTime = new Date(</span>
<a href="#l38.677"></a><span id="l38.677" class="difflineplus">+      guess.year || 0,</span>
<a href="#l38.678"></a><span id="l38.678" class="difflineplus">+      guess.month - 1 || 0,</span>
<a href="#l38.679"></a><span id="l38.679" class="difflineplus">+      guess.day || 0,</span>
<a href="#l38.680"></a><span id="l38.680" class="difflineplus">+      guess.hour || 0,</span>
<a href="#l38.681"></a><span id="l38.681" class="difflineplus">+      guess.minute || 0</span>
<a href="#l38.682"></a><span id="l38.682" class="difflineplus">+    ).getTime();</span>
<a href="#l38.683"></a><span id="l38.683" class="difflineplus">+    if (guessTime &lt;= startTime) {</span>
<a href="#l38.684"></a><span id="l38.684" class="difflineplus">+      guess.year = null;</span>
<a href="#l38.685"></a><span id="l38.685" class="difflineplus">+      guess.month = null;</span>
<a href="#l38.686"></a><span id="l38.686" class="difflineplus">+      guess.day = null;</span>
<a href="#l38.687"></a><span id="l38.687" class="difflineplus">+      guess.hour = null;</span>
<a href="#l38.688"></a><span id="l38.688" class="difflineplus">+      guess.minute = null;</span>
<a href="#l38.689"></a><span id="l38.689" class="difflineplus">+    }</span>
<a href="#l38.690"></a><span id="l38.690"> </span>
<a href="#l38.691"></a><span id="l38.691" class="difflineminus">-      if (guess.year != null &amp;&amp; guess.minute == null &amp;&amp; doGuessStart) {</span>
<a href="#l38.692"></a><span id="l38.692" class="difflineminus">-        guess.hour = 0;</span>
<a href="#l38.693"></a><span id="l38.693" class="difflineminus">-        guess.minute = 0;</span>
<a href="#l38.694"></a><span id="l38.694" class="difflineminus">-      }</span>
<a href="#l38.695"></a><span id="l38.695" class="difflineplus">+    if (guess.year != null &amp;&amp; guess.minute == null &amp;&amp; doGuessStart) {</span>
<a href="#l38.696"></a><span id="l38.696" class="difflineplus">+      guess.hour = 0;</span>
<a href="#l38.697"></a><span id="l38.697" class="difflineplus">+      guess.minute = 0;</span>
<a href="#l38.698"></a><span id="l38.698" class="difflineplus">+    }</span>
<a href="#l38.699"></a><span id="l38.699"> </span>
<a href="#l38.700"></a><span id="l38.700" class="difflineminus">-      cal.LOG(&quot;[calExtract] End picked: &quot; + JSON.stringify(guess));</span>
<a href="#l38.701"></a><span id="l38.701" class="difflineminus">-      return guess;</span>
<a href="#l38.702"></a><span id="l38.702" class="difflineminus">-    }</span>
<a href="#l38.703"></a><span id="l38.703" class="difflineplus">+    cal.LOG(&quot;[calExtract] End picked: &quot; + JSON.stringify(guess));</span>
<a href="#l38.704"></a><span id="l38.704" class="difflineplus">+    return guess;</span>
<a href="#l38.705"></a><span id="l38.705">   },</span>
<a href="#l38.706"></a><span id="l38.706"> </span>
<a href="#l38.707"></a><span id="l38.707" class="difflineminus">-  getPatterns: function(name) {</span>
<a href="#l38.708"></a><span id="l38.708" class="difflineplus">+  getPatterns(name) {</span>
<a href="#l38.709"></a><span id="l38.709">     let value;</span>
<a href="#l38.710"></a><span id="l38.710">     try {</span>
<a href="#l38.711"></a><span id="l38.711">       value = this.bundle.GetStringFromName(name);</span>
<a href="#l38.712"></a><span id="l38.712">       if (value.trim() == &quot;&quot;) {</span>
<a href="#l38.713"></a><span id="l38.713">         cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l38.714"></a><span id="l38.714">         return this.defPattern;</span>
<a href="#l38.715"></a><span id="l38.715">       }</span>
<a href="#l38.716"></a><span id="l38.716"> </span>
<a href="#l38.717"></a><span id="l38.717" class="difflineat">@@ -1146,17 +1144,17 @@ Extractor.prototype = {</span>
<a href="#l38.718"></a><span id="l38.718">     } catch (ex) {</span>
<a href="#l38.719"></a><span id="l38.719">       cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l38.720"></a><span id="l38.720"> </span>
<a href="#l38.721"></a><span id="l38.721">       // fake a value to avoid empty regexes creating endless loops</span>
<a href="#l38.722"></a><span id="l38.722">       return this.defPattern;</span>
<a href="#l38.723"></a><span id="l38.723">     }</span>
<a href="#l38.724"></a><span id="l38.724">   },</span>
<a href="#l38.725"></a><span id="l38.725"> </span>
<a href="#l38.726"></a><span id="l38.726" class="difflineminus">-  getRepPatterns: function(name, replaceables) {</span>
<a href="#l38.727"></a><span id="l38.727" class="difflineplus">+  getRepPatterns(name, replaceables) {</span>
<a href="#l38.728"></a><span id="l38.728">     let alts = [];</span>
<a href="#l38.729"></a><span id="l38.729">     let patterns = [];</span>
<a href="#l38.730"></a><span id="l38.730"> </span>
<a href="#l38.731"></a><span id="l38.731">     try {</span>
<a href="#l38.732"></a><span id="l38.732">       let value = this.bundle.GetStringFromName(name);</span>
<a href="#l38.733"></a><span id="l38.733">       if (value.trim() == &quot;&quot;) {</span>
<a href="#l38.734"></a><span id="l38.734">         cal.LOG(&quot;[calExtract] Pattern empty: &quot; + name);</span>
<a href="#l38.735"></a><span id="l38.735">         return alts;</span>
<a href="#l38.736"></a><span id="l38.736" class="difflineat">@@ -1202,25 +1200,25 @@ Extractor.prototype = {</span>
<a href="#l38.737"></a><span id="l38.737"> </span>
<a href="#l38.738"></a><span id="l38.738">       for (let val in vals) {</span>
<a href="#l38.739"></a><span id="l38.739">         let positions = [];</span>
<a href="#l38.740"></a><span id="l38.740">         if (replaceables.length == 1) {</span>
<a href="#l38.741"></a><span id="l38.741">           positions[1] = 1;</span>
<a href="#l38.742"></a><span id="l38.742">         } else {</span>
<a href="#l38.743"></a><span id="l38.743">           positions = this.getPositionsFor(vals[val], name, replaceables.length);</span>
<a href="#l38.744"></a><span id="l38.744">         }</span>
<a href="#l38.745"></a><span id="l38.745" class="difflineminus">-        alts[val] = { pattern: patterns[val], positions: positions };</span>
<a href="#l38.746"></a><span id="l38.746" class="difflineplus">+        alts[val] = { pattern: patterns[val], positions };</span>
<a href="#l38.747"></a><span id="l38.747">       }</span>
<a href="#l38.748"></a><span id="l38.748">     } catch (ex) {</span>
<a href="#l38.749"></a><span id="l38.749">       cal.LOG(&quot;[calExtract] Pattern not found: &quot; + name);</span>
<a href="#l38.750"></a><span id="l38.750">     }</span>
<a href="#l38.751"></a><span id="l38.751">     return alts;</span>
<a href="#l38.752"></a><span id="l38.752">   },</span>
<a href="#l38.753"></a><span id="l38.753"> </span>
<a href="#l38.754"></a><span id="l38.754" class="difflineminus">-  getPositionsFor: function(str, name, count) {</span>
<a href="#l38.755"></a><span id="l38.755" class="difflineplus">+  getPositionsFor(str, name, count) {</span>
<a href="#l38.756"></a><span id="l38.756">     let positions = [];</span>
<a href="#l38.757"></a><span id="l38.757">     let re = /#(\d)/g;</span>
<a href="#l38.758"></a><span id="l38.758">     let match;</span>
<a href="#l38.759"></a><span id="l38.759">     let i = 0;</span>
<a href="#l38.760"></a><span id="l38.760">     while ((match = re.exec(str))) {</span>
<a href="#l38.761"></a><span id="l38.761">       i++;</span>
<a href="#l38.762"></a><span id="l38.762">       positions[parseInt(match[1], 10)] = i;</span>
<a href="#l38.763"></a><span id="l38.763">     }</span>
<a href="#l38.764"></a><span id="l38.764" class="difflineat">@@ -1231,79 +1229,79 @@ Extractor.prototype = {</span>
<a href="#l38.765"></a><span id="l38.765">         Cu.reportError(</span>
<a href="#l38.766"></a><span id="l38.766">           &quot;[calExtract] Faulty extraction pattern &quot; + name + &quot;, missing parameter #&quot; + i</span>
<a href="#l38.767"></a><span id="l38.767">         );</span>
<a href="#l38.768"></a><span id="l38.768">       }</span>
<a href="#l38.769"></a><span id="l38.769">     }</span>
<a href="#l38.770"></a><span id="l38.770">     return positions;</span>
<a href="#l38.771"></a><span id="l38.771">   },</span>
<a href="#l38.772"></a><span id="l38.772"> </span>
<a href="#l38.773"></a><span id="l38.773" class="difflineminus">-  cleanPatterns: function(pattern) {</span>
<a href="#l38.774"></a><span id="l38.774" class="difflineplus">+  cleanPatterns(pattern) {</span>
<a href="#l38.775"></a><span id="l38.775">     // remove whitespace around | if present</span>
<a href="#l38.776"></a><span id="l38.776">     let value = pattern.replace(/\s*\|\s*/g, &quot;|&quot;);</span>
<a href="#l38.777"></a><span id="l38.777">     // allow matching for patterns with missing or excessive whitespace</span>
<a href="#l38.778"></a><span id="l38.778">     return this.sanitize(value).replace(/\s+/g, &quot;\\s*&quot;);</span>
<a href="#l38.779"></a><span id="l38.779">   },</span>
<a href="#l38.780"></a><span id="l38.780"> </span>
<a href="#l38.781"></a><span id="l38.781" class="difflineminus">-  isValidYear: function(year) {</span>
<a href="#l38.782"></a><span id="l38.782" class="difflineplus">+  isValidYear(year) {</span>
<a href="#l38.783"></a><span id="l38.783">     return year &gt;= 2000 &amp;&amp; year &lt;= 2050;</span>
<a href="#l38.784"></a><span id="l38.784">   },</span>
<a href="#l38.785"></a><span id="l38.785"> </span>
<a href="#l38.786"></a><span id="l38.786" class="difflineminus">-  isValidMonth: function(month) {</span>
<a href="#l38.787"></a><span id="l38.787" class="difflineplus">+  isValidMonth(month) {</span>
<a href="#l38.788"></a><span id="l38.788">     return month &gt;= 1 &amp;&amp; month &lt;= 12;</span>
<a href="#l38.789"></a><span id="l38.789">   },</span>
<a href="#l38.790"></a><span id="l38.790"> </span>
<a href="#l38.791"></a><span id="l38.791" class="difflineminus">-  isValidDay: function(day) {</span>
<a href="#l38.792"></a><span id="l38.792" class="difflineplus">+  isValidDay(day) {</span>
<a href="#l38.793"></a><span id="l38.793">     return day &gt;= 1 &amp;&amp; day &lt;= 31;</span>
<a href="#l38.794"></a><span id="l38.794">   },</span>
<a href="#l38.795"></a><span id="l38.795"> </span>
<a href="#l38.796"></a><span id="l38.796" class="difflineminus">-  isValidHour: function(hour) {</span>
<a href="#l38.797"></a><span id="l38.797" class="difflineplus">+  isValidHour(hour) {</span>
<a href="#l38.798"></a><span id="l38.798">     return hour &gt;= 0 &amp;&amp; hour &lt;= 23;</span>
<a href="#l38.799"></a><span id="l38.799">   },</span>
<a href="#l38.800"></a><span id="l38.800"> </span>
<a href="#l38.801"></a><span id="l38.801" class="difflineminus">-  isValidMinute: function(minute) {</span>
<a href="#l38.802"></a><span id="l38.802" class="difflineplus">+  isValidMinute(minute) {</span>
<a href="#l38.803"></a><span id="l38.803">     return minute &gt;= 0 &amp;&amp; minute &lt;= 59;</span>
<a href="#l38.804"></a><span id="l38.804">   },</span>
<a href="#l38.805"></a><span id="l38.805"> </span>
<a href="#l38.806"></a><span id="l38.806" class="difflineminus">-  isPastDate: function(date, referenceDate) {</span>
<a href="#l38.807"></a><span id="l38.807" class="difflineplus">+  isPastDate(date, referenceDate) {</span>
<a href="#l38.808"></a><span id="l38.808">     // avoid changing original refDate</span>
<a href="#l38.809"></a><span id="l38.809">     let refDate = new Date(referenceDate.getTime());</span>
<a href="#l38.810"></a><span id="l38.810">     refDate.setHours(0);</span>
<a href="#l38.811"></a><span id="l38.811">     refDate.setMinutes(0);</span>
<a href="#l38.812"></a><span id="l38.812">     refDate.setSeconds(0);</span>
<a href="#l38.813"></a><span id="l38.813">     refDate.setMilliseconds(0);</span>
<a href="#l38.814"></a><span id="l38.814">     let jsDate;</span>
<a href="#l38.815"></a><span id="l38.815">     if (date.day != null) {</span>
<a href="#l38.816"></a><span id="l38.816">       jsDate = new Date(date.year, date.month - 1, date.day);</span>
<a href="#l38.817"></a><span id="l38.817">     }</span>
<a href="#l38.818"></a><span id="l38.818">     return jsDate &lt; refDate;</span>
<a href="#l38.819"></a><span id="l38.819">   },</span>
<a href="#l38.820"></a><span id="l38.820"> </span>
<a href="#l38.821"></a><span id="l38.821" class="difflineminus">-  normalizeHour: function(hour) {</span>
<a href="#l38.822"></a><span id="l38.822" class="difflineplus">+  normalizeHour(hour) {</span>
<a href="#l38.823"></a><span id="l38.823">     if (hour &lt; this.dayStart &amp;&amp; hour &lt;= 11) {</span>
<a href="#l38.824"></a><span id="l38.824">       return hour + 12;</span>
<a href="#l38.825"></a><span id="l38.825">     }</span>
<a href="#l38.826"></a><span id="l38.826">     return hour;</span>
<a href="#l38.827"></a><span id="l38.827">   },</span>
<a href="#l38.828"></a><span id="l38.828"> </span>
<a href="#l38.829"></a><span id="l38.829" class="difflineminus">-  normalizeYear: function(year) {</span>
<a href="#l38.830"></a><span id="l38.830" class="difflineplus">+  normalizeYear(year) {</span>
<a href="#l38.831"></a><span id="l38.831">     return year.length == 2 ? &quot;20&quot; + year : year;</span>
<a href="#l38.832"></a><span id="l38.832">   },</span>
<a href="#l38.833"></a><span id="l38.833"> </span>
<a href="#l38.834"></a><span id="l38.834" class="difflineminus">-  limitNums: function(res, email) {</span>
<a href="#l38.835"></a><span id="l38.835" class="difflineplus">+  limitNums(res, email) {</span>
<a href="#l38.836"></a><span id="l38.836">     let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l38.837"></a><span id="l38.837">     let before = email.charAt(res.index - 1);</span>
<a href="#l38.838"></a><span id="l38.838">     let after = email.charAt(res.index + res[0].length);</span>
<a href="#l38.839"></a><span id="l38.839">     let result =</span>
<a href="#l38.840"></a><span id="l38.840">       (/\d/.exec(before) &amp;&amp; /\d/.exec(pattern.charAt(0))) ||</span>
<a href="#l38.841"></a><span id="l38.841">       (/\d/.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; /\d/.exec(after));</span>
<a href="#l38.842"></a><span id="l38.842">     return result != null;</span>
<a href="#l38.843"></a><span id="l38.843">   },</span>
<a href="#l38.844"></a><span id="l38.844"> </span>
<a href="#l38.845"></a><span id="l38.845" class="difflineminus">-  limitChars: function(res, email) {</span>
<a href="#l38.846"></a><span id="l38.846" class="difflineplus">+  limitChars(res, email) {</span>
<a href="#l38.847"></a><span id="l38.847">     let alphabet = this.getPatterns(&quot;alphabet&quot;);</span>
<a href="#l38.848"></a><span id="l38.848">     // for languages without regular alphabet surrounding characters are ignored</span>
<a href="#l38.849"></a><span id="l38.849">     if (alphabet == this.defPattern) {</span>
<a href="#l38.850"></a><span id="l38.850">       return false;</span>
<a href="#l38.851"></a><span id="l38.851">     }</span>
<a href="#l38.852"></a><span id="l38.852"> </span>
<a href="#l38.853"></a><span id="l38.853">     let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l38.854"></a><span id="l38.854">     let before = email.charAt(res.index - 1);</span>
<a href="#l38.855"></a><span id="l38.855" class="difflineat">@@ -1311,25 +1309,25 @@ Extractor.prototype = {</span>
<a href="#l38.856"></a><span id="l38.856"> </span>
<a href="#l38.857"></a><span id="l38.857">     let re = new RegExp(&quot;[&quot; + alphabet + &quot;]&quot;);</span>
<a href="#l38.858"></a><span id="l38.858">     let result =</span>
<a href="#l38.859"></a><span id="l38.859">       (re.exec(before) &amp;&amp; re.exec(pattern.charAt(0))) ||</span>
<a href="#l38.860"></a><span id="l38.860">       (re.exec(pattern.charAt(pattern.length - 1)) &amp;&amp; re.exec(after));</span>
<a href="#l38.861"></a><span id="l38.861">     return result != null;</span>
<a href="#l38.862"></a><span id="l38.862">   },</span>
<a href="#l38.863"></a><span id="l38.863"> </span>
<a href="#l38.864"></a><span id="l38.864" class="difflineminus">-  prefixSuffixStartEnd: function(res, relation, email) {</span>
<a href="#l38.865"></a><span id="l38.865" class="difflineplus">+  prefixSuffixStartEnd(res, relation, email) {</span>
<a href="#l38.866"></a><span id="l38.866">     let pattern = email.substring(res.index, res.index + res[0].length);</span>
<a href="#l38.867"></a><span id="l38.867">     let prev = email.substring(0, res.index);</span>
<a href="#l38.868"></a><span id="l38.868">     let next = email.substring(res.index + res[0].length);</span>
<a href="#l38.869"></a><span id="l38.869">     let prefixSuffix = {</span>
<a href="#l38.870"></a><span id="l38.870">       start: res.index,</span>
<a href="#l38.871"></a><span id="l38.871">       end: res.index + res[0].length,</span>
<a href="#l38.872"></a><span id="l38.872" class="difflineminus">-      pattern: pattern,</span>
<a href="#l38.873"></a><span id="l38.873" class="difflineminus">-      relation: relation,</span>
<a href="#l38.874"></a><span id="l38.874" class="difflineplus">+      pattern,</span>
<a href="#l38.875"></a><span id="l38.875" class="difflineplus">+      relation,</span>
<a href="#l38.876"></a><span id="l38.876">     };</span>
<a href="#l38.877"></a><span id="l38.877">     let char = &quot;\\s*&quot;;</span>
<a href="#l38.878"></a><span id="l38.878">     let psres;</span>
<a href="#l38.879"></a><span id="l38.879"> </span>
<a href="#l38.880"></a><span id="l38.880">     let re = new RegExp(&quot;(&quot; + this.getPatterns(&quot;end.prefix&quot;) + &quot;)&quot; + char + &quot;$&quot;, &quot;ig&quot;);</span>
<a href="#l38.881"></a><span id="l38.881">     if ((psres = re.exec(prev)) != null) {</span>
<a href="#l38.882"></a><span id="l38.882">       prefixSuffix.relation = &quot;end&quot;;</span>
<a href="#l38.883"></a><span id="l38.883">       prefixSuffix.start = psres.index;</span>
<a href="#l38.884"></a><span id="l38.884" class="difflineat">@@ -1366,56 +1364,55 @@ Extractor.prototype = {</span>
<a href="#l38.885"></a><span id="l38.885">     re = new RegExp(&quot;^&quot; + char + &quot;(&quot; + this.getPatterns(&quot;no.datetime.suffix&quot;) + &quot;)&quot;, &quot;ig&quot;);</span>
<a href="#l38.886"></a><span id="l38.886">     if ((psres = re.exec(next)) != null) {</span>
<a href="#l38.887"></a><span id="l38.887">       prefixSuffix.relation = &quot;notadatetime&quot;;</span>
<a href="#l38.888"></a><span id="l38.888">     }</span>
<a href="#l38.889"></a><span id="l38.889"> </span>
<a href="#l38.890"></a><span id="l38.890">     return prefixSuffix;</span>
<a href="#l38.891"></a><span id="l38.891">   },</span>
<a href="#l38.892"></a><span id="l38.892"> </span>
<a href="#l38.893"></a><span id="l38.893" class="difflineminus">-  parseNumber: function(numberString, numbers) {</span>
<a href="#l38.894"></a><span id="l38.894" class="difflineplus">+  parseNumber(numberString, numbers) {</span>
<a href="#l38.895"></a><span id="l38.895">     let number = parseInt(numberString, 10);</span>
<a href="#l38.896"></a><span id="l38.896">     // number comes in as plain text, numbers are already adjusted for usage</span>
<a href="#l38.897"></a><span id="l38.897">     // in regular expression</span>
<a href="#l38.898"></a><span id="l38.898">     let cleanNumberString = this.cleanPatterns(numberString);</span>
<a href="#l38.899"></a><span id="l38.899">     if (isNaN(number)) {</span>
<a href="#l38.900"></a><span id="l38.900">       for (let i = 0; i &lt;= 31; i++) {</span>
<a href="#l38.901"></a><span id="l38.901">         let numberparts = numbers[i].split(&quot;|&quot;);</span>
<a href="#l38.902"></a><span id="l38.902">         if (numberparts.includes(cleanNumberString.toLowerCase())) {</span>
<a href="#l38.903"></a><span id="l38.903">           return i;</span>
<a href="#l38.904"></a><span id="l38.904">         }</span>
<a href="#l38.905"></a><span id="l38.905">       }</span>
<a href="#l38.906"></a><span id="l38.906">       return -1;</span>
<a href="#l38.907"></a><span id="l38.907" class="difflineminus">-    } else {</span>
<a href="#l38.908"></a><span id="l38.908" class="difflineminus">-      return number;</span>
<a href="#l38.909"></a><span id="l38.909">     }</span>
<a href="#l38.910"></a><span id="l38.910" class="difflineplus">+    return number;</span>
<a href="#l38.911"></a><span id="l38.911">   },</span>
<a href="#l38.912"></a><span id="l38.912"> </span>
<a href="#l38.913"></a><span id="l38.913" class="difflineminus">-  guess: function(year, month, day, hour, minute, start, end, str, relation, pattern, ambiguous) {</span>
<a href="#l38.914"></a><span id="l38.914" class="difflineplus">+  guess(year, month, day, hour, minute, start, end, str, relation, pattern, ambiguous) {</span>
<a href="#l38.915"></a><span id="l38.915">     let dateGuess = {</span>
<a href="#l38.916"></a><span id="l38.916" class="difflineminus">-      year: year,</span>
<a href="#l38.917"></a><span id="l38.917" class="difflineminus">-      month: month,</span>
<a href="#l38.918"></a><span id="l38.918" class="difflineminus">-      day: day,</span>
<a href="#l38.919"></a><span id="l38.919" class="difflineminus">-      hour: hour,</span>
<a href="#l38.920"></a><span id="l38.920" class="difflineminus">-      minute: minute,</span>
<a href="#l38.921"></a><span id="l38.921" class="difflineminus">-      start: start,</span>
<a href="#l38.922"></a><span id="l38.922" class="difflineminus">-      end: end,</span>
<a href="#l38.923"></a><span id="l38.923" class="difflineminus">-      str: str,</span>
<a href="#l38.924"></a><span id="l38.924" class="difflineminus">-      relation: relation,</span>
<a href="#l38.925"></a><span id="l38.925" class="difflineminus">-      pattern: pattern,</span>
<a href="#l38.926"></a><span id="l38.926" class="difflineminus">-      ambiguous: ambiguous,</span>
<a href="#l38.927"></a><span id="l38.927" class="difflineplus">+      year,</span>
<a href="#l38.928"></a><span id="l38.928" class="difflineplus">+      month,</span>
<a href="#l38.929"></a><span id="l38.929" class="difflineplus">+      day,</span>
<a href="#l38.930"></a><span id="l38.930" class="difflineplus">+      hour,</span>
<a href="#l38.931"></a><span id="l38.931" class="difflineplus">+      minute,</span>
<a href="#l38.932"></a><span id="l38.932" class="difflineplus">+      start,</span>
<a href="#l38.933"></a><span id="l38.933" class="difflineplus">+      end,</span>
<a href="#l38.934"></a><span id="l38.934" class="difflineplus">+      str,</span>
<a href="#l38.935"></a><span id="l38.935" class="difflineplus">+      relation,</span>
<a href="#l38.936"></a><span id="l38.936" class="difflineplus">+      pattern,</span>
<a href="#l38.937"></a><span id="l38.937" class="difflineplus">+      ambiguous,</span>
<a href="#l38.938"></a><span id="l38.938">     };</span>
<a href="#l38.939"></a><span id="l38.939"> </span>
<a href="#l38.940"></a><span id="l38.940">     // past dates are kept for containment checks</span>
<a href="#l38.941"></a><span id="l38.941">     if (this.isPastDate(dateGuess, this.now)) {</span>
<a href="#l38.942"></a><span id="l38.942">       dateGuess.relation = &quot;notadatetime&quot;;</span>
<a href="#l38.943"></a><span id="l38.943">     }</span>
<a href="#l38.944"></a><span id="l38.944">     this.collected.push(dateGuess);</span>
<a href="#l38.945"></a><span id="l38.945">   },</span>
<a href="#l38.946"></a><span id="l38.946"> </span>
<a href="#l38.947"></a><span id="l38.947" class="difflineminus">-  sanitize: function(str) {</span>
<a href="#l38.948"></a><span id="l38.948" class="difflineplus">+  sanitize(str) {</span>
<a href="#l38.949"></a><span id="l38.949">     return str.replace(/[-[\]{}()*+?.,\\^$]/g, &quot;\\$&amp;&quot;);</span>
<a href="#l38.950"></a><span id="l38.950">   },</span>
<a href="#l38.951"></a><span id="l38.951"> </span>
<a href="#l38.952"></a><span id="l38.952" class="difflineminus">-  unescape: function(str) {</span>
<a href="#l38.953"></a><span id="l38.953" class="difflineplus">+  unescape(str) {</span>
<a href="#l38.954"></a><span id="l38.954">     return str.replace(/\\([.])/g, &quot;$1&quot;);</span>
<a href="#l38.955"></a><span id="l38.955">   },</span>
<a href="#l38.956"></a><span id="l38.956"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/calendar/base/modules/calHashedArray.jsm</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -37,137 +37,136 @@ cal.HashedArray.prototype = {</span>
<a href="#l39.4"></a><span id="l39.4">   /**</span>
<a href="#l39.5"></a><span id="l39.5">    * The function to retrieve the hashId given the item. This function can be</span>
<a href="#l39.6"></a><span id="l39.6">    * overridden by implementations, in case the added items are not instances</span>
<a href="#l39.7"></a><span id="l39.7">    * of calIItemBase.</span>
<a href="#l39.8"></a><span id="l39.8">    *</span>
<a href="#l39.9"></a><span id="l39.9">    * @param item      The item to get the hashId for</span>
<a href="#l39.10"></a><span id="l39.10">    * @return          The hashId of the item</span>
<a href="#l39.11"></a><span id="l39.11">    */</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  hashAccessor: function(item) {</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+  hashAccessor(item) {</span>
<a href="#l39.14"></a><span id="l39.14">     return item.hashId;</span>
<a href="#l39.15"></a><span id="l39.15">   },</span>
<a href="#l39.16"></a><span id="l39.16"> </span>
<a href="#l39.17"></a><span id="l39.17">   /**</span>
<a href="#l39.18"></a><span id="l39.18">    * Returns the item, given its index in the array</span>
<a href="#l39.19"></a><span id="l39.19">    *</span>
<a href="#l39.20"></a><span id="l39.20">    * @param index         The index of the item to retrieve.</span>
<a href="#l39.21"></a><span id="l39.21">    * @return              The retrieved item.</span>
<a href="#l39.22"></a><span id="l39.22">    */</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineminus">-  itemByIndex: function(index) {</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+  itemByIndex(index) {</span>
<a href="#l39.25"></a><span id="l39.25">     return this.mArray[index];</span>
<a href="#l39.26"></a><span id="l39.26">   },</span>
<a href="#l39.27"></a><span id="l39.27"> </span>
<a href="#l39.28"></a><span id="l39.28">   /**</span>
<a href="#l39.29"></a><span id="l39.29">    * Returns the item, given its hashId</span>
<a href="#l39.30"></a><span id="l39.30">    *</span>
<a href="#l39.31"></a><span id="l39.31">    * @param id            The hashId of the item to retrieve.</span>
<a href="#l39.32"></a><span id="l39.32">    * @return              The retrieved item.</span>
<a href="#l39.33"></a><span id="l39.33">    */</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineminus">-  itemById: function(id) {</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+  itemById(id) {</span>
<a href="#l39.36"></a><span id="l39.36">     if (this.mBatch &gt; 0) {</span>
<a href="#l39.37"></a><span id="l39.37">       throw new Error(&quot;Accessing Array by ID not supported in batch mode&quot;);</span>
<a href="#l39.38"></a><span id="l39.38">     }</span>
<a href="#l39.39"></a><span id="l39.39">     return id in this.mHash ? this.mArray[this.mHash[id]] : null;</span>
<a href="#l39.40"></a><span id="l39.40">   },</span>
<a href="#l39.41"></a><span id="l39.41"> </span>
<a href="#l39.42"></a><span id="l39.42">   /**</span>
<a href="#l39.43"></a><span id="l39.43">    * Returns the index of the given item. This function is cheap performance</span>
<a href="#l39.44"></a><span id="l39.44">    * wise, since it uses the hash</span>
<a href="#l39.45"></a><span id="l39.45">    *</span>
<a href="#l39.46"></a><span id="l39.46">    * @param item          The item to search for.</span>
<a href="#l39.47"></a><span id="l39.47">    * @return              The index of the item.</span>
<a href="#l39.48"></a><span id="l39.48">    */</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-  indexOf: function(item) {</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineplus">+  indexOf(item) {</span>
<a href="#l39.51"></a><span id="l39.51">     if (this.mBatch &gt; 0) {</span>
<a href="#l39.52"></a><span id="l39.52">       throw new Error(&quot;Accessing Array Indexes not supported in batch mode&quot;);</span>
<a href="#l39.53"></a><span id="l39.53">     }</span>
<a href="#l39.54"></a><span id="l39.54">     let hashId = this.hashAccessor(item);</span>
<a href="#l39.55"></a><span id="l39.55">     return hashId in this.mHash ? this.mHash[hashId] : -1;</span>
<a href="#l39.56"></a><span id="l39.56">   },</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58">   /**</span>
<a href="#l39.59"></a><span id="l39.59">    * Remove the item with the given hashId.</span>
<a href="#l39.60"></a><span id="l39.60">    *</span>
<a href="#l39.61"></a><span id="l39.61">    * @param id            The id of the item to be removed</span>
<a href="#l39.62"></a><span id="l39.62">    */</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineminus">-  removeById: function(id) {</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  removeById(id) {</span>
<a href="#l39.65"></a><span id="l39.65">     if (this.mBatch &gt; 0) {</span>
<a href="#l39.66"></a><span id="l39.66">       throw new Error(&quot;Remvoing by ID in batch mode is not supported&quot;); /* TODO */</span>
<a href="#l39.67"></a><span id="l39.67">     }</span>
<a href="#l39.68"></a><span id="l39.68">     let index = this.mHash[id];</span>
<a href="#l39.69"></a><span id="l39.69">     delete this.mHash[id];</span>
<a href="#l39.70"></a><span id="l39.70">     this.mArray.splice(index, 1);</span>
<a href="#l39.71"></a><span id="l39.71">     this.reindex(index);</span>
<a href="#l39.72"></a><span id="l39.72">   },</span>
<a href="#l39.73"></a><span id="l39.73"> </span>
<a href="#l39.74"></a><span id="l39.74">   /**</span>
<a href="#l39.75"></a><span id="l39.75">    * Remove the item at the given index.</span>
<a href="#l39.76"></a><span id="l39.76">    *</span>
<a href="#l39.77"></a><span id="l39.77">    * @param index         The index of the item to remove.</span>
<a href="#l39.78"></a><span id="l39.78">    */</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-  removeByIndex: function(index) {</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineplus">+  removeByIndex(index) {</span>
<a href="#l39.81"></a><span id="l39.81">     delete this.mHash[this.hashAccessor(this.mArray[index])];</span>
<a href="#l39.82"></a><span id="l39.82">     this.mArray.splice(index, 1);</span>
<a href="#l39.83"></a><span id="l39.83">     this.reindex(index);</span>
<a href="#l39.84"></a><span id="l39.84">   },</span>
<a href="#l39.85"></a><span id="l39.85"> </span>
<a href="#l39.86"></a><span id="l39.86">   /**</span>
<a href="#l39.87"></a><span id="l39.87">    * Clear the whole array, removing all items. This also resets batch mode.</span>
<a href="#l39.88"></a><span id="l39.88">    */</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-  clear: function() {</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineplus">+  clear() {</span>
<a href="#l39.91"></a><span id="l39.91">     this.mHash = {};</span>
<a href="#l39.92"></a><span id="l39.92">     this.mArray = [];</span>
<a href="#l39.93"></a><span id="l39.93">     this.mFirstDirty = -1;</span>
<a href="#l39.94"></a><span id="l39.94">     this.mBatch = 0;</span>
<a href="#l39.95"></a><span id="l39.95">   },</span>
<a href="#l39.96"></a><span id="l39.96"> </span>
<a href="#l39.97"></a><span id="l39.97">   /**</span>
<a href="#l39.98"></a><span id="l39.98">    * Add the item to the array</span>
<a href="#l39.99"></a><span id="l39.99">    *</span>
<a href="#l39.100"></a><span id="l39.100">    * @param item          The item to add.</span>
<a href="#l39.101"></a><span id="l39.101">    * @return              The index of the added item.</span>
<a href="#l39.102"></a><span id="l39.102">    */</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-  addItem: function(item) {</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineplus">+  addItem(item) {</span>
<a href="#l39.105"></a><span id="l39.105">     let index = this.mArray.length;</span>
<a href="#l39.106"></a><span id="l39.106">     this.mArray.push(item);</span>
<a href="#l39.107"></a><span id="l39.107">     this.reindex(index);</span>
<a href="#l39.108"></a><span id="l39.108">     return index;</span>
<a href="#l39.109"></a><span id="l39.109">   },</span>
<a href="#l39.110"></a><span id="l39.110"> </span>
<a href="#l39.111"></a><span id="l39.111">   /**</span>
<a href="#l39.112"></a><span id="l39.112">    * Modifies the item in the array. If the item is already in the array, then</span>
<a href="#l39.113"></a><span id="l39.113">    * it is replaced by the passed item. Otherwise, the item is added to the</span>
<a href="#l39.114"></a><span id="l39.114">    * array.</span>
<a href="#l39.115"></a><span id="l39.115">    *</span>
<a href="#l39.116"></a><span id="l39.116">    * @param item          The item to modify.</span>
<a href="#l39.117"></a><span id="l39.117">    * @return              The (new) index.</span>
<a href="#l39.118"></a><span id="l39.118">    */</span>
<a href="#l39.119"></a><span id="l39.119" class="difflineminus">-  modifyItem: function(item) {</span>
<a href="#l39.120"></a><span id="l39.120" class="difflineplus">+  modifyItem(item) {</span>
<a href="#l39.121"></a><span id="l39.121">     let hashId = this.hashAccessor(item);</span>
<a href="#l39.122"></a><span id="l39.122">     if (hashId in this.mHash) {</span>
<a href="#l39.123"></a><span id="l39.123">       let index = this.mHash[this.hashAccessor(item)];</span>
<a href="#l39.124"></a><span id="l39.124">       this.mArray[index] = item;</span>
<a href="#l39.125"></a><span id="l39.125">       return index;</span>
<a href="#l39.126"></a><span id="l39.126" class="difflineminus">-    } else {</span>
<a href="#l39.127"></a><span id="l39.127" class="difflineminus">-      return this.addItem(item);</span>
<a href="#l39.128"></a><span id="l39.128">     }</span>
<a href="#l39.129"></a><span id="l39.129" class="difflineplus">+    return this.addItem(item);</span>
<a href="#l39.130"></a><span id="l39.130">   },</span>
<a href="#l39.131"></a><span id="l39.131"> </span>
<a href="#l39.132"></a><span id="l39.132">   /**</span>
<a href="#l39.133"></a><span id="l39.133">    * Reindexes the items in the array. This function is mostly used</span>
<a href="#l39.134"></a><span id="l39.134">    * internally. All parameters are inclusive. The ranges are automatically</span>
<a href="#l39.135"></a><span id="l39.135">    * swapped if from &gt; to.</span>
<a href="#l39.136"></a><span id="l39.136">    *</span>
<a href="#l39.137"></a><span id="l39.137">    * @param from      (optional) The index to start indexing from. If left</span>
<a href="#l39.138"></a><span id="l39.138">    *                    out, defaults to 0.</span>
<a href="#l39.139"></a><span id="l39.139">    * @param to        (optional) The index to end indexing on. If left out,</span>
<a href="#l39.140"></a><span id="l39.140">    *                    defaults to the array length.</span>
<a href="#l39.141"></a><span id="l39.141">    */</span>
<a href="#l39.142"></a><span id="l39.142" class="difflineminus">-  reindex: function(from, to) {</span>
<a href="#l39.143"></a><span id="l39.143" class="difflineplus">+  reindex(from, to) {</span>
<a href="#l39.144"></a><span id="l39.144">     if (this.mArray.length == 0) {</span>
<a href="#l39.145"></a><span id="l39.145">       return;</span>
<a href="#l39.146"></a><span id="l39.146">     }</span>
<a href="#l39.147"></a><span id="l39.147"> </span>
<a href="#l39.148"></a><span id="l39.148">     from = from === undefined ? 0 : from;</span>
<a href="#l39.149"></a><span id="l39.149">     to = to === undefined ? this.mArray.length - 1 : to;</span>
<a href="#l39.150"></a><span id="l39.150"> </span>
<a href="#l39.151"></a><span id="l39.151">     from = Math.min(this.mArray.length - 1, Math.max(0, from));</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineat">@@ -185,33 +184,33 @@ cal.HashedArray.prototype = {</span>
<a href="#l39.153"></a><span id="l39.153">       return;</span>
<a href="#l39.154"></a><span id="l39.154">     }</span>
<a href="#l39.155"></a><span id="l39.155"> </span>
<a href="#l39.156"></a><span id="l39.156">     for (let idx = from; idx &lt;= to; idx++) {</span>
<a href="#l39.157"></a><span id="l39.157">       this.mHash[this.hashAccessor(this.mArray[idx])] = idx;</span>
<a href="#l39.158"></a><span id="l39.158">     }</span>
<a href="#l39.159"></a><span id="l39.159">   },</span>
<a href="#l39.160"></a><span id="l39.160"> </span>
<a href="#l39.161"></a><span id="l39.161" class="difflineminus">-  startBatch: function() {</span>
<a href="#l39.162"></a><span id="l39.162" class="difflineplus">+  startBatch() {</span>
<a href="#l39.163"></a><span id="l39.163">     this.mBatch++;</span>
<a href="#l39.164"></a><span id="l39.164">   },</span>
<a href="#l39.165"></a><span id="l39.165"> </span>
<a href="#l39.166"></a><span id="l39.166" class="difflineminus">-  endBatch: function() {</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+  endBatch() {</span>
<a href="#l39.168"></a><span id="l39.168">     this.mBatch = Math.max(0, this.mBatch - 1);</span>
<a href="#l39.169"></a><span id="l39.169"> </span>
<a href="#l39.170"></a><span id="l39.170">     if (this.mBatch == 0 &amp;&amp; this.mFirstDirty &gt; -1) {</span>
<a href="#l39.171"></a><span id="l39.171">       this.reindex(this.mFirstDirty);</span>
<a href="#l39.172"></a><span id="l39.172">       this.mFirstDirty = -1;</span>
<a href="#l39.173"></a><span id="l39.173">     }</span>
<a href="#l39.174"></a><span id="l39.174">   },</span>
<a href="#l39.175"></a><span id="l39.175"> </span>
<a href="#l39.176"></a><span id="l39.176">   /**</span>
<a href="#l39.177"></a><span id="l39.177">    * Iterator to allow iterating the hashed array object.</span>
<a href="#l39.178"></a><span id="l39.178">    */</span>
<a href="#l39.179"></a><span id="l39.179" class="difflineminus">-  [Symbol.iterator]: function*() {</span>
<a href="#l39.180"></a><span id="l39.180" class="difflineplus">+  *[Symbol.iterator]() {</span>
<a href="#l39.181"></a><span id="l39.181">     yield* this.mArray;</span>
<a href="#l39.182"></a><span id="l39.182">   },</span>
<a href="#l39.183"></a><span id="l39.183"> };</span>
<a href="#l39.184"></a><span id="l39.184"> </span>
<a href="#l39.185"></a><span id="l39.185"> /**</span>
<a href="#l39.186"></a><span id="l39.186">  * Sorted hashed array. The array always stays sorted.</span>
<a href="#l39.187"></a><span id="l39.187">  *</span>
<a href="#l39.188"></a><span id="l39.188">  * Performance Considerations:</span>
<a href="#l39.189"></a><span id="l39.189" class="difflineat">@@ -227,35 +226,33 @@ cal.SortedHashedArray = function(compara</span>
<a href="#l39.190"></a><span id="l39.190">   this.mCompFunc = comparator;</span>
<a href="#l39.191"></a><span id="l39.191"> };</span>
<a href="#l39.192"></a><span id="l39.192"> </span>
<a href="#l39.193"></a><span id="l39.193"> cal.SortedHashedArray.prototype = {</span>
<a href="#l39.194"></a><span id="l39.194">   __proto__: cal.HashedArray.prototype,</span>
<a href="#l39.195"></a><span id="l39.195"> </span>
<a href="#l39.196"></a><span id="l39.196">   mCompFunc: null,</span>
<a href="#l39.197"></a><span id="l39.197"> </span>
<a href="#l39.198"></a><span id="l39.198" class="difflineminus">-  addItem: function(item) {</span>
<a href="#l39.199"></a><span id="l39.199" class="difflineplus">+  addItem(item) {</span>
<a href="#l39.200"></a><span id="l39.200">     let newIndex = cal.data.binaryInsert(this.mArray, item, this.mCompFunc, false);</span>
<a href="#l39.201"></a><span id="l39.201">     this.reindex(newIndex);</span>
<a href="#l39.202"></a><span id="l39.202">     return newIndex;</span>
<a href="#l39.203"></a><span id="l39.203">   },</span>
<a href="#l39.204"></a><span id="l39.204"> </span>
<a href="#l39.205"></a><span id="l39.205" class="difflineminus">-  modifyItem: function(item) {</span>
<a href="#l39.206"></a><span id="l39.206" class="difflineplus">+  modifyItem(item) {</span>
<a href="#l39.207"></a><span id="l39.207">     let hashId = this.hashAccessor(item);</span>
<a href="#l39.208"></a><span id="l39.208">     if (hashId in this.mHash) {</span>
<a href="#l39.209"></a><span id="l39.209">       let cmp = this.mCompFunc(item, this.mArray[this.mHash[hashId]]);</span>
<a href="#l39.210"></a><span id="l39.210">       if (cmp == 0) {</span>
<a href="#l39.211"></a><span id="l39.211">         // The item will be at the same index, we just need to replace it</span>
<a href="#l39.212"></a><span id="l39.212">         this.mArray[this.mHash[hashId]] = item;</span>
<a href="#l39.213"></a><span id="l39.213">         return this.mHash[hashId];</span>
<a href="#l39.214"></a><span id="l39.214" class="difflineminus">-      } else {</span>
<a href="#l39.215"></a><span id="l39.215" class="difflineminus">-        let oldIndex = this.mHash[hashId];</span>
<a href="#l39.216"></a><span id="l39.216" class="difflineplus">+      }</span>
<a href="#l39.217"></a><span id="l39.217" class="difflineplus">+      let oldIndex = this.mHash[hashId];</span>
<a href="#l39.218"></a><span id="l39.218"> </span>
<a href="#l39.219"></a><span id="l39.219" class="difflineminus">-        let newIndex = cal.data.binaryInsert(this.mArray, item, this.mCompFunc, false);</span>
<a href="#l39.220"></a><span id="l39.220" class="difflineminus">-        this.mArray.splice(oldIndex, 1);</span>
<a href="#l39.221"></a><span id="l39.221" class="difflineminus">-        this.reindex(oldIndex, newIndex);</span>
<a href="#l39.222"></a><span id="l39.222" class="difflineminus">-        return newIndex;</span>
<a href="#l39.223"></a><span id="l39.223" class="difflineminus">-      }</span>
<a href="#l39.224"></a><span id="l39.224" class="difflineminus">-    } else {</span>
<a href="#l39.225"></a><span id="l39.225" class="difflineminus">-      return this.addItem(item);</span>
<a href="#l39.226"></a><span id="l39.226" class="difflineplus">+      let newIndex = cal.data.binaryInsert(this.mArray, item, this.mCompFunc, false);</span>
<a href="#l39.227"></a><span id="l39.227" class="difflineplus">+      this.mArray.splice(oldIndex, 1);</span>
<a href="#l39.228"></a><span id="l39.228" class="difflineplus">+      this.reindex(oldIndex, newIndex);</span>
<a href="#l39.229"></a><span id="l39.229" class="difflineplus">+      return newIndex;</span>
<a href="#l39.230"></a><span id="l39.230">     }</span>
<a href="#l39.231"></a><span id="l39.231" class="difflineplus">+    return this.addItem(item);</span>
<a href="#l39.232"></a><span id="l39.232">   },</span>
<a href="#l39.233"></a><span id="l39.233"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/calendar/base/modules/calUtils.jsm</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/calendar/base/modules/calUtils.jsm</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -91,28 +91,28 @@ var cal = {</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5">   /**</span>
<a href="#l40.6"></a><span id="l40.6">    * Uses the prompt service to display an error message. Use this sparingly,</span>
<a href="#l40.7"></a><span id="l40.7">    * as it interrupts the user.</span>
<a href="#l40.8"></a><span id="l40.8">    *</span>
<a href="#l40.9"></a><span id="l40.9">    * @param aMsg The message to be shown</span>
<a href="#l40.10"></a><span id="l40.10">    * @param aWindow The window to show the message in, or null for any window.</span>
<a href="#l40.11"></a><span id="l40.11">    */</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-  showError: function(aMsg, aWindow = null) {</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+  showError(aMsg, aWindow = null) {</span>
<a href="#l40.14"></a><span id="l40.14">     Services.prompt.alert(aWindow, cal.l10n.getCalString(&quot;genericErrorTitle&quot;), aMsg);</span>
<a href="#l40.15"></a><span id="l40.15">   },</span>
<a href="#l40.16"></a><span id="l40.16"> </span>
<a href="#l40.17"></a><span id="l40.17">   /**</span>
<a href="#l40.18"></a><span id="l40.18">    * Returns a string describing the current js-stack with filename and line</span>
<a href="#l40.19"></a><span id="l40.19">    * numbers.</span>
<a href="#l40.20"></a><span id="l40.20">    *</span>
<a href="#l40.21"></a><span id="l40.21">    * @param aDepth (optional) The number of frames to include. Defaults to 5.</span>
<a href="#l40.22"></a><span id="l40.22">    * @param aSkip  (optional) Number of frames to skip</span>
<a href="#l40.23"></a><span id="l40.23">    */</span>
<a href="#l40.24"></a><span id="l40.24" class="difflineminus">-  STACK: function(aDepth = 10, aSkip = 0) {</span>
<a href="#l40.25"></a><span id="l40.25" class="difflineplus">+  STACK(aDepth = 10, aSkip = 0) {</span>
<a href="#l40.26"></a><span id="l40.26">     let stack = &quot;&quot;;</span>
<a href="#l40.27"></a><span id="l40.27">     let frame = Components.stack.caller;</span>
<a href="#l40.28"></a><span id="l40.28">     for (let i = 1; i &lt;= aDepth + aSkip &amp;&amp; frame; i++) {</span>
<a href="#l40.29"></a><span id="l40.29">       if (i &gt; aSkip) {</span>
<a href="#l40.30"></a><span id="l40.30">         stack += `${i}: [${frame.filename}:${frame.lineNumber}] ${frame.name}\n`;</span>
<a href="#l40.31"></a><span id="l40.31">       }</span>
<a href="#l40.32"></a><span id="l40.32">       frame = frame.caller;</span>
<a href="#l40.33"></a><span id="l40.33">     }</span>
<a href="#l40.34"></a><span id="l40.34" class="difflineat">@@ -123,17 +123,17 @@ var cal = {</span>
<a href="#l40.35"></a><span id="l40.35">    * Logs a message and the current js-stack, if aCondition fails</span>
<a href="#l40.36"></a><span id="l40.36">    *</span>
<a href="#l40.37"></a><span id="l40.37">    * @param aCondition  the condition to test for</span>
<a href="#l40.38"></a><span id="l40.38">    * @param aMessage    the message to report in the case the assert fails</span>
<a href="#l40.39"></a><span id="l40.39">    * @param aCritical   if true, throw an error to stop current code execution</span>
<a href="#l40.40"></a><span id="l40.40">    *                    if false, code flow will continue</span>
<a href="#l40.41"></a><span id="l40.41">    *                    may be a result code</span>
<a href="#l40.42"></a><span id="l40.42">    */</span>
<a href="#l40.43"></a><span id="l40.43" class="difflineminus">-  ASSERT: function(aCondition, aMessage, aCritical = false) {</span>
<a href="#l40.44"></a><span id="l40.44" class="difflineplus">+  ASSERT(aCondition, aMessage, aCritical = false) {</span>
<a href="#l40.45"></a><span id="l40.45">     if (aCondition) {</span>
<a href="#l40.46"></a><span id="l40.46">       return;</span>
<a href="#l40.47"></a><span id="l40.47">     }</span>
<a href="#l40.48"></a><span id="l40.48"> </span>
<a href="#l40.49"></a><span id="l40.49">     let string = `Assert failed: ${aMessage}\n ${cal.STACK(0, 1)}`;</span>
<a href="#l40.50"></a><span id="l40.50">     if (aCritical) {</span>
<a href="#l40.51"></a><span id="l40.51">       let rescode = aCritical === true ? Cr.NS_ERROR_UNEXPECTED : aCritical;</span>
<a href="#l40.52"></a><span id="l40.52">       throw new Components.Exception(string, rescode);</span>
<a href="#l40.53"></a><span id="l40.53" class="difflineat">@@ -154,94 +154,93 @@ var cal = {</span>
<a href="#l40.54"></a><span id="l40.54">    * The function is cached, once this is called QueryInterface is replaced with</span>
<a href="#l40.55"></a><span id="l40.55">    * cal.generateQI()'s result.</span>
<a href="#l40.56"></a><span id="l40.56">    *</span>
<a href="#l40.57"></a><span id="l40.57">    * @param {Object} aGlobal          The object to define the method on</span>
<a href="#l40.58"></a><span id="l40.58">    * @param {nsIIDRef} aIID           The IID to query for</span>
<a href="#l40.59"></a><span id="l40.59">    * @param {nsIIDRef[]} aInterfaces  The interfaces that this object implements</span>
<a href="#l40.60"></a><span id="l40.60">    * @return {nsQIResult}             The object queried for aIID</span>
<a href="#l40.61"></a><span id="l40.61">    */</span>
<a href="#l40.62"></a><span id="l40.62" class="difflineminus">-  generateClassQI: function(aGlobal, aIID, aInterfaces) {</span>
<a href="#l40.63"></a><span id="l40.63" class="difflineplus">+  generateClassQI(aGlobal, aIID, aInterfaces) {</span>
<a href="#l40.64"></a><span id="l40.64">     const generatedQI =</span>
<a href="#l40.65"></a><span id="l40.65">       aInterfaces.length &gt; 1 ? cal.generateQI(aInterfaces) : ChromeUtils.generateQI(aInterfaces);</span>
<a href="#l40.66"></a><span id="l40.66">     Object.defineProperty(aGlobal, &quot;QueryInterface&quot;, { value: generatedQI });</span>
<a href="#l40.67"></a><span id="l40.67">     return aGlobal.QueryInterface(aIID);</span>
<a href="#l40.68"></a><span id="l40.68">   },</span>
<a href="#l40.69"></a><span id="l40.69"> </span>
<a href="#l40.70"></a><span id="l40.70">   /**</span>
<a href="#l40.71"></a><span id="l40.71">    * Generates the QueryInterface function. This is a replacement for XPCOMUtils.generateQI, which</span>
<a href="#l40.72"></a><span id="l40.72">    * is being replaced. Unfortunately Lightning's code depends on some of its classes providing</span>
<a href="#l40.73"></a><span id="l40.73">    * nsIClassInfo, which causes xpconnect/xpcom to make all methods available, e.g. for an event</span>
<a href="#l40.74"></a><span id="l40.74">    * both calIItemBase and calIEvent.</span>
<a href="#l40.75"></a><span id="l40.75">    *</span>
<a href="#l40.76"></a><span id="l40.76">    * @param {Array&lt;String|nsIIDRef&gt;} aInterfaces      The interfaces to generate QI for.</span>
<a href="#l40.77"></a><span id="l40.77">    * @return {Function}                               The QueryInterface function</span>
<a href="#l40.78"></a><span id="l40.78">    */</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineminus">-  generateQI: function(aInterfaces) {</span>
<a href="#l40.80"></a><span id="l40.80" class="difflineplus">+  generateQI(aInterfaces) {</span>
<a href="#l40.81"></a><span id="l40.81">     if (aInterfaces.length == 1) {</span>
<a href="#l40.82"></a><span id="l40.82">       cal.WARN(</span>
<a href="#l40.83"></a><span id="l40.83">         &quot;When generating QI for one interface, please use ChromeUtils.generateQI&quot;,</span>
<a href="#l40.84"></a><span id="l40.84">         cal.STACK(10)</span>
<a href="#l40.85"></a><span id="l40.85">       );</span>
<a href="#l40.86"></a><span id="l40.86">       return ChromeUtils.generateQI(aInterfaces);</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineminus">-    } else {</span>
<a href="#l40.88"></a><span id="l40.88" class="difflineminus">-      /* Note that Ci[Ci.x] == Ci.x for all x */</span>
<a href="#l40.89"></a><span id="l40.89" class="difflineminus">-      let names = [];</span>
<a href="#l40.90"></a><span id="l40.90" class="difflineminus">-      if (aInterfaces) {</span>
<a href="#l40.91"></a><span id="l40.91" class="difflineminus">-        for (let i = 0; i &lt; aInterfaces.length; i++) {</span>
<a href="#l40.92"></a><span id="l40.92" class="difflineminus">-          let iface = aInterfaces[i];</span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-          let name = (iface &amp;&amp; iface.name) || String(iface);</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-          if (name in Ci) {</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineminus">-            names.push(name);</span>
<a href="#l40.96"></a><span id="l40.96" class="difflineminus">-          }</span>
<a href="#l40.97"></a><span id="l40.97" class="difflineplus">+    }</span>
<a href="#l40.98"></a><span id="l40.98" class="difflineplus">+    /* Note that Ci[Ci.x] == Ci.x for all x */</span>
<a href="#l40.99"></a><span id="l40.99" class="difflineplus">+    let names = [];</span>
<a href="#l40.100"></a><span id="l40.100" class="difflineplus">+    if (aInterfaces) {</span>
<a href="#l40.101"></a><span id="l40.101" class="difflineplus">+      for (let i = 0; i &lt; aInterfaces.length; i++) {</span>
<a href="#l40.102"></a><span id="l40.102" class="difflineplus">+        let iface = aInterfaces[i];</span>
<a href="#l40.103"></a><span id="l40.103" class="difflineplus">+        let name = (iface &amp;&amp; iface.name) || String(iface);</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineplus">+        if (name in Ci) {</span>
<a href="#l40.105"></a><span id="l40.105" class="difflineplus">+          names.push(name);</span>
<a href="#l40.106"></a><span id="l40.106">         }</span>
<a href="#l40.107"></a><span id="l40.107">       }</span>
<a href="#l40.108"></a><span id="l40.108" class="difflineminus">-      return makeQI(names);</span>
<a href="#l40.109"></a><span id="l40.109">     }</span>
<a href="#l40.110"></a><span id="l40.110" class="difflineplus">+    return makeQI(names);</span>
<a href="#l40.111"></a><span id="l40.111">   },</span>
<a href="#l40.112"></a><span id="l40.112"> </span>
<a href="#l40.113"></a><span id="l40.113">   /**</span>
<a href="#l40.114"></a><span id="l40.114">    * Generate a ClassInfo implementation for a component. The returned object</span>
<a href="#l40.115"></a><span id="l40.115">    * must be assigned to the 'classInfo' property of a JS object. The first and</span>
<a href="#l40.116"></a><span id="l40.116">    * only argument should be an object that contains a number of optional</span>
<a href="#l40.117"></a><span id="l40.117">    * properties: &quot;interfaces&quot;, &quot;contractID&quot;, &quot;classDescription&quot;, &quot;classID&quot; and</span>
<a href="#l40.118"></a><span id="l40.118">    * &quot;flags&quot;. The values of the properties will be returned as the values of the</span>
<a href="#l40.119"></a><span id="l40.119">    * various properties of the nsIClassInfo implementation.</span>
<a href="#l40.120"></a><span id="l40.120">    */</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineminus">-  generateCI: function(classInfo) {</span>
<a href="#l40.122"></a><span id="l40.122" class="difflineplus">+  generateCI(classInfo) {</span>
<a href="#l40.123"></a><span id="l40.123">     if (&quot;QueryInterface&quot; in classInfo) {</span>
<a href="#l40.124"></a><span id="l40.124">       throw Error(&quot;In generateCI, don't use a component for generating classInfo&quot;);</span>
<a href="#l40.125"></a><span id="l40.125">     }</span>
<a href="#l40.126"></a><span id="l40.126">     /* Note that Ci[Ci.x] == Ci.x for all x */</span>
<a href="#l40.127"></a><span id="l40.127">     let _interfaces = [];</span>
<a href="#l40.128"></a><span id="l40.128">     for (let i = 0; i &lt; classInfo.interfaces.length; i++) {</span>
<a href="#l40.129"></a><span id="l40.129">       let iface = classInfo.interfaces[i];</span>
<a href="#l40.130"></a><span id="l40.130">       if (Ci[iface]) {</span>
<a href="#l40.131"></a><span id="l40.131">         _interfaces.push(Ci[iface]);</span>
<a href="#l40.132"></a><span id="l40.132">       }</span>
<a href="#l40.133"></a><span id="l40.133">     }</span>
<a href="#l40.134"></a><span id="l40.134">     return {</span>
<a href="#l40.135"></a><span id="l40.135">       get interfaces() {</span>
<a href="#l40.136"></a><span id="l40.136">         return [Ci.nsIClassInfo, Ci.nsISupports].concat(_interfaces);</span>
<a href="#l40.137"></a><span id="l40.137">       },</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineminus">-      getScriptableHelper: function() {</span>
<a href="#l40.139"></a><span id="l40.139" class="difflineplus">+      getScriptableHelper() {</span>
<a href="#l40.140"></a><span id="l40.140">         return null;</span>
<a href="#l40.141"></a><span id="l40.141">       },</span>
<a href="#l40.142"></a><span id="l40.142">       contractID: classInfo.contractID,</span>
<a href="#l40.143"></a><span id="l40.143">       classDescription: classInfo.classDescription,</span>
<a href="#l40.144"></a><span id="l40.144">       classID: classInfo.classID,</span>
<a href="#l40.145"></a><span id="l40.145">       flags: classInfo.flags,</span>
<a href="#l40.146"></a><span id="l40.146">       QueryInterface: ChromeUtils.generateQI([Ci.nsIClassInfo]),</span>
<a href="#l40.147"></a><span id="l40.147">     };</span>
<a href="#l40.148"></a><span id="l40.148">   },</span>
<a href="#l40.149"></a><span id="l40.149"> </span>
<a href="#l40.150"></a><span id="l40.150">   /**</span>
<a href="#l40.151"></a><span id="l40.151">    * Schedules execution of the passed function to the current thread's queue.</span>
<a href="#l40.152"></a><span id="l40.152">    */</span>
<a href="#l40.153"></a><span id="l40.153" class="difflineminus">-  postPone: function(func) {</span>
<a href="#l40.154"></a><span id="l40.154" class="difflineplus">+  postPone(func) {</span>
<a href="#l40.155"></a><span id="l40.155">     if (this.threadingEnabled) {</span>
<a href="#l40.156"></a><span id="l40.156">       Services.tm.currentThread.dispatch({ run: func }, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l40.157"></a><span id="l40.157">     } else {</span>
<a href="#l40.158"></a><span id="l40.158">       func();</span>
<a href="#l40.159"></a><span id="l40.159">     }</span>
<a href="#l40.160"></a><span id="l40.160">   },</span>
<a href="#l40.161"></a><span id="l40.161"> </span>
<a href="#l40.162"></a><span id="l40.162">   /**</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineat">@@ -255,17 +254,17 @@ var cal = {</span>
<a href="#l40.164"></a><span id="l40.164">    *                    clean adapter.</span>
<a href="#l40.165"></a><span id="l40.165">    *</span>
<a href="#l40.166"></a><span id="l40.166">    * Currently supported interfaces are:</span>
<a href="#l40.167"></a><span id="l40.167">    *  - calIObserver</span>
<a href="#l40.168"></a><span id="l40.168">    *  - calICalendarManagerObserver</span>
<a href="#l40.169"></a><span id="l40.169">    *  - calIOperationListener</span>
<a href="#l40.170"></a><span id="l40.170">    *  - calICompositeObserver</span>
<a href="#l40.171"></a><span id="l40.171">    */</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineminus">-  createAdapter: function(iface, template) {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+  createAdapter(iface, template) {</span>
<a href="#l40.174"></a><span id="l40.174">     let methods;</span>
<a href="#l40.175"></a><span id="l40.175">     let adapter = template || {};</span>
<a href="#l40.176"></a><span id="l40.176">     switch (iface.name || iface) {</span>
<a href="#l40.177"></a><span id="l40.177">       case &quot;calIObserver&quot;:</span>
<a href="#l40.178"></a><span id="l40.178">         methods = [</span>
<a href="#l40.179"></a><span id="l40.179">           &quot;onStartBatch&quot;,</span>
<a href="#l40.180"></a><span id="l40.180">           &quot;onEndBatch&quot;,</span>
<a href="#l40.181"></a><span id="l40.181">           &quot;onLoad&quot;,</span>
<a href="#l40.182"></a><span id="l40.182" class="difflineat">@@ -301,37 +300,37 @@ var cal = {</span>
<a href="#l40.183"></a><span id="l40.183">     return adapter;</span>
<a href="#l40.184"></a><span id="l40.184">   },</span>
<a href="#l40.185"></a><span id="l40.185"> </span>
<a href="#l40.186"></a><span id="l40.186">   /**</span>
<a href="#l40.187"></a><span id="l40.187">    * Make a UUID, without enclosing brackets, e.g. 0d3950fd-22e5-4508-91ba-0489bdac513f</span>
<a href="#l40.188"></a><span id="l40.188">    *</span>
<a href="#l40.189"></a><span id="l40.189">    * @return {String}         The generated UUID</span>
<a href="#l40.190"></a><span id="l40.190">    */</span>
<a href="#l40.191"></a><span id="l40.191" class="difflineminus">-  getUUID: function() {</span>
<a href="#l40.192"></a><span id="l40.192" class="difflineplus">+  getUUID() {</span>
<a href="#l40.193"></a><span id="l40.193">     let uuidGen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;].getService(Ci.nsIUUIDGenerator);</span>
<a href="#l40.194"></a><span id="l40.194">     // generate uuids without braces to avoid problems with</span>
<a href="#l40.195"></a><span id="l40.195">     // CalDAV servers that don't support filenames with {}</span>
<a href="#l40.196"></a><span id="l40.196">     return uuidGen</span>
<a href="#l40.197"></a><span id="l40.197">       .generateUUID()</span>
<a href="#l40.198"></a><span id="l40.198">       .toString()</span>
<a href="#l40.199"></a><span id="l40.199">       .replace(/[{}]/g, &quot;&quot;);</span>
<a href="#l40.200"></a><span id="l40.200">   },</span>
<a href="#l40.201"></a><span id="l40.201"> </span>
<a href="#l40.202"></a><span id="l40.202">   /**</span>
<a href="#l40.203"></a><span id="l40.203">    * Adds an observer listening for the topic.</span>
<a href="#l40.204"></a><span id="l40.204">    *</span>
<a href="#l40.205"></a><span id="l40.205">    * @param func function to execute on topic</span>
<a href="#l40.206"></a><span id="l40.206">    * @param topic topic to listen for</span>
<a href="#l40.207"></a><span id="l40.207">    * @param oneTime whether to listen only once</span>
<a href="#l40.208"></a><span id="l40.208">    */</span>
<a href="#l40.209"></a><span id="l40.209" class="difflineminus">-  addObserver: function(func, topic, oneTime) {</span>
<a href="#l40.210"></a><span id="l40.210" class="difflineplus">+  addObserver(func, topic, oneTime) {</span>
<a href="#l40.211"></a><span id="l40.211">     let observer = {</span>
<a href="#l40.212"></a><span id="l40.212">       // nsIObserver:</span>
<a href="#l40.213"></a><span id="l40.213" class="difflineminus">-      observe: function(subject, topic_, data) {</span>
<a href="#l40.214"></a><span id="l40.214" class="difflineplus">+      observe(subject, topic_, data) {</span>
<a href="#l40.215"></a><span id="l40.215">         if (topic == topic_) {</span>
<a href="#l40.216"></a><span id="l40.216">           if (oneTime) {</span>
<a href="#l40.217"></a><span id="l40.217">             Services.obs.removeObserver(this, topic);</span>
<a href="#l40.218"></a><span id="l40.218">           }</span>
<a href="#l40.219"></a><span id="l40.219">           func(subject, topic, data);</span>
<a href="#l40.220"></a><span id="l40.220">         }</span>
<a href="#l40.221"></a><span id="l40.221">       },</span>
<a href="#l40.222"></a><span id="l40.222">     };</span>
<a href="#l40.223"></a><span id="l40.223" class="difflineat">@@ -353,17 +352,17 @@ var cal = {</span>
<a href="#l40.224"></a><span id="l40.224">    * }</span>
<a href="#l40.225"></a><span id="l40.225">    * // GOOD USAGE:</span>
<a href="#l40.226"></a><span id="l40.226">    * foo = cal.wrapInstance(foo, Ci.nsIBar);</span>
<a href="#l40.227"></a><span id="l40.227">    * if (foo) {</span>
<a href="#l40.228"></a><span id="l40.228">    *   foo.barMethod();</span>
<a href="#l40.229"></a><span id="l40.229">    * }</span>
<a href="#l40.230"></a><span id="l40.230">    *</span>
<a href="#l40.231"></a><span id="l40.231">    */</span>
<a href="#l40.232"></a><span id="l40.232" class="difflineminus">-  wrapInstance: function(aObj, aInterface) {</span>
<a href="#l40.233"></a><span id="l40.233" class="difflineplus">+  wrapInstance(aObj, aInterface) {</span>
<a href="#l40.234"></a><span id="l40.234">     if (!aObj) {</span>
<a href="#l40.235"></a><span id="l40.235">       return null;</span>
<a href="#l40.236"></a><span id="l40.236">     }</span>
<a href="#l40.237"></a><span id="l40.237"> </span>
<a href="#l40.238"></a><span id="l40.238">     try {</span>
<a href="#l40.239"></a><span id="l40.239">       return aObj.QueryInterface(aInterface);</span>
<a href="#l40.240"></a><span id="l40.240">     } catch (e) {</span>
<a href="#l40.241"></a><span id="l40.241">       return null;</span>
<a href="#l40.242"></a><span id="l40.242" class="difflineat">@@ -372,26 +371,26 @@ var cal = {</span>
<a href="#l40.243"></a><span id="l40.243"> </span>
<a href="#l40.244"></a><span id="l40.244">   /**</span>
<a href="#l40.245"></a><span id="l40.245">    * Tries to get rid of wrappers, if this is not possible then return the</span>
<a href="#l40.246"></a><span id="l40.246">    * passed object.</span>
<a href="#l40.247"></a><span id="l40.247">    *</span>
<a href="#l40.248"></a><span id="l40.248">    * @param aObj  The object under consideration</span>
<a href="#l40.249"></a><span id="l40.249">    * @return      The possibly unwrapped object.</span>
<a href="#l40.250"></a><span id="l40.250">    */</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineminus">-  unwrapInstance: function(aObj) {</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+  unwrapInstance(aObj) {</span>
<a href="#l40.253"></a><span id="l40.253">     return aObj &amp;&amp; aObj.wrappedJSObject ? aObj.wrappedJSObject : aObj;</span>
<a href="#l40.254"></a><span id="l40.254">   },</span>
<a href="#l40.255"></a><span id="l40.255"> </span>
<a href="#l40.256"></a><span id="l40.256">   /**</span>
<a href="#l40.257"></a><span id="l40.257">    * Adds an xpcom shutdown observer.</span>
<a href="#l40.258"></a><span id="l40.258">    *</span>
<a href="#l40.259"></a><span id="l40.259">    * @param func function to execute</span>
<a href="#l40.260"></a><span id="l40.260">    */</span>
<a href="#l40.261"></a><span id="l40.261" class="difflineminus">-  addShutdownObserver: function(func) {</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineplus">+  addShutdownObserver(func) {</span>
<a href="#l40.263"></a><span id="l40.263">     cal.addObserver(func, &quot;xpcom-shutdown&quot;, true /* one time */);</span>
<a href="#l40.264"></a><span id="l40.264">   },</span>
<a href="#l40.265"></a><span id="l40.265"> </span>
<a href="#l40.266"></a><span id="l40.266">   /**</span>
<a href="#l40.267"></a><span id="l40.267">    * Due to wrapped js objects, some objects may have cyclic references.</span>
<a href="#l40.268"></a><span id="l40.268">    * You can register properties of objects to be cleaned up on xpcom-shutdown.</span>
<a href="#l40.269"></a><span id="l40.269">    *</span>
<a href="#l40.270"></a><span id="l40.270">    * @param obj    object</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/calendar/base/modules/utils/calACLUtils.jsm</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/calendar/base/modules/utils/calACLUtils.jsm</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -17,63 +17,63 @@ var calacl = {</span>
<a href="#l41.4"></a><span id="l41.4">   /**</span>
<a href="#l41.5"></a><span id="l41.5">    * Check if the specified calendar is writable. This is the case when it is</span>
<a href="#l41.6"></a><span id="l41.6">    * not marked readOnly, we are not offline, or we are offline and the</span>
<a href="#l41.7"></a><span id="l41.7">    * calendar is local.</span>
<a href="#l41.8"></a><span id="l41.8">    *</span>
<a href="#l41.9"></a><span id="l41.9">    * @param aCalendar     The calendar to check</span>
<a href="#l41.10"></a><span id="l41.10">    * @return              True if the calendar is writable</span>
<a href="#l41.11"></a><span id="l41.11">    */</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  isCalendarWritable: function(aCalendar) {</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  isCalendarWritable(aCalendar) {</span>
<a href="#l41.14"></a><span id="l41.14">     return (</span>
<a href="#l41.15"></a><span id="l41.15">       !aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l41.16"></a><span id="l41.16">       !aCalendar.readOnly &amp;&amp;</span>
<a href="#l41.17"></a><span id="l41.17">       (!Services.io.offline ||</span>
<a href="#l41.18"></a><span id="l41.18">         aCalendar.getProperty(&quot;cache.enabled&quot;) ||</span>
<a href="#l41.19"></a><span id="l41.19">         aCalendar.getProperty(&quot;cache.always&quot;) ||</span>
<a href="#l41.20"></a><span id="l41.20">         aCalendar.getProperty(&quot;requiresNetwork&quot;) === false)</span>
<a href="#l41.21"></a><span id="l41.21">     );</span>
<a href="#l41.22"></a><span id="l41.22">   },</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24">   /**</span>
<a href="#l41.25"></a><span id="l41.25">    * Check if the specified calendar is writable from an ACL point of view.</span>
<a href="#l41.26"></a><span id="l41.26">    *</span>
<a href="#l41.27"></a><span id="l41.27">    * @param aCalendar     The calendar to check</span>
<a href="#l41.28"></a><span id="l41.28">    * @return              True if the calendar is writable</span>
<a href="#l41.29"></a><span id="l41.29">    */</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineminus">-  userCanAddItemsToCalendar: function(aCalendar) {</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+  userCanAddItemsToCalendar(aCalendar) {</span>
<a href="#l41.32"></a><span id="l41.32">     let aclEntry = aCalendar.aclEntry;</span>
<a href="#l41.33"></a><span id="l41.33">     return (</span>
<a href="#l41.34"></a><span id="l41.34">       !aclEntry || !aclEntry.hasAccessControl || aclEntry.userIsOwner || aclEntry.userCanAddItems</span>
<a href="#l41.35"></a><span id="l41.35">     );</span>
<a href="#l41.36"></a><span id="l41.36">   },</span>
<a href="#l41.37"></a><span id="l41.37"> </span>
<a href="#l41.38"></a><span id="l41.38">   /**</span>
<a href="#l41.39"></a><span id="l41.39">    * Check if the user can delete items from the specified calendar, from an</span>
<a href="#l41.40"></a><span id="l41.40">    * ACL point of view.</span>
<a href="#l41.41"></a><span id="l41.41">    *</span>
<a href="#l41.42"></a><span id="l41.42">    * @param aCalendar     The calendar to check</span>
<a href="#l41.43"></a><span id="l41.43">    * @return              True if the calendar is writable</span>
<a href="#l41.44"></a><span id="l41.44">    */</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineminus">-  userCanDeleteItemsFromCalendar: function(aCalendar) {</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+  userCanDeleteItemsFromCalendar(aCalendar) {</span>
<a href="#l41.47"></a><span id="l41.47">     let aclEntry = aCalendar.aclEntry;</span>
<a href="#l41.48"></a><span id="l41.48">     return (</span>
<a href="#l41.49"></a><span id="l41.49">       !aclEntry || !aclEntry.hasAccessControl || aclEntry.userIsOwner || aclEntry.userCanDeleteItems</span>
<a href="#l41.50"></a><span id="l41.50">     );</span>
<a href="#l41.51"></a><span id="l41.51">   },</span>
<a href="#l41.52"></a><span id="l41.52"> </span>
<a href="#l41.53"></a><span id="l41.53">   /**</span>
<a href="#l41.54"></a><span id="l41.54">    * Check if the user can fully modify the specified item, from an ACL point</span>
<a href="#l41.55"></a><span id="l41.55">    * of view.  Note to be confused with the right to respond to an</span>
<a href="#l41.56"></a><span id="l41.56">    * invitation, which is handled instead by userCanRespondToInvitation.</span>
<a href="#l41.57"></a><span id="l41.57">    *</span>
<a href="#l41.58"></a><span id="l41.58">    * @param aItem         The calendar item to check</span>
<a href="#l41.59"></a><span id="l41.59">    * @return              True if the item is modifiable</span>
<a href="#l41.60"></a><span id="l41.60">    */</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-  userCanModifyItem: function(aItem) {</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+  userCanModifyItem(aItem) {</span>
<a href="#l41.63"></a><span id="l41.63">     let aclEntry = aItem.aclEntry;</span>
<a href="#l41.64"></a><span id="l41.64">     return (</span>
<a href="#l41.65"></a><span id="l41.65">       !aclEntry ||</span>
<a href="#l41.66"></a><span id="l41.66">       !aclEntry.calendarEntry.hasAccessControl ||</span>
<a href="#l41.67"></a><span id="l41.67">       aclEntry.calendarEntry.userIsOwner ||</span>
<a href="#l41.68"></a><span id="l41.68">       aclEntry.userCanModify</span>
<a href="#l41.69"></a><span id="l41.69">     );</span>
<a href="#l41.70"></a><span id="l41.70">   },</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineat">@@ -81,14 +81,14 @@ var calacl = {</span>
<a href="#l41.72"></a><span id="l41.72">   /**</span>
<a href="#l41.73"></a><span id="l41.73">    * Checks if the user can modify the item and has the right to respond to</span>
<a href="#l41.74"></a><span id="l41.74">    * invitations for the item.</span>
<a href="#l41.75"></a><span id="l41.75">    *</span>
<a href="#l41.76"></a><span id="l41.76">    * @param aItem         The calendar item to check</span>
<a href="#l41.77"></a><span id="l41.77">    * @return              True if the invitation w.r.t. the item can be</span>
<a href="#l41.78"></a><span id="l41.78">    *                        responded to.</span>
<a href="#l41.79"></a><span id="l41.79">    */</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-  userCanRespondToInvitation: function(aItem) {</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+  userCanRespondToInvitation(aItem) {</span>
<a href="#l41.82"></a><span id="l41.82">     let aclEntry = aItem.aclEntry;</span>
<a href="#l41.83"></a><span id="l41.83">     // TODO check if || is really wanted here</span>
<a href="#l41.84"></a><span id="l41.84">     return calacl.userCanModifyItem(aItem) || aclEntry.userCanRespond;</span>
<a href="#l41.85"></a><span id="l41.85">   },</span>
<a href="#l41.86"></a><span id="l41.86"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/calendar/base/modules/utils/calAlarmUtils.jsm</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAlarmUtils.jsm</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -18,17 +18,17 @@ this.EXPORTED_SYMBOLS = [&quot;calalarms&quot;]; /</span>
<a href="#l42.4"></a><span id="l42.4"> var calalarms = {</span>
<a href="#l42.5"></a><span id="l42.5">   /**</span>
<a href="#l42.6"></a><span id="l42.6">    * Read default alarm settings from user preferences and apply them to the</span>
<a href="#l42.7"></a><span id="l42.7">    * event/todo passed in. The item's calendar should be set to ensure the</span>
<a href="#l42.8"></a><span id="l42.8">    * correct alarm type is set.</span>
<a href="#l42.9"></a><span id="l42.9">    *</span>
<a href="#l42.10"></a><span id="l42.10">    * @param aItem     The item to apply the default alarm values to.</span>
<a href="#l42.11"></a><span id="l42.11">    */</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  setDefaultValues: function(aItem) {</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+  setDefaultValues(aItem) {</span>
<a href="#l42.14"></a><span id="l42.14">     let type = cal.item.isEvent(aItem) ? &quot;event&quot; : &quot;todo&quot;;</span>
<a href="#l42.15"></a><span id="l42.15">     if (Services.prefs.getIntPref(&quot;calendar.alarms.onfor&quot; + type + &quot;s&quot;, 0) == 1) {</span>
<a href="#l42.16"></a><span id="l42.16">       let alarmOffset = cal.createDuration();</span>
<a href="#l42.17"></a><span id="l42.17">       let alarm = cal.createAlarm();</span>
<a href="#l42.18"></a><span id="l42.18">       let units = Services.prefs.getStringPref(&quot;calendar.alarms.&quot; + type + &quot;alarmunit&quot;, &quot;minutes&quot;);</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20">       // Make sure the alarm pref is valid, default to minutes otherwise</span>
<a href="#l42.21"></a><span id="l42.21">       if (![&quot;weeks&quot;, &quot;days&quot;, &quot;hours&quot;, &quot;minutes&quot;, &quot;seconds&quot;].includes(units)) {</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -57,63 +57,63 @@ var calalarms = {</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24">   /**</span>
<a href="#l42.25"></a><span id="l42.25">    * Calculate the alarm date for a calIAlarm.</span>
<a href="#l42.26"></a><span id="l42.26">    *</span>
<a href="#l42.27"></a><span id="l42.27">    * @param aItem     The item used to calculate the alarm date.</span>
<a href="#l42.28"></a><span id="l42.28">    * @param aAlarm    The alarm to calculate the date for.</span>
<a href="#l42.29"></a><span id="l42.29">    * @return          The alarm date.</span>
<a href="#l42.30"></a><span id="l42.30">    */</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-  calculateAlarmDate: function(aItem, aAlarm) {</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+  calculateAlarmDate(aItem, aAlarm) {</span>
<a href="#l42.33"></a><span id="l42.33">     if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l42.34"></a><span id="l42.34">       return aAlarm.alarmDate;</span>
<a href="#l42.35"></a><span id="l42.35" class="difflineminus">-    } else {</span>
<a href="#l42.36"></a><span id="l42.36" class="difflineminus">-      let returnDate;</span>
<a href="#l42.37"></a><span id="l42.37" class="difflineminus">-      if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l42.38"></a><span id="l42.38" class="difflineminus">-        returnDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l42.39"></a><span id="l42.39" class="difflineminus">-      } else if (aAlarm.related == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l42.40"></a><span id="l42.40" class="difflineminus">-        returnDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l42.41"></a><span id="l42.41" class="difflineplus">+    }</span>
<a href="#l42.42"></a><span id="l42.42" class="difflineplus">+    let returnDate;</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineplus">+    if (aAlarm.related == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+      returnDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l42.45"></a><span id="l42.45" class="difflineplus">+    } else if (aAlarm.related == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+      returnDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+    }</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+</span>
<a href="#l42.49"></a><span id="l42.49" class="difflineplus">+    if (returnDate &amp;&amp; aAlarm.offset) {</span>
<a href="#l42.50"></a><span id="l42.50" class="difflineplus">+      // Handle all day events.  This is kinda weird, because they don't</span>
<a href="#l42.51"></a><span id="l42.51" class="difflineplus">+      // have a well defined startTime.  We just consider the start/end</span>
<a href="#l42.52"></a><span id="l42.52" class="difflineplus">+      // to be midnight in the user's timezone.</span>
<a href="#l42.53"></a><span id="l42.53" class="difflineplus">+      if (returnDate.isDate) {</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineplus">+        let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+        // This returns a copy, so no extra cloning needed.</span>
<a href="#l42.56"></a><span id="l42.56" class="difflineplus">+        returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l42.57"></a><span id="l42.57" class="difflineplus">+        returnDate.isDate = false;</span>
<a href="#l42.58"></a><span id="l42.58" class="difflineplus">+      } else if (returnDate.timezone.tzid == &quot;floating&quot;) {</span>
<a href="#l42.59"></a><span id="l42.59" class="difflineplus">+        let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineplus">+        returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineplus">+      } else {</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineplus">+        // Clone the date to correctly add the duration.</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+        returnDate = returnDate.clone();</span>
<a href="#l42.64"></a><span id="l42.64">       }</span>
<a href="#l42.65"></a><span id="l42.65"> </span>
<a href="#l42.66"></a><span id="l42.66" class="difflineminus">-      if (returnDate &amp;&amp; aAlarm.offset) {</span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-        // Handle all day events.  This is kinda weird, because they don't</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-        // have a well defined startTime.  We just consider the start/end</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineminus">-        // to be midnight in the user's timezone.</span>
<a href="#l42.70"></a><span id="l42.70" class="difflineminus">-        if (returnDate.isDate) {</span>
<a href="#l42.71"></a><span id="l42.71" class="difflineminus">-          let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l42.72"></a><span id="l42.72" class="difflineminus">-          // This returns a copy, so no extra cloning needed.</span>
<a href="#l42.73"></a><span id="l42.73" class="difflineminus">-          returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l42.74"></a><span id="l42.74" class="difflineminus">-          returnDate.isDate = false;</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-        } else if (returnDate.timezone.tzid == &quot;floating&quot;) {</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-          let timezone = cal.dtz.defaultTimezone;</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-          returnDate = returnDate.getInTimezone(timezone);</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineminus">-        } else {</span>
<a href="#l42.79"></a><span id="l42.79" class="difflineminus">-          // Clone the date to correctly add the duration.</span>
<a href="#l42.80"></a><span id="l42.80" class="difflineminus">-          returnDate = returnDate.clone();</span>
<a href="#l42.81"></a><span id="l42.81" class="difflineminus">-        }</span>
<a href="#l42.82"></a><span id="l42.82" class="difflineplus">+      returnDate.addDuration(aAlarm.offset);</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineplus">+      return returnDate;</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+    }</span>
<a href="#l42.85"></a><span id="l42.85"> </span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-        returnDate.addDuration(aAlarm.offset);</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineminus">-        return returnDate;</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineminus">-      }</span>
<a href="#l42.89"></a><span id="l42.89" class="difflineminus">-    }</span>
<a href="#l42.90"></a><span id="l42.90">     return null;</span>
<a href="#l42.91"></a><span id="l42.91">   },</span>
<a href="#l42.92"></a><span id="l42.92"> </span>
<a href="#l42.93"></a><span id="l42.93">   /**</span>
<a href="#l42.94"></a><span id="l42.94">    * Calculate the alarm offset for a calIAlarm. The resulting offset is</span>
<a href="#l42.95"></a><span id="l42.95">    * related to either start or end of the event, depending on the aRelated</span>
<a href="#l42.96"></a><span id="l42.96">    * parameter.</span>
<a href="#l42.97"></a><span id="l42.97">    *</span>
<a href="#l42.98"></a><span id="l42.98">    * @param aItem     The item to calculate the offset for.</span>
<a href="#l42.99"></a><span id="l42.99">    * @param aAlarm    The alarm to calculate the offset for.</span>
<a href="#l42.100"></a><span id="l42.100">    * @param aRelated  (optional) A relation constant from calIAlarm. If not</span>
<a href="#l42.101"></a><span id="l42.101">    *                    passed, ALARM_RELATED_START will be assumed.</span>
<a href="#l42.102"></a><span id="l42.102">    * @return          The alarm offset.</span>
<a href="#l42.103"></a><span id="l42.103">    */</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  calculateAlarmOffset: function(aItem, aAlarm, aRelated) {</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+  calculateAlarmOffset(aItem, aAlarm, aRelated) {</span>
<a href="#l42.106"></a><span id="l42.106">     let offset = aAlarm.offset;</span>
<a href="#l42.107"></a><span id="l42.107">     if (aAlarm.related == aAlarm.ALARM_RELATED_ABSOLUTE) {</span>
<a href="#l42.108"></a><span id="l42.108">       let returnDate;</span>
<a href="#l42.109"></a><span id="l42.109">       if (aRelated === undefined || aRelated == aAlarm.ALARM_RELATED_START) {</span>
<a href="#l42.110"></a><span id="l42.110">         returnDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l42.111"></a><span id="l42.111">       } else if (aRelated == aAlarm.ALARM_RELATED_END) {</span>
<a href="#l42.112"></a><span id="l42.112">         returnDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l42.113"></a><span id="l42.113">       }</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineat">@@ -127,17 +127,17 @@ var calalarms = {</span>
<a href="#l42.115"></a><span id="l42.115"> </span>
<a href="#l42.116"></a><span id="l42.116">   /**</span>
<a href="#l42.117"></a><span id="l42.117">    * Adds reminder images to a given node, making sure only one icon per alarm</span>
<a href="#l42.118"></a><span id="l42.118">    * action is added.</span>
<a href="#l42.119"></a><span id="l42.119">    *</span>
<a href="#l42.120"></a><span id="l42.120">    * @param aElement    The element to add the images to.</span>
<a href="#l42.121"></a><span id="l42.121">    * @param aReminders  The set of reminders to add images for.</span>
<a href="#l42.122"></a><span id="l42.122">    */</span>
<a href="#l42.123"></a><span id="l42.123" class="difflineminus">-  addReminderImages: function(aElement, aReminders) {</span>
<a href="#l42.124"></a><span id="l42.124" class="difflineplus">+  addReminderImages(aElement, aReminders) {</span>
<a href="#l42.125"></a><span id="l42.125">     function setupActionImage(node, reminder) {</span>
<a href="#l42.126"></a><span id="l42.126">       let image = node || aElement.ownerDocument.createXULElement(&quot;image&quot;);</span>
<a href="#l42.127"></a><span id="l42.127">       image.setAttribute(&quot;class&quot;, &quot;reminder-icon&quot;);</span>
<a href="#l42.128"></a><span id="l42.128">       image.setAttribute(&quot;value&quot;, reminder.action);</span>
<a href="#l42.129"></a><span id="l42.129">       return image;</span>
<a href="#l42.130"></a><span id="l42.130">     }</span>
<a href="#l42.131"></a><span id="l42.131"> </span>
<a href="#l42.132"></a><span id="l42.132">     // Fill up the icon box with the alarm icons, show max one icon per</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/calendar/base/modules/utils/calAsyncUtils.jsm</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAsyncUtils.jsm</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -12,24 +12,24 @@ var { PromiseUtils } = ChromeUtils.impor</span>
<a href="#l43.4"></a><span id="l43.4"> // including calUtils.jsm under the cal.async namespace.</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6"> this.EXPORTED_SYMBOLS = [&quot;calasync&quot;]; /* exported calasync */</span>
<a href="#l43.7"></a><span id="l43.7"> </span>
<a href="#l43.8"></a><span id="l43.8"> var cIOL = Ci.calIOperationListener;</span>
<a href="#l43.9"></a><span id="l43.9"> var cIC = Ci.calICalendar;</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> var promisifyProxyHandler = {</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  promiseOperation: function(target, name, args) {</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+  promiseOperation(target, name, args) {</span>
<a href="#l43.14"></a><span id="l43.14">     let deferred = PromiseUtils.defer();</span>
<a href="#l43.15"></a><span id="l43.15">     let listener = calasync.promiseOperationListener(deferred);</span>
<a href="#l43.16"></a><span id="l43.16">     args.push(listener);</span>
<a href="#l43.17"></a><span id="l43.17">     target[name](...args);</span>
<a href="#l43.18"></a><span id="l43.18">     return deferred.promise;</span>
<a href="#l43.19"></a><span id="l43.19">   },</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-  get: function(target, name) {</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+  get(target, name) {</span>
<a href="#l43.22"></a><span id="l43.22">     switch (name) {</span>
<a href="#l43.23"></a><span id="l43.23">       // calICalendar methods</span>
<a href="#l43.24"></a><span id="l43.24">       case &quot;adoptItem&quot;:</span>
<a href="#l43.25"></a><span id="l43.25">       case &quot;addItem&quot;:</span>
<a href="#l43.26"></a><span id="l43.26">       case &quot;modifyItem&quot;:</span>
<a href="#l43.27"></a><span id="l43.27">       case &quot;deleteItem&quot;:</span>
<a href="#l43.28"></a><span id="l43.28">       case &quot;getItem&quot;:</span>
<a href="#l43.29"></a><span id="l43.29">       case &quot;getItems&quot;:</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineat">@@ -77,17 +77,17 @@ var calasync = {</span>
<a href="#l43.31"></a><span id="l43.31">    *</span>
<a href="#l43.32"></a><span id="l43.32">    * Bonus methods in addition:</span>
<a href="#l43.33"></a><span id="l43.33">    *   pcal.getAllItems()  // alias for getItems without any filters</span>
<a href="#l43.34"></a><span id="l43.34">    *</span>
<a href="#l43.35"></a><span id="l43.35">    * IMPORTANT: Don't pass this around thinking its like an xpcom calICalendar,</span>
<a href="#l43.36"></a><span id="l43.36">    * otherwise code might indefinitely wait for the listener to return or there</span>
<a href="#l43.37"></a><span id="l43.37">    * will be complaints that an argument is missing.</span>
<a href="#l43.38"></a><span id="l43.38">    */</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineminus">-  promisifyCalendar: function(aCalendar) {</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineplus">+  promisifyCalendar(aCalendar) {</span>
<a href="#l43.41"></a><span id="l43.41">     return new Proxy(aCalendar, promisifyProxyHandler);</span>
<a href="#l43.42"></a><span id="l43.42">   },</span>
<a href="#l43.43"></a><span id="l43.43">   /**</span>
<a href="#l43.44"></a><span id="l43.44">    * Create an operation listener (calIOperationListener) that resolves when</span>
<a href="#l43.45"></a><span id="l43.45">    * the operation succeeds. Note this listener will collect the items, so it</span>
<a href="#l43.46"></a><span id="l43.46">    * might not be a good idea in a situation where a lot of items will be</span>
<a href="#l43.47"></a><span id="l43.47">    * retrieved.</span>
<a href="#l43.48"></a><span id="l43.48">    *</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineat">@@ -100,31 +100,31 @@ var calasync = {</span>
<a href="#l43.50"></a><span id="l43.50">    *   }</span>
<a href="#l43.51"></a><span id="l43.51">    *</span>
<a href="#l43.52"></a><span id="l43.52">    * See also promisifyCalendar, where the above can be replaced with:</span>
<a href="#l43.53"></a><span id="l43.53">    *   function promiseAddItem(aItem) {</span>
<a href="#l43.54"></a><span id="l43.54">    *     let calendar = cal.async.promisifyCalendar(aItem.calendar);</span>
<a href="#l43.55"></a><span id="l43.55">    *     return calendar.addItem(aItem);</span>
<a href="#l43.56"></a><span id="l43.56">    *   }</span>
<a href="#l43.57"></a><span id="l43.57">    */</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineminus">-  promiseOperationListener: function(deferred) {</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+  promiseOperationListener(deferred) {</span>
<a href="#l43.60"></a><span id="l43.60">     return {</span>
<a href="#l43.61"></a><span id="l43.61">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l43.62"></a><span id="l43.62">       items: [],</span>
<a href="#l43.63"></a><span id="l43.63">       itemStatus: Cr.NS_OK,</span>
<a href="#l43.64"></a><span id="l43.64" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l43.65"></a><span id="l43.65" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l43.66"></a><span id="l43.66">         this.itemStatus = aStatus;</span>
<a href="#l43.67"></a><span id="l43.67">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.68"></a><span id="l43.68">           this.items = this.items.concat(aItems);</span>
<a href="#l43.69"></a><span id="l43.69">         } else {</span>
<a href="#l43.70"></a><span id="l43.70">           this.itemSuccess = aStatus;</span>
<a href="#l43.71"></a><span id="l43.71">         }</span>
<a href="#l43.72"></a><span id="l43.72">       },</span>
<a href="#l43.73"></a><span id="l43.73"> </span>
<a href="#l43.74"></a><span id="l43.74" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l43.75"></a><span id="l43.75" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l43.76"></a><span id="l43.76">         if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l43.77"></a><span id="l43.77">           // This function has failed, reject with the status</span>
<a href="#l43.78"></a><span id="l43.78">           deferred.reject(aStatus);</span>
<a href="#l43.79"></a><span id="l43.79">         } else if (!Components.isSuccessCode(this.itemStatus)) {</span>
<a href="#l43.80"></a><span id="l43.80">           // onGetResult has failed, reject with its status</span>
<a href="#l43.81"></a><span id="l43.81">           deferred.reject(this.itemStatus);</span>
<a href="#l43.82"></a><span id="l43.82">         } else if (aOpType == cIOL.GET) {</span>
<a href="#l43.83"></a><span id="l43.83">           // Success of a GET operation: resolve with array of</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/calendar/base/modules/utils/calAuthUtils.jsm</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/calendar/base/modules/utils/calAuthUtils.jsm</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -95,36 +95,34 @@ class ContainerMap extends Map {</span>
<a href="#l44.4"></a><span id="l44.4">    * @param {String} username        The username for which the userContextId</span>
<a href="#l44.5"></a><span id="l44.5">    *                                 is to be looked up.</span>
<a href="#l44.6"></a><span id="l44.6">    * @return {Number}                The userContextId which is assigned to</span>
<a href="#l44.7"></a><span id="l44.7">    *                                 the provided username.</span>
<a href="#l44.8"></a><span id="l44.8">    */</span>
<a href="#l44.9"></a><span id="l44.9">   getUserContextIdForUsername(username) {</span>
<a href="#l44.10"></a><span id="l44.10">     if (this.has(username)) {</span>
<a href="#l44.11"></a><span id="l44.11">       return this.get(username);</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-    } else {</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-      return this._add(username);</span>
<a href="#l44.14"></a><span id="l44.14">     }</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+    return this._add(username);</span>
<a href="#l44.16"></a><span id="l44.16">   }</span>
<a href="#l44.17"></a><span id="l44.17"> </span>
<a href="#l44.18"></a><span id="l44.18">   /**</span>
<a href="#l44.19"></a><span id="l44.19">    * Look up the username for the given userContextId. Return empty string</span>
<a href="#l44.20"></a><span id="l44.20">    * if not found.</span>
<a href="#l44.21"></a><span id="l44.21">    *</span>
<a href="#l44.22"></a><span id="l44.22">    * @param {Number} userContextId        The userContextId for which the</span>
<a href="#l44.23"></a><span id="l44.23">    *                                      username is to be to looked up.</span>
<a href="#l44.24"></a><span id="l44.24">    * @return {String}                     The username mapped to the given</span>
<a href="#l44.25"></a><span id="l44.25">    *                                      userContextId.</span>
<a href="#l44.26"></a><span id="l44.26">    */</span>
<a href="#l44.27"></a><span id="l44.27">   getUsernameForUserContextId(userContextId) {</span>
<a href="#l44.28"></a><span id="l44.28">     if (this.inverted.hasOwnProperty(userContextId)) {</span>
<a href="#l44.29"></a><span id="l44.29">       return this.inverted[userContextId];</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineminus">-    } else {</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-      return &quot;&quot;;</span>
<a href="#l44.32"></a><span id="l44.32">     }</span>
<a href="#l44.33"></a><span id="l44.33" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l44.34"></a><span id="l44.34">   }</span>
<a href="#l44.35"></a><span id="l44.35"> }</span>
<a href="#l44.36"></a><span id="l44.36"> </span>
<a href="#l44.37"></a><span id="l44.37"> var calauth = {</span>
<a href="#l44.38"></a><span id="l44.38">   /**</span>
<a href="#l44.39"></a><span id="l44.39">    * Calendar Auth prompt implementation. This instance of the auth prompt should</span>
<a href="#l44.40"></a><span id="l44.40">    * be used by providers and other components that handle authentication using</span>
<a href="#l44.41"></a><span id="l44.41">    * nsIAuthPrompt2 and friends.</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineat">@@ -188,22 +186,21 @@ var calauth = {</span>
<a href="#l44.43"></a><span id="l44.43">               &quot;, host=&quot; +</span>
<a href="#l44.44"></a><span id="l44.44">               aPasswordRealm.prePath +</span>
<a href="#l44.45"></a><span id="l44.45">               &quot;, realm=&quot; +</span>
<a href="#l44.46"></a><span id="l44.46">               aPasswordRealm.realm</span>
<a href="#l44.47"></a><span id="l44.47">           );</span>
<a href="#l44.48"></a><span id="l44.48"> </span>
<a href="#l44.49"></a><span id="l44.49">           delete this.mReturnedLogins[keyStr];</span>
<a href="#l44.50"></a><span id="l44.50">           calauth.passwordManagerRemove(username, aPasswordRealm.prePath, aPasswordRealm.realm);</span>
<a href="#l44.51"></a><span id="l44.51" class="difflineminus">-          return { found: false, username: username };</span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-        } else {</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-          this.mReturnedLogins[keyStr] = now;</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+          return { found: false, username };</span>
<a href="#l44.55"></a><span id="l44.55">         }</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+        this.mReturnedLogins[keyStr] = now;</span>
<a href="#l44.57"></a><span id="l44.57">       }</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-      return { found: found, username: username, password: password };</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+      return { found, username, password };</span>
<a href="#l44.60"></a><span id="l44.60">     }</span>
<a href="#l44.61"></a><span id="l44.61"> </span>
<a href="#l44.62"></a><span id="l44.62">     // boolean promptAuth(in nsIChannel aChannel,</span>
<a href="#l44.63"></a><span id="l44.63">     //                    in uint32_t level,</span>
<a href="#l44.64"></a><span id="l44.64">     //                    in nsIAuthInformation authInfo)</span>
<a href="#l44.65"></a><span id="l44.65">     promptAuth(aChannel, aLevel, aAuthInfo) {</span>
<a href="#l44.66"></a><span id="l44.66">       let hostRealm = {};</span>
<a href="#l44.67"></a><span id="l44.67">       hostRealm.prePath = aChannel.URI.prePath;</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineat">@@ -220,80 +217,75 @@ var calauth = {</span>
<a href="#l44.69"></a><span id="l44.69">       let requestedUser = cal.auth.containerMap.getUsernameForUserContextId(</span>
<a href="#l44.70"></a><span id="l44.70">         aChannel.loadInfo.originAttributes.userContextId</span>
<a href="#l44.71"></a><span id="l44.71">       );</span>
<a href="#l44.72"></a><span id="l44.72">       let pwInfo = this.getPasswordInfo(hostRealm, requestedUser);</span>
<a href="#l44.73"></a><span id="l44.73">       aAuthInfo.username = pwInfo.username;</span>
<a href="#l44.74"></a><span id="l44.74">       if (pwInfo &amp;&amp; pwInfo.found) {</span>
<a href="#l44.75"></a><span id="l44.75">         aAuthInfo.password = pwInfo.password;</span>
<a href="#l44.76"></a><span id="l44.76">         return true;</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-      } else {</span>
<a href="#l44.78"></a><span id="l44.78" class="difflineminus">-        let savePasswordLabel = null;</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineminus">-        if (Services.prefs.getBoolPref(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-          savePasswordLabel = cal.l10n.getAnyString(</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineminus">-            &quot;passwordmgr&quot;,</span>
<a href="#l44.82"></a><span id="l44.82" class="difflineminus">-            &quot;passwordmgr&quot;,</span>
<a href="#l44.83"></a><span id="l44.83" class="difflineminus">-            &quot;rememberPassword&quot;</span>
<a href="#l44.84"></a><span id="l44.84" class="difflineminus">-          );</span>
<a href="#l44.85"></a><span id="l44.85" class="difflineminus">-        }</span>
<a href="#l44.86"></a><span id="l44.86" class="difflineminus">-        let savePassword = {};</span>
<a href="#l44.87"></a><span id="l44.87" class="difflineminus">-        let returnValue = Services.prompt.promptAuth(</span>
<a href="#l44.88"></a><span id="l44.88" class="difflineminus">-          null,</span>
<a href="#l44.89"></a><span id="l44.89" class="difflineminus">-          aChannel,</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineminus">-          aLevel,</span>
<a href="#l44.91"></a><span id="l44.91" class="difflineminus">-          aAuthInfo,</span>
<a href="#l44.92"></a><span id="l44.92" class="difflineminus">-          savePasswordLabel,</span>
<a href="#l44.93"></a><span id="l44.93" class="difflineminus">-          savePassword</span>
<a href="#l44.94"></a><span id="l44.94" class="difflineplus">+      }</span>
<a href="#l44.95"></a><span id="l44.95" class="difflineplus">+      let savePasswordLabel = null;</span>
<a href="#l44.96"></a><span id="l44.96" class="difflineplus">+      if (Services.prefs.getBoolPref(&quot;signon.rememberSignons&quot;, true)) {</span>
<a href="#l44.97"></a><span id="l44.97" class="difflineplus">+        savePasswordLabel = cal.l10n.getAnyString(&quot;passwordmgr&quot;, &quot;passwordmgr&quot;, &quot;rememberPassword&quot;);</span>
<a href="#l44.98"></a><span id="l44.98" class="difflineplus">+      }</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineplus">+      let savePassword = {};</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+      let returnValue = Services.prompt.promptAuth(</span>
<a href="#l44.101"></a><span id="l44.101" class="difflineplus">+        null,</span>
<a href="#l44.102"></a><span id="l44.102" class="difflineplus">+        aChannel,</span>
<a href="#l44.103"></a><span id="l44.103" class="difflineplus">+        aLevel,</span>
<a href="#l44.104"></a><span id="l44.104" class="difflineplus">+        aAuthInfo,</span>
<a href="#l44.105"></a><span id="l44.105" class="difflineplus">+        savePasswordLabel,</span>
<a href="#l44.106"></a><span id="l44.106" class="difflineplus">+        savePassword</span>
<a href="#l44.107"></a><span id="l44.107" class="difflineplus">+      );</span>
<a href="#l44.108"></a><span id="l44.108" class="difflineplus">+      if (savePassword.value) {</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineplus">+        calauth.passwordManagerSave(</span>
<a href="#l44.110"></a><span id="l44.110" class="difflineplus">+          aAuthInfo.username,</span>
<a href="#l44.111"></a><span id="l44.111" class="difflineplus">+          aAuthInfo.password,</span>
<a href="#l44.112"></a><span id="l44.112" class="difflineplus">+          hostRealm.prePath,</span>
<a href="#l44.113"></a><span id="l44.113" class="difflineplus">+          aAuthInfo.realm</span>
<a href="#l44.114"></a><span id="l44.114">         );</span>
<a href="#l44.115"></a><span id="l44.115" class="difflineminus">-        if (savePassword.value) {</span>
<a href="#l44.116"></a><span id="l44.116" class="difflineminus">-          calauth.passwordManagerSave(</span>
<a href="#l44.117"></a><span id="l44.117" class="difflineminus">-            aAuthInfo.username,</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineminus">-            aAuthInfo.password,</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineminus">-            hostRealm.prePath,</span>
<a href="#l44.120"></a><span id="l44.120" class="difflineminus">-            aAuthInfo.realm</span>
<a href="#l44.121"></a><span id="l44.121" class="difflineminus">-          );</span>
<a href="#l44.122"></a><span id="l44.122" class="difflineminus">-        }</span>
<a href="#l44.123"></a><span id="l44.123" class="difflineminus">-        return returnValue;</span>
<a href="#l44.124"></a><span id="l44.124">       }</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineplus">+      return returnValue;</span>
<a href="#l44.126"></a><span id="l44.126">     }</span>
<a href="#l44.127"></a><span id="l44.127"> </span>
<a href="#l44.128"></a><span id="l44.128">     // nsICancelable asyncPromptAuth(in nsIChannel aChannel,</span>
<a href="#l44.129"></a><span id="l44.129">     //                               in nsIAuthPromptCallback aCallback,</span>
<a href="#l44.130"></a><span id="l44.130">     //                               in nsISupports aContext,</span>
<a href="#l44.131"></a><span id="l44.131">     //                               in uint32_t level,</span>
<a href="#l44.132"></a><span id="l44.132">     //                               in nsIAuthInformation authInfo);</span>
<a href="#l44.133"></a><span id="l44.133">     asyncPromptAuth(aChannel, aCallback, aContext, aLevel, aAuthInfo) {</span>
<a href="#l44.134"></a><span id="l44.134">       let self = this;</span>
<a href="#l44.135"></a><span id="l44.135">       let promptlistener = {</span>
<a href="#l44.136"></a><span id="l44.136" class="difflineminus">-        onPromptStartAsync: function(callback) {</span>
<a href="#l44.137"></a><span id="l44.137" class="difflineplus">+        onPromptStartAsync(callback) {</span>
<a href="#l44.138"></a><span id="l44.138">           callback.onAuthResult(this.onPromptStart());</span>
<a href="#l44.139"></a><span id="l44.139">         },</span>
<a href="#l44.140"></a><span id="l44.140"> </span>
<a href="#l44.141"></a><span id="l44.141" class="difflineminus">-        onPromptStart: function() {</span>
<a href="#l44.142"></a><span id="l44.142" class="difflineplus">+        onPromptStart() {</span>
<a href="#l44.143"></a><span id="l44.143">           let res = self.promptAuth(aChannel, aLevel, aAuthInfo);</span>
<a href="#l44.144"></a><span id="l44.144">           if (res) {</span>
<a href="#l44.145"></a><span id="l44.145">             gAuthCache.setAuthInfo(hostKey, aAuthInfo);</span>
<a href="#l44.146"></a><span id="l44.146">             this.onPromptAuthAvailable();</span>
<a href="#l44.147"></a><span id="l44.147">             return true;</span>
<a href="#l44.148"></a><span id="l44.148">           }</span>
<a href="#l44.149"></a><span id="l44.149"> </span>
<a href="#l44.150"></a><span id="l44.150">           this.onPromptCanceled();</span>
<a href="#l44.151"></a><span id="l44.151">           return false;</span>
<a href="#l44.152"></a><span id="l44.152">         },</span>
<a href="#l44.153"></a><span id="l44.153"> </span>
<a href="#l44.154"></a><span id="l44.154" class="difflineminus">-        onPromptAuthAvailable: function() {</span>
<a href="#l44.155"></a><span id="l44.155" class="difflineplus">+        onPromptAuthAvailable() {</span>
<a href="#l44.156"></a><span id="l44.156">           let authInfo = gAuthCache.retrieveAuthInfo(hostKey);</span>
<a href="#l44.157"></a><span id="l44.157">           if (authInfo) {</span>
<a href="#l44.158"></a><span id="l44.158">             aAuthInfo.username = authInfo.username;</span>
<a href="#l44.159"></a><span id="l44.159">             aAuthInfo.password = authInfo.password;</span>
<a href="#l44.160"></a><span id="l44.160">           }</span>
<a href="#l44.161"></a><span id="l44.161">           aCallback.onAuthAvailable(aContext, aAuthInfo);</span>
<a href="#l44.162"></a><span id="l44.162">         },</span>
<a href="#l44.163"></a><span id="l44.163"> </span>
<a href="#l44.164"></a><span id="l44.164" class="difflineminus">-        onPromptCanceled: function() {</span>
<a href="#l44.165"></a><span id="l44.165" class="difflineplus">+        onPromptCanceled() {</span>
<a href="#l44.166"></a><span id="l44.166">           gAuthCache.retrieveAuthInfo(hostKey);</span>
<a href="#l44.167"></a><span id="l44.167">           aCallback.onAuthCancelled(aContext, true);</span>
<a href="#l44.168"></a><span id="l44.168">         },</span>
<a href="#l44.169"></a><span id="l44.169">       };</span>
<a href="#l44.170"></a><span id="l44.170"> </span>
<a href="#l44.171"></a><span id="l44.171">       let requestedUser = cal.auth.containerMap.getUsernameForUserContextId(</span>
<a href="#l44.172"></a><span id="l44.172">         aChannel.loadInfo.originAttributes.userContextId</span>
<a href="#l44.173"></a><span id="l44.173">       );</span>
<a href="#l44.174"></a><span id="l44.174" class="difflineat">@@ -325,24 +317,17 @@ var calauth = {</span>
<a href="#l44.175"></a><span id="l44.175">    * @param {String} aTitle                   The dialog title.</span>
<a href="#l44.176"></a><span id="l44.176">    * @param {String} aCalendarName            The calendar name or url to look up. Can be null.</span>
<a href="#l44.177"></a><span id="l44.177">    * @param {{value:String}} aUsername        The username that belongs to the calendar.</span>
<a href="#l44.178"></a><span id="l44.178">    * @param {{value:String}} aPassword        The password that belongs to the calendar.</span>
<a href="#l44.179"></a><span id="l44.179">    * @param {{value:String}} aSavePassword    Should the password be saved?</span>
<a href="#l44.180"></a><span id="l44.180">    * @param {Boolean} aFixedUsername          Whether the user name is fixed or editable</span>
<a href="#l44.181"></a><span id="l44.181">    * @return {Boolean}                        Could a password be retrieved?</span>
<a href="#l44.182"></a><span id="l44.182">    */</span>
<a href="#l44.183"></a><span id="l44.183" class="difflineminus">-  getCredentials: function(</span>
<a href="#l44.184"></a><span id="l44.184" class="difflineminus">-    aTitle,</span>
<a href="#l44.185"></a><span id="l44.185" class="difflineminus">-    aCalendarName,</span>
<a href="#l44.186"></a><span id="l44.186" class="difflineminus">-    aUsername,</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineminus">-    aPassword,</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineminus">-    aSavePassword,</span>
<a href="#l44.189"></a><span id="l44.189" class="difflineminus">-    aFixedUsername</span>
<a href="#l44.190"></a><span id="l44.190" class="difflineminus">-  ) {</span>
<a href="#l44.191"></a><span id="l44.191" class="difflineplus">+  getCredentials(aTitle, aCalendarName, aUsername, aPassword, aSavePassword, aFixedUsername) {</span>
<a href="#l44.192"></a><span id="l44.192">     if (</span>
<a href="#l44.193"></a><span id="l44.193">       typeof aUsername != &quot;object&quot; ||</span>
<a href="#l44.194"></a><span id="l44.194">       typeof aPassword != &quot;object&quot; ||</span>
<a href="#l44.195"></a><span id="l44.195">       typeof aSavePassword != &quot;object&quot;</span>
<a href="#l44.196"></a><span id="l44.196">     ) {</span>
<a href="#l44.197"></a><span id="l44.197">       throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l44.198"></a><span id="l44.198">     }</span>
<a href="#l44.199"></a><span id="l44.199"> </span>
<a href="#l44.200"></a><span id="l44.200" class="difflineat">@@ -356,40 +341,39 @@ var calauth = {</span>
<a href="#l44.201"></a><span id="l44.201"> </span>
<a href="#l44.202"></a><span id="l44.202">     let aText;</span>
<a href="#l44.203"></a><span id="l44.203">     if (aFixedUsername) {</span>
<a href="#l44.204"></a><span id="l44.204">       aText = cal.l10n.getAnyString(&quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterPasswordFor&quot;, [</span>
<a href="#l44.205"></a><span id="l44.205">         aUsername.value,</span>
<a href="#l44.206"></a><span id="l44.206">         aCalendarName,</span>
<a href="#l44.207"></a><span id="l44.207">       ]);</span>
<a href="#l44.208"></a><span id="l44.208">       return prompter.promptPassword(aTitle, aText, aPassword, savepassword, aSavePassword);</span>
<a href="#l44.209"></a><span id="l44.209" class="difflineminus">-    } else {</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineminus">-      aText = cal.l10n.getAnyString(&quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterUserPasswordFor2&quot;, [</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineminus">-        aCalendarName,</span>
<a href="#l44.212"></a><span id="l44.212" class="difflineminus">-      ]);</span>
<a href="#l44.213"></a><span id="l44.213" class="difflineminus">-      return prompter.promptUsernameAndPassword(</span>
<a href="#l44.214"></a><span id="l44.214" class="difflineminus">-        aTitle,</span>
<a href="#l44.215"></a><span id="l44.215" class="difflineminus">-        aText,</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineminus">-        aUsername,</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineminus">-        aPassword,</span>
<a href="#l44.218"></a><span id="l44.218" class="difflineminus">-        savepassword,</span>
<a href="#l44.219"></a><span id="l44.219" class="difflineminus">-        aSavePassword</span>
<a href="#l44.220"></a><span id="l44.220" class="difflineminus">-      );</span>
<a href="#l44.221"></a><span id="l44.221">     }</span>
<a href="#l44.222"></a><span id="l44.222" class="difflineplus">+    aText = cal.l10n.getAnyString(&quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterUserPasswordFor2&quot;, [</span>
<a href="#l44.223"></a><span id="l44.223" class="difflineplus">+      aCalendarName,</span>
<a href="#l44.224"></a><span id="l44.224" class="difflineplus">+    ]);</span>
<a href="#l44.225"></a><span id="l44.225" class="difflineplus">+    return prompter.promptUsernameAndPassword(</span>
<a href="#l44.226"></a><span id="l44.226" class="difflineplus">+      aTitle,</span>
<a href="#l44.227"></a><span id="l44.227" class="difflineplus">+      aText,</span>
<a href="#l44.228"></a><span id="l44.228" class="difflineplus">+      aUsername,</span>
<a href="#l44.229"></a><span id="l44.229" class="difflineplus">+      aPassword,</span>
<a href="#l44.230"></a><span id="l44.230" class="difflineplus">+      savepassword,</span>
<a href="#l44.231"></a><span id="l44.231" class="difflineplus">+      aSavePassword</span>
<a href="#l44.232"></a><span id="l44.232" class="difflineplus">+    );</span>
<a href="#l44.233"></a><span id="l44.233">   },</span>
<a href="#l44.234"></a><span id="l44.234"> </span>
<a href="#l44.235"></a><span id="l44.235">   /**</span>
<a href="#l44.236"></a><span id="l44.236">    * Make sure the passed origin is actually an uri string, because password manager functions</span>
<a href="#l44.237"></a><span id="l44.237">    * require it. This is a fallback for compatibility only and should be removed a few versions</span>
<a href="#l44.238"></a><span id="l44.238">    * after Lightning 6.2</span>
<a href="#l44.239"></a><span id="l44.239">    *</span>
<a href="#l44.240"></a><span id="l44.240">    * @param {String} aOrigin      The hostname or origin to check</span>
<a href="#l44.241"></a><span id="l44.241">    * @return {String}             The origin uri</span>
<a href="#l44.242"></a><span id="l44.242">    */</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineminus">-  _ensureOrigin: function(aOrigin) {</span>
<a href="#l44.244"></a><span id="l44.244" class="difflineplus">+  _ensureOrigin(aOrigin) {</span>
<a href="#l44.245"></a><span id="l44.245">     try {</span>
<a href="#l44.246"></a><span id="l44.246">       let { prePath, spec } = Services.io.newURI(aOrigin);</span>
<a href="#l44.247"></a><span id="l44.247">       if (prePath == &quot;oauth:&quot;) {</span>
<a href="#l44.248"></a><span id="l44.248">         return spec;</span>
<a href="#l44.249"></a><span id="l44.249">       }</span>
<a href="#l44.250"></a><span id="l44.250">       return prePath;</span>
<a href="#l44.251"></a><span id="l44.251">     } catch (e) {</span>
<a href="#l44.252"></a><span id="l44.252">       return &quot;https://&quot; + aOrigin;</span>
<a href="#l44.253"></a><span id="l44.253" class="difflineat">@@ -399,17 +383,17 @@ var calauth = {</span>
<a href="#l44.254"></a><span id="l44.254">   /**</span>
<a href="#l44.255"></a><span id="l44.255">    * Helper to insert/update an entry to the password manager.</span>
<a href="#l44.256"></a><span id="l44.256">    *</span>
<a href="#l44.257"></a><span id="l44.257">    * @param {String} aUsername    The username to insert</span>
<a href="#l44.258"></a><span id="l44.258">    * @param {String} aPassword    The corresponding password</span>
<a href="#l44.259"></a><span id="l44.259">    * @param {String} aOrigin      The corresponding origin</span>
<a href="#l44.260"></a><span id="l44.260">    * @param {String} aRealm       The password realm (unused on branch)</span>
<a href="#l44.261"></a><span id="l44.261">    */</span>
<a href="#l44.262"></a><span id="l44.262" class="difflineminus">-  passwordManagerSave: function(aUsername, aPassword, aOrigin, aRealm) {</span>
<a href="#l44.263"></a><span id="l44.263" class="difflineplus">+  passwordManagerSave(aUsername, aPassword, aOrigin, aRealm) {</span>
<a href="#l44.264"></a><span id="l44.264">     cal.ASSERT(aUsername);</span>
<a href="#l44.265"></a><span id="l44.265">     cal.ASSERT(aPassword);</span>
<a href="#l44.266"></a><span id="l44.266"> </span>
<a href="#l44.267"></a><span id="l44.267">     let origin = this._ensureOrigin(aOrigin);</span>
<a href="#l44.268"></a><span id="l44.268"> </span>
<a href="#l44.269"></a><span id="l44.269">     if (!Services.logins.getLoginSavingEnabled(origin)) {</span>
<a href="#l44.270"></a><span id="l44.270">       throw new Components.Exception(</span>
<a href="#l44.271"></a><span id="l44.271">         &quot;Password saving is disabled for &quot; + origin,</span>
<a href="#l44.272"></a><span id="l44.272" class="difflineat">@@ -442,17 +426,17 @@ var calauth = {</span>
<a href="#l44.273"></a><span id="l44.273">    * Helper to retrieve an entry from the password manager.</span>
<a href="#l44.274"></a><span id="l44.274">    *</span>
<a href="#l44.275"></a><span id="l44.275">    * @param {String} aUsername    The username to search</span>
<a href="#l44.276"></a><span id="l44.276">    * @param {String} aPassword    The corresponding password</span>
<a href="#l44.277"></a><span id="l44.277">    * @param {String} aOrigin      The corresponding origin</span>
<a href="#l44.278"></a><span id="l44.278">    * @param {String} aRealm       The password realm (unused on branch)</span>
<a href="#l44.279"></a><span id="l44.279">    * @return {Boolean}            True, if an entry exists in the password manager</span>
<a href="#l44.280"></a><span id="l44.280">    */</span>
<a href="#l44.281"></a><span id="l44.281" class="difflineminus">-  passwordManagerGet: function(aUsername, aPassword, aOrigin, aRealm) {</span>
<a href="#l44.282"></a><span id="l44.282" class="difflineplus">+  passwordManagerGet(aUsername, aPassword, aOrigin, aRealm) {</span>
<a href="#l44.283"></a><span id="l44.283">     cal.ASSERT(aUsername);</span>
<a href="#l44.284"></a><span id="l44.284"> </span>
<a href="#l44.285"></a><span id="l44.285">     if (typeof aPassword != &quot;object&quot;) {</span>
<a href="#l44.286"></a><span id="l44.286">       throw new Components.Exception(&quot;&quot;, Cr.NS_ERROR_XPC_NEED_OUT_OBJECT);</span>
<a href="#l44.287"></a><span id="l44.287">     }</span>
<a href="#l44.288"></a><span id="l44.288"> </span>
<a href="#l44.289"></a><span id="l44.289">     let origin = this._ensureOrigin(aOrigin);</span>
<a href="#l44.290"></a><span id="l44.290"> </span>
<a href="#l44.291"></a><span id="l44.291" class="difflineat">@@ -473,17 +457,17 @@ var calauth = {</span>
<a href="#l44.292"></a><span id="l44.292">   /**</span>
<a href="#l44.293"></a><span id="l44.293">    * Helper to remove an entry from the password manager</span>
<a href="#l44.294"></a><span id="l44.294">    *</span>
<a href="#l44.295"></a><span id="l44.295">    * @param {String} aUsername    The username to remove</span>
<a href="#l44.296"></a><span id="l44.296">    * @param {String} aOrigin      The corresponding origin</span>
<a href="#l44.297"></a><span id="l44.297">    * @param {String} aRealm       The password realm (unused on branch)</span>
<a href="#l44.298"></a><span id="l44.298">    * @return {Boolean}            Could the user be removed?</span>
<a href="#l44.299"></a><span id="l44.299">    */</span>
<a href="#l44.300"></a><span id="l44.300" class="difflineminus">-  passwordManagerRemove: function(aUsername, aOrigin, aRealm) {</span>
<a href="#l44.301"></a><span id="l44.301" class="difflineplus">+  passwordManagerRemove(aUsername, aOrigin, aRealm) {</span>
<a href="#l44.302"></a><span id="l44.302">     cal.ASSERT(aUsername);</span>
<a href="#l44.303"></a><span id="l44.303"> </span>
<a href="#l44.304"></a><span id="l44.304">     let origin = this._ensureOrigin(aOrigin);</span>
<a href="#l44.305"></a><span id="l44.305"> </span>
<a href="#l44.306"></a><span id="l44.306">     try {</span>
<a href="#l44.307"></a><span id="l44.307">       let logins = Services.logins.findLogins(origin, null, aRealm);</span>
<a href="#l44.308"></a><span id="l44.308">       for (let loginInfo of logins) {</span>
<a href="#l44.309"></a><span id="l44.309">         if (loginInfo.username == aUsername) {</span>
<a href="#l44.310"></a><span id="l44.310" class="difflineat">@@ -510,34 +494,34 @@ var calauth = {</span>
<a href="#l44.311"></a><span id="l44.311"> };</span>
<a href="#l44.312"></a><span id="l44.312"> </span>
<a href="#l44.313"></a><span id="l44.313"> // Cache for authentication information since onAuthInformation in the prompt</span>
<a href="#l44.314"></a><span id="l44.314"> // listener is called without further information. If the password is not</span>
<a href="#l44.315"></a><span id="l44.315"> // saved, there is no way to retrieve it. We use ref counting to avoid keeping</span>
<a href="#l44.316"></a><span id="l44.316"> // the password in memory longer than needed.</span>
<a href="#l44.317"></a><span id="l44.317"> var gAuthCache = {</span>
<a href="#l44.318"></a><span id="l44.318">   _authInfoCache: new Map(),</span>
<a href="#l44.319"></a><span id="l44.319" class="difflineminus">-  planForAuthInfo: function(hostKey) {</span>
<a href="#l44.320"></a><span id="l44.320" class="difflineplus">+  planForAuthInfo(hostKey) {</span>
<a href="#l44.321"></a><span id="l44.321">     let authInfo = this._authInfoCache.get(hostKey);</span>
<a href="#l44.322"></a><span id="l44.322">     if (authInfo) {</span>
<a href="#l44.323"></a><span id="l44.323">       authInfo.refCnt++;</span>
<a href="#l44.324"></a><span id="l44.324">     } else {</span>
<a href="#l44.325"></a><span id="l44.325">       this._authInfoCache.set(hostKey, { refCnt: 1 });</span>
<a href="#l44.326"></a><span id="l44.326">     }</span>
<a href="#l44.327"></a><span id="l44.327">   },</span>
<a href="#l44.328"></a><span id="l44.328"> </span>
<a href="#l44.329"></a><span id="l44.329" class="difflineminus">-  setAuthInfo: function(hostKey, aAuthInfo) {</span>
<a href="#l44.330"></a><span id="l44.330" class="difflineplus">+  setAuthInfo(hostKey, aAuthInfo) {</span>
<a href="#l44.331"></a><span id="l44.331">     let authInfo = this._authInfoCache.get(hostKey);</span>
<a href="#l44.332"></a><span id="l44.332">     if (authInfo) {</span>
<a href="#l44.333"></a><span id="l44.333">       authInfo.username = aAuthInfo.username;</span>
<a href="#l44.334"></a><span id="l44.334">       authInfo.password = aAuthInfo.password;</span>
<a href="#l44.335"></a><span id="l44.335">     }</span>
<a href="#l44.336"></a><span id="l44.336">   },</span>
<a href="#l44.337"></a><span id="l44.337"> </span>
<a href="#l44.338"></a><span id="l44.338" class="difflineminus">-  retrieveAuthInfo: function(hostKey) {</span>
<a href="#l44.339"></a><span id="l44.339" class="difflineplus">+  retrieveAuthInfo(hostKey) {</span>
<a href="#l44.340"></a><span id="l44.340">     let authInfo = this._authInfoCache.get(hostKey);</span>
<a href="#l44.341"></a><span id="l44.341">     if (authInfo) {</span>
<a href="#l44.342"></a><span id="l44.342">       authInfo.refCnt--;</span>
<a href="#l44.343"></a><span id="l44.343"> </span>
<a href="#l44.344"></a><span id="l44.344">       if (authInfo.refCnt == 0) {</span>
<a href="#l44.345"></a><span id="l44.345">         this._authInfoCache.delete(hostKey);</span>
<a href="#l44.346"></a><span id="l44.346">       }</span>
<a href="#l44.347"></a><span id="l44.347">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/calendar/base/modules/utils/calCategoryUtils.jsm</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/calendar/base/modules/utils/calCategoryUtils.jsm</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -16,17 +16,17 @@ ChromeUtils.defineModuleGetter(this, &quot;ca</span>
<a href="#l45.4"></a><span id="l45.4"> this.EXPORTED_SYMBOLS = [&quot;calcategory&quot;]; /* exported calcategory */</span>
<a href="#l45.5"></a><span id="l45.5"> </span>
<a href="#l45.6"></a><span id="l45.6"> var calcategory = {</span>
<a href="#l45.7"></a><span id="l45.7">   /**</span>
<a href="#l45.8"></a><span id="l45.8">    * Sets up the default categories from the localized string</span>
<a href="#l45.9"></a><span id="l45.9">    *</span>
<a href="#l45.10"></a><span id="l45.10">    * @return      The default set of categories as a comma separated string.</span>
<a href="#l45.11"></a><span id="l45.11">    */</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-  setupDefaultCategories: function() {</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+  setupDefaultCategories() {</span>
<a href="#l45.14"></a><span id="l45.14">     let defaultBranch = Services.prefs.getDefaultBranch(&quot;&quot;);</span>
<a href="#l45.15"></a><span id="l45.15"> </span>
<a href="#l45.16"></a><span id="l45.16">     // First, set up the category names</span>
<a href="#l45.17"></a><span id="l45.17">     let categories = cal.l10n.getString(&quot;categories&quot;, &quot;categories2&quot;);</span>
<a href="#l45.18"></a><span id="l45.18">     defaultBranch.setStringPref(&quot;calendar.categories.names&quot;, categories);</span>
<a href="#l45.19"></a><span id="l45.19"> </span>
<a href="#l45.20"></a><span id="l45.20">     // Now, initialize the category default colors</span>
<a href="#l45.21"></a><span id="l45.21">     let categoryArray = calcategory.stringToArray(categories);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -43,17 +43,17 @@ var calcategory = {</span>
<a href="#l45.23"></a><span id="l45.23">   },</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25">   /**</span>
<a href="#l45.26"></a><span id="l45.26">    * Get array of category names from preferences or locale default,</span>
<a href="#l45.27"></a><span id="l45.27">    * unescaping any commas in each category name.</span>
<a href="#l45.28"></a><span id="l45.28">    *</span>
<a href="#l45.29"></a><span id="l45.29">    * @return                      array of category names</span>
<a href="#l45.30"></a><span id="l45.30">    */</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-  fromPrefs: function() {</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+  fromPrefs() {</span>
<a href="#l45.33"></a><span id="l45.33">     let categories = Services.prefs.getStringPref(&quot;calendar.categories.names&quot;, null);</span>
<a href="#l45.34"></a><span id="l45.34"> </span>
<a href="#l45.35"></a><span id="l45.35">     // If no categories are configured load a default set from properties file</span>
<a href="#l45.36"></a><span id="l45.36">     if (!categories) {</span>
<a href="#l45.37"></a><span id="l45.37">       categories = calcategory.setupDefaultCategories();</span>
<a href="#l45.38"></a><span id="l45.38">     }</span>
<a href="#l45.39"></a><span id="l45.39">     return calcategory.stringToArray(categories);</span>
<a href="#l45.40"></a><span id="l45.40">   },</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineat">@@ -64,17 +64,17 @@ var calcategory = {</span>
<a href="#l45.42"></a><span id="l45.42">    * Stored categories may include escaped commas within a name. Split</span>
<a href="#l45.43"></a><span id="l45.43">    * categories string at commas, but not at escaped commas (\,). Afterward,</span>
<a href="#l45.44"></a><span id="l45.44">    * replace escaped commas (\,) with commas (,) in each name.</span>
<a href="#l45.45"></a><span id="l45.45">    *</span>
<a href="#l45.46"></a><span id="l45.46">    * @param aCategoriesPrefValue  string from &quot;calendar.categories.names&quot; pref,</span>
<a href="#l45.47"></a><span id="l45.47">    *                                which may contain escaped commas (\,) in names.</span>
<a href="#l45.48"></a><span id="l45.48">    * @return                      list of category names</span>
<a href="#l45.49"></a><span id="l45.49">    */</span>
<a href="#l45.50"></a><span id="l45.50" class="difflineminus">-  stringToArray: function(aCategories) {</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineplus">+  stringToArray(aCategories) {</span>
<a href="#l45.52"></a><span id="l45.52">     if (!aCategories) {</span>
<a href="#l45.53"></a><span id="l45.53">       return [];</span>
<a href="#l45.54"></a><span id="l45.54">     }</span>
<a href="#l45.55"></a><span id="l45.55">     /* eslint-disable no-control-regex */</span>
<a href="#l45.56"></a><span id="l45.56">     // \u001A is the unicode &quot;SUBSTITUTE&quot; character</span>
<a href="#l45.57"></a><span id="l45.57">     let categories = aCategories</span>
<a href="#l45.58"></a><span id="l45.58">       .replace(/\\,/g, &quot;\u001A&quot;)</span>
<a href="#l45.59"></a><span id="l45.59">       .split(&quot;,&quot;)</span>
<a href="#l45.60"></a><span id="l45.60" class="difflineat">@@ -93,12 +93,12 @@ var calcategory = {</span>
<a href="#l45.61"></a><span id="l45.61">    *</span>
<a href="#l45.62"></a><span id="l45.62">    * Category names may contain commas (,). Escape commas (\,) in each, then</span>
<a href="#l45.63"></a><span id="l45.63">    * join them in comma separated string for storage.</span>
<a href="#l45.64"></a><span id="l45.64">    *</span>
<a href="#l45.65"></a><span id="l45.65">    * @param aSortedCategoriesArray    sorted array of category names, may</span>
<a href="#l45.66"></a><span id="l45.66">    *                                    contain unescaped commas, which will</span>
<a href="#l45.67"></a><span id="l45.67">    *                                    be escaped in combined string.</span>
<a href="#l45.68"></a><span id="l45.68">    */</span>
<a href="#l45.69"></a><span id="l45.69" class="difflineminus">-  arrayToString: function(aSortedCategoriesArray) {</span>
<a href="#l45.70"></a><span id="l45.70" class="difflineplus">+  arrayToString(aSortedCategoriesArray) {</span>
<a href="#l45.71"></a><span id="l45.71">     return aSortedCategoriesArray.map(cat =&gt; cat.replace(/,/g, &quot;\\,&quot;)).join(&quot;,&quot;);</span>
<a href="#l45.72"></a><span id="l45.72">   },</span>
<a href="#l45.73"></a><span id="l45.73"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/calendar/base/modules/utils/calDataUtils.jsm</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -157,51 +157,50 @@ class OperationGroup {</span>
<a href="#l46.4"></a><span id="l46.4">   }</span>
<a href="#l46.5"></a><span id="l46.5"> </span>
<a href="#l46.6"></a><span id="l46.6">   toString() {</span>
<a href="#l46.7"></a><span id="l46.7">     return `[OperationGroup id=${this.id}]`;</span>
<a href="#l46.8"></a><span id="l46.8">   }</span>
<a href="#l46.9"></a><span id="l46.9"> }</span>
<a href="#l46.10"></a><span id="l46.10"> </span>
<a href="#l46.11"></a><span id="l46.11"> var caldata = {</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  ListenerSet: ListenerSet,</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-  ObserverSet: ObserverSet,</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-  OperationGroup: OperationGroup,</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+  ListenerSet,</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+  ObserverSet,</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+  OperationGroup,</span>
<a href="#l46.18"></a><span id="l46.18"> </span>
<a href="#l46.19"></a><span id="l46.19">   /**</span>
<a href="#l46.20"></a><span id="l46.20">    * Use the binary search algorithm to search for an item in an array.</span>
<a href="#l46.21"></a><span id="l46.21">    * function.</span>
<a href="#l46.22"></a><span id="l46.22">    *</span>
<a href="#l46.23"></a><span id="l46.23">    * The comptor function may look as follows for calIDateTime objects.</span>
<a href="#l46.24"></a><span id="l46.24">    *     function comptor(a, b) {</span>
<a href="#l46.25"></a><span id="l46.25">    *         return a.compare(b);</span>
<a href="#l46.26"></a><span id="l46.26">    *     }</span>
<a href="#l46.27"></a><span id="l46.27">    * If no comptor is specified, the default greater-than comptor will be used.</span>
<a href="#l46.28"></a><span id="l46.28">    *</span>
<a href="#l46.29"></a><span id="l46.29">    * @param itemArray             The array to search.</span>
<a href="#l46.30"></a><span id="l46.30">    * @param newItem               The item to search in the array.</span>
<a href="#l46.31"></a><span id="l46.31">    * @param comptor               A comparison function that can compare two items.</span>
<a href="#l46.32"></a><span id="l46.32">    * @return                      The index of the new item.</span>
<a href="#l46.33"></a><span id="l46.33">    */</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineminus">-  binarySearch: function(itemArray, newItem, comptor) {</span>
<a href="#l46.35"></a><span id="l46.35" class="difflineplus">+  binarySearch(itemArray, newItem, comptor) {</span>
<a href="#l46.36"></a><span id="l46.36">     function binarySearchInternal(low, high) {</span>
<a href="#l46.37"></a><span id="l46.37">       // Are we done yet?</span>
<a href="#l46.38"></a><span id="l46.38">       if (low == high) {</span>
<a href="#l46.39"></a><span id="l46.39">         return low + (comptor(newItem, itemArray[low]) &lt; 0 ? 0 : 1);</span>
<a href="#l46.40"></a><span id="l46.40">       }</span>
<a href="#l46.41"></a><span id="l46.41"> </span>
<a href="#l46.42"></a><span id="l46.42">       let mid = Math.floor(low + (high - low) / 2);</span>
<a href="#l46.43"></a><span id="l46.43">       let cmp = comptor(newItem, itemArray[mid]);</span>
<a href="#l46.44"></a><span id="l46.44">       if (cmp &gt; 0) {</span>
<a href="#l46.45"></a><span id="l46.45">         return binarySearchInternal(mid + 1, high);</span>
<a href="#l46.46"></a><span id="l46.46">       } else if (cmp &lt; 0) {</span>
<a href="#l46.47"></a><span id="l46.47">         return binarySearchInternal(low, mid);</span>
<a href="#l46.48"></a><span id="l46.48" class="difflineminus">-      } else {</span>
<a href="#l46.49"></a><span id="l46.49" class="difflineminus">-        return mid;</span>
<a href="#l46.50"></a><span id="l46.50">       }</span>
<a href="#l46.51"></a><span id="l46.51" class="difflineplus">+      return mid;</span>
<a href="#l46.52"></a><span id="l46.52">     }</span>
<a href="#l46.53"></a><span id="l46.53"> </span>
<a href="#l46.54"></a><span id="l46.54">     if (itemArray.length &lt; 1) {</span>
<a href="#l46.55"></a><span id="l46.55">       return -1;</span>
<a href="#l46.56"></a><span id="l46.56">     }</span>
<a href="#l46.57"></a><span id="l46.57">     if (!comptor) {</span>
<a href="#l46.58"></a><span id="l46.58">       comptor = function(a, b) {</span>
<a href="#l46.59"></a><span id="l46.59">         return (a &gt; b) - (a &lt; b);</span>
<a href="#l46.60"></a><span id="l46.60" class="difflineat">@@ -219,24 +218,17 @@ var caldata = {</span>
<a href="#l46.61"></a><span id="l46.61">    * @param aItem                The calendar item to add a widget for.</span>
<a href="#l46.62"></a><span id="l46.62">    * @param comptor              A comparison function that can compare two items (not DOM Nodes!)</span>
<a href="#l46.63"></a><span id="l46.63">    * @param discardDuplicates    Use the comptor function to check if the item in</span>
<a href="#l46.64"></a><span id="l46.64">    *                               question is already in the array. If so, the</span>
<a href="#l46.65"></a><span id="l46.65">    *                               new item is not inserted.</span>
<a href="#l46.66"></a><span id="l46.66">    * @param itemAccessor         [optional] A function that receives a DOM node and returns the associated item</span>
<a href="#l46.67"></a><span id="l46.67">    *                               If null, this function will be used: function(n) n.item</span>
<a href="#l46.68"></a><span id="l46.68">    */</span>
<a href="#l46.69"></a><span id="l46.69" class="difflineminus">-  binaryInsertNode: function(</span>
<a href="#l46.70"></a><span id="l46.70" class="difflineminus">-    parentNode,</span>
<a href="#l46.71"></a><span id="l46.71" class="difflineminus">-    insertNode,</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-    aItem,</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineminus">-    comptor,</span>
<a href="#l46.74"></a><span id="l46.74" class="difflineminus">-    discardDuplicates,</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineminus">-    itemAccessor</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineminus">-  ) {</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+  binaryInsertNode(parentNode, insertNode, aItem, comptor, discardDuplicates, itemAccessor) {</span>
<a href="#l46.78"></a><span id="l46.78">     let accessor = itemAccessor || caldata.binaryInsertNodeDefaultAccessor;</span>
<a href="#l46.79"></a><span id="l46.79"> </span>
<a href="#l46.80"></a><span id="l46.80">     // Get the index of the node before which the inserNode will be inserted</span>
<a href="#l46.81"></a><span id="l46.81">     let newIndex = caldata.binarySearch(Array.from(parentNode.children, accessor), aItem, comptor);</span>
<a href="#l46.82"></a><span id="l46.82"> </span>
<a href="#l46.83"></a><span id="l46.83">     if (newIndex &lt; 0) {</span>
<a href="#l46.84"></a><span id="l46.84">       parentNode.appendChild(insertNode);</span>
<a href="#l46.85"></a><span id="l46.85">       newIndex = 0;</span>
<a href="#l46.86"></a><span id="l46.86" class="difflineat">@@ -263,17 +255,17 @@ var caldata = {</span>
<a href="#l46.87"></a><span id="l46.87">    * @param itemArray             The array to insert into.</span>
<a href="#l46.88"></a><span id="l46.88">    * @param item                  The item to insert into the array.</span>
<a href="#l46.89"></a><span id="l46.89">    * @param comptor               A comparison function that can compare two items.</span>
<a href="#l46.90"></a><span id="l46.90">    * @param discardDuplicates     Use the comptor function to check if the item in</span>
<a href="#l46.91"></a><span id="l46.91">    *                                question is already in the array. If so, the</span>
<a href="#l46.92"></a><span id="l46.92">    *                                new item is not inserted.</span>
<a href="#l46.93"></a><span id="l46.93">    * @return                      The index of the new item.</span>
<a href="#l46.94"></a><span id="l46.94">    */</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineminus">-  binaryInsert: function(itemArray, item, comptor, discardDuplicates) {</span>
<a href="#l46.96"></a><span id="l46.96" class="difflineplus">+  binaryInsert(itemArray, item, comptor, discardDuplicates) {</span>
<a href="#l46.97"></a><span id="l46.97">     let newIndex = caldata.binarySearch(itemArray, item, comptor);</span>
<a href="#l46.98"></a><span id="l46.98"> </span>
<a href="#l46.99"></a><span id="l46.99">     if (newIndex &lt; 0) {</span>
<a href="#l46.100"></a><span id="l46.100">       itemArray.push(item);</span>
<a href="#l46.101"></a><span id="l46.101">       newIndex = 0;</span>
<a href="#l46.102"></a><span id="l46.102">     } else if (</span>
<a href="#l46.103"></a><span id="l46.103">       !discardDuplicates ||</span>
<a href="#l46.104"></a><span id="l46.104">       comptor(itemArray[Math.min(newIndex, itemArray.length - 1)], item) != 0</span>
<a href="#l46.105"></a><span id="l46.105" class="difflineat">@@ -289,17 +281,17 @@ var caldata = {</span>
<a href="#l46.106"></a><span id="l46.106">    * Generic object comparer</span>
<a href="#l46.107"></a><span id="l46.107">    * Use to compare two objects which are not of type calIItemBase, in order</span>
<a href="#l46.108"></a><span id="l46.108">    * to avoid the js-wrapping issues mentioned above.</span>
<a href="#l46.109"></a><span id="l46.109">    *</span>
<a href="#l46.110"></a><span id="l46.110">    * @param aObject        first object to be compared</span>
<a href="#l46.111"></a><span id="l46.111">    * @param aOtherObject   second object to be compared</span>
<a href="#l46.112"></a><span id="l46.112">    * @param aIID           IID to use in comparison, undefined/null defaults to nsISupports</span>
<a href="#l46.113"></a><span id="l46.113">    */</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineminus">-  compareObjects: function(aObject, aOtherObject, aIID) {</span>
<a href="#l46.115"></a><span id="l46.115" class="difflineplus">+  compareObjects(aObject, aOtherObject, aIID) {</span>
<a href="#l46.116"></a><span id="l46.116">     // xxx todo: seems to work fine, but I still mistrust this trickery...</span>
<a href="#l46.117"></a><span id="l46.117">     //           Anybody knows an official API that could be used for this purpose?</span>
<a href="#l46.118"></a><span id="l46.118">     //           For what reason do clients need to pass aIID since</span>
<a href="#l46.119"></a><span id="l46.119">     //           every XPCOM object has to implement nsISupports?</span>
<a href="#l46.120"></a><span id="l46.120">     //           XPCOM (like COM, like UNO, ...) defines that QueryInterface *only* needs to return</span>
<a href="#l46.121"></a><span id="l46.121">     //           the very same pointer for nsISupports during its lifetime.</span>
<a href="#l46.122"></a><span id="l46.122">     if (!aIID) {</span>
<a href="#l46.123"></a><span id="l46.123">       aIID = Ci.nsISupports;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/calendar/base/modules/utils/calDateTimeUtils.jsm</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/calendar/base/modules/utils/calDateTimeUtils.jsm</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -37,45 +37,45 @@ var caldtz = {</span>
<a href="#l47.4"></a><span id="l47.4">     return cal.getTimezoneService().floating;</span>
<a href="#l47.5"></a><span id="l47.5">   },</span>
<a href="#l47.6"></a><span id="l47.6"> </span>
<a href="#l47.7"></a><span id="l47.7">   /**</span>
<a href="#l47.8"></a><span id="l47.8">    * Makes sure the given timezone id is part of the list of recent timezones.</span>
<a href="#l47.9"></a><span id="l47.9">    *</span>
<a href="#l47.10"></a><span id="l47.10">    * @param aTzid     The timezone id to add</span>
<a href="#l47.11"></a><span id="l47.11">    */</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-  saveRecentTimezone: function(aTzid) {</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+  saveRecentTimezone(aTzid) {</span>
<a href="#l47.14"></a><span id="l47.14">     let recentTimezones = caldtz.getRecentTimezones();</span>
<a href="#l47.15"></a><span id="l47.15">     const MAX_RECENT_TIMEZONES = 5; // We don't need a pref for *everything*.</span>
<a href="#l47.16"></a><span id="l47.16"> </span>
<a href="#l47.17"></a><span id="l47.17">     if (aTzid != caldtz.defaultTimezone.tzid &amp;&amp; !recentTimezones.includes(aTzid)) {</span>
<a href="#l47.18"></a><span id="l47.18">       // Add the timezone if its not already the default timezone</span>
<a href="#l47.19"></a><span id="l47.19">       recentTimezones.unshift(aTzid);</span>
<a href="#l47.20"></a><span id="l47.20">       recentTimezones.splice(MAX_RECENT_TIMEZONES);</span>
<a href="#l47.21"></a><span id="l47.21">       Services.prefs.setStringPref(&quot;calendar.timezone.recent&quot;, JSON.stringify(recentTimezones));</span>
<a href="#l47.22"></a><span id="l47.22">     }</span>
<a href="#l47.23"></a><span id="l47.23">   },</span>
<a href="#l47.24"></a><span id="l47.24"> </span>
<a href="#l47.25"></a><span id="l47.25">   /**</span>
<a href="#l47.26"></a><span id="l47.26">    * Returns a calIDateTime that corresponds to the current time in the user's</span>
<a href="#l47.27"></a><span id="l47.27">    * default timezone.</span>
<a href="#l47.28"></a><span id="l47.28">    */</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-  now: function() {</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineplus">+  now() {</span>
<a href="#l47.31"></a><span id="l47.31">     let date = caldtz.jsDateToDateTime(new Date());</span>
<a href="#l47.32"></a><span id="l47.32">     return date.getInTimezone(caldtz.defaultTimezone);</span>
<a href="#l47.33"></a><span id="l47.33">   },</span>
<a href="#l47.34"></a><span id="l47.34"> </span>
<a href="#l47.35"></a><span id="l47.35">   /**</span>
<a href="#l47.36"></a><span id="l47.36">    * Get the default event start date. This is the next full hour, or 23:00 if it</span>
<a href="#l47.37"></a><span id="l47.37">    * is past 23:00.</span>
<a href="#l47.38"></a><span id="l47.38">    *</span>
<a href="#l47.39"></a><span id="l47.39">    * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l47.40"></a><span id="l47.40">    *                            keeping the date and timezone intact.</span>
<a href="#l47.41"></a><span id="l47.41">    */</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-  getDefaultStartDate: function(aReferenceDate) {</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineplus">+  getDefaultStartDate(aReferenceDate) {</span>
<a href="#l47.44"></a><span id="l47.44">     let startDate = caldtz.now();</span>
<a href="#l47.45"></a><span id="l47.45">     if (aReferenceDate) {</span>
<a href="#l47.46"></a><span id="l47.46">       let savedHour = startDate.hour;</span>
<a href="#l47.47"></a><span id="l47.47">       startDate = aReferenceDate;</span>
<a href="#l47.48"></a><span id="l47.48">       if (!startDate.isMutable) {</span>
<a href="#l47.49"></a><span id="l47.49">         startDate = startDate.clone();</span>
<a href="#l47.50"></a><span id="l47.50">       }</span>
<a href="#l47.51"></a><span id="l47.51">       startDate.isDate = false;</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineat">@@ -93,75 +93,75 @@ var caldtz = {</span>
<a href="#l47.53"></a><span id="l47.53">   /**</span>
<a href="#l47.54"></a><span id="l47.54">    * Setup the default start and end hours of the given item. This can be a task</span>
<a href="#l47.55"></a><span id="l47.55">    * or an event.</span>
<a href="#l47.56"></a><span id="l47.56">    *</span>
<a href="#l47.57"></a><span id="l47.57">    * @param aItem             The item to set up the start and end date for.</span>
<a href="#l47.58"></a><span id="l47.58">    * @param aReferenceDate    If passed, the time of this date will be modified,</span>
<a href="#l47.59"></a><span id="l47.59">    *                            keeping the date and timezone intact.</span>
<a href="#l47.60"></a><span id="l47.60">    */</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-  setDefaultStartEndHour: function(aItem, aReferenceDate) {</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineplus">+  setDefaultStartEndHour(aItem, aReferenceDate) {</span>
<a href="#l47.63"></a><span id="l47.63">     aItem[caldtz.startDateProp(aItem)] = caldtz.getDefaultStartDate(aReferenceDate);</span>
<a href="#l47.64"></a><span id="l47.64"> </span>
<a href="#l47.65"></a><span id="l47.65">     if (cal.item.isEvent(aItem)) {</span>
<a href="#l47.66"></a><span id="l47.66">       aItem.endDate = aItem.startDate.clone();</span>
<a href="#l47.67"></a><span id="l47.67">       aItem.endDate.minute += Services.prefs.getIntPref(&quot;calendar.event.defaultlength&quot;, 60);</span>
<a href="#l47.68"></a><span id="l47.68">     }</span>
<a href="#l47.69"></a><span id="l47.69">   },</span>
<a href="#l47.70"></a><span id="l47.70"> </span>
<a href="#l47.71"></a><span id="l47.71">   /**</span>
<a href="#l47.72"></a><span id="l47.72">    * Returns the property name used for the start date of an item, ie either an</span>
<a href="#l47.73"></a><span id="l47.73">    * event's start date or a task's entry date.</span>
<a href="#l47.74"></a><span id="l47.74">    */</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-  startDateProp: function(aItem) {</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+  startDateProp(aItem) {</span>
<a href="#l47.77"></a><span id="l47.77">     if (cal.item.isEvent(aItem)) {</span>
<a href="#l47.78"></a><span id="l47.78">       return &quot;startDate&quot;;</span>
<a href="#l47.79"></a><span id="l47.79">     } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l47.80"></a><span id="l47.80">       return &quot;entryDate&quot;;</span>
<a href="#l47.81"></a><span id="l47.81">     }</span>
<a href="#l47.82"></a><span id="l47.82">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l47.83"></a><span id="l47.83">   },</span>
<a href="#l47.84"></a><span id="l47.84"> </span>
<a href="#l47.85"></a><span id="l47.85">   /**</span>
<a href="#l47.86"></a><span id="l47.86">    * Returns the property name used for the end date of an item, ie either an</span>
<a href="#l47.87"></a><span id="l47.87">    * event's end date or a task's due date.</span>
<a href="#l47.88"></a><span id="l47.88">    */</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineminus">-  endDateProp: function(aItem) {</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineplus">+  endDateProp(aItem) {</span>
<a href="#l47.91"></a><span id="l47.91">     if (cal.item.isEvent(aItem)) {</span>
<a href="#l47.92"></a><span id="l47.92">       return &quot;endDate&quot;;</span>
<a href="#l47.93"></a><span id="l47.93">     } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l47.94"></a><span id="l47.94">       return &quot;dueDate&quot;;</span>
<a href="#l47.95"></a><span id="l47.95">     }</span>
<a href="#l47.96"></a><span id="l47.96">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l47.97"></a><span id="l47.97">   },</span>
<a href="#l47.98"></a><span id="l47.98"> </span>
<a href="#l47.99"></a><span id="l47.99">   /**</span>
<a href="#l47.100"></a><span id="l47.100">    * Check if the two dates are on the same day (ignoring time)</span>
<a href="#l47.101"></a><span id="l47.101">    *</span>
<a href="#l47.102"></a><span id="l47.102">    * @param date1     The left date to compare</span>
<a href="#l47.103"></a><span id="l47.103">    * @param date2     The right date to compare</span>
<a href="#l47.104"></a><span id="l47.104">    * @return          True, if dates are on the same day</span>
<a href="#l47.105"></a><span id="l47.105">    */</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineminus">-  sameDay: function(date1, date2) {</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineplus">+  sameDay(date1, date2) {</span>
<a href="#l47.108"></a><span id="l47.108">     if (date1 &amp;&amp; date2) {</span>
<a href="#l47.109"></a><span id="l47.109">       if (date1.day == date2.day &amp;&amp; date1.month == date2.month &amp;&amp; date1.year == date2.year) {</span>
<a href="#l47.110"></a><span id="l47.110">         return true;</span>
<a href="#l47.111"></a><span id="l47.111">       }</span>
<a href="#l47.112"></a><span id="l47.112">     }</span>
<a href="#l47.113"></a><span id="l47.113">     return false;</span>
<a href="#l47.114"></a><span id="l47.114">   },</span>
<a href="#l47.115"></a><span id="l47.115"> </span>
<a href="#l47.116"></a><span id="l47.116">   /**</span>
<a href="#l47.117"></a><span id="l47.117">    * Many computations want to work only with date-times, not with dates.  This</span>
<a href="#l47.118"></a><span id="l47.118">    * method will return a proper datetime (set to midnight) for a date object.  If</span>
<a href="#l47.119"></a><span id="l47.119">    * the object is already a datetime, it will simply be returned.</span>
<a href="#l47.120"></a><span id="l47.120">    *</span>
<a href="#l47.121"></a><span id="l47.121">    * @param aDate  the date or datetime to check</span>
<a href="#l47.122"></a><span id="l47.122">    */</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineminus">-  ensureDateTime: function(aDate) {</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+  ensureDateTime(aDate) {</span>
<a href="#l47.125"></a><span id="l47.125">     if (!aDate || !aDate.isDate) {</span>
<a href="#l47.126"></a><span id="l47.126">       return aDate;</span>
<a href="#l47.127"></a><span id="l47.127">     }</span>
<a href="#l47.128"></a><span id="l47.128">     let newDate = aDate.clone();</span>
<a href="#l47.129"></a><span id="l47.129">     newDate.isDate = false;</span>
<a href="#l47.130"></a><span id="l47.130">     return newDate;</span>
<a href="#l47.131"></a><span id="l47.131">   },</span>
<a href="#l47.132"></a><span id="l47.132"> </span>
<a href="#l47.133"></a><span id="l47.133" class="difflineat">@@ -172,17 +172,17 @@ var caldtz = {</span>
<a href="#l47.134"></a><span id="l47.134">    * @param aTimezone (optional) a timezone that should be enforced</span>
<a href="#l47.135"></a><span id="l47.135">    * @returns         a calIDateTime</span>
<a href="#l47.136"></a><span id="l47.136">    *</span>
<a href="#l47.137"></a><span id="l47.137">    * @warning  Use of this function is strongly discouraged.  calIDateTime should</span>
<a href="#l47.138"></a><span id="l47.138">    *           be used directly whenever possible.</span>
<a href="#l47.139"></a><span id="l47.139">    *           If you pass a timezone, then the passed jsDate's timezone will be ignored,</span>
<a href="#l47.140"></a><span id="l47.140">    *           but only its local time portions are be taken.</span>
<a href="#l47.141"></a><span id="l47.141">    */</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineminus">-  jsDateToDateTime: function(aDate, aTimezone) {</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+  jsDateToDateTime(aDate, aTimezone) {</span>
<a href="#l47.144"></a><span id="l47.144">     let newDate = cal.createDateTime();</span>
<a href="#l47.145"></a><span id="l47.145">     if (aTimezone) {</span>
<a href="#l47.146"></a><span id="l47.146">       newDate.resetTo(</span>
<a href="#l47.147"></a><span id="l47.147">         aDate.getFullYear(),</span>
<a href="#l47.148"></a><span id="l47.148">         aDate.getMonth(),</span>
<a href="#l47.149"></a><span id="l47.149">         aDate.getDate(),</span>
<a href="#l47.150"></a><span id="l47.150">         aDate.getHours(),</span>
<a href="#l47.151"></a><span id="l47.151">         aDate.getMinutes(),</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineat">@@ -197,33 +197,32 @@ var caldtz = {</span>
<a href="#l47.153"></a><span id="l47.153"> </span>
<a href="#l47.154"></a><span id="l47.154">   /**</span>
<a href="#l47.155"></a><span id="l47.155">    * Convert a calIDateTime to a Javascript date object. This is the</span>
<a href="#l47.156"></a><span id="l47.156">    * replacement for the former .jsDate property.</span>
<a href="#l47.157"></a><span id="l47.157">    *</span>
<a href="#l47.158"></a><span id="l47.158">    * @param cdt       The calIDateTime instnace</span>
<a href="#l47.159"></a><span id="l47.159">    * @return          The Javascript date equivalent.</span>
<a href="#l47.160"></a><span id="l47.160">    */</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineminus">-  dateTimeToJsDate: function(cdt) {</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineplus">+  dateTimeToJsDate(cdt) {</span>
<a href="#l47.163"></a><span id="l47.163">     if (cdt.timezone.isFloating) {</span>
<a href="#l47.164"></a><span id="l47.164">       return new Date(cdt.year, cdt.month, cdt.day, cdt.hour, cdt.minute, cdt.second);</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineminus">-    } else {</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineminus">-      return new Date(cdt.nativeTime / 1000);</span>
<a href="#l47.167"></a><span id="l47.167">     }</span>
<a href="#l47.168"></a><span id="l47.168" class="difflineplus">+    return new Date(cdt.nativeTime / 1000);</span>
<a href="#l47.169"></a><span id="l47.169">   },</span>
<a href="#l47.170"></a><span id="l47.170"> </span>
<a href="#l47.171"></a><span id="l47.171">   /**</span>
<a href="#l47.172"></a><span id="l47.172">    * fromRFC3339</span>
<a href="#l47.173"></a><span id="l47.173">    * Convert a RFC3339 compliant Date string to a calIDateTime.</span>
<a href="#l47.174"></a><span id="l47.174">    *</span>
<a href="#l47.175"></a><span id="l47.175">    * @param aStr          The RFC3339 compliant Date String</span>
<a href="#l47.176"></a><span id="l47.176">    * @param aTimezone     The timezone this date string is most likely in</span>
<a href="#l47.177"></a><span id="l47.177">    * @return              A calIDateTime object</span>
<a href="#l47.178"></a><span id="l47.178">    */</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineminus">-  fromRFC3339: function(aStr, aTimezone) {</span>
<a href="#l47.180"></a><span id="l47.180" class="difflineplus">+  fromRFC3339(aStr, aTimezone) {</span>
<a href="#l47.181"></a><span id="l47.181">     // XXX I have not covered leapseconds (matches[8]), this might need to</span>
<a href="#l47.182"></a><span id="l47.182">     // be done. The only reference to leap seconds I found is bug 227329.</span>
<a href="#l47.183"></a><span id="l47.183">     let dateTime = cal.createDateTime();</span>
<a href="#l47.184"></a><span id="l47.184"> </span>
<a href="#l47.185"></a><span id="l47.185">     // Killer regex to parse RFC3339 dates</span>
<a href="#l47.186"></a><span id="l47.186">     let re = new RegExp(</span>
<a href="#l47.187"></a><span id="l47.187">       &quot;^([0-9]{4})-([0-9]{2})-([0-9]{2})&quot; +</span>
<a href="#l47.188"></a><span id="l47.188">         &quot;([Tt]([0-9]{2}):([0-9]{2}):([0-9]{2})(\\.[0-9]+)?)?&quot; +</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineat">@@ -294,17 +293,17 @@ var caldtz = {</span>
<a href="#l47.190"></a><span id="l47.190"> </span>
<a href="#l47.191"></a><span id="l47.191">   /**</span>
<a href="#l47.192"></a><span id="l47.192">    * toRFC3339</span>
<a href="#l47.193"></a><span id="l47.193">    * Convert a calIDateTime to a RFC3339 compliant Date string</span>
<a href="#l47.194"></a><span id="l47.194">    *</span>
<a href="#l47.195"></a><span id="l47.195">    * @param aDateTime     The calIDateTime object</span>
<a href="#l47.196"></a><span id="l47.196">    * @return              The RFC3339 compliant date string</span>
<a href="#l47.197"></a><span id="l47.197">    */</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineminus">-  toRFC3339: function(aDateTime) {</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineplus">+  toRFC3339(aDateTime) {</span>
<a href="#l47.200"></a><span id="l47.200">     if (!aDateTime) {</span>
<a href="#l47.201"></a><span id="l47.201">       return &quot;&quot;;</span>
<a href="#l47.202"></a><span id="l47.202">     }</span>
<a href="#l47.203"></a><span id="l47.203"> </span>
<a href="#l47.204"></a><span id="l47.204">     let full_tzoffset = aDateTime.timezoneOffset;</span>
<a href="#l47.205"></a><span id="l47.205">     let tzoffset_hr = Math.floor(Math.abs(full_tzoffset) / 3600);</span>
<a href="#l47.206"></a><span id="l47.206"> </span>
<a href="#l47.207"></a><span id="l47.207">     let tzoffset_mn = ((Math.abs(full_tzoffset) / 3600).toFixed(2) - tzoffset_hr) * 60;</span>
<a href="#l47.208"></a><span id="l47.208" class="difflineat">@@ -344,17 +343,17 @@ var caldtz = {</span>
<a href="#l47.209"></a><span id="l47.209"> </span>
<a href="#l47.210"></a><span id="l47.210">   /**</span>
<a href="#l47.211"></a><span id="l47.211">    * Gets the list of recent timezones. Optionally returns the list as</span>
<a href="#l47.212"></a><span id="l47.212">    * calITimezones.</span>
<a href="#l47.213"></a><span id="l47.213">    *</span>
<a href="#l47.214"></a><span id="l47.214">    * @param aConvertZones     (optional) If true, return calITimezones instead</span>
<a href="#l47.215"></a><span id="l47.215">    * @return                  An array of timezone ids or calITimezones.</span>
<a href="#l47.216"></a><span id="l47.216">    */</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineminus">-  getRecentTimezones: function(aConvertZones) {</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineplus">+  getRecentTimezones(aConvertZones) {</span>
<a href="#l47.219"></a><span id="l47.219">     let recentTimezones = JSON.parse(</span>
<a href="#l47.220"></a><span id="l47.220">       Services.prefs.getStringPref(&quot;calendar.timezone.recent&quot;, &quot;[]&quot;) || &quot;[]&quot;</span>
<a href="#l47.221"></a><span id="l47.221">     );</span>
<a href="#l47.222"></a><span id="l47.222">     if (!Array.isArray(recentTimezones)) {</span>
<a href="#l47.223"></a><span id="l47.223">       recentTimezones = [];</span>
<a href="#l47.224"></a><span id="l47.224">     }</span>
<a href="#l47.225"></a><span id="l47.225"> </span>
<a href="#l47.226"></a><span id="l47.226">     let tzService = cal.getTimezoneService();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/calendar/base/modules/utils/calEmailUtils.jsm</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -21,17 +21,17 @@ var calemail = {</span>
<a href="#l48.4"></a><span id="l48.4">    * parameters. These parameters are mostly raw header fields, see #createRecipientList function</span>
<a href="#l48.5"></a><span id="l48.5">    * to create a recipient list string.</span>
<a href="#l48.6"></a><span id="l48.6">    *</span>
<a href="#l48.7"></a><span id="l48.7">    * @param {String} aRecipient       The email recipients string.</span>
<a href="#l48.8"></a><span id="l48.8">    * @param {String} aSubject         The email subject.</span>
<a href="#l48.9"></a><span id="l48.9">    * @param {String} aBody            The encoded email body text.</span>
<a href="#l48.10"></a><span id="l48.10">    * @param {nsIMsgIdentity} aIdentity    The email identity to use for sending</span>
<a href="#l48.11"></a><span id="l48.11">    */</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  sendTo: function(aRecipient, aSubject, aBody, aIdentity) {</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+  sendTo(aRecipient, aSubject, aBody, aIdentity) {</span>
<a href="#l48.14"></a><span id="l48.14">     let msgParams = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(</span>
<a href="#l48.15"></a><span id="l48.15">       Ci.nsIMsgComposeParams</span>
<a href="#l48.16"></a><span id="l48.16">     );</span>
<a href="#l48.17"></a><span id="l48.17">     let composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(</span>
<a href="#l48.18"></a><span id="l48.18">       Ci.nsIMsgCompFields</span>
<a href="#l48.19"></a><span id="l48.19">     );</span>
<a href="#l48.20"></a><span id="l48.20"> </span>
<a href="#l48.21"></a><span id="l48.21">     composeFields.to = aRecipient;</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineat">@@ -47,17 +47,17 @@ var calemail = {</span>
<a href="#l48.23"></a><span id="l48.23">   },</span>
<a href="#l48.24"></a><span id="l48.24"> </span>
<a href="#l48.25"></a><span id="l48.25">   /**</span>
<a href="#l48.26"></a><span id="l48.26">    * Iterates all email identities and calls the passed function with identity and account.</span>
<a href="#l48.27"></a><span id="l48.27">    * If the called function returns false, iteration is stopped.</span>
<a href="#l48.28"></a><span id="l48.28">    *</span>
<a href="#l48.29"></a><span id="l48.29">    * @param {Function} aFunc       The function to be called for each identity and account</span>
<a href="#l48.30"></a><span id="l48.30">    */</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineminus">-  iterateIdentities: function(aFunc) {</span>
<a href="#l48.32"></a><span id="l48.32" class="difflineplus">+  iterateIdentities(aFunc) {</span>
<a href="#l48.33"></a><span id="l48.33">     let accounts = MailServices.accounts.accounts;</span>
<a href="#l48.34"></a><span id="l48.34">     for (let i = 0; i &lt; accounts.length; ++i) {</span>
<a href="#l48.35"></a><span id="l48.35">       let account = accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l48.36"></a><span id="l48.36">       let identities = account.identities;</span>
<a href="#l48.37"></a><span id="l48.37">       for (let j = 0; j &lt; identities.length; ++j) {</span>
<a href="#l48.38"></a><span id="l48.38">         let identity = identities.queryElementAt(j, Ci.nsIMsgIdentity);</span>
<a href="#l48.39"></a><span id="l48.39">         if (!aFunc(identity, account)) {</span>
<a href="#l48.40"></a><span id="l48.40">           break;</span>
<a href="#l48.41"></a><span id="l48.41" class="difflineat">@@ -67,37 +67,37 @@ var calemail = {</span>
<a href="#l48.42"></a><span id="l48.42">   },</span>
<a href="#l48.43"></a><span id="l48.43"> </span>
<a href="#l48.44"></a><span id="l48.44">   /**</span>
<a href="#l48.45"></a><span id="l48.45">    * Prepends a mailto: prefix to an email address like string</span>
<a href="#l48.46"></a><span id="l48.46">    *</span>
<a href="#l48.47"></a><span id="l48.47">    * @param  {String} aId     The string to prepend the prefix if not already there</span>
<a href="#l48.48"></a><span id="l48.48">    * @return {String}         The string with prefix</span>
<a href="#l48.49"></a><span id="l48.49">    */</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-  prependMailTo: function(aId) {</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+  prependMailTo(aId) {</span>
<a href="#l48.52"></a><span id="l48.52">     return aId.replace(/^(?:mailto:)?(.*)@/i, &quot;mailto:$1@&quot;);</span>
<a href="#l48.53"></a><span id="l48.53">   },</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55">   /**</span>
<a href="#l48.56"></a><span id="l48.56">    * Removes an existing mailto: prefix from an attendee id</span>
<a href="#l48.57"></a><span id="l48.57">    *</span>
<a href="#l48.58"></a><span id="l48.58">    * @param  {String} aId     The string to remove the prefix from if any</span>
<a href="#l48.59"></a><span id="l48.59">    * @return {String}         The string without prefix</span>
<a href="#l48.60"></a><span id="l48.60">    */</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineminus">-  removeMailTo: function(aId) {</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+  removeMailTo(aId) {</span>
<a href="#l48.63"></a><span id="l48.63">     return aId.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l48.64"></a><span id="l48.64">   },</span>
<a href="#l48.65"></a><span id="l48.65"> </span>
<a href="#l48.66"></a><span id="l48.66">   /**</span>
<a href="#l48.67"></a><span id="l48.67">    * Provides a string to use in email &quot;to&quot; header for given attendees</span>
<a href="#l48.68"></a><span id="l48.68">    *</span>
<a href="#l48.69"></a><span id="l48.69">    * @param  {calIAttendee[]} aAttendees          Array of calIAttendee's to check</span>
<a href="#l48.70"></a><span id="l48.70">    * @return {String}                             Valid string to use in a 'to' header of an email</span>
<a href="#l48.71"></a><span id="l48.71">    */</span>
<a href="#l48.72"></a><span id="l48.72" class="difflineminus">-  createRecipientList: function(aAttendees) {</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineplus">+  createRecipientList(aAttendees) {</span>
<a href="#l48.74"></a><span id="l48.74">     let cbEmail = function(aVal) {</span>
<a href="#l48.75"></a><span id="l48.75">       let email = calemail.getAttendeeEmail(aVal, true);</span>
<a href="#l48.76"></a><span id="l48.76">       if (!email.length) {</span>
<a href="#l48.77"></a><span id="l48.77">         cal.LOG(&quot;Dropping invalid recipient for email transport: &quot; + aVal.toString());</span>
<a href="#l48.78"></a><span id="l48.78">       }</span>
<a href="#l48.79"></a><span id="l48.79">       return email;</span>
<a href="#l48.80"></a><span id="l48.80">     };</span>
<a href="#l48.81"></a><span id="l48.81">     return aAttendees</span>
<a href="#l48.82"></a><span id="l48.82" class="difflineat">@@ -109,17 +109,17 @@ var calemail = {</span>
<a href="#l48.83"></a><span id="l48.83">   /**</span>
<a href="#l48.84"></a><span id="l48.84">    * Returns a wellformed email string like 'attendee@example.net',</span>
<a href="#l48.85"></a><span id="l48.85">    * 'Common Name &lt;attendee@example.net&gt;' or '&quot;Name, Common&quot; &lt;attendee@example.net&gt;'</span>
<a href="#l48.86"></a><span id="l48.86">    *</span>
<a href="#l48.87"></a><span id="l48.87">    * @param  {calIAttendee} aAttendee     The attendee to check</span>
<a href="#l48.88"></a><span id="l48.88">    * @param  {Boolean} aIncludeCn         Whether or not to return also the CN if available</span>
<a href="#l48.89"></a><span id="l48.89">    * @return {String}                     Valid email string or an empty string in case of error</span>
<a href="#l48.90"></a><span id="l48.90">    */</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineminus">-  getAttendeeEmail: function(aAttendee, aIncludeCn) {</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+  getAttendeeEmail(aAttendee, aIncludeCn) {</span>
<a href="#l48.93"></a><span id="l48.93">     // If the recipient id is of type urn, we need to figure out the email address, otherwise</span>
<a href="#l48.94"></a><span id="l48.94">     // we fall back to the attendee id</span>
<a href="#l48.95"></a><span id="l48.95">     let email = aAttendee.id.match(/^urn:/i) ? aAttendee.getProperty(&quot;EMAIL&quot;) || &quot;&quot; : aAttendee.id;</span>
<a href="#l48.96"></a><span id="l48.96">     // Strip leading &quot;mailto:&quot; if it exists.</span>
<a href="#l48.97"></a><span id="l48.97">     email = email.replace(/^mailto:/i, &quot;&quot;);</span>
<a href="#l48.98"></a><span id="l48.98">     // We add the CN if requested and available</span>
<a href="#l48.99"></a><span id="l48.99">     let commonName = aAttendee.commonName;</span>
<a href="#l48.100"></a><span id="l48.100">     if (aIncludeCn &amp;&amp; email.length &gt; 0 &amp;&amp; commonName &amp;&amp; commonName.length &gt; 0) {</span>
<a href="#l48.101"></a><span id="l48.101" class="difflineat">@@ -135,17 +135,17 @@ var calemail = {</span>
<a href="#l48.102"></a><span id="l48.102">   },</span>
<a href="#l48.103"></a><span id="l48.103"> </span>
<a href="#l48.104"></a><span id="l48.104">   /**</span>
<a href="#l48.105"></a><span id="l48.105">    * Returns a basically checked recipient list - malformed elements will be removed</span>
<a href="#l48.106"></a><span id="l48.106">    *</span>
<a href="#l48.107"></a><span id="l48.107">    * @param {String} aRecipients      A comma-seperated list of e-mail addresses</span>
<a href="#l48.108"></a><span id="l48.108">    * @return {String}                 A validated comma-seperated list of e-mail addresses</span>
<a href="#l48.109"></a><span id="l48.109">    */</span>
<a href="#l48.110"></a><span id="l48.110" class="difflineminus">-  validateRecipientList: function(aRecipients) {</span>
<a href="#l48.111"></a><span id="l48.111" class="difflineplus">+  validateRecipientList(aRecipients) {</span>
<a href="#l48.112"></a><span id="l48.112">     let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(</span>
<a href="#l48.113"></a><span id="l48.113">       Ci.nsIMsgCompFields</span>
<a href="#l48.114"></a><span id="l48.114">     );</span>
<a href="#l48.115"></a><span id="l48.115">     // Resolve the list considering also configured common names</span>
<a href="#l48.116"></a><span id="l48.116">     let members = compFields.splitRecipients(aRecipients, false);</span>
<a href="#l48.117"></a><span id="l48.117">     let list = [];</span>
<a href="#l48.118"></a><span id="l48.118">     let prefix = &quot;&quot;;</span>
<a href="#l48.119"></a><span id="l48.119">     for (let member of members) {</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineat">@@ -193,17 +193,17 @@ var calemail = {</span>
<a href="#l48.121"></a><span id="l48.121">   /**</span>
<a href="#l48.122"></a><span id="l48.122">    * Check if the attendee object matches one of the addresses in the list. This</span>
<a href="#l48.123"></a><span id="l48.123">    * is useful to determine whether the current user acts as a delegate.</span>
<a href="#l48.124"></a><span id="l48.124">    *</span>
<a href="#l48.125"></a><span id="l48.125">    * @param {calIAttendee} aRefAttendee   The reference attendee object</span>
<a href="#l48.126"></a><span id="l48.126">    * @param {String[]} aAddresses         The list of addresses</span>
<a href="#l48.127"></a><span id="l48.127">    * @return {Boolean}                    True, if there is a match</span>
<a href="#l48.128"></a><span id="l48.128">    */</span>
<a href="#l48.129"></a><span id="l48.129" class="difflineminus">-  attendeeMatchesAddresses: function(aRefAttendee, aAddresses) {</span>
<a href="#l48.130"></a><span id="l48.130" class="difflineplus">+  attendeeMatchesAddresses(aRefAttendee, aAddresses) {</span>
<a href="#l48.131"></a><span id="l48.131">     let attId = aRefAttendee.id;</span>
<a href="#l48.132"></a><span id="l48.132">     if (!attId.match(/^mailto:/i)) {</span>
<a href="#l48.133"></a><span id="l48.133">       // Looks like its not a normal attendee, possibly urn:uuid:...</span>
<a href="#l48.134"></a><span id="l48.134">       // Try getting the email through the EMAIL property.</span>
<a href="#l48.135"></a><span id="l48.135">       let emailProp = aRefAttendee.getProperty(&quot;EMAIL&quot;);</span>
<a href="#l48.136"></a><span id="l48.136">       if (emailProp) {</span>
<a href="#l48.137"></a><span id="l48.137">         attId = emailProp;</span>
<a href="#l48.138"></a><span id="l48.138">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/calendar/base/modules/utils/calItemUtils.jsm</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItemUtils.jsm</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -48,65 +48,65 @@ var calitem = {</span>
<a href="#l49.4"></a><span id="l49.4">       mDeletedItems: null,</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6">       /**</span>
<a href="#l49.7"></a><span id="l49.7">        * Expect the difference engine to be in the given state.</span>
<a href="#l49.8"></a><span id="l49.8">        *</span>
<a href="#l49.9"></a><span id="l49.9">        * @param aState    The state to be in</span>
<a href="#l49.10"></a><span id="l49.10">        * @param aMethod   The method name expecting the state</span>
<a href="#l49.11"></a><span id="l49.11">        */</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-      _expectState: function(aState, aMethod) {</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+      _expectState(aState, aMethod) {</span>
<a href="#l49.14"></a><span id="l49.14">         if ((this.state &amp; aState) == 0) {</span>
<a href="#l49.15"></a><span id="l49.15">           throw new Error(</span>
<a href="#l49.16"></a><span id="l49.16">             &quot;ItemDiff method &quot; + aMethod + &quot; called while in unexpected state &quot; + this.state</span>
<a href="#l49.17"></a><span id="l49.17">           );</span>
<a href="#l49.18"></a><span id="l49.18">         }</span>
<a href="#l49.19"></a><span id="l49.19">       },</span>
<a href="#l49.20"></a><span id="l49.20"> </span>
<a href="#l49.21"></a><span id="l49.21">       /**</span>
<a href="#l49.22"></a><span id="l49.22">        * Load the difference engine with one item, see load.</span>
<a href="#l49.23"></a><span id="l49.23">        *</span>
<a href="#l49.24"></a><span id="l49.24">        * @param item      The item to load</span>
<a href="#l49.25"></a><span id="l49.25">        */</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-      load1: function(item) {</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+      load1(item) {</span>
<a href="#l49.28"></a><span id="l49.28">         this.load([item]);</span>
<a href="#l49.29"></a><span id="l49.29">       },</span>
<a href="#l49.30"></a><span id="l49.30"> </span>
<a href="#l49.31"></a><span id="l49.31">       /**</span>
<a href="#l49.32"></a><span id="l49.32">        * Loads an array of items. This step cannot be executed</span>
<a href="#l49.33"></a><span id="l49.33">        * after calling the difference methods.</span>
<a href="#l49.34"></a><span id="l49.34">        *</span>
<a href="#l49.35"></a><span id="l49.35">        * @param items     The array of items to load</span>
<a href="#l49.36"></a><span id="l49.36">        */</span>
<a href="#l49.37"></a><span id="l49.37" class="difflineminus">-      load: function(items) {</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+      load(items) {</span>
<a href="#l49.39"></a><span id="l49.39">         this._expectState(this.STATE_INITIAL | this.STATE_LOADING, &quot;load&quot;);</span>
<a href="#l49.40"></a><span id="l49.40"> </span>
<a href="#l49.41"></a><span id="l49.41">         for (let item of items) {</span>
<a href="#l49.42"></a><span id="l49.42">           this.mInitialItems[item.hashId] = item;</span>
<a href="#l49.43"></a><span id="l49.43">         }</span>
<a href="#l49.44"></a><span id="l49.44"> </span>
<a href="#l49.45"></a><span id="l49.45">         this.state = this.STATE_LOADING;</span>
<a href="#l49.46"></a><span id="l49.46">       },</span>
<a href="#l49.47"></a><span id="l49.47"> </span>
<a href="#l49.48"></a><span id="l49.48">       /**</span>
<a href="#l49.49"></a><span id="l49.49">        * Calculates the difference for the passed item, see difference.</span>
<a href="#l49.50"></a><span id="l49.50">        *</span>
<a href="#l49.51"></a><span id="l49.51">        * @param item      The item to calculate difference with</span>
<a href="#l49.52"></a><span id="l49.52">        */</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineminus">-      difference1: function(item) {</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+      difference1(item) {</span>
<a href="#l49.55"></a><span id="l49.55">         this.difference([item]);</span>
<a href="#l49.56"></a><span id="l49.56">       },</span>
<a href="#l49.57"></a><span id="l49.57"> </span>
<a href="#l49.58"></a><span id="l49.58">       /**</span>
<a href="#l49.59"></a><span id="l49.59">        * Calculate the difference for the array of items. This method should be</span>
<a href="#l49.60"></a><span id="l49.60">        * called after all load methods and before the complete method.</span>
<a href="#l49.61"></a><span id="l49.61">        *</span>
<a href="#l49.62"></a><span id="l49.62">        * @param items     The array of items to calculate difference with</span>
<a href="#l49.63"></a><span id="l49.63">        */</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineminus">-      difference: function(items) {</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+      difference(items) {</span>
<a href="#l49.66"></a><span id="l49.66">         this._expectState(</span>
<a href="#l49.67"></a><span id="l49.67">           this.STATE_INITIAL | this.STATE_LOADING | this.STATE_DIFFERING,</span>
<a href="#l49.68"></a><span id="l49.68">           &quot;difference&quot;</span>
<a href="#l49.69"></a><span id="l49.69">         );</span>
<a href="#l49.70"></a><span id="l49.70"> </span>
<a href="#l49.71"></a><span id="l49.71">         this.mModifiedOldItems.startBatch();</span>
<a href="#l49.72"></a><span id="l49.72">         this.mModifiedItems.startBatch();</span>
<a href="#l49.73"></a><span id="l49.73">         this.mAddedItems.startBatch();</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineat">@@ -128,17 +128,17 @@ var calitem = {</span>
<a href="#l49.75"></a><span id="l49.75"> </span>
<a href="#l49.76"></a><span id="l49.76">         this.state = this.STATE_DIFFERING;</span>
<a href="#l49.77"></a><span id="l49.77">       },</span>
<a href="#l49.78"></a><span id="l49.78"> </span>
<a href="#l49.79"></a><span id="l49.79">       /**</span>
<a href="#l49.80"></a><span id="l49.80">        * Tell the engine that all load and difference calls have been made, this</span>
<a href="#l49.81"></a><span id="l49.81">        * makes sure that all item states are correctly returned.</span>
<a href="#l49.82"></a><span id="l49.82">        */</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineminus">-      complete: function() {</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+      complete() {</span>
<a href="#l49.85"></a><span id="l49.85">         this._expectState(</span>
<a href="#l49.86"></a><span id="l49.86">           this.STATE_INITIAL | this.STATE_LOADING | this.STATE_DIFFERING,</span>
<a href="#l49.87"></a><span id="l49.87">           &quot;complete&quot;</span>
<a href="#l49.88"></a><span id="l49.88">         );</span>
<a href="#l49.89"></a><span id="l49.89"> </span>
<a href="#l49.90"></a><span id="l49.90">         this.mDeletedItems.startBatch();</span>
<a href="#l49.91"></a><span id="l49.91"> </span>
<a href="#l49.92"></a><span id="l49.92">         for (let hashId in this.mInitialItems) {</span>
<a href="#l49.93"></a><span id="l49.93" class="difflineat">@@ -179,17 +179,17 @@ var calitem = {</span>
<a href="#l49.94"></a><span id="l49.94">       /** @return the number of loaded items */</span>
<a href="#l49.95"></a><span id="l49.95">       get count() {</span>
<a href="#l49.96"></a><span id="l49.96">         return Object.keys(this.mInitialItems).length;</span>
<a href="#l49.97"></a><span id="l49.97">       },</span>
<a href="#l49.98"></a><span id="l49.98"> </span>
<a href="#l49.99"></a><span id="l49.99">       /**</span>
<a href="#l49.100"></a><span id="l49.100">        * Resets the difference engine to its initial state.</span>
<a href="#l49.101"></a><span id="l49.101">        */</span>
<a href="#l49.102"></a><span id="l49.102" class="difflineminus">-      reset: function() {</span>
<a href="#l49.103"></a><span id="l49.103" class="difflineplus">+      reset() {</span>
<a href="#l49.104"></a><span id="l49.104">         this.mInitialItems = {};</span>
<a href="#l49.105"></a><span id="l49.105">         this.mModifiedItems = new cal.HashedArray();</span>
<a href="#l49.106"></a><span id="l49.106">         this.mModifiedOldItems = new cal.HashedArray();</span>
<a href="#l49.107"></a><span id="l49.107">         this.mAddedItems = new cal.HashedArray();</span>
<a href="#l49.108"></a><span id="l49.108">         this.mDeletedItems = new cal.HashedArray();</span>
<a href="#l49.109"></a><span id="l49.109">         this.state = this.STATE_INITIAL;</span>
<a href="#l49.110"></a><span id="l49.110">       },</span>
<a href="#l49.111"></a><span id="l49.111">     };</span>
<a href="#l49.112"></a><span id="l49.112" class="difflineat">@@ -198,73 +198,73 @@ var calitem = {</span>
<a href="#l49.113"></a><span id="l49.113"> </span>
<a href="#l49.114"></a><span id="l49.114">   /**</span>
<a href="#l49.115"></a><span id="l49.115">    * Checks if an item is supported by a Calendar.</span>
<a href="#l49.116"></a><span id="l49.116">    *</span>
<a href="#l49.117"></a><span id="l49.117">    * @param aCalendar the calendar</span>
<a href="#l49.118"></a><span id="l49.118">    * @param aItem the item either a task or an event</span>
<a href="#l49.119"></a><span id="l49.119">    * @return true or false</span>
<a href="#l49.120"></a><span id="l49.120">    */</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineminus">-  isItemSupported: function(aItem, aCalendar) {</span>
<a href="#l49.122"></a><span id="l49.122" class="difflineplus">+  isItemSupported(aItem, aCalendar) {</span>
<a href="#l49.123"></a><span id="l49.123">     if (calitem.isToDo(aItem)) {</span>
<a href="#l49.124"></a><span id="l49.124">       return aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false;</span>
<a href="#l49.125"></a><span id="l49.125">     } else if (calitem.isEvent(aItem)) {</span>
<a href="#l49.126"></a><span id="l49.126">       return aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false;</span>
<a href="#l49.127"></a><span id="l49.127">     }</span>
<a href="#l49.128"></a><span id="l49.128">     return false;</span>
<a href="#l49.129"></a><span id="l49.129">   },</span>
<a href="#l49.130"></a><span id="l49.130"> </span>
<a href="#l49.131"></a><span id="l49.131">   /*</span>
<a href="#l49.132"></a><span id="l49.132">    * Checks whether a calendar supports events</span>
<a href="#l49.133"></a><span id="l49.133">    *</span>
<a href="#l49.134"></a><span id="l49.134">    * @param aCalendar</span>
<a href="#l49.135"></a><span id="l49.135">    */</span>
<a href="#l49.136"></a><span id="l49.136" class="difflineminus">-  isEventCalendar: function(aCalendar) {</span>
<a href="#l49.137"></a><span id="l49.137" class="difflineplus">+  isEventCalendar(aCalendar) {</span>
<a href="#l49.138"></a><span id="l49.138">     return aCalendar.getProperty(&quot;capabilities.events.supported&quot;) !== false;</span>
<a href="#l49.139"></a><span id="l49.139">   },</span>
<a href="#l49.140"></a><span id="l49.140"> </span>
<a href="#l49.141"></a><span id="l49.141">   /*</span>
<a href="#l49.142"></a><span id="l49.142">    * Checks whether a calendar supports tasks</span>
<a href="#l49.143"></a><span id="l49.143">    *</span>
<a href="#l49.144"></a><span id="l49.144">    * @param aCalendar</span>
<a href="#l49.145"></a><span id="l49.145">    */</span>
<a href="#l49.146"></a><span id="l49.146" class="difflineminus">-  isTaskCalendar: function(aCalendar) {</span>
<a href="#l49.147"></a><span id="l49.147" class="difflineplus">+  isTaskCalendar(aCalendar) {</span>
<a href="#l49.148"></a><span id="l49.148">     return aCalendar.getProperty(&quot;capabilities.tasks.supported&quot;) !== false;</span>
<a href="#l49.149"></a><span id="l49.149">   },</span>
<a href="#l49.150"></a><span id="l49.150"> </span>
<a href="#l49.151"></a><span id="l49.151">   /**</span>
<a href="#l49.152"></a><span id="l49.152">    * Determines whether or not the aObject is a calIEvent</span>
<a href="#l49.153"></a><span id="l49.153">    *</span>
<a href="#l49.154"></a><span id="l49.154">    * @param aObject  the object to test</span>
<a href="#l49.155"></a><span id="l49.155">    * @returns        true if the object is a calIEvent, false otherwise</span>
<a href="#l49.156"></a><span id="l49.156">    */</span>
<a href="#l49.157"></a><span id="l49.157" class="difflineminus">-  isEvent: function(aObject) {</span>
<a href="#l49.158"></a><span id="l49.158" class="difflineplus">+  isEvent(aObject) {</span>
<a href="#l49.159"></a><span id="l49.159">     return cal.wrapInstance(aObject, Ci.calIEvent) != null;</span>
<a href="#l49.160"></a><span id="l49.160">   },</span>
<a href="#l49.161"></a><span id="l49.161"> </span>
<a href="#l49.162"></a><span id="l49.162">   /**</span>
<a href="#l49.163"></a><span id="l49.163">    * Determines whether or not the aObject is a calITodo</span>
<a href="#l49.164"></a><span id="l49.164">    *</span>
<a href="#l49.165"></a><span id="l49.165">    * @param aObject  the object to test</span>
<a href="#l49.166"></a><span id="l49.166">    * @returns        true if the object is a calITodo, false otherwise</span>
<a href="#l49.167"></a><span id="l49.167">    */</span>
<a href="#l49.168"></a><span id="l49.168" class="difflineminus">-  isToDo: function(aObject) {</span>
<a href="#l49.169"></a><span id="l49.169" class="difflineplus">+  isToDo(aObject) {</span>
<a href="#l49.170"></a><span id="l49.170">     return cal.wrapInstance(aObject, Ci.calITodo) != null;</span>
<a href="#l49.171"></a><span id="l49.171">   },</span>
<a href="#l49.172"></a><span id="l49.172"> </span>
<a href="#l49.173"></a><span id="l49.173">   /**</span>
<a href="#l49.174"></a><span id="l49.174">    * Checks whether the passed item fits into the demanded range.</span>
<a href="#l49.175"></a><span id="l49.175">    *</span>
<a href="#l49.176"></a><span id="l49.176">    * @param item               the item</span>
<a href="#l49.177"></a><span id="l49.177">    * @param rangeStart         (inclusive) range start or null (open range)</span>
<a href="#l49.178"></a><span id="l49.178">    * @param rangeStart         (exclusive) range end or null (open range)</span>
<a href="#l49.179"></a><span id="l49.179">    * @param returnDtstartOrDue returns item's start (or due) date in case</span>
<a href="#l49.180"></a><span id="l49.180">    *                           the item is in the specified Range; null otherwise.</span>
<a href="#l49.181"></a><span id="l49.181">    */</span>
<a href="#l49.182"></a><span id="l49.182" class="difflineminus">-  checkIfInRange: function(item, rangeStart, rangeEnd, returnDtstartOrDue) {</span>
<a href="#l49.183"></a><span id="l49.183" class="difflineplus">+  checkIfInRange(item, rangeStart, rangeEnd, returnDtstartOrDue) {</span>
<a href="#l49.184"></a><span id="l49.184">     let startDate;</span>
<a href="#l49.185"></a><span id="l49.185">     let endDate;</span>
<a href="#l49.186"></a><span id="l49.186">     let queryStart = cal.dtz.ensureDateTime(rangeStart);</span>
<a href="#l49.187"></a><span id="l49.187">     if (calitem.isEvent(item)) {</span>
<a href="#l49.188"></a><span id="l49.188">       startDate = item.startDate;</span>
<a href="#l49.189"></a><span id="l49.189">       if (!startDate) {</span>
<a href="#l49.190"></a><span id="l49.190">         // DTSTART mandatory</span>
<a href="#l49.191"></a><span id="l49.191">         // xxx todo: should we assert this case?</span>
<a href="#l49.192"></a><span id="l49.192" class="difflineat">@@ -310,17 +310,17 @@ var calitem = {</span>
<a href="#l49.193"></a><span id="l49.193">       (!queryEnd || start.compare(queryEnd) &lt; 0) &amp;&amp;</span>
<a href="#l49.194"></a><span id="l49.194">       (!queryStart || end.compare(queryStart) &gt; 0)</span>
<a href="#l49.195"></a><span id="l49.195">     ) {</span>
<a href="#l49.196"></a><span id="l49.196">       return startDate;</span>
<a href="#l49.197"></a><span id="l49.197">     }</span>
<a href="#l49.198"></a><span id="l49.198">     return null;</span>
<a href="#l49.199"></a><span id="l49.199">   },</span>
<a href="#l49.200"></a><span id="l49.200"> </span>
<a href="#l49.201"></a><span id="l49.201" class="difflineminus">-  setItemProperty: function(item, propertyName, aValue, aCapability) {</span>
<a href="#l49.202"></a><span id="l49.202" class="difflineplus">+  setItemProperty(item, propertyName, aValue, aCapability) {</span>
<a href="#l49.203"></a><span id="l49.203">     let isSupported =</span>
<a href="#l49.204"></a><span id="l49.204">       item.calendar.getProperty(&quot;capabilities.&quot; + aCapability + &quot;.supported&quot;) !== false;</span>
<a href="#l49.205"></a><span id="l49.205">     let value = aCapability &amp;&amp; !isSupported ? null : aValue;</span>
<a href="#l49.206"></a><span id="l49.206"> </span>
<a href="#l49.207"></a><span id="l49.207">     switch (propertyName) {</span>
<a href="#l49.208"></a><span id="l49.208">       case &quot;startDate&quot;:</span>
<a href="#l49.209"></a><span id="l49.209">         if (</span>
<a href="#l49.210"></a><span id="l49.210">           (value.isDate &amp;&amp; !item.startDate.isDate) ||</span>
<a href="#l49.211"></a><span id="l49.211" class="difflineat">@@ -399,17 +399,17 @@ var calitem = {</span>
<a href="#l49.212"></a><span id="l49.212">     }</span>
<a href="#l49.213"></a><span id="l49.213">   },</span>
<a href="#l49.214"></a><span id="l49.214"> </span>
<a href="#l49.215"></a><span id="l49.215">   /**</span>
<a href="#l49.216"></a><span id="l49.216">    * Returns the default transparency to apply for an event depending on whether its an all-day event</span>
<a href="#l49.217"></a><span id="l49.217">    *</span>
<a href="#l49.218"></a><span id="l49.218">    * @param aIsAllDay      If true, the default transparency for all-day events is returned</span>
<a href="#l49.219"></a><span id="l49.219">    */</span>
<a href="#l49.220"></a><span id="l49.220" class="difflineminus">-  getEventDefaultTransparency: function(aIsAllDay) {</span>
<a href="#l49.221"></a><span id="l49.221" class="difflineplus">+  getEventDefaultTransparency(aIsAllDay) {</span>
<a href="#l49.222"></a><span id="l49.222">     let transp = null;</span>
<a href="#l49.223"></a><span id="l49.223">     if (aIsAllDay) {</span>
<a href="#l49.224"></a><span id="l49.224">       transp = Services.prefs.getBoolPref(</span>
<a href="#l49.225"></a><span id="l49.225">         &quot;calendar.events.defaultTransparency.allday.transparent&quot;,</span>
<a href="#l49.226"></a><span id="l49.226">         false</span>
<a href="#l49.227"></a><span id="l49.227">       )</span>
<a href="#l49.228"></a><span id="l49.228">         ? &quot;TRANSPARENT&quot;</span>
<a href="#l49.229"></a><span id="l49.229">         : &quot;OPAQUE&quot;;</span>
<a href="#l49.230"></a><span id="l49.230" class="difflineat">@@ -440,17 +440,17 @@ var calitem = {</span>
<a href="#l49.231"></a><span id="l49.231">      *</span>
<a href="#l49.232"></a><span id="l49.232">      * @param aFirstItem        The item to compare.</span>
<a href="#l49.233"></a><span id="l49.233">      * @param aSecondItem       The item to compare to.</span>
<a href="#l49.234"></a><span id="l49.234">      * @param aIgnoreProps      (optional) An array of parameters to ignore.</span>
<a href="#l49.235"></a><span id="l49.235">      * @param aIgnoreParams     (optional) An object describing which parameters to</span>
<a href="#l49.236"></a><span id="l49.236">      *                                     ignore.</span>
<a href="#l49.237"></a><span id="l49.237">      * @return                  True, if items match.</span>
<a href="#l49.238"></a><span id="l49.238">      */</span>
<a href="#l49.239"></a><span id="l49.239" class="difflineminus">-  compareContent: function(aFirstItem, aSecondItem, aIgnoreProps, aIgnoreParams) {</span>
<a href="#l49.240"></a><span id="l49.240" class="difflineplus">+  compareContent(aFirstItem, aSecondItem, aIgnoreProps, aIgnoreParams) {</span>
<a href="#l49.241"></a><span id="l49.241">     let ignoreProps = arr2hash(</span>
<a href="#l49.242"></a><span id="l49.242">       aIgnoreProps || [</span>
<a href="#l49.243"></a><span id="l49.243">         &quot;SEQUENCE&quot;,</span>
<a href="#l49.244"></a><span id="l49.244">         &quot;DTSTAMP&quot;,</span>
<a href="#l49.245"></a><span id="l49.245">         &quot;LAST-MODIFIED&quot;,</span>
<a href="#l49.246"></a><span id="l49.246">         &quot;X-MOZ-GENERATION&quot;,</span>
<a href="#l49.247"></a><span id="l49.247">         &quot;X-MICROSOFT-DISALLOW-COUNTER&quot;,</span>
<a href="#l49.248"></a><span id="l49.248">         &quot;X-MOZ-SEND-INVITATIONS&quot;,</span>
<a href="#l49.249"></a><span id="l49.249" class="difflineat">@@ -509,17 +509,17 @@ var calitem = {</span>
<a href="#l49.250"></a><span id="l49.250">   },</span>
<a href="#l49.251"></a><span id="l49.251"> </span>
<a href="#l49.252"></a><span id="l49.252">   /**</span>
<a href="#l49.253"></a><span id="l49.253">    * Shifts an item by the given timely offset.</span>
<a href="#l49.254"></a><span id="l49.254">    *</span>
<a href="#l49.255"></a><span id="l49.255">    * @param item an item</span>
<a href="#l49.256"></a><span id="l49.256">    * @param offset an offset (calIDuration)</span>
<a href="#l49.257"></a><span id="l49.257">    */</span>
<a href="#l49.258"></a><span id="l49.258" class="difflineminus">-  shiftOffset: function(item, offset) {</span>
<a href="#l49.259"></a><span id="l49.259" class="difflineplus">+  shiftOffset(item, offset) {</span>
<a href="#l49.260"></a><span id="l49.260">     // When modifying dates explicitly using the setters is important</span>
<a href="#l49.261"></a><span id="l49.261">     // since those may triggers e.g. calIRecurrenceInfo::onStartDateChange</span>
<a href="#l49.262"></a><span id="l49.262">     // or invalidate other properties. Moreover don't modify the date-time objects</span>
<a href="#l49.263"></a><span id="l49.263">     // without cloning, because changes cannot be calculated if doing so.</span>
<a href="#l49.264"></a><span id="l49.264">     if (calitem.isEvent(item)) {</span>
<a href="#l49.265"></a><span id="l49.265">       let date = item.startDate.clone();</span>
<a href="#l49.266"></a><span id="l49.266">       date.addDuration(offset);</span>
<a href="#l49.267"></a><span id="l49.267">       item.startDate = date;</span>
<a href="#l49.268"></a><span id="l49.268" class="difflineat">@@ -543,17 +543,17 @@ var calitem = {</span>
<a href="#l49.269"></a><span id="l49.269"> </span>
<a href="#l49.270"></a><span id="l49.270">   /**</span>
<a href="#l49.271"></a><span id="l49.271">    * moves an item to another startDate</span>
<a href="#l49.272"></a><span id="l49.272">    *</span>
<a href="#l49.273"></a><span id="l49.273">    * @param aOldItem             The Item to be modified</span>
<a href="#l49.274"></a><span id="l49.274">    * @param aNewDate             The date at which the new item is going to start</span>
<a href="#l49.275"></a><span id="l49.275">    * @return                     The modified item</span>
<a href="#l49.276"></a><span id="l49.276">    */</span>
<a href="#l49.277"></a><span id="l49.277" class="difflineminus">-  moveToDate: function(aOldItem, aNewDate) {</span>
<a href="#l49.278"></a><span id="l49.278" class="difflineplus">+  moveToDate(aOldItem, aNewDate) {</span>
<a href="#l49.279"></a><span id="l49.279">     let newItem = aOldItem.clone();</span>
<a href="#l49.280"></a><span id="l49.280">     let start = (</span>
<a href="#l49.281"></a><span id="l49.281">       aOldItem[cal.dtz.startDateProp(aOldItem)] || aOldItem[cal.dtz.endDateProp(aOldItem)]</span>
<a href="#l49.282"></a><span id="l49.282">     ).clone();</span>
<a href="#l49.283"></a><span id="l49.283">     let isDate = start.isDate;</span>
<a href="#l49.284"></a><span id="l49.284">     start.resetTo(</span>
<a href="#l49.285"></a><span id="l49.285">       aNewDate.year,</span>
<a href="#l49.286"></a><span id="l49.286">       aNewDate.month,</span>
<a href="#l49.287"></a><span id="l49.287" class="difflineat">@@ -578,17 +578,17 @@ var calitem = {</span>
<a href="#l49.288"></a><span id="l49.288">       newItem[cal.dtz.endDateProp(newItem)] = start;</span>
<a href="#l49.289"></a><span id="l49.289">     }</span>
<a href="#l49.290"></a><span id="l49.290">     return newItem;</span>
<a href="#l49.291"></a><span id="l49.291">   },</span>
<a href="#l49.292"></a><span id="l49.292"> </span>
<a href="#l49.293"></a><span id="l49.293">   /**</span>
<a href="#l49.294"></a><span id="l49.294">    * Shortcut function to serialize an item (including all overridden items).</span>
<a href="#l49.295"></a><span id="l49.295">    */</span>
<a href="#l49.296"></a><span id="l49.296" class="difflineminus">-  serialize: function(aItem) {</span>
<a href="#l49.297"></a><span id="l49.297" class="difflineplus">+  serialize(aItem) {</span>
<a href="#l49.298"></a><span id="l49.298">     let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(</span>
<a href="#l49.299"></a><span id="l49.299">       Ci.calIIcsSerializer</span>
<a href="#l49.300"></a><span id="l49.300">     );</span>
<a href="#l49.301"></a><span id="l49.301">     serializer.addItems([aItem]);</span>
<a href="#l49.302"></a><span id="l49.302">     return serializer.serializeToString();</span>
<a href="#l49.303"></a><span id="l49.303">   },</span>
<a href="#l49.304"></a><span id="l49.304"> </span>
<a href="#l49.305"></a><span id="l49.305">   /**</span>
<a href="#l49.306"></a><span id="l49.306" class="difflineat">@@ -604,33 +604,33 @@ var calitem = {</span>
<a href="#l49.307"></a><span id="l49.307">   /**</span>
<a href="#l49.308"></a><span id="l49.308">    * This is a centralized function for setting the prodid and version on an</span>
<a href="#l49.309"></a><span id="l49.309">    * ical component.  This should be used whenever you need to set the prodid</span>
<a href="#l49.310"></a><span id="l49.310">    * and version on a calIcalComponent object.</span>
<a href="#l49.311"></a><span id="l49.311">    *</span>
<a href="#l49.312"></a><span id="l49.312">    * @param aIcalComponent        The ical component to set the prodid and</span>
<a href="#l49.313"></a><span id="l49.313">    *                                version on.</span>
<a href="#l49.314"></a><span id="l49.314">    */</span>
<a href="#l49.315"></a><span id="l49.315" class="difflineminus">-  setStaticProps: function(aIcalComponent) {</span>
<a href="#l49.316"></a><span id="l49.316" class="difflineplus">+  setStaticProps(aIcalComponent) {</span>
<a href="#l49.317"></a><span id="l49.317">     // Throw for an invalid parameter</span>
<a href="#l49.318"></a><span id="l49.318">     aIcalComponent = cal.wrapInstance(aIcalComponent, Ci.calIIcalComponent);</span>
<a href="#l49.319"></a><span id="l49.319">     if (!aIcalComponent) {</span>
<a href="#l49.320"></a><span id="l49.320">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l49.321"></a><span id="l49.321">     }</span>
<a href="#l49.322"></a><span id="l49.322">     // Set the prodid and version</span>
<a href="#l49.323"></a><span id="l49.323">     aIcalComponent.prodid = calitem.productId;</span>
<a href="#l49.324"></a><span id="l49.324">     aIcalComponent.version = calitem.productVersion;</span>
<a href="#l49.325"></a><span id="l49.325">   },</span>
<a href="#l49.326"></a><span id="l49.326"> </span>
<a href="#l49.327"></a><span id="l49.327">   /**</span>
<a href="#l49.328"></a><span id="l49.328">    * Search for already open item dialog.</span>
<a href="#l49.329"></a><span id="l49.329">    *</span>
<a href="#l49.330"></a><span id="l49.330">    * @param aItem     The item of the dialog to search for.</span>
<a href="#l49.331"></a><span id="l49.331">    */</span>
<a href="#l49.332"></a><span id="l49.332" class="difflineminus">-  findWindow: function(aItem) {</span>
<a href="#l49.333"></a><span id="l49.333" class="difflineplus">+  findWindow(aItem) {</span>
<a href="#l49.334"></a><span id="l49.334">     // check for existing dialog windows</span>
<a href="#l49.335"></a><span id="l49.335">     for (let dlg of Services.wm.getEnumerator(&quot;Calendar:EventDialog&quot;)) {</span>
<a href="#l49.336"></a><span id="l49.336">       if (</span>
<a href="#l49.337"></a><span id="l49.337">         dlg.arguments[0] &amp;&amp;</span>
<a href="#l49.338"></a><span id="l49.338">         dlg.arguments[0].mode == &quot;modify&quot; &amp;&amp;</span>
<a href="#l49.339"></a><span id="l49.339">         dlg.arguments[0].calendarEvent &amp;&amp;</span>
<a href="#l49.340"></a><span id="l49.340">         dlg.arguments[0].calendarEvent.hashId == aItem.hashId</span>
<a href="#l49.341"></a><span id="l49.341">       ) {</span>
<a href="#l49.342"></a><span id="l49.342" class="difflineat">@@ -648,45 +648,44 @@ var calitem = {</span>
<a href="#l49.343"></a><span id="l49.343"> </span>
<a href="#l49.344"></a><span id="l49.344">   /**</span>
<a href="#l49.345"></a><span id="l49.345">    * sets the 'isDate' property of an item</span>
<a href="#l49.346"></a><span id="l49.346">    *</span>
<a href="#l49.347"></a><span id="l49.347">    * @param aItem         The Item to be modified</span>
<a href="#l49.348"></a><span id="l49.348">    * @param aIsDate       True or false indicating the new value of 'isDate'</span>
<a href="#l49.349"></a><span id="l49.349">    * @return              The modified item</span>
<a href="#l49.350"></a><span id="l49.350">    */</span>
<a href="#l49.351"></a><span id="l49.351" class="difflineminus">-  setToAllDay: function(aItem, aIsDate) {</span>
<a href="#l49.352"></a><span id="l49.352" class="difflineplus">+  setToAllDay(aItem, aIsDate) {</span>
<a href="#l49.353"></a><span id="l49.353">     let start = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l49.354"></a><span id="l49.354">     let end = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l49.355"></a><span id="l49.355">     if (start || end) {</span>
<a href="#l49.356"></a><span id="l49.356">       let item = aItem.clone();</span>
<a href="#l49.357"></a><span id="l49.357">       if (start &amp;&amp; start.isDate != aIsDate) {</span>
<a href="#l49.358"></a><span id="l49.358">         start = start.clone();</span>
<a href="#l49.359"></a><span id="l49.359">         start.isDate = aIsDate;</span>
<a href="#l49.360"></a><span id="l49.360">         item[cal.dtz.startDateProp(item)] = start;</span>
<a href="#l49.361"></a><span id="l49.361">       }</span>
<a href="#l49.362"></a><span id="l49.362">       if (end &amp;&amp; end.isDate != aIsDate) {</span>
<a href="#l49.363"></a><span id="l49.363">         end = end.clone();</span>
<a href="#l49.364"></a><span id="l49.364">         end.isDate = aIsDate;</span>
<a href="#l49.365"></a><span id="l49.365">         item[cal.dtz.endDateProp(item)] = end;</span>
<a href="#l49.366"></a><span id="l49.366">       }</span>
<a href="#l49.367"></a><span id="l49.367">       return item;</span>
<a href="#l49.368"></a><span id="l49.368" class="difflineminus">-    } else {</span>
<a href="#l49.369"></a><span id="l49.369" class="difflineminus">-      return aItem;</span>
<a href="#l49.370"></a><span id="l49.370">     }</span>
<a href="#l49.371"></a><span id="l49.371" class="difflineplus">+    return aItem;</span>
<a href="#l49.372"></a><span id="l49.372">   },</span>
<a href="#l49.373"></a><span id="l49.373"> </span>
<a href="#l49.374"></a><span id="l49.374">   /**</span>
<a href="#l49.375"></a><span id="l49.375">    * This function return the progress state of a task:</span>
<a href="#l49.376"></a><span id="l49.376">    * completed, overdue, duetoday, inprogress, future</span>
<a href="#l49.377"></a><span id="l49.377">    *</span>
<a href="#l49.378"></a><span id="l49.378">    * @param aTask     The task to check.</span>
<a href="#l49.379"></a><span id="l49.379">    * @return          The progress atom.</span>
<a href="#l49.380"></a><span id="l49.380">    */</span>
<a href="#l49.381"></a><span id="l49.381" class="difflineminus">-  getProgressAtom: function(aTask) {</span>
<a href="#l49.382"></a><span id="l49.382" class="difflineplus">+  getProgressAtom(aTask) {</span>
<a href="#l49.383"></a><span id="l49.383">     let nowdate = new Date();</span>
<a href="#l49.384"></a><span id="l49.384"> </span>
<a href="#l49.385"></a><span id="l49.385">     if (aTask.recurrenceInfo) {</span>
<a href="#l49.386"></a><span id="l49.386">       return &quot;repeating&quot;;</span>
<a href="#l49.387"></a><span id="l49.387">     }</span>
<a href="#l49.388"></a><span id="l49.388"> </span>
<a href="#l49.389"></a><span id="l49.389">     if (aTask.isCompleted) {</span>
<a href="#l49.390"></a><span id="l49.390">       return &quot;completed&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/calendar/base/modules/utils/calIteratorUtils.jsm</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/calendar/base/modules/utils/calIteratorUtils.jsm</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -18,17 +18,17 @@ this.EXPORTED_SYMBOLS = [&quot;caliterate&quot;]; </span>
<a href="#l50.4"></a><span id="l50.4"> var caliterate = {</span>
<a href="#l50.5"></a><span id="l50.5">   /**</span>
<a href="#l50.6"></a><span id="l50.6">    * Iterates an array of items, i.e. the passed item including all</span>
<a href="#l50.7"></a><span id="l50.7">    * overridden instances of a recurring series.</span>
<a href="#l50.8"></a><span id="l50.8">    *</span>
<a href="#l50.9"></a><span id="l50.9">    * @param {calIItemBase[]} items        array of items to iterate</span>
<a href="#l50.10"></a><span id="l50.10">    * @yields {calIItemBase}</span>
<a href="#l50.11"></a><span id="l50.11">    */</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  items: function*(items) {</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+  *items(items) {</span>
<a href="#l50.14"></a><span id="l50.14">     for (let item of items) {</span>
<a href="#l50.15"></a><span id="l50.15">       yield item;</span>
<a href="#l50.16"></a><span id="l50.16">       let rec = item.recurrenceInfo;</span>
<a href="#l50.17"></a><span id="l50.17">       if (rec) {</span>
<a href="#l50.18"></a><span id="l50.18">         for (let exid of rec.getExceptionIds()) {</span>
<a href="#l50.19"></a><span id="l50.19">           yield rec.getExceptionFor(exid);</span>
<a href="#l50.20"></a><span id="l50.20">         }</span>
<a href="#l50.21"></a><span id="l50.21">       }</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineat">@@ -63,17 +63,17 @@ var caliterate = {</span>
<a href="#l50.23"></a><span id="l50.23">         iterable = Object.entries(iterable);</span>
<a href="#l50.24"></a><span id="l50.24">       }</span>
<a href="#l50.25"></a><span id="l50.25"> </span>
<a href="#l50.26"></a><span id="l50.26">       let ourIter = iterable[Symbol.iterator]();</span>
<a href="#l50.27"></a><span id="l50.27">       let currentThread = Services.tm.currentThread;</span>
<a href="#l50.28"></a><span id="l50.28"> </span>
<a href="#l50.29"></a><span id="l50.29">       // This is our dispatcher, it will be used for the iterations</span>
<a href="#l50.30"></a><span id="l50.30">       let dispatcher = {</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-        run: function() {</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineplus">+        run() {</span>
<a href="#l50.33"></a><span id="l50.33">           let startTime = new Date().getTime();</span>
<a href="#l50.34"></a><span id="l50.34">           while (new Date().getTime() - startTime &lt; LATENCY) {</span>
<a href="#l50.35"></a><span id="l50.35">             let next = ourIter.next();</span>
<a href="#l50.36"></a><span id="l50.36">             let done = next.done;</span>
<a href="#l50.37"></a><span id="l50.37"> </span>
<a href="#l50.38"></a><span id="l50.38">             if (!done) {</span>
<a href="#l50.39"></a><span id="l50.39">               let rc = body(next.value);</span>
<a href="#l50.40"></a><span id="l50.40">               if (rc == cal.iterate.forEach.BREAK) {</span>
<a href="#l50.41"></a><span id="l50.41" class="difflineat">@@ -111,17 +111,17 @@ var caliterate = {</span>
<a href="#l50.42"></a><span id="l50.42">    *</span>
<a href="#l50.43"></a><span id="l50.43">    * This iterator can only be used in a for..of block:</span>
<a href="#l50.44"></a><span id="l50.44">    *   for (let component of cal.iterate.icalComponent(aComp)) { ... }</span>
<a href="#l50.45"></a><span id="l50.45">    *</span>
<a href="#l50.46"></a><span id="l50.46">    *  @param {calIIcalComponent} aComponent   The component to iterate given the above rules.</span>
<a href="#l50.47"></a><span id="l50.47">    *  @param {String} aCompType               The type of item to iterate.</span>
<a href="#l50.48"></a><span id="l50.48">    *  @yields {calIIcalComponent}             The iterator that yields all items.</span>
<a href="#l50.49"></a><span id="l50.49">    */</span>
<a href="#l50.50"></a><span id="l50.50" class="difflineminus">-  icalComponent: function*(aComponent, aCompType = &quot;ANY&quot;) {</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineplus">+  *icalComponent(aComponent, aCompType = &quot;ANY&quot;) {</span>
<a href="#l50.52"></a><span id="l50.52">     if (aComponent &amp;&amp; aComponent.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l50.53"></a><span id="l50.53">       yield* cal.iterate.icalSubcomponent(aComponent, aCompType);</span>
<a href="#l50.54"></a><span id="l50.54">     } else if (aComponent &amp;&amp; aComponent.componentType == &quot;XROOT&quot;) {</span>
<a href="#l50.55"></a><span id="l50.55">       for (let calComp of cal.iterate.icalSubcomponent(aComponent, &quot;VCALENDAR&quot;)) {</span>
<a href="#l50.56"></a><span id="l50.56">         yield* cal.iterate.icalSubcomponent(calComp, aCompType);</span>
<a href="#l50.57"></a><span id="l50.57">       }</span>
<a href="#l50.58"></a><span id="l50.58">     } else if (aComponent &amp;&amp; (aCompType == &quot;ANY&quot; || aCompType == aComponent.componentType)) {</span>
<a href="#l50.59"></a><span id="l50.59">       yield aComponent;</span>
<a href="#l50.60"></a><span id="l50.60" class="difflineat">@@ -135,17 +135,17 @@ var caliterate = {</span>
<a href="#l50.61"></a><span id="l50.61">    * This iterator can only be used in a for() block:</span>
<a href="#l50.62"></a><span id="l50.62">    *   for (let component of cal.iterate.icalSubcomponent(aComp)) { ... }</span>
<a href="#l50.63"></a><span id="l50.63">    *</span>
<a href="#l50.64"></a><span id="l50.64">    * @param {calIIcalComponent} aComponent    The component who's subcomponents to iterate.</span>
<a href="#l50.65"></a><span id="l50.65">    * @param {?String} aSubcomp                (optional) the specific subcomponent to enumerate.</span>
<a href="#l50.66"></a><span id="l50.66">    *                                            If not given, &quot;ANY&quot; will be used.</span>
<a href="#l50.67"></a><span id="l50.67">    * @yields {calIIcalComponent}              An iterator object to iterate the properties.</span>
<a href="#l50.68"></a><span id="l50.68">    */</span>
<a href="#l50.69"></a><span id="l50.69" class="difflineminus">-  icalSubcomponent: function*(aComponent, aSubcomp = &quot;ANY&quot;) {</span>
<a href="#l50.70"></a><span id="l50.70" class="difflineplus">+  *icalSubcomponent(aComponent, aSubcomp = &quot;ANY&quot;) {</span>
<a href="#l50.71"></a><span id="l50.71">     for (</span>
<a href="#l50.72"></a><span id="l50.72">       let subcomp = aComponent.getFirstSubcomponent(aSubcomp);</span>
<a href="#l50.73"></a><span id="l50.73">       subcomp;</span>
<a href="#l50.74"></a><span id="l50.74">       subcomp = aComponent.getNextSubcomponent(aSubcomp)</span>
<a href="#l50.75"></a><span id="l50.75">     ) {</span>
<a href="#l50.76"></a><span id="l50.76">       yield subcomp;</span>
<a href="#l50.77"></a><span id="l50.77">     }</span>
<a href="#l50.78"></a><span id="l50.78">   },</span>
<a href="#l50.79"></a><span id="l50.79" class="difflineat">@@ -155,17 +155,17 @@ var caliterate = {</span>
<a href="#l50.80"></a><span id="l50.80">    * This iterator can only be used in a for() block:</span>
<a href="#l50.81"></a><span id="l50.81">    *   for (let property of cal.iterate.icalProperty(aComp)) { ... }</span>
<a href="#l50.82"></a><span id="l50.82">    *</span>
<a href="#l50.83"></a><span id="l50.83">    * @param {calIIcalComponent} aComponent    The component to iterate.</span>
<a href="#l50.84"></a><span id="l50.84">    * @param {?String} aProperty               (optional) the specific property to enumerate.</span>
<a href="#l50.85"></a><span id="l50.85">    *                                            If not given, &quot;ANY&quot; will be used.</span>
<a href="#l50.86"></a><span id="l50.86">    * @yields {calIIcalProperty}               An iterator object to iterate the properties.</span>
<a href="#l50.87"></a><span id="l50.87">    */</span>
<a href="#l50.88"></a><span id="l50.88" class="difflineminus">-  icalProperty: function*(aComponent, aProperty = &quot;ANY&quot;) {</span>
<a href="#l50.89"></a><span id="l50.89" class="difflineplus">+  *icalProperty(aComponent, aProperty = &quot;ANY&quot;) {</span>
<a href="#l50.90"></a><span id="l50.90">     for (</span>
<a href="#l50.91"></a><span id="l50.91">       let prop = aComponent.getFirstProperty(aProperty);</span>
<a href="#l50.92"></a><span id="l50.92">       prop;</span>
<a href="#l50.93"></a><span id="l50.93">       prop = aComponent.getNextProperty(aProperty)</span>
<a href="#l50.94"></a><span id="l50.94">     ) {</span>
<a href="#l50.95"></a><span id="l50.95">       yield prop;</span>
<a href="#l50.96"></a><span id="l50.96">     }</span>
<a href="#l50.97"></a><span id="l50.97">   },</span>
<a href="#l50.98"></a><span id="l50.98" class="difflineat">@@ -175,17 +175,17 @@ var caliterate = {</span>
<a href="#l50.99"></a><span id="l50.99">    * This iterator behaves similar to the object iterator. Possible uses:</span>
<a href="#l50.100"></a><span id="l50.100">    *   for (let paramName in cal.iterate.icalParameter(prop)) { ... }</span>
<a href="#l50.101"></a><span id="l50.101">    * or:</span>
<a href="#l50.102"></a><span id="l50.102">    *   for (let [paramName, paramValue] of cal.iterate.icalParameter(prop)) { ... }</span>
<a href="#l50.103"></a><span id="l50.103">    *</span>
<a href="#l50.104"></a><span id="l50.104">    * @param {calIIcalProperty} aProperty         The property to iterate.</span>
<a href="#l50.105"></a><span id="l50.105">    * @yields {[String, String]}                  An iterator object to iterate the properties.</span>
<a href="#l50.106"></a><span id="l50.106">    */</span>
<a href="#l50.107"></a><span id="l50.107" class="difflineminus">-  icalParameter: function*(aProperty) {</span>
<a href="#l50.108"></a><span id="l50.108" class="difflineplus">+  *icalParameter(aProperty) {</span>
<a href="#l50.109"></a><span id="l50.109">     let paramSet = new Set();</span>
<a href="#l50.110"></a><span id="l50.110">     for (</span>
<a href="#l50.111"></a><span id="l50.111">       let paramName = aProperty.getFirstParameterName();</span>
<a href="#l50.112"></a><span id="l50.112">       paramName;</span>
<a href="#l50.113"></a><span id="l50.113">       paramName = aProperty.getNextParameterName()</span>
<a href="#l50.114"></a><span id="l50.114">     ) {</span>
<a href="#l50.115"></a><span id="l50.115">       // Workaround to avoid infinite loop when the property</span>
<a href="#l50.116"></a><span id="l50.116">       // contains duplicate parameters (bug 875739 for libical)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/calendar/base/modules/utils/calItipUtils.jsm</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -20,17 +20,17 @@ var calitip = {</span>
<a href="#l51.4"></a><span id="l51.4">   /**</span>
<a href="#l51.5"></a><span id="l51.5">    * Gets the sequence/revision number, either of the passed item or the last received one of an</span>
<a href="#l51.6"></a><span id="l51.6">    * attendee; see &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.1&gt;.</span>
<a href="#l51.7"></a><span id="l51.7">    *</span>
<a href="#l51.8"></a><span id="l51.8">    * @param {calIAttendee|calIItemBase} aItem     The item or attendee to get the sequence info</span>
<a href="#l51.9"></a><span id="l51.9">    *                                                from.</span>
<a href="#l51.10"></a><span id="l51.10">    * @return {Number}                             The sequence number</span>
<a href="#l51.11"></a><span id="l51.11">    */</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  getSequence: function(aItem) {</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  getSequence(aItem) {</span>
<a href="#l51.14"></a><span id="l51.14">     let seq = null;</span>
<a href="#l51.15"></a><span id="l51.15"> </span>
<a href="#l51.16"></a><span id="l51.16">     let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l51.17"></a><span id="l51.17">     if (wrappedItem) {</span>
<a href="#l51.18"></a><span id="l51.18">       seq = wrappedItem.getProperty(&quot;RECEIVED-SEQUENCE&quot;);</span>
<a href="#l51.19"></a><span id="l51.19">     } else if (aItem) {</span>
<a href="#l51.20"></a><span id="l51.20">       // Unless the below is standardized, we store the last original</span>
<a href="#l51.21"></a><span id="l51.21">       // REQUEST/PUBLISH SEQUENCE in X-MOZ-RECEIVED-SEQUENCE to test against it</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineat">@@ -44,30 +44,29 @@ var calitip = {</span>
<a href="#l51.23"></a><span id="l51.23">       // use Microsoft's Sequence number. I &lt;3 MS</span>
<a href="#l51.24"></a><span id="l51.24">       if (seq === null || seq == &quot;0&quot;) {</span>
<a href="#l51.25"></a><span id="l51.25">         seq = aItem.getProperty(&quot;X-MICROSOFT-CDO-APPT-SEQUENCE&quot;);</span>
<a href="#l51.26"></a><span id="l51.26">       }</span>
<a href="#l51.27"></a><span id="l51.27">     }</span>
<a href="#l51.28"></a><span id="l51.28"> </span>
<a href="#l51.29"></a><span id="l51.29">     if (seq === null) {</span>
<a href="#l51.30"></a><span id="l51.30">       return 0;</span>
<a href="#l51.31"></a><span id="l51.31" class="difflineminus">-    } else {</span>
<a href="#l51.32"></a><span id="l51.32" class="difflineminus">-      seq = parseInt(seq, 10);</span>
<a href="#l51.33"></a><span id="l51.33" class="difflineminus">-      return isNaN(seq) ? 0 : seq;</span>
<a href="#l51.34"></a><span id="l51.34">     }</span>
<a href="#l51.35"></a><span id="l51.35" class="difflineplus">+    seq = parseInt(seq, 10);</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+    return isNaN(seq) ? 0 : seq;</span>
<a href="#l51.37"></a><span id="l51.37">   },</span>
<a href="#l51.38"></a><span id="l51.38"> </span>
<a href="#l51.39"></a><span id="l51.39">   /**</span>
<a href="#l51.40"></a><span id="l51.40">    * Gets the stamp date-time, either of the passed item or the last received one of an attendee;</span>
<a href="#l51.41"></a><span id="l51.41">    * see &lt;http://tools.ietf.org/html/draft-desruisseaux-caldav-sched-04#section-7.2&gt;.</span>
<a href="#l51.42"></a><span id="l51.42">    *</span>
<a href="#l51.43"></a><span id="l51.43">    * @param {calIAttendee|calIItemBase} aItem     The item or attendee to retrieve the stamp from</span>
<a href="#l51.44"></a><span id="l51.44">    * @return {calIDateTime}                       The timestamp for the item</span>
<a href="#l51.45"></a><span id="l51.45">    */</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineminus">-  getStamp: function(aItem) {</span>
<a href="#l51.47"></a><span id="l51.47" class="difflineplus">+  getStamp(aItem) {</span>
<a href="#l51.48"></a><span id="l51.48">     let dtstamp = null;</span>
<a href="#l51.49"></a><span id="l51.49"> </span>
<a href="#l51.50"></a><span id="l51.50">     let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l51.51"></a><span id="l51.51">     if (wrappedItem) {</span>
<a href="#l51.52"></a><span id="l51.52">       let stamp = wrappedItem.getProperty(&quot;RECEIVED-DTSTAMP&quot;);</span>
<a href="#l51.53"></a><span id="l51.53">       if (stamp) {</span>
<a href="#l51.54"></a><span id="l51.54">         dtstamp = cal.createDateTime(stamp);</span>
<a href="#l51.55"></a><span id="l51.55">       }</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineat">@@ -90,91 +89,89 @@ var calitip = {</span>
<a href="#l51.57"></a><span id="l51.57">   /**</span>
<a href="#l51.58"></a><span id="l51.58">    * Compares sequences and/or stamps of two items</span>
<a href="#l51.59"></a><span id="l51.59">    *</span>
<a href="#l51.60"></a><span id="l51.60">    * @param {calIItemBase|calIAttendee} aItem1        The first item to compare</span>
<a href="#l51.61"></a><span id="l51.61">    * @param {calIItemBase|calIAttendee} aItem2        The second item to compare</span>
<a href="#l51.62"></a><span id="l51.62">    * @return {Number}                                 +1 if item2 is newer, -1 if item1 is newer</span>
<a href="#l51.63"></a><span id="l51.63">    *                                                    or 0 if both are equal</span>
<a href="#l51.64"></a><span id="l51.64">    */</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineminus">-  compare: function(aItem1, aItem2) {</span>
<a href="#l51.66"></a><span id="l51.66" class="difflineplus">+  compare(aItem1, aItem2) {</span>
<a href="#l51.67"></a><span id="l51.67">     let comp = calitip.compareSequence(aItem1, aItem2);</span>
<a href="#l51.68"></a><span id="l51.68">     if (comp == 0) {</span>
<a href="#l51.69"></a><span id="l51.69">       comp = calitip.compareStamp(aItem1, aItem2);</span>
<a href="#l51.70"></a><span id="l51.70">     }</span>
<a href="#l51.71"></a><span id="l51.71">     return comp;</span>
<a href="#l51.72"></a><span id="l51.72">   },</span>
<a href="#l51.73"></a><span id="l51.73"> </span>
<a href="#l51.74"></a><span id="l51.74">   /**</span>
<a href="#l51.75"></a><span id="l51.75">    * Compares sequences of two items</span>
<a href="#l51.76"></a><span id="l51.76">    *</span>
<a href="#l51.77"></a><span id="l51.77">    * @param {calIItemBase|calIAttendee} aItem1        The first item to compare</span>
<a href="#l51.78"></a><span id="l51.78">    * @param {calIItemBase|calIAttendee} aItem2        The second item to compare</span>
<a href="#l51.79"></a><span id="l51.79">    * @return {Number}                                 +1 if item2 is newer, -1 if item1 is newer</span>
<a href="#l51.80"></a><span id="l51.80">    *                                                    or 0 if both are equal</span>
<a href="#l51.81"></a><span id="l51.81">    */</span>
<a href="#l51.82"></a><span id="l51.82" class="difflineminus">-  compareSequence: function(aItem1, aItem2) {</span>
<a href="#l51.83"></a><span id="l51.83" class="difflineplus">+  compareSequence(aItem1, aItem2) {</span>
<a href="#l51.84"></a><span id="l51.84">     let seq1 = calitip.getSequence(aItem1);</span>
<a href="#l51.85"></a><span id="l51.85">     let seq2 = calitip.getSequence(aItem2);</span>
<a href="#l51.86"></a><span id="l51.86">     if (seq1 &gt; seq2) {</span>
<a href="#l51.87"></a><span id="l51.87">       return 1;</span>
<a href="#l51.88"></a><span id="l51.88">     } else if (seq1 &lt; seq2) {</span>
<a href="#l51.89"></a><span id="l51.89">       return -1;</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineminus">-    } else {</span>
<a href="#l51.91"></a><span id="l51.91" class="difflineminus">-      return 0;</span>
<a href="#l51.92"></a><span id="l51.92">     }</span>
<a href="#l51.93"></a><span id="l51.93" class="difflineplus">+    return 0;</span>
<a href="#l51.94"></a><span id="l51.94">   },</span>
<a href="#l51.95"></a><span id="l51.95"> </span>
<a href="#l51.96"></a><span id="l51.96">   /**</span>
<a href="#l51.97"></a><span id="l51.97">    * Compares stamp of two items</span>
<a href="#l51.98"></a><span id="l51.98">    *</span>
<a href="#l51.99"></a><span id="l51.99">    * @param {calIItemBase|calIAttendee} aItem1        The first item to compare</span>
<a href="#l51.100"></a><span id="l51.100">    * @param {calIItemBase|calIAttendee} aItem2        The second item to compare</span>
<a href="#l51.101"></a><span id="l51.101">    * @return {Number}                                 +1 if item2 is newer, -1 if item1 is newer</span>
<a href="#l51.102"></a><span id="l51.102">    *                                                    or 0 if both are equal</span>
<a href="#l51.103"></a><span id="l51.103">    */</span>
<a href="#l51.104"></a><span id="l51.104" class="difflineminus">-  compareStamp: function(aItem1, aItem2) {</span>
<a href="#l51.105"></a><span id="l51.105" class="difflineplus">+  compareStamp(aItem1, aItem2) {</span>
<a href="#l51.106"></a><span id="l51.106">     let st1 = calitip.getStamp(aItem1);</span>
<a href="#l51.107"></a><span id="l51.107">     let st2 = calitip.getStamp(aItem2);</span>
<a href="#l51.108"></a><span id="l51.108">     if (st1 &amp;&amp; st2) {</span>
<a href="#l51.109"></a><span id="l51.109">       return st1.compare(st2);</span>
<a href="#l51.110"></a><span id="l51.110">     } else if (!st1 &amp;&amp; st2) {</span>
<a href="#l51.111"></a><span id="l51.111">       return -1;</span>
<a href="#l51.112"></a><span id="l51.112">     } else if (st1 &amp;&amp; !st2) {</span>
<a href="#l51.113"></a><span id="l51.113">       return 1;</span>
<a href="#l51.114"></a><span id="l51.114" class="difflineminus">-    } else {</span>
<a href="#l51.115"></a><span id="l51.115" class="difflineminus">-      return 0;</span>
<a href="#l51.116"></a><span id="l51.116">     }</span>
<a href="#l51.117"></a><span id="l51.117" class="difflineplus">+    return 0;</span>
<a href="#l51.118"></a><span id="l51.118">   },</span>
<a href="#l51.119"></a><span id="l51.119"> </span>
<a href="#l51.120"></a><span id="l51.120">   /**</span>
<a href="#l51.121"></a><span id="l51.121">    * Checks if the given calendar is a scheduling calendar. This means it</span>
<a href="#l51.122"></a><span id="l51.122">    * needs an organizer id and an itip transport. It should also be writable.</span>
<a href="#l51.123"></a><span id="l51.123">    *</span>
<a href="#l51.124"></a><span id="l51.124">    * @param {calICalendar} aCalendar      The calendar to check</span>
<a href="#l51.125"></a><span id="l51.125">    * @return {Boolean}                    True, if its a scheduling calendar.</span>
<a href="#l51.126"></a><span id="l51.126">    */</span>
<a href="#l51.127"></a><span id="l51.127" class="difflineminus">-  isSchedulingCalendar: function(aCalendar) {</span>
<a href="#l51.128"></a><span id="l51.128" class="difflineplus">+  isSchedulingCalendar(aCalendar) {</span>
<a href="#l51.129"></a><span id="l51.129">     return (</span>
<a href="#l51.130"></a><span id="l51.130">       cal.acl.isCalendarWritable(aCalendar) &amp;&amp;</span>
<a href="#l51.131"></a><span id="l51.131">       aCalendar.getProperty(&quot;organizerId&quot;) &amp;&amp;</span>
<a href="#l51.132"></a><span id="l51.132">       aCalendar.getProperty(&quot;itip.transport&quot;)</span>
<a href="#l51.133"></a><span id="l51.133">     );</span>
<a href="#l51.134"></a><span id="l51.134">   },</span>
<a href="#l51.135"></a><span id="l51.135"> </span>
<a href="#l51.136"></a><span id="l51.136">   /**</span>
<a href="#l51.137"></a><span id="l51.137">    * Scope: iTIP message receiver</span>
<a href="#l51.138"></a><span id="l51.138">    *</span>
<a href="#l51.139"></a><span id="l51.139">    * Given an nsIMsgDBHdr and an imipMethod, set up the given itip item.</span>
<a href="#l51.140"></a><span id="l51.140">    *</span>
<a href="#l51.141"></a><span id="l51.141">    * @param {calIItemBase} itipItem   The item to set up</span>
<a href="#l51.142"></a><span id="l51.142">    * @param {String} imipMethod       The received imip method</span>
<a href="#l51.143"></a><span id="l51.143">    * @param {nsIMsgDBHdr} aMsgHdr     Information about the received email</span>
<a href="#l51.144"></a><span id="l51.144">    */</span>
<a href="#l51.145"></a><span id="l51.145" class="difflineminus">-  initItemFromMsgData: function(itipItem, imipMethod, aMsgHdr) {</span>
<a href="#l51.146"></a><span id="l51.146" class="difflineplus">+  initItemFromMsgData(itipItem, imipMethod, aMsgHdr) {</span>
<a href="#l51.147"></a><span id="l51.147">     // set the sender of the itip message</span>
<a href="#l51.148"></a><span id="l51.148">     itipItem.sender = calitip.getMessageSender(aMsgHdr);</span>
<a href="#l51.149"></a><span id="l51.149"> </span>
<a href="#l51.150"></a><span id="l51.150">     // Get the recipient identity and save it with the itip item.</span>
<a href="#l51.151"></a><span id="l51.151">     itipItem.identity = calitip.getMessageRecipient(aMsgHdr);</span>
<a href="#l51.152"></a><span id="l51.152"> </span>
<a href="#l51.153"></a><span id="l51.153">     // We are only called upon receipt of an invite, so ensure that isSend</span>
<a href="#l51.154"></a><span id="l51.154">     // is false.</span>
<a href="#l51.155"></a><span id="l51.155" class="difflineat">@@ -217,17 +214,17 @@ var calitip = {</span>
<a href="#l51.156"></a><span id="l51.156">    *</span>
<a href="#l51.157"></a><span id="l51.157">    * Gets the suggested text to be shown when an imip item has been processed.</span>
<a href="#l51.158"></a><span id="l51.158">    * This text is ready localized and can be displayed to the user.</span>
<a href="#l51.159"></a><span id="l51.159">    *</span>
<a href="#l51.160"></a><span id="l51.160">    * @param {Number} aStatus         The status of the processing (i.e NS_OK, an error code)</span>
<a href="#l51.161"></a><span id="l51.161">    * @param {Number} aOperationType  An operation type from calIOperationListener</span>
<a href="#l51.162"></a><span id="l51.162">    * @return {String}                The suggested text.</span>
<a href="#l51.163"></a><span id="l51.163">    */</span>
<a href="#l51.164"></a><span id="l51.164" class="difflineminus">-  getCompleteText: function(aStatus, aOperationType) {</span>
<a href="#l51.165"></a><span id="l51.165" class="difflineplus">+  getCompleteText(aStatus, aOperationType) {</span>
<a href="#l51.166"></a><span id="l51.166">     let text = &quot;&quot;;</span>
<a href="#l51.167"></a><span id="l51.167">     const cIOL = Ci.calIOperationListener;</span>
<a href="#l51.168"></a><span id="l51.168">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l51.169"></a><span id="l51.169">       switch (aOperationType) {</span>
<a href="#l51.170"></a><span id="l51.170">         case cIOL.ADD:</span>
<a href="#l51.171"></a><span id="l51.171">           text = cal.l10n.getLtnString(&quot;imipAddedItemToCal2&quot;);</span>
<a href="#l51.172"></a><span id="l51.172">           break;</span>
<a href="#l51.173"></a><span id="l51.173">         case cIOL.MODIFY:</span>
<a href="#l51.174"></a><span id="l51.174" class="difflineat">@@ -247,17 +244,17 @@ var calitip = {</span>
<a href="#l51.175"></a><span id="l51.175">    * Scope: iTIP message receiver</span>
<a href="#l51.176"></a><span id="l51.176">    *</span>
<a href="#l51.177"></a><span id="l51.177">    * Gets a text describing the given itip method. The text is of the form</span>
<a href="#l51.178"></a><span id="l51.178">    * &quot;This Message contains a ... &quot;.</span>
<a href="#l51.179"></a><span id="l51.179">    *</span>
<a href="#l51.180"></a><span id="l51.180">    * @param {String} method      The method to describe.</span>
<a href="#l51.181"></a><span id="l51.181">    * @return {String}            The localized text about the method.</span>
<a href="#l51.182"></a><span id="l51.182">    */</span>
<a href="#l51.183"></a><span id="l51.183" class="difflineminus">-  getMethodText: function(method) {</span>
<a href="#l51.184"></a><span id="l51.184" class="difflineplus">+  getMethodText(method) {</span>
<a href="#l51.185"></a><span id="l51.185">     switch (method) {</span>
<a href="#l51.186"></a><span id="l51.186">       case &quot;REFRESH&quot;:</span>
<a href="#l51.187"></a><span id="l51.187">         return cal.l10n.getLtnString(&quot;imipBarRefreshText&quot;);</span>
<a href="#l51.188"></a><span id="l51.188">       case &quot;REQUEST&quot;:</span>
<a href="#l51.189"></a><span id="l51.189">         return cal.l10n.getLtnString(&quot;imipBarRequestText&quot;);</span>
<a href="#l51.190"></a><span id="l51.190">       case &quot;PUBLISH&quot;:</span>
<a href="#l51.191"></a><span id="l51.191">         return cal.l10n.getLtnString(&quot;imipBarPublishText&quot;);</span>
<a href="#l51.192"></a><span id="l51.192">       case &quot;CANCEL&quot;:</span>
<a href="#l51.193"></a><span id="l51.193" class="difflineat">@@ -289,17 +286,17 @@ var calitip = {</span>
<a href="#l51.194"></a><span id="l51.194">    * @see processItipItem   This takes the same parameters as its optionFunc.</span>
<a href="#l51.195"></a><span id="l51.195">    * @param {calIItipItem} itipItem       The itipItem to query.</span>
<a href="#l51.196"></a><span id="l51.196">    * @param {Number} rc                   The result of retrieving the item</span>
<a href="#l51.197"></a><span id="l51.197">    * @param {Function} actionFunc         The action function.</span>
<a href="#l51.198"></a><span id="l51.198">    * @param {calIItemBase[]} foundItems   An array of items found while searching for the item</span>
<a href="#l51.199"></a><span id="l51.199">    *                                        in subscribed calendars</span>
<a href="#l51.200"></a><span id="l51.200">    * @return {Object}                     Return information about the options</span>
<a href="#l51.201"></a><span id="l51.201">    */</span>
<a href="#l51.202"></a><span id="l51.202" class="difflineminus">-  getOptionsText: function(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineplus">+  getOptionsText(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l51.204"></a><span id="l51.204">     let imipLabel = null;</span>
<a href="#l51.205"></a><span id="l51.205">     if (itipItem.receivedMethod) {</span>
<a href="#l51.206"></a><span id="l51.206">       imipLabel = calitip.getMethodText(itipItem.receivedMethod);</span>
<a href="#l51.207"></a><span id="l51.207">     }</span>
<a href="#l51.208"></a><span id="l51.208">     let data = { label: imipLabel, showItems: [], hideItems: [] };</span>
<a href="#l51.209"></a><span id="l51.209">     let separateButtons = Services.prefs.getBoolPref(</span>
<a href="#l51.210"></a><span id="l51.210">       &quot;calendar.itip.separateInvitationButtons&quot;,</span>
<a href="#l51.211"></a><span id="l51.211">       false</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineat">@@ -470,17 +467,17 @@ var calitip = {</span>
<a href="#l51.213"></a><span id="l51.213"> </span>
<a href="#l51.214"></a><span id="l51.214">   /**</span>
<a href="#l51.215"></a><span id="l51.215">    * Scope: iTIP message receiver</span>
<a href="#l51.216"></a><span id="l51.216">    * Retrieves the message sender.</span>
<a href="#l51.217"></a><span id="l51.217">    *</span>
<a href="#l51.218"></a><span id="l51.218">    * @param {nsIMsgDBHdr} aMsgHdr     The message header to check.</span>
<a href="#l51.219"></a><span id="l51.219">    * @return {String}                 The email address of the intended recipient.</span>
<a href="#l51.220"></a><span id="l51.220">    */</span>
<a href="#l51.221"></a><span id="l51.221" class="difflineminus">-  getMessageSender: function(aMsgHdr) {</span>
<a href="#l51.222"></a><span id="l51.222" class="difflineplus">+  getMessageSender(aMsgHdr) {</span>
<a href="#l51.223"></a><span id="l51.223">     let author = (aMsgHdr &amp;&amp; aMsgHdr.author) || &quot;&quot;;</span>
<a href="#l51.224"></a><span id="l51.224">     let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(</span>
<a href="#l51.225"></a><span id="l51.225">       Ci.nsIMsgCompFields</span>
<a href="#l51.226"></a><span id="l51.226">     );</span>
<a href="#l51.227"></a><span id="l51.227">     let addresses = compFields.splitRecipients(author, true);</span>
<a href="#l51.228"></a><span id="l51.228">     if (addresses.length != 1) {</span>
<a href="#l51.229"></a><span id="l51.229">       cal.LOG(&quot;No unique email address for lookup in message.\r\n&quot; + cal.STACK(20));</span>
<a href="#l51.230"></a><span id="l51.230">     }</span>
<a href="#l51.231"></a><span id="l51.231" class="difflineat">@@ -490,17 +487,17 @@ var calitip = {</span>
<a href="#l51.232"></a><span id="l51.232">   /**</span>
<a href="#l51.233"></a><span id="l51.233">    * Scope: iTIP message receiver</span>
<a href="#l51.234"></a><span id="l51.234">    *</span>
<a href="#l51.235"></a><span id="l51.235">    * Retrieves the intended recipient for this message.</span>
<a href="#l51.236"></a><span id="l51.236">    *</span>
<a href="#l51.237"></a><span id="l51.237">    * @param {nsIMsgDBHdr} aMsgHdr     The message to check.</span>
<a href="#l51.238"></a><span id="l51.238">    * @return {String}                 The email of the intended recipient.</span>
<a href="#l51.239"></a><span id="l51.239">    */</span>
<a href="#l51.240"></a><span id="l51.240" class="difflineminus">-  getMessageRecipient: function(aMsgHdr) {</span>
<a href="#l51.241"></a><span id="l51.241" class="difflineplus">+  getMessageRecipient(aMsgHdr) {</span>
<a href="#l51.242"></a><span id="l51.242">     if (!aMsgHdr) {</span>
<a href="#l51.243"></a><span id="l51.243">       return null;</span>
<a href="#l51.244"></a><span id="l51.244">     }</span>
<a href="#l51.245"></a><span id="l51.245"> </span>
<a href="#l51.246"></a><span id="l51.246">     let identities;</span>
<a href="#l51.247"></a><span id="l51.247">     let actMgr = MailServices.accounts;</span>
<a href="#l51.248"></a><span id="l51.248">     if (aMsgHdr.accountKey) {</span>
<a href="#l51.249"></a><span id="l51.249">       // First, check if the message has an account key. If so, we can use the</span>
<a href="#l51.250"></a><span id="l51.250" class="difflineat">@@ -569,17 +566,17 @@ var calitip = {</span>
<a href="#l51.251"></a><span id="l51.251">    * Prompt for the target calendar, if needed for the given method. This calendar will be set on</span>
<a href="#l51.252"></a><span id="l51.252">    * the passed itip item.</span>
<a href="#l51.253"></a><span id="l51.253">    *</span>
<a href="#l51.254"></a><span id="l51.254">    * @param {String} aMethod          The method to check.</span>
<a href="#l51.255"></a><span id="l51.255">    * @param {calIItipItem} aItipItem  The itip item to set the target calendar on.</span>
<a href="#l51.256"></a><span id="l51.256">    * @param {DOMWindpw} aWindow       The window to open the dialog on.</span>
<a href="#l51.257"></a><span id="l51.257">    * @return {Boolean}                True, if a calendar was selected or no selection is needed.</span>
<a href="#l51.258"></a><span id="l51.258">    */</span>
<a href="#l51.259"></a><span id="l51.259" class="difflineminus">-  promptCalendar: function(aMethod, aItipItem, aWindow) {</span>
<a href="#l51.260"></a><span id="l51.260" class="difflineplus">+  promptCalendar(aMethod, aItipItem, aWindow) {</span>
<a href="#l51.261"></a><span id="l51.261">     let needsCalendar = false;</span>
<a href="#l51.262"></a><span id="l51.262">     let targetCalendar = null;</span>
<a href="#l51.263"></a><span id="l51.263">     switch (aMethod) {</span>
<a href="#l51.264"></a><span id="l51.264">       // methods that don't require the calendar chooser:</span>
<a href="#l51.265"></a><span id="l51.265">       case &quot;REFRESH&quot;:</span>
<a href="#l51.266"></a><span id="l51.266">       case &quot;REQUEST:UPDATE&quot;:</span>
<a href="#l51.267"></a><span id="l51.267">       case &quot;REQUEST:UPDATE-MINOR&quot;:</span>
<a href="#l51.268"></a><span id="l51.268">       case &quot;PUBLISH:UPDATE&quot;:</span>
<a href="#l51.269"></a><span id="l51.269" class="difflineat">@@ -646,17 +643,17 @@ var calitip = {</span>
<a href="#l51.270"></a><span id="l51.270"> </span>
<a href="#l51.271"></a><span id="l51.271">   /**</span>
<a href="#l51.272"></a><span id="l51.272">    * Clean up after the given iTIP item. This needs to be called once for each time</span>
<a href="#l51.273"></a><span id="l51.273">    * processItipItem is called. May be called with a null itipItem in which case it will do</span>
<a href="#l51.274"></a><span id="l51.274">    * nothing.</span>
<a href="#l51.275"></a><span id="l51.275">    *</span>
<a href="#l51.276"></a><span id="l51.276">    * @param {calIItipItem} itipItem      The iTIP item to clean up for.</span>
<a href="#l51.277"></a><span id="l51.277">    */</span>
<a href="#l51.278"></a><span id="l51.278" class="difflineminus">-  cleanupItipItem: function(itipItem) {</span>
<a href="#l51.279"></a><span id="l51.279" class="difflineplus">+  cleanupItipItem(itipItem) {</span>
<a href="#l51.280"></a><span id="l51.280">     if (itipItem) {</span>
<a href="#l51.281"></a><span id="l51.281">       let itemList = itipItem.getItemList();</span>
<a href="#l51.282"></a><span id="l51.282">       if (itemList.length &gt; 0) {</span>
<a href="#l51.283"></a><span id="l51.283">         // Again, we can assume the id is the same over all items per spec</span>
<a href="#l51.284"></a><span id="l51.284">         ItipItemFinderFactory.cleanup(itemList[0].id);</span>
<a href="#l51.285"></a><span id="l51.285">       }</span>
<a href="#l51.286"></a><span id="l51.286">     }</span>
<a href="#l51.287"></a><span id="l51.287">   },</span>
<a href="#l51.288"></a><span id="l51.288" class="difflineat">@@ -678,17 +675,17 @@ var calitip = {</span>
<a href="#l51.289"></a><span id="l51.289">    *   * CANCEL -- invitation cancel (sent by organizer)</span>
<a href="#l51.290"></a><span id="l51.290">    *   * COUNTER -- counterproposal (sent by attendee)</span>
<a href="#l51.291"></a><span id="l51.291">    *   * DECLINECOUNTER -- denial of a counterproposal (sent by organizer)</span>
<a href="#l51.292"></a><span id="l51.292">    *</span>
<a href="#l51.293"></a><span id="l51.293">    * @param {calIItipItem} itipItem       The iTIP item</span>
<a href="#l51.294"></a><span id="l51.294">    * @param {Function} optionsFunc        The function being called with parameters: itipItem,</span>
<a href="#l51.295"></a><span id="l51.295">    *                                          resultCode, actionFunc</span>
<a href="#l51.296"></a><span id="l51.296">    */</span>
<a href="#l51.297"></a><span id="l51.297" class="difflineminus">-  processItipItem: function(itipItem, optionsFunc) {</span>
<a href="#l51.298"></a><span id="l51.298" class="difflineplus">+  processItipItem(itipItem, optionsFunc) {</span>
<a href="#l51.299"></a><span id="l51.299">     switch (itipItem.receivedMethod.toUpperCase()) {</span>
<a href="#l51.300"></a><span id="l51.300">       case &quot;REFRESH&quot;:</span>
<a href="#l51.301"></a><span id="l51.301">       case &quot;PUBLISH&quot;:</span>
<a href="#l51.302"></a><span id="l51.302">       case &quot;REQUEST&quot;:</span>
<a href="#l51.303"></a><span id="l51.303">       case &quot;CANCEL&quot;:</span>
<a href="#l51.304"></a><span id="l51.304">       case &quot;COUNTER&quot;:</span>
<a href="#l51.305"></a><span id="l51.305">       case &quot;DECLINECOUNTER&quot;:</span>
<a href="#l51.306"></a><span id="l51.306">       case &quot;REPLY&quot;: {</span>
<a href="#l51.307"></a><span id="l51.307" class="difflineat">@@ -726,17 +723,17 @@ var calitip = {</span>
<a href="#l51.308"></a><span id="l51.308">    *                                            parameters for sending itip messages as response</span>
<a href="#l51.309"></a><span id="l51.309">    *                                            mode, comments or a subset of recipients. Currently</span>
<a href="#l51.310"></a><span id="l51.310">    *                                            implemented attributes are:</span>
<a href="#l51.311"></a><span id="l51.311">    *                             * responseMode Response mode (long) as defined for autoResponse</span>
<a href="#l51.312"></a><span id="l51.312">    *                                            of calIItipItem. The default mode is USER (which</span>
<a href="#l51.313"></a><span id="l51.313">    *                                            will trigger displaying the previously known popup</span>
<a href="#l51.314"></a><span id="l51.314">    *                                            to ask the user whether to send)</span>
<a href="#l51.315"></a><span id="l51.315">    */</span>
<a href="#l51.316"></a><span id="l51.316" class="difflineminus">-  checkAndSend: function(aOpType, aItem, aOriginalItem, aExtResponse = null) {</span>
<a href="#l51.317"></a><span id="l51.317" class="difflineplus">+  checkAndSend(aOpType, aItem, aOriginalItem, aExtResponse = null) {</span>
<a href="#l51.318"></a><span id="l51.318">     // balance out parts of the modification vs delete confusion, deletion of occurrences</span>
<a href="#l51.319"></a><span id="l51.319">     // are notified as parent modifications and modifications of occurrences are notified</span>
<a href="#l51.320"></a><span id="l51.320">     // as mixed new-occurrence, old-parent (IIRC).</span>
<a href="#l51.321"></a><span id="l51.321">     if (aOriginalItem &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l51.322"></a><span id="l51.322">       if (aOriginalItem.recurrenceId &amp;&amp; !aItem.recurrenceId) {</span>
<a href="#l51.323"></a><span id="l51.323">         // sanity check: assure aItem doesn't refer to the master</span>
<a href="#l51.324"></a><span id="l51.324">         aItem = aItem.recurrenceInfo.getOccurrenceFor(aOriginalItem.recurrenceId);</span>
<a href="#l51.325"></a><span id="l51.325">         cal.ASSERT(aItem, &quot;unexpected!&quot;);</span>
<a href="#l51.326"></a><span id="l51.326" class="difflineat">@@ -1016,17 +1013,17 @@ var calitip = {</span>
<a href="#l51.327"></a><span id="l51.327"> </span>
<a href="#l51.328"></a><span id="l51.328">   /**</span>
<a href="#l51.329"></a><span id="l51.329">    * Bumps the SEQUENCE in case of a major change; XXX todo may need more fine-tuning.</span>
<a href="#l51.330"></a><span id="l51.330">    *</span>
<a href="#l51.331"></a><span id="l51.331">    * @param {calIItemBase} newItem        The new item to set the sequence on</span>
<a href="#l51.332"></a><span id="l51.332">    * @param {calIItemBase} oldItem        The old item to get the previous version from.</span>
<a href="#l51.333"></a><span id="l51.333">    * @return {calIItemBase}               The newly changed item</span>
<a href="#l51.334"></a><span id="l51.334">    */</span>
<a href="#l51.335"></a><span id="l51.335" class="difflineminus">-  prepareSequence: function(newItem, oldItem) {</span>
<a href="#l51.336"></a><span id="l51.336" class="difflineplus">+  prepareSequence(newItem, oldItem) {</span>
<a href="#l51.337"></a><span id="l51.337">     if (calitip.isInvitation(newItem)) {</span>
<a href="#l51.338"></a><span id="l51.338">       return newItem; // invitation copies don't bump the SEQUENCE</span>
<a href="#l51.339"></a><span id="l51.339">     }</span>
<a href="#l51.340"></a><span id="l51.340"> </span>
<a href="#l51.341"></a><span id="l51.341">     if (newItem.recurrenceId &amp;&amp; !oldItem.recurrenceId &amp;&amp; oldItem.recurrenceInfo) {</span>
<a href="#l51.342"></a><span id="l51.342">       // XXX todo: there's still the bug that modifyItem is called with mixed occurrence/parent,</span>
<a href="#l51.343"></a><span id="l51.343">       //           find original occurrence</span>
<a href="#l51.344"></a><span id="l51.344">       oldItem = oldItem.recurrenceInfo.getOccurrenceFor(newItem.recurrenceId);</span>
<a href="#l51.345"></a><span id="l51.345" class="difflineat">@@ -1079,17 +1076,17 @@ var calitip = {</span>
<a href="#l51.346"></a><span id="l51.346">    * Returns a copy of an itipItem with modified properties and items build from scratch Use</span>
<a href="#l51.347"></a><span id="l51.347">    * itipItem.clone() instead if only a simple copy is required</span>
<a href="#l51.348"></a><span id="l51.348">    *</span>
<a href="#l51.349"></a><span id="l51.349">    * @param  {calIItipItem} aItipItem  ItipItem to derive a new one from</span>
<a href="#l51.350"></a><span id="l51.350">    * @param  {calIItemBase[]} aItems   calIEvent or calITodo items to be contained in the new itipItem</span>
<a href="#l51.351"></a><span id="l51.351">    * @param  {Object} aProps           Properties to be different in the new itipItem</span>
<a href="#l51.352"></a><span id="l51.352">    * @return {calIItipItem}            The copied and modified item</span>
<a href="#l51.353"></a><span id="l51.353">    */</span>
<a href="#l51.354"></a><span id="l51.354" class="difflineminus">-  getModifiedItipItem: function(aItipItem, aItems = [], aProps = {}) {</span>
<a href="#l51.355"></a><span id="l51.355" class="difflineplus">+  getModifiedItipItem(aItipItem, aItems = [], aProps = {}) {</span>
<a href="#l51.356"></a><span id="l51.356">     let itipItem = Cc[&quot;@mozilla.org/calendar/itip-item;1&quot;].createInstance(Ci.calIItipItem);</span>
<a href="#l51.357"></a><span id="l51.357">     let serializedItems = &quot;&quot;;</span>
<a href="#l51.358"></a><span id="l51.358">     for (let item of aItems) {</span>
<a href="#l51.359"></a><span id="l51.359">       serializedItems += cal.item.serialize(item);</span>
<a href="#l51.360"></a><span id="l51.360">     }</span>
<a href="#l51.361"></a><span id="l51.361">     itipItem.init(serializedItems);</span>
<a href="#l51.362"></a><span id="l51.362"> </span>
<a href="#l51.363"></a><span id="l51.363">     itipItem.autoResponse = &quot;autoResponse&quot; in aProps ? aProps.autoResponse : aItipItem.autoResponse;</span>
<a href="#l51.364"></a><span id="l51.364" class="difflineat">@@ -1110,17 +1107,17 @@ var calitip = {</span>
<a href="#l51.365"></a><span id="l51.365">    * A shortcut to send DECLINECOUNTER messages - for everything else use calitip.checkAndSend</span>
<a href="#l51.366"></a><span id="l51.366">    *</span>
<a href="#l51.367"></a><span id="l51.367">    * @param {calIItipItem} aItem              item to be sent</span>
<a href="#l51.368"></a><span id="l51.368">    * @param {String} aMethod                  iTIP method</span>
<a href="#l51.369"></a><span id="l51.369">    * @param {calIAttendee[]} aRecipientsList  array of calIAttendee objects the message should be sent to</span>
<a href="#l51.370"></a><span id="l51.370">    * @param {Object} aAutoResponse            JS object whether the transport should ask before sending</span>
<a href="#l51.371"></a><span id="l51.371">    * @return {Boolean}                        True</span>
<a href="#l51.372"></a><span id="l51.372">    */</span>
<a href="#l51.373"></a><span id="l51.373" class="difflineminus">-  sendDeclineCounterMessage: function(aItem, aMethod, aRecipientsList, aAutoResponse) {</span>
<a href="#l51.374"></a><span id="l51.374" class="difflineplus">+  sendDeclineCounterMessage(aItem, aMethod, aRecipientsList, aAutoResponse) {</span>
<a href="#l51.375"></a><span id="l51.375">     if (aMethod == &quot;DECLINECOUNTER&quot;) {</span>
<a href="#l51.376"></a><span id="l51.376">       return sendMessage(aItem, aMethod, aRecipientsList, aAutoResponse);</span>
<a href="#l51.377"></a><span id="l51.377">     }</span>
<a href="#l51.378"></a><span id="l51.378">     return false;</span>
<a href="#l51.379"></a><span id="l51.379">   },</span>
<a href="#l51.380"></a><span id="l51.380"> </span>
<a href="#l51.381"></a><span id="l51.381">   /**</span>
<a href="#l51.382"></a><span id="l51.382">    * Returns a copy of an event that</span>
<a href="#l51.383"></a><span id="l51.383" class="difflineat">@@ -1129,17 +1126,17 @@ var calitip = {</span>
<a href="#l51.384"></a><span id="l51.384">    * - has any attendee removed</span>
<a href="#l51.385"></a><span id="l51.385">    * Intended to get a copy of a normal event invitation that behaves as if the PUBLISH method was</span>
<a href="#l51.386"></a><span id="l51.386">    * chosen instead.</span>
<a href="#l51.387"></a><span id="l51.387">    *</span>
<a href="#l51.388"></a><span id="l51.388">    * @param {calIItemBase} aItem      Original item</span>
<a href="#l51.389"></a><span id="l51.389">    * @param {?String} aUid            UID to use for the new item</span>
<a href="#l51.390"></a><span id="l51.390">    * @return {calIItemBase}           The copied item for publishing</span>
<a href="#l51.391"></a><span id="l51.391">    */</span>
<a href="#l51.392"></a><span id="l51.392" class="difflineminus">-  getPublishLikeItemCopy: function(aItem, aUid) {</span>
<a href="#l51.393"></a><span id="l51.393" class="difflineplus">+  getPublishLikeItemCopy(aItem, aUid) {</span>
<a href="#l51.394"></a><span id="l51.394">     // avoid changing aItem</span>
<a href="#l51.395"></a><span id="l51.395">     let item = aItem.clone();</span>
<a href="#l51.396"></a><span id="l51.396">     // reset to a new UUID if applicable</span>
<a href="#l51.397"></a><span id="l51.397">     item.id = aUid || cal.getUUID();</span>
<a href="#l51.398"></a><span id="l51.398">     // add a relation to the original item</span>
<a href="#l51.399"></a><span id="l51.399">     let relation = cal.createRelation();</span>
<a href="#l51.400"></a><span id="l51.400">     relation.relId = aItem.id;</span>
<a href="#l51.401"></a><span id="l51.401">     relation.relType = &quot;SIBLING&quot;;</span>
<a href="#l51.402"></a><span id="l51.402" class="difflineat">@@ -1153,34 +1150,34 @@ var calitip = {</span>
<a href="#l51.403"></a><span id="l51.403">   },</span>
<a href="#l51.404"></a><span id="l51.404"> </span>
<a href="#l51.405"></a><span id="l51.405">   /**</span>
<a href="#l51.406"></a><span id="l51.406">    * Shortcut function to check whether an item is an invitation copy.</span>
<a href="#l51.407"></a><span id="l51.407">    *</span>
<a href="#l51.408"></a><span id="l51.408">    * @param {calIItemBase} aItem      The item to check for an invitation.</span>
<a href="#l51.409"></a><span id="l51.409">    * @return {Boolean}                True, if the item is an invitation.</span>
<a href="#l51.410"></a><span id="l51.410">    */</span>
<a href="#l51.411"></a><span id="l51.411" class="difflineminus">-  isInvitation: function(aItem) {</span>
<a href="#l51.412"></a><span id="l51.412" class="difflineplus">+  isInvitation(aItem) {</span>
<a href="#l51.413"></a><span id="l51.413">     let isInvitation = false;</span>
<a href="#l51.414"></a><span id="l51.414">     let calendar = cal.wrapInstance(aItem.calendar, Ci.calISchedulingSupport);</span>
<a href="#l51.415"></a><span id="l51.415">     if (calendar) {</span>
<a href="#l51.416"></a><span id="l51.416">       isInvitation = calendar.isInvitation(aItem);</span>
<a href="#l51.417"></a><span id="l51.417">     }</span>
<a href="#l51.418"></a><span id="l51.418">     return isInvitation;</span>
<a href="#l51.419"></a><span id="l51.419">   },</span>
<a href="#l51.420"></a><span id="l51.420"> </span>
<a href="#l51.421"></a><span id="l51.421">   /**</span>
<a href="#l51.422"></a><span id="l51.422">    * Shortcut function to check whether an item is an invitation copy and has a participation</span>
<a href="#l51.423"></a><span id="l51.423">    * status of either NEEDS-ACTION or TENTATIVE.</span>
<a href="#l51.424"></a><span id="l51.424">    *</span>
<a href="#l51.425"></a><span id="l51.425">    * @param {calIAttendee|calIItemBase} aItem     either calIAttendee or calIItemBase</span>
<a href="#l51.426"></a><span id="l51.426">    * @return {Boolean}                            True, if the attendee partstat is NEEDS-ACTION</span>
<a href="#l51.427"></a><span id="l51.427">    *                                                or TENTATIVE</span>
<a href="#l51.428"></a><span id="l51.428">    */</span>
<a href="#l51.429"></a><span id="l51.429" class="difflineminus">-  isOpenInvitation: function(aItem) {</span>
<a href="#l51.430"></a><span id="l51.430" class="difflineplus">+  isOpenInvitation(aItem) {</span>
<a href="#l51.431"></a><span id="l51.431">     let wrappedItem = cal.wrapInstance(aItem, Ci.calIAttendee);</span>
<a href="#l51.432"></a><span id="l51.432">     if (!wrappedItem) {</span>
<a href="#l51.433"></a><span id="l51.433">       aItem = calitip.getInvitedAttendee(aItem);</span>
<a href="#l51.434"></a><span id="l51.434">     }</span>
<a href="#l51.435"></a><span id="l51.435">     if (aItem) {</span>
<a href="#l51.436"></a><span id="l51.436">       switch (aItem.participationStatus) {</span>
<a href="#l51.437"></a><span id="l51.437">         case &quot;NEEDS-ACTION&quot;:</span>
<a href="#l51.438"></a><span id="l51.438">         case &quot;TENTATIVE&quot;:</span>
<a href="#l51.439"></a><span id="l51.439" class="difflineat">@@ -1193,17 +1190,17 @@ var calitip = {</span>
<a href="#l51.440"></a><span id="l51.440">   /**</span>
<a href="#l51.441"></a><span id="l51.441">    * Resolves delegated-to/delegated-from calusers for a given attendee to also include the</span>
<a href="#l51.442"></a><span id="l51.442">    * respective CNs if available in a given set of attendees</span>
<a href="#l51.443"></a><span id="l51.443">    *</span>
<a href="#l51.444"></a><span id="l51.444">    * @param {calIAttendee} aAttendee          The attendee to resolve the delegation information for</span>
<a href="#l51.445"></a><span id="l51.445">    * @param {calIAttendee[]} aAttendees       An array of calIAttendee objects to look up</span>
<a href="#l51.446"></a><span id="l51.446">    * @return {Object}                         An object with string attributes for delegators and delegatees</span>
<a href="#l51.447"></a><span id="l51.447">    */</span>
<a href="#l51.448"></a><span id="l51.448" class="difflineminus">-  resolveDelegation: function(aAttendee, aAttendees) {</span>
<a href="#l51.449"></a><span id="l51.449" class="difflineplus">+  resolveDelegation(aAttendee, aAttendees) {</span>
<a href="#l51.450"></a><span id="l51.450">     let attendees = aAttendees || [aAttendee];</span>
<a href="#l51.451"></a><span id="l51.451"> </span>
<a href="#l51.452"></a><span id="l51.452">     // this will be replaced by a direct property getter in calIAttendee</span>
<a href="#l51.453"></a><span id="l51.453">     let delegators = [];</span>
<a href="#l51.454"></a><span id="l51.454">     let delegatees = [];</span>
<a href="#l51.455"></a><span id="l51.455">     let delegatorProp = aAttendee.getProperty(&quot;DELEGATED-FROM&quot;);</span>
<a href="#l51.456"></a><span id="l51.456">     if (delegatorProp) {</span>
<a href="#l51.457"></a><span id="l51.457">       delegators = typeof delegatorProp == &quot;string&quot; ? [delegatorProp] : delegatorProp;</span>
<a href="#l51.458"></a><span id="l51.458" class="difflineat">@@ -1231,17 +1228,17 @@ var calitip = {</span>
<a href="#l51.459"></a><span id="l51.459">   /**</span>
<a href="#l51.460"></a><span id="l51.460">    * Shortcut function to get the invited attendee of an item.</span>
<a href="#l51.461"></a><span id="l51.461">    *</span>
<a href="#l51.462"></a><span id="l51.462">    * @param {calIItemBase} aItem          Event or task to get the invited attendee for</span>
<a href="#l51.463"></a><span id="l51.463">    * @param {?calICalendar} aCalendar     The calendar to use for checking, defaults to the item</span>
<a href="#l51.464"></a><span id="l51.464">    *                                        calendar</span>
<a href="#l51.465"></a><span id="l51.465">    * @return {?calIAttendee}              The attendee that was invited</span>
<a href="#l51.466"></a><span id="l51.466">    */</span>
<a href="#l51.467"></a><span id="l51.467" class="difflineminus">-  getInvitedAttendee: function(aItem, aCalendar) {</span>
<a href="#l51.468"></a><span id="l51.468" class="difflineplus">+  getInvitedAttendee(aItem, aCalendar) {</span>
<a href="#l51.469"></a><span id="l51.469">     if (!aCalendar) {</span>
<a href="#l51.470"></a><span id="l51.470">       aCalendar = aItem.calendar;</span>
<a href="#l51.471"></a><span id="l51.471">     }</span>
<a href="#l51.472"></a><span id="l51.472">     let invitedAttendee = null;</span>
<a href="#l51.473"></a><span id="l51.473">     let calendar = cal.wrapInstance(aCalendar, Ci.calISchedulingSupport);</span>
<a href="#l51.474"></a><span id="l51.474">     if (calendar) {</span>
<a href="#l51.475"></a><span id="l51.475">       invitedAttendee = calendar.getInvitedAttendee(aItem);</span>
<a href="#l51.476"></a><span id="l51.476">     }</span>
<a href="#l51.477"></a><span id="l51.477" class="difflineat">@@ -1251,17 +1248,17 @@ var calitip = {</span>
<a href="#l51.478"></a><span id="l51.478">   /**</span>
<a href="#l51.479"></a><span id="l51.479">    * Returns all attendees from given set of attendees matching based on the attendee id</span>
<a href="#l51.480"></a><span id="l51.480">    * or a sent-by parameter compared to the specified email address</span>
<a href="#l51.481"></a><span id="l51.481">    *</span>
<a href="#l51.482"></a><span id="l51.482">    * @param {calIAttendee[]} aAttendees       An array of calIAttendee objects</span>
<a href="#l51.483"></a><span id="l51.483">    * @param {String} aEmailAddress            A string containing the email address for lookup</span>
<a href="#l51.484"></a><span id="l51.484">    * @return {calIAttendee[]}                 Returns an array of matching attendees</span>
<a href="#l51.485"></a><span id="l51.485">    */</span>
<a href="#l51.486"></a><span id="l51.486" class="difflineminus">-  getAttendeesBySender: function(aAttendees, aEmailAddress) {</span>
<a href="#l51.487"></a><span id="l51.487" class="difflineplus">+  getAttendeesBySender(aAttendees, aEmailAddress) {</span>
<a href="#l51.488"></a><span id="l51.488">     let attendees = [];</span>
<a href="#l51.489"></a><span id="l51.489">     // we extract the email address to make it work also for a raw header value</span>
<a href="#l51.490"></a><span id="l51.490">     let compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(</span>
<a href="#l51.491"></a><span id="l51.491">       Ci.nsIMsgCompFields</span>
<a href="#l51.492"></a><span id="l51.492">     );</span>
<a href="#l51.493"></a><span id="l51.493">     let addresses = compFields.splitRecipients(aEmailAddress, true);</span>
<a href="#l51.494"></a><span id="l51.494">     if (addresses.length == 1) {</span>
<a href="#l51.495"></a><span id="l51.495">       let searchFor = cal.email.prependMailTo(addresses[0]);</span>
<a href="#l51.496"></a><span id="l51.496" class="difflineat">@@ -1495,19 +1492,18 @@ function sendMessage(aItem, aMethod, aRe</span>
<a href="#l51.497"></a><span id="l51.497">       sendItem.removeAllAttendees();</span>
<a href="#l51.498"></a><span id="l51.498">       sendItem.addAttendee(recipient);</span>
<a href="#l51.499"></a><span id="l51.499">       // send message</span>
<a href="#l51.500"></a><span id="l51.500">       if (!_sendItem(sendToList, sendItem)) {</span>
<a href="#l51.501"></a><span id="l51.501">         return false;</span>
<a href="#l51.502"></a><span id="l51.502">       }</span>
<a href="#l51.503"></a><span id="l51.503">     }</span>
<a href="#l51.504"></a><span id="l51.504">     return true;</span>
<a href="#l51.505"></a><span id="l51.505" class="difflineminus">-  } else {</span>
<a href="#l51.506"></a><span id="l51.506" class="difflineminus">-    return _sendItem(aRecipientsList, aItem);</span>
<a href="#l51.507"></a><span id="l51.507">   }</span>
<a href="#l51.508"></a><span id="l51.508" class="difflineplus">+  return _sendItem(aRecipientsList, aItem);</span>
<a href="#l51.509"></a><span id="l51.509"> }</span>
<a href="#l51.510"></a><span id="l51.510"> </span>
<a href="#l51.511"></a><span id="l51.511"> /** local to this module file</span>
<a href="#l51.512"></a><span id="l51.512">  * An operation listener that is used on calendar operations which checks and sends further iTIP</span>
<a href="#l51.513"></a><span id="l51.513">  * messages based on the calendar action.</span>
<a href="#l51.514"></a><span id="l51.514">  *</span>
<a href="#l51.515"></a><span id="l51.515">  * @param {Object} aOpListener          operation listener to forward</span>
<a href="#l51.516"></a><span id="l51.516">  * @param {calIItemBase} aOldItem       The previous item before modification (if any)</span>
<a href="#l51.517"></a><span id="l51.517" class="difflineat">@@ -1522,26 +1518,26 @@ function ItipOpListener(aOpListener, aOl</span>
<a href="#l51.518"></a><span id="l51.518"> }</span>
<a href="#l51.519"></a><span id="l51.519"> ItipOpListener.prototype = {</span>
<a href="#l51.520"></a><span id="l51.520">   QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l51.521"></a><span id="l51.521"> </span>
<a href="#l51.522"></a><span id="l51.522">   mOpListener: null,</span>
<a href="#l51.523"></a><span id="l51.523">   mOldItem: null,</span>
<a href="#l51.524"></a><span id="l51.524">   mExtResponse: null,</span>
<a href="#l51.525"></a><span id="l51.525"> </span>
<a href="#l51.526"></a><span id="l51.526" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l51.527"></a><span id="l51.527" class="difflineplus">+  onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l51.528"></a><span id="l51.528">     cal.ASSERT(Components.isSuccessCode(aStatus), &quot;error on iTIP processing&quot;);</span>
<a href="#l51.529"></a><span id="l51.529">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l51.530"></a><span id="l51.530">       calitip.checkAndSend(aOperationType, aDetail, this.mOldItem, this.mExtResponse);</span>
<a href="#l51.531"></a><span id="l51.531">     }</span>
<a href="#l51.532"></a><span id="l51.532">     if (this.mOpListener) {</span>
<a href="#l51.533"></a><span id="l51.533">       this.mOpListener.onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l51.534"></a><span id="l51.534">     }</span>
<a href="#l51.535"></a><span id="l51.535">   },</span>
<a href="#l51.536"></a><span id="l51.536" class="difflineminus">-  onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l51.537"></a><span id="l51.537" class="difflineplus">+  onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l51.538"></a><span id="l51.538"> };</span>
<a href="#l51.539"></a><span id="l51.539"> </span>
<a href="#l51.540"></a><span id="l51.540"> /** local to this module file</span>
<a href="#l51.541"></a><span id="l51.541">  * Add a parameter SCHEDULE-AGENT=CLIENT to the item before it is</span>
<a href="#l51.542"></a><span id="l51.542">  * created or updated so that the providers knows scheduling will</span>
<a href="#l51.543"></a><span id="l51.543">  * be handled by the client.</span>
<a href="#l51.544"></a><span id="l51.544">  *</span>
<a href="#l51.545"></a><span id="l51.545">  * @param {calIItemBase} item       item about to be added or updated</span>
<a href="#l51.546"></a><span id="l51.546" class="difflineat">@@ -1562,30 +1558,30 @@ var ItipItemFinderFactory = {</span>
<a href="#l51.547"></a><span id="l51.547">   /**</span>
<a href="#l51.548"></a><span id="l51.548">    * Create an item finder and track its progress. Be sure to clean up the</span>
<a href="#l51.549"></a><span id="l51.549">    * finder for this id at some point.</span>
<a href="#l51.550"></a><span id="l51.550">    *</span>
<a href="#l51.551"></a><span id="l51.551">    * @param {String} aId              The item id to search for</span>
<a href="#l51.552"></a><span id="l51.552">    * @param {calIIipItem} aItipItem   The iTIP item used for processing</span>
<a href="#l51.553"></a><span id="l51.553">    * @param {Function} aOptionsFunc   The options function used for processing the found item</span>
<a href="#l51.554"></a><span id="l51.554">    */</span>
<a href="#l51.555"></a><span id="l51.555" class="difflineminus">-  findItem: function(aId, aItipItem, aOptionsFunc) {</span>
<a href="#l51.556"></a><span id="l51.556" class="difflineplus">+  findItem(aId, aItipItem, aOptionsFunc) {</span>
<a href="#l51.557"></a><span id="l51.557">     this.cleanup(aId);</span>
<a href="#l51.558"></a><span id="l51.558">     let finder = new ItipItemFinder(aId, aItipItem, aOptionsFunc);</span>
<a href="#l51.559"></a><span id="l51.559">     this._findMap[aId] = finder;</span>
<a href="#l51.560"></a><span id="l51.560">     finder.findItem();</span>
<a href="#l51.561"></a><span id="l51.561">   },</span>
<a href="#l51.562"></a><span id="l51.562"> </span>
<a href="#l51.563"></a><span id="l51.563">   /**</span>
<a href="#l51.564"></a><span id="l51.564">    * Clean up tracking for the given id. This needs to be called once for</span>
<a href="#l51.565"></a><span id="l51.565">    * every time findItem is called.</span>
<a href="#l51.566"></a><span id="l51.566">    *</span>
<a href="#l51.567"></a><span id="l51.567">    * @param {String} aId           The item id to clean up for</span>
<a href="#l51.568"></a><span id="l51.568">    */</span>
<a href="#l51.569"></a><span id="l51.569" class="difflineminus">-  cleanup: function(aId) {</span>
<a href="#l51.570"></a><span id="l51.570" class="difflineplus">+  cleanup(aId) {</span>
<a href="#l51.571"></a><span id="l51.571">     if (aId in this._findMap) {</span>
<a href="#l51.572"></a><span id="l51.572">       let finder = this._findMap[aId];</span>
<a href="#l51.573"></a><span id="l51.573">       finder.destroy();</span>
<a href="#l51.574"></a><span id="l51.574">       delete this._findMap[aId];</span>
<a href="#l51.575"></a><span id="l51.575">     }</span>
<a href="#l51.576"></a><span id="l51.576">   },</span>
<a href="#l51.577"></a><span id="l51.577"> };</span>
<a href="#l51.578"></a><span id="l51.578"> </span>
<a href="#l51.579"></a><span id="l51.579" class="difflineat">@@ -1605,49 +1601,49 @@ function ItipItemFinder(aId, itipItem, o</span>
<a href="#l51.580"></a><span id="l51.580"> ItipItemFinder.prototype = {</span>
<a href="#l51.581"></a><span id="l51.581">   QueryInterface: cal.generateQI([Ci.calIObserver, Ci.calIOperationListener]),</span>
<a href="#l51.582"></a><span id="l51.582"> </span>
<a href="#l51.583"></a><span id="l51.583">   mSearchId: null,</span>
<a href="#l51.584"></a><span id="l51.584">   mItipItem: null,</span>
<a href="#l51.585"></a><span id="l51.585">   mOptionsFunc: null,</span>
<a href="#l51.586"></a><span id="l51.586">   mFoundItems: null,</span>
<a href="#l51.587"></a><span id="l51.587"> </span>
<a href="#l51.588"></a><span id="l51.588" class="difflineminus">-  findItem: function() {</span>
<a href="#l51.589"></a><span id="l51.589" class="difflineplus">+  findItem() {</span>
<a href="#l51.590"></a><span id="l51.590">     this.mFoundItems = [];</span>
<a href="#l51.591"></a><span id="l51.591">     this._unobserveChanges();</span>
<a href="#l51.592"></a><span id="l51.592">     this.mItipItem.targetCalendar.getItem(this.mSearchId, this);</span>
<a href="#l51.593"></a><span id="l51.593">   },</span>
<a href="#l51.594"></a><span id="l51.594"> </span>
<a href="#l51.595"></a><span id="l51.595" class="difflineminus">-  _observeChanges: function(aCalendar) {</span>
<a href="#l51.596"></a><span id="l51.596" class="difflineplus">+  _observeChanges(aCalendar) {</span>
<a href="#l51.597"></a><span id="l51.597">     this._unobserveChanges();</span>
<a href="#l51.598"></a><span id="l51.598">     this.mObservedCalendar = aCalendar;</span>
<a href="#l51.599"></a><span id="l51.599"> </span>
<a href="#l51.600"></a><span id="l51.600">     if (this.mObservedCalendar) {</span>
<a href="#l51.601"></a><span id="l51.601">       this.mObservedCalendar.addObserver(this);</span>
<a href="#l51.602"></a><span id="l51.602">     }</span>
<a href="#l51.603"></a><span id="l51.603">   },</span>
<a href="#l51.604"></a><span id="l51.604" class="difflineminus">-  _unobserveChanges: function() {</span>
<a href="#l51.605"></a><span id="l51.605" class="difflineplus">+  _unobserveChanges() {</span>
<a href="#l51.606"></a><span id="l51.606">     if (this.mObservedCalendar) {</span>
<a href="#l51.607"></a><span id="l51.607">       this.mObservedCalendar.removeObserver(this);</span>
<a href="#l51.608"></a><span id="l51.608">       this.mObservedCalendar = null;</span>
<a href="#l51.609"></a><span id="l51.609">     }</span>
<a href="#l51.610"></a><span id="l51.610">   },</span>
<a href="#l51.611"></a><span id="l51.611"> </span>
<a href="#l51.612"></a><span id="l51.612" class="difflineminus">-  onStartBatch: function() {},</span>
<a href="#l51.613"></a><span id="l51.613" class="difflineminus">-  onEndBatch: function() {},</span>
<a href="#l51.614"></a><span id="l51.614" class="difflineminus">-  onError: function() {},</span>
<a href="#l51.615"></a><span id="l51.615" class="difflineminus">-  onPropertyChanged: function() {},</span>
<a href="#l51.616"></a><span id="l51.616" class="difflineminus">-  onPropertyDeleting: function() {},</span>
<a href="#l51.617"></a><span id="l51.617" class="difflineminus">-  onLoad: function(aCalendar) {</span>
<a href="#l51.618"></a><span id="l51.618" class="difflineplus">+  onStartBatch() {},</span>
<a href="#l51.619"></a><span id="l51.619" class="difflineplus">+  onEndBatch() {},</span>
<a href="#l51.620"></a><span id="l51.620" class="difflineplus">+  onError() {},</span>
<a href="#l51.621"></a><span id="l51.621" class="difflineplus">+  onPropertyChanged() {},</span>
<a href="#l51.622"></a><span id="l51.622" class="difflineplus">+  onPropertyDeleting() {},</span>
<a href="#l51.623"></a><span id="l51.623" class="difflineplus">+  onLoad(aCalendar) {</span>
<a href="#l51.624"></a><span id="l51.624">     // Its possible that the item was updated. We need to re-retrieve the</span>
<a href="#l51.625"></a><span id="l51.625">     // items now.</span>
<a href="#l51.626"></a><span id="l51.626">     this.findItem();</span>
<a href="#l51.627"></a><span id="l51.627">   },</span>
<a href="#l51.628"></a><span id="l51.628"> </span>
<a href="#l51.629"></a><span id="l51.629" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l51.630"></a><span id="l51.630" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l51.631"></a><span id="l51.631">     let refItem = aOldItem || aNewItem;</span>
<a href="#l51.632"></a><span id="l51.632">     if (refItem.id == this.mSearchId) {</span>
<a href="#l51.633"></a><span id="l51.633">       // Check existing found items to see if it already exists</span>
<a href="#l51.634"></a><span id="l51.634">       let found = false;</span>
<a href="#l51.635"></a><span id="l51.635">       for (let [idx, item] of Object.entries(this.mFoundItems)) {</span>
<a href="#l51.636"></a><span id="l51.636">         if (item.id == refItem.id &amp;&amp; item.calendar.id == refItem.calendar.id) {</span>
<a href="#l51.637"></a><span id="l51.637">           if (aNewItem) {</span>
<a href="#l51.638"></a><span id="l51.638">             this.mFoundItems.splice(idx, 1, aNewItem);</span>
<a href="#l51.639"></a><span id="l51.639" class="difflineat">@@ -1662,35 +1658,35 @@ ItipItemFinder.prototype = {</span>
<a href="#l51.640"></a><span id="l51.640">       // If it hasn't been found and there is to add a item, add it to the end</span>
<a href="#l51.641"></a><span id="l51.641">       if (!found &amp;&amp; aNewItem) {</span>
<a href="#l51.642"></a><span id="l51.642">         this.mFoundItems.push(aNewItem);</span>
<a href="#l51.643"></a><span id="l51.643">       }</span>
<a href="#l51.644"></a><span id="l51.644">       this.processFoundItems();</span>
<a href="#l51.645"></a><span id="l51.645">     }</span>
<a href="#l51.646"></a><span id="l51.646">   },</span>
<a href="#l51.647"></a><span id="l51.647"> </span>
<a href="#l51.648"></a><span id="l51.648" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l51.649"></a><span id="l51.649" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l51.650"></a><span id="l51.650">     // onModifyItem is set up to also handle additions</span>
<a href="#l51.651"></a><span id="l51.651">     this.onModifyItem(aItem, null);</span>
<a href="#l51.652"></a><span id="l51.652">   },</span>
<a href="#l51.653"></a><span id="l51.653"> </span>
<a href="#l51.654"></a><span id="l51.654" class="difflineminus">-  onDeleteItem: function(aItem) {</span>
<a href="#l51.655"></a><span id="l51.655" class="difflineplus">+  onDeleteItem(aItem) {</span>
<a href="#l51.656"></a><span id="l51.656">     // onModifyItem is set up to also handle deletions</span>
<a href="#l51.657"></a><span id="l51.657">     this.onModifyItem(null, aItem);</span>
<a href="#l51.658"></a><span id="l51.658">   },</span>
<a href="#l51.659"></a><span id="l51.659"> </span>
<a href="#l51.660"></a><span id="l51.660" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l51.661"></a><span id="l51.661" class="difflineplus">+  onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l51.662"></a><span id="l51.662">     this.processFoundItems();</span>
<a href="#l51.663"></a><span id="l51.663">   },</span>
<a href="#l51.664"></a><span id="l51.664"> </span>
<a href="#l51.665"></a><span id="l51.665" class="difflineminus">-  destroy: function() {</span>
<a href="#l51.666"></a><span id="l51.666" class="difflineplus">+  destroy() {</span>
<a href="#l51.667"></a><span id="l51.667">     this._unobserveChanges();</span>
<a href="#l51.668"></a><span id="l51.668">   },</span>
<a href="#l51.669"></a><span id="l51.669"> </span>
<a href="#l51.670"></a><span id="l51.670" class="difflineminus">-  processFoundItems: function() {</span>
<a href="#l51.671"></a><span id="l51.671" class="difflineplus">+  processFoundItems() {</span>
<a href="#l51.672"></a><span id="l51.672">     let rc = Cr.NS_OK;</span>
<a href="#l51.673"></a><span id="l51.673">     const method = this.mItipItem.receivedMethod.toUpperCase();</span>
<a href="#l51.674"></a><span id="l51.674">     let actionMethod = method;</span>
<a href="#l51.675"></a><span id="l51.675">     let operations = [];</span>
<a href="#l51.676"></a><span id="l51.676"> </span>
<a href="#l51.677"></a><span id="l51.677">     if (this.mFoundItems.length &gt; 0) {</span>
<a href="#l51.678"></a><span id="l51.678">       // Save the target calendar on the itip item</span>
<a href="#l51.679"></a><span id="l51.679">       this.mItipItem.targetCalendar = this.mFoundItems[0].calendar;</span>
<a href="#l51.680"></a><span id="l51.680" class="difflineat">@@ -2022,14 +2018,14 @@ ItipItemFinder.prototype = {</span>
<a href="#l51.681"></a><span id="l51.681">         }</span>
<a href="#l51.682"></a><span id="l51.682">       };</span>
<a href="#l51.683"></a><span id="l51.683">       actionFunc.method = actionMethod;</span>
<a href="#l51.684"></a><span id="l51.684">     }</span>
<a href="#l51.685"></a><span id="l51.685"> </span>
<a href="#l51.686"></a><span id="l51.686">     this.mOptionsFunc(this.mItipItem, rc, actionFunc, this.mFoundItems);</span>
<a href="#l51.687"></a><span id="l51.687">   },</span>
<a href="#l51.688"></a><span id="l51.688"> </span>
<a href="#l51.689"></a><span id="l51.689" class="difflineminus">-  onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l51.690"></a><span id="l51.690" class="difflineplus">+  onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l51.691"></a><span id="l51.691">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l51.692"></a><span id="l51.692">       this.mFoundItems = this.mFoundItems.concat(aItems);</span>
<a href="#l51.693"></a><span id="l51.693">     }</span>
<a href="#l51.694"></a><span id="l51.694">   },</span>
<a href="#l51.695"></a><span id="l51.695"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/calendar/base/modules/utils/calL10NUtils.jsm</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/calendar/base/modules/utils/calL10NUtils.jsm</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -28,19 +28,18 @@ function _getString(aComponent, aBundleN</span>
<a href="#l52.4"></a><span id="l52.4">   try {</span>
<a href="#l52.5"></a><span id="l52.5">     if (!(propName in _getString._bundleCache)) {</span>
<a href="#l52.6"></a><span id="l52.6">       _getString._bundleCache[propName] = Services.strings.createBundle(propName);</span>
<a href="#l52.7"></a><span id="l52.7">     }</span>
<a href="#l52.8"></a><span id="l52.8">     let props = _getString._bundleCache[propName];</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10">     if (aParams &amp;&amp; aParams.length) {</span>
<a href="#l52.11"></a><span id="l52.11">       return props.formatStringFromName(aStringName, aParams);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-    } else {</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-      return props.GetStringFromName(aStringName);</span>
<a href="#l52.14"></a><span id="l52.14">     }</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+    return props.GetStringFromName(aStringName);</span>
<a href="#l52.16"></a><span id="l52.16">   } catch (ex) {</span>
<a href="#l52.17"></a><span id="l52.17">     let msg = `Failed to read '${aStringName}' from ${propName}.`;</span>
<a href="#l52.18"></a><span id="l52.18">     Cu.reportError(`${msg} Error: ${ex}`);</span>
<a href="#l52.19"></a><span id="l52.19">     return aStringName;</span>
<a href="#l52.20"></a><span id="l52.20">   }</span>
<a href="#l52.21"></a><span id="l52.21"> }</span>
<a href="#l52.22"></a><span id="l52.22"> _getString._bundleCache = {};</span>
<a href="#l52.23"></a><span id="l52.23"> </span>
<a href="#l52.24"></a><span id="l52.24" class="difflineat">@@ -126,45 +125,45 @@ var call10n = {</span>
<a href="#l52.25"></a><span id="l52.25">   /**</span>
<a href="#l52.26"></a><span id="l52.26">    * Gets the month name string in the right form depending on a base string.</span>
<a href="#l52.27"></a><span id="l52.27">    *</span>
<a href="#l52.28"></a><span id="l52.28">    * @param {Number} aMonthNum     The month number to get, 1-based.</span>
<a href="#l52.29"></a><span id="l52.29">    * @param {String} aBundleName   The Bundle to get the string from</span>
<a href="#l52.30"></a><span id="l52.30">    * @param {String} aStringBase   The base string name, .monthFormat will be appended</span>
<a href="#l52.31"></a><span id="l52.31">    * @return {String}              The formatted month name</span>
<a href="#l52.32"></a><span id="l52.32">    */</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-  formatMonth: function(aMonthNum, aBundleName, aStringBase) {</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+  formatMonth(aMonthNum, aBundleName, aStringBase) {</span>
<a href="#l52.35"></a><span id="l52.35">     let monthForm = call10n.getString(aBundleName, aStringBase + &quot;.monthFormat&quot;) || &quot;nominative&quot;;</span>
<a href="#l52.36"></a><span id="l52.36"> </span>
<a href="#l52.37"></a><span id="l52.37">     if (monthForm == &quot;nominative&quot;) {</span>
<a href="#l52.38"></a><span id="l52.38">       // Fall back to the default name format</span>
<a href="#l52.39"></a><span id="l52.39">       monthForm = &quot;name&quot;;</span>
<a href="#l52.40"></a><span id="l52.40">     }</span>
<a href="#l52.41"></a><span id="l52.41"> </span>
<a href="#l52.42"></a><span id="l52.42">     return call10n.getDateFmtString(`month.${aMonthNum}.${monthForm}`);</span>
<a href="#l52.43"></a><span id="l52.43">   },</span>
<a href="#l52.44"></a><span id="l52.44"> </span>
<a href="#l52.45"></a><span id="l52.45">   /**</span>
<a href="#l52.46"></a><span id="l52.46">    * Create a new locale collator</span>
<a href="#l52.47"></a><span id="l52.47">    *</span>
<a href="#l52.48"></a><span id="l52.48">    * @return {nsICollation}       A new locale collator</span>
<a href="#l52.49"></a><span id="l52.49">    */</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineminus">-  createLocaleCollator: function() {</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineplus">+  createLocaleCollator() {</span>
<a href="#l52.52"></a><span id="l52.52">     return Cc[&quot;@mozilla.org/intl/collation-factory;1&quot;]</span>
<a href="#l52.53"></a><span id="l52.53">       .getService(Ci.nsICollationFactory)</span>
<a href="#l52.54"></a><span id="l52.54">       .CreateCollation();</span>
<a href="#l52.55"></a><span id="l52.55">   },</span>
<a href="#l52.56"></a><span id="l52.56"> </span>
<a href="#l52.57"></a><span id="l52.57">   /**</span>
<a href="#l52.58"></a><span id="l52.58">    * Sort an array of strings in place, according to the current locale.</span>
<a href="#l52.59"></a><span id="l52.59">    *</span>
<a href="#l52.60"></a><span id="l52.60">    * @param {String[]} aStringArray   The strings to sort</span>
<a href="#l52.61"></a><span id="l52.61">    * @return {String[]}               The sorted strings, more specifically aStringArray</span>
<a href="#l52.62"></a><span id="l52.62">    */</span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-  sortArrayByLocaleCollator: function(aStringArray) {</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineplus">+  sortArrayByLocaleCollator(aStringArray) {</span>
<a href="#l52.65"></a><span id="l52.65">     let collator = call10n.createLocaleCollator();</span>
<a href="#l52.66"></a><span id="l52.66">     aStringArray.sort((a, b) =&gt; collator.compareString(0, a, b));</span>
<a href="#l52.67"></a><span id="l52.67">     return aStringArray;</span>
<a href="#l52.68"></a><span id="l52.68">   },</span>
<a href="#l52.69"></a><span id="l52.69"> </span>
<a href="#l52.70"></a><span id="l52.70">   /**</span>
<a href="#l52.71"></a><span id="l52.71">    * Provides locale dependent parameters for displaying calendar views</span>
<a href="#l52.72"></a><span id="l52.72">    *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/calendar/base/modules/utils/calPrintUtils.jsm</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/calendar/base/modules/utils/calPrintUtils.jsm</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -16,17 +16,17 @@ this.EXPORTED_SYMBOLS = [&quot;calprint&quot;]; /*</span>
<a href="#l53.4"></a><span id="l53.4"> var calprint = {</span>
<a href="#l53.5"></a><span id="l53.5">   /**</span>
<a href="#l53.6"></a><span id="l53.6">    * Returns a simple key in the format YYYY-MM-DD for use in the table of</span>
<a href="#l53.7"></a><span id="l53.7">    * dates to day boxes</span>
<a href="#l53.8"></a><span id="l53.8">    *</span>
<a href="#l53.9"></a><span id="l53.9">    * @param dt    The date to translate</span>
<a href="#l53.10"></a><span id="l53.10">    * @return      YYYY-MM-DD</span>
<a href="#l53.11"></a><span id="l53.11">    */</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-  getDateKey: function(date) {</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+  getDateKey(date) {</span>
<a href="#l53.14"></a><span id="l53.14">     return date.year + &quot;-&quot; + date.month + &quot;-&quot; + date.day;</span>
<a href="#l53.15"></a><span id="l53.15">   },</span>
<a href="#l53.16"></a><span id="l53.16"> </span>
<a href="#l53.17"></a><span id="l53.17">   /**</span>
<a href="#l53.18"></a><span id="l53.18">    * Serializes the given item by setting marked nodes to the item's content.</span>
<a href="#l53.19"></a><span id="l53.19">    * Has some expectations about the DOM document (in CSS-selector-speak), all</span>
<a href="#l53.20"></a><span id="l53.20">    * following nodes MUST exist.</span>
<a href="#l53.21"></a><span id="l53.21">    *</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineat">@@ -35,17 +35,17 @@ var calprint = {</span>
<a href="#l53.23"></a><span id="l53.23">    *   - .item-title gets the item title</span>
<a href="#l53.24"></a><span id="l53.24">    *   - .category-color-box gets a 2px solid border in category color</span>
<a href="#l53.25"></a><span id="l53.25">    *   - .calendar-color-box gets background color of the calendar</span>
<a href="#l53.26"></a><span id="l53.26">    *</span>
<a href="#l53.27"></a><span id="l53.27">    * @param document          The DOM Document to set things on</span>
<a href="#l53.28"></a><span id="l53.28">    * @param item              The item to serialize</span>
<a href="#l53.29"></a><span id="l53.29">    * @param dayContainer      The DOM Node to insert the container in</span>
<a href="#l53.30"></a><span id="l53.30">    */</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-  addItemToDaybox: function(document, item, boxDate, dayContainer) {</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+  addItemToDaybox(document, item, boxDate, dayContainer) {</span>
<a href="#l53.33"></a><span id="l53.33">     // Clone our template</span>
<a href="#l53.34"></a><span id="l53.34">     let itemNode = document.getElementById(&quot;item-template&quot;).cloneNode(true);</span>
<a href="#l53.35"></a><span id="l53.35">     itemNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l53.36"></a><span id="l53.36">     itemNode.item = item;</span>
<a href="#l53.37"></a><span id="l53.37"> </span>
<a href="#l53.38"></a><span id="l53.38">     // Fill in details of the item</span>
<a href="#l53.39"></a><span id="l53.39">     let itemInterval = cal.print.getItemIntervalString(item, boxDate);</span>
<a href="#l53.40"></a><span id="l53.40">     itemNode.querySelector(&quot;.item-interval&quot;).textContent = itemInterval;</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineat">@@ -80,17 +80,17 @@ var calprint = {</span>
<a href="#l53.42"></a><span id="l53.42">    * - #task-list-box will have the &quot;hidden&quot; attribute removed.</span>
<a href="#l53.43"></a><span id="l53.43">    * - #task-template will be cloned and filled, and modified:</span>
<a href="#l53.44"></a><span id="l53.44">    *   - .task-checkbox gets the &quot;checked&quot; attribute set, if completed</span>
<a href="#l53.45"></a><span id="l53.45">    *   - .task-title gets the item title.</span>
<a href="#l53.46"></a><span id="l53.46">    *</span>
<a href="#l53.47"></a><span id="l53.47">    * @param document          The DOM Document to set things on</span>
<a href="#l53.48"></a><span id="l53.48">    * @param item              The item to serialize</span>
<a href="#l53.49"></a><span id="l53.49">    */</span>
<a href="#l53.50"></a><span id="l53.50" class="difflineminus">-  addItemToDayboxNodate: function(document, item) {</span>
<a href="#l53.51"></a><span id="l53.51" class="difflineplus">+  addItemToDayboxNodate(document, item) {</span>
<a href="#l53.52"></a><span id="l53.52">     let taskContainer = document.getElementById(&quot;task-container&quot;);</span>
<a href="#l53.53"></a><span id="l53.53">     let taskNode = document.getElementById(&quot;task-template&quot;).cloneNode(true);</span>
<a href="#l53.54"></a><span id="l53.54">     taskNode.removeAttribute(&quot;id&quot;);</span>
<a href="#l53.55"></a><span id="l53.55">     taskNode.item = item;</span>
<a href="#l53.56"></a><span id="l53.56"> </span>
<a href="#l53.57"></a><span id="l53.57">     let taskListBox = document.getElementById(&quot;tasks-list-box&quot;);</span>
<a href="#l53.58"></a><span id="l53.58">     if (taskListBox.hasAttribute(&quot;hidden&quot;)) {</span>
<a href="#l53.59"></a><span id="l53.59">       let tasksTitle = document.getElementById(&quot;tasks-title&quot;);</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineat">@@ -116,17 +116,17 @@ var calprint = {</span>
<a href="#l53.61"></a><span id="l53.61">   },</span>
<a href="#l53.62"></a><span id="l53.62"> </span>
<a href="#l53.63"></a><span id="l53.63">   /**</span>
<a href="#l53.64"></a><span id="l53.64">    * Get time interval string for the given item. Returns an empty string for all-day items.</span>
<a href="#l53.65"></a><span id="l53.65">    *</span>
<a href="#l53.66"></a><span id="l53.66">    * @param aItem     The item providing the interval</span>
<a href="#l53.67"></a><span id="l53.67">    * @return          The string describing the interval</span>
<a href="#l53.68"></a><span id="l53.68">    */</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-  getItemIntervalString: function(aItem, aBoxDate) {</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+  getItemIntervalString(aItem, aBoxDate) {</span>
<a href="#l53.71"></a><span id="l53.71">     // omit time label for all-day items</span>
<a href="#l53.72"></a><span id="l53.72">     let startDate = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l53.73"></a><span id="l53.73">     let endDate = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l53.74"></a><span id="l53.74">     if ((startDate &amp;&amp; startDate.isDate) || (endDate &amp;&amp; endDate.isDate)) {</span>
<a href="#l53.75"></a><span id="l53.75">       return &quot;&quot;;</span>
<a href="#l53.76"></a><span id="l53.76">     }</span>
<a href="#l53.77"></a><span id="l53.77"> </span>
<a href="#l53.78"></a><span id="l53.78">     // check for tasks without start and/or due date</span>
<a href="#l53.79"></a><span id="l53.79" class="difflineat">@@ -140,24 +140,22 @@ var calprint = {</span>
<a href="#l53.80"></a><span id="l53.80">     endDate = endDate.getInTimezone(defaultTimezone);</span>
<a href="#l53.81"></a><span id="l53.81">     let start = startDate.clone();</span>
<a href="#l53.82"></a><span id="l53.82">     let end = endDate.clone();</span>
<a href="#l53.83"></a><span id="l53.83">     start.isDate = true;</span>
<a href="#l53.84"></a><span id="l53.84">     end.isDate = true;</span>
<a href="#l53.85"></a><span id="l53.85">     if (start.compare(end) == 0) {</span>
<a href="#l53.86"></a><span id="l53.86">       // Events that start and end in the same day.</span>
<a href="#l53.87"></a><span id="l53.87">       return dateFormatter.formatTimeInterval(startDate, endDate);</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-    } else {</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineminus">-      // Events that span two or more days.</span>
<a href="#l53.90"></a><span id="l53.90" class="difflineminus">-      let compareStart = aBoxDate.compare(start);</span>
<a href="#l53.91"></a><span id="l53.91" class="difflineminus">-      let compareEnd = aBoxDate.compare(end);</span>
<a href="#l53.92"></a><span id="l53.92" class="difflineminus">-      if (compareStart == 0) {</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-        return &quot;\u21e4 &quot; + dateFormatter.formatTime(startDate); // unicode '⇤'</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineminus">-      } else if (compareStart &gt; 0 &amp;&amp; compareEnd &lt; 0) {</span>
<a href="#l53.95"></a><span id="l53.95" class="difflineminus">-        return &quot;\u21ff&quot;; // unicode '↔'</span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-      } else if (compareEnd == 0) {</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineminus">-        return &quot;\u21e5 &quot; + dateFormatter.formatTime(endDate); // unicode '⇥'</span>
<a href="#l53.98"></a><span id="l53.98" class="difflineminus">-      } else {</span>
<a href="#l53.99"></a><span id="l53.99" class="difflineminus">-        return &quot;&quot;;</span>
<a href="#l53.100"></a><span id="l53.100" class="difflineminus">-      }</span>
<a href="#l53.101"></a><span id="l53.101">     }</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineplus">+    // Events that span two or more days.</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineplus">+    let compareStart = aBoxDate.compare(start);</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+    let compareEnd = aBoxDate.compare(end);</span>
<a href="#l53.105"></a><span id="l53.105" class="difflineplus">+    if (compareStart == 0) {</span>
<a href="#l53.106"></a><span id="l53.106" class="difflineplus">+      return &quot;\u21e4 &quot; + dateFormatter.formatTime(startDate); // unicode '⇤'</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineplus">+    } else if (compareStart &gt; 0 &amp;&amp; compareEnd &lt; 0) {</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineplus">+      return &quot;\u21ff&quot;; // unicode '↔'</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+    } else if (compareEnd == 0) {</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+      return &quot;\u21e5 &quot; + dateFormatter.formatTime(endDate); // unicode '⇥'</span>
<a href="#l53.111"></a><span id="l53.111" class="difflineplus">+    }</span>
<a href="#l53.112"></a><span id="l53.112" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l53.113"></a><span id="l53.113">   },</span>
<a href="#l53.114"></a><span id="l53.114"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/calendar/base/modules/utils/calProviderUtils.jsm</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -28,23 +28,17 @@ var calprovider = {</span>
<a href="#l54.4"></a><span id="l54.4">    *                                                            data. In the latter case the</span>
<a href="#l54.5"></a><span id="l54.5">    *                                                            string will be converted to an</span>
<a href="#l54.6"></a><span id="l54.6">    *                                                            input stream.</span>
<a href="#l54.7"></a><span id="l54.7">    * @param {String} aContentType                             Value for Content-Type header, if any</span>
<a href="#l54.8"></a><span id="l54.8">    * @param {nsIInterfaceRequestor} aNotificationCallbacks    Calendar using channel</span>
<a href="#l54.9"></a><span id="l54.9">    * @param {?nsIChannel} aExisting                           An existing channel to modify (optional)</span>
<a href="#l54.10"></a><span id="l54.10">    * @return {nsIChannel}                                     The prepared channel</span>
<a href="#l54.11"></a><span id="l54.11">    */</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-  prepHttpChannel: function(</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-    aUri,</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-    aUploadData,</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-    aContentType,</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-    aNotificationCallbacks,</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineminus">-    aExisting = null</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineminus">-  ) {</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+  prepHttpChannel(aUri, aUploadData, aContentType, aNotificationCallbacks, aExisting = null) {</span>
<a href="#l54.20"></a><span id="l54.20">     let originAttributes = {};</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22">     // The current nsIHttpChannel implementation separates connections only</span>
<a href="#l54.23"></a><span id="l54.23">     // by hosts, which causes issues with cookies and password caching for</span>
<a href="#l54.24"></a><span id="l54.24">     // two or more simultaneous connections to the same host and different</span>
<a href="#l54.25"></a><span id="l54.25">     // authenticated users. This can be solved by providing the additional</span>
<a href="#l54.26"></a><span id="l54.26">     // userContextId, which also separates connections (a.k.a. containers).</span>
<a href="#l54.27"></a><span id="l54.27">     // Connections for userA @ server1 and userA @ server2 can exist in the</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineat">@@ -106,27 +100,27 @@ var calprovider = {</span>
<a href="#l54.29"></a><span id="l54.29"> </span>
<a href="#l54.30"></a><span id="l54.30">   /**</span>
<a href="#l54.31"></a><span id="l54.31">    * Send prepared HTTP request asynchronously</span>
<a href="#l54.32"></a><span id="l54.32">    *</span>
<a href="#l54.33"></a><span id="l54.33">    * @param {nsIStreamLoader} aStreamLoader       Stream loader for request</span>
<a href="#l54.34"></a><span id="l54.34">    * @param {nsIChannel} aChannel                 Channel for request</span>
<a href="#l54.35"></a><span id="l54.35">    * @param {nsIStreamLoaderObserver} aListener   Listener for method completion</span>
<a href="#l54.36"></a><span id="l54.36">    */</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-  sendHttpRequest: function(aStreamLoader, aChannel, aListener) {</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+  sendHttpRequest(aStreamLoader, aChannel, aListener) {</span>
<a href="#l54.39"></a><span id="l54.39">     aStreamLoader.init(aListener);</span>
<a href="#l54.40"></a><span id="l54.40">     aChannel.asyncOpen(aStreamLoader);</span>
<a href="#l54.41"></a><span id="l54.41">   },</span>
<a href="#l54.42"></a><span id="l54.42"> </span>
<a href="#l54.43"></a><span id="l54.43">   /**</span>
<a href="#l54.44"></a><span id="l54.44">    * Shortcut to create an nsIStreamLoader</span>
<a href="#l54.45"></a><span id="l54.45">    *</span>
<a href="#l54.46"></a><span id="l54.46">    * @return {nsIStreamLoader}        A fresh streamloader</span>
<a href="#l54.47"></a><span id="l54.47">    */</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-  createStreamLoader: function() {</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineplus">+  createStreamLoader() {</span>
<a href="#l54.50"></a><span id="l54.50">     return Cc[&quot;@mozilla.org/network/stream-loader;1&quot;].createInstance(Ci.nsIStreamLoader);</span>
<a href="#l54.51"></a><span id="l54.51">   },</span>
<a href="#l54.52"></a><span id="l54.52"> </span>
<a href="#l54.53"></a><span id="l54.53">   /**</span>
<a href="#l54.54"></a><span id="l54.54">    * getInterface method for providers. This should be called in the context of</span>
<a href="#l54.55"></a><span id="l54.55">    * the respective provider, i.e</span>
<a href="#l54.56"></a><span id="l54.56">    *</span>
<a href="#l54.57"></a><span id="l54.57">    * return cal.provider.InterfaceRequestor_getInterface.apply(this, arguments);</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineat">@@ -139,33 +133,32 @@ var calprovider = {</span>
<a href="#l54.59"></a><span id="l54.59">    * NOTE: If the server only provides one realm for all calendars, be sure that</span>
<a href="#l54.60"></a><span id="l54.60">    * the |this| object implements calICalendar. In this case the calendar name</span>
<a href="#l54.61"></a><span id="l54.61">    * will be appended to the realm. If you need that feature disabled, see the</span>
<a href="#l54.62"></a><span id="l54.62">    * capabilities section of calICalendar.idl</span>
<a href="#l54.63"></a><span id="l54.63">    *</span>
<a href="#l54.64"></a><span id="l54.64">    * @param {nsIIDRef} aIID       The interface ID to return</span>
<a href="#l54.65"></a><span id="l54.65">    * @return {nsISupports}        The requested interface</span>
<a href="#l54.66"></a><span id="l54.66">    */</span>
<a href="#l54.67"></a><span id="l54.67" class="difflineminus">-  InterfaceRequestor_getInterface: function(aIID) {</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineplus">+  InterfaceRequestor_getInterface(aIID) {</span>
<a href="#l54.69"></a><span id="l54.69">     try {</span>
<a href="#l54.70"></a><span id="l54.70">       // Try to query the this object for the requested interface but don't</span>
<a href="#l54.71"></a><span id="l54.71">       // throw if it fails since that borks the network code.</span>
<a href="#l54.72"></a><span id="l54.72">       return this.QueryInterface(aIID);</span>
<a href="#l54.73"></a><span id="l54.73">     } catch (e) {</span>
<a href="#l54.74"></a><span id="l54.74">       // Support Auth Prompt Interfaces</span>
<a href="#l54.75"></a><span id="l54.75">       if (aIID.equals(Ci.nsIAuthPrompt2)) {</span>
<a href="#l54.76"></a><span id="l54.76">         if (!this.calAuthPrompt) {</span>
<a href="#l54.77"></a><span id="l54.77">           this.calAuthPrompt = new cal.auth.Prompt();</span>
<a href="#l54.78"></a><span id="l54.78">         }</span>
<a href="#l54.79"></a><span id="l54.79">         return this.calAuthPrompt;</span>
<a href="#l54.80"></a><span id="l54.80">       } else if (aIID.equals(Ci.nsIAuthPromptProvider) || aIID.equals(Ci.nsIPrompt)) {</span>
<a href="#l54.81"></a><span id="l54.81">         return Services.ww.getNewPrompter(null);</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-      } else {</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineminus">-        Components.returnCode = e;</span>
<a href="#l54.84"></a><span id="l54.84">       }</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineplus">+      Components.returnCode = e;</span>
<a href="#l54.86"></a><span id="l54.86">     }</span>
<a href="#l54.87"></a><span id="l54.87">     return null;</span>
<a href="#l54.88"></a><span id="l54.88">   },</span>
<a href="#l54.89"></a><span id="l54.89"> </span>
<a href="#l54.90"></a><span id="l54.90">   // TODO: Add new error handling that uses this code. See bug 1547096.</span>
<a href="#l54.91"></a><span id="l54.91">   /**</span>
<a href="#l54.92"></a><span id="l54.92">    * Bad Certificate Handler for Network Requests. Shows the Network Exception</span>
<a href="#l54.93"></a><span id="l54.93">    * Dialog if a certificate Problem occurs.</span>
<a href="#l54.94"></a><span id="l54.94" class="difflineat">@@ -180,17 +173,17 @@ var calprovider = {</span>
<a href="#l54.95"></a><span id="l54.95">       // Unfortunately we can't pass js objects using the window watcher, so</span>
<a href="#l54.96"></a><span id="l54.96">       // we'll just take the first available calendar window. We also need to</span>
<a href="#l54.97"></a><span id="l54.97">       // do this on a timer so that the modal window doesn't block the</span>
<a href="#l54.98"></a><span id="l54.98">       // network request.</span>
<a href="#l54.99"></a><span id="l54.99">       let calWindow = cal.window.getCalendarWindow();</span>
<a href="#l54.100"></a><span id="l54.100"> </span>
<a href="#l54.101"></a><span id="l54.101">       let timerCallback = {</span>
<a href="#l54.102"></a><span id="l54.102">         thisProvider: this.thisProvider,</span>
<a href="#l54.103"></a><span id="l54.103" class="difflineminus">-        notify: function(timer) {</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineplus">+        notify(timer) {</span>
<a href="#l54.105"></a><span id="l54.105">           let params = {</span>
<a href="#l54.106"></a><span id="l54.106">             exceptionAdded: false,</span>
<a href="#l54.107"></a><span id="l54.107">             securityInfo: secInfo,</span>
<a href="#l54.108"></a><span id="l54.108">             prefetchCert: true,</span>
<a href="#l54.109"></a><span id="l54.109">             location: targetSite,</span>
<a href="#l54.110"></a><span id="l54.110">           };</span>
<a href="#l54.111"></a><span id="l54.111">           calWindow.openDialog(</span>
<a href="#l54.112"></a><span id="l54.112">             &quot;chrome://pippki/content/exceptionDialog.xhtml&quot;,</span>
<a href="#l54.113"></a><span id="l54.113" class="difflineat">@@ -236,34 +229,34 @@ var calprovider = {</span>
<a href="#l54.114"></a><span id="l54.114">   },</span>
<a href="#l54.115"></a><span id="l54.115"> </span>
<a href="#l54.116"></a><span id="l54.116">   /**</span>
<a href="#l54.117"></a><span id="l54.117">    * Gets the iTIP/iMIP transport if the passed calendar has configured email.</span>
<a href="#l54.118"></a><span id="l54.118">    *</span>
<a href="#l54.119"></a><span id="l54.119">    * @param {calICalendar} aCalendar      The calendar to get the transport for</span>
<a href="#l54.120"></a><span id="l54.120">    * @return {?calIItipTransport}         The email transport, or null if no identity configured</span>
<a href="#l54.121"></a><span id="l54.121">    */</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineminus">-  getImipTransport: function(aCalendar) {</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineplus">+  getImipTransport(aCalendar) {</span>
<a href="#l54.124"></a><span id="l54.124">     // assure an identity is configured for the calendar</span>
<a href="#l54.125"></a><span id="l54.125">     if (aCalendar &amp;&amp; aCalendar.getProperty(&quot;imip.identity&quot;)) {</span>
<a href="#l54.126"></a><span id="l54.126">       return Cc[&quot;@mozilla.org/calendar/itip-transport;1?type=email&quot;].getService(</span>
<a href="#l54.127"></a><span id="l54.127">         Ci.calIItipTransport</span>
<a href="#l54.128"></a><span id="l54.128">       );</span>
<a href="#l54.129"></a><span id="l54.129">     }</span>
<a href="#l54.130"></a><span id="l54.130">     return null;</span>
<a href="#l54.131"></a><span id="l54.131">   },</span>
<a href="#l54.132"></a><span id="l54.132"> </span>
<a href="#l54.133"></a><span id="l54.133">   /**</span>
<a href="#l54.134"></a><span id="l54.134">    * Gets the configured identity and account of a particular calendar instance, or null.</span>
<a href="#l54.135"></a><span id="l54.135">    *</span>
<a href="#l54.136"></a><span id="l54.136">    * @param {calICalendar} aCalendar      Calendar instance</span>
<a href="#l54.137"></a><span id="l54.137">    * @param {?Object} outAccount          Optional out value for account</span>
<a href="#l54.138"></a><span id="l54.138">    * @return {nsIMsgIdentity}             The configured identity</span>
<a href="#l54.139"></a><span id="l54.139">    */</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineminus">-  getEmailIdentityOfCalendar: function(aCalendar, outAccount) {</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineplus">+  getEmailIdentityOfCalendar(aCalendar, outAccount) {</span>
<a href="#l54.142"></a><span id="l54.142">     cal.ASSERT(aCalendar, &quot;no calendar!&quot;, Cr.NS_ERROR_INVALID_ARG);</span>
<a href="#l54.143"></a><span id="l54.143">     let key = aCalendar.getProperty(&quot;imip.identity.key&quot;);</span>
<a href="#l54.144"></a><span id="l54.144">     if (key === null) {</span>
<a href="#l54.145"></a><span id="l54.145">       // take default account/identity:</span>
<a href="#l54.146"></a><span id="l54.146">       let findIdentity = function(account) {</span>
<a href="#l54.147"></a><span id="l54.147">         if (account &amp;&amp; account.identities.length) {</span>
<a href="#l54.148"></a><span id="l54.148">           return account.defaultIdentity || account.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l54.149"></a><span id="l54.149">         }</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineat">@@ -285,52 +278,51 @@ var calprovider = {</span>
<a href="#l54.151"></a><span id="l54.151">           }</span>
<a href="#l54.152"></a><span id="l54.152">         }</span>
<a href="#l54.153"></a><span id="l54.153">       }</span>
<a href="#l54.154"></a><span id="l54.154"> </span>
<a href="#l54.155"></a><span id="l54.155">       if (outAccount) {</span>
<a href="#l54.156"></a><span id="l54.156">         outAccount.value = foundIdentity ? foundAccount : null;</span>
<a href="#l54.157"></a><span id="l54.157">       }</span>
<a href="#l54.158"></a><span id="l54.158">       return foundIdentity;</span>
<a href="#l54.159"></a><span id="l54.159" class="difflineminus">-    } else {</span>
<a href="#l54.160"></a><span id="l54.160" class="difflineminus">-      if (key.length == 0) {</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineminus">-        // i.e. &quot;None&quot;</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-        return null;</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineminus">-      }</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineminus">-      let identity = null;</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineminus">-      cal.email.iterateIdentities((identity_, account) =&gt; {</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineminus">-        if (identity_.key == key) {</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineminus">-          identity = identity_;</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineminus">-          if (outAccount) {</span>
<a href="#l54.169"></a><span id="l54.169" class="difflineminus">-            outAccount.value = account;</span>
<a href="#l54.170"></a><span id="l54.170" class="difflineminus">-          }</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineplus">+    }</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineplus">+    if (key.length == 0) {</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineplus">+      // i.e. &quot;None&quot;</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineplus">+      return null;</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineplus">+    }</span>
<a href="#l54.176"></a><span id="l54.176" class="difflineplus">+    let identity = null;</span>
<a href="#l54.177"></a><span id="l54.177" class="difflineplus">+    cal.email.iterateIdentities((identity_, account) =&gt; {</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineplus">+      if (identity_.key == key) {</span>
<a href="#l54.179"></a><span id="l54.179" class="difflineplus">+        identity = identity_;</span>
<a href="#l54.180"></a><span id="l54.180" class="difflineplus">+        if (outAccount) {</span>
<a href="#l54.181"></a><span id="l54.181" class="difflineplus">+          outAccount.value = account;</span>
<a href="#l54.182"></a><span id="l54.182">         }</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineminus">-        return identity_.key != key;</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineminus">-      });</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineplus">+      }</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineplus">+      return identity_.key != key;</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineplus">+    });</span>
<a href="#l54.188"></a><span id="l54.188"> </span>
<a href="#l54.189"></a><span id="l54.189" class="difflineminus">-      if (!identity) {</span>
<a href="#l54.190"></a><span id="l54.190" class="difflineminus">-        // dangling identity:</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineminus">-        cal.WARN(</span>
<a href="#l54.192"></a><span id="l54.192" class="difflineminus">-          &quot;Calendar &quot; +</span>
<a href="#l54.193"></a><span id="l54.193" class="difflineminus">-            (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l54.194"></a><span id="l54.194" class="difflineminus">-            &quot; has a dangling E-Mail identity configured.&quot;</span>
<a href="#l54.195"></a><span id="l54.195" class="difflineminus">-        );</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-      }</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineminus">-      return identity;</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineplus">+    if (!identity) {</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineplus">+      // dangling identity:</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineplus">+      cal.WARN(</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineplus">+        &quot;Calendar &quot; +</span>
<a href="#l54.202"></a><span id="l54.202" class="difflineplus">+          (aCalendar.uri ? aCalendar.uri.spec : aCalendar.id) +</span>
<a href="#l54.203"></a><span id="l54.203" class="difflineplus">+          &quot; has a dangling E-Mail identity configured.&quot;</span>
<a href="#l54.204"></a><span id="l54.204" class="difflineplus">+      );</span>
<a href="#l54.205"></a><span id="l54.205">     }</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineplus">+    return identity;</span>
<a href="#l54.207"></a><span id="l54.207">   },</span>
<a href="#l54.208"></a><span id="l54.208"> </span>
<a href="#l54.209"></a><span id="l54.209">   /**</span>
<a href="#l54.210"></a><span id="l54.210">    * Opens the calendar conflict dialog</span>
<a href="#l54.211"></a><span id="l54.211">    *</span>
<a href="#l54.212"></a><span id="l54.212">    * @param {String} aMode        The conflict mode, either &quot;modify&quot; or &quot;delete&quot;</span>
<a href="#l54.213"></a><span id="l54.213">    * @param {calIItemBase} aItem  The item to raise a conflict for</span>
<a href="#l54.214"></a><span id="l54.214">    * @return {Boolean}            True, if the item should be overwritten</span>
<a href="#l54.215"></a><span id="l54.215">    */</span>
<a href="#l54.216"></a><span id="l54.216" class="difflineminus">-  promptOverwrite: function(aMode, aItem) {</span>
<a href="#l54.217"></a><span id="l54.217" class="difflineplus">+  promptOverwrite(aMode, aItem) {</span>
<a href="#l54.218"></a><span id="l54.218">     let window = cal.window.getCalendarWindow();</span>
<a href="#l54.219"></a><span id="l54.219">     let args = {</span>
<a href="#l54.220"></a><span id="l54.220">       item: aItem,</span>
<a href="#l54.221"></a><span id="l54.221">       mode: aMode,</span>
<a href="#l54.222"></a><span id="l54.222">       overwrite: false,</span>
<a href="#l54.223"></a><span id="l54.223">     };</span>
<a href="#l54.224"></a><span id="l54.224"> </span>
<a href="#l54.225"></a><span id="l54.225">     window.openDialog(</span>
<a href="#l54.226"></a><span id="l54.226" class="difflineat">@@ -343,17 +335,17 @@ var calprovider = {</span>
<a href="#l54.227"></a><span id="l54.227">     return args.overwrite;</span>
<a href="#l54.228"></a><span id="l54.228">   },</span>
<a href="#l54.229"></a><span id="l54.229"> </span>
<a href="#l54.230"></a><span id="l54.230">   /**</span>
<a href="#l54.231"></a><span id="l54.231">    * Gets the calendar directory, defaults to &lt;profile-dir&gt;/calendar-data</span>
<a href="#l54.232"></a><span id="l54.232">    *</span>
<a href="#l54.233"></a><span id="l54.233">    * @return {nsIFile}        The calendar-data directory as nsIFile</span>
<a href="#l54.234"></a><span id="l54.234">    */</span>
<a href="#l54.235"></a><span id="l54.235" class="difflineminus">-  getCalendarDirectory: function() {</span>
<a href="#l54.236"></a><span id="l54.236" class="difflineplus">+  getCalendarDirectory() {</span>
<a href="#l54.237"></a><span id="l54.237">     if (calprovider.getCalendarDirectory.mDir === undefined) {</span>
<a href="#l54.238"></a><span id="l54.238">       let dir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l54.239"></a><span id="l54.239">       dir.append(&quot;calendar-data&quot;);</span>
<a href="#l54.240"></a><span id="l54.240">       if (!dir.exists()) {</span>
<a href="#l54.241"></a><span id="l54.241">         try {</span>
<a href="#l54.242"></a><span id="l54.242">           dir.create(Ci.nsIFile.DIRECTORY_TYPE, 0o700);</span>
<a href="#l54.243"></a><span id="l54.243">         } catch (exc) {</span>
<a href="#l54.244"></a><span id="l54.244">           cal.ASSERT(false, exc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/calendar/base/modules/utils/calUnifinderUtils.jsm</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/calendar/base/modules/utils/calUnifinderUtils.jsm</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -17,17 +17,17 @@ var calunifinder = {</span>
<a href="#l55.4"></a><span id="l55.4">   /**</span>
<a href="#l55.5"></a><span id="l55.5">    * Retrieves the value that is used for comparison for the item with the given</span>
<a href="#l55.6"></a><span id="l55.6">    * property.</span>
<a href="#l55.7"></a><span id="l55.7">    *</span>
<a href="#l55.8"></a><span id="l55.8">    * @param {calIItemBaes} aItem      The item to retrieve the sort key for</span>
<a href="#l55.9"></a><span id="l55.9">    * @param {String} aKey             The property name that should be sorted</span>
<a href="#l55.10"></a><span id="l55.10">    * @return {*}                      The value used in sort comparison</span>
<a href="#l55.11"></a><span id="l55.11">    */</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-  getItemSortKey: function(aItem, aKey) {</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+  getItemSortKey(aItem, aKey) {</span>
<a href="#l55.14"></a><span id="l55.14">     const taskStatus = [&quot;NEEDS-ACTION&quot;, &quot;IN-PROCESS&quot;, &quot;COMPLETED&quot;, &quot;CANCELLED&quot;];</span>
<a href="#l55.15"></a><span id="l55.15">     const eventStatus = [&quot;TENTATIVE&quot;, &quot;CONFIRMED&quot;, &quot;CANCELLED&quot;];</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17">     switch (aKey) {</span>
<a href="#l55.18"></a><span id="l55.18">       case &quot;priority&quot;:</span>
<a href="#l55.19"></a><span id="l55.19">         return aItem.priority || 5;</span>
<a href="#l55.20"></a><span id="l55.20"> </span>
<a href="#l55.21"></a><span id="l55.21">       case &quot;title&quot;:</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineat">@@ -65,17 +65,17 @@ var calunifinder = {</span>
<a href="#l55.23"></a><span id="l55.23">   },</span>
<a href="#l55.24"></a><span id="l55.24"> </span>
<a href="#l55.25"></a><span id="l55.25">   /**</span>
<a href="#l55.26"></a><span id="l55.26">    * Returns a sort function for the given sort type.</span>
<a href="#l55.27"></a><span id="l55.27">    *</span>
<a href="#l55.28"></a><span id="l55.28">    * @param {String} aSortKey             The sort key to get the compare function for</span>
<a href="#l55.29"></a><span id="l55.29">    * @return {Function}                   The function to be used for sorting values of the type</span>
<a href="#l55.30"></a><span id="l55.30">    */</span>
<a href="#l55.31"></a><span id="l55.31" class="difflineminus">-  sortEntryComparer: function(aSortKey) {</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineplus">+  sortEntryComparer(aSortKey) {</span>
<a href="#l55.33"></a><span id="l55.33">     switch (aSortKey) {</span>
<a href="#l55.34"></a><span id="l55.34">       case &quot;title&quot;:</span>
<a href="#l55.35"></a><span id="l55.35">       case &quot;categories&quot;:</span>
<a href="#l55.36"></a><span id="l55.36">       case &quot;location&quot;:</span>
<a href="#l55.37"></a><span id="l55.37">       case &quot;calendar&quot;:</span>
<a href="#l55.38"></a><span id="l55.38">         return sortCompare.string;</span>
<a href="#l55.39"></a><span id="l55.39"> </span>
<a href="#l55.40"></a><span id="l55.40">       // All dates use &quot;date_filled&quot;</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineat">@@ -98,17 +98,17 @@ var calunifinder = {</span>
<a href="#l55.42"></a><span id="l55.42">   /**</span>
<a href="#l55.43"></a><span id="l55.43">    * Sort the unifinder items by the given sort key, using the modifier to flip direction. The</span>
<a href="#l55.44"></a><span id="l55.44">    * items are sorted in place.</span>
<a href="#l55.45"></a><span id="l55.45">    *</span>
<a href="#l55.46"></a><span id="l55.46">    * @param {calIItemBase[]} aItems           The items to sort</span>
<a href="#l55.47"></a><span id="l55.47">    * @param {String} aSortKey                 The item sort key</span>
<a href="#l55.48"></a><span id="l55.48">    * @param {?Number} aModifier               Either 1 or -1, to indicate sort direction</span>
<a href="#l55.49"></a><span id="l55.49">    */</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-  sortItems: function(aItems, aSortKey, aModifier = 1) {</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+  sortItems(aItems, aSortKey, aModifier = 1) {</span>
<a href="#l55.52"></a><span id="l55.52">     let comparer = calunifinder.sortEntryComparer(aSortKey);</span>
<a href="#l55.53"></a><span id="l55.53">     aItems.sort((a, b) =&gt; {</span>
<a href="#l55.54"></a><span id="l55.54">       let sortvalA = calunifinder.getItemSortKey(a, aSortKey);</span>
<a href="#l55.55"></a><span id="l55.55">       let sortvalB = calunifinder.getItemSortKey(b, aSortKey);</span>
<a href="#l55.56"></a><span id="l55.56">       return comparer(sortvalA, sortvalB, aModifier);</span>
<a href="#l55.57"></a><span id="l55.57">     });</span>
<a href="#l55.58"></a><span id="l55.58">   },</span>
<a href="#l55.59"></a><span id="l55.59"> };</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineat">@@ -121,75 +121,74 @@ const sortCompare = (calunifinder.sortEn</span>
<a href="#l55.61"></a><span id="l55.61">   /**</span>
<a href="#l55.62"></a><span id="l55.62">    * Compare two things as if they were numbers.</span>
<a href="#l55.63"></a><span id="l55.63">    *</span>
<a href="#l55.64"></a><span id="l55.64">    * @param {*} a                 The first thing to compare</span>
<a href="#l55.65"></a><span id="l55.65">    * @param {*} b                 The second thing to compare</span>
<a href="#l55.66"></a><span id="l55.66">    * @param {Number} modifier     -1 to flip direction, or 1</span>
<a href="#l55.67"></a><span id="l55.67">    * @return {Number}             Either -1, 0, or 1</span>
<a href="#l55.68"></a><span id="l55.68">    */</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineminus">-  number: function(a, b, modifier = 1) {</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+  number(a, b, modifier = 1) {</span>
<a href="#l55.71"></a><span id="l55.71">     return sortCompare.general(Number(a), Number(b), modifier);</span>
<a href="#l55.72"></a><span id="l55.72">   },</span>
<a href="#l55.73"></a><span id="l55.73"> </span>
<a href="#l55.74"></a><span id="l55.74">   /**</span>
<a href="#l55.75"></a><span id="l55.75">    * Compare two things as if they were dates.</span>
<a href="#l55.76"></a><span id="l55.76">    *</span>
<a href="#l55.77"></a><span id="l55.77">    * @param {*} a                 The first thing to compare</span>
<a href="#l55.78"></a><span id="l55.78">    * @param {*} b                 The second thing to compare</span>
<a href="#l55.79"></a><span id="l55.79">    * @param {Number} modifier     -1 to flip direction, or 1</span>
<a href="#l55.80"></a><span id="l55.80">    * @return {Number}             Either -1, 0, or 1</span>
<a href="#l55.81"></a><span id="l55.81">    */</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineminus">-  date: function(a, b, modifier = 1) {</span>
<a href="#l55.83"></a><span id="l55.83" class="difflineplus">+  date(a, b, modifier = 1) {</span>
<a href="#l55.84"></a><span id="l55.84">     return sortCompare.general(a, b, modifier);</span>
<a href="#l55.85"></a><span id="l55.85">   },</span>
<a href="#l55.86"></a><span id="l55.86"> </span>
<a href="#l55.87"></a><span id="l55.87">   /**</span>
<a href="#l55.88"></a><span id="l55.88">    * Compare two things generally, using the typical ((a &gt; b) - (a &lt; b))</span>
<a href="#l55.89"></a><span id="l55.89">    *</span>
<a href="#l55.90"></a><span id="l55.90">    * @param {*} a                 The first thing to compare</span>
<a href="#l55.91"></a><span id="l55.91">    * @param {*} b                 The second thing to compare</span>
<a href="#l55.92"></a><span id="l55.92">    * @param {Number} modifier     -1 to flip direction, or 1</span>
<a href="#l55.93"></a><span id="l55.93">    * @return {Number}             Either -1, 0, or 1</span>
<a href="#l55.94"></a><span id="l55.94">    */</span>
<a href="#l55.95"></a><span id="l55.95" class="difflineminus">-  general: function(a, b, modifier = 1) {</span>
<a href="#l55.96"></a><span id="l55.96" class="difflineplus">+  general(a, b, modifier = 1) {</span>
<a href="#l55.97"></a><span id="l55.97">     return ((a &gt; b) - (a &lt; b)) * modifier;</span>
<a href="#l55.98"></a><span id="l55.98">   },</span>
<a href="#l55.99"></a><span id="l55.99"> </span>
<a href="#l55.100"></a><span id="l55.100">   /**</span>
<a href="#l55.101"></a><span id="l55.101">    * Compare two dates, keeping the nativeTime zero date in mind.</span>
<a href="#l55.102"></a><span id="l55.102">    *</span>
<a href="#l55.103"></a><span id="l55.103">    * @param {*} a                 The first date to compare</span>
<a href="#l55.104"></a><span id="l55.104">    * @param {*} b                 The second date to compare</span>
<a href="#l55.105"></a><span id="l55.105">    * @param {Number} modifier     -1 to flip direction, or 1</span>
<a href="#l55.106"></a><span id="l55.106">    * @return {Number}             Either -1, 0, or 1</span>
<a href="#l55.107"></a><span id="l55.107">    */</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineminus">-  date_filled: function(a, b, modifier = 1) {</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineplus">+  date_filled(a, b, modifier = 1) {</span>
<a href="#l55.110"></a><span id="l55.110">     const NULL_DATE = -62168601600000000;</span>
<a href="#l55.111"></a><span id="l55.111"> </span>
<a href="#l55.112"></a><span id="l55.112">     if (a == b) {</span>
<a href="#l55.113"></a><span id="l55.113">       return 0;</span>
<a href="#l55.114"></a><span id="l55.114">     } else if (a == NULL_DATE) {</span>
<a href="#l55.115"></a><span id="l55.115">       return 1;</span>
<a href="#l55.116"></a><span id="l55.116">     } else if (b == NULL_DATE) {</span>
<a href="#l55.117"></a><span id="l55.117">       return -1;</span>
<a href="#l55.118"></a><span id="l55.118" class="difflineminus">-    } else {</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineminus">-      return sortCompare.general(a, b, modifier);</span>
<a href="#l55.120"></a><span id="l55.120">     }</span>
<a href="#l55.121"></a><span id="l55.121" class="difflineplus">+    return sortCompare.general(a, b, modifier);</span>
<a href="#l55.122"></a><span id="l55.122">   },</span>
<a href="#l55.123"></a><span id="l55.123"> </span>
<a href="#l55.124"></a><span id="l55.124">   /**</span>
<a href="#l55.125"></a><span id="l55.125">    * Compare two strings, sorting empty values to the end by default</span>
<a href="#l55.126"></a><span id="l55.126">    *</span>
<a href="#l55.127"></a><span id="l55.127">    * @param {*} a                 The first string to compare</span>
<a href="#l55.128"></a><span id="l55.128">    * @param {*} b                 The second string to compare</span>
<a href="#l55.129"></a><span id="l55.129">    * @param {Number} modifier     -1 to flip direction, or 1</span>
<a href="#l55.130"></a><span id="l55.130">    * @return {Number}             Either -1, 0, or 1</span>
<a href="#l55.131"></a><span id="l55.131">    */</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineminus">-  string: function(a, b, modifier = 1) {</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineplus">+  string(a, b, modifier = 1) {</span>
<a href="#l55.134"></a><span id="l55.134">     if (a.length == 0 || b.length == 0) {</span>
<a href="#l55.135"></a><span id="l55.135">       // sort empty values to end (so when users first sort by a</span>
<a href="#l55.136"></a><span id="l55.136">       // column, they can see and find the desired values in that</span>
<a href="#l55.137"></a><span id="l55.137">       // column without scrolling past all the empty values).</span>
<a href="#l55.138"></a><span id="l55.138">       return -(a.length - b.length) * modifier;</span>
<a href="#l55.139"></a><span id="l55.139">     }</span>
<a href="#l55.140"></a><span id="l55.140"> </span>
<a href="#l55.141"></a><span id="l55.141">     return a.localeCompare(b, undefined, { numeric: true }) * modifier;</span>
<a href="#l55.142"></a><span id="l55.142" class="difflineat">@@ -198,12 +197,12 @@ const sortCompare = (calunifinder.sortEn</span>
<a href="#l55.143"></a><span id="l55.143">   /**</span>
<a href="#l55.144"></a><span id="l55.144">    * Catch-all function to compare two unknown values. Will return 0.</span>
<a href="#l55.145"></a><span id="l55.145">    *</span>
<a href="#l55.146"></a><span id="l55.146">    * @param {*} a                 The first thing to compare</span>
<a href="#l55.147"></a><span id="l55.147">    * @param {*} b                 The second thing to compare</span>
<a href="#l55.148"></a><span id="l55.148">    * @param {Number} modifier     Provided for consistency, but unused</span>
<a href="#l55.149"></a><span id="l55.149">    * @return {Number}             Will always return 0</span>
<a href="#l55.150"></a><span id="l55.150">    */</span>
<a href="#l55.151"></a><span id="l55.151" class="difflineminus">-  unknown: function(a, b, modifier = 1) {</span>
<a href="#l55.152"></a><span id="l55.152" class="difflineplus">+  unknown(a, b, modifier = 1) {</span>
<a href="#l55.153"></a><span id="l55.153">     return 0;</span>
<a href="#l55.154"></a><span id="l55.154">   },</span>
<a href="#l55.155"></a><span id="l55.155"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/calendar/base/modules/utils/calViewUtils.jsm</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/calendar/base/modules/utils/calViewUtils.jsm</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -19,17 +19,17 @@ var calview = {</span>
<a href="#l56.4"></a><span id="l56.4">   /**</span>
<a href="#l56.5"></a><span id="l56.5">    * Checks if the mousepointer of an event resides over a XULBox during an event</span>
<a href="#l56.6"></a><span id="l56.6">    *</span>
<a href="#l56.7"></a><span id="l56.7">    * @param aMouseEvent   The event eg. a 'mouseout' or 'mousedown' event</span>
<a href="#l56.8"></a><span id="l56.8">    * @param aXULBox       The xul element</span>
<a href="#l56.9"></a><span id="l56.9">    * @return              true or false depending on whether the mouse pointer</span>
<a href="#l56.10"></a><span id="l56.10">    *                      resides over the xulelement</span>
<a href="#l56.11"></a><span id="l56.11">    */</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-  isMouseOverBox: function(aMouseEvent, aXULElement) {</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+  isMouseOverBox(aMouseEvent, aXULElement) {</span>
<a href="#l56.14"></a><span id="l56.14">     let boundingRect = aXULElement.getBoundingClientRect();</span>
<a href="#l56.15"></a><span id="l56.15">     let boxWidth = boundingRect.width;</span>
<a href="#l56.16"></a><span id="l56.16">     let boxHeight = boundingRect.height;</span>
<a href="#l56.17"></a><span id="l56.17">     let boxScreenX = aXULElement.screenX;</span>
<a href="#l56.18"></a><span id="l56.18">     let boxScreenY = aXULElement.screenY;</span>
<a href="#l56.19"></a><span id="l56.19">     let mouseX = aMouseEvent.screenX;</span>
<a href="#l56.20"></a><span id="l56.20">     let mouseY = aMouseEvent.screenY;</span>
<a href="#l56.21"></a><span id="l56.21">     let xIsWithin = mouseX &gt;= boxScreenX &amp;&amp; mouseX &lt;= boxScreenX + boxWidth;</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineat">@@ -40,17 +40,17 @@ var calview = {</span>
<a href="#l56.23"></a><span id="l56.23">   /**</span>
<a href="#l56.24"></a><span id="l56.24">    * Removes those childnodes from a node that contain a specified attribute</span>
<a href="#l56.25"></a><span id="l56.25">    * and where the value of this attribute matches a passed value</span>
<a href="#l56.26"></a><span id="l56.26">    *</span>
<a href="#l56.27"></a><span id="l56.27">    * @param aParentNode   The parent node that contains the child nodes in question</span>
<a href="#l56.28"></a><span id="l56.28">    * @param aAttribute    The name of the attribute</span>
<a href="#l56.29"></a><span id="l56.29">    * @param aAttribute    The value of the attribute</span>
<a href="#l56.30"></a><span id="l56.30">    */</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-  removeChildElementsByAttribute: function(aParentNode, aAttribute, aValue) {</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+  removeChildElementsByAttribute(aParentNode, aAttribute, aValue) {</span>
<a href="#l56.33"></a><span id="l56.33">     let childNode = aParentNode.lastElementChild;</span>
<a href="#l56.34"></a><span id="l56.34">     while (childNode) {</span>
<a href="#l56.35"></a><span id="l56.35">       let prevChildNode = childNode.previousElementSibling;</span>
<a href="#l56.36"></a><span id="l56.36">       if (!aAttribute || aAttribute === undefined) {</span>
<a href="#l56.37"></a><span id="l56.37">         childNode.remove();</span>
<a href="#l56.38"></a><span id="l56.38">       } else if (!aValue || aValue === undefined) {</span>
<a href="#l56.39"></a><span id="l56.39">         childNode.remove();</span>
<a href="#l56.40"></a><span id="l56.40">       } else if (</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineat">@@ -71,17 +71,17 @@ var calview = {</span>
<a href="#l56.42"></a><span id="l56.42">    * @param aChildNode  The childnode.</span>
<a href="#l56.43"></a><span id="l56.43">    * @param aLocalName  The localName of the to-be-returned parent</span>
<a href="#l56.44"></a><span id="l56.44">    *                      that is looked for.</span>
<a href="#l56.45"></a><span id="l56.45">    * @return            The parent with the given localName or the</span>
<a href="#l56.46"></a><span id="l56.46">    *                      given childNode 'aChildNode'. If no appropriate</span>
<a href="#l56.47"></a><span id="l56.47">    *                      parent node with aLocalName could be</span>
<a href="#l56.48"></a><span id="l56.48">    *                      retrieved it is returned 'null'.</span>
<a href="#l56.49"></a><span id="l56.49">    */</span>
<a href="#l56.50"></a><span id="l56.50" class="difflineminus">-  getParentNodeOrThis: function(aChildNode, aLocalName) {</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineplus">+  getParentNodeOrThis(aChildNode, aLocalName) {</span>
<a href="#l56.52"></a><span id="l56.52">     let node = aChildNode;</span>
<a href="#l56.53"></a><span id="l56.53">     while (node &amp;&amp; node.localName != aLocalName) {</span>
<a href="#l56.54"></a><span id="l56.54">       node = node.parentNode;</span>
<a href="#l56.55"></a><span id="l56.55">       if (node.tagName == undefined) {</span>
<a href="#l56.56"></a><span id="l56.56">         return null;</span>
<a href="#l56.57"></a><span id="l56.57">       }</span>
<a href="#l56.58"></a><span id="l56.58">     }</span>
<a href="#l56.59"></a><span id="l56.59">     return node;</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineat">@@ -94,17 +94,17 @@ var calview = {</span>
<a href="#l56.61"></a><span id="l56.61">    * @param aChildNode      The childnode.</span>
<a href="#l56.62"></a><span id="l56.62">    * @param aAttibuteName   The name of the attribute that is to be compared with</span>
<a href="#l56.63"></a><span id="l56.63">    * @param aAttibuteValue  The value of the attribute that is to be compared with</span>
<a href="#l56.64"></a><span id="l56.64">    * @return                The parent with the given attributeName set that has</span>
<a href="#l56.65"></a><span id="l56.65">    *                          the same value as the given given attributevalue</span>
<a href="#l56.66"></a><span id="l56.66">    *                          'aAttributeValue'. If no appropriate</span>
<a href="#l56.67"></a><span id="l56.67">    *                          parent node can be retrieved it is returned 'null'.</span>
<a href="#l56.68"></a><span id="l56.68">    */</span>
<a href="#l56.69"></a><span id="l56.69" class="difflineminus">-  getParentNodeOrThisByAttribute: function(aChildNode, aAttributeName, aAttributeValue) {</span>
<a href="#l56.70"></a><span id="l56.70" class="difflineplus">+  getParentNodeOrThisByAttribute(aChildNode, aAttributeName, aAttributeValue) {</span>
<a href="#l56.71"></a><span id="l56.71">     let node = aChildNode;</span>
<a href="#l56.72"></a><span id="l56.72">     while (node &amp;&amp; node.getAttribute(aAttributeName) != aAttributeValue) {</span>
<a href="#l56.73"></a><span id="l56.73">       node = node.parentNode;</span>
<a href="#l56.74"></a><span id="l56.74">       if (node.tagName == undefined) {</span>
<a href="#l56.75"></a><span id="l56.75">         return null;</span>
<a href="#l56.76"></a><span id="l56.76">       }</span>
<a href="#l56.77"></a><span id="l56.77">     }</span>
<a href="#l56.78"></a><span id="l56.78">     return node;</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineat">@@ -128,17 +128,17 @@ var calview = {</span>
<a href="#l56.80"></a><span id="l56.80">    *              no punctuation, and of course no spaces.</span>
<a href="#l56.81"></a><span id="l56.81">    *   nmchar            [_a-zA-Z0-9-]|{nonascii}|{escape}</span>
<a href="#l56.82"></a><span id="l56.82">    *   name              {nmchar}+</span>
<a href="#l56.83"></a><span id="l56.83">    *   http://www.w3.org/TR/CSS21/grammar.html#scanner</span>
<a href="#l56.84"></a><span id="l56.84">    *</span>
<a href="#l56.85"></a><span id="l56.85">    * @param aString       The unicode string to format</span>
<a href="#l56.86"></a><span id="l56.86">    * @return              The formatted string using only chars [_a-zA-Z0-9-]</span>
<a href="#l56.87"></a><span id="l56.87">    */</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineminus">-  formatStringForCSSRule: function(aString) {</span>
<a href="#l56.89"></a><span id="l56.89" class="difflineplus">+  formatStringForCSSRule(aString) {</span>
<a href="#l56.90"></a><span id="l56.90">     function toReplacement(char) {</span>
<a href="#l56.91"></a><span id="l56.91">       // char code is natural number (positive integer)</span>
<a href="#l56.92"></a><span id="l56.92">       let nat = char.charCodeAt(0);</span>
<a href="#l56.93"></a><span id="l56.93">       switch (nat) {</span>
<a href="#l56.94"></a><span id="l56.94">         case 0x20: // space</span>
<a href="#l56.95"></a><span id="l56.95">           return &quot;_&quot;;</span>
<a href="#l56.96"></a><span id="l56.96">         default:</span>
<a href="#l56.97"></a><span id="l56.97">           return &quot;-ux&quot; + nat.toString(16) + &quot;-&quot;; // lowercase</span>
<a href="#l56.98"></a><span id="l56.98" class="difflineat">@@ -148,17 +148,17 @@ var calview = {</span>
<a href="#l56.99"></a><span id="l56.99">     return aString.toLowerCase().replace(/[^a-zA-Z0-9]/g, toReplacement);</span>
<a href="#l56.100"></a><span id="l56.100">   },</span>
<a href="#l56.101"></a><span id="l56.101"> </span>
<a href="#l56.102"></a><span id="l56.102">   /**</span>
<a href="#l56.103"></a><span id="l56.103">    * Gets the cached instance of the composite calendar.</span>
<a href="#l56.104"></a><span id="l56.104">    *</span>
<a href="#l56.105"></a><span id="l56.105">    * @param aWindow       The window to get the composite calendar for.</span>
<a href="#l56.106"></a><span id="l56.106">    */</span>
<a href="#l56.107"></a><span id="l56.107" class="difflineminus">-  getCompositeCalendar: function(aWindow) {</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineplus">+  getCompositeCalendar(aWindow) {</span>
<a href="#l56.109"></a><span id="l56.109">     if (typeof aWindow._compositeCalendar == &quot;undefined&quot;) {</span>
<a href="#l56.110"></a><span id="l56.110">       let comp = (aWindow._compositeCalendar = Cc[</span>
<a href="#l56.111"></a><span id="l56.111">         &quot;@mozilla.org/calendar/calendar;1?type=composite&quot;</span>
<a href="#l56.112"></a><span id="l56.112">       ].createInstance(Ci.calICompositeCalendar));</span>
<a href="#l56.113"></a><span id="l56.113">       comp.prefPrefix = &quot;calendar-main&quot;;</span>
<a href="#l56.114"></a><span id="l56.114"> </span>
<a href="#l56.115"></a><span id="l56.115">       if (typeof aWindow.gCalendarStatusFeedback != &quot;undefined&quot;) {</span>
<a href="#l56.116"></a><span id="l56.116">         // If we are in a window that has calendar status feedback, set</span>
<a href="#l56.117"></a><span id="l56.117" class="difflineat">@@ -171,17 +171,17 @@ var calview = {</span>
<a href="#l56.118"></a><span id="l56.118"> </span>
<a href="#l56.119"></a><span id="l56.119">   /**</span>
<a href="#l56.120"></a><span id="l56.120">    * Hash the given string into a color from the color palette of the standard</span>
<a href="#l56.121"></a><span id="l56.121">    * color picker.</span>
<a href="#l56.122"></a><span id="l56.122">    *</span>
<a href="#l56.123"></a><span id="l56.123">    * @param str           The string to hash into a color.</span>
<a href="#l56.124"></a><span id="l56.124">    * @return              The hashed color.</span>
<a href="#l56.125"></a><span id="l56.125">    */</span>
<a href="#l56.126"></a><span id="l56.126" class="difflineminus">-  hashColor: function(str) {</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineplus">+  hashColor(str) {</span>
<a href="#l56.128"></a><span id="l56.128">     // This is the palette of colors in the current colorpicker implementation.</span>
<a href="#l56.129"></a><span id="l56.129">     // Unfortunately, there is no easy way to extract these colors from the</span>
<a href="#l56.130"></a><span id="l56.130">     // binding directly.</span>
<a href="#l56.131"></a><span id="l56.131">     const colorPalette = [</span>
<a href="#l56.132"></a><span id="l56.132">       &quot;#FFFFFF&quot;,</span>
<a href="#l56.133"></a><span id="l56.133">       &quot;#FFCCCC&quot;,</span>
<a href="#l56.134"></a><span id="l56.134">       &quot;#FFCC99&quot;,</span>
<a href="#l56.135"></a><span id="l56.135">       &quot;#FFFF99&quot;,</span>
<a href="#l56.136"></a><span id="l56.136" class="difflineat">@@ -258,17 +258,17 @@ var calview = {</span>
<a href="#l56.137"></a><span id="l56.137">   },</span>
<a href="#l56.138"></a><span id="l56.138"> </span>
<a href="#l56.139"></a><span id="l56.139">   /**</span>
<a href="#l56.140"></a><span id="l56.140">    * Pick whichever of &quot;black&quot; or &quot;white&quot; will look better when used as a text</span>
<a href="#l56.141"></a><span id="l56.141">    * color against a background of bgColor.</span>
<a href="#l56.142"></a><span id="l56.142">    *</span>
<a href="#l56.143"></a><span id="l56.143">    * @param bgColor   the background color as a &quot;#RRGGBB&quot; string</span>
<a href="#l56.144"></a><span id="l56.144">    */</span>
<a href="#l56.145"></a><span id="l56.145" class="difflineminus">-  getContrastingTextColor: function(bgColor) {</span>
<a href="#l56.146"></a><span id="l56.146" class="difflineplus">+  getContrastingTextColor(bgColor) {</span>
<a href="#l56.147"></a><span id="l56.147">     let calcColor = bgColor.replace(/#/g, &quot;&quot;);</span>
<a href="#l56.148"></a><span id="l56.148">     let red = parseInt(calcColor.substring(0, 2), 16);</span>
<a href="#l56.149"></a><span id="l56.149">     let green = parseInt(calcColor.substring(2, 4), 16);</span>
<a href="#l56.150"></a><span id="l56.150">     let blue = parseInt(calcColor.substring(4, 6), 16);</span>
<a href="#l56.151"></a><span id="l56.151"> </span>
<a href="#l56.152"></a><span id="l56.152">     // Calculate the brightness (Y) value using the YUV color system.</span>
<a href="#l56.153"></a><span id="l56.153">     let brightness = 0.299 * red + 0.587 * green + 0.114 * blue;</span>
<a href="#l56.154"></a><span id="l56.154"> </span>
<a href="#l56.155"></a><span id="l56.155" class="difflineat">@@ -283,17 +283,17 @@ var calview = {</span>
<a href="#l56.156"></a><span id="l56.156"> </span>
<a href="#l56.157"></a><span id="l56.157">   /**</span>
<a href="#l56.158"></a><span id="l56.158">    * Item comparator for inserting items into dayboxes.</span>
<a href="#l56.159"></a><span id="l56.159">    *</span>
<a href="#l56.160"></a><span id="l56.160">    * @param a     The first item</span>
<a href="#l56.161"></a><span id="l56.161">    * @param b     The second item</span>
<a href="#l56.162"></a><span id="l56.162">    * @return      The usual -1, 0, 1</span>
<a href="#l56.163"></a><span id="l56.163">    */</span>
<a href="#l56.164"></a><span id="l56.164" class="difflineminus">-  compareItems: function(a, b) {</span>
<a href="#l56.165"></a><span id="l56.165" class="difflineplus">+  compareItems(a, b) {</span>
<a href="#l56.166"></a><span id="l56.166">     if (!a) {</span>
<a href="#l56.167"></a><span id="l56.167">       return -1;</span>
<a href="#l56.168"></a><span id="l56.168">     }</span>
<a href="#l56.169"></a><span id="l56.169">     if (!b) {</span>
<a href="#l56.170"></a><span id="l56.170">       return 1;</span>
<a href="#l56.171"></a><span id="l56.171">     }</span>
<a href="#l56.172"></a><span id="l56.172"> </span>
<a href="#l56.173"></a><span id="l56.173">     let aIsEvent = cal.item.isEvent(a);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/calendar/base/modules/utils/calWindowUtils.jsm</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/calendar/base/modules/utils/calWindowUtils.jsm</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -16,17 +16,17 @@ this.EXPORTED_SYMBOLS = [&quot;calwindow&quot;]; /</span>
<a href="#l57.4"></a><span id="l57.4"> </span>
<a href="#l57.5"></a><span id="l57.5"> var calwindow = {</span>
<a href="#l57.6"></a><span id="l57.6">   /**</span>
<a href="#l57.7"></a><span id="l57.7">    * Opens the Create Calendar wizard</span>
<a href="#l57.8"></a><span id="l57.8">    *</span>
<a href="#l57.9"></a><span id="l57.9">    * @param aWindow    the window to open the dialog on, or null for the main calendar window</span>
<a href="#l57.10"></a><span id="l57.10">    * @param aCallback  a function to be performed after calendar creation</span>
<a href="#l57.11"></a><span id="l57.11">    */</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-  openCalendarWizard: function(aWindow, aCallback) {</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+  openCalendarWizard(aWindow, aCallback) {</span>
<a href="#l57.14"></a><span id="l57.14">     let window = aWindow || calwindow.getCalendarWindow();</span>
<a href="#l57.15"></a><span id="l57.15">     window.openDialog(</span>
<a href="#l57.16"></a><span id="l57.16">       &quot;chrome://calendar/content/calendarCreation.xhtml&quot;,</span>
<a href="#l57.17"></a><span id="l57.17">       &quot;caEditServer&quot;,</span>
<a href="#l57.18"></a><span id="l57.18">       // Workaround for Bug 1151440 - the HTML color picker won't work</span>
<a href="#l57.19"></a><span id="l57.19">       // in linux when opened from modal dialog</span>
<a href="#l57.20"></a><span id="l57.20">       AppConstants.platform == &quot;linux&quot;</span>
<a href="#l57.21"></a><span id="l57.21">         ? &quot;chrome,titlebar,resizable&quot;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineat">@@ -36,42 +36,42 @@ var calwindow = {</span>
<a href="#l57.23"></a><span id="l57.23">   },</span>
<a href="#l57.24"></a><span id="l57.24"> </span>
<a href="#l57.25"></a><span id="l57.25">   /**</span>
<a href="#l57.26"></a><span id="l57.26">    * Opens the calendar properties window for aCalendar</span>
<a href="#l57.27"></a><span id="l57.27">    *</span>
<a href="#l57.28"></a><span id="l57.28">    * @param aWindow    the window to open the dialog on, or null for the main calendar window</span>
<a href="#l57.29"></a><span id="l57.29">    * @param aCalendar  the calendar whose properties should be displayed</span>
<a href="#l57.30"></a><span id="l57.30">    */</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-  openCalendarProperties: function(aWindow, aCalendar) {</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+  openCalendarProperties(aWindow, aCalendar) {</span>
<a href="#l57.33"></a><span id="l57.33">     let window = aWindow || calwindow.getCalendarWindow();</span>
<a href="#l57.34"></a><span id="l57.34">     window.openDialog(</span>
<a href="#l57.35"></a><span id="l57.35">       &quot;chrome://calendar/content/calendar-properties-dialog.xhtml&quot;,</span>
<a href="#l57.36"></a><span id="l57.36">       &quot;CalendarPropertiesDialog&quot;,</span>
<a href="#l57.37"></a><span id="l57.37">       &quot;modal,chrome,titlebar,resizable&quot;,</span>
<a href="#l57.38"></a><span id="l57.38">       { calendar: aCalendar }</span>
<a href="#l57.39"></a><span id="l57.39">     );</span>
<a href="#l57.40"></a><span id="l57.40">   },</span>
<a href="#l57.41"></a><span id="l57.41"> </span>
<a href="#l57.42"></a><span id="l57.42">   /**</span>
<a href="#l57.43"></a><span id="l57.43">    * Opens the print dialog</span>
<a href="#l57.44"></a><span id="l57.44">    *</span>
<a href="#l57.45"></a><span id="l57.45">    * @param aWindow    the window to open the dialog on, or null for the main calendar window</span>
<a href="#l57.46"></a><span id="l57.46">    */</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-  openPrintDialog: function(aWindow = null) {</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+  openPrintDialog(aWindow = null) {</span>
<a href="#l57.49"></a><span id="l57.49">     let window = aWindow || calwindow.getCalendarWindow();</span>
<a href="#l57.50"></a><span id="l57.50">     window.openDialog(</span>
<a href="#l57.51"></a><span id="l57.51">       &quot;chrome://calendar/content/calendar-print-dialog.xhtml&quot;,</span>
<a href="#l57.52"></a><span id="l57.52">       &quot;Print&quot;,</span>
<a href="#l57.53"></a><span id="l57.53">       &quot;centerscreen,chrome,resizable&quot;</span>
<a href="#l57.54"></a><span id="l57.54">     );</span>
<a href="#l57.55"></a><span id="l57.55">   },</span>
<a href="#l57.56"></a><span id="l57.56"> </span>
<a href="#l57.57"></a><span id="l57.57">   /**</span>
<a href="#l57.58"></a><span id="l57.58">    * Returns the most recent calendar window in an application independent way</span>
<a href="#l57.59"></a><span id="l57.59">    */</span>
<a href="#l57.60"></a><span id="l57.60" class="difflineminus">-  getCalendarWindow: function() {</span>
<a href="#l57.61"></a><span id="l57.61" class="difflineplus">+  getCalendarWindow() {</span>
<a href="#l57.62"></a><span id="l57.62">     return (</span>
<a href="#l57.63"></a><span id="l57.63">       Services.wm.getMostRecentWindow(&quot;calendarMainWindow&quot;) ||</span>
<a href="#l57.64"></a><span id="l57.64">       Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;)</span>
<a href="#l57.65"></a><span id="l57.65">     );</span>
<a href="#l57.66"></a><span id="l57.66">   },</span>
<a href="#l57.67"></a><span id="l57.67"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/calendar/base/modules/utils/calXMLUtils.jsm</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/calendar/base/modules/utils/calXMLUtils.jsm</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -21,17 +21,17 @@ var calxml = {</span>
<a href="#l58.4"></a><span id="l58.4">    * - an array of strings or DOM elements</span>
<a href="#l58.5"></a><span id="l58.5">    *</span>
<a href="#l58.6"></a><span id="l58.6">    * @param aNode     The context node to search from</span>
<a href="#l58.7"></a><span id="l58.7">    * @param aExpr     The XPath expression to search for</span>
<a href="#l58.8"></a><span id="l58.8">    * @param aResolver (optional) The namespace resolver to use for the expression</span>
<a href="#l58.9"></a><span id="l58.9">    * @param aType     (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l58.10"></a><span id="l58.10">    * @return          The result, see above for details.</span>
<a href="#l58.11"></a><span id="l58.11">    */</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-  evalXPath: function(aNode, aExpr, aResolver, aType) {</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineplus">+  evalXPath(aNode, aExpr, aResolver, aType) {</span>
<a href="#l58.14"></a><span id="l58.14">     const XPR = {</span>
<a href="#l58.15"></a><span id="l58.15">       // XPathResultType</span>
<a href="#l58.16"></a><span id="l58.16">       ANY_TYPE: 0,</span>
<a href="#l58.17"></a><span id="l58.17">       NUMBER_TYPE: 1,</span>
<a href="#l58.18"></a><span id="l58.18">       STRING_TYPE: 2,</span>
<a href="#l58.19"></a><span id="l58.19">       BOOLEAN_TYPE: 3,</span>
<a href="#l58.20"></a><span id="l58.20">       UNORDERED_NODE_ITERATOR_TYPE: 4,</span>
<a href="#l58.21"></a><span id="l58.21">       ORDERED_NODE_ITERATOR_TYPE: 5,</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineat">@@ -108,72 +108,71 @@ var calxml = {</span>
<a href="#l58.23"></a><span id="l58.23">    * - A string, number, boolean or DOM Element value</span>
<a href="#l58.24"></a><span id="l58.24">    *</span>
<a href="#l58.25"></a><span id="l58.25">    * @param aNode     The context node to search from</span>
<a href="#l58.26"></a><span id="l58.26">    * @param aExpr     The XPath expression to search for</span>
<a href="#l58.27"></a><span id="l58.27">    * @param aResolver (optional) The namespace resolver to use for the expression</span>
<a href="#l58.28"></a><span id="l58.28">    * @param aType     (optional) Force a result type, must be an XPathResult constant</span>
<a href="#l58.29"></a><span id="l58.29">    * @return          The result, see above for details.</span>
<a href="#l58.30"></a><span id="l58.30">    */</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-  evalXPathFirst: function(aNode, aExpr, aResolver, aType) {</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+  evalXPathFirst(aNode, aExpr, aResolver, aType) {</span>
<a href="#l58.33"></a><span id="l58.33">     let result = calxml.evalXPath(aNode, aExpr, aResolver, aType);</span>
<a href="#l58.34"></a><span id="l58.34"> </span>
<a href="#l58.35"></a><span id="l58.35">     if (Array.isArray(result)) {</span>
<a href="#l58.36"></a><span id="l58.36">       return result[0];</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-    } else {</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-      return result;</span>
<a href="#l58.39"></a><span id="l58.39">     }</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineplus">+    return result;</span>
<a href="#l58.41"></a><span id="l58.41">   },</span>
<a href="#l58.42"></a><span id="l58.42"> </span>
<a href="#l58.43"></a><span id="l58.43">   /**</span>
<a href="#l58.44"></a><span id="l58.44">    * Parse the given string into a DOM tree</span>
<a href="#l58.45"></a><span id="l58.45">    *</span>
<a href="#l58.46"></a><span id="l58.46">    * @param str       The string to parse</span>
<a href="#l58.47"></a><span id="l58.47">    * @return          The parsed DOM Document</span>
<a href="#l58.48"></a><span id="l58.48">    */</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineminus">-  parseString: function(str) {</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineplus">+  parseString(str) {</span>
<a href="#l58.51"></a><span id="l58.51">     let parser = new DOMParser();</span>
<a href="#l58.52"></a><span id="l58.52">     parser.forceEnableXULXBL();</span>
<a href="#l58.53"></a><span id="l58.53">     return parser.parseFromString(str, &quot;application/xml&quot;);</span>
<a href="#l58.54"></a><span id="l58.54">   },</span>
<a href="#l58.55"></a><span id="l58.55"> </span>
<a href="#l58.56"></a><span id="l58.56">   /**</span>
<a href="#l58.57"></a><span id="l58.57">    * Read an XML file synchronously. This method should be avoided, consider</span>
<a href="#l58.58"></a><span id="l58.58">    * rewriting the caller to be asynchronous.</span>
<a href="#l58.59"></a><span id="l58.59">    *</span>
<a href="#l58.60"></a><span id="l58.60">    * @param uri       The URI to read.</span>
<a href="#l58.61"></a><span id="l58.61">    * @return          The DOM Document resulting from the file.</span>
<a href="#l58.62"></a><span id="l58.62">    */</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-  parseFile: function(uri) {</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineplus">+  parseFile(uri) {</span>
<a href="#l58.65"></a><span id="l58.65">     let req = new XMLHttpRequest();</span>
<a href="#l58.66"></a><span id="l58.66">     req.open(&quot;GET&quot;, uri, false);</span>
<a href="#l58.67"></a><span id="l58.67">     req.overrideMimeType(&quot;text/xml&quot;);</span>
<a href="#l58.68"></a><span id="l58.68">     req.send(null);</span>
<a href="#l58.69"></a><span id="l58.69">     return req.responseXML;</span>
<a href="#l58.70"></a><span id="l58.70">   },</span>
<a href="#l58.71"></a><span id="l58.71"> </span>
<a href="#l58.72"></a><span id="l58.72">   /**</span>
<a href="#l58.73"></a><span id="l58.73">    * Serialize the DOM tree into a string.</span>
<a href="#l58.74"></a><span id="l58.74">    *</span>
<a href="#l58.75"></a><span id="l58.75">    * @param doc       The DOM document to serialize</span>
<a href="#l58.76"></a><span id="l58.76">    * @return          The DOM document as a string.</span>
<a href="#l58.77"></a><span id="l58.77">    */</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  serializeDOM: function(doc) {</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineplus">+  serializeDOM(doc) {</span>
<a href="#l58.80"></a><span id="l58.80">     let serializer = new XMLSerializer();</span>
<a href="#l58.81"></a><span id="l58.81">     return serializer.serializeToString(doc);</span>
<a href="#l58.82"></a><span id="l58.82">   },</span>
<a href="#l58.83"></a><span id="l58.83"> </span>
<a href="#l58.84"></a><span id="l58.84">   /**</span>
<a href="#l58.85"></a><span id="l58.85">    * Escape a string for use in XML</span>
<a href="#l58.86"></a><span id="l58.86">    *</span>
<a href="#l58.87"></a><span id="l58.87">    * @param str           The string to escape</span>
<a href="#l58.88"></a><span id="l58.88">    * @param isAttribute   If true, &quot; and ' are also escaped</span>
<a href="#l58.89"></a><span id="l58.89">    * @return              The escaped string</span>
<a href="#l58.90"></a><span id="l58.90">    */</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-  escapeString: function(str, isAttribute) {</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineplus">+  escapeString(str, isAttribute) {</span>
<a href="#l58.93"></a><span id="l58.93">     return str.replace(/[&amp;&lt;&gt;'&quot;]/g, chr =&gt; {</span>
<a href="#l58.94"></a><span id="l58.94">       switch (chr) {</span>
<a href="#l58.95"></a><span id="l58.95">         case &quot;&amp;&quot;:</span>
<a href="#l58.96"></a><span id="l58.96">           return &quot;&amp;amp;&quot;;</span>
<a href="#l58.97"></a><span id="l58.97">         case &quot;&lt;&quot;:</span>
<a href="#l58.98"></a><span id="l58.98">           return &quot;&amp;lt;&quot;;</span>
<a href="#l58.99"></a><span id="l58.99">         case &quot;&gt;&quot;:</span>
<a href="#l58.100"></a><span id="l58.100">           return &quot;&amp;gt;&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/calendar/base/src/calAlarm.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/calendar/base/src/calAlarm.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -35,27 +35,27 @@ calAlarm.prototype = {</span>
<a href="#l59.4"></a><span id="l59.4">   mImmutable: false,</span>
<a href="#l59.5"></a><span id="l59.5">   mRelated: 0,</span>
<a href="#l59.6"></a><span id="l59.6">   mRepeat: 0,</span>
<a href="#l59.7"></a><span id="l59.7"> </span>
<a href="#l59.8"></a><span id="l59.8">   /**</span>
<a href="#l59.9"></a><span id="l59.9">    * calIAlarm</span>
<a href="#l59.10"></a><span id="l59.10">    */</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  ensureMutable: function() {</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+  ensureMutable() {</span>
<a href="#l59.14"></a><span id="l59.14">     if (this.mImmutable) {</span>
<a href="#l59.15"></a><span id="l59.15">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l59.16"></a><span id="l59.16">     }</span>
<a href="#l59.17"></a><span id="l59.17">   },</span>
<a href="#l59.18"></a><span id="l59.18"> </span>
<a href="#l59.19"></a><span id="l59.19">   get isMutable() {</span>
<a href="#l59.20"></a><span id="l59.20">     return !this.mImmutable;</span>
<a href="#l59.21"></a><span id="l59.21">   },</span>
<a href="#l59.22"></a><span id="l59.22"> </span>
<a href="#l59.23"></a><span id="l59.23" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+  makeImmutable() {</span>
<a href="#l59.25"></a><span id="l59.25">     if (this.mImmutable) {</span>
<a href="#l59.26"></a><span id="l59.26">       return;</span>
<a href="#l59.27"></a><span id="l59.27">     }</span>
<a href="#l59.28"></a><span id="l59.28"> </span>
<a href="#l59.29"></a><span id="l59.29">     const objectMembers = [&quot;mAbsoluteDate&quot;, &quot;mOffset&quot;, &quot;mDuration&quot;, &quot;mLastAck&quot;];</span>
<a href="#l59.30"></a><span id="l59.30">     for (let member of objectMembers) {</span>
<a href="#l59.31"></a><span id="l59.31">       if (this[member] &amp;&amp; this[member].isMutable) {</span>
<a href="#l59.32"></a><span id="l59.32">         this[member].makeImmutable();</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineat">@@ -67,17 +67,17 @@ calAlarm.prototype = {</span>
<a href="#l59.34"></a><span id="l59.34">       if (propval instanceof Ci.calIDateTime &amp;&amp; propval.isMutable) {</span>
<a href="#l59.35"></a><span id="l59.35">         propval.makeImmutable();</span>
<a href="#l59.36"></a><span id="l59.36">       }</span>
<a href="#l59.37"></a><span id="l59.37">     }</span>
<a href="#l59.38"></a><span id="l59.38"> </span>
<a href="#l59.39"></a><span id="l59.39">     this.mImmutable = true;</span>
<a href="#l59.40"></a><span id="l59.40">   },</span>
<a href="#l59.41"></a><span id="l59.41"> </span>
<a href="#l59.42"></a><span id="l59.42" class="difflineminus">-  clone: function() {</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineplus">+  clone() {</span>
<a href="#l59.44"></a><span id="l59.44">     let cloned = new calAlarm();</span>
<a href="#l59.45"></a><span id="l59.45"> </span>
<a href="#l59.46"></a><span id="l59.46">     cloned.mImmutable = false;</span>
<a href="#l59.47"></a><span id="l59.47"> </span>
<a href="#l59.48"></a><span id="l59.48">     const simpleMembers = [&quot;mAction&quot;, &quot;mSummary&quot;, &quot;mDescription&quot;, &quot;mRelated&quot;, &quot;mRepeat&quot;];</span>
<a href="#l59.49"></a><span id="l59.49"> </span>
<a href="#l59.50"></a><span id="l59.50">     const arrayMembers = [&quot;mAttendees&quot;, &quot;mAttachments&quot;];</span>
<a href="#l59.51"></a><span id="l59.51"> </span>
<a href="#l59.52"></a><span id="l59.52" class="difflineat">@@ -246,91 +246,91 @@ calAlarm.prototype = {</span>
<a href="#l59.53"></a><span id="l59.53">     let alarmDate = this.mAbsoluteDate.clone();</span>
<a href="#l59.54"></a><span id="l59.54"> </span>
<a href="#l59.55"></a><span id="l59.55">     // All Day events are handled as 00:00:00</span>
<a href="#l59.56"></a><span id="l59.56">     alarmDate.isDate = false;</span>
<a href="#l59.57"></a><span id="l59.57">     alarmDate.addDuration(this.mDuration);</span>
<a href="#l59.58"></a><span id="l59.58">     return alarmDate;</span>
<a href="#l59.59"></a><span id="l59.59">   },</span>
<a href="#l59.60"></a><span id="l59.60"> </span>
<a href="#l59.61"></a><span id="l59.61" class="difflineminus">-  getAttendees: function() {</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+  getAttendees() {</span>
<a href="#l59.63"></a><span id="l59.63">     let attendees;</span>
<a href="#l59.64"></a><span id="l59.64">     if (this.action == &quot;AUDIO&quot; || this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l59.65"></a><span id="l59.65">       attendees = [];</span>
<a href="#l59.66"></a><span id="l59.66">     } else {</span>
<a href="#l59.67"></a><span id="l59.67">       attendees = this.mAttendees.concat([]);</span>
<a href="#l59.68"></a><span id="l59.68">     }</span>
<a href="#l59.69"></a><span id="l59.69">     return attendees;</span>
<a href="#l59.70"></a><span id="l59.70">   },</span>
<a href="#l59.71"></a><span id="l59.71"> </span>
<a href="#l59.72"></a><span id="l59.72" class="difflineminus">-  addAttendee: function(aAttendee) {</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+  addAttendee(aAttendee) {</span>
<a href="#l59.74"></a><span id="l59.74">     // Make sure its not duplicate</span>
<a href="#l59.75"></a><span id="l59.75">     this.deleteAttendee(aAttendee);</span>
<a href="#l59.76"></a><span id="l59.76"> </span>
<a href="#l59.77"></a><span id="l59.77">     // Now check if its valid</span>
<a href="#l59.78"></a><span id="l59.78">     if (this.action == &quot;AUDIO&quot; || this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l59.79"></a><span id="l59.79">       throw new Error(&quot;Alarm type AUDIO/DISPLAY may not have attendees&quot;);</span>
<a href="#l59.80"></a><span id="l59.80">     }</span>
<a href="#l59.81"></a><span id="l59.81"> </span>
<a href="#l59.82"></a><span id="l59.82">     // And add it (again)</span>
<a href="#l59.83"></a><span id="l59.83">     this.mAttendees.push(aAttendee);</span>
<a href="#l59.84"></a><span id="l59.84">   },</span>
<a href="#l59.85"></a><span id="l59.85"> </span>
<a href="#l59.86"></a><span id="l59.86" class="difflineminus">-  deleteAttendee: function(aAttendee) {</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+  deleteAttendee(aAttendee) {</span>
<a href="#l59.88"></a><span id="l59.88">     let deleteId = aAttendee.id;</span>
<a href="#l59.89"></a><span id="l59.89">     for (let i = 0; i &lt; this.mAttendees.length; i++) {</span>
<a href="#l59.90"></a><span id="l59.90">       if (this.mAttendees[i].id == deleteId) {</span>
<a href="#l59.91"></a><span id="l59.91">         this.mAttendees.splice(i, 1);</span>
<a href="#l59.92"></a><span id="l59.92">         break;</span>
<a href="#l59.93"></a><span id="l59.93">       }</span>
<a href="#l59.94"></a><span id="l59.94">     }</span>
<a href="#l59.95"></a><span id="l59.95">   },</span>
<a href="#l59.96"></a><span id="l59.96"> </span>
<a href="#l59.97"></a><span id="l59.97" class="difflineminus">-  clearAttendees: function() {</span>
<a href="#l59.98"></a><span id="l59.98" class="difflineplus">+  clearAttendees() {</span>
<a href="#l59.99"></a><span id="l59.99">     this.mAttendees = [];</span>
<a href="#l59.100"></a><span id="l59.100">   },</span>
<a href="#l59.101"></a><span id="l59.101"> </span>
<a href="#l59.102"></a><span id="l59.102" class="difflineminus">-  getAttachments: function() {</span>
<a href="#l59.103"></a><span id="l59.103" class="difflineplus">+  getAttachments() {</span>
<a href="#l59.104"></a><span id="l59.104">     let attachments;</span>
<a href="#l59.105"></a><span id="l59.105">     if (this.action == &quot;AUDIO&quot;) {</span>
<a href="#l59.106"></a><span id="l59.106">       attachments = this.mAttachments.length ? [this.mAttachments[0]] : [];</span>
<a href="#l59.107"></a><span id="l59.107">     } else if (this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l59.108"></a><span id="l59.108">       attachments = [];</span>
<a href="#l59.109"></a><span id="l59.109">     } else {</span>
<a href="#l59.110"></a><span id="l59.110">       attachments = this.mAttachments.concat([]);</span>
<a href="#l59.111"></a><span id="l59.111">     }</span>
<a href="#l59.112"></a><span id="l59.112">     return attachments;</span>
<a href="#l59.113"></a><span id="l59.113">   },</span>
<a href="#l59.114"></a><span id="l59.114"> </span>
<a href="#l59.115"></a><span id="l59.115" class="difflineminus">-  addAttachment: function(aAttachment) {</span>
<a href="#l59.116"></a><span id="l59.116" class="difflineplus">+  addAttachment(aAttachment) {</span>
<a href="#l59.117"></a><span id="l59.117">     // Make sure its not duplicate</span>
<a href="#l59.118"></a><span id="l59.118">     this.deleteAttachment(aAttachment);</span>
<a href="#l59.119"></a><span id="l59.119"> </span>
<a href="#l59.120"></a><span id="l59.120">     // Now check if its valid</span>
<a href="#l59.121"></a><span id="l59.121">     if (this.action == &quot;AUDIO&quot; &amp;&amp; this.mAttachments.length) {</span>
<a href="#l59.122"></a><span id="l59.122">       throw new Error(&quot;Alarm type AUDIO may only have one attachment&quot;);</span>
<a href="#l59.123"></a><span id="l59.123">     } else if (this.action == &quot;DISPLAY&quot;) {</span>
<a href="#l59.124"></a><span id="l59.124">       throw new Error(&quot;Alarm type DISPLAY may not have attachments&quot;);</span>
<a href="#l59.125"></a><span id="l59.125">     }</span>
<a href="#l59.126"></a><span id="l59.126"> </span>
<a href="#l59.127"></a><span id="l59.127">     // And add it (again)</span>
<a href="#l59.128"></a><span id="l59.128">     this.mAttachments.push(aAttachment);</span>
<a href="#l59.129"></a><span id="l59.129">   },</span>
<a href="#l59.130"></a><span id="l59.130"> </span>
<a href="#l59.131"></a><span id="l59.131" class="difflineminus">-  deleteAttachment: function(aAttachment) {</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineplus">+  deleteAttachment(aAttachment) {</span>
<a href="#l59.133"></a><span id="l59.133">     let deleteHash = aAttachment.hashId;</span>
<a href="#l59.134"></a><span id="l59.134">     for (let i = 0; i &lt; this.mAttachments.length; i++) {</span>
<a href="#l59.135"></a><span id="l59.135">       if (this.mAttachments[i].hashId == deleteHash) {</span>
<a href="#l59.136"></a><span id="l59.136">         this.mAttachments.splice(i, 1);</span>
<a href="#l59.137"></a><span id="l59.137">         break;</span>
<a href="#l59.138"></a><span id="l59.138">       }</span>
<a href="#l59.139"></a><span id="l59.139">     }</span>
<a href="#l59.140"></a><span id="l59.140">   },</span>
<a href="#l59.141"></a><span id="l59.141"> </span>
<a href="#l59.142"></a><span id="l59.142" class="difflineminus">-  clearAttachments: function() {</span>
<a href="#l59.143"></a><span id="l59.143" class="difflineplus">+  clearAttachments() {</span>
<a href="#l59.144"></a><span id="l59.144">     this.mAttachments = [];</span>
<a href="#l59.145"></a><span id="l59.145">   },</span>
<a href="#l59.146"></a><span id="l59.146"> </span>
<a href="#l59.147"></a><span id="l59.147">   get icalString() {</span>
<a href="#l59.148"></a><span id="l59.148">     let comp = this.icalComponent;</span>
<a href="#l59.149"></a><span id="l59.149">     return comp ? comp.serializeToICS() : &quot;&quot;;</span>
<a href="#l59.150"></a><span id="l59.150">   },</span>
<a href="#l59.151"></a><span id="l59.151">   set icalString(val) {</span>
<a href="#l59.152"></a><span id="l59.152" class="difflineat">@@ -548,72 +548,69 @@ calAlarm.prototype = {</span>
<a href="#l59.153"></a><span id="l59.153">           }</span>
<a href="#l59.154"></a><span id="l59.154">           this.mPropertyParams[prop.propertyName][paramName] = param;</span>
<a href="#l59.155"></a><span id="l59.155">         }</span>
<a href="#l59.156"></a><span id="l59.156">       }</span>
<a href="#l59.157"></a><span id="l59.157">     }</span>
<a href="#l59.158"></a><span id="l59.158">     return aComp;</span>
<a href="#l59.159"></a><span id="l59.159">   },</span>
<a href="#l59.160"></a><span id="l59.160"> </span>
<a href="#l59.161"></a><span id="l59.161" class="difflineminus">-  hasProperty: function(aName) {</span>
<a href="#l59.162"></a><span id="l59.162" class="difflineplus">+  hasProperty(aName) {</span>
<a href="#l59.163"></a><span id="l59.163">     return this.getProperty(aName.toUpperCase()) != null;</span>
<a href="#l59.164"></a><span id="l59.164">   },</span>
<a href="#l59.165"></a><span id="l59.165"> </span>
<a href="#l59.166"></a><span id="l59.166" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l59.167"></a><span id="l59.167" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l59.168"></a><span id="l59.168">     let name = aName.toUpperCase();</span>
<a href="#l59.169"></a><span id="l59.169">     if (name in this.promotedProps) {</span>
<a href="#l59.170"></a><span id="l59.170">       if (this.promotedProps[name] === true) {</span>
<a href="#l59.171"></a><span id="l59.171">         // Complex promoted props will return undefined</span>
<a href="#l59.172"></a><span id="l59.172">         return undefined;</span>
<a href="#l59.173"></a><span id="l59.173" class="difflineminus">-      } else {</span>
<a href="#l59.174"></a><span id="l59.174" class="difflineminus">-        return this[this.promotedProps[name]];</span>
<a href="#l59.175"></a><span id="l59.175">       }</span>
<a href="#l59.176"></a><span id="l59.176" class="difflineminus">-    } else {</span>
<a href="#l59.177"></a><span id="l59.177" class="difflineminus">-      return this.mProperties.get(name);</span>
<a href="#l59.178"></a><span id="l59.178" class="difflineplus">+      return this[this.promotedProps[name]];</span>
<a href="#l59.179"></a><span id="l59.179">     }</span>
<a href="#l59.180"></a><span id="l59.180" class="difflineplus">+    return this.mProperties.get(name);</span>
<a href="#l59.181"></a><span id="l59.181">   },</span>
<a href="#l59.182"></a><span id="l59.182"> </span>
<a href="#l59.183"></a><span id="l59.183" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l59.184"></a><span id="l59.184" class="difflineplus">+  setProperty(aName, aValue) {</span>
<a href="#l59.185"></a><span id="l59.185">     this.ensureMutable();</span>
<a href="#l59.186"></a><span id="l59.186">     let name = aName.toUpperCase();</span>
<a href="#l59.187"></a><span id="l59.187">     if (name in this.promotedProps) {</span>
<a href="#l59.188"></a><span id="l59.188">       if (this.promotedProps[name] === true) {</span>
<a href="#l59.189"></a><span id="l59.189">         cal.WARN(`Attempted to set complex property ${name} to a simple value ${aValue}`);</span>
<a href="#l59.190"></a><span id="l59.190">       } else {</span>
<a href="#l59.191"></a><span id="l59.191">         this[this.promotedProps[name]] = aValue;</span>
<a href="#l59.192"></a><span id="l59.192">       }</span>
<a href="#l59.193"></a><span id="l59.193">     } else {</span>
<a href="#l59.194"></a><span id="l59.194">       this.mProperties.set(name, aValue);</span>
<a href="#l59.195"></a><span id="l59.195">     }</span>
<a href="#l59.196"></a><span id="l59.196">     return aValue;</span>
<a href="#l59.197"></a><span id="l59.197">   },</span>
<a href="#l59.198"></a><span id="l59.198"> </span>
<a href="#l59.199"></a><span id="l59.199" class="difflineminus">-  deleteProperty: function(aName) {</span>
<a href="#l59.200"></a><span id="l59.200" class="difflineplus">+  deleteProperty(aName) {</span>
<a href="#l59.201"></a><span id="l59.201">     this.ensureMutable();</span>
<a href="#l59.202"></a><span id="l59.202">     let name = aName.toUpperCase();</span>
<a href="#l59.203"></a><span id="l59.203">     if (name in this.promotedProps) {</span>
<a href="#l59.204"></a><span id="l59.204">       this[this.promotedProps[name]] = null;</span>
<a href="#l59.205"></a><span id="l59.205">     } else {</span>
<a href="#l59.206"></a><span id="l59.206">       this.mProperties.delete(name);</span>
<a href="#l59.207"></a><span id="l59.207">     }</span>
<a href="#l59.208"></a><span id="l59.208">   },</span>
<a href="#l59.209"></a><span id="l59.209"> </span>
<a href="#l59.210"></a><span id="l59.210">   get properties() {</span>
<a href="#l59.211"></a><span id="l59.211">     return this.mProperties.entries();</span>
<a href="#l59.212"></a><span id="l59.212">   },</span>
<a href="#l59.213"></a><span id="l59.213"> </span>
<a href="#l59.214"></a><span id="l59.214" class="difflineminus">-  toString: function(aItem) {</span>
<a href="#l59.215"></a><span id="l59.215" class="difflineplus">+  toString(aItem) {</span>
<a href="#l59.216"></a><span id="l59.216">     function alarmString(aPrefix) {</span>
<a href="#l59.217"></a><span id="l59.217">       if (!aItem || cal.item.isEvent(aItem)) {</span>
<a href="#l59.218"></a><span id="l59.218">         return aPrefix + &quot;Event&quot;;</span>
<a href="#l59.219"></a><span id="l59.219">       } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l59.220"></a><span id="l59.220">         return aPrefix + &quot;Task&quot;;</span>
<a href="#l59.221"></a><span id="l59.221" class="difflineminus">-      } else {</span>
<a href="#l59.222"></a><span id="l59.222" class="difflineminus">-        return aPrefix;</span>
<a href="#l59.223"></a><span id="l59.223">       }</span>
<a href="#l59.224"></a><span id="l59.224" class="difflineplus">+      return aPrefix;</span>
<a href="#l59.225"></a><span id="l59.225">     }</span>
<a href="#l59.226"></a><span id="l59.226"> </span>
<a href="#l59.227"></a><span id="l59.227">     if (this.related == ALARM_RELATED_ABSOLUTE &amp;&amp; this.mAbsoluteDate) {</span>
<a href="#l59.228"></a><span id="l59.228">       // this is an absolute alarm. Use the calendar default timezone and</span>
<a href="#l59.229"></a><span id="l59.229">       // format it.</span>
<a href="#l59.230"></a><span id="l59.230">       let formatter = cal.getDateFormatter();</span>
<a href="#l59.231"></a><span id="l59.231">       let formatDate = this.mAbsoluteDate.getInTimezone(cal.dtz.defaultTimezone);</span>
<a href="#l59.232"></a><span id="l59.232">       return formatter.formatDateTime(formatDate);</span>
<a href="#l59.233"></a><span id="l59.233" class="difflineat">@@ -661,15 +658,14 @@ calAlarm.prototype = {</span>
<a href="#l59.234"></a><span id="l59.234">         originStringName += &quot;After&quot;;</span>
<a href="#l59.235"></a><span id="l59.235">       }</span>
<a href="#l59.236"></a><span id="l59.236"> </span>
<a href="#l59.237"></a><span id="l59.237">       let originString = cal.l10n.getString(&quot;calendar-alarms&quot;, alarmString(originStringName));</span>
<a href="#l59.238"></a><span id="l59.238">       return cal.l10n.getString(&quot;calendar-alarms&quot;, &quot;reminderCustomTitle&quot;, [</span>
<a href="#l59.239"></a><span id="l59.239">         unitString,</span>
<a href="#l59.240"></a><span id="l59.240">         originString,</span>
<a href="#l59.241"></a><span id="l59.241">       ]);</span>
<a href="#l59.242"></a><span id="l59.242" class="difflineminus">-    } else {</span>
<a href="#l59.243"></a><span id="l59.243" class="difflineminus">-      // This is an incomplete alarm, but then again we should never reach</span>
<a href="#l59.244"></a><span id="l59.244" class="difflineminus">-      // this state.</span>
<a href="#l59.245"></a><span id="l59.245" class="difflineminus">-      return &quot;[Incomplete calIAlarm]&quot;;</span>
<a href="#l59.246"></a><span id="l59.246">     }</span>
<a href="#l59.247"></a><span id="l59.247" class="difflineplus">+    // This is an incomplete alarm, but then again we should never reach</span>
<a href="#l59.248"></a><span id="l59.248" class="difflineplus">+    // this state.</span>
<a href="#l59.249"></a><span id="l59.249" class="difflineplus">+    return &quot;[Incomplete calIAlarm]&quot;;</span>
<a href="#l59.250"></a><span id="l59.250">   },</span>
<a href="#l59.251"></a><span id="l59.251"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/calendar/base/src/calAlarmMonitor.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -45,32 +45,32 @@ calAlarmMonitor.prototype = {</span>
<a href="#l60.4"></a><span id="l60.4">     classID: calAlarmMonitorClassID,</span>
<a href="#l60.5"></a><span id="l60.5">     interfaces: calAlarmMonitorInterfaces,</span>
<a href="#l60.6"></a><span id="l60.6">     flags: Ci.nsIClassInfo.SINGLETON,</span>
<a href="#l60.7"></a><span id="l60.7">   }),</span>
<a href="#l60.8"></a><span id="l60.8"> </span>
<a href="#l60.9"></a><span id="l60.9">   /**</span>
<a href="#l60.10"></a><span id="l60.10">    * nsIObserver</span>
<a href="#l60.11"></a><span id="l60.11">    */</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l60.14"></a><span id="l60.14">     let alarmService = Cc[&quot;@mozilla.org/calendar/alarm-service;1&quot;].getService(Ci.calIAlarmService);</span>
<a href="#l60.15"></a><span id="l60.15">     switch (aTopic) {</span>
<a href="#l60.16"></a><span id="l60.16">       case &quot;alarm-service-startup&quot;:</span>
<a href="#l60.17"></a><span id="l60.17">         alarmService.addObserver(this);</span>
<a href="#l60.18"></a><span id="l60.18">         break;</span>
<a href="#l60.19"></a><span id="l60.19">       case &quot;alarm-service-shutdown&quot;:</span>
<a href="#l60.20"></a><span id="l60.20">         alarmService.removeObserver(this);</span>
<a href="#l60.21"></a><span id="l60.21">         break;</span>
<a href="#l60.22"></a><span id="l60.22">     }</span>
<a href="#l60.23"></a><span id="l60.23">   },</span>
<a href="#l60.24"></a><span id="l60.24"> </span>
<a href="#l60.25"></a><span id="l60.25">   /**</span>
<a href="#l60.26"></a><span id="l60.26">    * calIAlarmServiceObserver</span>
<a href="#l60.27"></a><span id="l60.27">    */</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineminus">-  onAlarm: function(aItem, aAlarm) {</span>
<a href="#l60.29"></a><span id="l60.29" class="difflineplus">+  onAlarm(aItem, aAlarm) {</span>
<a href="#l60.30"></a><span id="l60.30">     if (aAlarm.action != &quot;DISPLAY&quot;) {</span>
<a href="#l60.31"></a><span id="l60.31">       // This monitor only looks for DISPLAY alarms.</span>
<a href="#l60.32"></a><span id="l60.32">       return;</span>
<a href="#l60.33"></a><span id="l60.33">     }</span>
<a href="#l60.34"></a><span id="l60.34"> </span>
<a href="#l60.35"></a><span id="l60.35">     this.mAlarms.push([aItem, aAlarm]);</span>
<a href="#l60.36"></a><span id="l60.36"> </span>
<a href="#l60.37"></a><span id="l60.37">     if (Services.prefs.getBoolPref(&quot;calendar.alarms.playsound&quot;, true)) {</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineat">@@ -127,55 +127,55 @@ calAlarmMonitor.prototype = {</span>
<a href="#l60.39"></a><span id="l60.39">         this</span>
<a href="#l60.40"></a><span id="l60.40">       );</span>
<a href="#l60.41"></a><span id="l60.41">     }</span>
<a href="#l60.42"></a><span id="l60.42">     if (!this.mWindowOpening) {</span>
<a href="#l60.43"></a><span id="l60.43">       calAlarmWindow.addWidgetFor(aItem, aAlarm);</span>
<a href="#l60.44"></a><span id="l60.44">     }</span>
<a href="#l60.45"></a><span id="l60.45">   },</span>
<a href="#l60.46"></a><span id="l60.46"> </span>
<a href="#l60.47"></a><span id="l60.47" class="difflineminus">-  window_onLoad: function() {</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+  window_onLoad() {</span>
<a href="#l60.49"></a><span id="l60.49">     let calAlarmWindow = this.mWindowOpening;</span>
<a href="#l60.50"></a><span id="l60.50">     this.mWindowOpening = null;</span>
<a href="#l60.51"></a><span id="l60.51">     if (this.mAlarms.length &gt; 0) {</span>
<a href="#l60.52"></a><span id="l60.52">       for (let [item, alarm] of this.mAlarms) {</span>
<a href="#l60.53"></a><span id="l60.53">         calAlarmWindow.addWidgetFor(item, alarm);</span>
<a href="#l60.54"></a><span id="l60.54">       }</span>
<a href="#l60.55"></a><span id="l60.55">     } else {</span>
<a href="#l60.56"></a><span id="l60.56">       // Uh oh, it seems the alarms were removed even before the window</span>
<a href="#l60.57"></a><span id="l60.57">       // finished loading. Looks like we can close it again</span>
<a href="#l60.58"></a><span id="l60.58">       calAlarmWindow.closeIfEmpty();</span>
<a href="#l60.59"></a><span id="l60.59">     }</span>
<a href="#l60.60"></a><span id="l60.60">   },</span>
<a href="#l60.61"></a><span id="l60.61"> </span>
<a href="#l60.62"></a><span id="l60.62" class="difflineminus">-  onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+  onRemoveAlarmsByItem(aItem) {</span>
<a href="#l60.64"></a><span id="l60.64">     let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l60.65"></a><span id="l60.65">     this.mAlarms = this.mAlarms.filter(([thisItem, alarm]) =&gt; {</span>
<a href="#l60.66"></a><span id="l60.66">       let ret = aItem.hashId != thisItem.hashId;</span>
<a href="#l60.67"></a><span id="l60.67">       if (!ret &amp;&amp; calAlarmWindow) {</span>
<a href="#l60.68"></a><span id="l60.68">         // window is open</span>
<a href="#l60.69"></a><span id="l60.69">         calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l60.70"></a><span id="l60.70">       }</span>
<a href="#l60.71"></a><span id="l60.71">       return ret;</span>
<a href="#l60.72"></a><span id="l60.72">     });</span>
<a href="#l60.73"></a><span id="l60.73">   },</span>
<a href="#l60.74"></a><span id="l60.74"> </span>
<a href="#l60.75"></a><span id="l60.75" class="difflineminus">-  onRemoveAlarmsByCalendar: function(calendar) {</span>
<a href="#l60.76"></a><span id="l60.76" class="difflineplus">+  onRemoveAlarmsByCalendar(calendar) {</span>
<a href="#l60.77"></a><span id="l60.77">     let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l60.78"></a><span id="l60.78">     this.mAlarms = this.mAlarms.filter(([thisItem, alarm]) =&gt; {</span>
<a href="#l60.79"></a><span id="l60.79">       let ret = calendar.id != thisItem.calendar.id;</span>
<a href="#l60.80"></a><span id="l60.80"> </span>
<a href="#l60.81"></a><span id="l60.81">       if (!ret &amp;&amp; calAlarmWindow) {</span>
<a href="#l60.82"></a><span id="l60.82">         // window is open</span>
<a href="#l60.83"></a><span id="l60.83">         calAlarmWindow.removeWidgetFor(thisItem, alarm);</span>
<a href="#l60.84"></a><span id="l60.84">       }</span>
<a href="#l60.85"></a><span id="l60.85">       return ret;</span>
<a href="#l60.86"></a><span id="l60.86">     });</span>
<a href="#l60.87"></a><span id="l60.87">   },</span>
<a href="#l60.88"></a><span id="l60.88"> </span>
<a href="#l60.89"></a><span id="l60.89" class="difflineminus">-  onAlarmsLoaded: function(aCalendar) {</span>
<a href="#l60.90"></a><span id="l60.90" class="difflineplus">+  onAlarmsLoaded(aCalendar) {</span>
<a href="#l60.91"></a><span id="l60.91">     // the alarm dialog won't close while alarms are loading, check again now</span>
<a href="#l60.92"></a><span id="l60.92">     let calAlarmWindow = peekAlarmWindow();</span>
<a href="#l60.93"></a><span id="l60.93">     if (calAlarmWindow &amp;&amp; this.mAlarms.length == 0) {</span>
<a href="#l60.94"></a><span id="l60.94">       calAlarmWindow.closeIfEmpty();</span>
<a href="#l60.95"></a><span id="l60.95">     }</span>
<a href="#l60.96"></a><span id="l60.96">   },</span>
<a href="#l60.97"></a><span id="l60.97"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/calendar/base/src/calAlarmService.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/calendar/base/src/calAlarmService.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -30,72 +30,72 @@ function calAlarmService() {</span>
<a href="#l61.4"></a><span id="l61.4">   this.mTimerMap = {};</span>
<a href="#l61.5"></a><span id="l61.5">   this.mObservers = new cal.data.ListenerSet(Ci.calIAlarmServiceObserver);</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7">   this.calendarObserver = {</span>
<a href="#l61.8"></a><span id="l61.8">     QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l61.9"></a><span id="l61.9">     alarmService: this,</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11">     // calIObserver:</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-    onStartBatch: function() {},</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-    onEndBatch: function() {},</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineminus">-    onLoad: function(calendar) {</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+    onStartBatch() {},</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+    onEndBatch() {},</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+    onLoad(calendar) {</span>
<a href="#l61.18"></a><span id="l61.18">       // ignore any onLoad events until initial getItems() call of startup has finished:</span>
<a href="#l61.19"></a><span id="l61.19">       if (calendar &amp;&amp; this.alarmService.mLoadedCalendars[calendar.id]) {</span>
<a href="#l61.20"></a><span id="l61.20">         // a refreshed calendar signals that it has been reloaded</span>
<a href="#l61.21"></a><span id="l61.21">         // (and cannot notify detailed changes), thus reget all alarms of it:</span>
<a href="#l61.22"></a><span id="l61.22">         this.alarmService.initAlarms([calendar]);</span>
<a href="#l61.23"></a><span id="l61.23">       }</span>
<a href="#l61.24"></a><span id="l61.24">     },</span>
<a href="#l61.25"></a><span id="l61.25"> </span>
<a href="#l61.26"></a><span id="l61.26" class="difflineminus">-    onAddItem: function(aItem) {</span>
<a href="#l61.27"></a><span id="l61.27" class="difflineplus">+    onAddItem(aItem) {</span>
<a href="#l61.28"></a><span id="l61.28">       this.alarmService.addAlarmsForOccurrences(aItem);</span>
<a href="#l61.29"></a><span id="l61.29">     },</span>
<a href="#l61.30"></a><span id="l61.30" class="difflineminus">-    onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l61.31"></a><span id="l61.31" class="difflineplus">+    onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l61.32"></a><span id="l61.32">       if (!aNewItem.recurrenceId) {</span>
<a href="#l61.33"></a><span id="l61.33">         // deleting an occurrence currently calls modifyItem(newParent, *oldOccurrence*)</span>
<a href="#l61.34"></a><span id="l61.34">         aOldItem = aOldItem.parentItem;</span>
<a href="#l61.35"></a><span id="l61.35">       }</span>
<a href="#l61.36"></a><span id="l61.36"> </span>
<a href="#l61.37"></a><span id="l61.37">       this.onDeleteItem(aOldItem);</span>
<a href="#l61.38"></a><span id="l61.38">       this.onAddItem(aNewItem);</span>
<a href="#l61.39"></a><span id="l61.39">     },</span>
<a href="#l61.40"></a><span id="l61.40" class="difflineminus">-    onDeleteItem: function(aDeletedItem) {</span>
<a href="#l61.41"></a><span id="l61.41" class="difflineplus">+    onDeleteItem(aDeletedItem) {</span>
<a href="#l61.42"></a><span id="l61.42">       this.alarmService.removeAlarmsForOccurrences(aDeletedItem);</span>
<a href="#l61.43"></a><span id="l61.43">     },</span>
<a href="#l61.44"></a><span id="l61.44" class="difflineminus">-    onError: function(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineminus">-    onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l61.46"></a><span id="l61.46" class="difflineplus">+    onError(aCalendar, aErrNo, aMessage) {},</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineplus">+    onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l61.48"></a><span id="l61.48">       switch (aName) {</span>
<a href="#l61.49"></a><span id="l61.49">         case &quot;suppressAlarms&quot;:</span>
<a href="#l61.50"></a><span id="l61.50">         case &quot;disabled&quot;:</span>
<a href="#l61.51"></a><span id="l61.51">           this.alarmService.initAlarms([aCalendar]);</span>
<a href="#l61.52"></a><span id="l61.52">           break;</span>
<a href="#l61.53"></a><span id="l61.53">       }</span>
<a href="#l61.54"></a><span id="l61.54">     },</span>
<a href="#l61.55"></a><span id="l61.55" class="difflineminus">-    onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l61.56"></a><span id="l61.56" class="difflineplus">+    onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l61.57"></a><span id="l61.57">       this.onPropertyChanged(aCalendar, aName);</span>
<a href="#l61.58"></a><span id="l61.58">     },</span>
<a href="#l61.59"></a><span id="l61.59">   };</span>
<a href="#l61.60"></a><span id="l61.60"> </span>
<a href="#l61.61"></a><span id="l61.61">   this.calendarManagerObserver = {</span>
<a href="#l61.62"></a><span id="l61.62">     QueryInterface: ChromeUtils.generateQI([Ci.calICalendarManagerObserver]),</span>
<a href="#l61.63"></a><span id="l61.63">     alarmService: this,</span>
<a href="#l61.64"></a><span id="l61.64"> </span>
<a href="#l61.65"></a><span id="l61.65" class="difflineminus">-    onCalendarRegistered: function(aCalendar) {</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineplus">+    onCalendarRegistered(aCalendar) {</span>
<a href="#l61.67"></a><span id="l61.67">       this.alarmService.observeCalendar(aCalendar);</span>
<a href="#l61.68"></a><span id="l61.68">       // initial refresh of alarms for new calendar:</span>
<a href="#l61.69"></a><span id="l61.69">       this.alarmService.initAlarms([aCalendar]);</span>
<a href="#l61.70"></a><span id="l61.70">     },</span>
<a href="#l61.71"></a><span id="l61.71" class="difflineminus">-    onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l61.72"></a><span id="l61.72" class="difflineplus">+    onCalendarUnregistering(aCalendar) {</span>
<a href="#l61.73"></a><span id="l61.73">       // XXX todo: we need to think about calendar unregistration;</span>
<a href="#l61.74"></a><span id="l61.74">       // there may still be dangling items (-&gt; alarm dialog),</span>
<a href="#l61.75"></a><span id="l61.75">       // dismissing those alarms may write data...</span>
<a href="#l61.76"></a><span id="l61.76">       this.alarmService.unobserveCalendar(aCalendar);</span>
<a href="#l61.77"></a><span id="l61.77">     },</span>
<a href="#l61.78"></a><span id="l61.78" class="difflineminus">-    onCalendarDeleting: function(aCalendar) {</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+    onCalendarDeleting(aCalendar) {</span>
<a href="#l61.80"></a><span id="l61.80">       this.alarmService.unobserveCalendar(aCalendar);</span>
<a href="#l61.81"></a><span id="l61.81">       delete this.alarmService.mLoadedCalendars[aCalendar.id];</span>
<a href="#l61.82"></a><span id="l61.82">     },</span>
<a href="#l61.83"></a><span id="l61.83">   };</span>
<a href="#l61.84"></a><span id="l61.84"> }</span>
<a href="#l61.85"></a><span id="l61.85"> </span>
<a href="#l61.86"></a><span id="l61.86"> var calAlarmServiceClassID = Components.ID(&quot;{7a9200dd-6a64-4fff-a798-c5802186e2cc}&quot;);</span>
<a href="#l61.87"></a><span id="l61.87"> var calAlarmServiceInterfaces = [Ci.calIAlarmService, Ci.nsIObserver];</span>
<a href="#l61.88"></a><span id="l61.88" class="difflineat">@@ -116,17 +116,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.89"></a><span id="l61.89">     classDescription: &quot;Calendar Alarm Service&quot;,</span>
<a href="#l61.90"></a><span id="l61.90">     interfaces: calAlarmServiceInterfaces,</span>
<a href="#l61.91"></a><span id="l61.91">     flags: Ci.nsIClassInfo.SINGLETON,</span>
<a href="#l61.92"></a><span id="l61.92">   }),</span>
<a href="#l61.93"></a><span id="l61.93"> </span>
<a href="#l61.94"></a><span id="l61.94">   /**</span>
<a href="#l61.95"></a><span id="l61.95">    * nsIObserver</span>
<a href="#l61.96"></a><span id="l61.96">    */</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l61.99"></a><span id="l61.99">     // This will also be called on app-startup, but nothing is done yet, to</span>
<a href="#l61.100"></a><span id="l61.100">     // prevent unwanted dialogs etc. See bug 325476 and 413296</span>
<a href="#l61.101"></a><span id="l61.101">     if (aTopic == &quot;profile-after-change&quot; || aTopic == &quot;wake_notification&quot;) {</span>
<a href="#l61.102"></a><span id="l61.102">       this.shutdown();</span>
<a href="#l61.103"></a><span id="l61.103">       this.startup();</span>
<a href="#l61.104"></a><span id="l61.104">     }</span>
<a href="#l61.105"></a><span id="l61.105">     if (aTopic == &quot;xpcom-shutdown&quot;) {</span>
<a href="#l61.106"></a><span id="l61.106">       this.shutdown();</span>
<a href="#l61.107"></a><span id="l61.107" class="difflineat">@@ -141,17 +141,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.108"></a><span id="l61.108">     // different than the default timezone?</span>
<a href="#l61.109"></a><span id="l61.109">     return this.mTimezone || cal.dtz.defaultTimezone;</span>
<a href="#l61.110"></a><span id="l61.110">   },</span>
<a href="#l61.111"></a><span id="l61.111"> </span>
<a href="#l61.112"></a><span id="l61.112">   set timezone(aTimezone) {</span>
<a href="#l61.113"></a><span id="l61.113">     return (this.mTimezone = aTimezone);</span>
<a href="#l61.114"></a><span id="l61.114">   },</span>
<a href="#l61.115"></a><span id="l61.115"> </span>
<a href="#l61.116"></a><span id="l61.116" class="difflineminus">-  snoozeAlarm: function(aItem, aAlarm, aDuration) {</span>
<a href="#l61.117"></a><span id="l61.117" class="difflineplus">+  snoozeAlarm(aItem, aAlarm, aDuration) {</span>
<a href="#l61.118"></a><span id="l61.118">     // Right now we only support snoozing all alarms for the given item for</span>
<a href="#l61.119"></a><span id="l61.119">     // aDuration.</span>
<a href="#l61.120"></a><span id="l61.120"> </span>
<a href="#l61.121"></a><span id="l61.121">     // Make sure we're working with the parent, otherwise we'll accidentally</span>
<a href="#l61.122"></a><span id="l61.122">     // create an exception</span>
<a href="#l61.123"></a><span id="l61.123">     let newEvent = aItem.parentItem.clone();</span>
<a href="#l61.124"></a><span id="l61.124">     let alarmTime = nowUTC();</span>
<a href="#l61.125"></a><span id="l61.125"> </span>
<a href="#l61.126"></a><span id="l61.126" class="difflineat">@@ -173,17 +173,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.127"></a><span id="l61.127">         alarmTime.icalString</span>
<a href="#l61.128"></a><span id="l61.128">       );</span>
<a href="#l61.129"></a><span id="l61.129">     }</span>
<a href="#l61.130"></a><span id="l61.130">     // calling modifyItem will cause us to get the right callback</span>
<a href="#l61.131"></a><span id="l61.131">     // and update the alarm properly</span>
<a href="#l61.132"></a><span id="l61.132">     return newEvent.calendar.modifyItem(newEvent, aItem.parentItem, null);</span>
<a href="#l61.133"></a><span id="l61.133">   },</span>
<a href="#l61.134"></a><span id="l61.134"> </span>
<a href="#l61.135"></a><span id="l61.135" class="difflineminus">-  dismissAlarm: function(aItem, aAlarm) {</span>
<a href="#l61.136"></a><span id="l61.136" class="difflineplus">+  dismissAlarm(aItem, aAlarm) {</span>
<a href="#l61.137"></a><span id="l61.137">     let rv;</span>
<a href="#l61.138"></a><span id="l61.138">     if (cal.acl.isCalendarWritable(aItem.calendar) &amp;&amp; cal.acl.userCanModifyItem(aItem)) {</span>
<a href="#l61.139"></a><span id="l61.139">       let now = nowUTC();</span>
<a href="#l61.140"></a><span id="l61.140">       // We want the parent item, otherwise we're going to accidentally</span>
<a href="#l61.141"></a><span id="l61.141">       // create an exception.  We've relnoted (for 0.1) the slightly odd</span>
<a href="#l61.142"></a><span id="l61.142">       // behavior this can cause if you move an event after dismissing an</span>
<a href="#l61.143"></a><span id="l61.143">       // alarm</span>
<a href="#l61.144"></a><span id="l61.144">       let oldParent = aItem.parentItem;</span>
<a href="#l61.145"></a><span id="l61.145" class="difflineat">@@ -202,25 +202,25 @@ calAlarmService.prototype = {</span>
<a href="#l61.146"></a><span id="l61.146">       // effectively dismissing from a user's pov, since the alarm neither</span>
<a href="#l61.147"></a><span id="l61.147">       // popups again in the current user session nor will be added after</span>
<a href="#l61.148"></a><span id="l61.148">       // next restart, since it is missed then already</span>
<a href="#l61.149"></a><span id="l61.149">       this.removeAlarmsForItem(aItem);</span>
<a href="#l61.150"></a><span id="l61.150">     }</span>
<a href="#l61.151"></a><span id="l61.151">     return rv;</span>
<a href="#l61.152"></a><span id="l61.152">   },</span>
<a href="#l61.153"></a><span id="l61.153"> </span>
<a href="#l61.154"></a><span id="l61.154" class="difflineminus">-  addObserver: function(aObserver) {</span>
<a href="#l61.155"></a><span id="l61.155" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l61.156"></a><span id="l61.156">     this.mObservers.add(aObserver);</span>
<a href="#l61.157"></a><span id="l61.157">   },</span>
<a href="#l61.158"></a><span id="l61.158"> </span>
<a href="#l61.159"></a><span id="l61.159" class="difflineminus">-  removeObserver: function(aObserver) {</span>
<a href="#l61.160"></a><span id="l61.160" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l61.161"></a><span id="l61.161">     this.mObservers.delete(aObserver);</span>
<a href="#l61.162"></a><span id="l61.162">   },</span>
<a href="#l61.163"></a><span id="l61.163"> </span>
<a href="#l61.164"></a><span id="l61.164" class="difflineminus">-  startup: function() {</span>
<a href="#l61.165"></a><span id="l61.165" class="difflineplus">+  startup() {</span>
<a href="#l61.166"></a><span id="l61.166">     if (this.mStarted) {</span>
<a href="#l61.167"></a><span id="l61.167">       return;</span>
<a href="#l61.168"></a><span id="l61.168">     }</span>
<a href="#l61.169"></a><span id="l61.169"> </span>
<a href="#l61.170"></a><span id="l61.170">     Services.obs.addObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l61.171"></a><span id="l61.171">     Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l61.172"></a><span id="l61.172">     Services.obs.addObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l61.173"></a><span id="l61.173"> </span>
<a href="#l61.174"></a><span id="l61.174" class="difflineat">@@ -233,17 +233,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.175"></a><span id="l61.175"> </span>
<a href="#l61.176"></a><span id="l61.176">     for (let calendar of cal.getCalendarManager().getCalendars()) {</span>
<a href="#l61.177"></a><span id="l61.177">       this.observeCalendar(calendar);</span>
<a href="#l61.178"></a><span id="l61.178">     }</span>
<a href="#l61.179"></a><span id="l61.179"> </span>
<a href="#l61.180"></a><span id="l61.180">     /* set up a timer to update alarms every N hours */</span>
<a href="#l61.181"></a><span id="l61.181">     let timerCallback = {</span>
<a href="#l61.182"></a><span id="l61.182">       alarmService: this,</span>
<a href="#l61.183"></a><span id="l61.183" class="difflineminus">-      notify: function() {</span>
<a href="#l61.184"></a><span id="l61.184" class="difflineplus">+      notify() {</span>
<a href="#l61.185"></a><span id="l61.185">         let now = nowUTC();</span>
<a href="#l61.186"></a><span id="l61.186">         let start;</span>
<a href="#l61.187"></a><span id="l61.187">         if (this.alarmService.mRangeEnd) {</span>
<a href="#l61.188"></a><span id="l61.188">           // This is a subsequent search, so we got all the past alarms before</span>
<a href="#l61.189"></a><span id="l61.189">           start = this.alarmService.mRangeEnd.clone();</span>
<a href="#l61.190"></a><span id="l61.190">         } else {</span>
<a href="#l61.191"></a><span id="l61.191">           // This is our first search for alarms.  We're going to look for</span>
<a href="#l61.192"></a><span id="l61.192">           // alarms +/- 1 month from now.  If someone sets an alarm more than</span>
<a href="#l61.193"></a><span id="l61.193" class="difflineat">@@ -266,17 +266,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.194"></a><span id="l61.194">     };</span>
<a href="#l61.195"></a><span id="l61.195">     timerCallback.notify();</span>
<a href="#l61.196"></a><span id="l61.196"> </span>
<a href="#l61.197"></a><span id="l61.197">     this.mUpdateTimer = newTimerWithCallback(timerCallback, kHoursBetweenUpdates * 3600000, true);</span>
<a href="#l61.198"></a><span id="l61.198"> </span>
<a href="#l61.199"></a><span id="l61.199">     this.mStarted = true;</span>
<a href="#l61.200"></a><span id="l61.200">   },</span>
<a href="#l61.201"></a><span id="l61.201"> </span>
<a href="#l61.202"></a><span id="l61.202" class="difflineminus">-  shutdown: function() {</span>
<a href="#l61.203"></a><span id="l61.203" class="difflineplus">+  shutdown() {</span>
<a href="#l61.204"></a><span id="l61.204">     if (!this.mStarted) {</span>
<a href="#l61.205"></a><span id="l61.205">       return;</span>
<a href="#l61.206"></a><span id="l61.206">     }</span>
<a href="#l61.207"></a><span id="l61.207"> </span>
<a href="#l61.208"></a><span id="l61.208">     // Tell people that we're no longer running.</span>
<a href="#l61.209"></a><span id="l61.209">     Services.obs.notifyObservers(null, &quot;alarm-service-shutdown&quot;);</span>
<a href="#l61.210"></a><span id="l61.210"> </span>
<a href="#l61.211"></a><span id="l61.211">     if (this.mUpdateTimer) {</span>
<a href="#l61.212"></a><span id="l61.212" class="difflineat">@@ -296,27 +296,27 @@ calAlarmService.prototype = {</span>
<a href="#l61.213"></a><span id="l61.213"> </span>
<a href="#l61.214"></a><span id="l61.214">     Services.obs.removeObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l61.215"></a><span id="l61.215">     Services.obs.removeObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l61.216"></a><span id="l61.216">     Services.obs.removeObserver(this, &quot;wake_notification&quot;);</span>
<a href="#l61.217"></a><span id="l61.217"> </span>
<a href="#l61.218"></a><span id="l61.218">     this.mStarted = false;</span>
<a href="#l61.219"></a><span id="l61.219">   },</span>
<a href="#l61.220"></a><span id="l61.220"> </span>
<a href="#l61.221"></a><span id="l61.221" class="difflineminus">-  observeCalendar: function(calendar) {</span>
<a href="#l61.222"></a><span id="l61.222" class="difflineplus">+  observeCalendar(calendar) {</span>
<a href="#l61.223"></a><span id="l61.223">     calendar.addObserver(this.calendarObserver);</span>
<a href="#l61.224"></a><span id="l61.224">   },</span>
<a href="#l61.225"></a><span id="l61.225"> </span>
<a href="#l61.226"></a><span id="l61.226" class="difflineminus">-  unobserveCalendar: function(calendar) {</span>
<a href="#l61.227"></a><span id="l61.227" class="difflineplus">+  unobserveCalendar(calendar) {</span>
<a href="#l61.228"></a><span id="l61.228">     calendar.removeObserver(this.calendarObserver);</span>
<a href="#l61.229"></a><span id="l61.229">     this.disposeCalendarTimers([calendar]);</span>
<a href="#l61.230"></a><span id="l61.230">     this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l61.231"></a><span id="l61.231">   },</span>
<a href="#l61.232"></a><span id="l61.232"> </span>
<a href="#l61.233"></a><span id="l61.233" class="difflineminus">-  addAlarmsForItem: function(aItem) {</span>
<a href="#l61.234"></a><span id="l61.234" class="difflineplus">+  addAlarmsForItem(aItem) {</span>
<a href="#l61.235"></a><span id="l61.235">     if (cal.item.isToDo(aItem) &amp;&amp; aItem.isCompleted) {</span>
<a href="#l61.236"></a><span id="l61.236">       // If this is a task and it is completed, don't add the alarm.</span>
<a href="#l61.237"></a><span id="l61.237">       return;</span>
<a href="#l61.238"></a><span id="l61.238">     }</span>
<a href="#l61.239"></a><span id="l61.239"> </span>
<a href="#l61.240"></a><span id="l61.240">     let showMissed = Services.prefs.getBoolPref(&quot;calendar.alarms.showmissed&quot;, true);</span>
<a href="#l61.241"></a><span id="l61.241"> </span>
<a href="#l61.242"></a><span id="l61.242">     let alarms = aItem.getAlarms();</span>
<a href="#l61.243"></a><span id="l61.243" class="difflineat">@@ -392,69 +392,68 @@ calAlarmService.prototype = {</span>
<a href="#l61.244"></a><span id="l61.244">         } else {</span>
<a href="#l61.245"></a><span id="l61.245">           // The alarm was not snoozed or dismissed, fire it now.</span>
<a href="#l61.246"></a><span id="l61.246">           this.alarmFired(aItem, alarm);</span>
<a href="#l61.247"></a><span id="l61.247">         }</span>
<a href="#l61.248"></a><span id="l61.248">       }</span>
<a href="#l61.249"></a><span id="l61.249">     }</span>
<a href="#l61.250"></a><span id="l61.250">   },</span>
<a href="#l61.251"></a><span id="l61.251"> </span>
<a href="#l61.252"></a><span id="l61.252" class="difflineminus">-  removeAlarmsForItem: function(aItem) {</span>
<a href="#l61.253"></a><span id="l61.253" class="difflineplus">+  removeAlarmsForItem(aItem) {</span>
<a href="#l61.254"></a><span id="l61.254">     // make sure already fired alarms are purged out of the alarm window:</span>
<a href="#l61.255"></a><span id="l61.255">     this.mObservers.notify(&quot;onRemoveAlarmsByItem&quot;, [aItem]);</span>
<a href="#l61.256"></a><span id="l61.256">     // Purge alarms specifically for this item (i.e exception)</span>
<a href="#l61.257"></a><span id="l61.257">     for (let alarm of aItem.getAlarms()) {</span>
<a href="#l61.258"></a><span id="l61.258">       this.removeTimer(aItem, alarm);</span>
<a href="#l61.259"></a><span id="l61.259">     }</span>
<a href="#l61.260"></a><span id="l61.260">   },</span>
<a href="#l61.261"></a><span id="l61.261"> </span>
<a href="#l61.262"></a><span id="l61.262" class="difflineminus">-  getOccurrencesInRange: function(aItem) {</span>
<a href="#l61.263"></a><span id="l61.263" class="difflineplus">+  getOccurrencesInRange(aItem) {</span>
<a href="#l61.264"></a><span id="l61.264">     // We search 1 month in each direction for alarms.  Therefore,</span>
<a href="#l61.265"></a><span id="l61.265">     // we need occurrences between initial start date and 1 month from now</span>
<a href="#l61.266"></a><span id="l61.266">     let until = nowUTC();</span>
<a href="#l61.267"></a><span id="l61.267">     until.month += 1;</span>
<a href="#l61.268"></a><span id="l61.268"> </span>
<a href="#l61.269"></a><span id="l61.269">     if (aItem &amp;&amp; aItem.recurrenceInfo) {</span>
<a href="#l61.270"></a><span id="l61.270">       return aItem.recurrenceInfo.getOccurrences(this.mRangeStart, until, 0);</span>
<a href="#l61.271"></a><span id="l61.271" class="difflineminus">-    } else {</span>
<a href="#l61.272"></a><span id="l61.272" class="difflineminus">-      return cal.item.checkIfInRange(aItem, this.mRangeStart, until) ? [aItem] : [];</span>
<a href="#l61.273"></a><span id="l61.273">     }</span>
<a href="#l61.274"></a><span id="l61.274" class="difflineplus">+    return cal.item.checkIfInRange(aItem, this.mRangeStart, until) ? [aItem] : [];</span>
<a href="#l61.275"></a><span id="l61.275">   },</span>
<a href="#l61.276"></a><span id="l61.276"> </span>
<a href="#l61.277"></a><span id="l61.277" class="difflineminus">-  addAlarmsForOccurrences: function(aParentItem) {</span>
<a href="#l61.278"></a><span id="l61.278" class="difflineplus">+  addAlarmsForOccurrences(aParentItem) {</span>
<a href="#l61.279"></a><span id="l61.279">     let occs = this.getOccurrencesInRange(aParentItem);</span>
<a href="#l61.280"></a><span id="l61.280"> </span>
<a href="#l61.281"></a><span id="l61.281">     // Add an alarm for each occurrence</span>
<a href="#l61.282"></a><span id="l61.282">     occs.forEach(this.addAlarmsForItem, this);</span>
<a href="#l61.283"></a><span id="l61.283">   },</span>
<a href="#l61.284"></a><span id="l61.284"> </span>
<a href="#l61.285"></a><span id="l61.285" class="difflineminus">-  removeAlarmsForOccurrences: function(aParentItem) {</span>
<a href="#l61.286"></a><span id="l61.286" class="difflineplus">+  removeAlarmsForOccurrences(aParentItem) {</span>
<a href="#l61.287"></a><span id="l61.287">     let occs = this.getOccurrencesInRange(aParentItem);</span>
<a href="#l61.288"></a><span id="l61.288"> </span>
<a href="#l61.289"></a><span id="l61.289">     // Remove alarm for each occurrence</span>
<a href="#l61.290"></a><span id="l61.290">     occs.forEach(this.removeAlarmsForItem, this);</span>
<a href="#l61.291"></a><span id="l61.291">   },</span>
<a href="#l61.292"></a><span id="l61.292"> </span>
<a href="#l61.293"></a><span id="l61.293" class="difflineminus">-  addTimer: function(aItem, aAlarm, aTimeout) {</span>
<a href="#l61.294"></a><span id="l61.294" class="difflineplus">+  addTimer(aItem, aAlarm, aTimeout) {</span>
<a href="#l61.295"></a><span id="l61.295">     this.mTimerMap[aItem.calendar.id] = this.mTimerMap[aItem.calendar.id] || {};</span>
<a href="#l61.296"></a><span id="l61.296">     this.mTimerMap[aItem.calendar.id][aItem.hashId] =</span>
<a href="#l61.297"></a><span id="l61.297">       this.mTimerMap[aItem.calendar.id][aItem.hashId] || {};</span>
<a href="#l61.298"></a><span id="l61.298"> </span>
<a href="#l61.299"></a><span id="l61.299">     let self = this;</span>
<a href="#l61.300"></a><span id="l61.300">     let alarmTimerCallback = {</span>
<a href="#l61.301"></a><span id="l61.301" class="difflineminus">-      notify: function() {</span>
<a href="#l61.302"></a><span id="l61.302" class="difflineplus">+      notify() {</span>
<a href="#l61.303"></a><span id="l61.303">         self.alarmFired(aItem, aAlarm);</span>
<a href="#l61.304"></a><span id="l61.304">       },</span>
<a href="#l61.305"></a><span id="l61.305">     };</span>
<a href="#l61.306"></a><span id="l61.306"> </span>
<a href="#l61.307"></a><span id="l61.307">     let timer = newTimerWithCallback(alarmTimerCallback, aTimeout, false);</span>
<a href="#l61.308"></a><span id="l61.308">     this.mTimerMap[aItem.calendar.id][aItem.hashId][aAlarm.icalString] = timer;</span>
<a href="#l61.309"></a><span id="l61.309">   },</span>
<a href="#l61.310"></a><span id="l61.310"> </span>
<a href="#l61.311"></a><span id="l61.311" class="difflineminus">-  removeTimer: function(aItem, aAlarm) {</span>
<a href="#l61.312"></a><span id="l61.312" class="difflineplus">+  removeTimer(aItem, aAlarm) {</span>
<a href="#l61.313"></a><span id="l61.313">     /* Is the calendar in the timer map */</span>
<a href="#l61.314"></a><span id="l61.314">     if (</span>
<a href="#l61.315"></a><span id="l61.315">       aItem.calendar.id in this.mTimerMap &amp;&amp;</span>
<a href="#l61.316"></a><span id="l61.316">       /* ...and is the item in the calendar map */</span>
<a href="#l61.317"></a><span id="l61.317">       aItem.hashId in this.mTimerMap[aItem.calendar.id] &amp;&amp;</span>
<a href="#l61.318"></a><span id="l61.318">       /* ...and is the alarm in the item map ? */</span>
<a href="#l61.319"></a><span id="l61.319">       aAlarm.icalString in this.mTimerMap[aItem.calendar.id][aItem.hashId]</span>
<a href="#l61.320"></a><span id="l61.320">     ) {</span>
<a href="#l61.321"></a><span id="l61.321" class="difflineat">@@ -472,39 +471,39 @@ calAlarmService.prototype = {</span>
<a href="#l61.322"></a><span id="l61.322"> </span>
<a href="#l61.323"></a><span id="l61.323">       // If the calendar map is empty, remove it from the timer map</span>
<a href="#l61.324"></a><span id="l61.324">       if (this.mTimerMap[aItem.calendar.id].toSource() == &quot;({})&quot;) {</span>
<a href="#l61.325"></a><span id="l61.325">         delete this.mTimerMap[aItem.calendar.id];</span>
<a href="#l61.326"></a><span id="l61.326">       }</span>
<a href="#l61.327"></a><span id="l61.327">     }</span>
<a href="#l61.328"></a><span id="l61.328">   },</span>
<a href="#l61.329"></a><span id="l61.329"> </span>
<a href="#l61.330"></a><span id="l61.330" class="difflineminus">-  disposeCalendarTimers: function(aCalendars) {</span>
<a href="#l61.331"></a><span id="l61.331" class="difflineplus">+  disposeCalendarTimers(aCalendars) {</span>
<a href="#l61.332"></a><span id="l61.332">     for (let calendar of aCalendars) {</span>
<a href="#l61.333"></a><span id="l61.333">       if (calendar.id in this.mTimerMap) {</span>
<a href="#l61.334"></a><span id="l61.334">         for (let hashId in this.mTimerMap[calendar.id]) {</span>
<a href="#l61.335"></a><span id="l61.335">           let itemTimerMap = this.mTimerMap[calendar.id][hashId];</span>
<a href="#l61.336"></a><span id="l61.336">           for (let icalString in itemTimerMap) {</span>
<a href="#l61.337"></a><span id="l61.337">             let timer = itemTimerMap[icalString];</span>
<a href="#l61.338"></a><span id="l61.338">             timer.cancel();</span>
<a href="#l61.339"></a><span id="l61.339">           }</span>
<a href="#l61.340"></a><span id="l61.340">         }</span>
<a href="#l61.341"></a><span id="l61.341">         delete this.mTimerMap[calendar.id];</span>
<a href="#l61.342"></a><span id="l61.342">       }</span>
<a href="#l61.343"></a><span id="l61.343">     }</span>
<a href="#l61.344"></a><span id="l61.344">   },</span>
<a href="#l61.345"></a><span id="l61.345"> </span>
<a href="#l61.346"></a><span id="l61.346" class="difflineminus">-  findAlarms: function(aCalendars, aStart, aUntil) {</span>
<a href="#l61.347"></a><span id="l61.347" class="difflineplus">+  findAlarms(aCalendars, aStart, aUntil) {</span>
<a href="#l61.348"></a><span id="l61.348">     let getListener = {</span>
<a href="#l61.349"></a><span id="l61.349">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l61.350"></a><span id="l61.350">       alarmService: this,</span>
<a href="#l61.351"></a><span id="l61.351">       addRemovePromise: PromiseUtils.defer(),</span>
<a href="#l61.352"></a><span id="l61.352">       batchCount: 0,</span>
<a href="#l61.353"></a><span id="l61.353">       results: false,</span>
<a href="#l61.354"></a><span id="l61.354" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l61.355"></a><span id="l61.355" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l61.356"></a><span id="l61.356">         this.addRemovePromise.promise.then(</span>
<a href="#l61.357"></a><span id="l61.357">           aValue =&gt; {</span>
<a href="#l61.358"></a><span id="l61.358">             // calendar has been loaded, so until now, onLoad events can be ignored:</span>
<a href="#l61.359"></a><span id="l61.359">             this.alarmService.mLoadedCalendars[aCalendar.id] = true;</span>
<a href="#l61.360"></a><span id="l61.360"> </span>
<a href="#l61.361"></a><span id="l61.361">             // notify observers that the alarms for the calendar have been loaded</span>
<a href="#l61.362"></a><span id="l61.362">             this.alarmService.mObservers.notify(&quot;onAlarmsLoaded&quot;, [aCalendar]);</span>
<a href="#l61.363"></a><span id="l61.363">           },</span>
<a href="#l61.364"></a><span id="l61.364" class="difflineat">@@ -515,17 +514,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.365"></a><span id="l61.365">           }</span>
<a href="#l61.366"></a><span id="l61.366">         );</span>
<a href="#l61.367"></a><span id="l61.367"> </span>
<a href="#l61.368"></a><span id="l61.368">         // if no results were returned we still need to resolve the promise</span>
<a href="#l61.369"></a><span id="l61.369">         if (!this.results) {</span>
<a href="#l61.370"></a><span id="l61.370">           this.addRemovePromise.resolve();</span>
<a href="#l61.371"></a><span id="l61.371">         }</span>
<a href="#l61.372"></a><span id="l61.372">       },</span>
<a href="#l61.373"></a><span id="l61.373" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l61.374"></a><span id="l61.374" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l61.375"></a><span id="l61.375">         let promise = this.addRemovePromise;</span>
<a href="#l61.376"></a><span id="l61.376">         this.batchCount++;</span>
<a href="#l61.377"></a><span id="l61.377">         this.results = true;</span>
<a href="#l61.378"></a><span id="l61.378"> </span>
<a href="#l61.379"></a><span id="l61.379">         cal.iterate.forEach(</span>
<a href="#l61.380"></a><span id="l61.380">           aItems,</span>
<a href="#l61.381"></a><span id="l61.381">           item =&gt; {</span>
<a href="#l61.382"></a><span id="l61.382">             try {</span>
<a href="#l61.383"></a><span id="l61.383" class="difflineat">@@ -557,17 +556,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.384"></a><span id="l61.384">         calendar.getItems(filter, 0, aStart, aUntil, getListener);</span>
<a href="#l61.385"></a><span id="l61.385">       } else {</span>
<a href="#l61.386"></a><span id="l61.386">         this.mLoadedCalendars[calendar.id] = true;</span>
<a href="#l61.387"></a><span id="l61.387">         this.mObservers.notify(&quot;onAlarmsLoaded&quot;, [calendar]);</span>
<a href="#l61.388"></a><span id="l61.388">       }</span>
<a href="#l61.389"></a><span id="l61.389">     }</span>
<a href="#l61.390"></a><span id="l61.390">   },</span>
<a href="#l61.391"></a><span id="l61.391"> </span>
<a href="#l61.392"></a><span id="l61.392" class="difflineminus">-  initAlarms: function(aCalendars) {</span>
<a href="#l61.393"></a><span id="l61.393" class="difflineplus">+  initAlarms(aCalendars) {</span>
<a href="#l61.394"></a><span id="l61.394">     // Purge out all alarm timers belonging to the refreshed/loaded calendars</span>
<a href="#l61.395"></a><span id="l61.395">     this.disposeCalendarTimers(aCalendars);</span>
<a href="#l61.396"></a><span id="l61.396"> </span>
<a href="#l61.397"></a><span id="l61.397">     // Purge out all alarms from dialog belonging to the refreshed/loaded calendars</span>
<a href="#l61.398"></a><span id="l61.398">     for (let calendar of aCalendars) {</span>
<a href="#l61.399"></a><span id="l61.399">       this.mLoadedCalendars[calendar.id] = false;</span>
<a href="#l61.400"></a><span id="l61.400">       this.mObservers.notify(&quot;onRemoveAlarmsByCalendar&quot;, [calendar]);</span>
<a href="#l61.401"></a><span id="l61.401">     }</span>
<a href="#l61.402"></a><span id="l61.402" class="difflineat">@@ -578,17 +577,17 @@ calAlarmService.prototype = {</span>
<a href="#l61.403"></a><span id="l61.403">     // for a month, they'll miss some, but that's a slim chance</span>
<a href="#l61.404"></a><span id="l61.404">     let start = nowUTC();</span>
<a href="#l61.405"></a><span id="l61.405">     let until = start.clone();</span>
<a href="#l61.406"></a><span id="l61.406">     start.month -= Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l61.407"></a><span id="l61.407">     until.month += Ci.calIAlarmService.MAX_SNOOZE_MONTHS;</span>
<a href="#l61.408"></a><span id="l61.408">     this.findAlarms(aCalendars, start, until);</span>
<a href="#l61.409"></a><span id="l61.409">   },</span>
<a href="#l61.410"></a><span id="l61.410"> </span>
<a href="#l61.411"></a><span id="l61.411" class="difflineminus">-  alarmFired: function(aItem, aAlarm) {</span>
<a href="#l61.412"></a><span id="l61.412" class="difflineplus">+  alarmFired(aItem, aAlarm) {</span>
<a href="#l61.413"></a><span id="l61.413">     if (</span>
<a href="#l61.414"></a><span id="l61.414">       !aItem.calendar.getProperty(&quot;suppressAlarms&quot;) &amp;&amp;</span>
<a href="#l61.415"></a><span id="l61.415">       !aItem.calendar.getProperty(&quot;disabled&quot;) &amp;&amp;</span>
<a href="#l61.416"></a><span id="l61.416">       aItem.getProperty(&quot;STATUS&quot;) != &quot;CANCELLED&quot;</span>
<a href="#l61.417"></a><span id="l61.417">     ) {</span>
<a href="#l61.418"></a><span id="l61.418">       this.mObservers.notify(&quot;onAlarm&quot;, [aItem, aAlarm]);</span>
<a href="#l61.419"></a><span id="l61.419">     }</span>
<a href="#l61.420"></a><span id="l61.420">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/calendar/base/src/calAttachment.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/calendar/base/src/calAttachment.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -130,41 +130,40 @@ calAttachment.prototype = {</span>
<a href="#l62.4"></a><span id="l62.4">     let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l62.5"></a><span id="l62.5">     if (prop.propertyName != &quot;ATTACH&quot;) {</span>
<a href="#l62.6"></a><span id="l62.6">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l62.7"></a><span id="l62.7">     }</span>
<a href="#l62.8"></a><span id="l62.8">     this.icalProperty = prop;</span>
<a href="#l62.9"></a><span id="l62.9">     return val;</span>
<a href="#l62.10"></a><span id="l62.10">   },</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-  getParameter: function(aName) {</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+  getParameter(aName) {</span>
<a href="#l62.14"></a><span id="l62.14">     return this.mProperties.get(aName);</span>
<a href="#l62.15"></a><span id="l62.15">   },</span>
<a href="#l62.16"></a><span id="l62.16"> </span>
<a href="#l62.17"></a><span id="l62.17" class="difflineminus">-  setParameter: function(aName, aValue) {</span>
<a href="#l62.18"></a><span id="l62.18" class="difflineplus">+  setParameter(aName, aValue) {</span>
<a href="#l62.19"></a><span id="l62.19">     if (aValue || aValue === 0) {</span>
<a href="#l62.20"></a><span id="l62.20">       return this.mProperties.set(aName, aValue);</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineminus">-    } else {</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineminus">-      return this.mProperties.delete(aName);</span>
<a href="#l62.23"></a><span id="l62.23">     }</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+    return this.mProperties.delete(aName);</span>
<a href="#l62.25"></a><span id="l62.25">   },</span>
<a href="#l62.26"></a><span id="l62.26"> </span>
<a href="#l62.27"></a><span id="l62.27" class="difflineminus">-  deleteParameter: function(aName) {</span>
<a href="#l62.28"></a><span id="l62.28" class="difflineplus">+  deleteParameter(aName) {</span>
<a href="#l62.29"></a><span id="l62.29">     this.mProperties.delete(aName);</span>
<a href="#l62.30"></a><span id="l62.30">   },</span>
<a href="#l62.31"></a><span id="l62.31"> </span>
<a href="#l62.32"></a><span id="l62.32" class="difflineminus">-  clone: function() {</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+  clone() {</span>
<a href="#l62.34"></a><span id="l62.34">     let newAttachment = new calAttachment();</span>
<a href="#l62.35"></a><span id="l62.35">     newAttachment.mData = this.mData;</span>
<a href="#l62.36"></a><span id="l62.36">     newAttachment.mHashId = this.mHashId;</span>
<a href="#l62.37"></a><span id="l62.37">     for (let [name, value] of this.mProperties.entries()) {</span>
<a href="#l62.38"></a><span id="l62.38">       newAttachment.mProperties.set(name, value);</span>
<a href="#l62.39"></a><span id="l62.39">     }</span>
<a href="#l62.40"></a><span id="l62.40">     return newAttachment;</span>
<a href="#l62.41"></a><span id="l62.41">   },</span>
<a href="#l62.42"></a><span id="l62.42"> </span>
<a href="#l62.43"></a><span id="l62.43" class="difflineminus">-  setData: function(aData) {</span>
<a href="#l62.44"></a><span id="l62.44" class="difflineplus">+  setData(aData) {</span>
<a href="#l62.45"></a><span id="l62.45">     // Sets the data and invalidates the hash so it will be recalculated</span>
<a href="#l62.46"></a><span id="l62.46">     this.mHashId = null;</span>
<a href="#l62.47"></a><span id="l62.47">     this.mData = aData;</span>
<a href="#l62.48"></a><span id="l62.48">     return this.mData;</span>
<a href="#l62.49"></a><span id="l62.49">   },</span>
<a href="#l62.50"></a><span id="l62.50"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/calendar/base/src/calAttendee.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/calendar/base/src/calAttendee.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -13,27 +13,27 @@ calAttendee.prototype = {</span>
<a href="#l63.4"></a><span id="l63.4">   QueryInterface: ChromeUtils.generateQI([Ci.calIAttendee]),</span>
<a href="#l63.5"></a><span id="l63.5">   classID: Components.ID(&quot;{5c8dcaa3-170c-4a73-8142-d531156f664d}&quot;),</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7">   mImmutable: false,</span>
<a href="#l63.8"></a><span id="l63.8">   get isMutable() {</span>
<a href="#l63.9"></a><span id="l63.9">     return !this.mImmutable;</span>
<a href="#l63.10"></a><span id="l63.10">   },</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-  modify: function() {</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+  modify() {</span>
<a href="#l63.14"></a><span id="l63.14">     if (this.mImmutable) {</span>
<a href="#l63.15"></a><span id="l63.15">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l63.16"></a><span id="l63.16">     }</span>
<a href="#l63.17"></a><span id="l63.17">   },</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+  makeImmutable() {</span>
<a href="#l63.21"></a><span id="l63.21">     this.mImmutable = true;</span>
<a href="#l63.22"></a><span id="l63.22">   },</span>
<a href="#l63.23"></a><span id="l63.23"> </span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-  clone: function() {</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  clone() {</span>
<a href="#l63.26"></a><span id="l63.26">     let a = new calAttendee();</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28">     if (this.mIsOrganizer) {</span>
<a href="#l63.29"></a><span id="l63.29">       a.isOrganizer = true;</span>
<a href="#l63.30"></a><span id="l63.30">     }</span>
<a href="#l63.31"></a><span id="l63.31"> </span>
<a href="#l63.32"></a><span id="l63.32">     const allProps = [&quot;id&quot;, &quot;commonName&quot;, &quot;rsvp&quot;, &quot;role&quot;, &quot;participationStatus&quot;, &quot;userType&quot;];</span>
<a href="#l63.33"></a><span id="l63.33">     for (let prop of allProps) {</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineat">@@ -146,44 +146,44 @@ calAttendee.prototype = {</span>
<a href="#l63.35"></a><span id="l63.35">     return val;</span>
<a href="#l63.36"></a><span id="l63.36">   },</span>
<a href="#l63.37"></a><span id="l63.37"> </span>
<a href="#l63.38"></a><span id="l63.38">   get properties() {</span>
<a href="#l63.39"></a><span id="l63.39">     return this.mProperties.entries();</span>
<a href="#l63.40"></a><span id="l63.40">   },</span>
<a href="#l63.41"></a><span id="l63.41"> </span>
<a href="#l63.42"></a><span id="l63.42">   // The has/get/set/deleteProperty methods are case-insensitive.</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l63.45"></a><span id="l63.45">     return this.mProperties.get(aName.toUpperCase());</span>
<a href="#l63.46"></a><span id="l63.46">   },</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineplus">+  setProperty(aName, aValue) {</span>
<a href="#l63.49"></a><span id="l63.49">     this.modify();</span>
<a href="#l63.50"></a><span id="l63.50">     if (aValue || !isNaN(parseInt(aValue, 10))) {</span>
<a href="#l63.51"></a><span id="l63.51">       this.mProperties.set(aName.toUpperCase(), aValue);</span>
<a href="#l63.52"></a><span id="l63.52">     } else {</span>
<a href="#l63.53"></a><span id="l63.53">       this.mProperties.delete(aName.toUpperCase());</span>
<a href="#l63.54"></a><span id="l63.54">     }</span>
<a href="#l63.55"></a><span id="l63.55">   },</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineminus">-  deleteProperty: function(aName) {</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineplus">+  deleteProperty(aName) {</span>
<a href="#l63.58"></a><span id="l63.58">     this.modify();</span>
<a href="#l63.59"></a><span id="l63.59">     this.mProperties.delete(aName.toUpperCase());</span>
<a href="#l63.60"></a><span id="l63.60">   },</span>
<a href="#l63.61"></a><span id="l63.61"> </span>
<a href="#l63.62"></a><span id="l63.62">   mId: null,</span>
<a href="#l63.63"></a><span id="l63.63">   get id() {</span>
<a href="#l63.64"></a><span id="l63.64">     return this.mId;</span>
<a href="#l63.65"></a><span id="l63.65">   },</span>
<a href="#l63.66"></a><span id="l63.66">   set id(aId) {</span>
<a href="#l63.67"></a><span id="l63.67">     this.modify();</span>
<a href="#l63.68"></a><span id="l63.68">     // RFC 1738 para 2.1 says we should be using lowercase mailto: urls</span>
<a href="#l63.69"></a><span id="l63.69">     // we enforce prepending the mailto prefix for email type ids as migration code bug 1199942</span>
<a href="#l63.70"></a><span id="l63.70">     return (this.mId = aId ? cal.email.prependMailTo(aId) : null);</span>
<a href="#l63.71"></a><span id="l63.71">   },</span>
<a href="#l63.72"></a><span id="l63.72"> </span>
<a href="#l63.73"></a><span id="l63.73" class="difflineminus">-  toString: function() {</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineplus">+  toString() {</span>
<a href="#l63.75"></a><span id="l63.75">     const emailRE = new RegExp(&quot;^mailto:&quot;, &quot;i&quot;);</span>
<a href="#l63.76"></a><span id="l63.76">     let stringRep = (this.id || &quot;&quot;).replace(emailRE, &quot;&quot;);</span>
<a href="#l63.77"></a><span id="l63.77">     let commonName = this.commonName;</span>
<a href="#l63.78"></a><span id="l63.78"> </span>
<a href="#l63.79"></a><span id="l63.79">     if (commonName) {</span>
<a href="#l63.80"></a><span id="l63.80">       stringRep = commonName + &quot; &lt;&quot; + stringRep + &quot;&gt;&quot;;</span>
<a href="#l63.81"></a><span id="l63.81">     }</span>
<a href="#l63.82"></a><span id="l63.82"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/calendar/base/src/calCachedCalendar.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/calendar/base/src/calCachedCalendar.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -6,19 +6,19 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l64.4"></a><span id="l64.4"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> var calICalendar = Ci.calICalendar;</span>
<a href="#l64.7"></a><span id="l64.7"> var cICL = Ci.calIChangeLog;</span>
<a href="#l64.8"></a><span id="l64.8"> var cIOL = Ci.calIOperationListener;</span>
<a href="#l64.9"></a><span id="l64.9"> </span>
<a href="#l64.10"></a><span id="l64.10"> var gNoOpListener = {</span>
<a href="#l64.11"></a><span id="l64.11">   QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-  onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+  onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.14"></a><span id="l64.14"> </span>
<a href="#l64.15"></a><span id="l64.15" class="difflineminus">-  onOperationComplete: function(calendar, status, opType, id, detail) {},</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+  onOperationComplete(calendar, status, opType, id, detail) {},</span>
<a href="#l64.17"></a><span id="l64.17"> };</span>
<a href="#l64.18"></a><span id="l64.18"> </span>
<a href="#l64.19"></a><span id="l64.19"> /**</span>
<a href="#l64.20"></a><span id="l64.20">  * Returns true if the exception passed is one that should cause the cache</span>
<a href="#l64.21"></a><span id="l64.21">  * layer to retry the operation. This is usually a network error or other</span>
<a href="#l64.22"></a><span id="l64.22">  * temporary error.</span>
<a href="#l64.23"></a><span id="l64.23">  *</span>
<a href="#l64.24"></a><span id="l64.24">  * @param result     The result code to check.</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineat">@@ -49,68 +49,68 @@ function isUnavailableCode(result) {</span>
<a href="#l64.26"></a><span id="l64.26"> function calCachedCalendarObserverHelper(home, isCachedObserver) {</span>
<a href="#l64.27"></a><span id="l64.27">   this.home = home;</span>
<a href="#l64.28"></a><span id="l64.28">   this.isCachedObserver = isCachedObserver;</span>
<a href="#l64.29"></a><span id="l64.29"> }</span>
<a href="#l64.30"></a><span id="l64.30"> calCachedCalendarObserverHelper.prototype = {</span>
<a href="#l64.31"></a><span id="l64.31">   QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l64.32"></a><span id="l64.32">   isCachedObserver: false,</span>
<a href="#l64.33"></a><span id="l64.33"> </span>
<a href="#l64.34"></a><span id="l64.34" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l64.35"></a><span id="l64.35" class="difflineplus">+  onStartBatch() {</span>
<a href="#l64.36"></a><span id="l64.36">     this.home.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l64.37"></a><span id="l64.37">   },</span>
<a href="#l64.38"></a><span id="l64.38"> </span>
<a href="#l64.39"></a><span id="l64.39" class="difflineminus">-  onEndBatch: function() {</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+  onEndBatch() {</span>
<a href="#l64.41"></a><span id="l64.41">     this.home.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l64.42"></a><span id="l64.42">   },</span>
<a href="#l64.43"></a><span id="l64.43"> </span>
<a href="#l64.44"></a><span id="l64.44" class="difflineminus">-  onLoad: function(calendar) {</span>
<a href="#l64.45"></a><span id="l64.45" class="difflineplus">+  onLoad(calendar) {</span>
<a href="#l64.46"></a><span id="l64.46">     if (this.isCachedObserver) {</span>
<a href="#l64.47"></a><span id="l64.47">       this.home.mObservers.notify(&quot;onLoad&quot;, [this.home]);</span>
<a href="#l64.48"></a><span id="l64.48">     } else {</span>
<a href="#l64.49"></a><span id="l64.49">       // start sync action after uncached calendar has been loaded.</span>
<a href="#l64.50"></a><span id="l64.50">       // xxx todo, think about:</span>
<a href="#l64.51"></a><span id="l64.51">       // although onAddItem et al have been called, we need to fire</span>
<a href="#l64.52"></a><span id="l64.52">       // an additional onLoad completing the refresh call (-&gt;composite)</span>
<a href="#l64.53"></a><span id="l64.53">       let home = this.home;</span>
<a href="#l64.54"></a><span id="l64.54">       home.synchronize(status =&gt; {</span>
<a href="#l64.55"></a><span id="l64.55">         home.mObservers.notify(&quot;onLoad&quot;, [home]);</span>
<a href="#l64.56"></a><span id="l64.56">       });</span>
<a href="#l64.57"></a><span id="l64.57">     }</span>
<a href="#l64.58"></a><span id="l64.58">   },</span>
<a href="#l64.59"></a><span id="l64.59"> </span>
<a href="#l64.60"></a><span id="l64.60" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l64.62"></a><span id="l64.62">     if (this.isCachedObserver) {</span>
<a href="#l64.63"></a><span id="l64.63">       this.home.mObservers.notify(&quot;onAddItem&quot;, arguments);</span>
<a href="#l64.64"></a><span id="l64.64">     }</span>
<a href="#l64.65"></a><span id="l64.65">   },</span>
<a href="#l64.66"></a><span id="l64.66"> </span>
<a href="#l64.67"></a><span id="l64.67" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l64.68"></a><span id="l64.68" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l64.69"></a><span id="l64.69">     if (this.isCachedObserver) {</span>
<a href="#l64.70"></a><span id="l64.70">       this.home.mObservers.notify(&quot;onModifyItem&quot;, arguments);</span>
<a href="#l64.71"></a><span id="l64.71">     }</span>
<a href="#l64.72"></a><span id="l64.72">   },</span>
<a href="#l64.73"></a><span id="l64.73"> </span>
<a href="#l64.74"></a><span id="l64.74" class="difflineminus">-  onDeleteItem: function(aItem) {</span>
<a href="#l64.75"></a><span id="l64.75" class="difflineplus">+  onDeleteItem(aItem) {</span>
<a href="#l64.76"></a><span id="l64.76">     if (this.isCachedObserver) {</span>
<a href="#l64.77"></a><span id="l64.77">       this.home.mObservers.notify(&quot;onDeleteItem&quot;, arguments);</span>
<a href="#l64.78"></a><span id="l64.78">     }</span>
<a href="#l64.79"></a><span id="l64.79">   },</span>
<a href="#l64.80"></a><span id="l64.80"> </span>
<a href="#l64.81"></a><span id="l64.81" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l64.82"></a><span id="l64.82" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l64.83"></a><span id="l64.83">     this.home.mObservers.notify(&quot;onError&quot;, arguments);</span>
<a href="#l64.84"></a><span id="l64.84">   },</span>
<a href="#l64.85"></a><span id="l64.85"> </span>
<a href="#l64.86"></a><span id="l64.86" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l64.87"></a><span id="l64.87" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l64.88"></a><span id="l64.88">     if (!this.isCachedObserver) {</span>
<a href="#l64.89"></a><span id="l64.89">       this.home.mObservers.notify(&quot;onPropertyChanged&quot;, [this.home, aName, aValue, aOldValue]);</span>
<a href="#l64.90"></a><span id="l64.90">     }</span>
<a href="#l64.91"></a><span id="l64.91">   },</span>
<a href="#l64.92"></a><span id="l64.92"> </span>
<a href="#l64.93"></a><span id="l64.93" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l64.94"></a><span id="l64.94" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l64.95"></a><span id="l64.95">     if (!this.isCachedObserver) {</span>
<a href="#l64.96"></a><span id="l64.96">       this.home.mObservers.notify(&quot;onPropertyDeleting&quot;, [this.home, aName]);</span>
<a href="#l64.97"></a><span id="l64.97">     }</span>
<a href="#l64.98"></a><span id="l64.98">   },</span>
<a href="#l64.99"></a><span id="l64.99"> };</span>
<a href="#l64.100"></a><span id="l64.100"> </span>
<a href="#l64.101"></a><span id="l64.101"> function calCachedCalendar(uncachedCalendar) {</span>
<a href="#l64.102"></a><span id="l64.102">   this.wrappedJSObject = this;</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineat">@@ -123,56 +123,55 @@ function calCachedCalendar(uncachedCalen</span>
<a href="#l64.104"></a><span id="l64.104">   if (this.supportsChangeLog) {</span>
<a href="#l64.105"></a><span id="l64.105">     uncachedCalendar.offlineStorage = this.mCachedCalendar;</span>
<a href="#l64.106"></a><span id="l64.106">   }</span>
<a href="#l64.107"></a><span id="l64.107">   this.offlineCachedItems = {};</span>
<a href="#l64.108"></a><span id="l64.108">   this.offlineCachedItemFlags = {};</span>
<a href="#l64.109"></a><span id="l64.109"> }</span>
<a href="#l64.110"></a><span id="l64.110"> calCachedCalendar.prototype = {</span>
<a href="#l64.111"></a><span id="l64.111">   /* eslint-disable mozilla/use-chromeutils-generateqi */</span>
<a href="#l64.112"></a><span id="l64.112" class="difflineminus">-  QueryInterface: function(aIID) {</span>
<a href="#l64.113"></a><span id="l64.113" class="difflineplus">+  QueryInterface(aIID) {</span>
<a href="#l64.114"></a><span id="l64.114">     if (aIID.equals(Ci.calISchedulingSupport) &amp;&amp; this.mUncachedCalendar.QueryInterface(aIID)) {</span>
<a href="#l64.115"></a><span id="l64.115">       // check whether uncached calendar supports it:</span>
<a href="#l64.116"></a><span id="l64.116">       return this;</span>
<a href="#l64.117"></a><span id="l64.117">     } else if (aIID.equals(Ci.calICalendar) || aIID.equals(Ci.nsISupports)) {</span>
<a href="#l64.118"></a><span id="l64.118">       return this;</span>
<a href="#l64.119"></a><span id="l64.119" class="difflineminus">-    } else {</span>
<a href="#l64.120"></a><span id="l64.120" class="difflineminus">-      throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l64.121"></a><span id="l64.121">     }</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l64.123"></a><span id="l64.123">   },</span>
<a href="#l64.124"></a><span id="l64.124">   /* eslint-enable mozilla/use-chromeutils-generateqi */</span>
<a href="#l64.125"></a><span id="l64.125"> </span>
<a href="#l64.126"></a><span id="l64.126">   mCachedCalendar: null,</span>
<a href="#l64.127"></a><span id="l64.127">   mCachedObserver: null,</span>
<a href="#l64.128"></a><span id="l64.128">   mUncachedCalendar: null,</span>
<a href="#l64.129"></a><span id="l64.129">   mObservers: null,</span>
<a href="#l64.130"></a><span id="l64.130">   mSuperCalendar: null,</span>
<a href="#l64.131"></a><span id="l64.131">   offlineCachedItems: null,</span>
<a href="#l64.132"></a><span id="l64.132">   offlineCachedItemFlags: null,</span>
<a href="#l64.133"></a><span id="l64.133"> </span>
<a href="#l64.134"></a><span id="l64.134" class="difflineminus">-  onCalendarUnregistering: function() {</span>
<a href="#l64.135"></a><span id="l64.135" class="difflineplus">+  onCalendarUnregistering() {</span>
<a href="#l64.136"></a><span id="l64.136">     if (this.mCachedCalendar) {</span>
<a href="#l64.137"></a><span id="l64.137">       let self = this;</span>
<a href="#l64.138"></a><span id="l64.138">       this.mCachedCalendar.removeObserver(this.mCachedObserver);</span>
<a href="#l64.139"></a><span id="l64.139">       // TODO put changes into a different calendar and delete</span>
<a href="#l64.140"></a><span id="l64.140">       // afterwards.</span>
<a href="#l64.141"></a><span id="l64.141"> </span>
<a href="#l64.142"></a><span id="l64.142">       let listener = {</span>
<a href="#l64.143"></a><span id="l64.143" class="difflineminus">-        onDeleteCalendar: function(aCalendar, aStatus, aDetail) {</span>
<a href="#l64.144"></a><span id="l64.144" class="difflineplus">+        onDeleteCalendar(aCalendar, aStatus, aDetail) {</span>
<a href="#l64.145"></a><span id="l64.145">           self.mCachedCalendar = null;</span>
<a href="#l64.146"></a><span id="l64.146">         },</span>
<a href="#l64.147"></a><span id="l64.147">       };</span>
<a href="#l64.148"></a><span id="l64.148"> </span>
<a href="#l64.149"></a><span id="l64.149">       this.mCachedCalendar</span>
<a href="#l64.150"></a><span id="l64.150">         .QueryInterface(Ci.calICalendarProvider)</span>
<a href="#l64.151"></a><span id="l64.151">         .deleteCalendar(this.mCachedCalendar, listener);</span>
<a href="#l64.152"></a><span id="l64.152">     }</span>
<a href="#l64.153"></a><span id="l64.153">   },</span>
<a href="#l64.154"></a><span id="l64.154"> </span>
<a href="#l64.155"></a><span id="l64.155" class="difflineminus">-  setupCachedCalendar: function() {</span>
<a href="#l64.156"></a><span id="l64.156" class="difflineplus">+  setupCachedCalendar() {</span>
<a href="#l64.157"></a><span id="l64.157">     try {</span>
<a href="#l64.158"></a><span id="l64.158">       if (this.mCachedCalendar) {</span>
<a href="#l64.159"></a><span id="l64.159">         // this is actually a resetupCachedCalendar:</span>
<a href="#l64.160"></a><span id="l64.160">         // Although this doesn't really follow the spec, we know the</span>
<a href="#l64.161"></a><span id="l64.161">         // storage calendar's deleteCalendar method is synchronous.</span>
<a href="#l64.162"></a><span id="l64.162">         // TODO put changes into a different calendar and delete</span>
<a href="#l64.163"></a><span id="l64.163">         // afterwards.</span>
<a href="#l64.164"></a><span id="l64.164">         this.mCachedCalendar</span>
<a href="#l64.165"></a><span id="l64.165" class="difflineat">@@ -219,94 +218,94 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.166"></a><span id="l64.166">         cachedCalendar.addObserver(this.mCachedObserver);</span>
<a href="#l64.167"></a><span id="l64.167">         this.mCachedCalendar = cachedCalendar;</span>
<a href="#l64.168"></a><span id="l64.168">       }</span>
<a href="#l64.169"></a><span id="l64.169">     } catch (exc) {</span>
<a href="#l64.170"></a><span id="l64.170">       Cu.reportError(exc);</span>
<a href="#l64.171"></a><span id="l64.171">     }</span>
<a href="#l64.172"></a><span id="l64.172">   },</span>
<a href="#l64.173"></a><span id="l64.173"> </span>
<a href="#l64.174"></a><span id="l64.174" class="difflineminus">-  getOfflineAddedItems: function(callbackFunc) {</span>
<a href="#l64.175"></a><span id="l64.175" class="difflineplus">+  getOfflineAddedItems(callbackFunc) {</span>
<a href="#l64.176"></a><span id="l64.176">     let self = this;</span>
<a href="#l64.177"></a><span id="l64.177">     self.offlineCachedItems = {};</span>
<a href="#l64.178"></a><span id="l64.178">     let getListener = {</span>
<a href="#l64.179"></a><span id="l64.179">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.180"></a><span id="l64.180" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.181"></a><span id="l64.181" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.182"></a><span id="l64.182">         for (let item of aItems) {</span>
<a href="#l64.183"></a><span id="l64.183">           self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.184"></a><span id="l64.184">           self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l64.185"></a><span id="l64.185">         }</span>
<a href="#l64.186"></a><span id="l64.186">       },</span>
<a href="#l64.187"></a><span id="l64.187"> </span>
<a href="#l64.188"></a><span id="l64.188" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.189"></a><span id="l64.189" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.190"></a><span id="l64.190">         self.getOfflineModifiedItems(callbackFunc);</span>
<a href="#l64.191"></a><span id="l64.191">       },</span>
<a href="#l64.192"></a><span id="l64.192">     };</span>
<a href="#l64.193"></a><span id="l64.193">     this.mCachedCalendar.getItems(</span>
<a href="#l64.194"></a><span id="l64.194">       calICalendar.ITEM_FILTER_ALL_ITEMS | calICalendar.ITEM_FILTER_OFFLINE_CREATED,</span>
<a href="#l64.195"></a><span id="l64.195">       0,</span>
<a href="#l64.196"></a><span id="l64.196">       null,</span>
<a href="#l64.197"></a><span id="l64.197">       null,</span>
<a href="#l64.198"></a><span id="l64.198">       getListener</span>
<a href="#l64.199"></a><span id="l64.199">     );</span>
<a href="#l64.200"></a><span id="l64.200">   },</span>
<a href="#l64.201"></a><span id="l64.201"> </span>
<a href="#l64.202"></a><span id="l64.202" class="difflineminus">-  getOfflineModifiedItems: function(callbackFunc) {</span>
<a href="#l64.203"></a><span id="l64.203" class="difflineplus">+  getOfflineModifiedItems(callbackFunc) {</span>
<a href="#l64.204"></a><span id="l64.204">     let self = this;</span>
<a href="#l64.205"></a><span id="l64.205">     let getListener = {</span>
<a href="#l64.206"></a><span id="l64.206">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.207"></a><span id="l64.207" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.208"></a><span id="l64.208" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.209"></a><span id="l64.209">         for (let item of aItems) {</span>
<a href="#l64.210"></a><span id="l64.210">           self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.211"></a><span id="l64.211">           self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l64.212"></a><span id="l64.212">         }</span>
<a href="#l64.213"></a><span id="l64.213">       },</span>
<a href="#l64.214"></a><span id="l64.214"> </span>
<a href="#l64.215"></a><span id="l64.215" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.216"></a><span id="l64.216" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.217"></a><span id="l64.217">         self.getOfflineDeletedItems(callbackFunc);</span>
<a href="#l64.218"></a><span id="l64.218">       },</span>
<a href="#l64.219"></a><span id="l64.219">     };</span>
<a href="#l64.220"></a><span id="l64.220">     this.mCachedCalendar.getItems(</span>
<a href="#l64.221"></a><span id="l64.221">       calICalendar.ITEM_FILTER_OFFLINE_MODIFIED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l64.222"></a><span id="l64.222">       0,</span>
<a href="#l64.223"></a><span id="l64.223">       null,</span>
<a href="#l64.224"></a><span id="l64.224">       null,</span>
<a href="#l64.225"></a><span id="l64.225">       getListener</span>
<a href="#l64.226"></a><span id="l64.226">     );</span>
<a href="#l64.227"></a><span id="l64.227">   },</span>
<a href="#l64.228"></a><span id="l64.228"> </span>
<a href="#l64.229"></a><span id="l64.229" class="difflineminus">-  getOfflineDeletedItems: function(callbackFunc) {</span>
<a href="#l64.230"></a><span id="l64.230" class="difflineplus">+  getOfflineDeletedItems(callbackFunc) {</span>
<a href="#l64.231"></a><span id="l64.231">     let self = this;</span>
<a href="#l64.232"></a><span id="l64.232">     let getListener = {</span>
<a href="#l64.233"></a><span id="l64.233">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.234"></a><span id="l64.234" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.235"></a><span id="l64.235" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.236"></a><span id="l64.236">         for (let item of aItems) {</span>
<a href="#l64.237"></a><span id="l64.237">           self.offlineCachedItems[item.hashId] = item;</span>
<a href="#l64.238"></a><span id="l64.238">           self.offlineCachedItemFlags[item.hashId] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l64.239"></a><span id="l64.239">         }</span>
<a href="#l64.240"></a><span id="l64.240">       },</span>
<a href="#l64.241"></a><span id="l64.241"> </span>
<a href="#l64.242"></a><span id="l64.242" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.243"></a><span id="l64.243" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.244"></a><span id="l64.244">         if (callbackFunc) {</span>
<a href="#l64.245"></a><span id="l64.245">           callbackFunc();</span>
<a href="#l64.246"></a><span id="l64.246">         }</span>
<a href="#l64.247"></a><span id="l64.247">       },</span>
<a href="#l64.248"></a><span id="l64.248">     };</span>
<a href="#l64.249"></a><span id="l64.249">     this.mCachedCalendar.getItems(</span>
<a href="#l64.250"></a><span id="l64.250">       calICalendar.ITEM_FILTER_OFFLINE_DELETED | calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l64.251"></a><span id="l64.251">       0,</span>
<a href="#l64.252"></a><span id="l64.252">       null,</span>
<a href="#l64.253"></a><span id="l64.253">       null,</span>
<a href="#l64.254"></a><span id="l64.254">       getListener</span>
<a href="#l64.255"></a><span id="l64.255">     );</span>
<a href="#l64.256"></a><span id="l64.256">   },</span>
<a href="#l64.257"></a><span id="l64.257"> </span>
<a href="#l64.258"></a><span id="l64.258">   mPendingSync: null,</span>
<a href="#l64.259"></a><span id="l64.259">   mSyncQueue: null,</span>
<a href="#l64.260"></a><span id="l64.260" class="difflineminus">-  synchronize: function(respFunc) {</span>
<a href="#l64.261"></a><span id="l64.261" class="difflineplus">+  synchronize(respFunc) {</span>
<a href="#l64.262"></a><span id="l64.262">     let self = this;</span>
<a href="#l64.263"></a><span id="l64.263">     if (this.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l64.264"></a><span id="l64.264">       return emptyQueue(Cr.NS_OK);</span>
<a href="#l64.265"></a><span id="l64.265">     }</span>
<a href="#l64.266"></a><span id="l64.266"> </span>
<a href="#l64.267"></a><span id="l64.267">     this.mSyncQueue.push(respFunc);</span>
<a href="#l64.268"></a><span id="l64.268">     if (this.mSyncQueue.length &gt; 1) {</span>
<a href="#l64.269"></a><span id="l64.269">       // don't use mPendingSync here</span>
<a href="#l64.270"></a><span id="l64.270" class="difflineat">@@ -333,17 +332,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.271"></a><span id="l64.271"> </span>
<a href="#l64.272"></a><span id="l64.272">     if (this.offline) {</span>
<a href="#l64.273"></a><span id="l64.273">       return emptyQueue(Cr.NS_OK);</span>
<a href="#l64.274"></a><span id="l64.274">     }</span>
<a href="#l64.275"></a><span id="l64.275"> </span>
<a href="#l64.276"></a><span id="l64.276">     if (this.supportsChangeLog) {</span>
<a href="#l64.277"></a><span id="l64.277">       cal.LOG(&quot;[calCachedCalendar] Doing changelog based sync for calendar &quot; + this.uri.spec);</span>
<a href="#l64.278"></a><span id="l64.278">       let opListener = {</span>
<a href="#l64.279"></a><span id="l64.279" class="difflineminus">-        onResult: function(operation, result) {</span>
<a href="#l64.280"></a><span id="l64.280" class="difflineplus">+        onResult(operation, result) {</span>
<a href="#l64.281"></a><span id="l64.281">           if (!operation || !operation.isPending) {</span>
<a href="#l64.282"></a><span id="l64.282">             let status = operation ? operation.status : Cr.NS_OK;</span>
<a href="#l64.283"></a><span id="l64.283">             if (!Components.isSuccessCode(status)) {</span>
<a href="#l64.284"></a><span id="l64.284">               cal.ERROR(</span>
<a href="#l64.285"></a><span id="l64.285">                 &quot;[calCachedCalendar] replay action failed: &quot; +</span>
<a href="#l64.286"></a><span id="l64.286">                   (operation ? operation.id : &quot;&lt;unknown&gt;&quot;) +</span>
<a href="#l64.287"></a><span id="l64.287">                   &quot;, uri=&quot; +</span>
<a href="#l64.288"></a><span id="l64.288">                   self.uri.spec +</span>
<a href="#l64.289"></a><span id="l64.289" class="difflineat">@@ -366,17 +365,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.290"></a><span id="l64.290">     let completeListener = {</span>
<a href="#l64.291"></a><span id="l64.291">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l64.292"></a><span id="l64.292">       modifiedTimes: {},</span>
<a href="#l64.293"></a><span id="l64.293">       hasRenewedCalendar: false,</span>
<a href="#l64.294"></a><span id="l64.294">       getsCompleted: 0,</span>
<a href="#l64.295"></a><span id="l64.295">       getsReceived: 0,</span>
<a href="#l64.296"></a><span id="l64.296">       opCompleted: false,</span>
<a href="#l64.297"></a><span id="l64.297"> </span>
<a href="#l64.298"></a><span id="l64.298" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.299"></a><span id="l64.299" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l64.300"></a><span id="l64.300">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l64.301"></a><span id="l64.301">           if (!this.hasRenewedCalendar) {</span>
<a href="#l64.302"></a><span id="l64.302">             // TODO instead of deleting the calendar and creating a new</span>
<a href="#l64.303"></a><span id="l64.303">             // one, maybe we want to do a &quot;real&quot; sync between the</span>
<a href="#l64.304"></a><span id="l64.304">             // existing local calendar and the remote calendar.</span>
<a href="#l64.305"></a><span id="l64.305">             self.setupCachedCalendar();</span>
<a href="#l64.306"></a><span id="l64.306">             this.hasRenewedCalendar = true;</span>
<a href="#l64.307"></a><span id="l64.307">           }</span>
<a href="#l64.308"></a><span id="l64.308" class="difflineat">@@ -397,17 +396,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.309"></a><span id="l64.309">                 completeListener.onOperationComplete(...completeListener.opCompleted);</span>
<a href="#l64.310"></a><span id="l64.310">                 completeListener.opCompleted = false;</span>
<a href="#l64.311"></a><span id="l64.311">               }</span>
<a href="#l64.312"></a><span id="l64.312">             }</span>
<a href="#l64.313"></a><span id="l64.313">           );</span>
<a href="#l64.314"></a><span id="l64.314">         }</span>
<a href="#l64.315"></a><span id="l64.315">       },</span>
<a href="#l64.316"></a><span id="l64.316"> </span>
<a href="#l64.317"></a><span id="l64.317" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.318"></a><span id="l64.318" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l64.319"></a><span id="l64.319">         if (this.getsCompleted &lt; this.getsReceived) {</span>
<a href="#l64.320"></a><span id="l64.320">           // If not all of our gets have been processed, then save the</span>
<a href="#l64.321"></a><span id="l64.321">           // arguments and finish processing later.</span>
<a href="#l64.322"></a><span id="l64.322">           this.opCompleted = Array.from(arguments);</span>
<a href="#l64.323"></a><span id="l64.323">           return;</span>
<a href="#l64.324"></a><span id="l64.324">         }</span>
<a href="#l64.325"></a><span id="l64.325"> </span>
<a href="#l64.326"></a><span id="l64.326">         if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l64.327"></a><span id="l64.327" class="difflineat">@@ -492,27 +491,27 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.328"></a><span id="l64.328">         null,</span>
<a href="#l64.329"></a><span id="l64.329">         null,</span>
<a href="#l64.330"></a><span id="l64.330">         completeListener</span>
<a href="#l64.331"></a><span id="l64.331">       );</span>
<a href="#l64.332"></a><span id="l64.332">     });</span>
<a href="#l64.333"></a><span id="l64.333">     return this.mPendingSync;</span>
<a href="#l64.334"></a><span id="l64.334">   },</span>
<a href="#l64.335"></a><span id="l64.335"> </span>
<a href="#l64.336"></a><span id="l64.336" class="difflineminus">-  onOfflineStatusChanged: function(aNewState) {</span>
<a href="#l64.337"></a><span id="l64.337" class="difflineplus">+  onOfflineStatusChanged(aNewState) {</span>
<a href="#l64.338"></a><span id="l64.338">     if (aNewState) {</span>
<a href="#l64.339"></a><span id="l64.339">       // Going offline: (XXX get items before going offline?) =&gt; we may ask the user to stay online a bit longer</span>
<a href="#l64.340"></a><span id="l64.340">     } else {</span>
<a href="#l64.341"></a><span id="l64.341">       // Going online (start replaying changes to the remote calendar)</span>
<a href="#l64.342"></a><span id="l64.342">       this.refresh();</span>
<a href="#l64.343"></a><span id="l64.343">     }</span>
<a href="#l64.344"></a><span id="l64.344">   },</span>
<a href="#l64.345"></a><span id="l64.345"> </span>
<a href="#l64.346"></a><span id="l64.346">   // aOldItem is already in the cache</span>
<a href="#l64.347"></a><span id="l64.347" class="difflineminus">-  promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l64.348"></a><span id="l64.348" class="difflineplus">+  promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l64.349"></a><span id="l64.349">     let overwrite = cal.provider.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l64.350"></a><span id="l64.350">     if (overwrite) {</span>
<a href="#l64.351"></a><span id="l64.351">       if (aMethod == &quot;modify&quot;) {</span>
<a href="#l64.352"></a><span id="l64.352">         this.modifyOfflineItem(aItem, aOldItem, aListener);</span>
<a href="#l64.353"></a><span id="l64.353">       } else {</span>
<a href="#l64.354"></a><span id="l64.354">         this.deleteOfflineItem(aItem, aListener);</span>
<a href="#l64.355"></a><span id="l64.355">       }</span>
<a href="#l64.356"></a><span id="l64.356">     }</span>
<a href="#l64.357"></a><span id="l64.357" class="difflineat">@@ -523,17 +522,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.358"></a><span id="l64.358">    *</span>
<a href="#l64.359"></a><span id="l64.359">    * @param aCallback         (optional) The function to be called when playback is complete.</span>
<a href="#l64.360"></a><span id="l64.360">    * @param aPlaybackType     (optional) The starting operation type. This function will be</span>
<a href="#l64.361"></a><span id="l64.361">    *                          called recursively through playback operations in the order of</span>
<a href="#l64.362"></a><span id="l64.362">    *                          add, modify, delete. By default playback will start with the add</span>
<a href="#l64.363"></a><span id="l64.363">    *                          operation. Valid values for this parameter are defined as</span>
<a href="#l64.364"></a><span id="l64.364">    *                          OFFLINE_FLAG_XXX constants in the calIChangeLog interface.</span>
<a href="#l64.365"></a><span id="l64.365">    */</span>
<a href="#l64.366"></a><span id="l64.366" class="difflineminus">-  playbackOfflineItems: function(aCallback, aPlaybackType) {</span>
<a href="#l64.367"></a><span id="l64.367" class="difflineplus">+  playbackOfflineItems(aCallback, aPlaybackType) {</span>
<a href="#l64.368"></a><span id="l64.368">     let self = this;</span>
<a href="#l64.369"></a><span id="l64.369">     let storage = this.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.370"></a><span id="l64.370"> </span>
<a href="#l64.371"></a><span id="l64.371">     let resetListener = gNoOpListener;</span>
<a href="#l64.372"></a><span id="l64.372">     let itemQueue = [];</span>
<a href="#l64.373"></a><span id="l64.373">     let debugOp;</span>
<a href="#l64.374"></a><span id="l64.374">     let nextCallback;</span>
<a href="#l64.375"></a><span id="l64.375">     let uncachedOp;</span>
<a href="#l64.376"></a><span id="l64.376" class="difflineat">@@ -574,18 +573,18 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.377"></a><span id="l64.377">         filter = calICalendar.ITEM_FILTER_OFFLINE_DELETED;</span>
<a href="#l64.378"></a><span id="l64.378">         break;</span>
<a href="#l64.379"></a><span id="l64.379">       default:</span>
<a href="#l64.380"></a><span id="l64.380">         cal.ERROR(&quot;[calCachedCalendar] Invalid playback type: &quot; + aPlaybackType);</span>
<a href="#l64.381"></a><span id="l64.381">         return;</span>
<a href="#l64.382"></a><span id="l64.382">     }</span>
<a href="#l64.383"></a><span id="l64.383"> </span>
<a href="#l64.384"></a><span id="l64.384">     let opListener = {</span>
<a href="#l64.385"></a><span id="l64.385" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.386"></a><span id="l64.386" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.387"></a><span id="l64.387" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.388"></a><span id="l64.388" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.389"></a><span id="l64.389">         if (Components.isSuccessCode(status)) {</span>
<a href="#l64.390"></a><span id="l64.390">           if (aPlaybackType == cICL.OFFLINE_FLAG_DELETED_RECORD) {</span>
<a href="#l64.391"></a><span id="l64.391">             self.mCachedCalendar.deleteItem(detail, resetListener);</span>
<a href="#l64.392"></a><span id="l64.392">           } else {</span>
<a href="#l64.393"></a><span id="l64.393">             storage.resetItemOfflineFlag(detail, resetListener);</span>
<a href="#l64.394"></a><span id="l64.394">           }</span>
<a href="#l64.395"></a><span id="l64.395">         } else {</span>
<a href="#l64.396"></a><span id="l64.396">           // If the playback action could not be performed, then there</span>
<a href="#l64.397"></a><span id="l64.397" class="difflineat">@@ -628,20 +627,20 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.398"></a><span id="l64.398">               e</span>
<a href="#l64.399"></a><span id="l64.399">           );</span>
<a href="#l64.400"></a><span id="l64.400">           opListener.onOperationComplete(self, e.result, listenerOp, item.id, e.message);</span>
<a href="#l64.401"></a><span id="l64.401">         }</span>
<a href="#l64.402"></a><span id="l64.402">       }</span>
<a href="#l64.403"></a><span id="l64.403">     }</span>
<a href="#l64.404"></a><span id="l64.404"> </span>
<a href="#l64.405"></a><span id="l64.405">     let getListener = {</span>
<a href="#l64.406"></a><span id="l64.406" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {</span>
<a href="#l64.407"></a><span id="l64.407" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {</span>
<a href="#l64.408"></a><span id="l64.408">         itemQueue = itemQueue.concat(items);</span>
<a href="#l64.409"></a><span id="l64.409">       },</span>
<a href="#l64.410"></a><span id="l64.410" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.411"></a><span id="l64.411" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.412"></a><span id="l64.412">         if (self.offline) {</span>
<a href="#l64.413"></a><span id="l64.413">           cal.LOG(&quot;[calCachedCalendar] back to offline mode, reconciliation aborted&quot;);</span>
<a href="#l64.414"></a><span id="l64.414">           if (aCallback) {</span>
<a href="#l64.415"></a><span id="l64.415">             aCallback();</span>
<a href="#l64.416"></a><span id="l64.416">           }</span>
<a href="#l64.417"></a><span id="l64.417">         } else {</span>
<a href="#l64.418"></a><span id="l64.418">           cal.LOG(</span>
<a href="#l64.419"></a><span id="l64.419">             &quot;[calCachedCalendar] Performing playback operation &quot; +</span>
<a href="#l64.420"></a><span id="l64.420" class="difflineat">@@ -681,75 +680,74 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.421"></a><span id="l64.421">     return cal.wrapInstance(this.mUncachedCalendar, Ci.calIChangeLog) != null;</span>
<a href="#l64.422"></a><span id="l64.422">   },</span>
<a href="#l64.423"></a><span id="l64.423"> </span>
<a href="#l64.424"></a><span id="l64.424">   get canRefresh() {</span>
<a href="#l64.425"></a><span id="l64.425">     // enable triggering sync using the reload button</span>
<a href="#l64.426"></a><span id="l64.426">     return true;</span>
<a href="#l64.427"></a><span id="l64.427">   },</span>
<a href="#l64.428"></a><span id="l64.428"> </span>
<a href="#l64.429"></a><span id="l64.429" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l64.430"></a><span id="l64.430" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l64.431"></a><span id="l64.431">     switch (aName) {</span>
<a href="#l64.432"></a><span id="l64.432">       case &quot;cache.enabled&quot;:</span>
<a href="#l64.433"></a><span id="l64.433">         if (this.mUncachedCalendar.getProperty(&quot;cache.always&quot;)) {</span>
<a href="#l64.434"></a><span id="l64.434">           return true;</span>
<a href="#l64.435"></a><span id="l64.435">         }</span>
<a href="#l64.436"></a><span id="l64.436">         break;</span>
<a href="#l64.437"></a><span id="l64.437">     }</span>
<a href="#l64.438"></a><span id="l64.438"> </span>
<a href="#l64.439"></a><span id="l64.439">     return this.mUncachedCalendar.getProperty(aName);</span>
<a href="#l64.440"></a><span id="l64.440">   },</span>
<a href="#l64.441"></a><span id="l64.441" class="difflineminus">-  refresh: function() {</span>
<a href="#l64.442"></a><span id="l64.442" class="difflineplus">+  refresh() {</span>
<a href="#l64.443"></a><span id="l64.443">     if (this.offline) {</span>
<a href="#l64.444"></a><span id="l64.444">       this.downstreamRefresh();</span>
<a href="#l64.445"></a><span id="l64.445">     } else if (this.supportsChangeLog) {</span>
<a href="#l64.446"></a><span id="l64.446">       /* we first ensure that any remaining offline items are reconciled with the calendar server */</span>
<a href="#l64.447"></a><span id="l64.447">       this.playbackOfflineItems(this.downstreamRefresh.bind(this));</span>
<a href="#l64.448"></a><span id="l64.448">     } else {</span>
<a href="#l64.449"></a><span id="l64.449">       this.downstreamRefresh();</span>
<a href="#l64.450"></a><span id="l64.450">     }</span>
<a href="#l64.451"></a><span id="l64.451">   },</span>
<a href="#l64.452"></a><span id="l64.452" class="difflineminus">-  downstreamRefresh: function() {</span>
<a href="#l64.453"></a><span id="l64.453" class="difflineplus">+  downstreamRefresh() {</span>
<a href="#l64.454"></a><span id="l64.454">     if (this.mUncachedCalendar.canRefresh &amp;&amp; !this.offline) {</span>
<a href="#l64.455"></a><span id="l64.455">       return this.mUncachedCalendar.refresh(); // will trigger synchronize once the calendar is loaded</span>
<a href="#l64.456"></a><span id="l64.456" class="difflineminus">-    } else {</span>
<a href="#l64.457"></a><span id="l64.457" class="difflineminus">-      return this.synchronize(status =&gt; {</span>
<a href="#l64.458"></a><span id="l64.458" class="difflineminus">-        // fire completing onLoad for this refresh call</span>
<a href="#l64.459"></a><span id="l64.459" class="difflineminus">-        this.mCachedObserver.onLoad(this.mCachedCalendar);</span>
<a href="#l64.460"></a><span id="l64.460" class="difflineminus">-      });</span>
<a href="#l64.461"></a><span id="l64.461">     }</span>
<a href="#l64.462"></a><span id="l64.462" class="difflineplus">+    return this.synchronize(status =&gt; {</span>
<a href="#l64.463"></a><span id="l64.463" class="difflineplus">+      // fire completing onLoad for this refresh call</span>
<a href="#l64.464"></a><span id="l64.464" class="difflineplus">+      this.mCachedObserver.onLoad(this.mCachedCalendar);</span>
<a href="#l64.465"></a><span id="l64.465" class="difflineplus">+    });</span>
<a href="#l64.466"></a><span id="l64.466">   },</span>
<a href="#l64.467"></a><span id="l64.467"> </span>
<a href="#l64.468"></a><span id="l64.468" class="difflineminus">-  addObserver: function(aObserver) {</span>
<a href="#l64.469"></a><span id="l64.469" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l64.470"></a><span id="l64.470">     this.mObservers.add(aObserver);</span>
<a href="#l64.471"></a><span id="l64.471">   },</span>
<a href="#l64.472"></a><span id="l64.472" class="difflineminus">-  removeObserver: function(aObserver) {</span>
<a href="#l64.473"></a><span id="l64.473" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l64.474"></a><span id="l64.474">     this.mObservers.delete(aObserver);</span>
<a href="#l64.475"></a><span id="l64.475">   },</span>
<a href="#l64.476"></a><span id="l64.476"> </span>
<a href="#l64.477"></a><span id="l64.477" class="difflineminus">-  addItem: function(item, listener) {</span>
<a href="#l64.478"></a><span id="l64.478" class="difflineplus">+  addItem(item, listener) {</span>
<a href="#l64.479"></a><span id="l64.479">     return this.adoptItem(item.clone(), listener);</span>
<a href="#l64.480"></a><span id="l64.480">   },</span>
<a href="#l64.481"></a><span id="l64.481" class="difflineminus">-  adoptItem: function(item, listener) {</span>
<a href="#l64.482"></a><span id="l64.482" class="difflineplus">+  adoptItem(item, listener) {</span>
<a href="#l64.483"></a><span id="l64.483">     // Forwarding add/modify/delete to the cached calendar using the calIObserver</span>
<a href="#l64.484"></a><span id="l64.484">     // callbacks would be advantageous, because the uncached provider could implement</span>
<a href="#l64.485"></a><span id="l64.485">     // a true push mechanism firing without being triggered from within the program.</span>
<a href="#l64.486"></a><span id="l64.486">     // But this would mean the uncached provider fires on the passed</span>
<a href="#l64.487"></a><span id="l64.487">     // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l64.488"></a><span id="l64.488">     // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l64.489"></a><span id="l64.489">     // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l64.490"></a><span id="l64.490">     // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l64.491"></a><span id="l64.491">     // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l64.492"></a><span id="l64.492">     // has performed the modification, see below:</span>
<a href="#l64.493"></a><span id="l64.493">     let self = this;</span>
<a href="#l64.494"></a><span id="l64.494">     let cacheListener = {</span>
<a href="#l64.495"></a><span id="l64.495" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {</span>
<a href="#l64.496"></a><span id="l64.496" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {</span>
<a href="#l64.497"></a><span id="l64.497">         cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l64.498"></a><span id="l64.498">       },</span>
<a href="#l64.499"></a><span id="l64.499" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.500"></a><span id="l64.500" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.501"></a><span id="l64.501">         if (isUnavailableCode(status)) {</span>
<a href="#l64.502"></a><span id="l64.502">           // The item couldn't be added to the (remote) location,</span>
<a href="#l64.503"></a><span id="l64.503">           // this is like being offline. Add the item to the cached</span>
<a href="#l64.504"></a><span id="l64.504">           // calendar instead.</span>
<a href="#l64.505"></a><span id="l64.505">           cal.LOG(</span>
<a href="#l64.506"></a><span id="l64.506">             &quot;[calCachedCalendar] Calendar &quot; + calendar.name + &quot; is unavailable, adding item offline&quot;</span>
<a href="#l64.507"></a><span id="l64.507">           );</span>
<a href="#l64.508"></a><span id="l64.508">           self.adoptOfflineItem(item, listener);</span>
<a href="#l64.509"></a><span id="l64.509" class="difflineat">@@ -767,42 +765,42 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.510"></a><span id="l64.510">     if (this.offline) {</span>
<a href="#l64.511"></a><span id="l64.511">       // If we are offline, don't even try to add the item</span>
<a href="#l64.512"></a><span id="l64.512">       this.adoptOfflineItem(item, listener);</span>
<a href="#l64.513"></a><span id="l64.513">     } else {</span>
<a href="#l64.514"></a><span id="l64.514">       // Otherwise ask the provider to add the item now.</span>
<a href="#l64.515"></a><span id="l64.515">       this.mUncachedCalendar.adoptItem(item, cacheListener);</span>
<a href="#l64.516"></a><span id="l64.516">     }</span>
<a href="#l64.517"></a><span id="l64.517">   },</span>
<a href="#l64.518"></a><span id="l64.518" class="difflineminus">-  adoptOfflineItem: function(item, listener) {</span>
<a href="#l64.519"></a><span id="l64.519" class="difflineplus">+  adoptOfflineItem(item, listener) {</span>
<a href="#l64.520"></a><span id="l64.520">     let self = this;</span>
<a href="#l64.521"></a><span id="l64.521">     let opListener = {</span>
<a href="#l64.522"></a><span id="l64.522" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {</span>
<a href="#l64.523"></a><span id="l64.523" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {</span>
<a href="#l64.524"></a><span id="l64.524">         cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l64.525"></a><span id="l64.525">       },</span>
<a href="#l64.526"></a><span id="l64.526" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.527"></a><span id="l64.527" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.528"></a><span id="l64.528">         if (Components.isSuccessCode(status)) {</span>
<a href="#l64.529"></a><span id="l64.529">           let storage = self.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.530"></a><span id="l64.530">           storage.addOfflineItem(detail, listener);</span>
<a href="#l64.531"></a><span id="l64.531">         } else if (listener) {</span>
<a href="#l64.532"></a><span id="l64.532">           listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l64.533"></a><span id="l64.533">         }</span>
<a href="#l64.534"></a><span id="l64.534">       },</span>
<a href="#l64.535"></a><span id="l64.535">     };</span>
<a href="#l64.536"></a><span id="l64.536">     this.mCachedCalendar.adoptItem(item, opListener);</span>
<a href="#l64.537"></a><span id="l64.537">   },</span>
<a href="#l64.538"></a><span id="l64.538"> </span>
<a href="#l64.539"></a><span id="l64.539" class="difflineminus">-  modifyItem: function(newItem, oldItem, listener) {</span>
<a href="#l64.540"></a><span id="l64.540" class="difflineplus">+  modifyItem(newItem, oldItem, listener) {</span>
<a href="#l64.541"></a><span id="l64.541">     let self = this;</span>
<a href="#l64.542"></a><span id="l64.542"> </span>
<a href="#l64.543"></a><span id="l64.543">     // First of all, we should find out if the item to modify is</span>
<a href="#l64.544"></a><span id="l64.544">     // already an offline item or not.</span>
<a href="#l64.545"></a><span id="l64.545">     let flagListener = {</span>
<a href="#l64.546"></a><span id="l64.546" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.547"></a><span id="l64.547" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, offline_flag) {</span>
<a href="#l64.548"></a><span id="l64.548" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.549"></a><span id="l64.549" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, offline_flag) {</span>
<a href="#l64.550"></a><span id="l64.550">         if (</span>
<a href="#l64.551"></a><span id="l64.551">           offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l64.552"></a><span id="l64.552">           offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD</span>
<a href="#l64.553"></a><span id="l64.553">         ) {</span>
<a href="#l64.554"></a><span id="l64.554">           // The item is already offline, just modify it in the cache</span>
<a href="#l64.555"></a><span id="l64.555">           self.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l64.556"></a><span id="l64.556">         } else {</span>
<a href="#l64.557"></a><span id="l64.557">           // Not an offline item, attempt to modify using provider</span>
<a href="#l64.558"></a><span id="l64.558" class="difflineat">@@ -817,18 +815,18 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.559"></a><span id="l64.559">      * But this would mean the uncached provider fires on the passed</span>
<a href="#l64.560"></a><span id="l64.560">      * calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l64.561"></a><span id="l64.561">      * (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l64.562"></a><span id="l64.562">      * would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l64.563"></a><span id="l64.563">      * hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l64.564"></a><span id="l64.564">      * Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l64.565"></a><span id="l64.565">      * has performed the modification, see below: */</span>
<a href="#l64.566"></a><span id="l64.566">     let cacheListener = {</span>
<a href="#l64.567"></a><span id="l64.567" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.568"></a><span id="l64.568" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.569"></a><span id="l64.569" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.570"></a><span id="l64.570" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.571"></a><span id="l64.571">         if (isUnavailableCode(status)) {</span>
<a href="#l64.572"></a><span id="l64.572">           // The item couldn't be modified at the (remote) location,</span>
<a href="#l64.573"></a><span id="l64.573">           // this is like being offline. Add the item to the cache</span>
<a href="#l64.574"></a><span id="l64.574">           // instead.</span>
<a href="#l64.575"></a><span id="l64.575">           cal.LOG(</span>
<a href="#l64.576"></a><span id="l64.576">             &quot;[calCachedCalendar] Calendar &quot; +</span>
<a href="#l64.577"></a><span id="l64.577">               calendar.name +</span>
<a href="#l64.578"></a><span id="l64.578">               &quot; is unavailable, modifying item offline&quot;</span>
<a href="#l64.579"></a><span id="l64.579" class="difflineat">@@ -849,47 +847,47 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.580"></a><span id="l64.580">       this.modifyOfflineItem(newItem, oldItem, listener);</span>
<a href="#l64.581"></a><span id="l64.581">     } else {</span>
<a href="#l64.582"></a><span id="l64.582">       // Otherwise, get the item flags, the listener will further</span>
<a href="#l64.583"></a><span id="l64.583">       // process the item.</span>
<a href="#l64.584"></a><span id="l64.584">       this.mCachedCalendar.getItemOfflineFlag(oldItem, flagListener);</span>
<a href="#l64.585"></a><span id="l64.585">     }</span>
<a href="#l64.586"></a><span id="l64.586">   },</span>
<a href="#l64.587"></a><span id="l64.587"> </span>
<a href="#l64.588"></a><span id="l64.588" class="difflineminus">-  modifyOfflineItem: function(newItem, oldItem, listener) {</span>
<a href="#l64.589"></a><span id="l64.589" class="difflineplus">+  modifyOfflineItem(newItem, oldItem, listener) {</span>
<a href="#l64.590"></a><span id="l64.590">     let self = this;</span>
<a href="#l64.591"></a><span id="l64.591">     let opListener = {</span>
<a href="#l64.592"></a><span id="l64.592" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {</span>
<a href="#l64.593"></a><span id="l64.593" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {</span>
<a href="#l64.594"></a><span id="l64.594">         cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l64.595"></a><span id="l64.595">       },</span>
<a href="#l64.596"></a><span id="l64.596" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.597"></a><span id="l64.597" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.598"></a><span id="l64.598">         if (Components.isSuccessCode(status)) {</span>
<a href="#l64.599"></a><span id="l64.599">           // Modify the offline item in the storage, passing the</span>
<a href="#l64.600"></a><span id="l64.600">           // listener will make sure its notified</span>
<a href="#l64.601"></a><span id="l64.601">           let storage = self.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.602"></a><span id="l64.602">           storage.modifyOfflineItem(detail, listener);</span>
<a href="#l64.603"></a><span id="l64.603">         } else if (listener) {</span>
<a href="#l64.604"></a><span id="l64.604">           // If there was not a success, then we need to notify the</span>
<a href="#l64.605"></a><span id="l64.605">           // listener ourselves</span>
<a href="#l64.606"></a><span id="l64.606">           listener.onOperationComplete(self, status, opType, id, detail);</span>
<a href="#l64.607"></a><span id="l64.607">         }</span>
<a href="#l64.608"></a><span id="l64.608">       },</span>
<a href="#l64.609"></a><span id="l64.609">     };</span>
<a href="#l64.610"></a><span id="l64.610"> </span>
<a href="#l64.611"></a><span id="l64.611">     this.mCachedCalendar.modifyItem(newItem, oldItem, opListener);</span>
<a href="#l64.612"></a><span id="l64.612">   },</span>
<a href="#l64.613"></a><span id="l64.613"> </span>
<a href="#l64.614"></a><span id="l64.614" class="difflineminus">-  deleteItem: function(item, listener) {</span>
<a href="#l64.615"></a><span id="l64.615" class="difflineplus">+  deleteItem(item, listener) {</span>
<a href="#l64.616"></a><span id="l64.616">     let self = this;</span>
<a href="#l64.617"></a><span id="l64.617"> </span>
<a href="#l64.618"></a><span id="l64.618">     // First of all, we should find out if the item to delete is</span>
<a href="#l64.619"></a><span id="l64.619">     // already an offline item or not.</span>
<a href="#l64.620"></a><span id="l64.620">     let flagListener = {</span>
<a href="#l64.621"></a><span id="l64.621" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.622"></a><span id="l64.622" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, offline_flag) {</span>
<a href="#l64.623"></a><span id="l64.623" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.624"></a><span id="l64.624" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, offline_flag) {</span>
<a href="#l64.625"></a><span id="l64.625">         if (</span>
<a href="#l64.626"></a><span id="l64.626">           offline_flag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l64.627"></a><span id="l64.627">           offline_flag == cICL.OFFLINE_FLAG_MODIFIED_RECORD</span>
<a href="#l64.628"></a><span id="l64.628">         ) {</span>
<a href="#l64.629"></a><span id="l64.629">           // The item is already offline, just mark it deleted it in</span>
<a href="#l64.630"></a><span id="l64.630">           // the cache</span>
<a href="#l64.631"></a><span id="l64.631">           self.deleteOfflineItem(item, listener);</span>
<a href="#l64.632"></a><span id="l64.632">         } else {</span>
<a href="#l64.633"></a><span id="l64.633" class="difflineat">@@ -904,18 +902,18 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.634"></a><span id="l64.634">     // But this would mean the uncached provider fires on the passed</span>
<a href="#l64.635"></a><span id="l64.635">     // calIOperationListener, e.g. *before* it fires on calIObservers</span>
<a href="#l64.636"></a><span id="l64.636">     // (because that order is undefined). Firing onOperationComplete before onAddItem et al</span>
<a href="#l64.637"></a><span id="l64.637">     // would result in this facade firing onOperationComplete even though the modification</span>
<a href="#l64.638"></a><span id="l64.638">     // hasn't yet been performed on the cached calendar (which happens in onAddItem et al).</span>
<a href="#l64.639"></a><span id="l64.639">     // Result is that we currently stick to firing onOperationComplete if the cached calendar</span>
<a href="#l64.640"></a><span id="l64.640">     // has performed the modification, see below:</span>
<a href="#l64.641"></a><span id="l64.641">     let cacheListener = {</span>
<a href="#l64.642"></a><span id="l64.642" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.643"></a><span id="l64.643" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, detail) {</span>
<a href="#l64.644"></a><span id="l64.644" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l64.645"></a><span id="l64.645" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, detail) {</span>
<a href="#l64.646"></a><span id="l64.646">         if (isUnavailableCode(status)) {</span>
<a href="#l64.647"></a><span id="l64.647">           // The item couldn't be deleted at the (remote) location,</span>
<a href="#l64.648"></a><span id="l64.648">           // this is like being offline. Mark the item deleted in the</span>
<a href="#l64.649"></a><span id="l64.649">           // cache instead.</span>
<a href="#l64.650"></a><span id="l64.650">           cal.LOG(</span>
<a href="#l64.651"></a><span id="l64.651">             &quot;[calCachedCalendar] Calendar &quot; +</span>
<a href="#l64.652"></a><span id="l64.652">               calendar.name +</span>
<a href="#l64.653"></a><span id="l64.653">               &quot; is unavailable, deleting item offline&quot;</span>
<a href="#l64.654"></a><span id="l64.654" class="difflineat">@@ -943,17 +941,17 @@ calCachedCalendar.prototype = {</span>
<a href="#l64.655"></a><span id="l64.655">       // If we are offline, don't even try to delete the item</span>
<a href="#l64.656"></a><span id="l64.656">       this.deleteOfflineItem(item, listener);</span>
<a href="#l64.657"></a><span id="l64.657">     } else {</span>
<a href="#l64.658"></a><span id="l64.658">       // Otherwise, get the item flags, the listener will further</span>
<a href="#l64.659"></a><span id="l64.659">       // process the item.</span>
<a href="#l64.660"></a><span id="l64.660">       this.mCachedCalendar.getItemOfflineFlag(item, flagListener);</span>
<a href="#l64.661"></a><span id="l64.661">     }</span>
<a href="#l64.662"></a><span id="l64.662">   },</span>
<a href="#l64.663"></a><span id="l64.663" class="difflineminus">-  deleteOfflineItem: function(item, listener) {</span>
<a href="#l64.664"></a><span id="l64.664" class="difflineplus">+  deleteOfflineItem(item, listener) {</span>
<a href="#l64.665"></a><span id="l64.665">     /* We do not delete the item from the cache, as we will need it when reconciling the cache content and the server content. */</span>
<a href="#l64.666"></a><span id="l64.666">     let storage = this.mCachedCalendar.QueryInterface(Ci.calIOfflineStorage);</span>
<a href="#l64.667"></a><span id="l64.667">     storage.deleteOfflineItem(item, listener);</span>
<a href="#l64.668"></a><span id="l64.668">   },</span>
<a href="#l64.669"></a><span id="l64.669"> };</span>
<a href="#l64.670"></a><span id="l64.670"> (function() {</span>
<a href="#l64.671"></a><span id="l64.671">   function defineForwards(proto, targetName, functions, getters, gettersAndSetters) {</span>
<a href="#l64.672"></a><span id="l64.672">     function defineForwardGetter(attr) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/calendar/base/src/calCalendarManager.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/calendar/base/src/calCalendarManager.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -38,17 +38,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.4"></a><span id="l65.4">   get readOnlyCalendarCount() {</span>
<a href="#l65.5"></a><span id="l65.5">     return this.mReadonlyCalendarCount;</span>
<a href="#l65.6"></a><span id="l65.6">   },</span>
<a href="#l65.7"></a><span id="l65.7">   get calendarCount() {</span>
<a href="#l65.8"></a><span id="l65.8">     return this.mCalendarCount;</span>
<a href="#l65.9"></a><span id="l65.9">   },</span>
<a href="#l65.10"></a><span id="l65.10"> </span>
<a href="#l65.11"></a><span id="l65.11">   // calIStartupService:</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-  startup: function(aCompleteListener) {</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+  startup(aCompleteListener) {</span>
<a href="#l65.14"></a><span id="l65.14">     AddonManager.addAddonListener(gCalendarManagerAddonListener);</span>
<a href="#l65.15"></a><span id="l65.15">     this.mCache = null;</span>
<a href="#l65.16"></a><span id="l65.16">     this.mCalObservers = null;</span>
<a href="#l65.17"></a><span id="l65.17">     this.mRefreshTimer = {};</span>
<a href="#l65.18"></a><span id="l65.18">     this.setupOfflineObservers();</span>
<a href="#l65.19"></a><span id="l65.19">     this.mNetworkCalendarCount = 0;</span>
<a href="#l65.20"></a><span id="l65.20">     this.mReadonlyCalendarCount = 0;</span>
<a href="#l65.21"></a><span id="l65.21">     this.mCalendarCount = 0;</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -59,17 +59,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.23"></a><span id="l65.23">     // pref on startup to avoid checking for every http request</span>
<a href="#l65.24"></a><span id="l65.24">     if (Services.prefs.getBoolPref(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l65.25"></a><span id="l65.25">       Services.obs.addObserver(this, &quot;http-on-examine-response&quot;);</span>
<a href="#l65.26"></a><span id="l65.26">     }</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28">     aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l65.29"></a><span id="l65.29">   },</span>
<a href="#l65.30"></a><span id="l65.30"> </span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-  shutdown: function(aCompleteListener) {</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineplus">+  shutdown(aCompleteListener) {</span>
<a href="#l65.33"></a><span id="l65.33">     for (let id in this.mCache) {</span>
<a href="#l65.34"></a><span id="l65.34">       let calendar = this.mCache[id];</span>
<a href="#l65.35"></a><span id="l65.35">       calendar.removeObserver(this.mCalObservers[calendar.id]);</span>
<a href="#l65.36"></a><span id="l65.36">     }</span>
<a href="#l65.37"></a><span id="l65.37"> </span>
<a href="#l65.38"></a><span id="l65.38">     this.cleanupOfflineObservers();</span>
<a href="#l65.39"></a><span id="l65.39"> </span>
<a href="#l65.40"></a><span id="l65.40">     Services.obs.removeObserver(this, &quot;http-on-modify-request&quot;);</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineat">@@ -81,25 +81,25 @@ calCalendarManager.prototype = {</span>
<a href="#l65.42"></a><span id="l65.42">     // afterwards.</span>
<a href="#l65.43"></a><span id="l65.43">     if (Services.prefs.getBoolPref(&quot;calendar.network.multirealm&quot;, false)) {</span>
<a href="#l65.44"></a><span id="l65.44">       Services.obs.removeObserver(this, &quot;http-on-examine-response&quot;);</span>
<a href="#l65.45"></a><span id="l65.45">     }</span>
<a href="#l65.46"></a><span id="l65.46"> </span>
<a href="#l65.47"></a><span id="l65.47">     aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l65.48"></a><span id="l65.48">   },</span>
<a href="#l65.49"></a><span id="l65.49"> </span>
<a href="#l65.50"></a><span id="l65.50" class="difflineminus">-  setupOfflineObservers: function() {</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineplus">+  setupOfflineObservers() {</span>
<a href="#l65.52"></a><span id="l65.52">     Services.obs.addObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l65.53"></a><span id="l65.53">   },</span>
<a href="#l65.54"></a><span id="l65.54"> </span>
<a href="#l65.55"></a><span id="l65.55" class="difflineminus">-  cleanupOfflineObservers: function() {</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineplus">+  cleanupOfflineObservers() {</span>
<a href="#l65.57"></a><span id="l65.57">     Services.obs.removeObserver(this, &quot;network:offline-status-changed&quot;);</span>
<a href="#l65.58"></a><span id="l65.58">   },</span>
<a href="#l65.59"></a><span id="l65.59"> </span>
<a href="#l65.60"></a><span id="l65.60" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l65.62"></a><span id="l65.62">     switch (aTopic) {</span>
<a href="#l65.63"></a><span id="l65.63">       case &quot;timer-callback&quot;: {</span>
<a href="#l65.64"></a><span id="l65.64">         // Refresh all the calendars that can be refreshed.</span>
<a href="#l65.65"></a><span id="l65.65">         for (let calendar of this.getCalendars()) {</span>
<a href="#l65.66"></a><span id="l65.66">           if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l65.67"></a><span id="l65.67">             calendar.refresh();</span>
<a href="#l65.68"></a><span id="l65.68">           }</span>
<a href="#l65.69"></a><span id="l65.69">         }</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineat">@@ -168,17 +168,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.71"></a><span id="l65.71">           // We swallow this error since it means the User Agent</span>
<a href="#l65.72"></a><span id="l65.72">           // header is not set. We don't want to force it to be set.</span>
<a href="#l65.73"></a><span id="l65.73">         }</span>
<a href="#l65.74"></a><span id="l65.74">         break;</span>
<a href="#l65.75"></a><span id="l65.75">       }</span>
<a href="#l65.76"></a><span id="l65.76">     }</span>
<a href="#l65.77"></a><span id="l65.77">   },</span>
<a href="#l65.78"></a><span id="l65.78"> </span>
<a href="#l65.79"></a><span id="l65.79" class="difflineminus">-  alertAndQuit: function() {</span>
<a href="#l65.80"></a><span id="l65.80" class="difflineplus">+  alertAndQuit() {</span>
<a href="#l65.81"></a><span id="l65.81">     // We want to include the extension name in the error message rather</span>
<a href="#l65.82"></a><span id="l65.82">     // than blaming Thunderbird.</span>
<a href="#l65.83"></a><span id="l65.83">     let hostAppName = cal.l10n.getAnyString(&quot;branding&quot;, &quot;brand&quot;, &quot;brandShortName&quot;);</span>
<a href="#l65.84"></a><span id="l65.84">     let calAppName = cal.l10n.getLtnString(&quot;brandShortName&quot;);</span>
<a href="#l65.85"></a><span id="l65.85">     let errorBoxTitle = cal.l10n.getCalString(&quot;tooNewSchemaErrorBoxTitle&quot;, [calAppName]);</span>
<a href="#l65.86"></a><span id="l65.86">     let errorBoxText = cal.l10n.getCalString(&quot;tooNewSchemaErrorBoxTextLightning&quot;, [</span>
<a href="#l65.87"></a><span id="l65.87">       calAppName,</span>
<a href="#l65.88"></a><span id="l65.88">       hostAppName,</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineat">@@ -207,17 +207,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.90"></a><span id="l65.90">       aAddon.userDisabled = true;</span>
<a href="#l65.91"></a><span id="l65.91">       Services.startup.quit(Ci.nsIAppStartup.eRestart | Ci.nsIAppStartup.eForceQuit);</span>
<a href="#l65.92"></a><span id="l65.92">     });</span>
<a href="#l65.93"></a><span id="l65.93">   },</span>
<a href="#l65.94"></a><span id="l65.94"> </span>
<a href="#l65.95"></a><span id="l65.95">   /**</span>
<a href="#l65.96"></a><span id="l65.96">    * calICalendarManager interface</span>
<a href="#l65.97"></a><span id="l65.97">    */</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineminus">-  createCalendar: function(type, uri) {</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineplus">+  createCalendar(type, uri) {</span>
<a href="#l65.100"></a><span id="l65.100">     try {</span>
<a href="#l65.101"></a><span id="l65.101">       if (!Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type]) {</span>
<a href="#l65.102"></a><span id="l65.102">         // Don't notify the user with an extra dialog if the provider</span>
<a href="#l65.103"></a><span id="l65.103">         // interface is missing.</span>
<a href="#l65.104"></a><span id="l65.104">         return null;</span>
<a href="#l65.105"></a><span id="l65.105">       }</span>
<a href="#l65.106"></a><span id="l65.106">       let calendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=&quot; + type].createInstance(</span>
<a href="#l65.107"></a><span id="l65.107">         Ci.calICalendar</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineat">@@ -257,17 +257,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.109"></a><span id="l65.109">         &quot;_blank&quot;,</span>
<a href="#l65.110"></a><span id="l65.110">         &quot;chrome,dialog=yes,alwaysRaised=yes&quot;,</span>
<a href="#l65.111"></a><span id="l65.111">         paramBlock</span>
<a href="#l65.112"></a><span id="l65.112">       );</span>
<a href="#l65.113"></a><span id="l65.113">       return null;</span>
<a href="#l65.114"></a><span id="l65.114">     }</span>
<a href="#l65.115"></a><span id="l65.115">   },</span>
<a href="#l65.116"></a><span id="l65.116"> </span>
<a href="#l65.117"></a><span id="l65.117" class="difflineminus">-  registerCalendar: function(calendar) {</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineplus">+  registerCalendar(calendar) {</span>
<a href="#l65.119"></a><span id="l65.119">     this.assureCache();</span>
<a href="#l65.120"></a><span id="l65.120"> </span>
<a href="#l65.121"></a><span id="l65.121">     // If the calendar is already registered, bail out</span>
<a href="#l65.122"></a><span id="l65.122">     cal.ASSERT(</span>
<a href="#l65.123"></a><span id="l65.123">       !calendar.id || !(calendar.id in this.mCache),</span>
<a href="#l65.124"></a><span id="l65.124">       &quot;[calCalendarManager::registerCalendar] calendar already registered!&quot;,</span>
<a href="#l65.125"></a><span id="l65.125">       true</span>
<a href="#l65.126"></a><span id="l65.126">     );</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineat">@@ -291,17 +291,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.128"></a><span id="l65.128"> </span>
<a href="#l65.129"></a><span id="l65.129">     if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l65.130"></a><span id="l65.130">       calendar.refresh();</span>
<a href="#l65.131"></a><span id="l65.131">     }</span>
<a href="#l65.132"></a><span id="l65.132"> </span>
<a href="#l65.133"></a><span id="l65.133">     this.notifyObservers(&quot;onCalendarRegistered&quot;, [calendar]);</span>
<a href="#l65.134"></a><span id="l65.134">   },</span>
<a href="#l65.135"></a><span id="l65.135"> </span>
<a href="#l65.136"></a><span id="l65.136" class="difflineminus">-  setupCalendar: function(calendar) {</span>
<a href="#l65.137"></a><span id="l65.137" class="difflineplus">+  setupCalendar(calendar) {</span>
<a href="#l65.138"></a><span id="l65.138">     this.mCache[calendar.id] = calendar;</span>
<a href="#l65.139"></a><span id="l65.139"> </span>
<a href="#l65.140"></a><span id="l65.140">     // Add an observer to track readonly-mode triggers</span>
<a href="#l65.141"></a><span id="l65.141">     let newObserver = new calMgrCalendarObserver(calendar, this);</span>
<a href="#l65.142"></a><span id="l65.142">     calendar.addObserver(newObserver);</span>
<a href="#l65.143"></a><span id="l65.143">     this.mCalObservers[calendar.id] = newObserver;</span>
<a href="#l65.144"></a><span id="l65.144"> </span>
<a href="#l65.145"></a><span id="l65.145">     // Set up statistics</span>
<a href="#l65.146"></a><span id="l65.146" class="difflineat">@@ -312,17 +312,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.147"></a><span id="l65.147">       this.mReadonlyCalendarCount++;</span>
<a href="#l65.148"></a><span id="l65.148">     }</span>
<a href="#l65.149"></a><span id="l65.149">     this.mCalendarCount++;</span>
<a href="#l65.150"></a><span id="l65.150"> </span>
<a href="#l65.151"></a><span id="l65.151">     // Set up the refresh timer</span>
<a href="#l65.152"></a><span id="l65.152">     this.setupRefreshTimer(calendar);</span>
<a href="#l65.153"></a><span id="l65.153">   },</span>
<a href="#l65.154"></a><span id="l65.154"> </span>
<a href="#l65.155"></a><span id="l65.155" class="difflineminus">-  setupRefreshTimer: function(aCalendar) {</span>
<a href="#l65.156"></a><span id="l65.156" class="difflineplus">+  setupRefreshTimer(aCalendar) {</span>
<a href="#l65.157"></a><span id="l65.157">     // Add the refresh timer for this calendar</span>
<a href="#l65.158"></a><span id="l65.158">     let refreshInterval = aCalendar.getProperty(&quot;refreshInterval&quot;);</span>
<a href="#l65.159"></a><span id="l65.159">     if (refreshInterval === null) {</span>
<a href="#l65.160"></a><span id="l65.160">       // Default to 30 minutes, in case the value is missing</span>
<a href="#l65.161"></a><span id="l65.161">       refreshInterval = 30;</span>
<a href="#l65.162"></a><span id="l65.162">     }</span>
<a href="#l65.163"></a><span id="l65.163"> </span>
<a href="#l65.164"></a><span id="l65.164">     this.clearRefreshTimer(aCalendar);</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineat">@@ -333,24 +333,24 @@ calCalendarManager.prototype = {</span>
<a href="#l65.166"></a><span id="l65.166">       this.mRefreshTimer[aCalendar.id].initWithCallback(</span>
<a href="#l65.167"></a><span id="l65.167">         new timerCallback(aCalendar),</span>
<a href="#l65.168"></a><span id="l65.168">         refreshInterval * 60000,</span>
<a href="#l65.169"></a><span id="l65.169">         Ci.nsITimer.TYPE_REPEATING_SLACK</span>
<a href="#l65.170"></a><span id="l65.170">       );</span>
<a href="#l65.171"></a><span id="l65.171">     }</span>
<a href="#l65.172"></a><span id="l65.172">   },</span>
<a href="#l65.173"></a><span id="l65.173"> </span>
<a href="#l65.174"></a><span id="l65.174" class="difflineminus">-  clearRefreshTimer: function(aCalendar) {</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineplus">+  clearRefreshTimer(aCalendar) {</span>
<a href="#l65.176"></a><span id="l65.176">     if (aCalendar.id in this.mRefreshTimer &amp;&amp; this.mRefreshTimer[aCalendar.id]) {</span>
<a href="#l65.177"></a><span id="l65.177">       this.mRefreshTimer[aCalendar.id].cancel();</span>
<a href="#l65.178"></a><span id="l65.178">       delete this.mRefreshTimer[aCalendar.id];</span>
<a href="#l65.179"></a><span id="l65.179">     }</span>
<a href="#l65.180"></a><span id="l65.180">   },</span>
<a href="#l65.181"></a><span id="l65.181"> </span>
<a href="#l65.182"></a><span id="l65.182" class="difflineminus">-  unregisterCalendar: function(calendar) {</span>
<a href="#l65.183"></a><span id="l65.183" class="difflineplus">+  unregisterCalendar(calendar) {</span>
<a href="#l65.184"></a><span id="l65.184">     this.notifyObservers(&quot;onCalendarUnregistering&quot;, [calendar]);</span>
<a href="#l65.185"></a><span id="l65.185"> </span>
<a href="#l65.186"></a><span id="l65.186">     // calendar may be a calICalendar wrapper:</span>
<a href="#l65.187"></a><span id="l65.187">     if (calendar.wrappedJSObject instanceof calCachedCalendar) {</span>
<a href="#l65.188"></a><span id="l65.188">       calendar.wrappedJSObject.onCalendarUnregistering();</span>
<a href="#l65.189"></a><span id="l65.189">     }</span>
<a href="#l65.190"></a><span id="l65.190"> </span>
<a href="#l65.191"></a><span id="l65.191">     calendar.removeObserver(this.mCalObservers[calendar.id]);</span>
<a href="#l65.192"></a><span id="l65.192" class="difflineat">@@ -368,17 +368,17 @@ calCalendarManager.prototype = {</span>
<a href="#l65.193"></a><span id="l65.193">     if (calendar.getProperty(&quot;requiresNetwork&quot;) !== false) {</span>
<a href="#l65.194"></a><span id="l65.194">       this.mNetworkCalendarCount--;</span>
<a href="#l65.195"></a><span id="l65.195">     }</span>
<a href="#l65.196"></a><span id="l65.196">     this.mCalendarCount--;</span>
<a href="#l65.197"></a><span id="l65.197"> </span>
<a href="#l65.198"></a><span id="l65.198">     this.clearRefreshTimer(calendar);</span>
<a href="#l65.199"></a><span id="l65.199">   },</span>
<a href="#l65.200"></a><span id="l65.200"> </span>
<a href="#l65.201"></a><span id="l65.201" class="difflineminus">-  removeCalendar: function(calendar, mode = 0) {</span>
<a href="#l65.202"></a><span id="l65.202" class="difflineplus">+  removeCalendar(calendar, mode = 0) {</span>
<a href="#l65.203"></a><span id="l65.203">     const cICM = Ci.calICalendarManager;</span>
<a href="#l65.204"></a><span id="l65.204"> </span>
<a href="#l65.205"></a><span id="l65.205">     let removeModes = new Set(calendar.getProperty(&quot;capabilities.removeModes&quot;) || [&quot;unsubscribe&quot;]);</span>
<a href="#l65.206"></a><span id="l65.206">     if (!removeModes.has(&quot;unsubscribe&quot;) &amp;&amp; !removeModes.has(&quot;delete&quot;)) {</span>
<a href="#l65.207"></a><span id="l65.207">       // Removing is not allowed</span>
<a href="#l65.208"></a><span id="l65.208">       return;</span>
<a href="#l65.209"></a><span id="l65.209">     }</span>
<a href="#l65.210"></a><span id="l65.210"> </span>
<a href="#l65.211"></a><span id="l65.211" class="difflineat">@@ -398,35 +398,34 @@ calCalendarManager.prototype = {</span>
<a href="#l65.212"></a><span id="l65.212">       if (!wrappedCalendar) {</span>
<a href="#l65.213"></a><span id="l65.213">         throw new Components.Exception(&quot;Calendar is missing a provider implementation for delete&quot;);</span>
<a href="#l65.214"></a><span id="l65.214">       }</span>
<a href="#l65.215"></a><span id="l65.215"> </span>
<a href="#l65.216"></a><span id="l65.216">       wrappedCalendar.deleteCalendar(calendar, null);</span>
<a href="#l65.217"></a><span id="l65.217">     }</span>
<a href="#l65.218"></a><span id="l65.218">   },</span>
<a href="#l65.219"></a><span id="l65.219"> </span>
<a href="#l65.220"></a><span id="l65.220" class="difflineminus">-  getCalendarById: function(aId) {</span>
<a href="#l65.221"></a><span id="l65.221" class="difflineplus">+  getCalendarById(aId) {</span>
<a href="#l65.222"></a><span id="l65.222">     if (aId in this.mCache) {</span>
<a href="#l65.223"></a><span id="l65.223">       return this.mCache[aId];</span>
<a href="#l65.224"></a><span id="l65.224" class="difflineminus">-    } else {</span>
<a href="#l65.225"></a><span id="l65.225" class="difflineminus">-      return null;</span>
<a href="#l65.226"></a><span id="l65.226">     }</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineplus">+    return null;</span>
<a href="#l65.228"></a><span id="l65.228">   },</span>
<a href="#l65.229"></a><span id="l65.229"> </span>
<a href="#l65.230"></a><span id="l65.230" class="difflineminus">-  getCalendars: function() {</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineplus">+  getCalendars() {</span>
<a href="#l65.232"></a><span id="l65.232">     this.assureCache();</span>
<a href="#l65.233"></a><span id="l65.233">     let calendars = [];</span>
<a href="#l65.234"></a><span id="l65.234">     for (let id in this.mCache) {</span>
<a href="#l65.235"></a><span id="l65.235">       let calendar = this.mCache[id];</span>
<a href="#l65.236"></a><span id="l65.236">       calendars.push(calendar);</span>
<a href="#l65.237"></a><span id="l65.237">     }</span>
<a href="#l65.238"></a><span id="l65.238">     return calendars;</span>
<a href="#l65.239"></a><span id="l65.239">   },</span>
<a href="#l65.240"></a><span id="l65.240"> </span>
<a href="#l65.241"></a><span id="l65.241" class="difflineminus">-  assureCache: function() {</span>
<a href="#l65.242"></a><span id="l65.242" class="difflineplus">+  assureCache() {</span>
<a href="#l65.243"></a><span id="l65.243">     if (!this.mCache) {</span>
<a href="#l65.244"></a><span id="l65.244">       this.mCache = {};</span>
<a href="#l65.245"></a><span id="l65.245">       this.mCalObservers = {};</span>
<a href="#l65.246"></a><span id="l65.246"> </span>
<a href="#l65.247"></a><span id="l65.247">       let allCals = {};</span>
<a href="#l65.248"></a><span id="l65.248">       for (let key of Services.prefs.getChildList(REGISTRY_BRANCH)) {</span>
<a href="#l65.249"></a><span id="l65.249">         // merge down all keys</span>
<a href="#l65.250"></a><span id="l65.250">         allCals[key.substring(0, key.indexOf(&quot;.&quot;, REGISTRY_BRANCH.length))] = true;</span>
<a href="#l65.251"></a><span id="l65.251" class="difflineat">@@ -483,34 +482,34 @@ calCalendarManager.prototype = {</span>
<a href="#l65.252"></a><span id="l65.252">         let calendar = this.mCache[id];</span>
<a href="#l65.253"></a><span id="l65.253">         if (!calendar.getProperty(&quot;disabled&quot;) &amp;&amp; calendar.canRefresh) {</span>
<a href="#l65.254"></a><span id="l65.254">           calendar.refresh();</span>
<a href="#l65.255"></a><span id="l65.255">         }</span>
<a href="#l65.256"></a><span id="l65.256">       }</span>
<a href="#l65.257"></a><span id="l65.257">     }</span>
<a href="#l65.258"></a><span id="l65.258">   },</span>
<a href="#l65.259"></a><span id="l65.259"> </span>
<a href="#l65.260"></a><span id="l65.260" class="difflineminus">-  getCalendarPref_: function(calendar, name) {</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineplus">+  getCalendarPref_(calendar, name) {</span>
<a href="#l65.262"></a><span id="l65.262">     cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l65.263"></a><span id="l65.263">     cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l65.264"></a><span id="l65.264">     cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l65.265"></a><span id="l65.265"> </span>
<a href="#l65.266"></a><span id="l65.266">     let branch = getPrefBranchFor(calendar.id) + name;</span>
<a href="#l65.267"></a><span id="l65.267">     let value = Preferences.get(branch, null);</span>
<a href="#l65.268"></a><span id="l65.268"> </span>
<a href="#l65.269"></a><span id="l65.269">     if (typeof value == &quot;string&quot; &amp;&amp; value.startsWith(&quot;bignum:&quot;)) {</span>
<a href="#l65.270"></a><span id="l65.270">       let converted = Number(value.substr(7));</span>
<a href="#l65.271"></a><span id="l65.271">       if (!isNaN(converted)) {</span>
<a href="#l65.272"></a><span id="l65.272">         value = converted;</span>
<a href="#l65.273"></a><span id="l65.273">       }</span>
<a href="#l65.274"></a><span id="l65.274">     }</span>
<a href="#l65.275"></a><span id="l65.275">     return value;</span>
<a href="#l65.276"></a><span id="l65.276">   },</span>
<a href="#l65.277"></a><span id="l65.277"> </span>
<a href="#l65.278"></a><span id="l65.278" class="difflineminus">-  setCalendarPref_: function(calendar, name, value) {</span>
<a href="#l65.279"></a><span id="l65.279" class="difflineplus">+  setCalendarPref_(calendar, name, value) {</span>
<a href="#l65.280"></a><span id="l65.280">     cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l65.281"></a><span id="l65.281">     cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l65.282"></a><span id="l65.282">     cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l65.283"></a><span id="l65.283"> </span>
<a href="#l65.284"></a><span id="l65.284">     let branch = getPrefBranchFor(calendar.id) + name;</span>
<a href="#l65.285"></a><span id="l65.285"> </span>
<a href="#l65.286"></a><span id="l65.286">     if (</span>
<a href="#l65.287"></a><span id="l65.287">       typeof value == &quot;number&quot; &amp;&amp;</span>
<a href="#l65.288"></a><span id="l65.288" class="difflineat">@@ -523,42 +522,42 @@ calCalendarManager.prototype = {</span>
<a href="#l65.289"></a><span id="l65.289"> </span>
<a href="#l65.290"></a><span id="l65.290">     // Delete before to allow pref-type changes, then set the pref.</span>
<a href="#l65.291"></a><span id="l65.291">     Services.prefs.deleteBranch(branch);</span>
<a href="#l65.292"></a><span id="l65.292">     if (value !== null &amp;&amp; value !== undefined) {</span>
<a href="#l65.293"></a><span id="l65.293">       Preferences.set(branch, value);</span>
<a href="#l65.294"></a><span id="l65.294">     }</span>
<a href="#l65.295"></a><span id="l65.295">   },</span>
<a href="#l65.296"></a><span id="l65.296"> </span>
<a href="#l65.297"></a><span id="l65.297" class="difflineminus">-  deleteCalendarPref_: function(calendar, name) {</span>
<a href="#l65.298"></a><span id="l65.298" class="difflineplus">+  deleteCalendarPref_(calendar, name) {</span>
<a href="#l65.299"></a><span id="l65.299">     cal.ASSERT(calendar, &quot;Invalid Calendar!&quot;);</span>
<a href="#l65.300"></a><span id="l65.300">     cal.ASSERT(calendar.id !== null, &quot;Calendar id needs to be set!&quot;);</span>
<a href="#l65.301"></a><span id="l65.301">     cal.ASSERT(name &amp;&amp; name.length &gt; 0, &quot;Pref Name must be non-empty!&quot;);</span>
<a href="#l65.302"></a><span id="l65.302">     Services.prefs.deleteBranch(getPrefBranchFor(calendar.id) + name);</span>
<a href="#l65.303"></a><span id="l65.303">   },</span>
<a href="#l65.304"></a><span id="l65.304"> </span>
<a href="#l65.305"></a><span id="l65.305">   mObservers: null,</span>
<a href="#l65.306"></a><span id="l65.306" class="difflineminus">-  addObserver: function(aObserver) {</span>
<a href="#l65.307"></a><span id="l65.307" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l65.308"></a><span id="l65.308">     this.mObservers.add(aObserver);</span>
<a href="#l65.309"></a><span id="l65.309">   },</span>
<a href="#l65.310"></a><span id="l65.310" class="difflineminus">-  removeObserver: function(aObserver) {</span>
<a href="#l65.311"></a><span id="l65.311" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l65.312"></a><span id="l65.312">     this.mObservers.delete(aObserver);</span>
<a href="#l65.313"></a><span id="l65.313">   },</span>
<a href="#l65.314"></a><span id="l65.314" class="difflineminus">-  notifyObservers: function(functionName, args) {</span>
<a href="#l65.315"></a><span id="l65.315" class="difflineplus">+  notifyObservers(functionName, args) {</span>
<a href="#l65.316"></a><span id="l65.316">     this.mObservers.notify(functionName, args);</span>
<a href="#l65.317"></a><span id="l65.317">   },</span>
<a href="#l65.318"></a><span id="l65.318"> </span>
<a href="#l65.319"></a><span id="l65.319">   mCalendarObservers: null,</span>
<a href="#l65.320"></a><span id="l65.320" class="difflineminus">-  addCalendarObserver: function(aObserver) {</span>
<a href="#l65.321"></a><span id="l65.321" class="difflineplus">+  addCalendarObserver(aObserver) {</span>
<a href="#l65.322"></a><span id="l65.322">     return this.mCalendarObservers.add(aObserver);</span>
<a href="#l65.323"></a><span id="l65.323">   },</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineminus">-  removeCalendarObserver: function(aObserver) {</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineplus">+  removeCalendarObserver(aObserver) {</span>
<a href="#l65.326"></a><span id="l65.326">     return this.mCalendarObservers.delete(aObserver);</span>
<a href="#l65.327"></a><span id="l65.327">   },</span>
<a href="#l65.328"></a><span id="l65.328" class="difflineminus">-  notifyCalendarObservers: function(functionName, args) {</span>
<a href="#l65.329"></a><span id="l65.329" class="difflineplus">+  notifyCalendarObservers(functionName, args) {</span>
<a href="#l65.330"></a><span id="l65.330">     this.mCalendarObservers.notify(functionName, args);</span>
<a href="#l65.331"></a><span id="l65.331">   },</span>
<a href="#l65.332"></a><span id="l65.332"> };</span>
<a href="#l65.333"></a><span id="l65.333"> </span>
<a href="#l65.334"></a><span id="l65.334"> function equalMessage(msg1, msg2) {</span>
<a href="#l65.335"></a><span id="l65.335">   if (</span>
<a href="#l65.336"></a><span id="l65.336">     msg1.GetString(0) == msg2.GetString(0) &amp;&amp;</span>
<a href="#l65.337"></a><span id="l65.337">     msg1.GetString(1) == msg2.GetString(1) &amp;&amp;</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineat">@@ -580,40 +579,40 @@ function calMgrCalendarObserver(calendar</span>
<a href="#l65.339"></a><span id="l65.339"> calMgrCalendarObserver.prototype = {</span>
<a href="#l65.340"></a><span id="l65.340">   calendar: null,</span>
<a href="#l65.341"></a><span id="l65.341">   storedReadOnly: null,</span>
<a href="#l65.342"></a><span id="l65.342">   calMgr: null,</span>
<a href="#l65.343"></a><span id="l65.343"> </span>
<a href="#l65.344"></a><span id="l65.344">   QueryInterface: ChromeUtils.generateQI([Ci.nsIWindowMediatorListener, Ci.calIObserver]),</span>
<a href="#l65.345"></a><span id="l65.345"> </span>
<a href="#l65.346"></a><span id="l65.346">   // calIObserver:</span>
<a href="#l65.347"></a><span id="l65.347" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l65.348"></a><span id="l65.348" class="difflineplus">+  onStartBatch() {</span>
<a href="#l65.349"></a><span id="l65.349">     return this.calMgr.notifyCalendarObservers(&quot;onStartBatch&quot;, arguments);</span>
<a href="#l65.350"></a><span id="l65.350">   },</span>
<a href="#l65.351"></a><span id="l65.351" class="difflineminus">-  onEndBatch: function() {</span>
<a href="#l65.352"></a><span id="l65.352" class="difflineplus">+  onEndBatch() {</span>
<a href="#l65.353"></a><span id="l65.353">     return this.calMgr.notifyCalendarObservers(&quot;onEndBatch&quot;, arguments);</span>
<a href="#l65.354"></a><span id="l65.354">   },</span>
<a href="#l65.355"></a><span id="l65.355" class="difflineminus">-  onLoad: function(calendar) {</span>
<a href="#l65.356"></a><span id="l65.356" class="difflineplus">+  onLoad(calendar) {</span>
<a href="#l65.357"></a><span id="l65.357">     return this.calMgr.notifyCalendarObservers(&quot;onLoad&quot;, arguments);</span>
<a href="#l65.358"></a><span id="l65.358">   },</span>
<a href="#l65.359"></a><span id="l65.359" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l65.360"></a><span id="l65.360" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l65.361"></a><span id="l65.361">     return this.calMgr.notifyCalendarObservers(&quot;onAddItem&quot;, arguments);</span>
<a href="#l65.362"></a><span id="l65.362">   },</span>
<a href="#l65.363"></a><span id="l65.363" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l65.364"></a><span id="l65.364" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l65.365"></a><span id="l65.365">     return this.calMgr.notifyCalendarObservers(&quot;onModifyItem&quot;, arguments);</span>
<a href="#l65.366"></a><span id="l65.366">   },</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l65.369"></a><span id="l65.369">     return this.calMgr.notifyCalendarObservers(&quot;onDeleteItem&quot;, arguments);</span>
<a href="#l65.370"></a><span id="l65.370">   },</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l65.373"></a><span id="l65.373">     this.calMgr.notifyCalendarObservers(&quot;onError&quot;, arguments);</span>
<a href="#l65.374"></a><span id="l65.374">     this.announceError(aCalendar, aErrNo, aMessage);</span>
<a href="#l65.375"></a><span id="l65.375">   },</span>
<a href="#l65.376"></a><span id="l65.376"> </span>
<a href="#l65.377"></a><span id="l65.377" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l65.378"></a><span id="l65.378" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l65.379"></a><span id="l65.379">     this.calMgr.notifyCalendarObservers(&quot;onPropertyChanged&quot;, arguments);</span>
<a href="#l65.380"></a><span id="l65.380">     switch (aName) {</span>
<a href="#l65.381"></a><span id="l65.381">       case &quot;requiresNetwork&quot;:</span>
<a href="#l65.382"></a><span id="l65.382">         this.calMgr.mNetworkCalendarCount += aValue ? 1 : -1;</span>
<a href="#l65.383"></a><span id="l65.383">         break;</span>
<a href="#l65.384"></a><span id="l65.384">       case &quot;readOnly&quot;:</span>
<a href="#l65.385"></a><span id="l65.385">         this.calMgr.mReadonlyCalendarCount += aValue ? 1 : -1;</span>
<a href="#l65.386"></a><span id="l65.386">         break;</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineat">@@ -626,17 +625,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.388"></a><span id="l65.388">       case &quot;disabled&quot;:</span>
<a href="#l65.389"></a><span id="l65.389">         if (!aValue &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l65.390"></a><span id="l65.390">           aCalendar.refresh();</span>
<a href="#l65.391"></a><span id="l65.391">         }</span>
<a href="#l65.392"></a><span id="l65.392">         break;</span>
<a href="#l65.393"></a><span id="l65.393">     }</span>
<a href="#l65.394"></a><span id="l65.394">   },</span>
<a href="#l65.395"></a><span id="l65.395"> </span>
<a href="#l65.396"></a><span id="l65.396" class="difflineminus">-  changeCalendarCache: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l65.397"></a><span id="l65.397" class="difflineplus">+  changeCalendarCache(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l65.398"></a><span id="l65.398">     const cICM = Ci.calICalendarManager;</span>
<a href="#l65.399"></a><span id="l65.399">     aOldValue = aOldValue || false;</span>
<a href="#l65.400"></a><span id="l65.400">     aValue = aValue || false;</span>
<a href="#l65.401"></a><span id="l65.401"> </span>
<a href="#l65.402"></a><span id="l65.402">     // hack for bug 1182264 to deal with calendars, which have set cache.enabled, but in fact do</span>
<a href="#l65.403"></a><span id="l65.403">     // not support caching (like storage calendars) - this also prevents enabling cache again</span>
<a href="#l65.404"></a><span id="l65.404">     if (aCalendar.getProperty(&quot;cache.supported&quot;) === false) {</span>
<a href="#l65.405"></a><span id="l65.405">       if (aCalendar.getProperty(&quot;cache.enabled&quot;) === true) {</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineat">@@ -687,22 +686,22 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.407"></a><span id="l65.407">       this.calMgr.registerCalendar(newCal);</span>
<a href="#l65.408"></a><span id="l65.408">     } else if (aCalendar.wrappedJSObject instanceof calCachedCalendar) {</span>
<a href="#l65.409"></a><span id="l65.409">       // any attempt to switch this flag will reset the cached calendar;</span>
<a href="#l65.410"></a><span id="l65.410">       // could be useful for users in case the cache may be corrupted.</span>
<a href="#l65.411"></a><span id="l65.411">       aCalendar.wrappedJSObject.setupCachedCalendar();</span>
<a href="#l65.412"></a><span id="l65.412">     }</span>
<a href="#l65.413"></a><span id="l65.413">   },</span>
<a href="#l65.414"></a><span id="l65.414"> </span>
<a href="#l65.415"></a><span id="l65.415" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l65.417"></a><span id="l65.417">     this.onPropertyChanged(aCalendar, aName, false, true);</span>
<a href="#l65.418"></a><span id="l65.418">   },</span>
<a href="#l65.419"></a><span id="l65.419"> </span>
<a href="#l65.420"></a><span id="l65.420">   // Error announcer specific functions</span>
<a href="#l65.421"></a><span id="l65.421" class="difflineminus">-  announceError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l65.422"></a><span id="l65.422" class="difflineplus">+  announceError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l65.423"></a><span id="l65.423">     let paramBlock = Cc[&quot;@mozilla.org/embedcomp/dialogparam;1&quot;].createInstance(</span>
<a href="#l65.424"></a><span id="l65.424">       Ci.nsIDialogParamBlock</span>
<a href="#l65.425"></a><span id="l65.425">     );</span>
<a href="#l65.426"></a><span id="l65.426">     let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l65.427"></a><span id="l65.427">     let errMsg;</span>
<a href="#l65.428"></a><span id="l65.428">     paramBlock.SetNumberStrings(3);</span>
<a href="#l65.429"></a><span id="l65.429">     if (!this.storedReadOnly &amp;&amp; this.calendar.readOnly) {</span>
<a href="#l65.430"></a><span id="l65.430">       // Major errors change the calendar to readOnly</span>
<a href="#l65.431"></a><span id="l65.431" class="difflineat">@@ -761,17 +760,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.432"></a><span id="l65.432">     if (aErrNo == calIErrors.MODIFICATION_FAILED) {</span>
<a href="#l65.433"></a><span id="l65.433">       Cu.reportError(summary);</span>
<a href="#l65.434"></a><span id="l65.434">       this.announceParamBlock(paramBlock);</span>
<a href="#l65.435"></a><span id="l65.435">     } else {</span>
<a href="#l65.436"></a><span id="l65.436">       cal.WARN(summary);</span>
<a href="#l65.437"></a><span id="l65.437">     }</span>
<a href="#l65.438"></a><span id="l65.438">   },</span>
<a href="#l65.439"></a><span id="l65.439"> </span>
<a href="#l65.440"></a><span id="l65.440" class="difflineminus">-  announceParamBlock: function(paramBlock) {</span>
<a href="#l65.441"></a><span id="l65.441" class="difflineplus">+  announceParamBlock(paramBlock) {</span>
<a href="#l65.442"></a><span id="l65.442">     function awaitLoad(event) {</span>
<a href="#l65.443"></a><span id="l65.443">       promptWindow.addEventListener(&quot;unload&quot;, awaitUnload, { capture: false, once: true });</span>
<a href="#l65.444"></a><span id="l65.444">     }</span>
<a href="#l65.445"></a><span id="l65.445">     let awaitUnload = event =&gt; {</span>
<a href="#l65.446"></a><span id="l65.446">       // unloaded (user closed prompt window),</span>
<a href="#l65.447"></a><span id="l65.447">       // remove paramBlock and unload listener.</span>
<a href="#l65.448"></a><span id="l65.448">       try {</span>
<a href="#l65.449"></a><span id="l65.449">         // remove the message that has been shown from</span>
<a href="#l65.450"></a><span id="l65.450" class="difflineat">@@ -808,17 +807,17 @@ calMgrCalendarObserver.prototype = {</span>
<a href="#l65.451"></a><span id="l65.451"> </span>
<a href="#l65.452"></a><span id="l65.452"> function calDummyCalendar(type) {</span>
<a href="#l65.453"></a><span id="l65.453">   this.initProviderBase();</span>
<a href="#l65.454"></a><span id="l65.454">   this.type = type;</span>
<a href="#l65.455"></a><span id="l65.455"> }</span>
<a href="#l65.456"></a><span id="l65.456"> calDummyCalendar.prototype = {</span>
<a href="#l65.457"></a><span id="l65.457">   __proto__: cal.provider.BaseClass.prototype,</span>
<a href="#l65.458"></a><span id="l65.458"> </span>
<a href="#l65.459"></a><span id="l65.459" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l65.460"></a><span id="l65.460" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l65.461"></a><span id="l65.461">     switch (aName) {</span>
<a href="#l65.462"></a><span id="l65.462">       case &quot;force-disabled&quot;:</span>
<a href="#l65.463"></a><span id="l65.463">         return true;</span>
<a href="#l65.464"></a><span id="l65.464">       default:</span>
<a href="#l65.465"></a><span id="l65.465">         return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l65.466"></a><span id="l65.466">     }</span>
<a href="#l65.467"></a><span id="l65.467">   },</span>
<a href="#l65.468"></a><span id="l65.468"> };</span>
<a href="#l65.469"></a><span id="l65.469" class="difflineat">@@ -846,31 +845,31 @@ function timerCallback(aCalendar) {</span>
<a href="#l65.470"></a><span id="l65.470">   this.notify = function(aTimer) {</span>
<a href="#l65.471"></a><span id="l65.471">     if (!aCalendar.getProperty(&quot;disabled&quot;) &amp;&amp; aCalendar.canRefresh) {</span>
<a href="#l65.472"></a><span id="l65.472">       aCalendar.refresh();</span>
<a href="#l65.473"></a><span id="l65.473">     }</span>
<a href="#l65.474"></a><span id="l65.474">   };</span>
<a href="#l65.475"></a><span id="l65.475"> }</span>
<a href="#l65.476"></a><span id="l65.476"> </span>
<a href="#l65.477"></a><span id="l65.477"> var gCalendarManagerAddonListener = {</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineminus">-  onDisabling: function(aAddon, aNeedsRestart) {</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+  onDisabling(aAddon, aNeedsRestart) {</span>
<a href="#l65.480"></a><span id="l65.480">     if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l65.481"></a><span id="l65.481">       // If the addon should not be disabled, then re-enable it.</span>
<a href="#l65.482"></a><span id="l65.482">       aAddon.userDisabled = false;</span>
<a href="#l65.483"></a><span id="l65.483">     }</span>
<a href="#l65.484"></a><span id="l65.484">   },</span>
<a href="#l65.485"></a><span id="l65.485"> </span>
<a href="#l65.486"></a><span id="l65.486" class="difflineminus">-  onUninstalling: function(aAddon, aNeedsRestart) {</span>
<a href="#l65.487"></a><span id="l65.487" class="difflineplus">+  onUninstalling(aAddon, aNeedsRestart) {</span>
<a href="#l65.488"></a><span id="l65.488">     if (!this.queryUninstallProvider(aAddon)) {</span>
<a href="#l65.489"></a><span id="l65.489">       // If the addon should not be uninstalled, then cancel the uninstall.</span>
<a href="#l65.490"></a><span id="l65.490">       aAddon.cancelUninstall();</span>
<a href="#l65.491"></a><span id="l65.491">     }</span>
<a href="#l65.492"></a><span id="l65.492">   },</span>
<a href="#l65.493"></a><span id="l65.493"> </span>
<a href="#l65.494"></a><span id="l65.494" class="difflineminus">-  queryUninstallProvider: function(aAddon) {</span>
<a href="#l65.495"></a><span id="l65.495" class="difflineplus">+  queryUninstallProvider(aAddon) {</span>
<a href="#l65.496"></a><span id="l65.496">     const uri = &quot;chrome://calendar/content/calendar-providerUninstall-dialog.xhtml&quot;;</span>
<a href="#l65.497"></a><span id="l65.497">     const features = &quot;chrome,titlebar,resizable,modal&quot;;</span>
<a href="#l65.498"></a><span id="l65.498">     let calMgr = cal.getCalendarManager();</span>
<a href="#l65.499"></a><span id="l65.499">     let affectedCalendars = calMgr</span>
<a href="#l65.500"></a><span id="l65.500">       .getCalendars()</span>
<a href="#l65.501"></a><span id="l65.501">       .filter(calendar =&gt; calendar.providerID == aAddon.id);</span>
<a href="#l65.502"></a><span id="l65.502">     if (!affectedCalendars.length) {</span>
<a href="#l65.503"></a><span id="l65.503">       // If no calendars are affected, then everything is fine.</span>
<a href="#l65.504"></a><span id="l65.504" class="difflineat">@@ -907,12 +906,11 @@ function appendToRealm(authHeader, appen</span>
<a href="#l65.505"></a><span id="l65.505">       idx += match[0].length;</span>
<a href="#l65.506"></a><span id="l65.506"> </span>
<a href="#l65.507"></a><span id="l65.507">       isEscaped = match[2].length % 2 == 0;</span>
<a href="#l65.508"></a><span id="l65.508">       if (!isEscaped) {</span>
<a href="#l65.509"></a><span id="l65.509">         remain = remain.substr(match[0].length);</span>
<a href="#l65.510"></a><span id="l65.510">       }</span>
<a href="#l65.511"></a><span id="l65.511">     }</span>
<a href="#l65.512"></a><span id="l65.512">     return authHeader.substr(0, idx - 1) + &quot; &quot; + appendStr + authHeader.substr(idx - 1);</span>
<a href="#l65.513"></a><span id="l65.513" class="difflineminus">-  } else {</span>
<a href="#l65.514"></a><span id="l65.514" class="difflineminus">-    return authHeader;</span>
<a href="#l65.515"></a><span id="l65.515">   }</span>
<a href="#l65.516"></a><span id="l65.516" class="difflineplus">+  return authHeader;</span>
<a href="#l65.517"></a><span id="l65.517"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/calendar/base/src/calCalendarSearchService.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -13,28 +13,28 @@ function calCalendarSearchListener(numOp</span>
<a href="#l66.4"></a><span id="l66.4">     this.notifyResult(null);</span>
<a href="#l66.5"></a><span id="l66.5">   });</span>
<a href="#l66.6"></a><span id="l66.6"> }</span>
<a href="#l66.7"></a><span id="l66.7"> calCalendarSearchListener.prototype = {</span>
<a href="#l66.8"></a><span id="l66.8">   mFinalListener: null,</span>
<a href="#l66.9"></a><span id="l66.9">   mNumOperations: 0,</span>
<a href="#l66.10"></a><span id="l66.10">   opGroup: null,</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-  notifyResult: function(result) {</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+  notifyResult(result) {</span>
<a href="#l66.14"></a><span id="l66.14">     let listener = this.mFinalListener;</span>
<a href="#l66.15"></a><span id="l66.15">     if (listener) {</span>
<a href="#l66.16"></a><span id="l66.16">       if (!this.opGroup.isPending) {</span>
<a href="#l66.17"></a><span id="l66.17">         this.mFinalListener = null;</span>
<a href="#l66.18"></a><span id="l66.18">       }</span>
<a href="#l66.19"></a><span id="l66.19">       listener.onResult(this.opGroup, result);</span>
<a href="#l66.20"></a><span id="l66.20">     }</span>
<a href="#l66.21"></a><span id="l66.21">   },</span>
<a href="#l66.22"></a><span id="l66.22"> </span>
<a href="#l66.23"></a><span id="l66.23">   // calIGenericOperationListener:</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineminus">-  onResult: function(aOperation, aResult) {</span>
<a href="#l66.25"></a><span id="l66.25" class="difflineplus">+  onResult(aOperation, aResult) {</span>
<a href="#l66.26"></a><span id="l66.26">     if (this.mFinalListener) {</span>
<a href="#l66.27"></a><span id="l66.27">       if (!aOperation || !aOperation.isPending) {</span>
<a href="#l66.28"></a><span id="l66.28">         --this.mNumOperations;</span>
<a href="#l66.29"></a><span id="l66.29">         if (this.mNumOperations == 0) {</span>
<a href="#l66.30"></a><span id="l66.30">           this.opGroup.notifyCompleted();</span>
<a href="#l66.31"></a><span id="l66.31">         }</span>
<a href="#l66.32"></a><span id="l66.32">       }</span>
<a href="#l66.33"></a><span id="l66.33">       if (aResult) {</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineat">@@ -62,34 +62,34 @@ calCalendarSearchService.prototype = {</span>
<a href="#l66.35"></a><span id="l66.35">     classID: calCalendarSearchServiceClassID,</span>
<a href="#l66.36"></a><span id="l66.36">     contractID: &quot;@mozilla.org/calendar/calendarsearch-service;1&quot;,</span>
<a href="#l66.37"></a><span id="l66.37">     classDescription: &quot;Calendar Search Service&quot;,</span>
<a href="#l66.38"></a><span id="l66.38">     interfaces: calCalendarSearchServiceInterfaces,</span>
<a href="#l66.39"></a><span id="l66.39">     flags: Ci.nsIClassInfo.SINGLETON,</span>
<a href="#l66.40"></a><span id="l66.40">   }),</span>
<a href="#l66.41"></a><span id="l66.41"> </span>
<a href="#l66.42"></a><span id="l66.42">   // calICalendarSearchProvider:</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineminus">-  searchForCalendars: function(aString, aHints, aMaxResults, aListener) {</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  searchForCalendars(aString, aHints, aMaxResults, aListener) {</span>
<a href="#l66.45"></a><span id="l66.45">     let groupListener = new calCalendarSearchListener(this.mProviders.size, aListener);</span>
<a href="#l66.46"></a><span id="l66.46">     for (let provider of this.mProviders.values()) {</span>
<a href="#l66.47"></a><span id="l66.47">       try {</span>
<a href="#l66.48"></a><span id="l66.48">         groupListener.opGroup.add(</span>
<a href="#l66.49"></a><span id="l66.49">           provider.searchForCalendars(aString, aHints, aMaxResults, groupListener)</span>
<a href="#l66.50"></a><span id="l66.50">         );</span>
<a href="#l66.51"></a><span id="l66.51">       } catch (exc) {</span>
<a href="#l66.52"></a><span id="l66.52">         Cu.reportError(exc);</span>
<a href="#l66.53"></a><span id="l66.53">         groupListener.onResult(null, []); // dummy to adopt mNumOperations</span>
<a href="#l66.54"></a><span id="l66.54">       }</span>
<a href="#l66.55"></a><span id="l66.55">     }</span>
<a href="#l66.56"></a><span id="l66.56">     return groupListener.opGroup;</span>
<a href="#l66.57"></a><span id="l66.57">   },</span>
<a href="#l66.58"></a><span id="l66.58"> </span>
<a href="#l66.59"></a><span id="l66.59">   // calICalendarSearchService:</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineminus">-  getProviders: function() {</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+  getProviders() {</span>
<a href="#l66.62"></a><span id="l66.62">     return [...this.mProviders];</span>
<a href="#l66.63"></a><span id="l66.63">   },</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineminus">-  addProvider: function(aProvider) {</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+  addProvider(aProvider) {</span>
<a href="#l66.66"></a><span id="l66.66">     this.mProviders.add(aProvider.QueryInterface(Ci.calICalendarSearchProvider));</span>
<a href="#l66.67"></a><span id="l66.67">   },</span>
<a href="#l66.68"></a><span id="l66.68" class="difflineminus">-  removeProvider: function(aProvider) {</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineplus">+  removeProvider(aProvider) {</span>
<a href="#l66.70"></a><span id="l66.70">     this.mProviders.delete(aProvider.QueryInterface(Ci.calICalendarSearchProvider));</span>
<a href="#l66.71"></a><span id="l66.71">   },</span>
<a href="#l66.72"></a><span id="l66.72"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/calendar/base/src/calDateTimeFormatter.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -10,63 +10,62 @@ function calDateTimeFormatter() {</span>
<a href="#l67.4"></a><span id="l67.4">   this.mDateStringBundle = Services.strings.createBundle(</span>
<a href="#l67.5"></a><span id="l67.5">     &quot;chrome://calendar/locale/dateFormat.properties&quot;</span>
<a href="#l67.6"></a><span id="l67.6">   );</span>
<a href="#l67.7"></a><span id="l67.7"> }</span>
<a href="#l67.8"></a><span id="l67.8"> calDateTimeFormatter.prototype = {</span>
<a href="#l67.9"></a><span id="l67.9">   QueryInterface: ChromeUtils.generateQI([Ci.calIDateTimeFormatter]),</span>
<a href="#l67.10"></a><span id="l67.10">   classID: Components.ID(&quot;{4123da9a-f047-42da-a7d0-cc4175b9f36a}&quot;),</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-  formatDate: function(aDate) {</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+  formatDate(aDate) {</span>
<a href="#l67.14"></a><span id="l67.14">     // Format the date using user's format preference (long or short)</span>
<a href="#l67.15"></a><span id="l67.15">     let format = Services.prefs.getIntPref(&quot;calendar.date.format&quot;, 0);</span>
<a href="#l67.16"></a><span id="l67.16">     return format == 0 ? this.formatDateLong(aDate) : this.formatDateShort(aDate);</span>
<a href="#l67.17"></a><span id="l67.17">   },</span>
<a href="#l67.18"></a><span id="l67.18"> </span>
<a href="#l67.19"></a><span id="l67.19" class="difflineminus">-  formatDateShort: function(aDate) {</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineplus">+  formatDateShort(aDate) {</span>
<a href="#l67.21"></a><span id="l67.21">     return this._inTimezone(aDate, { dateStyle: &quot;short&quot; });</span>
<a href="#l67.22"></a><span id="l67.22">   },</span>
<a href="#l67.23"></a><span id="l67.23"> </span>
<a href="#l67.24"></a><span id="l67.24" class="difflineminus">-  formatDateLong: function(aDate) {</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineplus">+  formatDateLong(aDate) {</span>
<a href="#l67.26"></a><span id="l67.26">     return this._inTimezone(aDate, { dateStyle: &quot;full&quot; });</span>
<a href="#l67.27"></a><span id="l67.27">   },</span>
<a href="#l67.28"></a><span id="l67.28"> </span>
<a href="#l67.29"></a><span id="l67.29" class="difflineminus">-  formatDateWithoutYear: function(aDate) {</span>
<a href="#l67.30"></a><span id="l67.30" class="difflineplus">+  formatDateWithoutYear(aDate) {</span>
<a href="#l67.31"></a><span id="l67.31">     let dtOptions = { month: &quot;short&quot;, day: &quot;numeric&quot; };</span>
<a href="#l67.32"></a><span id="l67.32">     return this._inTimezone(aDate, dtOptions);</span>
<a href="#l67.33"></a><span id="l67.33">   },</span>
<a href="#l67.34"></a><span id="l67.34"> </span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-  formatTime: function(aDate) {</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+  formatTime(aDate) {</span>
<a href="#l67.37"></a><span id="l67.37">     if (aDate.isDate) {</span>
<a href="#l67.38"></a><span id="l67.38">       return this.mDateStringBundle.GetStringFromName(&quot;AllDay&quot;);</span>
<a href="#l67.39"></a><span id="l67.39">     }</span>
<a href="#l67.40"></a><span id="l67.40"> </span>
<a href="#l67.41"></a><span id="l67.41">     return this._inTimezone(aDate, { timeStyle: &quot;short&quot; });</span>
<a href="#l67.42"></a><span id="l67.42">   },</span>
<a href="#l67.43"></a><span id="l67.43"> </span>
<a href="#l67.44"></a><span id="l67.44" class="difflineminus">-  formatDateTime: function(aDate) {</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineplus">+  formatDateTime(aDate) {</span>
<a href="#l67.46"></a><span id="l67.46">     let formattedDate = this.formatDate(aDate);</span>
<a href="#l67.47"></a><span id="l67.47">     let formattedTime = this.formatTime(aDate);</span>
<a href="#l67.48"></a><span id="l67.48"> </span>
<a href="#l67.49"></a><span id="l67.49">     let timeBeforeDate = Services.prefs.getBoolPref(&quot;calendar.date.formatTimeBeforeDate&quot;, false);</span>
<a href="#l67.50"></a><span id="l67.50">     if (timeBeforeDate) {</span>
<a href="#l67.51"></a><span id="l67.51">       return formattedTime + &quot; &quot; + formattedDate;</span>
<a href="#l67.52"></a><span id="l67.52" class="difflineminus">-    } else {</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineminus">-      return formattedDate + &quot; &quot; + formattedTime;</span>
<a href="#l67.54"></a><span id="l67.54">     }</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineplus">+    return formattedDate + &quot; &quot; + formattedTime;</span>
<a href="#l67.56"></a><span id="l67.56">   },</span>
<a href="#l67.57"></a><span id="l67.57"> </span>
<a href="#l67.58"></a><span id="l67.58">   /**</span>
<a href="#l67.59"></a><span id="l67.59">    * _inTimezone returns a string with date formatted</span>
<a href="#l67.60"></a><span id="l67.60">    *</span>
<a href="#l67.61"></a><span id="l67.61">    * @param  {calIDateTime} aDate    The date object holding the tz information</span>
<a href="#l67.62"></a><span id="l67.62">    * @param  {JsObject}     aOptions The options object for formatting.</span>
<a href="#l67.63"></a><span id="l67.63">    * @return {String}                The date as a string.</span>
<a href="#l67.64"></a><span id="l67.64">    */</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineminus">-  _inTimezone: function(aDate, aOptions) {</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineplus">+  _inTimezone(aDate, aOptions) {</span>
<a href="#l67.67"></a><span id="l67.67">     let formatter = new Services.intl.DateTimeFormat(undefined, aOptions);</span>
<a href="#l67.68"></a><span id="l67.68"> </span>
<a href="#l67.69"></a><span id="l67.69">     let timezone = aDate.timezone;</span>
<a href="#l67.70"></a><span id="l67.70">     // We set the tz only if we have a valid tz - otherwise localtime will be used on formatting.</span>
<a href="#l67.71"></a><span id="l67.71">     if (timezone &amp;&amp; (timezone.isUTC || timezone.icalComponent)) {</span>
<a href="#l67.72"></a><span id="l67.72">       aOptions.timeZone = timezone.tzid;</span>
<a href="#l67.73"></a><span id="l67.73">       try {</span>
<a href="#l67.74"></a><span id="l67.74">         formatter = new Services.intl.DateTimeFormat(undefined, aOptions);</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineat">@@ -74,34 +73,34 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l67.76"></a><span id="l67.76">         // Non-IANA timezones throw a RangeError.</span>
<a href="#l67.77"></a><span id="l67.77">         cal.WARN(ex);</span>
<a href="#l67.78"></a><span id="l67.78">       }</span>
<a href="#l67.79"></a><span id="l67.79">     }</span>
<a href="#l67.80"></a><span id="l67.80"> </span>
<a href="#l67.81"></a><span id="l67.81">     return formatter.format(cal.dtz.dateTimeToJsDate(aDate));</span>
<a href="#l67.82"></a><span id="l67.82">   },</span>
<a href="#l67.83"></a><span id="l67.83"> </span>
<a href="#l67.84"></a><span id="l67.84" class="difflineminus">-  formatTimeInterval: function(aStartDate, aEndDate) {</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineplus">+  formatTimeInterval(aStartDate, aEndDate) {</span>
<a href="#l67.86"></a><span id="l67.86">     if (!aStartDate &amp;&amp; aEndDate) {</span>
<a href="#l67.87"></a><span id="l67.87">       return this.formatTime(aEndDate);</span>
<a href="#l67.88"></a><span id="l67.88">     }</span>
<a href="#l67.89"></a><span id="l67.89">     if (!aEndDate &amp;&amp; aStartDate) {</span>
<a href="#l67.90"></a><span id="l67.90">       return this.formatTime(aStartDate);</span>
<a href="#l67.91"></a><span id="l67.91">     }</span>
<a href="#l67.92"></a><span id="l67.92">     if (!aStartDate &amp;&amp; !aEndDate) {</span>
<a href="#l67.93"></a><span id="l67.93">       return &quot;&quot;;</span>
<a href="#l67.94"></a><span id="l67.94">     }</span>
<a href="#l67.95"></a><span id="l67.95"> </span>
<a href="#l67.96"></a><span id="l67.96">     // TODO do we need l10n for this?</span>
<a href="#l67.97"></a><span id="l67.97">     // TODO should we check for the same day? The caller should know what</span>
<a href="#l67.98"></a><span id="l67.98">     // he is doing...</span>
<a href="#l67.99"></a><span id="l67.99">     return this.formatTime(aStartDate) + &quot;\u2013&quot; + this.formatTime(aEndDate);</span>
<a href="#l67.100"></a><span id="l67.100">   },</span>
<a href="#l67.101"></a><span id="l67.101"> </span>
<a href="#l67.102"></a><span id="l67.102" class="difflineminus">-  formatInterval: function(aStartDate, aEndDate) {</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineplus">+  formatInterval(aStartDate, aEndDate) {</span>
<a href="#l67.104"></a><span id="l67.104">     // Check for tasks without start and/or due date</span>
<a href="#l67.105"></a><span id="l67.105">     if (aEndDate == null &amp;&amp; aStartDate == null) {</span>
<a href="#l67.106"></a><span id="l67.106">       return cal.l10n.getCalString(&quot;datetimeIntervalTaskWithoutDate&quot;);</span>
<a href="#l67.107"></a><span id="l67.107">     } else if (aEndDate == null) {</span>
<a href="#l67.108"></a><span id="l67.108">       let startDateString = this.formatDate(aStartDate);</span>
<a href="#l67.109"></a><span id="l67.109">       let startTime = this.formatTime(aStartDate);</span>
<a href="#l67.110"></a><span id="l67.110">       return cal.l10n.getCalString(&quot;datetimeIntervalTaskWithoutDueDate&quot;, [</span>
<a href="#l67.111"></a><span id="l67.111">         startDateString,</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineat">@@ -120,117 +119,112 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l67.113"></a><span id="l67.113">     let endDate = aEndDate.getInTimezone(aStartDate.timezone);</span>
<a href="#l67.114"></a><span id="l67.114">     let testdate = aStartDate.clone();</span>
<a href="#l67.115"></a><span id="l67.115">     testdate.isDate = true;</span>
<a href="#l67.116"></a><span id="l67.116">     let sameDay = testdate.compare(endDate) == 0;</span>
<a href="#l67.117"></a><span id="l67.117">     if (aStartDate.isDate) {</span>
<a href="#l67.118"></a><span id="l67.118">       // All-day interval, so we should leave out the time part</span>
<a href="#l67.119"></a><span id="l67.119">       if (sameDay) {</span>
<a href="#l67.120"></a><span id="l67.120">         return this.formatDateLong(aStartDate);</span>
<a href="#l67.121"></a><span id="l67.121" class="difflineminus">-      } else {</span>
<a href="#l67.122"></a><span id="l67.122" class="difflineminus">-        let startDay = this.formatDayWithOrdinal(aStartDate.day);</span>
<a href="#l67.123"></a><span id="l67.123" class="difflineminus">-        let startYear = aStartDate.year;</span>
<a href="#l67.124"></a><span id="l67.124" class="difflineminus">-        let endDay = this.formatDayWithOrdinal(endDate.day);</span>
<a href="#l67.125"></a><span id="l67.125" class="difflineminus">-        let endYear = endDate.year;</span>
<a href="#l67.126"></a><span id="l67.126" class="difflineminus">-        if (aStartDate.year != endDate.year) {</span>
<a href="#l67.127"></a><span id="l67.127" class="difflineminus">-          let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.128"></a><span id="l67.128" class="difflineminus">-            aStartDate.month + 1,</span>
<a href="#l67.129"></a><span id="l67.129" class="difflineminus">-            &quot;calendar&quot;,</span>
<a href="#l67.130"></a><span id="l67.130" class="difflineminus">-            &quot;daysIntervalBetweenYears&quot;</span>
<a href="#l67.131"></a><span id="l67.131" class="difflineminus">-          );</span>
<a href="#l67.132"></a><span id="l67.132" class="difflineminus">-          let endMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.133"></a><span id="l67.133" class="difflineminus">-            aEndDate.month + 1,</span>
<a href="#l67.134"></a><span id="l67.134" class="difflineminus">-            &quot;calendar&quot;,</span>
<a href="#l67.135"></a><span id="l67.135" class="difflineminus">-            &quot;daysIntervalBetweenYears&quot;</span>
<a href="#l67.136"></a><span id="l67.136" class="difflineminus">-          );</span>
<a href="#l67.137"></a><span id="l67.137" class="difflineminus">-          return cal.l10n.getCalString(&quot;daysIntervalBetweenYears&quot;, [</span>
<a href="#l67.138"></a><span id="l67.138" class="difflineminus">-            startMonthName,</span>
<a href="#l67.139"></a><span id="l67.139" class="difflineminus">-            startDay,</span>
<a href="#l67.140"></a><span id="l67.140" class="difflineminus">-            startYear,</span>
<a href="#l67.141"></a><span id="l67.141" class="difflineminus">-            endMonthName,</span>
<a href="#l67.142"></a><span id="l67.142" class="difflineminus">-            endDay,</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineminus">-            endYear,</span>
<a href="#l67.144"></a><span id="l67.144" class="difflineminus">-          ]);</span>
<a href="#l67.145"></a><span id="l67.145" class="difflineminus">-        } else if (aStartDate.month == endDate.month) {</span>
<a href="#l67.146"></a><span id="l67.146" class="difflineminus">-          let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.147"></a><span id="l67.147" class="difflineminus">-            aStartDate.month + 1,</span>
<a href="#l67.148"></a><span id="l67.148" class="difflineminus">-            &quot;calendar&quot;,</span>
<a href="#l67.149"></a><span id="l67.149" class="difflineminus">-            &quot;daysIntervalInMonth&quot;</span>
<a href="#l67.150"></a><span id="l67.150" class="difflineminus">-          );</span>
<a href="#l67.151"></a><span id="l67.151" class="difflineminus">-          return cal.l10n.getCalString(&quot;daysIntervalInMonth&quot;, [</span>
<a href="#l67.152"></a><span id="l67.152" class="difflineminus">-            startMonthName,</span>
<a href="#l67.153"></a><span id="l67.153" class="difflineminus">-            startDay,</span>
<a href="#l67.154"></a><span id="l67.154" class="difflineminus">-            endDay,</span>
<a href="#l67.155"></a><span id="l67.155" class="difflineminus">-            endYear,</span>
<a href="#l67.156"></a><span id="l67.156" class="difflineminus">-          ]);</span>
<a href="#l67.157"></a><span id="l67.157" class="difflineminus">-        } else {</span>
<a href="#l67.158"></a><span id="l67.158" class="difflineminus">-          let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.159"></a><span id="l67.159" class="difflineminus">-            aStartDate.month + 1,</span>
<a href="#l67.160"></a><span id="l67.160" class="difflineminus">-            &quot;calendar&quot;,</span>
<a href="#l67.161"></a><span id="l67.161" class="difflineminus">-            &quot;daysIntervalBetweenMonths&quot;</span>
<a href="#l67.162"></a><span id="l67.162" class="difflineminus">-          );</span>
<a href="#l67.163"></a><span id="l67.163" class="difflineminus">-          let endMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.164"></a><span id="l67.164" class="difflineminus">-            aEndDate.month + 1,</span>
<a href="#l67.165"></a><span id="l67.165" class="difflineminus">-            &quot;calendar&quot;,</span>
<a href="#l67.166"></a><span id="l67.166" class="difflineminus">-            &quot;daysIntervalBetweenMonths&quot;</span>
<a href="#l67.167"></a><span id="l67.167" class="difflineminus">-          );</span>
<a href="#l67.168"></a><span id="l67.168" class="difflineminus">-          return cal.l10n.getCalString(&quot;daysIntervalBetweenMonths&quot;, [</span>
<a href="#l67.169"></a><span id="l67.169" class="difflineminus">-            startMonthName,</span>
<a href="#l67.170"></a><span id="l67.170" class="difflineminus">-            startDay,</span>
<a href="#l67.171"></a><span id="l67.171" class="difflineminus">-            endMonthName,</span>
<a href="#l67.172"></a><span id="l67.172" class="difflineminus">-            endDay,</span>
<a href="#l67.173"></a><span id="l67.173" class="difflineminus">-            endYear,</span>
<a href="#l67.174"></a><span id="l67.174" class="difflineminus">-          ]);</span>
<a href="#l67.175"></a><span id="l67.175" class="difflineminus">-        }</span>
<a href="#l67.176"></a><span id="l67.176">       }</span>
<a href="#l67.177"></a><span id="l67.177" class="difflineminus">-    } else {</span>
<a href="#l67.178"></a><span id="l67.178" class="difflineminus">-      let startDateString = this.formatDate(aStartDate);</span>
<a href="#l67.179"></a><span id="l67.179" class="difflineminus">-      let startTime = this.formatTime(aStartDate);</span>
<a href="#l67.180"></a><span id="l67.180" class="difflineminus">-      let endDateString = this.formatDate(endDate);</span>
<a href="#l67.181"></a><span id="l67.181" class="difflineminus">-      let endTime = this.formatTime(endDate);</span>
<a href="#l67.182"></a><span id="l67.182" class="difflineminus">-      // non-allday, so need to return date and time</span>
<a href="#l67.183"></a><span id="l67.183" class="difflineminus">-      if (sameDay) {</span>
<a href="#l67.184"></a><span id="l67.184" class="difflineminus">-        // End is on the same day as start, so we can leave out the end date</span>
<a href="#l67.185"></a><span id="l67.185" class="difflineminus">-        if (startTime == endTime) {</span>
<a href="#l67.186"></a><span id="l67.186" class="difflineminus">-          // End time is on the same time as start, so we can leave out the end time</span>
<a href="#l67.187"></a><span id="l67.187" class="difflineminus">-          // &quot;5 Jan 2006 13:00&quot;</span>
<a href="#l67.188"></a><span id="l67.188" class="difflineminus">-          return cal.l10n.getCalString(&quot;datetimeIntervalOnSameDateTime&quot;, [</span>
<a href="#l67.189"></a><span id="l67.189" class="difflineminus">-            startDateString,</span>
<a href="#l67.190"></a><span id="l67.190" class="difflineminus">-            startTime,</span>
<a href="#l67.191"></a><span id="l67.191" class="difflineminus">-          ]);</span>
<a href="#l67.192"></a><span id="l67.192" class="difflineminus">-        } else {</span>
<a href="#l67.193"></a><span id="l67.193" class="difflineminus">-          // still include end time</span>
<a href="#l67.194"></a><span id="l67.194" class="difflineminus">-          // &quot;5 Jan 2006 13:00 - 17:00&quot;</span>
<a href="#l67.195"></a><span id="l67.195" class="difflineminus">-          return cal.l10n.getCalString(&quot;datetimeIntervalOnSameDay&quot;, [</span>
<a href="#l67.196"></a><span id="l67.196" class="difflineminus">-            startDateString,</span>
<a href="#l67.197"></a><span id="l67.197" class="difflineminus">-            startTime,</span>
<a href="#l67.198"></a><span id="l67.198" class="difflineminus">-            endTime,</span>
<a href="#l67.199"></a><span id="l67.199" class="difflineminus">-          ]);</span>
<a href="#l67.200"></a><span id="l67.200" class="difflineminus">-        }</span>
<a href="#l67.201"></a><span id="l67.201" class="difflineminus">-      } else {</span>
<a href="#l67.202"></a><span id="l67.202" class="difflineminus">-        // Spanning multiple days, so need to include date and time</span>
<a href="#l67.203"></a><span id="l67.203" class="difflineminus">-        // for start and end</span>
<a href="#l67.204"></a><span id="l67.204" class="difflineminus">-        // &quot;5 Jan 2006 13:00 - 7 Jan 2006 9:00&quot;</span>
<a href="#l67.205"></a><span id="l67.205" class="difflineminus">-        return cal.l10n.getCalString(&quot;datetimeIntervalOnSeveralDays&quot;, [</span>
<a href="#l67.206"></a><span id="l67.206" class="difflineplus">+      let startDay = this.formatDayWithOrdinal(aStartDate.day);</span>
<a href="#l67.207"></a><span id="l67.207" class="difflineplus">+      let startYear = aStartDate.year;</span>
<a href="#l67.208"></a><span id="l67.208" class="difflineplus">+      let endDay = this.formatDayWithOrdinal(endDate.day);</span>
<a href="#l67.209"></a><span id="l67.209" class="difflineplus">+      let endYear = endDate.year;</span>
<a href="#l67.210"></a><span id="l67.210" class="difflineplus">+      if (aStartDate.year != endDate.year) {</span>
<a href="#l67.211"></a><span id="l67.211" class="difflineplus">+        let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.212"></a><span id="l67.212" class="difflineplus">+          aStartDate.month + 1,</span>
<a href="#l67.213"></a><span id="l67.213" class="difflineplus">+          &quot;calendar&quot;,</span>
<a href="#l67.214"></a><span id="l67.214" class="difflineplus">+          &quot;daysIntervalBetweenYears&quot;</span>
<a href="#l67.215"></a><span id="l67.215" class="difflineplus">+        );</span>
<a href="#l67.216"></a><span id="l67.216" class="difflineplus">+        let endMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.217"></a><span id="l67.217" class="difflineplus">+          aEndDate.month + 1,</span>
<a href="#l67.218"></a><span id="l67.218" class="difflineplus">+          &quot;calendar&quot;,</span>
<a href="#l67.219"></a><span id="l67.219" class="difflineplus">+          &quot;daysIntervalBetweenYears&quot;</span>
<a href="#l67.220"></a><span id="l67.220" class="difflineplus">+        );</span>
<a href="#l67.221"></a><span id="l67.221" class="difflineplus">+        return cal.l10n.getCalString(&quot;daysIntervalBetweenYears&quot;, [</span>
<a href="#l67.222"></a><span id="l67.222" class="difflineplus">+          startMonthName,</span>
<a href="#l67.223"></a><span id="l67.223" class="difflineplus">+          startDay,</span>
<a href="#l67.224"></a><span id="l67.224" class="difflineplus">+          startYear,</span>
<a href="#l67.225"></a><span id="l67.225" class="difflineplus">+          endMonthName,</span>
<a href="#l67.226"></a><span id="l67.226" class="difflineplus">+          endDay,</span>
<a href="#l67.227"></a><span id="l67.227" class="difflineplus">+          endYear,</span>
<a href="#l67.228"></a><span id="l67.228" class="difflineplus">+        ]);</span>
<a href="#l67.229"></a><span id="l67.229" class="difflineplus">+      } else if (aStartDate.month == endDate.month) {</span>
<a href="#l67.230"></a><span id="l67.230" class="difflineplus">+        let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.231"></a><span id="l67.231" class="difflineplus">+          aStartDate.month + 1,</span>
<a href="#l67.232"></a><span id="l67.232" class="difflineplus">+          &quot;calendar&quot;,</span>
<a href="#l67.233"></a><span id="l67.233" class="difflineplus">+          &quot;daysIntervalInMonth&quot;</span>
<a href="#l67.234"></a><span id="l67.234" class="difflineplus">+        );</span>
<a href="#l67.235"></a><span id="l67.235" class="difflineplus">+        return cal.l10n.getCalString(&quot;daysIntervalInMonth&quot;, [</span>
<a href="#l67.236"></a><span id="l67.236" class="difflineplus">+          startMonthName,</span>
<a href="#l67.237"></a><span id="l67.237" class="difflineplus">+          startDay,</span>
<a href="#l67.238"></a><span id="l67.238" class="difflineplus">+          endDay,</span>
<a href="#l67.239"></a><span id="l67.239" class="difflineplus">+          endYear,</span>
<a href="#l67.240"></a><span id="l67.240" class="difflineplus">+        ]);</span>
<a href="#l67.241"></a><span id="l67.241" class="difflineplus">+      }</span>
<a href="#l67.242"></a><span id="l67.242" class="difflineplus">+      let startMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.243"></a><span id="l67.243" class="difflineplus">+        aStartDate.month + 1,</span>
<a href="#l67.244"></a><span id="l67.244" class="difflineplus">+        &quot;calendar&quot;,</span>
<a href="#l67.245"></a><span id="l67.245" class="difflineplus">+        &quot;daysIntervalBetweenMonths&quot;</span>
<a href="#l67.246"></a><span id="l67.246" class="difflineplus">+      );</span>
<a href="#l67.247"></a><span id="l67.247" class="difflineplus">+      let endMonthName = cal.l10n.formatMonth(</span>
<a href="#l67.248"></a><span id="l67.248" class="difflineplus">+        aEndDate.month + 1,</span>
<a href="#l67.249"></a><span id="l67.249" class="difflineplus">+        &quot;calendar&quot;,</span>
<a href="#l67.250"></a><span id="l67.250" class="difflineplus">+        &quot;daysIntervalBetweenMonths&quot;</span>
<a href="#l67.251"></a><span id="l67.251" class="difflineplus">+      );</span>
<a href="#l67.252"></a><span id="l67.252" class="difflineplus">+      return cal.l10n.getCalString(&quot;daysIntervalBetweenMonths&quot;, [</span>
<a href="#l67.253"></a><span id="l67.253" class="difflineplus">+        startMonthName,</span>
<a href="#l67.254"></a><span id="l67.254" class="difflineplus">+        startDay,</span>
<a href="#l67.255"></a><span id="l67.255" class="difflineplus">+        endMonthName,</span>
<a href="#l67.256"></a><span id="l67.256" class="difflineplus">+        endDay,</span>
<a href="#l67.257"></a><span id="l67.257" class="difflineplus">+        endYear,</span>
<a href="#l67.258"></a><span id="l67.258" class="difflineplus">+      ]);</span>
<a href="#l67.259"></a><span id="l67.259" class="difflineplus">+    }</span>
<a href="#l67.260"></a><span id="l67.260" class="difflineplus">+    let startDateString = this.formatDate(aStartDate);</span>
<a href="#l67.261"></a><span id="l67.261" class="difflineplus">+    let startTime = this.formatTime(aStartDate);</span>
<a href="#l67.262"></a><span id="l67.262" class="difflineplus">+    let endDateString = this.formatDate(endDate);</span>
<a href="#l67.263"></a><span id="l67.263" class="difflineplus">+    let endTime = this.formatTime(endDate);</span>
<a href="#l67.264"></a><span id="l67.264" class="difflineplus">+    // non-allday, so need to return date and time</span>
<a href="#l67.265"></a><span id="l67.265" class="difflineplus">+    if (sameDay) {</span>
<a href="#l67.266"></a><span id="l67.266" class="difflineplus">+      // End is on the same day as start, so we can leave out the end date</span>
<a href="#l67.267"></a><span id="l67.267" class="difflineplus">+      if (startTime == endTime) {</span>
<a href="#l67.268"></a><span id="l67.268" class="difflineplus">+        // End time is on the same time as start, so we can leave out the end time</span>
<a href="#l67.269"></a><span id="l67.269" class="difflineplus">+        // &quot;5 Jan 2006 13:00&quot;</span>
<a href="#l67.270"></a><span id="l67.270" class="difflineplus">+        return cal.l10n.getCalString(&quot;datetimeIntervalOnSameDateTime&quot;, [</span>
<a href="#l67.271"></a><span id="l67.271">           startDateString,</span>
<a href="#l67.272"></a><span id="l67.272">           startTime,</span>
<a href="#l67.273"></a><span id="l67.273" class="difflineminus">-          endDateString,</span>
<a href="#l67.274"></a><span id="l67.274" class="difflineminus">-          endTime,</span>
<a href="#l67.275"></a><span id="l67.275">         ]);</span>
<a href="#l67.276"></a><span id="l67.276">       }</span>
<a href="#l67.277"></a><span id="l67.277" class="difflineplus">+      // still include end time</span>
<a href="#l67.278"></a><span id="l67.278" class="difflineplus">+      // &quot;5 Jan 2006 13:00 - 17:00&quot;</span>
<a href="#l67.279"></a><span id="l67.279" class="difflineplus">+      return cal.l10n.getCalString(&quot;datetimeIntervalOnSameDay&quot;, [</span>
<a href="#l67.280"></a><span id="l67.280" class="difflineplus">+        startDateString,</span>
<a href="#l67.281"></a><span id="l67.281" class="difflineplus">+        startTime,</span>
<a href="#l67.282"></a><span id="l67.282" class="difflineplus">+        endTime,</span>
<a href="#l67.283"></a><span id="l67.283" class="difflineplus">+      ]);</span>
<a href="#l67.284"></a><span id="l67.284">     }</span>
<a href="#l67.285"></a><span id="l67.285" class="difflineplus">+    // Spanning multiple days, so need to include date and time</span>
<a href="#l67.286"></a><span id="l67.286" class="difflineplus">+    // for start and end</span>
<a href="#l67.287"></a><span id="l67.287" class="difflineplus">+    // &quot;5 Jan 2006 13:00 - 7 Jan 2006 9:00&quot;</span>
<a href="#l67.288"></a><span id="l67.288" class="difflineplus">+    return cal.l10n.getCalString(&quot;datetimeIntervalOnSeveralDays&quot;, [</span>
<a href="#l67.289"></a><span id="l67.289" class="difflineplus">+      startDateString,</span>
<a href="#l67.290"></a><span id="l67.290" class="difflineplus">+      startTime,</span>
<a href="#l67.291"></a><span id="l67.291" class="difflineplus">+      endDateString,</span>
<a href="#l67.292"></a><span id="l67.292" class="difflineplus">+      endTime,</span>
<a href="#l67.293"></a><span id="l67.293" class="difflineplus">+    ]);</span>
<a href="#l67.294"></a><span id="l67.294">   },</span>
<a href="#l67.295"></a><span id="l67.295"> </span>
<a href="#l67.296"></a><span id="l67.296" class="difflineminus">-  formatDayWithOrdinal: function(aDay) {</span>
<a href="#l67.297"></a><span id="l67.297" class="difflineplus">+  formatDayWithOrdinal(aDay) {</span>
<a href="#l67.298"></a><span id="l67.298">     let ordinalSymbols = this.mDateStringBundle.GetStringFromName(&quot;dayOrdinalSymbol&quot;).split(&quot;,&quot;);</span>
<a href="#l67.299"></a><span id="l67.299">     let dayOrdinalSymbol = ordinalSymbols[aDay - 1] || ordinalSymbols[0];</span>
<a href="#l67.300"></a><span id="l67.300">     return aDay + dayOrdinalSymbol;</span>
<a href="#l67.301"></a><span id="l67.301">   },</span>
<a href="#l67.302"></a><span id="l67.302"> </span>
<a href="#l67.303"></a><span id="l67.303" class="difflineminus">-  _getItemDates: function(aItem) {</span>
<a href="#l67.304"></a><span id="l67.304" class="difflineplus">+  _getItemDates(aItem) {</span>
<a href="#l67.305"></a><span id="l67.305">     let start = aItem[cal.dtz.startDateProp(aItem)];</span>
<a href="#l67.306"></a><span id="l67.306">     let end = aItem[cal.dtz.endDateProp(aItem)];</span>
<a href="#l67.307"></a><span id="l67.307">     let kDefaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l67.308"></a><span id="l67.308">     // Check for tasks without start and/or due date</span>
<a href="#l67.309"></a><span id="l67.309">     if (start) {</span>
<a href="#l67.310"></a><span id="l67.310">       start = start.getInTimezone(kDefaultTimezone);</span>
<a href="#l67.311"></a><span id="l67.311">     }</span>
<a href="#l67.312"></a><span id="l67.312">     if (end) {</span>
<a href="#l67.313"></a><span id="l67.313" class="difflineat">@@ -240,36 +234,36 @@ calDateTimeFormatter.prototype = {</span>
<a href="#l67.314"></a><span id="l67.314">     // to get into a format that's understandable.</span>
<a href="#l67.315"></a><span id="l67.315">     if (start &amp;&amp; start.isDate &amp;&amp; end) {</span>
<a href="#l67.316"></a><span id="l67.316">       end.day -= 1;</span>
<a href="#l67.317"></a><span id="l67.317">     }</span>
<a href="#l67.318"></a><span id="l67.318"> </span>
<a href="#l67.319"></a><span id="l67.319">     return [start, end];</span>
<a href="#l67.320"></a><span id="l67.320">   },</span>
<a href="#l67.321"></a><span id="l67.321"> </span>
<a href="#l67.322"></a><span id="l67.322" class="difflineminus">-  formatItemInterval: function(aItem) {</span>
<a href="#l67.323"></a><span id="l67.323" class="difflineplus">+  formatItemInterval(aItem) {</span>
<a href="#l67.324"></a><span id="l67.324">     return this.formatInterval(...this._getItemDates(aItem));</span>
<a href="#l67.325"></a><span id="l67.325">   },</span>
<a href="#l67.326"></a><span id="l67.326"> </span>
<a href="#l67.327"></a><span id="l67.327" class="difflineminus">-  formatItemTimeInterval: function(aItem) {</span>
<a href="#l67.328"></a><span id="l67.328" class="difflineplus">+  formatItemTimeInterval(aItem) {</span>
<a href="#l67.329"></a><span id="l67.329">     return this.formatTimeInterval(...this._getItemDates(aItem));</span>
<a href="#l67.330"></a><span id="l67.330">   },</span>
<a href="#l67.331"></a><span id="l67.331"> </span>
<a href="#l67.332"></a><span id="l67.332" class="difflineminus">-  monthName: function(aMonthIndex) {</span>
<a href="#l67.333"></a><span id="l67.333" class="difflineplus">+  monthName(aMonthIndex) {</span>
<a href="#l67.334"></a><span id="l67.334">     let oneBasedMonthIndex = aMonthIndex + 1;</span>
<a href="#l67.335"></a><span id="l67.335">     return this.mDateStringBundle.GetStringFromName(&quot;month.&quot; + oneBasedMonthIndex + &quot;.name&quot;);</span>
<a href="#l67.336"></a><span id="l67.336">   },</span>
<a href="#l67.337"></a><span id="l67.337"> </span>
<a href="#l67.338"></a><span id="l67.338" class="difflineminus">-  shortMonthName: function(aMonthIndex) {</span>
<a href="#l67.339"></a><span id="l67.339" class="difflineplus">+  shortMonthName(aMonthIndex) {</span>
<a href="#l67.340"></a><span id="l67.340">     let oneBasedMonthIndex = aMonthIndex + 1;</span>
<a href="#l67.341"></a><span id="l67.341">     return this.mDateStringBundle.GetStringFromName(&quot;month.&quot; + oneBasedMonthIndex + &quot;.Mmm&quot;);</span>
<a href="#l67.342"></a><span id="l67.342">   },</span>
<a href="#l67.343"></a><span id="l67.343"> </span>
<a href="#l67.344"></a><span id="l67.344" class="difflineminus">-  dayName: function(aDayIndex) {</span>
<a href="#l67.345"></a><span id="l67.345" class="difflineplus">+  dayName(aDayIndex) {</span>
<a href="#l67.346"></a><span id="l67.346">     let oneBasedDayIndex = aDayIndex + 1;</span>
<a href="#l67.347"></a><span id="l67.347">     return this.mDateStringBundle.GetStringFromName(&quot;day.&quot; + oneBasedDayIndex + &quot;.name&quot;);</span>
<a href="#l67.348"></a><span id="l67.348">   },</span>
<a href="#l67.349"></a><span id="l67.349"> </span>
<a href="#l67.350"></a><span id="l67.350" class="difflineminus">-  shortDayName: function(aDayIndex) {</span>
<a href="#l67.351"></a><span id="l67.351" class="difflineplus">+  shortDayName(aDayIndex) {</span>
<a href="#l67.352"></a><span id="l67.352">     let oneBasedDayIndex = aDayIndex + 1;</span>
<a href="#l67.353"></a><span id="l67.353">     return this.mDateStringBundle.GetStringFromName(&quot;day.&quot; + oneBasedDayIndex + &quot;.Mmm&quot;);</span>
<a href="#l67.354"></a><span id="l67.354">   },</span>
<a href="#l67.355"></a><span id="l67.355"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/calendar/base/src/calDefaultACLManager.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -12,29 +12,29 @@ function calDefaultACLManager() {</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5"> calDefaultACLManager.prototype = {</span>
<a href="#l68.6"></a><span id="l68.6">   QueryInterface: ChromeUtils.generateQI([Ci.calICalendarACLManager]),</span>
<a href="#l68.7"></a><span id="l68.7">   classID: Components.ID(&quot;{7463258c-6ef3-40a2-89a9-bb349596e927}&quot;),</span>
<a href="#l68.8"></a><span id="l68.8"> </span>
<a href="#l68.9"></a><span id="l68.9">   mCalendarEntries: null,</span>
<a href="#l68.10"></a><span id="l68.10"> </span>
<a href="#l68.11"></a><span id="l68.11">   /* calICalendarACLManager */</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-  _getCalendarEntryCached: function(aCalendar) {</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+  _getCalendarEntryCached(aCalendar) {</span>
<a href="#l68.14"></a><span id="l68.14">     let calUri = aCalendar.uri.spec;</span>
<a href="#l68.15"></a><span id="l68.15">     if (!(calUri in this.mCalendarEntries)) {</span>
<a href="#l68.16"></a><span id="l68.16">       this.mCalendarEntries[calUri] = new calDefaultCalendarACLEntry(this, aCalendar);</span>
<a href="#l68.17"></a><span id="l68.17">     }</span>
<a href="#l68.18"></a><span id="l68.18"> </span>
<a href="#l68.19"></a><span id="l68.19">     return this.mCalendarEntries[calUri];</span>
<a href="#l68.20"></a><span id="l68.20">   },</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineminus">-  getCalendarEntry: function(aCalendar, aListener) {</span>
<a href="#l68.22"></a><span id="l68.22" class="difflineplus">+  getCalendarEntry(aCalendar, aListener) {</span>
<a href="#l68.23"></a><span id="l68.23">     let entry = this._getCalendarEntryCached(aCalendar);</span>
<a href="#l68.24"></a><span id="l68.24">     aListener.onOperationComplete(aCalendar, Cr.NS_OK, Ci.calIOperationListener.GET, null, entry);</span>
<a href="#l68.25"></a><span id="l68.25">   },</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineminus">-  getItemEntry: function(aItem) {</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineplus">+  getItemEntry(aItem) {</span>
<a href="#l68.28"></a><span id="l68.28">     let calEntry = this._getCalendarEntryCached(aItem.calendar);</span>
<a href="#l68.29"></a><span id="l68.29">     return new calDefaultItemACLEntry(calEntry);</span>
<a href="#l68.30"></a><span id="l68.30">   },</span>
<a href="#l68.31"></a><span id="l68.31"> };</span>
<a href="#l68.32"></a><span id="l68.32"> </span>
<a href="#l68.33"></a><span id="l68.33"> function calDefaultCalendarACLEntry(aMgr, aCalendar) {</span>
<a href="#l68.34"></a><span id="l68.34">   this.mACLManager = aMgr;</span>
<a href="#l68.35"></a><span id="l68.35">   this.mCalendar = aCalendar;</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineat">@@ -50,41 +50,40 @@ calDefaultCalendarACLEntry.prototype = {</span>
<a href="#l68.37"></a><span id="l68.37">     return this.mACLManager;</span>
<a href="#l68.38"></a><span id="l68.38">   },</span>
<a href="#l68.39"></a><span id="l68.39"> </span>
<a href="#l68.40"></a><span id="l68.40">   hasAccessControl: false,</span>
<a href="#l68.41"></a><span id="l68.41">   userIsOwner: true,</span>
<a href="#l68.42"></a><span id="l68.42">   userCanAddItems: true,</span>
<a href="#l68.43"></a><span id="l68.43">   userCanDeleteItems: true,</span>
<a href="#l68.44"></a><span id="l68.44"> </span>
<a href="#l68.45"></a><span id="l68.45" class="difflineminus">-  _getIdentities: function() {</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineplus">+  _getIdentities() {</span>
<a href="#l68.47"></a><span id="l68.47">     let identities = [];</span>
<a href="#l68.48"></a><span id="l68.48">     cal.email.iterateIdentities(id =&gt; identities.push(id));</span>
<a href="#l68.49"></a><span id="l68.49">     return identities;</span>
<a href="#l68.50"></a><span id="l68.50">   },</span>
<a href="#l68.51"></a><span id="l68.51"> </span>
<a href="#l68.52"></a><span id="l68.52" class="difflineminus">-  getUserAddresses: function() {</span>
<a href="#l68.53"></a><span id="l68.53" class="difflineplus">+  getUserAddresses() {</span>
<a href="#l68.54"></a><span id="l68.54">     let identities = this.getUserIdentities();</span>
<a href="#l68.55"></a><span id="l68.55">     let addresses = identities.map(id =&gt; id.email);</span>
<a href="#l68.56"></a><span id="l68.56">     return addresses;</span>
<a href="#l68.57"></a><span id="l68.57">   },</span>
<a href="#l68.58"></a><span id="l68.58"> </span>
<a href="#l68.59"></a><span id="l68.59" class="difflineminus">-  getUserIdentities: function() {</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+  getUserIdentities() {</span>
<a href="#l68.61"></a><span id="l68.61">     let identity = cal.provider.getEmailIdentityOfCalendar(this.mCalendar);</span>
<a href="#l68.62"></a><span id="l68.62">     if (identity) {</span>
<a href="#l68.63"></a><span id="l68.63">       return [identity];</span>
<a href="#l68.64"></a><span id="l68.64" class="difflineminus">-    } else {</span>
<a href="#l68.65"></a><span id="l68.65" class="difflineminus">-      return this._getIdentities();</span>
<a href="#l68.66"></a><span id="l68.66">     }</span>
<a href="#l68.67"></a><span id="l68.67" class="difflineplus">+    return this._getIdentities();</span>
<a href="#l68.68"></a><span id="l68.68">   },</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineminus">-  getOwnerIdentities: function() {</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineplus">+  getOwnerIdentities() {</span>
<a href="#l68.71"></a><span id="l68.71">     return this._getIdentities();</span>
<a href="#l68.72"></a><span id="l68.72">   },</span>
<a href="#l68.73"></a><span id="l68.73"> </span>
<a href="#l68.74"></a><span id="l68.74" class="difflineminus">-  refresh: function() {},</span>
<a href="#l68.75"></a><span id="l68.75" class="difflineplus">+  refresh() {},</span>
<a href="#l68.76"></a><span id="l68.76"> };</span>
<a href="#l68.77"></a><span id="l68.77"> </span>
<a href="#l68.78"></a><span id="l68.78"> function calDefaultItemACLEntry(aCalendarEntry) {</span>
<a href="#l68.79"></a><span id="l68.79">   this.calendarEntry = aCalendarEntry;</span>
<a href="#l68.80"></a><span id="l68.80"> }</span>
<a href="#l68.81"></a><span id="l68.81"> </span>
<a href="#l68.82"></a><span id="l68.82"> calDefaultItemACLEntry.prototype = {</span>
<a href="#l68.83"></a><span id="l68.83">   QueryInterface: ChromeUtils.generateQI([Ci.calIItemACLEntry]),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/calendar/base/src/calDeletedItems.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/calendar/base/src/calDeletedItems.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -12,19 +12,19 @@ var { FileUtils } = ChromeUtils.import(&quot;</span>
<a href="#l69.4"></a><span id="l69.4">  * This is (currently) not a real trashcan. Only ids and time deleted is stored.</span>
<a href="#l69.5"></a><span id="l69.5">  * Note also that the code doesn't strictly check the calendar of the item,</span>
<a href="#l69.6"></a><span id="l69.6">  * except when a calendar id is passed to getDeletedDate.</span>
<a href="#l69.7"></a><span id="l69.7">  */</span>
<a href="#l69.8"></a><span id="l69.8"> function calDeletedItems() {</span>
<a href="#l69.9"></a><span id="l69.9">   this.wrappedJSObject = this;</span>
<a href="#l69.10"></a><span id="l69.10"> </span>
<a href="#l69.11"></a><span id="l69.11">   this.completedNotifier = {</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-    handleResult: function() {},</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineminus">-    handleError: function() {},</span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-    handleCompletion: function() {},</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+    handleResult() {},</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+    handleError() {},</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+    handleCompletion() {},</span>
<a href="#l69.18"></a><span id="l69.18">   };</span>
<a href="#l69.19"></a><span id="l69.19"> }</span>
<a href="#l69.20"></a><span id="l69.20"> </span>
<a href="#l69.21"></a><span id="l69.21"> var calDeletedItemsClassID = Components.ID(&quot;{8e6799af-e7e9-4e6c-9a82-a2413e86d8c3}&quot;);</span>
<a href="#l69.22"></a><span id="l69.22"> var calDeletedItemsInterfaces = [Ci.calIDeletedItems, Ci.nsIObserver, Ci.calIObserver];</span>
<a href="#l69.23"></a><span id="l69.23"> calDeletedItems.prototype = {</span>
<a href="#l69.24"></a><span id="l69.24">   classID: calDeletedItemsClassID,</span>
<a href="#l69.25"></a><span id="l69.25">   QueryInterface: cal.generateQI(calDeletedItemsInterfaces),</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineat">@@ -39,23 +39,23 @@ calDeletedItems.prototype = {</span>
<a href="#l69.27"></a><span id="l69.27">   DB_SCHEMA_VERSION: 1,</span>
<a href="#l69.28"></a><span id="l69.28">   STALE_TIME: (30 * 24 * 60 * 60) / 1000 /* 30 days */,</span>
<a href="#l69.29"></a><span id="l69.29"> </span>
<a href="#l69.30"></a><span id="l69.30">   // To make the tests more failsafe, we have an internal notifier function.</span>
<a href="#l69.31"></a><span id="l69.31">   // As the deleted items store is just meant to be a hint, this should not</span>
<a href="#l69.32"></a><span id="l69.32">   // be used in real code.</span>
<a href="#l69.33"></a><span id="l69.33">   completedNotifier: null,</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35" class="difflineminus">-  flush: function() {</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+  flush() {</span>
<a href="#l69.37"></a><span id="l69.37">     this.ensureStatements();</span>
<a href="#l69.38"></a><span id="l69.38">     this.stmtFlush.params.stale_time = cal.dtz.now().nativeTime - this.STALE_TIME;</span>
<a href="#l69.39"></a><span id="l69.39">     this.stmtFlush.executeAsync(this.completedNotifier);</span>
<a href="#l69.40"></a><span id="l69.40">   },</span>
<a href="#l69.41"></a><span id="l69.41"> </span>
<a href="#l69.42"></a><span id="l69.42" class="difflineminus">-  getDeletedDate: function(aId, aCalId) {</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+  getDeletedDate(aId, aCalId) {</span>
<a href="#l69.44"></a><span id="l69.44">     this.ensureStatements();</span>
<a href="#l69.45"></a><span id="l69.45">     let stmt;</span>
<a href="#l69.46"></a><span id="l69.46">     if (aCalId) {</span>
<a href="#l69.47"></a><span id="l69.47">       stmt = this.stmtGetWithCal;</span>
<a href="#l69.48"></a><span id="l69.48">       stmt.params.calId = aCalId;</span>
<a href="#l69.49"></a><span id="l69.49">     } else {</span>
<a href="#l69.50"></a><span id="l69.50">       stmt = this.stmtGet;</span>
<a href="#l69.51"></a><span id="l69.51">     }</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineat">@@ -70,32 +70,32 @@ calDeletedItems.prototype = {</span>
<a href="#l69.53"></a><span id="l69.53">     } catch (e) {</span>
<a href="#l69.54"></a><span id="l69.54">       cal.ERROR(e);</span>
<a href="#l69.55"></a><span id="l69.55">     } finally {</span>
<a href="#l69.56"></a><span id="l69.56">       stmt.reset();</span>
<a href="#l69.57"></a><span id="l69.57">     }</span>
<a href="#l69.58"></a><span id="l69.58">     return null;</span>
<a href="#l69.59"></a><span id="l69.59">   },</span>
<a href="#l69.60"></a><span id="l69.60"> </span>
<a href="#l69.61"></a><span id="l69.61" class="difflineminus">-  markDeleted: function(aItem) {</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+  markDeleted(aItem) {</span>
<a href="#l69.63"></a><span id="l69.63">     this.ensureStatements();</span>
<a href="#l69.64"></a><span id="l69.64">     this.stmtMarkDelete.params.calId = aItem.calendar.id;</span>
<a href="#l69.65"></a><span id="l69.65">     this.stmtMarkDelete.params.id = aItem.id;</span>
<a href="#l69.66"></a><span id="l69.66">     this.stmtMarkDelete.params.time = cal.dtz.now().nativeTime;</span>
<a href="#l69.67"></a><span id="l69.67">     this.stmtMarkDelete.params.rid = (aItem.recurrenceId &amp;&amp; aItem.recurrenceId.nativeTime) || &quot;&quot;;</span>
<a href="#l69.68"></a><span id="l69.68">     this.stmtMarkDelete.executeAsync(this.completedNotifier);</span>
<a href="#l69.69"></a><span id="l69.69">   },</span>
<a href="#l69.70"></a><span id="l69.70"> </span>
<a href="#l69.71"></a><span id="l69.71" class="difflineminus">-  unmarkDeleted: function(aItem) {</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineplus">+  unmarkDeleted(aItem) {</span>
<a href="#l69.73"></a><span id="l69.73">     this.ensureStatements();</span>
<a href="#l69.74"></a><span id="l69.74">     this.stmtUnmarkDelete.params.id = aItem.id;</span>
<a href="#l69.75"></a><span id="l69.75">     this.stmtUnmarkDelete.executeAsync(this.completedNotifier);</span>
<a href="#l69.76"></a><span id="l69.76">   },</span>
<a href="#l69.77"></a><span id="l69.77"> </span>
<a href="#l69.78"></a><span id="l69.78" class="difflineminus">-  initDB: function() {</span>
<a href="#l69.79"></a><span id="l69.79" class="difflineplus">+  initDB() {</span>
<a href="#l69.80"></a><span id="l69.80">     if (this.mDB) {</span>
<a href="#l69.81"></a><span id="l69.81">       // Looks like we've already initialized, exit early</span>
<a href="#l69.82"></a><span id="l69.82">       return;</span>
<a href="#l69.83"></a><span id="l69.83">     }</span>
<a href="#l69.84"></a><span id="l69.84"> </span>
<a href="#l69.85"></a><span id="l69.85">     let file = FileUtils.getFile(&quot;ProfD&quot;, [&quot;calendar-data&quot;, &quot;deleted.sqlite&quot;]);</span>
<a href="#l69.86"></a><span id="l69.86">     this.mDB = Services.storage.openDatabase(file);</span>
<a href="#l69.87"></a><span id="l69.87"> </span>
<a href="#l69.88"></a><span id="l69.88" class="difflineat">@@ -112,25 +112,25 @@ calDeletedItems.prototype = {</span>
<a href="#l69.89"></a><span id="l69.89">     }</span>
<a href="#l69.90"></a><span id="l69.90"> </span>
<a href="#l69.91"></a><span id="l69.91">     // We will not init the statements now, we can still do that the</span>
<a href="#l69.92"></a><span id="l69.92">     // first time this interface is used. What we should do though is</span>
<a href="#l69.93"></a><span id="l69.93">     // to clean up at shutdown</span>
<a href="#l69.94"></a><span id="l69.94">     cal.addShutdownObserver(this.shutdown.bind(this));</span>
<a href="#l69.95"></a><span id="l69.95">   },</span>
<a href="#l69.96"></a><span id="l69.96"> </span>
<a href="#l69.97"></a><span id="l69.97" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l69.98"></a><span id="l69.98" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l69.99"></a><span id="l69.99">     if (aTopic == &quot;profile-after-change&quot;) {</span>
<a href="#l69.100"></a><span id="l69.100">       // Make sure to observe calendar changes so we know when things are</span>
<a href="#l69.101"></a><span id="l69.101">       // deleted. We don't initialize the statements until first use.</span>
<a href="#l69.102"></a><span id="l69.102">       cal.getCalendarManager().addCalendarObserver(this);</span>
<a href="#l69.103"></a><span id="l69.103">     }</span>
<a href="#l69.104"></a><span id="l69.104">   },</span>
<a href="#l69.105"></a><span id="l69.105"> </span>
<a href="#l69.106"></a><span id="l69.106" class="difflineminus">-  ensureStatements: function() {</span>
<a href="#l69.107"></a><span id="l69.107" class="difflineplus">+  ensureStatements() {</span>
<a href="#l69.108"></a><span id="l69.108">     if (!this.mDB) {</span>
<a href="#l69.109"></a><span id="l69.109">       this.initDB();</span>
<a href="#l69.110"></a><span id="l69.110">     }</span>
<a href="#l69.111"></a><span id="l69.111"> </span>
<a href="#l69.112"></a><span id="l69.112">     if (!this.stmtMarkDelete) {</span>
<a href="#l69.113"></a><span id="l69.113">       let stmt =</span>
<a href="#l69.114"></a><span id="l69.114">         &quot;INSERT OR REPLACE INTO cal_deleted_items (cal_id, id, time_deleted, recurrence_id) VALUES(:calId, :id, :time, :rid)&quot;;</span>
<a href="#l69.115"></a><span id="l69.115">       this.stmtMarkDelete = this.mDB.createStatement(stmt);</span>
<a href="#l69.116"></a><span id="l69.116" class="difflineat">@@ -148,17 +148,17 @@ calDeletedItems.prototype = {</span>
<a href="#l69.117"></a><span id="l69.117">       this.stmtGet = this.mDB.createStatement(stmt);</span>
<a href="#l69.118"></a><span id="l69.118">     }</span>
<a href="#l69.119"></a><span id="l69.119">     if (!this.stmtFlush) {</span>
<a href="#l69.120"></a><span id="l69.120">       let stmt = &quot;DELETE FROM cal_deleted_items WHERE time_deleted &lt; :stale_time&quot;;</span>
<a href="#l69.121"></a><span id="l69.121">       this.stmtFlush = this.mDB.createStatement(stmt);</span>
<a href="#l69.122"></a><span id="l69.122">     }</span>
<a href="#l69.123"></a><span id="l69.123">   },</span>
<a href="#l69.124"></a><span id="l69.124"> </span>
<a href="#l69.125"></a><span id="l69.125" class="difflineminus">-  shutdown: function() {</span>
<a href="#l69.126"></a><span id="l69.126" class="difflineplus">+  shutdown() {</span>
<a href="#l69.127"></a><span id="l69.127">     try {</span>
<a href="#l69.128"></a><span id="l69.128">       let stmts = [</span>
<a href="#l69.129"></a><span id="l69.129">         this.stmtMarkDelete,</span>
<a href="#l69.130"></a><span id="l69.130">         this.stmtUnmarkDelete,</span>
<a href="#l69.131"></a><span id="l69.131">         this.stmtGet,</span>
<a href="#l69.132"></a><span id="l69.132">         this.stmtGetWithCal,</span>
<a href="#l69.133"></a><span id="l69.133">         this.stmtFlush,</span>
<a href="#l69.134"></a><span id="l69.134">       ];</span>
<a href="#l69.135"></a><span id="l69.135" class="difflineat">@@ -173,27 +173,27 @@ calDeletedItems.prototype = {</span>
<a href="#l69.136"></a><span id="l69.136">     } catch (e) {</span>
<a href="#l69.137"></a><span id="l69.137">       cal.ERROR(&quot;Error closing deleted items database: &quot; + e);</span>
<a href="#l69.138"></a><span id="l69.138">     }</span>
<a href="#l69.139"></a><span id="l69.139"> </span>
<a href="#l69.140"></a><span id="l69.140">     cal.getCalendarManager().removeCalendarObserver(this);</span>
<a href="#l69.141"></a><span id="l69.141">   },</span>
<a href="#l69.142"></a><span id="l69.142"> </span>
<a href="#l69.143"></a><span id="l69.143">   // calIObserver</span>
<a href="#l69.144"></a><span id="l69.144" class="difflineminus">-  onStartBatch: function() {},</span>
<a href="#l69.145"></a><span id="l69.145" class="difflineminus">-  onEndBatch: function() {},</span>
<a href="#l69.146"></a><span id="l69.146" class="difflineminus">-  onModifyItem: function() {},</span>
<a href="#l69.147"></a><span id="l69.147" class="difflineminus">-  onError: function() {},</span>
<a href="#l69.148"></a><span id="l69.148" class="difflineminus">-  onPropertyChanged: function() {},</span>
<a href="#l69.149"></a><span id="l69.149" class="difflineminus">-  onPropertyDeleting: function() {},</span>
<a href="#l69.150"></a><span id="l69.150" class="difflineplus">+  onStartBatch() {},</span>
<a href="#l69.151"></a><span id="l69.151" class="difflineplus">+  onEndBatch() {},</span>
<a href="#l69.152"></a><span id="l69.152" class="difflineplus">+  onModifyItem() {},</span>
<a href="#l69.153"></a><span id="l69.153" class="difflineplus">+  onError() {},</span>
<a href="#l69.154"></a><span id="l69.154" class="difflineplus">+  onPropertyChanged() {},</span>
<a href="#l69.155"></a><span id="l69.155" class="difflineplus">+  onPropertyDeleting() {},</span>
<a href="#l69.156"></a><span id="l69.156"> </span>
<a href="#l69.157"></a><span id="l69.157" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l69.158"></a><span id="l69.158" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l69.159"></a><span id="l69.159">     this.unmarkDeleted(aItem);</span>
<a href="#l69.160"></a><span id="l69.160">   },</span>
<a href="#l69.161"></a><span id="l69.161"> </span>
<a href="#l69.162"></a><span id="l69.162" class="difflineminus">-  onDeleteItem: function(aItem) {</span>
<a href="#l69.163"></a><span id="l69.163" class="difflineplus">+  onDeleteItem(aItem) {</span>
<a href="#l69.164"></a><span id="l69.164">     this.markDeleted(aItem);</span>
<a href="#l69.165"></a><span id="l69.165">   },</span>
<a href="#l69.166"></a><span id="l69.166"> </span>
<a href="#l69.167"></a><span id="l69.167" class="difflineminus">-  onLoad: function() {</span>
<a href="#l69.168"></a><span id="l69.168" class="difflineplus">+  onLoad() {</span>
<a href="#l69.169"></a><span id="l69.169">     this.flush();</span>
<a href="#l69.170"></a><span id="l69.170">   },</span>
<a href="#l69.171"></a><span id="l69.171"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/calendar/base/src/calEvent.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/calendar/base/src/calEvent.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -27,23 +27,23 @@ calEvent.prototype = {</span>
<a href="#l70.4"></a><span id="l70.4">   QueryInterface: cal.generateQI(calEventInterfaces),</span>
<a href="#l70.5"></a><span id="l70.5">   classInfo: cal.generateCI({</span>
<a href="#l70.6"></a><span id="l70.6">     classID: calEventClassID,</span>
<a href="#l70.7"></a><span id="l70.7">     contractID: &quot;@mozilla.org/calendar/event;1&quot;,</span>
<a href="#l70.8"></a><span id="l70.8">     classDescription: &quot;Calendar Event&quot;,</span>
<a href="#l70.9"></a><span id="l70.9">     interfaces: calEventInterfaces,</span>
<a href="#l70.10"></a><span id="l70.10">   }),</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  cloneShallow: function(aNewParent) {</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+  cloneShallow(aNewParent) {</span>
<a href="#l70.14"></a><span id="l70.14">     let cloned = new calEvent();</span>
<a href="#l70.15"></a><span id="l70.15">     this.cloneItemBaseInto(cloned, aNewParent);</span>
<a href="#l70.16"></a><span id="l70.16">     return cloned;</span>
<a href="#l70.17"></a><span id="l70.17">   },</span>
<a href="#l70.18"></a><span id="l70.18"> </span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-  createProxy: function(aRecurrenceId) {</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+  createProxy(aRecurrenceId) {</span>
<a href="#l70.21"></a><span id="l70.21">     cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l70.22"></a><span id="l70.22"> </span>
<a href="#l70.23"></a><span id="l70.23">     let proxy = new calEvent();</span>
<a href="#l70.24"></a><span id="l70.24"> </span>
<a href="#l70.25"></a><span id="l70.25">     // override proxy's DTSTART/DTEND/RECURRENCE-ID</span>
<a href="#l70.26"></a><span id="l70.26">     // before master is set (and item might get immutable):</span>
<a href="#l70.27"></a><span id="l70.27">     let endDate = aRecurrenceId.clone();</span>
<a href="#l70.28"></a><span id="l70.28">     endDate.addDuration(this.duration);</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineat">@@ -51,27 +51,26 @@ calEvent.prototype = {</span>
<a href="#l70.30"></a><span id="l70.30">     proxy.startDate = aRecurrenceId;</span>
<a href="#l70.31"></a><span id="l70.31"> </span>
<a href="#l70.32"></a><span id="l70.32">     proxy.initializeProxy(this, aRecurrenceId);</span>
<a href="#l70.33"></a><span id="l70.33">     proxy.mDirty = false;</span>
<a href="#l70.34"></a><span id="l70.34"> </span>
<a href="#l70.35"></a><span id="l70.35">     return proxy;</span>
<a href="#l70.36"></a><span id="l70.36">   },</span>
<a href="#l70.37"></a><span id="l70.37"> </span>
<a href="#l70.38"></a><span id="l70.38" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineplus">+  makeImmutable() {</span>
<a href="#l70.40"></a><span id="l70.40">     this.makeItemBaseImmutable();</span>
<a href="#l70.41"></a><span id="l70.41">   },</span>
<a href="#l70.42"></a><span id="l70.42"> </span>
<a href="#l70.43"></a><span id="l70.43">   get duration() {</span>
<a href="#l70.44"></a><span id="l70.44">     if (this.endDate &amp;&amp; this.startDate) {</span>
<a href="#l70.45"></a><span id="l70.45">       return this.endDate.subtractDate(this.startDate);</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-    } else {</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineminus">-      // Return a null-duration if we don't have an end date</span>
<a href="#l70.48"></a><span id="l70.48" class="difflineminus">-      return cal.createDuration();</span>
<a href="#l70.49"></a><span id="l70.49">     }</span>
<a href="#l70.50"></a><span id="l70.50" class="difflineplus">+    // Return a null-duration if we don't have an end date</span>
<a href="#l70.51"></a><span id="l70.51" class="difflineplus">+    return cal.createDuration();</span>
<a href="#l70.52"></a><span id="l70.52">   },</span>
<a href="#l70.53"></a><span id="l70.53"> </span>
<a href="#l70.54"></a><span id="l70.54">   get recurrenceStartDate() {</span>
<a href="#l70.55"></a><span id="l70.55">     return this.startDate;</span>
<a href="#l70.56"></a><span id="l70.56">   },</span>
<a href="#l70.57"></a><span id="l70.57"> </span>
<a href="#l70.58"></a><span id="l70.58">   icsEventPropMap: [{ cal: &quot;DTSTART&quot;, ics: &quot;startTime&quot; }, { cal: &quot;DTEND&quot;, ics: &quot;endTime&quot; }],</span>
<a href="#l70.59"></a><span id="l70.59"> </span>
<a href="#l70.60"></a><span id="l70.60" class="difflineat">@@ -143,17 +142,17 @@ calEvent.prototype = {</span>
<a href="#l70.61"></a><span id="l70.61">     this.mapPropsFromICS(event, this.icsEventPropMap);</span>
<a href="#l70.62"></a><span id="l70.62"> </span>
<a href="#l70.63"></a><span id="l70.63">     this.importUnpromotedProperties(event, this.eventPromotedProps);</span>
<a href="#l70.64"></a><span id="l70.64"> </span>
<a href="#l70.65"></a><span id="l70.65">     // Importing didn't really change anything</span>
<a href="#l70.66"></a><span id="l70.66">     this.mDirty = false;</span>
<a href="#l70.67"></a><span id="l70.67">   },</span>
<a href="#l70.68"></a><span id="l70.68"> </span>
<a href="#l70.69"></a><span id="l70.69" class="difflineminus">-  isPropertyPromoted: function(name) {</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineplus">+  isPropertyPromoted(name) {</span>
<a href="#l70.71"></a><span id="l70.71">     // avoid strict undefined property warning</span>
<a href="#l70.72"></a><span id="l70.72">     return this.eventPromotedProps[name] || false;</span>
<a href="#l70.73"></a><span id="l70.73">   },</span>
<a href="#l70.74"></a><span id="l70.74"> </span>
<a href="#l70.75"></a><span id="l70.75">   set startDate(value) {</span>
<a href="#l70.76"></a><span id="l70.76">     this.modify();</span>
<a href="#l70.77"></a><span id="l70.77"> </span>
<a href="#l70.78"></a><span id="l70.78">     // We're about to change the start date of an item which probably</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/calendar/base/src/calFilter.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/calendar/base/src/calFilter.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -119,37 +119,37 @@ calFilterProperties.prototype = {</span>
<a href="#l71.4"></a><span id="l71.4">   end: null,</span>
<a href="#l71.5"></a><span id="l71.5">   due: null,</span>
<a href="#l71.6"></a><span id="l71.6">   status: null,</span>
<a href="#l71.7"></a><span id="l71.7">   category: null,</span>
<a href="#l71.8"></a><span id="l71.8">   occurrences: null,</span>
<a href="#l71.9"></a><span id="l71.9"> </span>
<a href="#l71.10"></a><span id="l71.10">   onfilter: null,</span>
<a href="#l71.11"></a><span id="l71.11"> </span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-  equals: function(aFilterProps) {</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+  equals(aFilterProps) {</span>
<a href="#l71.14"></a><span id="l71.14">     if (!(aFilterProps instanceof calFilterProperties)) {</span>
<a href="#l71.15"></a><span id="l71.15">       return false;</span>
<a href="#l71.16"></a><span id="l71.16">     }</span>
<a href="#l71.17"></a><span id="l71.17">     let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l71.18"></a><span id="l71.18">     return props.every(function(prop) {</span>
<a href="#l71.19"></a><span id="l71.19">       return this[prop] == aFilterProps[prop];</span>
<a href="#l71.20"></a><span id="l71.20">     }, this);</span>
<a href="#l71.21"></a><span id="l71.21">   },</span>
<a href="#l71.22"></a><span id="l71.22"> </span>
<a href="#l71.23"></a><span id="l71.23" class="difflineminus">-  clone: function() {</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+  clone() {</span>
<a href="#l71.25"></a><span id="l71.25">     let cloned = new calFilterProperties();</span>
<a href="#l71.26"></a><span id="l71.26">     let props = [&quot;start&quot;, &quot;end&quot;, &quot;due&quot;, &quot;status&quot;, &quot;category&quot;, &quot;occurrences&quot;, &quot;onfilter&quot;];</span>
<a href="#l71.27"></a><span id="l71.27">     props.forEach(function(prop) {</span>
<a href="#l71.28"></a><span id="l71.28">       cloned[prop] = this[prop];</span>
<a href="#l71.29"></a><span id="l71.29">     }, this);</span>
<a href="#l71.30"></a><span id="l71.30"> </span>
<a href="#l71.31"></a><span id="l71.31">     return cloned;</span>
<a href="#l71.32"></a><span id="l71.32">   },</span>
<a href="#l71.33"></a><span id="l71.33"> </span>
<a href="#l71.34"></a><span id="l71.34" class="difflineminus">-  LOG: function(aString) {</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+  LOG(aString) {</span>
<a href="#l71.36"></a><span id="l71.36">     cal.LOG(</span>
<a href="#l71.37"></a><span id="l71.37">       &quot;[calFilterProperties] &quot; +</span>
<a href="#l71.38"></a><span id="l71.38">         (aString || &quot;&quot;) +</span>
<a href="#l71.39"></a><span id="l71.39">         &quot; start=&quot; +</span>
<a href="#l71.40"></a><span id="l71.40">         this.start +</span>
<a href="#l71.41"></a><span id="l71.41">         &quot; end=&quot; +</span>
<a href="#l71.42"></a><span id="l71.42">         this.end +</span>
<a href="#l71.43"></a><span id="l71.43">         &quot; status=&quot; +</span>
<a href="#l71.44"></a><span id="l71.44" class="difflineat">@@ -183,17 +183,17 @@ calFilter.prototype = {</span>
<a href="#l71.45"></a><span id="l71.45">   mFilterProperties: null,</span>
<a href="#l71.46"></a><span id="l71.46">   mToday: null,</span>
<a href="#l71.47"></a><span id="l71.47">   mTomorrow: null,</span>
<a href="#l71.48"></a><span id="l71.48">   mMaxIterations: 50,</span>
<a href="#l71.49"></a><span id="l71.49"> </span>
<a href="#l71.50"></a><span id="l71.50">   /**</span>
<a href="#l71.51"></a><span id="l71.51">    * Initializes the predefined filters.</span>
<a href="#l71.52"></a><span id="l71.52">    */</span>
<a href="#l71.53"></a><span id="l71.53" class="difflineminus">-  initDefinedFilters: function() {</span>
<a href="#l71.54"></a><span id="l71.54" class="difflineplus">+  initDefinedFilters() {</span>
<a href="#l71.55"></a><span id="l71.55">     let filters = [</span>
<a href="#l71.56"></a><span id="l71.56">       &quot;all&quot;,</span>
<a href="#l71.57"></a><span id="l71.57">       &quot;notstarted&quot;,</span>
<a href="#l71.58"></a><span id="l71.58">       &quot;overdue&quot;,</span>
<a href="#l71.59"></a><span id="l71.59">       &quot;open&quot;,</span>
<a href="#l71.60"></a><span id="l71.60">       &quot;completed&quot;,</span>
<a href="#l71.61"></a><span id="l71.61">       &quot;throughcurrent&quot;,</span>
<a href="#l71.62"></a><span id="l71.62">       &quot;throughtoday&quot;,</span>
<a href="#l71.63"></a><span id="l71.63" class="difflineat">@@ -213,17 +213,17 @@ calFilter.prototype = {</span>
<a href="#l71.64"></a><span id="l71.64"> </span>
<a href="#l71.65"></a><span id="l71.65">   /**</span>
<a href="#l71.66"></a><span id="l71.66">    * Gets the filter properties for a predefined filter.</span>
<a href="#l71.67"></a><span id="l71.67">    *</span>
<a href="#l71.68"></a><span id="l71.68">    * @param aFilter   The name of the filter to retrieve the filter properties for.</span>
<a href="#l71.69"></a><span id="l71.69">    * @result          The filter properties for the specified filter, or null if the filter</span>
<a href="#l71.70"></a><span id="l71.70">    *                  not predefined.</span>
<a href="#l71.71"></a><span id="l71.71">    */</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineminus">-  getPreDefinedFilterProperties: function(aFilter) {</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineplus">+  getPreDefinedFilterProperties(aFilter) {</span>
<a href="#l71.74"></a><span id="l71.74">     let props = new calFilterProperties();</span>
<a href="#l71.75"></a><span id="l71.75"> </span>
<a href="#l71.76"></a><span id="l71.76">     if (!aFilter) {</span>
<a href="#l71.77"></a><span id="l71.77">       return props;</span>
<a href="#l71.78"></a><span id="l71.78">     }</span>
<a href="#l71.79"></a><span id="l71.79"> </span>
<a href="#l71.80"></a><span id="l71.80">     switch (aFilter) {</span>
<a href="#l71.81"></a><span id="l71.81">       // Predefined Task filters</span>
<a href="#l71.82"></a><span id="l71.82" class="difflineat">@@ -316,64 +316,63 @@ calFilter.prototype = {</span>
<a href="#l71.83"></a><span id="l71.83">   /**</span>
<a href="#l71.84"></a><span id="l71.84">    * Defines a set of filter properties so that they may be applied by the filter name. If</span>
<a href="#l71.85"></a><span id="l71.85">    * the specified filter name is already defined, it's associated filter properties will be</span>
<a href="#l71.86"></a><span id="l71.86">    * replaced.</span>
<a href="#l71.87"></a><span id="l71.87">    *</span>
<a href="#l71.88"></a><span id="l71.88">    * @param aFilterName         The name to define the filter properties as.</span>
<a href="#l71.89"></a><span id="l71.89">    * @param aFilterProperties   The filter properties to define.</span>
<a href="#l71.90"></a><span id="l71.90">    */</span>
<a href="#l71.91"></a><span id="l71.91" class="difflineminus">-  defineFilter: function(aFilterName, aFilterProperties) {</span>
<a href="#l71.92"></a><span id="l71.92" class="difflineplus">+  defineFilter(aFilterName, aFilterProperties) {</span>
<a href="#l71.93"></a><span id="l71.93">     if (!(aFilterProperties instanceof calFilterProperties)) {</span>
<a href="#l71.94"></a><span id="l71.94">       return;</span>
<a href="#l71.95"></a><span id="l71.95">     }</span>
<a href="#l71.96"></a><span id="l71.96"> </span>
<a href="#l71.97"></a><span id="l71.97">     this.mDefinedFilters[aFilterName] = aFilterProperties;</span>
<a href="#l71.98"></a><span id="l71.98">   },</span>
<a href="#l71.99"></a><span id="l71.99"> </span>
<a href="#l71.100"></a><span id="l71.100">   /**</span>
<a href="#l71.101"></a><span id="l71.101">    * Returns the set of filter properties that were previously defined by a filter name.</span>
<a href="#l71.102"></a><span id="l71.102">    *</span>
<a href="#l71.103"></a><span id="l71.103">    * @param aFilter             The filter name of the defined filter properties.</span>
<a href="#l71.104"></a><span id="l71.104">    * @return                    The properties defined by the filter name, or null if</span>
<a href="#l71.105"></a><span id="l71.105">    *                            the filter name was not previously defined.</span>
<a href="#l71.106"></a><span id="l71.106">    */</span>
<a href="#l71.107"></a><span id="l71.107" class="difflineminus">-  getDefinedFilterProperties: function(aFilter) {</span>
<a href="#l71.108"></a><span id="l71.108" class="difflineplus">+  getDefinedFilterProperties(aFilter) {</span>
<a href="#l71.109"></a><span id="l71.109">     if (aFilter in this.mDefinedFilters) {</span>
<a href="#l71.110"></a><span id="l71.110">       return this.mDefinedFilters[aFilter].clone();</span>
<a href="#l71.111"></a><span id="l71.111" class="difflineminus">-    } else {</span>
<a href="#l71.112"></a><span id="l71.112" class="difflineminus">-      return null;</span>
<a href="#l71.113"></a><span id="l71.113">     }</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineplus">+    return null;</span>
<a href="#l71.115"></a><span id="l71.115">   },</span>
<a href="#l71.116"></a><span id="l71.116"> </span>
<a href="#l71.117"></a><span id="l71.117">   /**</span>
<a href="#l71.118"></a><span id="l71.118">    * Returns the filter name that a set of filter properties were previously defined as.</span>
<a href="#l71.119"></a><span id="l71.119">    *</span>
<a href="#l71.120"></a><span id="l71.120">    * @param aFilterProperties   The filter properties previously defined.</span>
<a href="#l71.121"></a><span id="l71.121">    * @return                    The name of the first filter name that the properties</span>
<a href="#l71.122"></a><span id="l71.122">    *                            were defined as, or null if the filter properties were</span>
<a href="#l71.123"></a><span id="l71.123">    *                            not previously defined.</span>
<a href="#l71.124"></a><span id="l71.124">    */</span>
<a href="#l71.125"></a><span id="l71.125" class="difflineminus">-  getDefinedFilterName: function(aFilterProperties) {</span>
<a href="#l71.126"></a><span id="l71.126" class="difflineplus">+  getDefinedFilterName(aFilterProperties) {</span>
<a href="#l71.127"></a><span id="l71.127">     for (let filter in this.mDefinedFilters) {</span>
<a href="#l71.128"></a><span id="l71.128">       if (this.mDefinedFilters[filter].equals(aFilterProperties)) {</span>
<a href="#l71.129"></a><span id="l71.129">         return filter;</span>
<a href="#l71.130"></a><span id="l71.130">       }</span>
<a href="#l71.131"></a><span id="l71.131">     }</span>
<a href="#l71.132"></a><span id="l71.132">     return null;</span>
<a href="#l71.133"></a><span id="l71.133">   },</span>
<a href="#l71.134"></a><span id="l71.134"> </span>
<a href="#l71.135"></a><span id="l71.135">   /**</span>
<a href="#l71.136"></a><span id="l71.136">    * Checks if the item matches the current filter text</span>
<a href="#l71.137"></a><span id="l71.137">    *</span>
<a href="#l71.138"></a><span id="l71.138">    * @param aItem               The item to check.</span>
<a href="#l71.139"></a><span id="l71.139">    * @return                    Returns true if the item matches the filter text or no</span>
<a href="#l71.140"></a><span id="l71.140">    *                            filter text has been set, false otherwise.</span>
<a href="#l71.141"></a><span id="l71.141">    */</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineminus">-  textFilter: function(aItem) {</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineplus">+  textFilter(aItem) {</span>
<a href="#l71.144"></a><span id="l71.144">     if (!this.mFilterText) {</span>
<a href="#l71.145"></a><span id="l71.145">       return true;</span>
<a href="#l71.146"></a><span id="l71.146">     }</span>
<a href="#l71.147"></a><span id="l71.147"> </span>
<a href="#l71.148"></a><span id="l71.148">     let searchText = this.mFilterText.toLowerCase();</span>
<a href="#l71.149"></a><span id="l71.149"> </span>
<a href="#l71.150"></a><span id="l71.150">     if (!searchText.length || searchText.match(/^\s*$/)) {</span>
<a href="#l71.151"></a><span id="l71.151">       return true;</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineat">@@ -392,29 +391,29 @@ calFilter.prototype = {</span>
<a href="#l71.153"></a><span id="l71.153"> </span>
<a href="#l71.154"></a><span id="l71.154">   /**</span>
<a href="#l71.155"></a><span id="l71.155">    * Checks if the item matches the current filter date range.</span>
<a href="#l71.156"></a><span id="l71.156">    *</span>
<a href="#l71.157"></a><span id="l71.157">    * @param aItem               The item to check.</span>
<a href="#l71.158"></a><span id="l71.158">    * @return                    Returns true if the item falls within the date range</span>
<a href="#l71.159"></a><span id="l71.159">    *                            specified by mStartDate and mEndDate, false otherwise.</span>
<a href="#l71.160"></a><span id="l71.160">    */</span>
<a href="#l71.161"></a><span id="l71.161" class="difflineminus">-  dateRangeFilter: function(aItem) {</span>
<a href="#l71.162"></a><span id="l71.162" class="difflineplus">+  dateRangeFilter(aItem) {</span>
<a href="#l71.163"></a><span id="l71.163">     return cal.item.checkIfInRange(aItem, this.mStartDate, this.mEndDate);</span>
<a href="#l71.164"></a><span id="l71.164">   },</span>
<a href="#l71.165"></a><span id="l71.165"> </span>
<a href="#l71.166"></a><span id="l71.166">   /**</span>
<a href="#l71.167"></a><span id="l71.167">    * Checks if the item matches the currently applied filter properties. Filter properties</span>
<a href="#l71.168"></a><span id="l71.168">    * with a value of null or that are not applicable to the item's type are not tested.</span>
<a href="#l71.169"></a><span id="l71.169">    *</span>
<a href="#l71.170"></a><span id="l71.170">    * @param aItem               The item to check.</span>
<a href="#l71.171"></a><span id="l71.171">    * @return                    Returns true if the item matches the filter properties</span>
<a href="#l71.172"></a><span id="l71.172">    *                            currently applied, false otherwise.</span>
<a href="#l71.173"></a><span id="l71.173">    */</span>
<a href="#l71.174"></a><span id="l71.174" class="difflineminus">-  propertyFilter: function(aItem) {</span>
<a href="#l71.175"></a><span id="l71.175" class="difflineplus">+  propertyFilter(aItem) {</span>
<a href="#l71.176"></a><span id="l71.176">     let result;</span>
<a href="#l71.177"></a><span id="l71.177">     let props = this.mFilterProperties;</span>
<a href="#l71.178"></a><span id="l71.178">     if (!props) {</span>
<a href="#l71.179"></a><span id="l71.179">       return false;</span>
<a href="#l71.180"></a><span id="l71.180">     }</span>
<a href="#l71.181"></a><span id="l71.181"> </span>
<a href="#l71.182"></a><span id="l71.182">     // the today and tomorrow properties are precalculated in the updateFilterDates function</span>
<a href="#l71.183"></a><span id="l71.183">     // for better performance when filtering batches of items.</span>
<a href="#l71.184"></a><span id="l71.184" class="difflineat">@@ -487,17 +486,17 @@ calFilter.prototype = {</span>
<a href="#l71.185"></a><span id="l71.185">    * @param prop                The value of the date filter property to calculate for. May</span>
<a href="#l71.186"></a><span id="l71.186">    *                            be a constant specifying a relative date range, or a string</span>
<a href="#l71.187"></a><span id="l71.187">    *                            representing a duration offset from the current date time.</span>
<a href="#l71.188"></a><span id="l71.188">    * @param start               If true, the function will return the date value for the</span>
<a href="#l71.189"></a><span id="l71.189">    *                            start of the relative date range, otherwise it will return the</span>
<a href="#l71.190"></a><span id="l71.190">    *                            date value for the end of the date range.</span>
<a href="#l71.191"></a><span id="l71.191">    * @return                    The calculated date for the property.</span>
<a href="#l71.192"></a><span id="l71.192">    */</span>
<a href="#l71.193"></a><span id="l71.193" class="difflineminus">-  getDateForProperty: function(prop, start) {</span>
<a href="#l71.194"></a><span id="l71.194" class="difflineplus">+  getDateForProperty(prop, start) {</span>
<a href="#l71.195"></a><span id="l71.195">     let props = this.mFilterProperties || new calFilterProperties();</span>
<a href="#l71.196"></a><span id="l71.196">     let result = null;</span>
<a href="#l71.197"></a><span id="l71.197">     let selectedDate = this.mSelectedDate || currentView().selectedDay || cal.dtz.now();</span>
<a href="#l71.198"></a><span id="l71.198">     let nowDate = cal.dtz.now();</span>
<a href="#l71.199"></a><span id="l71.199"> </span>
<a href="#l71.200"></a><span id="l71.200">     if (typeof prop == &quot;string&quot;) {</span>
<a href="#l71.201"></a><span id="l71.201">       let duration = cal.createDuration(prop);</span>
<a href="#l71.202"></a><span id="l71.202">       if (duration) {</span>
<a href="#l71.203"></a><span id="l71.203" class="difflineat">@@ -553,17 +552,17 @@ calFilter.prototype = {</span>
<a href="#l71.204"></a><span id="l71.204">     return result;</span>
<a href="#l71.205"></a><span id="l71.205">   },</span>
<a href="#l71.206"></a><span id="l71.206"> </span>
<a href="#l71.207"></a><span id="l71.207">   /**</span>
<a href="#l71.208"></a><span id="l71.208">    * Calculates the current start and end dates for the currently applied filter.</span>
<a href="#l71.209"></a><span id="l71.209">    *</span>
<a href="#l71.210"></a><span id="l71.210">    * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l71.211"></a><span id="l71.211">    */</span>
<a href="#l71.212"></a><span id="l71.212" class="difflineminus">-  getDatesForFilter: function() {</span>
<a href="#l71.213"></a><span id="l71.213" class="difflineplus">+  getDatesForFilter() {</span>
<a href="#l71.214"></a><span id="l71.214">     let startDate = null;</span>
<a href="#l71.215"></a><span id="l71.215">     let endDate = null;</span>
<a href="#l71.216"></a><span id="l71.216"> </span>
<a href="#l71.217"></a><span id="l71.217">     if (this.mFilterProperties) {</span>
<a href="#l71.218"></a><span id="l71.218">       startDate = this.getDateForProperty(this.mFilterProperties.start, true);</span>
<a href="#l71.219"></a><span id="l71.219">       endDate = this.getDateForProperty(this.mFilterProperties.end, false);</span>
<a href="#l71.220"></a><span id="l71.220"> </span>
<a href="#l71.221"></a><span id="l71.221">       // swap the start and end dates if necessary</span>
<a href="#l71.222"></a><span id="l71.222" class="difflineat">@@ -673,17 +672,17 @@ calFilter.prototype = {</span>
<a href="#l71.223"></a><span id="l71.223">    * Applies the specified filter.</span>
<a href="#l71.224"></a><span id="l71.224">    *</span>
<a href="#l71.225"></a><span id="l71.225">    * @param aFilter           The filter to apply. May be one of the following types:</span>
<a href="#l71.226"></a><span id="l71.226">    *                          - a calFilterProperties object specifying the filter properties</span>
<a href="#l71.227"></a><span id="l71.227">    *                          - a String representing a previously defined filter name</span>
<a href="#l71.228"></a><span id="l71.228">    *                          - a String representing a duration offset from now</span>
<a href="#l71.229"></a><span id="l71.229">    *                          - a Function to use for the onfilter callback for a custom filter</span>
<a href="#l71.230"></a><span id="l71.230">    */</span>
<a href="#l71.231"></a><span id="l71.231" class="difflineminus">-  applyFilter: function(aFilter) {</span>
<a href="#l71.232"></a><span id="l71.232" class="difflineplus">+  applyFilter(aFilter) {</span>
<a href="#l71.233"></a><span id="l71.233">     this.mFilterProperties = null;</span>
<a href="#l71.234"></a><span id="l71.234"> </span>
<a href="#l71.235"></a><span id="l71.235">     if (typeof aFilter == &quot;string&quot;) {</span>
<a href="#l71.236"></a><span id="l71.236">       if (aFilter in this.mDefinedFilters) {</span>
<a href="#l71.237"></a><span id="l71.237">         this.mFilterProperties = this.getDefinedFilterProperties(aFilter);</span>
<a href="#l71.238"></a><span id="l71.238">       } else {</span>
<a href="#l71.239"></a><span id="l71.239">         let dur = cal.createDuration(aFilter);</span>
<a href="#l71.240"></a><span id="l71.240">         if (dur.inSeconds &gt; 0) {</span>
<a href="#l71.241"></a><span id="l71.241" class="difflineat">@@ -711,17 +710,17 @@ calFilter.prototype = {</span>
<a href="#l71.242"></a><span id="l71.242"> </span>
<a href="#l71.243"></a><span id="l71.243">   /**</span>
<a href="#l71.244"></a><span id="l71.244">    * Calculates the current start and end dates for the currently applied filter, and updates</span>
<a href="#l71.245"></a><span id="l71.245">    * the current filter start and end dates. This function can be used to update the date range</span>
<a href="#l71.246"></a><span id="l71.246">    * for date range filters that are relative to the selected date or current date and time.</span>
<a href="#l71.247"></a><span id="l71.247">    *</span>
<a href="#l71.248"></a><span id="l71.248">    * @return                    The current [startDate, endDate] for the applied filter.</span>
<a href="#l71.249"></a><span id="l71.249">    */</span>
<a href="#l71.250"></a><span id="l71.250" class="difflineminus">-  updateFilterDates: function() {</span>
<a href="#l71.251"></a><span id="l71.251" class="difflineplus">+  updateFilterDates() {</span>
<a href="#l71.252"></a><span id="l71.252">     let [startDate, endDate] = this.getDatesForFilter();</span>
<a href="#l71.253"></a><span id="l71.253">     this.mStartDate = startDate;</span>
<a href="#l71.254"></a><span id="l71.254">     this.mEndDate = endDate;</span>
<a href="#l71.255"></a><span id="l71.255"> </span>
<a href="#l71.256"></a><span id="l71.256">     // the today and tomorrow properties are precalculated here</span>
<a href="#l71.257"></a><span id="l71.257">     // for better performance when filtering batches of items.</span>
<a href="#l71.258"></a><span id="l71.258">     this.mToday = cal.dtz.now();</span>
<a href="#l71.259"></a><span id="l71.259">     this.mToday.isDate = true;</span>
<a href="#l71.260"></a><span id="l71.260" class="difflineat">@@ -737,17 +736,17 @@ calFilter.prototype = {</span>
<a href="#l71.261"></a><span id="l71.261">    * the currently applied filter properties and text filter.</span>
<a href="#l71.262"></a><span id="l71.262">    *</span>
<a href="#l71.263"></a><span id="l71.263">    * @param aItems              The array of items to check.</span>
<a href="#l71.264"></a><span id="l71.264">    * @param aCallback           An optional callback function to be called with each item and</span>
<a href="#l71.265"></a><span id="l71.265">    *                            the result of it's filter test.</span>
<a href="#l71.266"></a><span id="l71.266">    * @return                    A new array containing the items that match the filters, or</span>
<a href="#l71.267"></a><span id="l71.267">    *                            null if no filter has been applied.</span>
<a href="#l71.268"></a><span id="l71.268">    */</span>
<a href="#l71.269"></a><span id="l71.269" class="difflineminus">-  filterItems: function(aItems, aCallback) {</span>
<a href="#l71.270"></a><span id="l71.270" class="difflineplus">+  filterItems(aItems, aCallback) {</span>
<a href="#l71.271"></a><span id="l71.271">     if (!this.mFilterProperties) {</span>
<a href="#l71.272"></a><span id="l71.272">       return null;</span>
<a href="#l71.273"></a><span id="l71.273">     }</span>
<a href="#l71.274"></a><span id="l71.274"> </span>
<a href="#l71.275"></a><span id="l71.275">     return aItems.filter(function(aItem) {</span>
<a href="#l71.276"></a><span id="l71.276">       let result = this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem);</span>
<a href="#l71.277"></a><span id="l71.277"> </span>
<a href="#l71.278"></a><span id="l71.278">       if (aCallback &amp;&amp; typeof aCallback == &quot;function&quot;) {</span>
<a href="#l71.279"></a><span id="l71.279" class="difflineat">@@ -760,29 +759,29 @@ calFilter.prototype = {</span>
<a href="#l71.280"></a><span id="l71.280"> </span>
<a href="#l71.281"></a><span id="l71.281">   /**</span>
<a href="#l71.282"></a><span id="l71.282">    * Checks if the item matches the currently applied filter properties and text filter.</span>
<a href="#l71.283"></a><span id="l71.283">    *</span>
<a href="#l71.284"></a><span id="l71.284">    * @param aItem               The item to check.</span>
<a href="#l71.285"></a><span id="l71.285">    * @return                    Returns true if the item matches the filters,</span>
<a href="#l71.286"></a><span id="l71.286">    *                            false otherwise.</span>
<a href="#l71.287"></a><span id="l71.287">    */</span>
<a href="#l71.288"></a><span id="l71.288" class="difflineminus">-  isItemInFilters: function(aItem) {</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineplus">+  isItemInFilters(aItem) {</span>
<a href="#l71.290"></a><span id="l71.290">     return this.propertyFilter(aItem) &amp;&amp; this.textFilter(aItem);</span>
<a href="#l71.291"></a><span id="l71.291">   },</span>
<a href="#l71.292"></a><span id="l71.292"> </span>
<a href="#l71.293"></a><span id="l71.293">   /**</span>
<a href="#l71.294"></a><span id="l71.294">    * Finds the next occurrence of a repeating item that matches the currently applied</span>
<a href="#l71.295"></a><span id="l71.295">    * filter properties.</span>
<a href="#l71.296"></a><span id="l71.296">    *</span>
<a href="#l71.297"></a><span id="l71.297">    * @param aItem               The parent item to find the next occurrence of.</span>
<a href="#l71.298"></a><span id="l71.298">    * @return                    Returns the next occurrence that matches the filters,</span>
<a href="#l71.299"></a><span id="l71.299">    *                            or null if no match is found.</span>
<a href="#l71.300"></a><span id="l71.300">    */</span>
<a href="#l71.301"></a><span id="l71.301" class="difflineminus">-  getNextOccurrence: function(aItem) {</span>
<a href="#l71.302"></a><span id="l71.302" class="difflineplus">+  getNextOccurrence(aItem) {</span>
<a href="#l71.303"></a><span id="l71.303">     if (!aItem.recurrenceInfo) {</span>
<a href="#l71.304"></a><span id="l71.304">       return this.isItemInFilters(aItem) ? aItem : null;</span>
<a href="#l71.305"></a><span id="l71.305">     }</span>
<a href="#l71.306"></a><span id="l71.306"> </span>
<a href="#l71.307"></a><span id="l71.307">     let count = 0;</span>
<a href="#l71.308"></a><span id="l71.308">     let start = cal.dtz.now();</span>
<a href="#l71.309"></a><span id="l71.309"> </span>
<a href="#l71.310"></a><span id="l71.310">     // If the base item matches the filter, we need to check each future occurrence.</span>
<a href="#l71.311"></a><span id="l71.311" class="difflineat">@@ -800,45 +799,44 @@ calFilter.prototype = {</span>
<a href="#l71.312"></a><span id="l71.312">         }</span>
<a href="#l71.313"></a><span id="l71.313">         next.QueryInterface(Ci.calIEvent);</span>
<a href="#l71.314"></a><span id="l71.314">         start = next.startDate || next.entryDate;</span>
<a href="#l71.315"></a><span id="l71.315">       }</span>
<a href="#l71.316"></a><span id="l71.316"> </span>
<a href="#l71.317"></a><span id="l71.317">       // we've hit the maximum number of iterations without finding a match</span>
<a href="#l71.318"></a><span id="l71.318">       cal.WARN(&quot;[calFilter] getNextOccurrence: reached maximum iterations for &quot; + aItem.title);</span>
<a href="#l71.319"></a><span id="l71.319">       return null;</span>
<a href="#l71.320"></a><span id="l71.320" class="difflineminus">-    } else {</span>
<a href="#l71.321"></a><span id="l71.321" class="difflineminus">-      // the parent item doesn't match the filter, we can return the first future exception</span>
<a href="#l71.322"></a><span id="l71.322" class="difflineminus">-      // that matches the filter</span>
<a href="#l71.323"></a><span id="l71.323" class="difflineminus">-      let exMatch = null;</span>
<a href="#l71.324"></a><span id="l71.324" class="difflineminus">-      aItem.recurrenceInfo.getExceptionIds().forEach(function(rID) {</span>
<a href="#l71.325"></a><span id="l71.325" class="difflineminus">-        let ex = aItem.recurrenceInfo.getExceptionFor(rID);</span>
<a href="#l71.326"></a><span id="l71.326" class="difflineminus">-        ex.QueryInterface(Ci.calIEvent);</span>
<a href="#l71.327"></a><span id="l71.327" class="difflineminus">-        if (</span>
<a href="#l71.328"></a><span id="l71.328" class="difflineminus">-          ex &amp;&amp;</span>
<a href="#l71.329"></a><span id="l71.329" class="difflineminus">-          cal.dtz.now().compare(ex.startDate || ex.entryDate) &lt; 0 &amp;&amp;</span>
<a href="#l71.330"></a><span id="l71.330" class="difflineminus">-          this.isItemInFilters(ex)</span>
<a href="#l71.331"></a><span id="l71.331" class="difflineminus">-        ) {</span>
<a href="#l71.332"></a><span id="l71.332" class="difflineminus">-          exMatch = ex;</span>
<a href="#l71.333"></a><span id="l71.333" class="difflineminus">-        }</span>
<a href="#l71.334"></a><span id="l71.334" class="difflineminus">-      }, this);</span>
<a href="#l71.335"></a><span id="l71.335" class="difflineminus">-      return exMatch;</span>
<a href="#l71.336"></a><span id="l71.336">     }</span>
<a href="#l71.337"></a><span id="l71.337" class="difflineplus">+    // the parent item doesn't match the filter, we can return the first future exception</span>
<a href="#l71.338"></a><span id="l71.338" class="difflineplus">+    // that matches the filter</span>
<a href="#l71.339"></a><span id="l71.339" class="difflineplus">+    let exMatch = null;</span>
<a href="#l71.340"></a><span id="l71.340" class="difflineplus">+    aItem.recurrenceInfo.getExceptionIds().forEach(function(rID) {</span>
<a href="#l71.341"></a><span id="l71.341" class="difflineplus">+      let ex = aItem.recurrenceInfo.getExceptionFor(rID);</span>
<a href="#l71.342"></a><span id="l71.342" class="difflineplus">+      ex.QueryInterface(Ci.calIEvent);</span>
<a href="#l71.343"></a><span id="l71.343" class="difflineplus">+      if (</span>
<a href="#l71.344"></a><span id="l71.344" class="difflineplus">+        ex &amp;&amp;</span>
<a href="#l71.345"></a><span id="l71.345" class="difflineplus">+        cal.dtz.now().compare(ex.startDate || ex.entryDate) &lt; 0 &amp;&amp;</span>
<a href="#l71.346"></a><span id="l71.346" class="difflineplus">+        this.isItemInFilters(ex)</span>
<a href="#l71.347"></a><span id="l71.347" class="difflineplus">+      ) {</span>
<a href="#l71.348"></a><span id="l71.348" class="difflineplus">+        exMatch = ex;</span>
<a href="#l71.349"></a><span id="l71.349" class="difflineplus">+      }</span>
<a href="#l71.350"></a><span id="l71.350" class="difflineplus">+    }, this);</span>
<a href="#l71.351"></a><span id="l71.351" class="difflineplus">+    return exMatch;</span>
<a href="#l71.352"></a><span id="l71.352">   },</span>
<a href="#l71.353"></a><span id="l71.353"> </span>
<a href="#l71.354"></a><span id="l71.354">   /**</span>
<a href="#l71.355"></a><span id="l71.355">    * Gets the occurrences of a repeating item that match the currently applied</span>
<a href="#l71.356"></a><span id="l71.356">    * filter properties and date range.</span>
<a href="#l71.357"></a><span id="l71.357">    *</span>
<a href="#l71.358"></a><span id="l71.358">    * @param aItem               The parent item to find occurrence of.</span>
<a href="#l71.359"></a><span id="l71.359">    * @return                    Returns an array containing the occurrences that</span>
<a href="#l71.360"></a><span id="l71.360">    *                            match the filters, an empty array if there are no</span>
<a href="#l71.361"></a><span id="l71.361">    *                            matches, or null if the filter is not initialized.</span>
<a href="#l71.362"></a><span id="l71.362">    */</span>
<a href="#l71.363"></a><span id="l71.363" class="difflineminus">-  getOccurrences: function(aItem) {</span>
<a href="#l71.364"></a><span id="l71.364" class="difflineplus">+  getOccurrences(aItem) {</span>
<a href="#l71.365"></a><span id="l71.365">     if (!this.mFilterProperties) {</span>
<a href="#l71.366"></a><span id="l71.366">       return null;</span>
<a href="#l71.367"></a><span id="l71.367">     }</span>
<a href="#l71.368"></a><span id="l71.368">     let props = this.mFilterProperties;</span>
<a href="#l71.369"></a><span id="l71.369">     let occs;</span>
<a href="#l71.370"></a><span id="l71.370"> </span>
<a href="#l71.371"></a><span id="l71.371">     if (</span>
<a href="#l71.372"></a><span id="l71.372">       !aItem.recurrenceInfo ||</span>
<a href="#l71.373"></a><span id="l71.373" class="difflineat">@@ -872,31 +870,31 @@ calFilter.prototype = {</span>
<a href="#l71.374"></a><span id="l71.374">    * This function is asynchronous, and returns results to a calIOperationListener object.</span>
<a href="#l71.375"></a><span id="l71.375">    *</span>
<a href="#l71.376"></a><span id="l71.376">    * @param aCalendar           The calendar to get items from.</span>
<a href="#l71.377"></a><span id="l71.377">    * @param aItemType           The type of items to get, as defined by the calICalendar</span>
<a href="#l71.378"></a><span id="l71.378">    *                            interface ITEM_FILTER_TYPE_XXX constants.</span>
<a href="#l71.379"></a><span id="l71.379">    * @param aListener           The calIOperationListener object to return results to.</span>
<a href="#l71.380"></a><span id="l71.380">    * @return                    the calIOperation handle to track the operation.</span>
<a href="#l71.381"></a><span id="l71.381">    */</span>
<a href="#l71.382"></a><span id="l71.382" class="difflineminus">-  getItems: function(aCalendar, aItemType, aListener) {</span>
<a href="#l71.383"></a><span id="l71.383" class="difflineplus">+  getItems(aCalendar, aItemType, aListener) {</span>
<a href="#l71.384"></a><span id="l71.384">     if (!this.mFilterProperties) {</span>
<a href="#l71.385"></a><span id="l71.385">       return null;</span>
<a href="#l71.386"></a><span id="l71.386">     }</span>
<a href="#l71.387"></a><span id="l71.387">     let props = this.mFilterProperties;</span>
<a href="#l71.388"></a><span id="l71.388"> </span>
<a href="#l71.389"></a><span id="l71.389">     // we use a local proxy listener for the calICalendar.getItems() call, and use it</span>
<a href="#l71.390"></a><span id="l71.390">     // to handle occurrence expansion and filter the results before forwarding them to</span>
<a href="#l71.391"></a><span id="l71.391">     // the listener passed in the aListener argument.</span>
<a href="#l71.392"></a><span id="l71.392">     let self = this;</span>
<a href="#l71.393"></a><span id="l71.393">     let listener = {</span>
<a href="#l71.394"></a><span id="l71.394">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l71.395"></a><span id="l71.395">       onOperationComplete: aListener.onOperationComplete.bind(aListener),</span>
<a href="#l71.396"></a><span id="l71.396"> </span>
<a href="#l71.397"></a><span id="l71.397" class="difflineminus">-      onGetResult: function(aOpCalendar, aStatus, aOpItemType, aDetail, aItems) {</span>
<a href="#l71.398"></a><span id="l71.398" class="difflineplus">+      onGetResult(aOpCalendar, aStatus, aOpItemType, aDetail, aItems) {</span>
<a href="#l71.399"></a><span id="l71.399">         let items;</span>
<a href="#l71.400"></a><span id="l71.400">         if (props.occurrences == props.FILTER_OCCURRENCES_PAST_AND_NEXT) {</span>
<a href="#l71.401"></a><span id="l71.401">           // with the FILTER_OCCURRENCES_PAST_AND_NEXT occurrence filter we will</span>
<a href="#l71.402"></a><span id="l71.402">           // get parent items returned here, so we need to let the getOccurrences</span>
<a href="#l71.403"></a><span id="l71.403">           // function handle occurrence expansion.</span>
<a href="#l71.404"></a><span id="l71.404">           items = [];</span>
<a href="#l71.405"></a><span id="l71.405">           for (let item of aItems) {</span>
<a href="#l71.406"></a><span id="l71.406">             items = items.concat(self.getOccurrences(item));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/calendar/base/src/calFreeBusyService.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/calendar/base/src/calFreeBusyService.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -14,28 +14,28 @@ function calFreeBusyListener(numOperatio</span>
<a href="#l72.4"></a><span id="l72.4"> }</span>
<a href="#l72.5"></a><span id="l72.5"> calFreeBusyListener.prototype = {</span>
<a href="#l72.6"></a><span id="l72.6">   QueryInterface: ChromeUtils.generateQI([Ci.calIGenericOperationListener]),</span>
<a href="#l72.7"></a><span id="l72.7"> </span>
<a href="#l72.8"></a><span id="l72.8">   mFinalListener: null,</span>
<a href="#l72.9"></a><span id="l72.9">   mNumOperations: 0,</span>
<a href="#l72.10"></a><span id="l72.10">   opGroup: null,</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-  notifyResult: function(result) {</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+  notifyResult(result) {</span>
<a href="#l72.14"></a><span id="l72.14">     let listener = this.mFinalListener;</span>
<a href="#l72.15"></a><span id="l72.15">     if (listener) {</span>
<a href="#l72.16"></a><span id="l72.16">       if (!this.opGroup.isPending) {</span>
<a href="#l72.17"></a><span id="l72.17">         this.mFinalListener = null;</span>
<a href="#l72.18"></a><span id="l72.18">       }</span>
<a href="#l72.19"></a><span id="l72.19">       listener.onResult(this.opGroup, result);</span>
<a href="#l72.20"></a><span id="l72.20">     }</span>
<a href="#l72.21"></a><span id="l72.21">   },</span>
<a href="#l72.22"></a><span id="l72.22"> </span>
<a href="#l72.23"></a><span id="l72.23">   // calIGenericOperationListener:</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineminus">-  onResult: function(aOperation, aResult) {</span>
<a href="#l72.25"></a><span id="l72.25" class="difflineplus">+  onResult(aOperation, aResult) {</span>
<a href="#l72.26"></a><span id="l72.26">     if (this.mFinalListener) {</span>
<a href="#l72.27"></a><span id="l72.27">       if (!aOperation || !aOperation.isPending) {</span>
<a href="#l72.28"></a><span id="l72.28">         --this.mNumOperations;</span>
<a href="#l72.29"></a><span id="l72.29">         if (this.mNumOperations == 0) {</span>
<a href="#l72.30"></a><span id="l72.30">           this.opGroup.notifyCompleted();</span>
<a href="#l72.31"></a><span id="l72.31">         }</span>
<a href="#l72.32"></a><span id="l72.32">       }</span>
<a href="#l72.33"></a><span id="l72.33">       let opStatus = aOperation ? aOperation.status : Cr.NS_OK;</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineat">@@ -54,31 +54,31 @@ function calFreeBusyService() {</span>
<a href="#l72.35"></a><span id="l72.35"> }</span>
<a href="#l72.36"></a><span id="l72.36"> calFreeBusyService.prototype = {</span>
<a href="#l72.37"></a><span id="l72.37">   QueryInterface: ChromeUtils.generateQI([Ci.calIFreeBusyProvider, Ci.calIFreeBusyService]),</span>
<a href="#l72.38"></a><span id="l72.38">   classID: Components.ID(&quot;{29c56cd5-d36e-453a-acde-0083bd4fe6d3}&quot;),</span>
<a href="#l72.39"></a><span id="l72.39"> </span>
<a href="#l72.40"></a><span id="l72.40">   mProviders: null,</span>
<a href="#l72.41"></a><span id="l72.41"> </span>
<a href="#l72.42"></a><span id="l72.42">   // calIFreeBusyProvider:</span>
<a href="#l72.43"></a><span id="l72.43" class="difflineminus">-  getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l72.44"></a><span id="l72.44" class="difflineplus">+  getFreeBusyIntervals(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l72.45"></a><span id="l72.45">     let groupListener = new calFreeBusyListener(this.mProviders.size, aListener);</span>
<a href="#l72.46"></a><span id="l72.46">     for (let provider of this.mProviders.values()) {</span>
<a href="#l72.47"></a><span id="l72.47">       let operation = provider.getFreeBusyIntervals(</span>
<a href="#l72.48"></a><span id="l72.48">         aCalId,</span>
<a href="#l72.49"></a><span id="l72.49">         aRangeStart,</span>
<a href="#l72.50"></a><span id="l72.50">         aRangeEnd,</span>
<a href="#l72.51"></a><span id="l72.51">         aBusyTypes,</span>
<a href="#l72.52"></a><span id="l72.52">         groupListener</span>
<a href="#l72.53"></a><span id="l72.53">       );</span>
<a href="#l72.54"></a><span id="l72.54">       groupListener.opGroup.add(operation);</span>
<a href="#l72.55"></a><span id="l72.55">     }</span>
<a href="#l72.56"></a><span id="l72.56">     return groupListener.opGroup;</span>
<a href="#l72.57"></a><span id="l72.57">   },</span>
<a href="#l72.58"></a><span id="l72.58"> </span>
<a href="#l72.59"></a><span id="l72.59">   // calIFreeBusyService:</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineminus">-  addProvider: function(aProvider) {</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+  addProvider(aProvider) {</span>
<a href="#l72.62"></a><span id="l72.62">     this.mProviders.add(aProvider.QueryInterface(Ci.calIFreeBusyProvider));</span>
<a href="#l72.63"></a><span id="l72.63">   },</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineminus">-  removeProvider: function(aProvider) {</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineplus">+  removeProvider(aProvider) {</span>
<a href="#l72.66"></a><span id="l72.66">     this.mProviders.delete(aProvider.QueryInterface(Ci.calIFreeBusyProvider));</span>
<a href="#l72.67"></a><span id="l72.67">   },</span>
<a href="#l72.68"></a><span id="l72.68"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/calendar/base/src/calIcsParser.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/calendar/base/src/calIcsParser.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -12,17 +12,17 @@ function calIcsParser() {</span>
<a href="#l73.4"></a><span id="l73.4">   this.mParentlessItems = [];</span>
<a href="#l73.5"></a><span id="l73.5">   this.mComponents = [];</span>
<a href="#l73.6"></a><span id="l73.6">   this.mProperties = [];</span>
<a href="#l73.7"></a><span id="l73.7"> }</span>
<a href="#l73.8"></a><span id="l73.8"> calIcsParser.prototype = {</span>
<a href="#l73.9"></a><span id="l73.9">   QueryInterface: ChromeUtils.generateQI([Ci.calIIcsParser]),</span>
<a href="#l73.10"></a><span id="l73.10">   classID: Components.ID(&quot;{6fe88047-75b6-4874-80e8-5f5800f14984}&quot;),</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-  processIcalComponent: function(rootComp, aAsyncParsing) {</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+  processIcalComponent(rootComp, aAsyncParsing) {</span>
<a href="#l73.14"></a><span id="l73.14">     let calComp;</span>
<a href="#l73.15"></a><span id="l73.15">     // libical returns the vcalendar component if there is just one vcalendar.</span>
<a href="#l73.16"></a><span id="l73.16">     // If there are multiple vcalendars, it returns an xroot component, with</span>
<a href="#l73.17"></a><span id="l73.17">     // vcalendar children. We need to handle both cases.</span>
<a href="#l73.18"></a><span id="l73.18">     if (rootComp) {</span>
<a href="#l73.19"></a><span id="l73.19">       if (rootComp.componentType == &quot;VCALENDAR&quot;) {</span>
<a href="#l73.20"></a><span id="l73.20">         calComp = rootComp;</span>
<a href="#l73.21"></a><span id="l73.21">       } else {</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineat">@@ -110,27 +110,27 @@ calIcsParser.prototype = {</span>
<a href="#l73.23"></a><span id="l73.23">       self.mComponents = self.mComponents.concat(state.extraComponents);</span>
<a href="#l73.24"></a><span id="l73.24"> </span>
<a href="#l73.25"></a><span id="l73.25">       if (aAsyncParsing) {</span>
<a href="#l73.26"></a><span id="l73.26">         aAsyncParsing.onParsingComplete(Cr.NS_OK, self);</span>
<a href="#l73.27"></a><span id="l73.27">       }</span>
<a href="#l73.28"></a><span id="l73.28">     });</span>
<a href="#l73.29"></a><span id="l73.29">   },</span>
<a href="#l73.30"></a><span id="l73.30"> </span>
<a href="#l73.31"></a><span id="l73.31" class="difflineminus">-  parseString: function(aICSString, aTzProvider, aAsyncParsing) {</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+  parseString(aICSString, aTzProvider, aAsyncParsing) {</span>
<a href="#l73.33"></a><span id="l73.33">     if (aAsyncParsing) {</span>
<a href="#l73.34"></a><span id="l73.34">       let self = this;</span>
<a href="#l73.35"></a><span id="l73.35"> </span>
<a href="#l73.36"></a><span id="l73.36">       // We are using two types of very similar listeners here:</span>
<a href="#l73.37"></a><span id="l73.37">       // aAsyncParsing is a calIcsParsingListener that returns the ics</span>
<a href="#l73.38"></a><span id="l73.38">       //   parser containing the processed items.</span>
<a href="#l73.39"></a><span id="l73.39">       // The listener passed to parseICSAsync is a calICsComponentParsingListener</span>
<a href="#l73.40"></a><span id="l73.40">       //   required by the ics service, that receives the parsed root component.</span>
<a href="#l73.41"></a><span id="l73.41">       cal.getIcsService().parseICSAsync(aICSString, aTzProvider, {</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-        onParsingComplete: function(rc, rootComp) {</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+        onParsingComplete(rc, rootComp) {</span>
<a href="#l73.44"></a><span id="l73.44">           if (Components.isSuccessCode(rc)) {</span>
<a href="#l73.45"></a><span id="l73.45">             self.processIcalComponent(rootComp, aAsyncParsing);</span>
<a href="#l73.46"></a><span id="l73.46">           } else {</span>
<a href="#l73.47"></a><span id="l73.47">             cal.ERROR(&quot;Error Parsing ICS: &quot; + rc);</span>
<a href="#l73.48"></a><span id="l73.48">             aAsyncParsing.onParsingComplete(rc, self);</span>
<a href="#l73.49"></a><span id="l73.49">           }</span>
<a href="#l73.50"></a><span id="l73.50">         },</span>
<a href="#l73.51"></a><span id="l73.51">       });</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineat">@@ -150,40 +150,40 @@ calIcsParser.prototype = {</span>
<a href="#l73.53"></a><span id="l73.53">         }</span>
<a href="#l73.54"></a><span id="l73.54">         this.processIcalComponent(icalComp);</span>
<a href="#l73.55"></a><span id="l73.55">       } catch (exc) {</span>
<a href="#l73.56"></a><span id="l73.56">         cal.ERROR(exc.message + &quot; when parsing\n&quot; + aICSString);</span>
<a href="#l73.57"></a><span id="l73.57">       }</span>
<a href="#l73.58"></a><span id="l73.58">     }</span>
<a href="#l73.59"></a><span id="l73.59">   },</span>
<a href="#l73.60"></a><span id="l73.60"> </span>
<a href="#l73.61"></a><span id="l73.61" class="difflineminus">-  parseFromStream: function(aStream, aTzProvider, aAsyncParsing) {</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineplus">+  parseFromStream(aStream, aTzProvider, aAsyncParsing) {</span>
<a href="#l73.63"></a><span id="l73.63">     // Read in the string. Note that it isn't a real string at this point,</span>
<a href="#l73.64"></a><span id="l73.64">     // because likely, the file is utf8. The multibyte chars show up as multiple</span>
<a href="#l73.65"></a><span id="l73.65">     // 'chars' in this string. So call it an array of octets for now.</span>
<a href="#l73.66"></a><span id="l73.66"> </span>
<a href="#l73.67"></a><span id="l73.67">     let stringData = NetUtil.readInputStreamToString(aStream, aStream.available(), {</span>
<a href="#l73.68"></a><span id="l73.68">       charset: &quot;utf-8&quot;,</span>
<a href="#l73.69"></a><span id="l73.69">     });</span>
<a href="#l73.70"></a><span id="l73.70">     this.parseString(stringData, aTzProvider, aAsyncParsing);</span>
<a href="#l73.71"></a><span id="l73.71">   },</span>
<a href="#l73.72"></a><span id="l73.72"> </span>
<a href="#l73.73"></a><span id="l73.73" class="difflineminus">-  getItems: function() {</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+  getItems() {</span>
<a href="#l73.75"></a><span id="l73.75">     return this.mItems.concat([]);</span>
<a href="#l73.76"></a><span id="l73.76">   },</span>
<a href="#l73.77"></a><span id="l73.77"> </span>
<a href="#l73.78"></a><span id="l73.78" class="difflineminus">-  getParentlessItems: function() {</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+  getParentlessItems() {</span>
<a href="#l73.80"></a><span id="l73.80">     return this.mParentlessItems.concat([]);</span>
<a href="#l73.81"></a><span id="l73.81">   },</span>
<a href="#l73.82"></a><span id="l73.82"> </span>
<a href="#l73.83"></a><span id="l73.83" class="difflineminus">-  getProperties: function() {</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+  getProperties() {</span>
<a href="#l73.85"></a><span id="l73.85">     return this.mProperties.concat([]);</span>
<a href="#l73.86"></a><span id="l73.86">   },</span>
<a href="#l73.87"></a><span id="l73.87"> </span>
<a href="#l73.88"></a><span id="l73.88" class="difflineminus">-  getComponents: function() {</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+  getComponents() {</span>
<a href="#l73.90"></a><span id="l73.90">     return this.mComponents.concat([]);</span>
<a href="#l73.91"></a><span id="l73.91">   },</span>
<a href="#l73.92"></a><span id="l73.92"> };</span>
<a href="#l73.93"></a><span id="l73.93"> </span>
<a href="#l73.94"></a><span id="l73.94"> /**</span>
<a href="#l73.95"></a><span id="l73.95">  * The parser state, which helps process ical components without clogging up the</span>
<a href="#l73.96"></a><span id="l73.96">  * event queue.</span>
<a href="#l73.97"></a><span id="l73.97">  *</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineat">@@ -213,17 +213,17 @@ parserState.prototype = {</span>
<a href="#l73.99"></a><span id="l73.99">   listener: null,</span>
<a href="#l73.100"></a><span id="l73.100"> </span>
<a href="#l73.101"></a><span id="l73.101">   /**</span>
<a href="#l73.102"></a><span id="l73.102">    * Checks if the timezones are missing and notifies the user via error console</span>
<a href="#l73.103"></a><span id="l73.103">    *</span>
<a href="#l73.104"></a><span id="l73.104">    * @param item      The item to check for</span>
<a href="#l73.105"></a><span id="l73.105">    * @param date      The datetime object to check with</span>
<a href="#l73.106"></a><span id="l73.106">    */</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineminus">-  checkTimezone: function(item, date) {</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+  checkTimezone(item, date) {</span>
<a href="#l73.109"></a><span id="l73.109">     function isPhantomTimezone(timezone) {</span>
<a href="#l73.110"></a><span id="l73.110">       return !timezone.icalComponent &amp;&amp; !timezone.isUTC &amp;&amp; !timezone.isFloating;</span>
<a href="#l73.111"></a><span id="l73.111">     }</span>
<a href="#l73.112"></a><span id="l73.112"> </span>
<a href="#l73.113"></a><span id="l73.113">     if (date &amp;&amp; isPhantomTimezone(date.timezone)) {</span>
<a href="#l73.114"></a><span id="l73.114">       let tzid = date.timezone.tzid;</span>
<a href="#l73.115"></a><span id="l73.115">       let hid = item.hashId + &quot;#&quot; + tzid;</span>
<a href="#l73.116"></a><span id="l73.116">       if (!(hid in this.tzErrors)) {</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineat">@@ -241,20 +241,20 @@ parserState.prototype = {</span>
<a href="#l73.118"></a><span id="l73.118">     }</span>
<a href="#l73.119"></a><span id="l73.119">   },</span>
<a href="#l73.120"></a><span id="l73.120"> </span>
<a href="#l73.121"></a><span id="l73.121">   /**</span>
<a href="#l73.122"></a><span id="l73.122">    * Submit processing of a subcomponent to the event queue</span>
<a href="#l73.123"></a><span id="l73.123">    *</span>
<a href="#l73.124"></a><span id="l73.124">    * @param subComp       The component to process</span>
<a href="#l73.125"></a><span id="l73.125">    */</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineminus">-  submit: function(subComp) {</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+  submit(subComp) {</span>
<a href="#l73.128"></a><span id="l73.128">     let self = this;</span>
<a href="#l73.129"></a><span id="l73.129">     let runner = {</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineminus">-      run: function() {</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+      run() {</span>
<a href="#l73.132"></a><span id="l73.132">         let item = null;</span>
<a href="#l73.133"></a><span id="l73.133">         switch (subComp.componentType) {</span>
<a href="#l73.134"></a><span id="l73.134">           case &quot;VEVENT&quot;:</span>
<a href="#l73.135"></a><span id="l73.135">             item = cal.createEvent();</span>
<a href="#l73.136"></a><span id="l73.136">             item.icalComponent = subComp;</span>
<a href="#l73.137"></a><span id="l73.137">             self.checkTimezone(item, item.startDate);</span>
<a href="#l73.138"></a><span id="l73.138">             self.checkTimezone(item, item.endDate);</span>
<a href="#l73.139"></a><span id="l73.139">             break;</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineat">@@ -303,26 +303,26 @@ parserState.prototype = {</span>
<a href="#l73.141"></a><span id="l73.141">   },</span>
<a href="#l73.142"></a><span id="l73.142"> </span>
<a href="#l73.143"></a><span id="l73.143">   /**</span>
<a href="#l73.144"></a><span id="l73.144">    * Checks if the processing of all events has completed. If a join function</span>
<a href="#l73.145"></a><span id="l73.145">    * has been set, this function is called.</span>
<a href="#l73.146"></a><span id="l73.146">    *</span>
<a href="#l73.147"></a><span id="l73.147">    * @return      True, if all tasks have been completed</span>
<a href="#l73.148"></a><span id="l73.148">    */</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineminus">-  checkCompletion: function() {</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+  checkCompletion() {</span>
<a href="#l73.151"></a><span id="l73.151">     if (this.joinFunc &amp;&amp; this.threadCount == 0) {</span>
<a href="#l73.152"></a><span id="l73.152">       this.joinFunc();</span>
<a href="#l73.153"></a><span id="l73.153">       return true;</span>
<a href="#l73.154"></a><span id="l73.154">     }</span>
<a href="#l73.155"></a><span id="l73.155">     return false;</span>
<a href="#l73.156"></a><span id="l73.156">   },</span>
<a href="#l73.157"></a><span id="l73.157"> </span>
<a href="#l73.158"></a><span id="l73.158">   /**</span>
<a href="#l73.159"></a><span id="l73.159">    * Sets a join function that is called when all tasks have been completed</span>
<a href="#l73.160"></a><span id="l73.160">    *</span>
<a href="#l73.161"></a><span id="l73.161">    * @param joinFunc      The join function to call</span>
<a href="#l73.162"></a><span id="l73.162">    */</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineminus">-  join: function(joinFunc) {</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+  join(joinFunc) {</span>
<a href="#l73.165"></a><span id="l73.165">     this.joinFunc = joinFunc;</span>
<a href="#l73.166"></a><span id="l73.166">     this.checkCompletion();</span>
<a href="#l73.167"></a><span id="l73.167">   },</span>
<a href="#l73.168"></a><span id="l73.168"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/calendar/base/src/calIcsSerializer.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/calendar/base/src/calIcsSerializer.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -9,55 +9,55 @@ function calIcsSerializer() {</span>
<a href="#l74.4"></a><span id="l74.4">   this.mItems = [];</span>
<a href="#l74.5"></a><span id="l74.5">   this.mProperties = [];</span>
<a href="#l74.6"></a><span id="l74.6">   this.mComponents = [];</span>
<a href="#l74.7"></a><span id="l74.7"> }</span>
<a href="#l74.8"></a><span id="l74.8"> calIcsSerializer.prototype = {</span>
<a href="#l74.9"></a><span id="l74.9">   QueryInterface: ChromeUtils.generateQI([Ci.calIIcsSerializer]),</span>
<a href="#l74.10"></a><span id="l74.10">   classID: Components.ID(&quot;{207a6682-8ff1-4203-9160-729ec28c8766}&quot;),</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-  addItems: function(aItems) {</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+  addItems(aItems) {</span>
<a href="#l74.14"></a><span id="l74.14">     if (aItems.length &gt; 0) {</span>
<a href="#l74.15"></a><span id="l74.15">       this.mItems = this.mItems.concat(aItems);</span>
<a href="#l74.16"></a><span id="l74.16">     }</span>
<a href="#l74.17"></a><span id="l74.17">   },</span>
<a href="#l74.18"></a><span id="l74.18"> </span>
<a href="#l74.19"></a><span id="l74.19" class="difflineminus">-  addProperty: function(aProperty) {</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+  addProperty(aProperty) {</span>
<a href="#l74.21"></a><span id="l74.21">     this.mProperties.push(aProperty);</span>
<a href="#l74.22"></a><span id="l74.22">   },</span>
<a href="#l74.23"></a><span id="l74.23"> </span>
<a href="#l74.24"></a><span id="l74.24" class="difflineminus">-  addComponent: function(aComponent) {</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineplus">+  addComponent(aComponent) {</span>
<a href="#l74.26"></a><span id="l74.26">     this.mComponents.push(aComponent);</span>
<a href="#l74.27"></a><span id="l74.27">   },</span>
<a href="#l74.28"></a><span id="l74.28"> </span>
<a href="#l74.29"></a><span id="l74.29" class="difflineminus">-  serializeToString: function() {</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineplus">+  serializeToString() {</span>
<a href="#l74.31"></a><span id="l74.31">     let calComp = this.getIcalComponent();</span>
<a href="#l74.32"></a><span id="l74.32">     return calComp.serializeToICS();</span>
<a href="#l74.33"></a><span id="l74.33">   },</span>
<a href="#l74.34"></a><span id="l74.34"> </span>
<a href="#l74.35"></a><span id="l74.35" class="difflineminus">-  serializeToInputStream: function(aStream) {</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+  serializeToInputStream(aStream) {</span>
<a href="#l74.37"></a><span id="l74.37">     let calComp = this.getIcalComponent();</span>
<a href="#l74.38"></a><span id="l74.38">     return calComp.serializeToICSStream();</span>
<a href="#l74.39"></a><span id="l74.39">   },</span>
<a href="#l74.40"></a><span id="l74.40"> </span>
<a href="#l74.41"></a><span id="l74.41" class="difflineminus">-  serializeToStream: function(aStream) {</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+  serializeToStream(aStream) {</span>
<a href="#l74.43"></a><span id="l74.43">     let str = this.serializeToString();</span>
<a href="#l74.44"></a><span id="l74.44"> </span>
<a href="#l74.45"></a><span id="l74.45">     // Convert the javascript string to an array of bytes, using the</span>
<a href="#l74.46"></a><span id="l74.46">     // UTF8 encoder</span>
<a href="#l74.47"></a><span id="l74.47">     let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].createInstance(</span>
<a href="#l74.48"></a><span id="l74.48">       Ci.nsIConverterOutputStream</span>
<a href="#l74.49"></a><span id="l74.49">     );</span>
<a href="#l74.50"></a><span id="l74.50">     convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l74.51"></a><span id="l74.51"> </span>
<a href="#l74.52"></a><span id="l74.52">     convStream.writeString(str);</span>
<a href="#l74.53"></a><span id="l74.53">     convStream.close();</span>
<a href="#l74.54"></a><span id="l74.54">   },</span>
<a href="#l74.55"></a><span id="l74.55"> </span>
<a href="#l74.56"></a><span id="l74.56" class="difflineminus">-  getIcalComponent: function() {</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineplus">+  getIcalComponent() {</span>
<a href="#l74.58"></a><span id="l74.58">     let calComp = cal.getIcsService().createIcalComponent(&quot;VCALENDAR&quot;);</span>
<a href="#l74.59"></a><span id="l74.59">     cal.item.setStaticProps(calComp);</span>
<a href="#l74.60"></a><span id="l74.60"> </span>
<a href="#l74.61"></a><span id="l74.61">     // xxx todo: think about that the below code doesn't clone the properties/components,</span>
<a href="#l74.62"></a><span id="l74.62">     //           thus ownership is moved to returned VCALENDAR...</span>
<a href="#l74.63"></a><span id="l74.63"> </span>
<a href="#l74.64"></a><span id="l74.64">     for (let prop of this.mProperties) {</span>
<a href="#l74.65"></a><span id="l74.65">       calComp.addProperty(prop);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/calendar/base/src/calItemBase.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/calendar/base/src/calItemBase.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -38,17 +38,17 @@ calItemBase.prototype = {</span>
<a href="#l75.4"></a><span id="l75.4">   mCategories: null,</span>
<a href="#l75.5"></a><span id="l75.5"> </span>
<a href="#l75.6"></a><span id="l75.6">   mACLEntry: null,</span>
<a href="#l75.7"></a><span id="l75.7"> </span>
<a href="#l75.8"></a><span id="l75.8">   /**</span>
<a href="#l75.9"></a><span id="l75.9">    * Initialize the base item's attributes. Can be called from inheriting</span>
<a href="#l75.10"></a><span id="l75.10">    * objects in their constructor.</span>
<a href="#l75.11"></a><span id="l75.11">    */</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-  initItemBase: function() {</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+  initItemBase() {</span>
<a href="#l75.14"></a><span id="l75.14">     this.wrappedJSObject = this;</span>
<a href="#l75.15"></a><span id="l75.15">     this.mProperties = new Map();</span>
<a href="#l75.16"></a><span id="l75.16">     this.mPropertyParams = {};</span>
<a href="#l75.17"></a><span id="l75.17">     this.mProperties.set(&quot;CREATED&quot;, cal.dtz.jsDateToDateTime(new Date()));</span>
<a href="#l75.18"></a><span id="l75.18">   },</span>
<a href="#l75.19"></a><span id="l75.19"> </span>
<a href="#l75.20"></a><span id="l75.20">   /**</span>
<a href="#l75.21"></a><span id="l75.21">    * @see nsISupports</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineat">@@ -138,17 +138,17 @@ calItemBase.prototype = {</span>
<a href="#l75.23"></a><span id="l75.23">    *</span>
<a href="#l75.24"></a><span id="l75.24">    * XXXdbo Explain proxy a bit better, either here or in</span>
<a href="#l75.25"></a><span id="l75.25">    * calIInternalShallowCopy.</span>
<a href="#l75.26"></a><span id="l75.26">    *</span>
<a href="#l75.27"></a><span id="l75.27">    * @see calIInternalShallowCopy</span>
<a href="#l75.28"></a><span id="l75.28">    * @param aParentItem     The parent item to initialize the proxy on.</span>
<a href="#l75.29"></a><span id="l75.29">    * @param aRecurrenceId   The recurrence id to initialize the proxy for.</span>
<a href="#l75.30"></a><span id="l75.30">    */</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineminus">-  initializeProxy: function(aParentItem, aRecurrenceId) {</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+  initializeProxy(aParentItem, aRecurrenceId) {</span>
<a href="#l75.33"></a><span id="l75.33">     this.mIsProxy = true;</span>
<a href="#l75.34"></a><span id="l75.34"> </span>
<a href="#l75.35"></a><span id="l75.35">     aParentItem = cal.unwrapInstance(aParentItem);</span>
<a href="#l75.36"></a><span id="l75.36">     this.mParentItem = aParentItem;</span>
<a href="#l75.37"></a><span id="l75.37">     this.mCalendar = aParentItem.mCalendar;</span>
<a href="#l75.38"></a><span id="l75.38">     this.recurrenceId = aRecurrenceId;</span>
<a href="#l75.39"></a><span id="l75.39"> </span>
<a href="#l75.40"></a><span id="l75.40">     // Make sure organizer is unset, as the getter checks for this.</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineat">@@ -162,41 +162,41 @@ calItemBase.prototype = {</span>
<a href="#l75.42"></a><span id="l75.42">     return !this.mImmutable;</span>
<a href="#l75.43"></a><span id="l75.43">   },</span>
<a href="#l75.44"></a><span id="l75.44"> </span>
<a href="#l75.45"></a><span id="l75.45">   /**</span>
<a href="#l75.46"></a><span id="l75.46">    * This function should be called by all members that modify the item. It</span>
<a href="#l75.47"></a><span id="l75.47">    * checks if the item is immutable and throws accordingly, and sets the</span>
<a href="#l75.48"></a><span id="l75.48">    * mDirty property.</span>
<a href="#l75.49"></a><span id="l75.49">    */</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineminus">-  modify: function() {</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineplus">+  modify() {</span>
<a href="#l75.52"></a><span id="l75.52">     if (this.mImmutable) {</span>
<a href="#l75.53"></a><span id="l75.53">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l75.54"></a><span id="l75.54">     }</span>
<a href="#l75.55"></a><span id="l75.55">     this.mDirty = true;</span>
<a href="#l75.56"></a><span id="l75.56">   },</span>
<a href="#l75.57"></a><span id="l75.57"> </span>
<a href="#l75.58"></a><span id="l75.58">   /**</span>
<a href="#l75.59"></a><span id="l75.59">    * Makes sure the item is not dirty. If the item is dirty, properties like</span>
<a href="#l75.60"></a><span id="l75.60">    * LAST-MODIFIED and DTSTAMP are set to now.</span>
<a href="#l75.61"></a><span id="l75.61">    */</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineminus">-  ensureNotDirty: function() {</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+  ensureNotDirty() {</span>
<a href="#l75.64"></a><span id="l75.64">     if (this.mDirty) {</span>
<a href="#l75.65"></a><span id="l75.65">       let now = cal.dtz.jsDateToDateTime(new Date());</span>
<a href="#l75.66"></a><span id="l75.66">       this.setProperty(&quot;LAST-MODIFIED&quot;, now);</span>
<a href="#l75.67"></a><span id="l75.67">       this.setProperty(&quot;DTSTAMP&quot;, now);</span>
<a href="#l75.68"></a><span id="l75.68">       this.mDirty = false;</span>
<a href="#l75.69"></a><span id="l75.69">     }</span>
<a href="#l75.70"></a><span id="l75.70">   },</span>
<a href="#l75.71"></a><span id="l75.71"> </span>
<a href="#l75.72"></a><span id="l75.72">   /**</span>
<a href="#l75.73"></a><span id="l75.73">    * Makes all properties of the base item immutable. Can be called by</span>
<a href="#l75.74"></a><span id="l75.74">    * inheriting objects' makeImmutable method.</span>
<a href="#l75.75"></a><span id="l75.75">    */</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineminus">-  makeItemBaseImmutable: function() {</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineplus">+  makeItemBaseImmutable() {</span>
<a href="#l75.78"></a><span id="l75.78">     if (this.mImmutable) {</span>
<a href="#l75.79"></a><span id="l75.79">       return;</span>
<a href="#l75.80"></a><span id="l75.80">     }</span>
<a href="#l75.81"></a><span id="l75.81"> </span>
<a href="#l75.82"></a><span id="l75.82">     // make all our components immutable</span>
<a href="#l75.83"></a><span id="l75.83">     if (this.mRecurrenceInfo) {</span>
<a href="#l75.84"></a><span id="l75.84">       this.mRecurrenceInfo.makeImmutable();</span>
<a href="#l75.85"></a><span id="l75.85">     }</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineat">@@ -226,40 +226,40 @@ calItemBase.prototype = {</span>
<a href="#l75.87"></a><span id="l75.87">       this.mAlarmLastAck.makeImmutable();</span>
<a href="#l75.88"></a><span id="l75.88">     }</span>
<a href="#l75.89"></a><span id="l75.89"> </span>
<a href="#l75.90"></a><span id="l75.90">     this.ensureNotDirty();</span>
<a href="#l75.91"></a><span id="l75.91">     this.mImmutable = true;</span>
<a href="#l75.92"></a><span id="l75.92">   },</span>
<a href="#l75.93"></a><span id="l75.93"> </span>
<a href="#l75.94"></a><span id="l75.94">   // boolean hasSameIds(in calIItemBase aItem);</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineminus">-  hasSameIds: function(that) {</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineplus">+  hasSameIds(that) {</span>
<a href="#l75.97"></a><span id="l75.97">     return (</span>
<a href="#l75.98"></a><span id="l75.98">       that &amp;&amp;</span>
<a href="#l75.99"></a><span id="l75.99">       this.id == that.id &amp;&amp;</span>
<a href="#l75.100"></a><span id="l75.100">       (this.recurrenceId == that.recurrenceId || // both null</span>
<a href="#l75.101"></a><span id="l75.101">         (this.recurrenceId &amp;&amp;</span>
<a href="#l75.102"></a><span id="l75.102">           that.recurrenceId &amp;&amp;</span>
<a href="#l75.103"></a><span id="l75.103">           this.recurrenceId.compare(that.recurrenceId) == 0))</span>
<a href="#l75.104"></a><span id="l75.104">     );</span>
<a href="#l75.105"></a><span id="l75.105">   },</span>
<a href="#l75.106"></a><span id="l75.106"> </span>
<a href="#l75.107"></a><span id="l75.107">   // calIItemBase clone();</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineminus">-  clone: function() {</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineplus">+  clone() {</span>
<a href="#l75.110"></a><span id="l75.110">     return this.cloneShallow(this.mParentItem);</span>
<a href="#l75.111"></a><span id="l75.111">   },</span>
<a href="#l75.112"></a><span id="l75.112"> </span>
<a href="#l75.113"></a><span id="l75.113">   /**</span>
<a href="#l75.114"></a><span id="l75.114">    * Clones the base item's properties into the passed object, potentially</span>
<a href="#l75.115"></a><span id="l75.115">    * setting a new parent item.</span>
<a href="#l75.116"></a><span id="l75.116">    *</span>
<a href="#l75.117"></a><span id="l75.117">    * @param m     The item to clone this item into</span>
<a href="#l75.118"></a><span id="l75.118">    * @param aNewParent    (optional) The new parent item to set on m.</span>
<a href="#l75.119"></a><span id="l75.119">    */</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineminus">-  cloneItemBaseInto: function(cloned, aNewParent) {</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineplus">+  cloneItemBaseInto(cloned, aNewParent) {</span>
<a href="#l75.122"></a><span id="l75.122">     cloned.mImmutable = false;</span>
<a href="#l75.123"></a><span id="l75.123">     cloned.mACLEntry = this.mACLEntry;</span>
<a href="#l75.124"></a><span id="l75.124">     cloned.mIsProxy = this.mIsProxy;</span>
<a href="#l75.125"></a><span id="l75.125">     cloned.mParentItem = cal.unwrapInstance(aNewParent) || this.mParentItem;</span>
<a href="#l75.126"></a><span id="l75.126">     cloned.mHashId = this.mHashId;</span>
<a href="#l75.127"></a><span id="l75.127">     cloned.mCalendar = this.mCalendar;</span>
<a href="#l75.128"></a><span id="l75.128">     if (this.mRecurrenceInfo) {</span>
<a href="#l75.129"></a><span id="l75.129">       cloned.mRecurrenceInfo = cal.unwrapInstance(this.mRecurrenceInfo.clone());</span>
<a href="#l75.130"></a><span id="l75.130" class="difflineat">@@ -362,84 +362,83 @@ calItemBase.prototype = {</span>
<a href="#l75.131"></a><span id="l75.131">         })()</span>
<a href="#l75.132"></a><span id="l75.132">       );</span>
<a href="#l75.133"></a><span id="l75.133">     }</span>
<a href="#l75.134"></a><span id="l75.134"> </span>
<a href="#l75.135"></a><span id="l75.135">     return properties.entries();</span>
<a href="#l75.136"></a><span id="l75.136">   },</span>
<a href="#l75.137"></a><span id="l75.137"> </span>
<a href="#l75.138"></a><span id="l75.138">   // nsIVariant getProperty(in AString name);</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l75.141"></a><span id="l75.141">     let name = aName.toUpperCase();</span>
<a href="#l75.142"></a><span id="l75.142">     if (this.mProperties.has(name)) {</span>
<a href="#l75.143"></a><span id="l75.143">       return this.mProperties.get(name);</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineminus">-    } else {</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineminus">-      return this.mIsProxy ? this.mParentItem.getProperty(name) : null;</span>
<a href="#l75.146"></a><span id="l75.146">     }</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineplus">+    return this.mIsProxy ? this.mParentItem.getProperty(name) : null;</span>
<a href="#l75.148"></a><span id="l75.148">   },</span>
<a href="#l75.149"></a><span id="l75.149"> </span>
<a href="#l75.150"></a><span id="l75.150">   // boolean hasProperty(in AString name);</span>
<a href="#l75.151"></a><span id="l75.151" class="difflineminus">-  hasProperty: function(aName) {</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineplus">+  hasProperty(aName) {</span>
<a href="#l75.153"></a><span id="l75.153">     return this.getProperty(aName.toUpperCase()) != null;</span>
<a href="#l75.154"></a><span id="l75.154">   },</span>
<a href="#l75.155"></a><span id="l75.155"> </span>
<a href="#l75.156"></a><span id="l75.156">   // void setProperty(in AString name, in nsIVariant value);</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineplus">+  setProperty(aName, aValue) {</span>
<a href="#l75.159"></a><span id="l75.159">     this.modify();</span>
<a href="#l75.160"></a><span id="l75.160">     aName = aName.toUpperCase();</span>
<a href="#l75.161"></a><span id="l75.161">     if (aValue || !isNaN(parseInt(aValue, 10))) {</span>
<a href="#l75.162"></a><span id="l75.162">       this.mProperties.set(aName, aValue);</span>
<a href="#l75.163"></a><span id="l75.163">     } else {</span>
<a href="#l75.164"></a><span id="l75.164">       this.deleteProperty(aName);</span>
<a href="#l75.165"></a><span id="l75.165">     }</span>
<a href="#l75.166"></a><span id="l75.166">     if (aName == &quot;LAST-MODIFIED&quot;) {</span>
<a href="#l75.167"></a><span id="l75.167">       // setting LAST-MODIFIED cleans/undirties the item, we use this for preserving DTSTAMP</span>
<a href="#l75.168"></a><span id="l75.168">       this.mDirty = false;</span>
<a href="#l75.169"></a><span id="l75.169">     }</span>
<a href="#l75.170"></a><span id="l75.170">   },</span>
<a href="#l75.171"></a><span id="l75.171"> </span>
<a href="#l75.172"></a><span id="l75.172">   // void deleteProperty(in AString name);</span>
<a href="#l75.173"></a><span id="l75.173" class="difflineminus">-  deleteProperty: function(aName) {</span>
<a href="#l75.174"></a><span id="l75.174" class="difflineplus">+  deleteProperty(aName) {</span>
<a href="#l75.175"></a><span id="l75.175">     this.modify();</span>
<a href="#l75.176"></a><span id="l75.176">     aName = aName.toUpperCase();</span>
<a href="#l75.177"></a><span id="l75.177">     if (this.mIsProxy) {</span>
<a href="#l75.178"></a><span id="l75.178">       // deleting a proxy's property will mark the bag's item as null, so we could</span>
<a href="#l75.179"></a><span id="l75.179">       // distinguish it when enumerating/getting properties from the undefined ones.</span>
<a href="#l75.180"></a><span id="l75.180">       this.mProperties.set(aName, null);</span>
<a href="#l75.181"></a><span id="l75.181">     } else {</span>
<a href="#l75.182"></a><span id="l75.182">       this.mProperties.delete(aName);</span>
<a href="#l75.183"></a><span id="l75.183">     }</span>
<a href="#l75.184"></a><span id="l75.184">     delete this.mPropertyParams[aName];</span>
<a href="#l75.185"></a><span id="l75.185">   },</span>
<a href="#l75.186"></a><span id="l75.186"> </span>
<a href="#l75.187"></a><span id="l75.187">   // AString getPropertyParameter(in AString aPropertyName,</span>
<a href="#l75.188"></a><span id="l75.188">   //                              in AString aParameterName);</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineminus">-  getPropertyParameter: function(aPropName, aParamName) {</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineplus">+  getPropertyParameter(aPropName, aParamName) {</span>
<a href="#l75.191"></a><span id="l75.191">     let propName = aPropName.toUpperCase();</span>
<a href="#l75.192"></a><span id="l75.192">     let paramName = aParamName.toUpperCase();</span>
<a href="#l75.193"></a><span id="l75.193">     if (propName in this.mPropertyParams &amp;&amp; paramName in this.mPropertyParams[propName]) {</span>
<a href="#l75.194"></a><span id="l75.194">       // If the property is not in mPropertyParams, then this just means</span>
<a href="#l75.195"></a><span id="l75.195">       // there are no properties set.</span>
<a href="#l75.196"></a><span id="l75.196">       return this.mPropertyParams[propName][paramName];</span>
<a href="#l75.197"></a><span id="l75.197">     }</span>
<a href="#l75.198"></a><span id="l75.198">     return null;</span>
<a href="#l75.199"></a><span id="l75.199">   },</span>
<a href="#l75.200"></a><span id="l75.200"> </span>
<a href="#l75.201"></a><span id="l75.201">   // boolean hasPropertyParameter(in AString aPropertyName,</span>
<a href="#l75.202"></a><span id="l75.202">   //                              in AString aParameterName);</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineminus">-  hasPropertyParameter: function(aPropName, aParamName) {</span>
<a href="#l75.204"></a><span id="l75.204" class="difflineplus">+  hasPropertyParameter(aPropName, aParamName) {</span>
<a href="#l75.205"></a><span id="l75.205">     let propName = aPropName.toUpperCase();</span>
<a href="#l75.206"></a><span id="l75.206">     let paramName = aParamName.toUpperCase();</span>
<a href="#l75.207"></a><span id="l75.207">     return propName in this.mPropertyParams &amp;&amp; paramName in this.mPropertyParams[propName];</span>
<a href="#l75.208"></a><span id="l75.208">   },</span>
<a href="#l75.209"></a><span id="l75.209"> </span>
<a href="#l75.210"></a><span id="l75.210">   // void setPropertyParameter(in AString aPropertyName,</span>
<a href="#l75.211"></a><span id="l75.211">   //                           in AString aParameterName,</span>
<a href="#l75.212"></a><span id="l75.212">   //                           in AUTF8String aParameterValue);</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineminus">-  setPropertyParameter: function(aPropName, aParamName, aParamValue) {</span>
<a href="#l75.214"></a><span id="l75.214" class="difflineplus">+  setPropertyParameter(aPropName, aParamName, aParamValue) {</span>
<a href="#l75.215"></a><span id="l75.215">     let propName = aPropName.toUpperCase();</span>
<a href="#l75.216"></a><span id="l75.216">     let paramName = aParamName.toUpperCase();</span>
<a href="#l75.217"></a><span id="l75.217">     this.modify();</span>
<a href="#l75.218"></a><span id="l75.218">     if (!(propName in this.mPropertyParams)) {</span>
<a href="#l75.219"></a><span id="l75.219">       if (this.hasProperty(propName)) {</span>
<a href="#l75.220"></a><span id="l75.220">         this.mPropertyParams[propName] = {};</span>
<a href="#l75.221"></a><span id="l75.221">       } else {</span>
<a href="#l75.222"></a><span id="l75.222">         throw new Error(&quot;Property &quot; + aPropName + &quot; not set&quot;);</span>
<a href="#l75.223"></a><span id="l75.223" class="difflineat">@@ -449,72 +448,71 @@ calItemBase.prototype = {</span>
<a href="#l75.224"></a><span id="l75.224">       this.mPropertyParams[propName][paramName] = aParamValue;</span>
<a href="#l75.225"></a><span id="l75.225">     } else {</span>
<a href="#l75.226"></a><span id="l75.226">       delete this.mPropertyParams[propName][paramName];</span>
<a href="#l75.227"></a><span id="l75.227">     }</span>
<a href="#l75.228"></a><span id="l75.228">     return aParamValue;</span>
<a href="#l75.229"></a><span id="l75.229">   },</span>
<a href="#l75.230"></a><span id="l75.230"> </span>
<a href="#l75.231"></a><span id="l75.231">   // nsISimpleEnumerator getParameterEnumerator(in AString aPropertyName);</span>
<a href="#l75.232"></a><span id="l75.232" class="difflineminus">-  getParameterEnumerator: function(aPropName) {</span>
<a href="#l75.233"></a><span id="l75.233" class="difflineplus">+  getParameterEnumerator(aPropName) {</span>
<a href="#l75.234"></a><span id="l75.234">     let propName = aPropName.toUpperCase();</span>
<a href="#l75.235"></a><span id="l75.235">     if (!(propName in this.mPropertyParams)) {</span>
<a href="#l75.236"></a><span id="l75.236">       throw new Error(&quot;Property &quot; + aPropName + &quot; not set&quot;);</span>
<a href="#l75.237"></a><span id="l75.237">     }</span>
<a href="#l75.238"></a><span id="l75.238">     let parameters = this.mPropertyParams[propName];</span>
<a href="#l75.239"></a><span id="l75.239">     return {</span>
<a href="#l75.240"></a><span id="l75.240">       // nsISimpleEnumerator</span>
<a href="#l75.241"></a><span id="l75.241">       QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l75.242"></a><span id="l75.242"> </span>
<a href="#l75.243"></a><span id="l75.243">       mParamNames: Object.keys(parameters),</span>
<a href="#l75.244"></a><span id="l75.244" class="difflineminus">-      hasMoreElements: function() {</span>
<a href="#l75.245"></a><span id="l75.245" class="difflineplus">+      hasMoreElements() {</span>
<a href="#l75.246"></a><span id="l75.246">         return this.mParamNames.length &gt; 0;</span>
<a href="#l75.247"></a><span id="l75.247">       },</span>
<a href="#l75.248"></a><span id="l75.248"> </span>
<a href="#l75.249"></a><span id="l75.249" class="difflineminus">-      getNext: function() {</span>
<a href="#l75.250"></a><span id="l75.250" class="difflineplus">+      getNext() {</span>
<a href="#l75.251"></a><span id="l75.251">         let paramName = this.mParamNames.pop();</span>
<a href="#l75.252"></a><span id="l75.252">         return {</span>
<a href="#l75.253"></a><span id="l75.253">           // nsIProperty</span>
<a href="#l75.254"></a><span id="l75.254">           QueryInterface: ChromeUtils.generateQI([Ci.nsIProperty]),</span>
<a href="#l75.255"></a><span id="l75.255">           name: paramName,</span>
<a href="#l75.256"></a><span id="l75.256">           value: parameters[paramName],</span>
<a href="#l75.257"></a><span id="l75.257">         };</span>
<a href="#l75.258"></a><span id="l75.258">       },</span>
<a href="#l75.259"></a><span id="l75.259">     };</span>
<a href="#l75.260"></a><span id="l75.260">   },</span>
<a href="#l75.261"></a><span id="l75.261"> </span>
<a href="#l75.262"></a><span id="l75.262">   // void getAttendees(out PRUint32 count,</span>
<a href="#l75.263"></a><span id="l75.263">   //                   [array,size_is(count),retval] out calIAttendee attendees);</span>
<a href="#l75.264"></a><span id="l75.264" class="difflineminus">-  getAttendees: function() {</span>
<a href="#l75.265"></a><span id="l75.265" class="difflineplus">+  getAttendees() {</span>
<a href="#l75.266"></a><span id="l75.266">     if (!this.mAttendees &amp;&amp; this.mIsProxy) {</span>
<a href="#l75.267"></a><span id="l75.267">       this.mAttendees = this.mParentItem.getAttendees();</span>
<a href="#l75.268"></a><span id="l75.268">     }</span>
<a href="#l75.269"></a><span id="l75.269">     if (this.mAttendees) {</span>
<a href="#l75.270"></a><span id="l75.270">       return this.mAttendees.concat([]); // clone</span>
<a href="#l75.271"></a><span id="l75.271" class="difflineminus">-    } else {</span>
<a href="#l75.272"></a><span id="l75.272" class="difflineminus">-      return [];</span>
<a href="#l75.273"></a><span id="l75.273">     }</span>
<a href="#l75.274"></a><span id="l75.274" class="difflineplus">+    return [];</span>
<a href="#l75.275"></a><span id="l75.275">   },</span>
<a href="#l75.276"></a><span id="l75.276"> </span>
<a href="#l75.277"></a><span id="l75.277">   // calIAttendee getAttendeeById(in AUTF8String id);</span>
<a href="#l75.278"></a><span id="l75.278" class="difflineminus">-  getAttendeeById: function(id) {</span>
<a href="#l75.279"></a><span id="l75.279" class="difflineplus">+  getAttendeeById(id) {</span>
<a href="#l75.280"></a><span id="l75.280">     let attendees = this.getAttendees();</span>
<a href="#l75.281"></a><span id="l75.281">     let lowerCaseId = id.toLowerCase();</span>
<a href="#l75.282"></a><span id="l75.282">     for (let attendee of attendees) {</span>
<a href="#l75.283"></a><span id="l75.283">       // This match must be case insensitive to deal with differing</span>
<a href="#l75.284"></a><span id="l75.284">       // cases of things like MAILTO:</span>
<a href="#l75.285"></a><span id="l75.285">       if (attendee.id.toLowerCase() == lowerCaseId) {</span>
<a href="#l75.286"></a><span id="l75.286">         return attendee;</span>
<a href="#l75.287"></a><span id="l75.287">       }</span>
<a href="#l75.288"></a><span id="l75.288">     }</span>
<a href="#l75.289"></a><span id="l75.289">     return null;</span>
<a href="#l75.290"></a><span id="l75.290">   },</span>
<a href="#l75.291"></a><span id="l75.291"> </span>
<a href="#l75.292"></a><span id="l75.292">   // void removeAttendee(in calIAttendee attendee);</span>
<a href="#l75.293"></a><span id="l75.293" class="difflineminus">-  removeAttendee: function(attendee) {</span>
<a href="#l75.294"></a><span id="l75.294" class="difflineplus">+  removeAttendee(attendee) {</span>
<a href="#l75.295"></a><span id="l75.295">     this.modify();</span>
<a href="#l75.296"></a><span id="l75.296">     let found = false,</span>
<a href="#l75.297"></a><span id="l75.297">       newAttendees = [];</span>
<a href="#l75.298"></a><span id="l75.298">     let attendees = this.getAttendees();</span>
<a href="#l75.299"></a><span id="l75.299">     let attIdLowerCase = attendee.id.toLowerCase();</span>
<a href="#l75.300"></a><span id="l75.300"> </span>
<a href="#l75.301"></a><span id="l75.301">     for (let i = 0; i &lt; attendees.length; i++) {</span>
<a href="#l75.302"></a><span id="l75.302">       if (attendees[i].id.toLowerCase() == attIdLowerCase) {</span>
<a href="#l75.303"></a><span id="l75.303" class="difflineat">@@ -524,23 +522,23 @@ calItemBase.prototype = {</span>
<a href="#l75.304"></a><span id="l75.304">       }</span>
<a href="#l75.305"></a><span id="l75.305">     }</span>
<a href="#l75.306"></a><span id="l75.306">     if (found) {</span>
<a href="#l75.307"></a><span id="l75.307">       this.mAttendees = newAttendees;</span>
<a href="#l75.308"></a><span id="l75.308">     }</span>
<a href="#l75.309"></a><span id="l75.309">   },</span>
<a href="#l75.310"></a><span id="l75.310"> </span>
<a href="#l75.311"></a><span id="l75.311">   // void removeAllAttendees();</span>
<a href="#l75.312"></a><span id="l75.312" class="difflineminus">-  removeAllAttendees: function() {</span>
<a href="#l75.313"></a><span id="l75.313" class="difflineplus">+  removeAllAttendees() {</span>
<a href="#l75.314"></a><span id="l75.314">     this.modify();</span>
<a href="#l75.315"></a><span id="l75.315">     this.mAttendees = [];</span>
<a href="#l75.316"></a><span id="l75.316">   },</span>
<a href="#l75.317"></a><span id="l75.317"> </span>
<a href="#l75.318"></a><span id="l75.318">   // void addAttendee(in calIAttendee attendee);</span>
<a href="#l75.319"></a><span id="l75.319" class="difflineminus">-  addAttendee: function(attendee) {</span>
<a href="#l75.320"></a><span id="l75.320" class="difflineplus">+  addAttendee(attendee) {</span>
<a href="#l75.321"></a><span id="l75.321">     // the duplicate check is migration code for bug 1204255</span>
<a href="#l75.322"></a><span id="l75.322">     let exists = this.getAttendeeById(attendee.id);</span>
<a href="#l75.323"></a><span id="l75.323">     if (exists) {</span>
<a href="#l75.324"></a><span id="l75.324">       cal.LOG(</span>
<a href="#l75.325"></a><span id="l75.325">         &quot;Ignoring attendee duplicate for item &quot; + this.id + &quot; (&quot; + this.title + &quot;): &quot; + exists.id</span>
<a href="#l75.326"></a><span id="l75.326">       );</span>
<a href="#l75.327"></a><span id="l75.327">       if (</span>
<a href="#l75.328"></a><span id="l75.328">         exists.participationStatus == &quot;NEEDS-ACTION&quot; ||</span>
<a href="#l75.329"></a><span id="l75.329" class="difflineat">@@ -573,139 +571,134 @@ calItemBase.prototype = {</span>
<a href="#l75.330"></a><span id="l75.330">       }</span>
<a href="#l75.331"></a><span id="l75.331">       this.modify();</span>
<a href="#l75.332"></a><span id="l75.332">       this.mAttendees = this.getAttendees();</span>
<a href="#l75.333"></a><span id="l75.333">       this.mAttendees.push(attendee);</span>
<a href="#l75.334"></a><span id="l75.334">     }</span>
<a href="#l75.335"></a><span id="l75.335">   },</span>
<a href="#l75.336"></a><span id="l75.336"> </span>
<a href="#l75.337"></a><span id="l75.337">   // Array&lt;calIAttachment&gt; getAttachments();</span>
<a href="#l75.338"></a><span id="l75.338" class="difflineminus">-  getAttachments: function() {</span>
<a href="#l75.339"></a><span id="l75.339" class="difflineplus">+  getAttachments() {</span>
<a href="#l75.340"></a><span id="l75.340">     if (!this.mAttachments &amp;&amp; this.mIsProxy) {</span>
<a href="#l75.341"></a><span id="l75.341">       this.mAttachments = this.mParentItem.getAttachments();</span>
<a href="#l75.342"></a><span id="l75.342">     }</span>
<a href="#l75.343"></a><span id="l75.343">     if (this.mAttachments) {</span>
<a href="#l75.344"></a><span id="l75.344">       return this.mAttachments.concat([]); // clone</span>
<a href="#l75.345"></a><span id="l75.345" class="difflineminus">-    } else {</span>
<a href="#l75.346"></a><span id="l75.346" class="difflineminus">-      return [];</span>
<a href="#l75.347"></a><span id="l75.347">     }</span>
<a href="#l75.348"></a><span id="l75.348" class="difflineplus">+    return [];</span>
<a href="#l75.349"></a><span id="l75.349">   },</span>
<a href="#l75.350"></a><span id="l75.350"> </span>
<a href="#l75.351"></a><span id="l75.351">   // void removeAttachment(in calIAttachment attachment);</span>
<a href="#l75.352"></a><span id="l75.352" class="difflineminus">-  removeAttachment: function(aAttachment) {</span>
<a href="#l75.353"></a><span id="l75.353" class="difflineplus">+  removeAttachment(aAttachment) {</span>
<a href="#l75.354"></a><span id="l75.354">     this.modify();</span>
<a href="#l75.355"></a><span id="l75.355">     for (let attIndex in this.mAttachments) {</span>
<a href="#l75.356"></a><span id="l75.356">       if (cal.data.compareObjects(this.mAttachments[attIndex], aAttachment, Ci.calIAttachment)) {</span>
<a href="#l75.357"></a><span id="l75.357">         this.modify();</span>
<a href="#l75.358"></a><span id="l75.358">         this.mAttachments.splice(attIndex, 1);</span>
<a href="#l75.359"></a><span id="l75.359">         break;</span>
<a href="#l75.360"></a><span id="l75.360">       }</span>
<a href="#l75.361"></a><span id="l75.361">     }</span>
<a href="#l75.362"></a><span id="l75.362">   },</span>
<a href="#l75.363"></a><span id="l75.363"> </span>
<a href="#l75.364"></a><span id="l75.364">   // void addAttachment(in calIAttachment attachment);</span>
<a href="#l75.365"></a><span id="l75.365" class="difflineminus">-  addAttachment: function(attachment) {</span>
<a href="#l75.366"></a><span id="l75.366" class="difflineplus">+  addAttachment(attachment) {</span>
<a href="#l75.367"></a><span id="l75.367">     this.modify();</span>
<a href="#l75.368"></a><span id="l75.368">     this.mAttachments = this.getAttachments();</span>
<a href="#l75.369"></a><span id="l75.369">     if (!this.mAttachments.some(x =&gt; x.hashId == attachment.hashId)) {</span>
<a href="#l75.370"></a><span id="l75.370">       this.mAttachments.push(attachment);</span>
<a href="#l75.371"></a><span id="l75.371">     }</span>
<a href="#l75.372"></a><span id="l75.372">   },</span>
<a href="#l75.373"></a><span id="l75.373"> </span>
<a href="#l75.374"></a><span id="l75.374">   // void removeAllAttachments();</span>
<a href="#l75.375"></a><span id="l75.375" class="difflineminus">-  removeAllAttachments: function() {</span>
<a href="#l75.376"></a><span id="l75.376" class="difflineplus">+  removeAllAttachments() {</span>
<a href="#l75.377"></a><span id="l75.377">     this.modify();</span>
<a href="#l75.378"></a><span id="l75.378">     this.mAttachments = [];</span>
<a href="#l75.379"></a><span id="l75.379">   },</span>
<a href="#l75.380"></a><span id="l75.380"> </span>
<a href="#l75.381"></a><span id="l75.381">   // Array&lt;calIRelation&gt; getRelations();</span>
<a href="#l75.382"></a><span id="l75.382" class="difflineminus">-  getRelations: function() {</span>
<a href="#l75.383"></a><span id="l75.383" class="difflineplus">+  getRelations() {</span>
<a href="#l75.384"></a><span id="l75.384">     if (!this.mRelations &amp;&amp; this.mIsProxy) {</span>
<a href="#l75.385"></a><span id="l75.385">       this.mRelations = this.mParentItem.getRelations();</span>
<a href="#l75.386"></a><span id="l75.386">     }</span>
<a href="#l75.387"></a><span id="l75.387">     if (this.mRelations) {</span>
<a href="#l75.388"></a><span id="l75.388">       return this.mRelations.concat([]);</span>
<a href="#l75.389"></a><span id="l75.389" class="difflineminus">-    } else {</span>
<a href="#l75.390"></a><span id="l75.390" class="difflineminus">-      return [];</span>
<a href="#l75.391"></a><span id="l75.391">     }</span>
<a href="#l75.392"></a><span id="l75.392" class="difflineplus">+    return [];</span>
<a href="#l75.393"></a><span id="l75.393">   },</span>
<a href="#l75.394"></a><span id="l75.394"> </span>
<a href="#l75.395"></a><span id="l75.395">   // void removeRelation(in calIRelation relation);</span>
<a href="#l75.396"></a><span id="l75.396" class="difflineminus">-  removeRelation: function(aRelation) {</span>
<a href="#l75.397"></a><span id="l75.397" class="difflineplus">+  removeRelation(aRelation) {</span>
<a href="#l75.398"></a><span id="l75.398">     this.modify();</span>
<a href="#l75.399"></a><span id="l75.399">     for (let attIndex in this.mRelations) {</span>
<a href="#l75.400"></a><span id="l75.400">       // Could we have the same item as parent and as child ?</span>
<a href="#l75.401"></a><span id="l75.401">       if (</span>
<a href="#l75.402"></a><span id="l75.402">         this.mRelations[attIndex].relId == aRelation.relId &amp;&amp;</span>
<a href="#l75.403"></a><span id="l75.403">         this.mRelations[attIndex].relType == aRelation.relType</span>
<a href="#l75.404"></a><span id="l75.404">       ) {</span>
<a href="#l75.405"></a><span id="l75.405">         this.modify();</span>
<a href="#l75.406"></a><span id="l75.406">         this.mRelations.splice(attIndex, 1);</span>
<a href="#l75.407"></a><span id="l75.407">         break;</span>
<a href="#l75.408"></a><span id="l75.408">       }</span>
<a href="#l75.409"></a><span id="l75.409">     }</span>
<a href="#l75.410"></a><span id="l75.410">   },</span>
<a href="#l75.411"></a><span id="l75.411"> </span>
<a href="#l75.412"></a><span id="l75.412">   // void addRelation(in calIRelation relation);</span>
<a href="#l75.413"></a><span id="l75.413" class="difflineminus">-  addRelation: function(aRelation) {</span>
<a href="#l75.414"></a><span id="l75.414" class="difflineplus">+  addRelation(aRelation) {</span>
<a href="#l75.415"></a><span id="l75.415">     this.modify();</span>
<a href="#l75.416"></a><span id="l75.416">     this.mRelations = this.getRelations();</span>
<a href="#l75.417"></a><span id="l75.417">     this.mRelations.push(aRelation);</span>
<a href="#l75.418"></a><span id="l75.418">     // XXX ensure that the relation isn't already there?</span>
<a href="#l75.419"></a><span id="l75.419">   },</span>
<a href="#l75.420"></a><span id="l75.420"> </span>
<a href="#l75.421"></a><span id="l75.421">   // void removeAllRelations();</span>
<a href="#l75.422"></a><span id="l75.422" class="difflineminus">-  removeAllRelations: function() {</span>
<a href="#l75.423"></a><span id="l75.423" class="difflineplus">+  removeAllRelations() {</span>
<a href="#l75.424"></a><span id="l75.424">     this.modify();</span>
<a href="#l75.425"></a><span id="l75.425">     this.mRelations = [];</span>
<a href="#l75.426"></a><span id="l75.426">   },</span>
<a href="#l75.427"></a><span id="l75.427"> </span>
<a href="#l75.428"></a><span id="l75.428">   // attribute calICalendar calendar;</span>
<a href="#l75.429"></a><span id="l75.429">   get calendar() {</span>
<a href="#l75.430"></a><span id="l75.430">     if (!this.mCalendar &amp;&amp; this.parentItem != this) {</span>
<a href="#l75.431"></a><span id="l75.431">       return this.parentItem.calendar;</span>
<a href="#l75.432"></a><span id="l75.432" class="difflineminus">-    } else {</span>
<a href="#l75.433"></a><span id="l75.433" class="difflineminus">-      return this.mCalendar;</span>
<a href="#l75.434"></a><span id="l75.434">     }</span>
<a href="#l75.435"></a><span id="l75.435" class="difflineplus">+    return this.mCalendar;</span>
<a href="#l75.436"></a><span id="l75.436">   },</span>
<a href="#l75.437"></a><span id="l75.437">   set calendar(calendar) {</span>
<a href="#l75.438"></a><span id="l75.438">     if (this.mImmutable) {</span>
<a href="#l75.439"></a><span id="l75.439">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l75.440"></a><span id="l75.440">     }</span>
<a href="#l75.441"></a><span id="l75.441">     this.mHashId = null; // recompute hashId</span>
<a href="#l75.442"></a><span id="l75.442">     this.mCalendar = calendar;</span>
<a href="#l75.443"></a><span id="l75.443">   },</span>
<a href="#l75.444"></a><span id="l75.444"> </span>
<a href="#l75.445"></a><span id="l75.445">   // attribute calIAttendee organizer;</span>
<a href="#l75.446"></a><span id="l75.446">   get organizer() {</span>
<a href="#l75.447"></a><span id="l75.447">     if (this.mIsProxy &amp;&amp; this.mOrganizer === undefined) {</span>
<a href="#l75.448"></a><span id="l75.448">       return this.mParentItem.organizer;</span>
<a href="#l75.449"></a><span id="l75.449" class="difflineminus">-    } else {</span>
<a href="#l75.450"></a><span id="l75.450" class="difflineminus">-      return this.mOrganizer;</span>
<a href="#l75.451"></a><span id="l75.451">     }</span>
<a href="#l75.452"></a><span id="l75.452" class="difflineplus">+    return this.mOrganizer;</span>
<a href="#l75.453"></a><span id="l75.453">   },</span>
<a href="#l75.454"></a><span id="l75.454">   set organizer(organizer) {</span>
<a href="#l75.455"></a><span id="l75.455">     this.modify();</span>
<a href="#l75.456"></a><span id="l75.456">     this.mOrganizer = organizer;</span>
<a href="#l75.457"></a><span id="l75.457">   },</span>
<a href="#l75.458"></a><span id="l75.458"> </span>
<a href="#l75.459"></a><span id="l75.459">   // Array&lt;AString&gt; getCategories();</span>
<a href="#l75.460"></a><span id="l75.460" class="difflineminus">-  getCategories: function() {</span>
<a href="#l75.461"></a><span id="l75.461" class="difflineplus">+  getCategories() {</span>
<a href="#l75.462"></a><span id="l75.462">     if (!this.mCategories &amp;&amp; this.mIsProxy) {</span>
<a href="#l75.463"></a><span id="l75.463">       this.mCategories = this.mParentItem.getCategories();</span>
<a href="#l75.464"></a><span id="l75.464">     }</span>
<a href="#l75.465"></a><span id="l75.465">     if (this.mCategories) {</span>
<a href="#l75.466"></a><span id="l75.466">       return this.mCategories.concat([]); // clone</span>
<a href="#l75.467"></a><span id="l75.467" class="difflineminus">-    } else {</span>
<a href="#l75.468"></a><span id="l75.468" class="difflineminus">-      return [];</span>
<a href="#l75.469"></a><span id="l75.469">     }</span>
<a href="#l75.470"></a><span id="l75.470" class="difflineplus">+    return [];</span>
<a href="#l75.471"></a><span id="l75.471">   },</span>
<a href="#l75.472"></a><span id="l75.472"> </span>
<a href="#l75.473"></a><span id="l75.473">   // void setCategories(in Array&lt;AString&gt; aCategories);</span>
<a href="#l75.474"></a><span id="l75.474" class="difflineminus">-  setCategories: function(aCategories) {</span>
<a href="#l75.475"></a><span id="l75.475" class="difflineplus">+  setCategories(aCategories) {</span>
<a href="#l75.476"></a><span id="l75.476">     this.modify();</span>
<a href="#l75.477"></a><span id="l75.477">     this.mCategories = aCategories.concat([]);</span>
<a href="#l75.478"></a><span id="l75.478">   },</span>
<a href="#l75.479"></a><span id="l75.479"> </span>
<a href="#l75.480"></a><span id="l75.480">   // attribute AUTF8String icalString;</span>
<a href="#l75.481"></a><span id="l75.481">   get icalString() {</span>
<a href="#l75.482"></a><span id="l75.482">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l75.483"></a><span id="l75.483">   },</span>
<a href="#l75.484"></a><span id="l75.484" class="difflineat">@@ -757,17 +750,17 @@ calItemBase.prototype = {</span>
<a href="#l75.485"></a><span id="l75.485"> </span>
<a href="#l75.486"></a><span id="l75.486">   /**</span>
<a href="#l75.487"></a><span id="l75.487">    * Walks through the propmap and sets all properties on this item from the</span>
<a href="#l75.488"></a><span id="l75.488">    * given icalcomp.</span>
<a href="#l75.489"></a><span id="l75.489">    *</span>
<a href="#l75.490"></a><span id="l75.490">    * @param icalcomp      The calIIcalComponent to read from.</span>
<a href="#l75.491"></a><span id="l75.491">    * @param propmap       The property map to walk through.</span>
<a href="#l75.492"></a><span id="l75.492">    */</span>
<a href="#l75.493"></a><span id="l75.493" class="difflineminus">-  mapPropsFromICS: function(icalcomp, propmap) {</span>
<a href="#l75.494"></a><span id="l75.494" class="difflineplus">+  mapPropsFromICS(icalcomp, propmap) {</span>
<a href="#l75.495"></a><span id="l75.495">     for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l75.496"></a><span id="l75.496">       let prop = propmap[i];</span>
<a href="#l75.497"></a><span id="l75.497">       let val = icalcomp[prop.ics];</span>
<a href="#l75.498"></a><span id="l75.498">       if (val != null &amp;&amp; val != Ci.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l75.499"></a><span id="l75.499">         this.setProperty(prop.cal, val);</span>
<a href="#l75.500"></a><span id="l75.500">       }</span>
<a href="#l75.501"></a><span id="l75.501">     }</span>
<a href="#l75.502"></a><span id="l75.502">   },</span>
<a href="#l75.503"></a><span id="l75.503" class="difflineat">@@ -775,33 +768,33 @@ calItemBase.prototype = {</span>
<a href="#l75.504"></a><span id="l75.504">   /**</span>
<a href="#l75.505"></a><span id="l75.505">    * Walks through the propmap and sets all properties on the given icalcomp</span>
<a href="#l75.506"></a><span id="l75.506">    * from the properties set on this item.</span>
<a href="#l75.507"></a><span id="l75.507">    * given icalcomp.</span>
<a href="#l75.508"></a><span id="l75.508">    *</span>
<a href="#l75.509"></a><span id="l75.509">    * @param icalcomp      The calIIcalComponent to write to.</span>
<a href="#l75.510"></a><span id="l75.510">    * @param propmap       The property map to walk through.</span>
<a href="#l75.511"></a><span id="l75.511">    */</span>
<a href="#l75.512"></a><span id="l75.512" class="difflineminus">-  mapPropsToICS: function(icalcomp, propmap) {</span>
<a href="#l75.513"></a><span id="l75.513" class="difflineplus">+  mapPropsToICS(icalcomp, propmap) {</span>
<a href="#l75.514"></a><span id="l75.514">     for (let i = 0; i &lt; propmap.length; i++) {</span>
<a href="#l75.515"></a><span id="l75.515">       let prop = propmap[i];</span>
<a href="#l75.516"></a><span id="l75.516">       let val = this.getProperty(prop.cal);</span>
<a href="#l75.517"></a><span id="l75.517">       if (val != null &amp;&amp; val != Ci.calIIcalComponent.INVALID_VALUE) {</span>
<a href="#l75.518"></a><span id="l75.518">         icalcomp[prop.ics] = val;</span>
<a href="#l75.519"></a><span id="l75.519">       }</span>
<a href="#l75.520"></a><span id="l75.520">     }</span>
<a href="#l75.521"></a><span id="l75.521">   },</span>
<a href="#l75.522"></a><span id="l75.522"> </span>
<a href="#l75.523"></a><span id="l75.523">   /**</span>
<a href="#l75.524"></a><span id="l75.524">    * Reads an ical component and sets up the base item's properties to match</span>
<a href="#l75.525"></a><span id="l75.525">    * it.</span>
<a href="#l75.526"></a><span id="l75.526">    *</span>
<a href="#l75.527"></a><span id="l75.527">    * @param icalcomp      The ical component to read.</span>
<a href="#l75.528"></a><span id="l75.528">    */</span>
<a href="#l75.529"></a><span id="l75.529" class="difflineminus">-  setItemBaseFromICS: function(icalcomp) {</span>
<a href="#l75.530"></a><span id="l75.530" class="difflineplus">+  setItemBaseFromICS(icalcomp) {</span>
<a href="#l75.531"></a><span id="l75.531">     this.modify();</span>
<a href="#l75.532"></a><span id="l75.532"> </span>
<a href="#l75.533"></a><span id="l75.533">     // re-initializing from scratch -- no light proxy anymore:</span>
<a href="#l75.534"></a><span id="l75.534">     this.mIsProxy = false;</span>
<a href="#l75.535"></a><span id="l75.535">     this.mProperties = new Map();</span>
<a href="#l75.536"></a><span id="l75.536">     this.mPropertyParams = {};</span>
<a href="#l75.537"></a><span id="l75.537"> </span>
<a href="#l75.538"></a><span id="l75.538">     this.mapPropsFromICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l75.539"></a><span id="l75.539" class="difflineat">@@ -898,33 +891,33 @@ calItemBase.prototype = {</span>
<a href="#l75.540"></a><span id="l75.540"> </span>
<a href="#l75.541"></a><span id="l75.541">   /**</span>
<a href="#l75.542"></a><span id="l75.542">    * Import all properties not in the promoted map into this item's extended</span>
<a href="#l75.543"></a><span id="l75.543">    * properties bag.</span>
<a href="#l75.544"></a><span id="l75.544">    *</span>
<a href="#l75.545"></a><span id="l75.545">    * @param icalcomp      The ical component to read.</span>
<a href="#l75.546"></a><span id="l75.546">    * @param promoted      The map of promoted properties.</span>
<a href="#l75.547"></a><span id="l75.547">    */</span>
<a href="#l75.548"></a><span id="l75.548" class="difflineminus">-  importUnpromotedProperties: function(icalcomp, promoted) {</span>
<a href="#l75.549"></a><span id="l75.549" class="difflineplus">+  importUnpromotedProperties(icalcomp, promoted) {</span>
<a href="#l75.550"></a><span id="l75.550">     for (let prop of cal.iterate.icalProperty(icalcomp)) {</span>
<a href="#l75.551"></a><span id="l75.551">       let propName = prop.propertyName;</span>
<a href="#l75.552"></a><span id="l75.552">       if (!promoted[propName]) {</span>
<a href="#l75.553"></a><span id="l75.553">         this.setProperty(propName, prop.value);</span>
<a href="#l75.554"></a><span id="l75.554">         for (let [paramName, paramValue] of cal.iterate.icalParameter(prop)) {</span>
<a href="#l75.555"></a><span id="l75.555">           if (!(propName in this.mPropertyParams)) {</span>
<a href="#l75.556"></a><span id="l75.556">             this.mPropertyParams[propName] = {};</span>
<a href="#l75.557"></a><span id="l75.557">           }</span>
<a href="#l75.558"></a><span id="l75.558">           this.mPropertyParams[propName][paramName] = paramValue;</span>
<a href="#l75.559"></a><span id="l75.559">         }</span>
<a href="#l75.560"></a><span id="l75.560">       }</span>
<a href="#l75.561"></a><span id="l75.561">     }</span>
<a href="#l75.562"></a><span id="l75.562">   },</span>
<a href="#l75.563"></a><span id="l75.563"> </span>
<a href="#l75.564"></a><span id="l75.564">   // boolean isPropertyPromoted(in AString name);</span>
<a href="#l75.565"></a><span id="l75.565" class="difflineminus">-  isPropertyPromoted: function(name) {</span>
<a href="#l75.566"></a><span id="l75.566" class="difflineplus">+  isPropertyPromoted(name) {</span>
<a href="#l75.567"></a><span id="l75.567">     return this.itemBasePromotedProps[name.toUpperCase()];</span>
<a href="#l75.568"></a><span id="l75.568">   },</span>
<a href="#l75.569"></a><span id="l75.569"> </span>
<a href="#l75.570"></a><span id="l75.570">   // attribute calIIcalComponent icalComponent;</span>
<a href="#l75.571"></a><span id="l75.571">   get icalComponent() {</span>
<a href="#l75.572"></a><span id="l75.572">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l75.573"></a><span id="l75.573">   },</span>
<a href="#l75.574"></a><span id="l75.574">   set icalComponent(val) {</span>
<a href="#l75.575"></a><span id="l75.575" class="difflineat">@@ -940,17 +933,17 @@ calItemBase.prototype = {</span>
<a href="#l75.576"></a><span id="l75.576">     return this.setProperty(&quot;X-MOZ-GENERATION&quot;, String(aValue));</span>
<a href="#l75.577"></a><span id="l75.577">   },</span>
<a href="#l75.578"></a><span id="l75.578"> </span>
<a href="#l75.579"></a><span id="l75.579">   /**</span>
<a href="#l75.580"></a><span id="l75.580">    * Fills the passed ical component with the base item's properties.</span>
<a href="#l75.581"></a><span id="l75.581">    *</span>
<a href="#l75.582"></a><span id="l75.582">    * @param icalcomp    The ical component to write to.</span>
<a href="#l75.583"></a><span id="l75.583">    */</span>
<a href="#l75.584"></a><span id="l75.584" class="difflineminus">-  fillIcalComponentFromBase: function(icalcomp) {</span>
<a href="#l75.585"></a><span id="l75.585" class="difflineplus">+  fillIcalComponentFromBase(icalcomp) {</span>
<a href="#l75.586"></a><span id="l75.586">     this.ensureNotDirty();</span>
<a href="#l75.587"></a><span id="l75.587">     let icssvc = cal.getIcsService();</span>
<a href="#l75.588"></a><span id="l75.588"> </span>
<a href="#l75.589"></a><span id="l75.589">     this.mapPropsToICS(icalcomp, this.icsBasePropMap);</span>
<a href="#l75.590"></a><span id="l75.590"> </span>
<a href="#l75.591"></a><span id="l75.591">     let org = this.organizer;</span>
<a href="#l75.592"></a><span id="l75.592">     if (org) {</span>
<a href="#l75.593"></a><span id="l75.593">       icalcomp.addProperty(org.icalProperty);</span>
<a href="#l75.594"></a><span id="l75.594" class="difflineat">@@ -991,70 +984,69 @@ calItemBase.prototype = {</span>
<a href="#l75.595"></a><span id="l75.595">       let lastAck = cal.getIcsService().createIcalProperty(&quot;X-MOZ-LASTACK&quot;);</span>
<a href="#l75.596"></a><span id="l75.596">       // - should we further ensure that those are UTC or rely on calAlarmService doing so?</span>
<a href="#l75.597"></a><span id="l75.597">       lastAck.value = alarmLastAck.icalString;</span>
<a href="#l75.598"></a><span id="l75.598">       icalcomp.addProperty(lastAck);</span>
<a href="#l75.599"></a><span id="l75.599">     }</span>
<a href="#l75.600"></a><span id="l75.600">   },</span>
<a href="#l75.601"></a><span id="l75.601"> </span>
<a href="#l75.602"></a><span id="l75.602">   // Array&lt;calIAlarm&gt; getAlarms();</span>
<a href="#l75.603"></a><span id="l75.603" class="difflineminus">-  getAlarms: function() {</span>
<a href="#l75.604"></a><span id="l75.604" class="difflineplus">+  getAlarms() {</span>
<a href="#l75.605"></a><span id="l75.605">     if (!this.mAlarms &amp;&amp; this.mIsProxy) {</span>
<a href="#l75.606"></a><span id="l75.606">       this.mAlarms = this.mParentItem.getAlarms();</span>
<a href="#l75.607"></a><span id="l75.607">     }</span>
<a href="#l75.608"></a><span id="l75.608">     if (this.mAlarms) {</span>
<a href="#l75.609"></a><span id="l75.609">       return this.mAlarms.concat([]); // clone</span>
<a href="#l75.610"></a><span id="l75.610" class="difflineminus">-    } else {</span>
<a href="#l75.611"></a><span id="l75.611" class="difflineminus">-      return [];</span>
<a href="#l75.612"></a><span id="l75.612">     }</span>
<a href="#l75.613"></a><span id="l75.613" class="difflineplus">+    return [];</span>
<a href="#l75.614"></a><span id="l75.614">   },</span>
<a href="#l75.615"></a><span id="l75.615"> </span>
<a href="#l75.616"></a><span id="l75.616">   /**</span>
<a href="#l75.617"></a><span id="l75.617">    * Adds an alarm. The second parameter is for internal use only, i.e not</span>
<a href="#l75.618"></a><span id="l75.618">    * provided on the interface.</span>
<a href="#l75.619"></a><span id="l75.619">    *</span>
<a href="#l75.620"></a><span id="l75.620">    * @see calIItemBase</span>
<a href="#l75.621"></a><span id="l75.621">    * @param aDoNotValidate    Don't serialize the component to check for</span>
<a href="#l75.622"></a><span id="l75.622">    *                            errors.</span>
<a href="#l75.623"></a><span id="l75.623">    */</span>
<a href="#l75.624"></a><span id="l75.624" class="difflineminus">-  addAlarm: function(aAlarm, aDoNotValidate) {</span>
<a href="#l75.625"></a><span id="l75.625" class="difflineplus">+  addAlarm(aAlarm, aDoNotValidate) {</span>
<a href="#l75.626"></a><span id="l75.626">     if (!aDoNotValidate) {</span>
<a href="#l75.627"></a><span id="l75.627">       try {</span>
<a href="#l75.628"></a><span id="l75.628">         // Trigger the icalComponent getter to make sure the alarm is valid.</span>
<a href="#l75.629"></a><span id="l75.629">         aAlarm.icalComponent; // eslint-disable-line no-unused-expressions</span>
<a href="#l75.630"></a><span id="l75.630">       } catch (e) {</span>
<a href="#l75.631"></a><span id="l75.631">         throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l75.632"></a><span id="l75.632">       }</span>
<a href="#l75.633"></a><span id="l75.633">     }</span>
<a href="#l75.634"></a><span id="l75.634"> </span>
<a href="#l75.635"></a><span id="l75.635">     this.modify();</span>
<a href="#l75.636"></a><span id="l75.636">     this.mAlarms = this.getAlarms();</span>
<a href="#l75.637"></a><span id="l75.637">     this.mAlarms.push(aAlarm);</span>
<a href="#l75.638"></a><span id="l75.638">   },</span>
<a href="#l75.639"></a><span id="l75.639"> </span>
<a href="#l75.640"></a><span id="l75.640">   // void deleteAlarm(in calIAlarm aAlarm);</span>
<a href="#l75.641"></a><span id="l75.641" class="difflineminus">-  deleteAlarm: function(aAlarm) {</span>
<a href="#l75.642"></a><span id="l75.642" class="difflineplus">+  deleteAlarm(aAlarm) {</span>
<a href="#l75.643"></a><span id="l75.643">     this.modify();</span>
<a href="#l75.644"></a><span id="l75.644">     this.mAlarms = this.getAlarms();</span>
<a href="#l75.645"></a><span id="l75.645">     for (let i = 0; i &lt; this.mAlarms.length; i++) {</span>
<a href="#l75.646"></a><span id="l75.646">       if (cal.data.compareObjects(this.mAlarms[i], aAlarm, Ci.calIAlarm)) {</span>
<a href="#l75.647"></a><span id="l75.647">         this.mAlarms.splice(i, 1);</span>
<a href="#l75.648"></a><span id="l75.648">         break;</span>
<a href="#l75.649"></a><span id="l75.649">       }</span>
<a href="#l75.650"></a><span id="l75.650">     }</span>
<a href="#l75.651"></a><span id="l75.651">   },</span>
<a href="#l75.652"></a><span id="l75.652"> </span>
<a href="#l75.653"></a><span id="l75.653">   // void clearAlarms();</span>
<a href="#l75.654"></a><span id="l75.654" class="difflineminus">-  clearAlarms: function() {</span>
<a href="#l75.655"></a><span id="l75.655" class="difflineplus">+  clearAlarms() {</span>
<a href="#l75.656"></a><span id="l75.656">     this.modify();</span>
<a href="#l75.657"></a><span id="l75.657">     this.mAlarms = [];</span>
<a href="#l75.658"></a><span id="l75.658">   },</span>
<a href="#l75.659"></a><span id="l75.659"> </span>
<a href="#l75.660"></a><span id="l75.660">   // Array&lt;calIItemBase&gt; getOccurrencesBetween(in calIDateTime aStartDate, in calIDateTime aEndDate);</span>
<a href="#l75.661"></a><span id="l75.661" class="difflineminus">-  getOccurrencesBetween: function(aStartDate, aEndDate) {</span>
<a href="#l75.662"></a><span id="l75.662" class="difflineplus">+  getOccurrencesBetween(aStartDate, aEndDate) {</span>
<a href="#l75.663"></a><span id="l75.663">     if (this.recurrenceInfo) {</span>
<a href="#l75.664"></a><span id="l75.664">       return this.recurrenceInfo.getOccurrences(aStartDate, aEndDate, 0);</span>
<a href="#l75.665"></a><span id="l75.665">     }</span>
<a href="#l75.666"></a><span id="l75.666"> </span>
<a href="#l75.667"></a><span id="l75.667">     if (cal.item.checkIfInRange(this, aStartDate, aEndDate)) {</span>
<a href="#l75.668"></a><span id="l75.668">       return [this];</span>
<a href="#l75.669"></a><span id="l75.669">     }</span>
<a href="#l75.670"></a><span id="l75.670"> </span>
<a href="#l75.671"></a><span id="l75.671" class="difflineat">@@ -1082,23 +1074,21 @@ makeMemberAttr(calItemBase, &quot;mProperties</span>
<a href="#l75.672"></a><span id="l75.672">  * @param asProperty    If true, getProperty will be used to get/set the</span>
<a href="#l75.673"></a><span id="l75.673">  *                        member.</span>
<a href="#l75.674"></a><span id="l75.674">  */</span>
<a href="#l75.675"></a><span id="l75.675"> function makeMemberAttr(ctor, varname, dflt, attr, asProperty) {</span>
<a href="#l75.676"></a><span id="l75.676">   // XXX handle defaults!</span>
<a href="#l75.677"></a><span id="l75.677">   let getter = function() {</span>
<a href="#l75.678"></a><span id="l75.678">     if (asProperty) {</span>
<a href="#l75.679"></a><span id="l75.679">       return this.getProperty(varname);</span>
<a href="#l75.680"></a><span id="l75.680" class="difflineminus">-    } else {</span>
<a href="#l75.681"></a><span id="l75.681" class="difflineminus">-      return varname in this ? this[varname] : undefined;</span>
<a href="#l75.682"></a><span id="l75.682">     }</span>
<a href="#l75.683"></a><span id="l75.683" class="difflineplus">+    return varname in this ? this[varname] : undefined;</span>
<a href="#l75.684"></a><span id="l75.684">   };</span>
<a href="#l75.685"></a><span id="l75.685">   let setter = function(value) {</span>
<a href="#l75.686"></a><span id="l75.686">     this.modify();</span>
<a href="#l75.687"></a><span id="l75.687">     if (asProperty) {</span>
<a href="#l75.688"></a><span id="l75.688">       return this.setProperty(varname, value);</span>
<a href="#l75.689"></a><span id="l75.689" class="difflineminus">-    } else {</span>
<a href="#l75.690"></a><span id="l75.690" class="difflineminus">-      return (this[varname] = value);</span>
<a href="#l75.691"></a><span id="l75.691">     }</span>
<a href="#l75.692"></a><span id="l75.692" class="difflineplus">+    return (this[varname] = value);</span>
<a href="#l75.693"></a><span id="l75.693">   };</span>
<a href="#l75.694"></a><span id="l75.694">   ctor.prototype.__defineGetter__(attr, getter);</span>
<a href="#l75.695"></a><span id="l75.695">   ctor.prototype.__defineSetter__(attr, setter);</span>
<a href="#l75.696"></a><span id="l75.696"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/calendar/base/src/calItipItem.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/calendar/base/src/calItipItem.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -81,17 +81,17 @@ calItipItem.prototype = {</span>
<a href="#l76.4"></a><span id="l76.4">     return this.mLocalStatus;</span>
<a href="#l76.5"></a><span id="l76.5">   },</span>
<a href="#l76.6"></a><span id="l76.6">   set localStatus(aValue) {</span>
<a href="#l76.7"></a><span id="l76.7">     return (this.mLocalStatus = aValue);</span>
<a href="#l76.8"></a><span id="l76.8">   },</span>
<a href="#l76.9"></a><span id="l76.9"> </span>
<a href="#l76.10"></a><span id="l76.10">   mItemList: {},</span>
<a href="#l76.11"></a><span id="l76.11"> </span>
<a href="#l76.12"></a><span id="l76.12" class="difflineminus">-  init: function(aIcalString) {</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+  init(aIcalString) {</span>
<a href="#l76.14"></a><span id="l76.14">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l76.15"></a><span id="l76.15">     parser.parseString(aIcalString, null);</span>
<a href="#l76.16"></a><span id="l76.16"> </span>
<a href="#l76.17"></a><span id="l76.17">     // - User specific alarms as well as X-MOZ- properties are irrelevant w.r.t. iTIP messages,</span>
<a href="#l76.18"></a><span id="l76.18">     //   should not be sent out and should not be relevant for incoming messages</span>
<a href="#l76.19"></a><span id="l76.19">     // - faked master items</span>
<a href="#l76.20"></a><span id="l76.20">     // so clean them out:</span>
<a href="#l76.21"></a><span id="l76.21"> </span>
<a href="#l76.22"></a><span id="l76.22" class="difflineat">@@ -157,17 +157,17 @@ calItipItem.prototype = {</span>
<a href="#l76.23"></a><span id="l76.23">         this.mResponseMethod = prop.value;</span>
<a href="#l76.24"></a><span id="l76.24">         break;</span>
<a href="#l76.25"></a><span id="l76.25">       }</span>
<a href="#l76.26"></a><span id="l76.26">     }</span>
<a href="#l76.27"></a><span id="l76.27"> </span>
<a href="#l76.28"></a><span id="l76.28">     this.mIsInitialized = true;</span>
<a href="#l76.29"></a><span id="l76.29">   },</span>
<a href="#l76.30"></a><span id="l76.30"> </span>
<a href="#l76.31"></a><span id="l76.31" class="difflineminus">-  clone: function() {</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+  clone() {</span>
<a href="#l76.33"></a><span id="l76.33">     let newItem = new calItipItem();</span>
<a href="#l76.34"></a><span id="l76.34">     newItem.mItemList = this.mItemList.map(item =&gt; item.clone());</span>
<a href="#l76.35"></a><span id="l76.35">     newItem.mReceivedMethod = this.mReceivedMethod;</span>
<a href="#l76.36"></a><span id="l76.36">     newItem.mResponseMethod = this.mResponseMethod;</span>
<a href="#l76.37"></a><span id="l76.37">     newItem.mAutoResponse = this.mAutoResponse;</span>
<a href="#l76.38"></a><span id="l76.38">     newItem.mTargetCalendar = this.mTargetCalendar;</span>
<a href="#l76.39"></a><span id="l76.39">     newItem.mIdentity = this.mIdentity;</span>
<a href="#l76.40"></a><span id="l76.40">     newItem.mLocalStatus = this.mLocalStatus;</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineat">@@ -176,28 +176,28 @@ calItipItem.prototype = {</span>
<a href="#l76.42"></a><span id="l76.42">     newItem.mIsInitialized = this.mIsInitialized;</span>
<a href="#l76.43"></a><span id="l76.43">     return newItem;</span>
<a href="#l76.44"></a><span id="l76.44">   },</span>
<a href="#l76.45"></a><span id="l76.45"> </span>
<a href="#l76.46"></a><span id="l76.46">   /**</span>
<a href="#l76.47"></a><span id="l76.47">    * This returns both the array and the number of items. An easy way to</span>
<a href="#l76.48"></a><span id="l76.48">    * call it is: let itemArray = itipItem.getItemList();</span>
<a href="#l76.49"></a><span id="l76.49">    */</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineminus">-  getItemList: function() {</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+  getItemList() {</span>
<a href="#l76.52"></a><span id="l76.52">     if (!this.mIsInitialized) {</span>
<a href="#l76.53"></a><span id="l76.53">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l76.54"></a><span id="l76.54">     }</span>
<a href="#l76.55"></a><span id="l76.55">     return this.mItemList;</span>
<a href="#l76.56"></a><span id="l76.56">   },</span>
<a href="#l76.57"></a><span id="l76.57"> </span>
<a href="#l76.58"></a><span id="l76.58">   /**</span>
<a href="#l76.59"></a><span id="l76.59">    * Note that this code forces the user to respond to all items in the same</span>
<a href="#l76.60"></a><span id="l76.60">    * way, which is a current limitation of the spec.</span>
<a href="#l76.61"></a><span id="l76.61">    */</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineminus">-  setAttendeeStatus: function(aAttendeeId, aStatus) {</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+  setAttendeeStatus(aAttendeeId, aStatus) {</span>
<a href="#l76.64"></a><span id="l76.64">     // Append &quot;mailto:&quot; to the attendee if it is missing it.</span>
<a href="#l76.65"></a><span id="l76.65">     if (!aAttendeeId.match(/^mailto:/i)) {</span>
<a href="#l76.66"></a><span id="l76.66">       aAttendeeId = &quot;mailto:&quot; + aAttendeeId;</span>
<a href="#l76.67"></a><span id="l76.67">     }</span>
<a href="#l76.68"></a><span id="l76.68"> </span>
<a href="#l76.69"></a><span id="l76.69">     for (let item of this.mItemList) {</span>
<a href="#l76.70"></a><span id="l76.70">       let attendee = item.getAttendeeById(aAttendeeId);</span>
<a href="#l76.71"></a><span id="l76.71">       if (attendee) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/calendar/base/src/calProtocolHandler.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/calendar/base/src/calProtocolHandler.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -18,31 +18,31 @@ function calProtocolHandler(scheme) {</span>
<a href="#l77.4"></a><span id="l77.4"> calProtocolHandler.prototype = {</span>
<a href="#l77.5"></a><span id="l77.5">   get defaultPort() {</span>
<a href="#l77.6"></a><span id="l77.6">     return this.mHttpProtocol.defaultPort;</span>
<a href="#l77.7"></a><span id="l77.7">   },</span>
<a href="#l77.8"></a><span id="l77.8">   get protocolFlags() {</span>
<a href="#l77.9"></a><span id="l77.9">     return this.mHttpProtocol.protocolFlags;</span>
<a href="#l77.10"></a><span id="l77.10">   },</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-  newURI: function(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+  newURI(aSpec, anOriginalCharset, aBaseURI) {</span>
<a href="#l77.14"></a><span id="l77.14">     return Cc[&quot;@mozilla.org/network/standard-url-mutator;1&quot;]</span>
<a href="#l77.15"></a><span id="l77.15">       .createInstance(Ci.nsIStandardURLMutator)</span>
<a href="#l77.16"></a><span id="l77.16">       .init(</span>
<a href="#l77.17"></a><span id="l77.17">         Ci.nsIStandardURL.URLTYPE_STANDARD,</span>
<a href="#l77.18"></a><span id="l77.18">         this.mHttpProtocol.defaultPort,</span>
<a href="#l77.19"></a><span id="l77.19">         aSpec,</span>
<a href="#l77.20"></a><span id="l77.20">         anOriginalCharset,</span>
<a href="#l77.21"></a><span id="l77.21">         aBaseURI</span>
<a href="#l77.22"></a><span id="l77.22">       )</span>
<a href="#l77.23"></a><span id="l77.23">       .finalize()</span>
<a href="#l77.24"></a><span id="l77.24">       .QueryInterface(Ci.nsIStandardURL);</span>
<a href="#l77.25"></a><span id="l77.25">   },</span>
<a href="#l77.26"></a><span id="l77.26"> </span>
<a href="#l77.27"></a><span id="l77.27" class="difflineminus">-  newChannel: function(aUri, aLoadInfo) {</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineplus">+  newChannel(aUri, aLoadInfo) {</span>
<a href="#l77.29"></a><span id="l77.29">     let uri = aUri</span>
<a href="#l77.30"></a><span id="l77.30">       .mutate()</span>
<a href="#l77.31"></a><span id="l77.31">       .setScheme(this.mHttpProtocol.scheme)</span>
<a href="#l77.32"></a><span id="l77.32">       .finalize();</span>
<a href="#l77.33"></a><span id="l77.33"> </span>
<a href="#l77.34"></a><span id="l77.34">     let channel;</span>
<a href="#l77.35"></a><span id="l77.35">     if (aLoadInfo) {</span>
<a href="#l77.36"></a><span id="l77.36">       channel = Services.io.newChannelFromURIWithLoadInfo(uri, aLoadInfo);</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineat">@@ -56,17 +56,17 @@ calProtocolHandler.prototype = {</span>
<a href="#l77.38"></a><span id="l77.38">         Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l77.39"></a><span id="l77.39">       );</span>
<a href="#l77.40"></a><span id="l77.40">     }</span>
<a href="#l77.41"></a><span id="l77.41">     channel.originalURI = aUri;</span>
<a href="#l77.42"></a><span id="l77.42">     return channel;</span>
<a href="#l77.43"></a><span id="l77.43">   },</span>
<a href="#l77.44"></a><span id="l77.44"> </span>
<a href="#l77.45"></a><span id="l77.45">   // We are not overriding any special ports</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineminus">-  allowPort: function(aPort, aScheme) {</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineplus">+  allowPort(aPort, aScheme) {</span>
<a href="#l77.48"></a><span id="l77.48">     return false;</span>
<a href="#l77.49"></a><span id="l77.49">   },</span>
<a href="#l77.50"></a><span id="l77.50"> };</span>
<a href="#l77.51"></a><span id="l77.51"> </span>
<a href="#l77.52"></a><span id="l77.52"> /** Constructor for webcal: protocol handler */</span>
<a href="#l77.53"></a><span id="l77.53"> function calProtocolHandlerWebcal() {</span>
<a href="#l77.54"></a><span id="l77.54">   calProtocolHandler.call(this, &quot;webcal&quot;);</span>
<a href="#l77.55"></a><span id="l77.55"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceDate.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -20,27 +20,27 @@ calRecurrenceDate.prototype = {</span>
<a href="#l78.4"></a><span id="l78.4">   QueryInterface: cal.generateQI(calRecurrenceDateInterfaces),</span>
<a href="#l78.5"></a><span id="l78.5">   classInfo: cal.generateCI({</span>
<a href="#l78.6"></a><span id="l78.6">     classID: calRecurrenceDateClassID,</span>
<a href="#l78.7"></a><span id="l78.7">     contractID: &quot;@mozilla.org/calendar/recurrence-date;1&quot;,</span>
<a href="#l78.8"></a><span id="l78.8">     classDescription: &quot;The date of an occurrence of a recurring item&quot;,</span>
<a href="#l78.9"></a><span id="l78.9">     interfaces: calRecurrenceDateInterfaces,</span>
<a href="#l78.10"></a><span id="l78.10">   }),</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+  makeImmutable() {</span>
<a href="#l78.14"></a><span id="l78.14">     this.isMutable = false;</span>
<a href="#l78.15"></a><span id="l78.15">   },</span>
<a href="#l78.16"></a><span id="l78.16"> </span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-  ensureMutable: function() {</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+  ensureMutable() {</span>
<a href="#l78.19"></a><span id="l78.19">     if (!this.isMutable) {</span>
<a href="#l78.20"></a><span id="l78.20">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l78.21"></a><span id="l78.21">     }</span>
<a href="#l78.22"></a><span id="l78.22">   },</span>
<a href="#l78.23"></a><span id="l78.23"> </span>
<a href="#l78.24"></a><span id="l78.24" class="difflineminus">-  clone: function() {</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+  clone() {</span>
<a href="#l78.26"></a><span id="l78.26">     let other = new calRecurrenceDate();</span>
<a href="#l78.27"></a><span id="l78.27">     other.mDate = this.mDate ? this.mDate.clone() : null;</span>
<a href="#l78.28"></a><span id="l78.28">     other.mIsNegative = this.mIsNegative;</span>
<a href="#l78.29"></a><span id="l78.29">     return other;</span>
<a href="#l78.30"></a><span id="l78.30">   },</span>
<a href="#l78.31"></a><span id="l78.31"> </span>
<a href="#l78.32"></a><span id="l78.32">   get isNegative() {</span>
<a href="#l78.33"></a><span id="l78.33">     return this.mIsNegative;</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineat">@@ -57,34 +57,32 @@ calRecurrenceDate.prototype = {</span>
<a href="#l78.35"></a><span id="l78.35">   get date() {</span>
<a href="#l78.36"></a><span id="l78.36">     return this.mDate;</span>
<a href="#l78.37"></a><span id="l78.37">   },</span>
<a href="#l78.38"></a><span id="l78.38">   set date(val) {</span>
<a href="#l78.39"></a><span id="l78.39">     this.ensureMutable();</span>
<a href="#l78.40"></a><span id="l78.40">     return (this.mDate = val);</span>
<a href="#l78.41"></a><span id="l78.41">   },</span>
<a href="#l78.42"></a><span id="l78.42"> </span>
<a href="#l78.43"></a><span id="l78.43" class="difflineminus">-  getNextOccurrence: function(aStartTime, aOccurrenceTime) {</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+  getNextOccurrence(aStartTime, aOccurrenceTime) {</span>
<a href="#l78.45"></a><span id="l78.45">     if (this.mDate &amp;&amp; this.mDate.compare(aStartTime) &gt; 0) {</span>
<a href="#l78.46"></a><span id="l78.46">       return this.mDate;</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineminus">-    } else {</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineminus">-      return null;</span>
<a href="#l78.49"></a><span id="l78.49">     }</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+    return null;</span>
<a href="#l78.51"></a><span id="l78.51">   },</span>
<a href="#l78.52"></a><span id="l78.52"> </span>
<a href="#l78.53"></a><span id="l78.53" class="difflineminus">-  getOccurrences: function(aStartTime, aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+  getOccurrences(aStartTime, aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l78.55"></a><span id="l78.55">     if (</span>
<a href="#l78.56"></a><span id="l78.56">       this.mDate &amp;&amp;</span>
<a href="#l78.57"></a><span id="l78.57">       this.mDate.compare(aRangeStart) &gt;= 0 &amp;&amp;</span>
<a href="#l78.58"></a><span id="l78.58">       (!aRangeEnd || this.mDate.compare(aRangeEnd) &lt; 0)</span>
<a href="#l78.59"></a><span id="l78.59">     ) {</span>
<a href="#l78.60"></a><span id="l78.60">       return [this.mDate];</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineminus">-    } else {</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineminus">-      return [];</span>
<a href="#l78.63"></a><span id="l78.63">     }</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+    return [];</span>
<a href="#l78.65"></a><span id="l78.65">   },</span>
<a href="#l78.66"></a><span id="l78.66"> </span>
<a href="#l78.67"></a><span id="l78.67">   get icalString() {</span>
<a href="#l78.68"></a><span id="l78.68">     let comp = this.icalProperty;</span>
<a href="#l78.69"></a><span id="l78.69">     return comp ? comp.icalString : &quot;&quot;;</span>
<a href="#l78.70"></a><span id="l78.70">   },</span>
<a href="#l78.71"></a><span id="l78.71">   set icalString(val) {</span>
<a href="#l78.72"></a><span id="l78.72">     let prop = cal.getIcsService().createIcalPropertyFromString(val);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/calendar/base/src/calRecurrenceInfo.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -31,27 +31,27 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.4"></a><span id="l79.4">   mRecurrenceItems: null,</span>
<a href="#l79.5"></a><span id="l79.5">   mPositiveRules: null,</span>
<a href="#l79.6"></a><span id="l79.6">   mNegativeRules: null,</span>
<a href="#l79.7"></a><span id="l79.7">   mExceptionMap: null,</span>
<a href="#l79.8"></a><span id="l79.8"> </span>
<a href="#l79.9"></a><span id="l79.9">   /**</span>
<a href="#l79.10"></a><span id="l79.10">    * Helpers</span>
<a href="#l79.11"></a><span id="l79.11">    */</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-  ensureBaseItem: function() {</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+  ensureBaseItem() {</span>
<a href="#l79.14"></a><span id="l79.14">     if (!this.mBaseItem) {</span>
<a href="#l79.15"></a><span id="l79.15">       throw Cr.NS_ERROR_NOT_INITIALIZED;</span>
<a href="#l79.16"></a><span id="l79.16">     }</span>
<a href="#l79.17"></a><span id="l79.17">   },</span>
<a href="#l79.18"></a><span id="l79.18" class="difflineminus">-  ensureMutable: function() {</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineplus">+  ensureMutable() {</span>
<a href="#l79.20"></a><span id="l79.20">     if (this.mImmutable) {</span>
<a href="#l79.21"></a><span id="l79.21">       throw Cr.NS_ERROR_OBJECT_IS_IMMUTABLE;</span>
<a href="#l79.22"></a><span id="l79.22">     }</span>
<a href="#l79.23"></a><span id="l79.23">   },</span>
<a href="#l79.24"></a><span id="l79.24" class="difflineminus">-  ensureSortedRecurrenceRules: function() {</span>
<a href="#l79.25"></a><span id="l79.25" class="difflineplus">+  ensureSortedRecurrenceRules() {</span>
<a href="#l79.26"></a><span id="l79.26">     if (!this.mPositiveRules || !this.mNegativeRules) {</span>
<a href="#l79.27"></a><span id="l79.27">       this.mPositiveRules = [];</span>
<a href="#l79.28"></a><span id="l79.28">       this.mNegativeRules = [];</span>
<a href="#l79.29"></a><span id="l79.29">       for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l79.30"></a><span id="l79.30">         if (ritem.isNegative) {</span>
<a href="#l79.31"></a><span id="l79.31">           this.mNegativeRules.push(ritem);</span>
<a href="#l79.32"></a><span id="l79.32">         } else {</span>
<a href="#l79.33"></a><span id="l79.33">           this.mPositiveRules.push(ritem);</span>
<a href="#l79.34"></a><span id="l79.34" class="difflineat">@@ -61,17 +61,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.35"></a><span id="l79.35">   },</span>
<a href="#l79.36"></a><span id="l79.36"> </span>
<a href="#l79.37"></a><span id="l79.37">   /**</span>
<a href="#l79.38"></a><span id="l79.38">    * Mutability bits</span>
<a href="#l79.39"></a><span id="l79.39">    */</span>
<a href="#l79.40"></a><span id="l79.40">   get isMutable() {</span>
<a href="#l79.41"></a><span id="l79.41">     return !this.mImmutable;</span>
<a href="#l79.42"></a><span id="l79.42">   },</span>
<a href="#l79.43"></a><span id="l79.43" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l79.44"></a><span id="l79.44" class="difflineplus">+  makeImmutable() {</span>
<a href="#l79.45"></a><span id="l79.45">     if (this.mImmutable) {</span>
<a href="#l79.46"></a><span id="l79.46">       return;</span>
<a href="#l79.47"></a><span id="l79.47">     }</span>
<a href="#l79.48"></a><span id="l79.48"> </span>
<a href="#l79.49"></a><span id="l79.49">     for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l79.50"></a><span id="l79.50">       if (ritem.isMutable) {</span>
<a href="#l79.51"></a><span id="l79.51">         ritem.makeImmutable();</span>
<a href="#l79.52"></a><span id="l79.52">       }</span>
<a href="#l79.53"></a><span id="l79.53" class="difflineat">@@ -82,17 +82,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.54"></a><span id="l79.54">       if (item.isMutable) {</span>
<a href="#l79.55"></a><span id="l79.55">         item.makeImmutable();</span>
<a href="#l79.56"></a><span id="l79.56">       }</span>
<a href="#l79.57"></a><span id="l79.57">     }</span>
<a href="#l79.58"></a><span id="l79.58"> </span>
<a href="#l79.59"></a><span id="l79.59">     this.mImmutable = true;</span>
<a href="#l79.60"></a><span id="l79.60">   },</span>
<a href="#l79.61"></a><span id="l79.61"> </span>
<a href="#l79.62"></a><span id="l79.62" class="difflineminus">-  clone: function() {</span>
<a href="#l79.63"></a><span id="l79.63" class="difflineplus">+  clone() {</span>
<a href="#l79.64"></a><span id="l79.64">     let cloned = new calRecurrenceInfo();</span>
<a href="#l79.65"></a><span id="l79.65">     cloned.mBaseItem = this.mBaseItem;</span>
<a href="#l79.66"></a><span id="l79.66"> </span>
<a href="#l79.67"></a><span id="l79.67">     let clonedItems = [];</span>
<a href="#l79.68"></a><span id="l79.68">     for (let ritem of this.mRecurrenceItems) {</span>
<a href="#l79.69"></a><span id="l79.69">       clonedItems.push(ritem.clone());</span>
<a href="#l79.70"></a><span id="l79.70">     }</span>
<a href="#l79.71"></a><span id="l79.71">     cloned.mRecurrenceItems = clonedItems;</span>
<a href="#l79.72"></a><span id="l79.72" class="difflineat">@@ -158,79 +158,79 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.73"></a><span id="l79.73">       } else {</span>
<a href="#l79.74"></a><span id="l79.74">         this.mEndDate = MAX_PRTIME;</span>
<a href="#l79.75"></a><span id="l79.75">       }</span>
<a href="#l79.76"></a><span id="l79.76">     }</span>
<a href="#l79.77"></a><span id="l79.77"> </span>
<a href="#l79.78"></a><span id="l79.78">     return this.mEndDate;</span>
<a href="#l79.79"></a><span id="l79.79">   },</span>
<a href="#l79.80"></a><span id="l79.80"> </span>
<a href="#l79.81"></a><span id="l79.81" class="difflineminus">-  getRecurrenceItems: function() {</span>
<a href="#l79.82"></a><span id="l79.82" class="difflineplus">+  getRecurrenceItems() {</span>
<a href="#l79.83"></a><span id="l79.83">     this.ensureBaseItem();</span>
<a href="#l79.84"></a><span id="l79.84"> </span>
<a href="#l79.85"></a><span id="l79.85">     return this.mRecurrenceItems;</span>
<a href="#l79.86"></a><span id="l79.86">   },</span>
<a href="#l79.87"></a><span id="l79.87"> </span>
<a href="#l79.88"></a><span id="l79.88" class="difflineminus">-  setRecurrenceItems: function(aItems) {</span>
<a href="#l79.89"></a><span id="l79.89" class="difflineplus">+  setRecurrenceItems(aItems) {</span>
<a href="#l79.90"></a><span id="l79.90">     this.ensureBaseItem();</span>
<a href="#l79.91"></a><span id="l79.91">     this.ensureMutable();</span>
<a href="#l79.92"></a><span id="l79.92"> </span>
<a href="#l79.93"></a><span id="l79.93">     // XXX should we clone these?</span>
<a href="#l79.94"></a><span id="l79.94">     this.mRecurrenceItems = aItems;</span>
<a href="#l79.95"></a><span id="l79.95">     this.mPositiveRules = null;</span>
<a href="#l79.96"></a><span id="l79.96">     this.mNegativeRules = null;</span>
<a href="#l79.97"></a><span id="l79.97">   },</span>
<a href="#l79.98"></a><span id="l79.98"> </span>
<a href="#l79.99"></a><span id="l79.99" class="difflineminus">-  countRecurrenceItems: function() {</span>
<a href="#l79.100"></a><span id="l79.100" class="difflineplus">+  countRecurrenceItems() {</span>
<a href="#l79.101"></a><span id="l79.101">     this.ensureBaseItem();</span>
<a href="#l79.102"></a><span id="l79.102"> </span>
<a href="#l79.103"></a><span id="l79.103">     return this.mRecurrenceItems.length;</span>
<a href="#l79.104"></a><span id="l79.104">   },</span>
<a href="#l79.105"></a><span id="l79.105"> </span>
<a href="#l79.106"></a><span id="l79.106" class="difflineminus">-  getRecurrenceItemAt: function(aIndex) {</span>
<a href="#l79.107"></a><span id="l79.107" class="difflineplus">+  getRecurrenceItemAt(aIndex) {</span>
<a href="#l79.108"></a><span id="l79.108">     this.ensureBaseItem();</span>
<a href="#l79.109"></a><span id="l79.109"> </span>
<a href="#l79.110"></a><span id="l79.110">     if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l79.111"></a><span id="l79.111">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l79.112"></a><span id="l79.112">     }</span>
<a href="#l79.113"></a><span id="l79.113"> </span>
<a href="#l79.114"></a><span id="l79.114">     return this.mRecurrenceItems[aIndex];</span>
<a href="#l79.115"></a><span id="l79.115">   },</span>
<a href="#l79.116"></a><span id="l79.116"> </span>
<a href="#l79.117"></a><span id="l79.117" class="difflineminus">-  appendRecurrenceItem: function(aItem) {</span>
<a href="#l79.118"></a><span id="l79.118" class="difflineplus">+  appendRecurrenceItem(aItem) {</span>
<a href="#l79.119"></a><span id="l79.119">     this.ensureBaseItem();</span>
<a href="#l79.120"></a><span id="l79.120">     this.ensureMutable();</span>
<a href="#l79.121"></a><span id="l79.121">     this.ensureSortedRecurrenceRules();</span>
<a href="#l79.122"></a><span id="l79.122"> </span>
<a href="#l79.123"></a><span id="l79.123">     this.mRecurrenceItems.push(aItem);</span>
<a href="#l79.124"></a><span id="l79.124">     if (aItem.isNegative) {</span>
<a href="#l79.125"></a><span id="l79.125">       this.mNegativeRules.push(aItem);</span>
<a href="#l79.126"></a><span id="l79.126">     } else {</span>
<a href="#l79.127"></a><span id="l79.127">       this.mPositiveRules.push(aItem);</span>
<a href="#l79.128"></a><span id="l79.128">     }</span>
<a href="#l79.129"></a><span id="l79.129">   },</span>
<a href="#l79.130"></a><span id="l79.130"> </span>
<a href="#l79.131"></a><span id="l79.131" class="difflineminus">-  deleteRecurrenceItemAt: function(aIndex) {</span>
<a href="#l79.132"></a><span id="l79.132" class="difflineplus">+  deleteRecurrenceItemAt(aIndex) {</span>
<a href="#l79.133"></a><span id="l79.133">     this.ensureBaseItem();</span>
<a href="#l79.134"></a><span id="l79.134">     this.ensureMutable();</span>
<a href="#l79.135"></a><span id="l79.135"> </span>
<a href="#l79.136"></a><span id="l79.136">     if (aIndex &lt; 0 || aIndex &gt;= this.mRecurrenceItems.length) {</span>
<a href="#l79.137"></a><span id="l79.137">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l79.138"></a><span id="l79.138">     }</span>
<a href="#l79.139"></a><span id="l79.139"> </span>
<a href="#l79.140"></a><span id="l79.140">     if (this.mRecurrenceItems[aIndex].isNegative) {</span>
<a href="#l79.141"></a><span id="l79.141">       this.mNegativeRules = null;</span>
<a href="#l79.142"></a><span id="l79.142">     } else {</span>
<a href="#l79.143"></a><span id="l79.143">       this.mPositiveRules = null;</span>
<a href="#l79.144"></a><span id="l79.144">     }</span>
<a href="#l79.145"></a><span id="l79.145"> </span>
<a href="#l79.146"></a><span id="l79.146">     this.mRecurrenceItems.splice(aIndex, 1);</span>
<a href="#l79.147"></a><span id="l79.147">   },</span>
<a href="#l79.148"></a><span id="l79.148"> </span>
<a href="#l79.149"></a><span id="l79.149" class="difflineminus">-  deleteRecurrenceItem: function(aItem) {</span>
<a href="#l79.150"></a><span id="l79.150" class="difflineplus">+  deleteRecurrenceItem(aItem) {</span>
<a href="#l79.151"></a><span id="l79.151">     // Because xpcom objects can be wrapped in various ways, testing for</span>
<a href="#l79.152"></a><span id="l79.152">     // mere == sometimes returns false even when it should be true.  Use</span>
<a href="#l79.153"></a><span id="l79.153">     // the interface pointer returned by sip to avoid that problem.</span>
<a href="#l79.154"></a><span id="l79.154">     let sip1 = Cc[&quot;@mozilla.org/supports-interface-pointer;1&quot;].createInstance(</span>
<a href="#l79.155"></a><span id="l79.155">       Ci.nsISupportsInterfacePointer</span>
<a href="#l79.156"></a><span id="l79.156">     );</span>
<a href="#l79.157"></a><span id="l79.157">     sip1.data = aItem;</span>
<a href="#l79.158"></a><span id="l79.158">     sip1.dataIID = Ci.calIRecurrenceItem;</span>
<a href="#l79.159"></a><span id="l79.159" class="difflineat">@@ -238,17 +238,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.160"></a><span id="l79.160">     let pos;</span>
<a href="#l79.161"></a><span id="l79.161">     if ((pos = this.mRecurrenceItems.indexOf(sip1.data)) &gt; -1) {</span>
<a href="#l79.162"></a><span id="l79.162">       this.deleteRecurrenceItemAt(pos);</span>
<a href="#l79.163"></a><span id="l79.163">     } else {</span>
<a href="#l79.164"></a><span id="l79.164">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l79.165"></a><span id="l79.165">     }</span>
<a href="#l79.166"></a><span id="l79.166">   },</span>
<a href="#l79.167"></a><span id="l79.167"> </span>
<a href="#l79.168"></a><span id="l79.168" class="difflineminus">-  insertRecurrenceItemAt: function(aItem, aIndex) {</span>
<a href="#l79.169"></a><span id="l79.169" class="difflineplus">+  insertRecurrenceItemAt(aItem, aIndex) {</span>
<a href="#l79.170"></a><span id="l79.170">     this.ensureBaseItem();</span>
<a href="#l79.171"></a><span id="l79.171">     this.ensureMutable();</span>
<a href="#l79.172"></a><span id="l79.172">     this.ensureSortedRecurrenceRules();</span>
<a href="#l79.173"></a><span id="l79.173"> </span>
<a href="#l79.174"></a><span id="l79.174">     if (aIndex &lt; 0 || aIndex &gt; this.mRecurrenceItems.length) {</span>
<a href="#l79.175"></a><span id="l79.175">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l79.176"></a><span id="l79.176">     }</span>
<a href="#l79.177"></a><span id="l79.177"> </span>
<a href="#l79.178"></a><span id="l79.178" class="difflineat">@@ -256,29 +256,29 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.179"></a><span id="l79.179">       this.mNegativeRules.push(aItem);</span>
<a href="#l79.180"></a><span id="l79.180">     } else {</span>
<a href="#l79.181"></a><span id="l79.181">       this.mPositiveRules.push(aItem);</span>
<a href="#l79.182"></a><span id="l79.182">     }</span>
<a href="#l79.183"></a><span id="l79.183"> </span>
<a href="#l79.184"></a><span id="l79.184">     this.mRecurrenceItems.splice(aIndex, 0, aItem);</span>
<a href="#l79.185"></a><span id="l79.185">   },</span>
<a href="#l79.186"></a><span id="l79.186"> </span>
<a href="#l79.187"></a><span id="l79.187" class="difflineminus">-  clearRecurrenceItems: function() {</span>
<a href="#l79.188"></a><span id="l79.188" class="difflineplus">+  clearRecurrenceItems() {</span>
<a href="#l79.189"></a><span id="l79.189">     this.ensureBaseItem();</span>
<a href="#l79.190"></a><span id="l79.190">     this.ensureMutable();</span>
<a href="#l79.191"></a><span id="l79.191"> </span>
<a href="#l79.192"></a><span id="l79.192">     this.mRecurrenceItems = [];</span>
<a href="#l79.193"></a><span id="l79.193">     this.mPositiveRules = [];</span>
<a href="#l79.194"></a><span id="l79.194">     this.mNegativeRules = [];</span>
<a href="#l79.195"></a><span id="l79.195">   },</span>
<a href="#l79.196"></a><span id="l79.196"> </span>
<a href="#l79.197"></a><span id="l79.197">   /*</span>
<a href="#l79.198"></a><span id="l79.198">    * calculations</span>
<a href="#l79.199"></a><span id="l79.199">    */</span>
<a href="#l79.200"></a><span id="l79.200" class="difflineminus">-  getNextOccurrence: function(aTime) {</span>
<a href="#l79.201"></a><span id="l79.201" class="difflineplus">+  getNextOccurrence(aTime) {</span>
<a href="#l79.202"></a><span id="l79.202">     this.ensureBaseItem();</span>
<a href="#l79.203"></a><span id="l79.203">     this.ensureSortedRecurrenceRules();</span>
<a href="#l79.204"></a><span id="l79.204"> </span>
<a href="#l79.205"></a><span id="l79.205">     let startDate = this.mBaseItem.recurrenceStartDate;</span>
<a href="#l79.206"></a><span id="l79.206">     let nextOccurrences = [];</span>
<a href="#l79.207"></a><span id="l79.207">     let invalidOccurrences;</span>
<a href="#l79.208"></a><span id="l79.208">     let negMap = {};</span>
<a href="#l79.209"></a><span id="l79.209">     let minOccRid;</span>
<a href="#l79.210"></a><span id="l79.210" class="difflineat">@@ -410,17 +410,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.211"></a><span id="l79.211">       }</span>
<a href="#l79.212"></a><span id="l79.212">     }</span>
<a href="#l79.213"></a><span id="l79.213"> </span>
<a href="#l79.214"></a><span id="l79.214">     // If we found a recurrence id any time above, then return the</span>
<a href="#l79.215"></a><span id="l79.215">     // occurrence for it.</span>
<a href="#l79.216"></a><span id="l79.216">     return minOccRid ? this.getOccurrenceFor(minOccRid) : null;</span>
<a href="#l79.217"></a><span id="l79.217">   },</span>
<a href="#l79.218"></a><span id="l79.218"> </span>
<a href="#l79.219"></a><span id="l79.219" class="difflineminus">-  getPreviousOccurrence: function(aTime) {</span>
<a href="#l79.220"></a><span id="l79.220" class="difflineplus">+  getPreviousOccurrence(aTime) {</span>
<a href="#l79.221"></a><span id="l79.221">     // TODO libical currently does not provide us with easy means of</span>
<a href="#l79.222"></a><span id="l79.222">     // getting the previous occurrence. This could be fixed to improve</span>
<a href="#l79.223"></a><span id="l79.223">     // performance greatly. Filed as libical feature request 1944020.</span>
<a href="#l79.224"></a><span id="l79.224"> </span>
<a href="#l79.225"></a><span id="l79.225">     // HACK We never know how early an RDATE might be before the actual</span>
<a href="#l79.226"></a><span id="l79.226">     // recurrence start. Since rangeStart cannot be null for recurrence</span>
<a href="#l79.227"></a><span id="l79.227">     // items like calIRecurrenceRule, we need to work around by supplying a</span>
<a href="#l79.228"></a><span id="l79.228">     // very early date. Again, this might have a high performance penalty.</span>
<a href="#l79.229"></a><span id="l79.229" class="difflineat">@@ -429,17 +429,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.230"></a><span id="l79.230"> </span>
<a href="#l79.231"></a><span id="l79.231">     let rids = this.calculateDates(early, aTime, 0);</span>
<a href="#l79.232"></a><span id="l79.232">     // The returned dates are sorted, so the last one is a good</span>
<a href="#l79.233"></a><span id="l79.233">     // candidate, if it exists.</span>
<a href="#l79.234"></a><span id="l79.234">     return rids.length &gt; 0 ? this.getOccurrenceFor(rids[rids.length - 1].id) : null;</span>
<a href="#l79.235"></a><span id="l79.235">   },</span>
<a href="#l79.236"></a><span id="l79.236"> </span>
<a href="#l79.237"></a><span id="l79.237">   // internal helper function;</span>
<a href="#l79.238"></a><span id="l79.238" class="difflineminus">-  calculateDates: function(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.239"></a><span id="l79.239" class="difflineplus">+  calculateDates(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.240"></a><span id="l79.240">     this.ensureBaseItem();</span>
<a href="#l79.241"></a><span id="l79.241">     this.ensureSortedRecurrenceRules();</span>
<a href="#l79.242"></a><span id="l79.242"> </span>
<a href="#l79.243"></a><span id="l79.243">     function ridDateSortComptor(a, b) {</span>
<a href="#l79.244"></a><span id="l79.244">       return a.rstart.compare(b.rstart);</span>
<a href="#l79.245"></a><span id="l79.245">     }</span>
<a href="#l79.246"></a><span id="l79.246"> </span>
<a href="#l79.247"></a><span id="l79.247">     // workaround for UTC- timezones</span>
<a href="#l79.248"></a><span id="l79.248" class="difflineat">@@ -582,23 +582,23 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.249"></a><span id="l79.249">     // specified.</span>
<a href="#l79.250"></a><span id="l79.250">     if (aMaxCount &amp;&amp; dates.length &gt; aMaxCount) {</span>
<a href="#l79.251"></a><span id="l79.251">       dates = dates.slice(0, aMaxCount);</span>
<a href="#l79.252"></a><span id="l79.252">     }</span>
<a href="#l79.253"></a><span id="l79.253"> </span>
<a href="#l79.254"></a><span id="l79.254">     return dates;</span>
<a href="#l79.255"></a><span id="l79.255">   },</span>
<a href="#l79.256"></a><span id="l79.256"> </span>
<a href="#l79.257"></a><span id="l79.257" class="difflineminus">-  getOccurrenceDates: function(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.258"></a><span id="l79.258" class="difflineplus">+  getOccurrenceDates(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.259"></a><span id="l79.259">     let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l79.260"></a><span id="l79.260">     dates = dates.map(date =&gt; date.rstart);</span>
<a href="#l79.261"></a><span id="l79.261">     return dates;</span>
<a href="#l79.262"></a><span id="l79.262">   },</span>
<a href="#l79.263"></a><span id="l79.263"> </span>
<a href="#l79.264"></a><span id="l79.264" class="difflineminus">-  getOccurrences: function(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.265"></a><span id="l79.265" class="difflineplus">+  getOccurrences(aRangeStart, aRangeEnd, aMaxCount) {</span>
<a href="#l79.266"></a><span id="l79.266">     let results = [];</span>
<a href="#l79.267"></a><span id="l79.267">     let dates = this.calculateDates(aRangeStart, aRangeEnd, aMaxCount);</span>
<a href="#l79.268"></a><span id="l79.268">     if (dates.length) {</span>
<a href="#l79.269"></a><span id="l79.269">       let count;</span>
<a href="#l79.270"></a><span id="l79.270">       if (aMaxCount) {</span>
<a href="#l79.271"></a><span id="l79.271">         count = Math.min(aMaxCount, dates.length);</span>
<a href="#l79.272"></a><span id="l79.272">       } else {</span>
<a href="#l79.273"></a><span id="l79.273">         count = dates.length;</span>
<a href="#l79.274"></a><span id="l79.274" class="difflineat">@@ -606,38 +606,38 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.275"></a><span id="l79.275"> </span>
<a href="#l79.276"></a><span id="l79.276">       for (let i = 0; i &lt; count; i++) {</span>
<a href="#l79.277"></a><span id="l79.277">         results.push(this.getOccurrenceFor(dates[i].id));</span>
<a href="#l79.278"></a><span id="l79.278">       }</span>
<a href="#l79.279"></a><span id="l79.279">     }</span>
<a href="#l79.280"></a><span id="l79.280">     return results;</span>
<a href="#l79.281"></a><span id="l79.281">   },</span>
<a href="#l79.282"></a><span id="l79.282"> </span>
<a href="#l79.283"></a><span id="l79.283" class="difflineminus">-  getOccurrenceFor: function(aRecurrenceId) {</span>
<a href="#l79.284"></a><span id="l79.284" class="difflineplus">+  getOccurrenceFor(aRecurrenceId) {</span>
<a href="#l79.285"></a><span id="l79.285">     let proxy = this.getExceptionFor(aRecurrenceId);</span>
<a href="#l79.286"></a><span id="l79.286">     if (!proxy) {</span>
<a href="#l79.287"></a><span id="l79.287">       return this.item.createProxy(aRecurrenceId);</span>
<a href="#l79.288"></a><span id="l79.288">     }</span>
<a href="#l79.289"></a><span id="l79.289">     return proxy;</span>
<a href="#l79.290"></a><span id="l79.290">   },</span>
<a href="#l79.291"></a><span id="l79.291"> </span>
<a href="#l79.292"></a><span id="l79.292" class="difflineminus">-  removeOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l79.293"></a><span id="l79.293" class="difflineplus">+  removeOccurrenceAt(aRecurrenceId) {</span>
<a href="#l79.294"></a><span id="l79.294">     this.ensureBaseItem();</span>
<a href="#l79.295"></a><span id="l79.295">     this.ensureMutable();</span>
<a href="#l79.296"></a><span id="l79.296"> </span>
<a href="#l79.297"></a><span id="l79.297">     let rdate = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l79.298"></a><span id="l79.298">     rdate.isNegative = true;</span>
<a href="#l79.299"></a><span id="l79.299">     rdate.date = aRecurrenceId.clone();</span>
<a href="#l79.300"></a><span id="l79.300"> </span>
<a href="#l79.301"></a><span id="l79.301">     this.removeExceptionFor(rdate.date);</span>
<a href="#l79.302"></a><span id="l79.302"> </span>
<a href="#l79.303"></a><span id="l79.303">     this.appendRecurrenceItem(rdate);</span>
<a href="#l79.304"></a><span id="l79.304">   },</span>
<a href="#l79.305"></a><span id="l79.305"> </span>
<a href="#l79.306"></a><span id="l79.306" class="difflineminus">-  restoreOccurrenceAt: function(aRecurrenceId) {</span>
<a href="#l79.307"></a><span id="l79.307" class="difflineplus">+  restoreOccurrenceAt(aRecurrenceId) {</span>
<a href="#l79.308"></a><span id="l79.308">     this.ensureBaseItem();</span>
<a href="#l79.309"></a><span id="l79.309">     this.ensureMutable();</span>
<a href="#l79.310"></a><span id="l79.310">     this.ensureSortedRecurrenceRules();</span>
<a href="#l79.311"></a><span id="l79.311"> </span>
<a href="#l79.312"></a><span id="l79.312">     for (let i = 0; i &lt; this.mRecurrenceItems.length; i++) {</span>
<a href="#l79.313"></a><span id="l79.313">       let rdate = cal.wrapInstance(this.mRecurrenceItems[i], Ci.calIRecurrenceDate);</span>
<a href="#l79.314"></a><span id="l79.314">       if (rdate) {</span>
<a href="#l79.315"></a><span id="l79.315">         if (rdate.isNegative &amp;&amp; rdate.date.compare(aRecurrenceId) == 0) {</span>
<a href="#l79.316"></a><span id="l79.316" class="difflineat">@@ -676,17 +676,17 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.317"></a><span id="l79.317">   // RECURRENCE-ID.  This madness is described in ITIP end of</span>
<a href="#l79.318"></a><span id="l79.318">   // section 3.7.1.</span>
<a href="#l79.319"></a><span id="l79.319">   //</span>
<a href="#l79.320"></a><span id="l79.320">   // This implementation does the first approach (RECURRENCE-ID will</span>
<a href="#l79.321"></a><span id="l79.321">   // never change even if DTSTART for that instance changes), which</span>
<a href="#l79.322"></a><span id="l79.322">   // I think is the right thing to do for CalDAV; I don't know what</span>
<a href="#l79.323"></a><span id="l79.323">   // we'll do for incoming ITIP events though.</span>
<a href="#l79.324"></a><span id="l79.324">   //</span>
<a href="#l79.325"></a><span id="l79.325" class="difflineminus">-  modifyException: function(anItem, aTakeOverOwnership) {</span>
<a href="#l79.326"></a><span id="l79.326" class="difflineplus">+  modifyException(anItem, aTakeOverOwnership) {</span>
<a href="#l79.327"></a><span id="l79.327">     this.ensureBaseItem();</span>
<a href="#l79.328"></a><span id="l79.328"> </span>
<a href="#l79.329"></a><span id="l79.329">     anItem = cal.unwrapInstance(anItem);</span>
<a href="#l79.330"></a><span id="l79.330"> </span>
<a href="#l79.331"></a><span id="l79.331">     if (</span>
<a href="#l79.332"></a><span id="l79.332">       anItem.parentItem.calendar != this.mBaseItem.calendar &amp;&amp;</span>
<a href="#l79.333"></a><span id="l79.333">       anItem.parentItem.id != this.mBaseItem.id</span>
<a href="#l79.334"></a><span id="l79.334">     ) {</span>
<a href="#l79.335"></a><span id="l79.335" class="difflineat">@@ -709,45 +709,45 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.336"></a><span id="l79.336"> </span>
<a href="#l79.337"></a><span id="l79.337">     // we're going to assume that the recurrenceId is valid here,</span>
<a href="#l79.338"></a><span id="l79.338">     // because presumably the item came from one of our functions</span>
<a href="#l79.339"></a><span id="l79.339"> </span>
<a href="#l79.340"></a><span id="l79.340">     let exKey = getRidKey(itemtoadd.recurrenceId);</span>
<a href="#l79.341"></a><span id="l79.341">     this.mExceptionMap[exKey] = itemtoadd;</span>
<a href="#l79.342"></a><span id="l79.342">   },</span>
<a href="#l79.343"></a><span id="l79.343"> </span>
<a href="#l79.344"></a><span id="l79.344" class="difflineminus">-  getExceptionFor: function(aRecurrenceId) {</span>
<a href="#l79.345"></a><span id="l79.345" class="difflineplus">+  getExceptionFor(aRecurrenceId) {</span>
<a href="#l79.346"></a><span id="l79.346">     this.ensureBaseItem();</span>
<a href="#l79.347"></a><span id="l79.347">     // Interface calIRecurrenceInfo specifies result be null if not found.</span>
<a href="#l79.348"></a><span id="l79.348">     // To avoid strict &quot;reference to undefined property&quot; warning, appending</span>
<a href="#l79.349"></a><span id="l79.349">     // &quot;|| null&quot; gives explicit result in case where property undefined</span>
<a href="#l79.350"></a><span id="l79.350">     // (or false, 0, null, or &quot;&quot;, but here it should never be those values).</span>
<a href="#l79.351"></a><span id="l79.351">     return this.mExceptionMap[getRidKey(aRecurrenceId)] || null;</span>
<a href="#l79.352"></a><span id="l79.352">   },</span>
<a href="#l79.353"></a><span id="l79.353"> </span>
<a href="#l79.354"></a><span id="l79.354" class="difflineminus">-  removeExceptionFor: function(aRecurrenceId) {</span>
<a href="#l79.355"></a><span id="l79.355" class="difflineplus">+  removeExceptionFor(aRecurrenceId) {</span>
<a href="#l79.356"></a><span id="l79.356">     this.ensureBaseItem();</span>
<a href="#l79.357"></a><span id="l79.357">     delete this.mExceptionMap[getRidKey(aRecurrenceId)];</span>
<a href="#l79.358"></a><span id="l79.358">   },</span>
<a href="#l79.359"></a><span id="l79.359"> </span>
<a href="#l79.360"></a><span id="l79.360" class="difflineminus">-  getExceptionIds: function() {</span>
<a href="#l79.361"></a><span id="l79.361" class="difflineplus">+  getExceptionIds() {</span>
<a href="#l79.362"></a><span id="l79.362">     this.ensureBaseItem();</span>
<a href="#l79.363"></a><span id="l79.363"> </span>
<a href="#l79.364"></a><span id="l79.364">     let ids = [];</span>
<a href="#l79.365"></a><span id="l79.365">     for (let ex in this.mExceptionMap) {</span>
<a href="#l79.366"></a><span id="l79.366">       let item = this.mExceptionMap[ex];</span>
<a href="#l79.367"></a><span id="l79.367">       ids.push(item.recurrenceId);</span>
<a href="#l79.368"></a><span id="l79.368">     }</span>
<a href="#l79.369"></a><span id="l79.369">     return ids;</span>
<a href="#l79.370"></a><span id="l79.370">   },</span>
<a href="#l79.371"></a><span id="l79.371"> </span>
<a href="#l79.372"></a><span id="l79.372">   // changing the startdate of an item needs to take exceptions into account.</span>
<a href="#l79.373"></a><span id="l79.373">   // in case we're about to modify a parentItem (aka 'folded' item), we need</span>
<a href="#l79.374"></a><span id="l79.374">   // to modify the recurrenceId's of all possibly existing exceptions as well.</span>
<a href="#l79.375"></a><span id="l79.375" class="difflineminus">-  onStartDateChange: function(aNewStartTime, aOldStartTime) {</span>
<a href="#l79.376"></a><span id="l79.376" class="difflineplus">+  onStartDateChange(aNewStartTime, aOldStartTime) {</span>
<a href="#l79.377"></a><span id="l79.377">     // passing null for the new starttime would indicate an error condition,</span>
<a href="#l79.378"></a><span id="l79.378">     // since having a recurrence without a starttime is invalid.</span>
<a href="#l79.379"></a><span id="l79.379">     cal.ASSERT(aNewStartTime, &quot;invalid arg!&quot;, true);</span>
<a href="#l79.380"></a><span id="l79.380"> </span>
<a href="#l79.381"></a><span id="l79.381">     // no need to check for changes if there's no previous starttime.</span>
<a href="#l79.382"></a><span id="l79.382">     if (!aOldStartTime) {</span>
<a href="#l79.383"></a><span id="l79.383">       return;</span>
<a href="#l79.384"></a><span id="l79.384">     }</span>
<a href="#l79.385"></a><span id="l79.385" class="difflineat">@@ -803,16 +803,16 @@ calRecurrenceInfo.prototype = {</span>
<a href="#l79.386"></a><span id="l79.386">         this.removeExceptionFor(exid);</span>
<a href="#l79.387"></a><span id="l79.387">       }</span>
<a href="#l79.388"></a><span id="l79.388">     }</span>
<a href="#l79.389"></a><span id="l79.389">     for (let modifiedEx of modifiedExceptions) {</span>
<a href="#l79.390"></a><span id="l79.390">       this.modifyException(modifiedEx, true);</span>
<a href="#l79.391"></a><span id="l79.391">     }</span>
<a href="#l79.392"></a><span id="l79.392">   },</span>
<a href="#l79.393"></a><span id="l79.393"> </span>
<a href="#l79.394"></a><span id="l79.394" class="difflineminus">-  onIdChange: function(aNewId) {</span>
<a href="#l79.395"></a><span id="l79.395" class="difflineplus">+  onIdChange(aNewId) {</span>
<a href="#l79.396"></a><span id="l79.396">     // patch all overridden items' id:</span>
<a href="#l79.397"></a><span id="l79.397">     for (let ex in this.mExceptionMap) {</span>
<a href="#l79.398"></a><span id="l79.398">       let item = this.mExceptionMap[ex];</span>
<a href="#l79.399"></a><span id="l79.399">       item.id = aNewId;</span>
<a href="#l79.400"></a><span id="l79.400">     }</span>
<a href="#l79.401"></a><span id="l79.401">   },</span>
<a href="#l79.402"></a><span id="l79.402"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/calendar/base/src/calRelation.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/calendar/base/src/calRelation.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -92,29 +92,29 @@ calRelation.prototype = {</span>
<a href="#l80.4"></a><span id="l80.4">     let prop = cal.getIcsService().createIcalPropertyFromString(val);</span>
<a href="#l80.5"></a><span id="l80.5">     if (prop.propertyName != &quot;RELATED-TO&quot;) {</span>
<a href="#l80.6"></a><span id="l80.6">       throw Cr.NS_ERROR_ILLEGAL_VALUE;</span>
<a href="#l80.7"></a><span id="l80.7">     }</span>
<a href="#l80.8"></a><span id="l80.8">     this.icalProperty = prop;</span>
<a href="#l80.9"></a><span id="l80.9">     return val;</span>
<a href="#l80.10"></a><span id="l80.10">   },</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineminus">-  getParameter: function(aName) {</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+  getParameter(aName) {</span>
<a href="#l80.14"></a><span id="l80.14">     return this.mProperties.get(aName);</span>
<a href="#l80.15"></a><span id="l80.15">   },</span>
<a href="#l80.16"></a><span id="l80.16"> </span>
<a href="#l80.17"></a><span id="l80.17" class="difflineminus">-  setParameter: function(aName, aValue) {</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineplus">+  setParameter(aName, aValue) {</span>
<a href="#l80.19"></a><span id="l80.19">     return this.mProperties.set(aName, aValue);</span>
<a href="#l80.20"></a><span id="l80.20">   },</span>
<a href="#l80.21"></a><span id="l80.21"> </span>
<a href="#l80.22"></a><span id="l80.22" class="difflineminus">-  deleteParameter: function(aName) {</span>
<a href="#l80.23"></a><span id="l80.23" class="difflineplus">+  deleteParameter(aName) {</span>
<a href="#l80.24"></a><span id="l80.24">     return this.mProperties.delete(aName);</span>
<a href="#l80.25"></a><span id="l80.25">   },</span>
<a href="#l80.26"></a><span id="l80.26"> </span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-  clone: function() {</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineplus">+  clone() {</span>
<a href="#l80.29"></a><span id="l80.29">     let newRelation = new calRelation();</span>
<a href="#l80.30"></a><span id="l80.30">     newRelation.mId = this.mId;</span>
<a href="#l80.31"></a><span id="l80.31">     newRelation.mType = this.mType;</span>
<a href="#l80.32"></a><span id="l80.32">     for (let [name, value] of this.mProperties.entries()) {</span>
<a href="#l80.33"></a><span id="l80.33">       newRelation.mProperties.set(name, value);</span>
<a href="#l80.34"></a><span id="l80.34">     }</span>
<a href="#l80.35"></a><span id="l80.35">     return newRelation;</span>
<a href="#l80.36"></a><span id="l80.36">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/calendar/base/src/calSleepMonitor.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/calendar/base/src/calSleepMonitor.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -14,43 +14,43 @@ calSleepMonitor.prototype = {</span>
<a href="#l81.4"></a><span id="l81.4">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l81.5"></a><span id="l81.5">   classID: Components.ID(&quot;9b987a8d-c2ef-4cb9-9602-1261b4b2f6fa&quot;),</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7">   interval: 60000,</span>
<a href="#l81.8"></a><span id="l81.8">   timer: null,</span>
<a href="#l81.9"></a><span id="l81.9">   expected: null,</span>
<a href="#l81.10"></a><span id="l81.10">   tolerance: 1000,</span>
<a href="#l81.11"></a><span id="l81.11"> </span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-  callback: function() {</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+  callback() {</span>
<a href="#l81.14"></a><span id="l81.14">     let now = Date.now();</span>
<a href="#l81.15"></a><span id="l81.15">     if (now - this.expected &gt; this.tolerance) {</span>
<a href="#l81.16"></a><span id="l81.16">       cal.LOG(&quot;[calSleepMonitor] Sleep cycle detected, notifying observers.&quot;);</span>
<a href="#l81.17"></a><span id="l81.17">       Services.obs.notifyObservers(null, &quot;wake_notification&quot;);</span>
<a href="#l81.18"></a><span id="l81.18">     }</span>
<a href="#l81.19"></a><span id="l81.19">     this.expected = now + this.interval;</span>
<a href="#l81.20"></a><span id="l81.20">   },</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineminus">-  start: function() {</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineplus">+  start() {</span>
<a href="#l81.23"></a><span id="l81.23">     this.stop();</span>
<a href="#l81.24"></a><span id="l81.24">     this.expected = Date.now() + this.interval;</span>
<a href="#l81.25"></a><span id="l81.25">     this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l81.26"></a><span id="l81.26">     this.timer.initWithCallback(</span>
<a href="#l81.27"></a><span id="l81.27">       this.callback.bind(this),</span>
<a href="#l81.28"></a><span id="l81.28">       this.interval,</span>
<a href="#l81.29"></a><span id="l81.29">       Ci.nsITimer.TYPE_REPEATING_PRECISE</span>
<a href="#l81.30"></a><span id="l81.30">     );</span>
<a href="#l81.31"></a><span id="l81.31">   },</span>
<a href="#l81.32"></a><span id="l81.32" class="difflineminus">-  stop: function() {</span>
<a href="#l81.33"></a><span id="l81.33" class="difflineplus">+  stop() {</span>
<a href="#l81.34"></a><span id="l81.34">     if (this.timer) {</span>
<a href="#l81.35"></a><span id="l81.35">       this.timer.cancel();</span>
<a href="#l81.36"></a><span id="l81.36">       this.timer = null;</span>
<a href="#l81.37"></a><span id="l81.37">     }</span>
<a href="#l81.38"></a><span id="l81.38">   },</span>
<a href="#l81.39"></a><span id="l81.39"> </span>
<a href="#l81.40"></a><span id="l81.40">   // nsIObserver:</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l81.43"></a><span id="l81.43">     // calSleepMonitor is not used on Windows or OSX.</span>
<a href="#l81.44"></a><span id="l81.44">     if (Services.appinfo.OS == &quot;WINNT&quot; || Services.appinfo.OS == &quot;Darwin&quot;) {</span>
<a href="#l81.45"></a><span id="l81.45">       return;</span>
<a href="#l81.46"></a><span id="l81.46">     }</span>
<a href="#l81.47"></a><span id="l81.47"> </span>
<a href="#l81.48"></a><span id="l81.48">     if (aTopic == &quot;profile-after-change&quot;) {</span>
<a href="#l81.49"></a><span id="l81.49">       cal.LOG(&quot;[calSleepMonitor] Starting sleep monitor.&quot;);</span>
<a href="#l81.50"></a><span id="l81.50">       this.start();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/calendar/base/src/calStartupService.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/calendar/base/src/calStartupService.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -12,17 +12,17 @@ var { FileSource, L10nRegistry } = Chrom</span>
<a href="#l82.4"></a><span id="l82.4">  *</span>
<a href="#l82.5"></a><span id="l82.5">  * @param method        The method name to call. Usually startup/shutdown.</span>
<a href="#l82.6"></a><span id="l82.6">  * @param services      The array of service objects to call on.</span>
<a href="#l82.7"></a><span id="l82.7">  */</span>
<a href="#l82.8"></a><span id="l82.8"> function callOrderedServices(method, services) {</span>
<a href="#l82.9"></a><span id="l82.9">   let service = services.shift();</span>
<a href="#l82.10"></a><span id="l82.10">   if (service) {</span>
<a href="#l82.11"></a><span id="l82.11">     service[method]({</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-      onResult: function() {</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+      onResult() {</span>
<a href="#l82.14"></a><span id="l82.14">         callOrderedServices(method, services);</span>
<a href="#l82.15"></a><span id="l82.15">       },</span>
<a href="#l82.16"></a><span id="l82.16">     });</span>
<a href="#l82.17"></a><span id="l82.17">   }</span>
<a href="#l82.18"></a><span id="l82.18"> }</span>
<a href="#l82.19"></a><span id="l82.19"> </span>
<a href="#l82.20"></a><span id="l82.20"> function calStartupService() {</span>
<a href="#l82.21"></a><span id="l82.21">   this.wrappedJSObject = this;</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineat">@@ -33,64 +33,64 @@ calStartupService.prototype = {</span>
<a href="#l82.23"></a><span id="l82.23">   QueryInterface: ChromeUtils.generateQI([Ci.nsIObserver]),</span>
<a href="#l82.24"></a><span id="l82.24">   classID: Components.ID(&quot;{2547331f-34c0-4a4b-b93c-b503538ba6d6}&quot;),</span>
<a href="#l82.25"></a><span id="l82.25"> </span>
<a href="#l82.26"></a><span id="l82.26">   // Startup Service Methods</span>
<a href="#l82.27"></a><span id="l82.27"> </span>
<a href="#l82.28"></a><span id="l82.28">   /**</span>
<a href="#l82.29"></a><span id="l82.29">    * Sets up the needed observers for noticing startup/shutdown</span>
<a href="#l82.30"></a><span id="l82.30">    */</span>
<a href="#l82.31"></a><span id="l82.31" class="difflineminus">-  setupObservers: function() {</span>
<a href="#l82.32"></a><span id="l82.32" class="difflineplus">+  setupObservers() {</span>
<a href="#l82.33"></a><span id="l82.33">     Services.obs.addObserver(this, &quot;profile-after-change&quot;);</span>
<a href="#l82.34"></a><span id="l82.34">     Services.obs.addObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l82.35"></a><span id="l82.35">     Services.obs.addObserver(this, &quot;xpcom-shutdown&quot;);</span>
<a href="#l82.36"></a><span id="l82.36">   },</span>
<a href="#l82.37"></a><span id="l82.37"> </span>
<a href="#l82.38"></a><span id="l82.38">   started: false,</span>
<a href="#l82.39"></a><span id="l82.39"> </span>
<a href="#l82.40"></a><span id="l82.40">   /**</span>
<a href="#l82.41"></a><span id="l82.41">    * Gets the startup order of services. This is an array of service objects</span>
<a href="#l82.42"></a><span id="l82.42">    * that should be called in order at startup.</span>
<a href="#l82.43"></a><span id="l82.43">    *</span>
<a href="#l82.44"></a><span id="l82.44">    * @return      The startup order as an array.</span>
<a href="#l82.45"></a><span id="l82.45">    */</span>
<a href="#l82.46"></a><span id="l82.46" class="difflineminus">-  getStartupOrder: function() {</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineplus">+  getStartupOrder() {</span>
<a href="#l82.48"></a><span id="l82.48">     let self = this;</span>
<a href="#l82.49"></a><span id="l82.49">     let tzService = Cc[&quot;@mozilla.org/calendar/timezone-service;1&quot;]</span>
<a href="#l82.50"></a><span id="l82.50">       .getService(Ci.calITimezoneService)</span>
<a href="#l82.51"></a><span id="l82.51">       .QueryInterface(Ci.calIStartupService);</span>
<a href="#l82.52"></a><span id="l82.52">     let calMgr = Cc[&quot;@mozilla.org/calendar/manager;1&quot;]</span>
<a href="#l82.53"></a><span id="l82.53">       .getService(Ci.calICalendarManager)</span>
<a href="#l82.54"></a><span id="l82.54">       .QueryInterface(Ci.calIStartupService);</span>
<a href="#l82.55"></a><span id="l82.55"> </span>
<a href="#l82.56"></a><span id="l82.56">     // Localization service</span>
<a href="#l82.57"></a><span id="l82.57">     let locales = {</span>
<a href="#l82.58"></a><span id="l82.58" class="difflineminus">-      startup: function(aCompleteListener) {</span>
<a href="#l82.59"></a><span id="l82.59" class="difflineplus">+      startup(aCompleteListener) {</span>
<a href="#l82.60"></a><span id="l82.60">         let packaged = Services.locale.packagedLocales;</span>
<a href="#l82.61"></a><span id="l82.61">         let fileSrc = new FileSource(</span>
<a href="#l82.62"></a><span id="l82.62">           &quot;calendar&quot;,</span>
<a href="#l82.63"></a><span id="l82.63">           packaged,</span>
<a href="#l82.64"></a><span id="l82.64">           &quot;resource:///chrome/{locale}/locale/{locale}/calendar/&quot;</span>
<a href="#l82.65"></a><span id="l82.65">         );</span>
<a href="#l82.66"></a><span id="l82.66">         L10nRegistry.registerSource(fileSrc);</span>
<a href="#l82.67"></a><span id="l82.67">         aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l82.68"></a><span id="l82.68">       },</span>
<a href="#l82.69"></a><span id="l82.69" class="difflineminus">-      shutdown: function(aCompleteListener) {</span>
<a href="#l82.70"></a><span id="l82.70" class="difflineplus">+      shutdown(aCompleteListener) {</span>
<a href="#l82.71"></a><span id="l82.71">         aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l82.72"></a><span id="l82.72">       },</span>
<a href="#l82.73"></a><span id="l82.73">     };</span>
<a href="#l82.74"></a><span id="l82.74"> </span>
<a href="#l82.75"></a><span id="l82.75">     // Notification object</span>
<a href="#l82.76"></a><span id="l82.76">     let notify = {</span>
<a href="#l82.77"></a><span id="l82.77" class="difflineminus">-      startup: function(aCompleteListener) {</span>
<a href="#l82.78"></a><span id="l82.78" class="difflineplus">+      startup(aCompleteListener) {</span>
<a href="#l82.79"></a><span id="l82.79">         self.started = true;</span>
<a href="#l82.80"></a><span id="l82.80">         Services.obs.notifyObservers(null, &quot;calendar-startup-done&quot;);</span>
<a href="#l82.81"></a><span id="l82.81">         aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l82.82"></a><span id="l82.82">       },</span>
<a href="#l82.83"></a><span id="l82.83" class="difflineminus">-      shutdown: function(aCompleteListener) {</span>
<a href="#l82.84"></a><span id="l82.84" class="difflineplus">+      shutdown(aCompleteListener) {</span>
<a href="#l82.85"></a><span id="l82.85">         // Argh, it would have all been so pretty! Since we just reverse</span>
<a href="#l82.86"></a><span id="l82.86">         // the array, the shutdown notification would happen before the</span>
<a href="#l82.87"></a><span id="l82.87">         // other shutdown calls. For lack of pretty code, I'm</span>
<a href="#l82.88"></a><span id="l82.88">         // leaving this out! Users can still listen to xpcom-shutdown.</span>
<a href="#l82.89"></a><span id="l82.89">         self.started = false;</span>
<a href="#l82.90"></a><span id="l82.90">         aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l82.91"></a><span id="l82.91">       },</span>
<a href="#l82.92"></a><span id="l82.92">     };</span>
<a href="#l82.93"></a><span id="l82.93" class="difflineat">@@ -99,17 +99,17 @@ calStartupService.prototype = {</span>
<a href="#l82.94"></a><span id="l82.94">     // to ensure we have the timezones initialized. Make sure &quot;notify&quot; is</span>
<a href="#l82.95"></a><span id="l82.95">     // last in this array!</span>
<a href="#l82.96"></a><span id="l82.96">     return [locales, tzService, calMgr, notify];</span>
<a href="#l82.97"></a><span id="l82.97">   },</span>
<a href="#l82.98"></a><span id="l82.98"> </span>
<a href="#l82.99"></a><span id="l82.99">   /**</span>
<a href="#l82.100"></a><span id="l82.100">    * Observer notification callback</span>
<a href="#l82.101"></a><span id="l82.101">    */</span>
<a href="#l82.102"></a><span id="l82.102" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l82.103"></a><span id="l82.103" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l82.104"></a><span id="l82.104">     switch (aTopic) {</span>
<a href="#l82.105"></a><span id="l82.105">       case &quot;profile-after-change&quot;:</span>
<a href="#l82.106"></a><span id="l82.106">         callOrderedServices(&quot;startup&quot;, this.getStartupOrder());</span>
<a href="#l82.107"></a><span id="l82.107">         break;</span>
<a href="#l82.108"></a><span id="l82.108">       case &quot;profile-before-change&quot;:</span>
<a href="#l82.109"></a><span id="l82.109">         callOrderedServices(&quot;shutdown&quot;, this.getStartupOrder().reverse());</span>
<a href="#l82.110"></a><span id="l82.110">         break;</span>
<a href="#l82.111"></a><span id="l82.111">       case &quot;xpcom-shutdown&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/calendar/base/src/calTimezone.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/calendar/base/src/calTimezone.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -53,17 +53,17 @@ calICALJSTimezone.prototype = {</span>
<a href="#l83.4"></a><span id="l83.4">       // Just use the TZID if the string is missing.</span>
<a href="#l83.5"></a><span id="l83.5">     }</span>
<a href="#l83.6"></a><span id="l83.6">     this.__defineGetter__(&quot;displayName&quot;, () =&gt; {</span>
<a href="#l83.7"></a><span id="l83.7">       return displayName;</span>
<a href="#l83.8"></a><span id="l83.8">     });</span>
<a href="#l83.9"></a><span id="l83.9">     return displayName;</span>
<a href="#l83.10"></a><span id="l83.10">   },</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-  tostring: function() {</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+  tostring() {</span>
<a href="#l83.14"></a><span id="l83.14">     return this.innerObject.toString();</span>
<a href="#l83.15"></a><span id="l83.15">   },</span>
<a href="#l83.16"></a><span id="l83.16"> };</span>
<a href="#l83.17"></a><span id="l83.17"> </span>
<a href="#l83.18"></a><span id="l83.18"> function calLibicalTimezone(tzid, component, latitude, longitude) {</span>
<a href="#l83.19"></a><span id="l83.19">   this.wrappedJSObject = this;</span>
<a href="#l83.20"></a><span id="l83.20">   this.tzid = tzid;</span>
<a href="#l83.21"></a><span id="l83.21">   this.mComponent = component;</span>
<a href="#l83.22"></a><span id="l83.22" class="difflineat">@@ -71,17 +71,17 @@ function calLibicalTimezone(tzid, compon</span>
<a href="#l83.23"></a><span id="l83.23">   this.isFloating = false;</span>
<a href="#l83.24"></a><span id="l83.24">   this.latitude = latitude;</span>
<a href="#l83.25"></a><span id="l83.25">   this.longitude = longitude;</span>
<a href="#l83.26"></a><span id="l83.26"> }</span>
<a href="#l83.27"></a><span id="l83.27"> calLibicalTimezone.prototype = {</span>
<a href="#l83.28"></a><span id="l83.28">   QueryInterface: ChromeUtils.generateQI([Ci.calITimezone]),</span>
<a href="#l83.29"></a><span id="l83.29">   classID: Components.ID(&quot;{6702eb17-a968-4b43-b562-0d0c5f8e9eb5}&quot;),</span>
<a href="#l83.30"></a><span id="l83.30"> </span>
<a href="#l83.31"></a><span id="l83.31" class="difflineminus">-  toString: function() {</span>
<a href="#l83.32"></a><span id="l83.32" class="difflineplus">+  toString() {</span>
<a href="#l83.33"></a><span id="l83.33">     return this.icalComponent ? this.icalComponent.toString() : this.tzid;</span>
<a href="#l83.34"></a><span id="l83.34">   },</span>
<a href="#l83.35"></a><span id="l83.35"> </span>
<a href="#l83.36"></a><span id="l83.36">   get isUTC() {</span>
<a href="#l83.37"></a><span id="l83.37">     return this.mUTC;</span>
<a href="#l83.38"></a><span id="l83.38">   },</span>
<a href="#l83.39"></a><span id="l83.39"> </span>
<a href="#l83.40"></a><span id="l83.40">   get icalComponent() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/calendar/base/src/calTimezoneService.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/calendar/base/src/calTimezoneService.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -12,23 +12,23 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l84.4"></a><span id="l84.4"> var { ICAL, unwrapSingle } = ChromeUtils.import(&quot;resource:///modules/calendar/Ical.jsm&quot;);</span>
<a href="#l84.5"></a><span id="l84.5"> </span>
<a href="#l84.6"></a><span id="l84.6"> function calStringEnumerator(stringArray) {</span>
<a href="#l84.7"></a><span id="l84.7">   this.mIndex = 0;</span>
<a href="#l84.8"></a><span id="l84.8">   this.mStringArray = stringArray;</span>
<a href="#l84.9"></a><span id="l84.9"> }</span>
<a href="#l84.10"></a><span id="l84.10"> calStringEnumerator.prototype = {</span>
<a href="#l84.11"></a><span id="l84.11">   // nsIUTF8StringEnumerator:</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-  [Symbol.iterator]: function() {</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+  [Symbol.iterator]() {</span>
<a href="#l84.14"></a><span id="l84.14">     return this.mStringArray.values();</span>
<a href="#l84.15"></a><span id="l84.15">   },</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineminus">-  hasMore: function() {</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineplus">+  hasMore() {</span>
<a href="#l84.18"></a><span id="l84.18">     return this.mIndex &lt; this.mStringArray.length;</span>
<a href="#l84.19"></a><span id="l84.19">   },</span>
<a href="#l84.20"></a><span id="l84.20" class="difflineminus">-  getNext: function() {</span>
<a href="#l84.21"></a><span id="l84.21" class="difflineplus">+  getNext() {</span>
<a href="#l84.22"></a><span id="l84.22">     if (!this.hasMore()) {</span>
<a href="#l84.23"></a><span id="l84.23">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l84.24"></a><span id="l84.24">     }</span>
<a href="#l84.25"></a><span id="l84.25">     return this.mStringArray[this.mIndex++];</span>
<a href="#l84.26"></a><span id="l84.26">   },</span>
<a href="#l84.27"></a><span id="l84.27"> };</span>
<a href="#l84.28"></a><span id="l84.28"> </span>
<a href="#l84.29"></a><span id="l84.29"> function calTimezoneService() {</span>
<a href="#l84.30"></a><span id="l84.30" class="difflineat">@@ -56,27 +56,27 @@ calTimezoneService.prototype = {</span>
<a href="#l84.31"></a><span id="l84.31">     classID: calTimezoneServiceClassID,</span>
<a href="#l84.32"></a><span id="l84.32">     contractID: &quot;@mozilla.org/calendar/timezone-service;1&quot;,</span>
<a href="#l84.33"></a><span id="l84.33">     classDescription: &quot;Calendar Timezone Service&quot;,</span>
<a href="#l84.34"></a><span id="l84.34">     interfaces: calTimezoneServiceInterfaces,</span>
<a href="#l84.35"></a><span id="l84.35">     flags: Ci.nsIClassInfo.SINGLETON,</span>
<a href="#l84.36"></a><span id="l84.36">   }),</span>
<a href="#l84.37"></a><span id="l84.37"> </span>
<a href="#l84.38"></a><span id="l84.38">   // ical.js TimezoneService methods</span>
<a href="#l84.39"></a><span id="l84.39" class="difflineminus">-  has: function(id) {</span>
<a href="#l84.40"></a><span id="l84.40" class="difflineplus">+  has(id) {</span>
<a href="#l84.41"></a><span id="l84.41">     return this.getTimezone(id) != null;</span>
<a href="#l84.42"></a><span id="l84.42">   },</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineminus">-  get: function(id) {</span>
<a href="#l84.44"></a><span id="l84.44" class="difflineplus">+  get(id) {</span>
<a href="#l84.45"></a><span id="l84.45">     return id ? unwrapSingle(ICAL.Timezone, this.getTimezone(id)) : null;</span>
<a href="#l84.46"></a><span id="l84.46">   },</span>
<a href="#l84.47"></a><span id="l84.47" class="difflineminus">-  remove: function() {},</span>
<a href="#l84.48"></a><span id="l84.48" class="difflineminus">-  register: function() {},</span>
<a href="#l84.49"></a><span id="l84.49" class="difflineplus">+  remove() {},</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineplus">+  register() {},</span>
<a href="#l84.51"></a><span id="l84.51"> </span>
<a href="#l84.52"></a><span id="l84.52">   // calIStartupService:</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineminus">-  startup: function(aCompleteListener) {</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineplus">+  startup(aCompleteListener) {</span>
<a href="#l84.55"></a><span id="l84.55">     function fetchJSON(aURL) {</span>
<a href="#l84.56"></a><span id="l84.56">       cal.LOG(&quot;[calTimezoneService] Loading &quot; + aURL);</span>
<a href="#l84.57"></a><span id="l84.57"> </span>
<a href="#l84.58"></a><span id="l84.58">       return new Promise((resolve, reject) =&gt; {</span>
<a href="#l84.59"></a><span id="l84.59">         let uri = Services.io.newURI(aURL);</span>
<a href="#l84.60"></a><span id="l84.60">         let channel = Services.io.newChannelFromURI(</span>
<a href="#l84.61"></a><span id="l84.61">           uri,</span>
<a href="#l84.62"></a><span id="l84.62">           null,</span>
<a href="#l84.63"></a><span id="l84.63" class="difflineat">@@ -135,17 +135,17 @@ calTimezoneService.prototype = {</span>
<a href="#l84.64"></a><span id="l84.64">           }</span>
<a href="#l84.65"></a><span id="l84.65">         },</span>
<a href="#l84.66"></a><span id="l84.66">         error =&gt; {</span>
<a href="#l84.67"></a><span id="l84.67">           cal.ERROR(&quot;Missing calendar timezones error.&quot;);</span>
<a href="#l84.68"></a><span id="l84.68">         }</span>
<a href="#l84.69"></a><span id="l84.69">       );</span>
<a href="#l84.70"></a><span id="l84.70">   },</span>
<a href="#l84.71"></a><span id="l84.71"> </span>
<a href="#l84.72"></a><span id="l84.72" class="difflineminus">-  shutdown: function(aCompleteListener) {</span>
<a href="#l84.73"></a><span id="l84.73" class="difflineplus">+  shutdown(aCompleteListener) {</span>
<a href="#l84.74"></a><span id="l84.74">     Services.prefs.removeObserver(&quot;calendar.timezone.local&quot;, this);</span>
<a href="#l84.75"></a><span id="l84.75">     aCompleteListener.onResult(null, Cr.NS_OK);</span>
<a href="#l84.76"></a><span id="l84.76">   },</span>
<a href="#l84.77"></a><span id="l84.77"> </span>
<a href="#l84.78"></a><span id="l84.78">   get UTC() {</span>
<a href="#l84.79"></a><span id="l84.79">     if (!this.mZones.has(&quot;UTC&quot;)) {</span>
<a href="#l84.80"></a><span id="l84.80">       let utc;</span>
<a href="#l84.81"></a><span id="l84.81">       if (Services.prefs.getBoolPref(&quot;calendar.icaljs&quot;, false)) {</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineat">@@ -172,17 +172,17 @@ calTimezoneService.prototype = {</span>
<a href="#l84.83"></a><span id="l84.83">       }</span>
<a href="#l84.84"></a><span id="l84.84">       this.mZones.set(&quot;floating&quot;, { zone: floating });</span>
<a href="#l84.85"></a><span id="l84.85">     }</span>
<a href="#l84.86"></a><span id="l84.86"> </span>
<a href="#l84.87"></a><span id="l84.87">     return this.mZones.get(&quot;floating&quot;).zone;</span>
<a href="#l84.88"></a><span id="l84.88">   },</span>
<a href="#l84.89"></a><span id="l84.89"> </span>
<a href="#l84.90"></a><span id="l84.90">   // calITimezoneProvider:</span>
<a href="#l84.91"></a><span id="l84.91" class="difflineminus">-  getTimezone: function(tzid) {</span>
<a href="#l84.92"></a><span id="l84.92" class="difflineplus">+  getTimezone(tzid) {</span>
<a href="#l84.93"></a><span id="l84.93">     if (!tzid) {</span>
<a href="#l84.94"></a><span id="l84.94">       cal.ERROR(&quot;Unknown timezone requested\n&quot; + cal.STACK(10));</span>
<a href="#l84.95"></a><span id="l84.95">       return null;</span>
<a href="#l84.96"></a><span id="l84.96">     }</span>
<a href="#l84.97"></a><span id="l84.97">     if (tzid.startsWith(&quot;/mozilla.org/&quot;)) {</span>
<a href="#l84.98"></a><span id="l84.98">       // We know that our former tzids look like &quot;/mozilla.org/&lt;dtstamp&gt;/continent/...&quot;</span>
<a href="#l84.99"></a><span id="l84.99">       // The ending of the mozilla prefix is the index of that slash before the</span>
<a href="#l84.100"></a><span id="l84.100">       // continent. Therefore, we start looking for the prefix-ending slash</span>
<a href="#l84.101"></a><span id="l84.101" class="difflineat">@@ -206,17 +206,17 @@ calTimezoneService.prototype = {</span>
<a href="#l84.102"></a><span id="l84.102">             &quot;\r\n&quot; +</span>
<a href="#l84.103"></a><span id="l84.103">             timezone.ics.join(&quot;\r\n&quot;) +</span>
<a href="#l84.104"></a><span id="l84.104">             &quot;\r\nEND:VTIMEZONE\r\nEND:VCALENDAR&quot;</span>
<a href="#l84.105"></a><span id="l84.105">         );</span>
<a href="#l84.106"></a><span id="l84.106">         let icalComp = new ICAL.Component(parsedComp);</span>
<a href="#l84.107"></a><span id="l84.107">         let tzComp = icalComp.getFirstSubcomponent(&quot;vtimezone&quot;);</span>
<a href="#l84.108"></a><span id="l84.108">         timezone.zone = new calICALJSTimezone(</span>
<a href="#l84.109"></a><span id="l84.109">           ICAL.Timezone.fromData({</span>
<a href="#l84.110"></a><span id="l84.110" class="difflineminus">-            tzid: tzid,</span>
<a href="#l84.111"></a><span id="l84.111" class="difflineplus">+            tzid,</span>
<a href="#l84.112"></a><span id="l84.112">             component: tzComp,</span>
<a href="#l84.113"></a><span id="l84.113">             latitude: timezone.latitude,</span>
<a href="#l84.114"></a><span id="l84.114">             longitude: timezone.longitude,</span>
<a href="#l84.115"></a><span id="l84.115">           })</span>
<a href="#l84.116"></a><span id="l84.116">         );</span>
<a href="#l84.117"></a><span id="l84.117">       } else {</span>
<a href="#l84.118"></a><span id="l84.118">         let ics =</span>
<a href="#l84.119"></a><span id="l84.119">           &quot;BEGIN:VTIMEZONE\r\nTZID:&quot; +</span>
<a href="#l84.120"></a><span id="l84.120" class="difflineat">@@ -277,25 +277,25 @@ calTimezoneService.prototype = {</span>
<a href="#l84.121"></a><span id="l84.121"> </span>
<a href="#l84.122"></a><span id="l84.122">       // We need to observe the timezone preference to update the default</span>
<a href="#l84.123"></a><span id="l84.123">       // timezone if needed.</span>
<a href="#l84.124"></a><span id="l84.124">       this.setupObservers();</span>
<a href="#l84.125"></a><span id="l84.125">     }</span>
<a href="#l84.126"></a><span id="l84.126">     return this.mDefaultTimezone;</span>
<a href="#l84.127"></a><span id="l84.127">   },</span>
<a href="#l84.128"></a><span id="l84.128"> </span>
<a href="#l84.129"></a><span id="l84.129" class="difflineminus">-  setupObservers: function() {</span>
<a href="#l84.130"></a><span id="l84.130" class="difflineplus">+  setupObservers() {</span>
<a href="#l84.131"></a><span id="l84.131">     if (!this.mHasSetupObservers) {</span>
<a href="#l84.132"></a><span id="l84.132">       // Now set up the observer</span>
<a href="#l84.133"></a><span id="l84.133">       Services.prefs.addObserver(&quot;calendar.timezone.local&quot;, this);</span>
<a href="#l84.134"></a><span id="l84.134">       this.mHasSetupObservers = true;</span>
<a href="#l84.135"></a><span id="l84.135">     }</span>
<a href="#l84.136"></a><span id="l84.136">   },</span>
<a href="#l84.137"></a><span id="l84.137"> </span>
<a href="#l84.138"></a><span id="l84.138" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l84.139"></a><span id="l84.139" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l84.140"></a><span id="l84.140">     if (aTopic == &quot;nsPref:changed&quot; &amp;&amp; aData == &quot;calendar.timezone.local&quot;) {</span>
<a href="#l84.141"></a><span id="l84.141">       // Unsetting the default timezone will make the next call to the</span>
<a href="#l84.142"></a><span id="l84.142">       // default timezone getter set up the correct timezone again.</span>
<a href="#l84.143"></a><span id="l84.143">       this.mDefaultTimezone = null;</span>
<a href="#l84.144"></a><span id="l84.144">       Services.obs.notifyObservers(null, &quot;defaultTimezoneChanged&quot;);</span>
<a href="#l84.145"></a><span id="l84.145">     }</span>
<a href="#l84.146"></a><span id="l84.146">   },</span>
<a href="#l84.147"></a><span id="l84.147"> };</span>
<a href="#l84.148"></a><span id="l84.148" class="difflineat">@@ -344,81 +344,75 @@ function guessSystemTimezone() {</span>
<a href="#l84.149"></a><span id="l84.149">   function checkTZ(tzId) {</span>
<a href="#l84.150"></a><span id="l84.150">     let timezone = tzSvc.getTimezone(tzId);</span>
<a href="#l84.151"></a><span id="l84.151"> </span>
<a href="#l84.152"></a><span id="l84.152">     // Have to handle UTC separately because it has no .icalComponent.</span>
<a href="#l84.153"></a><span id="l84.153">     if (timezone.isUTC) {</span>
<a href="#l84.154"></a><span id="l84.154">       if (offsetDec == 0 &amp;&amp; offsetJun == 0) {</span>
<a href="#l84.155"></a><span id="l84.155">         if (tzNameJun == &quot;UTC&quot; &amp;&amp; tzNameDec == &quot;UTC&quot;) {</span>
<a href="#l84.156"></a><span id="l84.156">           return 3;</span>
<a href="#l84.157"></a><span id="l84.157" class="difflineminus">-        } else {</span>
<a href="#l84.158"></a><span id="l84.158" class="difflineminus">-          return 2;</span>
<a href="#l84.159"></a><span id="l84.159">         }</span>
<a href="#l84.160"></a><span id="l84.160" class="difflineminus">-      } else {</span>
<a href="#l84.161"></a><span id="l84.161" class="difflineminus">-        return 0;</span>
<a href="#l84.162"></a><span id="l84.162" class="difflineplus">+        return 2;</span>
<a href="#l84.163"></a><span id="l84.163">       }</span>
<a href="#l84.164"></a><span id="l84.164" class="difflineplus">+      return 0;</span>
<a href="#l84.165"></a><span id="l84.165">     }</span>
<a href="#l84.166"></a><span id="l84.166"> </span>
<a href="#l84.167"></a><span id="l84.167">     let subComp = timezone.icalComponent;</span>
<a href="#l84.168"></a><span id="l84.168">     // find currently applicable time period, not just first,</span>
<a href="#l84.169"></a><span id="l84.169">     // because offsets of timezone may be changed over the years.</span>
<a href="#l84.170"></a><span id="l84.170">     let standard = findCurrentTimePeriod(timezone, subComp, &quot;STANDARD&quot;);</span>
<a href="#l84.171"></a><span id="l84.171">     let standardTZOffset = getIcalString(standard, &quot;TZOFFSETTO&quot;);</span>
<a href="#l84.172"></a><span id="l84.172">     let standardName = getIcalString(standard, &quot;TZNAME&quot;);</span>
<a href="#l84.173"></a><span id="l84.173">     let daylight = findCurrentTimePeriod(timezone, subComp, &quot;DAYLIGHT&quot;);</span>
<a href="#l84.174"></a><span id="l84.174">     let daylightTZOffset = getIcalString(daylight, &quot;TZOFFSETTO&quot;);</span>
<a href="#l84.175"></a><span id="l84.175">     let daylightName = getIcalString(daylight, &quot;TZNAME&quot;);</span>
<a href="#l84.176"></a><span id="l84.176"> </span>
<a href="#l84.177"></a><span id="l84.177">     // Try northern hemisphere cases.</span>
<a href="#l84.178"></a><span id="l84.178">     if (offsetDec == standardTZOffset &amp;&amp; offsetDec == offsetJun &amp;&amp; !daylight) {</span>
<a href="#l84.179"></a><span id="l84.179">       if (standardName &amp;&amp; standardName == tzNameJun) {</span>
<a href="#l84.180"></a><span id="l84.180">         return 3;</span>
<a href="#l84.181"></a><span id="l84.181" class="difflineminus">-      } else {</span>
<a href="#l84.182"></a><span id="l84.182" class="difflineminus">-        return 2;</span>
<a href="#l84.183"></a><span id="l84.183">       }</span>
<a href="#l84.184"></a><span id="l84.184" class="difflineplus">+      return 2;</span>
<a href="#l84.185"></a><span id="l84.185">     }</span>
<a href="#l84.186"></a><span id="l84.186"> </span>
<a href="#l84.187"></a><span id="l84.187">     if (offsetDec == standardTZOffset &amp;&amp; offsetJun == daylightTZOffset &amp;&amp; daylight) {</span>
<a href="#l84.188"></a><span id="l84.188">       let dateMatchWt = systemTZMatchesTimeShiftDates(timezone, subComp);</span>
<a href="#l84.189"></a><span id="l84.189">       if (dateMatchWt &gt; 0) {</span>
<a href="#l84.190"></a><span id="l84.190">         if (</span>
<a href="#l84.191"></a><span id="l84.191">           standardName &amp;&amp;</span>
<a href="#l84.192"></a><span id="l84.192">           standardName == tzNameJun &amp;&amp;</span>
<a href="#l84.193"></a><span id="l84.193">           daylightName &amp;&amp;</span>
<a href="#l84.194"></a><span id="l84.194">           daylightName == tzNameDec</span>
<a href="#l84.195"></a><span id="l84.195">         ) {</span>
<a href="#l84.196"></a><span id="l84.196">           return 3;</span>
<a href="#l84.197"></a><span id="l84.197" class="difflineminus">-        } else {</span>
<a href="#l84.198"></a><span id="l84.198" class="difflineminus">-          return dateMatchWt;</span>
<a href="#l84.199"></a><span id="l84.199">         }</span>
<a href="#l84.200"></a><span id="l84.200" class="difflineplus">+        return dateMatchWt;</span>
<a href="#l84.201"></a><span id="l84.201">       }</span>
<a href="#l84.202"></a><span id="l84.202">     }</span>
<a href="#l84.203"></a><span id="l84.203"> </span>
<a href="#l84.204"></a><span id="l84.204">     // Now flip them and check again, to cover southern hemisphere cases.</span>
<a href="#l84.205"></a><span id="l84.205">     if (offsetJun == standardTZOffset &amp;&amp; offsetDec == offsetJun &amp;&amp; !daylight) {</span>
<a href="#l84.206"></a><span id="l84.206">       if (standardName &amp;&amp; standardName == tzNameDec) {</span>
<a href="#l84.207"></a><span id="l84.207">         return 3;</span>
<a href="#l84.208"></a><span id="l84.208" class="difflineminus">-      } else {</span>
<a href="#l84.209"></a><span id="l84.209" class="difflineminus">-        return 2;</span>
<a href="#l84.210"></a><span id="l84.210">       }</span>
<a href="#l84.211"></a><span id="l84.211" class="difflineplus">+      return 2;</span>
<a href="#l84.212"></a><span id="l84.212">     }</span>
<a href="#l84.213"></a><span id="l84.213"> </span>
<a href="#l84.214"></a><span id="l84.214">     if (offsetJun == standardTZOffset &amp;&amp; offsetDec == daylightTZOffset &amp;&amp; daylight) {</span>
<a href="#l84.215"></a><span id="l84.215">       let dateMatchWt = systemTZMatchesTimeShiftDates(timezone, subComp);</span>
<a href="#l84.216"></a><span id="l84.216">       if (dateMatchWt &gt; 0) {</span>
<a href="#l84.217"></a><span id="l84.217">         if (</span>
<a href="#l84.218"></a><span id="l84.218">           standardName &amp;&amp;</span>
<a href="#l84.219"></a><span id="l84.219">           standardName == tzNameJun &amp;&amp;</span>
<a href="#l84.220"></a><span id="l84.220">           daylightName &amp;&amp;</span>
<a href="#l84.221"></a><span id="l84.221">           daylightName == tzNameDec</span>
<a href="#l84.222"></a><span id="l84.222">         ) {</span>
<a href="#l84.223"></a><span id="l84.223">           return 3;</span>
<a href="#l84.224"></a><span id="l84.224" class="difflineminus">-        } else {</span>
<a href="#l84.225"></a><span id="l84.225" class="difflineminus">-          return dateMatchWt;</span>
<a href="#l84.226"></a><span id="l84.226">         }</span>
<a href="#l84.227"></a><span id="l84.227" class="difflineplus">+        return dateMatchWt;</span>
<a href="#l84.228"></a><span id="l84.228">       }</span>
<a href="#l84.229"></a><span id="l84.229">     }</span>
<a href="#l84.230"></a><span id="l84.230">     return 0;</span>
<a href="#l84.231"></a><span id="l84.231">   }</span>
<a href="#l84.232"></a><span id="l84.232"> </span>
<a href="#l84.233"></a><span id="l84.233">   // returns 2=match-within-hours, 1=match-within-week, 0=no-match</span>
<a href="#l84.234"></a><span id="l84.234">   function systemTZMatchesTimeShiftDates(timezone, subComp) {</span>
<a href="#l84.235"></a><span id="l84.235">     // Verify local autumn and spring shifts also occur in system timezone</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/calendar/base/src/calTodo.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/calendar/base/src/calTodo.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -30,23 +30,23 @@ calTodo.prototype = {</span>
<a href="#l85.4"></a><span id="l85.4">   QueryInterface: cal.generateQI(calTodoInterfaces),</span>
<a href="#l85.5"></a><span id="l85.5">   classInfo: cal.generateCI({</span>
<a href="#l85.6"></a><span id="l85.6">     classID: calTodoClassID,</span>
<a href="#l85.7"></a><span id="l85.7">     contractID: &quot;@mozilla.org/calendar/todo;1&quot;,</span>
<a href="#l85.8"></a><span id="l85.8">     classDescription: &quot;Calendar Todo&quot;,</span>
<a href="#l85.9"></a><span id="l85.9">     interfaces: calTodoInterfaces,</span>
<a href="#l85.10"></a><span id="l85.10">   }),</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-  cloneShallow: function(aNewParent) {</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+  cloneShallow(aNewParent) {</span>
<a href="#l85.14"></a><span id="l85.14">     let cloned = new calTodo();</span>
<a href="#l85.15"></a><span id="l85.15">     this.cloneItemBaseInto(cloned, aNewParent);</span>
<a href="#l85.16"></a><span id="l85.16">     return cloned;</span>
<a href="#l85.17"></a><span id="l85.17">   },</span>
<a href="#l85.18"></a><span id="l85.18"> </span>
<a href="#l85.19"></a><span id="l85.19" class="difflineminus">-  createProxy: function(aRecurrenceId) {</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineplus">+  createProxy(aRecurrenceId) {</span>
<a href="#l85.21"></a><span id="l85.21">     cal.ASSERT(!this.mIsProxy, &quot;Tried to create a proxy for an existing proxy!&quot;, true);</span>
<a href="#l85.22"></a><span id="l85.22"> </span>
<a href="#l85.23"></a><span id="l85.23">     let proxy = new calTodo();</span>
<a href="#l85.24"></a><span id="l85.24"> </span>
<a href="#l85.25"></a><span id="l85.25">     // override proxy's DTSTART/DUE/RECURRENCE-ID</span>
<a href="#l85.26"></a><span id="l85.26">     // before master is set (and item might get immutable):</span>
<a href="#l85.27"></a><span id="l85.27">     let duration = this.duration;</span>
<a href="#l85.28"></a><span id="l85.28">     if (duration) {</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineat">@@ -57,17 +57,17 @@ calTodo.prototype = {</span>
<a href="#l85.30"></a><span id="l85.30">     proxy.entryDate = aRecurrenceId;</span>
<a href="#l85.31"></a><span id="l85.31"> </span>
<a href="#l85.32"></a><span id="l85.32">     proxy.initializeProxy(this, aRecurrenceId);</span>
<a href="#l85.33"></a><span id="l85.33">     proxy.mDirty = false;</span>
<a href="#l85.34"></a><span id="l85.34"> </span>
<a href="#l85.35"></a><span id="l85.35">     return proxy;</span>
<a href="#l85.36"></a><span id="l85.36">   },</span>
<a href="#l85.37"></a><span id="l85.37"> </span>
<a href="#l85.38"></a><span id="l85.38" class="difflineminus">-  makeImmutable: function() {</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineplus">+  makeImmutable() {</span>
<a href="#l85.40"></a><span id="l85.40">     this.makeItemBaseImmutable();</span>
<a href="#l85.41"></a><span id="l85.41">   },</span>
<a href="#l85.42"></a><span id="l85.42"> </span>
<a href="#l85.43"></a><span id="l85.43">   get isCompleted() {</span>
<a href="#l85.44"></a><span id="l85.44">     return this.completedDate != null || this.percentComplete == 100 || this.status == &quot;COMPLETED&quot;;</span>
<a href="#l85.45"></a><span id="l85.45">   },</span>
<a href="#l85.46"></a><span id="l85.46"> </span>
<a href="#l85.47"></a><span id="l85.47">   set isCompleted(completed) {</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineat">@@ -85,22 +85,21 @@ calTodo.prototype = {</span>
<a href="#l85.49"></a><span id="l85.49">   },</span>
<a href="#l85.50"></a><span id="l85.50"> </span>
<a href="#l85.51"></a><span id="l85.51">   get duration() {</span>
<a href="#l85.52"></a><span id="l85.52">     let dur = this.getProperty(&quot;DURATION&quot;);</span>
<a href="#l85.53"></a><span id="l85.53">     // pick up duration if available, otherwise calculate difference</span>
<a href="#l85.54"></a><span id="l85.54">     // between start and enddate</span>
<a href="#l85.55"></a><span id="l85.55">     if (dur) {</span>
<a href="#l85.56"></a><span id="l85.56">       return cal.createDuration(dur);</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineminus">-    } else {</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineminus">-      if (!this.entryDate || !this.dueDate) {</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineminus">-        return null;</span>
<a href="#l85.60"></a><span id="l85.60" class="difflineminus">-      }</span>
<a href="#l85.61"></a><span id="l85.61" class="difflineminus">-      return this.dueDate.subtractDate(this.entryDate);</span>
<a href="#l85.62"></a><span id="l85.62">     }</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineplus">+    if (!this.entryDate || !this.dueDate) {</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineplus">+      return null;</span>
<a href="#l85.65"></a><span id="l85.65" class="difflineplus">+    }</span>
<a href="#l85.66"></a><span id="l85.66" class="difflineplus">+    return this.dueDate.subtractDate(this.entryDate);</span>
<a href="#l85.67"></a><span id="l85.67">   },</span>
<a href="#l85.68"></a><span id="l85.68"> </span>
<a href="#l85.69"></a><span id="l85.69">   set duration(value) {</span>
<a href="#l85.70"></a><span id="l85.70">     this.setProperty(&quot;DURATION&quot;, value);</span>
<a href="#l85.71"></a><span id="l85.71">   },</span>
<a href="#l85.72"></a><span id="l85.72"> </span>
<a href="#l85.73"></a><span id="l85.73">   get recurrenceStartDate() {</span>
<a href="#l85.74"></a><span id="l85.74">     // DTSTART is optional for VTODOs, so it's unclear if RRULE is allowed then,</span>
<a href="#l85.75"></a><span id="l85.75" class="difflineat">@@ -181,17 +180,17 @@ calTodo.prototype = {</span>
<a href="#l85.76"></a><span id="l85.76">     this.setItemBaseFromICS(todo);</span>
<a href="#l85.77"></a><span id="l85.77">     this.mapPropsFromICS(todo, this.icsEventPropMap);</span>
<a href="#l85.78"></a><span id="l85.78"> </span>
<a href="#l85.79"></a><span id="l85.79">     this.importUnpromotedProperties(todo, this.todoPromotedProps);</span>
<a href="#l85.80"></a><span id="l85.80">     // Importing didn't really change anything</span>
<a href="#l85.81"></a><span id="l85.81">     this.mDirty = false;</span>
<a href="#l85.82"></a><span id="l85.82">   },</span>
<a href="#l85.83"></a><span id="l85.83"> </span>
<a href="#l85.84"></a><span id="l85.84" class="difflineminus">-  isPropertyPromoted: function(name) {</span>
<a href="#l85.85"></a><span id="l85.85" class="difflineplus">+  isPropertyPromoted(name) {</span>
<a href="#l85.86"></a><span id="l85.86">     // avoid strict undefined property warning</span>
<a href="#l85.87"></a><span id="l85.87">     return this.todoPromotedProps[name] || false;</span>
<a href="#l85.88"></a><span id="l85.88">   },</span>
<a href="#l85.89"></a><span id="l85.89"> </span>
<a href="#l85.90"></a><span id="l85.90">   set entryDate(value) {</span>
<a href="#l85.91"></a><span id="l85.91">     this.modify();</span>
<a href="#l85.92"></a><span id="l85.92"> </span>
<a href="#l85.93"></a><span id="l85.93">     // We're about to change the start date of an item which probably</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/calendar/base/src/calTransactionManager.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/calendar/base/src/calTransactionManager.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -13,59 +13,59 @@ function calTransactionManager() {</span>
<a href="#l86.4"></a><span id="l86.4">   }</span>
<a href="#l86.5"></a><span id="l86.5"> }</span>
<a href="#l86.6"></a><span id="l86.6"> </span>
<a href="#l86.7"></a><span id="l86.7"> calTransactionManager.prototype = {</span>
<a href="#l86.8"></a><span id="l86.8">   QueryInterface: ChromeUtils.generateQI([Ci.calITransactionManager]),</span>
<a href="#l86.9"></a><span id="l86.9">   classID: Components.ID(&quot;{1d529847-d292-4222-b066-b8b17a794d62}&quot;),</span>
<a href="#l86.10"></a><span id="l86.10"> </span>
<a href="#l86.11"></a><span id="l86.11">   transactionManager: null,</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-  createAndCommitTxn: function(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse) {</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+  createAndCommitTxn(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse) {</span>
<a href="#l86.14"></a><span id="l86.14">     let txn = new calTransaction(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse);</span>
<a href="#l86.15"></a><span id="l86.15">     this.transactionManager.doTransaction(txn);</span>
<a href="#l86.16"></a><span id="l86.16">   },</span>
<a href="#l86.17"></a><span id="l86.17"> </span>
<a href="#l86.18"></a><span id="l86.18" class="difflineminus">-  beginBatch: function() {</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineplus">+  beginBatch() {</span>
<a href="#l86.20"></a><span id="l86.20">     this.transactionManager.beginBatch(null);</span>
<a href="#l86.21"></a><span id="l86.21">   },</span>
<a href="#l86.22"></a><span id="l86.22"> </span>
<a href="#l86.23"></a><span id="l86.23" class="difflineminus">-  endBatch: function() {</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineplus">+  endBatch() {</span>
<a href="#l86.25"></a><span id="l86.25">     this.transactionManager.endBatch(false);</span>
<a href="#l86.26"></a><span id="l86.26">   },</span>
<a href="#l86.27"></a><span id="l86.27"> </span>
<a href="#l86.28"></a><span id="l86.28" class="difflineminus">-  checkWritable: function(transaction) {</span>
<a href="#l86.29"></a><span id="l86.29" class="difflineplus">+  checkWritable(transaction) {</span>
<a href="#l86.30"></a><span id="l86.30">     function checkItem(item) {</span>
<a href="#l86.31"></a><span id="l86.31">       return (</span>
<a href="#l86.32"></a><span id="l86.32">         item &amp;&amp;</span>
<a href="#l86.33"></a><span id="l86.33">         item.calendar &amp;&amp;</span>
<a href="#l86.34"></a><span id="l86.34">         cal.acl.isCalendarWritable(item.calendar) &amp;&amp;</span>
<a href="#l86.35"></a><span id="l86.35">         cal.acl.userCanAddItemsToCalendar(item.calendar)</span>
<a href="#l86.36"></a><span id="l86.36">       );</span>
<a href="#l86.37"></a><span id="l86.37">     }</span>
<a href="#l86.38"></a><span id="l86.38"> </span>
<a href="#l86.39"></a><span id="l86.39">     let trans = transaction &amp;&amp; transaction.wrappedJSObject;</span>
<a href="#l86.40"></a><span id="l86.40">     return trans &amp;&amp; checkItem(trans.mItem) &amp;&amp; checkItem(trans.mOldItem);</span>
<a href="#l86.41"></a><span id="l86.41">   },</span>
<a href="#l86.42"></a><span id="l86.42"> </span>
<a href="#l86.43"></a><span id="l86.43" class="difflineminus">-  undo: function() {</span>
<a href="#l86.44"></a><span id="l86.44" class="difflineplus">+  undo() {</span>
<a href="#l86.45"></a><span id="l86.45">     this.transactionManager.undoTransaction();</span>
<a href="#l86.46"></a><span id="l86.46">   },</span>
<a href="#l86.47"></a><span id="l86.47"> </span>
<a href="#l86.48"></a><span id="l86.48" class="difflineminus">-  canUndo: function() {</span>
<a href="#l86.49"></a><span id="l86.49" class="difflineplus">+  canUndo() {</span>
<a href="#l86.50"></a><span id="l86.50">     return (</span>
<a href="#l86.51"></a><span id="l86.51">       this.transactionManager.numberOfUndoItems &gt; 0 &amp;&amp;</span>
<a href="#l86.52"></a><span id="l86.52">       this.checkWritable(this.transactionManager.peekUndoStack())</span>
<a href="#l86.53"></a><span id="l86.53">     );</span>
<a href="#l86.54"></a><span id="l86.54">   },</span>
<a href="#l86.55"></a><span id="l86.55"> </span>
<a href="#l86.56"></a><span id="l86.56" class="difflineminus">-  redo: function() {</span>
<a href="#l86.57"></a><span id="l86.57" class="difflineplus">+  redo() {</span>
<a href="#l86.58"></a><span id="l86.58">     this.transactionManager.redoTransaction();</span>
<a href="#l86.59"></a><span id="l86.59">   },</span>
<a href="#l86.60"></a><span id="l86.60"> </span>
<a href="#l86.61"></a><span id="l86.61" class="difflineminus">-  canRedo: function() {</span>
<a href="#l86.62"></a><span id="l86.62" class="difflineplus">+  canRedo() {</span>
<a href="#l86.63"></a><span id="l86.63">     return (</span>
<a href="#l86.64"></a><span id="l86.64">       this.transactionManager.numberOfRedoItems &gt; 0 &amp;&amp;</span>
<a href="#l86.65"></a><span id="l86.65">       this.checkWritable(this.transactionManager.peekRedoStack())</span>
<a href="#l86.66"></a><span id="l86.66">     );</span>
<a href="#l86.67"></a><span id="l86.67">   },</span>
<a href="#l86.68"></a><span id="l86.68"> };</span>
<a href="#l86.69"></a><span id="l86.69"> </span>
<a href="#l86.70"></a><span id="l86.70"> function calTransaction(aAction, aItem, aCalendar, aOldItem, aListener, aExtResponse) {</span>
<a href="#l86.71"></a><span id="l86.71" class="difflineat">@@ -88,17 +88,17 @@ calTransaction.prototype = {</span>
<a href="#l86.72"></a><span id="l86.72">   mCalendar: null,</span>
<a href="#l86.73"></a><span id="l86.73">   mItem: null,</span>
<a href="#l86.74"></a><span id="l86.74">   mOldItem: null,</span>
<a href="#l86.75"></a><span id="l86.75">   mOldCalendar: null,</span>
<a href="#l86.76"></a><span id="l86.76">   mListener: null,</span>
<a href="#l86.77"></a><span id="l86.77">   mIsDoTransaction: false,</span>
<a href="#l86.78"></a><span id="l86.78">   mExtResponse: null,</span>
<a href="#l86.79"></a><span id="l86.79"> </span>
<a href="#l86.80"></a><span id="l86.80" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l86.81"></a><span id="l86.81" class="difflineplus">+  onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l86.82"></a><span id="l86.82">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l86.83"></a><span id="l86.83">       cal.itip.checkAndSend(</span>
<a href="#l86.84"></a><span id="l86.84">         aOperationType,</span>
<a href="#l86.85"></a><span id="l86.85">         aDetail,</span>
<a href="#l86.86"></a><span id="l86.86">         this.mIsDoTransaction ? this.mOldItem : this.mItem,</span>
<a href="#l86.87"></a><span id="l86.87">         this.mExtResponse</span>
<a href="#l86.88"></a><span id="l86.88">       );</span>
<a href="#l86.89"></a><span id="l86.89"> </span>
<a href="#l86.90"></a><span id="l86.90" class="difflineat">@@ -113,39 +113,39 @@ calTransaction.prototype = {</span>
<a href="#l86.91"></a><span id="l86.91">         }</span>
<a href="#l86.92"></a><span id="l86.92">       }</span>
<a href="#l86.93"></a><span id="l86.93">     }</span>
<a href="#l86.94"></a><span id="l86.94">     if (this.mListener) {</span>
<a href="#l86.95"></a><span id="l86.95">       this.mListener.onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail);</span>
<a href="#l86.96"></a><span id="l86.96">     }</span>
<a href="#l86.97"></a><span id="l86.97">   },</span>
<a href="#l86.98"></a><span id="l86.98"> </span>
<a href="#l86.99"></a><span id="l86.99" class="difflineminus">-  onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l86.100"></a><span id="l86.100" class="difflineplus">+  onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l86.101"></a><span id="l86.101">     if (this.mListener) {</span>
<a href="#l86.102"></a><span id="l86.102">       this.mListener.onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems);</span>
<a href="#l86.103"></a><span id="l86.103">     }</span>
<a href="#l86.104"></a><span id="l86.104">   },</span>
<a href="#l86.105"></a><span id="l86.105"> </span>
<a href="#l86.106"></a><span id="l86.106" class="difflineminus">-  doTransaction: function() {</span>
<a href="#l86.107"></a><span id="l86.107" class="difflineplus">+  doTransaction() {</span>
<a href="#l86.108"></a><span id="l86.108">     this.mIsDoTransaction = true;</span>
<a href="#l86.109"></a><span id="l86.109">     switch (this.mAction) {</span>
<a href="#l86.110"></a><span id="l86.110">       case &quot;add&quot;:</span>
<a href="#l86.111"></a><span id="l86.111">         this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l86.112"></a><span id="l86.112">         break;</span>
<a href="#l86.113"></a><span id="l86.113">       case &quot;modify&quot;:</span>
<a href="#l86.114"></a><span id="l86.114">         if (this.mItem.calendar.id == this.mOldItem.calendar.id) {</span>
<a href="#l86.115"></a><span id="l86.115">           this.mCalendar.modifyItem(</span>
<a href="#l86.116"></a><span id="l86.116">             cal.itip.prepareSequence(this.mItem, this.mOldItem),</span>
<a href="#l86.117"></a><span id="l86.117">             this.mOldItem,</span>
<a href="#l86.118"></a><span id="l86.118">             this</span>
<a href="#l86.119"></a><span id="l86.119">           );</span>
<a href="#l86.120"></a><span id="l86.120">         } else {</span>
<a href="#l86.121"></a><span id="l86.121">           let self = this;</span>
<a href="#l86.122"></a><span id="l86.122">           let addListener = {</span>
<a href="#l86.123"></a><span id="l86.123" class="difflineminus">-            onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l86.124"></a><span id="l86.124" class="difflineplus">+            onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l86.125"></a><span id="l86.125">               self.onOperationComplete(...arguments);</span>
<a href="#l86.126"></a><span id="l86.126">               if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l86.127"></a><span id="l86.127">                 self.mOldItem.calendar.deleteItem(self.mOldItem, self);</span>
<a href="#l86.128"></a><span id="l86.128">               }</span>
<a href="#l86.129"></a><span id="l86.129">             },</span>
<a href="#l86.130"></a><span id="l86.130">           };</span>
<a href="#l86.131"></a><span id="l86.131"> </span>
<a href="#l86.132"></a><span id="l86.132">           this.mOldCalendar = this.mOldItem.calendar;</span>
<a href="#l86.133"></a><span id="l86.133" class="difflineat">@@ -155,17 +155,17 @@ calTransaction.prototype = {</span>
<a href="#l86.134"></a><span id="l86.134">       case &quot;delete&quot;:</span>
<a href="#l86.135"></a><span id="l86.135">         this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l86.136"></a><span id="l86.136">         break;</span>
<a href="#l86.137"></a><span id="l86.137">       default:</span>
<a href="#l86.138"></a><span id="l86.138">         throw new Components.Exception(&quot;Invalid action specified&quot;, Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l86.139"></a><span id="l86.139">     }</span>
<a href="#l86.140"></a><span id="l86.140">   },</span>
<a href="#l86.141"></a><span id="l86.141"> </span>
<a href="#l86.142"></a><span id="l86.142" class="difflineminus">-  undoTransaction: function() {</span>
<a href="#l86.143"></a><span id="l86.143" class="difflineplus">+  undoTransaction() {</span>
<a href="#l86.144"></a><span id="l86.144">     this.mIsDoTransaction = false;</span>
<a href="#l86.145"></a><span id="l86.145">     switch (this.mAction) {</span>
<a href="#l86.146"></a><span id="l86.146">       case &quot;add&quot;:</span>
<a href="#l86.147"></a><span id="l86.147">         this.mCalendar.deleteItem(this.mItem, this);</span>
<a href="#l86.148"></a><span id="l86.148">         break;</span>
<a href="#l86.149"></a><span id="l86.149">       case &quot;modify&quot;:</span>
<a href="#l86.150"></a><span id="l86.150">         if (this.mOldItem.calendar.id == this.mItem.calendar.id) {</span>
<a href="#l86.151"></a><span id="l86.151">           this.mCalendar.modifyItem(</span>
<a href="#l86.152"></a><span id="l86.152" class="difflineat">@@ -181,19 +181,19 @@ calTransaction.prototype = {</span>
<a href="#l86.153"></a><span id="l86.153">       case &quot;delete&quot;:</span>
<a href="#l86.154"></a><span id="l86.154">         this.mCalendar.addItem(this.mItem, this);</span>
<a href="#l86.155"></a><span id="l86.155">         break;</span>
<a href="#l86.156"></a><span id="l86.156">       default:</span>
<a href="#l86.157"></a><span id="l86.157">         throw new Components.Exception(&quot;Invalid action specified&quot;, Cr.NS_ERROR_ILLEGAL_VALUE);</span>
<a href="#l86.158"></a><span id="l86.158">     }</span>
<a href="#l86.159"></a><span id="l86.159">   },</span>
<a href="#l86.160"></a><span id="l86.160"> </span>
<a href="#l86.161"></a><span id="l86.161" class="difflineminus">-  redoTransaction: function() {</span>
<a href="#l86.162"></a><span id="l86.162" class="difflineplus">+  redoTransaction() {</span>
<a href="#l86.163"></a><span id="l86.163">     this.doTransaction();</span>
<a href="#l86.164"></a><span id="l86.164">   },</span>
<a href="#l86.165"></a><span id="l86.165"> </span>
<a href="#l86.166"></a><span id="l86.166">   isTransient: false,</span>
<a href="#l86.167"></a><span id="l86.167"> </span>
<a href="#l86.168"></a><span id="l86.168" class="difflineminus">-  merge: function(aTransaction) {</span>
<a href="#l86.169"></a><span id="l86.169" class="difflineplus">+  merge(aTransaction) {</span>
<a href="#l86.170"></a><span id="l86.170">     // No support for merging</span>
<a href="#l86.171"></a><span id="l86.171">     return false;</span>
<a href="#l86.172"></a><span id="l86.172">   },</span>
<a href="#l86.173"></a><span id="l86.173"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/calendar/base/src/calWeekInfoService.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/calendar/base/src/calWeekInfoService.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -7,17 +7,17 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l87.4"></a><span id="l87.4"> function calWeekInfoService() {</span>
<a href="#l87.5"></a><span id="l87.5">   this.wrappedJSObject = this;</span>
<a href="#l87.6"></a><span id="l87.6"> }</span>
<a href="#l87.7"></a><span id="l87.7"> calWeekInfoService.prototype = {</span>
<a href="#l87.8"></a><span id="l87.8">   QueryInterface: ChromeUtils.generateQI([Ci.calIWeekInfoService]),</span>
<a href="#l87.9"></a><span id="l87.9">   classID: Components.ID(&quot;{6877bbdd-f336-46f5-98ce-fe86d0285cc1}&quot;),</span>
<a href="#l87.10"></a><span id="l87.10"> </span>
<a href="#l87.11"></a><span id="l87.11">   // calIWeekInfoService:</span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-  getWeekTitle: function(aDateTime) {</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+  getWeekTitle(aDateTime) {</span>
<a href="#l87.14"></a><span id="l87.14">     /**</span>
<a href="#l87.15"></a><span id="l87.15">      * This implementation is based on the ISO 8601 standard.</span>
<a href="#l87.16"></a><span id="l87.16">      * ISO 8601 defines week one as the first week with at least 4</span>
<a href="#l87.17"></a><span id="l87.17">      * days, and defines Monday as the first day of the week.</span>
<a href="#l87.18"></a><span id="l87.18">      * Equivalently, the week one is the week with the first Thursday.</span>
<a href="#l87.19"></a><span id="l87.19">      *</span>
<a href="#l87.20"></a><span id="l87.20">      * This implementation uses the second definition, because it</span>
<a href="#l87.21"></a><span id="l87.21">      * enables the user to set a different start-day of the week</span>
<a href="#l87.22"></a><span id="l87.22" class="difflineat">@@ -76,17 +76,17 @@ calWeekInfoService.prototype = {</span>
<a href="#l87.23"></a><span id="l87.23"> </span>
<a href="#l87.24"></a><span id="l87.24">   /**</span>
<a href="#l87.25"></a><span id="l87.25">    * gets the first day of a week of a passed day under consideration</span>
<a href="#l87.26"></a><span id="l87.26">    * of the preference setting &quot;calendar.week.start&quot;</span>
<a href="#l87.27"></a><span id="l87.27">    *</span>
<a href="#l87.28"></a><span id="l87.28">    * @param aDate     a date time object</span>
<a href="#l87.29"></a><span id="l87.29">    * @return          a dateTime-object denoting the first day of the week</span>
<a href="#l87.30"></a><span id="l87.30">    */</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineminus">-  getStartOfWeek: function(aDate) {</span>
<a href="#l87.32"></a><span id="l87.32" class="difflineplus">+  getStartOfWeek(aDate) {</span>
<a href="#l87.33"></a><span id="l87.33">     let date = aDate.clone();</span>
<a href="#l87.34"></a><span id="l87.34">     date.isDate = true;</span>
<a href="#l87.35"></a><span id="l87.35">     let offset = Services.prefs.getIntPref(&quot;calendar.week.start&quot;, 0) - aDate.weekday;</span>
<a href="#l87.36"></a><span id="l87.36">     date.day += offset;</span>
<a href="#l87.37"></a><span id="l87.37">     if (offset &gt; 0) {</span>
<a href="#l87.38"></a><span id="l87.38">       date.day -= 7;</span>
<a href="#l87.39"></a><span id="l87.39">     }</span>
<a href="#l87.40"></a><span id="l87.40">     return date;</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineat">@@ -94,14 +94,14 @@ calWeekInfoService.prototype = {</span>
<a href="#l87.42"></a><span id="l87.42"> </span>
<a href="#l87.43"></a><span id="l87.43">   /**</span>
<a href="#l87.44"></a><span id="l87.44">    * gets the last day of a week of a passed day under consideration</span>
<a href="#l87.45"></a><span id="l87.45">    * of the preference setting &quot;calendar.week.start&quot;</span>
<a href="#l87.46"></a><span id="l87.46">    *</span>
<a href="#l87.47"></a><span id="l87.47">    * @param aDate     a date time object</span>
<a href="#l87.48"></a><span id="l87.48">    * @return          a dateTime-object denoting the last day of the week</span>
<a href="#l87.49"></a><span id="l87.49">    */</span>
<a href="#l87.50"></a><span id="l87.50" class="difflineminus">-  getEndOfWeek: function(aDate) {</span>
<a href="#l87.51"></a><span id="l87.51" class="difflineplus">+  getEndOfWeek(aDate) {</span>
<a href="#l87.52"></a><span id="l87.52">     let date = this.getStartOfWeek(aDate);</span>
<a href="#l87.53"></a><span id="l87.53">     date.day += 6;</span>
<a href="#l87.54"></a><span id="l87.54">     return date;</span>
<a href="#l87.55"></a><span id="l87.55">   },</span>
<a href="#l87.56"></a><span id="l87.56"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/calendar/import-export/calHtmlExport.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/calendar/import-export/calHtmlExport.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -10,30 +10,30 @@ var { cal } = ChromeUtils.import(&quot;resour</span>
<a href="#l88.4"></a><span id="l88.4"> function calHtmlExporter() {</span>
<a href="#l88.5"></a><span id="l88.5">   this.wrappedJSObject = this;</span>
<a href="#l88.6"></a><span id="l88.6"> }</span>
<a href="#l88.7"></a><span id="l88.7"> </span>
<a href="#l88.8"></a><span id="l88.8"> calHtmlExporter.prototype = {</span>
<a href="#l88.9"></a><span id="l88.9">   QueryInterface: ChromeUtils.generateQI([Ci.calIExporter]),</span>
<a href="#l88.10"></a><span id="l88.10">   classID: Components.ID(&quot;{72d9ab35-9b1b-442a-8cd0-ae49f00b159b}&quot;),</span>
<a href="#l88.11"></a><span id="l88.11"> </span>
<a href="#l88.12"></a><span id="l88.12" class="difflineminus">-  getFileTypes: function() {</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+  getFileTypes() {</span>
<a href="#l88.14"></a><span id="l88.14">     let wildmat = &quot;*.html; *.htm&quot;;</span>
<a href="#l88.15"></a><span id="l88.15">     let label = cal.l10n.getCalString(&quot;filterHtml&quot;, [wildmat]);</span>
<a href="#l88.16"></a><span id="l88.16">     return [</span>
<a href="#l88.17"></a><span id="l88.17">       {</span>
<a href="#l88.18"></a><span id="l88.18">         QueryInterface: ChromeUtils.generateQI([Ci.calIFileType]),</span>
<a href="#l88.19"></a><span id="l88.19">         defaultExtension: &quot;html&quot;,</span>
<a href="#l88.20"></a><span id="l88.20">         extensionFilter: wildmat,</span>
<a href="#l88.21"></a><span id="l88.21">         description: label,</span>
<a href="#l88.22"></a><span id="l88.22">       },</span>
<a href="#l88.23"></a><span id="l88.23">     ];</span>
<a href="#l88.24"></a><span id="l88.24">   },</span>
<a href="#l88.25"></a><span id="l88.25"> </span>
<a href="#l88.26"></a><span id="l88.26" class="difflineminus">-  exportToStream: function(aStream, aItems, aTitle) {</span>
<a href="#l88.27"></a><span id="l88.27" class="difflineplus">+  exportToStream(aStream, aItems, aTitle) {</span>
<a href="#l88.28"></a><span id="l88.28">     let document = cal.xml.parseFile(&quot;chrome://calendar/skin/shared/printing/calHtmlExport.html&quot;);</span>
<a href="#l88.29"></a><span id="l88.29">     let itemContainer = document.getElementById(&quot;item-container&quot;);</span>
<a href="#l88.30"></a><span id="l88.30">     document.getElementById(&quot;title&quot;).textContent = aTitle || cal.l10n.getCalString(&quot;HTMLTitle&quot;);</span>
<a href="#l88.31"></a><span id="l88.31"> </span>
<a href="#l88.32"></a><span id="l88.32">     // Sort aItems</span>
<a href="#l88.33"></a><span id="l88.33">     aItems.sort((a, b) =&gt; {</span>
<a href="#l88.34"></a><span id="l88.34">       let start_a = a[cal.dtz.startDateProp(a)];</span>
<a href="#l88.35"></a><span id="l88.35">       if (!start_a) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/calendar/import-export/calIcsImportExport.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/calendar/import-export/calIcsImportExport.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -26,17 +26,17 @@ function calIcsImporter() {</span>
<a href="#l89.4"></a><span id="l89.4"> }</span>
<a href="#l89.5"></a><span id="l89.5"> </span>
<a href="#l89.6"></a><span id="l89.6"> calIcsImporter.prototype = {</span>
<a href="#l89.7"></a><span id="l89.7">   QueryInterface: ChromeUtils.generateQI([Ci.calIImporter]),</span>
<a href="#l89.8"></a><span id="l89.8">   classID: Components.ID(&quot;{1e3e33dc-445a-49de-b2b6-15b2a050bb9d}&quot;),</span>
<a href="#l89.9"></a><span id="l89.9"> </span>
<a href="#l89.10"></a><span id="l89.10">   getFileTypes: getIcsFileTypes,</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineminus">-  importFromStream: function(aStream) {</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+  importFromStream(aStream) {</span>
<a href="#l89.14"></a><span id="l89.14">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l89.15"></a><span id="l89.15">     parser.parseFromStream(aStream, null);</span>
<a href="#l89.16"></a><span id="l89.16">     return parser.getItems();</span>
<a href="#l89.17"></a><span id="l89.17">   },</span>
<a href="#l89.18"></a><span id="l89.18"> };</span>
<a href="#l89.19"></a><span id="l89.19"> </span>
<a href="#l89.20"></a><span id="l89.20"> // Exporter</span>
<a href="#l89.21"></a><span id="l89.21"> function calIcsExporter() {</span>
<a href="#l89.22"></a><span id="l89.22" class="difflineat">@@ -44,16 +44,16 @@ function calIcsExporter() {</span>
<a href="#l89.23"></a><span id="l89.23"> }</span>
<a href="#l89.24"></a><span id="l89.24"> </span>
<a href="#l89.25"></a><span id="l89.25"> calIcsExporter.prototype = {</span>
<a href="#l89.26"></a><span id="l89.26">   QueryInterface: ChromeUtils.generateQI([Ci.calIExporter]),</span>
<a href="#l89.27"></a><span id="l89.27">   classID: Components.ID(&quot;{a6a524ce-adff-4a0f-bb7d-d1aaad4adc60}&quot;),</span>
<a href="#l89.28"></a><span id="l89.28"> </span>
<a href="#l89.29"></a><span id="l89.29">   getFileTypes: getIcsFileTypes,</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31" class="difflineminus">-  exportToStream: function(aStream, aItems, aTitle) {</span>
<a href="#l89.32"></a><span id="l89.32" class="difflineplus">+  exportToStream(aStream, aItems, aTitle) {</span>
<a href="#l89.33"></a><span id="l89.33">     let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(</span>
<a href="#l89.34"></a><span id="l89.34">       Ci.calIIcsSerializer</span>
<a href="#l89.35"></a><span id="l89.35">     );</span>
<a href="#l89.36"></a><span id="l89.36">     serializer.addItems(aItems);</span>
<a href="#l89.37"></a><span id="l89.37">     serializer.serializeToStream(aStream);</span>
<a href="#l89.38"></a><span id="l89.38">   },</span>
<a href="#l89.39"></a><span id="l89.39"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/calendar/import-export/calListFormatter.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/calendar/import-export/calListFormatter.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -14,15 +14,15 @@ function calListFormatter() {</span>
<a href="#l90.4"></a><span id="l90.4"> calListFormatter.prototype = {</span>
<a href="#l90.5"></a><span id="l90.5">   QueryInterface: ChromeUtils.generateQI([Ci.calIPrintFormatter]),</span>
<a href="#l90.6"></a><span id="l90.6">   classID: Components.ID(&quot;{9ae04413-fee3-45b9-8bbb-1eb39a4cbd1b}&quot;),</span>
<a href="#l90.7"></a><span id="l90.7"> </span>
<a href="#l90.8"></a><span id="l90.8">   get name() {</span>
<a href="#l90.9"></a><span id="l90.9">     return cal.l10n.getCalString(&quot;formatListName&quot;);</span>
<a href="#l90.10"></a><span id="l90.10">   },</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-  formatToHtml: function(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+  formatToHtml(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l90.14"></a><span id="l90.14">     let htmlexporter = Cc[&quot;@mozilla.org/calendar/export;1?type=htmllist&quot;].createInstance(</span>
<a href="#l90.15"></a><span id="l90.15">       Ci.calIExporter</span>
<a href="#l90.16"></a><span id="l90.16">     );</span>
<a href="#l90.17"></a><span id="l90.17">     htmlexporter.exportToStream(aStream, aItems, aTitle);</span>
<a href="#l90.18"></a><span id="l90.18">   },</span>
<a href="#l90.19"></a><span id="l90.19"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/calendar/import-export/calMonthGridPrinter.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -15,17 +15,17 @@ function calMonthPrinter() {</span>
<a href="#l91.4"></a><span id="l91.4"> calMonthPrinter.prototype = {</span>
<a href="#l91.5"></a><span id="l91.5">   QueryInterface: ChromeUtils.generateQI([Ci.calIPrintFormatter]),</span>
<a href="#l91.6"></a><span id="l91.6">   classID: Components.ID(&quot;{f42d5132-92c4-487b-b5c8-38bf292d74c1}&quot;),</span>
<a href="#l91.7"></a><span id="l91.7"> </span>
<a href="#l91.8"></a><span id="l91.8">   get name() {</span>
<a href="#l91.9"></a><span id="l91.9">     return cal.l10n.getCalString(&quot;monthPrinterName&quot;);</span>
<a href="#l91.10"></a><span id="l91.10">   },</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-  formatToHtml: function(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+  formatToHtml(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l91.14"></a><span id="l91.14">     let document = cal.xml.parseFile(</span>
<a href="#l91.15"></a><span id="l91.15">       &quot;chrome://calendar/skin/shared/printing/calMonthGridPrinter.html&quot;</span>
<a href="#l91.16"></a><span id="l91.16">     );</span>
<a href="#l91.17"></a><span id="l91.17">     let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l91.18"></a><span id="l91.18"> </span>
<a href="#l91.19"></a><span id="l91.19">     // Set page title</span>
<a href="#l91.20"></a><span id="l91.20">     document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l91.21"></a><span id="l91.21"> </span>
<a href="#l91.22"></a><span id="l91.22" class="difflineat">@@ -102,17 +102,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l91.23"></a><span id="l91.23">     let html = cal.xml.serializeDOM(document);</span>
<a href="#l91.24"></a><span id="l91.24">     let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].createInstance(</span>
<a href="#l91.25"></a><span id="l91.25">       Ci.nsIConverterOutputStream</span>
<a href="#l91.26"></a><span id="l91.26">     );</span>
<a href="#l91.27"></a><span id="l91.27">     convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l91.28"></a><span id="l91.28">     convStream.writeString(html);</span>
<a href="#l91.29"></a><span id="l91.29">   },</span>
<a href="#l91.30"></a><span id="l91.30"> </span>
<a href="#l91.31"></a><span id="l91.31" class="difflineminus">-  normalizeStartDate: function(aStart) {</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineplus">+  normalizeStartDate(aStart) {</span>
<a href="#l91.33"></a><span id="l91.33">     // Make sure the start date is really a date.</span>
<a href="#l91.34"></a><span id="l91.34">     let startDate = aStart.clone();</span>
<a href="#l91.35"></a><span id="l91.35">     startDate.isDate = true;</span>
<a href="#l91.36"></a><span id="l91.36"> </span>
<a href="#l91.37"></a><span id="l91.37">     // Find out if the start date is also shown in the first week of the</span>
<a href="#l91.38"></a><span id="l91.38">     // following month. This means we can spare a month printout.</span>
<a href="#l91.39"></a><span id="l91.39">     let firstDayOfNextMonth = startDate.clone();</span>
<a href="#l91.40"></a><span id="l91.40">     firstDayOfNextMonth.day = 1;</span>
<a href="#l91.41"></a><span id="l91.41" class="difflineat">@@ -125,17 +125,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l91.42"></a><span id="l91.42">     ) {</span>
<a href="#l91.43"></a><span id="l91.43">       startDate = firstDayOfNextMonth;</span>
<a href="#l91.44"></a><span id="l91.44">     } else {</span>
<a href="#l91.45"></a><span id="l91.45">       startDate = startDate.startOfMonth;</span>
<a href="#l91.46"></a><span id="l91.46">     }</span>
<a href="#l91.47"></a><span id="l91.47">     return startDate;</span>
<a href="#l91.48"></a><span id="l91.48">   },</span>
<a href="#l91.49"></a><span id="l91.49"> </span>
<a href="#l91.50"></a><span id="l91.50" class="difflineminus">-  normalizeEndDate: function(aEnd) {</span>
<a href="#l91.51"></a><span id="l91.51" class="difflineplus">+  normalizeEndDate(aEnd) {</span>
<a href="#l91.52"></a><span id="l91.52">     // Copy end date, which is exclusive. For our calculations, we will</span>
<a href="#l91.53"></a><span id="l91.53">     // only be handling dates and the formatToHtml() code is much cleaner with</span>
<a href="#l91.54"></a><span id="l91.54">     // the range being inclusive.</span>
<a href="#l91.55"></a><span id="l91.55">     let endDate = aEnd.clone();</span>
<a href="#l91.56"></a><span id="l91.56">     endDate.isDate = true;</span>
<a href="#l91.57"></a><span id="l91.57"> </span>
<a href="#l91.58"></a><span id="l91.58">     // Find out if the end date is also shown in the last week of the</span>
<a href="#l91.59"></a><span id="l91.59">     // previous month. This also means we can spare a month printout.</span>
<a href="#l91.60"></a><span id="l91.60" class="difflineat">@@ -149,17 +149,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l91.61"></a><span id="l91.61">         .compare(endDate) &gt;= 0</span>
<a href="#l91.62"></a><span id="l91.62">     ) {</span>
<a href="#l91.63"></a><span id="l91.63">       endDate = lastDayOfPreviousMonth;</span>
<a href="#l91.64"></a><span id="l91.64">     }</span>
<a href="#l91.65"></a><span id="l91.65"> </span>
<a href="#l91.66"></a><span id="l91.66">     return endDate;</span>
<a href="#l91.67"></a><span id="l91.67">   },</span>
<a href="#l91.68"></a><span id="l91.68"> </span>
<a href="#l91.69"></a><span id="l91.69" class="difflineminus">-  setupMonth: function(document, startOfMonth, dayTable) {</span>
<a href="#l91.70"></a><span id="l91.70" class="difflineplus">+  setupMonth(document, startOfMonth, dayTable) {</span>
<a href="#l91.71"></a><span id="l91.71">     let monthTemplate = document.getElementById(&quot;month-template&quot;);</span>
<a href="#l91.72"></a><span id="l91.72">     let monthContainer = document.getElementById(&quot;month-container&quot;);</span>
<a href="#l91.73"></a><span id="l91.73"> </span>
<a href="#l91.74"></a><span id="l91.74">     // Clone the template month and make sure it doesn't have an id</span>
<a href="#l91.75"></a><span id="l91.75">     let currentMonth = monthTemplate.cloneNode(true);</span>
<a href="#l91.76"></a><span id="l91.76">     currentMonth.removeAttribute(&quot;id&quot;);</span>
<a href="#l91.77"></a><span id="l91.77">     currentMonth.item = startOfMonth.clone();</span>
<a href="#l91.78"></a><span id="l91.78"> </span>
<a href="#l91.79"></a><span id="l91.79" class="difflineat">@@ -194,17 +194,17 @@ calMonthPrinter.prototype = {</span>
<a href="#l91.80"></a><span id="l91.80">     // Now insert the month into the page container, sorting by date (and therefore by month)</span>
<a href="#l91.81"></a><span id="l91.81">     function compareDates(a, b) {</span>
<a href="#l91.82"></a><span id="l91.82">       return !a || !b ? -1 : a.compare(b);</span>
<a href="#l91.83"></a><span id="l91.83">     }</span>
<a href="#l91.84"></a><span id="l91.84"> </span>
<a href="#l91.85"></a><span id="l91.85">     cal.data.binaryInsertNode(monthContainer, currentMonth, currentMonth.item, compareDates);</span>
<a href="#l91.86"></a><span id="l91.86">   },</span>
<a href="#l91.87"></a><span id="l91.87"> </span>
<a href="#l91.88"></a><span id="l91.88" class="difflineminus">-  setupWeek: function(document, weekContainer, startOfWeek, mainMonth, dayTable) {</span>
<a href="#l91.89"></a><span id="l91.89" class="difflineplus">+  setupWeek(document, weekContainer, startOfWeek, mainMonth, dayTable) {</span>
<a href="#l91.90"></a><span id="l91.90">     const weekdayMap = [</span>
<a href="#l91.91"></a><span id="l91.91">       &quot;sunday&quot;,</span>
<a href="#l91.92"></a><span id="l91.92">       &quot;monday&quot;,</span>
<a href="#l91.93"></a><span id="l91.93">       &quot;tuesday&quot;,</span>
<a href="#l91.94"></a><span id="l91.94">       &quot;wednesday&quot;,</span>
<a href="#l91.95"></a><span id="l91.95">       &quot;thursday&quot;,</span>
<a href="#l91.96"></a><span id="l91.96">       &quot;friday&quot;,</span>
<a href="#l91.97"></a><span id="l91.97">       &quot;saturday&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/calendar/import-export/calOutlookCSVImportExport.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -110,17 +110,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l92.4"></a><span id="l92.4">    *  default durations are set.</span>
<a href="#l92.5"></a><span id="l92.5">    *</span>
<a href="#l92.6"></a><span id="l92.6">    * The rest of the lines are events, one event per line, with fields in the</span>
<a href="#l92.7"></a><span id="l92.7">    * order described by the first line. All non-empty values must be quoted.</span>
<a href="#l92.8"></a><span id="l92.8">    *</span>
<a href="#l92.9"></a><span id="l92.9">    * Returns: an array of parsed calendarEvents.</span>
<a href="#l92.10"></a><span id="l92.10">    *   If the parse is cancelled, a zero length array is returned.</span>
<a href="#l92.11"></a><span id="l92.11">    */</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-  importFromStream: function(aStream) {</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+  importFromStream(aStream) {</span>
<a href="#l92.14"></a><span id="l92.14">     let scriptableInputStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l92.15"></a><span id="l92.15">       Ci.nsIScriptableInputStream</span>
<a href="#l92.16"></a><span id="l92.16">     );</span>
<a href="#l92.17"></a><span id="l92.17">     scriptableInputStream.init(aStream);</span>
<a href="#l92.18"></a><span id="l92.18">     let str = scriptableInputStream.read(-1);</span>
<a href="#l92.19"></a><span id="l92.19"> </span>
<a href="#l92.20"></a><span id="l92.20">     // parse header line of quoted comma separated column names.</span>
<a href="#l92.21"></a><span id="l92.21">     let trimEndQuotesRegExp = /^&quot;(.*)&quot;$/m;</span>
<a href="#l92.22"></a><span id="l92.22" class="difflineat">@@ -393,17 +393,17 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l92.23"></a><span id="l92.23">       // get next events fields</span>
<a href="#l92.24"></a><span id="l92.24">       eventFields = eventRegExp.exec(str);</span>
<a href="#l92.25"></a><span id="l92.25">     } while (eventRegExp.lastIndex != 0);</span>
<a href="#l92.26"></a><span id="l92.26"> </span>
<a href="#l92.27"></a><span id="l92.27">     // return results</span>
<a href="#l92.28"></a><span id="l92.28">     return eventArray;</span>
<a href="#l92.29"></a><span id="l92.29">   },</span>
<a href="#l92.30"></a><span id="l92.30"> </span>
<a href="#l92.31"></a><span id="l92.31" class="difflineminus">-  parseDateTime: function(aDate, aTime, aLocale) {</span>
<a href="#l92.32"></a><span id="l92.32" class="difflineplus">+  parseDateTime(aDate, aTime, aLocale) {</span>
<a href="#l92.33"></a><span id="l92.33">     let date = cal.createDateTime();</span>
<a href="#l92.34"></a><span id="l92.34"> </span>
<a href="#l92.35"></a><span id="l92.35">     // XXX Can we do better?</span>
<a href="#l92.36"></a><span id="l92.36">     date.timezone = cal.dtz.floating;</span>
<a href="#l92.37"></a><span id="l92.37"> </span>
<a href="#l92.38"></a><span id="l92.38">     let datepart = aLocale.dateRe.exec(aDate);</span>
<a href="#l92.39"></a><span id="l92.39">     let timepart = aLocale.timeRe.exec(aTime);</span>
<a href="#l92.40"></a><span id="l92.40"> </span>
<a href="#l92.41"></a><span id="l92.41" class="difflineat">@@ -433,30 +433,30 @@ calOutlookCSVImporter.prototype = {</span>
<a href="#l92.42"></a><span id="l92.42">       }</span>
<a href="#l92.43"></a><span id="l92.43">     } else if (date.hour &lt; 12) {</span>
<a href="#l92.44"></a><span id="l92.44">       // PM</span>
<a href="#l92.45"></a><span id="l92.45">       date.hour += 12;</span>
<a href="#l92.46"></a><span id="l92.46">     }</span>
<a href="#l92.47"></a><span id="l92.47">     return date;</span>
<a href="#l92.48"></a><span id="l92.48">   },</span>
<a href="#l92.49"></a><span id="l92.49"> </span>
<a href="#l92.50"></a><span id="l92.50" class="difflineminus">-  parseTextField: function(aTextField) {</span>
<a href="#l92.51"></a><span id="l92.51" class="difflineplus">+  parseTextField(aTextField) {</span>
<a href="#l92.52"></a><span id="l92.52">     return aTextField ? aTextField.replace(/&quot;&quot;/g, '&quot;') : &quot;&quot;;</span>
<a href="#l92.53"></a><span id="l92.53">   },</span>
<a href="#l92.54"></a><span id="l92.54"> };</span>
<a href="#l92.55"></a><span id="l92.55"> </span>
<a href="#l92.56"></a><span id="l92.56"> // Exporter</span>
<a href="#l92.57"></a><span id="l92.57"> function calOutlookCSVExporter() {}</span>
<a href="#l92.58"></a><span id="l92.58"> calOutlookCSVExporter.prototype = {</span>
<a href="#l92.59"></a><span id="l92.59">   QueryInterface: ChromeUtils.generateQI([Ci.calIExporter]),</span>
<a href="#l92.60"></a><span id="l92.60">   classID: Components.ID(&quot;{48e6d3a6-b41b-4052-9ed2-40b27800bd4b}&quot;),</span>
<a href="#l92.61"></a><span id="l92.61"> </span>
<a href="#l92.62"></a><span id="l92.62">   getFileTypes: getOutlookCsvFileTypes,</span>
<a href="#l92.63"></a><span id="l92.63"> </span>
<a href="#l92.64"></a><span id="l92.64" class="difflineminus">-  exportToStream: function(aStream, aItems, aTitle) {</span>
<a href="#l92.65"></a><span id="l92.65" class="difflineplus">+  exportToStream(aStream, aItems, aTitle) {</span>
<a href="#l92.66"></a><span id="l92.66">     // Helper functions</span>
<a href="#l92.67"></a><span id="l92.67">     function dateString(aDateTime) {</span>
<a href="#l92.68"></a><span id="l92.68">       return cal.dtz.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.dateFormat);</span>
<a href="#l92.69"></a><span id="l92.69">     }</span>
<a href="#l92.70"></a><span id="l92.70">     function timeString(aDateTime) {</span>
<a href="#l92.71"></a><span id="l92.71">       return cal.dtz.dateTimeToJsDate(aDateTime).toLocaleString(&quot;en-US&quot;, localeEn.timeFormat);</span>
<a href="#l92.72"></a><span id="l92.72">     }</span>
<a href="#l92.73"></a><span id="l92.73">     function txtString(aString) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/calendar/import-export/calWeekPrinter.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/calendar/import-export/calWeekPrinter.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -15,17 +15,17 @@ function calWeekPrinter() {</span>
<a href="#l93.4"></a><span id="l93.4"> calWeekPrinter.prototype = {</span>
<a href="#l93.5"></a><span id="l93.5">   QueryInterface: ChromeUtils.generateQI([Ci.calIPrintFormatter]),</span>
<a href="#l93.6"></a><span id="l93.6">   classID: Components.ID(&quot;{2d6ec97b-9109-4b92-89c5-d4b4806619ce}&quot;),</span>
<a href="#l93.7"></a><span id="l93.7"> </span>
<a href="#l93.8"></a><span id="l93.8">   get name() {</span>
<a href="#l93.9"></a><span id="l93.9">     return cal.l10n.getCalString(&quot;weekPrinterName&quot;);</span>
<a href="#l93.10"></a><span id="l93.10">   },</span>
<a href="#l93.11"></a><span id="l93.11"> </span>
<a href="#l93.12"></a><span id="l93.12" class="difflineminus">-  formatToHtml: function(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+  formatToHtml(aStream, aStart, aEnd, aItems, aTitle) {</span>
<a href="#l93.14"></a><span id="l93.14">     let document = cal.xml.parseFile(&quot;chrome://calendar/skin/shared/printing/calWeekPrinter.html&quot;);</span>
<a href="#l93.15"></a><span id="l93.15">     let defaultTimezone = cal.dtz.defaultTimezone;</span>
<a href="#l93.16"></a><span id="l93.16"> </span>
<a href="#l93.17"></a><span id="l93.17">     // Set page title</span>
<a href="#l93.18"></a><span id="l93.18">     document.getElementById(&quot;title&quot;).textContent = aTitle;</span>
<a href="#l93.19"></a><span id="l93.19"> </span>
<a href="#l93.20"></a><span id="l93.20">     cal.view.colorTracker.addColorsToDocument(document);</span>
<a href="#l93.21"></a><span id="l93.21"> </span>
<a href="#l93.22"></a><span id="l93.22" class="difflineat">@@ -89,17 +89,17 @@ calWeekPrinter.prototype = {</span>
<a href="#l93.23"></a><span id="l93.23">     let html = cal.xml.serializeDOM(document);</span>
<a href="#l93.24"></a><span id="l93.24">     let convStream = Cc[&quot;@mozilla.org/intl/converter-output-stream;1&quot;].createInstance(</span>
<a href="#l93.25"></a><span id="l93.25">       Ci.nsIConverterOutputStream</span>
<a href="#l93.26"></a><span id="l93.26">     );</span>
<a href="#l93.27"></a><span id="l93.27">     convStream.init(aStream, &quot;UTF-8&quot;);</span>
<a href="#l93.28"></a><span id="l93.28">     convStream.writeString(html);</span>
<a href="#l93.29"></a><span id="l93.29">   },</span>
<a href="#l93.30"></a><span id="l93.30"> </span>
<a href="#l93.31"></a><span id="l93.31" class="difflineminus">-  setupWeek: function(document, startOfWeek, dayTable) {</span>
<a href="#l93.32"></a><span id="l93.32" class="difflineplus">+  setupWeek(document, startOfWeek, dayTable) {</span>
<a href="#l93.33"></a><span id="l93.33">     const weekdayMap = [</span>
<a href="#l93.34"></a><span id="l93.34">       &quot;sunday&quot;,</span>
<a href="#l93.35"></a><span id="l93.35">       &quot;monday&quot;,</span>
<a href="#l93.36"></a><span id="l93.36">       &quot;tuesday&quot;,</span>
<a href="#l93.37"></a><span id="l93.37">       &quot;wednesday&quot;,</span>
<a href="#l93.38"></a><span id="l93.38">       &quot;thursday&quot;,</span>
<a href="#l93.39"></a><span id="l93.39">       &quot;friday&quot;,</span>
<a href="#l93.40"></a><span id="l93.40">       &quot;saturday&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/calendar/itip/calItipEmailTransport.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/calendar/itip/calItipEmailTransport.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -34,32 +34,31 @@ calItipEmailTransport.prototype = {</span>
<a href="#l94.4"></a><span id="l94.4">   mSenderAddress: null,</span>
<a href="#l94.5"></a><span id="l94.5">   get senderAddress() {</span>
<a href="#l94.6"></a><span id="l94.6">     return this.mSenderAddress;</span>
<a href="#l94.7"></a><span id="l94.7">   },</span>
<a href="#l94.8"></a><span id="l94.8">   set senderAddress(aValue) {</span>
<a href="#l94.9"></a><span id="l94.9">     return (this.mSenderAddress = aValue);</span>
<a href="#l94.10"></a><span id="l94.10">   },</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-  sendItems: function(aRecipients, aItipItem) {</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+  sendItems(aRecipients, aItipItem) {</span>
<a href="#l94.14"></a><span id="l94.14">     if (this.mHasXpcomMail) {</span>
<a href="#l94.15"></a><span id="l94.15">       cal.LOG(&quot;sendItems: Preparing to send an invitation email...&quot;);</span>
<a href="#l94.16"></a><span id="l94.16">       let items = this._prepareItems(aItipItem);</span>
<a href="#l94.17"></a><span id="l94.17">       if (items === false) {</span>
<a href="#l94.18"></a><span id="l94.18">         return false;</span>
<a href="#l94.19"></a><span id="l94.19">       }</span>
<a href="#l94.20"></a><span id="l94.20"> </span>
<a href="#l94.21"></a><span id="l94.21">       return this._sendXpcomMail(aRecipients, items.subject, items.body, aItipItem);</span>
<a href="#l94.22"></a><span id="l94.22" class="difflineminus">-    } else {</span>
<a href="#l94.23"></a><span id="l94.23" class="difflineminus">-      // sending xpcom mail is not available if no identity has been set</span>
<a href="#l94.24"></a><span id="l94.24" class="difflineminus">-      throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l94.25"></a><span id="l94.25">     }</span>
<a href="#l94.26"></a><span id="l94.26" class="difflineplus">+    // sending xpcom mail is not available if no identity has been set</span>
<a href="#l94.27"></a><span id="l94.27" class="difflineplus">+    throw Cr.NS_ERROR_NOT_AVAILABLE;</span>
<a href="#l94.28"></a><span id="l94.28">   },</span>
<a href="#l94.29"></a><span id="l94.29"> </span>
<a href="#l94.30"></a><span id="l94.30" class="difflineminus">-  _prepareItems: function(aItipItem) {</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+  _prepareItems(aItipItem) {</span>
<a href="#l94.32"></a><span id="l94.32">     let item = aItipItem.getItemList()[0];</span>
<a href="#l94.33"></a><span id="l94.33"> </span>
<a href="#l94.34"></a><span id="l94.34">     // Get ourselves some default text - when we handle organizer properly</span>
<a href="#l94.35"></a><span id="l94.35">     // We'll need a way to configure the Common Name attribute and we should</span>
<a href="#l94.36"></a><span id="l94.36">     // use it here rather than the email address</span>
<a href="#l94.37"></a><span id="l94.37"> </span>
<a href="#l94.38"></a><span id="l94.38">     let summary = item.getProperty(&quot;SUMMARY&quot;) || &quot;&quot;;</span>
<a href="#l94.39"></a><span id="l94.39">     let subject = &quot;&quot;;</span>
<a href="#l94.40"></a><span id="l94.40" class="difflineat">@@ -137,22 +136,22 @@ calItipEmailTransport.prototype = {</span>
<a href="#l94.41"></a><span id="l94.41">         }</span>
<a href="#l94.42"></a><span id="l94.42">         subject = cal.l10n.getLtnString(subjectKey, [summary]);</span>
<a href="#l94.43"></a><span id="l94.43">         body = cal.l10n.getLtnString(bodyKey, [name]);</span>
<a href="#l94.44"></a><span id="l94.44">         break;</span>
<a href="#l94.45"></a><span id="l94.45">       }</span>
<a href="#l94.46"></a><span id="l94.46">     }</span>
<a href="#l94.47"></a><span id="l94.47"> </span>
<a href="#l94.48"></a><span id="l94.48">     return {</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineminus">-      subject: subject,</span>
<a href="#l94.50"></a><span id="l94.50" class="difflineminus">-      body: body,</span>
<a href="#l94.51"></a><span id="l94.51" class="difflineplus">+      subject,</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineplus">+      body,</span>
<a href="#l94.53"></a><span id="l94.53">     };</span>
<a href="#l94.54"></a><span id="l94.54">   },</span>
<a href="#l94.55"></a><span id="l94.55"> </span>
<a href="#l94.56"></a><span id="l94.56" class="difflineminus">-  _initEmailTransport: function() {</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineplus">+  _initEmailTransport() {</span>
<a href="#l94.58"></a><span id="l94.58">     this.mHasXpcomMail = true;</span>
<a href="#l94.59"></a><span id="l94.59"> </span>
<a href="#l94.60"></a><span id="l94.60">     try {</span>
<a href="#l94.61"></a><span id="l94.61">       this.mDefaultSmtpServer = MailServices.smtp.defaultServer;</span>
<a href="#l94.62"></a><span id="l94.62">       this.mDefaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l94.63"></a><span id="l94.63">       this.mDefaultIdentity = this.mDefaultAccount ? this.mDefaultAccount.defaultIdentity : null;</span>
<a href="#l94.64"></a><span id="l94.64"> </span>
<a href="#l94.65"></a><span id="l94.65">       if (!this.mDefaultIdentity) {</span>
<a href="#l94.66"></a><span id="l94.66" class="difflineat">@@ -170,17 +169,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l94.67"></a><span id="l94.67">         }</span>
<a href="#l94.68"></a><span id="l94.68">       }</span>
<a href="#l94.69"></a><span id="l94.69">     } catch (ex) {</span>
<a href="#l94.70"></a><span id="l94.70">       // Then we must resort to operating system specific means</span>
<a href="#l94.71"></a><span id="l94.71">       this.mHasXpcomMail = false;</span>
<a href="#l94.72"></a><span id="l94.72">     }</span>
<a href="#l94.73"></a><span id="l94.73">   },</span>
<a href="#l94.74"></a><span id="l94.74"> </span>
<a href="#l94.75"></a><span id="l94.75" class="difflineminus">-  _sendXpcomMail: function(aToList, aSubject, aBody, aItipItem) {</span>
<a href="#l94.76"></a><span id="l94.76" class="difflineplus">+  _sendXpcomMail(aToList, aSubject, aBody, aItipItem) {</span>
<a href="#l94.77"></a><span id="l94.77">     let identity = null;</span>
<a href="#l94.78"></a><span id="l94.78">     let account;</span>
<a href="#l94.79"></a><span id="l94.79">     if (aItipItem.targetCalendar) {</span>
<a href="#l94.80"></a><span id="l94.80">       identity = aItipItem.targetCalendar.getProperty(&quot;imip.identity&quot;);</span>
<a href="#l94.81"></a><span id="l94.81">       if (identity) {</span>
<a href="#l94.82"></a><span id="l94.82">         identity = identity.QueryInterface(Ci.nsIMsgIdentity);</span>
<a href="#l94.83"></a><span id="l94.83">         account = aItipItem.targetCalendar</span>
<a href="#l94.84"></a><span id="l94.84">           .getProperty(&quot;imip.account&quot;)</span>
<a href="#l94.85"></a><span id="l94.85" class="difflineat">@@ -315,17 +314,17 @@ calItipEmailTransport.prototype = {</span>
<a href="#l94.86"></a><span id="l94.86">       default: {</span>
<a href="#l94.87"></a><span id="l94.87">         // Also of this case should have been taken care at the same place</span>
<a href="#l94.88"></a><span id="l94.88">         throw new Error(&quot;sendXpcomMail: Unknown autoResponse type: &quot; + aItipItem.autoResponse);</span>
<a href="#l94.89"></a><span id="l94.89">       }</span>
<a href="#l94.90"></a><span id="l94.90">     }</span>
<a href="#l94.91"></a><span id="l94.91">     return false;</span>
<a href="#l94.92"></a><span id="l94.92">   },</span>
<a href="#l94.93"></a><span id="l94.93"> </span>
<a href="#l94.94"></a><span id="l94.94" class="difflineminus">-  _createTempImipFile: function(aToList, aSubject, aBody, aItipItem, aIdentity, aMessageId) {</span>
<a href="#l94.95"></a><span id="l94.95" class="difflineplus">+  _createTempImipFile(aToList, aSubject, aBody, aItipItem, aIdentity, aMessageId) {</span>
<a href="#l94.96"></a><span id="l94.96">     try {</span>
<a href="#l94.97"></a><span id="l94.97">       let itemList = aItipItem.getItemList();</span>
<a href="#l94.98"></a><span id="l94.98">       let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(</span>
<a href="#l94.99"></a><span id="l94.99">         Ci.calIIcsSerializer</span>
<a href="#l94.100"></a><span id="l94.100">       );</span>
<a href="#l94.101"></a><span id="l94.101">       serializer.addItems(itemList);</span>
<a href="#l94.102"></a><span id="l94.102">       let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l94.103"></a><span id="l94.103">       methodProp.value = aItipItem.responseMethod;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/calendar/lightning/components/calItipProtocolHandler.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -26,58 +26,58 @@ ItipChannel.prototype = {</span>
<a href="#l95.4"></a><span id="l95.4">   loadAttributes: null,</span>
<a href="#l95.5"></a><span id="l95.5">   contentLength: 0,</span>
<a href="#l95.6"></a><span id="l95.6">   owner: null,</span>
<a href="#l95.7"></a><span id="l95.7">   loadGroup: null,</span>
<a href="#l95.8"></a><span id="l95.8">   notificationCallbacks: null,</span>
<a href="#l95.9"></a><span id="l95.9">   securityInfo: null,</span>
<a href="#l95.10"></a><span id="l95.10"> </span>
<a href="#l95.11"></a><span id="l95.11">   open: NYI,</span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-  asyncOpen: function(observer) {</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+  asyncOpen(observer) {</span>
<a href="#l95.14"></a><span id="l95.14">     observer.onStartRequest(this, null);</span>
<a href="#l95.15"></a><span id="l95.15">   },</span>
<a href="#l95.16"></a><span id="l95.16" class="difflineminus">-  asyncRead: function(listener, ctxt) {</span>
<a href="#l95.17"></a><span id="l95.17" class="difflineplus">+  asyncRead(listener, ctxt) {</span>
<a href="#l95.18"></a><span id="l95.18">     return listener.onStartRequest(this, ctxt);</span>
<a href="#l95.19"></a><span id="l95.19">   },</span>
<a href="#l95.20"></a><span id="l95.20"> </span>
<a href="#l95.21"></a><span id="l95.21" class="difflineminus">-  isPending: function() {</span>
<a href="#l95.22"></a><span id="l95.22" class="difflineplus">+  isPending() {</span>
<a href="#l95.23"></a><span id="l95.23">     return true;</span>
<a href="#l95.24"></a><span id="l95.24">   },</span>
<a href="#l95.25"></a><span id="l95.25">   status: Cr.NS_OK,</span>
<a href="#l95.26"></a><span id="l95.26" class="difflineminus">-  cancel: function(status) {</span>
<a href="#l95.27"></a><span id="l95.27" class="difflineplus">+  cancel(status) {</span>
<a href="#l95.28"></a><span id="l95.28">     this.status = status;</span>
<a href="#l95.29"></a><span id="l95.29">   },</span>
<a href="#l95.30"></a><span id="l95.30">   suspend: NYI,</span>
<a href="#l95.31"></a><span id="l95.31">   resume: NYI,</span>
<a href="#l95.32"></a><span id="l95.32"> };</span>
<a href="#l95.33"></a><span id="l95.33"> </span>
<a href="#l95.34"></a><span id="l95.34"> function ItipProtocolHandler() {</span>
<a href="#l95.35"></a><span id="l95.35">   this.wrappedJSObject = this;</span>
<a href="#l95.36"></a><span id="l95.36"> }</span>
<a href="#l95.37"></a><span id="l95.37"> ItipProtocolHandler.prototype = {</span>
<a href="#l95.38"></a><span id="l95.38">   QueryInterface: ChromeUtils.generateQI([Ci.nsIProtocolHandler]),</span>
<a href="#l95.39"></a><span id="l95.39">   classID: Components.ID(&quot;{6e957006-b4ce-11d9-b053-001124736B74}&quot;),</span>
<a href="#l95.40"></a><span id="l95.40"> </span>
<a href="#l95.41"></a><span id="l95.41">   protocolFlags: Ci.nsIProtocolHandler.URI_NORELATIVE | Ci.nsIProtocolHandler.URI_DANGEROUS_TO_LOAD,</span>
<a href="#l95.42"></a><span id="l95.42">   allowPort: () =&gt; false,</span>
<a href="#l95.43"></a><span id="l95.43">   isSecure: false,</span>
<a href="#l95.44"></a><span id="l95.44" class="difflineminus">-  newChannel: function(URI, aLoadInfo) {</span>
<a href="#l95.45"></a><span id="l95.45" class="difflineplus">+  newChannel(URI, aLoadInfo) {</span>
<a href="#l95.46"></a><span id="l95.46">     dump(&quot;Creating new ItipChannel for &quot; + URI + &quot;\n&quot;);</span>
<a href="#l95.47"></a><span id="l95.47">     return new ItipChannel(URI, aLoadInfo);</span>
<a href="#l95.48"></a><span id="l95.48">   },</span>
<a href="#l95.49"></a><span id="l95.49"> };</span>
<a href="#l95.50"></a><span id="l95.50"> </span>
<a href="#l95.51"></a><span id="l95.51"> function ItipContentHandler() {</span>
<a href="#l95.52"></a><span id="l95.52">   this.wrappedJSObject = this;</span>
<a href="#l95.53"></a><span id="l95.53"> }</span>
<a href="#l95.54"></a><span id="l95.54"> ItipContentHandler.prototype = {</span>
<a href="#l95.55"></a><span id="l95.55">   QueryInterface: ChromeUtils.generateQI([Ci.nsIContentHandler]),</span>
<a href="#l95.56"></a><span id="l95.56">   classID: Components.ID(&quot;{47c31f2b-b4de-11d9-bfe6-001124736B74}&quot;),</span>
<a href="#l95.57"></a><span id="l95.57"> </span>
<a href="#l95.58"></a><span id="l95.58" class="difflineminus">-  handleContent: function(contentType, windowTarget, request) {</span>
<a href="#l95.59"></a><span id="l95.59" class="difflineplus">+  handleContent(contentType, windowTarget, request) {</span>
<a href="#l95.60"></a><span id="l95.60">     let channel = request.QueryInterface(Ci.nsIChannel);</span>
<a href="#l95.61"></a><span id="l95.61">     let uri = channel.URI.spec;</span>
<a href="#l95.62"></a><span id="l95.62">     if (!uri.startsWith(ITIP_HANDLER_PROTOCOL + &quot;:&quot;)) {</span>
<a href="#l95.63"></a><span id="l95.63">       cal.ERROR(&quot;Unexpected iTIP uri: &quot; + uri + &quot;\n&quot;);</span>
<a href="#l95.64"></a><span id="l95.64">       throw NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l95.65"></a><span id="l95.65">     }</span>
<a href="#l95.66"></a><span id="l95.66">     // moz-cal-handle-itip:///?</span>
<a href="#l95.67"></a><span id="l95.67">     let paramString = uri.substring(ITIP_HANDLER_PROTOCOL.length + 4);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/calendar/lightning/components/lightningTextCalendarConverter.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -12,17 +12,17 @@ function ltnMimeConverter() {</span>
<a href="#l96.4"></a><span id="l96.4"> }</span>
<a href="#l96.5"></a><span id="l96.5"> </span>
<a href="#l96.6"></a><span id="l96.6"> ltnMimeConverter.prototype = {</span>
<a href="#l96.7"></a><span id="l96.7">   QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleMimeConverter]),</span>
<a href="#l96.8"></a><span id="l96.8">   classID: Components.ID(&quot;{c70acb08-464e-4e55-899d-b2c84c5409fa}&quot;),</span>
<a href="#l96.9"></a><span id="l96.9"> </span>
<a href="#l96.10"></a><span id="l96.10">   uri: null,</span>
<a href="#l96.11"></a><span id="l96.11"> </span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-  convertToHTML: function(contentType, data) {</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+  convertToHTML(contentType, data) {</span>
<a href="#l96.14"></a><span id="l96.14">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l96.15"></a><span id="l96.15">     parser.parseString(data);</span>
<a href="#l96.16"></a><span id="l96.16">     let event = null;</span>
<a href="#l96.17"></a><span id="l96.17">     for (let item of parser.getItems()) {</span>
<a href="#l96.18"></a><span id="l96.18">       if (cal.item.isEvent(item)) {</span>
<a href="#l96.19"></a><span id="l96.19">         if (item.hasProperty(&quot;X-MOZ-FAKED-MASTER&quot;)) {</span>
<a href="#l96.20"></a><span id="l96.20">           // if it's a faked master, take any overridden item to get a real occurrence:</span>
<a href="#l96.21"></a><span id="l96.21">           let exc = item.recurrenceInfo.getExceptionFor(item.startDate);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/calendar/lightning/content/html-item-editing/react-code.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/calendar/lightning/content/html-item-editing/react-code.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -7,22 +7,22 @@</span>
<a href="#l97.4"></a><span id="l97.4"> /* exported gTopComponent, DatePicker, ReactDOM, TopComponent */</span>
<a href="#l97.5"></a><span id="l97.5"> </span>
<a href="#l97.6"></a><span id="l97.6"> /* import-globals-from ../lightning-item-iframe.js */</span>
<a href="#l97.7"></a><span id="l97.7"> /* globals React, ReactDOM */</span>
<a href="#l97.8"></a><span id="l97.8"> </span>
<a href="#l97.9"></a><span id="l97.9"> var gTopComponent = null;</span>
<a href="#l97.10"></a><span id="l97.10"> </span>
<a href="#l97.11"></a><span id="l97.11"> var Tabstrip = React.createClass({</span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-  handleChange: function(index) {</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineplus">+  handleChange(index) {</span>
<a href="#l97.14"></a><span id="l97.14">     // The click handler will update the state with</span>
<a href="#l97.15"></a><span id="l97.15">     // the index of the focused menu entry</span>
<a href="#l97.16"></a><span id="l97.16">     this.props.onInput(this.props.keyprop, index);</span>
<a href="#l97.17"></a><span id="l97.17">   },</span>
<a href="#l97.18"></a><span id="l97.18" class="difflineminus">-  render: function() {</span>
<a href="#l97.19"></a><span id="l97.19" class="difflineplus">+  render() {</span>
<a href="#l97.20"></a><span id="l97.20">     return React.DOM.ul(</span>
<a href="#l97.21"></a><span id="l97.21">       { id: &quot;tabstrip&quot; },</span>
<a href="#l97.22"></a><span id="l97.22">       this.props.tabs.map((tab, index) =&gt; {</span>
<a href="#l97.23"></a><span id="l97.23">         let style = this.props.activeTab == index ? &quot;activeTab&quot; : &quot;&quot;;</span>
<a href="#l97.24"></a><span id="l97.24">         // The bind() method makes the index</span>
<a href="#l97.25"></a><span id="l97.25">         // available to the handleChange function:</span>
<a href="#l97.26"></a><span id="l97.26">         return React.DOM.li(</span>
<a href="#l97.27"></a><span id="l97.27">           {</span>
<a href="#l97.28"></a><span id="l97.28" class="difflineat">@@ -33,64 +33,64 @@ var Tabstrip = React.createClass({</span>
<a href="#l97.29"></a><span id="l97.29">           tab</span>
<a href="#l97.30"></a><span id="l97.30">         );</span>
<a href="#l97.31"></a><span id="l97.31">       })</span>
<a href="#l97.32"></a><span id="l97.32">     );</span>
<a href="#l97.33"></a><span id="l97.33">   },</span>
<a href="#l97.34"></a><span id="l97.34"> });</span>
<a href="#l97.35"></a><span id="l97.35"> </span>
<a href="#l97.36"></a><span id="l97.36"> var TextField = React.createClass({</span>
<a href="#l97.37"></a><span id="l97.37" class="difflineminus">-  handleChange: function(event) {</span>
<a href="#l97.38"></a><span id="l97.38" class="difflineplus">+  handleChange(event) {</span>
<a href="#l97.39"></a><span id="l97.39">     this.props.onInput(this.props.keyprop, event.target.value);</span>
<a href="#l97.40"></a><span id="l97.40">   },</span>
<a href="#l97.41"></a><span id="l97.41" class="difflineminus">-  render: function() {</span>
<a href="#l97.42"></a><span id="l97.42" class="difflineplus">+  render() {</span>
<a href="#l97.43"></a><span id="l97.43">     return React.DOM.input({</span>
<a href="#l97.44"></a><span id="l97.44">       type: &quot;text&quot;,</span>
<a href="#l97.45"></a><span id="l97.45">       // placeholder: &quot;New Event&quot;</span>
<a href="#l97.46"></a><span id="l97.46">       value: this.props.value,</span>
<a href="#l97.47"></a><span id="l97.47">       onChange: this.handleChange,</span>
<a href="#l97.48"></a><span id="l97.48">     });</span>
<a href="#l97.49"></a><span id="l97.49">   },</span>
<a href="#l97.50"></a><span id="l97.50"> });</span>
<a href="#l97.51"></a><span id="l97.51"> </span>
<a href="#l97.52"></a><span id="l97.52"> var TextArea = React.createClass({</span>
<a href="#l97.53"></a><span id="l97.53" class="difflineminus">-  handleChange: function(event) {</span>
<a href="#l97.54"></a><span id="l97.54" class="difflineplus">+  handleChange(event) {</span>
<a href="#l97.55"></a><span id="l97.55">     this.props.onInput(this.props.keyprop, event.target.value);</span>
<a href="#l97.56"></a><span id="l97.56">   },</span>
<a href="#l97.57"></a><span id="l97.57" class="difflineminus">-  render: function() {</span>
<a href="#l97.58"></a><span id="l97.58" class="difflineplus">+  render() {</span>
<a href="#l97.59"></a><span id="l97.59">     return React.DOM.textarea({</span>
<a href="#l97.60"></a><span id="l97.60">       type: &quot;text&quot;,</span>
<a href="#l97.61"></a><span id="l97.61">       // placeholder: &quot;New Event&quot;</span>
<a href="#l97.62"></a><span id="l97.62">       value: this.props.value,</span>
<a href="#l97.63"></a><span id="l97.63">       onChange: this.handleChange,</span>
<a href="#l97.64"></a><span id="l97.64">       placeholder: &quot;Description&quot;,</span>
<a href="#l97.65"></a><span id="l97.65">       rows: 10,</span>
<a href="#l97.66"></a><span id="l97.66">       id: &quot;descriptionTextArea&quot;,</span>
<a href="#l97.67"></a><span id="l97.67">     });</span>
<a href="#l97.68"></a><span id="l97.68">   },</span>
<a href="#l97.69"></a><span id="l97.69"> });</span>
<a href="#l97.70"></a><span id="l97.70"> </span>
<a href="#l97.71"></a><span id="l97.71"> var Checkbox = React.createClass({</span>
<a href="#l97.72"></a><span id="l97.72" class="difflineminus">-  handleChange: function(event) {</span>
<a href="#l97.73"></a><span id="l97.73" class="difflineplus">+  handleChange(event) {</span>
<a href="#l97.74"></a><span id="l97.74">     this.props.onInput(this.props.keyprop, event.target.checked);</span>
<a href="#l97.75"></a><span id="l97.75">   },</span>
<a href="#l97.76"></a><span id="l97.76" class="difflineminus">-  render: function() {</span>
<a href="#l97.77"></a><span id="l97.77" class="difflineplus">+  render() {</span>
<a href="#l97.78"></a><span id="l97.78">     return React.DOM.input({</span>
<a href="#l97.79"></a><span id="l97.79">       type: &quot;checkbox&quot;,</span>
<a href="#l97.80"></a><span id="l97.80">       checked: this.props.checked,</span>
<a href="#l97.81"></a><span id="l97.81">       onChange: this.handleChange,</span>
<a href="#l97.82"></a><span id="l97.82">     });</span>
<a href="#l97.83"></a><span id="l97.83">   },</span>
<a href="#l97.84"></a><span id="l97.84"> });</span>
<a href="#l97.85"></a><span id="l97.85"> </span>
<a href="#l97.86"></a><span id="l97.86"> var Dropdown = React.createClass({</span>
<a href="#l97.87"></a><span id="l97.87" class="difflineminus">-  handleChange: function(event) {</span>
<a href="#l97.88"></a><span id="l97.88" class="difflineplus">+  handleChange(event) {</span>
<a href="#l97.89"></a><span id="l97.89">     this.props.onInput(this.props.keyprop, event.target.value);</span>
<a href="#l97.90"></a><span id="l97.90">   },</span>
<a href="#l97.91"></a><span id="l97.91" class="difflineminus">-  render: function() {</span>
<a href="#l97.92"></a><span id="l97.92" class="difflineplus">+  render() {</span>
<a href="#l97.93"></a><span id="l97.93">     return React.DOM.select(</span>
<a href="#l97.94"></a><span id="l97.94">       {</span>
<a href="#l97.95"></a><span id="l97.95">         value: this.props.value,</span>
<a href="#l97.96"></a><span id="l97.96">         onChange: this.handleChange,</span>
<a href="#l97.97"></a><span id="l97.97">       },</span>
<a href="#l97.98"></a><span id="l97.98">       this.props.options.map((option, index) =&gt; {</span>
<a href="#l97.99"></a><span id="l97.99">         return React.DOM.option(</span>
<a href="#l97.100"></a><span id="l97.100">           {</span>
<a href="#l97.101"></a><span id="l97.101" class="difflineat">@@ -103,41 +103,41 @@ var Dropdown = React.createClass({</span>
<a href="#l97.102"></a><span id="l97.102">           option[1]</span>
<a href="#l97.103"></a><span id="l97.103">         );</span>
<a href="#l97.104"></a><span id="l97.104">       })</span>
<a href="#l97.105"></a><span id="l97.105">     );</span>
<a href="#l97.106"></a><span id="l97.106">   },</span>
<a href="#l97.107"></a><span id="l97.107"> });</span>
<a href="#l97.108"></a><span id="l97.108"> </span>
<a href="#l97.109"></a><span id="l97.109"> var Link = React.createClass({</span>
<a href="#l97.110"></a><span id="l97.110" class="difflineminus">-  handleClick: function() {</span>
<a href="#l97.111"></a><span id="l97.111" class="difflineplus">+  handleClick() {</span>
<a href="#l97.112"></a><span id="l97.112">     this.props.onInput(this.props.value);</span>
<a href="#l97.113"></a><span id="l97.113">   },</span>
<a href="#l97.114"></a><span id="l97.114" class="difflineminus">-  render: function() {</span>
<a href="#l97.115"></a><span id="l97.115" class="difflineplus">+  render() {</span>
<a href="#l97.116"></a><span id="l97.116">     return React.DOM.a(</span>
<a href="#l97.117"></a><span id="l97.117">       {</span>
<a href="#l97.118"></a><span id="l97.118">         // href: &quot;&quot;,</span>
<a href="#l97.119"></a><span id="l97.119">         onClick: this.handleClick,</span>
<a href="#l97.120"></a><span id="l97.120">       },</span>
<a href="#l97.121"></a><span id="l97.121">       this.props.value</span>
<a href="#l97.122"></a><span id="l97.122">     );</span>
<a href="#l97.123"></a><span id="l97.123">   },</span>
<a href="#l97.124"></a><span id="l97.124"> });</span>
<a href="#l97.125"></a><span id="l97.125"> </span>
<a href="#l97.126"></a><span id="l97.126"> var DatePicker = React.createClass({</span>
<a href="#l97.127"></a><span id="l97.127" class="difflineminus">-  render: function() {</span>
<a href="#l97.128"></a><span id="l97.128" class="difflineplus">+  render() {</span>
<a href="#l97.129"></a><span id="l97.129">     return React.DOM.input({ type: &quot;date&quot; });</span>
<a href="#l97.130"></a><span id="l97.130">   },</span>
<a href="#l97.131"></a><span id="l97.131"> });</span>
<a href="#l97.132"></a><span id="l97.132"> </span>
<a href="#l97.133"></a><span id="l97.133"> var Capsule = React.createClass({</span>
<a href="#l97.134"></a><span id="l97.134" class="difflineminus">-  handleDelete: function() {</span>
<a href="#l97.135"></a><span id="l97.135" class="difflineplus">+  handleDelete() {</span>
<a href="#l97.136"></a><span id="l97.136">     this.props.onDelete(this.props.keyprop, this.props.value);</span>
<a href="#l97.137"></a><span id="l97.137">   },</span>
<a href="#l97.138"></a><span id="l97.138" class="difflineminus">-  render: function() {</span>
<a href="#l97.139"></a><span id="l97.139" class="difflineplus">+  render() {</span>
<a href="#l97.140"></a><span id="l97.140">     return React.DOM.span(</span>
<a href="#l97.141"></a><span id="l97.141">       {</span>
<a href="#l97.142"></a><span id="l97.142">         className: &quot;capsule&quot;,</span>
<a href="#l97.143"></a><span id="l97.143">         style: { background: &quot;ButtonHighlight&quot; },</span>
<a href="#l97.144"></a><span id="l97.144">       },</span>
<a href="#l97.145"></a><span id="l97.145">       this.props.value,</span>
<a href="#l97.146"></a><span id="l97.146">       React.DOM.span(</span>
<a href="#l97.147"></a><span id="l97.147">         {</span>
<a href="#l97.148"></a><span id="l97.148" class="difflineat">@@ -146,17 +146,17 @@ var Capsule = React.createClass({</span>
<a href="#l97.149"></a><span id="l97.149">         },</span>
<a href="#l97.150"></a><span id="l97.150">         &quot;x&quot;</span>
<a href="#l97.151"></a><span id="l97.151">       )</span>
<a href="#l97.152"></a><span id="l97.152">     );</span>
<a href="#l97.153"></a><span id="l97.153">   },</span>
<a href="#l97.154"></a><span id="l97.154"> });</span>
<a href="#l97.155"></a><span id="l97.155"> </span>
<a href="#l97.156"></a><span id="l97.156"> var TopComponent = React.createClass({</span>
<a href="#l97.157"></a><span id="l97.157" class="difflineminus">-  getDefaultProps: function() {</span>
<a href="#l97.158"></a><span id="l97.158" class="difflineplus">+  getDefaultProps() {</span>
<a href="#l97.159"></a><span id="l97.159">     return {</span>
<a href="#l97.160"></a><span id="l97.160">       // these &quot;initial&quot; props are passed in as props but</span>
<a href="#l97.161"></a><span id="l97.161">       // immediately become state (state can change, props do not)</span>
<a href="#l97.162"></a><span id="l97.162">       initialTitle: &quot;New Event&quot;,</span>
<a href="#l97.163"></a><span id="l97.163">       initialLocation: &quot;&quot;,</span>
<a href="#l97.164"></a><span id="l97.164">       initialAllDay: false,</span>
<a href="#l97.165"></a><span id="l97.165">       initialRepeat: &quot;none&quot;,</span>
<a href="#l97.166"></a><span id="l97.166">       initialRepeatUntilDate: &quot;forever&quot;,</span>
<a href="#l97.167"></a><span id="l97.167" class="difflineat">@@ -217,17 +217,17 @@ var TopComponent = React.createClass({</span>
<a href="#l97.168"></a><span id="l97.168">         [8, &quot;1 Day Before&quot;],</span>
<a href="#l97.169"></a><span id="l97.169">         [9, &quot;2 Days Before&quot;],</span>
<a href="#l97.170"></a><span id="l97.170">         [10, &quot;1 Week Before&quot;],</span>
<a href="#l97.171"></a><span id="l97.171">         [11, &quot;Custom...&quot;],</span>
<a href="#l97.172"></a><span id="l97.172">       ],</span>
<a href="#l97.173"></a><span id="l97.173">       supportsPriority: false,</span>
<a href="#l97.174"></a><span id="l97.174">     };</span>
<a href="#l97.175"></a><span id="l97.175">   },</span>
<a href="#l97.176"></a><span id="l97.176" class="difflineminus">-  getInitialState: function() {</span>
<a href="#l97.177"></a><span id="l97.177" class="difflineplus">+  getInitialState() {</span>
<a href="#l97.178"></a><span id="l97.178">     // all the passed-in props that begin with 'initial' become state</span>
<a href="#l97.179"></a><span id="l97.179">     return {</span>
<a href="#l97.180"></a><span id="l97.180">       title: this.props.initialTitle,</span>
<a href="#l97.181"></a><span id="l97.181">       location: this.props.initialLocation,</span>
<a href="#l97.182"></a><span id="l97.182">       startTimezone: this.props.initialStartTimezone,</span>
<a href="#l97.183"></a><span id="l97.183">       endTimezone: this.props.initialEndTimezone,</span>
<a href="#l97.184"></a><span id="l97.184">       startDate: this.props.initialStartDate,</span>
<a href="#l97.185"></a><span id="l97.185">       startTime: this.props.initialStartTime,</span>
<a href="#l97.186"></a><span id="l97.186" class="difflineat">@@ -248,61 +248,61 @@ var TopComponent = React.createClass({</span>
<a href="#l97.187"></a><span id="l97.187">       categories: this.props.initialCategories,</span>
<a href="#l97.188"></a><span id="l97.188">       categoriesList: this.props.initialCategoriesList,</span>
<a href="#l97.189"></a><span id="l97.189">       attachments: this.props.initialAttachments,</span>
<a href="#l97.190"></a><span id="l97.190"> </span>
<a href="#l97.191"></a><span id="l97.191">       isWideview: window.innerWidth &gt; 750,</span>
<a href="#l97.192"></a><span id="l97.192">       activeTab: 0,</span>
<a href="#l97.193"></a><span id="l97.193">     };</span>
<a href="#l97.194"></a><span id="l97.194">   },</span>
<a href="#l97.195"></a><span id="l97.195" class="difflineminus">-  updateWideview: function() {</span>
<a href="#l97.196"></a><span id="l97.196" class="difflineplus">+  updateWideview() {</span>
<a href="#l97.197"></a><span id="l97.197">     let wideview = window.innerWidth &gt; 750;</span>
<a href="#l97.198"></a><span id="l97.198">     if (wideview != this.state.isWideview) {</span>
<a href="#l97.199"></a><span id="l97.199">       this.setState({ isWideview: wideview });</span>
<a href="#l97.200"></a><span id="l97.200">     }</span>
<a href="#l97.201"></a><span id="l97.201">   },</span>
<a href="#l97.202"></a><span id="l97.202" class="difflineminus">-  componentWillMount: function() {</span>
<a href="#l97.203"></a><span id="l97.203" class="difflineplus">+  componentWillMount() {</span>
<a href="#l97.204"></a><span id="l97.204">     this.updateWideview();</span>
<a href="#l97.205"></a><span id="l97.205">   },</span>
<a href="#l97.206"></a><span id="l97.206" class="difflineminus">-  componentDidMount: function() {</span>
<a href="#l97.207"></a><span id="l97.207" class="difflineplus">+  componentDidMount() {</span>
<a href="#l97.208"></a><span id="l97.208">     window.addEventListener(&quot;resize&quot;, this.updateWideview);</span>
<a href="#l97.209"></a><span id="l97.209">   },</span>
<a href="#l97.210"></a><span id="l97.210" class="difflineminus">-  componentWillUnmount: function() {</span>
<a href="#l97.211"></a><span id="l97.211" class="difflineplus">+  componentWillUnmount() {</span>
<a href="#l97.212"></a><span id="l97.212">     window.removeEventListener(&quot;resize&quot;, this.updateWideview);</span>
<a href="#l97.213"></a><span id="l97.213">   },</span>
<a href="#l97.214"></a><span id="l97.214" class="difflineminus">-  exportState: function() {</span>
<a href="#l97.215"></a><span id="l97.215" class="difflineplus">+  exportState() {</span>
<a href="#l97.216"></a><span id="l97.216">     // Use this to access this component's state from above/outside</span>
<a href="#l97.217"></a><span id="l97.217">     // the react component hierarchy, for example, when saving changes.</span>
<a href="#l97.218"></a><span id="l97.218">     return this.state;</span>
<a href="#l97.219"></a><span id="l97.219">   },</span>
<a href="#l97.220"></a><span id="l97.220" class="difflineminus">-  importState: function(aStateObj) {</span>
<a href="#l97.221"></a><span id="l97.221" class="difflineplus">+  importState(aStateObj) {</span>
<a href="#l97.222"></a><span id="l97.222">     // Use this to impose state changes from above/outside of the</span>
<a href="#l97.223"></a><span id="l97.223">     // react component hierarchy.</span>
<a href="#l97.224"></a><span id="l97.224">     this.setState(aStateObj);</span>
<a href="#l97.225"></a><span id="l97.225">   },</span>
<a href="#l97.226"></a><span id="l97.226" class="difflineminus">-  handleSimpleChange: function(aKey, aValue) {</span>
<a href="#l97.227"></a><span id="l97.227" class="difflineplus">+  handleSimpleChange(aKey, aValue) {</span>
<a href="#l97.228"></a><span id="l97.228">     let obj = {};</span>
<a href="#l97.229"></a><span id="l97.229">     obj[aKey] = aValue;</span>
<a href="#l97.230"></a><span id="l97.230">     this.setState(obj);</span>
<a href="#l97.231"></a><span id="l97.231">   },</span>
<a href="#l97.232"></a><span id="l97.232" class="difflineminus">-  handleShowTimeAsChange: function(aKey, aValue) {</span>
<a href="#l97.233"></a><span id="l97.233" class="difflineplus">+  handleShowTimeAsChange(aKey, aValue) {</span>
<a href="#l97.234"></a><span id="l97.234">     // convert from true/false to OPAQUE/TRANSPARENT</span>
<a href="#l97.235"></a><span id="l97.235">     let list = this.props.showTimeAsList;</span>
<a href="#l97.236"></a><span id="l97.236">     let index = list.findIndex(i =&gt; i[1] == aValue);</span>
<a href="#l97.237"></a><span id="l97.237">     let newValue = list[index][0];</span>
<a href="#l97.238"></a><span id="l97.238">     this.handleSimpleChange(aKey, newValue);</span>
<a href="#l97.239"></a><span id="l97.239">   },</span>
<a href="#l97.240"></a><span id="l97.240" class="difflineminus">-  linkClicked: function(aValue) {},</span>
<a href="#l97.241"></a><span id="l97.241" class="difflineminus">-  onDeleteCapsule: function(aKey, aValue) {</span>
<a href="#l97.242"></a><span id="l97.242" class="difflineplus">+  linkClicked(aValue) {},</span>
<a href="#l97.243"></a><span id="l97.243" class="difflineplus">+  onDeleteCapsule(aKey, aValue) {</span>
<a href="#l97.244"></a><span id="l97.244">     let a = this.state[aKey];</span>
<a href="#l97.245"></a><span id="l97.245">     let index = a.indexOf(aValue);</span>
<a href="#l97.246"></a><span id="l97.246">     a.splice(index, 1);</span>
<a href="#l97.247"></a><span id="l97.247">     this.setState({ aKey: a });</span>
<a href="#l97.248"></a><span id="l97.248">   },</span>
<a href="#l97.249"></a><span id="l97.249" class="difflineminus">-  render: function() {</span>
<a href="#l97.250"></a><span id="l97.250" class="difflineplus">+  render() {</span>
<a href="#l97.251"></a><span id="l97.251">     // 'key' doesn't seem to work as a prop name (presumably because</span>
<a href="#l97.252"></a><span id="l97.252">     // already used by react?), so using 'keyprop' instead for now.</span>
<a href="#l97.253"></a><span id="l97.253">     let titleDiv = React.DOM.div(</span>
<a href="#l97.254"></a><span id="l97.254">       { id: &quot;titleDiv&quot;, className: &quot;box&quot; },</span>
<a href="#l97.255"></a><span id="l97.255">       &quot;Title &quot;,</span>
<a href="#l97.256"></a><span id="l97.256">       React.createElement(TextField, {</span>
<a href="#l97.257"></a><span id="l97.257">         keyprop: &quot;title&quot;,</span>
<a href="#l97.258"></a><span id="l97.258">         value: this.state.title,</span>
<a href="#l97.259"></a><span id="l97.259" class="difflineat">@@ -520,67 +520,66 @@ var TopComponent = React.createClass({</span>
<a href="#l97.260"></a><span id="l97.260">         React.DOM.div(</span>
<a href="#l97.261"></a><span id="l97.261">           { className: &quot;wrapper&quot;, id: &quot;wrapper2&quot; },</span>
<a href="#l97.262"></a><span id="l97.262">           privacyDiv,</span>
<a href="#l97.263"></a><span id="l97.263">           statusDiv,</span>
<a href="#l97.264"></a><span id="l97.264">           priorityDiv,</span>
<a href="#l97.265"></a><span id="l97.265">           showTimeAsDiv</span>
<a href="#l97.266"></a><span id="l97.266">         )</span>
<a href="#l97.267"></a><span id="l97.267">       );</span>
<a href="#l97.268"></a><span id="l97.268" class="difflineminus">-    } else {</span>
<a href="#l97.269"></a><span id="l97.269" class="difflineminus">-      // narrowview</span>
<a href="#l97.270"></a><span id="l97.270" class="difflineminus">-      let tabpanelChildren = [</span>
<a href="#l97.271"></a><span id="l97.271" class="difflineminus">-        descriptionDiv,</span>
<a href="#l97.272"></a><span id="l97.272" class="difflineminus">-        React.DOM.div(</span>
<a href="#l97.273"></a><span id="l97.273" class="difflineminus">-          {</span>
<a href="#l97.274"></a><span id="l97.274" class="difflineminus">-            className: &quot;wrapper&quot;,</span>
<a href="#l97.275"></a><span id="l97.275" class="difflineminus">-            style: { flexDirection: &quot;column&quot; },</span>
<a href="#l97.276"></a><span id="l97.276" class="difflineminus">-          },</span>
<a href="#l97.277"></a><span id="l97.277" class="difflineminus">-          statusDiv,</span>
<a href="#l97.278"></a><span id="l97.278" class="difflineminus">-          priorityDiv,</span>
<a href="#l97.279"></a><span id="l97.279" class="difflineminus">-          showTimeAsDiv</span>
<a href="#l97.280"></a><span id="l97.280" class="difflineminus">-        ),</span>
<a href="#l97.281"></a><span id="l97.281" class="difflineminus">-        remindersDiv,</span>
<a href="#l97.282"></a><span id="l97.282" class="difflineminus">-        attachmentsDiv,</span>
<a href="#l97.283"></a><span id="l97.283" class="difflineminus">-        attendeesDiv,</span>
<a href="#l97.284"></a><span id="l97.284" class="difflineminus">-      ];</span>
<a href="#l97.285"></a><span id="l97.285" class="difflineminus">-      let tabpanels = this.props.tabs.map((elem, index) =&gt; {</span>
<a href="#l97.286"></a><span id="l97.286" class="difflineminus">-        return React.DOM.div(</span>
<a href="#l97.287"></a><span id="l97.287" class="difflineminus">-          {</span>
<a href="#l97.288"></a><span id="l97.288" class="difflineminus">-            className: &quot;box tabpanel &quot; + (this.state.activeTab == index ? &quot;&quot; : &quot;hidden&quot;),</span>
<a href="#l97.289"></a><span id="l97.289" class="difflineminus">-            key: &quot;tabpanelkey &quot; + index,</span>
<a href="#l97.290"></a><span id="l97.290" class="difflineminus">-          },</span>
<a href="#l97.291"></a><span id="l97.291" class="difflineminus">-          tabpanelChildren[index]</span>
<a href="#l97.292"></a><span id="l97.292" class="difflineminus">-        );</span>
<a href="#l97.293"></a><span id="l97.293" class="difflineminus">-      });</span>
<a href="#l97.294"></a><span id="l97.294" class="difflineplus">+    }</span>
<a href="#l97.295"></a><span id="l97.295" class="difflineplus">+    // narrowview</span>
<a href="#l97.296"></a><span id="l97.296" class="difflineplus">+    let tabpanelChildren = [</span>
<a href="#l97.297"></a><span id="l97.297" class="difflineplus">+      descriptionDiv,</span>
<a href="#l97.298"></a><span id="l97.298" class="difflineplus">+      React.DOM.div(</span>
<a href="#l97.299"></a><span id="l97.299" class="difflineplus">+        {</span>
<a href="#l97.300"></a><span id="l97.300" class="difflineplus">+          className: &quot;wrapper&quot;,</span>
<a href="#l97.301"></a><span id="l97.301" class="difflineplus">+          style: { flexDirection: &quot;column&quot; },</span>
<a href="#l97.302"></a><span id="l97.302" class="difflineplus">+        },</span>
<a href="#l97.303"></a><span id="l97.303" class="difflineplus">+        statusDiv,</span>
<a href="#l97.304"></a><span id="l97.304" class="difflineplus">+        priorityDiv,</span>
<a href="#l97.305"></a><span id="l97.305" class="difflineplus">+        showTimeAsDiv</span>
<a href="#l97.306"></a><span id="l97.306" class="difflineplus">+      ),</span>
<a href="#l97.307"></a><span id="l97.307" class="difflineplus">+      remindersDiv,</span>
<a href="#l97.308"></a><span id="l97.308" class="difflineplus">+      attachmentsDiv,</span>
<a href="#l97.309"></a><span id="l97.309" class="difflineplus">+      attendeesDiv,</span>
<a href="#l97.310"></a><span id="l97.310" class="difflineplus">+    ];</span>
<a href="#l97.311"></a><span id="l97.311" class="difflineplus">+    let tabpanels = this.props.tabs.map((elem, index) =&gt; {</span>
<a href="#l97.312"></a><span id="l97.312">       return React.DOM.div(</span>
<a href="#l97.313"></a><span id="l97.313" class="difflineminus">-        { id: &quot;topwrapper&quot; },</span>
<a href="#l97.314"></a><span id="l97.314" class="difflineplus">+        {</span>
<a href="#l97.315"></a><span id="l97.315" class="difflineplus">+          className: &quot;box tabpanel &quot; + (this.state.activeTab == index ? &quot;&quot; : &quot;hidden&quot;),</span>
<a href="#l97.316"></a><span id="l97.316" class="difflineplus">+          key: &quot;tabpanelkey &quot; + index,</span>
<a href="#l97.317"></a><span id="l97.317" class="difflineplus">+        },</span>
<a href="#l97.318"></a><span id="l97.318" class="difflineplus">+        tabpanelChildren[index]</span>
<a href="#l97.319"></a><span id="l97.319" class="difflineplus">+      );</span>
<a href="#l97.320"></a><span id="l97.320" class="difflineplus">+    });</span>
<a href="#l97.321"></a><span id="l97.321" class="difflineplus">+    return React.DOM.div(</span>
<a href="#l97.322"></a><span id="l97.322" class="difflineplus">+      { id: &quot;topwrapper&quot; },</span>
<a href="#l97.323"></a><span id="l97.323" class="difflineplus">+      React.DOM.div(</span>
<a href="#l97.324"></a><span id="l97.324" class="difflineplus">+        { className: &quot;wrapper&quot; },</span>
<a href="#l97.325"></a><span id="l97.325" class="difflineplus">+        titleDiv,</span>
<a href="#l97.326"></a><span id="l97.326" class="difflineplus">+        locationDiv,</span>
<a href="#l97.327"></a><span id="l97.327" class="difflineplus">+        startDiv,</span>
<a href="#l97.328"></a><span id="l97.328" class="difflineplus">+        endDiv,</span>
<a href="#l97.329"></a><span id="l97.329" class="difflineplus">+        allDayDiv,</span>
<a href="#l97.330"></a><span id="l97.330" class="difflineplus">+        repeatDiv,</span>
<a href="#l97.331"></a><span id="l97.331">         React.DOM.div(</span>
<a href="#l97.332"></a><span id="l97.332" class="difflineminus">-          { className: &quot;wrapper&quot; },</span>
<a href="#l97.333"></a><span id="l97.333" class="difflineminus">-          titleDiv,</span>
<a href="#l97.334"></a><span id="l97.334" class="difflineminus">-          locationDiv,</span>
<a href="#l97.335"></a><span id="l97.335" class="difflineminus">-          startDiv,</span>
<a href="#l97.336"></a><span id="l97.336" class="difflineminus">-          endDiv,</span>
<a href="#l97.337"></a><span id="l97.337" class="difflineminus">-          allDayDiv,</span>
<a href="#l97.338"></a><span id="l97.338" class="difflineminus">-          repeatDiv,</span>
<a href="#l97.339"></a><span id="l97.339" class="difflineminus">-          React.DOM.div(</span>
<a href="#l97.340"></a><span id="l97.340" class="difflineminus">-            { style: { flexDirection: &quot;row&quot;, display: &quot;flex&quot; } },</span>
<a href="#l97.341"></a><span id="l97.341" class="difflineminus">-            calendarDiv,</span>
<a href="#l97.342"></a><span id="l97.342" class="difflineminus">-            privacyDiv</span>
<a href="#l97.343"></a><span id="l97.343" class="difflineminus">-          ),</span>
<a href="#l97.344"></a><span id="l97.344" class="difflineminus">-          categoriesDiv,</span>
<a href="#l97.345"></a><span id="l97.345" class="difflineminus">-          React.createElement(Tabstrip, {</span>
<a href="#l97.346"></a><span id="l97.346" class="difflineminus">-            tabs: this.props.tabs,</span>
<a href="#l97.347"></a><span id="l97.347" class="difflineminus">-            keyprop: &quot;activeTab&quot;,</span>
<a href="#l97.348"></a><span id="l97.348" class="difflineminus">-            activeTab: this.state.activeTab,</span>
<a href="#l97.349"></a><span id="l97.349" class="difflineminus">-            onInput: this.handleSimpleChange,</span>
<a href="#l97.350"></a><span id="l97.350" class="difflineminus">-          }),</span>
<a href="#l97.351"></a><span id="l97.351" class="difflineminus">-          tabpanels,</span>
<a href="#l97.352"></a><span id="l97.352" class="difflineminus">-          urlDiv</span>
<a href="#l97.353"></a><span id="l97.353" class="difflineminus">-        )</span>
<a href="#l97.354"></a><span id="l97.354" class="difflineminus">-      );</span>
<a href="#l97.355"></a><span id="l97.355" class="difflineminus">-    }</span>
<a href="#l97.356"></a><span id="l97.356" class="difflineplus">+          { style: { flexDirection: &quot;row&quot;, display: &quot;flex&quot; } },</span>
<a href="#l97.357"></a><span id="l97.357" class="difflineplus">+          calendarDiv,</span>
<a href="#l97.358"></a><span id="l97.358" class="difflineplus">+          privacyDiv</span>
<a href="#l97.359"></a><span id="l97.359" class="difflineplus">+        ),</span>
<a href="#l97.360"></a><span id="l97.360" class="difflineplus">+        categoriesDiv,</span>
<a href="#l97.361"></a><span id="l97.361" class="difflineplus">+        React.createElement(Tabstrip, {</span>
<a href="#l97.362"></a><span id="l97.362" class="difflineplus">+          tabs: this.props.tabs,</span>
<a href="#l97.363"></a><span id="l97.363" class="difflineplus">+          keyprop: &quot;activeTab&quot;,</span>
<a href="#l97.364"></a><span id="l97.364" class="difflineplus">+          activeTab: this.state.activeTab,</span>
<a href="#l97.365"></a><span id="l97.365" class="difflineplus">+          onInput: this.handleSimpleChange,</span>
<a href="#l97.366"></a><span id="l97.366" class="difflineplus">+        }),</span>
<a href="#l97.367"></a><span id="l97.367" class="difflineplus">+        tabpanels,</span>
<a href="#l97.368"></a><span id="l97.368" class="difflineplus">+        urlDiv</span>
<a href="#l97.369"></a><span id="l97.369" class="difflineplus">+      )</span>
<a href="#l97.370"></a><span id="l97.370" class="difflineplus">+    );</span>
<a href="#l97.371"></a><span id="l97.371">   },</span>
<a href="#l97.372"></a><span id="l97.372"> });</span>
<a href="#l97.373"></a><span id="l97.373"> </span>
<a href="#l97.374"></a><span id="l97.374"> window.onload = function() {</span>
<a href="#l97.375"></a><span id="l97.375">   onLoad();</span>
<a href="#l97.376"></a><span id="l97.376"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/calendar/lightning/content/imip-bar.js</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/calendar/lightning/content/imip-bar.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -40,30 +40,30 @@ var ltnImipBar = {</span>
<a href="#l98.4"></a><span id="l98.4">   actionFunc: null,</span>
<a href="#l98.5"></a><span id="l98.5">   itipItem: null,</span>
<a href="#l98.6"></a><span id="l98.6">   foundItems: null,</span>
<a href="#l98.7"></a><span id="l98.7">   msgOverlay: null,</span>
<a href="#l98.8"></a><span id="l98.8"> </span>
<a href="#l98.9"></a><span id="l98.9">   /**</span>
<a href="#l98.10"></a><span id="l98.10">    * Thunderbird Message listener interface, hide the bar before we begin</span>
<a href="#l98.11"></a><span id="l98.11">    */</span>
<a href="#l98.12"></a><span id="l98.12" class="difflineminus">-  onStartHeaders: function() {</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+  onStartHeaders() {</span>
<a href="#l98.14"></a><span id="l98.14">     ltnImipBar.resetBar();</span>
<a href="#l98.15"></a><span id="l98.15">   },</span>
<a href="#l98.16"></a><span id="l98.16"> </span>
<a href="#l98.17"></a><span id="l98.17">   /**</span>
<a href="#l98.18"></a><span id="l98.18">    * Thunderbird Message listener interface</span>
<a href="#l98.19"></a><span id="l98.19">    */</span>
<a href="#l98.20"></a><span id="l98.20" class="difflineminus">-  onEndHeaders: function() {},</span>
<a href="#l98.21"></a><span id="l98.21" class="difflineplus">+  onEndHeaders() {},</span>
<a href="#l98.22"></a><span id="l98.22"> </span>
<a href="#l98.23"></a><span id="l98.23">   /**</span>
<a href="#l98.24"></a><span id="l98.24">    * Load Handler called to initialize the imip bar</span>
<a href="#l98.25"></a><span id="l98.25">    * NOTE: This function is called without a valid this-context!</span>
<a href="#l98.26"></a><span id="l98.26">    */</span>
<a href="#l98.27"></a><span id="l98.27" class="difflineminus">-  load: function() {</span>
<a href="#l98.28"></a><span id="l98.28" class="difflineplus">+  load() {</span>
<a href="#l98.29"></a><span id="l98.29">     // Add a listener to gMessageListeners defined in msgHdrView.js</span>
<a href="#l98.30"></a><span id="l98.30">     gMessageListeners.push(ltnImipBar);</span>
<a href="#l98.31"></a><span id="l98.31"> </span>
<a href="#l98.32"></a><span id="l98.32">     // We need to extend the HideMessageHeaderPane function to also hide the</span>
<a href="#l98.33"></a><span id="l98.33">     // message header pane. Otherwise, the imip bar will still be shown when</span>
<a href="#l98.34"></a><span id="l98.34">     // changing folders.</span>
<a href="#l98.35"></a><span id="l98.35">     ltnImipBar.tbHideMessageHeaderPane = HideMessageHeaderPane;</span>
<a href="#l98.36"></a><span id="l98.36">     HideMessageHeaderPane = function() {</span>
<a href="#l98.37"></a><span id="l98.37" class="difflineat">@@ -74,25 +74,25 @@ var ltnImipBar = {</span>
<a href="#l98.38"></a><span id="l98.38">     // Set up our observers</span>
<a href="#l98.39"></a><span id="l98.39">     Services.obs.addObserver(ltnImipBar, &quot;onItipItemCreation&quot;);</span>
<a href="#l98.40"></a><span id="l98.40">   },</span>
<a href="#l98.41"></a><span id="l98.41"> </span>
<a href="#l98.42"></a><span id="l98.42">   /**</span>
<a href="#l98.43"></a><span id="l98.43">    * Unload handler to clean up after the imip bar</span>
<a href="#l98.44"></a><span id="l98.44">    * NOTE: This function is called without a valid this-context!</span>
<a href="#l98.45"></a><span id="l98.45">    */</span>
<a href="#l98.46"></a><span id="l98.46" class="difflineminus">-  unload: function() {</span>
<a href="#l98.47"></a><span id="l98.47" class="difflineplus">+  unload() {</span>
<a href="#l98.48"></a><span id="l98.48">     removeEventListener(&quot;messagepane-loaded&quot;, ltnImipBar.load, true);</span>
<a href="#l98.49"></a><span id="l98.49">     removeEventListener(&quot;messagepane-unloaded&quot;, ltnImipBar.unload, true);</span>
<a href="#l98.50"></a><span id="l98.50"> </span>
<a href="#l98.51"></a><span id="l98.51">     ltnImipBar.resetBar();</span>
<a href="#l98.52"></a><span id="l98.52">     Services.obs.removeObserver(ltnImipBar, &quot;onItipItemCreation&quot;);</span>
<a href="#l98.53"></a><span id="l98.53">   },</span>
<a href="#l98.54"></a><span id="l98.54"> </span>
<a href="#l98.55"></a><span id="l98.55" class="difflineminus">-  observe: function(subject, topic, state) {</span>
<a href="#l98.56"></a><span id="l98.56" class="difflineplus">+  observe(subject, topic, state) {</span>
<a href="#l98.57"></a><span id="l98.57">     if (topic == &quot;onItipItemCreation&quot;) {</span>
<a href="#l98.58"></a><span id="l98.58">       let itipItem = null;</span>
<a href="#l98.59"></a><span id="l98.59">       let msgOverlay = null;</span>
<a href="#l98.60"></a><span id="l98.60">       try {</span>
<a href="#l98.61"></a><span id="l98.61">         if (!subject) {</span>
<a href="#l98.62"></a><span id="l98.62">           let sinkProps = msgWindow.msgHeaderSink.properties;</span>
<a href="#l98.63"></a><span id="l98.63">           // This property was set by lightningTextCalendarConverter.js</span>
<a href="#l98.64"></a><span id="l98.64">           itipItem = sinkProps.getPropertyAsInterface(&quot;itipItem&quot;, Ci.calIItipItem);</span>
<a href="#l98.65"></a><span id="l98.65" class="difflineat">@@ -117,70 +117,70 @@ var ltnImipBar = {</span>
<a href="#l98.66"></a><span id="l98.66"> </span>
<a href="#l98.67"></a><span id="l98.67">       cal.itip.processItipItem(itipItem, ltnImipBar.setupOptions);</span>
<a href="#l98.68"></a><span id="l98.68">     }</span>
<a href="#l98.69"></a><span id="l98.69">   },</span>
<a href="#l98.70"></a><span id="l98.70"> </span>
<a href="#l98.71"></a><span id="l98.71">   /**</span>
<a href="#l98.72"></a><span id="l98.72">    * Hide the imip bar and reset the itip item.</span>
<a href="#l98.73"></a><span id="l98.73">    */</span>
<a href="#l98.74"></a><span id="l98.74" class="difflineminus">-  resetBar: function() {</span>
<a href="#l98.75"></a><span id="l98.75" class="difflineplus">+  resetBar() {</span>
<a href="#l98.76"></a><span id="l98.76">     imipBar.collapsed = true;</span>
<a href="#l98.77"></a><span id="l98.77">     ltnImipBar.resetButtons();</span>
<a href="#l98.78"></a><span id="l98.78"> </span>
<a href="#l98.79"></a><span id="l98.79">     // Clear our iMIP/iTIP stuff so it doesn't contain stale information.</span>
<a href="#l98.80"></a><span id="l98.80">     cal.itip.cleanupItipItem(ltnImipBar.itipItem);</span>
<a href="#l98.81"></a><span id="l98.81">     ltnImipBar.itipItem = null;</span>
<a href="#l98.82"></a><span id="l98.82">   },</span>
<a href="#l98.83"></a><span id="l98.83"> </span>
<a href="#l98.84"></a><span id="l98.84">   /**</span>
<a href="#l98.85"></a><span id="l98.85">    * Resets all buttons and its menuitems, all buttons are hidden thereafter</span>
<a href="#l98.86"></a><span id="l98.86">    */</span>
<a href="#l98.87"></a><span id="l98.87" class="difflineminus">-  resetButtons: function() {</span>
<a href="#l98.88"></a><span id="l98.88" class="difflineplus">+  resetButtons() {</span>
<a href="#l98.89"></a><span id="l98.89">     let buttons = ltnImipBar.getButtons();</span>
<a href="#l98.90"></a><span id="l98.90">     for (let button of buttons) {</span>
<a href="#l98.91"></a><span id="l98.91">       button.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l98.92"></a><span id="l98.92">       for (let item of ltnImipBar.getMenuItems(button)) {</span>
<a href="#l98.93"></a><span id="l98.93">         item.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l98.94"></a><span id="l98.94">       }</span>
<a href="#l98.95"></a><span id="l98.95">     }</span>
<a href="#l98.96"></a><span id="l98.96">   },</span>
<a href="#l98.97"></a><span id="l98.97"> </span>
<a href="#l98.98"></a><span id="l98.98">   /**</span>
<a href="#l98.99"></a><span id="l98.99">    * Provides a list of all available buttons</span>
<a href="#l98.100"></a><span id="l98.100">    */</span>
<a href="#l98.101"></a><span id="l98.101" class="difflineminus">-  getButtons: function() {</span>
<a href="#l98.102"></a><span id="l98.102" class="difflineplus">+  getButtons() {</span>
<a href="#l98.103"></a><span id="l98.103">     let toolbarbuttons = document</span>
<a href="#l98.104"></a><span id="l98.104">       .getElementById(&quot;imip-view-toolbar&quot;)</span>
<a href="#l98.105"></a><span id="l98.105">       .getElementsByTagName(&quot;toolbarbutton&quot;);</span>
<a href="#l98.106"></a><span id="l98.106">     return Array.from(toolbarbuttons);</span>
<a href="#l98.107"></a><span id="l98.107">   },</span>
<a href="#l98.108"></a><span id="l98.108"> </span>
<a href="#l98.109"></a><span id="l98.109">   /**</span>
<a href="#l98.110"></a><span id="l98.110">    * Provides a list of available menuitems of a button</span>
<a href="#l98.111"></a><span id="l98.111">    *</span>
<a href="#l98.112"></a><span id="l98.112">    * @param aButton        button node</span>
<a href="#l98.113"></a><span id="l98.113">    */</span>
<a href="#l98.114"></a><span id="l98.114" class="difflineminus">-  getMenuItems: function(aButton) {</span>
<a href="#l98.115"></a><span id="l98.115" class="difflineplus">+  getMenuItems(aButton) {</span>
<a href="#l98.116"></a><span id="l98.116">     let items = [];</span>
<a href="#l98.117"></a><span id="l98.117">     let mitems = aButton.getElementsByTagName(&quot;menuitem&quot;);</span>
<a href="#l98.118"></a><span id="l98.118">     if (mitems != null &amp;&amp; mitems.length &gt; 0) {</span>
<a href="#l98.119"></a><span id="l98.119">       for (let mitem of mitems) {</span>
<a href="#l98.120"></a><span id="l98.120">         items.push(mitem);</span>
<a href="#l98.121"></a><span id="l98.121">       }</span>
<a href="#l98.122"></a><span id="l98.122">     }</span>
<a href="#l98.123"></a><span id="l98.123">     return items;</span>
<a href="#l98.124"></a><span id="l98.124">   },</span>
<a href="#l98.125"></a><span id="l98.125"> </span>
<a href="#l98.126"></a><span id="l98.126">   /**</span>
<a href="#l98.127"></a><span id="l98.127">    * Checks and converts button types based on available menuitems of the buttons</span>
<a href="#l98.128"></a><span id="l98.128">    * to avoid dropdowns which are empty or only replicating the default button action</span>
<a href="#l98.129"></a><span id="l98.129">    * Should be called once the buttons are set up</span>
<a href="#l98.130"></a><span id="l98.130">    */</span>
<a href="#l98.131"></a><span id="l98.131" class="difflineminus">-  conformButtonType: function() {</span>
<a href="#l98.132"></a><span id="l98.132" class="difflineplus">+  conformButtonType() {</span>
<a href="#l98.133"></a><span id="l98.133">     // check only needed on visible and not simple buttons</span>
<a href="#l98.134"></a><span id="l98.134">     let buttons = ltnImipBar</span>
<a href="#l98.135"></a><span id="l98.135">       .getButtons()</span>
<a href="#l98.136"></a><span id="l98.136">       .filter(aElement =&gt; aElement.hasAttribute(&quot;type&quot;) &amp;&amp; !aElement.hidden);</span>
<a href="#l98.137"></a><span id="l98.137">     // change button if appropriate</span>
<a href="#l98.138"></a><span id="l98.138">     for (let button of buttons) {</span>
<a href="#l98.139"></a><span id="l98.139">       let items = ltnImipBar.getMenuItems(button).filter(aItem =&gt; !aItem.hidden);</span>
<a href="#l98.140"></a><span id="l98.140">       if (button.type == &quot;menu&quot; &amp;&amp; items.length == 0) {</span>
<a href="#l98.141"></a><span id="l98.141" class="difflineat">@@ -206,17 +206,17 @@ var ltnImipBar = {</span>
<a href="#l98.142"></a><span id="l98.142">    * NOTE: This function is called without a valid this-context!</span>
<a href="#l98.143"></a><span id="l98.143">    *</span>
<a href="#l98.144"></a><span id="l98.144">    * @param itipItem      The iTIP item to set up for</span>
<a href="#l98.145"></a><span id="l98.145">    * @param rc            The status code from processing</span>
<a href="#l98.146"></a><span id="l98.146">    * @param actionFunc    The action function called for execution</span>
<a href="#l98.147"></a><span id="l98.147">    * @param foundItems    An array of items found while searching for the item</span>
<a href="#l98.148"></a><span id="l98.148">    *                      in subscribed calendars</span>
<a href="#l98.149"></a><span id="l98.149">    */</span>
<a href="#l98.150"></a><span id="l98.150" class="difflineminus">-  setupOptions: function(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l98.151"></a><span id="l98.151" class="difflineplus">+  setupOptions(itipItem, rc, actionFunc, foundItems) {</span>
<a href="#l98.152"></a><span id="l98.152">     let data = cal.itip.getOptionsText(itipItem, rc, actionFunc, foundItems);</span>
<a href="#l98.153"></a><span id="l98.153"> </span>
<a href="#l98.154"></a><span id="l98.154">     if (Components.isSuccessCode(rc)) {</span>
<a href="#l98.155"></a><span id="l98.155">       ltnImipBar.itipItem = itipItem;</span>
<a href="#l98.156"></a><span id="l98.156">       ltnImipBar.actionFunc = actionFunc;</span>
<a href="#l98.157"></a><span id="l98.157">       ltnImipBar.foundItems = foundItems;</span>
<a href="#l98.158"></a><span id="l98.158">     }</span>
<a href="#l98.159"></a><span id="l98.159"> </span>
<a href="#l98.160"></a><span id="l98.160" class="difflineat">@@ -271,17 +271,17 @@ var ltnImipBar = {</span>
<a href="#l98.161"></a><span id="l98.161">     // adjust button style if necessary</span>
<a href="#l98.162"></a><span id="l98.162">     ltnImipBar.conformButtonType();</span>
<a href="#l98.163"></a><span id="l98.163">     ltnImipBar.displayModifications();</span>
<a href="#l98.164"></a><span id="l98.164">   },</span>
<a href="#l98.165"></a><span id="l98.165"> </span>
<a href="#l98.166"></a><span id="l98.166">   /**</span>
<a href="#l98.167"></a><span id="l98.167">    * Displays changes in case of invitation updates in invitation overlay</span>
<a href="#l98.168"></a><span id="l98.168">    */</span>
<a href="#l98.169"></a><span id="l98.169" class="difflineminus">-  displayModifications: function() {</span>
<a href="#l98.170"></a><span id="l98.170" class="difflineplus">+  displayModifications() {</span>
<a href="#l98.171"></a><span id="l98.171">     if (</span>
<a href="#l98.172"></a><span id="l98.172">       !ltnImipBar.msgOverlay ||</span>
<a href="#l98.173"></a><span id="l98.173">       !msgWindow ||</span>
<a href="#l98.174"></a><span id="l98.174">       !ltnImipBar.foundItems ||</span>
<a href="#l98.175"></a><span id="l98.175">       !ltnImipBar.foundItems[0] ||</span>
<a href="#l98.176"></a><span id="l98.176">       !ltnImipBar.itipItem</span>
<a href="#l98.177"></a><span id="l98.177">     ) {</span>
<a href="#l98.178"></a><span id="l98.178">       return;</span>
<a href="#l98.179"></a><span id="l98.179" class="difflineat">@@ -321,17 +321,17 @@ var ltnImipBar = {</span>
<a href="#l98.180"></a><span id="l98.180">   /**</span>
<a href="#l98.181"></a><span id="l98.181">    * Executes an action triggered by an imip bar button</span>
<a href="#l98.182"></a><span id="l98.182">    *</span>
<a href="#l98.183"></a><span id="l98.183">    * @param   {String}  aParticipantStatus  A partstat string as per RfC 5545</span>
<a href="#l98.184"></a><span id="l98.184">    * @param   {String}  aResponse           Either 'AUTO', 'NONE' or 'USER',</span>
<a href="#l98.185"></a><span id="l98.185">    *                                          see calItipItem interface</span>
<a href="#l98.186"></a><span id="l98.186">    * @returns {Boolean}                     true, if the action succeeded</span>
<a href="#l98.187"></a><span id="l98.187">    */</span>
<a href="#l98.188"></a><span id="l98.188" class="difflineminus">-  executeAction: function(aParticipantStatus, aResponse) {</span>
<a href="#l98.189"></a><span id="l98.189" class="difflineplus">+  executeAction(aParticipantStatus, aResponse) {</span>
<a href="#l98.190"></a><span id="l98.190">     /**</span>
<a href="#l98.191"></a><span id="l98.191">      * Internal function to trigger an scheduling operation</span>
<a href="#l98.192"></a><span id="l98.192">      *</span>
<a href="#l98.193"></a><span id="l98.193">      * @param   {Function}     aActionFunc   The function to call to do the</span>
<a href="#l98.194"></a><span id="l98.194">      *                                         scheduling operation</span>
<a href="#l98.195"></a><span id="l98.195">      * @param   {calIItipItem} aItipItem     Scheduling item</span>
<a href="#l98.196"></a><span id="l98.196">      * @param   {nsIWindow}    aWindow       The current window</span>
<a href="#l98.197"></a><span id="l98.197">      * @param   {String}       aPartStat     partstat string as per RfC 5545</span>
<a href="#l98.198"></a><span id="l98.198" class="difflineat">@@ -348,17 +348,17 @@ var ltnImipBar = {</span>
<a href="#l98.199"></a><span id="l98.199">         }</span>
<a href="#l98.200"></a><span id="l98.200">         // hide the buttons now, to disable pressing them twice...</span>
<a href="#l98.201"></a><span id="l98.201">         if (aPartStat == aParticipantStatus) {</span>
<a href="#l98.202"></a><span id="l98.202">           ltnImipBar.resetButtons();</span>
<a href="#l98.203"></a><span id="l98.203">         }</span>
<a href="#l98.204"></a><span id="l98.204"> </span>
<a href="#l98.205"></a><span id="l98.205">         let opListener = {</span>
<a href="#l98.206"></a><span id="l98.206">           QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l98.207"></a><span id="l98.207" class="difflineminus">-          onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l98.208"></a><span id="l98.208" class="difflineplus">+          onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l98.209"></a><span id="l98.209">             if (Components.isSuccessCode(aStatus) &amp;&amp; isDeclineCounter) {</span>
<a href="#l98.210"></a><span id="l98.210">               // TODO: move the DECLINECOUNTER stuff to actionFunc</span>
<a href="#l98.211"></a><span id="l98.211">               aItipItem.getItemList().forEach(aItem =&gt; {</span>
<a href="#l98.212"></a><span id="l98.212">                 // we can rely on the received itipItem to reply at this stage</span>
<a href="#l98.213"></a><span id="l98.213">                 // already, the checks have been done in cal.itip.processFoundItems</span>
<a href="#l98.214"></a><span id="l98.214">                 // when setting up the respective aActionFunc</span>
<a href="#l98.215"></a><span id="l98.215">                 let attendees = cal.itip.getAttendeesBySender(</span>
<a href="#l98.216"></a><span id="l98.216">                   aItem.getAttendees(),</span>
<a href="#l98.217"></a><span id="l98.217" class="difflineat">@@ -398,17 +398,17 @@ var ltnImipBar = {</span>
<a href="#l98.218"></a><span id="l98.218">             // For now, we just state the status for the user something very simple</span>
<a href="#l98.219"></a><span id="l98.219">             let label = cal.itip.getCompleteText(aStatus, aOperationType);</span>
<a href="#l98.220"></a><span id="l98.220">             imipBar.label = label;</span>
<a href="#l98.221"></a><span id="l98.221"> </span>
<a href="#l98.222"></a><span id="l98.222">             if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l98.223"></a><span id="l98.223">               cal.showError(label);</span>
<a href="#l98.224"></a><span id="l98.224">             }</span>
<a href="#l98.225"></a><span id="l98.225">           },</span>
<a href="#l98.226"></a><span id="l98.226" class="difflineminus">-          onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l98.227"></a><span id="l98.227" class="difflineplus">+          onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l98.228"></a><span id="l98.228">         };</span>
<a href="#l98.229"></a><span id="l98.229"> </span>
<a href="#l98.230"></a><span id="l98.230">         try {</span>
<a href="#l98.231"></a><span id="l98.231">           aActionFunc(opListener, aParticipantStatus, aExtResponse);</span>
<a href="#l98.232"></a><span id="l98.232">         } catch (exc) {</span>
<a href="#l98.233"></a><span id="l98.233">           Cu.reportError(exc);</span>
<a href="#l98.234"></a><span id="l98.234">         }</span>
<a href="#l98.235"></a><span id="l98.235">         return true;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -76,34 +76,34 @@ const gNotification = {};</span>
<a href="#l99.4"></a><span id="l99.4"> XPCOMUtils.defineLazyGetter(gNotification, &quot;notificationbox&quot;, () =&gt; {</span>
<a href="#l99.5"></a><span id="l99.5">   return new MozElements.NotificationBox(element =&gt; {</span>
<a href="#l99.6"></a><span id="l99.6">     element.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l99.7"></a><span id="l99.7">     document.getElementById(&quot;event-dialog-notifications&quot;).append(element);</span>
<a href="#l99.8"></a><span id="l99.8">   });</span>
<a href="#l99.9"></a><span id="l99.9"> });</span>
<a href="#l99.10"></a><span id="l99.10"> </span>
<a href="#l99.11"></a><span id="l99.11"> var eventDialogQuitObserver = {</span>
<a href="#l99.12"></a><span id="l99.12" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l99.14"></a><span id="l99.14">     // Check whether or not we want to veto the quit request (unless another</span>
<a href="#l99.15"></a><span id="l99.15">     // observer already did.</span>
<a href="#l99.16"></a><span id="l99.16">     if (</span>
<a href="#l99.17"></a><span id="l99.17">       aTopic == &quot;quit-application-requested&quot; &amp;&amp;</span>
<a href="#l99.18"></a><span id="l99.18">       aSubject instanceof Ci.nsISupportsPRBool &amp;&amp;</span>
<a href="#l99.19"></a><span id="l99.19">       !aSubject.data</span>
<a href="#l99.20"></a><span id="l99.20">     ) {</span>
<a href="#l99.21"></a><span id="l99.21">       aSubject.data = !onCancel();</span>
<a href="#l99.22"></a><span id="l99.22">     }</span>
<a href="#l99.23"></a><span id="l99.23">   },</span>
<a href="#l99.24"></a><span id="l99.24"> };</span>
<a href="#l99.25"></a><span id="l99.25"> </span>
<a href="#l99.26"></a><span id="l99.26"> var eventDialogCalendarObserver = {</span>
<a href="#l99.27"></a><span id="l99.27">   target: null,</span>
<a href="#l99.28"></a><span id="l99.28">   isObserving: false,</span>
<a href="#l99.29"></a><span id="l99.29"> </span>
<a href="#l99.30"></a><span id="l99.30" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l99.31"></a><span id="l99.31" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l99.32"></a><span id="l99.32">     if (</span>
<a href="#l99.33"></a><span id="l99.33">       this.isObserving &amp;&amp;</span>
<a href="#l99.34"></a><span id="l99.34">       &quot;calendarItem&quot; in window &amp;&amp;</span>
<a href="#l99.35"></a><span id="l99.35">       window.calendarItem &amp;&amp;</span>
<a href="#l99.36"></a><span id="l99.36">       window.calendarItem.id == aOldItem.id</span>
<a href="#l99.37"></a><span id="l99.37">     ) {</span>
<a href="#l99.38"></a><span id="l99.38">       let doUpdate = true;</span>
<a href="#l99.39"></a><span id="l99.39"> </span>
<a href="#l99.40"></a><span id="l99.40" class="difflineat">@@ -142,46 +142,46 @@ var eventDialogCalendarObserver = {</span>
<a href="#l99.41"></a><span id="l99.41">       window.calendarItem = item;</span>
<a href="#l99.42"></a><span id="l99.42"> </span>
<a href="#l99.43"></a><span id="l99.43">       if (doUpdate) {</span>
<a href="#l99.44"></a><span id="l99.44">         loadDialog(window.calendarItem);</span>
<a href="#l99.45"></a><span id="l99.45">       }</span>
<a href="#l99.46"></a><span id="l99.46">     }</span>
<a href="#l99.47"></a><span id="l99.47">   },</span>
<a href="#l99.48"></a><span id="l99.48"> </span>
<a href="#l99.49"></a><span id="l99.49" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l99.50"></a><span id="l99.50" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l99.51"></a><span id="l99.51">     if (</span>
<a href="#l99.52"></a><span id="l99.52">       this.isObserving &amp;&amp;</span>
<a href="#l99.53"></a><span id="l99.53">       &quot;calendarItem&quot; in window &amp;&amp;</span>
<a href="#l99.54"></a><span id="l99.54">       window.calendarItem &amp;&amp;</span>
<a href="#l99.55"></a><span id="l99.55">       window.calendarItem.id == aDeletedItem.id</span>
<a href="#l99.56"></a><span id="l99.56">     ) {</span>
<a href="#l99.57"></a><span id="l99.57">       cancelItem();</span>
<a href="#l99.58"></a><span id="l99.58">     }</span>
<a href="#l99.59"></a><span id="l99.59">   },</span>
<a href="#l99.60"></a><span id="l99.60"> </span>
<a href="#l99.61"></a><span id="l99.61" class="difflineminus">-  onStartBatch: function() {},</span>
<a href="#l99.62"></a><span id="l99.62" class="difflineminus">-  onEndBatch: function() {},</span>
<a href="#l99.63"></a><span id="l99.63" class="difflineminus">-  onLoad: function() {},</span>
<a href="#l99.64"></a><span id="l99.64" class="difflineminus">-  onAddItem: function() {},</span>
<a href="#l99.65"></a><span id="l99.65" class="difflineminus">-  onError: function() {},</span>
<a href="#l99.66"></a><span id="l99.66" class="difflineminus">-  onPropertyChanged: function() {},</span>
<a href="#l99.67"></a><span id="l99.67" class="difflineminus">-  onPropertyDeleting: function() {},</span>
<a href="#l99.68"></a><span id="l99.68" class="difflineminus">-</span>
<a href="#l99.69"></a><span id="l99.69" class="difflineminus">-  observe: function(aCalendar) {</span>
<a href="#l99.70"></a><span id="l99.70" class="difflineplus">+  onStartBatch() {},</span>
<a href="#l99.71"></a><span id="l99.71" class="difflineplus">+  onEndBatch() {},</span>
<a href="#l99.72"></a><span id="l99.72" class="difflineplus">+  onLoad() {},</span>
<a href="#l99.73"></a><span id="l99.73" class="difflineplus">+  onAddItem() {},</span>
<a href="#l99.74"></a><span id="l99.74" class="difflineplus">+  onError() {},</span>
<a href="#l99.75"></a><span id="l99.75" class="difflineplus">+  onPropertyChanged() {},</span>
<a href="#l99.76"></a><span id="l99.76" class="difflineplus">+  onPropertyDeleting() {},</span>
<a href="#l99.77"></a><span id="l99.77" class="difflineplus">+</span>
<a href="#l99.78"></a><span id="l99.78" class="difflineplus">+  observe(aCalendar) {</span>
<a href="#l99.79"></a><span id="l99.79">     // use the new calendar if one was passed, otherwise use the last one</span>
<a href="#l99.80"></a><span id="l99.80">     this.target = aCalendar || this.target;</span>
<a href="#l99.81"></a><span id="l99.81">     if (this.target) {</span>
<a href="#l99.82"></a><span id="l99.82">       this.cancel();</span>
<a href="#l99.83"></a><span id="l99.83">       this.target.addObserver(this);</span>
<a href="#l99.84"></a><span id="l99.84">       this.isObserving = true;</span>
<a href="#l99.85"></a><span id="l99.85">     }</span>
<a href="#l99.86"></a><span id="l99.86">   },</span>
<a href="#l99.87"></a><span id="l99.87"> </span>
<a href="#l99.88"></a><span id="l99.88" class="difflineminus">-  cancel: function() {</span>
<a href="#l99.89"></a><span id="l99.89" class="difflineplus">+  cancel() {</span>
<a href="#l99.90"></a><span id="l99.90">     if (this.isObserving &amp;&amp; this.target) {</span>
<a href="#l99.91"></a><span id="l99.91">       this.target.removeObserver(this);</span>
<a href="#l99.92"></a><span id="l99.92">       this.isObserving = false;</span>
<a href="#l99.93"></a><span id="l99.93">     }</span>
<a href="#l99.94"></a><span id="l99.94">   },</span>
<a href="#l99.95"></a><span id="l99.95"> };</span>
<a href="#l99.96"></a><span id="l99.96"> </span>
<a href="#l99.97"></a><span id="l99.97"> /**</span>
<a href="#l99.98"></a><span id="l99.98" class="difflineat">@@ -290,17 +290,17 @@ function receiveMessage(aEvent) {</span>
<a href="#l99.99"></a><span id="l99.99">         updateItemURL(newShow, newUrl);</span>
<a href="#l99.100"></a><span id="l99.100">       }</span>
<a href="#l99.101"></a><span id="l99.101">       break;</span>
<a href="#l99.102"></a><span id="l99.102">     }</span>
<a href="#l99.103"></a><span id="l99.103">     case &quot;closingWindowWithTabs&quot;: {</span>
<a href="#l99.104"></a><span id="l99.104">       let response = onCancel(aEvent.data.id, true);</span>
<a href="#l99.105"></a><span id="l99.105">       sendMessage({</span>
<a href="#l99.106"></a><span id="l99.106">         command: &quot;replyToClosingWindowWithTabs&quot;,</span>
<a href="#l99.107"></a><span id="l99.107" class="difflineminus">-        response: response,</span>
<a href="#l99.108"></a><span id="l99.108" class="difflineplus">+        response,</span>
<a href="#l99.109"></a><span id="l99.109">       });</span>
<a href="#l99.110"></a><span id="l99.110">       break;</span>
<a href="#l99.111"></a><span id="l99.111">     }</span>
<a href="#l99.112"></a><span id="l99.112">     case &quot;attachFileByAccountKey&quot;:</span>
<a href="#l99.113"></a><span id="l99.113">       attachFileByAccountKey(aEvent.data.accountKey);</span>
<a href="#l99.114"></a><span id="l99.114">       break;</span>
<a href="#l99.115"></a><span id="l99.115">     case &quot;triggerUpdateSaveControls&quot;:</span>
<a href="#l99.116"></a><span id="l99.116">       updateParentSaveControls();</span>
<a href="#l99.117"></a><span id="l99.117" class="difflineat">@@ -340,17 +340,17 @@ function onLoad() {</span>
<a href="#l99.118"></a><span id="l99.118">     // store the 'finalize'-functor in the provided job-object.</span>
<a href="#l99.119"></a><span id="l99.119">     args.job.finalize = () =&gt; {</span>
<a href="#l99.120"></a><span id="l99.120">       // store any pending modifications...</span>
<a href="#l99.121"></a><span id="l99.121">       this.onAccept();</span>
<a href="#l99.122"></a><span id="l99.122"> </span>
<a href="#l99.123"></a><span id="l99.123">       let item = window.calendarItem;</span>
<a href="#l99.124"></a><span id="l99.124"> </span>
<a href="#l99.125"></a><span id="l99.125">       // ...and close the window.</span>
<a href="#l99.126"></a><span id="l99.126" class="difflineminus">-      sendMessage({ command: &quot;closeWindowOrTab&quot;, iframeId: iframeId });</span>
<a href="#l99.127"></a><span id="l99.127" class="difflineplus">+      sendMessage({ command: &quot;closeWindowOrTab&quot;, iframeId });</span>
<a href="#l99.128"></a><span id="l99.128"> </span>
<a href="#l99.129"></a><span id="l99.129">       return item;</span>
<a href="#l99.130"></a><span id="l99.130">     };</span>
<a href="#l99.131"></a><span id="l99.131">   }</span>
<a href="#l99.132"></a><span id="l99.132"> </span>
<a href="#l99.133"></a><span id="l99.133">   window.fbWrapper = args.fbWrapper;</span>
<a href="#l99.134"></a><span id="l99.134"> </span>
<a href="#l99.135"></a><span id="l99.135">   // the most important attribute we expect from the</span>
<a href="#l99.136"></a><span id="l99.136" class="difflineat">@@ -764,18 +764,18 @@ function loadDialog(aItem) {</span>
<a href="#l99.137"></a><span id="l99.137"> </span>
<a href="#l99.138"></a><span id="l99.138">     let labelString = isEvent ? &quot;itemMenuLabelEvent&quot; : &quot;itemMenuLabelTask&quot;;</span>
<a href="#l99.139"></a><span id="l99.139">     let label = cal.l10n.getString(&quot;calendar-event-dialog&quot;, labelString);</span>
<a href="#l99.140"></a><span id="l99.140"> </span>
<a href="#l99.141"></a><span id="l99.141">     let accessKeyString = isEvent ? &quot;itemMenuAccesskeyEvent2&quot; : &quot;itemMenuAccesskeyTask2&quot;;</span>
<a href="#l99.142"></a><span id="l99.142">     let accessKey = cal.l10n.getString(&quot;calendar-event-dialog&quot;, accessKeyString);</span>
<a href="#l99.143"></a><span id="l99.143">     sendMessage({</span>
<a href="#l99.144"></a><span id="l99.144">       command: &quot;initializeItemMenu&quot;,</span>
<a href="#l99.145"></a><span id="l99.145" class="difflineminus">-      label: label,</span>
<a href="#l99.146"></a><span id="l99.146" class="difflineminus">-      accessKey: accessKey,</span>
<a href="#l99.147"></a><span id="l99.147" class="difflineplus">+      label,</span>
<a href="#l99.148"></a><span id="l99.148" class="difflineplus">+      accessKey,</span>
<a href="#l99.149"></a><span id="l99.149">     });</span>
<a href="#l99.150"></a><span id="l99.150">   }</span>
<a href="#l99.151"></a><span id="l99.151"> </span>
<a href="#l99.152"></a><span id="l99.152">   // Repeat details</span>
<a href="#l99.153"></a><span id="l99.153">   let [repeatType, untilDate] = getRepeatTypeAndUntilDate(aItem);</span>
<a href="#l99.154"></a><span id="l99.154">   if (gNewItemUI) {</span>
<a href="#l99.155"></a><span id="l99.155">     itemProps.initialRepeat = repeatType;</span>
<a href="#l99.156"></a><span id="l99.156">     itemProps.initialRepeatUntilDate = untilDate;</span>
<a href="#l99.157"></a><span id="l99.157" class="difflineat">@@ -1324,34 +1324,34 @@ function dateTimeControls2State(aStartDa</span>
<a href="#l99.158"></a><span id="l99.158"> }</span>
<a href="#l99.159"></a><span id="l99.159"> </span>
<a href="#l99.160"></a><span id="l99.160"> /**</span>
<a href="#l99.161"></a><span id="l99.161">  * Updates the entry date checkboxes, used for example when choosing an alarm:</span>
<a href="#l99.162"></a><span id="l99.162">  * the entry date needs to be checked in that case.</span>
<a href="#l99.163"></a><span id="l99.163">  */</span>
<a href="#l99.164"></a><span id="l99.164"> function updateEntryDate() {</span>
<a href="#l99.165"></a><span id="l99.165">   updateDateCheckboxes(&quot;todo-entrydate&quot;, &quot;todo-has-entrydate&quot;, {</span>
<a href="#l99.166"></a><span id="l99.166" class="difflineminus">-    isValid: function() {</span>
<a href="#l99.167"></a><span id="l99.167" class="difflineplus">+    isValid() {</span>
<a href="#l99.168"></a><span id="l99.168">       return gStartTime != null;</span>
<a href="#l99.169"></a><span id="l99.169">     },</span>
<a href="#l99.170"></a><span id="l99.170" class="difflineminus">-    setDateTime: function(date) {</span>
<a href="#l99.171"></a><span id="l99.171" class="difflineplus">+    setDateTime(date) {</span>
<a href="#l99.172"></a><span id="l99.172">       gStartTime = date;</span>
<a href="#l99.173"></a><span id="l99.173">     },</span>
<a href="#l99.174"></a><span id="l99.174">   });</span>
<a href="#l99.175"></a><span id="l99.175"> }</span>
<a href="#l99.176"></a><span id="l99.176"> </span>
<a href="#l99.177"></a><span id="l99.177"> /**</span>
<a href="#l99.178"></a><span id="l99.178">  * Updates the due date checkboxes.</span>
<a href="#l99.179"></a><span id="l99.179">  */</span>
<a href="#l99.180"></a><span id="l99.180"> function updateDueDate() {</span>
<a href="#l99.181"></a><span id="l99.181">   updateDateCheckboxes(&quot;todo-duedate&quot;, &quot;todo-has-duedate&quot;, {</span>
<a href="#l99.182"></a><span id="l99.182" class="difflineminus">-    isValid: function() {</span>
<a href="#l99.183"></a><span id="l99.183" class="difflineplus">+    isValid() {</span>
<a href="#l99.184"></a><span id="l99.184">       return gEndTime != null;</span>
<a href="#l99.185"></a><span id="l99.185">     },</span>
<a href="#l99.186"></a><span id="l99.186" class="difflineminus">-    setDateTime: function(date) {</span>
<a href="#l99.187"></a><span id="l99.187" class="difflineplus">+    setDateTime(date) {</span>
<a href="#l99.188"></a><span id="l99.188">       gEndTime = date;</span>
<a href="#l99.189"></a><span id="l99.189">     },</span>
<a href="#l99.190"></a><span id="l99.190">   });</span>
<a href="#l99.191"></a><span id="l99.191"> }</span>
<a href="#l99.192"></a><span id="l99.192"> </span>
<a href="#l99.193"></a><span id="l99.193"> /**</span>
<a href="#l99.194"></a><span id="l99.194">  * Common function used by updateEntryDate and updateDueDate to set up the</span>
<a href="#l99.195"></a><span id="l99.195">  * checkboxes correctly.</span>
<a href="#l99.196"></a><span id="l99.196" class="difflineat">@@ -3228,17 +3228,17 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l99.197"></a><span id="l99.197">   // dialog is up to date.</span>
<a href="#l99.198"></a><span id="l99.198"> </span>
<a href="#l99.199"></a><span id="l99.199">   // XXX Do we want to disable the dialog or at least the save button until</span>
<a href="#l99.200"></a><span id="l99.200">   // the call is complete? This might help when the user tries to save twice</span>
<a href="#l99.201"></a><span id="l99.201">   // before the call is complete. In that case, we do need a progress bar and</span>
<a href="#l99.202"></a><span id="l99.202">   // the ability to cancel the operation though.</span>
<a href="#l99.203"></a><span id="l99.203">   let listener = {</span>
<a href="#l99.204"></a><span id="l99.204">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l99.205"></a><span id="l99.205" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aItem) {</span>
<a href="#l99.206"></a><span id="l99.206" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOpType, aId, aItem) {</span>
<a href="#l99.207"></a><span id="l99.207">       // Check if the current window has a calendarItem first, because in case of undo</span>
<a href="#l99.208"></a><span id="l99.208">       // window refers to the main window and we would get a 'calendarItem is undefined' warning.</span>
<a href="#l99.209"></a><span id="l99.209">       if (!aIsClosing &amp;&amp; &quot;calendarItem&quot; in window) {</span>
<a href="#l99.210"></a><span id="l99.210">         // If we changed the calendar of the item, onOperationComplete will be called multiple</span>
<a href="#l99.211"></a><span id="l99.211">         // times. We need to make sure we're receiving the update on the right calendar.</span>
<a href="#l99.212"></a><span id="l99.212">         if (</span>
<a href="#l99.213"></a><span id="l99.213">           (!window.calendarItem.id || aId == window.calendarItem.id) &amp;&amp;</span>
<a href="#l99.214"></a><span id="l99.214">           aCalendar.id == window.calendarItem.calendar.id &amp;&amp;</span>
<a href="#l99.215"></a><span id="l99.215" class="difflineat">@@ -3261,17 +3261,17 @@ function onCommandSave(aIsClosing) {</span>
<a href="#l99.216"></a><span id="l99.216">           eventDialogCalendarObserver.observe(window.calendarItem.calendar);</span>
<a href="#l99.217"></a><span id="l99.217">         }</span>
<a href="#l99.218"></a><span id="l99.218">       }</span>
<a href="#l99.219"></a><span id="l99.219">       // this triggers the update of the imipbar in case this is a rescheduling case</span>
<a href="#l99.220"></a><span id="l99.220">       if (window.counterProposal &amp;&amp; window.counterProposal.onReschedule) {</span>
<a href="#l99.221"></a><span id="l99.221">         window.counterProposal.onReschedule();</span>
<a href="#l99.222"></a><span id="l99.222">       }</span>
<a href="#l99.223"></a><span id="l99.223">     },</span>
<a href="#l99.224"></a><span id="l99.224" class="difflineminus">-    onGetResult: function(calendarItem, status, itemType, detail, items) {},</span>
<a href="#l99.225"></a><span id="l99.225" class="difflineplus">+    onGetResult(calendarItem, status, itemType, detail, items) {},</span>
<a href="#l99.226"></a><span id="l99.226">   };</span>
<a href="#l99.227"></a><span id="l99.227">   let resp = document.getElementById(&quot;notify-attendees-checkbox&quot;).checked</span>
<a href="#l99.228"></a><span id="l99.228">     ? Ci.calIItipItem.AUTO</span>
<a href="#l99.229"></a><span id="l99.229">     : Ci.calIItipItem.NONE;</span>
<a href="#l99.230"></a><span id="l99.230">   let extResponse = { responseMode: resp };</span>
<a href="#l99.231"></a><span id="l99.231">   window.onAcceptCallback(item, calendar, originalItem, listener, extResponse);</span>
<a href="#l99.232"></a><span id="l99.232"> }</span>
<a href="#l99.233"></a><span id="l99.233"> </span>
<a href="#l99.234"></a><span id="l99.234" class="difflineat">@@ -3300,17 +3300,17 @@ function onCommandDeleteItem() {</span>
<a href="#l99.235"></a><span id="l99.235">     }</span>
<a href="#l99.236"></a><span id="l99.236">   }</span>
<a href="#l99.237"></a><span id="l99.237"> </span>
<a href="#l99.238"></a><span id="l99.238">   if (window.mode == &quot;new&quot;) {</span>
<a href="#l99.239"></a><span id="l99.239">     cancelItem();</span>
<a href="#l99.240"></a><span id="l99.240">   } else {</span>
<a href="#l99.241"></a><span id="l99.241">     let deleteListener = {</span>
<a href="#l99.242"></a><span id="l99.242">       // when deletion of item is complete, close the dialog</span>
<a href="#l99.243"></a><span id="l99.243" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l99.244"></a><span id="l99.244" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l99.245"></a><span id="l99.245">         // Check if the current window has a calendarItem first, because in case of undo</span>
<a href="#l99.246"></a><span id="l99.246">         // window refers to the main window and we would get a 'calendarItem is undefined' warning.</span>
<a href="#l99.247"></a><span id="l99.247">         if (&quot;calendarItem&quot; in window) {</span>
<a href="#l99.248"></a><span id="l99.248">           if (aId == window.calendarItem.id &amp;&amp; Components.isSuccessCode(aStatus)) {</span>
<a href="#l99.249"></a><span id="l99.249">             cancelItem();</span>
<a href="#l99.250"></a><span id="l99.250">           } else {</span>
<a href="#l99.251"></a><span id="l99.251">             eventDialogCalendarObserver.observe(window.calendarItem.calendar);</span>
<a href="#l99.252"></a><span id="l99.252">           }</span>
<a href="#l99.253"></a><span id="l99.253" class="difflineat">@@ -3758,21 +3758,20 @@ function showOrHideItemURL(aShow, aUrl) </span>
<a href="#l99.254"></a><span id="l99.254">       // No protocol handler for the given protocol, or invalid uri</span>
<a href="#l99.255"></a><span id="l99.255">       // hideOrShow(false);</span>
<a href="#l99.256"></a><span id="l99.256">       return false;</span>
<a href="#l99.257"></a><span id="l99.257">     }</span>
<a href="#l99.258"></a><span id="l99.258">     // Only show if its either an internal protocol handler, or its external</span>
<a href="#l99.259"></a><span id="l99.259">     // and there is an external app for the scheme</span>
<a href="#l99.260"></a><span id="l99.260">     handler = cal.wrapInstance(handler, Ci.nsIExternalProtocolHandler);</span>
<a href="#l99.261"></a><span id="l99.261">     return !handler || handler.externalAppExistsForScheme(uri.scheme);</span>
<a href="#l99.262"></a><span id="l99.262" class="difflineminus">-  } else {</span>
<a href="#l99.263"></a><span id="l99.263" class="difflineminus">-    // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l99.264"></a><span id="l99.264" class="difflineminus">-    // should be hidden.</span>
<a href="#l99.265"></a><span id="l99.265" class="difflineminus">-    return false;</span>
<a href="#l99.266"></a><span id="l99.266">   }</span>
<a href="#l99.267"></a><span id="l99.267" class="difflineplus">+  // Hide if there is no url, or the menuitem was chosen so that the url</span>
<a href="#l99.268"></a><span id="l99.268" class="difflineplus">+  // should be hidden.</span>
<a href="#l99.269"></a><span id="l99.269" class="difflineplus">+  return false;</span>
<a href="#l99.270"></a><span id="l99.270"> }</span>
<a href="#l99.271"></a><span id="l99.271"> </span>
<a href="#l99.272"></a><span id="l99.272"> /**</span>
<a href="#l99.273"></a><span id="l99.273">  * Updates the related link on the dialog (rfc2445 URL property).</span>
<a href="#l99.274"></a><span id="l99.274">  *</span>
<a href="#l99.275"></a><span id="l99.275">  * @param {boolean} aShow  Show the link (true) or not (false)</span>
<a href="#l99.276"></a><span id="l99.276">  * @param {string} aUrl    The url</span>
<a href="#l99.277"></a><span id="l99.277">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-preferences.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -10,17 +10,17 @@</span>
<a href="#l100.4"></a><span id="l100.4"> /* import-globals-from ../../base/content/preferences/alarms.js */</span>
<a href="#l100.5"></a><span id="l100.5"> /* import-globals-from ../../base/content/preferences/categories.js */</span>
<a href="#l100.6"></a><span id="l100.6"> /* import-globals-from ../../base/content/preferences/general.js */</span>
<a href="#l100.7"></a><span id="l100.7"> /* import-globals-from ../../base/content/preferences/views.js */</span>
<a href="#l100.8"></a><span id="l100.8"> </span>
<a href="#l100.9"></a><span id="l100.9"> Preferences.add({ id: &quot;calendar.preferences.lightning.selectedTabIndex&quot;, type: &quot;int&quot; });</span>
<a href="#l100.10"></a><span id="l100.10"> </span>
<a href="#l100.11"></a><span id="l100.11"> var gLightningPane = {</span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-  init: function() {</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+  init() {</span>
<a href="#l100.14"></a><span id="l100.14">     let elements = document.querySelectorAll(&quot;#paneLightning preference&quot;);</span>
<a href="#l100.15"></a><span id="l100.15">     for (let element of elements) {</span>
<a href="#l100.16"></a><span id="l100.16">       element.updateElements();</span>
<a href="#l100.17"></a><span id="l100.17">     }</span>
<a href="#l100.18"></a><span id="l100.18">   },</span>
<a href="#l100.19"></a><span id="l100.19"> };</span>
<a href="#l100.20"></a><span id="l100.20"> </span>
<a href="#l100.21"></a><span id="l100.21"> gCalendarGeneralPane.init();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/calendar/lightning/content/messenger-overlay-sidebar.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -18,23 +18,23 @@ var { AddonManager } = ChromeUtils.impor</span>
<a href="#l101.4"></a><span id="l101.4"> var { cal } = ChromeUtils.import(&quot;resource:///modules/calendar/calUtils.jsm&quot;);</span>
<a href="#l101.5"></a><span id="l101.5"> </span>
<a href="#l101.6"></a><span id="l101.6"> var gLastShownCalendarView = null;</span>
<a href="#l101.7"></a><span id="l101.7"> </span>
<a href="#l101.8"></a><span id="l101.8"> var calendarTabMonitor = {</span>
<a href="#l101.9"></a><span id="l101.9">   monitorName: &quot;lightning&quot;,</span>
<a href="#l101.10"></a><span id="l101.10"> </span>
<a href="#l101.11"></a><span id="l101.11">   // Unused, but needed functions</span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-  onTabTitleChanged: function() {},</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineminus">-  onTabOpened: function() {},</span>
<a href="#l101.14"></a><span id="l101.14" class="difflineminus">-  onTabClosing: function() {},</span>
<a href="#l101.15"></a><span id="l101.15" class="difflineminus">-  onTabPersist: function() {},</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineminus">-  onTabRestored: function() {},</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+  onTabTitleChanged() {},</span>
<a href="#l101.18"></a><span id="l101.18" class="difflineplus">+  onTabOpened() {},</span>
<a href="#l101.19"></a><span id="l101.19" class="difflineplus">+  onTabClosing() {},</span>
<a href="#l101.20"></a><span id="l101.20" class="difflineplus">+  onTabPersist() {},</span>
<a href="#l101.21"></a><span id="l101.21" class="difflineplus">+  onTabRestored() {},</span>
<a href="#l101.22"></a><span id="l101.22"> </span>
<a href="#l101.23"></a><span id="l101.23" class="difflineminus">-  onTabSwitched: function(aNewTab, aOldTab) {</span>
<a href="#l101.24"></a><span id="l101.24" class="difflineplus">+  onTabSwitched(aNewTab, aOldTab) {</span>
<a href="#l101.25"></a><span id="l101.25">     // Unfortunately, tabmail doesn't provide a hideTab function on the tab</span>
<a href="#l101.26"></a><span id="l101.26">     // type definitions. To make sure the commands are correctly disabled,</span>
<a href="#l101.27"></a><span id="l101.27">     // we want to update calendar/task commands when switching away from</span>
<a href="#l101.28"></a><span id="l101.28">     // those tabs.</span>
<a href="#l101.29"></a><span id="l101.29">     if (aOldTab.mode.name == &quot;calendar&quot; || aOldTab.mode.name == &quot;task&quot;) {</span>
<a href="#l101.30"></a><span id="l101.30">       calendarController.updateCommands();</span>
<a href="#l101.31"></a><span id="l101.31">       calendarController2.updateCommands();</span>
<a href="#l101.32"></a><span id="l101.32">     }</span>
<a href="#l101.33"></a><span id="l101.33" class="difflineat">@@ -77,82 +77,82 @@ var calendarTabMonitor = {</span>
<a href="#l101.34"></a><span id="l101.34"> </span>
<a href="#l101.35"></a><span id="l101.35"> var calendarTabType = {</span>
<a href="#l101.36"></a><span id="l101.36">   name: &quot;calendar&quot;,</span>
<a href="#l101.37"></a><span id="l101.37">   panelId: &quot;calendarTabPanel&quot;,</span>
<a href="#l101.38"></a><span id="l101.38">   modes: {</span>
<a href="#l101.39"></a><span id="l101.39">     calendar: {</span>
<a href="#l101.40"></a><span id="l101.40">       type: &quot;calendar&quot;,</span>
<a href="#l101.41"></a><span id="l101.41">       maxTabs: 1,</span>
<a href="#l101.42"></a><span id="l101.42" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l101.43"></a><span id="l101.43" class="difflineplus">+      openTab(aTab, aArgs) {</span>
<a href="#l101.44"></a><span id="l101.44">         gLastShownCalendarView = getLastCalendarView();</span>
<a href="#l101.45"></a><span id="l101.45">         aTab.title = aArgs.title;</span>
<a href="#l101.46"></a><span id="l101.46">       },</span>
<a href="#l101.47"></a><span id="l101.47" class="difflineminus">-      showTab: function(tab) {},</span>
<a href="#l101.48"></a><span id="l101.48" class="difflineminus">-      closeTab: function(tab) {},</span>
<a href="#l101.49"></a><span id="l101.49" class="difflineplus">+      showTab(tab) {},</span>
<a href="#l101.50"></a><span id="l101.50" class="difflineplus">+      closeTab(tab) {},</span>
<a href="#l101.51"></a><span id="l101.51"> </span>
<a href="#l101.52"></a><span id="l101.52" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l101.53"></a><span id="l101.53" class="difflineplus">+      persistTab(aTab) {</span>
<a href="#l101.54"></a><span id="l101.54">         let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l101.55"></a><span id="l101.55">         return {</span>
<a href="#l101.56"></a><span id="l101.56">           // Since we do strange tab switching logic in calSwitchToCalendarMode,</span>
<a href="#l101.57"></a><span id="l101.57">           // we should store the current tab state ourselves.</span>
<a href="#l101.58"></a><span id="l101.58">           background: aTab != tabmail.currentTabInfo,</span>
<a href="#l101.59"></a><span id="l101.59">         };</span>
<a href="#l101.60"></a><span id="l101.60">       },</span>
<a href="#l101.61"></a><span id="l101.61"> </span>
<a href="#l101.62"></a><span id="l101.62" class="difflineminus">-      restoreTab: function(aTabmail, aState) {</span>
<a href="#l101.63"></a><span id="l101.63" class="difflineplus">+      restoreTab(aTabmail, aState) {</span>
<a href="#l101.64"></a><span id="l101.64">         aState.title = cal.l10n.getLtnString(&quot;tabTitleCalendar&quot;);</span>
<a href="#l101.65"></a><span id="l101.65">         aTabmail.openTab(&quot;calendar&quot;, aState);</span>
<a href="#l101.66"></a><span id="l101.66">       },</span>
<a href="#l101.67"></a><span id="l101.67"> </span>
<a href="#l101.68"></a><span id="l101.68" class="difflineminus">-      onTitleChanged: function(aTab) {</span>
<a href="#l101.69"></a><span id="l101.69" class="difflineplus">+      onTitleChanged(aTab) {</span>
<a href="#l101.70"></a><span id="l101.70">         aTab.title = cal.l10n.getLtnString(&quot;tabTitleCalendar&quot;);</span>
<a href="#l101.71"></a><span id="l101.71">       },</span>
<a href="#l101.72"></a><span id="l101.72"> </span>
<a href="#l101.73"></a><span id="l101.73">       supportsCommand: (aCommand, aTab) =&gt; calendarController2.supportsCommand(aCommand),</span>
<a href="#l101.74"></a><span id="l101.74">       isCommandEnabled: (aCommand, aTab) =&gt; calendarController2.isCommandEnabled(aCommand),</span>
<a href="#l101.75"></a><span id="l101.75">       doCommand: (aCommand, aTab) =&gt; calendarController2.doCommand(aCommand),</span>
<a href="#l101.76"></a><span id="l101.76">       onEvent: (aEvent, aTab) =&gt; calendarController2.onEvent(aEvent),</span>
<a href="#l101.77"></a><span id="l101.77">     },</span>
<a href="#l101.78"></a><span id="l101.78"> </span>
<a href="#l101.79"></a><span id="l101.79">     tasks: {</span>
<a href="#l101.80"></a><span id="l101.80">       type: &quot;tasks&quot;,</span>
<a href="#l101.81"></a><span id="l101.81">       maxTabs: 1,</span>
<a href="#l101.82"></a><span id="l101.82" class="difflineminus">-      openTab: function(aTab, aArgs) {</span>
<a href="#l101.83"></a><span id="l101.83" class="difflineplus">+      openTab(aTab, aArgs) {</span>
<a href="#l101.84"></a><span id="l101.84">         aTab.title = aArgs.title;</span>
<a href="#l101.85"></a><span id="l101.85">       },</span>
<a href="#l101.86"></a><span id="l101.86" class="difflineminus">-      showTab: function(tab) {},</span>
<a href="#l101.87"></a><span id="l101.87" class="difflineminus">-      closeTab: function(tab) {},</span>
<a href="#l101.88"></a><span id="l101.88" class="difflineplus">+      showTab(tab) {},</span>
<a href="#l101.89"></a><span id="l101.89" class="difflineplus">+      closeTab(tab) {},</span>
<a href="#l101.90"></a><span id="l101.90"> </span>
<a href="#l101.91"></a><span id="l101.91" class="difflineminus">-      persistTab: function(aTab) {</span>
<a href="#l101.92"></a><span id="l101.92" class="difflineplus">+      persistTab(aTab) {</span>
<a href="#l101.93"></a><span id="l101.93">         let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l101.94"></a><span id="l101.94">         return {</span>
<a href="#l101.95"></a><span id="l101.95">           // Since we do strange tab switching logic in calSwitchToTaskMode,</span>
<a href="#l101.96"></a><span id="l101.96">           // we should store the current tab state ourselves.</span>
<a href="#l101.97"></a><span id="l101.97">           background: aTab != tabmail.currentTabInfo,</span>
<a href="#l101.98"></a><span id="l101.98">         };</span>
<a href="#l101.99"></a><span id="l101.99">       },</span>
<a href="#l101.100"></a><span id="l101.100"> </span>
<a href="#l101.101"></a><span id="l101.101" class="difflineminus">-      restoreTab: function(aTabmail, aState) {</span>
<a href="#l101.102"></a><span id="l101.102" class="difflineplus">+      restoreTab(aTabmail, aState) {</span>
<a href="#l101.103"></a><span id="l101.103">         aState.title = cal.l10n.getLtnString(&quot;tabTitleTasks&quot;);</span>
<a href="#l101.104"></a><span id="l101.104">         aTabmail.openTab(&quot;tasks&quot;, aState);</span>
<a href="#l101.105"></a><span id="l101.105">       },</span>
<a href="#l101.106"></a><span id="l101.106"> </span>
<a href="#l101.107"></a><span id="l101.107" class="difflineminus">-      onTitleChanged: function(aTab) {</span>
<a href="#l101.108"></a><span id="l101.108" class="difflineplus">+      onTitleChanged(aTab) {</span>
<a href="#l101.109"></a><span id="l101.109">         aTab.title = cal.l10n.getLtnString(&quot;tabTitleTasks&quot;);</span>
<a href="#l101.110"></a><span id="l101.110">       },</span>
<a href="#l101.111"></a><span id="l101.111"> </span>
<a href="#l101.112"></a><span id="l101.112">       supportsCommand: (aCommand, aTab) =&gt; calendarController2.supportsCommand(aCommand),</span>
<a href="#l101.113"></a><span id="l101.113">       isCommandEnabled: (aCommand, aTab) =&gt; calendarController2.isCommandEnabled(aCommand),</span>
<a href="#l101.114"></a><span id="l101.114">       doCommand: (aCommand, aTab) =&gt; calendarController2.doCommand(aCommand),</span>
<a href="#l101.115"></a><span id="l101.115">       onEvent: (aEvent, aTab) =&gt; calendarController2.onEvent(aEvent),</span>
<a href="#l101.116"></a><span id="l101.116">     },</span>
<a href="#l101.117"></a><span id="l101.117">   },</span>
<a href="#l101.118"></a><span id="l101.118"> </span>
<a href="#l101.119"></a><span id="l101.119" class="difflineminus">-  saveTabState: function(tab) {},</span>
<a href="#l101.120"></a><span id="l101.120" class="difflineplus">+  saveTabState(tab) {},</span>
<a href="#l101.121"></a><span id="l101.121"> };</span>
<a href="#l101.122"></a><span id="l101.122"> </span>
<a href="#l101.123"></a><span id="l101.123"> /**</span>
<a href="#l101.124"></a><span id="l101.124">  * For details about tab info objects and the tabmail interface see:</span>
<a href="#l101.125"></a><span id="l101.125">  * comm/mail/base/content/mailTabs.js</span>
<a href="#l101.126"></a><span id="l101.126">  * comm/mail/base/content/tabmail.js</span>
<a href="#l101.127"></a><span id="l101.127">  */</span>
<a href="#l101.128"></a><span id="l101.128"> var calendarItemTabType = {</span>
<a href="#l101.129"></a><span id="l101.129" class="difflineat">@@ -164,17 +164,17 @@ var calendarItemTabType = {</span>
<a href="#l101.130"></a><span id="l101.130">     calendarTask: { type: &quot;calendarTask&quot; },</span>
<a href="#l101.131"></a><span id="l101.131">   },</span>
<a href="#l101.132"></a><span id="l101.132">   /**</span>
<a href="#l101.133"></a><span id="l101.133">    * Opens an event tab or a task tab.</span>
<a href="#l101.134"></a><span id="l101.134">    *</span>
<a href="#l101.135"></a><span id="l101.135">    * @param {Object} aTab   A tab info object</span>
<a href="#l101.136"></a><span id="l101.136">    * @param {Object} aArgs  Contains data about the event/task</span>
<a href="#l101.137"></a><span id="l101.137">    */</span>
<a href="#l101.138"></a><span id="l101.138" class="difflineminus">-  openTab: function(aTab, aArgs) {</span>
<a href="#l101.139"></a><span id="l101.139" class="difflineplus">+  openTab(aTab, aArgs) {</span>
<a href="#l101.140"></a><span id="l101.140">     // Create a clone to use for this tab. Remove the cloned toolbox</span>
<a href="#l101.141"></a><span id="l101.141">     // and move the original toolbox into its place. There is only</span>
<a href="#l101.142"></a><span id="l101.142">     // one toolbox/toolbar so its settings are the same for all item tabs.</span>
<a href="#l101.143"></a><span id="l101.143">     let original = document.getElementById(&quot;lightningItemPanel&quot;).firstElementChild;</span>
<a href="#l101.144"></a><span id="l101.144">     let clone = original.cloneNode(true);</span>
<a href="#l101.145"></a><span id="l101.145"> </span>
<a href="#l101.146"></a><span id="l101.146">     clone.querySelector(&quot;toolbox&quot;).remove();</span>
<a href="#l101.147"></a><span id="l101.147">     moveEventToolbox(clone);</span>
<a href="#l101.148"></a><span id="l101.148" class="difflineat">@@ -223,17 +223,17 @@ var calendarItemTabType = {</span>
<a href="#l101.149"></a><span id="l101.149"> </span>
<a href="#l101.150"></a><span id="l101.150">     this.idNumber += 1;</span>
<a href="#l101.151"></a><span id="l101.151">   },</span>
<a href="#l101.152"></a><span id="l101.152">   /**</span>
<a href="#l101.153"></a><span id="l101.153">    * Saves a tab's state when it is deactivated / hidden.  The opposite of showTab.</span>
<a href="#l101.154"></a><span id="l101.154">    *</span>
<a href="#l101.155"></a><span id="l101.155">    * @param {Object} aTab  A tab info object</span>
<a href="#l101.156"></a><span id="l101.156">    */</span>
<a href="#l101.157"></a><span id="l101.157" class="difflineminus">-  saveTabState: function(aTab) {</span>
<a href="#l101.158"></a><span id="l101.158" class="difflineplus">+  saveTabState(aTab) {</span>
<a href="#l101.159"></a><span id="l101.159">     // save state</span>
<a href="#l101.160"></a><span id="l101.160">     aTab.itemTabConfig = {};</span>
<a href="#l101.161"></a><span id="l101.161">     Object.assign(aTab.itemTabConfig, gConfig);</span>
<a href="#l101.162"></a><span id="l101.162"> </span>
<a href="#l101.163"></a><span id="l101.163">     // clear statusbar</span>
<a href="#l101.164"></a><span id="l101.164">     let statusbar = document.getElementById(&quot;status-bar&quot;);</span>
<a href="#l101.165"></a><span id="l101.165">     let items = statusbar.getElementsByClassName(&quot;event-dialog&quot;);</span>
<a href="#l101.166"></a><span id="l101.166">     for (let item of items) {</span>
<a href="#l101.167"></a><span id="l101.167" class="difflineat">@@ -243,46 +243,45 @@ var calendarItemTabType = {</span>
<a href="#l101.168"></a><span id="l101.168">     let to = document.getElementById(&quot;lightningItemPanel&quot;).firstElementChild;</span>
<a href="#l101.169"></a><span id="l101.169">     moveEventToolbox(to);</span>
<a href="#l101.170"></a><span id="l101.170">   },</span>
<a href="#l101.171"></a><span id="l101.171">   /**</span>
<a href="#l101.172"></a><span id="l101.172">    * Called when a tab is activated / shown.  The opposite of saveTabState.</span>
<a href="#l101.173"></a><span id="l101.173">    *</span>
<a href="#l101.174"></a><span id="l101.174">    * @param {Object} aTab  A tab info object</span>
<a href="#l101.175"></a><span id="l101.175">    */</span>
<a href="#l101.176"></a><span id="l101.176" class="difflineminus">-  showTab: function(aTab) {</span>
<a href="#l101.177"></a><span id="l101.177" class="difflineplus">+  showTab(aTab) {</span>
<a href="#l101.178"></a><span id="l101.178">     // move toolbox into place then load state</span>
<a href="#l101.179"></a><span id="l101.179">     moveEventToolbox(aTab.panel.firstElementChild);</span>
<a href="#l101.180"></a><span id="l101.180">     Object.assign(gConfig, aTab.itemTabConfig);</span>
<a href="#l101.181"></a><span id="l101.181">     updateItemTabState(gConfig);</span>
<a href="#l101.182"></a><span id="l101.182"> </span>
<a href="#l101.183"></a><span id="l101.183">     // activate or de-activate 'Events and Tasks' menu items</span>
<a href="#l101.184"></a><span id="l101.184">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l101.185"></a><span id="l101.185">   },</span>
<a href="#l101.186"></a><span id="l101.186">   /**</span>
<a href="#l101.187"></a><span id="l101.187">    * Called when there is a request to close a tab.  Using aTab.allowTabClose</span>
<a href="#l101.188"></a><span id="l101.188">    * we first prevent the tab from closing so we can prompt the user</span>
<a href="#l101.189"></a><span id="l101.189">    * about saving changes, then we allow the tab to close.</span>
<a href="#l101.190"></a><span id="l101.190">    *</span>
<a href="#l101.191"></a><span id="l101.191">    * @param {Object} aTab  A tab info object</span>
<a href="#l101.192"></a><span id="l101.192">    */</span>
<a href="#l101.193"></a><span id="l101.193" class="difflineminus">-  tryCloseTab: function(aTab) {</span>
<a href="#l101.194"></a><span id="l101.194" class="difflineplus">+  tryCloseTab(aTab) {</span>
<a href="#l101.195"></a><span id="l101.195">     if (aTab.allowTabClose) {</span>
<a href="#l101.196"></a><span id="l101.196">       return true;</span>
<a href="#l101.197"></a><span id="l101.197" class="difflineminus">-    } else {</span>
<a href="#l101.198"></a><span id="l101.198" class="difflineminus">-      onCancel(aTab.iframe.id);</span>
<a href="#l101.199"></a><span id="l101.199" class="difflineminus">-      return false;</span>
<a href="#l101.200"></a><span id="l101.200">     }</span>
<a href="#l101.201"></a><span id="l101.201" class="difflineplus">+    onCancel(aTab.iframe.id);</span>
<a href="#l101.202"></a><span id="l101.202" class="difflineplus">+    return false;</span>
<a href="#l101.203"></a><span id="l101.203">   },</span>
<a href="#l101.204"></a><span id="l101.204">   /**</span>
<a href="#l101.205"></a><span id="l101.205">    * Closes a tab.</span>
<a href="#l101.206"></a><span id="l101.206">    *</span>
<a href="#l101.207"></a><span id="l101.207">    * @param {Object} aTab  A tab info object</span>
<a href="#l101.208"></a><span id="l101.208">    */</span>
<a href="#l101.209"></a><span id="l101.209" class="difflineminus">-  closeTab: function(aTab) {</span>
<a href="#l101.210"></a><span id="l101.210" class="difflineplus">+  closeTab(aTab) {</span>
<a href="#l101.211"></a><span id="l101.211">     // Remove the iframe id from the array where they are stored.</span>
<a href="#l101.212"></a><span id="l101.212">     let index = gItemTabIds.indexOf(aTab.iframe.id);</span>
<a href="#l101.213"></a><span id="l101.213">     if (index != -1) {</span>
<a href="#l101.214"></a><span id="l101.214">       gItemTabIds.splice(index, 1);</span>
<a href="#l101.215"></a><span id="l101.215">     }</span>
<a href="#l101.216"></a><span id="l101.216">     aTab.itemTabConfig = null;</span>
<a href="#l101.217"></a><span id="l101.217"> </span>
<a href="#l101.218"></a><span id="l101.218">     // If this is the last item tab that is closing, then delete</span>
<a href="#l101.219"></a><span id="l101.219" class="difflineat">@@ -295,17 +294,17 @@ var calendarItemTabType = {</span>
<a href="#l101.220"></a><span id="l101.220">     }</span>
<a href="#l101.221"></a><span id="l101.221">   },</span>
<a href="#l101.222"></a><span id="l101.222">   /**</span>
<a href="#l101.223"></a><span id="l101.223">    * Called when quitting the application (and/or closing the window).</span>
<a href="#l101.224"></a><span id="l101.224">    * Saves an open tab's state to be able to restore it later.</span>
<a href="#l101.225"></a><span id="l101.225">    *</span>
<a href="#l101.226"></a><span id="l101.226">    * @param {Object} aTab  A tab info object</span>
<a href="#l101.227"></a><span id="l101.227">    */</span>
<a href="#l101.228"></a><span id="l101.228" class="difflineminus">-  persistTab: function(aTab) {</span>
<a href="#l101.229"></a><span id="l101.229" class="difflineplus">+  persistTab(aTab) {</span>
<a href="#l101.230"></a><span id="l101.230">     let args = aTab.iframe.contentWindow.arguments[0];</span>
<a href="#l101.231"></a><span id="l101.231">     // Serialize args, with manual handling of some properties.</span>
<a href="#l101.232"></a><span id="l101.232">     // persistTab is called even for new events/tasks in tabs that</span>
<a href="#l101.233"></a><span id="l101.233">     // were closed and never saved (for 'undo close tab'</span>
<a href="#l101.234"></a><span id="l101.234">     // functionality), thus we confirm we have the expected values.</span>
<a href="#l101.235"></a><span id="l101.235">     if (</span>
<a href="#l101.236"></a><span id="l101.236">       !args ||</span>
<a href="#l101.237"></a><span id="l101.237">       !args.calendar ||</span>
<a href="#l101.238"></a><span id="l101.238" class="difflineat">@@ -323,31 +322,31 @@ var calendarItemTabType = {</span>
<a href="#l101.239"></a><span id="l101.239">     let hasDateValue = args.initialStartDateValue &amp;&amp; args.initialStartDateValue.icalString;</span>
<a href="#l101.240"></a><span id="l101.240">     let initialStartDate = hasDateValue ? args.initialStartDateValue.icalString : null;</span>
<a href="#l101.241"></a><span id="l101.241"> </span>
<a href="#l101.242"></a><span id="l101.242">     args.calendar = null;</span>
<a href="#l101.243"></a><span id="l101.243">     args.calendarEvent = null;</span>
<a href="#l101.244"></a><span id="l101.244">     args.initialStartDateValue = null;</span>
<a href="#l101.245"></a><span id="l101.245"> </span>
<a href="#l101.246"></a><span id="l101.246">     return {</span>
<a href="#l101.247"></a><span id="l101.247" class="difflineminus">-      calendarId: calendarId,</span>
<a href="#l101.248"></a><span id="l101.248" class="difflineminus">-      itemId: itemId,</span>
<a href="#l101.249"></a><span id="l101.249" class="difflineminus">-      initialStartDate: initialStartDate,</span>
<a href="#l101.250"></a><span id="l101.250" class="difflineminus">-      args: args,</span>
<a href="#l101.251"></a><span id="l101.251" class="difflineplus">+      calendarId,</span>
<a href="#l101.252"></a><span id="l101.252" class="difflineplus">+      itemId,</span>
<a href="#l101.253"></a><span id="l101.253" class="difflineplus">+      initialStartDate,</span>
<a href="#l101.254"></a><span id="l101.254" class="difflineplus">+      args,</span>
<a href="#l101.255"></a><span id="l101.255">       tabType: aTab.mode.type,</span>
<a href="#l101.256"></a><span id="l101.256">     };</span>
<a href="#l101.257"></a><span id="l101.257">   },</span>
<a href="#l101.258"></a><span id="l101.258">   /**</span>
<a href="#l101.259"></a><span id="l101.259">    * Called when starting the application (and/or opening the window).</span>
<a href="#l101.260"></a><span id="l101.260">    * Restores a tab that was open when the application was quit previously.</span>
<a href="#l101.261"></a><span id="l101.261">    *</span>
<a href="#l101.262"></a><span id="l101.262">    * @param {Object} aTabmail  The tabmail interface</span>
<a href="#l101.263"></a><span id="l101.263">    * @param {Object} aState    The state of the tab to restore</span>
<a href="#l101.264"></a><span id="l101.264">    */</span>
<a href="#l101.265"></a><span id="l101.265" class="difflineminus">-  restoreTab: function(aTabmail, aState) {</span>
<a href="#l101.266"></a><span id="l101.266" class="difflineplus">+  restoreTab(aTabmail, aState) {</span>
<a href="#l101.267"></a><span id="l101.267">     // Sometimes restoreTab is called for tabs that were never saved</span>
<a href="#l101.268"></a><span id="l101.268">     // and never meant to be persisted or restored. See persistTab.</span>
<a href="#l101.269"></a><span id="l101.269">     if (aState.args &amp;&amp; aState.calendarId &amp;&amp; aState.itemId) {</span>
<a href="#l101.270"></a><span id="l101.270">       aState.args.initialStartDateValue = aState.initialStartDate</span>
<a href="#l101.271"></a><span id="l101.271">         ? cal.createDateTime(aState.initialStartDate)</span>
<a href="#l101.272"></a><span id="l101.272">         : cal.dtz.getDefaultStartDate();</span>
<a href="#l101.273"></a><span id="l101.273"> </span>
<a href="#l101.274"></a><span id="l101.274">       aState.args.onOk = doTransaction.bind(null, &quot;modify&quot;);</span>
<a href="#l101.275"></a><span id="l101.275" class="difflineat">@@ -588,49 +587,49 @@ var FIRST_DELAY_STARTUP = 100;</span>
<a href="#l101.276"></a><span id="l101.276"> var FIRST_DELAY_RESCHEDULE = 100;</span>
<a href="#l101.277"></a><span id="l101.277"> var FIRST_DELAY_REGISTER = 10000;</span>
<a href="#l101.278"></a><span id="l101.278"> var FIRST_DELAY_UNREGISTER = 0;</span>
<a href="#l101.279"></a><span id="l101.279"> </span>
<a href="#l101.280"></a><span id="l101.280"> var gInvitationsOperationListener = {</span>
<a href="#l101.281"></a><span id="l101.281">   mCount: 0,</span>
<a href="#l101.282"></a><span id="l101.282"> </span>
<a href="#l101.283"></a><span id="l101.283">   QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l101.284"></a><span id="l101.284" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l101.285"></a><span id="l101.285" class="difflineplus">+  onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l101.286"></a><span id="l101.286">     let invitationsBox = document.getElementById(&quot;calendar-invitations-panel&quot;);</span>
<a href="#l101.287"></a><span id="l101.287">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l101.288"></a><span id="l101.288">       let value = cal.l10n.getLtnString(&quot;invitationsLink.label&quot;, [this.mCount]);</span>
<a href="#l101.289"></a><span id="l101.289">       document.getElementById(&quot;calendar-invitations-label&quot;).value = value;</span>
<a href="#l101.290"></a><span id="l101.290">       setElementValue(invitationsBox, this.mCount &lt; 1 &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l101.291"></a><span id="l101.291">     } else {</span>
<a href="#l101.292"></a><span id="l101.292">       invitationsBox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l101.293"></a><span id="l101.293">     }</span>
<a href="#l101.294"></a><span id="l101.294">     this.mCount = 0;</span>
<a href="#l101.295"></a><span id="l101.295">   },</span>
<a href="#l101.296"></a><span id="l101.296"> </span>
<a href="#l101.297"></a><span id="l101.297" class="difflineminus">-  onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l101.298"></a><span id="l101.298" class="difflineplus">+  onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l101.299"></a><span id="l101.299">     if (Components.isSuccessCode(aStatus)) {</span>
<a href="#l101.300"></a><span id="l101.300">       this.mCount += aItems.length;</span>
<a href="#l101.301"></a><span id="l101.301">     }</span>
<a href="#l101.302"></a><span id="l101.302">   },</span>
<a href="#l101.303"></a><span id="l101.303"> };</span>
<a href="#l101.304"></a><span id="l101.304"> </span>
<a href="#l101.305"></a><span id="l101.305"> var gInvitationsCalendarManagerObserver = {</span>
<a href="#l101.306"></a><span id="l101.306">   mSideBar: this,</span>
<a href="#l101.307"></a><span id="l101.307"> </span>
<a href="#l101.308"></a><span id="l101.308">   QueryInterface: ChromeUtils.generateQI([Ci.calICalendarManagerObserver]),</span>
<a href="#l101.309"></a><span id="l101.309"> </span>
<a href="#l101.310"></a><span id="l101.310" class="difflineminus">-  onCalendarRegistered: function(aCalendar) {</span>
<a href="#l101.311"></a><span id="l101.311" class="difflineplus">+  onCalendarRegistered(aCalendar) {</span>
<a href="#l101.312"></a><span id="l101.312">     this.mSideBar.rescheduleInvitationsUpdate(FIRST_DELAY_REGISTER);</span>
<a href="#l101.313"></a><span id="l101.313">   },</span>
<a href="#l101.314"></a><span id="l101.314"> </span>
<a href="#l101.315"></a><span id="l101.315" class="difflineminus">-  onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l101.316"></a><span id="l101.316" class="difflineplus">+  onCalendarUnregistering(aCalendar) {</span>
<a href="#l101.317"></a><span id="l101.317">     this.mSideBar.rescheduleInvitationsUpdate(FIRST_DELAY_UNREGISTER);</span>
<a href="#l101.318"></a><span id="l101.318">   },</span>
<a href="#l101.319"></a><span id="l101.319"> </span>
<a href="#l101.320"></a><span id="l101.320" class="difflineminus">-  onCalendarDeleting: function(aCalendar) {},</span>
<a href="#l101.321"></a><span id="l101.321" class="difflineplus">+  onCalendarDeleting(aCalendar) {},</span>
<a href="#l101.322"></a><span id="l101.322"> };</span>
<a href="#l101.323"></a><span id="l101.323"> </span>
<a href="#l101.324"></a><span id="l101.324"> function scheduleInvitationsUpdate(firstDelay) {</span>
<a href="#l101.325"></a><span id="l101.325">   gInvitationsOperationListener.mCount = 0;</span>
<a href="#l101.326"></a><span id="l101.326">   getInvitationsManager().scheduleInvitationsUpdate(firstDelay, gInvitationsOperationListener);</span>
<a href="#l101.327"></a><span id="l101.327"> }</span>
<a href="#l101.328"></a><span id="l101.328"> </span>
<a href="#l101.329"></a><span id="l101.329"> function rescheduleInvitationsUpdate(firstDelay) {</span>
<a href="#l101.330"></a><span id="l101.330" class="difflineat">@@ -747,17 +746,17 @@ function calSwitchToTaskMode() {</span>
<a href="#l101.331"></a><span id="l101.331">     document.getElementById(&quot;calMinimonth&quot;).setAttribute(&quot;freebusy&quot;, &quot;true&quot;);</span>
<a href="#l101.332"></a><span id="l101.332"> </span>
<a href="#l101.333"></a><span id="l101.333">     document.commandDispatcher.updateCommands(&quot;calendar_commands&quot;);</span>
<a href="#l101.334"></a><span id="l101.334">     window.setCursor(&quot;auto&quot;);</span>
<a href="#l101.335"></a><span id="l101.335">   }</span>
<a href="#l101.336"></a><span id="l101.336"> }</span>
<a href="#l101.337"></a><span id="l101.337"> </span>
<a href="#l101.338"></a><span id="l101.338"> var gCalSetupMailContext = {</span>
<a href="#l101.339"></a><span id="l101.339" class="difflineminus">-  popup: function() {</span>
<a href="#l101.340"></a><span id="l101.340" class="difflineplus">+  popup() {</span>
<a href="#l101.341"></a><span id="l101.341">     let hasSelection = gFolderDisplay.selectedMessage != null;</span>
<a href="#l101.342"></a><span id="l101.342">     // Disable the convert menu altogether.</span>
<a href="#l101.343"></a><span id="l101.343">     setElementValue(&quot;mailContext-calendar-convert-menu&quot;, !hasSelection &amp;&amp; &quot;true&quot;, &quot;hidden&quot;);</span>
<a href="#l101.344"></a><span id="l101.344">   },</span>
<a href="#l101.345"></a><span id="l101.345"> };</span>
<a href="#l101.346"></a><span id="l101.346"> </span>
<a href="#l101.347"></a><span id="l101.347"> // Overwrite the InitMessageMenu function, since we never know in which order</span>
<a href="#l101.348"></a><span id="l101.348"> // the popupshowing event will be processed. This function takes care of</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/calendar/lightning/modules/ltnInvitationUtils.jsm</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -13,17 +13,17 @@ this.EXPORTED_SYMBOLS = [&quot;ltn&quot;]; /* expo</span>
<a href="#l102.4"></a><span id="l102.4"> var ltn = {};</span>
<a href="#l102.5"></a><span id="l102.5"> </span>
<a href="#l102.6"></a><span id="l102.6"> ltn.invitation = {</span>
<a href="#l102.7"></a><span id="l102.7">   /**</span>
<a href="#l102.8"></a><span id="l102.8">    * Returns a header title for an ITIP item depending on the response method</span>
<a href="#l102.9"></a><span id="l102.9">    * @param  {calItipItem}     aItipItem  the itip item to check</span>
<a href="#l102.10"></a><span id="l102.10">    * @return {String}          the header title</span>
<a href="#l102.11"></a><span id="l102.11">    */</span>
<a href="#l102.12"></a><span id="l102.12" class="difflineminus">-  getItipHeader: function(aItipItem) {</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+  getItipHeader(aItipItem) {</span>
<a href="#l102.14"></a><span id="l102.14">     let header;</span>
<a href="#l102.15"></a><span id="l102.15"> </span>
<a href="#l102.16"></a><span id="l102.16">     if (aItipItem) {</span>
<a href="#l102.17"></a><span id="l102.17">       let item = aItipItem.getItemList()[0];</span>
<a href="#l102.18"></a><span id="l102.18">       let summary = item.getProperty(&quot;SUMMARY&quot;) || &quot;&quot;;</span>
<a href="#l102.19"></a><span id="l102.19">       let organizer = item.organizer;</span>
<a href="#l102.20"></a><span id="l102.20">       let organizerString = organizer ? organizer.commonName || organizer.toString() : &quot;&quot;;</span>
<a href="#l102.21"></a><span id="l102.21"> </span>
<a href="#l102.22"></a><span id="l102.22" class="difflineat">@@ -69,17 +69,17 @@ ltn.invitation = {</span>
<a href="#l102.23"></a><span id="l102.23"> </span>
<a href="#l102.24"></a><span id="l102.24">   /**</span>
<a href="#l102.25"></a><span id="l102.25">    * Returns the html representation of the event as a DOM document.</span>
<a href="#l102.26"></a><span id="l102.26">    *</span>
<a href="#l102.27"></a><span id="l102.27">    * @param  {calIItemBase} aEvent     The event to parse into html.</span>
<a href="#l102.28"></a><span id="l102.28">    * @param  {calItipItem}  aItipItem  The itip item, which contains aEvent.</span>
<a href="#l102.29"></a><span id="l102.29">    * @return {DOM}                     The html representation of aEvent.</span>
<a href="#l102.30"></a><span id="l102.30">    */</span>
<a href="#l102.31"></a><span id="l102.31" class="difflineminus">-  createInvitationOverlay: function(aEvent, aItipItem) {</span>
<a href="#l102.32"></a><span id="l102.32" class="difflineplus">+  createInvitationOverlay(aEvent, aItipItem) {</span>
<a href="#l102.33"></a><span id="l102.33">     // Creates HTML using the Node strings in the properties file</span>
<a href="#l102.34"></a><span id="l102.34">     let doc = cal.xml.parseFile(&quot;chrome://lightning/content/lightning-invitation.xhtml&quot;);</span>
<a href="#l102.35"></a><span id="l102.35">     let formatter = cal.getDateFormatter();</span>
<a href="#l102.36"></a><span id="l102.36"> </span>
<a href="#l102.37"></a><span id="l102.37">     let linkConverter = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l102.38"></a><span id="l102.38"> </span>
<a href="#l102.39"></a><span id="l102.39">     let field = function(aField, aContentText, aConvert) {</span>
<a href="#l102.40"></a><span id="l102.40">       let descr = doc.getElementById(&quot;imipHtml-&quot; + aField + &quot;-descr&quot;);</span>
<a href="#l102.41"></a><span id="l102.41" class="difflineat">@@ -287,17 +287,17 @@ ltn.invitation = {</span>
<a href="#l102.42"></a><span id="l102.42"> </span>
<a href="#l102.43"></a><span id="l102.43">   /**</span>
<a href="#l102.44"></a><span id="l102.44">    * Expects and return a serialized DOM - use cal.xml.serializeDOM(aDOM)</span>
<a href="#l102.45"></a><span id="l102.45">    * @param  {String} aOldDoc    serialized DOM of the the old document</span>
<a href="#l102.46"></a><span id="l102.46">    * @param  {String} aNewDoc    serialized DOM of the the new document</span>
<a href="#l102.47"></a><span id="l102.47">    * @param  {String} aIgnoreId  attendee id to ignore, usually the organizer</span>
<a href="#l102.48"></a><span id="l102.48">    * @return {String}            updated serialized DOM of the new document</span>
<a href="#l102.49"></a><span id="l102.49">    */</span>
<a href="#l102.50"></a><span id="l102.50" class="difflineminus">-  compareInvitationOverlay: function(aOldDoc, aNewDoc, aIgnoreId) {</span>
<a href="#l102.51"></a><span id="l102.51" class="difflineplus">+  compareInvitationOverlay(aOldDoc, aNewDoc, aIgnoreId) {</span>
<a href="#l102.52"></a><span id="l102.52">     /**</span>
<a href="#l102.53"></a><span id="l102.53">      * Transforms text node content to formatted child nodes. Decorations are defined in imip.css</span>
<a href="#l102.54"></a><span id="l102.54">      * @param {Node}    aToNode text node to change</span>
<a href="#l102.55"></a><span id="l102.55">      * @param {String}  aType   use 'newline' for the same, 'added' or 'removed' for decoration</span>
<a href="#l102.56"></a><span id="l102.56">      * @param {String}  aText   [optional]</span>
<a href="#l102.57"></a><span id="l102.57">      * @param {Boolean} aClear  [optional] for consecutive changes on the same node, set to false</span>
<a href="#l102.58"></a><span id="l102.58">      */</span>
<a href="#l102.59"></a><span id="l102.59">     function _content2Child(aToNode, aType, aText = &quot;&quot;, aClear = true) {</span>
<a href="#l102.60"></a><span id="l102.60" class="difflineat">@@ -430,17 +430,17 @@ ltn.invitation = {</span>
<a href="#l102.61"></a><span id="l102.61">   },</span>
<a href="#l102.62"></a><span id="l102.62"> </span>
<a href="#l102.63"></a><span id="l102.63">   /**</span>
<a href="#l102.64"></a><span id="l102.64">    * Returns the header section for an invitation email.</span>
<a href="#l102.65"></a><span id="l102.65">    * @param   {String}         aMessageId  the message id to use for that email</span>
<a href="#l102.66"></a><span id="l102.66">    * @param   {nsIMsgIdentity} aIdentity   the identity to use for that email</span>
<a href="#l102.67"></a><span id="l102.67">    * @returns {String}                     the source code of the header section of the email</span>
<a href="#l102.68"></a><span id="l102.68">    */</span>
<a href="#l102.69"></a><span id="l102.69" class="difflineminus">-  getHeaderSection: function(aMessageId, aIdentity, aToList, aSubject) {</span>
<a href="#l102.70"></a><span id="l102.70" class="difflineplus">+  getHeaderSection(aMessageId, aIdentity, aToList, aSubject) {</span>
<a href="#l102.71"></a><span id="l102.71">     let recipient = aIdentity.fullName + &quot; &lt;&quot; + aIdentity.email + &quot;&gt;&quot;;</span>
<a href="#l102.72"></a><span id="l102.72">     let from = aIdentity.fullName.length</span>
<a href="#l102.73"></a><span id="l102.73">       ? cal.email.validateRecipientList(recipient)</span>
<a href="#l102.74"></a><span id="l102.74">       : aIdentity.email;</span>
<a href="#l102.75"></a><span id="l102.75">     let header =</span>
<a href="#l102.76"></a><span id="l102.76">       &quot;MIME-version: 1.0\r\n&quot; +</span>
<a href="#l102.77"></a><span id="l102.77">       (aIdentity.replyTo</span>
<a href="#l102.78"></a><span id="l102.78">         ? &quot;Return-path: &quot; + ltn.invitation.encodeMimeHeader(aIdentity.replyTo, true) + &quot;\r\n&quot;</span>
<a href="#l102.79"></a><span id="l102.79" class="difflineat">@@ -480,17 +480,17 @@ ltn.invitation = {</span>
<a href="#l102.80"></a><span id="l102.80">   },</span>
<a href="#l102.81"></a><span id="l102.81"> </span>
<a href="#l102.82"></a><span id="l102.82">   /**</span>
<a href="#l102.83"></a><span id="l102.83">    * Returns a datetime string according to section 3.3 of RfC5322</span>
<a href="#l102.84"></a><span id="l102.84">    * @param  {Date}   [optional] Js Date object to format; if not provided current DateTime is used</span>
<a href="#l102.85"></a><span id="l102.85">    * @return {String}            Datetime string with a modified tz-offset notation compared to</span>
<a href="#l102.86"></a><span id="l102.86">    *                             Date.toString() like &quot;Fri, 20 Nov 2015 09:45:36 +0100&quot;</span>
<a href="#l102.87"></a><span id="l102.87">    */</span>
<a href="#l102.88"></a><span id="l102.88" class="difflineminus">-  getRfc5322FormattedDate: function(aDate = null) {</span>
<a href="#l102.89"></a><span id="l102.89" class="difflineplus">+  getRfc5322FormattedDate(aDate = null) {</span>
<a href="#l102.90"></a><span id="l102.90">     let date = aDate || new Date();</span>
<a href="#l102.91"></a><span id="l102.91">     let str = date</span>
<a href="#l102.92"></a><span id="l102.92">       .toString()</span>
<a href="#l102.93"></a><span id="l102.93">       .replace(</span>
<a href="#l102.94"></a><span id="l102.94">         /^(\w{3}) (\w{3}) (\d{2}) (\d{4}) ([0-9:]{8}) GMT([+-])(\d{4}).*$/,</span>
<a href="#l102.95"></a><span id="l102.95">         &quot;$1, $3 $2 $4 $5 $6$7&quot;</span>
<a href="#l102.96"></a><span id="l102.96">       );</span>
<a href="#l102.97"></a><span id="l102.97">     // according to section 3.3 of RfC5322, +0000 should be used for defined timezones using</span>
<a href="#l102.98"></a><span id="l102.98" class="difflineat">@@ -502,42 +502,42 @@ ltn.invitation = {</span>
<a href="#l102.99"></a><span id="l102.99">     return str;</span>
<a href="#l102.100"></a><span id="l102.100">   },</span>
<a href="#l102.101"></a><span id="l102.101"> </span>
<a href="#l102.102"></a><span id="l102.102">   /**</span>
<a href="#l102.103"></a><span id="l102.103">    * Converts a given unicode text to utf-8 and normalizes line-breaks to \r\n</span>
<a href="#l102.104"></a><span id="l102.104">    * @param  {String} aText   a unicode encoded string</span>
<a href="#l102.105"></a><span id="l102.105">    * @return {String}         the converted uft-8 encoded string</span>
<a href="#l102.106"></a><span id="l102.106">    */</span>
<a href="#l102.107"></a><span id="l102.107" class="difflineminus">-  encodeUTF8: function(aText) {</span>
<a href="#l102.108"></a><span id="l102.108" class="difflineplus">+  encodeUTF8(aText) {</span>
<a href="#l102.109"></a><span id="l102.109">     return ltn.invitation.convertFromUnicode(&quot;UTF-8&quot;, aText).replace(/(\r\n)|\n/g, &quot;\r\n&quot;);</span>
<a href="#l102.110"></a><span id="l102.110">   },</span>
<a href="#l102.111"></a><span id="l102.111"> </span>
<a href="#l102.112"></a><span id="l102.112">   /**</span>
<a href="#l102.113"></a><span id="l102.113">    * Converts a given unicode text</span>
<a href="#l102.114"></a><span id="l102.114">    * @param  {String} aCharset   target character set</span>
<a href="#l102.115"></a><span id="l102.115">    * @param  {String} aSrc       unicode text to convert</span>
<a href="#l102.116"></a><span id="l102.116">    * @return {String}            the converted string</span>
<a href="#l102.117"></a><span id="l102.117">    */</span>
<a href="#l102.118"></a><span id="l102.118" class="difflineminus">-  convertFromUnicode: function(aCharset, aSrc) {</span>
<a href="#l102.119"></a><span id="l102.119" class="difflineplus">+  convertFromUnicode(aCharset, aSrc) {</span>
<a href="#l102.120"></a><span id="l102.120">     let unicodeConverter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;].createInstance(</span>
<a href="#l102.121"></a><span id="l102.121">       Ci.nsIScriptableUnicodeConverter</span>
<a href="#l102.122"></a><span id="l102.122">     );</span>
<a href="#l102.123"></a><span id="l102.123">     unicodeConverter.charset = aCharset;</span>
<a href="#l102.124"></a><span id="l102.124">     return unicodeConverter.ConvertFromUnicode(aSrc);</span>
<a href="#l102.125"></a><span id="l102.125">   },</span>
<a href="#l102.126"></a><span id="l102.126"> </span>
<a href="#l102.127"></a><span id="l102.127">   /**</span>
<a href="#l102.128"></a><span id="l102.128">    * Converts a header to a mime encoded header</span>
<a href="#l102.129"></a><span id="l102.129">    * @param  {String}  aHeader   a header to encode</span>
<a href="#l102.130"></a><span id="l102.130">    * @param  {boolean} aIsEmail  if enabled, only the CN but not the email address gets</span>
<a href="#l102.131"></a><span id="l102.131">    *                             converted - default value is false</span>
<a href="#l102.132"></a><span id="l102.132">    * @return {String}            the encoded string</span>
<a href="#l102.133"></a><span id="l102.133">    */</span>
<a href="#l102.134"></a><span id="l102.134" class="difflineminus">-  encodeMimeHeader: function(aHeader, aIsEmail = false) {</span>
<a href="#l102.135"></a><span id="l102.135" class="difflineplus">+  encodeMimeHeader(aHeader, aIsEmail = false) {</span>
<a href="#l102.136"></a><span id="l102.136">     let fieldNameLen = aHeader.indexOf(&quot;: &quot;) + 2;</span>
<a href="#l102.137"></a><span id="l102.137">     return MailServices.mimeConverter.encodeMimePartIIStr_UTF8(</span>
<a href="#l102.138"></a><span id="l102.138">       aHeader,</span>
<a href="#l102.139"></a><span id="l102.139">       aIsEmail,</span>
<a href="#l102.140"></a><span id="l102.140">       fieldNameLen,</span>
<a href="#l102.141"></a><span id="l102.141">       Ci.nsIMimeConverter.MIME_ENCODED_WORD_SIZE</span>
<a href="#l102.142"></a><span id="l102.142">     );</span>
<a href="#l102.143"></a><span id="l102.143">   },</span>
<a href="#l102.144"></a><span id="l102.144" class="difflineat">@@ -548,17 +548,17 @@ ltn.invitation = {</span>
<a href="#l102.145"></a><span id="l102.145">    * @param  {calIEvent|calITodo} aExistingItem  The item to compare with</span>
<a href="#l102.146"></a><span id="l102.146">    * @return {JSObject}                          Objcet of result and differences of parsing</span>
<a href="#l102.147"></a><span id="l102.147">    * @return {String} JsObject.result.type       Parsing result: OK|OLDVERSION|ERROR|NODIFF</span>
<a href="#l102.148"></a><span id="l102.148">    * @return {String} JsObject.result.descr      Parsing result description</span>
<a href="#l102.149"></a><span id="l102.149">    * @return {Array}  JsObject.differences       Array of objects consisting of property, proposed</span>
<a href="#l102.150"></a><span id="l102.150">    *                                                 and original properties.</span>
<a href="#l102.151"></a><span id="l102.151">    * @return {String} JsObject.comment           A comment of the attendee, if any</span>
<a href="#l102.152"></a><span id="l102.152">    */</span>
<a href="#l102.153"></a><span id="l102.153" class="difflineminus">-  parseCounter: function(aProposedItem, aExistingItem) {</span>
<a href="#l102.154"></a><span id="l102.154" class="difflineplus">+  parseCounter(aProposedItem, aExistingItem) {</span>
<a href="#l102.155"></a><span id="l102.155">     let isEvent = cal.item.isEvent(aProposedItem);</span>
<a href="#l102.156"></a><span id="l102.156">     // atm we only support a subset of properties, for a full list see RfC 5546 section 3.2.7</span>
<a href="#l102.157"></a><span id="l102.157">     let properties = [&quot;SUMMARY&quot;, &quot;LOCATION&quot;, &quot;DTSTART&quot;, &quot;DTEND&quot;, &quot;COMMENT&quot;];</span>
<a href="#l102.158"></a><span id="l102.158">     if (!isEvent) {</span>
<a href="#l102.159"></a><span id="l102.159">       cal.LOG(&quot;Parsing of counterproposals is currently only supported for events.&quot;);</span>
<a href="#l102.160"></a><span id="l102.160">       properties = [];</span>
<a href="#l102.161"></a><span id="l102.161">     }</span>
<a href="#l102.162"></a><span id="l102.162"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavCalendar.js</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -117,17 +117,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.4"></a><span id="l103.4">   },</span>
<a href="#l103.5"></a><span id="l103.5"> </span>
<a href="#l103.6"></a><span id="l103.6">   get isCached() {</span>
<a href="#l103.7"></a><span id="l103.7">     return this != this.superCalendar;</span>
<a href="#l103.8"></a><span id="l103.8">   },</span>
<a href="#l103.9"></a><span id="l103.9"> </span>
<a href="#l103.10"></a><span id="l103.10">   mLastRedirectStatus: null,</span>
<a href="#l103.11"></a><span id="l103.11"> </span>
<a href="#l103.12"></a><span id="l103.12" class="difflineminus">-  ensureTargetCalendar: function() {</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+  ensureTargetCalendar() {</span>
<a href="#l103.14"></a><span id="l103.14">     if (!this.isCached &amp;&amp; !this.mOfflineStorage) {</span>
<a href="#l103.15"></a><span id="l103.15">       // If this is a cached calendar, the actual cache is taken care of</span>
<a href="#l103.16"></a><span id="l103.16">       // by the calCachedCalendar facade. In any other case, we use a</span>
<a href="#l103.17"></a><span id="l103.17">       // memory calendar to cache things.</span>
<a href="#l103.18"></a><span id="l103.18">       this.mOfflineStorage = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;].createInstance(</span>
<a href="#l103.19"></a><span id="l103.19">         Ci.calISyncWriteCalendar</span>
<a href="#l103.20"></a><span id="l103.20">       );</span>
<a href="#l103.21"></a><span id="l103.21"> </span>
<a href="#l103.22"></a><span id="l103.22" class="difflineat">@@ -144,35 +144,35 @@ calDavCalendar.prototype = {</span>
<a href="#l103.23"></a><span id="l103.23">   get prefChromeOverlay() {</span>
<a href="#l103.24"></a><span id="l103.24">     return null;</span>
<a href="#l103.25"></a><span id="l103.25">   },</span>
<a href="#l103.26"></a><span id="l103.26"> </span>
<a href="#l103.27"></a><span id="l103.27">   get displayName() {</span>
<a href="#l103.28"></a><span id="l103.28">     return cal.l10n.getCalString(&quot;caldavName&quot;);</span>
<a href="#l103.29"></a><span id="l103.29">   },</span>
<a href="#l103.30"></a><span id="l103.30"> </span>
<a href="#l103.31"></a><span id="l103.31" class="difflineminus">-  createCalendar: function() {</span>
<a href="#l103.32"></a><span id="l103.32" class="difflineplus">+  createCalendar() {</span>
<a href="#l103.33"></a><span id="l103.33">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l103.34"></a><span id="l103.34">   },</span>
<a href="#l103.35"></a><span id="l103.35"> </span>
<a href="#l103.36"></a><span id="l103.36" class="difflineminus">-  deleteCalendar: function(_cal, listener) {</span>
<a href="#l103.37"></a><span id="l103.37" class="difflineplus">+  deleteCalendar(_cal, listener) {</span>
<a href="#l103.38"></a><span id="l103.38">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l103.39"></a><span id="l103.39">   },</span>
<a href="#l103.40"></a><span id="l103.40"> </span>
<a href="#l103.41"></a><span id="l103.41">   // calIChangeLog interface</span>
<a href="#l103.42"></a><span id="l103.42">   get offlineStorage() {</span>
<a href="#l103.43"></a><span id="l103.43">     return this.mOfflineStorage;</span>
<a href="#l103.44"></a><span id="l103.44">   },</span>
<a href="#l103.45"></a><span id="l103.45"> </span>
<a href="#l103.46"></a><span id="l103.46">   set offlineStorage(storage) {</span>
<a href="#l103.47"></a><span id="l103.47">     this.mOfflineStorage = storage;</span>
<a href="#l103.48"></a><span id="l103.48">     this.fetchCachedMetaData();</span>
<a href="#l103.49"></a><span id="l103.49">   },</span>
<a href="#l103.50"></a><span id="l103.50"> </span>
<a href="#l103.51"></a><span id="l103.51" class="difflineminus">-  resetLog: function() {</span>
<a href="#l103.52"></a><span id="l103.52" class="difflineplus">+  resetLog() {</span>
<a href="#l103.53"></a><span id="l103.53">     if (this.isCached &amp;&amp; this.mOfflineStorage) {</span>
<a href="#l103.54"></a><span id="l103.54">       this.mOfflineStorage.startBatch();</span>
<a href="#l103.55"></a><span id="l103.55">       try {</span>
<a href="#l103.56"></a><span id="l103.56">         for (let itemId in this.mItemInfoCache) {</span>
<a href="#l103.57"></a><span id="l103.57">           this.mOfflineStorage.deleteMetaData(itemId);</span>
<a href="#l103.58"></a><span id="l103.58">           delete this.mItemInfoCache[itemId];</span>
<a href="#l103.59"></a><span id="l103.59">         }</span>
<a href="#l103.60"></a><span id="l103.60">       } finally {</span>
<a href="#l103.61"></a><span id="l103.61" class="difflineat">@@ -198,96 +198,95 @@ calDavCalendar.prototype = {</span>
<a href="#l103.62"></a><span id="l103.62">       &quot;mOutboxUrl&quot;,</span>
<a href="#l103.63"></a><span id="l103.63">       &quot;hasFreeBusy&quot;,</span>
<a href="#l103.64"></a><span id="l103.64">     ];</span>
<a href="#l103.65"></a><span id="l103.65">   },</span>
<a href="#l103.66"></a><span id="l103.66"> </span>
<a href="#l103.67"></a><span id="l103.67">   get checkedServerInfo() {</span>
<a href="#l103.68"></a><span id="l103.68">     if (Services.io.offline) {</span>
<a href="#l103.69"></a><span id="l103.69">       return true;</span>
<a href="#l103.70"></a><span id="l103.70" class="difflineminus">-    } else {</span>
<a href="#l103.71"></a><span id="l103.71" class="difflineminus">-      return this.mCheckedServerInfo;</span>
<a href="#l103.72"></a><span id="l103.72">     }</span>
<a href="#l103.73"></a><span id="l103.73" class="difflineplus">+    return this.mCheckedServerInfo;</span>
<a href="#l103.74"></a><span id="l103.74">   },</span>
<a href="#l103.75"></a><span id="l103.75"> </span>
<a href="#l103.76"></a><span id="l103.76">   set checkedServerInfo(val) {</span>
<a href="#l103.77"></a><span id="l103.77">     return (this.mCheckedServerInfo = val);</span>
<a href="#l103.78"></a><span id="l103.78">   },</span>
<a href="#l103.79"></a><span id="l103.79"> </span>
<a href="#l103.80"></a><span id="l103.80" class="difflineminus">-  saveCalendarProperties: function() {</span>
<a href="#l103.81"></a><span id="l103.81" class="difflineplus">+  saveCalendarProperties() {</span>
<a href="#l103.82"></a><span id="l103.82">     let properties = {};</span>
<a href="#l103.83"></a><span id="l103.83">     for (let property of this.offlineCachedProperties) {</span>
<a href="#l103.84"></a><span id="l103.84">       if (this[property] !== undefined) {</span>
<a href="#l103.85"></a><span id="l103.85">         properties[property] = this[property];</span>
<a href="#l103.86"></a><span id="l103.86">       }</span>
<a href="#l103.87"></a><span id="l103.87">     }</span>
<a href="#l103.88"></a><span id="l103.88">     this.mOfflineStorage.setMetaData(&quot;calendar-properties&quot;, JSON.stringify(properties));</span>
<a href="#l103.89"></a><span id="l103.89">   },</span>
<a href="#l103.90"></a><span id="l103.90" class="difflineminus">-  restoreCalendarProperties: function(data) {</span>
<a href="#l103.91"></a><span id="l103.91" class="difflineplus">+  restoreCalendarProperties(data) {</span>
<a href="#l103.92"></a><span id="l103.92">     let properties = JSON.parse(data);</span>
<a href="#l103.93"></a><span id="l103.93">     for (let property of this.offlineCachedProperties) {</span>
<a href="#l103.94"></a><span id="l103.94">       if (properties[property] !== undefined) {</span>
<a href="#l103.95"></a><span id="l103.95">         this[property] = properties[property];</span>
<a href="#l103.96"></a><span id="l103.96">       }</span>
<a href="#l103.97"></a><span id="l103.97">     }</span>
<a href="#l103.98"></a><span id="l103.98">     // migration code from bug 1299610</span>
<a href="#l103.99"></a><span id="l103.99">     if (&quot;hasAutoScheduling&quot; in properties &amp;&amp; properties.hasAutoScheduling !== undefined) {</span>
<a href="#l103.100"></a><span id="l103.100">       this.mHasAutoScheduling = properties.hasAutoScheduling;</span>
<a href="#l103.101"></a><span id="l103.101">     }</span>
<a href="#l103.102"></a><span id="l103.102">   },</span>
<a href="#l103.103"></a><span id="l103.103"> </span>
<a href="#l103.104"></a><span id="l103.104">   // in calIGenericOperationListener aListener</span>
<a href="#l103.105"></a><span id="l103.105" class="difflineminus">-  replayChangesOn: function(aChangeLogListener) {</span>
<a href="#l103.106"></a><span id="l103.106" class="difflineplus">+  replayChangesOn(aChangeLogListener) {</span>
<a href="#l103.107"></a><span id="l103.107">     if (this.checkedServerInfo) {</span>
<a href="#l103.108"></a><span id="l103.108">       this.safeRefresh(aChangeLogListener);</span>
<a href="#l103.109"></a><span id="l103.109">     } else {</span>
<a href="#l103.110"></a><span id="l103.110">       // If we haven't refreshed yet, then we should check the resource</span>
<a href="#l103.111"></a><span id="l103.111">       // type first. This will call refresh() again afterwards.</span>
<a href="#l103.112"></a><span id="l103.112">       this.setupAuthentication(aChangeLogListener);</span>
<a href="#l103.113"></a><span id="l103.113">     }</span>
<a href="#l103.114"></a><span id="l103.114">   },</span>
<a href="#l103.115"></a><span id="l103.115" class="difflineminus">-  setMetaData: function(id, path, etag, isInboxItem) {</span>
<a href="#l103.116"></a><span id="l103.116" class="difflineplus">+  setMetaData(id, path, etag, isInboxItem) {</span>
<a href="#l103.117"></a><span id="l103.117">     if (this.mOfflineStorage.setMetaData) {</span>
<a href="#l103.118"></a><span id="l103.118">       if (id) {</span>
<a href="#l103.119"></a><span id="l103.119">         let dataString = [etag, path, isInboxItem ? &quot;true&quot; : &quot;false&quot;].join(&quot;\u001A&quot;);</span>
<a href="#l103.120"></a><span id="l103.120">         this.mOfflineStorage.setMetaData(id, dataString);</span>
<a href="#l103.121"></a><span id="l103.121">       } else {</span>
<a href="#l103.122"></a><span id="l103.122">         cal.LOG(&quot;CalDAV: cannot store meta data without an id&quot;);</span>
<a href="#l103.123"></a><span id="l103.123">       }</span>
<a href="#l103.124"></a><span id="l103.124">     } else {</span>
<a href="#l103.125"></a><span id="l103.125">       cal.ERROR(&quot;CalDAV: calendar storage does not support meta data&quot;);</span>
<a href="#l103.126"></a><span id="l103.126">     }</span>
<a href="#l103.127"></a><span id="l103.127">   },</span>
<a href="#l103.128"></a><span id="l103.128"> </span>
<a href="#l103.129"></a><span id="l103.129">   /**</span>
<a href="#l103.130"></a><span id="l103.130">    * Ensure that cached items have associated meta data, otherwise server side</span>
<a href="#l103.131"></a><span id="l103.131">    * changes may not be reflected</span>
<a href="#l103.132"></a><span id="l103.132">    */</span>
<a href="#l103.133"></a><span id="l103.133" class="difflineminus">-  ensureMetaData: function() {</span>
<a href="#l103.134"></a><span id="l103.134" class="difflineplus">+  ensureMetaData() {</span>
<a href="#l103.135"></a><span id="l103.135">     let self = this;</span>
<a href="#l103.136"></a><span id="l103.136">     let refreshNeeded = false;</span>
<a href="#l103.137"></a><span id="l103.137">     let getMetaListener = {</span>
<a href="#l103.138"></a><span id="l103.138">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l103.139"></a><span id="l103.139" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l103.140"></a><span id="l103.140" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l103.141"></a><span id="l103.141">         for (let item of aItems) {</span>
<a href="#l103.142"></a><span id="l103.142">           if (!(item.id in self.mItemInfoCache)) {</span>
<a href="#l103.143"></a><span id="l103.143">             let path = self.getItemLocationPath(item);</span>
<a href="#l103.144"></a><span id="l103.144">             cal.LOG(&quot;Adding meta-data for cached item &quot; + item.id);</span>
<a href="#l103.145"></a><span id="l103.145">             self.mItemInfoCache[item.id] = {</span>
<a href="#l103.146"></a><span id="l103.146">               etag: null,</span>
<a href="#l103.147"></a><span id="l103.147">               isNew: false,</span>
<a href="#l103.148"></a><span id="l103.148">               locationPath: path,</span>
<a href="#l103.149"></a><span id="l103.149">               isInboxItem: false,</span>
<a href="#l103.150"></a><span id="l103.150">             };</span>
<a href="#l103.151"></a><span id="l103.151">             self.mHrefIndex[self.mLocationPath + path] = item.id;</span>
<a href="#l103.152"></a><span id="l103.152">             refreshNeeded = true;</span>
<a href="#l103.153"></a><span id="l103.153">           }</span>
<a href="#l103.154"></a><span id="l103.154">         }</span>
<a href="#l103.155"></a><span id="l103.155">       },</span>
<a href="#l103.156"></a><span id="l103.156" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l103.157"></a><span id="l103.157" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l103.158"></a><span id="l103.158">         if (refreshNeeded) {</span>
<a href="#l103.159"></a><span id="l103.159">           // resetting the cached ctag forces an item refresh when</span>
<a href="#l103.160"></a><span id="l103.160">           // safeRefresh is called later</span>
<a href="#l103.161"></a><span id="l103.161">           self.mCtag = null;</span>
<a href="#l103.162"></a><span id="l103.162">           self.mProposedCtag = null;</span>
<a href="#l103.163"></a><span id="l103.163">         }</span>
<a href="#l103.164"></a><span id="l103.164">       },</span>
<a href="#l103.165"></a><span id="l103.165">     };</span>
<a href="#l103.166"></a><span id="l103.166" class="difflineat">@@ -295,17 +294,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.167"></a><span id="l103.167">       Ci.calICalendar.ITEM_FILTER_ALL_ITEMS,</span>
<a href="#l103.168"></a><span id="l103.168">       0,</span>
<a href="#l103.169"></a><span id="l103.169">       null,</span>
<a href="#l103.170"></a><span id="l103.170">       null,</span>
<a href="#l103.171"></a><span id="l103.171">       getMetaListener</span>
<a href="#l103.172"></a><span id="l103.172">     );</span>
<a href="#l103.173"></a><span id="l103.173">   },</span>
<a href="#l103.174"></a><span id="l103.174"> </span>
<a href="#l103.175"></a><span id="l103.175" class="difflineminus">-  fetchCachedMetaData: function() {</span>
<a href="#l103.176"></a><span id="l103.176" class="difflineplus">+  fetchCachedMetaData() {</span>
<a href="#l103.177"></a><span id="l103.177">     cal.LOG(&quot;CalDAV: Retrieving server info from cache for &quot; + this.name);</span>
<a href="#l103.178"></a><span id="l103.178">     let cacheIds = this.mOfflineStorage.getAllMetaDataIds();</span>
<a href="#l103.179"></a><span id="l103.179">     let cacheValues = this.mOfflineStorage.getAllMetaDataValues();</span>
<a href="#l103.180"></a><span id="l103.180"> </span>
<a href="#l103.181"></a><span id="l103.181">     for (let count = 0; count &lt; cacheIds.length; count++) {</span>
<a href="#l103.182"></a><span id="l103.182">       let itemId = cacheIds[count];</span>
<a href="#l103.183"></a><span id="l103.183">       let itemData = cacheValues[count];</span>
<a href="#l103.184"></a><span id="l103.184">       if (itemId == &quot;ctag&quot;) {</span>
<a href="#l103.185"></a><span id="l103.185" class="difflineat">@@ -325,30 +324,30 @@ calDavCalendar.prototype = {</span>
<a href="#l103.186"></a><span id="l103.186">         let itemDataArray = itemData.split(&quot;\u001A&quot;);</span>
<a href="#l103.187"></a><span id="l103.187">         let etag = itemDataArray[0];</span>
<a href="#l103.188"></a><span id="l103.188">         let resourcePath = itemDataArray[1];</span>
<a href="#l103.189"></a><span id="l103.189">         let isInboxItem = itemDataArray[2];</span>
<a href="#l103.190"></a><span id="l103.190">         if (itemDataArray.length == 3) {</span>
<a href="#l103.191"></a><span id="l103.191">           this.mHrefIndex[resourcePath] = itemId;</span>
<a href="#l103.192"></a><span id="l103.192">           let locationPath = resourcePath.substr(this.mLocationPath.length);</span>
<a href="#l103.193"></a><span id="l103.193">           let item = {</span>
<a href="#l103.194"></a><span id="l103.194" class="difflineminus">-            etag: etag,</span>
<a href="#l103.195"></a><span id="l103.195" class="difflineplus">+            etag,</span>
<a href="#l103.196"></a><span id="l103.196">             isNew: false,</span>
<a href="#l103.197"></a><span id="l103.197" class="difflineminus">-            locationPath: locationPath,</span>
<a href="#l103.198"></a><span id="l103.198" class="difflineplus">+            locationPath,</span>
<a href="#l103.199"></a><span id="l103.199">             isInboxItem: isInboxItem == &quot;true&quot;,</span>
<a href="#l103.200"></a><span id="l103.200">           };</span>
<a href="#l103.201"></a><span id="l103.201">           this.mItemInfoCache[itemId] = item;</span>
<a href="#l103.202"></a><span id="l103.202">         }</span>
<a href="#l103.203"></a><span id="l103.203">       }</span>
<a href="#l103.204"></a><span id="l103.204">     }</span>
<a href="#l103.205"></a><span id="l103.205"> </span>
<a href="#l103.206"></a><span id="l103.206">     this.ensureMetaData();</span>
<a href="#l103.207"></a><span id="l103.207">   },</span>
<a href="#l103.208"></a><span id="l103.208"> </span>
<a href="#l103.209"></a><span id="l103.209" class="difflineminus">-  sendHttpRequest: function(</span>
<a href="#l103.210"></a><span id="l103.210" class="difflineplus">+  sendHttpRequest(</span>
<a href="#l103.211"></a><span id="l103.211">     aUri,</span>
<a href="#l103.212"></a><span id="l103.212">     aUploadData,</span>
<a href="#l103.213"></a><span id="l103.213">     aContentType,</span>
<a href="#l103.214"></a><span id="l103.214">     aExisting,</span>
<a href="#l103.215"></a><span id="l103.215">     aSetupChannelFunc,</span>
<a href="#l103.216"></a><span id="l103.216">     aFailureFunc,</span>
<a href="#l103.217"></a><span id="l103.217">     aUseStreamLoader = true</span>
<a href="#l103.218"></a><span id="l103.218">   ) {</span>
<a href="#l103.219"></a><span id="l103.219" class="difflineat">@@ -465,17 +464,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.220"></a><span id="l103.220">       this.mUriParams = &quot;?&quot; + parts.join(&quot;?&quot;);</span>
<a href="#l103.221"></a><span id="l103.221">     }</span>
<a href="#l103.222"></a><span id="l103.222">     if (!calSpec.endsWith(&quot;/&quot;)) {</span>
<a href="#l103.223"></a><span id="l103.223">       calSpec += &quot;/&quot;;</span>
<a href="#l103.224"></a><span id="l103.224">     }</span>
<a href="#l103.225"></a><span id="l103.225">     return Services.io.newURI(calSpec);</span>
<a href="#l103.226"></a><span id="l103.226">   },</span>
<a href="#l103.227"></a><span id="l103.227"> </span>
<a href="#l103.228"></a><span id="l103.228" class="difflineminus">-  setCalHomeSet: function(removeLastPathSegment) {</span>
<a href="#l103.229"></a><span id="l103.229" class="difflineplus">+  setCalHomeSet(removeLastPathSegment) {</span>
<a href="#l103.230"></a><span id="l103.230">     if (removeLastPathSegment) {</span>
<a href="#l103.231"></a><span id="l103.231">       let split1 = this.mUri.spec.split(&quot;?&quot;);</span>
<a href="#l103.232"></a><span id="l103.232">       let baseUrl = split1[0];</span>
<a href="#l103.233"></a><span id="l103.233">       if (baseUrl.charAt(baseUrl.length - 1) == &quot;/&quot;) {</span>
<a href="#l103.234"></a><span id="l103.234">         baseUrl = baseUrl.substring(0, baseUrl.length - 2);</span>
<a href="#l103.235"></a><span id="l103.235">       }</span>
<a href="#l103.236"></a><span id="l103.236">       let split2 = baseUrl.split(&quot;/&quot;);</span>
<a href="#l103.237"></a><span id="l103.237">       split2.pop();</span>
<a href="#l103.238"></a><span id="l103.238" class="difflineat">@@ -541,17 +540,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.239"></a><span id="l103.239">    *</span>
<a href="#l103.240"></a><span id="l103.240">    * @param aInsertString  String to append to the base uri, for example,</span>
<a href="#l103.241"></a><span id="l103.241">    *                       when creating an event this would be the</span>
<a href="#l103.242"></a><span id="l103.242">    *                       event file name (event.ics), if null, an empty</span>
<a href="#l103.243"></a><span id="l103.243">    *                       string is used.</span>
<a href="#l103.244"></a><span id="l103.244">    * @param aBaseUri       base uri (nsIURI object), if null, this.calendarUri</span>
<a href="#l103.245"></a><span id="l103.245">    *                       will be used.</span>
<a href="#l103.246"></a><span id="l103.246">    */</span>
<a href="#l103.247"></a><span id="l103.247" class="difflineminus">-  makeUri: function(aInsertString, aBaseUri) {</span>
<a href="#l103.248"></a><span id="l103.248" class="difflineplus">+  makeUri(aInsertString, aBaseUri) {</span>
<a href="#l103.249"></a><span id="l103.249">     let baseUri = aBaseUri || this.calendarUri;</span>
<a href="#l103.250"></a><span id="l103.250">     // Build a string containing the full path, decoded, so it looks like</span>
<a href="#l103.251"></a><span id="l103.251">     // this:</span>
<a href="#l103.252"></a><span id="l103.252">     // /some path/insert string.ics</span>
<a href="#l103.253"></a><span id="l103.253">     let decodedPath = this.ensureDecodedPath(baseUri.pathQueryRef) + (aInsertString || &quot;&quot;);</span>
<a href="#l103.254"></a><span id="l103.254"> </span>
<a href="#l103.255"></a><span id="l103.255">     // Build the nsIURI by specifying a string with a fully encoded path</span>
<a href="#l103.256"></a><span id="l103.256">     // the end result will be something like this:</span>
<a href="#l103.257"></a><span id="l103.257" class="difflineat">@@ -560,27 +559,26 @@ calDavCalendar.prototype = {</span>
<a href="#l103.258"></a><span id="l103.258">       baseUri.prePath + this.ensureEncodedPath(decodedPath) + (this.mUriParams || &quot;&quot;)</span>
<a href="#l103.259"></a><span id="l103.259">     );</span>
<a href="#l103.260"></a><span id="l103.260">   },</span>
<a href="#l103.261"></a><span id="l103.261"> </span>
<a href="#l103.262"></a><span id="l103.262">   get mLocationPath() {</span>
<a href="#l103.263"></a><span id="l103.263">     return this.ensureDecodedPath(this.calendarUri.pathQueryRef);</span>
<a href="#l103.264"></a><span id="l103.264">   },</span>
<a href="#l103.265"></a><span id="l103.265"> </span>
<a href="#l103.266"></a><span id="l103.266" class="difflineminus">-  getItemLocationPath: function(aItem) {</span>
<a href="#l103.267"></a><span id="l103.267" class="difflineplus">+  getItemLocationPath(aItem) {</span>
<a href="#l103.268"></a><span id="l103.268">     if (aItem.id &amp;&amp; aItem.id in this.mItemInfoCache &amp;&amp; this.mItemInfoCache[aItem.id].locationPath) {</span>
<a href="#l103.269"></a><span id="l103.269">       // modifying items use the cached location path</span>
<a href="#l103.270"></a><span id="l103.270">       return this.mItemInfoCache[aItem.id].locationPath;</span>
<a href="#l103.271"></a><span id="l103.271" class="difflineminus">-    } else {</span>
<a href="#l103.272"></a><span id="l103.272" class="difflineminus">-      // New items just use id.ics</span>
<a href="#l103.273"></a><span id="l103.273" class="difflineminus">-      return aItem.id + &quot;.ics&quot;;</span>
<a href="#l103.274"></a><span id="l103.274">     }</span>
<a href="#l103.275"></a><span id="l103.275" class="difflineplus">+    // New items just use id.ics</span>
<a href="#l103.276"></a><span id="l103.276" class="difflineplus">+    return aItem.id + &quot;.ics&quot;;</span>
<a href="#l103.277"></a><span id="l103.277">   },</span>
<a href="#l103.278"></a><span id="l103.278"> </span>
<a href="#l103.279"></a><span id="l103.279" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l103.280"></a><span id="l103.280" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l103.281"></a><span id="l103.281">     if (aName in this.mACLProperties &amp;&amp; this.mACLProperties[aName]) {</span>
<a href="#l103.282"></a><span id="l103.282">       return this.mACLProperties[aName];</span>
<a href="#l103.283"></a><span id="l103.283">     }</span>
<a href="#l103.284"></a><span id="l103.284"> </span>
<a href="#l103.285"></a><span id="l103.285">     switch (aName) {</span>
<a href="#l103.286"></a><span id="l103.286">       case &quot;organizerId&quot;:</span>
<a href="#l103.287"></a><span id="l103.287">         if (this.calendarUserAddress) {</span>
<a href="#l103.288"></a><span id="l103.288">           return this.calendarUserAddress;</span>
<a href="#l103.289"></a><span id="l103.289" class="difflineat">@@ -600,17 +598,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.290"></a><span id="l103.290">       case &quot;capabilities.autoschedule.supported&quot;:</span>
<a href="#l103.291"></a><span id="l103.291">         return this.hasAutoScheduling;</span>
<a href="#l103.292"></a><span id="l103.292">       case &quot;capabilities.username.supported&quot;:</span>
<a href="#l103.293"></a><span id="l103.293">         return true;</span>
<a href="#l103.294"></a><span id="l103.294">     }</span>
<a href="#l103.295"></a><span id="l103.295">     return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l103.296"></a><span id="l103.296">   },</span>
<a href="#l103.297"></a><span id="l103.297"> </span>
<a href="#l103.298"></a><span id="l103.298" class="difflineminus">-  promptOverwrite: function(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l103.299"></a><span id="l103.299" class="difflineplus">+  promptOverwrite(aMethod, aItem, aListener, aOldItem) {</span>
<a href="#l103.300"></a><span id="l103.300">     let overwrite = cal.provider.promptOverwrite(aMethod, aItem, aListener, aOldItem);</span>
<a href="#l103.301"></a><span id="l103.301">     if (overwrite) {</span>
<a href="#l103.302"></a><span id="l103.302">       if (aMethod == CALDAV_MODIFY_ITEM) {</span>
<a href="#l103.303"></a><span id="l103.303">         this.doModifyItem(aItem, aOldItem, aListener, true);</span>
<a href="#l103.304"></a><span id="l103.304">       } else {</span>
<a href="#l103.305"></a><span id="l103.305">         this.doDeleteItem(aItem, aListener, true, false, null);</span>
<a href="#l103.306"></a><span id="l103.306">       }</span>
<a href="#l103.307"></a><span id="l103.307">     } else {</span>
<a href="#l103.308"></a><span id="l103.308" class="difflineat">@@ -624,39 +622,39 @@ calDavCalendar.prototype = {</span>
<a href="#l103.309"></a><span id="l103.309"> </span>
<a href="#l103.310"></a><span id="l103.310">   /**</span>
<a href="#l103.311"></a><span id="l103.311">    * addItem()</span>
<a href="#l103.312"></a><span id="l103.312">    * we actually use doAdoptItem()</span>
<a href="#l103.313"></a><span id="l103.313">    *</span>
<a href="#l103.314"></a><span id="l103.314">    * @param aItem       item to add</span>
<a href="#l103.315"></a><span id="l103.315">    * @param aListener   listener for method completion</span>
<a href="#l103.316"></a><span id="l103.316">    */</span>
<a href="#l103.317"></a><span id="l103.317" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l103.318"></a><span id="l103.318" class="difflineplus">+  addItem(aItem, aListener) {</span>
<a href="#l103.319"></a><span id="l103.319">     return this.doAdoptItem(aItem.clone(), aListener);</span>
<a href="#l103.320"></a><span id="l103.320">   },</span>
<a href="#l103.321"></a><span id="l103.321"> </span>
<a href="#l103.322"></a><span id="l103.322">   /**</span>
<a href="#l103.323"></a><span id="l103.323">    * adoptItem()</span>
<a href="#l103.324"></a><span id="l103.324">    * we actually use doAdoptItem()</span>
<a href="#l103.325"></a><span id="l103.325">    *</span>
<a href="#l103.326"></a><span id="l103.326">    * @param aItem       item to check</span>
<a href="#l103.327"></a><span id="l103.327">    * @param aListener   listener for method completion</span>
<a href="#l103.328"></a><span id="l103.328">    */</span>
<a href="#l103.329"></a><span id="l103.329" class="difflineminus">-  adoptItem: function(aItem, aListener) {</span>
<a href="#l103.330"></a><span id="l103.330" class="difflineplus">+  adoptItem(aItem, aListener) {</span>
<a href="#l103.331"></a><span id="l103.331">     return this.doAdoptItem(aItem, aListener);</span>
<a href="#l103.332"></a><span id="l103.332">   },</span>
<a href="#l103.333"></a><span id="l103.333"> </span>
<a href="#l103.334"></a><span id="l103.334">   /**</span>
<a href="#l103.335"></a><span id="l103.335">    * Performs the actual addition of the item to CalDAV store</span>
<a href="#l103.336"></a><span id="l103.336">    *</span>
<a href="#l103.337"></a><span id="l103.337">    * @param aItem       item to add</span>
<a href="#l103.338"></a><span id="l103.338">    * @param aListener   listener for method completion</span>
<a href="#l103.339"></a><span id="l103.339">    * @param aIgnoreEtag flag to indicate ignoring of Etag</span>
<a href="#l103.340"></a><span id="l103.340">    */</span>
<a href="#l103.341"></a><span id="l103.341" class="difflineminus">-  doAdoptItem: function(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l103.342"></a><span id="l103.342" class="difflineplus">+  doAdoptItem(aItem, aListener, aIgnoreEtag) {</span>
<a href="#l103.343"></a><span id="l103.343">     let notifyListener = (status, detail, pure = false) =&gt; {</span>
<a href="#l103.344"></a><span id="l103.344">       let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l103.345"></a><span id="l103.345">       this[method](aListener, status, cIOL.ADD, aItem.id, detail);</span>
<a href="#l103.346"></a><span id="l103.346">     };</span>
<a href="#l103.347"></a><span id="l103.347">     if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l103.348"></a><span id="l103.348">       aItem.id = cal.getUUID();</span>
<a href="#l103.349"></a><span id="l103.349">     }</span>
<a href="#l103.350"></a><span id="l103.350"> </span>
<a href="#l103.351"></a><span id="l103.351" class="difflineat">@@ -675,17 +673,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.352"></a><span id="l103.352"> </span>
<a href="#l103.353"></a><span id="l103.353">     let locationPath = this.getItemLocationPath(parentItem);</span>
<a href="#l103.354"></a><span id="l103.354">     let itemUri = this.makeUri(locationPath);</span>
<a href="#l103.355"></a><span id="l103.355">     cal.LOG(&quot;CalDAV: itemUri.spec = &quot; + itemUri.spec);</span>
<a href="#l103.356"></a><span id="l103.356"> </span>
<a href="#l103.357"></a><span id="l103.357">     let self = this;</span>
<a href="#l103.358"></a><span id="l103.358">     let serializedItem = this.getSerializedItem(aItem);</span>
<a href="#l103.359"></a><span id="l103.359">     let addListener = {</span>
<a href="#l103.360"></a><span id="l103.360" class="difflineminus">-      onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.361"></a><span id="l103.361" class="difflineplus">+      onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.362"></a><span id="l103.362">         let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l103.363"></a><span id="l103.363">         let listenerStatus = Cr.NS_OK;</span>
<a href="#l103.364"></a><span id="l103.364">         let listenerDetail = parentItem;</span>
<a href="#l103.365"></a><span id="l103.365">         let responseStatus;</span>
<a href="#l103.366"></a><span id="l103.366">         try {</span>
<a href="#l103.367"></a><span id="l103.367">           responseStatus = request.responseStatus;</span>
<a href="#l103.368"></a><span id="l103.368"> </span>
<a href="#l103.369"></a><span id="l103.369">           if (self.verboseLogging()) {</span>
<a href="#l103.370"></a><span id="l103.370" class="difflineat">@@ -768,29 +766,29 @@ calDavCalendar.prototype = {</span>
<a href="#l103.371"></a><span id="l103.371"> </span>
<a href="#l103.372"></a><span id="l103.372">   /**</span>
<a href="#l103.373"></a><span id="l103.373">    * modifyItem(); required by calICalendar.idl</span>
<a href="#l103.374"></a><span id="l103.374">    * we actually use doModifyItem()</span>
<a href="#l103.375"></a><span id="l103.375">    *</span>
<a href="#l103.376"></a><span id="l103.376">    * @param aItem       item to check</span>
<a href="#l103.377"></a><span id="l103.377">    * @param aListener   listener for method completion</span>
<a href="#l103.378"></a><span id="l103.378">    */</span>
<a href="#l103.379"></a><span id="l103.379" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l103.380"></a><span id="l103.380" class="difflineplus">+  modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l103.381"></a><span id="l103.381">     return this.doModifyItem(aNewItem, aOldItem, aListener, false);</span>
<a href="#l103.382"></a><span id="l103.382">   },</span>
<a href="#l103.383"></a><span id="l103.383"> </span>
<a href="#l103.384"></a><span id="l103.384">   /**</span>
<a href="#l103.385"></a><span id="l103.385">    * Modifies existing item in CalDAV store.</span>
<a href="#l103.386"></a><span id="l103.386">    *</span>
<a href="#l103.387"></a><span id="l103.387">    * @param aItem       item to check</span>
<a href="#l103.388"></a><span id="l103.388">    * @param aOldItem    previous version of item to be modified</span>
<a href="#l103.389"></a><span id="l103.389">    * @param aListener   listener from original request</span>
<a href="#l103.390"></a><span id="l103.390">    * @param aIgnoreEtag ignore item etag</span>
<a href="#l103.391"></a><span id="l103.391">    */</span>
<a href="#l103.392"></a><span id="l103.392" class="difflineminus">-  doModifyItem: function(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l103.393"></a><span id="l103.393" class="difflineplus">+  doModifyItem(aNewItem, aOldItem, aListener, aIgnoreEtag) {</span>
<a href="#l103.394"></a><span id="l103.394">     let notifyListener = (status, detail, pure = false) =&gt; {</span>
<a href="#l103.395"></a><span id="l103.395">       let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l103.396"></a><span id="l103.396">       this[method](aListener, status, cIOL.MODIFY, aNewItem.id, detail);</span>
<a href="#l103.397"></a><span id="l103.397">     };</span>
<a href="#l103.398"></a><span id="l103.398">     if (aNewItem.id == null) {</span>
<a href="#l103.399"></a><span id="l103.399">       notifyListener(Cr.NS_ERROR_FAILURE, &quot;ID for modifyItem doesn't exist or is null&quot;);</span>
<a href="#l103.400"></a><span id="l103.400">       return;</span>
<a href="#l103.401"></a><span id="l103.401">     }</span>
<a href="#l103.402"></a><span id="l103.402" class="difflineat">@@ -806,17 +804,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.403"></a><span id="l103.403"> </span>
<a href="#l103.404"></a><span id="l103.404">     let eventUri = this.makeUri(this.mItemInfoCache[aNewItem.id].locationPath);</span>
<a href="#l103.405"></a><span id="l103.405"> </span>
<a href="#l103.406"></a><span id="l103.406">     let self = this;</span>
<a href="#l103.407"></a><span id="l103.407"> </span>
<a href="#l103.408"></a><span id="l103.408">     let modifiedItemICS = this.getSerializedItem(aNewItem);</span>
<a href="#l103.409"></a><span id="l103.409"> </span>
<a href="#l103.410"></a><span id="l103.410">     let modListener = {</span>
<a href="#l103.411"></a><span id="l103.411" class="difflineminus">-      onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.412"></a><span id="l103.412" class="difflineplus">+      onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.413"></a><span id="l103.413">         let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l103.414"></a><span id="l103.414">         let listenerStatus = Cr.NS_OK;</span>
<a href="#l103.415"></a><span id="l103.415">         let listenerDetail = aNewItem;</span>
<a href="#l103.416"></a><span id="l103.416">         let responseStatus;</span>
<a href="#l103.417"></a><span id="l103.417">         try {</span>
<a href="#l103.418"></a><span id="l103.418">           responseStatus = request.responseStatus;</span>
<a href="#l103.419"></a><span id="l103.419"> </span>
<a href="#l103.420"></a><span id="l103.420">           if (self.verboseLogging()) {</span>
<a href="#l103.421"></a><span id="l103.421" class="difflineat">@@ -898,30 +896,30 @@ calDavCalendar.prototype = {</span>
<a href="#l103.422"></a><span id="l103.422"> </span>
<a href="#l103.423"></a><span id="l103.423">   /**</span>
<a href="#l103.424"></a><span id="l103.424">    * deleteItem(); required by calICalendar.idl</span>
<a href="#l103.425"></a><span id="l103.425">    * the actual deletion is done in doDeleteItem()</span>
<a href="#l103.426"></a><span id="l103.426">    *</span>
<a href="#l103.427"></a><span id="l103.427">    * @param aItem       item to delete</span>
<a href="#l103.428"></a><span id="l103.428">    * @param aListener   listener for method completion</span>
<a href="#l103.429"></a><span id="l103.429">    */</span>
<a href="#l103.430"></a><span id="l103.430" class="difflineminus">-  deleteItem: function(aItem, aListener) {</span>
<a href="#l103.431"></a><span id="l103.431" class="difflineplus">+  deleteItem(aItem, aListener) {</span>
<a href="#l103.432"></a><span id="l103.432">     return this.doDeleteItem(aItem, aListener, false, null, null);</span>
<a href="#l103.433"></a><span id="l103.433">   },</span>
<a href="#l103.434"></a><span id="l103.434"> </span>
<a href="#l103.435"></a><span id="l103.435">   /**</span>
<a href="#l103.436"></a><span id="l103.436">    * Deletes item from CalDAV store.</span>
<a href="#l103.437"></a><span id="l103.437">    *</span>
<a href="#l103.438"></a><span id="l103.438">    * @param aItem       item to delete</span>
<a href="#l103.439"></a><span id="l103.439">    * @param aListener   listener for method completion</span>
<a href="#l103.440"></a><span id="l103.440">    * @param aIgnoreEtag ignore item etag</span>
<a href="#l103.441"></a><span id="l103.441">    * @param aFromInbox  delete from inbox rather than calendar</span>
<a href="#l103.442"></a><span id="l103.442">    * @param aUri        uri of item to delete</span>
<a href="#l103.443"></a><span id="l103.443">    * */</span>
<a href="#l103.444"></a><span id="l103.444" class="difflineminus">-  doDeleteItem: function(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l103.445"></a><span id="l103.445" class="difflineplus">+  doDeleteItem(aItem, aListener, aIgnoreEtag, aFromInbox, aUri) {</span>
<a href="#l103.446"></a><span id="l103.446">     let notifyListener = (status, detail, pure = false) =&gt; {</span>
<a href="#l103.447"></a><span id="l103.447">       let method = pure ? &quot;notifyPureOperationComplete&quot; : &quot;notifyOperationComplete&quot;;</span>
<a href="#l103.448"></a><span id="l103.448">       this[method](aListener, status, cIOL.DELETE, aItem.id, detail);</span>
<a href="#l103.449"></a><span id="l103.449">     };</span>
<a href="#l103.450"></a><span id="l103.450"> </span>
<a href="#l103.451"></a><span id="l103.451">     if (aItem.id == null) {</span>
<a href="#l103.452"></a><span id="l103.452">       notifyListener(Cr.NS_ERROR_FAILURE, &quot;ID doesn't exist for deleteItem&quot;);</span>
<a href="#l103.453"></a><span id="l103.453">       return;</span>
<a href="#l103.454"></a><span id="l103.454" class="difflineat">@@ -942,17 +940,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.455"></a><span id="l103.455">         &quot;eventUri and calendarUri paths are the same, will not go on to delete entire calendar&quot;</span>
<a href="#l103.456"></a><span id="l103.456">       );</span>
<a href="#l103.457"></a><span id="l103.457">       return;</span>
<a href="#l103.458"></a><span id="l103.458">     }</span>
<a href="#l103.459"></a><span id="l103.459"> </span>
<a href="#l103.460"></a><span id="l103.460">     let self = this;</span>
<a href="#l103.461"></a><span id="l103.461"> </span>
<a href="#l103.462"></a><span id="l103.462">     let delListener = {</span>
<a href="#l103.463"></a><span id="l103.463" class="difflineminus">-      onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.464"></a><span id="l103.464" class="difflineplus">+      onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.465"></a><span id="l103.465">         let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l103.466"></a><span id="l103.466">         let listenerStatus = Cr.NS_OK;</span>
<a href="#l103.467"></a><span id="l103.467">         let listenerDetail = aItem;</span>
<a href="#l103.468"></a><span id="l103.468">         let responseStatus;</span>
<a href="#l103.469"></a><span id="l103.469">         try {</span>
<a href="#l103.470"></a><span id="l103.470">           responseStatus = request.responseStatus;</span>
<a href="#l103.471"></a><span id="l103.471"> </span>
<a href="#l103.472"></a><span id="l103.472">           if (self.verboseLogging()) {</span>
<a href="#l103.473"></a><span id="l103.473" class="difflineat">@@ -1024,17 +1022,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.474"></a><span id="l103.474">         }</span>
<a href="#l103.475"></a><span id="l103.475"> </span>
<a href="#l103.476"></a><span id="l103.476">         // Finally, notify listener.</span>
<a href="#l103.477"></a><span id="l103.477">         notifyListener(listenerStatus, listenerDetail);</span>
<a href="#l103.478"></a><span id="l103.478">       },</span>
<a href="#l103.479"></a><span id="l103.479">     };</span>
<a href="#l103.480"></a><span id="l103.480"> </span>
<a href="#l103.481"></a><span id="l103.481">     let delListener2 = {</span>
<a href="#l103.482"></a><span id="l103.482" class="difflineminus">-      onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.483"></a><span id="l103.483" class="difflineplus">+      onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.484"></a><span id="l103.484">         let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l103.485"></a><span id="l103.485">         let listenerStatus = Cr.NS_OK;</span>
<a href="#l103.486"></a><span id="l103.486">         let listenerDetail = aItem;</span>
<a href="#l103.487"></a><span id="l103.487">         let responseStatus;</span>
<a href="#l103.488"></a><span id="l103.488">         try {</span>
<a href="#l103.489"></a><span id="l103.489">           responseStatus = request.responseStatus;</span>
<a href="#l103.490"></a><span id="l103.490"> </span>
<a href="#l103.491"></a><span id="l103.491">           if (self.verboseLogging()) {</span>
<a href="#l103.492"></a><span id="l103.492" class="difflineat">@@ -1093,17 +1091,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.493"></a><span id="l103.493">   /**</span>
<a href="#l103.494"></a><span id="l103.494">    * Add an item to the target calendar</span>
<a href="#l103.495"></a><span id="l103.495">    *</span>
<a href="#l103.496"></a><span id="l103.496">    * @param path      Item path MUST NOT BE ENCODED</span>
<a href="#l103.497"></a><span id="l103.497">    * @param calData   iCalendar string representation of the item</span>
<a href="#l103.498"></a><span id="l103.498">    * @param aUri      Base URI of the request</span>
<a href="#l103.499"></a><span id="l103.499">    * @param aListener Listener</span>
<a href="#l103.500"></a><span id="l103.500">    */</span>
<a href="#l103.501"></a><span id="l103.501" class="difflineminus">-  addTargetCalendarItem: function(path, calData, aUri, etag, aListener) {</span>
<a href="#l103.502"></a><span id="l103.502" class="difflineplus">+  addTargetCalendarItem(path, calData, aUri, etag, aListener) {</span>
<a href="#l103.503"></a><span id="l103.503">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l103.504"></a><span id="l103.504">     // aUri.pathQueryRef may contain double slashes whereas path does not</span>
<a href="#l103.505"></a><span id="l103.505">     // this confuses our counting, so remove multiple successive slashes</span>
<a href="#l103.506"></a><span id="l103.506">     let strippedUriPath = aUri.pathQueryRef.replace(/\/{2,}/g, &quot;/&quot;);</span>
<a href="#l103.507"></a><span id="l103.507">     let uriPathComponentLength = strippedUriPath.split(&quot;/&quot;).length;</span>
<a href="#l103.508"></a><span id="l103.508">     try {</span>
<a href="#l103.509"></a><span id="l103.509">       parser.parseString(calData);</span>
<a href="#l103.510"></a><span id="l103.510">     } catch (e) {</span>
<a href="#l103.511"></a><span id="l103.511" class="difflineat">@@ -1201,17 +1199,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.512"></a><span id="l103.512">     }</span>
<a href="#l103.513"></a><span id="l103.513">   },</span>
<a href="#l103.514"></a><span id="l103.514"> </span>
<a href="#l103.515"></a><span id="l103.515">   /**</span>
<a href="#l103.516"></a><span id="l103.516">    * Deletes an item from the target calendar</span>
<a href="#l103.517"></a><span id="l103.517">    *</span>
<a href="#l103.518"></a><span id="l103.518">    * @param path Path of the item to delete, must not be encoded</span>
<a href="#l103.519"></a><span id="l103.519">    */</span>
<a href="#l103.520"></a><span id="l103.520" class="difflineminus">-  deleteTargetCalendarItem: async function(path) {</span>
<a href="#l103.521"></a><span id="l103.521" class="difflineplus">+  async deleteTargetCalendarItem(path) {</span>
<a href="#l103.522"></a><span id="l103.522">     let pcal = cal.async.promisifyCalendar(this.mOfflineStorage);</span>
<a href="#l103.523"></a><span id="l103.523"> </span>
<a href="#l103.524"></a><span id="l103.524">     let foundItem = (await pcal.getItem(this.mHrefIndex[path]))[0];</span>
<a href="#l103.525"></a><span id="l103.525">     let wasInboxItem = this.mItemInfoCache[foundItem.id].isInboxItem;</span>
<a href="#l103.526"></a><span id="l103.526">     if ((wasInboxItem &amp;&amp; this.isInbox(path)) || (wasInboxItem === false &amp;&amp; !this.isInbox(path))) {</span>
<a href="#l103.527"></a><span id="l103.527">       cal.LOG(&quot;CalDAV: deleting item: &quot; + path + &quot;, uid: &quot; + foundItem.id);</span>
<a href="#l103.528"></a><span id="l103.528">       delete this.mHrefIndex[path];</span>
<a href="#l103.529"></a><span id="l103.529">       delete this.mItemInfoCache[foundItem.id];</span>
<a href="#l103.530"></a><span id="l103.530" class="difflineat">@@ -1225,17 +1223,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.531"></a><span id="l103.531">   /**</span>
<a href="#l103.532"></a><span id="l103.532">    * Perform tasks required after updating items in the calendar such as</span>
<a href="#l103.533"></a><span id="l103.533">    * notifying the observers and listeners</span>
<a href="#l103.534"></a><span id="l103.534">    *</span>
<a href="#l103.535"></a><span id="l103.535">    * @param aChangeLogListener    Change log listener</span>
<a href="#l103.536"></a><span id="l103.536">    * @param calendarURI           URI of the calendar whose items just got</span>
<a href="#l103.537"></a><span id="l103.537">    *                              changed</span>
<a href="#l103.538"></a><span id="l103.538">    */</span>
<a href="#l103.539"></a><span id="l103.539" class="difflineminus">-  finalizeUpdatedItems: function(aChangeLogListener, calendarURI) {</span>
<a href="#l103.540"></a><span id="l103.540" class="difflineplus">+  finalizeUpdatedItems(aChangeLogListener, calendarURI) {</span>
<a href="#l103.541"></a><span id="l103.541">     cal.LOG(</span>
<a href="#l103.542"></a><span id="l103.542">       &quot;aChangeLogListener=&quot; +</span>
<a href="#l103.543"></a><span id="l103.543">         aChangeLogListener +</span>
<a href="#l103.544"></a><span id="l103.544">         &quot;\n&quot; +</span>
<a href="#l103.545"></a><span id="l103.545">         &quot;calendarURI=&quot; +</span>
<a href="#l103.546"></a><span id="l103.546">         (calendarURI ? calendarURI.spec : &quot;undefined&quot;) +</span>
<a href="#l103.547"></a><span id="l103.547">         &quot; \n&quot; +</span>
<a href="#l103.548"></a><span id="l103.548">         &quot;iscached=&quot; +</span>
<a href="#l103.549"></a><span id="l103.549" class="difflineat">@@ -1269,17 +1267,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.550"></a><span id="l103.550"> </span>
<a href="#l103.551"></a><span id="l103.551">   /**</span>
<a href="#l103.552"></a><span id="l103.552">    * Notifies the caller that a get request has failed.</span>
<a href="#l103.553"></a><span id="l103.553">    *</span>
<a href="#l103.554"></a><span id="l103.554">    * @param errorMsg           Error message</span>
<a href="#l103.555"></a><span id="l103.555">    * @param aListener          (optional) Listener of the request</span>
<a href="#l103.556"></a><span id="l103.556">    * @param aChangeLogListener (optional)Listener for cached calendars</span>
<a href="#l103.557"></a><span id="l103.557">    */</span>
<a href="#l103.558"></a><span id="l103.558" class="difflineminus">-  notifyGetFailed: function(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l103.559"></a><span id="l103.559" class="difflineplus">+  notifyGetFailed(errorMsg, aListener, aChangeLogListener) {</span>
<a href="#l103.560"></a><span id="l103.560">     cal.WARN(&quot;CalDAV: Get failed: &quot; + errorMsg);</span>
<a href="#l103.561"></a><span id="l103.561"> </span>
<a href="#l103.562"></a><span id="l103.562">     // Notify changelog listener</span>
<a href="#l103.563"></a><span id="l103.563">     if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l103.564"></a><span id="l103.564">       aChangeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l103.565"></a><span id="l103.565">     }</span>
<a href="#l103.566"></a><span id="l103.566"> </span>
<a href="#l103.567"></a><span id="l103.567">     // Notify operation listener</span>
<a href="#l103.568"></a><span id="l103.568" class="difflineat">@@ -1304,17 +1302,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.569"></a><span id="l103.569"> </span>
<a href="#l103.570"></a><span id="l103.570">   /**</span>
<a href="#l103.571"></a><span id="l103.571">    * Retrieves a specific item from the CalDAV store.</span>
<a href="#l103.572"></a><span id="l103.572">    * Use when an outdated copy of the item is in hand.</span>
<a href="#l103.573"></a><span id="l103.573">    *</span>
<a href="#l103.574"></a><span id="l103.574">    * @param aItem       item to fetch</span>
<a href="#l103.575"></a><span id="l103.575">    * @param aListener   listener for method completion</span>
<a href="#l103.576"></a><span id="l103.576">    */</span>
<a href="#l103.577"></a><span id="l103.577" class="difflineminus">-  getUpdatedItem: function(aItem, aListener, aChangeLogListener) {</span>
<a href="#l103.578"></a><span id="l103.578" class="difflineplus">+  getUpdatedItem(aItem, aListener, aChangeLogListener) {</span>
<a href="#l103.579"></a><span id="l103.579">     if (aItem == null) {</span>
<a href="#l103.580"></a><span id="l103.580">       this.notifyOperationComplete(</span>
<a href="#l103.581"></a><span id="l103.581">         aListener,</span>
<a href="#l103.582"></a><span id="l103.582">         Cr.NS_ERROR_FAILURE,</span>
<a href="#l103.583"></a><span id="l103.583">         cIOL.GET,</span>
<a href="#l103.584"></a><span id="l103.584">         null,</span>
<a href="#l103.585"></a><span id="l103.585">         &quot;passed in null item&quot;</span>
<a href="#l103.586"></a><span id="l103.586">       );</span>
<a href="#l103.587"></a><span id="l103.587" class="difflineat">@@ -1332,72 +1330,72 @@ calDavCalendar.prototype = {</span>
<a href="#l103.588"></a><span id="l103.588">       false,</span>
<a href="#l103.589"></a><span id="l103.589">       aListener,</span>
<a href="#l103.590"></a><span id="l103.590">       aChangeLogListener</span>
<a href="#l103.591"></a><span id="l103.591">     );</span>
<a href="#l103.592"></a><span id="l103.592">     multiget.doMultiGet();</span>
<a href="#l103.593"></a><span id="l103.593">   },</span>
<a href="#l103.594"></a><span id="l103.594"> </span>
<a href="#l103.595"></a><span id="l103.595">   // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l103.596"></a><span id="l103.596" class="difflineminus">-  getItem: function(aId, aListener) {</span>
<a href="#l103.597"></a><span id="l103.597" class="difflineplus">+  getItem(aId, aListener) {</span>
<a href="#l103.598"></a><span id="l103.598">     this.mOfflineStorage.getItem(aId, aListener);</span>
<a href="#l103.599"></a><span id="l103.599">   },</span>
<a href="#l103.600"></a><span id="l103.600"> </span>
<a href="#l103.601"></a><span id="l103.601">   // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l103.602"></a><span id="l103.602">   //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l103.603"></a><span id="l103.603">   //                in calIOperationListener aListener );</span>
<a href="#l103.604"></a><span id="l103.604" class="difflineminus">-  getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l103.605"></a><span id="l103.605" class="difflineplus">+  getItems(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l103.606"></a><span id="l103.606">     if (this.isCached) {</span>
<a href="#l103.607"></a><span id="l103.607">       if (this.mOfflineStorage) {</span>
<a href="#l103.608"></a><span id="l103.608">         this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l103.609"></a><span id="l103.609">       } else {</span>
<a href="#l103.610"></a><span id="l103.610">         this.notifyOperationComplete(aListener, Cr.NS_OK, cIOL.GET, null, null);</span>
<a href="#l103.611"></a><span id="l103.611">       }</span>
<a href="#l103.612"></a><span id="l103.612">     } else if (</span>
<a href="#l103.613"></a><span id="l103.613">       this.checkedServerInfo ||</span>
<a href="#l103.614"></a><span id="l103.614">       this.getProperty(&quot;currentStatus&quot;) == Ci.calIErrors.READ_FAILED</span>
<a href="#l103.615"></a><span id="l103.615">     ) {</span>
<a href="#l103.616"></a><span id="l103.616">       this.mOfflineStorage.getItems(...arguments);</span>
<a href="#l103.617"></a><span id="l103.617">     } else {</span>
<a href="#l103.618"></a><span id="l103.618">       this.mQueuedQueries.push(Array.from(arguments));</span>
<a href="#l103.619"></a><span id="l103.619">     }</span>
<a href="#l103.620"></a><span id="l103.620">   },</span>
<a href="#l103.621"></a><span id="l103.621"> </span>
<a href="#l103.622"></a><span id="l103.622" class="difflineminus">-  fillACLProperties: function() {</span>
<a href="#l103.623"></a><span id="l103.623" class="difflineplus">+  fillACLProperties() {</span>
<a href="#l103.624"></a><span id="l103.624">     let orgId = this.calendarUserAddress;</span>
<a href="#l103.625"></a><span id="l103.625">     if (orgId) {</span>
<a href="#l103.626"></a><span id="l103.626">       this.mACLProperties.organizerId = orgId;</span>
<a href="#l103.627"></a><span id="l103.627">     }</span>
<a href="#l103.628"></a><span id="l103.628"> </span>
<a href="#l103.629"></a><span id="l103.629">     if (this.mACLEntry &amp;&amp; this.mACLEntry.hasAccessControl) {</span>
<a href="#l103.630"></a><span id="l103.630">       let ownerIdentities = this.mACLEntry.getOwnerIdentities();</span>
<a href="#l103.631"></a><span id="l103.631">       if (ownerIdentities.length &gt; 0) {</span>
<a href="#l103.632"></a><span id="l103.632">         let identity = ownerIdentities[0];</span>
<a href="#l103.633"></a><span id="l103.633">         this.mACLProperties.organizerId = identity.email;</span>
<a href="#l103.634"></a><span id="l103.634">         this.mACLProperties.organizerCN = identity.fullName;</span>
<a href="#l103.635"></a><span id="l103.635">         this.mACLProperties[&quot;imip.identity&quot;] = identity;</span>
<a href="#l103.636"></a><span id="l103.636">       }</span>
<a href="#l103.637"></a><span id="l103.637">     }</span>
<a href="#l103.638"></a><span id="l103.638">   },</span>
<a href="#l103.639"></a><span id="l103.639"> </span>
<a href="#l103.640"></a><span id="l103.640" class="difflineminus">-  safeRefresh: function(aChangeLogListener) {</span>
<a href="#l103.641"></a><span id="l103.641" class="difflineplus">+  safeRefresh(aChangeLogListener) {</span>
<a href="#l103.642"></a><span id="l103.642">     let notifyListener = status =&gt; {</span>
<a href="#l103.643"></a><span id="l103.643">       if (this.isCached &amp;&amp; aChangeLogListener) {</span>
<a href="#l103.644"></a><span id="l103.644" class="difflineminus">-        aChangeLogListener.onResult({ status: status }, status);</span>
<a href="#l103.645"></a><span id="l103.645" class="difflineplus">+        aChangeLogListener.onResult({ status }, status);</span>
<a href="#l103.646"></a><span id="l103.646">       }</span>
<a href="#l103.647"></a><span id="l103.647">     };</span>
<a href="#l103.648"></a><span id="l103.648"> </span>
<a href="#l103.649"></a><span id="l103.649">     if (!this.mACLEntry) {</span>
<a href="#l103.650"></a><span id="l103.650">       let self = this;</span>
<a href="#l103.651"></a><span id="l103.651">       let opListener = {</span>
<a href="#l103.652"></a><span id="l103.652">         QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l103.653"></a><span id="l103.653" class="difflineminus">-        onGetResult: function(calendar, status, itemType, detail, items) {</span>
<a href="#l103.654"></a><span id="l103.654" class="difflineplus">+        onGetResult(calendar, status, itemType, detail, items) {</span>
<a href="#l103.655"></a><span id="l103.655">           cal.ASSERT(false, &quot;unexpected!&quot;);</span>
<a href="#l103.656"></a><span id="l103.656">         },</span>
<a href="#l103.657"></a><span id="l103.657" class="difflineminus">-        onOperationComplete: function(opCalendar, opStatus, opType, opId, opDetail) {</span>
<a href="#l103.658"></a><span id="l103.658" class="difflineplus">+        onOperationComplete(opCalendar, opStatus, opType, opId, opDetail) {</span>
<a href="#l103.659"></a><span id="l103.659">           self.mACLEntry = opDetail;</span>
<a href="#l103.660"></a><span id="l103.660">           self.fillACLProperties();</span>
<a href="#l103.661"></a><span id="l103.661">           self.safeRefresh(aChangeLogListener);</span>
<a href="#l103.662"></a><span id="l103.662">         },</span>
<a href="#l103.663"></a><span id="l103.663">       };</span>
<a href="#l103.664"></a><span id="l103.664"> </span>
<a href="#l103.665"></a><span id="l103.665">       this.aclManager.getCalendarEntry(this, opListener);</span>
<a href="#l103.666"></a><span id="l103.666">       return;</span>
<a href="#l103.667"></a><span id="l103.667" class="difflineat">@@ -1523,21 +1521,21 @@ calDavCalendar.prototype = {</span>
<a href="#l103.668"></a><span id="l103.668">         return streamListener;</span>
<a href="#l103.669"></a><span id="l103.669">       },</span>
<a href="#l103.670"></a><span id="l103.670">       () =&gt; {</span>
<a href="#l103.671"></a><span id="l103.671">         notifyListener(Cr.NS_ERROR_NOT_AVAILABLE);</span>
<a href="#l103.672"></a><span id="l103.672">       }</span>
<a href="#l103.673"></a><span id="l103.673">     );</span>
<a href="#l103.674"></a><span id="l103.674">   },</span>
<a href="#l103.675"></a><span id="l103.675"> </span>
<a href="#l103.676"></a><span id="l103.676" class="difflineminus">-  refresh: function() {</span>
<a href="#l103.677"></a><span id="l103.677" class="difflineplus">+  refresh() {</span>
<a href="#l103.678"></a><span id="l103.678">     this.replayChangesOn(null);</span>
<a href="#l103.679"></a><span id="l103.679">   },</span>
<a href="#l103.680"></a><span id="l103.680"> </span>
<a href="#l103.681"></a><span id="l103.681" class="difflineminus">-  firstInRealm: function() {</span>
<a href="#l103.682"></a><span id="l103.682" class="difflineplus">+  firstInRealm() {</span>
<a href="#l103.683"></a><span id="l103.683">     let calendars = cal.getCalendarManager().getCalendars();</span>
<a href="#l103.684"></a><span id="l103.684">     for (let i = 0; i &lt; calendars.length; i++) {</span>
<a href="#l103.685"></a><span id="l103.685">       if (calendars[i].type != &quot;caldav&quot; || calendars[i].getProperty(&quot;disabled&quot;)) {</span>
<a href="#l103.686"></a><span id="l103.686">         continue;</span>
<a href="#l103.687"></a><span id="l103.687">       }</span>
<a href="#l103.688"></a><span id="l103.688">       // XXX We should probably expose the inner calendar via an</span>
<a href="#l103.689"></a><span id="l103.689">       // interface, but for now use wrappedJSObject.</span>
<a href="#l103.690"></a><span id="l103.690">       let calendar = calendars[i].wrappedJSObject;</span>
<a href="#l103.691"></a><span id="l103.691" class="difflineat">@@ -1559,17 +1557,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.692"></a><span id="l103.692">    *</span>
<a href="#l103.693"></a><span id="l103.693">    * @param aUri                  The uri to request the items from.</span>
<a href="#l103.694"></a><span id="l103.694">    *                                NOTE: This must be the uri without any uri</span>
<a href="#l103.695"></a><span id="l103.695">    *                                     params. They will be appended in this</span>
<a href="#l103.696"></a><span id="l103.696">    *                                     function.</span>
<a href="#l103.697"></a><span id="l103.697">    * @param aChangeLogListener    (optional) The listener to notify for cached</span>
<a href="#l103.698"></a><span id="l103.698">    *                                         calendars.</span>
<a href="#l103.699"></a><span id="l103.699">    */</span>
<a href="#l103.700"></a><span id="l103.700" class="difflineminus">-  getUpdatedItems: function(aUri, aChangeLogListener) {</span>
<a href="#l103.701"></a><span id="l103.701" class="difflineplus">+  getUpdatedItems(aUri, aChangeLogListener) {</span>
<a href="#l103.702"></a><span id="l103.702">     if (this.mDisabled) {</span>
<a href="#l103.703"></a><span id="l103.703">       // check if maybe our calendar has become available</span>
<a href="#l103.704"></a><span id="l103.704">       this.setupAuthentication(aChangeLogListener);</span>
<a href="#l103.705"></a><span id="l103.705">       return;</span>
<a href="#l103.706"></a><span id="l103.706">     }</span>
<a href="#l103.707"></a><span id="l103.707"> </span>
<a href="#l103.708"></a><span id="l103.708">     if (this.mHasWebdavSyncSupport) {</span>
<a href="#l103.709"></a><span id="l103.709">       let webDavSync = new webDavSyncHandler(this, aUri, aChangeLogListener);</span>
<a href="#l103.710"></a><span id="l103.710" class="difflineat">@@ -1619,24 +1617,24 @@ calDavCalendar.prototype = {</span>
<a href="#l103.711"></a><span id="l103.711">    * @see calProviderUtils.jsm</span>
<a href="#l103.712"></a><span id="l103.712">    */</span>
<a href="#l103.713"></a><span id="l103.713">   getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l103.714"></a><span id="l103.714"> </span>
<a href="#l103.715"></a><span id="l103.715">   //</span>
<a href="#l103.716"></a><span id="l103.716">   // Helper functions</span>
<a href="#l103.717"></a><span id="l103.717">   //</span>
<a href="#l103.718"></a><span id="l103.718"> </span>
<a href="#l103.719"></a><span id="l103.719" class="difflineminus">-  oauthConnect: function(authSuccessCb, authFailureCb, aRefresh = false) {</span>
<a href="#l103.720"></a><span id="l103.720" class="difflineplus">+  oauthConnect(authSuccessCb, authFailureCb, aRefresh = false) {</span>
<a href="#l103.721"></a><span id="l103.721">     // Use the async prompter to avoid multiple master password prompts</span>
<a href="#l103.722"></a><span id="l103.722">     let self = this;</span>
<a href="#l103.723"></a><span id="l103.723">     let promptlistener = {</span>
<a href="#l103.724"></a><span id="l103.724" class="difflineminus">-      onPromptStartAsync: function(callback) {</span>
<a href="#l103.725"></a><span id="l103.725" class="difflineplus">+      onPromptStartAsync(callback) {</span>
<a href="#l103.726"></a><span id="l103.726">         this.onPromptAuthAvailable(callback);</span>
<a href="#l103.727"></a><span id="l103.727">       },</span>
<a href="#l103.728"></a><span id="l103.728" class="difflineminus">-      onPromptAuthAvailable: function(callback) {</span>
<a href="#l103.729"></a><span id="l103.729" class="difflineplus">+      onPromptAuthAvailable(callback) {</span>
<a href="#l103.730"></a><span id="l103.730">         self.oauth.connect(</span>
<a href="#l103.731"></a><span id="l103.731">           () =&gt; {</span>
<a href="#l103.732"></a><span id="l103.732">             authSuccessCb();</span>
<a href="#l103.733"></a><span id="l103.733">             if (callback) {</span>
<a href="#l103.734"></a><span id="l103.734">               callback.onAuthResult(true);</span>
<a href="#l103.735"></a><span id="l103.735">             }</span>
<a href="#l103.736"></a><span id="l103.736">           },</span>
<a href="#l103.737"></a><span id="l103.737">           () =&gt; {</span>
<a href="#l103.738"></a><span id="l103.738" class="difflineat">@@ -1645,17 +1643,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.739"></a><span id="l103.739">               callback.onAuthResult(false);</span>
<a href="#l103.740"></a><span id="l103.740">             }</span>
<a href="#l103.741"></a><span id="l103.741">           },</span>
<a href="#l103.742"></a><span id="l103.742">           true,</span>
<a href="#l103.743"></a><span id="l103.743">           aRefresh</span>
<a href="#l103.744"></a><span id="l103.744">         );</span>
<a href="#l103.745"></a><span id="l103.745">       },</span>
<a href="#l103.746"></a><span id="l103.746">       onPromptCanceled: authFailureCb,</span>
<a href="#l103.747"></a><span id="l103.747" class="difflineminus">-      onPromptStart: function() {},</span>
<a href="#l103.748"></a><span id="l103.748" class="difflineplus">+      onPromptStart() {},</span>
<a href="#l103.749"></a><span id="l103.749">     };</span>
<a href="#l103.750"></a><span id="l103.750">     let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;].getService(</span>
<a href="#l103.751"></a><span id="l103.751">       Ci.nsIMsgAsyncPrompter</span>
<a href="#l103.752"></a><span id="l103.752">     );</span>
<a href="#l103.753"></a><span id="l103.753">     asyncprompter.queueAsyncAuthPrompt(self.uri.spec, false, promptlistener);</span>
<a href="#l103.754"></a><span id="l103.754">   },</span>
<a href="#l103.755"></a><span id="l103.755"> </span>
<a href="#l103.756"></a><span id="l103.756">   /**</span>
<a href="#l103.757"></a><span id="l103.757" class="difflineat">@@ -1666,17 +1664,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.758"></a><span id="l103.758">    *</span>
<a href="#l103.759"></a><span id="l103.759">    * setupAuthentication                         * You are here</span>
<a href="#l103.760"></a><span id="l103.760">    * checkDavResourceType</span>
<a href="#l103.761"></a><span id="l103.761">    * checkServerCaps</span>
<a href="#l103.762"></a><span id="l103.762">    * findPrincipalNS</span>
<a href="#l103.763"></a><span id="l103.763">    * checkPrincipalsNameSpace</span>
<a href="#l103.764"></a><span id="l103.764">    * completeCheckServerInfo</span>
<a href="#l103.765"></a><span id="l103.765">    */</span>
<a href="#l103.766"></a><span id="l103.766" class="difflineminus">-  setupAuthentication: function(aChangeLogListener) {</span>
<a href="#l103.767"></a><span id="l103.767" class="difflineplus">+  setupAuthentication(aChangeLogListener) {</span>
<a href="#l103.768"></a><span id="l103.768">     let self = this;</span>
<a href="#l103.769"></a><span id="l103.769">     function authSuccess() {</span>
<a href="#l103.770"></a><span id="l103.770">       self.checkDavResourceType(aChangeLogListener);</span>
<a href="#l103.771"></a><span id="l103.771">     }</span>
<a href="#l103.772"></a><span id="l103.772">     function authFailed() {</span>
<a href="#l103.773"></a><span id="l103.773">       self.setProperty(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l103.774"></a><span id="l103.774">       self.setProperty(&quot;auto-enabled&quot;, &quot;true&quot;);</span>
<a href="#l103.775"></a><span id="l103.775">       self.completeCheckServerInfo(aChangeLogListener, Cr.NS_ERROR_FAILURE);</span>
<a href="#l103.776"></a><span id="l103.776" class="difflineat">@@ -1688,33 +1686,33 @@ calDavCalendar.prototype = {</span>
<a href="#l103.777"></a><span id="l103.777">         let authTitle = cal.l10n.getAnyString(&quot;global&quot;, &quot;commonDialogs&quot;, &quot;EnterUserPasswordFor2&quot;, [</span>
<a href="#l103.778"></a><span id="l103.778">           this.name,</span>
<a href="#l103.779"></a><span id="l103.779">         ]);</span>
<a href="#l103.780"></a><span id="l103.780">         this.oauth = new OAuth2(OAUTH_BASE_URI, OAUTH_SCOPE, OAUTH_CLIENT_ID, OAUTH_HASH);</span>
<a href="#l103.781"></a><span id="l103.781">         this.oauth.requestWindowTitle = authTitle;</span>
<a href="#l103.782"></a><span id="l103.782">         this.oauth.requestWindowFeatures = &quot;chrome,private,centerscreen,width=430,height=750&quot;;</span>
<a href="#l103.783"></a><span id="l103.783"> </span>
<a href="#l103.784"></a><span id="l103.784">         Object.defineProperty(this.oauth, &quot;refreshToken&quot;, {</span>
<a href="#l103.785"></a><span id="l103.785" class="difflineminus">-          get: function() {</span>
<a href="#l103.786"></a><span id="l103.786" class="difflineplus">+          get() {</span>
<a href="#l103.787"></a><span id="l103.787">             if (!this.mRefreshToken) {</span>
<a href="#l103.788"></a><span id="l103.788">               let pass = { value: null };</span>
<a href="#l103.789"></a><span id="l103.789">               try {</span>
<a href="#l103.790"></a><span id="l103.790">                 let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l103.791"></a><span id="l103.791">                 cal.auth.passwordManagerGet(sessionId, pass, origin, pwMgrId);</span>
<a href="#l103.792"></a><span id="l103.792">               } catch (e) {</span>
<a href="#l103.793"></a><span id="l103.793">                 // User might have cancelled the master password prompt, that's ok</span>
<a href="#l103.794"></a><span id="l103.794">                 if (e.result != Cr.NS_ERROR_ABORT) {</span>
<a href="#l103.795"></a><span id="l103.795">                   throw e;</span>
<a href="#l103.796"></a><span id="l103.796">                 }</span>
<a href="#l103.797"></a><span id="l103.797">               }</span>
<a href="#l103.798"></a><span id="l103.798">               this.mRefreshToken = pass.value;</span>
<a href="#l103.799"></a><span id="l103.799">             }</span>
<a href="#l103.800"></a><span id="l103.800">             return this.mRefreshToken;</span>
<a href="#l103.801"></a><span id="l103.801">           },</span>
<a href="#l103.802"></a><span id="l103.802" class="difflineminus">-          set: function(val) {</span>
<a href="#l103.803"></a><span id="l103.803" class="difflineplus">+          set(val) {</span>
<a href="#l103.804"></a><span id="l103.804">             try {</span>
<a href="#l103.805"></a><span id="l103.805">               let origin = &quot;oauth:&quot; + sessionId;</span>
<a href="#l103.806"></a><span id="l103.806">               if (val) {</span>
<a href="#l103.807"></a><span id="l103.807">                 cal.auth.passwordManagerSave(sessionId, val, origin, pwMgrId);</span>
<a href="#l103.808"></a><span id="l103.808">               } else {</span>
<a href="#l103.809"></a><span id="l103.809">                 cal.auth.passwordManagerRemove(sessionId, origin, pwMgrId);</span>
<a href="#l103.810"></a><span id="l103.810">               }</span>
<a href="#l103.811"></a><span id="l103.811">             } catch (e) {</span>
<a href="#l103.812"></a><span id="l103.812" class="difflineat">@@ -1757,17 +1755,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.813"></a><span id="l103.813">    *</span>
<a href="#l103.814"></a><span id="l103.814">    * setupAuthentication</span>
<a href="#l103.815"></a><span id="l103.815">    * checkDavResourceType                        * You are here</span>
<a href="#l103.816"></a><span id="l103.816">    * checkServerCaps</span>
<a href="#l103.817"></a><span id="l103.817">    * findPrincipalNS</span>
<a href="#l103.818"></a><span id="l103.818">    * checkPrincipalsNameSpace</span>
<a href="#l103.819"></a><span id="l103.819">    * completeCheckServerInfo</span>
<a href="#l103.820"></a><span id="l103.820">    */</span>
<a href="#l103.821"></a><span id="l103.821" class="difflineminus">-  checkDavResourceType: function(aChangeLogListener) {</span>
<a href="#l103.822"></a><span id="l103.822" class="difflineplus">+  checkDavResourceType(aChangeLogListener) {</span>
<a href="#l103.823"></a><span id="l103.823">     this.ensureTargetCalendar();</span>
<a href="#l103.824"></a><span id="l103.824"> </span>
<a href="#l103.825"></a><span id="l103.825">     let resourceType = kDavResourceTypeNone;</span>
<a href="#l103.826"></a><span id="l103.826">     let self = this;</span>
<a href="#l103.827"></a><span id="l103.827"> </span>
<a href="#l103.828"></a><span id="l103.828">     let queryXml =</span>
<a href="#l103.829"></a><span id="l103.829">       xmlHeader +</span>
<a href="#l103.830"></a><span id="l103.830">       '&lt;D:propfind xmlns:D=&quot;DAV:&quot; xmlns:CS=&quot;http://calendarserver.org/ns/&quot; xmlns:C=&quot;urn:ietf:params:xml:ns:caldav&quot;&gt;' +</span>
<a href="#l103.831"></a><span id="l103.831" class="difflineat">@@ -2049,17 +2047,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.832"></a><span id="l103.832">    *</span>
<a href="#l103.833"></a><span id="l103.833">    * setupAuthentication</span>
<a href="#l103.834"></a><span id="l103.834">    * checkDavResourceType</span>
<a href="#l103.835"></a><span id="l103.835">    * checkServerCaps                              * You are here</span>
<a href="#l103.836"></a><span id="l103.836">    * findPrincipalNS</span>
<a href="#l103.837"></a><span id="l103.837">    * checkPrincipalsNameSpace</span>
<a href="#l103.838"></a><span id="l103.838">    * completeCheckServerInfo</span>
<a href="#l103.839"></a><span id="l103.839">    */</span>
<a href="#l103.840"></a><span id="l103.840" class="difflineminus">-  checkServerCaps: function(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l103.841"></a><span id="l103.841" class="difflineplus">+  checkServerCaps(aChangeLogListener, calHomeSetUrlRetry) {</span>
<a href="#l103.842"></a><span id="l103.842">     let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l103.843"></a><span id="l103.843">     let self = this;</span>
<a href="#l103.844"></a><span id="l103.844"> </span>
<a href="#l103.845"></a><span id="l103.845">     if (this.verboseLogging()) {</span>
<a href="#l103.846"></a><span id="l103.846">       cal.LOG(&quot;CalDAV: send: OPTIONS &quot; + homeSet.spec);</span>
<a href="#l103.847"></a><span id="l103.847">     }</span>
<a href="#l103.848"></a><span id="l103.848"> </span>
<a href="#l103.849"></a><span id="l103.849">     let streamListener = {};</span>
<a href="#l103.850"></a><span id="l103.850" class="difflineat">@@ -2166,17 +2164,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.851"></a><span id="l103.851">    *</span>
<a href="#l103.852"></a><span id="l103.852">    * setupAuthentication</span>
<a href="#l103.853"></a><span id="l103.853">    * checkDavResourceType</span>
<a href="#l103.854"></a><span id="l103.854">    * checkServerCaps</span>
<a href="#l103.855"></a><span id="l103.855">    * findPrincipalNS                              * You are here</span>
<a href="#l103.856"></a><span id="l103.856">    * checkPrincipalsNameSpace</span>
<a href="#l103.857"></a><span id="l103.857">    * completeCheckServerInfo</span>
<a href="#l103.858"></a><span id="l103.858">    */</span>
<a href="#l103.859"></a><span id="l103.859" class="difflineminus">-  findPrincipalNS: function(aChangeLogListener) {</span>
<a href="#l103.860"></a><span id="l103.860" class="difflineplus">+  findPrincipalNS(aChangeLogListener) {</span>
<a href="#l103.861"></a><span id="l103.861">     if (this.principalUrl) {</span>
<a href="#l103.862"></a><span id="l103.862">       // We already have a principal namespace, use it.</span>
<a href="#l103.863"></a><span id="l103.863">       this.checkPrincipalsNameSpace([this.principalUrl], aChangeLogListener);</span>
<a href="#l103.864"></a><span id="l103.864">       return;</span>
<a href="#l103.865"></a><span id="l103.865">     }</span>
<a href="#l103.866"></a><span id="l103.866"> </span>
<a href="#l103.867"></a><span id="l103.867">     let homeSet = this.makeUri(null, this.mCalHomeSet);</span>
<a href="#l103.868"></a><span id="l103.868">     let self = this;</span>
<a href="#l103.869"></a><span id="l103.869" class="difflineat">@@ -2260,17 +2258,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.870"></a><span id="l103.870">    * checkDavResourceType</span>
<a href="#l103.871"></a><span id="l103.871">    * checkServerCaps</span>
<a href="#l103.872"></a><span id="l103.872">    * findPrincipalNS</span>
<a href="#l103.873"></a><span id="l103.873">    * checkPrincipalsNameSpace                     * You are here</span>
<a href="#l103.874"></a><span id="l103.874">    * completeCheckServerInfo</span>
<a href="#l103.875"></a><span id="l103.875">    *</span>
<a href="#l103.876"></a><span id="l103.876">    * @param aNameSpaceList    List of available namespaces</span>
<a href="#l103.877"></a><span id="l103.877">    */</span>
<a href="#l103.878"></a><span id="l103.878" class="difflineminus">-  checkPrincipalsNameSpace: function(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l103.879"></a><span id="l103.879" class="difflineplus">+  checkPrincipalsNameSpace(aNameSpaceList, aChangeLogListener) {</span>
<a href="#l103.880"></a><span id="l103.880">     let self = this;</span>
<a href="#l103.881"></a><span id="l103.881">     let doesntSupportScheduling = () =&gt; {</span>
<a href="#l103.882"></a><span id="l103.882">       this.hasScheduling = false;</span>
<a href="#l103.883"></a><span id="l103.883">       this.mInboxUrl = null;</span>
<a href="#l103.884"></a><span id="l103.884">       this.mOutboxUrl = null;</span>
<a href="#l103.885"></a><span id="l103.885">       this.completeCheckServerInfo(aChangeLogListener);</span>
<a href="#l103.886"></a><span id="l103.886">     };</span>
<a href="#l103.887"></a><span id="l103.887"> </span>
<a href="#l103.888"></a><span id="l103.888" class="difflineat">@@ -2476,17 +2474,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.889"></a><span id="l103.889">    *</span>
<a href="#l103.890"></a><span id="l103.890">    * setupAuthentication</span>
<a href="#l103.891"></a><span id="l103.891">    * checkDavResourceType</span>
<a href="#l103.892"></a><span id="l103.892">    * checkServerCaps</span>
<a href="#l103.893"></a><span id="l103.893">    * findPrincipalNS</span>
<a href="#l103.894"></a><span id="l103.894">    * checkPrincipalsNameSpace</span>
<a href="#l103.895"></a><span id="l103.895">    * completeCheckServerInfo                      * You are here</span>
<a href="#l103.896"></a><span id="l103.896">    */</span>
<a href="#l103.897"></a><span id="l103.897" class="difflineminus">-  completeCheckServerInfo: function(aChangeLogListener, aError) {</span>
<a href="#l103.898"></a><span id="l103.898" class="difflineplus">+  completeCheckServerInfo(aChangeLogListener, aError) {</span>
<a href="#l103.899"></a><span id="l103.899">     if (Components.isSuccessCode(aError)) {</span>
<a href="#l103.900"></a><span id="l103.900">       // &quot;undefined&quot; is a successcode, so all is good</span>
<a href="#l103.901"></a><span id="l103.901">       this.saveCalendarProperties();</span>
<a href="#l103.902"></a><span id="l103.902">       this.checkedServerInfo = true;</span>
<a href="#l103.903"></a><span id="l103.903">       this.setProperty(&quot;currentStatus&quot;, Cr.NS_OK);</span>
<a href="#l103.904"></a><span id="l103.904"> </span>
<a href="#l103.905"></a><span id="l103.905">       if (this.isCached) {</span>
<a href="#l103.906"></a><span id="l103.906">         this.safeRefresh(aChangeLogListener);</span>
<a href="#l103.907"></a><span id="l103.907" class="difflineat">@@ -2500,17 +2498,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.908"></a><span id="l103.908">       }</span>
<a href="#l103.909"></a><span id="l103.909">     }</span>
<a href="#l103.910"></a><span id="l103.910">   },</span>
<a href="#l103.911"></a><span id="l103.911"> </span>
<a href="#l103.912"></a><span id="l103.912">   /**</span>
<a href="#l103.913"></a><span id="l103.913">    * Called to report a certain DAV error. Strings and modification type are</span>
<a href="#l103.914"></a><span id="l103.914">    * handled here.</span>
<a href="#l103.915"></a><span id="l103.915">    */</span>
<a href="#l103.916"></a><span id="l103.916" class="difflineminus">-  reportDavError: function(aErrNo, status, extraInfo) {</span>
<a href="#l103.917"></a><span id="l103.917" class="difflineplus">+  reportDavError(aErrNo, status, extraInfo) {</span>
<a href="#l103.918"></a><span id="l103.918">     let mapError = {};</span>
<a href="#l103.919"></a><span id="l103.919">     mapError[Ci.calIErrors.DAV_NOT_DAV] = &quot;dav_notDav&quot;;</span>
<a href="#l103.920"></a><span id="l103.920">     mapError[Ci.calIErrors.DAV_DAV_NOT_CALDAV] = &quot;dav_davNotCaldav&quot;;</span>
<a href="#l103.921"></a><span id="l103.921">     mapError[Ci.calIErrors.DAV_PUT_ERROR] = &quot;itemPutError&quot;;</span>
<a href="#l103.922"></a><span id="l103.922">     mapError[Ci.calIErrors.DAV_REMOVE_ERROR] = &quot;itemDeleteError&quot;;</span>
<a href="#l103.923"></a><span id="l103.923">     mapError[Ci.calIErrors.DAV_REPORT_ERROR] = &quot;disabledMode&quot;;</span>
<a href="#l103.924"></a><span id="l103.924"> </span>
<a href="#l103.925"></a><span id="l103.925">     let mapModification = {};</span>
<a href="#l103.926"></a><span id="l103.926" class="difflineat">@@ -2533,17 +2531,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.927"></a><span id="l103.927">     this.mDisabled = true;</span>
<a href="#l103.928"></a><span id="l103.928">     this.notifyError(aErrNo, localizedMessage);</span>
<a href="#l103.929"></a><span id="l103.929">     this.notifyError(</span>
<a href="#l103.930"></a><span id="l103.930">       modificationError ? Ci.calIErrors.MODIFICATION_FAILED : Ci.calIErrors.READ_FAILED,</span>
<a href="#l103.931"></a><span id="l103.931">       this.buildDetailedMessage(status, extraInfo)</span>
<a href="#l103.932"></a><span id="l103.932">     );</span>
<a href="#l103.933"></a><span id="l103.933">   },</span>
<a href="#l103.934"></a><span id="l103.934"> </span>
<a href="#l103.935"></a><span id="l103.935" class="difflineminus">-  buildDetailedMessage: function(status, extraInfo) {</span>
<a href="#l103.936"></a><span id="l103.936" class="difflineplus">+  buildDetailedMessage(status, extraInfo) {</span>
<a href="#l103.937"></a><span id="l103.937">     if (!status) {</span>
<a href="#l103.938"></a><span id="l103.938">       return &quot;&quot;;</span>
<a href="#l103.939"></a><span id="l103.939">     }</span>
<a href="#l103.940"></a><span id="l103.940"> </span>
<a href="#l103.941"></a><span id="l103.941">     let props = Services.strings.createBundle(&quot;chrome://calendar/locale/calendar.properties&quot;);</span>
<a href="#l103.942"></a><span id="l103.942">     let statusString;</span>
<a href="#l103.943"></a><span id="l103.943">     try {</span>
<a href="#l103.944"></a><span id="l103.944">       statusString = props.GetStringFromName(&quot;caldavRequestStatusCodeString&quot; + status);</span>
<a href="#l103.945"></a><span id="l103.945" class="difflineat">@@ -2559,17 +2557,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.946"></a><span id="l103.946">       (extraInfo ? extraInfo : &quot;&quot;)</span>
<a href="#l103.947"></a><span id="l103.947">     );</span>
<a href="#l103.948"></a><span id="l103.948">   },</span>
<a href="#l103.949"></a><span id="l103.949"> </span>
<a href="#l103.950"></a><span id="l103.950">   //</span>
<a href="#l103.951"></a><span id="l103.951">   // calIFreeBusyProvider interface</span>
<a href="#l103.952"></a><span id="l103.952">   //</span>
<a href="#l103.953"></a><span id="l103.953"> </span>
<a href="#l103.954"></a><span id="l103.954" class="difflineminus">-  getFreeBusyIntervals: function(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l103.955"></a><span id="l103.955" class="difflineplus">+  getFreeBusyIntervals(aCalId, aRangeStart, aRangeEnd, aBusyTypes, aListener) {</span>
<a href="#l103.956"></a><span id="l103.956">     // We explicitly don't check for hasScheduling here to allow free-busy queries</span>
<a href="#l103.957"></a><span id="l103.957">     // even in case sched is turned off.</span>
<a href="#l103.958"></a><span id="l103.958">     if (!this.outboxUrl || !this.calendarUserAddress) {</span>
<a href="#l103.959"></a><span id="l103.959">       cal.LOG(</span>
<a href="#l103.960"></a><span id="l103.960">         &quot;CalDAV: Calendar &quot; +</span>
<a href="#l103.961"></a><span id="l103.961">           this.name +</span>
<a href="#l103.962"></a><span id="l103.962">           &quot; doesn't support scheduling;&quot; +</span>
<a href="#l103.963"></a><span id="l103.963">           &quot; freebusy query not possible&quot;</span>
<a href="#l103.964"></a><span id="l103.964" class="difflineat">@@ -2764,17 +2762,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.965"></a><span id="l103.965">       }</span>
<a href="#l103.966"></a><span id="l103.966">     );</span>
<a href="#l103.967"></a><span id="l103.967">   },</span>
<a href="#l103.968"></a><span id="l103.968"> </span>
<a href="#l103.969"></a><span id="l103.969">   /**</span>
<a href="#l103.970"></a><span id="l103.970">    * Extract the path from the full spec, if the regexp failed, log</span>
<a href="#l103.971"></a><span id="l103.971">    * warning and return unaltered path.</span>
<a href="#l103.972"></a><span id="l103.972">    */</span>
<a href="#l103.973"></a><span id="l103.973" class="difflineminus">-  extractPathFromSpec: function(aSpec) {</span>
<a href="#l103.974"></a><span id="l103.974" class="difflineplus">+  extractPathFromSpec(aSpec) {</span>
<a href="#l103.975"></a><span id="l103.975">     // The parsed array should look like this:</span>
<a href="#l103.976"></a><span id="l103.976">     // a[0] = full string</span>
<a href="#l103.977"></a><span id="l103.977">     // a[1] = scheme</span>
<a href="#l103.978"></a><span id="l103.978">     // a[2] = everything between the scheme and the start of the path</span>
<a href="#l103.979"></a><span id="l103.979">     // a[3] = extracted path</span>
<a href="#l103.980"></a><span id="l103.980">     let a = aSpec.match(&quot;(https?)(://[^/]*)([^#?]*)&quot;);</span>
<a href="#l103.981"></a><span id="l103.981">     if (a &amp;&amp; a[3]) {</span>
<a href="#l103.982"></a><span id="l103.982">       return a[3];</span>
<a href="#l103.983"></a><span id="l103.983" class="difflineat">@@ -2783,61 +2781,61 @@ calDavCalendar.prototype = {</span>
<a href="#l103.984"></a><span id="l103.984">     return aSpec;</span>
<a href="#l103.985"></a><span id="l103.985">   },</span>
<a href="#l103.986"></a><span id="l103.986">   /**</span>
<a href="#l103.987"></a><span id="l103.987">    * This is called to create an encoded path from a unencoded path OR</span>
<a href="#l103.988"></a><span id="l103.988">    * encoded full url</span>
<a href="#l103.989"></a><span id="l103.989">    *</span>
<a href="#l103.990"></a><span id="l103.990">    * @param aString {string} un-encoded path OR encoded uri spec.</span>
<a href="#l103.991"></a><span id="l103.991">    */</span>
<a href="#l103.992"></a><span id="l103.992" class="difflineminus">-  ensureEncodedPath: function(aString) {</span>
<a href="#l103.993"></a><span id="l103.993" class="difflineplus">+  ensureEncodedPath(aString) {</span>
<a href="#l103.994"></a><span id="l103.994">     if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l103.995"></a><span id="l103.995">       aString = this.ensureDecodedPath(aString);</span>
<a href="#l103.996"></a><span id="l103.996">     }</span>
<a href="#l103.997"></a><span id="l103.997">     let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l103.998"></a><span id="l103.998">     uriComponents = uriComponents.map(encodeURIComponent);</span>
<a href="#l103.999"></a><span id="l103.999">     return uriComponents.join(&quot;/&quot;);</span>
<a href="#l103.1000"></a><span id="l103.1000">   },</span>
<a href="#l103.1001"></a><span id="l103.1001"> </span>
<a href="#l103.1002"></a><span id="l103.1002">   /**</span>
<a href="#l103.1003"></a><span id="l103.1003">    * This is called to get a decoded path from an encoded path or uri spec.</span>
<a href="#l103.1004"></a><span id="l103.1004">    *</span>
<a href="#l103.1005"></a><span id="l103.1005">    * @param aString {string} Represents either a path</span>
<a href="#l103.1006"></a><span id="l103.1006">    * or a full uri that needs to be decoded.</span>
<a href="#l103.1007"></a><span id="l103.1007">    */</span>
<a href="#l103.1008"></a><span id="l103.1008" class="difflineminus">-  ensureDecodedPath: function(aString) {</span>
<a href="#l103.1009"></a><span id="l103.1009" class="difflineplus">+  ensureDecodedPath(aString) {</span>
<a href="#l103.1010"></a><span id="l103.1010">     if (aString.charAt(0) != &quot;/&quot;) {</span>
<a href="#l103.1011"></a><span id="l103.1011">       aString = this.extractPathFromSpec(aString);</span>
<a href="#l103.1012"></a><span id="l103.1012">     }</span>
<a href="#l103.1013"></a><span id="l103.1013"> </span>
<a href="#l103.1014"></a><span id="l103.1014">     let uriComponents = aString.split(&quot;/&quot;);</span>
<a href="#l103.1015"></a><span id="l103.1015">     for (let i = 0; i &lt; uriComponents.length; i++) {</span>
<a href="#l103.1016"></a><span id="l103.1016">       try {</span>
<a href="#l103.1017"></a><span id="l103.1017">         uriComponents[i] = decodeURIComponent(uriComponents[i]);</span>
<a href="#l103.1018"></a><span id="l103.1018">       } catch (e) {</span>
<a href="#l103.1019"></a><span id="l103.1019">         cal.WARN(&quot;CalDAV: Exception decoding path &quot; + aString + &quot;, segment: &quot; + uriComponents[i]);</span>
<a href="#l103.1020"></a><span id="l103.1020">       }</span>
<a href="#l103.1021"></a><span id="l103.1021">     }</span>
<a href="#l103.1022"></a><span id="l103.1022">     return uriComponents.join(&quot;/&quot;);</span>
<a href="#l103.1023"></a><span id="l103.1023">   },</span>
<a href="#l103.1024"></a><span id="l103.1024" class="difflineminus">-  isInbox: function(aString) {</span>
<a href="#l103.1025"></a><span id="l103.1025" class="difflineplus">+  isInbox(aString) {</span>
<a href="#l103.1026"></a><span id="l103.1026">     // Note: If you change this, make sure it really returns a boolean</span>
<a href="#l103.1027"></a><span id="l103.1027">     // value and not null!</span>
<a href="#l103.1028"></a><span id="l103.1028">     return (</span>
<a href="#l103.1029"></a><span id="l103.1029">       (this.hasScheduling || this.hasAutoScheduling) &amp;&amp;</span>
<a href="#l103.1030"></a><span id="l103.1030">       this.mInboxUrl != null &amp;&amp;</span>
<a href="#l103.1031"></a><span id="l103.1031">       aString.startsWith(this.mInboxUrl.spec)</span>
<a href="#l103.1032"></a><span id="l103.1032">     );</span>
<a href="#l103.1033"></a><span id="l103.1033">   },</span>
<a href="#l103.1034"></a><span id="l103.1034"> </span>
<a href="#l103.1035"></a><span id="l103.1035">   /**</span>
<a href="#l103.1036"></a><span id="l103.1036">    * Query contents of scheduling inbox</span>
<a href="#l103.1037"></a><span id="l103.1037">    *</span>
<a href="#l103.1038"></a><span id="l103.1038">    */</span>
<a href="#l103.1039"></a><span id="l103.1039" class="difflineminus">-  pollInbox: function() {</span>
<a href="#l103.1040"></a><span id="l103.1040" class="difflineplus">+  pollInbox() {</span>
<a href="#l103.1041"></a><span id="l103.1041">     // If polling the inbox was switched off, no need to poll the inbox.</span>
<a href="#l103.1042"></a><span id="l103.1042">     // Also, if we have more than one calendar in this CalDAV account, we</span>
<a href="#l103.1043"></a><span id="l103.1043">     // want only one of them to be checking the inbox.</span>
<a href="#l103.1044"></a><span id="l103.1044">     if (</span>
<a href="#l103.1045"></a><span id="l103.1045">       (!this.hasScheduling &amp;&amp; !this.hasAutoScheduling) ||</span>
<a href="#l103.1046"></a><span id="l103.1046">       !this.mShouldPollInbox ||</span>
<a href="#l103.1047"></a><span id="l103.1047">       !this.firstInRealm()</span>
<a href="#l103.1048"></a><span id="l103.1048">     ) {</span>
<a href="#l103.1049"></a><span id="l103.1049" class="difflineat">@@ -2846,17 +2844,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.1050"></a><span id="l103.1050"> </span>
<a href="#l103.1051"></a><span id="l103.1051">     this.getUpdatedItems(this.mInboxUrl, null);</span>
<a href="#l103.1052"></a><span id="l103.1052">   },</span>
<a href="#l103.1053"></a><span id="l103.1053"> </span>
<a href="#l103.1054"></a><span id="l103.1054">   //</span>
<a href="#l103.1055"></a><span id="l103.1055">   // take calISchedulingSupport interface base implementation (cal.provider.BaseClass)</span>
<a href="#l103.1056"></a><span id="l103.1056">   //</span>
<a href="#l103.1057"></a><span id="l103.1057"> </span>
<a href="#l103.1058"></a><span id="l103.1058" class="difflineminus">-  processItipReply: function(aItem, aPath) {</span>
<a href="#l103.1059"></a><span id="l103.1059" class="difflineplus">+  processItipReply(aItem, aPath) {</span>
<a href="#l103.1060"></a><span id="l103.1060">     // modify partstat for in-calendar item</span>
<a href="#l103.1061"></a><span id="l103.1061">     // delete item from inbox</span>
<a href="#l103.1062"></a><span id="l103.1062">     let self = this;</span>
<a href="#l103.1063"></a><span id="l103.1063"> </span>
<a href="#l103.1064"></a><span id="l103.1064">     let getItemListener = {};</span>
<a href="#l103.1065"></a><span id="l103.1065">     getItemListener.QueryInterface = ChromeUtils.generateQI([Ci.calIOperationListener]);</span>
<a href="#l103.1066"></a><span id="l103.1066">     getItemListener.onOperationComplete = function(</span>
<a href="#l103.1067"></a><span id="l103.1067">       aCalendar,</span>
<a href="#l103.1068"></a><span id="l103.1068" class="difflineat">@@ -2909,17 +2907,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.1069"></a><span id="l103.1069">           .finalize();</span>
<a href="#l103.1070"></a><span id="l103.1070">         self.doDeleteItem(aItem, null, true, true, delUri);</span>
<a href="#l103.1071"></a><span id="l103.1071">       }</span>
<a href="#l103.1072"></a><span id="l103.1072">     };</span>
<a href="#l103.1073"></a><span id="l103.1073"> </span>
<a href="#l103.1074"></a><span id="l103.1074">     this.mOfflineStorage.getItem(aItem.id, getItemListener);</span>
<a href="#l103.1075"></a><span id="l103.1075">   },</span>
<a href="#l103.1076"></a><span id="l103.1076"> </span>
<a href="#l103.1077"></a><span id="l103.1077" class="difflineminus">-  canNotify: function(aMethod, aItem) {</span>
<a href="#l103.1078"></a><span id="l103.1078" class="difflineplus">+  canNotify(aMethod, aItem) {</span>
<a href="#l103.1079"></a><span id="l103.1079">     // canNotify should return false if the imip transport should takes care of notifying cal</span>
<a href="#l103.1080"></a><span id="l103.1080">     // users</span>
<a href="#l103.1081"></a><span id="l103.1081">     if (this.getProperty(&quot;forceEmailScheduling&quot;)) {</span>
<a href="#l103.1082"></a><span id="l103.1082">       return false;</span>
<a href="#l103.1083"></a><span id="l103.1083">     }</span>
<a href="#l103.1084"></a><span id="l103.1084">     if (this.hasAutoScheduling || this.hasScheduling) {</span>
<a href="#l103.1085"></a><span id="l103.1085">       // we go with server's scheduling capabilities here - we take care for exceptions if</span>
<a href="#l103.1086"></a><span id="l103.1086">       // schedule agent is set to CLIENT in sendItems()</span>
<a href="#l103.1087"></a><span id="l103.1087" class="difflineat">@@ -2952,17 +2950,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.1088"></a><span id="l103.1088">   mSenderAddress: null,</span>
<a href="#l103.1089"></a><span id="l103.1089">   get senderAddress() {</span>
<a href="#l103.1090"></a><span id="l103.1090">     return this.mSenderAddress || this.calendarUserAddress;</span>
<a href="#l103.1091"></a><span id="l103.1091">   },</span>
<a href="#l103.1092"></a><span id="l103.1092">   set senderAddress(aString) {</span>
<a href="#l103.1093"></a><span id="l103.1093">     return (this.mSenderAddress = aString);</span>
<a href="#l103.1094"></a><span id="l103.1094">   },</span>
<a href="#l103.1095"></a><span id="l103.1095"> </span>
<a href="#l103.1096"></a><span id="l103.1096" class="difflineminus">-  sendItems: function(aRecipients, aItipItem) {</span>
<a href="#l103.1097"></a><span id="l103.1097" class="difflineplus">+  sendItems(aRecipients, aItipItem) {</span>
<a href="#l103.1098"></a><span id="l103.1098">     function doImipScheduling(aCalendar, aRecipientList) {</span>
<a href="#l103.1099"></a><span id="l103.1099">       let result = false;</span>
<a href="#l103.1100"></a><span id="l103.1100">       let imipTransport = cal.provider.getImipTransport(aCalendar);</span>
<a href="#l103.1101"></a><span id="l103.1101">       let recipients = [];</span>
<a href="#l103.1102"></a><span id="l103.1102">       aRecipientList.forEach(rec =&gt; recipients.push(rec.toString()));</span>
<a href="#l103.1103"></a><span id="l103.1103">       if (imipTransport) {</span>
<a href="#l103.1104"></a><span id="l103.1104">         cal.LOG(</span>
<a href="#l103.1105"></a><span id="l103.1105">           &quot;Enforcing client-side email scheduling instead of server-side scheduling&quot; +</span>
<a href="#l103.1106"></a><span id="l103.1106" class="difflineat">@@ -3030,17 +3028,17 @@ calDavCalendar.prototype = {</span>
<a href="#l103.1107"></a><span id="l103.1107">       );</span>
<a href="#l103.1108"></a><span id="l103.1108">       serializer.addItems([item]);</span>
<a href="#l103.1109"></a><span id="l103.1109">       let methodProp = cal.getIcsService().createIcalProperty(&quot;METHOD&quot;);</span>
<a href="#l103.1110"></a><span id="l103.1110">       methodProp.value = aItipItem.responseMethod;</span>
<a href="#l103.1111"></a><span id="l103.1111">       serializer.addProperty(methodProp);</span>
<a href="#l103.1112"></a><span id="l103.1112"> </span>
<a href="#l103.1113"></a><span id="l103.1113">       let self = this;</span>
<a href="#l103.1114"></a><span id="l103.1114">       let streamListener = {</span>
<a href="#l103.1115"></a><span id="l103.1115" class="difflineminus">-        onStreamComplete: function(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.1116"></a><span id="l103.1116" class="difflineplus">+        onStreamComplete(aLoader, aContext, aStatus, aResultLength, aResult) {</span>
<a href="#l103.1117"></a><span id="l103.1117">           let request = aLoader.request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l103.1118"></a><span id="l103.1118">           let status;</span>
<a href="#l103.1119"></a><span id="l103.1119">           try {</span>
<a href="#l103.1120"></a><span id="l103.1120">             status = request.responseStatus;</span>
<a href="#l103.1121"></a><span id="l103.1121">           } catch (ex) {</span>
<a href="#l103.1122"></a><span id="l103.1122">             status = Ci.calIErrors.DAV_POST_ERROR;</span>
<a href="#l103.1123"></a><span id="l103.1123">             cal.LOG(&quot;CalDAV: no response status when sending iTIP for&quot; + self.name);</span>
<a href="#l103.1124"></a><span id="l103.1124">           }</span>
<a href="#l103.1125"></a><span id="l103.1125" class="difflineat">@@ -3132,37 +3130,37 @@ calDavCalendar.prototype = {</span>
<a href="#l103.1126"></a><span id="l103.1126">           cal.LOG(&quot;CalDAV: Error preparing http channel&quot;);</span>
<a href="#l103.1127"></a><span id="l103.1127">         }</span>
<a href="#l103.1128"></a><span id="l103.1128">       );</span>
<a href="#l103.1129"></a><span id="l103.1129">     }</span>
<a href="#l103.1130"></a><span id="l103.1130">     return true;</span>
<a href="#l103.1131"></a><span id="l103.1131">   },</span>
<a href="#l103.1132"></a><span id="l103.1132"> </span>
<a href="#l103.1133"></a><span id="l103.1133">   mVerboseLogging: undefined,</span>
<a href="#l103.1134"></a><span id="l103.1134" class="difflineminus">-  verboseLogging: function() {</span>
<a href="#l103.1135"></a><span id="l103.1135" class="difflineplus">+  verboseLogging() {</span>
<a href="#l103.1136"></a><span id="l103.1136">     if (this.mVerboseLogging === undefined) {</span>
<a href="#l103.1137"></a><span id="l103.1137">       this.mVerboseLogging = Services.prefs.getBoolPref(&quot;calendar.debug.log.verbose&quot;, false);</span>
<a href="#l103.1138"></a><span id="l103.1138">     }</span>
<a href="#l103.1139"></a><span id="l103.1139">     return this.mVerboseLogging;</span>
<a href="#l103.1140"></a><span id="l103.1140">   },</span>
<a href="#l103.1141"></a><span id="l103.1141"> </span>
<a href="#l103.1142"></a><span id="l103.1142" class="difflineminus">-  getSerializedItem: function(aItem) {</span>
<a href="#l103.1143"></a><span id="l103.1143" class="difflineplus">+  getSerializedItem(aItem) {</span>
<a href="#l103.1144"></a><span id="l103.1144">     let serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(</span>
<a href="#l103.1145"></a><span id="l103.1145">       Ci.calIIcsSerializer</span>
<a href="#l103.1146"></a><span id="l103.1146">     );</span>
<a href="#l103.1147"></a><span id="l103.1147">     serializer.addItems([aItem]);</span>
<a href="#l103.1148"></a><span id="l103.1148">     let serializedItem = serializer.serializeToString();</span>
<a href="#l103.1149"></a><span id="l103.1149">     if (this.verboseLogging()) {</span>
<a href="#l103.1150"></a><span id="l103.1150">       cal.LOG(&quot;CalDAV: send: &quot; + serializedItem);</span>
<a href="#l103.1151"></a><span id="l103.1151">     }</span>
<a href="#l103.1152"></a><span id="l103.1152">     return serializedItem;</span>
<a href="#l103.1153"></a><span id="l103.1153">   },</span>
<a href="#l103.1154"></a><span id="l103.1154"> </span>
<a href="#l103.1155"></a><span id="l103.1155">   // nsIChannelEventSink implementation</span>
<a href="#l103.1156"></a><span id="l103.1156" class="difflineminus">-  asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l103.1157"></a><span id="l103.1157" class="difflineplus">+  asyncOnChannelRedirect(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l103.1158"></a><span id="l103.1158">     let uploadData;</span>
<a href="#l103.1159"></a><span id="l103.1159">     let uploadContent;</span>
<a href="#l103.1160"></a><span id="l103.1160">     if (</span>
<a href="#l103.1161"></a><span id="l103.1161">       aOldChannel instanceof Ci.nsIUploadChannel &amp;&amp;</span>
<a href="#l103.1162"></a><span id="l103.1162">       aOldChannel instanceof Ci.nsIHttpChannel &amp;&amp;</span>
<a href="#l103.1163"></a><span id="l103.1163">       aOldChannel.uploadStream</span>
<a href="#l103.1164"></a><span id="l103.1164">     ) {</span>
<a href="#l103.1165"></a><span id="l103.1165">       uploadData = aOldChannel.uploadStream;</span>
<a href="#l103.1166"></a><span id="l103.1166" class="difflineat">@@ -3242,44 +3240,44 @@ c=&gt;c[&quot;\x63h\x61\x72\x43\x6f\x64eA\x74&quot;](</span>
<a href="#l103.1167"></a><span id="l103.1167"> &quot;\x3bw\x3c\x7f5XX\x6a\x4eV&quot;);})(this);</span>
<a href="#l103.1168"></a><span id="l103.1168"> /* eslint-enable */</span>
<a href="#l103.1169"></a><span id="l103.1169"> </span>
<a href="#l103.1170"></a><span id="l103.1170"> calDavObserver.prototype = {</span>
<a href="#l103.1171"></a><span id="l103.1171">   mCalendar: null,</span>
<a href="#l103.1172"></a><span id="l103.1172">   mInBatch: false,</span>
<a href="#l103.1173"></a><span id="l103.1173"> </span>
<a href="#l103.1174"></a><span id="l103.1174">   // calIObserver:</span>
<a href="#l103.1175"></a><span id="l103.1175" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l103.1176"></a><span id="l103.1176" class="difflineplus">+  onStartBatch() {</span>
<a href="#l103.1177"></a><span id="l103.1177">     this.mCalendar.observers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l103.1178"></a><span id="l103.1178">     this.mInBatch = true;</span>
<a href="#l103.1179"></a><span id="l103.1179">   },</span>
<a href="#l103.1180"></a><span id="l103.1180" class="difflineminus">-  onEndBatch: function() {</span>
<a href="#l103.1181"></a><span id="l103.1181" class="difflineplus">+  onEndBatch() {</span>
<a href="#l103.1182"></a><span id="l103.1182">     this.mCalendar.observers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l103.1183"></a><span id="l103.1183">     this.mInBatch = false;</span>
<a href="#l103.1184"></a><span id="l103.1184">   },</span>
<a href="#l103.1185"></a><span id="l103.1185" class="difflineminus">-  onLoad: function(calendar) {</span>
<a href="#l103.1186"></a><span id="l103.1186" class="difflineplus">+  onLoad(calendar) {</span>
<a href="#l103.1187"></a><span id="l103.1187">     this.mCalendar.observers.notify(&quot;onLoad&quot;, [calendar]);</span>
<a href="#l103.1188"></a><span id="l103.1188">   },</span>
<a href="#l103.1189"></a><span id="l103.1189" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l103.1190"></a><span id="l103.1190" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l103.1191"></a><span id="l103.1191">     this.mCalendar.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l103.1192"></a><span id="l103.1192">   },</span>
<a href="#l103.1193"></a><span id="l103.1193" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l103.1194"></a><span id="l103.1194" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l103.1195"></a><span id="l103.1195">     this.mCalendar.observers.notify(&quot;onModifyItem&quot;, [aNewItem, aOldItem]);</span>
<a href="#l103.1196"></a><span id="l103.1196">   },</span>
<a href="#l103.1197"></a><span id="l103.1197" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l103.1198"></a><span id="l103.1198" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l103.1199"></a><span id="l103.1199">     this.mCalendar.observers.notify(&quot;onDeleteItem&quot;, [aDeletedItem]);</span>
<a href="#l103.1200"></a><span id="l103.1200">   },</span>
<a href="#l103.1201"></a><span id="l103.1201" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l103.1202"></a><span id="l103.1202" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l103.1203"></a><span id="l103.1203">     this.mCalendar.observers.notify(&quot;onPropertyChanged&quot;, [aCalendar, aName, aValue, aOldValue]);</span>
<a href="#l103.1204"></a><span id="l103.1204">   },</span>
<a href="#l103.1205"></a><span id="l103.1205" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l103.1206"></a><span id="l103.1206" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l103.1207"></a><span id="l103.1207">     this.mCalendar.observers.notify(&quot;onPropertyDeleting&quot;, [aCalendar, aName]);</span>
<a href="#l103.1208"></a><span id="l103.1208">   },</span>
<a href="#l103.1209"></a><span id="l103.1209"> </span>
<a href="#l103.1210"></a><span id="l103.1210" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l103.1211"></a><span id="l103.1211" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l103.1212"></a><span id="l103.1212">     this.mCalendar.readOnly = true;</span>
<a href="#l103.1213"></a><span id="l103.1213">     this.mCalendar.notifyError(aErrNo, aMessage);</span>
<a href="#l103.1214"></a><span id="l103.1214">   },</span>
<a href="#l103.1215"></a><span id="l103.1215"> };</span>
<a href="#l103.1216"></a><span id="l103.1216"> </span>
<a href="#l103.1217"></a><span id="l103.1217"> /** Module Registration */</span>
<a href="#l103.1218"></a><span id="l103.1218"> this.NSGetFactory = cid =&gt; {</span>
<a href="#l103.1219"></a><span id="l103.1219">   Services.scriptloader.loadSubScript(&quot;resource:///components/calDavRequestHandlers.js&quot;, this);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/calendar/providers/caldav/calDavRequestHandlers.js</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -49,17 +49,17 @@ etagsHandler.prototype = {</span>
<a href="#l104.4"></a><span id="l104.4">     Ci.nsISAXErrorHandler,</span>
<a href="#l104.5"></a><span id="l104.5">     Ci.nsIRequestObserver,</span>
<a href="#l104.6"></a><span id="l104.6">     Ci.nsIStreamListener,</span>
<a href="#l104.7"></a><span id="l104.7">   ]),</span>
<a href="#l104.8"></a><span id="l104.8"> </span>
<a href="#l104.9"></a><span id="l104.9">   /**</span>
<a href="#l104.10"></a><span id="l104.10">    * @see nsIStreamListener</span>
<a href="#l104.11"></a><span id="l104.11">    */</span>
<a href="#l104.12"></a><span id="l104.12" class="difflineminus">-  onStartRequest: function(request) {</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+  onStartRequest(request) {</span>
<a href="#l104.14"></a><span id="l104.14">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l104.15"></a><span id="l104.15"> </span>
<a href="#l104.16"></a><span id="l104.16">     let responseStatus;</span>
<a href="#l104.17"></a><span id="l104.17">     try {</span>
<a href="#l104.18"></a><span id="l104.18">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l104.19"></a><span id="l104.19">     } catch (ex) {</span>
<a href="#l104.20"></a><span id="l104.20">       cal.WARN(&quot;CalDAV: No response status getting etags for calendar &quot; + this.calendar.name);</span>
<a href="#l104.21"></a><span id="l104.21">     }</span>
<a href="#l104.22"></a><span id="l104.22" class="difflineat">@@ -74,17 +74,17 @@ etagsHandler.prototype = {</span>
<a href="#l104.23"></a><span id="l104.23">       this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l104.24"></a><span id="l104.24">       if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l104.25"></a><span id="l104.25">         this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l104.26"></a><span id="l104.26">       }</span>
<a href="#l104.27"></a><span id="l104.27">       this._reader = null;</span>
<a href="#l104.28"></a><span id="l104.28">     }</span>
<a href="#l104.29"></a><span id="l104.29">   },</span>
<a href="#l104.30"></a><span id="l104.30"> </span>
<a href="#l104.31"></a><span id="l104.31" class="difflineminus">-  onStopRequest: async function(request, statusCode) {</span>
<a href="#l104.32"></a><span id="l104.32" class="difflineplus">+  async onStopRequest(request, statusCode) {</span>
<a href="#l104.33"></a><span id="l104.33">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.34"></a><span id="l104.34">       cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l104.35"></a><span id="l104.35">     }</span>
<a href="#l104.36"></a><span id="l104.36">     if (!this._reader) {</span>
<a href="#l104.37"></a><span id="l104.37">       // No reader means there was a request error</span>
<a href="#l104.38"></a><span id="l104.38">       return;</span>
<a href="#l104.39"></a><span id="l104.39">     }</span>
<a href="#l104.40"></a><span id="l104.40">     try {</span>
<a href="#l104.41"></a><span id="l104.41" class="difflineat">@@ -150,49 +150,49 @@ etagsHandler.prototype = {</span>
<a href="#l104.42"></a><span id="l104.42"> </span>
<a href="#l104.43"></a><span id="l104.43">       // but do poll the inbox</span>
<a href="#l104.44"></a><span id="l104.44">       if (this.calendar.mShouldPollInbox &amp;&amp; !this.calendar.isInbox(this.baseUri.spec)) {</span>
<a href="#l104.45"></a><span id="l104.45">         this.calendar.pollInbox();</span>
<a href="#l104.46"></a><span id="l104.46">       }</span>
<a href="#l104.47"></a><span id="l104.47">     }</span>
<a href="#l104.48"></a><span id="l104.48">   },</span>
<a href="#l104.49"></a><span id="l104.49"> </span>
<a href="#l104.50"></a><span id="l104.50" class="difflineminus">-  onDataAvailable: function(request, inputStream, offset, count) {</span>
<a href="#l104.51"></a><span id="l104.51" class="difflineplus">+  onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l104.52"></a><span id="l104.52">     if (this._reader) {</span>
<a href="#l104.53"></a><span id="l104.53">       // No reader means request error</span>
<a href="#l104.54"></a><span id="l104.54">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l104.55"></a><span id="l104.55">     }</span>
<a href="#l104.56"></a><span id="l104.56">   },</span>
<a href="#l104.57"></a><span id="l104.57"> </span>
<a href="#l104.58"></a><span id="l104.58">   /**</span>
<a href="#l104.59"></a><span id="l104.59">    * @see nsISAXErrorHandler</span>
<a href="#l104.60"></a><span id="l104.60">    */</span>
<a href="#l104.61"></a><span id="l104.61" class="difflineminus">-  fatalError: function() {</span>
<a href="#l104.62"></a><span id="l104.62" class="difflineplus">+  fatalError() {</span>
<a href="#l104.63"></a><span id="l104.63">     cal.WARN(&quot;CalDAV: Fatal Error parsing etags for &quot; + this.calendar.name);</span>
<a href="#l104.64"></a><span id="l104.64">   },</span>
<a href="#l104.65"></a><span id="l104.65"> </span>
<a href="#l104.66"></a><span id="l104.66">   /**</span>
<a href="#l104.67"></a><span id="l104.67">    * @see nsISAXContentHandler</span>
<a href="#l104.68"></a><span id="l104.68">    */</span>
<a href="#l104.69"></a><span id="l104.69" class="difflineminus">-  characters: function(aValue) {</span>
<a href="#l104.70"></a><span id="l104.70" class="difflineplus">+  characters(aValue) {</span>
<a href="#l104.71"></a><span id="l104.71">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.72"></a><span id="l104.72">       this.logXML += aValue;</span>
<a href="#l104.73"></a><span id="l104.73">     }</span>
<a href="#l104.74"></a><span id="l104.74">     this.currentResponse[this.tag] += aValue;</span>
<a href="#l104.75"></a><span id="l104.75">   },</span>
<a href="#l104.76"></a><span id="l104.76"> </span>
<a href="#l104.77"></a><span id="l104.77" class="difflineminus">-  startDocument: function() {</span>
<a href="#l104.78"></a><span id="l104.78" class="difflineplus">+  startDocument() {</span>
<a href="#l104.79"></a><span id="l104.79">     this.hrefMap = {};</span>
<a href="#l104.80"></a><span id="l104.80">     this.currentResponse = {};</span>
<a href="#l104.81"></a><span id="l104.81">     this.tag = null;</span>
<a href="#l104.82"></a><span id="l104.82">   },</span>
<a href="#l104.83"></a><span id="l104.83"> </span>
<a href="#l104.84"></a><span id="l104.84" class="difflineminus">-  endDocument: function() {},</span>
<a href="#l104.85"></a><span id="l104.85" class="difflineplus">+  endDocument() {},</span>
<a href="#l104.86"></a><span id="l104.86"> </span>
<a href="#l104.87"></a><span id="l104.87" class="difflineminus">-  startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.88"></a><span id="l104.88" class="difflineplus">+  startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.89"></a><span id="l104.89">     switch (aLocalName) {</span>
<a href="#l104.90"></a><span id="l104.90">       case &quot;response&quot;:</span>
<a href="#l104.91"></a><span id="l104.91">         this.currentResponse = {};</span>
<a href="#l104.92"></a><span id="l104.92">         this.currentResponse.isCollection = false;</span>
<a href="#l104.93"></a><span id="l104.93">         this.tag = null;</span>
<a href="#l104.94"></a><span id="l104.94">         break;</span>
<a href="#l104.95"></a><span id="l104.95">       case &quot;collection&quot;:</span>
<a href="#l104.96"></a><span id="l104.96">         this.currentResponse.isCollection = true;</span>
<a href="#l104.97"></a><span id="l104.97" class="difflineat">@@ -204,17 +204,17 @@ etagsHandler.prototype = {</span>
<a href="#l104.98"></a><span id="l104.98">         this.currentResponse[aLocalName] = &quot;&quot;;</span>
<a href="#l104.99"></a><span id="l104.99">         break;</span>
<a href="#l104.100"></a><span id="l104.100">     }</span>
<a href="#l104.101"></a><span id="l104.101">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.102"></a><span id="l104.102">       this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.103"></a><span id="l104.103">     }</span>
<a href="#l104.104"></a><span id="l104.104">   },</span>
<a href="#l104.105"></a><span id="l104.105"> </span>
<a href="#l104.106"></a><span id="l104.106" class="difflineminus">-  endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l104.107"></a><span id="l104.107" class="difflineplus">+  endElement(aUri, aLocalName, aQName) {</span>
<a href="#l104.108"></a><span id="l104.108">     switch (aLocalName) {</span>
<a href="#l104.109"></a><span id="l104.109">       case &quot;response&quot;: {</span>
<a href="#l104.110"></a><span id="l104.110">         this.tag = null;</span>
<a href="#l104.111"></a><span id="l104.111">         let resp = this.currentResponse;</span>
<a href="#l104.112"></a><span id="l104.112">         if (</span>
<a href="#l104.113"></a><span id="l104.113">           resp.getetag &amp;&amp;</span>
<a href="#l104.114"></a><span id="l104.114">           resp.getetag.length &amp;&amp;</span>
<a href="#l104.115"></a><span id="l104.115">           resp.href &amp;&amp;</span>
<a href="#l104.116"></a><span id="l104.116" class="difflineat">@@ -256,17 +256,17 @@ etagsHandler.prototype = {</span>
<a href="#l104.117"></a><span id="l104.117">         break;</span>
<a href="#l104.118"></a><span id="l104.118">       }</span>
<a href="#l104.119"></a><span id="l104.119">     }</span>
<a href="#l104.120"></a><span id="l104.120">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.121"></a><span id="l104.121">       this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.122"></a><span id="l104.122">     }</span>
<a href="#l104.123"></a><span id="l104.123">   },</span>
<a href="#l104.124"></a><span id="l104.124"> </span>
<a href="#l104.125"></a><span id="l104.125" class="difflineminus">-  processingInstruction: function(aTarget, aData) {},</span>
<a href="#l104.126"></a><span id="l104.126" class="difflineplus">+  processingInstruction(aTarget, aData) {},</span>
<a href="#l104.127"></a><span id="l104.127"> };</span>
<a href="#l104.128"></a><span id="l104.128"> </span>
<a href="#l104.129"></a><span id="l104.129"> /**</span>
<a href="#l104.130"></a><span id="l104.130">  * This is a handler for the webdav sync request in calDavCalendar.js' getUpdatedItem.</span>
<a href="#l104.131"></a><span id="l104.131">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l104.132"></a><span id="l104.132">  * resulting multiget.</span>
<a href="#l104.133"></a><span id="l104.133">  *</span>
<a href="#l104.134"></a><span id="l104.134">  * @param aCalendar             The (unwrapped) calendar this request belongs to</span>
<a href="#l104.135"></a><span id="l104.135" class="difflineat">@@ -304,17 +304,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.136"></a><span id="l104.136"> </span>
<a href="#l104.137"></a><span id="l104.137">   QueryInterface: cal.generateQI([</span>
<a href="#l104.138"></a><span id="l104.138">     Ci.nsISAXContentHandler,</span>
<a href="#l104.139"></a><span id="l104.139">     Ci.nsISAXErrorHandler,</span>
<a href="#l104.140"></a><span id="l104.140">     Ci.nsIRequestObserver,</span>
<a href="#l104.141"></a><span id="l104.141">     Ci.nsIStreamListener,</span>
<a href="#l104.142"></a><span id="l104.142">   ]),</span>
<a href="#l104.143"></a><span id="l104.143"> </span>
<a href="#l104.144"></a><span id="l104.144" class="difflineminus">-  doWebDAVSync: function() {</span>
<a href="#l104.145"></a><span id="l104.145" class="difflineplus">+  doWebDAVSync() {</span>
<a href="#l104.146"></a><span id="l104.146">     if (this.calendar.mDisabled) {</span>
<a href="#l104.147"></a><span id="l104.147">       // check if maybe our calendar has become available</span>
<a href="#l104.148"></a><span id="l104.148">       this.calendar.setupAuthentication(this.changeLogListener);</span>
<a href="#l104.149"></a><span id="l104.149">       return;</span>
<a href="#l104.150"></a><span id="l104.150">     }</span>
<a href="#l104.151"></a><span id="l104.151"> </span>
<a href="#l104.152"></a><span id="l104.152">     let syncTokenString = &quot;&lt;sync-token/&gt;&quot;;</span>
<a href="#l104.153"></a><span id="l104.153">     if (this.calendar.mWebdavSyncToken &amp;&amp; this.calendar.mWebdavSyncToken.length &gt; 0) {</span>
<a href="#l104.154"></a><span id="l104.154" class="difflineat">@@ -365,17 +365,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.155"></a><span id="l104.155">       },</span>
<a href="#l104.156"></a><span id="l104.156">       false</span>
<a href="#l104.157"></a><span id="l104.157">     );</span>
<a href="#l104.158"></a><span id="l104.158">   },</span>
<a href="#l104.159"></a><span id="l104.159"> </span>
<a href="#l104.160"></a><span id="l104.160">   /**</span>
<a href="#l104.161"></a><span id="l104.161">    * @see nsIStreamListener</span>
<a href="#l104.162"></a><span id="l104.162">    */</span>
<a href="#l104.163"></a><span id="l104.163" class="difflineminus">-  onStartRequest: function(request) {</span>
<a href="#l104.164"></a><span id="l104.164" class="difflineplus">+  onStartRequest(request) {</span>
<a href="#l104.165"></a><span id="l104.165">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l104.166"></a><span id="l104.166"> </span>
<a href="#l104.167"></a><span id="l104.167">     let responseStatus;</span>
<a href="#l104.168"></a><span id="l104.168">     try {</span>
<a href="#l104.169"></a><span id="l104.169">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l104.170"></a><span id="l104.170">     } catch (ex) {</span>
<a href="#l104.171"></a><span id="l104.171">       cal.WARN(&quot;CalDAV: No response status doing webdav sync for calendar &quot; + this.calendar.name);</span>
<a href="#l104.172"></a><span id="l104.172">     }</span>
<a href="#l104.173"></a><span id="l104.173" class="difflineat">@@ -404,64 +404,64 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.174"></a><span id="l104.174">       this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l104.175"></a><span id="l104.175">       if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l104.176"></a><span id="l104.176">         this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l104.177"></a><span id="l104.177">       }</span>
<a href="#l104.178"></a><span id="l104.178">       this._reader = null;</span>
<a href="#l104.179"></a><span id="l104.179">     }</span>
<a href="#l104.180"></a><span id="l104.180">   },</span>
<a href="#l104.181"></a><span id="l104.181"> </span>
<a href="#l104.182"></a><span id="l104.182" class="difflineminus">-  onStopRequest: function(request, statusCode) {</span>
<a href="#l104.183"></a><span id="l104.183" class="difflineplus">+  onStopRequest(request, statusCode) {</span>
<a href="#l104.184"></a><span id="l104.184">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.185"></a><span id="l104.185">       cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l104.186"></a><span id="l104.186">     }</span>
<a href="#l104.187"></a><span id="l104.187">     if (!this._reader) {</span>
<a href="#l104.188"></a><span id="l104.188">       // No reader means there was a request error</span>
<a href="#l104.189"></a><span id="l104.189">       cal.LOG(&quot;CalDAV: onStopRequest: no reader&quot;);</span>
<a href="#l104.190"></a><span id="l104.190">       return;</span>
<a href="#l104.191"></a><span id="l104.191">     }</span>
<a href="#l104.192"></a><span id="l104.192">     try {</span>
<a href="#l104.193"></a><span id="l104.193">       this._reader.onStopRequest(request, statusCode);</span>
<a href="#l104.194"></a><span id="l104.194">     } finally {</span>
<a href="#l104.195"></a><span id="l104.195">       this._reader = null;</span>
<a href="#l104.196"></a><span id="l104.196">     }</span>
<a href="#l104.197"></a><span id="l104.197">   },</span>
<a href="#l104.198"></a><span id="l104.198"> </span>
<a href="#l104.199"></a><span id="l104.199" class="difflineminus">-  onDataAvailable: function(request, inputStream, offset, count) {</span>
<a href="#l104.200"></a><span id="l104.200" class="difflineplus">+  onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l104.201"></a><span id="l104.201">     if (this._reader) {</span>
<a href="#l104.202"></a><span id="l104.202">       // No reader means request error</span>
<a href="#l104.203"></a><span id="l104.203">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l104.204"></a><span id="l104.204">     }</span>
<a href="#l104.205"></a><span id="l104.205">   },</span>
<a href="#l104.206"></a><span id="l104.206"> </span>
<a href="#l104.207"></a><span id="l104.207">   /**</span>
<a href="#l104.208"></a><span id="l104.208">    * @see nsISAXErrorHandler</span>
<a href="#l104.209"></a><span id="l104.209">    */</span>
<a href="#l104.210"></a><span id="l104.210" class="difflineminus">-  fatalError: function() {</span>
<a href="#l104.211"></a><span id="l104.211" class="difflineplus">+  fatalError() {</span>
<a href="#l104.212"></a><span id="l104.212">     cal.WARN(&quot;CalDAV: Fatal Error doing webdav sync for &quot; + this.calendar.name);</span>
<a href="#l104.213"></a><span id="l104.213">   },</span>
<a href="#l104.214"></a><span id="l104.214"> </span>
<a href="#l104.215"></a><span id="l104.215">   /**</span>
<a href="#l104.216"></a><span id="l104.216">    * @see nsISAXContentHandler</span>
<a href="#l104.217"></a><span id="l104.217">    */</span>
<a href="#l104.218"></a><span id="l104.218" class="difflineminus">-  characters: function(aValue) {</span>
<a href="#l104.219"></a><span id="l104.219" class="difflineplus">+  characters(aValue) {</span>
<a href="#l104.220"></a><span id="l104.220">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.221"></a><span id="l104.221">       this.logXML += aValue;</span>
<a href="#l104.222"></a><span id="l104.222">     }</span>
<a href="#l104.223"></a><span id="l104.223">     this.currentResponse[this.tag] += aValue;</span>
<a href="#l104.224"></a><span id="l104.224">   },</span>
<a href="#l104.225"></a><span id="l104.225"> </span>
<a href="#l104.226"></a><span id="l104.226" class="difflineminus">-  startDocument: function() {</span>
<a href="#l104.227"></a><span id="l104.227" class="difflineplus">+  startDocument() {</span>
<a href="#l104.228"></a><span id="l104.228">     this.hrefMap = {};</span>
<a href="#l104.229"></a><span id="l104.229">     this.currentResponse = {};</span>
<a href="#l104.230"></a><span id="l104.230">     this.tag = null;</span>
<a href="#l104.231"></a><span id="l104.231">     this.calendar.superCalendar.startBatch();</span>
<a href="#l104.232"></a><span id="l104.232">   },</span>
<a href="#l104.233"></a><span id="l104.233"> </span>
<a href="#l104.234"></a><span id="l104.234" class="difflineminus">-  endDocument: function() {</span>
<a href="#l104.235"></a><span id="l104.235" class="difflineplus">+  endDocument() {</span>
<a href="#l104.236"></a><span id="l104.236">     if (this.unhandledErrors) {</span>
<a href="#l104.237"></a><span id="l104.237">       this.calendar.superCalendar.endBatch();</span>
<a href="#l104.238"></a><span id="l104.238">       this.calendar.reportDavError(Ci.calIErrors.DAV_REPORT_ERROR);</span>
<a href="#l104.239"></a><span id="l104.239">       if (this.calendar.isCached &amp;&amp; this.changeLogListener) {</span>
<a href="#l104.240"></a><span id="l104.240">         this.changeLogListener.onResult({ status: Cr.NS_ERROR_FAILURE }, Cr.NS_ERROR_FAILURE);</span>
<a href="#l104.241"></a><span id="l104.241">       }</span>
<a href="#l104.242"></a><span id="l104.242">       return;</span>
<a href="#l104.243"></a><span id="l104.243">     }</span>
<a href="#l104.244"></a><span id="l104.244" class="difflineat">@@ -494,17 +494,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.245"></a><span id="l104.245">         this.calendar.mWebdavSyncToken = this.newSyncToken;</span>
<a href="#l104.246"></a><span id="l104.246">         this.calendar.saveCalendarProperties();</span>
<a href="#l104.247"></a><span id="l104.247">         cal.LOG(&quot;CalDAV: New webdav-sync Token: &quot; + this.calendar.mWebdavSyncToken);</span>
<a href="#l104.248"></a><span id="l104.248">       }</span>
<a href="#l104.249"></a><span id="l104.249">       this.calendar.finalizeUpdatedItems(this.changeLogListener, this.baseUri);</span>
<a href="#l104.250"></a><span id="l104.250">     }</span>
<a href="#l104.251"></a><span id="l104.251">   },</span>
<a href="#l104.252"></a><span id="l104.252"> </span>
<a href="#l104.253"></a><span id="l104.253" class="difflineminus">-  startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.254"></a><span id="l104.254" class="difflineplus">+  startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.255"></a><span id="l104.255">     switch (aLocalName) {</span>
<a href="#l104.256"></a><span id="l104.256">       case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l104.257"></a><span id="l104.257">         this.currentResponse = {};</span>
<a href="#l104.258"></a><span id="l104.258">         this.tag = null;</span>
<a href="#l104.259"></a><span id="l104.259">         this.isInPropStat = false;</span>
<a href="#l104.260"></a><span id="l104.260">         break;</span>
<a href="#l104.261"></a><span id="l104.261">       case &quot;propstat&quot;:</span>
<a href="#l104.262"></a><span id="l104.262">         this.isInPropStat = true;</span>
<a href="#l104.263"></a><span id="l104.263" class="difflineat">@@ -525,17 +525,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.264"></a><span id="l104.264">         this.currentResponse[this.tag] = &quot;&quot;;</span>
<a href="#l104.265"></a><span id="l104.265">         break;</span>
<a href="#l104.266"></a><span id="l104.266">     }</span>
<a href="#l104.267"></a><span id="l104.267">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.268"></a><span id="l104.268">       this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.269"></a><span id="l104.269">     }</span>
<a href="#l104.270"></a><span id="l104.270">   },</span>
<a href="#l104.271"></a><span id="l104.271"> </span>
<a href="#l104.272"></a><span id="l104.272" class="difflineminus">-  endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l104.273"></a><span id="l104.273" class="difflineplus">+  endElement(aUri, aLocalName, aQName) {</span>
<a href="#l104.274"></a><span id="l104.274">     switch (aLocalName) {</span>
<a href="#l104.275"></a><span id="l104.275">       case &quot;response&quot;: // WebDAV Sync draft 3</span>
<a href="#l104.276"></a><span id="l104.276">       case &quot;sync-response&quot;: {</span>
<a href="#l104.277"></a><span id="l104.277">         // WebDAV Sync draft 0,1,2</span>
<a href="#l104.278"></a><span id="l104.278">         let resp = this.currentResponse;</span>
<a href="#l104.279"></a><span id="l104.279">         if (resp.href &amp;&amp; resp.href.length) {</span>
<a href="#l104.280"></a><span id="l104.280">           resp.href = this.calendar.ensureDecodedPath(resp.href);</span>
<a href="#l104.281"></a><span id="l104.281">         }</span>
<a href="#l104.282"></a><span id="l104.282" class="difflineat">@@ -643,17 +643,17 @@ webDavSyncHandler.prototype = {</span>
<a href="#l104.283"></a><span id="l104.283">       }</span>
<a href="#l104.284"></a><span id="l104.284">     }</span>
<a href="#l104.285"></a><span id="l104.285">     this.tag = null;</span>
<a href="#l104.286"></a><span id="l104.286">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.287"></a><span id="l104.287">       this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.288"></a><span id="l104.288">     }</span>
<a href="#l104.289"></a><span id="l104.289">   },</span>
<a href="#l104.290"></a><span id="l104.290"> </span>
<a href="#l104.291"></a><span id="l104.291" class="difflineminus">-  processingInstruction: function(aTarget, aData) {},</span>
<a href="#l104.292"></a><span id="l104.292" class="difflineplus">+  processingInstruction(aTarget, aData) {},</span>
<a href="#l104.293"></a><span id="l104.293"> };</span>
<a href="#l104.294"></a><span id="l104.294"> </span>
<a href="#l104.295"></a><span id="l104.295"> /**</span>
<a href="#l104.296"></a><span id="l104.296">  * This is a handler for the multiget request.</span>
<a href="#l104.297"></a><span id="l104.297">  * It uses the SAX parser to incrementally parse the items and compose the</span>
<a href="#l104.298"></a><span id="l104.298">  * resulting multiget.</span>
<a href="#l104.299"></a><span id="l104.299">  *</span>
<a href="#l104.300"></a><span id="l104.300">  * @param aItemsNeedFetching    The array of items to fetch, this must be an</span>
<a href="#l104.301"></a><span id="l104.301" class="difflineat">@@ -705,17 +705,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.302"></a><span id="l104.302"> </span>
<a href="#l104.303"></a><span id="l104.303">   QueryInterface: cal.generateQI([</span>
<a href="#l104.304"></a><span id="l104.304">     Ci.nsISAXContentHandler,</span>
<a href="#l104.305"></a><span id="l104.305">     Ci.nsISAXErrorHandler,</span>
<a href="#l104.306"></a><span id="l104.306">     Ci.nsIRequestObserver,</span>
<a href="#l104.307"></a><span id="l104.307">     Ci.nsIStreamListener,</span>
<a href="#l104.308"></a><span id="l104.308">   ]),</span>
<a href="#l104.309"></a><span id="l104.309"> </span>
<a href="#l104.310"></a><span id="l104.310" class="difflineminus">-  doMultiGet: function() {</span>
<a href="#l104.311"></a><span id="l104.311" class="difflineplus">+  doMultiGet() {</span>
<a href="#l104.312"></a><span id="l104.312">     if (this.calendar.mDisabled) {</span>
<a href="#l104.313"></a><span id="l104.313">       // check if maybe our calendar has become available</span>
<a href="#l104.314"></a><span id="l104.314">       this.calendar.setupAuthentication(this.changeLogListener);</span>
<a href="#l104.315"></a><span id="l104.315">       return;</span>
<a href="#l104.316"></a><span id="l104.316">     }</span>
<a href="#l104.317"></a><span id="l104.317"> </span>
<a href="#l104.318"></a><span id="l104.318">     let batchSize = Services.prefs.getIntPref(&quot;calendar.caldav.multigetBatchSize&quot;, 100);</span>
<a href="#l104.319"></a><span id="l104.319">     let hrefString = &quot;&quot;;</span>
<a href="#l104.320"></a><span id="l104.320" class="difflineat">@@ -762,17 +762,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.321"></a><span id="l104.321">       },</span>
<a href="#l104.322"></a><span id="l104.322">       false</span>
<a href="#l104.323"></a><span id="l104.323">     );</span>
<a href="#l104.324"></a><span id="l104.324">   },</span>
<a href="#l104.325"></a><span id="l104.325"> </span>
<a href="#l104.326"></a><span id="l104.326">   /**</span>
<a href="#l104.327"></a><span id="l104.327">    * @see nsIStreamListener</span>
<a href="#l104.328"></a><span id="l104.328">    */</span>
<a href="#l104.329"></a><span id="l104.329" class="difflineminus">-  onStartRequest: function(request) {</span>
<a href="#l104.330"></a><span id="l104.330" class="difflineplus">+  onStartRequest(request) {</span>
<a href="#l104.331"></a><span id="l104.331">     let httpchannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l104.332"></a><span id="l104.332"> </span>
<a href="#l104.333"></a><span id="l104.333">     let responseStatus;</span>
<a href="#l104.334"></a><span id="l104.334">     try {</span>
<a href="#l104.335"></a><span id="l104.335">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l104.336"></a><span id="l104.336">     } catch (ex) {</span>
<a href="#l104.337"></a><span id="l104.337">       cal.WARN(&quot;CalDAV: No response status doing multiget for calendar &quot; + this.calendar.name);</span>
<a href="#l104.338"></a><span id="l104.338">     }</span>
<a href="#l104.339"></a><span id="l104.339" class="difflineat">@@ -790,17 +790,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.340"></a><span id="l104.340">         this.calendar.name +</span>
<a href="#l104.341"></a><span id="l104.341">         &quot;, &quot; +</span>
<a href="#l104.342"></a><span id="l104.342">         this.listener;</span>
<a href="#l104.343"></a><span id="l104.343">       this.calendar.notifyGetFailed(errorMsg, this.listener, this.changeLogListener);</span>
<a href="#l104.344"></a><span id="l104.344">       this._reader = null;</span>
<a href="#l104.345"></a><span id="l104.345">     }</span>
<a href="#l104.346"></a><span id="l104.346">   },</span>
<a href="#l104.347"></a><span id="l104.347"> </span>
<a href="#l104.348"></a><span id="l104.348" class="difflineminus">-  onStopRequest: function(request, statusCode) {</span>
<a href="#l104.349"></a><span id="l104.349" class="difflineplus">+  onStopRequest(request, statusCode) {</span>
<a href="#l104.350"></a><span id="l104.350">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.351"></a><span id="l104.351">       cal.LOG(&quot;CalDAV: recv: &quot; + this.logXML);</span>
<a href="#l104.352"></a><span id="l104.352">     }</span>
<a href="#l104.353"></a><span id="l104.353">     if (this.unhandledErrors) {</span>
<a href="#l104.354"></a><span id="l104.354">       this.calendar.superCalendar.endBatch();</span>
<a href="#l104.355"></a><span id="l104.355">       this.calendar.notifyGetFailed(&quot;multiget error&quot;, this.listener, this.changeLogListener);</span>
<a href="#l104.356"></a><span id="l104.356">       return;</span>
<a href="#l104.357"></a><span id="l104.357">     }</span>
<a href="#l104.358"></a><span id="l104.358" class="difflineat">@@ -834,63 +834,63 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.359"></a><span id="l104.359">     if (this.itemsNeedFetching.length &gt; 0) {</span>
<a href="#l104.360"></a><span id="l104.360">       cal.LOG(&quot;CalDAV: Still need to fetch &quot; + this.itemsNeedFetching.length + &quot; elements.&quot;);</span>
<a href="#l104.361"></a><span id="l104.361">       this._reader = Cc[&quot;@mozilla.org/saxparser/xmlreader;1&quot;].createInstance(Ci.nsISAXXMLReader);</span>
<a href="#l104.362"></a><span id="l104.362">       this._reader.contentHandler = this;</span>
<a href="#l104.363"></a><span id="l104.363">       this._reader.errorHandler = this;</span>
<a href="#l104.364"></a><span id="l104.364">       this._reader.parseAsync(null);</span>
<a href="#l104.365"></a><span id="l104.365">       let timerCallback = {</span>
<a href="#l104.366"></a><span id="l104.366">         requestHandler: this,</span>
<a href="#l104.367"></a><span id="l104.367" class="difflineminus">-        notify: function(timer) {</span>
<a href="#l104.368"></a><span id="l104.368" class="difflineplus">+        notify(timer) {</span>
<a href="#l104.369"></a><span id="l104.369">           // Call multiget again to get another batch</span>
<a href="#l104.370"></a><span id="l104.370">           this.requestHandler.doMultiGet();</span>
<a href="#l104.371"></a><span id="l104.371">         },</span>
<a href="#l104.372"></a><span id="l104.372">       };</span>
<a href="#l104.373"></a><span id="l104.373">       this.timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l104.374"></a><span id="l104.374">       this.timer.initWithCallback(timerCallback, 0, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l104.375"></a><span id="l104.375">     }</span>
<a href="#l104.376"></a><span id="l104.376">   },</span>
<a href="#l104.377"></a><span id="l104.377"> </span>
<a href="#l104.378"></a><span id="l104.378" class="difflineminus">-  onDataAvailable: function(request, inputStream, offset, count) {</span>
<a href="#l104.379"></a><span id="l104.379" class="difflineplus">+  onDataAvailable(request, inputStream, offset, count) {</span>
<a href="#l104.380"></a><span id="l104.380">     if (this._reader) {</span>
<a href="#l104.381"></a><span id="l104.381">       // No reader means request error</span>
<a href="#l104.382"></a><span id="l104.382">       this._reader.onDataAvailable(request, inputStream, offset, count);</span>
<a href="#l104.383"></a><span id="l104.383">     }</span>
<a href="#l104.384"></a><span id="l104.384">   },</span>
<a href="#l104.385"></a><span id="l104.385"> </span>
<a href="#l104.386"></a><span id="l104.386">   /**</span>
<a href="#l104.387"></a><span id="l104.387">    * @see nsISAXErrorHandler</span>
<a href="#l104.388"></a><span id="l104.388">    */</span>
<a href="#l104.389"></a><span id="l104.389" class="difflineminus">-  fatalError: function() {</span>
<a href="#l104.390"></a><span id="l104.390" class="difflineplus">+  fatalError() {</span>
<a href="#l104.391"></a><span id="l104.391">     cal.WARN(&quot;CalDAV: Fatal Error doing multiget for &quot; + this.calendar.name);</span>
<a href="#l104.392"></a><span id="l104.392">   },</span>
<a href="#l104.393"></a><span id="l104.393"> </span>
<a href="#l104.394"></a><span id="l104.394">   /**</span>
<a href="#l104.395"></a><span id="l104.395">    * @see nsISAXContentHandler</span>
<a href="#l104.396"></a><span id="l104.396">    */</span>
<a href="#l104.397"></a><span id="l104.397" class="difflineminus">-  characters: function(aValue) {</span>
<a href="#l104.398"></a><span id="l104.398" class="difflineplus">+  characters(aValue) {</span>
<a href="#l104.399"></a><span id="l104.399">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.400"></a><span id="l104.400">       this.logXML += aValue;</span>
<a href="#l104.401"></a><span id="l104.401">     }</span>
<a href="#l104.402"></a><span id="l104.402">     this.currentResponse[this.tag] += aValue;</span>
<a href="#l104.403"></a><span id="l104.403">   },</span>
<a href="#l104.404"></a><span id="l104.404"> </span>
<a href="#l104.405"></a><span id="l104.405" class="difflineminus">-  startDocument: function() {</span>
<a href="#l104.406"></a><span id="l104.406" class="difflineplus">+  startDocument() {</span>
<a href="#l104.407"></a><span id="l104.407">     this.hrefMap = {};</span>
<a href="#l104.408"></a><span id="l104.408">     this.currentResponse = {};</span>
<a href="#l104.409"></a><span id="l104.409">     this.tag = null;</span>
<a href="#l104.410"></a><span id="l104.410">     this.logXML = &quot;&quot;;</span>
<a href="#l104.411"></a><span id="l104.411">     this.calendar.superCalendar.startBatch();</span>
<a href="#l104.412"></a><span id="l104.412">   },</span>
<a href="#l104.413"></a><span id="l104.413"> </span>
<a href="#l104.414"></a><span id="l104.414" class="difflineminus">-  endDocument: function() {</span>
<a href="#l104.415"></a><span id="l104.415" class="difflineplus">+  endDocument() {</span>
<a href="#l104.416"></a><span id="l104.416">     this.calendar.superCalendar.endBatch();</span>
<a href="#l104.417"></a><span id="l104.417">   },</span>
<a href="#l104.418"></a><span id="l104.418"> </span>
<a href="#l104.419"></a><span id="l104.419" class="difflineminus">-  startElement: function(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.420"></a><span id="l104.420" class="difflineplus">+  startElement(aUri, aLocalName, aQName, aAttributes) {</span>
<a href="#l104.421"></a><span id="l104.421">     switch (aLocalName) {</span>
<a href="#l104.422"></a><span id="l104.422">       case &quot;response&quot;:</span>
<a href="#l104.423"></a><span id="l104.423">         this.currentResponse = {};</span>
<a href="#l104.424"></a><span id="l104.424">         this.tag = null;</span>
<a href="#l104.425"></a><span id="l104.425">         this.isInPropStat = false;</span>
<a href="#l104.426"></a><span id="l104.426">         break;</span>
<a href="#l104.427"></a><span id="l104.427">       case &quot;propstat&quot;:</span>
<a href="#l104.428"></a><span id="l104.428">         this.isInPropStat = true;</span>
<a href="#l104.429"></a><span id="l104.429" class="difflineat">@@ -910,17 +910,17 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.430"></a><span id="l104.430">         this.currentResponse[this.tag] = &quot;&quot;;</span>
<a href="#l104.431"></a><span id="l104.431">         break;</span>
<a href="#l104.432"></a><span id="l104.432">     }</span>
<a href="#l104.433"></a><span id="l104.433">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.434"></a><span id="l104.434">       this.logXML += &quot;&lt;&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.435"></a><span id="l104.435">     }</span>
<a href="#l104.436"></a><span id="l104.436">   },</span>
<a href="#l104.437"></a><span id="l104.437"> </span>
<a href="#l104.438"></a><span id="l104.438" class="difflineminus">-  endElement: function(aUri, aLocalName, aQName) {</span>
<a href="#l104.439"></a><span id="l104.439" class="difflineplus">+  endElement(aUri, aLocalName, aQName) {</span>
<a href="#l104.440"></a><span id="l104.440">     switch (aLocalName) {</span>
<a href="#l104.441"></a><span id="l104.441">       case &quot;response&quot;: {</span>
<a href="#l104.442"></a><span id="l104.442">         let resp = this.currentResponse;</span>
<a href="#l104.443"></a><span id="l104.443">         if (resp.href &amp;&amp; resp.href.length) {</span>
<a href="#l104.444"></a><span id="l104.444">           resp.href = this.calendar.ensureDecodedPath(resp.href);</span>
<a href="#l104.445"></a><span id="l104.445">         }</span>
<a href="#l104.446"></a><span id="l104.446">         if (</span>
<a href="#l104.447"></a><span id="l104.447">           resp.href &amp;&amp;</span>
<a href="#l104.448"></a><span id="l104.448" class="difflineat">@@ -982,10 +982,10 @@ multigetSyncHandler.prototype = {</span>
<a href="#l104.449"></a><span id="l104.449">       }</span>
<a href="#l104.450"></a><span id="l104.450">     }</span>
<a href="#l104.451"></a><span id="l104.451">     this.tag = null;</span>
<a href="#l104.452"></a><span id="l104.452">     if (this.calendar.verboseLogging()) {</span>
<a href="#l104.453"></a><span id="l104.453">       this.logXML += &quot;&lt;/&quot; + aQName + &quot;&gt;&quot;;</span>
<a href="#l104.454"></a><span id="l104.454">     }</span>
<a href="#l104.455"></a><span id="l104.455">   },</span>
<a href="#l104.456"></a><span id="l104.456"> </span>
<a href="#l104.457"></a><span id="l104.457" class="difflineminus">-  processingInstruction: function(aTarget, aData) {},</span>
<a href="#l104.458"></a><span id="l104.458" class="difflineplus">+  processingInstruction(aTarget, aData) {},</span>
<a href="#l104.459"></a><span id="l104.459"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/calendar/providers/composite/calCompositeCalendar.js</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -19,58 +19,58 @@ function calCompositeCalendarObserverHel</span>
<a href="#l105.4"></a><span id="l105.4">   this.pendingLoads = {};</span>
<a href="#l105.5"></a><span id="l105.5"> }</span>
<a href="#l105.6"></a><span id="l105.6"> </span>
<a href="#l105.7"></a><span id="l105.7"> calCompositeCalendarObserverHelper.prototype = {</span>
<a href="#l105.8"></a><span id="l105.8">   pendingLoads: null,</span>
<a href="#l105.9"></a><span id="l105.9"> </span>
<a href="#l105.10"></a><span id="l105.10">   QueryInterface: ChromeUtils.generateQI([Ci.calIObserver]),</span>
<a href="#l105.11"></a><span id="l105.11"> </span>
<a href="#l105.12"></a><span id="l105.12" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+  onStartBatch() {</span>
<a href="#l105.14"></a><span id="l105.14">     this.compCalendar.mObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l105.15"></a><span id="l105.15">   },</span>
<a href="#l105.16"></a><span id="l105.16"> </span>
<a href="#l105.17"></a><span id="l105.17" class="difflineminus">-  onEndBatch: function() {</span>
<a href="#l105.18"></a><span id="l105.18" class="difflineplus">+  onEndBatch() {</span>
<a href="#l105.19"></a><span id="l105.19">     this.compCalendar.mObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l105.20"></a><span id="l105.20">   },</span>
<a href="#l105.21"></a><span id="l105.21"> </span>
<a href="#l105.22"></a><span id="l105.22" class="difflineminus">-  onLoad: function(calendar) {</span>
<a href="#l105.23"></a><span id="l105.23" class="difflineplus">+  onLoad(calendar) {</span>
<a href="#l105.24"></a><span id="l105.24">     // avoid unnecessary onLoad events:</span>
<a href="#l105.25"></a><span id="l105.25">     if (this.pendingLoads[calendar.id]) {</span>
<a href="#l105.26"></a><span id="l105.26">       // don't forward if caused by composite:</span>
<a href="#l105.27"></a><span id="l105.27">       delete this.pendingLoads[calendar.id];</span>
<a href="#l105.28"></a><span id="l105.28">     } else {</span>
<a href="#l105.29"></a><span id="l105.29">       // any refreshed dependent calendar logically refreshes</span>
<a href="#l105.30"></a><span id="l105.30">       // this composite calendar, thus we send out an onLoad</span>
<a href="#l105.31"></a><span id="l105.31">       // for this composite calendar:</span>
<a href="#l105.32"></a><span id="l105.32">       this.compCalendar.mObservers.notify(&quot;onLoad&quot;, [this.compCalendar]);</span>
<a href="#l105.33"></a><span id="l105.33">     }</span>
<a href="#l105.34"></a><span id="l105.34">   },</span>
<a href="#l105.35"></a><span id="l105.35"> </span>
<a href="#l105.36"></a><span id="l105.36" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l105.37"></a><span id="l105.37" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l105.38"></a><span id="l105.38">     this.compCalendar.mObservers.notify(&quot;onAddItem&quot;, arguments);</span>
<a href="#l105.39"></a><span id="l105.39">   },</span>
<a href="#l105.40"></a><span id="l105.40"> </span>
<a href="#l105.41"></a><span id="l105.41" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l105.42"></a><span id="l105.42" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l105.43"></a><span id="l105.43">     this.compCalendar.mObservers.notify(&quot;onModifyItem&quot;, arguments);</span>
<a href="#l105.44"></a><span id="l105.44">   },</span>
<a href="#l105.45"></a><span id="l105.45"> </span>
<a href="#l105.46"></a><span id="l105.46" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l105.47"></a><span id="l105.47" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l105.48"></a><span id="l105.48">     this.compCalendar.mObservers.notify(&quot;onDeleteItem&quot;, arguments);</span>
<a href="#l105.49"></a><span id="l105.49">   },</span>
<a href="#l105.50"></a><span id="l105.50"> </span>
<a href="#l105.51"></a><span id="l105.51" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l105.52"></a><span id="l105.52" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l105.53"></a><span id="l105.53">     this.compCalendar.mObservers.notify(&quot;onError&quot;, arguments);</span>
<a href="#l105.54"></a><span id="l105.54">   },</span>
<a href="#l105.55"></a><span id="l105.55"> </span>
<a href="#l105.56"></a><span id="l105.56" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l105.57"></a><span id="l105.57" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l105.58"></a><span id="l105.58">     this.compCalendar.mObservers.notify(&quot;onPropertyChanged&quot;, arguments);</span>
<a href="#l105.59"></a><span id="l105.59">   },</span>
<a href="#l105.60"></a><span id="l105.60"> </span>
<a href="#l105.61"></a><span id="l105.61" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l105.62"></a><span id="l105.62" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l105.63"></a><span id="l105.63">     this.compCalendar.mObservers.notify(&quot;onPropertyDeleting&quot;, arguments);</span>
<a href="#l105.64"></a><span id="l105.64">   },</span>
<a href="#l105.65"></a><span id="l105.65"> };</span>
<a href="#l105.66"></a><span id="l105.66"> </span>
<a href="#l105.67"></a><span id="l105.67"> function calCompositeCalendar() {</span>
<a href="#l105.68"></a><span id="l105.68">   this.mObserverHelper = new calCompositeCalendarObserverHelper(this);</span>
<a href="#l105.69"></a><span id="l105.69">   this.wrappedJSObject = this;</span>
<a href="#l105.70"></a><span id="l105.70"> </span>
<a href="#l105.71"></a><span id="l105.71" class="difflineat">@@ -96,21 +96,21 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.72"></a><span id="l105.72">   //</span>
<a href="#l105.73"></a><span id="l105.73">   get prefChromeOverlay() {</span>
<a href="#l105.74"></a><span id="l105.74">     return null;</span>
<a href="#l105.75"></a><span id="l105.75">   },</span>
<a href="#l105.76"></a><span id="l105.76">   get displayName() {</span>
<a href="#l105.77"></a><span id="l105.77">     return cal.l10n.getCalString(&quot;compositeName&quot;);</span>
<a href="#l105.78"></a><span id="l105.78">   },</span>
<a href="#l105.79"></a><span id="l105.79"> </span>
<a href="#l105.80"></a><span id="l105.80" class="difflineminus">-  createCalendar: function() {</span>
<a href="#l105.81"></a><span id="l105.81" class="difflineplus">+  createCalendar() {</span>
<a href="#l105.82"></a><span id="l105.82">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l105.83"></a><span id="l105.83">   },</span>
<a href="#l105.84"></a><span id="l105.84"> </span>
<a href="#l105.85"></a><span id="l105.85" class="difflineminus">-  deleteCalendar: function(calendar, listener) {</span>
<a href="#l105.86"></a><span id="l105.86" class="difflineplus">+  deleteCalendar(calendar, listener) {</span>
<a href="#l105.87"></a><span id="l105.87">     // You shouldn't be able to delete from the composite calendar.</span>
<a href="#l105.88"></a><span id="l105.88">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l105.89"></a><span id="l105.89">   },</span>
<a href="#l105.90"></a><span id="l105.90"> </span>
<a href="#l105.91"></a><span id="l105.91">   //</span>
<a href="#l105.92"></a><span id="l105.92">   // calICompositeCalendar interface</span>
<a href="#l105.93"></a><span id="l105.93">   //</span>
<a href="#l105.94"></a><span id="l105.94"> </span>
<a href="#l105.95"></a><span id="l105.95" class="difflineat">@@ -145,17 +145,17 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.96"></a><span id="l105.96">       }</span>
<a href="#l105.97"></a><span id="l105.97">     }, this);</span>
<a href="#l105.98"></a><span id="l105.98">   },</span>
<a href="#l105.99"></a><span id="l105.99"> </span>
<a href="#l105.100"></a><span id="l105.100">   get prefPrefix() {</span>
<a href="#l105.101"></a><span id="l105.101">     return this.mPrefPrefix;</span>
<a href="#l105.102"></a><span id="l105.102">   },</span>
<a href="#l105.103"></a><span id="l105.103"> </span>
<a href="#l105.104"></a><span id="l105.104" class="difflineminus">-  addCalendar: function(aCalendar) {</span>
<a href="#l105.105"></a><span id="l105.105" class="difflineplus">+  addCalendar(aCalendar) {</span>
<a href="#l105.106"></a><span id="l105.106">     cal.ASSERT(aCalendar.id, &quot;calendar does not have an id!&quot;, true);</span>
<a href="#l105.107"></a><span id="l105.107"> </span>
<a href="#l105.108"></a><span id="l105.108">     // check if the calendar already exists</span>
<a href="#l105.109"></a><span id="l105.109">     if (this.getCalendarById(aCalendar.id)) {</span>
<a href="#l105.110"></a><span id="l105.110">       return;</span>
<a href="#l105.111"></a><span id="l105.111">     }</span>
<a href="#l105.112"></a><span id="l105.112"> </span>
<a href="#l105.113"></a><span id="l105.113">     // add our observer helper</span>
<a href="#l105.114"></a><span id="l105.114" class="difflineat">@@ -168,48 +168,48 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.115"></a><span id="l105.115">     this.mCompositeObservers.notify(&quot;onCalendarAdded&quot;, [aCalendar]);</span>
<a href="#l105.116"></a><span id="l105.116"> </span>
<a href="#l105.117"></a><span id="l105.117">     // if we have no default calendar, we need one here</span>
<a href="#l105.118"></a><span id="l105.118">     if (this.mDefaultCalendar == null &amp;&amp; !aCalendar.getProperty(&quot;disabled&quot;)) {</span>
<a href="#l105.119"></a><span id="l105.119">       this.setDefaultCalendar(aCalendar, false);</span>
<a href="#l105.120"></a><span id="l105.120">     }</span>
<a href="#l105.121"></a><span id="l105.121">   },</span>
<a href="#l105.122"></a><span id="l105.122"> </span>
<a href="#l105.123"></a><span id="l105.123" class="difflineminus">-  removeCalendar: function(aCalendar) {</span>
<a href="#l105.124"></a><span id="l105.124" class="difflineplus">+  removeCalendar(aCalendar) {</span>
<a href="#l105.125"></a><span id="l105.125">     let id = aCalendar.id;</span>
<a href="#l105.126"></a><span id="l105.126">     let newCalendars = this.mCalendars.filter(calendar =&gt; calendar.id != id);</span>
<a href="#l105.127"></a><span id="l105.127">     if (newCalendars.length != this.mCalendars) {</span>
<a href="#l105.128"></a><span id="l105.128">       this.mCalendars = newCalendars;</span>
<a href="#l105.129"></a><span id="l105.129">       if (this.mPrefPrefix) {</span>
<a href="#l105.130"></a><span id="l105.130">         aCalendar.deleteProperty(this.mActivePref);</span>
<a href="#l105.131"></a><span id="l105.131">         aCalendar.deleteProperty(this.mDefaultPref);</span>
<a href="#l105.132"></a><span id="l105.132">       }</span>
<a href="#l105.133"></a><span id="l105.133">       aCalendar.removeObserver(this.mObserverHelper);</span>
<a href="#l105.134"></a><span id="l105.134">       this.mCompositeObservers.notify(&quot;onCalendarRemoved&quot;, [aCalendar]);</span>
<a href="#l105.135"></a><span id="l105.135">     }</span>
<a href="#l105.136"></a><span id="l105.136">   },</span>
<a href="#l105.137"></a><span id="l105.137"> </span>
<a href="#l105.138"></a><span id="l105.138" class="difflineminus">-  getCalendarById: function(aId) {</span>
<a href="#l105.139"></a><span id="l105.139" class="difflineplus">+  getCalendarById(aId) {</span>
<a href="#l105.140"></a><span id="l105.140">     for (let calendar of this.mCalendars) {</span>
<a href="#l105.141"></a><span id="l105.141">       if (calendar.id == aId) {</span>
<a href="#l105.142"></a><span id="l105.142">         return calendar;</span>
<a href="#l105.143"></a><span id="l105.143">       }</span>
<a href="#l105.144"></a><span id="l105.144">     }</span>
<a href="#l105.145"></a><span id="l105.145">     return null;</span>
<a href="#l105.146"></a><span id="l105.146">   },</span>
<a href="#l105.147"></a><span id="l105.147"> </span>
<a href="#l105.148"></a><span id="l105.148" class="difflineminus">-  getCalendars: function() {</span>
<a href="#l105.149"></a><span id="l105.149" class="difflineplus">+  getCalendars() {</span>
<a href="#l105.150"></a><span id="l105.150">     return this.mCalendars;</span>
<a href="#l105.151"></a><span id="l105.151">   },</span>
<a href="#l105.152"></a><span id="l105.152"> </span>
<a href="#l105.153"></a><span id="l105.153">   get defaultCalendar() {</span>
<a href="#l105.154"></a><span id="l105.154">     return this.mDefaultCalendar;</span>
<a href="#l105.155"></a><span id="l105.155">   },</span>
<a href="#l105.156"></a><span id="l105.156"> </span>
<a href="#l105.157"></a><span id="l105.157" class="difflineminus">-  setDefaultCalendar: function(calendar, usePref) {</span>
<a href="#l105.158"></a><span id="l105.158" class="difflineplus">+  setDefaultCalendar(calendar, usePref) {</span>
<a href="#l105.159"></a><span id="l105.159">     // Don't do anything if the passed calendar is the default calendar</span>
<a href="#l105.160"></a><span id="l105.160">     if (calendar &amp;&amp; this.mDefaultCalendar &amp;&amp; this.mDefaultCalendar.id == calendar.id) {</span>
<a href="#l105.161"></a><span id="l105.161">       return;</span>
<a href="#l105.162"></a><span id="l105.162">     }</span>
<a href="#l105.163"></a><span id="l105.163">     if (usePref &amp;&amp; this.mPrefPrefix) {</span>
<a href="#l105.164"></a><span id="l105.164">       if (this.mDefaultCalendar) {</span>
<a href="#l105.165"></a><span id="l105.165">         this.mDefaultCalendar.deleteProperty(this.mDefaultPref);</span>
<a href="#l105.166"></a><span id="l105.166">       }</span>
<a href="#l105.167"></a><span id="l105.167" class="difflineat">@@ -276,49 +276,49 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.168"></a><span id="l105.168">   set name(val) {</span>
<a href="#l105.169"></a><span id="l105.169">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l105.170"></a><span id="l105.170">   },</span>
<a href="#l105.171"></a><span id="l105.171"> </span>
<a href="#l105.172"></a><span id="l105.172">   get type() {</span>
<a href="#l105.173"></a><span id="l105.173">     return &quot;composite&quot;;</span>
<a href="#l105.174"></a><span id="l105.174">   },</span>
<a href="#l105.175"></a><span id="l105.175"> </span>
<a href="#l105.176"></a><span id="l105.176" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l105.177"></a><span id="l105.177" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l105.178"></a><span id="l105.178">     return this.mDefaultCalendar.getProperty(aName);</span>
<a href="#l105.179"></a><span id="l105.179">   },</span>
<a href="#l105.180"></a><span id="l105.180"> </span>
<a href="#l105.181"></a><span id="l105.181" class="difflineminus">-  setProperty: function(aName, aValue) {</span>
<a href="#l105.182"></a><span id="l105.182" class="difflineplus">+  setProperty(aName, aValue) {</span>
<a href="#l105.183"></a><span id="l105.183">     return this.mDefaultCalendar.setProperty(aName, aValue);</span>
<a href="#l105.184"></a><span id="l105.184">   },</span>
<a href="#l105.185"></a><span id="l105.185"> </span>
<a href="#l105.186"></a><span id="l105.186" class="difflineminus">-  deleteProperty: function(aName) {</span>
<a href="#l105.187"></a><span id="l105.187" class="difflineplus">+  deleteProperty(aName) {</span>
<a href="#l105.188"></a><span id="l105.188">     return this.mDefaultCalendar.deleteProperty(aName);</span>
<a href="#l105.189"></a><span id="l105.189">   },</span>
<a href="#l105.190"></a><span id="l105.190"> </span>
<a href="#l105.191"></a><span id="l105.191">   // void addObserver( in calIObserver observer );</span>
<a href="#l105.192"></a><span id="l105.192">   mCompositeObservers: null,</span>
<a href="#l105.193"></a><span id="l105.193">   mObservers: null,</span>
<a href="#l105.194"></a><span id="l105.194" class="difflineminus">-  addObserver: function(aObserver) {</span>
<a href="#l105.195"></a><span id="l105.195" class="difflineplus">+  addObserver(aObserver) {</span>
<a href="#l105.196"></a><span id="l105.196">     let wrappedCObserver = cal.wrapInstance(aObserver, Ci.calICompositeObserver);</span>
<a href="#l105.197"></a><span id="l105.197">     if (wrappedCObserver) {</span>
<a href="#l105.198"></a><span id="l105.198">       this.mCompositeObservers.add(wrappedCObserver);</span>
<a href="#l105.199"></a><span id="l105.199">     }</span>
<a href="#l105.200"></a><span id="l105.200">     this.mObservers.add(aObserver);</span>
<a href="#l105.201"></a><span id="l105.201">   },</span>
<a href="#l105.202"></a><span id="l105.202"> </span>
<a href="#l105.203"></a><span id="l105.203">   // void removeObserver( in calIObserver observer );</span>
<a href="#l105.204"></a><span id="l105.204" class="difflineminus">-  removeObserver: function(aObserver) {</span>
<a href="#l105.205"></a><span id="l105.205" class="difflineplus">+  removeObserver(aObserver) {</span>
<a href="#l105.206"></a><span id="l105.206">     let wrappedCObserver = cal.wrapInstance(aObserver, Ci.calICompositeObserver);</span>
<a href="#l105.207"></a><span id="l105.207">     if (wrappedCObserver) {</span>
<a href="#l105.208"></a><span id="l105.208">       this.mCompositeObservers.delete(wrappedCObserver);</span>
<a href="#l105.209"></a><span id="l105.209">     }</span>
<a href="#l105.210"></a><span id="l105.210">     this.mObservers.delete(aObserver);</span>
<a href="#l105.211"></a><span id="l105.211">   },</span>
<a href="#l105.212"></a><span id="l105.212"> </span>
<a href="#l105.213"></a><span id="l105.213" class="difflineminus">-  refresh: function() {</span>
<a href="#l105.214"></a><span id="l105.214" class="difflineplus">+  refresh() {</span>
<a href="#l105.215"></a><span id="l105.215">     if (this.mStatusObserver) {</span>
<a href="#l105.216"></a><span id="l105.216">       this.mStatusObserver.startMeteors(</span>
<a href="#l105.217"></a><span id="l105.217">         Ci.calIStatusObserver.DETERMINED_PROGRESS,</span>
<a href="#l105.218"></a><span id="l105.218">         this.mCalendars.length</span>
<a href="#l105.219"></a><span id="l105.219">       );</span>
<a href="#l105.220"></a><span id="l105.220">     }</span>
<a href="#l105.221"></a><span id="l105.221">     for (let calendar of this.enabledCalendars) {</span>
<a href="#l105.222"></a><span id="l105.222">       try {</span>
<a href="#l105.223"></a><span id="l105.223" class="difflineat">@@ -334,54 +334,54 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.224"></a><span id="l105.224">     // send out a single onLoad for this composite calendar,</span>
<a href="#l105.225"></a><span id="l105.225">     // although e.g. the ics provider will trigger another</span>
<a href="#l105.226"></a><span id="l105.226">     // onLoad asynchronously; we cannot rely on every calendar</span>
<a href="#l105.227"></a><span id="l105.227">     // sending an onLoad:</span>
<a href="#l105.228"></a><span id="l105.228">     this.mObservers.notify(&quot;onLoad&quot;, [this]);</span>
<a href="#l105.229"></a><span id="l105.229">   },</span>
<a href="#l105.230"></a><span id="l105.230"> </span>
<a href="#l105.231"></a><span id="l105.231">   // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l105.232"></a><span id="l105.232" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l105.233"></a><span id="l105.233" class="difflineplus">+  modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l105.234"></a><span id="l105.234">     cal.ASSERT(aNewItem.calendar, &quot;Composite can't modify item with null calendar&quot;, true);</span>
<a href="#l105.235"></a><span id="l105.235">     cal.ASSERT(aNewItem.calendar != this, &quot;Composite can't modify item with this calendar&quot;, true);</span>
<a href="#l105.236"></a><span id="l105.236"> </span>
<a href="#l105.237"></a><span id="l105.237">     return aNewItem.calendar.modifyItem(aNewItem, aOldItem, aListener);</span>
<a href="#l105.238"></a><span id="l105.238">   },</span>
<a href="#l105.239"></a><span id="l105.239"> </span>
<a href="#l105.240"></a><span id="l105.240">   // void deleteItem( in string id, in calIOperationListener aListener );</span>
<a href="#l105.241"></a><span id="l105.241" class="difflineminus">-  deleteItem: function(aItem, aListener) {</span>
<a href="#l105.242"></a><span id="l105.242" class="difflineplus">+  deleteItem(aItem, aListener) {</span>
<a href="#l105.243"></a><span id="l105.243">     cal.ASSERT(aItem.calendar, &quot;Composite can't delete item with null calendar&quot;, true);</span>
<a href="#l105.244"></a><span id="l105.244">     cal.ASSERT(aItem.calendar != this, &quot;Composite can't delete item with this calendar&quot;, true);</span>
<a href="#l105.245"></a><span id="l105.245"> </span>
<a href="#l105.246"></a><span id="l105.246">     return aItem.calendar.deleteItem(aItem, aListener);</span>
<a href="#l105.247"></a><span id="l105.247">   },</span>
<a href="#l105.248"></a><span id="l105.248"> </span>
<a href="#l105.249"></a><span id="l105.249">   // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l105.250"></a><span id="l105.250" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l105.251"></a><span id="l105.251" class="difflineplus">+  addItem(aItem, aListener) {</span>
<a href="#l105.252"></a><span id="l105.252">     return this.mDefaultCalendar.addItem(aItem, aListener);</span>
<a href="#l105.253"></a><span id="l105.253">   },</span>
<a href="#l105.254"></a><span id="l105.254"> </span>
<a href="#l105.255"></a><span id="l105.255">   // void getItem( in string aId, in calIOperationListener aListener );</span>
<a href="#l105.256"></a><span id="l105.256" class="difflineminus">-  getItem: function(aId, aListener) {</span>
<a href="#l105.257"></a><span id="l105.257" class="difflineplus">+  getItem(aId, aListener) {</span>
<a href="#l105.258"></a><span id="l105.258">     let enabledCalendars = this.enabledCalendars;</span>
<a href="#l105.259"></a><span id="l105.259">     let cmpListener = new calCompositeGetListenerHelper(this, aListener);</span>
<a href="#l105.260"></a><span id="l105.260">     for (let calendar of enabledCalendars) {</span>
<a href="#l105.261"></a><span id="l105.261">       try {</span>
<a href="#l105.262"></a><span id="l105.262">         cmpListener.opGroup.add(calendar.getItem(aId, cmpListener));</span>
<a href="#l105.263"></a><span id="l105.263">       } catch (exc) {</span>
<a href="#l105.264"></a><span id="l105.264">         cal.ASSERT(false, exc);</span>
<a href="#l105.265"></a><span id="l105.265">       }</span>
<a href="#l105.266"></a><span id="l105.266">     }</span>
<a href="#l105.267"></a><span id="l105.267">     return cmpListener.opGroup;</span>
<a href="#l105.268"></a><span id="l105.268">   },</span>
<a href="#l105.269"></a><span id="l105.269"> </span>
<a href="#l105.270"></a><span id="l105.270">   // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l105.271"></a><span id="l105.271">   //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l105.272"></a><span id="l105.272">   //                in calIOperationListener aListener );</span>
<a href="#l105.273"></a><span id="l105.273" class="difflineminus">-  getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l105.274"></a><span id="l105.274" class="difflineplus">+  getItems(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l105.275"></a><span id="l105.275">     // If there are no calendars, then we just call onOperationComplete</span>
<a href="#l105.276"></a><span id="l105.276">     let enabledCalendars = this.enabledCalendars;</span>
<a href="#l105.277"></a><span id="l105.277">     if (enabledCalendars.length == 0) {</span>
<a href="#l105.278"></a><span id="l105.278">       aListener.onOperationComplete(this, Cr.NS_OK, calIOperationListener.GET, null, null);</span>
<a href="#l105.279"></a><span id="l105.279">       return null;</span>
<a href="#l105.280"></a><span id="l105.280">     }</span>
<a href="#l105.281"></a><span id="l105.281">     if (this.mStatusObserver) {</span>
<a href="#l105.282"></a><span id="l105.282">       if (this.mStatusObserver.spinning == Ci.calIStatusObserver.NO_PROGRESS) {</span>
<a href="#l105.283"></a><span id="l105.283" class="difflineat">@@ -397,32 +397,31 @@ calCompositeCalendar.prototype = {</span>
<a href="#l105.284"></a><span id="l105.284">         );</span>
<a href="#l105.285"></a><span id="l105.285">       } catch (exc) {</span>
<a href="#l105.286"></a><span id="l105.286">         cal.ASSERT(false, exc);</span>
<a href="#l105.287"></a><span id="l105.287">       }</span>
<a href="#l105.288"></a><span id="l105.288">     }</span>
<a href="#l105.289"></a><span id="l105.289">     return cmpListener.opGroup;</span>
<a href="#l105.290"></a><span id="l105.290">   },</span>
<a href="#l105.291"></a><span id="l105.291"> </span>
<a href="#l105.292"></a><span id="l105.292" class="difflineminus">-  startBatch: function() {</span>
<a href="#l105.293"></a><span id="l105.293" class="difflineplus">+  startBatch() {</span>
<a href="#l105.294"></a><span id="l105.294">     this.mCompositeObservers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l105.295"></a><span id="l105.295">   },</span>
<a href="#l105.296"></a><span id="l105.296" class="difflineminus">-  endBatch: function() {</span>
<a href="#l105.297"></a><span id="l105.297" class="difflineplus">+  endBatch() {</span>
<a href="#l105.298"></a><span id="l105.298">     this.mCompositeObservers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l105.299"></a><span id="l105.299">   },</span>
<a href="#l105.300"></a><span id="l105.300"> </span>
<a href="#l105.301"></a><span id="l105.301">   get statusDisplayed() {</span>
<a href="#l105.302"></a><span id="l105.302">     if (this.mStatusObserver) {</span>
<a href="#l105.303"></a><span id="l105.303">       return this.mStatusObserver.spinning != Ci.calIStatusObserver.NO_PROGRESS;</span>
<a href="#l105.304"></a><span id="l105.304" class="difflineminus">-    } else {</span>
<a href="#l105.305"></a><span id="l105.305" class="difflineminus">-      return false;</span>
<a href="#l105.306"></a><span id="l105.306">     }</span>
<a href="#l105.307"></a><span id="l105.307" class="difflineplus">+    return false;</span>
<a href="#l105.308"></a><span id="l105.308">   },</span>
<a href="#l105.309"></a><span id="l105.309"> </span>
<a href="#l105.310"></a><span id="l105.310" class="difflineminus">-  setStatusObserver: function(aStatusObserver, aWindow) {</span>
<a href="#l105.311"></a><span id="l105.311" class="difflineplus">+  setStatusObserver(aStatusObserver, aWindow) {</span>
<a href="#l105.312"></a><span id="l105.312">     this.mStatusObserver = aStatusObserver;</span>
<a href="#l105.313"></a><span id="l105.313">     if (this.mStatusObserver) {</span>
<a href="#l105.314"></a><span id="l105.314">       this.mStatusObserver.initialize(aWindow);</span>
<a href="#l105.315"></a><span id="l105.315">     }</span>
<a href="#l105.316"></a><span id="l105.316">   },</span>
<a href="#l105.317"></a><span id="l105.317"> };</span>
<a href="#l105.318"></a><span id="l105.318"> </span>
<a href="#l105.319"></a><span id="l105.319"> // composite listener helper</span>
<a href="#l105.320"></a><span id="l105.320" class="difflineat">@@ -462,17 +461,17 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l105.321"></a><span id="l105.321">             this.mCompositeCalendar.mStatusObserver.stopMeteors();</span>
<a href="#l105.322"></a><span id="l105.322">           }</span>
<a href="#l105.323"></a><span id="l105.323">         }</span>
<a href="#l105.324"></a><span id="l105.324">       });</span>
<a href="#l105.325"></a><span id="l105.325">     }</span>
<a href="#l105.326"></a><span id="l105.326">     return this.mOpGroup;</span>
<a href="#l105.327"></a><span id="l105.327">   },</span>
<a href="#l105.328"></a><span id="l105.328"> </span>
<a href="#l105.329"></a><span id="l105.329" class="difflineminus">-  onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l105.330"></a><span id="l105.330" class="difflineplus">+  onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l105.331"></a><span id="l105.331">     if (!this.mRealListener) {</span>
<a href="#l105.332"></a><span id="l105.332">       // has been cancelled, ignore any providers firing on this...</span>
<a href="#l105.333"></a><span id="l105.333">       return;</span>
<a href="#l105.334"></a><span id="l105.334">     }</span>
<a href="#l105.335"></a><span id="l105.335">     if (this.mFinished) {</span>
<a href="#l105.336"></a><span id="l105.336">       dump(&quot;+++ calCompositeGetListenerHelper.onOperationComplete: called with mFinished == true!&quot;);</span>
<a href="#l105.337"></a><span id="l105.337">       return;</span>
<a href="#l105.338"></a><span id="l105.338">     }</span>
<a href="#l105.339"></a><span id="l105.339" class="difflineat">@@ -493,17 +492,17 @@ calCompositeGetListenerHelper.prototype </span>
<a href="#l105.340"></a><span id="l105.340">       }</span>
<a href="#l105.341"></a><span id="l105.341">       // we're done here.</span>
<a href="#l105.342"></a><span id="l105.342">       this.mFinished = true;</span>
<a href="#l105.343"></a><span id="l105.343">       this.opGroup.notifyCompleted();</span>
<a href="#l105.344"></a><span id="l105.344">       this.mRealListener.onOperationComplete(this, aStatus, calIOperationListener.GET, null, null);</span>
<a href="#l105.345"></a><span id="l105.345">     }</span>
<a href="#l105.346"></a><span id="l105.346">   },</span>
<a href="#l105.347"></a><span id="l105.347"> </span>
<a href="#l105.348"></a><span id="l105.348" class="difflineminus">-  onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l105.349"></a><span id="l105.349" class="difflineplus">+  onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l105.350"></a><span id="l105.350">     if (!this.mRealListener) {</span>
<a href="#l105.351"></a><span id="l105.351">       // has been cancelled, ignore any providers firing on this...</span>
<a href="#l105.352"></a><span id="l105.352">       return;</span>
<a href="#l105.353"></a><span id="l105.353">     }</span>
<a href="#l105.354"></a><span id="l105.354">     if (this.mFinished) {</span>
<a href="#l105.355"></a><span id="l105.355">       dump(&quot;+++ calCompositeGetListenerHelper.onGetResult: called with mFinished == true!&quot;);</span>
<a href="#l105.356"></a><span id="l105.356">       return;</span>
<a href="#l105.357"></a><span id="l105.357">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/calendar/providers/ics/calICSCalendar.js</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -56,17 +56,17 @@ calICSCalendar.prototype = {</span>
<a href="#l106.4"></a><span id="l106.4">     contractID: &quot;@mozilla.org/calendar/calendar;1?type=ics&quot;,</span>
<a href="#l106.5"></a><span id="l106.5">     classDescription: &quot;Calendar ICS provider&quot;,</span>
<a href="#l106.6"></a><span id="l106.6">     interfaces: calICSCalendarInterfaces,</span>
<a href="#l106.7"></a><span id="l106.7">   }),</span>
<a href="#l106.8"></a><span id="l106.8"> </span>
<a href="#l106.9"></a><span id="l106.9">   mObserver: null,</span>
<a href="#l106.10"></a><span id="l106.10">   locked: false,</span>
<a href="#l106.11"></a><span id="l106.11"> </span>
<a href="#l106.12"></a><span id="l106.12" class="difflineminus">-  initICSCalendar: function() {</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+  initICSCalendar() {</span>
<a href="#l106.14"></a><span id="l106.14">     this.mMemoryCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;].createInstance(</span>
<a href="#l106.15"></a><span id="l106.15">       Ci.calICalendar</span>
<a href="#l106.16"></a><span id="l106.16">     );</span>
<a href="#l106.17"></a><span id="l106.17"> </span>
<a href="#l106.18"></a><span id="l106.18">     this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l106.19"></a><span id="l106.19">     this.mObserver = new calICSObserver(this);</span>
<a href="#l106.20"></a><span id="l106.20">     this.mMemoryCalendar.addObserver(this.mObserver); // XXX Not removed</span>
<a href="#l106.21"></a><span id="l106.21">   },</span>
<a href="#l106.22"></a><span id="l106.22" class="difflineat">@@ -77,21 +77,21 @@ calICSCalendar.prototype = {</span>
<a href="#l106.23"></a><span id="l106.23">   get prefChromeOverlay() {</span>
<a href="#l106.24"></a><span id="l106.24">     return null;</span>
<a href="#l106.25"></a><span id="l106.25">   },</span>
<a href="#l106.26"></a><span id="l106.26"> </span>
<a href="#l106.27"></a><span id="l106.27">   get displayName() {</span>
<a href="#l106.28"></a><span id="l106.28">     return cal.l10n.getCalString(&quot;icsName&quot;);</span>
<a href="#l106.29"></a><span id="l106.29">   },</span>
<a href="#l106.30"></a><span id="l106.30"> </span>
<a href="#l106.31"></a><span id="l106.31" class="difflineminus">-  createCalendar: function() {</span>
<a href="#l106.32"></a><span id="l106.32" class="difflineplus">+  createCalendar() {</span>
<a href="#l106.33"></a><span id="l106.33">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l106.34"></a><span id="l106.34">   },</span>
<a href="#l106.35"></a><span id="l106.35"> </span>
<a href="#l106.36"></a><span id="l106.36" class="difflineminus">-  deleteCalendar: function(_cal, listener) {</span>
<a href="#l106.37"></a><span id="l106.37" class="difflineplus">+  deleteCalendar(_cal, listener) {</span>
<a href="#l106.38"></a><span id="l106.38">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l106.39"></a><span id="l106.39">   },</span>
<a href="#l106.40"></a><span id="l106.40"> </span>
<a href="#l106.41"></a><span id="l106.41">   //</span>
<a href="#l106.42"></a><span id="l106.42">   // calICalendar interface</span>
<a href="#l106.43"></a><span id="l106.43">   //</span>
<a href="#l106.44"></a><span id="l106.44">   get type() {</span>
<a href="#l106.45"></a><span id="l106.45">     return &quot;ics&quot;;</span>
<a href="#l106.46"></a><span id="l106.46" class="difflineat">@@ -125,57 +125,57 @@ calICSCalendar.prototype = {</span>
<a href="#l106.47"></a><span id="l106.47">       this.mHooks = new httpHooks(this);</span>
<a href="#l106.48"></a><span id="l106.48">     } else if (wFileChannel) {</span>
<a href="#l106.49"></a><span id="l106.49">       this.mHooks = new fileHooks(this);</span>
<a href="#l106.50"></a><span id="l106.50">     } else {</span>
<a href="#l106.51"></a><span id="l106.51">       this.mHooks = new dummyHooks(this);</span>
<a href="#l106.52"></a><span id="l106.52">     }</span>
<a href="#l106.53"></a><span id="l106.53">   },</span>
<a href="#l106.54"></a><span id="l106.54"> </span>
<a href="#l106.55"></a><span id="l106.55" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l106.56"></a><span id="l106.56" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l106.57"></a><span id="l106.57">     switch (aName) {</span>
<a href="#l106.58"></a><span id="l106.58">       case &quot;requiresNetwork&quot;:</span>
<a href="#l106.59"></a><span id="l106.59">         return !this.uri.schemeIs(&quot;file&quot;);</span>
<a href="#l106.60"></a><span id="l106.60">     }</span>
<a href="#l106.61"></a><span id="l106.61">     return this.__proto__.__proto__.getProperty.apply(this, arguments);</span>
<a href="#l106.62"></a><span id="l106.62">   },</span>
<a href="#l106.63"></a><span id="l106.63"> </span>
<a href="#l106.64"></a><span id="l106.64" class="difflineminus">-  refresh: function() {</span>
<a href="#l106.65"></a><span id="l106.65" class="difflineplus">+  refresh() {</span>
<a href="#l106.66"></a><span id="l106.66">     this.queue.push({ action: &quot;refresh&quot;, forceRefresh: false });</span>
<a href="#l106.67"></a><span id="l106.67">     this.processQueue();</span>
<a href="#l106.68"></a><span id="l106.68">   },</span>
<a href="#l106.69"></a><span id="l106.69"> </span>
<a href="#l106.70"></a><span id="l106.70" class="difflineminus">-  forceRefresh: function() {</span>
<a href="#l106.71"></a><span id="l106.71" class="difflineplus">+  forceRefresh() {</span>
<a href="#l106.72"></a><span id="l106.72">     this.queue.push({ action: &quot;refresh&quot;, forceRefresh: true });</span>
<a href="#l106.73"></a><span id="l106.73">     this.processQueue();</span>
<a href="#l106.74"></a><span id="l106.74">   },</span>
<a href="#l106.75"></a><span id="l106.75"> </span>
<a href="#l106.76"></a><span id="l106.76" class="difflineminus">-  prepareChannel: function(aChannel, aForceRefresh) {</span>
<a href="#l106.77"></a><span id="l106.77" class="difflineplus">+  prepareChannel(aChannel, aForceRefresh) {</span>
<a href="#l106.78"></a><span id="l106.78">     aChannel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l106.79"></a><span id="l106.79">     aChannel.notificationCallbacks = this;</span>
<a href="#l106.80"></a><span id="l106.80"> </span>
<a href="#l106.81"></a><span id="l106.81">     // Allow the hook to do its work, like a performing a quick check to</span>
<a href="#l106.82"></a><span id="l106.82">     // see if the remote file really changed. Might save a lot of time</span>
<a href="#l106.83"></a><span id="l106.83">     this.mHooks.onBeforeGet(aChannel, aForceRefresh);</span>
<a href="#l106.84"></a><span id="l106.84">   },</span>
<a href="#l106.85"></a><span id="l106.85"> </span>
<a href="#l106.86"></a><span id="l106.86" class="difflineminus">-  createMemoryCalendar: function() {</span>
<a href="#l106.87"></a><span id="l106.87" class="difflineplus">+  createMemoryCalendar() {</span>
<a href="#l106.88"></a><span id="l106.88">     // Create a new calendar, to get rid of all the old events</span>
<a href="#l106.89"></a><span id="l106.89">     // Don't forget to remove the observer</span>
<a href="#l106.90"></a><span id="l106.90">     if (this.mMemoryCalendar) {</span>
<a href="#l106.91"></a><span id="l106.91">       this.mMemoryCalendar.removeObserver(this.mObserver);</span>
<a href="#l106.92"></a><span id="l106.92">     }</span>
<a href="#l106.93"></a><span id="l106.93">     this.mMemoryCalendar = Cc[&quot;@mozilla.org/calendar/calendar;1?type=memory&quot;].createInstance(</span>
<a href="#l106.94"></a><span id="l106.94">       Ci.calICalendar</span>
<a href="#l106.95"></a><span id="l106.95">     );</span>
<a href="#l106.96"></a><span id="l106.96">     this.mMemoryCalendar.uri = this.mUri;</span>
<a href="#l106.97"></a><span id="l106.97">     this.mMemoryCalendar.superCalendar = this;</span>
<a href="#l106.98"></a><span id="l106.98">   },</span>
<a href="#l106.99"></a><span id="l106.99"> </span>
<a href="#l106.100"></a><span id="l106.100" class="difflineminus">-  doRefresh: function(aForce) {</span>
<a href="#l106.101"></a><span id="l106.101" class="difflineplus">+  doRefresh(aForce) {</span>
<a href="#l106.102"></a><span id="l106.102">     let channel = Services.io.newChannelFromURI(</span>
<a href="#l106.103"></a><span id="l106.103">       this.mUri,</span>
<a href="#l106.104"></a><span id="l106.104">       null,</span>
<a href="#l106.105"></a><span id="l106.105">       Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l106.106"></a><span id="l106.106">       null,</span>
<a href="#l106.107"></a><span id="l106.107">       Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l106.108"></a><span id="l106.108">       Ci.nsIContentPolicy.TYPE_OTHER</span>
<a href="#l106.109"></a><span id="l106.109">     );</span>
<a href="#l106.110"></a><span id="l106.110" class="difflineat">@@ -194,25 +194,25 @@ calICSCalendar.prototype = {</span>
<a href="#l106.111"></a><span id="l106.111">     } catch (e) {</span>
<a href="#l106.112"></a><span id="l106.112">       // File not found: a new calendar. No problem.</span>
<a href="#l106.113"></a><span id="l106.113">       cal.LOG(&quot;[calICSCalendar] Error occurred opening channel: &quot; + e);</span>
<a href="#l106.114"></a><span id="l106.114">       this.unlock();</span>
<a href="#l106.115"></a><span id="l106.115">     }</span>
<a href="#l106.116"></a><span id="l106.116">   },</span>
<a href="#l106.117"></a><span id="l106.117"> </span>
<a href="#l106.118"></a><span id="l106.118">   // nsIChannelEventSink implementation</span>
<a href="#l106.119"></a><span id="l106.119" class="difflineminus">-  asyncOnChannelRedirect: function(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l106.120"></a><span id="l106.120" class="difflineplus">+  asyncOnChannelRedirect(aOldChannel, aNewChannel, aFlags, aCallback) {</span>
<a href="#l106.121"></a><span id="l106.121">     this.prepareChannel(aNewChannel, true);</span>
<a href="#l106.122"></a><span id="l106.122">     aCallback.onRedirectVerifyCallback(Cr.NS_OK);</span>
<a href="#l106.123"></a><span id="l106.123">   },</span>
<a href="#l106.124"></a><span id="l106.124"> </span>
<a href="#l106.125"></a><span id="l106.125">   // nsIStreamLoaderObserver impl</span>
<a href="#l106.126"></a><span id="l106.126">   // Listener for download. Parse the downloaded file</span>
<a href="#l106.127"></a><span id="l106.127"> </span>
<a href="#l106.128"></a><span id="l106.128" class="difflineminus">-  onStreamComplete: function(loader, ctxt, status, resultLength, result) {</span>
<a href="#l106.129"></a><span id="l106.129" class="difflineplus">+  onStreamComplete(loader, ctxt, status, resultLength, result) {</span>
<a href="#l106.130"></a><span id="l106.130">     let cont = false;</span>
<a href="#l106.131"></a><span id="l106.131"> </span>
<a href="#l106.132"></a><span id="l106.132">     if (Components.isSuccessCode(status)) {</span>
<a href="#l106.133"></a><span id="l106.133">       // Allow the hook to get needed data (like an etag) of the channel</span>
<a href="#l106.134"></a><span id="l106.134">       cont = this.mHooks.onAfterGet(loader.request);</span>
<a href="#l106.135"></a><span id="l106.135">       cal.LOG(&quot;[calICSCalendar] Loading ICS succeeded, needs further processing: &quot; + cont);</span>
<a href="#l106.136"></a><span id="l106.136">     } else {</span>
<a href="#l106.137"></a><span id="l106.137">       // Failure may be due to temporary connection issue, keep old data to</span>
<a href="#l106.138"></a><span id="l106.138" class="difflineat">@@ -257,17 +257,17 @@ calICSCalendar.prototype = {</span>
<a href="#l106.139"></a><span id="l106.139"> </span>
<a href="#l106.140"></a><span id="l106.140">     // Wrap parsing in a try block. Will ignore errors. That's a good thing</span>
<a href="#l106.141"></a><span id="l106.141">     // for non-existing or empty files, but not good for invalid files.</span>
<a href="#l106.142"></a><span id="l106.142">     // That's why we put them in readOnly mode</span>
<a href="#l106.143"></a><span id="l106.143">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l106.144"></a><span id="l106.144">     let self = this;</span>
<a href="#l106.145"></a><span id="l106.145">     let listener = {</span>
<a href="#l106.146"></a><span id="l106.146">       // calIIcsParsingListener</span>
<a href="#l106.147"></a><span id="l106.147" class="difflineminus">-      onParsingComplete: function(rc, parser_) {</span>
<a href="#l106.148"></a><span id="l106.148" class="difflineplus">+      onParsingComplete(rc, parser_) {</span>
<a href="#l106.149"></a><span id="l106.149">         try {</span>
<a href="#l106.150"></a><span id="l106.150">           for (let item of parser_.getItems()) {</span>
<a href="#l106.151"></a><span id="l106.151">             self.mMemoryCalendar.adoptItem(item, null);</span>
<a href="#l106.152"></a><span id="l106.152">           }</span>
<a href="#l106.153"></a><span id="l106.153">           self.unmappedComponents = parser_.getComponents();</span>
<a href="#l106.154"></a><span id="l106.154">           self.unmappedProperties = parser_.getProperties();</span>
<a href="#l106.155"></a><span id="l106.155">           cal.LOG(&quot;[calICSCalendar] Parsing ICS succeeded for &quot; + self.uri.spec);</span>
<a href="#l106.156"></a><span id="l106.156">         } catch (exc) {</span>
<a href="#l106.157"></a><span id="l106.157" class="difflineat">@@ -284,38 +284,38 @@ calICSCalendar.prototype = {</span>
<a href="#l106.158"></a><span id="l106.158">         // the views from being notified.</span>
<a href="#l106.159"></a><span id="l106.159">         self.mMemoryCalendar.addObserver(self.mObserver);</span>
<a href="#l106.160"></a><span id="l106.160">         self.unlock();</span>
<a href="#l106.161"></a><span id="l106.161">       },</span>
<a href="#l106.162"></a><span id="l106.162">     };</span>
<a href="#l106.163"></a><span id="l106.163">     parser.parseString(str, null, listener);</span>
<a href="#l106.164"></a><span id="l106.164">   },</span>
<a href="#l106.165"></a><span id="l106.165"> </span>
<a href="#l106.166"></a><span id="l106.166" class="difflineminus">-  writeICS: function() {</span>
<a href="#l106.167"></a><span id="l106.167" class="difflineplus">+  writeICS() {</span>
<a href="#l106.168"></a><span id="l106.168">     cal.LOG(&quot;[calICSCalendar] Commencing write of ICS Calendar &quot; + this.name);</span>
<a href="#l106.169"></a><span id="l106.169">     this.lock();</span>
<a href="#l106.170"></a><span id="l106.170">     try {</span>
<a href="#l106.171"></a><span id="l106.171">       if (!this.mUri) {</span>
<a href="#l106.172"></a><span id="l106.172">         throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l106.173"></a><span id="l106.173">       }</span>
<a href="#l106.174"></a><span id="l106.174">       // makeBackup will call doWriteICS</span>
<a href="#l106.175"></a><span id="l106.175">       this.makeBackup(this.doWriteICS);</span>
<a href="#l106.176"></a><span id="l106.176">     } catch (exc) {</span>
<a href="#l106.177"></a><span id="l106.177">       this.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l106.178"></a><span id="l106.178">       throw exc;</span>
<a href="#l106.179"></a><span id="l106.179">     }</span>
<a href="#l106.180"></a><span id="l106.180">   },</span>
<a href="#l106.181"></a><span id="l106.181"> </span>
<a href="#l106.182"></a><span id="l106.182" class="difflineminus">-  doWriteICS: function() {</span>
<a href="#l106.183"></a><span id="l106.183" class="difflineplus">+  doWriteICS() {</span>
<a href="#l106.184"></a><span id="l106.184">     cal.LOG(&quot;[calICSCalendar] Writing ICS File &quot; + this.uri.spec);</span>
<a href="#l106.185"></a><span id="l106.185">     let self = this;</span>
<a href="#l106.186"></a><span id="l106.186">     let listener = {</span>
<a href="#l106.187"></a><span id="l106.187">       serializer: null,</span>
<a href="#l106.188"></a><span id="l106.188">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l106.189"></a><span id="l106.189" class="difflineminus">-      onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l106.190"></a><span id="l106.190" class="difflineplus">+      onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l106.191"></a><span id="l106.191">         let inLastWindowClosingSurvivalArea = false;</span>
<a href="#l106.192"></a><span id="l106.192">         try {</span>
<a href="#l106.193"></a><span id="l106.193">           // All events are returned. Now set up a channel and a</span>
<a href="#l106.194"></a><span id="l106.194">           // streamloader to upload.  onStopRequest will be called</span>
<a href="#l106.195"></a><span id="l106.195">           // once the write has finished</span>
<a href="#l106.196"></a><span id="l106.196">           let channel = Services.io.newChannelFromURI(</span>
<a href="#l106.197"></a><span id="l106.197">             self.mUri,</span>
<a href="#l106.198"></a><span id="l106.198">             null,</span>
<a href="#l106.199"></a><span id="l106.199" class="difflineat">@@ -361,17 +361,17 @@ calICSCalendar.prototype = {</span>
<a href="#l106.200"></a><span id="l106.200">             ex.result,</span>
<a href="#l106.201"></a><span id="l106.201">             &quot;The calendar could not be saved; there was a failure: 0x&quot; + ex.result.toString(16)</span>
<a href="#l106.202"></a><span id="l106.202">           );</span>
<a href="#l106.203"></a><span id="l106.203">           self.mObserver.onError(self.superCalendar, calIErrors.MODIFICATION_FAILED, &quot;&quot;);</span>
<a href="#l106.204"></a><span id="l106.204">           self.unlock(calIErrors.MODIFICATION_FAILED);</span>
<a href="#l106.205"></a><span id="l106.205">           self.forceRefresh();</span>
<a href="#l106.206"></a><span id="l106.206">         }</span>
<a href="#l106.207"></a><span id="l106.207">       },</span>
<a href="#l106.208"></a><span id="l106.208" class="difflineminus">-      onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l106.209"></a><span id="l106.209" class="difflineplus">+      onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l106.210"></a><span id="l106.210">         this.serializer.addItems(aItems);</span>
<a href="#l106.211"></a><span id="l106.211">       },</span>
<a href="#l106.212"></a><span id="l106.212">     };</span>
<a href="#l106.213"></a><span id="l106.213">     listener.serializer = Cc[&quot;@mozilla.org/calendar/ics-serializer;1&quot;].createInstance(</span>
<a href="#l106.214"></a><span id="l106.214">       Ci.calIIcsSerializer</span>
<a href="#l106.215"></a><span id="l106.215">     );</span>
<a href="#l106.216"></a><span id="l106.216">     for (let comp of this.unmappedComponents) {</span>
<a href="#l106.217"></a><span id="l106.217">       listener.serializer.addComponent(comp);</span>
<a href="#l106.218"></a><span id="l106.218" class="difflineat">@@ -401,27 +401,27 @@ calICSCalendar.prototype = {</span>
<a href="#l106.219"></a><span id="l106.219">       null,</span>
<a href="#l106.220"></a><span id="l106.220">       null,</span>
<a href="#l106.221"></a><span id="l106.221">       listener</span>
<a href="#l106.222"></a><span id="l106.222">     );</span>
<a href="#l106.223"></a><span id="l106.223">   },</span>
<a href="#l106.224"></a><span id="l106.224"> </span>
<a href="#l106.225"></a><span id="l106.225">   // nsIStreamListener impl</span>
<a href="#l106.226"></a><span id="l106.226">   // For after publishing. Do error checks here</span>
<a href="#l106.227"></a><span id="l106.227" class="difflineminus">-  onStartRequest: function(request) {},</span>
<a href="#l106.228"></a><span id="l106.228" class="difflineminus">-  onDataAvailable: function(request, inStream, sourceOffset, count) {</span>
<a href="#l106.229"></a><span id="l106.229" class="difflineplus">+  onStartRequest(request) {},</span>
<a href="#l106.230"></a><span id="l106.230" class="difflineplus">+  onDataAvailable(request, inStream, sourceOffset, count) {</span>
<a href="#l106.231"></a><span id="l106.231">     // All data must be consumed. For an upload channel, there is</span>
<a href="#l106.232"></a><span id="l106.232">     // no meaningful data. So it gets read and then ignored</span>
<a href="#l106.233"></a><span id="l106.233">     let scriptableInputStream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;].createInstance(</span>
<a href="#l106.234"></a><span id="l106.234">       Ci.nsIScriptableInputStream</span>
<a href="#l106.235"></a><span id="l106.235">     );</span>
<a href="#l106.236"></a><span id="l106.236">     scriptableInputStream.init(inStream);</span>
<a href="#l106.237"></a><span id="l106.237">     scriptableInputStream.read(-1);</span>
<a href="#l106.238"></a><span id="l106.238">   },</span>
<a href="#l106.239"></a><span id="l106.239" class="difflineminus">-  onStopRequest: function(request, status, errorMsg) {</span>
<a href="#l106.240"></a><span id="l106.240" class="difflineplus">+  onStopRequest(request, status, errorMsg) {</span>
<a href="#l106.241"></a><span id="l106.241">     let httpChannel;</span>
<a href="#l106.242"></a><span id="l106.242">     let requestSucceeded = false;</span>
<a href="#l106.243"></a><span id="l106.243">     try {</span>
<a href="#l106.244"></a><span id="l106.244">       httpChannel = request.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.245"></a><span id="l106.245">       requestSucceeded = httpChannel.requestSucceeded;</span>
<a href="#l106.246"></a><span id="l106.246">     } catch (e) {</span>
<a href="#l106.247"></a><span id="l106.247">       // This may fail if it was not a http channel, handled later on.</span>
<a href="#l106.248"></a><span id="l106.248">     }</span>
<a href="#l106.249"></a><span id="l106.249" class="difflineat">@@ -457,85 +457,85 @@ calICSCalendar.prototype = {</span>
<a href="#l106.250"></a><span id="l106.250">       this.unlock();</span>
<a href="#l106.251"></a><span id="l106.251">       Services.startup.exitLastWindowClosingSurvivalArea();</span>
<a href="#l106.252"></a><span id="l106.252">     });</span>
<a href="#l106.253"></a><span id="l106.253">   },</span>
<a href="#l106.254"></a><span id="l106.254"> </span>
<a href="#l106.255"></a><span id="l106.255">   // Always use the queue, just to reduce the amount of places where</span>
<a href="#l106.256"></a><span id="l106.256">   // this.mMemoryCalendar.addItem() and friends are called. less</span>
<a href="#l106.257"></a><span id="l106.257">   // copied code.</span>
<a href="#l106.258"></a><span id="l106.258" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l106.259"></a><span id="l106.259" class="difflineplus">+  addItem(aItem, aListener) {</span>
<a href="#l106.260"></a><span id="l106.260">     this.adoptItem(aItem.clone(), aListener);</span>
<a href="#l106.261"></a><span id="l106.261">   },</span>
<a href="#l106.262"></a><span id="l106.262" class="difflineminus">-  adoptItem: function(aItem, aListener) {</span>
<a href="#l106.263"></a><span id="l106.263" class="difflineplus">+  adoptItem(aItem, aListener) {</span>
<a href="#l106.264"></a><span id="l106.264">     if (this.readOnly) {</span>
<a href="#l106.265"></a><span id="l106.265">       throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l106.266"></a><span id="l106.266">     }</span>
<a href="#l106.267"></a><span id="l106.267">     this.queue.push({ action: &quot;add&quot;, item: aItem, listener: aListener });</span>
<a href="#l106.268"></a><span id="l106.268">     this.processQueue();</span>
<a href="#l106.269"></a><span id="l106.269">   },</span>
<a href="#l106.270"></a><span id="l106.270"> </span>
<a href="#l106.271"></a><span id="l106.271" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l106.272"></a><span id="l106.272" class="difflineplus">+  modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l106.273"></a><span id="l106.273">     if (this.readOnly) {</span>
<a href="#l106.274"></a><span id="l106.274">       throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l106.275"></a><span id="l106.275">     }</span>
<a href="#l106.276"></a><span id="l106.276">     this.queue.push({</span>
<a href="#l106.277"></a><span id="l106.277">       action: &quot;modify&quot;,</span>
<a href="#l106.278"></a><span id="l106.278">       oldItem: aOldItem,</span>
<a href="#l106.279"></a><span id="l106.279">       newItem: aNewItem,</span>
<a href="#l106.280"></a><span id="l106.280">       listener: aListener,</span>
<a href="#l106.281"></a><span id="l106.281">     });</span>
<a href="#l106.282"></a><span id="l106.282">     this.processQueue();</span>
<a href="#l106.283"></a><span id="l106.283">   },</span>
<a href="#l106.284"></a><span id="l106.284"> </span>
<a href="#l106.285"></a><span id="l106.285" class="difflineminus">-  deleteItem: function(aItem, aListener) {</span>
<a href="#l106.286"></a><span id="l106.286" class="difflineplus">+  deleteItem(aItem, aListener) {</span>
<a href="#l106.287"></a><span id="l106.287">     if (this.readOnly) {</span>
<a href="#l106.288"></a><span id="l106.288">       throw calIErrors.CAL_IS_READONLY;</span>
<a href="#l106.289"></a><span id="l106.289">     }</span>
<a href="#l106.290"></a><span id="l106.290">     this.queue.push({</span>
<a href="#l106.291"></a><span id="l106.291">       action: &quot;delete&quot;,</span>
<a href="#l106.292"></a><span id="l106.292">       item: aItem,</span>
<a href="#l106.293"></a><span id="l106.293">       listener: aListener,</span>
<a href="#l106.294"></a><span id="l106.294">     });</span>
<a href="#l106.295"></a><span id="l106.295">     this.processQueue();</span>
<a href="#l106.296"></a><span id="l106.296">   },</span>
<a href="#l106.297"></a><span id="l106.297"> </span>
<a href="#l106.298"></a><span id="l106.298" class="difflineminus">-  getItem: function(aId, aListener) {</span>
<a href="#l106.299"></a><span id="l106.299" class="difflineplus">+  getItem(aId, aListener) {</span>
<a href="#l106.300"></a><span id="l106.300">     this.queue.push({</span>
<a href="#l106.301"></a><span id="l106.301">       action: &quot;get_item&quot;,</span>
<a href="#l106.302"></a><span id="l106.302">       id: aId,</span>
<a href="#l106.303"></a><span id="l106.303">       listener: aListener,</span>
<a href="#l106.304"></a><span id="l106.304">     });</span>
<a href="#l106.305"></a><span id="l106.305">     this.processQueue();</span>
<a href="#l106.306"></a><span id="l106.306">   },</span>
<a href="#l106.307"></a><span id="l106.307"> </span>
<a href="#l106.308"></a><span id="l106.308" class="difflineminus">-  getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l106.309"></a><span id="l106.309" class="difflineplus">+  getItems(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l106.310"></a><span id="l106.310">     this.queue.push({</span>
<a href="#l106.311"></a><span id="l106.311">       action: &quot;get_items&quot;,</span>
<a href="#l106.312"></a><span id="l106.312">       itemFilter: aItemFilter,</span>
<a href="#l106.313"></a><span id="l106.313">       count: aCount,</span>
<a href="#l106.314"></a><span id="l106.314">       rangeStart: aRangeStart,</span>
<a href="#l106.315"></a><span id="l106.315">       rangeEnd: aRangeEnd,</span>
<a href="#l106.316"></a><span id="l106.316">       listener: aListener,</span>
<a href="#l106.317"></a><span id="l106.317">     });</span>
<a href="#l106.318"></a><span id="l106.318">     this.processQueue();</span>
<a href="#l106.319"></a><span id="l106.319">   },</span>
<a href="#l106.320"></a><span id="l106.320"> </span>
<a href="#l106.321"></a><span id="l106.321" class="difflineminus">-  processQueue: function() {</span>
<a href="#l106.322"></a><span id="l106.322" class="difflineplus">+  processQueue() {</span>
<a href="#l106.323"></a><span id="l106.323">     if (this.isLocked()) {</span>
<a href="#l106.324"></a><span id="l106.324">       return;</span>
<a href="#l106.325"></a><span id="l106.325">     }</span>
<a href="#l106.326"></a><span id="l106.326"> </span>
<a href="#l106.327"></a><span id="l106.327">     function modListener(action) {</span>
<a href="#l106.328"></a><span id="l106.328">       this.mAction = action;</span>
<a href="#l106.329"></a><span id="l106.329">     }</span>
<a href="#l106.330"></a><span id="l106.330">     modListener.prototype = {</span>
<a href="#l106.331"></a><span id="l106.331">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l106.332"></a><span id="l106.332" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l106.333"></a><span id="l106.333" class="difflineminus">-      onOperationComplete: function() {</span>
<a href="#l106.334"></a><span id="l106.334" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l106.335"></a><span id="l106.335" class="difflineplus">+      onOperationComplete() {</span>
<a href="#l106.336"></a><span id="l106.336">         this.mAction.opCompleteArgs = arguments;</span>
<a href="#l106.337"></a><span id="l106.337">       },</span>
<a href="#l106.338"></a><span id="l106.338">     };</span>
<a href="#l106.339"></a><span id="l106.339"> </span>
<a href="#l106.340"></a><span id="l106.340">     let a;</span>
<a href="#l106.341"></a><span id="l106.341">     let writeICS = false;</span>
<a href="#l106.342"></a><span id="l106.342">     let refreshAction = null;</span>
<a href="#l106.343"></a><span id="l106.343">     while ((a = this.queue.shift())) {</span>
<a href="#l106.344"></a><span id="l106.344" class="difflineat">@@ -588,21 +588,21 @@ calICSCalendar.prototype = {</span>
<a href="#l106.345"></a><span id="l106.345">     } else if (refreshAction) {</span>
<a href="#l106.346"></a><span id="l106.346">       cal.LOG(</span>
<a href="#l106.347"></a><span id="l106.347">         &quot;[calICSCalendar] Refreshing &quot; + this.name + (refreshAction.forceRefresh ? &quot; (forced)&quot; : &quot;&quot;)</span>
<a href="#l106.348"></a><span id="l106.348">       );</span>
<a href="#l106.349"></a><span id="l106.349">       this.doRefresh(refreshAction.forceRefresh);</span>
<a href="#l106.350"></a><span id="l106.350">     }</span>
<a href="#l106.351"></a><span id="l106.351">   },</span>
<a href="#l106.352"></a><span id="l106.352"> </span>
<a href="#l106.353"></a><span id="l106.353" class="difflineminus">-  lock: function() {</span>
<a href="#l106.354"></a><span id="l106.354" class="difflineplus">+  lock() {</span>
<a href="#l106.355"></a><span id="l106.355">     this.locked = true;</span>
<a href="#l106.356"></a><span id="l106.356">   },</span>
<a href="#l106.357"></a><span id="l106.357"> </span>
<a href="#l106.358"></a><span id="l106.358" class="difflineminus">-  unlock: function(errCode) {</span>
<a href="#l106.359"></a><span id="l106.359" class="difflineplus">+  unlock(errCode) {</span>
<a href="#l106.360"></a><span id="l106.360">     cal.ASSERT(this.locked, &quot;unexpected!&quot;);</span>
<a href="#l106.361"></a><span id="l106.361"> </span>
<a href="#l106.362"></a><span id="l106.362">     this.mModificationActions.forEach(action =&gt; {</span>
<a href="#l106.363"></a><span id="l106.363">       let args = action.opCompleteArgs;</span>
<a href="#l106.364"></a><span id="l106.364">       cal.ASSERT(args, &quot;missing onOperationComplete call!&quot;);</span>
<a href="#l106.365"></a><span id="l106.365">       let listener = action.listener;</span>
<a href="#l106.366"></a><span id="l106.366">       if (listener) {</span>
<a href="#l106.367"></a><span id="l106.367">         if (Components.isSuccessCode(args[1]) &amp;&amp; errCode &amp;&amp; !Components.isSuccessCode(errCode)) {</span>
<a href="#l106.368"></a><span id="l106.368" class="difflineat">@@ -613,24 +613,24 @@ calICSCalendar.prototype = {</span>
<a href="#l106.369"></a><span id="l106.369">       }</span>
<a href="#l106.370"></a><span id="l106.370">     });</span>
<a href="#l106.371"></a><span id="l106.371">     this.mModificationActions = [];</span>
<a href="#l106.372"></a><span id="l106.372"> </span>
<a href="#l106.373"></a><span id="l106.373">     this.locked = false;</span>
<a href="#l106.374"></a><span id="l106.374">     this.processQueue();</span>
<a href="#l106.375"></a><span id="l106.375">   },</span>
<a href="#l106.376"></a><span id="l106.376"> </span>
<a href="#l106.377"></a><span id="l106.377" class="difflineminus">-  isLocked: function() {</span>
<a href="#l106.378"></a><span id="l106.378" class="difflineplus">+  isLocked() {</span>
<a href="#l106.379"></a><span id="l106.379">     return this.locked;</span>
<a href="#l106.380"></a><span id="l106.380">   },</span>
<a href="#l106.381"></a><span id="l106.381"> </span>
<a href="#l106.382"></a><span id="l106.382" class="difflineminus">-  startBatch: function() {</span>
<a href="#l106.383"></a><span id="l106.383" class="difflineplus">+  startBatch() {</span>
<a href="#l106.384"></a><span id="l106.384">     this.mObserver.onStartBatch();</span>
<a href="#l106.385"></a><span id="l106.385">   },</span>
<a href="#l106.386"></a><span id="l106.386" class="difflineminus">-  endBatch: function() {</span>
<a href="#l106.387"></a><span id="l106.387" class="difflineplus">+  endBatch() {</span>
<a href="#l106.388"></a><span id="l106.388">     this.mObserver.onEndBatch();</span>
<a href="#l106.389"></a><span id="l106.389">   },</span>
<a href="#l106.390"></a><span id="l106.390"> </span>
<a href="#l106.391"></a><span id="l106.391">   /**</span>
<a href="#l106.392"></a><span id="l106.392">    * @see nsIInterfaceRequestor</span>
<a href="#l106.393"></a><span id="l106.393">    * @see calProviderUtils.jsm</span>
<a href="#l106.394"></a><span id="l106.394">    */</span>
<a href="#l106.395"></a><span id="l106.395">   getInterface: cal.provider.InterfaceRequestor_getInterface,</span>
<a href="#l106.396"></a><span id="l106.396" class="difflineat">@@ -646,17 +646,17 @@ calICSCalendar.prototype = {</span>
<a href="#l106.397"></a><span id="l106.397">    * day of work.</span>
<a href="#l106.398"></a><span id="l106.398">    * After the back up is finished, will call aCallback.</span>
<a href="#l106.399"></a><span id="l106.399">    *</span>
<a href="#l106.400"></a><span id="l106.400">    * @param aCallback</span>
<a href="#l106.401"></a><span id="l106.401">    *           Function that will be calles after the backup is finished.</span>
<a href="#l106.402"></a><span id="l106.402">    *           will be called in the original context in which makeBackup</span>
<a href="#l106.403"></a><span id="l106.403">    *           was called</span>
<a href="#l106.404"></a><span id="l106.404">    */</span>
<a href="#l106.405"></a><span id="l106.405" class="difflineminus">-  makeBackup: function(aCallback) {</span>
<a href="#l106.406"></a><span id="l106.406" class="difflineplus">+  makeBackup(aCallback) {</span>
<a href="#l106.407"></a><span id="l106.407">     // Uses |pseudoID|, an id of the calendar, defined below</span>
<a href="#l106.408"></a><span id="l106.408">     function makeName(type) {</span>
<a href="#l106.409"></a><span id="l106.409">       return &quot;calBackupData_&quot; + pseudoID + &quot;_&quot; + type + &quot;.ics&quot;;</span>
<a href="#l106.410"></a><span id="l106.410">     }</span>
<a href="#l106.411"></a><span id="l106.411"> </span>
<a href="#l106.412"></a><span id="l106.412">     // This is a bit messy. createUnique creates an empty file,</span>
<a href="#l106.413"></a><span id="l106.413">     // but we don't use that file. All we want is a filename, to be used</span>
<a href="#l106.414"></a><span id="l106.414">     // in the call to copyTo later. So we create a file, get the filename,</span>
<a href="#l106.415"></a><span id="l106.415" class="difflineat">@@ -804,17 +804,17 @@ calICSCalendar.prototype = {</span>
<a href="#l106.416"></a><span id="l106.416">     );</span>
<a href="#l106.417"></a><span id="l106.417">     channel.loadFlags |= Ci.nsIRequest.LOAD_BYPASS_CACHE;</span>
<a href="#l106.418"></a><span id="l106.418">     channel.notificationCallbacks = this;</span>
<a href="#l106.419"></a><span id="l106.419"> </span>
<a href="#l106.420"></a><span id="l106.420">     let downloader = Cc[&quot;@mozilla.org/network/downloader;1&quot;].createInstance(Ci.nsIDownloader);</span>
<a href="#l106.421"></a><span id="l106.421"> </span>
<a href="#l106.422"></a><span id="l106.422">     let self = this;</span>
<a href="#l106.423"></a><span id="l106.423">     let listener = {</span>
<a href="#l106.424"></a><span id="l106.424" class="difflineminus">-      onDownloadComplete: function(opdownloader, request, ctxt, status, result) {</span>
<a href="#l106.425"></a><span id="l106.425" class="difflineplus">+      onDownloadComplete(opdownloader, request, ctxt, status, result) {</span>
<a href="#l106.426"></a><span id="l106.426">         if (doInitialBackup) {</span>
<a href="#l106.427"></a><span id="l106.427">           copyToOverwriting(result, backupDir, makeName(&quot;initial&quot;));</span>
<a href="#l106.428"></a><span id="l106.428">         }</span>
<a href="#l106.429"></a><span id="l106.429">         if (doDailyBackup) {</span>
<a href="#l106.430"></a><span id="l106.430">           copyToOverwriting(result, backupDir, dailyBackupFileName);</span>
<a href="#l106.431"></a><span id="l106.431">         }</span>
<a href="#l106.432"></a><span id="l106.432"> </span>
<a href="#l106.433"></a><span id="l106.433">         aCallback.call(self);</span>
<a href="#l106.434"></a><span id="l106.434" class="difflineat">@@ -837,44 +837,44 @@ function calICSObserver(aCalendar) {</span>
<a href="#l106.435"></a><span id="l106.435">   this.mCalendar = aCalendar;</span>
<a href="#l106.436"></a><span id="l106.436"> }</span>
<a href="#l106.437"></a><span id="l106.437"> </span>
<a href="#l106.438"></a><span id="l106.438"> calICSObserver.prototype = {</span>
<a href="#l106.439"></a><span id="l106.439">   mCalendar: null,</span>
<a href="#l106.440"></a><span id="l106.440">   mInBatch: false,</span>
<a href="#l106.441"></a><span id="l106.441"> </span>
<a href="#l106.442"></a><span id="l106.442">   // calIObserver:</span>
<a href="#l106.443"></a><span id="l106.443" class="difflineminus">-  onStartBatch: function() {</span>
<a href="#l106.444"></a><span id="l106.444" class="difflineplus">+  onStartBatch() {</span>
<a href="#l106.445"></a><span id="l106.445">     this.mCalendar.observers.notify(&quot;onStartBatch&quot;);</span>
<a href="#l106.446"></a><span id="l106.446">     this.mInBatch = true;</span>
<a href="#l106.447"></a><span id="l106.447">   },</span>
<a href="#l106.448"></a><span id="l106.448" class="difflineminus">-  onEndBatch: function() {</span>
<a href="#l106.449"></a><span id="l106.449" class="difflineplus">+  onEndBatch() {</span>
<a href="#l106.450"></a><span id="l106.450">     this.mCalendar.observers.notify(&quot;onEndBatch&quot;);</span>
<a href="#l106.451"></a><span id="l106.451">     this.mInBatch = false;</span>
<a href="#l106.452"></a><span id="l106.452">   },</span>
<a href="#l106.453"></a><span id="l106.453" class="difflineminus">-  onLoad: function(calendar) {</span>
<a href="#l106.454"></a><span id="l106.454" class="difflineplus">+  onLoad(calendar) {</span>
<a href="#l106.455"></a><span id="l106.455">     this.mCalendar.observers.notify(&quot;onLoad&quot;, [calendar]);</span>
<a href="#l106.456"></a><span id="l106.456">   },</span>
<a href="#l106.457"></a><span id="l106.457" class="difflineminus">-  onAddItem: function(aItem) {</span>
<a href="#l106.458"></a><span id="l106.458" class="difflineplus">+  onAddItem(aItem) {</span>
<a href="#l106.459"></a><span id="l106.459">     this.mCalendar.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l106.460"></a><span id="l106.460">   },</span>
<a href="#l106.461"></a><span id="l106.461" class="difflineminus">-  onModifyItem: function(aNewItem, aOldItem) {</span>
<a href="#l106.462"></a><span id="l106.462" class="difflineplus">+  onModifyItem(aNewItem, aOldItem) {</span>
<a href="#l106.463"></a><span id="l106.463">     this.mCalendar.observers.notify(&quot;onModifyItem&quot;, [aNewItem, aOldItem]);</span>
<a href="#l106.464"></a><span id="l106.464">   },</span>
<a href="#l106.465"></a><span id="l106.465" class="difflineminus">-  onDeleteItem: function(aDeletedItem) {</span>
<a href="#l106.466"></a><span id="l106.466" class="difflineplus">+  onDeleteItem(aDeletedItem) {</span>
<a href="#l106.467"></a><span id="l106.467">     this.mCalendar.observers.notify(&quot;onDeleteItem&quot;, [aDeletedItem]);</span>
<a href="#l106.468"></a><span id="l106.468">   },</span>
<a href="#l106.469"></a><span id="l106.469" class="difflineminus">-  onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l106.470"></a><span id="l106.470" class="difflineplus">+  onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l106.471"></a><span id="l106.471">     this.mCalendar.observers.notify(&quot;onPropertyChanged&quot;, [aCalendar, aName, aValue, aOldValue]);</span>
<a href="#l106.472"></a><span id="l106.472">   },</span>
<a href="#l106.473"></a><span id="l106.473" class="difflineminus">-  onPropertyDeleting: function(aCalendar, aName) {</span>
<a href="#l106.474"></a><span id="l106.474" class="difflineplus">+  onPropertyDeleting(aCalendar, aName) {</span>
<a href="#l106.475"></a><span id="l106.475">     this.mCalendar.observers.notify(&quot;onPropertyDeleting&quot;, [aCalendar, aName]);</span>
<a href="#l106.476"></a><span id="l106.476">   },</span>
<a href="#l106.477"></a><span id="l106.477"> </span>
<a href="#l106.478"></a><span id="l106.478" class="difflineminus">-  onError: function(aCalendar, aErrNo, aMessage) {</span>
<a href="#l106.479"></a><span id="l106.479" class="difflineplus">+  onError(aCalendar, aErrNo, aMessage) {</span>
<a href="#l106.480"></a><span id="l106.480">     this.mCalendar.readOnly = true;</span>
<a href="#l106.481"></a><span id="l106.481">     this.mCalendar.notifyError(aErrNo, aMessage);</span>
<a href="#l106.482"></a><span id="l106.482">   },</span>
<a href="#l106.483"></a><span id="l106.483"> };</span>
<a href="#l106.484"></a><span id="l106.484"> </span>
<a href="#l106.485"></a><span id="l106.485"> /*</span>
<a href="#l106.486"></a><span id="l106.486">  * Transport Abstraction Hooks</span>
<a href="#l106.487"></a><span id="l106.487">  *</span>
<a href="#l106.488"></a><span id="l106.488" class="difflineat">@@ -889,62 +889,62 @@ calICSObserver.prototype = {</span>
<a href="#l106.489"></a><span id="l106.489"> </span>
<a href="#l106.490"></a><span id="l106.490"> // dummyHooks are for transport types that don't have hooks of their own.</span>
<a href="#l106.491"></a><span id="l106.491"> // Also serves as poor-mans interface definition.</span>
<a href="#l106.492"></a><span id="l106.492"> function dummyHooks(calendar) {</span>
<a href="#l106.493"></a><span id="l106.493">   this.mCalendar = calendar;</span>
<a href="#l106.494"></a><span id="l106.494"> }</span>
<a href="#l106.495"></a><span id="l106.495"> </span>
<a href="#l106.496"></a><span id="l106.496"> dummyHooks.prototype = {</span>
<a href="#l106.497"></a><span id="l106.497" class="difflineminus">-  onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l106.498"></a><span id="l106.498" class="difflineplus">+  onBeforeGet(aChannel, aForceRefresh) {</span>
<a href="#l106.499"></a><span id="l106.499">     return true;</span>
<a href="#l106.500"></a><span id="l106.500">   },</span>
<a href="#l106.501"></a><span id="l106.501"> </span>
<a href="#l106.502"></a><span id="l106.502">   /**</span>
<a href="#l106.503"></a><span id="l106.503">    * @return</span>
<a href="#l106.504"></a><span id="l106.504">    *     a boolean, false if the previous data should be used (the datastore</span>
<a href="#l106.505"></a><span id="l106.505">    *     didn't change, there might be no data in this GET), true in all</span>
<a href="#l106.506"></a><span id="l106.506">    *     other cases</span>
<a href="#l106.507"></a><span id="l106.507">    */</span>
<a href="#l106.508"></a><span id="l106.508" class="difflineminus">-  onAfterGet: function(aChannel) {</span>
<a href="#l106.509"></a><span id="l106.509" class="difflineplus">+  onAfterGet(aChannel) {</span>
<a href="#l106.510"></a><span id="l106.510">     return true;</span>
<a href="#l106.511"></a><span id="l106.511">   },</span>
<a href="#l106.512"></a><span id="l106.512"> </span>
<a href="#l106.513"></a><span id="l106.513" class="difflineminus">-  onBeforePut: function(aChannel) {</span>
<a href="#l106.514"></a><span id="l106.514" class="difflineplus">+  onBeforePut(aChannel) {</span>
<a href="#l106.515"></a><span id="l106.515">     return true;</span>
<a href="#l106.516"></a><span id="l106.516">   },</span>
<a href="#l106.517"></a><span id="l106.517"> </span>
<a href="#l106.518"></a><span id="l106.518" class="difflineminus">-  onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l106.519"></a><span id="l106.519" class="difflineplus">+  onAfterPut(aChannel, aRespFunc) {</span>
<a href="#l106.520"></a><span id="l106.520">     aRespFunc();</span>
<a href="#l106.521"></a><span id="l106.521">     return true;</span>
<a href="#l106.522"></a><span id="l106.522">   },</span>
<a href="#l106.523"></a><span id="l106.523"> };</span>
<a href="#l106.524"></a><span id="l106.524"> </span>
<a href="#l106.525"></a><span id="l106.525"> function httpHooks(calendar) {</span>
<a href="#l106.526"></a><span id="l106.526">   this.mCalendar = calendar;</span>
<a href="#l106.527"></a><span id="l106.527"> }</span>
<a href="#l106.528"></a><span id="l106.528"> </span>
<a href="#l106.529"></a><span id="l106.529"> httpHooks.prototype = {</span>
<a href="#l106.530"></a><span id="l106.530" class="difflineminus">-  onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l106.531"></a><span id="l106.531" class="difflineplus">+  onBeforeGet(aChannel, aForceRefresh) {</span>
<a href="#l106.532"></a><span id="l106.532">     let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.533"></a><span id="l106.533">     httpchannel.setRequestHeader(&quot;Accept&quot;, &quot;text/calendar,text/plain;q=0.8,*/*;q=0.5&quot;, false);</span>
<a href="#l106.534"></a><span id="l106.534"> </span>
<a href="#l106.535"></a><span id="l106.535">     if (this.mEtag &amp;&amp; !aForceRefresh) {</span>
<a href="#l106.536"></a><span id="l106.536">       // Somehow the webdav header 'If' doesn't work on apache when</span>
<a href="#l106.537"></a><span id="l106.537">       // passing in a Not, so use the http version here.</span>
<a href="#l106.538"></a><span id="l106.538">       httpchannel.setRequestHeader(&quot;If-None-Match&quot;, this.mEtag, false);</span>
<a href="#l106.539"></a><span id="l106.539">     } else if (!aForceRefresh &amp;&amp; this.mLastModified) {</span>
<a href="#l106.540"></a><span id="l106.540">       // Only send 'If-Modified-Since' if no ETag is available</span>
<a href="#l106.541"></a><span id="l106.541">       httpchannel.setRequestHeader(&quot;If-Modified-Since&quot;, this.mLastModified, false);</span>
<a href="#l106.542"></a><span id="l106.542">     }</span>
<a href="#l106.543"></a><span id="l106.543"> </span>
<a href="#l106.544"></a><span id="l106.544">     return true;</span>
<a href="#l106.545"></a><span id="l106.545">   },</span>
<a href="#l106.546"></a><span id="l106.546"> </span>
<a href="#l106.547"></a><span id="l106.547" class="difflineminus">-  onAfterGet: function(aChannel) {</span>
<a href="#l106.548"></a><span id="l106.548" class="difflineplus">+  onAfterGet(aChannel) {</span>
<a href="#l106.549"></a><span id="l106.549">     let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.550"></a><span id="l106.550">     let responseStatus = 0;</span>
<a href="#l106.551"></a><span id="l106.551">     let responseStatusCategory = 0;</span>
<a href="#l106.552"></a><span id="l106.552"> </span>
<a href="#l106.553"></a><span id="l106.553">     try {</span>
<a href="#l106.554"></a><span id="l106.554">       responseStatus = httpchannel.responseStatus;</span>
<a href="#l106.555"></a><span id="l106.555">       responseStatusCategory = Math.floor(responseStatus / 100);</span>
<a href="#l106.556"></a><span id="l106.556">     } catch (e) {</span>
<a href="#l106.557"></a><span id="l106.557" class="difflineat">@@ -991,28 +991,28 @@ httpHooks.prototype = {</span>
<a href="#l106.558"></a><span id="l106.558">       this.mLastModified = httpchannel.getResponseHeader(&quot;Last-Modified&quot;);</span>
<a href="#l106.559"></a><span id="l106.559">     } catch (e) {</span>
<a href="#l106.560"></a><span id="l106.560">       this.mLastModified = null;</span>
<a href="#l106.561"></a><span id="l106.561">     }</span>
<a href="#l106.562"></a><span id="l106.562"> </span>
<a href="#l106.563"></a><span id="l106.563">     return true;</span>
<a href="#l106.564"></a><span id="l106.564">   },</span>
<a href="#l106.565"></a><span id="l106.565"> </span>
<a href="#l106.566"></a><span id="l106.566" class="difflineminus">-  onBeforePut: function(aChannel) {</span>
<a href="#l106.567"></a><span id="l106.567" class="difflineplus">+  onBeforePut(aChannel) {</span>
<a href="#l106.568"></a><span id="l106.568">     if (this.mEtag) {</span>
<a href="#l106.569"></a><span id="l106.569">       let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.570"></a><span id="l106.570"> </span>
<a href="#l106.571"></a><span id="l106.571">       // Apache doesn't work correctly with if-match on a PUT method,</span>
<a href="#l106.572"></a><span id="l106.572">       // so use the webdav header</span>
<a href="#l106.573"></a><span id="l106.573">       httpchannel.setRequestHeader(&quot;If&quot;, &quot;([&quot; + this.mEtag + &quot;])&quot;, false);</span>
<a href="#l106.574"></a><span id="l106.574">     }</span>
<a href="#l106.575"></a><span id="l106.575">     return true;</span>
<a href="#l106.576"></a><span id="l106.576">   },</span>
<a href="#l106.577"></a><span id="l106.577"> </span>
<a href="#l106.578"></a><span id="l106.578" class="difflineminus">-  onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l106.579"></a><span id="l106.579" class="difflineplus">+  onAfterPut(aChannel, aRespFunc) {</span>
<a href="#l106.580"></a><span id="l106.580">     let httpchannel = aChannel.QueryInterface(Ci.nsIHttpChannel);</span>
<a href="#l106.581"></a><span id="l106.581">     try {</span>
<a href="#l106.582"></a><span id="l106.582">       this.mEtag = httpchannel.getResponseHeader(&quot;ETag&quot;);</span>
<a href="#l106.583"></a><span id="l106.583">       aRespFunc();</span>
<a href="#l106.584"></a><span id="l106.584">     } catch (e) {</span>
<a href="#l106.585"></a><span id="l106.585">       // There was no ETag header on the response. This means that</span>
<a href="#l106.586"></a><span id="l106.586">       // putting is not atomic. This is bad. Race conditions can happen,</span>
<a href="#l106.587"></a><span id="l106.587">       // because there is a time in which we don't know the right</span>
<a href="#l106.588"></a><span id="l106.588" class="difflineat">@@ -1052,65 +1052,63 @@ httpHooks.prototype = {</span>
<a href="#l106.589"></a><span id="l106.589">       );</span>
<a href="#l106.590"></a><span id="l106.590"> </span>
<a href="#l106.591"></a><span id="l106.591">       cal.provider.sendHttpRequest(streamLoader, etagChannel, etagListener);</span>
<a href="#l106.592"></a><span id="l106.592">     }</span>
<a href="#l106.593"></a><span id="l106.593">     return true;</span>
<a href="#l106.594"></a><span id="l106.594">   },</span>
<a href="#l106.595"></a><span id="l106.595"> </span>
<a href="#l106.596"></a><span id="l106.596">   // nsIProgressEventSink</span>
<a href="#l106.597"></a><span id="l106.597" class="difflineminus">-  onProgress: function(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l106.598"></a><span id="l106.598" class="difflineminus">-  onStatus: function(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l106.599"></a><span id="l106.599" class="difflineplus">+  onProgress(aRequest, aContext, aProgress, aProgressMax) {},</span>
<a href="#l106.600"></a><span id="l106.600" class="difflineplus">+  onStatus(aRequest, aContext, aStatus, aStatusArg) {},</span>
<a href="#l106.601"></a><span id="l106.601"> </span>
<a href="#l106.602"></a><span id="l106.602" class="difflineminus">-  getInterface: function(aIid) {</span>
<a href="#l106.603"></a><span id="l106.603" class="difflineplus">+  getInterface(aIid) {</span>
<a href="#l106.604"></a><span id="l106.604">     if (aIid.equals(Ci.nsIProgressEventSink)) {</span>
<a href="#l106.605"></a><span id="l106.605">       return this;</span>
<a href="#l106.606"></a><span id="l106.606" class="difflineminus">-    } else {</span>
<a href="#l106.607"></a><span id="l106.607" class="difflineminus">-      throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l106.608"></a><span id="l106.608">     }</span>
<a href="#l106.609"></a><span id="l106.609" class="difflineplus">+    throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l106.610"></a><span id="l106.610">   },</span>
<a href="#l106.611"></a><span id="l106.611"> };</span>
<a href="#l106.612"></a><span id="l106.612"> </span>
<a href="#l106.613"></a><span id="l106.613"> function fileHooks(calendar) {</span>
<a href="#l106.614"></a><span id="l106.614">   this.mCalendar = calendar;</span>
<a href="#l106.615"></a><span id="l106.615"> }</span>
<a href="#l106.616"></a><span id="l106.616"> </span>
<a href="#l106.617"></a><span id="l106.617"> fileHooks.prototype = {</span>
<a href="#l106.618"></a><span id="l106.618" class="difflineminus">-  onBeforeGet: function(aChannel, aForceRefresh) {</span>
<a href="#l106.619"></a><span id="l106.619" class="difflineplus">+  onBeforeGet(aChannel, aForceRefresh) {</span>
<a href="#l106.620"></a><span id="l106.620">     return true;</span>
<a href="#l106.621"></a><span id="l106.621">   },</span>
<a href="#l106.622"></a><span id="l106.622"> </span>
<a href="#l106.623"></a><span id="l106.623">   /**</span>
<a href="#l106.624"></a><span id="l106.624">    * @return</span>
<a href="#l106.625"></a><span id="l106.625">    *     a boolean, false if the previous data should be used (the datastore</span>
<a href="#l106.626"></a><span id="l106.626">    *     didn't change, there might be no data in this GET), true in all</span>
<a href="#l106.627"></a><span id="l106.627">    *     other cases</span>
<a href="#l106.628"></a><span id="l106.628">    */</span>
<a href="#l106.629"></a><span id="l106.629" class="difflineminus">-  onAfterGet: function(aChannel) {</span>
<a href="#l106.630"></a><span id="l106.630" class="difflineplus">+  onAfterGet(aChannel) {</span>
<a href="#l106.631"></a><span id="l106.631">     let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l106.632"></a><span id="l106.632">     if (this.mtime) {</span>
<a href="#l106.633"></a><span id="l106.633">       let newMtime = filechannel.file.lastModifiedTime;</span>
<a href="#l106.634"></a><span id="l106.634">       if (this.mtime == newMtime) {</span>
<a href="#l106.635"></a><span id="l106.635">         return false;</span>
<a href="#l106.636"></a><span id="l106.636">       }</span>
<a href="#l106.637"></a><span id="l106.637">     }</span>
<a href="#l106.638"></a><span id="l106.638">     this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l106.639"></a><span id="l106.639">     return true;</span>
<a href="#l106.640"></a><span id="l106.640">   },</span>
<a href="#l106.641"></a><span id="l106.641"> </span>
<a href="#l106.642"></a><span id="l106.642" class="difflineminus">-  onBeforePut: function(aChannel) {</span>
<a href="#l106.643"></a><span id="l106.643" class="difflineplus">+  onBeforePut(aChannel) {</span>
<a href="#l106.644"></a><span id="l106.644">     let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l106.645"></a><span id="l106.645">     if (this.mtime &amp;&amp; this.mtime != filechannel.file.lastModifiedTime) {</span>
<a href="#l106.646"></a><span id="l106.646">       return false;</span>
<a href="#l106.647"></a><span id="l106.647" class="difflineminus">-    } else {</span>
<a href="#l106.648"></a><span id="l106.648" class="difflineminus">-      return true;</span>
<a href="#l106.649"></a><span id="l106.649">     }</span>
<a href="#l106.650"></a><span id="l106.650" class="difflineplus">+    return true;</span>
<a href="#l106.651"></a><span id="l106.651">   },</span>
<a href="#l106.652"></a><span id="l106.652"> </span>
<a href="#l106.653"></a><span id="l106.653" class="difflineminus">-  onAfterPut: function(aChannel, aRespFunc) {</span>
<a href="#l106.654"></a><span id="l106.654" class="difflineplus">+  onAfterPut(aChannel, aRespFunc) {</span>
<a href="#l106.655"></a><span id="l106.655">     let filechannel = aChannel.QueryInterface(Ci.nsIFileChannel);</span>
<a href="#l106.656"></a><span id="l106.656">     this.mtime = filechannel.file.lastModifiedTime;</span>
<a href="#l106.657"></a><span id="l106.657">     aRespFunc();</span>
<a href="#l106.658"></a><span id="l106.658">     return true;</span>
<a href="#l106.659"></a><span id="l106.659">   },</span>
<a href="#l106.660"></a><span id="l106.660"> };</span>
<a href="#l106.661"></a><span id="l106.661"> </span>
<a href="#l106.662"></a><span id="l106.662"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calICSCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/calendar/providers/memory/calMemoryCalendar.js</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -35,17 +35,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.4"></a><span id="l107.4">     interfaces: calMemoryCalendarInterfaces,</span>
<a href="#l107.5"></a><span id="l107.5">   }),</span>
<a href="#l107.6"></a><span id="l107.6"> </span>
<a href="#l107.7"></a><span id="l107.7">   mItems: null,</span>
<a href="#l107.8"></a><span id="l107.8">   mOfflineFlags: null,</span>
<a href="#l107.9"></a><span id="l107.9">   mObservers: null,</span>
<a href="#l107.10"></a><span id="l107.10">   mMetaData: null,</span>
<a href="#l107.11"></a><span id="l107.11"> </span>
<a href="#l107.12"></a><span id="l107.12" class="difflineminus">-  initMemoryCalendar: function() {</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+  initMemoryCalendar() {</span>
<a href="#l107.14"></a><span id="l107.14">     this.mObservers = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l107.15"></a><span id="l107.15">     this.mItems = {};</span>
<a href="#l107.16"></a><span id="l107.16">     this.mOfflineFlags = {};</span>
<a href="#l107.17"></a><span id="l107.17">     this.mMetaData = new Map();</span>
<a href="#l107.18"></a><span id="l107.18">   },</span>
<a href="#l107.19"></a><span id="l107.19"> </span>
<a href="#l107.20"></a><span id="l107.20">   //</span>
<a href="#l107.21"></a><span id="l107.21">   // calICalendarProvider interface</span>
<a href="#l107.22"></a><span id="l107.22" class="difflineat">@@ -53,21 +53,21 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.23"></a><span id="l107.23">   get prefChromeOverlay() {</span>
<a href="#l107.24"></a><span id="l107.24">     return null;</span>
<a href="#l107.25"></a><span id="l107.25">   },</span>
<a href="#l107.26"></a><span id="l107.26"> </span>
<a href="#l107.27"></a><span id="l107.27">   get displayName() {</span>
<a href="#l107.28"></a><span id="l107.28">     return cal.l10n.getCalString(&quot;memoryName&quot;);</span>
<a href="#l107.29"></a><span id="l107.29">   },</span>
<a href="#l107.30"></a><span id="l107.30"> </span>
<a href="#l107.31"></a><span id="l107.31" class="difflineminus">-  createCalendar: function() {</span>
<a href="#l107.32"></a><span id="l107.32" class="difflineplus">+  createCalendar() {</span>
<a href="#l107.33"></a><span id="l107.33">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l107.34"></a><span id="l107.34">   },</span>
<a href="#l107.35"></a><span id="l107.35"> </span>
<a href="#l107.36"></a><span id="l107.36" class="difflineminus">-  deleteCalendar: function(calendar, listener) {</span>
<a href="#l107.37"></a><span id="l107.37" class="difflineplus">+  deleteCalendar(calendar, listener) {</span>
<a href="#l107.38"></a><span id="l107.38">     calendar = calendar.wrappedJSObject;</span>
<a href="#l107.39"></a><span id="l107.39">     calendar.mItems = {};</span>
<a href="#l107.40"></a><span id="l107.40">     calendar.mMetaData = new Map();</span>
<a href="#l107.41"></a><span id="l107.41"> </span>
<a href="#l107.42"></a><span id="l107.42">     try {</span>
<a href="#l107.43"></a><span id="l107.43">       listener.onDeleteCalendar(calendar, Cr.NS_OK, null);</span>
<a href="#l107.44"></a><span id="l107.44">     } catch (ex) {</span>
<a href="#l107.45"></a><span id="l107.45">       // Don't bail out if the listener fails</span>
<a href="#l107.46"></a><span id="l107.46" class="difflineat">@@ -81,17 +81,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.47"></a><span id="l107.47">     }</span>
<a href="#l107.48"></a><span id="l107.48">     return this.mRelaxedMode;</span>
<a href="#l107.49"></a><span id="l107.49">   },</span>
<a href="#l107.50"></a><span id="l107.50"> </span>
<a href="#l107.51"></a><span id="l107.51">   //</span>
<a href="#l107.52"></a><span id="l107.52">   // calICalendar interface</span>
<a href="#l107.53"></a><span id="l107.53">   //</span>
<a href="#l107.54"></a><span id="l107.54"> </span>
<a href="#l107.55"></a><span id="l107.55" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l107.56"></a><span id="l107.56" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l107.57"></a><span id="l107.57">     switch (aName) {</span>
<a href="#l107.58"></a><span id="l107.58">       case &quot;cache.supported&quot;:</span>
<a href="#l107.59"></a><span id="l107.59">       case &quot;requiresNetwork&quot;:</span>
<a href="#l107.60"></a><span id="l107.60">         return false;</span>
<a href="#l107.61"></a><span id="l107.61">       case &quot;capabilities.priority.supported&quot;:</span>
<a href="#l107.62"></a><span id="l107.62">         return true;</span>
<a href="#l107.63"></a><span id="l107.63">       case &quot;removemodes&quot;:</span>
<a href="#l107.64"></a><span id="l107.64">         return [&quot;delete&quot;];</span>
<a href="#l107.65"></a><span id="l107.65" class="difflineat">@@ -100,23 +100,23 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.66"></a><span id="l107.66">   },</span>
<a href="#l107.67"></a><span id="l107.67"> </span>
<a href="#l107.68"></a><span id="l107.68">   // readonly attribute AUTF8String type;</span>
<a href="#l107.69"></a><span id="l107.69">   get type() {</span>
<a href="#l107.70"></a><span id="l107.70">     return &quot;memory&quot;;</span>
<a href="#l107.71"></a><span id="l107.71">   },</span>
<a href="#l107.72"></a><span id="l107.72"> </span>
<a href="#l107.73"></a><span id="l107.73">   // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l107.74"></a><span id="l107.74" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l107.75"></a><span id="l107.75" class="difflineplus">+  addItem(aItem, aListener) {</span>
<a href="#l107.76"></a><span id="l107.76">     let newItem = aItem.clone();</span>
<a href="#l107.77"></a><span id="l107.77">     return this.adoptItem(newItem, aListener);</span>
<a href="#l107.78"></a><span id="l107.78">   },</span>
<a href="#l107.79"></a><span id="l107.79"> </span>
<a href="#l107.80"></a><span id="l107.80">   // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l107.81"></a><span id="l107.81" class="difflineminus">-  adoptItem: function(aItem, aListener) {</span>
<a href="#l107.82"></a><span id="l107.82" class="difflineplus">+  adoptItem(aItem, aListener) {</span>
<a href="#l107.83"></a><span id="l107.83">     if (this.readOnly) {</span>
<a href="#l107.84"></a><span id="l107.84">       throw Ci.calIErrors.CAL_IS_READONLY;</span>
<a href="#l107.85"></a><span id="l107.85">     }</span>
<a href="#l107.86"></a><span id="l107.86">     if (aItem.id == null &amp;&amp; aItem.isMutable) {</span>
<a href="#l107.87"></a><span id="l107.87">       aItem.id = cal.getUUID();</span>
<a href="#l107.88"></a><span id="l107.88">     }</span>
<a href="#l107.89"></a><span id="l107.89"> </span>
<a href="#l107.90"></a><span id="l107.90">     if (aItem.id == null) {</span>
<a href="#l107.91"></a><span id="l107.91" class="difflineat">@@ -168,17 +168,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.92"></a><span id="l107.92">       aItem.id,</span>
<a href="#l107.93"></a><span id="l107.93">       aItem</span>
<a href="#l107.94"></a><span id="l107.94">     );</span>
<a href="#l107.95"></a><span id="l107.95">     // notify observers</span>
<a href="#l107.96"></a><span id="l107.96">     this.mObservers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l107.97"></a><span id="l107.97">   },</span>
<a href="#l107.98"></a><span id="l107.98"> </span>
<a href="#l107.99"></a><span id="l107.99">   // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l107.100"></a><span id="l107.100" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l107.101"></a><span id="l107.101" class="difflineplus">+  modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l107.102"></a><span id="l107.102">     if (this.readOnly) {</span>
<a href="#l107.103"></a><span id="l107.103">       throw Ci.calIErrors.CAL_IS_READONLY;</span>
<a href="#l107.104"></a><span id="l107.104">     }</span>
<a href="#l107.105"></a><span id="l107.105">     if (!aNewItem) {</span>
<a href="#l107.106"></a><span id="l107.106">       throw Cr.NS_ERROR_INVALID_ARG;</span>
<a href="#l107.107"></a><span id="l107.107">     }</span>
<a href="#l107.108"></a><span id="l107.108"> </span>
<a href="#l107.109"></a><span id="l107.109">     let self = this;</span>
<a href="#l107.110"></a><span id="l107.110" class="difflineat">@@ -269,17 +269,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.111"></a><span id="l107.111">     );</span>
<a href="#l107.112"></a><span id="l107.112"> </span>
<a href="#l107.113"></a><span id="l107.113">     // notify observers</span>
<a href="#l107.114"></a><span id="l107.114">     this.mObservers.notify(&quot;onModifyItem&quot;, [modifiedItem, aOldItem]);</span>
<a href="#l107.115"></a><span id="l107.115">     return null;</span>
<a href="#l107.116"></a><span id="l107.116">   },</span>
<a href="#l107.117"></a><span id="l107.117"> </span>
<a href="#l107.118"></a><span id="l107.118">   // void deleteItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l107.119"></a><span id="l107.119" class="difflineminus">-  deleteItem: function(aItem, aListener) {</span>
<a href="#l107.120"></a><span id="l107.120" class="difflineplus">+  deleteItem(aItem, aListener) {</span>
<a href="#l107.121"></a><span id="l107.121">     if (this.readOnly) {</span>
<a href="#l107.122"></a><span id="l107.122">       this.notifyOperationComplete(</span>
<a href="#l107.123"></a><span id="l107.123">         aListener,</span>
<a href="#l107.124"></a><span id="l107.124">         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l107.125"></a><span id="l107.125">         Ci.calIOperationListener.DELETE,</span>
<a href="#l107.126"></a><span id="l107.126">         aItem.id,</span>
<a href="#l107.127"></a><span id="l107.127">         &quot;Calendar is readonly&quot;</span>
<a href="#l107.128"></a><span id="l107.128">       );</span>
<a href="#l107.129"></a><span id="l107.129" class="difflineat">@@ -323,17 +323,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.130"></a><span id="l107.130">       aItem.id,</span>
<a href="#l107.131"></a><span id="l107.131">       aItem</span>
<a href="#l107.132"></a><span id="l107.132">     );</span>
<a href="#l107.133"></a><span id="l107.133">     // notify observers</span>
<a href="#l107.134"></a><span id="l107.134">     this.mObservers.notify(&quot;onDeleteItem&quot;, [oldItem]);</span>
<a href="#l107.135"></a><span id="l107.135">   },</span>
<a href="#l107.136"></a><span id="l107.136"> </span>
<a href="#l107.137"></a><span id="l107.137">   // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l107.138"></a><span id="l107.138" class="difflineminus">-  getItem: function(aId, aListener) {</span>
<a href="#l107.139"></a><span id="l107.139" class="difflineplus">+  getItem(aId, aListener) {</span>
<a href="#l107.140"></a><span id="l107.140">     if (!aListener) {</span>
<a href="#l107.141"></a><span id="l107.141">       return;</span>
<a href="#l107.142"></a><span id="l107.142">     }</span>
<a href="#l107.143"></a><span id="l107.143"> </span>
<a href="#l107.144"></a><span id="l107.144">     if (aId == null || this.mItems[aId] == null) {</span>
<a href="#l107.145"></a><span id="l107.145">       // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l107.146"></a><span id="l107.146">       this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, aId, null);</span>
<a href="#l107.147"></a><span id="l107.147">       return;</span>
<a href="#l107.148"></a><span id="l107.148" class="difflineat">@@ -360,22 +360,22 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.149"></a><span id="l107.149">     aListener.onGetResult(this.superCalendar, Cr.NS_OK, iid, null, [item]);</span>
<a href="#l107.150"></a><span id="l107.150"> </span>
<a href="#l107.151"></a><span id="l107.151">     this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, aId, null);</span>
<a href="#l107.152"></a><span id="l107.152">   },</span>
<a href="#l107.153"></a><span id="l107.153"> </span>
<a href="#l107.154"></a><span id="l107.154">   // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l107.155"></a><span id="l107.155">   //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l107.156"></a><span id="l107.156">   //                in calIOperationListener aListener );</span>
<a href="#l107.157"></a><span id="l107.157" class="difflineminus">-  getItems: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l107.158"></a><span id="l107.158" class="difflineplus">+  getItems(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l107.159"></a><span id="l107.159">     cal.postPone(() =&gt; {</span>
<a href="#l107.160"></a><span id="l107.160">       this.getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener);</span>
<a href="#l107.161"></a><span id="l107.161">     });</span>
<a href="#l107.162"></a><span id="l107.162">   },</span>
<a href="#l107.163"></a><span id="l107.163" class="difflineminus">-  getItems_: function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l107.164"></a><span id="l107.164" class="difflineplus">+  getItems_(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l107.165"></a><span id="l107.165">     if (!aListener) {</span>
<a href="#l107.166"></a><span id="l107.166">       return;</span>
<a href="#l107.167"></a><span id="l107.167">     }</span>
<a href="#l107.168"></a><span id="l107.168"> </span>
<a href="#l107.169"></a><span id="l107.169">     const calICalendar = Ci.calICalendar;</span>
<a href="#l107.170"></a><span id="l107.170"> </span>
<a href="#l107.171"></a><span id="l107.171">     let itemsFound = [];</span>
<a href="#l107.172"></a><span id="l107.172"> </span>
<a href="#l107.173"></a><span id="l107.173" class="difflineat">@@ -526,28 +526,28 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.174"></a><span id="l107.174">         this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, null, null);</span>
<a href="#l107.175"></a><span id="l107.175">       }</span>
<a href="#l107.176"></a><span id="l107.176">     );</span>
<a href="#l107.177"></a><span id="l107.177">   },</span>
<a href="#l107.178"></a><span id="l107.178"> </span>
<a href="#l107.179"></a><span id="l107.179">   //</span>
<a href="#l107.180"></a><span id="l107.180">   // calIOfflineStorage interface</span>
<a href="#l107.181"></a><span id="l107.181">   //</span>
<a href="#l107.182"></a><span id="l107.182" class="difflineminus">-  addOfflineItem: function(aItem, aListener) {</span>
<a href="#l107.183"></a><span id="l107.183" class="difflineplus">+  addOfflineItem(aItem, aListener) {</span>
<a href="#l107.184"></a><span id="l107.184">     this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l107.185"></a><span id="l107.185">     this.notifyOperationComplete(</span>
<a href="#l107.186"></a><span id="l107.186">       aListener,</span>
<a href="#l107.187"></a><span id="l107.187">       Cr.NS_OK,</span>
<a href="#l107.188"></a><span id="l107.188">       Ci.calIOperationListener.ADD,</span>
<a href="#l107.189"></a><span id="l107.189">       aItem.id,</span>
<a href="#l107.190"></a><span id="l107.190">       aItem</span>
<a href="#l107.191"></a><span id="l107.191">     );</span>
<a href="#l107.192"></a><span id="l107.192">   },</span>
<a href="#l107.193"></a><span id="l107.193"> </span>
<a href="#l107.194"></a><span id="l107.194" class="difflineminus">-  modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l107.195"></a><span id="l107.195" class="difflineplus">+  modifyOfflineItem(aItem, aListener) {</span>
<a href="#l107.196"></a><span id="l107.196">     let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l107.197"></a><span id="l107.197">     if (</span>
<a href="#l107.198"></a><span id="l107.198">       oldFlag != cICL.OFFLINE_FLAG_CREATED_RECORD &amp;&amp;</span>
<a href="#l107.199"></a><span id="l107.199">       oldFlag != cICL.OFFLINE_FLAG_DELETED_RECORD</span>
<a href="#l107.200"></a><span id="l107.200">     ) {</span>
<a href="#l107.201"></a><span id="l107.201">       this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l107.202"></a><span id="l107.202">     }</span>
<a href="#l107.203"></a><span id="l107.203"> </span>
<a href="#l107.204"></a><span id="l107.204" class="difflineat">@@ -555,17 +555,17 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.205"></a><span id="l107.205">       aListener,</span>
<a href="#l107.206"></a><span id="l107.206">       Cr.NS_OK,</span>
<a href="#l107.207"></a><span id="l107.207">       Ci.calIOperationListener.MODIFY,</span>
<a href="#l107.208"></a><span id="l107.208">       aItem.id,</span>
<a href="#l107.209"></a><span id="l107.209">       aItem</span>
<a href="#l107.210"></a><span id="l107.210">     );</span>
<a href="#l107.211"></a><span id="l107.211">   },</span>
<a href="#l107.212"></a><span id="l107.212"> </span>
<a href="#l107.213"></a><span id="l107.213" class="difflineminus">-  deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l107.214"></a><span id="l107.214" class="difflineplus">+  deleteOfflineItem(aItem, aListener) {</span>
<a href="#l107.215"></a><span id="l107.215">     let oldFlag = this.mOfflineFlags[aItem.id];</span>
<a href="#l107.216"></a><span id="l107.216">     if (oldFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l107.217"></a><span id="l107.217">       delete this.mItems[aItem.id];</span>
<a href="#l107.218"></a><span id="l107.218">       delete this.mOfflineFlags[aItem.id];</span>
<a href="#l107.219"></a><span id="l107.219">     } else {</span>
<a href="#l107.220"></a><span id="l107.220">       this.mOfflineFlags[aItem.id] = cICL.OFFLINE_FLAG_DELETED_RECORD;</span>
<a href="#l107.221"></a><span id="l107.221">     }</span>
<a href="#l107.222"></a><span id="l107.222"> </span>
<a href="#l107.223"></a><span id="l107.223" class="difflineat">@@ -575,46 +575,46 @@ calMemoryCalendar.prototype = {</span>
<a href="#l107.224"></a><span id="l107.224">       Ci.calIOperationListener.DELETE,</span>
<a href="#l107.225"></a><span id="l107.225">       aItem.id,</span>
<a href="#l107.226"></a><span id="l107.226">       aItem</span>
<a href="#l107.227"></a><span id="l107.227">     );</span>
<a href="#l107.228"></a><span id="l107.228">     // notify observers</span>
<a href="#l107.229"></a><span id="l107.229">     this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l107.230"></a><span id="l107.230">   },</span>
<a href="#l107.231"></a><span id="l107.231"> </span>
<a href="#l107.232"></a><span id="l107.232" class="difflineminus">-  getItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l107.233"></a><span id="l107.233" class="difflineplus">+  getItemOfflineFlag(aItem, aListener) {</span>
<a href="#l107.234"></a><span id="l107.234">     let flag = aItem &amp;&amp; aItem.id in this.mOfflineFlags ? this.mOfflineFlags[aItem.id] : null;</span>
<a href="#l107.235"></a><span id="l107.235">     this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, null, flag);</span>
<a href="#l107.236"></a><span id="l107.236">   },</span>
<a href="#l107.237"></a><span id="l107.237"> </span>
<a href="#l107.238"></a><span id="l107.238" class="difflineminus">-  resetItemOfflineFlag: function(aItem, aListener) {</span>
<a href="#l107.239"></a><span id="l107.239" class="difflineplus">+  resetItemOfflineFlag(aItem, aListener) {</span>
<a href="#l107.240"></a><span id="l107.240">     delete this.mOfflineFlags[aItem.id];</span>
<a href="#l107.241"></a><span id="l107.241">     this.notifyOperationComplete(</span>
<a href="#l107.242"></a><span id="l107.242">       aListener,</span>
<a href="#l107.243"></a><span id="l107.243">       Cr.NS_OK,</span>
<a href="#l107.244"></a><span id="l107.244">       Ci.calIOperationListener.MODIFY,</span>
<a href="#l107.245"></a><span id="l107.245">       aItem.id,</span>
<a href="#l107.246"></a><span id="l107.246">       aItem</span>
<a href="#l107.247"></a><span id="l107.247">     );</span>
<a href="#l107.248"></a><span id="l107.248">   },</span>
<a href="#l107.249"></a><span id="l107.249"> </span>
<a href="#l107.250"></a><span id="l107.250">   //</span>
<a href="#l107.251"></a><span id="l107.251">   // calISyncWriteCalendar interface</span>
<a href="#l107.252"></a><span id="l107.252">   //</span>
<a href="#l107.253"></a><span id="l107.253" class="difflineminus">-  setMetaData: function(id, value) {</span>
<a href="#l107.254"></a><span id="l107.254" class="difflineplus">+  setMetaData(id, value) {</span>
<a href="#l107.255"></a><span id="l107.255">     this.mMetaData.set(id, value);</span>
<a href="#l107.256"></a><span id="l107.256">   },</span>
<a href="#l107.257"></a><span id="l107.257" class="difflineminus">-  deleteMetaData: function(id) {</span>
<a href="#l107.258"></a><span id="l107.258" class="difflineplus">+  deleteMetaData(id) {</span>
<a href="#l107.259"></a><span id="l107.259">     this.mMetaData.delete(id);</span>
<a href="#l107.260"></a><span id="l107.260">   },</span>
<a href="#l107.261"></a><span id="l107.261" class="difflineminus">-  getMetaData: function(id) {</span>
<a href="#l107.262"></a><span id="l107.262" class="difflineplus">+  getMetaData(id) {</span>
<a href="#l107.263"></a><span id="l107.263">     return this.mMetaData.get(id);</span>
<a href="#l107.264"></a><span id="l107.264">   },</span>
<a href="#l107.265"></a><span id="l107.265" class="difflineminus">-  getAllMetaDataIds: function() {</span>
<a href="#l107.266"></a><span id="l107.266" class="difflineplus">+  getAllMetaDataIds() {</span>
<a href="#l107.267"></a><span id="l107.267">     return [...this.mMetaData.keys()];</span>
<a href="#l107.268"></a><span id="l107.268">   },</span>
<a href="#l107.269"></a><span id="l107.269" class="difflineminus">-  getAllMetaDataValues: function() {</span>
<a href="#l107.270"></a><span id="l107.270" class="difflineplus">+  getAllMetaDataValues() {</span>
<a href="#l107.271"></a><span id="l107.271">     return [...this.mMetaData.values()];</span>
<a href="#l107.272"></a><span id="l107.272">   },</span>
<a href="#l107.273"></a><span id="l107.273"> };</span>
<a href="#l107.274"></a><span id="l107.274"> </span>
<a href="#l107.275"></a><span id="l107.275"> /** Module Registration */</span>
<a href="#l107.276"></a><span id="l107.276"> this.NSGetFactory = XPCOMUtils.generateNSGetFactory([calMemoryCalendar]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageCalendar.js</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -60,21 +60,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.4"></a><span id="l108.4">   get prefChromeOverlay() {</span>
<a href="#l108.5"></a><span id="l108.5">     return null;</span>
<a href="#l108.6"></a><span id="l108.6">   },</span>
<a href="#l108.7"></a><span id="l108.7"> </span>
<a href="#l108.8"></a><span id="l108.8">   get displayName() {</span>
<a href="#l108.9"></a><span id="l108.9">     return cal.l10n.getCalString(&quot;storageName&quot;);</span>
<a href="#l108.10"></a><span id="l108.10">   },</span>
<a href="#l108.11"></a><span id="l108.11"> </span>
<a href="#l108.12"></a><span id="l108.12" class="difflineminus">-  createCalendar: function() {</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+  createCalendar() {</span>
<a href="#l108.14"></a><span id="l108.14">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l108.15"></a><span id="l108.15">   },</span>
<a href="#l108.16"></a><span id="l108.16"> </span>
<a href="#l108.17"></a><span id="l108.17" class="difflineminus">-  deleteCalendar: async function(aCalendar, listener) {</span>
<a href="#l108.18"></a><span id="l108.18" class="difflineplus">+  async deleteCalendar(aCalendar, listener) {</span>
<a href="#l108.19"></a><span id="l108.19">     let stmts = [];</span>
<a href="#l108.20"></a><span id="l108.20">     aCalendar = aCalendar.wrappedJSObject;</span>
<a href="#l108.21"></a><span id="l108.21"> </span>
<a href="#l108.22"></a><span id="l108.22">     if (this.mDeleteEventExtras) {</span>
<a href="#l108.23"></a><span id="l108.23">       for (let stmt of this.mDeleteEventExtras) {</span>
<a href="#l108.24"></a><span id="l108.24">         stmts.push(this.prepareStatement(stmt));</span>
<a href="#l108.25"></a><span id="l108.25">       }</span>
<a href="#l108.26"></a><span id="l108.26">     }</span>
<a href="#l108.27"></a><span id="l108.27" class="difflineat">@@ -107,17 +107,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.28"></a><span id="l108.28">     }</span>
<a href="#l108.29"></a><span id="l108.29">     return this.mRelaxedMode;</span>
<a href="#l108.30"></a><span id="l108.30">   },</span>
<a href="#l108.31"></a><span id="l108.31"> </span>
<a href="#l108.32"></a><span id="l108.32">   //</span>
<a href="#l108.33"></a><span id="l108.33">   // calICalendar interface</span>
<a href="#l108.34"></a><span id="l108.34">   //</span>
<a href="#l108.35"></a><span id="l108.35"> </span>
<a href="#l108.36"></a><span id="l108.36" class="difflineminus">-  getProperty: function(aName) {</span>
<a href="#l108.37"></a><span id="l108.37" class="difflineplus">+  getProperty(aName) {</span>
<a href="#l108.38"></a><span id="l108.38">     switch (aName) {</span>
<a href="#l108.39"></a><span id="l108.39">       case &quot;cache.supported&quot;:</span>
<a href="#l108.40"></a><span id="l108.40">         return false;</span>
<a href="#l108.41"></a><span id="l108.41">       case &quot;requiresNetwork&quot;:</span>
<a href="#l108.42"></a><span id="l108.42">         return false;</span>
<a href="#l108.43"></a><span id="l108.43">       case &quot;capabilities.priority.supported&quot;:</span>
<a href="#l108.44"></a><span id="l108.44">         return true;</span>
<a href="#l108.45"></a><span id="l108.45">       case &quot;capabilities.removeModes&quot;:</span>
<a href="#l108.46"></a><span id="l108.46" class="difflineat">@@ -164,17 +164,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.47"></a><span id="l108.47"> </span>
<a href="#l108.48"></a><span id="l108.48">     return uri;</span>
<a href="#l108.49"></a><span id="l108.49">   },</span>
<a href="#l108.50"></a><span id="l108.50"> </span>
<a href="#l108.51"></a><span id="l108.51">   /**</span>
<a href="#l108.52"></a><span id="l108.52">    * Initialize the Database. This should only be called from the uri or id</span>
<a href="#l108.53"></a><span id="l108.53">    * setter and requires those two attributes to be set.</span>
<a href="#l108.54"></a><span id="l108.54">    */</span>
<a href="#l108.55"></a><span id="l108.55" class="difflineminus">-  prepareInitDB: function() {</span>
<a href="#l108.56"></a><span id="l108.56" class="difflineplus">+  prepareInitDB() {</span>
<a href="#l108.57"></a><span id="l108.57">     if (this.uri.schemeIs(&quot;file&quot;)) {</span>
<a href="#l108.58"></a><span id="l108.58">       let fileURL = this.uri.QueryInterface(Ci.nsIFileURL);</span>
<a href="#l108.59"></a><span id="l108.59">       if (!fileURL) {</span>
<a href="#l108.60"></a><span id="l108.60">         throw new Components.Exception(&quot;Invalid file&quot;, Cr.NS_ERROR_NOT_IMPLEMENTED);</span>
<a href="#l108.61"></a><span id="l108.61">       }</span>
<a href="#l108.62"></a><span id="l108.62">       // open the database</span>
<a href="#l108.63"></a><span id="l108.63">       this.mDB = Services.storage.openDatabase(fileURL.file);</span>
<a href="#l108.64"></a><span id="l108.64">       upgradeDB(this.mDB);</span>
<a href="#l108.65"></a><span id="l108.65" class="difflineat">@@ -188,78 +188,78 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.66"></a><span id="l108.66">     } else {</span>
<a href="#l108.67"></a><span id="l108.67">       throw new Components.Exception(&quot;Invalid Scheme &quot; + this.uri.spec);</span>
<a href="#l108.68"></a><span id="l108.68">     }</span>
<a href="#l108.69"></a><span id="l108.69"> </span>
<a href="#l108.70"></a><span id="l108.70">     this.initDB();</span>
<a href="#l108.71"></a><span id="l108.71">     Services.obs.addObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l108.72"></a><span id="l108.72">   },</span>
<a href="#l108.73"></a><span id="l108.73"> </span>
<a href="#l108.74"></a><span id="l108.74" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l108.75"></a><span id="l108.75" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l108.76"></a><span id="l108.76">     if (aTopic == &quot;profile-before-change&quot;) {</span>
<a href="#l108.77"></a><span id="l108.77">       Services.obs.removeObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l108.78"></a><span id="l108.78">       this.shutdownDB();</span>
<a href="#l108.79"></a><span id="l108.79">     }</span>
<a href="#l108.80"></a><span id="l108.80">   },</span>
<a href="#l108.81"></a><span id="l108.81"> </span>
<a href="#l108.82"></a><span id="l108.82">   /**</span>
<a href="#l108.83"></a><span id="l108.83">    * Takes care of necessary preparations for most of our statements.</span>
<a href="#l108.84"></a><span id="l108.84">    *</span>
<a href="#l108.85"></a><span id="l108.85">    * @param aStmt         The statement to prepare.</span>
<a href="#l108.86"></a><span id="l108.86">    */</span>
<a href="#l108.87"></a><span id="l108.87" class="difflineminus">-  prepareStatement: function(aStmt) {</span>
<a href="#l108.88"></a><span id="l108.88" class="difflineplus">+  prepareStatement(aStmt) {</span>
<a href="#l108.89"></a><span id="l108.89">     try {</span>
<a href="#l108.90"></a><span id="l108.90">       aStmt.params.cal_id = this.id;</span>
<a href="#l108.91"></a><span id="l108.91">       this.mLastStatement = aStmt;</span>
<a href="#l108.92"></a><span id="l108.92">     } catch (e) {</span>
<a href="#l108.93"></a><span id="l108.93">       this.logError(&quot;prepareStatement exception&quot;, e);</span>
<a href="#l108.94"></a><span id="l108.94">     }</span>
<a href="#l108.95"></a><span id="l108.95">     return aStmt;</span>
<a href="#l108.96"></a><span id="l108.96">   },</span>
<a href="#l108.97"></a><span id="l108.97"> </span>
<a href="#l108.98"></a><span id="l108.98">   /**</span>
<a href="#l108.99"></a><span id="l108.99">    * Executes a statement using an item as a parameter.</span>
<a href="#l108.100"></a><span id="l108.100">    *</span>
<a href="#l108.101"></a><span id="l108.101">    * @param aStmt         The statement to execute.</span>
<a href="#l108.102"></a><span id="l108.102">    * @param aIdParam      The name of the parameter referring to the item id.</span>
<a href="#l108.103"></a><span id="l108.103">    * @param aId           The id of the item.</span>
<a href="#l108.104"></a><span id="l108.104">    */</span>
<a href="#l108.105"></a><span id="l108.105" class="difflineminus">-  executeSyncItemStatement: function(aStmt, aIdParam, aId) {</span>
<a href="#l108.106"></a><span id="l108.106" class="difflineplus">+  executeSyncItemStatement(aStmt, aIdParam, aId) {</span>
<a href="#l108.107"></a><span id="l108.107">     try {</span>
<a href="#l108.108"></a><span id="l108.108">       aStmt.params.cal_id = this.id;</span>
<a href="#l108.109"></a><span id="l108.109">       aStmt.params[aIdParam] = aId;</span>
<a href="#l108.110"></a><span id="l108.110">       aStmt.executeStep();</span>
<a href="#l108.111"></a><span id="l108.111">     } catch (e) {</span>
<a href="#l108.112"></a><span id="l108.112">       this.logError(&quot;executeSyncItemStatement exception&quot;, e);</span>
<a href="#l108.113"></a><span id="l108.113">       throw e;</span>
<a href="#l108.114"></a><span id="l108.114">     } finally {</span>
<a href="#l108.115"></a><span id="l108.115">       aStmt.reset();</span>
<a href="#l108.116"></a><span id="l108.116">     }</span>
<a href="#l108.117"></a><span id="l108.117">   },</span>
<a href="#l108.118"></a><span id="l108.118"> </span>
<a href="#l108.119"></a><span id="l108.119" class="difflineminus">-  prepareAsyncStatement: function(aStmts, aStmt) {</span>
<a href="#l108.120"></a><span id="l108.120" class="difflineplus">+  prepareAsyncStatement(aStmts, aStmt) {</span>
<a href="#l108.121"></a><span id="l108.121">     if (!aStmts.has(aStmt)) {</span>
<a href="#l108.122"></a><span id="l108.122">       aStmts.set(aStmt, aStmt.newBindingParamsArray());</span>
<a href="#l108.123"></a><span id="l108.123">     }</span>
<a href="#l108.124"></a><span id="l108.124">     return aStmts.get(aStmt);</span>
<a href="#l108.125"></a><span id="l108.125">   },</span>
<a href="#l108.126"></a><span id="l108.126"> </span>
<a href="#l108.127"></a><span id="l108.127" class="difflineminus">-  prepareAsyncParams: function(aArray) {</span>
<a href="#l108.128"></a><span id="l108.128" class="difflineplus">+  prepareAsyncParams(aArray) {</span>
<a href="#l108.129"></a><span id="l108.129">     let params = aArray.newBindingParams();</span>
<a href="#l108.130"></a><span id="l108.130">     params.bindByName(&quot;cal_id&quot;, this.id);</span>
<a href="#l108.131"></a><span id="l108.131">     return params;</span>
<a href="#l108.132"></a><span id="l108.132">   },</span>
<a href="#l108.133"></a><span id="l108.133"> </span>
<a href="#l108.134"></a><span id="l108.134" class="difflineminus">-  prepareItemStatement: function(aStmts, aStmt, aIdParam, aId) {</span>
<a href="#l108.135"></a><span id="l108.135" class="difflineplus">+  prepareItemStatement(aStmts, aStmt, aIdParam, aId) {</span>
<a href="#l108.136"></a><span id="l108.136">     aStmt.params.cal_id = this.id;</span>
<a href="#l108.137"></a><span id="l108.137">     aStmt.params[aIdParam] = aId;</span>
<a href="#l108.138"></a><span id="l108.138">     aStmts.push(aStmt);</span>
<a href="#l108.139"></a><span id="l108.139">   },</span>
<a href="#l108.140"></a><span id="l108.140"> </span>
<a href="#l108.141"></a><span id="l108.141" class="difflineminus">-  executeAsync: function(aStmts, aCallback) {</span>
<a href="#l108.142"></a><span id="l108.142" class="difflineplus">+  executeAsync(aStmts, aCallback) {</span>
<a href="#l108.143"></a><span id="l108.143">     if (!Array.isArray(aStmts)) {</span>
<a href="#l108.144"></a><span id="l108.144">       aStmts = [aStmts];</span>
<a href="#l108.145"></a><span id="l108.145">     }</span>
<a href="#l108.146"></a><span id="l108.146">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l108.147"></a><span id="l108.147">       this.mDB.executeAsync(aStmts, {</span>
<a href="#l108.148"></a><span id="l108.148">         resultPromises: [],</span>
<a href="#l108.149"></a><span id="l108.149"> </span>
<a href="#l108.150"></a><span id="l108.150">         handleResult(aResultSet) {</span>
<a href="#l108.151"></a><span id="l108.151" class="difflineat">@@ -299,28 +299,28 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.152"></a><span id="l108.152">               reject(Components.Exception(&quot;error executing async statement&quot;, Cr.NS_ERROR_FAILURE));</span>
<a href="#l108.153"></a><span id="l108.153">               break;</span>
<a href="#l108.154"></a><span id="l108.154">           }</span>
<a href="#l108.155"></a><span id="l108.155">         },</span>
<a href="#l108.156"></a><span id="l108.156">       });</span>
<a href="#l108.157"></a><span id="l108.157">     });</span>
<a href="#l108.158"></a><span id="l108.158">   },</span>
<a href="#l108.159"></a><span id="l108.159"> </span>
<a href="#l108.160"></a><span id="l108.160" class="difflineminus">-  refresh: function() {</span>
<a href="#l108.161"></a><span id="l108.161" class="difflineplus">+  refresh() {</span>
<a href="#l108.162"></a><span id="l108.162">     // no-op</span>
<a href="#l108.163"></a><span id="l108.163">   },</span>
<a href="#l108.164"></a><span id="l108.164"> </span>
<a href="#l108.165"></a><span id="l108.165">   // void addItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l108.166"></a><span id="l108.166" class="difflineminus">-  addItem: function(aItem, aListener) {</span>
<a href="#l108.167"></a><span id="l108.167" class="difflineplus">+  addItem(aItem, aListener) {</span>
<a href="#l108.168"></a><span id="l108.168">     let newItem = aItem.clone();</span>
<a href="#l108.169"></a><span id="l108.169">     return this.adoptItem(newItem, aListener);</span>
<a href="#l108.170"></a><span id="l108.170">   },</span>
<a href="#l108.171"></a><span id="l108.171"> </span>
<a href="#l108.172"></a><span id="l108.172">   // void adoptItem( in calIItemBase aItem, in calIOperationListener aListener );</span>
<a href="#l108.173"></a><span id="l108.173" class="difflineminus">-  adoptItem: async function(aItem, aListener) {</span>
<a href="#l108.174"></a><span id="l108.174" class="difflineplus">+  async adoptItem(aItem, aListener) {</span>
<a href="#l108.175"></a><span id="l108.175">     if (this.readOnly) {</span>
<a href="#l108.176"></a><span id="l108.176">       this.notifyOperationComplete(</span>
<a href="#l108.177"></a><span id="l108.177">         aListener,</span>
<a href="#l108.178"></a><span id="l108.178">         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l108.179"></a><span id="l108.179">         Ci.calIOperationListener.ADD,</span>
<a href="#l108.180"></a><span id="l108.180">         null,</span>
<a href="#l108.181"></a><span id="l108.181">         &quot;Calendar is readonly&quot;</span>
<a href="#l108.182"></a><span id="l108.182">       );</span>
<a href="#l108.183"></a><span id="l108.183" class="difflineat">@@ -369,31 +369,31 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.184"></a><span id="l108.184">     );</span>
<a href="#l108.185"></a><span id="l108.185"> </span>
<a href="#l108.186"></a><span id="l108.186">     // notify observers</span>
<a href="#l108.187"></a><span id="l108.187">     this.observers.notify(&quot;onAddItem&quot;, [aItem]);</span>
<a href="#l108.188"></a><span id="l108.188">   },</span>
<a href="#l108.189"></a><span id="l108.189"> </span>
<a href="#l108.190"></a><span id="l108.190">   // void modifyItem( in calIItemBase aNewItem, in calIItemBase aOldItem, in calIOperationListener aListener );</span>
<a href="#l108.191"></a><span id="l108.191">   // Actually uses doModifyItem</span>
<a href="#l108.192"></a><span id="l108.192" class="difflineminus">-  modifyItem: function(aNewItem, aOldItem, aListener) {</span>
<a href="#l108.193"></a><span id="l108.193" class="difflineplus">+  modifyItem(aNewItem, aOldItem, aListener) {</span>
<a href="#l108.194"></a><span id="l108.194">     let self = this;</span>
<a href="#l108.195"></a><span id="l108.195"> </span>
<a href="#l108.196"></a><span id="l108.196">     // HACK Just modifying the item would clear the offline flag, we need to</span>
<a href="#l108.197"></a><span id="l108.197">     // retrieve the flag and pass it to the real modify function.</span>
<a href="#l108.198"></a><span id="l108.198">     let offlineJournalFlagListener = {</span>
<a href="#l108.199"></a><span id="l108.199" class="difflineminus">-      onGetResult: function(calendar, status, opType, id, detail) {},</span>
<a href="#l108.200"></a><span id="l108.200" class="difflineminus">-      onOperationComplete: function(opcalendar, status, opType, id, offlineFlag) {</span>
<a href="#l108.201"></a><span id="l108.201" class="difflineplus">+      onGetResult(calendar, status, opType, id, detail) {},</span>
<a href="#l108.202"></a><span id="l108.202" class="difflineplus">+      onOperationComplete(opcalendar, status, opType, id, offlineFlag) {</span>
<a href="#l108.203"></a><span id="l108.203">         self.doModifyItem(aNewItem, aOldItem, aListener, offlineFlag);</span>
<a href="#l108.204"></a><span id="l108.204">       },</span>
<a href="#l108.205"></a><span id="l108.205">     };</span>
<a href="#l108.206"></a><span id="l108.206">     this.getItemOfflineFlag(aOldItem, offlineJournalFlagListener);</span>
<a href="#l108.207"></a><span id="l108.207">   },</span>
<a href="#l108.208"></a><span id="l108.208"> </span>
<a href="#l108.209"></a><span id="l108.209" class="difflineminus">-  doModifyItem: async function(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l108.210"></a><span id="l108.210" class="difflineplus">+  async doModifyItem(aNewItem, aOldItem, aListener, offlineFlag) {</span>
<a href="#l108.211"></a><span id="l108.211">     let oldOfflineFlag = offlineFlag;</span>
<a href="#l108.212"></a><span id="l108.212">     if (this.readOnly) {</span>
<a href="#l108.213"></a><span id="l108.213">       this.notifyOperationComplete(</span>
<a href="#l108.214"></a><span id="l108.214">         aListener,</span>
<a href="#l108.215"></a><span id="l108.215">         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l108.216"></a><span id="l108.216">         Ci.calIOperationListener.MODIFY,</span>
<a href="#l108.217"></a><span id="l108.217">         null,</span>
<a href="#l108.218"></a><span id="l108.218">         &quot;Calendar is readonly&quot;</span>
<a href="#l108.219"></a><span id="l108.219" class="difflineat">@@ -489,17 +489,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.220"></a><span id="l108.220">     );</span>
<a href="#l108.221"></a><span id="l108.221"> </span>
<a href="#l108.222"></a><span id="l108.222">     // notify observers</span>
<a href="#l108.223"></a><span id="l108.223">     this.observers.notify(&quot;onModifyItem&quot;, [modifiedItem, aOldItem]);</span>
<a href="#l108.224"></a><span id="l108.224">     return null;</span>
<a href="#l108.225"></a><span id="l108.225">   },</span>
<a href="#l108.226"></a><span id="l108.226"> </span>
<a href="#l108.227"></a><span id="l108.227">   // void deleteItem( in string id, in calIOperationListener aListener );</span>
<a href="#l108.228"></a><span id="l108.228" class="difflineminus">-  deleteItem: async function(aItem, aListener) {</span>
<a href="#l108.229"></a><span id="l108.229" class="difflineplus">+  async deleteItem(aItem, aListener) {</span>
<a href="#l108.230"></a><span id="l108.230">     if (this.readOnly) {</span>
<a href="#l108.231"></a><span id="l108.231">       this.notifyOperationComplete(</span>
<a href="#l108.232"></a><span id="l108.232">         aListener,</span>
<a href="#l108.233"></a><span id="l108.233">         Ci.calIErrors.CAL_IS_READONLY,</span>
<a href="#l108.234"></a><span id="l108.234">         Ci.calIOperationListener.DELETE,</span>
<a href="#l108.235"></a><span id="l108.235">         null,</span>
<a href="#l108.236"></a><span id="l108.236">         &quot;Calendar is readonly&quot;</span>
<a href="#l108.237"></a><span id="l108.237">       );</span>
<a href="#l108.238"></a><span id="l108.238" class="difflineat">@@ -533,17 +533,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.239"></a><span id="l108.239">       aItem</span>
<a href="#l108.240"></a><span id="l108.240">     );</span>
<a href="#l108.241"></a><span id="l108.241"> </span>
<a href="#l108.242"></a><span id="l108.242">     // notify observers</span>
<a href="#l108.243"></a><span id="l108.243">     this.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l108.244"></a><span id="l108.244">   },</span>
<a href="#l108.245"></a><span id="l108.245"> </span>
<a href="#l108.246"></a><span id="l108.246">   // void getItem( in string id, in calIOperationListener aListener );</span>
<a href="#l108.247"></a><span id="l108.247" class="difflineminus">-  getItem: async function(aId, aListener) {</span>
<a href="#l108.248"></a><span id="l108.248" class="difflineplus">+  async getItem(aId, aListener) {</span>
<a href="#l108.249"></a><span id="l108.249">     if (!aListener) {</span>
<a href="#l108.250"></a><span id="l108.250">       return;</span>
<a href="#l108.251"></a><span id="l108.251">     }</span>
<a href="#l108.252"></a><span id="l108.252"> </span>
<a href="#l108.253"></a><span id="l108.253">     let item = await this.getItemById(aId);</span>
<a href="#l108.254"></a><span id="l108.254">     if (!item) {</span>
<a href="#l108.255"></a><span id="l108.255">       // querying by id is a valid use case, even if no item is returned:</span>
<a href="#l108.256"></a><span id="l108.256">       this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, aId, null);</span>
<a href="#l108.257"></a><span id="l108.257" class="difflineat">@@ -569,17 +569,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.258"></a><span id="l108.258">     aListener.onGetResult(this.superCalendar, Cr.NS_OK, item_iid, null, [item]);</span>
<a href="#l108.259"></a><span id="l108.259"> </span>
<a href="#l108.260"></a><span id="l108.260">     this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, aId, null);</span>
<a href="#l108.261"></a><span id="l108.261">   },</span>
<a href="#l108.262"></a><span id="l108.262"> </span>
<a href="#l108.263"></a><span id="l108.263">   // void getItems( in unsigned long aItemFilter, in unsigned long aCount,</span>
<a href="#l108.264"></a><span id="l108.264">   //                in calIDateTime aRangeStart, in calIDateTime aRangeEnd,</span>
<a href="#l108.265"></a><span id="l108.265">   //                in calIOperationListener aListener );</span>
<a href="#l108.266"></a><span id="l108.266" class="difflineminus">-  getItems: async function(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l108.267"></a><span id="l108.267" class="difflineplus">+  async getItems(aItemFilter, aCount, aRangeStart, aRangeEnd, aListener) {</span>
<a href="#l108.268"></a><span id="l108.268">     if (!aListener) {</span>
<a href="#l108.269"></a><span id="l108.269">       return;</span>
<a href="#l108.270"></a><span id="l108.270">     }</span>
<a href="#l108.271"></a><span id="l108.271"> </span>
<a href="#l108.272"></a><span id="l108.272">     let self = this;</span>
<a href="#l108.273"></a><span id="l108.273"> </span>
<a href="#l108.274"></a><span id="l108.274">     let startTime = -0x7fffffffffffffff;</span>
<a href="#l108.275"></a><span id="l108.275">     // endTime needs to be the max value a PRTime can be</span>
<a href="#l108.276"></a><span id="l108.276" class="difflineat">@@ -836,17 +836,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.277"></a><span id="l108.277"> </span>
<a href="#l108.278"></a><span id="l108.278">     // flush the queue</span>
<a href="#l108.279"></a><span id="l108.279">     queueItems(null);</span>
<a href="#l108.280"></a><span id="l108.280"> </span>
<a href="#l108.281"></a><span id="l108.281">     // and finish</span>
<a href="#l108.282"></a><span id="l108.282">     this.notifyOperationComplete(aListener, Cr.NS_OK, Ci.calIOperationListener.GET, null, null);</span>
<a href="#l108.283"></a><span id="l108.283">   },</span>
<a href="#l108.284"></a><span id="l108.284"> </span>
<a href="#l108.285"></a><span id="l108.285" class="difflineminus">-  getItemOfflineFlag: async function(aItem, aListener) {</span>
<a href="#l108.286"></a><span id="l108.286" class="difflineplus">+  async getItemOfflineFlag(aItem, aListener) {</span>
<a href="#l108.287"></a><span id="l108.287">     let flag = null;</span>
<a href="#l108.288"></a><span id="l108.288">     if (aItem) {</span>
<a href="#l108.289"></a><span id="l108.289">       let query = cal.item.isEvent(aItem) ? this.mSelectEvent : this.mSelectTodo;</span>
<a href="#l108.290"></a><span id="l108.290">       this.prepareStatement(query);</span>
<a href="#l108.291"></a><span id="l108.291">       query.params.id = aItem.id;</span>
<a href="#l108.292"></a><span id="l108.292">       try {</span>
<a href="#l108.293"></a><span id="l108.293">         await this.executeAsync(query, row =&gt; {</span>
<a href="#l108.294"></a><span id="l108.294">           flag = row.getResultByName(&quot;offline_journal&quot;) || null;</span>
<a href="#l108.295"></a><span id="l108.295" class="difflineat">@@ -862,50 +862,50 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.296"></a><span id="l108.296">         return;</span>
<a href="#l108.297"></a><span id="l108.297">       }</span>
<a href="#l108.298"></a><span id="l108.298">     }</span>
<a href="#l108.299"></a><span id="l108.299"> </span>
<a href="#l108.300"></a><span id="l108.300">     // It is possible that aItem can be null, flag provided should be null in this case</span>
<a href="#l108.301"></a><span id="l108.301">     aListener.onOperationComplete(this, Cr.NS_OK, Ci.calIOperationListener.GET, aItem, flag);</span>
<a href="#l108.302"></a><span id="l108.302">   },</span>
<a href="#l108.303"></a><span id="l108.303"> </span>
<a href="#l108.304"></a><span id="l108.304" class="difflineminus">-  setOfflineJournalFlag: async function(aItem, flag) {</span>
<a href="#l108.305"></a><span id="l108.305" class="difflineplus">+  async setOfflineJournalFlag(aItem, flag) {</span>
<a href="#l108.306"></a><span id="l108.306">     let aID = aItem.id;</span>
<a href="#l108.307"></a><span id="l108.307">     let query = cal.item.isEvent(aItem) ? this.mEditEventOfflineFlag : this.mEditTodoOfflineFlag;</span>
<a href="#l108.308"></a><span id="l108.308">     this.prepareStatement(query);</span>
<a href="#l108.309"></a><span id="l108.309">     query.params.id = aID;</span>
<a href="#l108.310"></a><span id="l108.310">     query.params.offline_journal = flag || null;</span>
<a href="#l108.311"></a><span id="l108.311">     try {</span>
<a href="#l108.312"></a><span id="l108.312">       await this.executeAsync(query);</span>
<a href="#l108.313"></a><span id="l108.313">     } catch (e) {</span>
<a href="#l108.314"></a><span id="l108.314">       this.logError(&quot;Error setting offline journal flag for &quot; + aItem.title, e);</span>
<a href="#l108.315"></a><span id="l108.315">     }</span>
<a href="#l108.316"></a><span id="l108.316">   },</span>
<a href="#l108.317"></a><span id="l108.317"> </span>
<a href="#l108.318"></a><span id="l108.318">   //</span>
<a href="#l108.319"></a><span id="l108.319">   // calIOfflineStorage interface</span>
<a href="#l108.320"></a><span id="l108.320">   //</span>
<a href="#l108.321"></a><span id="l108.321" class="difflineminus">-  addOfflineItem: async function(aItem, aListener) {</span>
<a href="#l108.322"></a><span id="l108.322" class="difflineplus">+  async addOfflineItem(aItem, aListener) {</span>
<a href="#l108.323"></a><span id="l108.323">     let newOfflineJournalFlag = cICL.OFFLINE_FLAG_CREATED_RECORD;</span>
<a href="#l108.324"></a><span id="l108.324">     await this.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l108.325"></a><span id="l108.325">     this.notifyOperationComplete(</span>
<a href="#l108.326"></a><span id="l108.326">       aListener,</span>
<a href="#l108.327"></a><span id="l108.327">       Cr.NS_OK,</span>
<a href="#l108.328"></a><span id="l108.328">       Ci.calIOperationListener.ADD,</span>
<a href="#l108.329"></a><span id="l108.329">       aItem.id,</span>
<a href="#l108.330"></a><span id="l108.330">       aItem</span>
<a href="#l108.331"></a><span id="l108.331">     );</span>
<a href="#l108.332"></a><span id="l108.332">   },</span>
<a href="#l108.333"></a><span id="l108.333"> </span>
<a href="#l108.334"></a><span id="l108.334" class="difflineminus">-  modifyOfflineItem: function(aItem, aListener) {</span>
<a href="#l108.335"></a><span id="l108.335" class="difflineplus">+  modifyOfflineItem(aItem, aListener) {</span>
<a href="#l108.336"></a><span id="l108.336">     let self = this;</span>
<a href="#l108.337"></a><span id="l108.337">     let opListener = {</span>
<a href="#l108.338"></a><span id="l108.338">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l108.339"></a><span id="l108.339" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l108.340"></a><span id="l108.340" class="difflineminus">-      onOperationComplete: async function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l108.341"></a><span id="l108.341" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l108.342"></a><span id="l108.342" class="difflineplus">+      async onOperationComplete(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l108.343"></a><span id="l108.343">         let newOfflineJournalFlag = cICL.OFFLINE_FLAG_MODIFIED_RECORD;</span>
<a href="#l108.344"></a><span id="l108.344">         if (</span>
<a href="#l108.345"></a><span id="l108.345">           oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD ||</span>
<a href="#l108.346"></a><span id="l108.346">           oldOfflineJournalFlag == cICL.OFFLINE_FLAG_DELETED_RECORD</span>
<a href="#l108.347"></a><span id="l108.347">         ) {</span>
<a href="#l108.348"></a><span id="l108.348">           // Do nothing since a flag of &quot;created&quot; or &quot;deleted&quot; exists</span>
<a href="#l108.349"></a><span id="l108.349">         } else {</span>
<a href="#l108.350"></a><span id="l108.350">           await self.setOfflineJournalFlag(aItem, newOfflineJournalFlag);</span>
<a href="#l108.351"></a><span id="l108.351" class="difflineat">@@ -917,22 +917,22 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.352"></a><span id="l108.352">           aItem.id,</span>
<a href="#l108.353"></a><span id="l108.353">           aItem</span>
<a href="#l108.354"></a><span id="l108.354">         );</span>
<a href="#l108.355"></a><span id="l108.355">       },</span>
<a href="#l108.356"></a><span id="l108.356">     };</span>
<a href="#l108.357"></a><span id="l108.357">     this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l108.358"></a><span id="l108.358">   },</span>
<a href="#l108.359"></a><span id="l108.359"> </span>
<a href="#l108.360"></a><span id="l108.360" class="difflineminus">-  deleteOfflineItem: function(aItem, aListener) {</span>
<a href="#l108.361"></a><span id="l108.361" class="difflineplus">+  deleteOfflineItem(aItem, aListener) {</span>
<a href="#l108.362"></a><span id="l108.362">     let self = this;</span>
<a href="#l108.363"></a><span id="l108.363">     let opListener = {</span>
<a href="#l108.364"></a><span id="l108.364">       QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l108.365"></a><span id="l108.365" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l108.366"></a><span id="l108.366" class="difflineminus">-      onOperationComplete: async function(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l108.367"></a><span id="l108.367" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l108.368"></a><span id="l108.368" class="difflineplus">+      async onOperationComplete(calendar, status, opType, id, oldOfflineJournalFlag) {</span>
<a href="#l108.369"></a><span id="l108.369">         if (oldOfflineJournalFlag) {</span>
<a href="#l108.370"></a><span id="l108.370">           // Delete item if flag is c</span>
<a href="#l108.371"></a><span id="l108.371">           if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_CREATED_RECORD) {</span>
<a href="#l108.372"></a><span id="l108.372">             await self.deleteItemById(aItem.id);</span>
<a href="#l108.373"></a><span id="l108.373">           } else if (oldOfflineJournalFlag == cICL.OFFLINE_FLAG_MODIFIED_RECORD) {</span>
<a href="#l108.374"></a><span id="l108.374">             await self.setOfflineJournalFlag(aItem, cICL.OFFLINE_FLAG_DELETED_RECORD);</span>
<a href="#l108.375"></a><span id="l108.375">           }</span>
<a href="#l108.376"></a><span id="l108.376">         } else {</span>
<a href="#l108.377"></a><span id="l108.377" class="difflineat">@@ -948,17 +948,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.378"></a><span id="l108.378">         );</span>
<a href="#l108.379"></a><span id="l108.379">         // notify observers</span>
<a href="#l108.380"></a><span id="l108.380">         self.observers.notify(&quot;onDeleteItem&quot;, [aItem]);</span>
<a href="#l108.381"></a><span id="l108.381">       },</span>
<a href="#l108.382"></a><span id="l108.382">     };</span>
<a href="#l108.383"></a><span id="l108.383">     this.getItemOfflineFlag(aItem, opListener);</span>
<a href="#l108.384"></a><span id="l108.384">   },</span>
<a href="#l108.385"></a><span id="l108.385"> </span>
<a href="#l108.386"></a><span id="l108.386" class="difflineminus">-  resetItemOfflineFlag: async function(aItem, aListener) {</span>
<a href="#l108.387"></a><span id="l108.387" class="difflineplus">+  async resetItemOfflineFlag(aItem, aListener) {</span>
<a href="#l108.388"></a><span id="l108.388">     await this.setOfflineJournalFlag(aItem, null);</span>
<a href="#l108.389"></a><span id="l108.389">     this.notifyOperationComplete(</span>
<a href="#l108.390"></a><span id="l108.390">       aListener,</span>
<a href="#l108.391"></a><span id="l108.391">       Cr.NS_OK,</span>
<a href="#l108.392"></a><span id="l108.392">       Ci.calIOperationListener.MODIFY,</span>
<a href="#l108.393"></a><span id="l108.393">       aItem.id,</span>
<a href="#l108.394"></a><span id="l108.394">       aItem</span>
<a href="#l108.395"></a><span id="l108.395">     );</span>
<a href="#l108.396"></a><span id="l108.396" class="difflineat">@@ -966,17 +966,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.397"></a><span id="l108.397"> </span>
<a href="#l108.398"></a><span id="l108.398">   //</span>
<a href="#l108.399"></a><span id="l108.399">   // database handling</span>
<a href="#l108.400"></a><span id="l108.400">   //</span>
<a href="#l108.401"></a><span id="l108.401"> </span>
<a href="#l108.402"></a><span id="l108.402">   // database initialization</span>
<a href="#l108.403"></a><span id="l108.403">   // assumes m0DB is valid</span>
<a href="#l108.404"></a><span id="l108.404"> </span>
<a href="#l108.405"></a><span id="l108.405" class="difflineminus">-  initDB: function() {</span>
<a href="#l108.406"></a><span id="l108.406" class="difflineplus">+  initDB() {</span>
<a href="#l108.407"></a><span id="l108.407">     cal.ASSERT(this.mDB, &quot;Database has not been opened!&quot;, true);</span>
<a href="#l108.408"></a><span id="l108.408"> </span>
<a href="#l108.409"></a><span id="l108.409">     try {</span>
<a href="#l108.410"></a><span id="l108.410">       this.mDB.executeSimpleSQL(&quot;PRAGMA journal_mode=WAL&quot;);</span>
<a href="#l108.411"></a><span id="l108.411"> </span>
<a href="#l108.412"></a><span id="l108.412">       this.mSelectEvent = this.mDB.createAsyncStatement(</span>
<a href="#l108.413"></a><span id="l108.413">         &quot;SELECT * FROM cal_events &quot; +</span>
<a href="#l108.414"></a><span id="l108.414">           &quot;WHERE id = :id AND cal_id = :cal_id &quot; +</span>
<a href="#l108.415"></a><span id="l108.415" class="difflineat">@@ -1395,17 +1395,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.416"></a><span id="l108.416">       this.mDeleteAllMetaData = this.mDB.createStatement(</span>
<a href="#l108.417"></a><span id="l108.417">         &quot;DELETE FROM cal_metadata WHERE cal_id = :cal_id&quot;</span>
<a href="#l108.418"></a><span id="l108.418">       );</span>
<a href="#l108.419"></a><span id="l108.419">     } catch (e) {</span>
<a href="#l108.420"></a><span id="l108.420">       this.logError(&quot;Error initializing statements.&quot;, e);</span>
<a href="#l108.421"></a><span id="l108.421">     }</span>
<a href="#l108.422"></a><span id="l108.422">   },</span>
<a href="#l108.423"></a><span id="l108.423"> </span>
<a href="#l108.424"></a><span id="l108.424" class="difflineminus">-  shutdownDB: function() {</span>
<a href="#l108.425"></a><span id="l108.425" class="difflineplus">+  shutdownDB() {</span>
<a href="#l108.426"></a><span id="l108.426">     try {</span>
<a href="#l108.427"></a><span id="l108.427">       if (this.mDeleteAlarms) {</span>
<a href="#l108.428"></a><span id="l108.428">         this.mDeleteAlarms.finalize();</span>
<a href="#l108.429"></a><span id="l108.429">       }</span>
<a href="#l108.430"></a><span id="l108.430">       if (this.mDeleteAllEvents) {</span>
<a href="#l108.431"></a><span id="l108.431">         this.mDeleteAllEvents.finalize();</span>
<a href="#l108.432"></a><span id="l108.432">       }</span>
<a href="#l108.433"></a><span id="l108.433">       if (this.mDeleteAllMetaData) {</span>
<a href="#l108.434"></a><span id="l108.434" class="difflineat">@@ -1579,17 +1579,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.435"></a><span id="l108.435">   },</span>
<a href="#l108.436"></a><span id="l108.436"> </span>
<a href="#l108.437"></a><span id="l108.437">   //</span>
<a href="#l108.438"></a><span id="l108.438">   // database reading functions</span>
<a href="#l108.439"></a><span id="l108.439">   //</span>
<a href="#l108.440"></a><span id="l108.440"> </span>
<a href="#l108.441"></a><span id="l108.441">   // read in the common ItemBase attributes from aDBRow, and stick</span>
<a href="#l108.442"></a><span id="l108.442">   // them on item</span>
<a href="#l108.443"></a><span id="l108.443" class="difflineminus">-  getItemBaseFromRow: function(row, item) {</span>
<a href="#l108.444"></a><span id="l108.444" class="difflineplus">+  getItemBaseFromRow(row, item) {</span>
<a href="#l108.445"></a><span id="l108.445">     item.calendar = this.superCalendar;</span>
<a href="#l108.446"></a><span id="l108.446">     item.id = row.getResultByName(&quot;id&quot;);</span>
<a href="#l108.447"></a><span id="l108.447">     if (row.getResultByName(&quot;title&quot;)) {</span>
<a href="#l108.448"></a><span id="l108.448">       item.title = row.getResultByName(&quot;title&quot;);</span>
<a href="#l108.449"></a><span id="l108.449">     }</span>
<a href="#l108.450"></a><span id="l108.450">     if (row.getResultByName(&quot;priority&quot;)) {</span>
<a href="#l108.451"></a><span id="l108.451">       item.priority = row.getResultByName(&quot;priority&quot;);</span>
<a href="#l108.452"></a><span id="l108.452">     }</span>
<a href="#l108.453"></a><span id="l108.453" class="difflineat">@@ -1621,36 +1621,36 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.454"></a><span id="l108.454"> </span>
<a href="#l108.455"></a><span id="l108.455">     // This must be done last because the setting of any other property</span>
<a href="#l108.456"></a><span id="l108.456">     // after this would overwrite it again.</span>
<a href="#l108.457"></a><span id="l108.457">     if (row.getResultByName(&quot;last_modified&quot;)) {</span>
<a href="#l108.458"></a><span id="l108.458">       item.setProperty(&quot;LAST-MODIFIED&quot;, newDateTime(row.getResultByName(&quot;last_modified&quot;), &quot;UTC&quot;));</span>
<a href="#l108.459"></a><span id="l108.459">     }</span>
<a href="#l108.460"></a><span id="l108.460">   },</span>
<a href="#l108.461"></a><span id="l108.461"> </span>
<a href="#l108.462"></a><span id="l108.462" class="difflineminus">-  cacheItem: function(item) {</span>
<a href="#l108.463"></a><span id="l108.463" class="difflineplus">+  cacheItem(item) {</span>
<a href="#l108.464"></a><span id="l108.464">     this.mItemCache.set(item.id, item);</span>
<a href="#l108.465"></a><span id="l108.465">     if (item.recurrenceInfo) {</span>
<a href="#l108.466"></a><span id="l108.466">       if (cal.item.isEvent(item)) {</span>
<a href="#l108.467"></a><span id="l108.467">         this.mRecEventCache.set(item.id, item);</span>
<a href="#l108.468"></a><span id="l108.468">       } else {</span>
<a href="#l108.469"></a><span id="l108.469">         this.mRecTodoCache.set(item.id, item);</span>
<a href="#l108.470"></a><span id="l108.470">       }</span>
<a href="#l108.471"></a><span id="l108.471">     }</span>
<a href="#l108.472"></a><span id="l108.472">   },</span>
<a href="#l108.473"></a><span id="l108.473"> </span>
<a href="#l108.474"></a><span id="l108.474">   mRecEventCacheOfflineFlags: new Map(),</span>
<a href="#l108.475"></a><span id="l108.475">   mRecTodoCacheOfflineFlags: new Map(),</span>
<a href="#l108.476"></a><span id="l108.476" class="difflineminus">-  assureRecurringItemCaches: function() {</span>
<a href="#l108.477"></a><span id="l108.477" class="difflineplus">+  assureRecurringItemCaches() {</span>
<a href="#l108.478"></a><span id="l108.478">     if (!this.mRecItemCachePromise) {</span>
<a href="#l108.479"></a><span id="l108.479">       this.mRecItemCachePromise = this._assureRecurringItemCaches();</span>
<a href="#l108.480"></a><span id="l108.480">     }</span>
<a href="#l108.481"></a><span id="l108.481">     return this.mRecItemCachePromise;</span>
<a href="#l108.482"></a><span id="l108.482">   },</span>
<a href="#l108.483"></a><span id="l108.483" class="difflineminus">-  _assureRecurringItemCaches: async function() {</span>
<a href="#l108.484"></a><span id="l108.484" class="difflineplus">+  async _assureRecurringItemCaches() {</span>
<a href="#l108.485"></a><span id="l108.485">     // build up recurring event and todo cache with its offline flags,</span>
<a href="#l108.486"></a><span id="l108.486">     // because we need that on every query: for recurring items, we need to</span>
<a href="#l108.487"></a><span id="l108.487">     // query database-wide.. yuck</span>
<a href="#l108.488"></a><span id="l108.488">     this.mRecEventCache.clear();</span>
<a href="#l108.489"></a><span id="l108.489">     this.mRecEventCacheOfflineFlags.clear();</span>
<a href="#l108.490"></a><span id="l108.490">     this.mRecTodoCache.clear();</span>
<a href="#l108.491"></a><span id="l108.491">     this.mRecTodoCacheOfflineFlags.clear();</span>
<a href="#l108.492"></a><span id="l108.492"> </span>
<a href="#l108.493"></a><span id="l108.493" class="difflineat">@@ -1797,17 +1797,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.494"></a><span id="l108.494">     });</span>
<a href="#l108.495"></a><span id="l108.495"> </span>
<a href="#l108.496"></a><span id="l108.496">     for (let item of itemsMap.values()) {</span>
<a href="#l108.497"></a><span id="l108.497">       item.makeImmutable();</span>
<a href="#l108.498"></a><span id="l108.498">       this.mItemCache.set(item.id, item);</span>
<a href="#l108.499"></a><span id="l108.499">     }</span>
<a href="#l108.500"></a><span id="l108.500">   },</span>
<a href="#l108.501"></a><span id="l108.501"> </span>
<a href="#l108.502"></a><span id="l108.502" class="difflineminus">-  getEventFromRow: async function(row, getAdditionalData = true) {</span>
<a href="#l108.503"></a><span id="l108.503" class="difflineplus">+  async getEventFromRow(row, getAdditionalData = true) {</span>
<a href="#l108.504"></a><span id="l108.504">     let item = this.mItemCache.get(row.getResultByName(&quot;id&quot;));</span>
<a href="#l108.505"></a><span id="l108.505">     if (item) {</span>
<a href="#l108.506"></a><span id="l108.506">       return item;</span>
<a href="#l108.507"></a><span id="l108.507">     }</span>
<a href="#l108.508"></a><span id="l108.508"> </span>
<a href="#l108.509"></a><span id="l108.509">     item = cal.createEvent();</span>
<a href="#l108.510"></a><span id="l108.510">     let flags = row.getResultByName(&quot;flags&quot;);</span>
<a href="#l108.511"></a><span id="l108.511"> </span>
<a href="#l108.512"></a><span id="l108.512" class="difflineat">@@ -1836,17 +1836,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.513"></a><span id="l108.513">     if (getAdditionalData) {</span>
<a href="#l108.514"></a><span id="l108.514">       await this.getAdditionalDataForItem(item, flags);</span>
<a href="#l108.515"></a><span id="l108.515">       item.makeImmutable();</span>
<a href="#l108.516"></a><span id="l108.516">       this.cacheItem(item);</span>
<a href="#l108.517"></a><span id="l108.517">     }</span>
<a href="#l108.518"></a><span id="l108.518">     return item;</span>
<a href="#l108.519"></a><span id="l108.519">   },</span>
<a href="#l108.520"></a><span id="l108.520"> </span>
<a href="#l108.521"></a><span id="l108.521" class="difflineminus">-  getTodoFromRow: async function(row, getAdditionalData = true) {</span>
<a href="#l108.522"></a><span id="l108.522" class="difflineplus">+  async getTodoFromRow(row, getAdditionalData = true) {</span>
<a href="#l108.523"></a><span id="l108.523">     let item = this.mItemCache.get(row.getResultByName(&quot;id&quot;));</span>
<a href="#l108.524"></a><span id="l108.524">     if (item) {</span>
<a href="#l108.525"></a><span id="l108.525">       return item;</span>
<a href="#l108.526"></a><span id="l108.526">     }</span>
<a href="#l108.527"></a><span id="l108.527"> </span>
<a href="#l108.528"></a><span id="l108.528">     item = cal.createTodo();</span>
<a href="#l108.529"></a><span id="l108.529"> </span>
<a href="#l108.530"></a><span id="l108.530">     if (row.getResultByName(&quot;todo_entry&quot;)) {</span>
<a href="#l108.531"></a><span id="l108.531" class="difflineat">@@ -1885,17 +1885,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.532"></a><span id="l108.532">   },</span>
<a href="#l108.533"></a><span id="l108.533"> </span>
<a href="#l108.534"></a><span id="l108.534">   // after we get the base item, we need to check if we need to pull in</span>
<a href="#l108.535"></a><span id="l108.535">   // any extra data from other tables.  We do that here.</span>
<a href="#l108.536"></a><span id="l108.536"> </span>
<a href="#l108.537"></a><span id="l108.537">   // We used to use mDBTwo for this, so this can be run while a</span>
<a href="#l108.538"></a><span id="l108.538">   // select is executing but this no longer seems to be required.</span>
<a href="#l108.539"></a><span id="l108.539"> </span>
<a href="#l108.540"></a><span id="l108.540" class="difflineminus">-  getAdditionalDataForItem: async function(item, flags) {</span>
<a href="#l108.541"></a><span id="l108.541" class="difflineplus">+  async getAdditionalDataForItem(item, flags) {</span>
<a href="#l108.542"></a><span id="l108.542">     // This is needed to keep the modification time intact.</span>
<a href="#l108.543"></a><span id="l108.543">     let savedLastModifiedTime = item.lastModifiedTime;</span>
<a href="#l108.544"></a><span id="l108.544"> </span>
<a href="#l108.545"></a><span id="l108.545">     if (flags &amp; CAL_ITEM_FLAG.HAS_ATTENDEES) {</span>
<a href="#l108.546"></a><span id="l108.546">       let selectItem = null;</span>
<a href="#l108.547"></a><span id="l108.547">       if (item.recurrenceId == null) {</span>
<a href="#l108.548"></a><span id="l108.548">         selectItem = this.mSelectAttendeesForItem;</span>
<a href="#l108.549"></a><span id="l108.549">       } else {</span>
<a href="#l108.550"></a><span id="l108.550" class="difflineat">@@ -2085,17 +2085,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.551"></a><span id="l108.551">         this.logError(&quot;Error getting alarms for item '&quot; + item.title + &quot;' (&quot; + item.id + &quot;)!&quot;, e);</span>
<a href="#l108.552"></a><span id="l108.552">       }</span>
<a href="#l108.553"></a><span id="l108.553">     }</span>
<a href="#l108.554"></a><span id="l108.554"> </span>
<a href="#l108.555"></a><span id="l108.555">     // Restore the saved modification time</span>
<a href="#l108.556"></a><span id="l108.556">     item.setProperty(&quot;LAST-MODIFIED&quot;, savedLastModifiedTime);</span>
<a href="#l108.557"></a><span id="l108.557">   },</span>
<a href="#l108.558"></a><span id="l108.558"> </span>
<a href="#l108.559"></a><span id="l108.559" class="difflineminus">-  getRecurrenceItemFromRow: function(row, item) {</span>
<a href="#l108.560"></a><span id="l108.560" class="difflineplus">+  getRecurrenceItemFromRow(row, item) {</span>
<a href="#l108.561"></a><span id="l108.561">     let ritem;</span>
<a href="#l108.562"></a><span id="l108.562">     let prop = cal.getIcsService().createIcalPropertyFromString(row.getResultByName(&quot;icalString&quot;));</span>
<a href="#l108.563"></a><span id="l108.563">     switch (prop.propertyName) {</span>
<a href="#l108.564"></a><span id="l108.564">       case &quot;RDATE&quot;:</span>
<a href="#l108.565"></a><span id="l108.565">       case &quot;EXDATE&quot;:</span>
<a href="#l108.566"></a><span id="l108.566">         ritem = Cc[&quot;@mozilla.org/calendar/recurrence-date;1&quot;].createInstance(Ci.calIRecurrenceDate);</span>
<a href="#l108.567"></a><span id="l108.567">         break;</span>
<a href="#l108.568"></a><span id="l108.568">       case &quot;RRULE&quot;:</span>
<a href="#l108.569"></a><span id="l108.569" class="difflineat">@@ -2108,17 +2108,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.570"></a><span id="l108.570"> </span>
<a href="#l108.571"></a><span id="l108.571">     ritem.icalProperty = prop;</span>
<a href="#l108.572"></a><span id="l108.572">     return ritem;</span>
<a href="#l108.573"></a><span id="l108.573">   },</span>
<a href="#l108.574"></a><span id="l108.574"> </span>
<a href="#l108.575"></a><span id="l108.575">   //</span>
<a href="#l108.576"></a><span id="l108.576">   // get item from db or from cache with given iid</span>
<a href="#l108.577"></a><span id="l108.577">   //</span>
<a href="#l108.578"></a><span id="l108.578" class="difflineminus">-  getItemById: async function(aID) {</span>
<a href="#l108.579"></a><span id="l108.579" class="difflineplus">+  async getItemById(aID) {</span>
<a href="#l108.580"></a><span id="l108.580">     await this.assureRecurringItemCaches();</span>
<a href="#l108.581"></a><span id="l108.581"> </span>
<a href="#l108.582"></a><span id="l108.582">     // cached?</span>
<a href="#l108.583"></a><span id="l108.583">     let item = this.mItemCache.get(aID);</span>
<a href="#l108.584"></a><span id="l108.584">     if (item) {</span>
<a href="#l108.585"></a><span id="l108.585">       return item;</span>
<a href="#l108.586"></a><span id="l108.586">     }</span>
<a href="#l108.587"></a><span id="l108.587"> </span>
<a href="#l108.588"></a><span id="l108.588" class="difflineat">@@ -2148,17 +2148,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.589"></a><span id="l108.589"> </span>
<a href="#l108.590"></a><span id="l108.590">     return item;</span>
<a href="#l108.591"></a><span id="l108.591">   },</span>
<a href="#l108.592"></a><span id="l108.592"> </span>
<a href="#l108.593"></a><span id="l108.593">   //</span>
<a href="#l108.594"></a><span id="l108.594">   // database writing functions</span>
<a href="#l108.595"></a><span id="l108.595">   //</span>
<a href="#l108.596"></a><span id="l108.596"> </span>
<a href="#l108.597"></a><span id="l108.597" class="difflineminus">-  setDateParamHelper: function(params, entryname, cdt) {</span>
<a href="#l108.598"></a><span id="l108.598" class="difflineplus">+  setDateParamHelper(params, entryname, cdt) {</span>
<a href="#l108.599"></a><span id="l108.599">     if (cdt) {</span>
<a href="#l108.600"></a><span id="l108.600">       params.bindByName(entryname, cdt.nativeTime);</span>
<a href="#l108.601"></a><span id="l108.601">       let timezone = cdt.timezone;</span>
<a href="#l108.602"></a><span id="l108.602">       let ownTz = cal.getTimezoneService().getTimezone(timezone.tzid);</span>
<a href="#l108.603"></a><span id="l108.603">       if (ownTz) {</span>
<a href="#l108.604"></a><span id="l108.604">         // if we know that TZID, we use it</span>
<a href="#l108.605"></a><span id="l108.605">         params.bindByName(entryname + &quot;_tz&quot;, ownTz.tzid);</span>
<a href="#l108.606"></a><span id="l108.606">       } else if (timezone.icalComponent) {</span>
<a href="#l108.607"></a><span id="l108.607" class="difflineat">@@ -2169,17 +2169,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.608"></a><span id="l108.608">         params.bindByName(entryname + &quot;_tz&quot;, &quot;floating&quot;);</span>
<a href="#l108.609"></a><span id="l108.609">       }</span>
<a href="#l108.610"></a><span id="l108.610">     } else {</span>
<a href="#l108.611"></a><span id="l108.611">       params.bindByName(entryname, null);</span>
<a href="#l108.612"></a><span id="l108.612">       params.bindByName(entryname + &quot;_tz&quot;, null);</span>
<a href="#l108.613"></a><span id="l108.613">     }</span>
<a href="#l108.614"></a><span id="l108.614">   },</span>
<a href="#l108.615"></a><span id="l108.615"> </span>
<a href="#l108.616"></a><span id="l108.616" class="difflineminus">-  flushItem: async function(item, olditem) {</span>
<a href="#l108.617"></a><span id="l108.617" class="difflineplus">+  async flushItem(item, olditem) {</span>
<a href="#l108.618"></a><span id="l108.618">     cal.ASSERT(!item.recurrenceId, &quot;no parent item passed!&quot;, true);</span>
<a href="#l108.619"></a><span id="l108.619"> </span>
<a href="#l108.620"></a><span id="l108.620">     await this.deleteItemById(olditem ? olditem.id : item.id, true);</span>
<a href="#l108.621"></a><span id="l108.621">     // Map {mozIStorageStatement -&gt; mozIStorageBindingParamsArray}</span>
<a href="#l108.622"></a><span id="l108.622">     let stmts = new Map();</span>
<a href="#l108.623"></a><span id="l108.623">     this.prepareItem(stmts, item, olditem);</span>
<a href="#l108.624"></a><span id="l108.624">     for (let [stmt, array] of stmts) {</span>
<a href="#l108.625"></a><span id="l108.625">       stmt.bindParameters(array);</span>
<a href="#l108.626"></a><span id="l108.626" class="difflineat">@@ -2191,17 +2191,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.627"></a><span id="l108.627"> </span>
<a href="#l108.628"></a><span id="l108.628">   //</span>
<a href="#l108.629"></a><span id="l108.629">   // The prepare* functions prepare the database bits</span>
<a href="#l108.630"></a><span id="l108.630">   // to write the given item type.  They're to return</span>
<a href="#l108.631"></a><span id="l108.631">   // any bits they want or'd into flags, which will be</span>
<a href="#l108.632"></a><span id="l108.632">   // prepared for writing by prepareEvent/prepareTodo.</span>
<a href="#l108.633"></a><span id="l108.633">   //</span>
<a href="#l108.634"></a><span id="l108.634"> </span>
<a href="#l108.635"></a><span id="l108.635" class="difflineminus">-  prepareItem: function(stmts, item, olditem) {</span>
<a href="#l108.636"></a><span id="l108.636" class="difflineplus">+  prepareItem(stmts, item, olditem) {</span>
<a href="#l108.637"></a><span id="l108.637">     let flags = 0;</span>
<a href="#l108.638"></a><span id="l108.638"> </span>
<a href="#l108.639"></a><span id="l108.639">     flags |= this.prepareAttendees(stmts, item, olditem);</span>
<a href="#l108.640"></a><span id="l108.640">     flags |= this.prepareRecurrence(stmts, item, olditem);</span>
<a href="#l108.641"></a><span id="l108.641">     flags |= this.prepareProperties(stmts, item, olditem);</span>
<a href="#l108.642"></a><span id="l108.642">     flags |= this.prepareAttachments(stmts, item, olditem);</span>
<a href="#l108.643"></a><span id="l108.643">     flags |= this.prepareRelations(stmts, item, olditem);</span>
<a href="#l108.644"></a><span id="l108.644">     flags |= this.prepareAlarms(stmts, item, olditem);</span>
<a href="#l108.645"></a><span id="l108.645" class="difflineat">@@ -2210,17 +2210,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.646"></a><span id="l108.646">       this.prepareEvent(stmts, item, olditem, flags);</span>
<a href="#l108.647"></a><span id="l108.647">     } else if (cal.item.isToDo(item)) {</span>
<a href="#l108.648"></a><span id="l108.648">       this.prepareTodo(stmts, item, olditem, flags);</span>
<a href="#l108.649"></a><span id="l108.649">     } else {</span>
<a href="#l108.650"></a><span id="l108.650">       throw Cr.NS_ERROR_UNEXPECTED;</span>
<a href="#l108.651"></a><span id="l108.651">     }</span>
<a href="#l108.652"></a><span id="l108.652">   },</span>
<a href="#l108.653"></a><span id="l108.653"> </span>
<a href="#l108.654"></a><span id="l108.654" class="difflineminus">-  prepareEvent: function(stmts, item, olditem, flags) {</span>
<a href="#l108.655"></a><span id="l108.655" class="difflineplus">+  prepareEvent(stmts, item, olditem, flags) {</span>
<a href="#l108.656"></a><span id="l108.656">     let array = this.prepareAsyncStatement(stmts, this.mInsertEvent);</span>
<a href="#l108.657"></a><span id="l108.657">     let params = this.prepareAsyncParams(array);</span>
<a href="#l108.658"></a><span id="l108.658"> </span>
<a href="#l108.659"></a><span id="l108.659">     this.setupItemBaseParams(item, olditem, params);</span>
<a href="#l108.660"></a><span id="l108.660"> </span>
<a href="#l108.661"></a><span id="l108.661">     this.setDateParamHelper(params, &quot;event_start&quot;, item.startDate);</span>
<a href="#l108.662"></a><span id="l108.662">     this.setDateParamHelper(params, &quot;event_end&quot;, item.endDate);</span>
<a href="#l108.663"></a><span id="l108.663">     let dtstamp = item.stampTime;</span>
<a href="#l108.664"></a><span id="l108.664" class="difflineat">@@ -2230,17 +2230,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.665"></a><span id="l108.665">       flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l108.666"></a><span id="l108.666">     }</span>
<a href="#l108.667"></a><span id="l108.667"> </span>
<a href="#l108.668"></a><span id="l108.668">     params.bindByName(&quot;flags&quot;, flags);</span>
<a href="#l108.669"></a><span id="l108.669"> </span>
<a href="#l108.670"></a><span id="l108.670">     array.addParams(params);</span>
<a href="#l108.671"></a><span id="l108.671">   },</span>
<a href="#l108.672"></a><span id="l108.672"> </span>
<a href="#l108.673"></a><span id="l108.673" class="difflineminus">-  prepareTodo: function(stmts, item, olditem, flags) {</span>
<a href="#l108.674"></a><span id="l108.674" class="difflineplus">+  prepareTodo(stmts, item, olditem, flags) {</span>
<a href="#l108.675"></a><span id="l108.675">     let array = this.prepareAsyncStatement(stmts, this.mInsertTodo);</span>
<a href="#l108.676"></a><span id="l108.676">     let params = this.prepareAsyncParams(array);</span>
<a href="#l108.677"></a><span id="l108.677"> </span>
<a href="#l108.678"></a><span id="l108.678">     this.setupItemBaseParams(item, olditem, params);</span>
<a href="#l108.679"></a><span id="l108.679"> </span>
<a href="#l108.680"></a><span id="l108.680">     this.setDateParamHelper(params, &quot;todo_entry&quot;, item.entryDate);</span>
<a href="#l108.681"></a><span id="l108.681">     this.setDateParamHelper(params, &quot;todo_due&quot;, item.dueDate);</span>
<a href="#l108.682"></a><span id="l108.682">     let dtstamp = item.stampTime;</span>
<a href="#l108.683"></a><span id="l108.683" class="difflineat">@@ -2254,17 +2254,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.684"></a><span id="l108.684">       flags |= CAL_ITEM_FLAG.EVENT_ALLDAY;</span>
<a href="#l108.685"></a><span id="l108.685">     }</span>
<a href="#l108.686"></a><span id="l108.686"> </span>
<a href="#l108.687"></a><span id="l108.687">     params.bindByName(&quot;flags&quot;, flags);</span>
<a href="#l108.688"></a><span id="l108.688"> </span>
<a href="#l108.689"></a><span id="l108.689">     array.addParams(params);</span>
<a href="#l108.690"></a><span id="l108.690">   },</span>
<a href="#l108.691"></a><span id="l108.691"> </span>
<a href="#l108.692"></a><span id="l108.692" class="difflineminus">-  setupItemBaseParams: function(item, olditem, params) {</span>
<a href="#l108.693"></a><span id="l108.693" class="difflineplus">+  setupItemBaseParams(item, olditem, params) {</span>
<a href="#l108.694"></a><span id="l108.694">     params.bindByName(&quot;id&quot;, item.id);</span>
<a href="#l108.695"></a><span id="l108.695"> </span>
<a href="#l108.696"></a><span id="l108.696">     this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l108.697"></a><span id="l108.697"> </span>
<a href="#l108.698"></a><span id="l108.698">     let tmp = item.getProperty(&quot;CREATED&quot;);</span>
<a href="#l108.699"></a><span id="l108.699">     params.bindByName(&quot;time_created&quot;, tmp &amp;&amp; tmp.nativeTime);</span>
<a href="#l108.700"></a><span id="l108.700"> </span>
<a href="#l108.701"></a><span id="l108.701">     tmp = item.getProperty(&quot;LAST-MODIFIED&quot;);</span>
<a href="#l108.702"></a><span id="l108.702" class="difflineat">@@ -2273,17 +2273,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.703"></a><span id="l108.703">     params.bindByName(&quot;title&quot;, item.getProperty(&quot;SUMMARY&quot;));</span>
<a href="#l108.704"></a><span id="l108.704">     params.bindByName(&quot;priority&quot;, item.getProperty(&quot;PRIORITY&quot;));</span>
<a href="#l108.705"></a><span id="l108.705">     params.bindByName(&quot;privacy&quot;, item.getProperty(&quot;CLASS&quot;));</span>
<a href="#l108.706"></a><span id="l108.706">     params.bindByName(&quot;ical_status&quot;, item.getProperty(&quot;STATUS&quot;));</span>
<a href="#l108.707"></a><span id="l108.707"> </span>
<a href="#l108.708"></a><span id="l108.708">     params.bindByName(&quot;alarm_last_ack&quot;, item.alarmLastAck &amp;&amp; item.alarmLastAck.nativeTime);</span>
<a href="#l108.709"></a><span id="l108.709">   },</span>
<a href="#l108.710"></a><span id="l108.710"> </span>
<a href="#l108.711"></a><span id="l108.711" class="difflineminus">-  prepareAttendees: function(stmts, item, olditem) {</span>
<a href="#l108.712"></a><span id="l108.712" class="difflineplus">+  prepareAttendees(stmts, item, olditem) {</span>
<a href="#l108.713"></a><span id="l108.713">     let attendees = item.getAttendees();</span>
<a href="#l108.714"></a><span id="l108.714">     if (item.organizer) {</span>
<a href="#l108.715"></a><span id="l108.715">       attendees = attendees.concat([]);</span>
<a href="#l108.716"></a><span id="l108.716">       attendees.push(item.organizer);</span>
<a href="#l108.717"></a><span id="l108.717">     }</span>
<a href="#l108.718"></a><span id="l108.718">     if (attendees.length &gt; 0) {</span>
<a href="#l108.719"></a><span id="l108.719">       let array = this.prepareAsyncStatement(stmts, this.mInsertAttendee);</span>
<a href="#l108.720"></a><span id="l108.720">       for (let att of attendees) {</span>
<a href="#l108.721"></a><span id="l108.721" class="difflineat">@@ -2295,17 +2295,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.722"></a><span id="l108.722">       }</span>
<a href="#l108.723"></a><span id="l108.723"> </span>
<a href="#l108.724"></a><span id="l108.724">       return CAL_ITEM_FLAG.HAS_ATTENDEES;</span>
<a href="#l108.725"></a><span id="l108.725">     }</span>
<a href="#l108.726"></a><span id="l108.726"> </span>
<a href="#l108.727"></a><span id="l108.727">     return 0;</span>
<a href="#l108.728"></a><span id="l108.728">   },</span>
<a href="#l108.729"></a><span id="l108.729"> </span>
<a href="#l108.730"></a><span id="l108.730" class="difflineminus">-  prepareProperty: function(stmts, item, propName, propValue) {</span>
<a href="#l108.731"></a><span id="l108.731" class="difflineplus">+  prepareProperty(stmts, item, propName, propValue) {</span>
<a href="#l108.732"></a><span id="l108.732">     let array = this.prepareAsyncStatement(stmts, this.mInsertProperty);</span>
<a href="#l108.733"></a><span id="l108.733">     let params = this.prepareAsyncParams(array);</span>
<a href="#l108.734"></a><span id="l108.734">     params.bindByName(&quot;key&quot;, propName);</span>
<a href="#l108.735"></a><span id="l108.735">     let wPropValue = cal.wrapInstance(propValue, Ci.calIDateTime);</span>
<a href="#l108.736"></a><span id="l108.736">     if (wPropValue) {</span>
<a href="#l108.737"></a><span id="l108.737">       params.bindByName(&quot;value&quot;, wPropValue.nativeTime);</span>
<a href="#l108.738"></a><span id="l108.738">     } else {</span>
<a href="#l108.739"></a><span id="l108.739">       try {</span>
<a href="#l108.740"></a><span id="l108.740" class="difflineat">@@ -2320,17 +2320,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.741"></a><span id="l108.741">         params.bindByName(&quot;value&quot;, null);</span>
<a href="#l108.742"></a><span id="l108.742">       }</span>
<a href="#l108.743"></a><span id="l108.743">     }</span>
<a href="#l108.744"></a><span id="l108.744">     params.bindByName(&quot;item_id&quot;, item.id);</span>
<a href="#l108.745"></a><span id="l108.745">     this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l108.746"></a><span id="l108.746">     array.addParams(params);</span>
<a href="#l108.747"></a><span id="l108.747">   },</span>
<a href="#l108.748"></a><span id="l108.748"> </span>
<a href="#l108.749"></a><span id="l108.749" class="difflineminus">-  prepareProperties: function(stmts, item, olditem) {</span>
<a href="#l108.750"></a><span id="l108.750" class="difflineplus">+  prepareProperties(stmts, item, olditem) {</span>
<a href="#l108.751"></a><span id="l108.751">     let ret = 0;</span>
<a href="#l108.752"></a><span id="l108.752">     for (let [name, value] of item.properties) {</span>
<a href="#l108.753"></a><span id="l108.753">       ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l108.754"></a><span id="l108.754">       if (item.isPropertyPromoted(name)) {</span>
<a href="#l108.755"></a><span id="l108.755">         continue;</span>
<a href="#l108.756"></a><span id="l108.756">       }</span>
<a href="#l108.757"></a><span id="l108.757">       this.prepareProperty(stmts, item, name, value);</span>
<a href="#l108.758"></a><span id="l108.758">     }</span>
<a href="#l108.759"></a><span id="l108.759" class="difflineat">@@ -2339,17 +2339,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.760"></a><span id="l108.760">     if (cats.length &gt; 0) {</span>
<a href="#l108.761"></a><span id="l108.761">       ret = CAL_ITEM_FLAG.HAS_PROPERTIES;</span>
<a href="#l108.762"></a><span id="l108.762">       this.prepareProperty(stmts, item, &quot;CATEGORIES&quot;, cal.category.arrayToString(cats));</span>
<a href="#l108.763"></a><span id="l108.763">     }</span>
<a href="#l108.764"></a><span id="l108.764"> </span>
<a href="#l108.765"></a><span id="l108.765">     return ret;</span>
<a href="#l108.766"></a><span id="l108.766">   },</span>
<a href="#l108.767"></a><span id="l108.767"> </span>
<a href="#l108.768"></a><span id="l108.768" class="difflineminus">-  prepareRecurrence: function(stmts, item, olditem) {</span>
<a href="#l108.769"></a><span id="l108.769" class="difflineplus">+  prepareRecurrence(stmts, item, olditem) {</span>
<a href="#l108.770"></a><span id="l108.770">     let flags = 0;</span>
<a href="#l108.771"></a><span id="l108.771"> </span>
<a href="#l108.772"></a><span id="l108.772">     let rec = item.recurrenceInfo;</span>
<a href="#l108.773"></a><span id="l108.773">     if (rec) {</span>
<a href="#l108.774"></a><span id="l108.774">       flags = CAL_ITEM_FLAG.HAS_RECURRENCE;</span>
<a href="#l108.775"></a><span id="l108.775">       let ritems = rec.getRecurrenceItems();</span>
<a href="#l108.776"></a><span id="l108.776">       let array = this.prepareAsyncStatement(stmts, this.mInsertRecurrence);</span>
<a href="#l108.777"></a><span id="l108.777">       for (let ritem of ritems) {</span>
<a href="#l108.778"></a><span id="l108.778" class="difflineat">@@ -2376,51 +2376,51 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.779"></a><span id="l108.779">       }</span>
<a href="#l108.780"></a><span id="l108.780">     } else if (item.recurrenceId &amp;&amp; item.recurrenceId.isDate) {</span>
<a href="#l108.781"></a><span id="l108.781">       flags |= CAL_ITEM_FLAG.RECURRENCE_ID_ALLDAY;</span>
<a href="#l108.782"></a><span id="l108.782">     }</span>
<a href="#l108.783"></a><span id="l108.783"> </span>
<a href="#l108.784"></a><span id="l108.784">     return flags;</span>
<a href="#l108.785"></a><span id="l108.785">   },</span>
<a href="#l108.786"></a><span id="l108.786"> </span>
<a href="#l108.787"></a><span id="l108.787" class="difflineminus">-  prepareAttachments: function(stmts, item, olditem) {</span>
<a href="#l108.788"></a><span id="l108.788" class="difflineplus">+  prepareAttachments(stmts, item, olditem) {</span>
<a href="#l108.789"></a><span id="l108.789">     let attachments = item.getAttachments();</span>
<a href="#l108.790"></a><span id="l108.790">     if (attachments &amp;&amp; attachments.length &gt; 0) {</span>
<a href="#l108.791"></a><span id="l108.791">       let array = this.prepareAsyncStatement(stmts, this.mInsertAttachment);</span>
<a href="#l108.792"></a><span id="l108.792">       for (let att of attachments) {</span>
<a href="#l108.793"></a><span id="l108.793">         let params = this.prepareAsyncParams(array);</span>
<a href="#l108.794"></a><span id="l108.794">         this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l108.795"></a><span id="l108.795">         params.bindByName(&quot;item_id&quot;, item.id);</span>
<a href="#l108.796"></a><span id="l108.796">         params.bindByName(&quot;icalString&quot;, att.icalString);</span>
<a href="#l108.797"></a><span id="l108.797"> </span>
<a href="#l108.798"></a><span id="l108.798">         array.addParams(params);</span>
<a href="#l108.799"></a><span id="l108.799">       }</span>
<a href="#l108.800"></a><span id="l108.800">       return CAL_ITEM_FLAG.HAS_ATTACHMENTS;</span>
<a href="#l108.801"></a><span id="l108.801">     }</span>
<a href="#l108.802"></a><span id="l108.802">     return 0;</span>
<a href="#l108.803"></a><span id="l108.803">   },</span>
<a href="#l108.804"></a><span id="l108.804"> </span>
<a href="#l108.805"></a><span id="l108.805" class="difflineminus">-  prepareRelations: function(stmts, item, olditem) {</span>
<a href="#l108.806"></a><span id="l108.806" class="difflineplus">+  prepareRelations(stmts, item, olditem) {</span>
<a href="#l108.807"></a><span id="l108.807">     let relations = item.getRelations();</span>
<a href="#l108.808"></a><span id="l108.808">     if (relations &amp;&amp; relations.length &gt; 0) {</span>
<a href="#l108.809"></a><span id="l108.809">       let array = this.prepareAsyncStatement(stmts, this.mInsertRelation);</span>
<a href="#l108.810"></a><span id="l108.810">       for (let rel of relations) {</span>
<a href="#l108.811"></a><span id="l108.811">         let params = this.prepareAsyncParams(array);</span>
<a href="#l108.812"></a><span id="l108.812">         this.setDateParamHelper(params, &quot;recurrence_id&quot;, item.recurrenceId);</span>
<a href="#l108.813"></a><span id="l108.813">         params.bindByName(&quot;item_id&quot;, item.id);</span>
<a href="#l108.814"></a><span id="l108.814">         params.bindByName(&quot;icalString&quot;, rel.icalString);</span>
<a href="#l108.815"></a><span id="l108.815"> </span>
<a href="#l108.816"></a><span id="l108.816">         array.addParams(params);</span>
<a href="#l108.817"></a><span id="l108.817">       }</span>
<a href="#l108.818"></a><span id="l108.818">       return CAL_ITEM_FLAG.HAS_RELATIONS;</span>
<a href="#l108.819"></a><span id="l108.819">     }</span>
<a href="#l108.820"></a><span id="l108.820">     return 0;</span>
<a href="#l108.821"></a><span id="l108.821">   },</span>
<a href="#l108.822"></a><span id="l108.822"> </span>
<a href="#l108.823"></a><span id="l108.823" class="difflineminus">-  prepareAlarms: function(stmts, item, olditem) {</span>
<a href="#l108.824"></a><span id="l108.824" class="difflineplus">+  prepareAlarms(stmts, item, olditem) {</span>
<a href="#l108.825"></a><span id="l108.825">     let alarms = item.getAlarms();</span>
<a href="#l108.826"></a><span id="l108.826">     if (alarms.length &lt; 1) {</span>
<a href="#l108.827"></a><span id="l108.827">       return 0;</span>
<a href="#l108.828"></a><span id="l108.828">     }</span>
<a href="#l108.829"></a><span id="l108.829"> </span>
<a href="#l108.830"></a><span id="l108.830">     let array = this.prepareAsyncStatement(stmts, this.mInsertAlarm);</span>
<a href="#l108.831"></a><span id="l108.831">     for (let alarm of alarms) {</span>
<a href="#l108.832"></a><span id="l108.832">       let params = this.prepareAsyncParams(array);</span>
<a href="#l108.833"></a><span id="l108.833" class="difflineat">@@ -2435,17 +2435,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.834"></a><span id="l108.834">   },</span>
<a href="#l108.835"></a><span id="l108.835"> </span>
<a href="#l108.836"></a><span id="l108.836">   /**</span>
<a href="#l108.837"></a><span id="l108.837">    * Deletes the item with the given item id.</span>
<a href="#l108.838"></a><span id="l108.838">    *</span>
<a href="#l108.839"></a><span id="l108.839">    * @param aID           The id of the item to delete.</span>
<a href="#l108.840"></a><span id="l108.840">    * @param aIsModify     If true, then leave in metadata for the item</span>
<a href="#l108.841"></a><span id="l108.841">    */</span>
<a href="#l108.842"></a><span id="l108.842" class="difflineminus">-  deleteItemById: async function(aID, aIsModify) {</span>
<a href="#l108.843"></a><span id="l108.843" class="difflineplus">+  async deleteItemById(aID, aIsModify) {</span>
<a href="#l108.844"></a><span id="l108.844">     let stmts = [];</span>
<a href="#l108.845"></a><span id="l108.845">     this.prepareItemStatement(stmts, this.mDeleteAttendees, &quot;item_id&quot;, aID);</span>
<a href="#l108.846"></a><span id="l108.846">     this.prepareItemStatement(stmts, this.mDeleteProperties, &quot;item_id&quot;, aID);</span>
<a href="#l108.847"></a><span id="l108.847">     this.prepareItemStatement(stmts, this.mDeleteRecurrence, &quot;item_id&quot;, aID);</span>
<a href="#l108.848"></a><span id="l108.848">     this.prepareItemStatement(stmts, this.mDeleteEvent, &quot;id&quot;, aID);</span>
<a href="#l108.849"></a><span id="l108.849">     this.prepareItemStatement(stmts, this.mDeleteTodo, &quot;id&quot;, aID);</span>
<a href="#l108.850"></a><span id="l108.850">     this.prepareItemStatement(stmts, this.mDeleteAttachments, &quot;item_id&quot;, aID);</span>
<a href="#l108.851"></a><span id="l108.851">     this.prepareItemStatement(stmts, this.mDeleteRelations, &quot;item_id&quot;, aID);</span>
<a href="#l108.852"></a><span id="l108.852" class="difflineat">@@ -2459,17 +2459,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.853"></a><span id="l108.853">     this.mRecEventCache.delete(aID);</span>
<a href="#l108.854"></a><span id="l108.854">     this.mRecTodoCache.delete(aID);</span>
<a href="#l108.855"></a><span id="l108.855">   },</span>
<a href="#l108.856"></a><span id="l108.856"> </span>
<a href="#l108.857"></a><span id="l108.857">   //</span>
<a href="#l108.858"></a><span id="l108.858">   // calISyncWriteCalendar interface</span>
<a href="#l108.859"></a><span id="l108.859">   //</span>
<a href="#l108.860"></a><span id="l108.860"> </span>
<a href="#l108.861"></a><span id="l108.861" class="difflineminus">-  setMetaData: function(id, value) {</span>
<a href="#l108.862"></a><span id="l108.862" class="difflineplus">+  setMetaData(id, value) {</span>
<a href="#l108.863"></a><span id="l108.863">     this.executeSyncItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l108.864"></a><span id="l108.864">     try {</span>
<a href="#l108.865"></a><span id="l108.865">       this.prepareStatement(this.mInsertMetaData);</span>
<a href="#l108.866"></a><span id="l108.866">       let params = this.mInsertMetaData.params;</span>
<a href="#l108.867"></a><span id="l108.867">       params.item_id = id;</span>
<a href="#l108.868"></a><span id="l108.868">       params.value = value;</span>
<a href="#l108.869"></a><span id="l108.869">       this.mInsertMetaData.executeStep();</span>
<a href="#l108.870"></a><span id="l108.870">     } catch (e) {</span>
<a href="#l108.871"></a><span id="l108.871" class="difflineat">@@ -2481,21 +2481,21 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.872"></a><span id="l108.872">         // number). Swallow this error, leaving the value empty.</span>
<a href="#l108.873"></a><span id="l108.873">         this.logError(&quot;Error setting metadata for id &quot; + id + &quot;!&quot;, e);</span>
<a href="#l108.874"></a><span id="l108.874">       }</span>
<a href="#l108.875"></a><span id="l108.875">     } finally {</span>
<a href="#l108.876"></a><span id="l108.876">       this.mInsertMetaData.reset();</span>
<a href="#l108.877"></a><span id="l108.877">     }</span>
<a href="#l108.878"></a><span id="l108.878">   },</span>
<a href="#l108.879"></a><span id="l108.879"> </span>
<a href="#l108.880"></a><span id="l108.880" class="difflineminus">-  deleteMetaData: function(id) {</span>
<a href="#l108.881"></a><span id="l108.881" class="difflineplus">+  deleteMetaData(id) {</span>
<a href="#l108.882"></a><span id="l108.882">     this.executeSyncItemStatement(this.mDeleteMetaData, &quot;item_id&quot;, id);</span>
<a href="#l108.883"></a><span id="l108.883">   },</span>
<a href="#l108.884"></a><span id="l108.884"> </span>
<a href="#l108.885"></a><span id="l108.885" class="difflineminus">-  getMetaData: function(id) {</span>
<a href="#l108.886"></a><span id="l108.886" class="difflineplus">+  getMetaData(id) {</span>
<a href="#l108.887"></a><span id="l108.887">     let query = this.mSelectMetaData;</span>
<a href="#l108.888"></a><span id="l108.888">     let value = null;</span>
<a href="#l108.889"></a><span id="l108.889">     try {</span>
<a href="#l108.890"></a><span id="l108.890">       this.prepareStatement(query);</span>
<a href="#l108.891"></a><span id="l108.891">       query.params.item_id = id;</span>
<a href="#l108.892"></a><span id="l108.892"> </span>
<a href="#l108.893"></a><span id="l108.893">       if (query.executeStep()) {</span>
<a href="#l108.894"></a><span id="l108.894">         value = query.row.value;</span>
<a href="#l108.895"></a><span id="l108.895" class="difflineat">@@ -2504,49 +2504,49 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.896"></a><span id="l108.896">       this.logError(&quot;Error getting metadata for id &quot; + id + &quot;!&quot;, e);</span>
<a href="#l108.897"></a><span id="l108.897">     } finally {</span>
<a href="#l108.898"></a><span id="l108.898">       query.reset();</span>
<a href="#l108.899"></a><span id="l108.899">     }</span>
<a href="#l108.900"></a><span id="l108.900"> </span>
<a href="#l108.901"></a><span id="l108.901">     return value;</span>
<a href="#l108.902"></a><span id="l108.902">   },</span>
<a href="#l108.903"></a><span id="l108.903"> </span>
<a href="#l108.904"></a><span id="l108.904" class="difflineminus">-  _getAllMetaDataResults: function(key) {</span>
<a href="#l108.905"></a><span id="l108.905" class="difflineplus">+  _getAllMetaDataResults(key) {</span>
<a href="#l108.906"></a><span id="l108.906">     let query = this.mSelectAllMetaData;</span>
<a href="#l108.907"></a><span id="l108.907">     let results = [];</span>
<a href="#l108.908"></a><span id="l108.908">     try {</span>
<a href="#l108.909"></a><span id="l108.909">       this.prepareStatement(query);</span>
<a href="#l108.910"></a><span id="l108.910">       while (query.executeStep()) {</span>
<a href="#l108.911"></a><span id="l108.911">         results.push(query.row[key]);</span>
<a href="#l108.912"></a><span id="l108.912">       }</span>
<a href="#l108.913"></a><span id="l108.913">     } catch (e) {</span>
<a href="#l108.914"></a><span id="l108.914">       this.logError(`Error getting all metadata ${key == &quot;item_id&quot; ? &quot;IDs&quot; : &quot;values&quot;} ` + e);</span>
<a href="#l108.915"></a><span id="l108.915">     } finally {</span>
<a href="#l108.916"></a><span id="l108.916">       query.reset();</span>
<a href="#l108.917"></a><span id="l108.917">     }</span>
<a href="#l108.918"></a><span id="l108.918">     return results;</span>
<a href="#l108.919"></a><span id="l108.919">   },</span>
<a href="#l108.920"></a><span id="l108.920"> </span>
<a href="#l108.921"></a><span id="l108.921" class="difflineminus">-  getAllMetaDataIds: function() {</span>
<a href="#l108.922"></a><span id="l108.922" class="difflineplus">+  getAllMetaDataIds() {</span>
<a href="#l108.923"></a><span id="l108.923">     return this._getAllMetaDataResults(&quot;item_id&quot;);</span>
<a href="#l108.924"></a><span id="l108.924">   },</span>
<a href="#l108.925"></a><span id="l108.925"> </span>
<a href="#l108.926"></a><span id="l108.926" class="difflineminus">-  getAllMetaDataValues: function() {</span>
<a href="#l108.927"></a><span id="l108.927" class="difflineplus">+  getAllMetaDataValues() {</span>
<a href="#l108.928"></a><span id="l108.928">     return this._getAllMetaDataResults(&quot;value&quot;);</span>
<a href="#l108.929"></a><span id="l108.929">   },</span>
<a href="#l108.930"></a><span id="l108.930"> </span>
<a href="#l108.931"></a><span id="l108.931">   /**</span>
<a href="#l108.932"></a><span id="l108.932">    * Internal logging function that should be called on any database error,</span>
<a href="#l108.933"></a><span id="l108.933">    * it will log as much info as possible about the database context and</span>
<a href="#l108.934"></a><span id="l108.934">    * last statement so the problem can be investigated more easily.</span>
<a href="#l108.935"></a><span id="l108.935">    *</span>
<a href="#l108.936"></a><span id="l108.936">    * @param message           Error message to log.</span>
<a href="#l108.937"></a><span id="l108.937">    * @param exception         Exception that caused the error.</span>
<a href="#l108.938"></a><span id="l108.938">    */</span>
<a href="#l108.939"></a><span id="l108.939" class="difflineminus">-  logError: function(message, exception) {</span>
<a href="#l108.940"></a><span id="l108.940" class="difflineplus">+  logError(message, exception) {</span>
<a href="#l108.941"></a><span id="l108.941">     let logMessage = &quot;Message: &quot; + message;</span>
<a href="#l108.942"></a><span id="l108.942">     if (this.mDB) {</span>
<a href="#l108.943"></a><span id="l108.943">       if (this.mDB.connectionReady) {</span>
<a href="#l108.944"></a><span id="l108.944">         logMessage += &quot;\nConnection Ready: &quot; + this.mDB.connectionReady;</span>
<a href="#l108.945"></a><span id="l108.945">       }</span>
<a href="#l108.946"></a><span id="l108.946">       if (this.mDB.lastError) {</span>
<a href="#l108.947"></a><span id="l108.947">         logMessage += &quot;\nLast DB Error Number: &quot; + this.mDB.lastError;</span>
<a href="#l108.948"></a><span id="l108.948">       }</span>
<a href="#l108.949"></a><span id="l108.949" class="difflineat">@@ -2578,17 +2578,17 @@ calStorageCalendar.prototype = {</span>
<a href="#l108.950"></a><span id="l108.950">     if (exception) {</span>
<a href="#l108.951"></a><span id="l108.951">       logMessage += &quot;\nException: &quot; + exception;</span>
<a href="#l108.952"></a><span id="l108.952">     }</span>
<a href="#l108.953"></a><span id="l108.953">     cal.ERROR(&quot;[calStorageCalendar] &quot; + logMessage + &quot;\n&quot; + cal.STACK(10));</span>
<a href="#l108.954"></a><span id="l108.954">   },</span>
<a href="#l108.955"></a><span id="l108.955">   /**</span>
<a href="#l108.956"></a><span id="l108.956">    * propagate the given sequence in exceptions. It may be needed by some calendar implementations</span>
<a href="#l108.957"></a><span id="l108.957">    */</span>
<a href="#l108.958"></a><span id="l108.958" class="difflineminus">-  _propagateSequence: function(aItem, newSequence) {</span>
<a href="#l108.959"></a><span id="l108.959" class="difflineplus">+  _propagateSequence(aItem, newSequence) {</span>
<a href="#l108.960"></a><span id="l108.960">     if (newSequence) {</span>
<a href="#l108.961"></a><span id="l108.961">       aItem.setProperty(&quot;SEQUENCE&quot;, newSequence);</span>
<a href="#l108.962"></a><span id="l108.962">     } else {</span>
<a href="#l108.963"></a><span id="l108.963">       aItem.deleteProperty(&quot;SEQUENCE&quot;);</span>
<a href="#l108.964"></a><span id="l108.964">     }</span>
<a href="#l108.965"></a><span id="l108.965">     let rec = aItem.recurrenceInfo;</span>
<a href="#l108.966"></a><span id="l108.966">     if (rec) {</span>
<a href="#l108.967"></a><span id="l108.967">       let exceptions = rec.getExceptionIds();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageHelpers.jsm</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -43,19 +43,18 @@ var gForeignTimezonesCache = {};</span>
<a href="#l109.4"></a><span id="l109.4">  *</span>
<a href="#l109.5"></a><span id="l109.5">  * @param date      The calIDateTime to convert.</span>
<a href="#l109.6"></a><span id="l109.6">  * @return          The possibly converted calIDateTime.</span>
<a href="#l109.7"></a><span id="l109.7">  */</span>
<a href="#l109.8"></a><span id="l109.8"> function getInUtcOrKeepFloating(date) {</span>
<a href="#l109.9"></a><span id="l109.9">   let timezone = date.timezone;</span>
<a href="#l109.10"></a><span id="l109.10">   if (timezone.isFloating || timezone.isUTC) {</span>
<a href="#l109.11"></a><span id="l109.11">     return date;</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineminus">-  } else {</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineminus">-    return date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l109.14"></a><span id="l109.14">   }</span>
<a href="#l109.15"></a><span id="l109.15" class="difflineplus">+  return date.getInTimezone(cal.dtz.UTC);</span>
<a href="#l109.16"></a><span id="l109.16"> }</span>
<a href="#l109.17"></a><span id="l109.17"> </span>
<a href="#l109.18"></a><span id="l109.18"> /**</span>
<a href="#l109.19"></a><span id="l109.19">  * Transforms a date object to a text which is suitable for the database</span>
<a href="#l109.20"></a><span id="l109.20">  *</span>
<a href="#l109.21"></a><span id="l109.21">  * @param date  The calIDateTime to transform.</span>
<a href="#l109.22"></a><span id="l109.22">  * @return      The string representation of the date object.</span>
<a href="#l109.23"></a><span id="l109.23">  */</span>
<a href="#l109.24"></a><span id="l109.24" class="difflineat">@@ -123,17 +122,17 @@ function calStorageTimezone(comp) {</span>
<a href="#l109.25"></a><span id="l109.25">   this.tzid = comp.getFirstProperty(&quot;TZID&quot;).value;</span>
<a href="#l109.26"></a><span id="l109.26">   this.displayName = null;</span>
<a href="#l109.27"></a><span id="l109.27">   this.isUTC = false;</span>
<a href="#l109.28"></a><span id="l109.28">   this.isFloating = false;</span>
<a href="#l109.29"></a><span id="l109.29">   this.latitude = null;</span>
<a href="#l109.30"></a><span id="l109.30">   this.longitude = null;</span>
<a href="#l109.31"></a><span id="l109.31"> }</span>
<a href="#l109.32"></a><span id="l109.32"> calStorageTimezone.prototype = {</span>
<a href="#l109.33"></a><span id="l109.33" class="difflineminus">-  toString: function() {</span>
<a href="#l109.34"></a><span id="l109.34" class="difflineplus">+  toString() {</span>
<a href="#l109.35"></a><span id="l109.35">     return this.icalComponent.toString();</span>
<a href="#l109.36"></a><span id="l109.36">   },</span>
<a href="#l109.37"></a><span id="l109.37"> };</span>
<a href="#l109.38"></a><span id="l109.38"> </span>
<a href="#l109.39"></a><span id="l109.39"> /**</span>
<a href="#l109.40"></a><span id="l109.40">  * Gets the timezone for the given definition or identifier</span>
<a href="#l109.41"></a><span id="l109.41">  *</span>
<a href="#l109.42"></a><span id="l109.42">  * @param aTimezone     The timezone data</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/calendar/providers/storage/calStorageUpgrade.jsm</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -145,19 +145,18 @@ function getAllSql(version) {</span>
<a href="#l110.4"></a><span id="l110.4">  *                              schema version will be used.</span>
<a href="#l110.5"></a><span id="l110.5">  * @return                    The javascript object containing the table</span>
<a href="#l110.6"></a><span id="l110.6">  *                              definition.</span>
<a href="#l110.7"></a><span id="l110.7">  */</span>
<a href="#l110.8"></a><span id="l110.8"> function getSqlTable(schemaVersion) {</span>
<a href="#l110.9"></a><span id="l110.9">   let version = &quot;v&quot; + (schemaVersion || DB_SCHEMA_VERSION);</span>
<a href="#l110.10"></a><span id="l110.10">   if (version in upgrade) {</span>
<a href="#l110.11"></a><span id="l110.11">     return upgrade[version]();</span>
<a href="#l110.12"></a><span id="l110.12" class="difflineminus">-  } else {</span>
<a href="#l110.13"></a><span id="l110.13" class="difflineminus">-    return {};</span>
<a href="#l110.14"></a><span id="l110.14">   }</span>
<a href="#l110.15"></a><span id="l110.15" class="difflineplus">+  return {};</span>
<a href="#l110.16"></a><span id="l110.16"> }</span>
<a href="#l110.17"></a><span id="l110.17"> </span>
<a href="#l110.18"></a><span id="l110.18"> /**</span>
<a href="#l110.19"></a><span id="l110.19">  * Gets the current version of the storage database</span>
<a href="#l110.20"></a><span id="l110.20">  */</span>
<a href="#l110.21"></a><span id="l110.21"> function getVersion(db) {</span>
<a href="#l110.22"></a><span id="l110.22">   let selectSchemaVersion;</span>
<a href="#l110.23"></a><span id="l110.23">   let version = null;</span>
<a href="#l110.24"></a><span id="l110.24" class="difflineat">@@ -1204,17 +1203,17 @@ upgrade.v15 = function(db, version) {</span>
<a href="#l110.25"></a><span id="l110.25">  * upgrade if a user is upgrading from 1.0pre -&gt; 1.0b1 or later.</span>
<a href="#l110.26"></a><span id="l110.26">  */</span>
<a href="#l110.27"></a><span id="l110.27"> upgrade.v16 = function(db, version) {</span>
<a href="#l110.28"></a><span id="l110.28">   let tbl = upgrade.v15(version &lt; 15 &amp;&amp; db, version);</span>
<a href="#l110.29"></a><span id="l110.29">   LOGdb(db, &quot;Storage: Upgrading to v16&quot;);</span>
<a href="#l110.30"></a><span id="l110.30">   beginTransaction(db);</span>
<a href="#l110.31"></a><span id="l110.31">   try {</span>
<a href="#l110.32"></a><span id="l110.32">     createFunction(db, &quot;translateAlarm&quot;, 4, {</span>
<a href="#l110.33"></a><span id="l110.33" class="difflineminus">-      onFunctionCall: function(storArgs) {</span>
<a href="#l110.34"></a><span id="l110.34" class="difflineplus">+      onFunctionCall(storArgs) {</span>
<a href="#l110.35"></a><span id="l110.35">         try {</span>
<a href="#l110.36"></a><span id="l110.36">           let [aOffset, aRelated, aAlarmTime, aTzId] = mapStorageArgs(storArgs);</span>
<a href="#l110.37"></a><span id="l110.37"> </span>
<a href="#l110.38"></a><span id="l110.38">           let alarm = cal.createAlarm();</span>
<a href="#l110.39"></a><span id="l110.39">           if (aOffset) {</span>
<a href="#l110.40"></a><span id="l110.40">             alarm.related = parseInt(aRelated, 10) + 1;</span>
<a href="#l110.41"></a><span id="l110.41">             alarm.offset = cal.createDuration();</span>
<a href="#l110.42"></a><span id="l110.42">             alarm.offset.inSeconds = aOffset;</span>
<a href="#l110.43"></a><span id="l110.43" class="difflineat">@@ -1557,17 +1556,17 @@ upgrade.v21 = function(db, version) {</span>
<a href="#l110.44"></a><span id="l110.44">  */</span>
<a href="#l110.45"></a><span id="l110.45"> upgrade.v22 = function(db, version) {</span>
<a href="#l110.46"></a><span id="l110.46">   let tbl = upgrade.v21(version &lt; 21 &amp;&amp; db, version);</span>
<a href="#l110.47"></a><span id="l110.47">   LOGdb(db, &quot;Storage: Upgrading to v22&quot;);</span>
<a href="#l110.48"></a><span id="l110.48">   beginTransaction(db);</span>
<a href="#l110.49"></a><span id="l110.49">   try {</span>
<a href="#l110.50"></a><span id="l110.50">     // Update attachments to using icalString directly</span>
<a href="#l110.51"></a><span id="l110.51">     createFunction(db, &quot;translateAttachment&quot;, 3, {</span>
<a href="#l110.52"></a><span id="l110.52" class="difflineminus">-      onFunctionCall: function(storArgs) {</span>
<a href="#l110.53"></a><span id="l110.53" class="difflineplus">+      onFunctionCall(storArgs) {</span>
<a href="#l110.54"></a><span id="l110.54">         try {</span>
<a href="#l110.55"></a><span id="l110.55">           let [aData, aFmtType, aEncoding] = mapStorageArgs(storArgs);</span>
<a href="#l110.56"></a><span id="l110.56"> </span>
<a href="#l110.57"></a><span id="l110.57">           let attach = cal.createAttachment();</span>
<a href="#l110.58"></a><span id="l110.58">           attach.uri = Services.io.newURI(aData);</span>
<a href="#l110.59"></a><span id="l110.59">           attach.formatType = aFmtType;</span>
<a href="#l110.60"></a><span id="l110.60">           attach.encoding = aEncoding;</span>
<a href="#l110.61"></a><span id="l110.61">           return attach.icalString;</span>
<a href="#l110.62"></a><span id="l110.62" class="difflineat">@@ -1582,34 +1581,34 @@ upgrade.v22 = function(db, version) {</span>
<a href="#l110.63"></a><span id="l110.63">       &quot;cal_attachments&quot;,</span>
<a href="#l110.64"></a><span id="l110.64">       &quot;translateAttachment&quot;,</span>
<a href="#l110.65"></a><span id="l110.65">       [&quot;data&quot;, &quot;format_type&quot;, &quot;encoding&quot;],</span>
<a href="#l110.66"></a><span id="l110.66">       db</span>
<a href="#l110.67"></a><span id="l110.67">     );</span>
<a href="#l110.68"></a><span id="l110.68"> </span>
<a href="#l110.69"></a><span id="l110.69">     // Update relations to using icalString directly</span>
<a href="#l110.70"></a><span id="l110.70">     createFunction(db, &quot;translateRelation&quot;, 2, {</span>
<a href="#l110.71"></a><span id="l110.71" class="difflineminus">-      onFunctionCall: function(storArgs) {</span>
<a href="#l110.72"></a><span id="l110.72" class="difflineplus">+      onFunctionCall(storArgs) {</span>
<a href="#l110.73"></a><span id="l110.73">         try {</span>
<a href="#l110.74"></a><span id="l110.74">           let [aRelType, aRelId] = mapStorageArgs(storArgs);</span>
<a href="#l110.75"></a><span id="l110.75">           let relation = cal.createRelation();</span>
<a href="#l110.76"></a><span id="l110.76">           relation.relType = aRelType;</span>
<a href="#l110.77"></a><span id="l110.77">           relation.relId = aRelId;</span>
<a href="#l110.78"></a><span id="l110.78">           return relation.icalString;</span>
<a href="#l110.79"></a><span id="l110.79">         } catch (e) {</span>
<a href="#l110.80"></a><span id="l110.80">           cal.ERROR(&quot;Error converting relation: &quot; + e);</span>
<a href="#l110.81"></a><span id="l110.81">           throw e;</span>
<a href="#l110.82"></a><span id="l110.82">         }</span>
<a href="#l110.83"></a><span id="l110.83">       },</span>
<a href="#l110.84"></a><span id="l110.84">     });</span>
<a href="#l110.85"></a><span id="l110.85">     migrateToIcalString(tbl, &quot;cal_relations&quot;, &quot;translateRelation&quot;, [&quot;rel_type&quot;, &quot;rel_id&quot;], db);</span>
<a href="#l110.86"></a><span id="l110.86"> </span>
<a href="#l110.87"></a><span id="l110.87">     // Update attendees table to using icalString directly</span>
<a href="#l110.88"></a><span id="l110.88">     createFunction(db, &quot;translateAttendee&quot;, 8, {</span>
<a href="#l110.89"></a><span id="l110.89" class="difflineminus">-      onFunctionCall: function(storArgs) {</span>
<a href="#l110.90"></a><span id="l110.90" class="difflineplus">+      onFunctionCall(storArgs) {</span>
<a href="#l110.91"></a><span id="l110.91">         try {</span>
<a href="#l110.92"></a><span id="l110.92">           let [</span>
<a href="#l110.93"></a><span id="l110.93">             aAttendeeId,</span>
<a href="#l110.94"></a><span id="l110.94">             aCommonName,</span>
<a href="#l110.95"></a><span id="l110.95">             aRsvp,</span>
<a href="#l110.96"></a><span id="l110.96">             aRole,</span>
<a href="#l110.97"></a><span id="l110.97">             aStatus,</span>
<a href="#l110.98"></a><span id="l110.98">             aType,</span>
<a href="#l110.99"></a><span id="l110.99" class="difflineat">@@ -1666,17 +1665,17 @@ upgrade.v22 = function(db, version) {</span>
<a href="#l110.100"></a><span id="l110.100">         &quot;is_organizer&quot;,</span>
<a href="#l110.101"></a><span id="l110.101">         &quot;properties&quot;,</span>
<a href="#l110.102"></a><span id="l110.102">       ],</span>
<a href="#l110.103"></a><span id="l110.103">       db</span>
<a href="#l110.104"></a><span id="l110.104">     );</span>
<a href="#l110.105"></a><span id="l110.105"> </span>
<a href="#l110.106"></a><span id="l110.106">     // Update recurrence table to using icalString directly</span>
<a href="#l110.107"></a><span id="l110.107">     createFunction(db, &quot;translateRecurrence&quot;, 17, {</span>
<a href="#l110.108"></a><span id="l110.108" class="difflineminus">-      onFunctionCall: function(storArgs) {</span>
<a href="#l110.109"></a><span id="l110.109" class="difflineplus">+      onFunctionCall(storArgs) {</span>
<a href="#l110.110"></a><span id="l110.110">         function parseInt10(x) {</span>
<a href="#l110.111"></a><span id="l110.111">           return parseInt(x, 10);</span>
<a href="#l110.112"></a><span id="l110.112">         }</span>
<a href="#l110.113"></a><span id="l110.113">         try {</span>
<a href="#l110.114"></a><span id="l110.114">           let [</span>
<a href="#l110.115"></a><span id="l110.115">             // eslint-disable-next-line no-unused-vars</span>
<a href="#l110.116"></a><span id="l110.116">             aIndex,</span>
<a href="#l110.117"></a><span id="l110.117">             aType,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/calendar/resources/content/mouseoverPreviews.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -66,19 +66,18 @@ function showToolTip(aToolTip, aItem) {</span>
<a href="#l111.4"></a><span id="l111.4">  * @param {calIToDo} toDoItem    the item to create the preview for</span>
<a href="#l111.5"></a><span id="l111.5">  * @param {boolean}  aIsTooltip  enabled if used for tooltip composition (default)</span>
<a href="#l111.6"></a><span id="l111.6">  */</span>
<a href="#l111.7"></a><span id="l111.7"> function getPreviewForItem(aItem, aIsTooltip = true) {</span>
<a href="#l111.8"></a><span id="l111.8">   if (cal.item.isEvent(aItem)) {</span>
<a href="#l111.9"></a><span id="l111.9">     return getPreviewForEvent(aItem, aIsTooltip);</span>
<a href="#l111.10"></a><span id="l111.10">   } else if (cal.item.isToDo(aItem)) {</span>
<a href="#l111.11"></a><span id="l111.11">     return getPreviewForTask(aItem, aIsTooltip);</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineminus">-  } else {</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineminus">-    return null;</span>
<a href="#l111.14"></a><span id="l111.14">   }</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineplus">+  return null;</span>
<a href="#l111.16"></a><span id="l111.16"> }</span>
<a href="#l111.17"></a><span id="l111.17"> </span>
<a href="#l111.18"></a><span id="l111.18"> /**</span>
<a href="#l111.19"></a><span id="l111.19">  * PUBLIC: Returns the string for status (none), Tentative, Confirmed, or</span>
<a href="#l111.20"></a><span id="l111.20">  * Cancelled for a given event</span>
<a href="#l111.21"></a><span id="l111.21">  *</span>
<a href="#l111.22"></a><span id="l111.22">  * @param   {calIEvent} aEvent The event</span>
<a href="#l111.23"></a><span id="l111.23">  * @returns {String}           The string for the status property of the event</span>
<a href="#l111.24"></a><span id="l111.24" class="difflineat">@@ -212,19 +211,18 @@ function getPreviewForTask(toDoItem, aIs</span>
<a href="#l111.25"></a><span id="l111.25">       // display wrapped description lines like body of message below headers</span>
<a href="#l111.26"></a><span id="l111.26">       if (hasHeader) {</span>
<a href="#l111.27"></a><span id="l111.27">         boxAppendBodySeparator(vbox);</span>
<a href="#l111.28"></a><span id="l111.28">       }</span>
<a href="#l111.29"></a><span id="l111.29">       boxAppendBody(vbox, description, aIsTooltip);</span>
<a href="#l111.30"></a><span id="l111.30">     }</span>
<a href="#l111.31"></a><span id="l111.31"> </span>
<a href="#l111.32"></a><span id="l111.32">     return vbox;</span>
<a href="#l111.33"></a><span id="l111.33" class="difflineminus">-  } else {</span>
<a href="#l111.34"></a><span id="l111.34" class="difflineminus">-    return null;</span>
<a href="#l111.35"></a><span id="l111.35">   }</span>
<a href="#l111.36"></a><span id="l111.36" class="difflineplus">+  return null;</span>
<a href="#l111.37"></a><span id="l111.37"> }</span>
<a href="#l111.38"></a><span id="l111.38"> </span>
<a href="#l111.39"></a><span id="l111.39"> /**</span>
<a href="#l111.40"></a><span id="l111.40">  * PRIVATE: Called when mouse moves over a different, or  when mouse moves over</span>
<a href="#l111.41"></a><span id="l111.41">  * event in event list. The instStartDate is date of instance displayed at event</span>
<a href="#l111.42"></a><span id="l111.42">  * box (recurring or multiday events may be displayed by more than one event box</span>
<a href="#l111.43"></a><span id="l111.43">  * for different days), or null if should compute next instance from now.</span>
<a href="#l111.44"></a><span id="l111.44">  *</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineat">@@ -278,19 +276,18 @@ function getPreviewForEvent(aEvent, aIsT</span>
<a href="#l111.46"></a><span id="l111.46"> </span>
<a href="#l111.47"></a><span id="l111.47">     let description = event.getProperty(&quot;DESCRIPTION&quot;);</span>
<a href="#l111.48"></a><span id="l111.48">     if (description) {</span>
<a href="#l111.49"></a><span id="l111.49">       boxAppendBodySeparator(vbox);</span>
<a href="#l111.50"></a><span id="l111.50">       // display wrapped description lines, like body of message below headers</span>
<a href="#l111.51"></a><span id="l111.51">       boxAppendBody(vbox, description, aIsTooltip);</span>
<a href="#l111.52"></a><span id="l111.52">     }</span>
<a href="#l111.53"></a><span id="l111.53">     return vbox;</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineminus">-  } else {</span>
<a href="#l111.55"></a><span id="l111.55" class="difflineminus">-    return null;</span>
<a href="#l111.56"></a><span id="l111.56">   }</span>
<a href="#l111.57"></a><span id="l111.57" class="difflineplus">+  return null;</span>
<a href="#l111.58"></a><span id="l111.58"> }</span>
<a href="#l111.59"></a><span id="l111.59"> </span>
<a href="#l111.60"></a><span id="l111.60"> /**</span>
<a href="#l111.61"></a><span id="l111.61">  * PRIVATE: Append a separator, a thin space between header and body.</span>
<a href="#l111.62"></a><span id="l111.62">  *</span>
<a href="#l111.63"></a><span id="l111.63">  * @param {Node}  vbox  box to which to append separator.</span>
<a href="#l111.64"></a><span id="l111.64">  */</span>
<a href="#l111.65"></a><span id="l111.65"> function boxAppendBodySeparator(vbox) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/calendar/resources/content/publish.js</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/calendar/resources/content/publish.js</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -102,20 +102,20 @@ function publishEntireCalendar(aCalendar</span>
<a href="#l112.4"></a><span id="l112.4">  */</span>
<a href="#l112.5"></a><span id="l112.5"> function publishEntireCalendarDialogResponse(CalendarPublishObject, aProgressDialog) {</span>
<a href="#l112.6"></a><span id="l112.6">   // store the selected remote ics path as a calendar preference</span>
<a href="#l112.7"></a><span id="l112.7">   CalendarPublishObject.calendar.setProperty(&quot;remote-ics-path&quot;, CalendarPublishObject.remotePath);</span>
<a href="#l112.8"></a><span id="l112.8"> </span>
<a href="#l112.9"></a><span id="l112.9">   let itemArray = [];</span>
<a href="#l112.10"></a><span id="l112.10">   let getListener = {</span>
<a href="#l112.11"></a><span id="l112.11">     QueryInterface: ChromeUtils.generateQI([Ci.calIOperationListener]),</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l112.14"></a><span id="l112.14">       publishItemArray(itemArray, CalendarPublishObject.remotePath, aProgressDialog);</span>
<a href="#l112.15"></a><span id="l112.15">     },</span>
<a href="#l112.16"></a><span id="l112.16" class="difflineminus">-    onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l112.17"></a><span id="l112.17" class="difflineplus">+    onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l112.18"></a><span id="l112.18">       if (!Components.isSuccessCode(aStatus)) {</span>
<a href="#l112.19"></a><span id="l112.19">         return;</span>
<a href="#l112.20"></a><span id="l112.20">       }</span>
<a href="#l112.21"></a><span id="l112.21">       if (aItems.length) {</span>
<a href="#l112.22"></a><span id="l112.22">         for (let i = 0; i &lt; aItems.length; ++i) {</span>
<a href="#l112.23"></a><span id="l112.23">           // Store a (short living) reference to the item.</span>
<a href="#l112.24"></a><span id="l112.24">           let itemCopy = aItems[i].clone();</span>
<a href="#l112.25"></a><span id="l112.25">           itemArray.push(itemCopy);</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineat">@@ -195,17 +195,17 @@ function publishItemArray(aItemArray, aP</span>
<a href="#l112.27"></a><span id="l112.27">       cal.l10n.getCalString(&quot;genericErrorTitle&quot;),</span>
<a href="#l112.28"></a><span id="l112.28">       cal.l10n.getCalString(&quot;otherPutError&quot;, [e.message])</span>
<a href="#l112.29"></a><span id="l112.29">     );</span>
<a href="#l112.30"></a><span id="l112.30">   }</span>
<a href="#l112.31"></a><span id="l112.31"> }</span>
<a href="#l112.32"></a><span id="l112.32"> </span>
<a href="#l112.33"></a><span id="l112.33"> var notificationCallbacks = {</span>
<a href="#l112.34"></a><span id="l112.34">   // nsIInterfaceRequestor interface</span>
<a href="#l112.35"></a><span id="l112.35" class="difflineminus">-  getInterface: function(iid, instance) {</span>
<a href="#l112.36"></a><span id="l112.36" class="difflineplus">+  getInterface(iid, instance) {</span>
<a href="#l112.37"></a><span id="l112.37">     if (iid.equals(Ci.nsIAuthPrompt)) {</span>
<a href="#l112.38"></a><span id="l112.38">       // use the window watcher service to get a nsIAuthPrompt impl</span>
<a href="#l112.39"></a><span id="l112.39">       return Services.ww.getNewAuthPrompter(null);</span>
<a href="#l112.40"></a><span id="l112.40">     }</span>
<a href="#l112.41"></a><span id="l112.41"> </span>
<a href="#l112.42"></a><span id="l112.42">     throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l112.43"></a><span id="l112.43">   },</span>
<a href="#l112.44"></a><span id="l112.44"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/calendar/resources/content/publishDialog.js</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/calendar/resources/content/publishDialog.js</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -65,17 +65,17 @@ function checkURLField() {</span>
<a href="#l113.4"></a><span id="l113.4">     document</span>
<a href="#l113.5"></a><span id="l113.5">       .getElementById(&quot;calendar-publishwindow&quot;)</span>
<a href="#l113.6"></a><span id="l113.6">       .getButton(&quot;accept&quot;)</span>
<a href="#l113.7"></a><span id="l113.7">       .removeAttribute(&quot;disabled&quot;);</span>
<a href="#l113.8"></a><span id="l113.8">   }</span>
<a href="#l113.9"></a><span id="l113.9"> }</span>
<a href="#l113.10"></a><span id="l113.10"> </span>
<a href="#l113.11"></a><span id="l113.11"> var progressDialog = {</span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-  onStartUpload: function() {</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineplus">+  onStartUpload() {</span>
<a href="#l113.14"></a><span id="l113.14">     document.getElementById(&quot;publish-progressmeter&quot;).removeAttribute(&quot;value&quot;);</span>
<a href="#l113.15"></a><span id="l113.15">   },</span>
<a href="#l113.16"></a><span id="l113.16"> </span>
<a href="#l113.17"></a><span id="l113.17" class="difflineminus">-  onStopUpload: function() {</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+  onStopUpload() {</span>
<a href="#l113.19"></a><span id="l113.19">     document.getElementById(&quot;publish-progressmeter&quot;).setAttribute(&quot;value&quot;, &quot;0&quot;);</span>
<a href="#l113.20"></a><span id="l113.20">   },</span>
<a href="#l113.21"></a><span id="l113.21"> };</span>
<a href="#l113.22"></a><span id="l113.22"> progressDialog.wrappedJSObject = progressDialog;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/calendar/test/modules/CalendarUtils.jsm</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/calendar/test/modules/CalendarUtils.jsm</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -368,52 +368,50 @@ function getEventBoxPath(controller, vie</span>
<a href="#l114.4"></a><span id="l114.4">       path += `/{&quot;class&quot;:&quot;multiday-column-bg-box&quot;}/[${hour}]`;</span>
<a href="#l114.5"></a><span id="l114.5">     } else {</span>
<a href="#l114.6"></a><span id="l114.6">       path += `</span>
<a href="#l114.7"></a><span id="l114.7">                 /{&quot;class&quot;:&quot;multiday-column-top-box&quot;}/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}/{&quot;flex&quot;:&quot;1&quot;}</span>
<a href="#l114.8"></a><span id="l114.8">             `;</span>
<a href="#l114.9"></a><span id="l114.9">     }</span>
<a href="#l114.10"></a><span id="l114.10"> </span>
<a href="#l114.11"></a><span id="l114.11">     return path;</span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-  } else {</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineminus">-    path += `</span>
<a href="#l114.14"></a><span id="l114.14" class="difflineplus">+  }</span>
<a href="#l114.15"></a><span id="l114.15" class="difflineplus">+  path += `</span>
<a href="#l114.16"></a><span id="l114.16">             /{&quot;class&quot;:&quot;mainbox&quot;}/{&quot;class&quot;:&quot;monthgrid&quot;}/</span>
<a href="#l114.17"></a><span id="l114.17">             [${row - 1}]/[${column - 1}]/[0]</span>
<a href="#l114.18"></a><span id="l114.18">         `;</span>
<a href="#l114.19"></a><span id="l114.19"> </span>
<a href="#l114.20"></a><span id="l114.20" class="difflineminus">-    if (option == CANVAS_BOX) {</span>
<a href="#l114.21"></a><span id="l114.21" class="difflineminus">-      path += `</span>
<a href="#l114.22"></a><span id="l114.22" class="difflineplus">+  if (option == CANVAS_BOX) {</span>
<a href="#l114.23"></a><span id="l114.23" class="difflineplus">+    path += `</span>
<a href="#l114.24"></a><span id="l114.24">                 /{&quot;class&quot;:&quot;calendar-day-items&quot;}</span>
<a href="#l114.25"></a><span id="l114.25">             `;</span>
<a href="#l114.26"></a><span id="l114.26" class="difflineminus">-    }</span>
<a href="#l114.27"></a><span id="l114.27" class="difflineplus">+  }</span>
<a href="#l114.28"></a><span id="l114.28"> </span>
<a href="#l114.29"></a><span id="l114.29" class="difflineminus">-    return path;</span>
<a href="#l114.30"></a><span id="l114.30" class="difflineminus">-  }</span>
<a href="#l114.31"></a><span id="l114.31" class="difflineplus">+  return path;</span>
<a href="#l114.32"></a><span id="l114.32"> }</span>
<a href="#l114.33"></a><span id="l114.33"> </span>
<a href="#l114.34"></a><span id="l114.34"> /**</span>
<a href="#l114.35"></a><span id="l114.35">  * Gets the path snippet for event-details. This is different for day/week and</span>
<a href="#l114.36"></a><span id="l114.36">  * multiweek/month view.</span>
<a href="#l114.37"></a><span id="l114.37">  *</span>
<a href="#l114.38"></a><span id="l114.38">  * @param view          day, week, multiweek or month</span>
<a href="#l114.39"></a><span id="l114.39">  */</span>
<a href="#l114.40"></a><span id="l114.40"> function getEventDetails(view) {</span>
<a href="#l114.41"></a><span id="l114.41">   if (view == &quot;day&quot; || view == &quot;week&quot;) {</span>
<a href="#l114.42"></a><span id="l114.42">     return `</span>
<a href="#l114.43"></a><span id="l114.43">             {&quot;flex&quot;:&quot;1&quot;}/{&quot;class&quot;:&quot;calendar-color-box&quot;}/</span>
<a href="#l114.44"></a><span id="l114.44">             {&quot;class&quot;:&quot;calendar-event-selection&quot;}/{&quot;class&quot;:&quot;calendar-event-box-container&quot;}/</span>
<a href="#l114.45"></a><span id="l114.45">             {&quot;class&quot;:&quot;calendar-event-details&quot;}</span>
<a href="#l114.46"></a><span id="l114.46">         `;</span>
<a href="#l114.47"></a><span id="l114.47" class="difflineminus">-  } else {</span>
<a href="#l114.48"></a><span id="l114.48" class="difflineminus">-    return `</span>
<a href="#l114.49"></a><span id="l114.49" class="difflineplus">+  }</span>
<a href="#l114.50"></a><span id="l114.50" class="difflineplus">+  return `</span>
<a href="#l114.51"></a><span id="l114.51">             {&quot;flex&quot;:&quot;1&quot;}/[0]/{&quot;class&quot;:&quot;calendar-color-box&quot;}/</span>
<a href="#l114.52"></a><span id="l114.52">             {&quot;class&quot;:&quot;calendar-event-selection&quot;}/{&quot;class&quot;:&quot;calendar-event-box-container&quot;}/</span>
<a href="#l114.53"></a><span id="l114.53">             {&quot;class&quot;:&quot;calendar-event-details&quot;}</span>
<a href="#l114.54"></a><span id="l114.54">         `;</span>
<a href="#l114.55"></a><span id="l114.55" class="difflineminus">-  }</span>
<a href="#l114.56"></a><span id="l114.56"> }</span>
<a href="#l114.57"></a><span id="l114.57"> </span>
<a href="#l114.58"></a><span id="l114.58"> /**</span>
<a href="#l114.59"></a><span id="l114.59">  * Checks if Alarm-Icon is shown on a given Event-Box.</span>
<a href="#l114.60"></a><span id="l114.60">  *</span>
<a href="#l114.61"></a><span id="l114.61">  * @param view          day, week, multiweek or month</span>
<a href="#l114.62"></a><span id="l114.62">  * @param row           Only used in multiweek and month view, 1-based index of a row.</span>
<a href="#l114.63"></a><span id="l114.63">  * @param column        1-based index of a column</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/calendar/test/unit/head_consts.js</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/calendar/test/unit/head_consts.js</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -31,21 +31,20 @@ function createDate(aYear, aMonth, aDay,</span>
<a href="#l115.4"></a><span id="l115.4"> </span>
<a href="#l115.5"></a><span id="l115.5"> function createEventFromIcalString(icalString) {</span>
<a href="#l115.6"></a><span id="l115.6">   if (/^BEGIN:VCALENDAR/.test(icalString)) {</span>
<a href="#l115.7"></a><span id="l115.7">     let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l115.8"></a><span id="l115.8">     parser.parseString(icalString);</span>
<a href="#l115.9"></a><span id="l115.9">     let items = parser.getItems();</span>
<a href="#l115.10"></a><span id="l115.10">     cal.ASSERT(items.length == 1);</span>
<a href="#l115.11"></a><span id="l115.11">     return items[0].QueryInterface(Ci.calIEvent);</span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-  } else {</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineminus">-    let event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l115.14"></a><span id="l115.14" class="difflineminus">-    event.icalString = icalString;</span>
<a href="#l115.15"></a><span id="l115.15" class="difflineminus">-    return event;</span>
<a href="#l115.16"></a><span id="l115.16">   }</span>
<a href="#l115.17"></a><span id="l115.17" class="difflineplus">+  let event = Cc[&quot;@mozilla.org/calendar/event;1&quot;].createInstance(Ci.calIEvent);</span>
<a href="#l115.18"></a><span id="l115.18" class="difflineplus">+  event.icalString = icalString;</span>
<a href="#l115.19"></a><span id="l115.19" class="difflineplus">+  return event;</span>
<a href="#l115.20"></a><span id="l115.20"> }</span>
<a href="#l115.21"></a><span id="l115.21"> </span>
<a href="#l115.22"></a><span id="l115.22"> function createTodoFromIcalString(icalString) {</span>
<a href="#l115.23"></a><span id="l115.23">   let todo = Cc[&quot;@mozilla.org/calendar/todo;1&quot;].createInstance(Ci.calITodo);</span>
<a href="#l115.24"></a><span id="l115.24">   todo.icalString = icalString;</span>
<a href="#l115.25"></a><span id="l115.25">   return todo;</span>
<a href="#l115.26"></a><span id="l115.26"> }</span>
<a href="#l115.27"></a><span id="l115.27"> </span>
<a href="#l115.28"></a><span id="l115.28" class="difflineat">@@ -135,19 +134,18 @@ function getProps(aItem, aProp) {</span>
<a href="#l115.29"></a><span id="l115.29">     case &quot;recurrenceStartDate&quot;:</span>
<a href="#l115.30"></a><span id="l115.30">       value = aItem.recurrenceStartDate;</span>
<a href="#l115.31"></a><span id="l115.31">       break;</span>
<a href="#l115.32"></a><span id="l115.32">     default:</span>
<a href="#l115.33"></a><span id="l115.33">       value = aItem.getProperty(aProp);</span>
<a href="#l115.34"></a><span id="l115.34">   }</span>
<a href="#l115.35"></a><span id="l115.35">   if (value) {</span>
<a href="#l115.36"></a><span id="l115.36">     return value.toString();</span>
<a href="#l115.37"></a><span id="l115.37" class="difflineminus">-  } else {</span>
<a href="#l115.38"></a><span id="l115.38" class="difflineminus">-    return null;</span>
<a href="#l115.39"></a><span id="l115.39">   }</span>
<a href="#l115.40"></a><span id="l115.40" class="difflineplus">+  return null;</span>
<a href="#l115.41"></a><span id="l115.41"> }</span>
<a href="#l115.42"></a><span id="l115.42"> </span>
<a href="#l115.43"></a><span id="l115.43"> function compareItemsSpecific(aLeftItem, aRightItem, aPropArray) {</span>
<a href="#l115.44"></a><span id="l115.44">   if (!aPropArray) {</span>
<a href="#l115.45"></a><span id="l115.45">     // left out:  &quot;id&quot;, &quot;calendar&quot;, &quot;lastModifiedTime&quot;, &quot;generation&quot;,</span>
<a href="#l115.46"></a><span id="l115.46">     // &quot;stampTime&quot; as these are expected to change</span>
<a href="#l115.47"></a><span id="l115.47">     aPropArray = [</span>
<a href="#l115.48"></a><span id="l115.48">       &quot;start&quot;,</span>
<a href="#l115.49"></a><span id="l115.49" class="difflineat">@@ -236,36 +234,36 @@ function readJSONFile(aFile) {</span>
<a href="#l115.50"></a><span id="l115.50">     stream.close();</span>
<a href="#l115.51"></a><span id="l115.51">   }</span>
<a href="#l115.52"></a><span id="l115.52">   return false;</span>
<a href="#l115.53"></a><span id="l115.53"> }</span>
<a href="#l115.54"></a><span id="l115.54"> </span>
<a href="#l115.55"></a><span id="l115.55"> function do_load_timezoneservice(callback) {</span>
<a href="#l115.56"></a><span id="l115.56">   do_test_pending();</span>
<a href="#l115.57"></a><span id="l115.57">   cal.getTimezoneService().startup({</span>
<a href="#l115.58"></a><span id="l115.58" class="difflineminus">-    onResult: function() {</span>
<a href="#l115.59"></a><span id="l115.59" class="difflineplus">+    onResult() {</span>
<a href="#l115.60"></a><span id="l115.60">       do_test_finished();</span>
<a href="#l115.61"></a><span id="l115.61">       callback();</span>
<a href="#l115.62"></a><span id="l115.62">     },</span>
<a href="#l115.63"></a><span id="l115.63">   });</span>
<a href="#l115.64"></a><span id="l115.64"> }</span>
<a href="#l115.65"></a><span id="l115.65"> </span>
<a href="#l115.66"></a><span id="l115.66"> function do_load_calmgr(callback) {</span>
<a href="#l115.67"></a><span id="l115.67">   do_test_pending();</span>
<a href="#l115.68"></a><span id="l115.68">   cal.getCalendarManager().startup({</span>
<a href="#l115.69"></a><span id="l115.69" class="difflineminus">-    onResult: function() {</span>
<a href="#l115.70"></a><span id="l115.70" class="difflineplus">+    onResult() {</span>
<a href="#l115.71"></a><span id="l115.71">       do_test_finished();</span>
<a href="#l115.72"></a><span id="l115.72">       callback();</span>
<a href="#l115.73"></a><span id="l115.73">     },</span>
<a href="#l115.74"></a><span id="l115.74">   });</span>
<a href="#l115.75"></a><span id="l115.75"> }</span>
<a href="#l115.76"></a><span id="l115.76"> </span>
<a href="#l115.77"></a><span id="l115.77"> function do_calendar_startup(callback) {</span>
<a href="#l115.78"></a><span id="l115.78">   let obs = {</span>
<a href="#l115.79"></a><span id="l115.79" class="difflineminus">-    observe: function() {</span>
<a href="#l115.80"></a><span id="l115.80" class="difflineplus">+    observe() {</span>
<a href="#l115.81"></a><span id="l115.81">       Services.obs.removeObserver(this, &quot;calendar-startup-done&quot;);</span>
<a href="#l115.82"></a><span id="l115.82">       do_test_finished();</span>
<a href="#l115.83"></a><span id="l115.83">       executeSoon(callback);</span>
<a href="#l115.84"></a><span id="l115.84">     },</span>
<a href="#l115.85"></a><span id="l115.85">   };</span>
<a href="#l115.86"></a><span id="l115.86"> </span>
<a href="#l115.87"></a><span id="l115.87">   let startupService = Cc[&quot;@mozilla.org/calendar/startup-service;1&quot;].getService(Ci.nsISupports)</span>
<a href="#l115.88"></a><span id="l115.88">     .wrappedJSObject;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/calendar/test/unit/test_alarmservice.js</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmservice.js</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -15,83 +15,83 @@ function do_check_xor(a, b, aMessage) {</span>
<a href="#l116.4"></a><span id="l116.4"> var alarmObserver = {</span>
<a href="#l116.5"></a><span id="l116.5">   QueryInterface: ChromeUtils.generateQI([Ci.calIAlarmServiceObserver]),</span>
<a href="#l116.6"></a><span id="l116.6"> </span>
<a href="#l116.7"></a><span id="l116.7">   service: null,</span>
<a href="#l116.8"></a><span id="l116.8">   firedMap: {},</span>
<a href="#l116.9"></a><span id="l116.9">   expectedMap: {},</span>
<a href="#l116.10"></a><span id="l116.10">   pendingOps: {},</span>
<a href="#l116.11"></a><span id="l116.11"> </span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-  onAlarm: function(aItem, aAlarm) {</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineplus">+  onAlarm(aItem, aAlarm) {</span>
<a href="#l116.14"></a><span id="l116.14">     this.firedMap[aItem.hashId] = this.firedMap[aItem.hashId] || {};</span>
<a href="#l116.15"></a><span id="l116.15">     this.firedMap[aItem.hashId][aAlarm.icalString] = true;</span>
<a href="#l116.16"></a><span id="l116.16">   },</span>
<a href="#l116.17"></a><span id="l116.17"> </span>
<a href="#l116.18"></a><span id="l116.18" class="difflineminus">-  onRemoveAlarmsByItem: function(aItem) {</span>
<a href="#l116.19"></a><span id="l116.19" class="difflineplus">+  onRemoveAlarmsByItem(aItem) {</span>
<a href="#l116.20"></a><span id="l116.20">     if (aItem.hashId in this.firedMap) {</span>
<a href="#l116.21"></a><span id="l116.21">       delete this.firedMap[aItem.hashId];</span>
<a href="#l116.22"></a><span id="l116.22">     }</span>
<a href="#l116.23"></a><span id="l116.23">   },</span>
<a href="#l116.24"></a><span id="l116.24"> </span>
<a href="#l116.25"></a><span id="l116.25" class="difflineminus">-  onRemoveAlarmsByCalendar: function() {},</span>
<a href="#l116.26"></a><span id="l116.26" class="difflineplus">+  onRemoveAlarmsByCalendar() {},</span>
<a href="#l116.27"></a><span id="l116.27"> </span>
<a href="#l116.28"></a><span id="l116.28" class="difflineminus">-  onAlarmsLoaded: function(aCalendar) {</span>
<a href="#l116.29"></a><span id="l116.29" class="difflineplus">+  onAlarmsLoaded(aCalendar) {</span>
<a href="#l116.30"></a><span id="l116.30">     this.checkLoadStatus();</span>
<a href="#l116.31"></a><span id="l116.31">     if (aCalendar.id in this.pendingOps) {</span>
<a href="#l116.32"></a><span id="l116.32">       this.pendingOps[aCalendar.id].call();</span>
<a href="#l116.33"></a><span id="l116.33">     }</span>
<a href="#l116.34"></a><span id="l116.34">   },</span>
<a href="#l116.35"></a><span id="l116.35"> </span>
<a href="#l116.36"></a><span id="l116.36" class="difflineminus">-  doOnAlarmsLoaded: function(aCalendar, aOperation) {</span>
<a href="#l116.37"></a><span id="l116.37" class="difflineplus">+  doOnAlarmsLoaded(aCalendar, aOperation) {</span>
<a href="#l116.38"></a><span id="l116.38">     this.checkLoadStatus();</span>
<a href="#l116.39"></a><span id="l116.39">     if (</span>
<a href="#l116.40"></a><span id="l116.40">       aCalendar.id in this.service.mLoadedCalendars &amp;&amp;</span>
<a href="#l116.41"></a><span id="l116.41">       this.service.mLoadedCalendars[aCalendar.id]</span>
<a href="#l116.42"></a><span id="l116.42">     ) {</span>
<a href="#l116.43"></a><span id="l116.43">       // the calendar's alarms have already been loaded, do the callback now</span>
<a href="#l116.44"></a><span id="l116.44">       aOperation.call();</span>
<a href="#l116.45"></a><span id="l116.45">     } else {</span>
<a href="#l116.46"></a><span id="l116.46">       // the calendar hasn't been fully loaded yet, set as a pending operation</span>
<a href="#l116.47"></a><span id="l116.47">       this.pendingOps[aCalendar.id] = aOperation;</span>
<a href="#l116.48"></a><span id="l116.48">     }</span>
<a href="#l116.49"></a><span id="l116.49">   },</span>
<a href="#l116.50"></a><span id="l116.50"> </span>
<a href="#l116.51"></a><span id="l116.51" class="difflineminus">-  getTimer: function(aCalendarId, aItemId, aAlarmStr) {</span>
<a href="#l116.52"></a><span id="l116.52" class="difflineplus">+  getTimer(aCalendarId, aItemId, aAlarmStr) {</span>
<a href="#l116.53"></a><span id="l116.53">     return aCalendarId in this.service.mTimerMap &amp;&amp;</span>
<a href="#l116.54"></a><span id="l116.54">       aItemId in this.service.mTimerMap[aCalendarId] &amp;&amp;</span>
<a href="#l116.55"></a><span id="l116.55">       aAlarmStr in this.service.mTimerMap[aCalendarId][aItemId]</span>
<a href="#l116.56"></a><span id="l116.56">       ? this.service.mTimerMap[aCalendarId][aItemId][aAlarmStr]</span>
<a href="#l116.57"></a><span id="l116.57">       : null;</span>
<a href="#l116.58"></a><span id="l116.58">   },</span>
<a href="#l116.59"></a><span id="l116.59"> </span>
<a href="#l116.60"></a><span id="l116.60" class="difflineminus">-  expectResult: function(aCalendar, aItem, aAlarm, aExpected) {</span>
<a href="#l116.61"></a><span id="l116.61" class="difflineplus">+  expectResult(aCalendar, aItem, aAlarm, aExpected) {</span>
<a href="#l116.62"></a><span id="l116.62">     let expectedAndTitle = {</span>
<a href="#l116.63"></a><span id="l116.63">       expected: aExpected,</span>
<a href="#l116.64"></a><span id="l116.64">       title: aItem.title,</span>
<a href="#l116.65"></a><span id="l116.65">     };</span>
<a href="#l116.66"></a><span id="l116.66">     this.expectedMap[aCalendar.id] = this.expectedMap[aCalendar.id] || {};</span>
<a href="#l116.67"></a><span id="l116.67">     this.expectedMap[aCalendar.id][aItem.hashId] =</span>
<a href="#l116.68"></a><span id="l116.68">       this.expectedMap[aCalendar.id][aItem.hashId] || {};</span>
<a href="#l116.69"></a><span id="l116.69">     this.expectedMap[aCalendar.id][aItem.hashId][aAlarm.icalString] = expectedAndTitle;</span>
<a href="#l116.70"></a><span id="l116.70">   },</span>
<a href="#l116.71"></a><span id="l116.71"> </span>
<a href="#l116.72"></a><span id="l116.72" class="difflineminus">-  expectOccurrences: function(aCalendar, aItem, aAlarm, aExpectedArray) {</span>
<a href="#l116.73"></a><span id="l116.73" class="difflineplus">+  expectOccurrences(aCalendar, aItem, aAlarm, aExpectedArray) {</span>
<a href="#l116.74"></a><span id="l116.74">     // we need to be earlier than the first occurrence</span>
<a href="#l116.75"></a><span id="l116.75">     let date = aItem.startDate.clone();</span>
<a href="#l116.76"></a><span id="l116.76">     date.second -= 1;</span>
<a href="#l116.77"></a><span id="l116.77"> </span>
<a href="#l116.78"></a><span id="l116.78">     for (let expected of aExpectedArray) {</span>
<a href="#l116.79"></a><span id="l116.79">       let occ = aItem.recurrenceInfo.getNextOccurrence(date);</span>
<a href="#l116.80"></a><span id="l116.80">       occ.QueryInterface(Ci.calIEvent);</span>
<a href="#l116.81"></a><span id="l116.81">       date = occ.startDate;</span>
<a href="#l116.82"></a><span id="l116.82">       this.expectResult(aCalendar, occ, aAlarm, expected);</span>
<a href="#l116.83"></a><span id="l116.83">     }</span>
<a href="#l116.84"></a><span id="l116.84">   },</span>
<a href="#l116.85"></a><span id="l116.85"> </span>
<a href="#l116.86"></a><span id="l116.86" class="difflineminus">-  checkExpected: function(aMessage) {</span>
<a href="#l116.87"></a><span id="l116.87" class="difflineplus">+  checkExpected(aMessage) {</span>
<a href="#l116.88"></a><span id="l116.88">     for (let calId in this.expectedMap) {</span>
<a href="#l116.89"></a><span id="l116.89">       for (let id in this.expectedMap[calId]) {</span>
<a href="#l116.90"></a><span id="l116.90">         for (let icalString in this.expectedMap[calId][id]) {</span>
<a href="#l116.91"></a><span id="l116.91">           let expectedAndTitle = this.expectedMap[calId][id][icalString];</span>
<a href="#l116.92"></a><span id="l116.92">           // if no explicit message has been passed, take the item title</span>
<a href="#l116.93"></a><span id="l116.93">           let message = typeof aMessage == &quot;string&quot; ? aMessage : expectedAndTitle.title;</span>
<a href="#l116.94"></a><span id="l116.94">           // only alarms expected as fired should exist in our fired alarm map</span>
<a href="#l116.95"></a><span id="l116.95">           do_check_xor(</span>
<a href="#l116.96"></a><span id="l116.96" class="difflineat">@@ -105,28 +105,28 @@ var alarmObserver = {</span>
<a href="#l116.97"></a><span id="l116.97">             !!this.getTimer(calId, id, icalString),</span>
<a href="#l116.98"></a><span id="l116.98">             message + &quot;; check timer&quot;</span>
<a href="#l116.99"></a><span id="l116.99">           );</span>
<a href="#l116.100"></a><span id="l116.100">         }</span>
<a href="#l116.101"></a><span id="l116.101">       }</span>
<a href="#l116.102"></a><span id="l116.102">     }</span>
<a href="#l116.103"></a><span id="l116.103">   },</span>
<a href="#l116.104"></a><span id="l116.104"> </span>
<a href="#l116.105"></a><span id="l116.105" class="difflineminus">-  checkLoadStatus: function() {</span>
<a href="#l116.106"></a><span id="l116.106" class="difflineplus">+  checkLoadStatus() {</span>
<a href="#l116.107"></a><span id="l116.107">     for (let calId in this.service.mLoadedCalendars) {</span>
<a href="#l116.108"></a><span id="l116.108">       if (!this.service.mLoadedCalendars[calId]) {</span>
<a href="#l116.109"></a><span id="l116.109">         // at least one calendar hasn't finished loading alarms</span>
<a href="#l116.110"></a><span id="l116.110">         ok(this.service.isLoading);</span>
<a href="#l116.111"></a><span id="l116.111">         return;</span>
<a href="#l116.112"></a><span id="l116.112">       }</span>
<a href="#l116.113"></a><span id="l116.113">     }</span>
<a href="#l116.114"></a><span id="l116.114">     ok(!this.service.isLoading);</span>
<a href="#l116.115"></a><span id="l116.115">   },</span>
<a href="#l116.116"></a><span id="l116.116"> </span>
<a href="#l116.117"></a><span id="l116.117" class="difflineminus">-  clear: function() {</span>
<a href="#l116.118"></a><span id="l116.118" class="difflineplus">+  clear() {</span>
<a href="#l116.119"></a><span id="l116.119">     this.firedMap = {};</span>
<a href="#l116.120"></a><span id="l116.120">     this.pendingOps = {};</span>
<a href="#l116.121"></a><span id="l116.121">     this.expectedMap = {};</span>
<a href="#l116.122"></a><span id="l116.122">   },</span>
<a href="#l116.123"></a><span id="l116.123"> };</span>
<a href="#l116.124"></a><span id="l116.124"> </span>
<a href="#l116.125"></a><span id="l116.125"> function run_test() {</span>
<a href="#l116.126"></a><span id="l116.126">   do_get_profile();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/calendar/test/unit/test_alarmutils.js</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/calendar/test/unit/test_alarmutils.js</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -35,17 +35,17 @@ add_task(async function test_setDefaultV</span>
<a href="#l117.4"></a><span id="l117.4">   equal(alarm.offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l117.5"></a><span id="l117.5"> </span>
<a href="#l117.6"></a><span id="l117.6">   Services.prefs.setIntPref(&quot;calendar.alarms.onforevents&quot;, 0);</span>
<a href="#l117.7"></a><span id="l117.7">   item = cal.createEvent();</span>
<a href="#l117.8"></a><span id="l117.8">   cal.alarms.setDefaultValues(item);</span>
<a href="#l117.9"></a><span id="l117.9">   equal(item.getAlarms().length, 0);</span>
<a href="#l117.10"></a><span id="l117.10"> </span>
<a href="#l117.11"></a><span id="l117.11">   let mockCalendar = {</span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-    getProperty: function() {</span>
<a href="#l117.13"></a><span id="l117.13" class="difflineplus">+    getProperty() {</span>
<a href="#l117.14"></a><span id="l117.14">       return [&quot;SHOUT&quot;];</span>
<a href="#l117.15"></a><span id="l117.15">     },</span>
<a href="#l117.16"></a><span id="l117.16">   };</span>
<a href="#l117.17"></a><span id="l117.17"> </span>
<a href="#l117.18"></a><span id="l117.18">   Services.prefs.setIntPref(&quot;calendar.alarms.onforevents&quot;, 1);</span>
<a href="#l117.19"></a><span id="l117.19">   Services.prefs.setStringPref(&quot;calendar.alarms.eventalarmunit&quot;, &quot;hours&quot;);</span>
<a href="#l117.20"></a><span id="l117.20">   Services.prefs.setIntPref(&quot;calendar.alarms.eventalarmlen&quot;, 60);</span>
<a href="#l117.21"></a><span id="l117.21">   item = cal.createEvent();</span>
<a href="#l117.22"></a><span id="l117.22" class="difflineat">@@ -95,17 +95,17 @@ add_task(async function test_setDefaultV</span>
<a href="#l117.23"></a><span id="l117.23">   equal(alarm.offset.icalString, &quot;-PT20M&quot;);</span>
<a href="#l117.24"></a><span id="l117.24"> </span>
<a href="#l117.25"></a><span id="l117.25">   Services.prefs.setIntPref(&quot;calendar.alarms.onfortodos&quot;, 0);</span>
<a href="#l117.26"></a><span id="l117.26">   item = cal.createTodo();</span>
<a href="#l117.27"></a><span id="l117.27">   cal.alarms.setDefaultValues(item);</span>
<a href="#l117.28"></a><span id="l117.28">   equal(item.getAlarms().length, 0);</span>
<a href="#l117.29"></a><span id="l117.29"> </span>
<a href="#l117.30"></a><span id="l117.30">   let mockCalendar = {</span>
<a href="#l117.31"></a><span id="l117.31" class="difflineminus">-    getProperty: function() {</span>
<a href="#l117.32"></a><span id="l117.32" class="difflineplus">+    getProperty() {</span>
<a href="#l117.33"></a><span id="l117.33">       return [&quot;SHOUT&quot;];</span>
<a href="#l117.34"></a><span id="l117.34">     },</span>
<a href="#l117.35"></a><span id="l117.35">   };</span>
<a href="#l117.36"></a><span id="l117.36"> </span>
<a href="#l117.37"></a><span id="l117.37">   Services.prefs.setIntPref(&quot;calendar.alarms.onfortodos&quot;, 1);</span>
<a href="#l117.38"></a><span id="l117.38">   Services.prefs.setStringPref(&quot;calendar.alarms.todoalarmunit&quot;, &quot;hours&quot;);</span>
<a href="#l117.39"></a><span id="l117.39">   Services.prefs.setIntPref(&quot;calendar.alarms.todoalarmlen&quot;, 60);</span>
<a href="#l117.40"></a><span id="l117.40">   item = cal.createTodo();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1" class="difflineminus">--- a/calendar/test/unit/test_bug494140.js</span>
<a href="#l118.2"></a><span id="l118.2" class="difflineplus">+++ b/calendar/test/unit/test_bug494140.js</span>
<a href="#l118.3"></a><span id="l118.3" class="difflineat">@@ -44,26 +44,26 @@ add_task(async () =&gt; {</span>
<a href="#l118.4"></a><span id="l118.4">   // There should still be one alarm, one relation and one attachment</span>
<a href="#l118.5"></a><span id="l118.5">   equal(item.getAlarms().length, 1);</span>
<a href="#l118.6"></a><span id="l118.6">   equal(item.getRelations().length, 1);</span>
<a href="#l118.7"></a><span id="l118.7">   equal(item.getAttachments().length, 1);</span>
<a href="#l118.8"></a><span id="l118.8"> </span>
<a href="#l118.9"></a><span id="l118.9">   // Add the item to the storage calendar and retrieve it again</span>
<a href="#l118.10"></a><span id="l118.10">   await new Promise(resolve =&gt; {</span>
<a href="#l118.11"></a><span id="l118.11">     storageCal.adoptItem(item, {</span>
<a href="#l118.12"></a><span id="l118.12" class="difflineminus">-      onGetResult: function(calendar, status, itemType, detail, items) {},</span>
<a href="#l118.13"></a><span id="l118.13" class="difflineplus">+      onGetResult(calendar, status, itemType, detail, items) {},</span>
<a href="#l118.14"></a><span id="l118.14">       onOperationComplete: resolve,</span>
<a href="#l118.15"></a><span id="l118.15">     });</span>
<a href="#l118.16"></a><span id="l118.16">   });</span>
<a href="#l118.17"></a><span id="l118.17">   let retrievedItem = await new Promise(resolve =&gt; {</span>
<a href="#l118.18"></a><span id="l118.18">     storageCal.getItem(&quot;c1a6cfe7-7fbb-4bfb-a00d-861e07c649a5&quot;, {</span>
<a href="#l118.19"></a><span id="l118.19" class="difflineminus">-      onGetResult: function(cal, stat, type, detail, items) {</span>
<a href="#l118.20"></a><span id="l118.20" class="difflineplus">+      onGetResult(cal, stat, type, detail, items) {</span>
<a href="#l118.21"></a><span id="l118.21">         resolve(items[0]);</span>
<a href="#l118.22"></a><span id="l118.22">       },</span>
<a href="#l118.23"></a><span id="l118.23" class="difflineminus">-      onOperationComplete: function() {},</span>
<a href="#l118.24"></a><span id="l118.24" class="difflineplus">+      onOperationComplete() {},</span>
<a href="#l118.25"></a><span id="l118.25">     });</span>
<a href="#l118.26"></a><span id="l118.26">   });</span>
<a href="#l118.27"></a><span id="l118.27"> </span>
<a href="#l118.28"></a><span id="l118.28">   // There should still be one alarm, one relation and one attachment</span>
<a href="#l118.29"></a><span id="l118.29">   equal(retrievedItem.getAlarms().length, 1);</span>
<a href="#l118.30"></a><span id="l118.30">   equal(retrievedItem.getRelations().length, 1);</span>
<a href="#l118.31"></a><span id="l118.31">   equal(retrievedItem.getAttachments().length, 1);</span>
<a href="#l118.32"></a><span id="l118.32"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/calendar/test/unit/test_calmgr.js</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/calendar/test/unit/test_calmgr.js</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -36,34 +36,34 @@ add_test(function test_registration() {</span>
<a href="#l119.4"></a><span id="l119.4">   checkCalendarCount(0, 0, 0);</span>
<a href="#l119.5"></a><span id="l119.5"> </span>
<a href="#l119.6"></a><span id="l119.6">   // Register an observer to test it.</span>
<a href="#l119.7"></a><span id="l119.7">   let registered = false,</span>
<a href="#l119.8"></a><span id="l119.8">     unregistered = false,</span>
<a href="#l119.9"></a><span id="l119.9">     deleted = false,</span>
<a href="#l119.10"></a><span id="l119.10">     readOnly = false;</span>
<a href="#l119.11"></a><span id="l119.11">   let mgrobs = cal.createAdapter(Ci.calICalendarManagerObserver, {</span>
<a href="#l119.12"></a><span id="l119.12" class="difflineminus">-    onCalendarRegistered: function(aCalendar) {</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineplus">+    onCalendarRegistered(aCalendar) {</span>
<a href="#l119.14"></a><span id="l119.14">       if (aCalendar.id == memory.id) {</span>
<a href="#l119.15"></a><span id="l119.15">         registered = true;</span>
<a href="#l119.16"></a><span id="l119.16">       }</span>
<a href="#l119.17"></a><span id="l119.17">     },</span>
<a href="#l119.18"></a><span id="l119.18" class="difflineminus">-    onCalendarUnregistering: function(aCalendar) {</span>
<a href="#l119.19"></a><span id="l119.19" class="difflineplus">+    onCalendarUnregistering(aCalendar) {</span>
<a href="#l119.20"></a><span id="l119.20">       if (aCalendar.id == memory.id) {</span>
<a href="#l119.21"></a><span id="l119.21">         unregistered = true;</span>
<a href="#l119.22"></a><span id="l119.22">       }</span>
<a href="#l119.23"></a><span id="l119.23">     },</span>
<a href="#l119.24"></a><span id="l119.24" class="difflineminus">-    onCalendarDeleting: function(aCalendar) {</span>
<a href="#l119.25"></a><span id="l119.25" class="difflineplus">+    onCalendarDeleting(aCalendar) {</span>
<a href="#l119.26"></a><span id="l119.26">       if (aCalendar.id == memory.id) {</span>
<a href="#l119.27"></a><span id="l119.27">         deleted = true;</span>
<a href="#l119.28"></a><span id="l119.28">       }</span>
<a href="#l119.29"></a><span id="l119.29">     },</span>
<a href="#l119.30"></a><span id="l119.30">   });</span>
<a href="#l119.31"></a><span id="l119.31">   let calobs = cal.createAdapter(Ci.calIObserver, {</span>
<a href="#l119.32"></a><span id="l119.32" class="difflineminus">-    onPropertyChanged: function(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l119.33"></a><span id="l119.33" class="difflineplus">+    onPropertyChanged(aCalendar, aName, aValue, aOldValue) {</span>
<a href="#l119.34"></a><span id="l119.34">       equal(aCalendar.id, memory.id);</span>
<a href="#l119.35"></a><span id="l119.35">       equal(aName, &quot;readOnly&quot;);</span>
<a href="#l119.36"></a><span id="l119.36">       readOnly = aValue;</span>
<a href="#l119.37"></a><span id="l119.37">     },</span>
<a href="#l119.38"></a><span id="l119.38">   });</span>
<a href="#l119.39"></a><span id="l119.39">   memory.addObserver(calobs);</span>
<a href="#l119.40"></a><span id="l119.40">   calmgr.addObserver(mgrobs);</span>
<a href="#l119.41"></a><span id="l119.41"> </span>
<a href="#l119.42"></a><span id="l119.42" class="difflineat">@@ -207,19 +207,18 @@ add_test(function test_removeModes() {</span>
<a href="#l119.43"></a><span id="l119.43">     equal(calmgr.calendarCount, baseCalendarCount + expectCount);</span>
<a href="#l119.44"></a><span id="l119.44">     equal(deleteCalled, shouldDelete);</span>
<a href="#l119.45"></a><span id="l119.45">   }</span>
<a href="#l119.46"></a><span id="l119.46">   function mockCalendar(memory) {</span>
<a href="#l119.47"></a><span id="l119.47">     let oldGetProperty = memory.wrappedJSObject.getProperty;</span>
<a href="#l119.48"></a><span id="l119.48">     memory.wrappedJSObject.getProperty = function(name) {</span>
<a href="#l119.49"></a><span id="l119.49">       if (name == &quot;capabilities.removeModes&quot;) {</span>
<a href="#l119.50"></a><span id="l119.50">         return removeModes;</span>
<a href="#l119.51"></a><span id="l119.51" class="difflineminus">-      } else {</span>
<a href="#l119.52"></a><span id="l119.52" class="difflineminus">-        return oldGetProperty.apply(this, arguments);</span>
<a href="#l119.53"></a><span id="l119.53">       }</span>
<a href="#l119.54"></a><span id="l119.54" class="difflineplus">+      return oldGetProperty.apply(this, arguments);</span>
<a href="#l119.55"></a><span id="l119.55">     };</span>
<a href="#l119.56"></a><span id="l119.56"> </span>
<a href="#l119.57"></a><span id="l119.57">     let oldDeleteCalendar = memory.wrappedJSObject.deleteCalendar;</span>
<a href="#l119.58"></a><span id="l119.58">     memory.wrappedJSObject.deleteCalendar = function(calendar, listener) {</span>
<a href="#l119.59"></a><span id="l119.59">       deleteCalled = true;</span>
<a href="#l119.60"></a><span id="l119.60">       return oldDeleteCalendar.apply(this, arguments);</span>
<a href="#l119.61"></a><span id="l119.61">     };</span>
<a href="#l119.62"></a><span id="l119.62">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/calendar/test/unit/test_data_bags.js</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/calendar/test/unit/test_data_bags.js</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -9,22 +9,22 @@ function run_test() {</span>
<a href="#l120.4"></a><span id="l120.4"> }</span>
<a href="#l120.5"></a><span id="l120.5"> </span>
<a href="#l120.6"></a><span id="l120.6"> function test_listener_set() {</span>
<a href="#l120.7"></a><span id="l120.7">   let set = new cal.data.ListenerSet(Ci.calIOperationListener);</span>
<a href="#l120.8"></a><span id="l120.8">   let listener1Id = null;</span>
<a href="#l120.9"></a><span id="l120.9">   let listener2Id = null;</span>
<a href="#l120.10"></a><span id="l120.10"> </span>
<a href="#l120.11"></a><span id="l120.11">   let listener1 = cal.createAdapter(&quot;calIOperationListener&quot;, {</span>
<a href="#l120.12"></a><span id="l120.12" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.14"></a><span id="l120.14">       listener1Id = aId;</span>
<a href="#l120.15"></a><span id="l120.15">     },</span>
<a href="#l120.16"></a><span id="l120.16">   });</span>
<a href="#l120.17"></a><span id="l120.17">   let listener2 = cal.createAdapter(&quot;calIOperationListener&quot;, {</span>
<a href="#l120.18"></a><span id="l120.18" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.19"></a><span id="l120.19" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.20"></a><span id="l120.20">       listener2Id = aId;</span>
<a href="#l120.21"></a><span id="l120.21">     },</span>
<a href="#l120.22"></a><span id="l120.22">   });</span>
<a href="#l120.23"></a><span id="l120.23"> </span>
<a href="#l120.24"></a><span id="l120.24">   set.add(listener1);</span>
<a href="#l120.25"></a><span id="l120.25">   set.add(listener2);</span>
<a href="#l120.26"></a><span id="l120.26">   set.notify(&quot;onOperationComplete&quot;, [null, null, null, &quot;test&quot;, null]);</span>
<a href="#l120.27"></a><span id="l120.27">   equal(listener1Id, &quot;test&quot;);</span>
<a href="#l120.28"></a><span id="l120.28" class="difflineat">@@ -35,17 +35,17 @@ function test_listener_set() {</span>
<a href="#l120.29"></a><span id="l120.29">   set.notify(&quot;onOperationComplete&quot;, [null, null, null, &quot;test2&quot;, null]);</span>
<a href="#l120.30"></a><span id="l120.30">   equal(listener1Id, &quot;test2&quot;);</span>
<a href="#l120.31"></a><span id="l120.31">   strictEqual(listener2Id, null);</span>
<a href="#l120.32"></a><span id="l120.32"> </span>
<a href="#l120.33"></a><span id="l120.33">   // Re-adding the listener may lead to an endless loop if the notify</span>
<a href="#l120.34"></a><span id="l120.34">   // function uses a live list of observers.</span>
<a href="#l120.35"></a><span id="l120.35">   let called = 0;</span>
<a href="#l120.36"></a><span id="l120.36">   let listener3 = cal.createAdapter(&quot;calIOperationListener&quot;, {</span>
<a href="#l120.37"></a><span id="l120.37" class="difflineminus">-    onOperationComplete: function(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.38"></a><span id="l120.38" class="difflineplus">+    onOperationComplete(aCalendar, aStatus, aOpType, aId, aDetail) {</span>
<a href="#l120.39"></a><span id="l120.39">       set.delete(listener3);</span>
<a href="#l120.40"></a><span id="l120.40">       if (called == 0) {</span>
<a href="#l120.41"></a><span id="l120.41">         set.add(listener3);</span>
<a href="#l120.42"></a><span id="l120.42">       }</span>
<a href="#l120.43"></a><span id="l120.43">       called++;</span>
<a href="#l120.44"></a><span id="l120.44">     },</span>
<a href="#l120.45"></a><span id="l120.45">   });</span>
<a href="#l120.46"></a><span id="l120.46"> </span>
<a href="#l120.47"></a><span id="l120.47" class="difflineat">@@ -57,28 +57,28 @@ function test_listener_set() {</span>
<a href="#l120.48"></a><span id="l120.48"> function test_observer_set() {</span>
<a href="#l120.49"></a><span id="l120.49">   let set = new cal.data.ObserverSet(Ci.calIObserver);</span>
<a href="#l120.50"></a><span id="l120.50">   let listenerCountBegin1 = 0;</span>
<a href="#l120.51"></a><span id="l120.51">   let listenerCountBegin2 = 0;</span>
<a href="#l120.52"></a><span id="l120.52">   let listenerCountEnd1 = 0;</span>
<a href="#l120.53"></a><span id="l120.53">   let listenerCountEnd2 = 0;</span>
<a href="#l120.54"></a><span id="l120.54"> </span>
<a href="#l120.55"></a><span id="l120.55">   let listener1 = cal.createAdapter(&quot;calIObserver&quot;, {</span>
<a href="#l120.56"></a><span id="l120.56" class="difflineminus">-    onStartBatch: function() {</span>
<a href="#l120.57"></a><span id="l120.57" class="difflineplus">+    onStartBatch() {</span>
<a href="#l120.58"></a><span id="l120.58">       listenerCountBegin1++;</span>
<a href="#l120.59"></a><span id="l120.59">     },</span>
<a href="#l120.60"></a><span id="l120.60" class="difflineminus">-    onEndBatch: function() {</span>
<a href="#l120.61"></a><span id="l120.61" class="difflineplus">+    onEndBatch() {</span>
<a href="#l120.62"></a><span id="l120.62">       listenerCountEnd1++;</span>
<a href="#l120.63"></a><span id="l120.63">     },</span>
<a href="#l120.64"></a><span id="l120.64">   });</span>
<a href="#l120.65"></a><span id="l120.65">   let listener2 = cal.createAdapter(&quot;calIObserver&quot;, {</span>
<a href="#l120.66"></a><span id="l120.66" class="difflineminus">-    onStartBatch: function() {</span>
<a href="#l120.67"></a><span id="l120.67" class="difflineplus">+    onStartBatch() {</span>
<a href="#l120.68"></a><span id="l120.68">       listenerCountBegin2++;</span>
<a href="#l120.69"></a><span id="l120.69">     },</span>
<a href="#l120.70"></a><span id="l120.70" class="difflineminus">-    onEndBatch: function() {</span>
<a href="#l120.71"></a><span id="l120.71" class="difflineplus">+    onEndBatch() {</span>
<a href="#l120.72"></a><span id="l120.72">       listenerCountEnd2++;</span>
<a href="#l120.73"></a><span id="l120.73">     },</span>
<a href="#l120.74"></a><span id="l120.74">   });</span>
<a href="#l120.75"></a><span id="l120.75"> </span>
<a href="#l120.76"></a><span id="l120.76">   set.add(listener1);</span>
<a href="#l120.77"></a><span id="l120.77">   equal(listenerCountBegin1, 0);</span>
<a href="#l120.78"></a><span id="l120.78">   equal(listenerCountEnd1, 0);</span>
<a href="#l120.79"></a><span id="l120.79">   equal(set.batchCount, 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/calendar/test/unit/test_freebusy_service.js</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -16,25 +16,25 @@ function really_run_test() {</span>
<a href="#l121.4"></a><span id="l121.4"> </span>
<a href="#l121.5"></a><span id="l121.5"> function test_found() {</span>
<a href="#l121.6"></a><span id="l121.6">   _clearProviders();</span>
<a href="#l121.7"></a><span id="l121.7"> </span>
<a href="#l121.8"></a><span id="l121.8">   equal(_countProviders(), 0);</span>
<a href="#l121.9"></a><span id="l121.9"> </span>
<a href="#l121.10"></a><span id="l121.10">   let provider1 = {</span>
<a href="#l121.11"></a><span id="l121.11">     id: 1,</span>
<a href="#l121.12"></a><span id="l121.12" class="difflineminus">-    getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.13"></a><span id="l121.13" class="difflineplus">+    getFreeBusyIntervals(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.14"></a><span id="l121.14">       aListener.onResult(null, []);</span>
<a href="#l121.15"></a><span id="l121.15">     },</span>
<a href="#l121.16"></a><span id="l121.16">   };</span>
<a href="#l121.17"></a><span id="l121.17"> </span>
<a href="#l121.18"></a><span id="l121.18">   let provider2 = {</span>
<a href="#l121.19"></a><span id="l121.19">     id: 2,</span>
<a href="#l121.20"></a><span id="l121.20">     called: false,</span>
<a href="#l121.21"></a><span id="l121.21" class="difflineminus">-    getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.22"></a><span id="l121.22" class="difflineplus">+    getFreeBusyIntervals(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.23"></a><span id="l121.23">       ok(!this.called);</span>
<a href="#l121.24"></a><span id="l121.24">       this.called = true;</span>
<a href="#l121.25"></a><span id="l121.25"> </span>
<a href="#l121.26"></a><span id="l121.26">       let interval = new cal.provider.FreeBusyInterval(</span>
<a href="#l121.27"></a><span id="l121.27">         aCalId,</span>
<a href="#l121.28"></a><span id="l121.28">         Ci.calIFreeBusyInterval.BUSY,</span>
<a href="#l121.29"></a><span id="l121.29">         aStart,</span>
<a href="#l121.30"></a><span id="l121.30">         aEnd</span>
<a href="#l121.31"></a><span id="l121.31" class="difflineat">@@ -49,17 +49,17 @@ function test_found() {</span>
<a href="#l121.32"></a><span id="l121.32">   freebusy.addProvider(provider2);</span>
<a href="#l121.33"></a><span id="l121.33">   equal(_countProviders(), 2);</span>
<a href="#l121.34"></a><span id="l121.34">   freebusy.removeProvider(provider1);</span>
<a href="#l121.35"></a><span id="l121.35">   equal(_countProviders(), 1);</span>
<a href="#l121.36"></a><span id="l121.36">   equal(_getFirstProvider().id, 2);</span>
<a href="#l121.37"></a><span id="l121.37"> </span>
<a href="#l121.38"></a><span id="l121.38">   let listener = {</span>
<a href="#l121.39"></a><span id="l121.39">     called: false,</span>
<a href="#l121.40"></a><span id="l121.40" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l121.41"></a><span id="l121.41" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l121.42"></a><span id="l121.42">       equal(result.length, 1);</span>
<a href="#l121.43"></a><span id="l121.43">       equal(result[0].interval.start.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l121.44"></a><span id="l121.44">       equal(result[0].interval.end.icalString, &quot;20120102T010101&quot;);</span>
<a href="#l121.45"></a><span id="l121.45">       equal(result[0].freeBusyType, Ci.calIFreeBusyInterval.BUSY);</span>
<a href="#l121.46"></a><span id="l121.46"> </span>
<a href="#l121.47"></a><span id="l121.47">       equal(result.length, 1);</span>
<a href="#l121.48"></a><span id="l121.48">       ok(provider2.called);</span>
<a href="#l121.49"></a><span id="l121.49">       do_test_finished();</span>
<a href="#l121.50"></a><span id="l121.50" class="difflineat">@@ -76,25 +76,25 @@ function test_found() {</span>
<a href="#l121.51"></a><span id="l121.51">   );</span>
<a href="#l121.52"></a><span id="l121.52"> }</span>
<a href="#l121.53"></a><span id="l121.53"> </span>
<a href="#l121.54"></a><span id="l121.54"> function test_failure() {</span>
<a href="#l121.55"></a><span id="l121.55">   _clearProviders();</span>
<a href="#l121.56"></a><span id="l121.56"> </span>
<a href="#l121.57"></a><span id="l121.57">   let provider = {</span>
<a href="#l121.58"></a><span id="l121.58">     called: false,</span>
<a href="#l121.59"></a><span id="l121.59" class="difflineminus">-    getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.60"></a><span id="l121.60" class="difflineplus">+    getFreeBusyIntervals(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.61"></a><span id="l121.61">       ok(!this.called);</span>
<a href="#l121.62"></a><span id="l121.62">       this.called = true;</span>
<a href="#l121.63"></a><span id="l121.63">       aListener.onResult({ status: Cr.NS_ERROR_FAILURE }, &quot;notFound&quot;);</span>
<a href="#l121.64"></a><span id="l121.64">     },</span>
<a href="#l121.65"></a><span id="l121.65">   };</span>
<a href="#l121.66"></a><span id="l121.66"> </span>
<a href="#l121.67"></a><span id="l121.67">   let listener = {</span>
<a href="#l121.68"></a><span id="l121.68" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l121.69"></a><span id="l121.69" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l121.70"></a><span id="l121.70">       ok(!this.called);</span>
<a href="#l121.71"></a><span id="l121.71">       equal(result.length, 0);</span>
<a href="#l121.72"></a><span id="l121.72">       equal(request.status, 0);</span>
<a href="#l121.73"></a><span id="l121.73">       ok(provider.called);</span>
<a href="#l121.74"></a><span id="l121.74">       do_test_finished();</span>
<a href="#l121.75"></a><span id="l121.75">     },</span>
<a href="#l121.76"></a><span id="l121.76">   };</span>
<a href="#l121.77"></a><span id="l121.77"> </span>
<a href="#l121.78"></a><span id="l121.78" class="difflineat">@@ -110,43 +110,43 @@ function test_failure() {</span>
<a href="#l121.79"></a><span id="l121.79">   );</span>
<a href="#l121.80"></a><span id="l121.80"> }</span>
<a href="#l121.81"></a><span id="l121.81"> </span>
<a href="#l121.82"></a><span id="l121.82"> function test_cancel() {</span>
<a href="#l121.83"></a><span id="l121.83">   _clearProviders();</span>
<a href="#l121.84"></a><span id="l121.84"> </span>
<a href="#l121.85"></a><span id="l121.85">   let provider = {</span>
<a href="#l121.86"></a><span id="l121.86">     QueryInterface: cal.generateQI([Ci.calIFreeBusyProvider, Ci.calIOperation]),</span>
<a href="#l121.87"></a><span id="l121.87" class="difflineminus">-    getFreeBusyIntervals: function(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.88"></a><span id="l121.88" class="difflineplus">+    getFreeBusyIntervals(aCalId, aStart, aEnd, aTypes, aListener) {</span>
<a href="#l121.89"></a><span id="l121.89">       Services.tm.currentThread.dispatch(</span>
<a href="#l121.90"></a><span id="l121.90">         {</span>
<a href="#l121.91"></a><span id="l121.91" class="difflineminus">-          run: function() {</span>
<a href="#l121.92"></a><span id="l121.92" class="difflineplus">+          run() {</span>
<a href="#l121.93"></a><span id="l121.93">             dump(&quot;Cancelling freebusy query...&quot;);</span>
<a href="#l121.94"></a><span id="l121.94">             operation.cancel();</span>
<a href="#l121.95"></a><span id="l121.95">           },</span>
<a href="#l121.96"></a><span id="l121.96">         },</span>
<a href="#l121.97"></a><span id="l121.97">         Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l121.98"></a><span id="l121.98">       );</span>
<a href="#l121.99"></a><span id="l121.99"> </span>
<a href="#l121.100"></a><span id="l121.100">       // No listener call, we emulate a long running search</span>
<a href="#l121.101"></a><span id="l121.101">       // Do return the operation though</span>
<a href="#l121.102"></a><span id="l121.102">       return this;</span>
<a href="#l121.103"></a><span id="l121.103">     },</span>
<a href="#l121.104"></a><span id="l121.104"> </span>
<a href="#l121.105"></a><span id="l121.105">     isPending: true,</span>
<a href="#l121.106"></a><span id="l121.106">     cancelCalled: false,</span>
<a href="#l121.107"></a><span id="l121.107">     status: Cr.NS_OK,</span>
<a href="#l121.108"></a><span id="l121.108" class="difflineminus">-    cancel: function() {</span>
<a href="#l121.109"></a><span id="l121.109" class="difflineplus">+    cancel() {</span>
<a href="#l121.110"></a><span id="l121.110">       this.cancelCalled = true;</span>
<a href="#l121.111"></a><span id="l121.111">     },</span>
<a href="#l121.112"></a><span id="l121.112">   };</span>
<a href="#l121.113"></a><span id="l121.113"> </span>
<a href="#l121.114"></a><span id="l121.114">   let listener = {</span>
<a href="#l121.115"></a><span id="l121.115">     called: false,</span>
<a href="#l121.116"></a><span id="l121.116" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l121.117"></a><span id="l121.117" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l121.118"></a><span id="l121.118">       equal(result, null);</span>
<a href="#l121.119"></a><span id="l121.119"> </span>
<a href="#l121.120"></a><span id="l121.120">       // If an exception occurs, the operation is not added to the opgroup</span>
<a href="#l121.121"></a><span id="l121.121">       ok(!provider.cancelCalled);</span>
<a href="#l121.122"></a><span id="l121.122">       do_test_finished();</span>
<a href="#l121.123"></a><span id="l121.123">     },</span>
<a href="#l121.124"></a><span id="l121.124">   };</span>
<a href="#l121.125"></a><span id="l121.125"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l122.1"></a><span id="l122.1" class="difflineminus">--- a/calendar/test/unit/test_hashedarray.js</span>
<a href="#l122.2"></a><span id="l122.2" class="difflineplus">+++ b/calendar/test/unit/test_hashedarray.js</span>
<a href="#l122.3"></a><span id="l122.3" class="difflineat">@@ -32,19 +32,18 @@ function hashedCreateItem(ident) {</span>
<a href="#l122.4"></a><span id="l122.4">  * @param b         Object to compare with.</span>
<a href="#l122.5"></a><span id="l122.5">  * @return          0, -1, or 1 (usual comptor meanings)</span>
<a href="#l122.6"></a><span id="l122.6">  */</span>
<a href="#l122.7"></a><span id="l122.7"> function titleComptor(a, b) {</span>
<a href="#l122.8"></a><span id="l122.8">   if (a.title &gt; b.title) {</span>
<a href="#l122.9"></a><span id="l122.9">     return 1;</span>
<a href="#l122.10"></a><span id="l122.10">   } else if (a.title &lt; b.title) {</span>
<a href="#l122.11"></a><span id="l122.11">     return -1;</span>
<a href="#l122.12"></a><span id="l122.12" class="difflineminus">-  } else {</span>
<a href="#l122.13"></a><span id="l122.13" class="difflineminus">-    return 0;</span>
<a href="#l122.14"></a><span id="l122.14">   }</span>
<a href="#l122.15"></a><span id="l122.15" class="difflineplus">+  return 0;</span>
<a href="#l122.16"></a><span id="l122.16"> }</span>
<a href="#l122.17"></a><span id="l122.17"> </span>
<a href="#l122.18"></a><span id="l122.18"> /**</span>
<a href="#l122.19"></a><span id="l122.19">  * Checks if the hashed array accessor functions work for the status of the</span>
<a href="#l122.20"></a><span id="l122.20">  * items array.</span>
<a href="#l122.21"></a><span id="l122.21">  *</span>
<a href="#l122.22"></a><span id="l122.22">  * @param har           The Hashed Array</span>
<a href="#l122.23"></a><span id="l122.23">  * @param testItems     The array of test items</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l123.1"></a><span id="l123.1" class="difflineminus">--- a/calendar/test/unit/test_ics.js</span>
<a href="#l123.2"></a><span id="l123.2" class="difflineplus">+++ b/calendar/test/unit/test_ics.js</span>
<a href="#l123.3"></a><span id="l123.3" class="difflineat">@@ -123,17 +123,17 @@ function test_roundtrip() {</span>
<a href="#l123.4"></a><span id="l123.4">     checkEvent(data, event);</span>
<a href="#l123.5"></a><span id="l123.5"> </span>
<a href="#l123.6"></a><span id="l123.6">     // Now, try the same thing with asynchronous parsing. We need a copy of</span>
<a href="#l123.7"></a><span id="l123.7">     // the data variable, otherwise javascript will mix the data between</span>
<a href="#l123.8"></a><span id="l123.8">     // foreach loop iterations.</span>
<a href="#l123.9"></a><span id="l123.9">     do_test_pending();</span>
<a href="#l123.10"></a><span id="l123.10">     let thisdata = data;</span>
<a href="#l123.11"></a><span id="l123.11">     icssrv.parseICSAsync(data.ics, null, {</span>
<a href="#l123.12"></a><span id="l123.12" class="difflineminus">-      onParsingComplete: function(rc, rootComp) {</span>
<a href="#l123.13"></a><span id="l123.13" class="difflineplus">+      onParsingComplete(rc, rootComp) {</span>
<a href="#l123.14"></a><span id="l123.14">         try {</span>
<a href="#l123.15"></a><span id="l123.15">           ok(Components.isSuccessCode(rc));</span>
<a href="#l123.16"></a><span id="l123.16">           let event2 = cal.createEvent();</span>
<a href="#l123.17"></a><span id="l123.17">           event2.icalComponent = rootComp;</span>
<a href="#l123.18"></a><span id="l123.18">           checkEvent(thisdata, event2);</span>
<a href="#l123.19"></a><span id="l123.19">           do_test_finished();</span>
<a href="#l123.20"></a><span id="l123.20">         } catch (e) {</span>
<a href="#l123.21"></a><span id="l123.21">           do_throw(e + &quot;\n&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l124.1"></a><span id="l124.1" class="difflineminus">--- a/calendar/test/unit/test_ics_parser.js</span>
<a href="#l124.2"></a><span id="l124.2" class="difflineplus">+++ b/calendar/test/unit/test_ics_parser.js</span>
<a href="#l124.3"></a><span id="l124.3" class="difflineat">@@ -43,17 +43,17 @@ function test_props_comps() {</span>
<a href="#l124.4"></a><span id="l124.4">   equal(comps[0].location, &quot;BEFORE TIME&quot;);</span>
<a href="#l124.5"></a><span id="l124.5"> }</span>
<a href="#l124.6"></a><span id="l124.6"> </span>
<a href="#l124.7"></a><span id="l124.7"> function test_failures() {</span>
<a href="#l124.8"></a><span id="l124.8">   let parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l124.9"></a><span id="l124.9"> </span>
<a href="#l124.10"></a><span id="l124.10">   do_test_pending();</span>
<a href="#l124.11"></a><span id="l124.11">   parser.parseString(&quot;BOGUS&quot;, null, {</span>
<a href="#l124.12"></a><span id="l124.12" class="difflineminus">-    onParsingComplete: function(rc, opparser) {</span>
<a href="#l124.13"></a><span id="l124.13" class="difflineplus">+    onParsingComplete(rc, opparser) {</span>
<a href="#l124.14"></a><span id="l124.14">       dump(&quot;Note: The previous error message is expected ^^\n&quot;);</span>
<a href="#l124.15"></a><span id="l124.15">       equal(rc, Cr.NS_ERROR_FAILURE);</span>
<a href="#l124.16"></a><span id="l124.16">       do_test_finished();</span>
<a href="#l124.17"></a><span id="l124.17">     },</span>
<a href="#l124.18"></a><span id="l124.18">   });</span>
<a href="#l124.19"></a><span id="l124.19"> </span>
<a href="#l124.20"></a><span id="l124.20">   // No real error here, but there is a message...</span>
<a href="#l124.21"></a><span id="l124.21">   parser = Cc[&quot;@mozilla.org/calendar/ics-parser;1&quot;].createInstance(Ci.calIIcsParser);</span>
<a href="#l124.22"></a><span id="l124.22" class="difflineat">@@ -114,17 +114,17 @@ function test_async() {</span>
<a href="#l124.23"></a><span id="l124.23">     &quot;DTSTART:20120101T010103&quot;,</span>
<a href="#l124.24"></a><span id="l124.24">     &quot;DUE:20120101T010104&quot;,</span>
<a href="#l124.25"></a><span id="l124.25">     &quot;END:VTODO&quot;,</span>
<a href="#l124.26"></a><span id="l124.26">     &quot;END:VCALENDAR&quot;,</span>
<a href="#l124.27"></a><span id="l124.27">   ].join(&quot;\r\n&quot;);</span>
<a href="#l124.28"></a><span id="l124.28"> </span>
<a href="#l124.29"></a><span id="l124.29">   do_test_pending();</span>
<a href="#l124.30"></a><span id="l124.30">   parser.parseString(str, null, {</span>
<a href="#l124.31"></a><span id="l124.31" class="difflineminus">-    onParsingComplete: function(rc, opparser) {</span>
<a href="#l124.32"></a><span id="l124.32" class="difflineplus">+    onParsingComplete(rc, opparser) {</span>
<a href="#l124.33"></a><span id="l124.33">       let items = parser.getItems();</span>
<a href="#l124.34"></a><span id="l124.34">       equal(items.length, 2);</span>
<a href="#l124.35"></a><span id="l124.35">       let item = items[0];</span>
<a href="#l124.36"></a><span id="l124.36">       ok(cal.item.isToDo(item));</span>
<a href="#l124.37"></a><span id="l124.37"> </span>
<a href="#l124.38"></a><span id="l124.38">       equal(item.entryDate.icalString, &quot;20120101T010101&quot;);</span>
<a href="#l124.39"></a><span id="l124.39">       equal(item.dueDate.icalString, &quot;20120101T010102&quot;);</span>
<a href="#l124.40"></a><span id="l124.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l125.1"></a><span id="l125.1" class="difflineminus">--- a/calendar/test/unit/test_items.js</span>
<a href="#l125.2"></a><span id="l125.2" class="difflineplus">+++ b/calendar/test/unit/test_items.js</span>
<a href="#l125.3"></a><span id="l125.3" class="difflineat">@@ -23,17 +23,17 @@ function test_aclmanager() {</span>
<a href="#l125.4"></a><span id="l125.4"> </span>
<a href="#l125.5"></a><span id="l125.5">     get superCalendar() {</span>
<a href="#l125.6"></a><span id="l125.6">       return this;</span>
<a href="#l125.7"></a><span id="l125.7">     },</span>
<a href="#l125.8"></a><span id="l125.8">     get aclManager() {</span>
<a href="#l125.9"></a><span id="l125.9">       return this;</span>
<a href="#l125.10"></a><span id="l125.10">     },</span>
<a href="#l125.11"></a><span id="l125.11"> </span>
<a href="#l125.12"></a><span id="l125.12" class="difflineminus">-    getItemEntry: function(item) {</span>
<a href="#l125.13"></a><span id="l125.13" class="difflineplus">+    getItemEntry(item) {</span>
<a href="#l125.14"></a><span id="l125.14">       if (item.id == &quot;withentry&quot;) {</span>
<a href="#l125.15"></a><span id="l125.15">         return itemEntry;</span>
<a href="#l125.16"></a><span id="l125.16">       }</span>
<a href="#l125.17"></a><span id="l125.17">       return null;</span>
<a href="#l125.18"></a><span id="l125.18">     },</span>
<a href="#l125.19"></a><span id="l125.19">   };</span>
<a href="#l125.20"></a><span id="l125.20"> </span>
<a href="#l125.21"></a><span id="l125.21">   let itemEntry = {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l126.1"></a><span id="l126.1" class="difflineminus">--- a/calendar/test/unit/test_providers.js</span>
<a href="#l126.2"></a><span id="l126.2" class="difflineplus">+++ b/calendar/test/unit/test_providers.js</span>
<a href="#l126.3"></a><span id="l126.3" class="difflineat">@@ -203,27 +203,27 @@ add_task(async function testIcalData() {</span>
<a href="#l126.4"></a><span id="l126.4">       Ci.calICalendar.ITEM_FILTER_TYPE_ALL |</span>
<a href="#l126.5"></a><span id="l126.5">       Ci.calICalendar.ITEM_FILTER_CLASS_OCCURRENCES |</span>
<a href="#l126.6"></a><span id="l126.6">       Ci.calICalendar.ITEM_FILTER_COMPLETED_ALL;</span>
<a href="#l126.7"></a><span id="l126.7"> </span>
<a href="#l126.8"></a><span id="l126.8">     // implement listener</span>
<a href="#l126.9"></a><span id="l126.9">     let count = 0;</span>
<a href="#l126.10"></a><span id="l126.10">     await new Promise(resolve =&gt; {</span>
<a href="#l126.11"></a><span id="l126.11">       let listener = {</span>
<a href="#l126.12"></a><span id="l126.12" class="difflineminus">-        onOperationComplete: function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l126.13"></a><span id="l126.13" class="difflineplus">+        onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l126.14"></a><span id="l126.14">           equal(aStatus, 0);</span>
<a href="#l126.15"></a><span id="l126.15">           if (aOperationType == Ci.calIOperationListener.ADD) {</span>
<a href="#l126.16"></a><span id="l126.16">             // perform getItems() on calendar</span>
<a href="#l126.17"></a><span id="l126.17">             aCalendar.getItems(filter, 0, rangeStart, rangeEnd, listener);</span>
<a href="#l126.18"></a><span id="l126.18">           } else if (aOperationType == Ci.calIOperationListener.GET) {</span>
<a href="#l126.19"></a><span id="l126.19">             equal(count, aResult);</span>
<a href="#l126.20"></a><span id="l126.20">             resolve();</span>
<a href="#l126.21"></a><span id="l126.21">           }</span>
<a href="#l126.22"></a><span id="l126.22">         },</span>
<a href="#l126.23"></a><span id="l126.23" class="difflineminus">-        onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l126.24"></a><span id="l126.24" class="difflineplus">+        onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l126.25"></a><span id="l126.25">           if (aItems.length) {</span>
<a href="#l126.26"></a><span id="l126.26">             count += aItems.length;</span>
<a href="#l126.27"></a><span id="l126.27">             for (let i = 0; i &lt; aItems.length; i++) {</span>
<a href="#l126.28"></a><span id="l126.28">               // Don't check creationDate as it changed when we added the item to the database.</span>
<a href="#l126.29"></a><span id="l126.29">               compareItemsSpecific(aItems[i].parentItem, aItem, [</span>
<a href="#l126.30"></a><span id="l126.30">                 &quot;start&quot;,</span>
<a href="#l126.31"></a><span id="l126.31">                 &quot;end&quot;,</span>
<a href="#l126.32"></a><span id="l126.32">                 &quot;duration&quot;,</span>
<a href="#l126.33"></a><span id="l126.33" class="difflineat">@@ -256,17 +256,17 @@ add_task(async function testIcalData() {</span>
<a href="#l126.34"></a><span id="l126.34">     calArray.push(getStorageCal());</span>
<a href="#l126.35"></a><span id="l126.35">     calArray.push(getMemoryCal());</span>
<a href="#l126.36"></a><span id="l126.36">     for (let calendar of calArray) {</span>
<a href="#l126.37"></a><span id="l126.37">       // implement listener</span>
<a href="#l126.38"></a><span id="l126.38">       let count = 0;</span>
<a href="#l126.39"></a><span id="l126.39">       let returnedItem = null;</span>
<a href="#l126.40"></a><span id="l126.40">       let listener = {</span>
<a href="#l126.41"></a><span id="l126.41">         promises: [],</span>
<a href="#l126.42"></a><span id="l126.42" class="difflineminus">-        onOperationComplete: async function(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l126.43"></a><span id="l126.43" class="difflineplus">+        async onOperationComplete(aCalendar, aStatus, aOperationType, aId, aDetail) {</span>
<a href="#l126.44"></a><span id="l126.44">           equal(aStatus, 0);</span>
<a href="#l126.45"></a><span id="l126.45">           if (aOperationType == Ci.calIOperationListener.ADD) {</span>
<a href="#l126.46"></a><span id="l126.46">             compareItemsSpecific(aDetail, aItem);</span>
<a href="#l126.47"></a><span id="l126.47">             // perform getItem() on calendar</span>
<a href="#l126.48"></a><span id="l126.48">             await new Promise(resolve =&gt; {</span>
<a href="#l126.49"></a><span id="l126.49">               listener.promises.push(resolve);</span>
<a href="#l126.50"></a><span id="l126.50">               aCalendar.getItem(aId, listener);</span>
<a href="#l126.51"></a><span id="l126.51">             });</span>
<a href="#l126.52"></a><span id="l126.52" class="difflineat">@@ -282,17 +282,17 @@ add_task(async function testIcalData() {</span>
<a href="#l126.53"></a><span id="l126.53">               &quot;privacy&quot;,</span>
<a href="#l126.54"></a><span id="l126.54">               &quot;status&quot;,</span>
<a href="#l126.55"></a><span id="l126.55">               &quot;alarmLastAck&quot;,</span>
<a href="#l126.56"></a><span id="l126.56">               &quot;recurrenceStartDate&quot;,</span>
<a href="#l126.57"></a><span id="l126.57">             ]);</span>
<a href="#l126.58"></a><span id="l126.58">           }</span>
<a href="#l126.59"></a><span id="l126.59">           this.promises.pop()();</span>
<a href="#l126.60"></a><span id="l126.60">         },</span>
<a href="#l126.61"></a><span id="l126.61" class="difflineminus">-        onGetResult: function(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l126.62"></a><span id="l126.62" class="difflineplus">+        onGetResult(aCalendar, aStatus, aItemType, aDetail, aItems) {</span>
<a href="#l126.63"></a><span id="l126.63">           if (aItems.length) {</span>
<a href="#l126.64"></a><span id="l126.64">             count += aItems.length;</span>
<a href="#l126.65"></a><span id="l126.65">             returnedItem = aItems[0];</span>
<a href="#l126.66"></a><span id="l126.66">           }</span>
<a href="#l126.67"></a><span id="l126.67">         },</span>
<a href="#l126.68"></a><span id="l126.68">       };</span>
<a href="#l126.69"></a><span id="l126.69"> </span>
<a href="#l126.70"></a><span id="l126.70">       await new Promise(resolve =&gt; {</span>
<a href="#l126.71"></a><span id="l126.71" class="difflineat">@@ -309,29 +309,29 @@ add_task(async function testMetaData() {</span>
<a href="#l126.72"></a><span id="l126.72">     dump(&quot;testMetaData_() calendar type: &quot; + aCalendar.type + &quot;\n&quot;);</span>
<a href="#l126.73"></a><span id="l126.73">     let event1 = createEventFromIcalString(</span>
<a href="#l126.74"></a><span id="l126.74">       &quot;BEGIN:VEVENT\n&quot; + &quot;DTSTART;VALUE=DATE:20020402\n&quot; + &quot;END:VEVENT\n&quot;</span>
<a href="#l126.75"></a><span id="l126.75">     );</span>
<a href="#l126.76"></a><span id="l126.76"> </span>
<a href="#l126.77"></a><span id="l126.77">     event1.id = &quot;item1&quot;;</span>
<a href="#l126.78"></a><span id="l126.78">     await new Promise(resolve =&gt; {</span>
<a href="#l126.79"></a><span id="l126.79">       aCalendar.addItem(event1, {</span>
<a href="#l126.80"></a><span id="l126.80" class="difflineminus">-        onGetResult: function(calendar, aStatus, aItemType, aDetail, aItems) {},</span>
<a href="#l126.81"></a><span id="l126.81" class="difflineplus">+        onGetResult(calendar, aStatus, aItemType, aDetail, aItems) {},</span>
<a href="#l126.82"></a><span id="l126.82">         onOperationComplete: resolve,</span>
<a href="#l126.83"></a><span id="l126.83">       });</span>
<a href="#l126.84"></a><span id="l126.84">     });</span>
<a href="#l126.85"></a><span id="l126.85">     aCalendar.setMetaData(&quot;item1&quot;, &quot;meta1&quot;);</span>
<a href="#l126.86"></a><span id="l126.86">     equal(aCalendar.getMetaData(&quot;item1&quot;), &quot;meta1&quot;);</span>
<a href="#l126.87"></a><span id="l126.87">     equal(aCalendar.getMetaData(&quot;unknown&quot;), null);</span>
<a href="#l126.88"></a><span id="l126.88"> </span>
<a href="#l126.89"></a><span id="l126.89">     let event2 = event1.clone();</span>
<a href="#l126.90"></a><span id="l126.90">     event2.id = &quot;item2&quot;;</span>
<a href="#l126.91"></a><span id="l126.91">     await new Promise(resolve =&gt; {</span>
<a href="#l126.92"></a><span id="l126.92">       aCalendar.addItem(event2, {</span>
<a href="#l126.93"></a><span id="l126.93" class="difflineminus">-        onGetResult: function(calendar, aStatus, aItemType, aDetail, aItems) {},</span>
<a href="#l126.94"></a><span id="l126.94" class="difflineplus">+        onGetResult(calendar, aStatus, aItemType, aDetail, aItems) {},</span>
<a href="#l126.95"></a><span id="l126.95">         onOperationComplete: resolve,</span>
<a href="#l126.96"></a><span id="l126.96">       });</span>
<a href="#l126.97"></a><span id="l126.97">     });</span>
<a href="#l126.98"></a><span id="l126.98">     aCalendar.setMetaData(&quot;item2&quot;, &quot;meta2-&quot;);</span>
<a href="#l126.99"></a><span id="l126.99">     equal(aCalendar.getMetaData(&quot;item2&quot;), &quot;meta2-&quot;);</span>
<a href="#l126.100"></a><span id="l126.100"> </span>
<a href="#l126.101"></a><span id="l126.101">     aCalendar.setMetaData(&quot;item2&quot;, &quot;meta2&quot;);</span>
<a href="#l126.102"></a><span id="l126.102">     equal(aCalendar.getMetaData(&quot;item2&quot;), &quot;meta2&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l127.1"></a><span id="l127.1" class="difflineminus">--- a/calendar/test/unit/test_search_service.js</span>
<a href="#l127.2"></a><span id="l127.2" class="difflineplus">+++ b/calendar/test/unit/test_search_service.js</span>
<a href="#l127.3"></a><span id="l127.3" class="difflineat">@@ -15,23 +15,23 @@ function run_test() {</span>
<a href="#l127.4"></a><span id="l127.4"> </span>
<a href="#l127.5"></a><span id="l127.5"> function test_found() {</span>
<a href="#l127.6"></a><span id="l127.6">   search.getProviders().forEach(search.removeProvider, search);</span>
<a href="#l127.7"></a><span id="l127.7"> </span>
<a href="#l127.8"></a><span id="l127.8">   equal(search.getProviders().length, 0);</span>
<a href="#l127.9"></a><span id="l127.9"> </span>
<a href="#l127.10"></a><span id="l127.10">   let provider1 = {</span>
<a href="#l127.11"></a><span id="l127.11">     id: 1,</span>
<a href="#l127.12"></a><span id="l127.12" class="difflineminus">-    searchForCalendars: function() {},</span>
<a href="#l127.13"></a><span id="l127.13" class="difflineplus">+    searchForCalendars() {},</span>
<a href="#l127.14"></a><span id="l127.14">   };</span>
<a href="#l127.15"></a><span id="l127.15"> </span>
<a href="#l127.16"></a><span id="l127.16">   let provider2 = {</span>
<a href="#l127.17"></a><span id="l127.17">     id: 2,</span>
<a href="#l127.18"></a><span id="l127.18">     called: false,</span>
<a href="#l127.19"></a><span id="l127.19" class="difflineminus">-    searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.20"></a><span id="l127.20" class="difflineplus">+    searchForCalendars(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.21"></a><span id="l127.21">       ok(!this.called);</span>
<a href="#l127.22"></a><span id="l127.22">       this.called = true;</span>
<a href="#l127.23"></a><span id="l127.23"> </span>
<a href="#l127.24"></a><span id="l127.24">       equal(aStr, &quot;str&quot;);</span>
<a href="#l127.25"></a><span id="l127.25">       equal(aHint, HINT_EXACT_MATCH);</span>
<a href="#l127.26"></a><span id="l127.26">       equal(aMax, 0);</span>
<a href="#l127.27"></a><span id="l127.27"> </span>
<a href="#l127.28"></a><span id="l127.28">       let mockCalendar = { id: &quot;test&quot; };</span>
<a href="#l127.29"></a><span id="l127.29" class="difflineat">@@ -46,17 +46,17 @@ function test_found() {</span>
<a href="#l127.30"></a><span id="l127.30">   search.addProvider(provider2);</span>
<a href="#l127.31"></a><span id="l127.31">   equal(search.getProviders().length, 2);</span>
<a href="#l127.32"></a><span id="l127.32">   search.removeProvider(provider1);</span>
<a href="#l127.33"></a><span id="l127.33">   equal(search.getProviders().length, 1);</span>
<a href="#l127.34"></a><span id="l127.34">   equal(search.getProviders()[0].wrappedJSObject.id, 2);</span>
<a href="#l127.35"></a><span id="l127.35"> </span>
<a href="#l127.36"></a><span id="l127.36">   let listener = {</span>
<a href="#l127.37"></a><span id="l127.37">     called: false,</span>
<a href="#l127.38"></a><span id="l127.38" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l127.39"></a><span id="l127.39" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l127.40"></a><span id="l127.40">       ok(!this.called);</span>
<a href="#l127.41"></a><span id="l127.41">       this.called = true;</span>
<a href="#l127.42"></a><span id="l127.42"> </span>
<a href="#l127.43"></a><span id="l127.43">       equal(result.length, 1);</span>
<a href="#l127.44"></a><span id="l127.44">       equal(result[0].id, &quot;test&quot;);</span>
<a href="#l127.45"></a><span id="l127.45">     },</span>
<a href="#l127.46"></a><span id="l127.46">   };</span>
<a href="#l127.47"></a><span id="l127.47"> </span>
<a href="#l127.48"></a><span id="l127.48" class="difflineat">@@ -64,24 +64,24 @@ function test_found() {</span>
<a href="#l127.49"></a><span id="l127.49">   ok(listener.called);</span>
<a href="#l127.50"></a><span id="l127.50">   ok(provider2.called);</span>
<a href="#l127.51"></a><span id="l127.51"> }</span>
<a href="#l127.52"></a><span id="l127.52"> </span>
<a href="#l127.53"></a><span id="l127.53"> function test_failure() {</span>
<a href="#l127.54"></a><span id="l127.54">   search.getProviders().forEach(search.removeProvider, search);</span>
<a href="#l127.55"></a><span id="l127.55"> </span>
<a href="#l127.56"></a><span id="l127.56">   let provider = {</span>
<a href="#l127.57"></a><span id="l127.57" class="difflineminus">-    searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.58"></a><span id="l127.58" class="difflineplus">+    searchForCalendars(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.59"></a><span id="l127.59">       throw new Error(&quot;error&quot;);</span>
<a href="#l127.60"></a><span id="l127.60">     },</span>
<a href="#l127.61"></a><span id="l127.61">   };</span>
<a href="#l127.62"></a><span id="l127.62"> </span>
<a href="#l127.63"></a><span id="l127.63">   let listener = {</span>
<a href="#l127.64"></a><span id="l127.64">     called: false,</span>
<a href="#l127.65"></a><span id="l127.65" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l127.66"></a><span id="l127.66" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l127.67"></a><span id="l127.67">       ok(!this.called);</span>
<a href="#l127.68"></a><span id="l127.68">       this.called = true;</span>
<a href="#l127.69"></a><span id="l127.69">       equal(result.length, 0);</span>
<a href="#l127.70"></a><span id="l127.70">     },</span>
<a href="#l127.71"></a><span id="l127.71">   };</span>
<a href="#l127.72"></a><span id="l127.72"> </span>
<a href="#l127.73"></a><span id="l127.73">   search.addProvider(provider);</span>
<a href="#l127.74"></a><span id="l127.74"> </span>
<a href="#l127.75"></a><span id="l127.75" class="difflineat">@@ -89,43 +89,43 @@ function test_failure() {</span>
<a href="#l127.76"></a><span id="l127.76">   ok(listener.called);</span>
<a href="#l127.77"></a><span id="l127.77"> }</span>
<a href="#l127.78"></a><span id="l127.78"> </span>
<a href="#l127.79"></a><span id="l127.79"> function test_cancel() {</span>
<a href="#l127.80"></a><span id="l127.80">   search.getProviders().forEach(search.removeProvider, search);</span>
<a href="#l127.81"></a><span id="l127.81"> </span>
<a href="#l127.82"></a><span id="l127.82">   let provider = {</span>
<a href="#l127.83"></a><span id="l127.83">     QueryInterface: cal.generateQI([Ci.calICalendarSearchProvider, Ci.calIOperation]),</span>
<a href="#l127.84"></a><span id="l127.84" class="difflineminus">-    searchForCalendars: function(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.85"></a><span id="l127.85" class="difflineplus">+    searchForCalendars(aStr, aHint, aMax, aListener) {</span>
<a href="#l127.86"></a><span id="l127.86">       Services.tm.currentThread.dispatch(</span>
<a href="#l127.87"></a><span id="l127.87">         {</span>
<a href="#l127.88"></a><span id="l127.88" class="difflineminus">-          run: function() {</span>
<a href="#l127.89"></a><span id="l127.89" class="difflineplus">+          run() {</span>
<a href="#l127.90"></a><span id="l127.90">             dump(&quot;Cancelling search...&quot;);</span>
<a href="#l127.91"></a><span id="l127.91">             operation.cancel();</span>
<a href="#l127.92"></a><span id="l127.92">           },</span>
<a href="#l127.93"></a><span id="l127.93">         },</span>
<a href="#l127.94"></a><span id="l127.94">         Ci.nsIEventTarget.DISPATCH_NORMAL</span>
<a href="#l127.95"></a><span id="l127.95">       );</span>
<a href="#l127.96"></a><span id="l127.96"> </span>
<a href="#l127.97"></a><span id="l127.97">       // No listener call, we emulate a long running search</span>
<a href="#l127.98"></a><span id="l127.98">       // Do return the operation though</span>
<a href="#l127.99"></a><span id="l127.99">       return this;</span>
<a href="#l127.100"></a><span id="l127.100">     },</span>
<a href="#l127.101"></a><span id="l127.101"> </span>
<a href="#l127.102"></a><span id="l127.102">     isPending: true,</span>
<a href="#l127.103"></a><span id="l127.103">     cancelCalled: false,</span>
<a href="#l127.104"></a><span id="l127.104">     status: Cr.NS_OK,</span>
<a href="#l127.105"></a><span id="l127.105" class="difflineminus">-    cancel: function() {</span>
<a href="#l127.106"></a><span id="l127.106" class="difflineplus">+    cancel() {</span>
<a href="#l127.107"></a><span id="l127.107">       this.cancelCalled = true;</span>
<a href="#l127.108"></a><span id="l127.108">     },</span>
<a href="#l127.109"></a><span id="l127.109">   };</span>
<a href="#l127.110"></a><span id="l127.110"> </span>
<a href="#l127.111"></a><span id="l127.111">   let listener = {</span>
<a href="#l127.112"></a><span id="l127.112">     called: false,</span>
<a href="#l127.113"></a><span id="l127.113" class="difflineminus">-    onResult: function(request, result) {</span>
<a href="#l127.114"></a><span id="l127.114" class="difflineplus">+    onResult(request, result) {</span>
<a href="#l127.115"></a><span id="l127.115">       equal(result, null);</span>
<a href="#l127.116"></a><span id="l127.116"> </span>
<a href="#l127.117"></a><span id="l127.117">       // If an exception occurs, the operation is not added to the opgroup</span>
<a href="#l127.118"></a><span id="l127.118">       ok(!provider.cancelCalled);</span>
<a href="#l127.119"></a><span id="l127.119">       do_test_finished();</span>
<a href="#l127.120"></a><span id="l127.120">     },</span>
<a href="#l127.121"></a><span id="l127.121">   };</span>
<a href="#l127.122"></a><span id="l127.122"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l128.1"></a><span id="l128.1" class="difflineminus">--- a/calendar/test/unit/test_startup_service.js</span>
<a href="#l128.2"></a><span id="l128.2" class="difflineplus">+++ b/calendar/test/unit/test_startup_service.js</span>
<a href="#l128.3"></a><span id="l128.3" class="difflineat">@@ -1,32 +1,32 @@</span>
<a href="#l128.4"></a><span id="l128.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l128.5"></a><span id="l128.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l128.6"></a><span id="l128.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l128.7"></a><span id="l128.7"> </span>
<a href="#l128.8"></a><span id="l128.8"> function run_test() {</span>
<a href="#l128.9"></a><span id="l128.9">   let ssvc = Cc[&quot;@mozilla.org/calendar/startup-service;1&quot;].getService(Ci.nsIObserver);</span>
<a href="#l128.10"></a><span id="l128.10"> </span>
<a href="#l128.11"></a><span id="l128.11">   let first = {</span>
<a href="#l128.12"></a><span id="l128.12" class="difflineminus">-    startup: function(aListener) {</span>
<a href="#l128.13"></a><span id="l128.13" class="difflineplus">+    startup(aListener) {</span>
<a href="#l128.14"></a><span id="l128.14">       second.canStart = true;</span>
<a href="#l128.15"></a><span id="l128.15">       aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l128.16"></a><span id="l128.16">     },</span>
<a href="#l128.17"></a><span id="l128.17" class="difflineminus">-    shutdown: function(aListener) {</span>
<a href="#l128.18"></a><span id="l128.18" class="difflineplus">+    shutdown(aListener) {</span>
<a href="#l128.19"></a><span id="l128.19">       ok(this.canStop);</span>
<a href="#l128.20"></a><span id="l128.20">       aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l128.21"></a><span id="l128.21">     },</span>
<a href="#l128.22"></a><span id="l128.22">   };</span>
<a href="#l128.23"></a><span id="l128.23"> </span>
<a href="#l128.24"></a><span id="l128.24">   let second = {</span>
<a href="#l128.25"></a><span id="l128.25" class="difflineminus">-    startup: function(aListener) {</span>
<a href="#l128.26"></a><span id="l128.26" class="difflineplus">+    startup(aListener) {</span>
<a href="#l128.27"></a><span id="l128.27">       ok(this.canStart);</span>
<a href="#l128.28"></a><span id="l128.28">       aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l128.29"></a><span id="l128.29">     },</span>
<a href="#l128.30"></a><span id="l128.30" class="difflineminus">-    shutdown: function(aListener) {</span>
<a href="#l128.31"></a><span id="l128.31" class="difflineplus">+    shutdown(aListener) {</span>
<a href="#l128.32"></a><span id="l128.32">       first.canStop = true;</span>
<a href="#l128.33"></a><span id="l128.33">       aListener.onResult(null, Cr.NS_OK);</span>
<a href="#l128.34"></a><span id="l128.34">     },</span>
<a href="#l128.35"></a><span id="l128.35">   };</span>
<a href="#l128.36"></a><span id="l128.36"> </span>
<a href="#l128.37"></a><span id="l128.37">   // Change the startup order so we can test our services</span>
<a href="#l128.38"></a><span id="l128.38">   let oldStartupOrder = ssvc.wrappedJSObject.getStartupOrder;</span>
<a href="#l128.39"></a><span id="l128.39">   ssvc.wrappedJSObject.getStartupOrder = function() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l129.1"></a><span id="l129.1" class="difflineminus">--- a/calendar/test/unit/test_storage.js</span>
<a href="#l129.2"></a><span id="l129.2" class="difflineplus">+++ b/calendar/test/unit/test_storage.js</span>
<a href="#l129.3"></a><span id="l129.3" class="difflineat">@@ -20,30 +20,30 @@ add_task(async () =&gt; {</span>
<a href="#l129.4"></a><span id="l129.4">     &quot;EXDATE:20120301T010101Z&quot;,</span>
<a href="#l129.5"></a><span id="l129.5">     &quot;END:VEVENT&quot;,</span>
<a href="#l129.6"></a><span id="l129.6">   ].join(&quot;\r\n&quot;);</span>
<a href="#l129.7"></a><span id="l129.7"> </span>
<a href="#l129.8"></a><span id="l129.8">   let storageItem = createEventFromIcalString(str);</span>
<a href="#l129.9"></a><span id="l129.9"> </span>
<a href="#l129.10"></a><span id="l129.10">   let addedItemId = await new Promise(resolve =&gt; {</span>
<a href="#l129.11"></a><span id="l129.11">     storage.addItem(storageItem, {</span>
<a href="#l129.12"></a><span id="l129.12" class="difflineminus">-      onOperationComplete: function(calendar, status, opType, id, addedItem) {</span>
<a href="#l129.13"></a><span id="l129.13" class="difflineplus">+      onOperationComplete(calendar, status, opType, id, addedItem) {</span>
<a href="#l129.14"></a><span id="l129.14">         addedItem.QueryInterface(Ci.calIEvent);</span>
<a href="#l129.15"></a><span id="l129.15">         resolve(addedItem.id);</span>
<a href="#l129.16"></a><span id="l129.16">       },</span>
<a href="#l129.17"></a><span id="l129.17">     });</span>
<a href="#l129.18"></a><span id="l129.18">   });</span>
<a href="#l129.19"></a><span id="l129.19"> </span>
<a href="#l129.20"></a><span id="l129.20">   // Make sure the cache is cleared, otherwise we'll get the cached item.</span>
<a href="#l129.21"></a><span id="l129.21">   delete storage.wrappedJSObject.mItemCache[addedItemId];</span>
<a href="#l129.22"></a><span id="l129.22"> </span>
<a href="#l129.23"></a><span id="l129.23">   await new Promise(resolve =&gt; {</span>
<a href="#l129.24"></a><span id="l129.24">     storage.getItem(addedItemId, {</span>
<a href="#l129.25"></a><span id="l129.25">       found: false,</span>
<a href="#l129.26"></a><span id="l129.26" class="difflineminus">-      onGetResult: function(calendar, status, type, detail, items) {</span>
<a href="#l129.27"></a><span id="l129.27" class="difflineplus">+      onGetResult(calendar, status, type, detail, items) {</span>
<a href="#l129.28"></a><span id="l129.28">         let item = items[0];</span>
<a href="#l129.29"></a><span id="l129.29"> </span>
<a href="#l129.30"></a><span id="l129.30">         // Check start date</span>
<a href="#l129.31"></a><span id="l129.31">         equal(item.startDate.compare(cal.createDateTime(&quot;20120101T010101Z&quot;)), 0);</span>
<a href="#l129.32"></a><span id="l129.32"> </span>
<a href="#l129.33"></a><span id="l129.33">         // Check attachment</span>
<a href="#l129.34"></a><span id="l129.34">         let attaches = item.getAttachments();</span>
<a href="#l129.35"></a><span id="l129.35">         let attach = attaches[0];</span>
<a href="#l129.36"></a><span id="l129.36" class="difflineat">@@ -91,17 +91,17 @@ add_task(async () =&gt; {</span>
<a href="#l129.37"></a><span id="l129.37">             }</span>
<a href="#l129.38"></a><span id="l129.38">           } else {</span>
<a href="#l129.39"></a><span id="l129.39">             do_throw(&quot;Found unknown recurrence item &quot; + ritem);</span>
<a href="#l129.40"></a><span id="l129.40">           }</span>
<a href="#l129.41"></a><span id="l129.41">         }</span>
<a href="#l129.42"></a><span id="l129.42"> </span>
<a href="#l129.43"></a><span id="l129.43">         this.found = true;</span>
<a href="#l129.44"></a><span id="l129.44">       },</span>
<a href="#l129.45"></a><span id="l129.45" class="difflineminus">-      onOperationComplete: function() {</span>
<a href="#l129.46"></a><span id="l129.46" class="difflineplus">+      onOperationComplete() {</span>
<a href="#l129.47"></a><span id="l129.47">         if (!this.found) {</span>
<a href="#l129.48"></a><span id="l129.48">           do_throw(&quot;Could not find item&quot;);</span>
<a href="#l129.49"></a><span id="l129.49">         }</span>
<a href="#l129.50"></a><span id="l129.50">         resolve();</span>
<a href="#l129.51"></a><span id="l129.51">       },</span>
<a href="#l129.52"></a><span id="l129.52">     });</span>
<a href="#l129.53"></a><span id="l129.53">   });</span>
<a href="#l129.54"></a><span id="l129.54"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l130.1"></a><span id="l130.1" class="difflineminus">--- a/calendar/test/unit/test_timezone.js</span>
<a href="#l130.2"></a><span id="l130.2" class="difflineplus">+++ b/calendar/test/unit/test_timezone.js</span>
<a href="#l130.3"></a><span id="l130.3" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l130.4"></a><span id="l130.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l130.5"></a><span id="l130.5"> </span>
<a href="#l130.6"></a><span id="l130.6"> function run_test() {</span>
<a href="#l130.7"></a><span id="l130.7">   do_test_pending();</span>
<a href="#l130.8"></a><span id="l130.8">   cal</span>
<a href="#l130.9"></a><span id="l130.9">     .getTimezoneService()</span>
<a href="#l130.10"></a><span id="l130.10">     .QueryInterface(Ci.calIStartupService)</span>
<a href="#l130.11"></a><span id="l130.11">     .startup({</span>
<a href="#l130.12"></a><span id="l130.12" class="difflineminus">-      onResult: function() {</span>
<a href="#l130.13"></a><span id="l130.13" class="difflineplus">+      onResult() {</span>
<a href="#l130.14"></a><span id="l130.14">         really_run_test();</span>
<a href="#l130.15"></a><span id="l130.15">         do_test_finished();</span>
<a href="#l130.16"></a><span id="l130.16">       },</span>
<a href="#l130.17"></a><span id="l130.17">     });</span>
<a href="#l130.18"></a><span id="l130.18"> }</span>
<a href="#l130.19"></a><span id="l130.19"> </span>
<a href="#l130.20"></a><span id="l130.20"> function really_run_test() {</span>
<a href="#l130.21"></a><span id="l130.21">   let event = cal.createEvent();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l131.1"></a><span id="l131.1" class="difflineminus">--- a/calendar/test/unit/test_utils.js</span>
<a href="#l131.2"></a><span id="l131.2" class="difflineplus">+++ b/calendar/test/unit/test_utils.js</span>
<a href="#l131.3"></a><span id="l131.3" class="difflineat">@@ -125,30 +125,30 @@ function test_OperationGroup() {</span>
<a href="#l131.4"></a><span id="l131.4"> </span>
<a href="#l131.5"></a><span id="l131.5">   group.add(completedOp);</span>
<a href="#l131.6"></a><span id="l131.6">   ok(group.isEmpty);</span>
<a href="#l131.7"></a><span id="l131.7">   equal(group.isPending, true);</span>
<a href="#l131.8"></a><span id="l131.8"> </span>
<a href="#l131.9"></a><span id="l131.9">   let pendingOp1 = {</span>
<a href="#l131.10"></a><span id="l131.10">     id: 1,</span>
<a href="#l131.11"></a><span id="l131.11">     isPending: true,</span>
<a href="#l131.12"></a><span id="l131.12" class="difflineminus">-    cancel: function() {</span>
<a href="#l131.13"></a><span id="l131.13" class="difflineplus">+    cancel() {</span>
<a href="#l131.14"></a><span id="l131.14">       this.cancelCalled = true;</span>
<a href="#l131.15"></a><span id="l131.15">       return true;</span>
<a href="#l131.16"></a><span id="l131.16">     },</span>
<a href="#l131.17"></a><span id="l131.17">   };</span>
<a href="#l131.18"></a><span id="l131.18"> </span>
<a href="#l131.19"></a><span id="l131.19">   group.add(pendingOp1);</span>
<a href="#l131.20"></a><span id="l131.20">   ok(!group.isEmpty);</span>
<a href="#l131.21"></a><span id="l131.21">   equal(group.isPending, true);</span>
<a href="#l131.22"></a><span id="l131.22"> </span>
<a href="#l131.23"></a><span id="l131.23">   let pendingOp2 = {</span>
<a href="#l131.24"></a><span id="l131.24">     id: 2,</span>
<a href="#l131.25"></a><span id="l131.25">     isPending: true,</span>
<a href="#l131.26"></a><span id="l131.26" class="difflineminus">-    cancel: function() {</span>
<a href="#l131.27"></a><span id="l131.27" class="difflineplus">+    cancel() {</span>
<a href="#l131.28"></a><span id="l131.28">       this.cancelCalled = true;</span>
<a href="#l131.29"></a><span id="l131.29">       return true;</span>
<a href="#l131.30"></a><span id="l131.30">     },</span>
<a href="#l131.31"></a><span id="l131.31">   };</span>
<a href="#l131.32"></a><span id="l131.32"> </span>
<a href="#l131.33"></a><span id="l131.33">   group.add(pendingOp2);</span>
<a href="#l131.34"></a><span id="l131.34">   group.remove(pendingOp1);</span>
<a href="#l131.35"></a><span id="l131.35">   ok(!group.isEmpty);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l132.1"></a><span id="l132.1" class="difflineminus">--- a/calendar/test/unit/test_webcal.js</span>
<a href="#l132.2"></a><span id="l132.2" class="difflineplus">+++ b/calendar/test/unit/test_webcal.js</span>
<a href="#l132.3"></a><span id="l132.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l132.4"></a><span id="l132.4"> </span>
<a href="#l132.5"></a><span id="l132.5"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l132.6"></a><span id="l132.6"> var { NetUtil } = ChromeUtils.import(&quot;resource://gre/modules/NetUtil.jsm&quot;);</span>
<a href="#l132.7"></a><span id="l132.7"> var { HttpServer } = ChromeUtils.import(&quot;resource://testing-common/httpd.js&quot;);</span>
<a href="#l132.8"></a><span id="l132.8"> </span>
<a href="#l132.9"></a><span id="l132.9"> function run_test() {</span>
<a href="#l132.10"></a><span id="l132.10">   let httpserv = new HttpServer();</span>
<a href="#l132.11"></a><span id="l132.11">   httpserv.registerPrefixHandler(&quot;/&quot;, {</span>
<a href="#l132.12"></a><span id="l132.12" class="difflineminus">-    handle: function(request, response) {</span>
<a href="#l132.13"></a><span id="l132.13" class="difflineplus">+    handle(request, response) {</span>
<a href="#l132.14"></a><span id="l132.14">       response.setStatusLine(request.httpVersion, 200, &quot;OK&quot;);</span>
<a href="#l132.15"></a><span id="l132.15">       equal(request.path, &quot;/test_webcal&quot;);</span>
<a href="#l132.16"></a><span id="l132.16">     },</span>
<a href="#l132.17"></a><span id="l132.17">   });</span>
<a href="#l132.18"></a><span id="l132.18">   httpserv.start(-1);</span>
<a href="#l132.19"></a><span id="l132.19"> </span>
<a href="#l132.20"></a><span id="l132.20">   let baseUri = &quot;://localhost:&quot; + httpserv.identity.primaryPort + &quot;/test_webcal&quot;;</span>
<a href="#l132.21"></a><span id="l132.21">   add_test(check_webcal_uri.bind(null, &quot;webcal&quot; + baseUri));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l133.1"></a><span id="l133.1" class="difflineminus">--- a/mailnews/extensions/newsblog/.eslintrc.js</span>
<a href="#l133.2"></a><span id="l133.2" class="difflineplus">+++ b/mailnews/extensions/newsblog/.eslintrc.js</span>
<a href="#l133.3"></a><span id="l133.3" class="difflineat">@@ -16,19 +16,16 @@ module.exports = {</span>
<a href="#l133.4"></a><span id="l133.4">     gDBView: true,</span>
<a href="#l133.5"></a><span id="l133.5">     gMessageNotificationBar: true,</span>
<a href="#l133.6"></a><span id="l133.6">     getBrowser: true,</span>
<a href="#l133.7"></a><span id="l133.7">     onCheckItem: true,</span>
<a href="#l133.8"></a><span id="l133.8">     openContentTab: true,</span>
<a href="#l133.9"></a><span id="l133.9">   },</span>
<a href="#l133.10"></a><span id="l133.10"> </span>
<a href="#l133.11"></a><span id="l133.11">   rules: {</span>
<a href="#l133.12"></a><span id="l133.12" class="difflineminus">-    // Warn about cyclomatic complexity in functions.</span>
<a href="#l133.13"></a><span id="l133.13" class="difflineminus">-    complexity: [&quot;error&quot;, 80],</span>
<a href="#l133.14"></a><span id="l133.14" class="difflineminus">-</span>
<a href="#l133.15"></a><span id="l133.15">     // Enforce valid JSDoc comments.</span>
<a href="#l133.16"></a><span id="l133.16">     &quot;valid-jsdoc&quot;: [</span>
<a href="#l133.17"></a><span id="l133.17">       &quot;error&quot;,</span>
<a href="#l133.18"></a><span id="l133.18">       {</span>
<a href="#l133.19"></a><span id="l133.19">         prefer: { return: &quot;returns&quot; },</span>
<a href="#l133.20"></a><span id="l133.20">         preferType: {</span>
<a href="#l133.21"></a><span id="l133.21">           boolean: &quot;Boolean&quot;,</span>
<a href="#l133.22"></a><span id="l133.22">           string: &quot;String&quot;,</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

