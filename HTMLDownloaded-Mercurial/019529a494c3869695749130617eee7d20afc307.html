<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26637:019529a494c3869695749130617eee7d20afc307</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 019529a494c3869695749130617eee7d20afc307" />
<meta property="og:url" content="/comm-central/rev/019529a494c3869695749130617eee7d20afc307" />
<meta property="og:description" content="Bug 1546364 - Reformat to Google coding style in mailnews/base/src (part 3). rs=reformat" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 019529a494c3869695749130617eee7d20afc307 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/019529a494c3869695749130617eee7d20afc307">shortlog</a> |
<a href="/comm-central/log/019529a494c3869695749130617eee7d20afc307">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/019529a494c3869695749130617eee7d20afc307">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/019529a494c3869695749130617eee7d20afc307">files</a> |
changeset |
<a href="/comm-central/raw-rev/019529a494c3869695749130617eee7d20afc307">raw</a>  | <a href="/comm-central/archive/019529a494c3869695749130617eee7d20afc307.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 3). rs=reformat
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 18 May 2019 22:05:01 +0200</td></tr>

<tr>
 <td>changeset 26637</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/019529a494c3869695749130617eee7d20afc307">019529a494c3869695749130617eee7d20afc307</a></td>
</tr>



<tr>
<td>parent 26636</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/fa6c146ca1a00f9687b396ed4c36c9ba90c7fe3c">fa6c146ca1a00f9687b396ed4c36c9ba90c7fe3c</a>
</td>
</tr>

<tr>
<td>child 26638</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/865b4199ce94e7359748c33b2b368f85fed9734b">865b4199ce94e7359748c33b2b368f85fed9734b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=019529a494c3869695749130617eee7d20afc307">15933</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 18 May 2019 20:10:55 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@019529a494c3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=019529a494c3869695749130617eee7d20afc307">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=019529a494c3869695749130617eee7d20afc307&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019529a494c3869695749130617eee7d20afc307&newProject=comm-central&newRevision=fa6c146ca1a00f9687b396ed4c36c9ba90c7fe3c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019529a494c3869695749130617eee7d20afc307&newProject=comm-central&newRevision=fa6c146ca1a00f9687b396ed4c36c9ba90c7fe3c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=019529a494c3869695749130617eee7d20afc307&newProject=comm-central&newRevision=fa6c146ca1a00f9687b396ed4c36c9ba90c7fe3c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28reformat%29&revcount=50">reformat</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">1546364</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1546364">Bug 1546364</a> - Reformat to Google coding style in mailnews/base/src (part 3). rs=reformat
# ignore-this-changeset</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">mailnews/base/src/nsMsgDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">file</a> |
<a href="/comm-central/annotate/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">annotate</a> |
<a href="/comm-central/diff/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">diff</a> |
<a href="/comm-central/comparison/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">comparison</a> |
<a href="/comm-central/log/019529a494c3869695749130617eee7d20afc307/mailnews/base/src/nsMsgDBView.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -46,66 +46,64 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIAbCard.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;mozilla/Services.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;mozilla/Attributes.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;mozilla/dom/DataTransfer.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;mozilla/mailnews/MimeHeaderParser.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsTArray.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> using namespace mozilla::mailnews;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-nsrefcnt nsMsgDBView::gInstanceCount  = 0;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-char16_t * nsMsgDBView::kHighestPriorityString = nullptr;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-char16_t * nsMsgDBView::kHighPriorityString = nullptr;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-char16_t * nsMsgDBView::kLowestPriorityString = nullptr;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-char16_t * nsMsgDBView::kLowPriorityString = nullptr;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineminus">-char16_t * nsMsgDBView::kNormalPriorityString = nullptr;</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineminus">-char16_t * nsMsgDBView::kReadString = nullptr;</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-char16_t * nsMsgDBView::kRepliedString = nullptr;</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineminus">-char16_t * nsMsgDBView::kForwardedString = nullptr;</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineminus">-char16_t * nsMsgDBView::kNewString = nullptr;</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineminus">-</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatDefault = mozilla::kDateFormatShort;</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatThisWeek = mozilla::kDateFormatShort;</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-mozilla::nsDateFormatSelector  nsMsgDBView::m_dateFormatToday = mozilla::kDateFormatNone;</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+nsrefcnt nsMsgDBView::gInstanceCount = 0;</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+char16_t *nsMsgDBView::kHighestPriorityString = nullptr;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+char16_t *nsMsgDBView::kHighPriorityString = nullptr;</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+char16_t *nsMsgDBView::kLowestPriorityString = nullptr;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+char16_t *nsMsgDBView::kLowPriorityString = nullptr;</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+char16_t *nsMsgDBView::kNormalPriorityString = nullptr;</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+char16_t *nsMsgDBView::kReadString = nullptr;</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+char16_t *nsMsgDBView::kRepliedString = nullptr;</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+char16_t *nsMsgDBView::kForwardedString = nullptr;</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+char16_t *nsMsgDBView::kNewString = nullptr;</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+mozilla::nsDateFormatSelector nsMsgDBView::m_dateFormatDefault =</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    mozilla::kDateFormatShort;</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+mozilla::nsDateFormatSelector nsMsgDBView::m_dateFormatThisWeek =</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+    mozilla::kDateFormatShort;</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+mozilla::nsDateFormatSelector nsMsgDBView::m_dateFormatToday =</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+    mozilla::kDateFormatNone;</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46"> static const uint32_t kMaxNumSortColumns = 2;</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-static void GetCachedName(const nsCString&amp; unparsedString,</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineminus">-                          int32_t displayVersion,</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-                          nsACString&amp; cachedName);</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineminus">-</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineminus">-static void UpdateCachedName(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineminus">-                             const char *header_field,</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineminus">-                             const nsAString&amp; newName);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+static void GetCachedName(const nsCString &amp;unparsedString,</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+                          int32_t displayVersion, nsACString &amp;cachedName);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+static void UpdateCachedName(nsIMsgDBHdr *aHdr, const char *header_field,</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+                             const nsAString &amp;newName);</span>
<a href="#l1.60"></a><span id="l1.60"> </span>
<a href="#l1.61"></a><span id="l1.61"> // This is passed into NS_QuickSort as custom data.</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineminus">-class viewSortInfo</span>
<a href="#l1.63"></a><span id="l1.63" class="difflineminus">-{</span>
<a href="#l1.64"></a><span id="l1.64" class="difflineminus">-public:</span>
<a href="#l1.65"></a><span id="l1.65" class="difflineplus">+class viewSortInfo {</span>
<a href="#l1.66"></a><span id="l1.66" class="difflineplus">+ public:</span>
<a href="#l1.67"></a><span id="l1.67">   nsMsgDBView *view;</span>
<a href="#l1.68"></a><span id="l1.68">   nsIMsgDatabase *db;</span>
<a href="#l1.69"></a><span id="l1.69">   bool isSecondarySort;</span>
<a href="#l1.70"></a><span id="l1.70">   bool ascendingSort;</span>
<a href="#l1.71"></a><span id="l1.71"> };</span>
<a href="#l1.72"></a><span id="l1.72"> </span>
<a href="#l1.73"></a><span id="l1.73" class="difflineminus">-</span>
<a href="#l1.74"></a><span id="l1.74"> NS_IMPL_ADDREF(nsMsgDBView)</span>
<a href="#l1.75"></a><span id="l1.75"> NS_IMPL_RELEASE(nsMsgDBView)</span>
<a href="#l1.76"></a><span id="l1.76"> </span>
<a href="#l1.77"></a><span id="l1.77"> NS_INTERFACE_MAP_BEGIN(nsMsgDBView)</span>
<a href="#l1.78"></a><span id="l1.78" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMsgDBView)</span>
<a href="#l1.79"></a><span id="l1.79" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIMsgDBView)</span>
<a href="#l1.80"></a><span id="l1.80" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIDBChangeListener)</span>
<a href="#l1.81"></a><span id="l1.81" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l1.82"></a><span id="l1.82" class="difflineminus">-   NS_INTERFACE_MAP_ENTRY(nsIJunkMailClassificationListener)</span>
<a href="#l1.83"></a><span id="l1.83" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY_AMBIGUOUS(nsISupports, nsIMsgDBView)</span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIMsgDBView)</span>
<a href="#l1.85"></a><span id="l1.85" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIDBChangeListener)</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsITreeView)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineplus">+  NS_INTERFACE_MAP_ENTRY(nsIJunkMailClassificationListener)</span>
<a href="#l1.88"></a><span id="l1.88"> NS_INTERFACE_MAP_END</span>
<a href="#l1.89"></a><span id="l1.89"> </span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-nsMsgDBView::nsMsgDBView()</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineminus">-{</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+nsMsgDBView::nsMsgDBView() {</span>
<a href="#l1.93"></a><span id="l1.93">   // Member initializers and constructor code.</span>
<a href="#l1.94"></a><span id="l1.94">   m_sortValid = false;</span>
<a href="#l1.95"></a><span id="l1.95">   m_checkedCustomColumns = false;</span>
<a href="#l1.96"></a><span id="l1.96">   m_sortOrder = nsMsgViewSortOrder::none;</span>
<a href="#l1.97"></a><span id="l1.97">   m_viewFlags = nsMsgViewFlagsType::kNone;</span>
<a href="#l1.98"></a><span id="l1.98">   m_secondarySort = nsMsgViewSortType::byId;</span>
<a href="#l1.99"></a><span id="l1.99">   m_secondarySortOrder = nsMsgViewSortOrder::ascending;</span>
<a href="#l1.100"></a><span id="l1.100">   m_cachedMsgKey = nsMsgKey_None;</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineat">@@ -132,291 +130,254 @@ nsMsgDBView::nsMsgDBView()</span>
<a href="#l1.102"></a><span id="l1.102">   // mCommandsNeedDisablingBecauseOfSelection - A boolean that tell us if we</span>
<a href="#l1.103"></a><span id="l1.103">   // needed to disable commands because of what's selected. If we're offline</span>
<a href="#l1.104"></a><span id="l1.104">   // w/o a downloaded msg selected, or a dummy message was selected.</span>
<a href="#l1.105"></a><span id="l1.105">   mCommandsNeedDisablingBecauseOfSelection = false;</span>
<a href="#l1.106"></a><span id="l1.106">   mRemovingRow = false;</span>
<a href="#l1.107"></a><span id="l1.107">   m_saveRestoreSelectionDepth = 0;</span>
<a href="#l1.108"></a><span id="l1.108">   mRecentlyDeletedArrayIndex = 0;</span>
<a href="#l1.109"></a><span id="l1.109">   // Initialize any static atoms or unicode strings.</span>
<a href="#l1.110"></a><span id="l1.110" class="difflineminus">-  if (gInstanceCount == 0)</span>
<a href="#l1.111"></a><span id="l1.111" class="difflineminus">-  {</span>
<a href="#l1.112"></a><span id="l1.112" class="difflineplus">+  if (gInstanceCount == 0) {</span>
<a href="#l1.113"></a><span id="l1.113">     InitializeLiterals();</span>
<a href="#l1.114"></a><span id="l1.114">     InitDisplayFormats();</span>
<a href="#l1.115"></a><span id="l1.115">   }</span>
<a href="#l1.116"></a><span id="l1.116"> </span>
<a href="#l1.117"></a><span id="l1.117">   InitLabelStrings();</span>
<a href="#l1.118"></a><span id="l1.118">   gInstanceCount++;</span>
<a href="#l1.119"></a><span id="l1.119"> }</span>
<a href="#l1.120"></a><span id="l1.120"> </span>
<a href="#l1.121"></a><span id="l1.121" class="difflineminus">-void</span>
<a href="#l1.122"></a><span id="l1.122" class="difflineminus">-nsMsgDBView::InitializeLiterals()</span>
<a href="#l1.123"></a><span id="l1.123" class="difflineminus">-{</span>
<a href="#l1.124"></a><span id="l1.124" class="difflineplus">+void nsMsgDBView::InitializeLiterals() {</span>
<a href="#l1.125"></a><span id="l1.125">   // Priority strings.</span>
<a href="#l1.126"></a><span id="l1.126">   kHighestPriorityString = GetString(u&quot;priorityHighest&quot;);</span>
<a href="#l1.127"></a><span id="l1.127">   kHighPriorityString = GetString(u&quot;priorityHigh&quot;);</span>
<a href="#l1.128"></a><span id="l1.128">   kLowestPriorityString = GetString(u&quot;priorityLowest&quot;);</span>
<a href="#l1.129"></a><span id="l1.129">   kLowPriorityString = GetString(u&quot;priorityLow&quot;);</span>
<a href="#l1.130"></a><span id="l1.130">   kNormalPriorityString = GetString(u&quot;priorityNormal&quot;);</span>
<a href="#l1.131"></a><span id="l1.131"> </span>
<a href="#l1.132"></a><span id="l1.132">   kReadString = GetString(u&quot;read&quot;);</span>
<a href="#l1.133"></a><span id="l1.133">   kRepliedString = GetString(u&quot;replied&quot;);</span>
<a href="#l1.134"></a><span id="l1.134">   kForwardedString = GetString(u&quot;forwarded&quot;);</span>
<a href="#l1.135"></a><span id="l1.135">   kNewString = GetString(u&quot;new&quot;);</span>
<a href="#l1.136"></a><span id="l1.136"> }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-nsMsgDBView::~nsMsgDBView()</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-{</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-  if (m_db)</span>
<a href="#l1.141"></a><span id="l1.141" class="difflineminus">-    m_db-&gt;RemoveListener(this);</span>
<a href="#l1.142"></a><span id="l1.142" class="difflineplus">+nsMsgDBView::~nsMsgDBView() {</span>
<a href="#l1.143"></a><span id="l1.143" class="difflineplus">+  if (m_db) m_db-&gt;RemoveListener(this);</span>
<a href="#l1.144"></a><span id="l1.144"> </span>
<a href="#l1.145"></a><span id="l1.145">   gInstanceCount--;</span>
<a href="#l1.146"></a><span id="l1.146" class="difflineminus">-  if (gInstanceCount &lt;= 0)</span>
<a href="#l1.147"></a><span id="l1.147" class="difflineminus">-  {</span>
<a href="#l1.148"></a><span id="l1.148" class="difflineplus">+  if (gInstanceCount &lt;= 0) {</span>
<a href="#l1.149"></a><span id="l1.149">     free(kHighestPriorityString);</span>
<a href="#l1.150"></a><span id="l1.150">     free(kHighPriorityString);</span>
<a href="#l1.151"></a><span id="l1.151">     free(kLowestPriorityString);</span>
<a href="#l1.152"></a><span id="l1.152">     free(kLowPriorityString);</span>
<a href="#l1.153"></a><span id="l1.153">     free(kNormalPriorityString);</span>
<a href="#l1.154"></a><span id="l1.154"> </span>
<a href="#l1.155"></a><span id="l1.155">     free(kReadString);</span>
<a href="#l1.156"></a><span id="l1.156">     free(kRepliedString);</span>
<a href="#l1.157"></a><span id="l1.157">     free(kForwardedString);</span>
<a href="#l1.158"></a><span id="l1.158">     free(kNewString);</span>
<a href="#l1.159"></a><span id="l1.159">   }</span>
<a href="#l1.160"></a><span id="l1.160"> }</span>
<a href="#l1.161"></a><span id="l1.161"> </span>
<a href="#l1.162"></a><span id="l1.162" class="difflineminus">-nsresult</span>
<a href="#l1.163"></a><span id="l1.163" class="difflineminus">-nsMsgDBView::InitLabelStrings()</span>
<a href="#l1.164"></a><span id="l1.164" class="difflineminus">-{</span>
<a href="#l1.165"></a><span id="l1.165" class="difflineplus">+nsresult nsMsgDBView::InitLabelStrings() {</span>
<a href="#l1.166"></a><span id="l1.166">   nsresult rv = NS_OK;</span>
<a href="#l1.167"></a><span id="l1.167">   nsCString prefString;</span>
<a href="#l1.168"></a><span id="l1.168"> </span>
<a href="#l1.169"></a><span id="l1.169" class="difflineminus">-  for(int32_t i = 0; i &lt; PREF_LABELS_MAX; i++)</span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-  {</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+  for (int32_t i = 0; i &lt; PREF_LABELS_MAX; i++) {</span>
<a href="#l1.172"></a><span id="l1.172">     prefString.Assign(PREF_LABELS_DESCRIPTION);</span>
<a href="#l1.173"></a><span id="l1.173">     prefString.AppendInt(i + 1);</span>
<a href="#l1.174"></a><span id="l1.174">     rv = GetPrefLocalizedString(prefString.get(), mLabelPrefDescriptions[i]);</span>
<a href="#l1.175"></a><span id="l1.175">   }</span>
<a href="#l1.176"></a><span id="l1.176">   return rv;</span>
<a href="#l1.177"></a><span id="l1.177"> }</span>
<a href="#l1.178"></a><span id="l1.178"> </span>
<a href="#l1.179"></a><span id="l1.179"> // Helper function used to fetch strings from the messenger string bundle</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineminus">-char16_t * nsMsgDBView::GetString(const char16_t *aStringName)</span>
<a href="#l1.181"></a><span id="l1.181" class="difflineminus">-{</span>
<a href="#l1.182"></a><span id="l1.182" class="difflineminus">-  nsresult    res = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.183"></a><span id="l1.183" class="difflineplus">+char16_t *nsMsgDBView::GetString(const char16_t *aStringName) {</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineplus">+  nsresult res = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.185"></a><span id="l1.185">   nsAutoString str;</span>
<a href="#l1.186"></a><span id="l1.186"> </span>
<a href="#l1.187"></a><span id="l1.187" class="difflineminus">-  if (!mMessengerStringBundle)</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-  {</span>
<a href="#l1.189"></a><span id="l1.189" class="difflineplus">+  if (!mMessengerStringBundle) {</span>
<a href="#l1.190"></a><span id="l1.190">     static const char propertyURL[] = MESSENGER_STRING_URL;</span>
<a href="#l1.191"></a><span id="l1.191">     nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-      mozilla::services::GetStringBundleService();</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+        mozilla::services::GetStringBundleService();</span>
<a href="#l1.194"></a><span id="l1.194"> </span>
<a href="#l1.195"></a><span id="l1.195">     if (sBundleService)</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-      res = sBundleService-&gt;CreateBundle(propertyURL,</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-                                         getter_AddRefs(mMessengerStringBundle));</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineplus">+      res = sBundleService-&gt;CreateBundle(</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineplus">+          propertyURL, getter_AddRefs(mMessengerStringBundle));</span>
<a href="#l1.200"></a><span id="l1.200">   }</span>
<a href="#l1.201"></a><span id="l1.201"> </span>
<a href="#l1.202"></a><span id="l1.202">   if (mMessengerStringBundle)</span>
<a href="#l1.203"></a><span id="l1.203">     res = mMessengerStringBundle-&gt;GetStringFromName(</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineminus">-                                    NS_ConvertUTF16toUTF8(aStringName).get(), str);</span>
<a href="#l1.205"></a><span id="l1.205" class="difflineplus">+        NS_ConvertUTF16toUTF8(aStringName).get(), str);</span>
<a href="#l1.206"></a><span id="l1.206"> </span>
<a href="#l1.207"></a><span id="l1.207">   if (NS_SUCCEEDED(res))</span>
<a href="#l1.208"></a><span id="l1.208">     return ToNewUnicode(str);</span>
<a href="#l1.209"></a><span id="l1.209">   else</span>
<a href="#l1.210"></a><span id="l1.210">     return NS_xstrdup(aStringName);</span>
<a href="#l1.211"></a><span id="l1.211"> }</span>
<a href="#l1.212"></a><span id="l1.212"> </span>
<a href="#l1.213"></a><span id="l1.213"> // Helper function used to fetch localized strings from the prefs</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineminus">-nsresult</span>
<a href="#l1.215"></a><span id="l1.215" class="difflineminus">-nsMsgDBView::GetPrefLocalizedString(const char *aPrefName,</span>
<a href="#l1.216"></a><span id="l1.216" class="difflineminus">-                                    nsString&amp; aResult)</span>
<a href="#l1.217"></a><span id="l1.217" class="difflineminus">-{</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineplus">+nsresult nsMsgDBView::GetPrefLocalizedString(const char *aPrefName,</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineplus">+                                             nsString &amp;aResult) {</span>
<a href="#l1.220"></a><span id="l1.220">   nsresult rv = NS_OK;</span>
<a href="#l1.221"></a><span id="l1.221">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l1.222"></a><span id="l1.222">   nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l1.223"></a><span id="l1.223">   nsString ucsval;</span>
<a href="#l1.224"></a><span id="l1.224"> </span>
<a href="#l1.225"></a><span id="l1.225">   prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.226"></a><span id="l1.226">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.227"></a><span id="l1.227"> </span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-  rv = prefBranch-&gt;GetComplexValue(aPrefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+  rv = prefBranch-&gt;GetComplexValue(</span>
<a href="#l1.230"></a><span id="l1.230" class="difflineplus">+      aPrefName, NS_GET_IID(nsIPrefLocalizedString), getter_AddRefs(pls));</span>
<a href="#l1.231"></a><span id="l1.231">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.232"></a><span id="l1.232">   pls-&gt;ToString(getter_Copies(ucsval));</span>
<a href="#l1.233"></a><span id="l1.233">   aResult = ucsval.get();</span>
<a href="#l1.234"></a><span id="l1.234">   return rv;</span>
<a href="#l1.235"></a><span id="l1.235"> }</span>
<a href="#l1.236"></a><span id="l1.236"> </span>
<a href="#l1.237"></a><span id="l1.237" class="difflineminus">-nsresult</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineminus">-nsMsgDBView::AppendKeywordProperties(const nsACString&amp; keywords,</span>
<a href="#l1.239"></a><span id="l1.239" class="difflineminus">-                                     nsAString&amp; properties)</span>
<a href="#l1.240"></a><span id="l1.240" class="difflineminus">-{</span>
<a href="#l1.241"></a><span id="l1.241" class="difflineplus">+nsresult nsMsgDBView::AppendKeywordProperties(const nsACString &amp;keywords,</span>
<a href="#l1.242"></a><span id="l1.242" class="difflineplus">+                                              nsAString &amp;properties) {</span>
<a href="#l1.243"></a><span id="l1.243">   // Get the top most keyword's CSS selector and append that as a property.</span>
<a href="#l1.244"></a><span id="l1.244">   nsresult rv;</span>
<a href="#l1.245"></a><span id="l1.245" class="difflineminus">-  if (!mTagService)</span>
<a href="#l1.246"></a><span id="l1.246" class="difflineminus">-  {</span>
<a href="#l1.247"></a><span id="l1.247" class="difflineplus">+  if (!mTagService) {</span>
<a href="#l1.248"></a><span id="l1.248">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.249"></a><span id="l1.249">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.250"></a><span id="l1.250">   }</span>
<a href="#l1.251"></a><span id="l1.251"> </span>
<a href="#l1.252"></a><span id="l1.252">   nsCString topKey;</span>
<a href="#l1.253"></a><span id="l1.253">   rv = mTagService-&gt;GetTopKey(keywords, topKey);</span>
<a href="#l1.254"></a><span id="l1.254">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.255"></a><span id="l1.255" class="difflineminus">-  if (topKey.IsEmpty())</span>
<a href="#l1.256"></a><span id="l1.256" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.257"></a><span id="l1.257" class="difflineplus">+  if (topKey.IsEmpty()) return NS_OK;</span>
<a href="#l1.258"></a><span id="l1.258"> </span>
<a href="#l1.259"></a><span id="l1.259">   nsString selector;</span>
<a href="#l1.260"></a><span id="l1.260">   rv = mTagService-&gt;GetSelectorForKey(topKey, selector);</span>
<a href="#l1.261"></a><span id="l1.261" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l1.262"></a><span id="l1.262" class="difflineminus">-  {</span>
<a href="#l1.263"></a><span id="l1.263" class="difflineplus">+  if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.264"></a><span id="l1.264">     properties.Append(' ');</span>
<a href="#l1.265"></a><span id="l1.265">     properties.Append(selector);</span>
<a href="#l1.266"></a><span id="l1.266">   }</span>
<a href="#l1.267"></a><span id="l1.267">   return rv;</span>
<a href="#l1.268"></a><span id="l1.268"> }</span>
<a href="#l1.269"></a><span id="l1.269"> </span>
<a href="#l1.270"></a><span id="l1.270"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.271"></a><span id="l1.271"> // nsITreeView Implementation Methods (and helper methods)</span>
<a href="#l1.272"></a><span id="l1.272"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.273"></a><span id="l1.273"> </span>
<a href="#l1.274"></a><span id="l1.274" class="difflineminus">-static nsresult</span>
<a href="#l1.275"></a><span id="l1.275" class="difflineminus">-GetDisplayNameInAddressBook(const nsACString&amp; emailAddress,</span>
<a href="#l1.276"></a><span id="l1.276" class="difflineminus">-                            nsAString&amp; displayName)</span>
<a href="#l1.277"></a><span id="l1.277" class="difflineminus">-{</span>
<a href="#l1.278"></a><span id="l1.278" class="difflineplus">+static nsresult GetDisplayNameInAddressBook(const nsACString &amp;emailAddress,</span>
<a href="#l1.279"></a><span id="l1.279" class="difflineplus">+                                            nsAString &amp;displayName) {</span>
<a href="#l1.280"></a><span id="l1.280">   nsresult rv;</span>
<a href="#l1.281"></a><span id="l1.281" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt; abManager(do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.282"></a><span id="l1.282" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l1.283"></a><span id="l1.283" class="difflineplus">+      do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.284"></a><span id="l1.284">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.287"></a><span id="l1.287">   rv = abManager-&gt;GetDirectories(getter_AddRefs(enumerator));</span>
<a href="#l1.288"></a><span id="l1.288">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.289"></a><span id="l1.289"> </span>
<a href="#l1.290"></a><span id="l1.290">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l1.291"></a><span id="l1.291">   nsCOMPtr&lt;nsIAbDirectory&gt; directory;</span>
<a href="#l1.292"></a><span id="l1.292">   nsCOMPtr&lt;nsIAbCard&gt; cardForAddress;</span>
<a href="#l1.293"></a><span id="l1.293">   bool hasMore;</span>
<a href="#l1.294"></a><span id="l1.294"> </span>
<a href="#l1.295"></a><span id="l1.295">   // Scan the addressbook to find out the card of the email address</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-         hasMore &amp;&amp;</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-         !cardForAddress)</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineminus">-  {</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+  while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+         !cardForAddress) {</span>
<a href="#l1.302"></a><span id="l1.302">     rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.303"></a><span id="l1.303">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.304"></a><span id="l1.304">     directory = do_QueryInterface(supports);</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineminus">-    if (directory)</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineminus">-    {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+    if (directory) {</span>
<a href="#l1.308"></a><span id="l1.308">       rv = directory-&gt;CardForEmailAddress(emailAddress,</span>
<a href="#l1.309"></a><span id="l1.309">                                           getter_AddRefs(cardForAddress));</span>
<a href="#l1.310"></a><span id="l1.310">       // The card is found,so stop looping.</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; cardForAddress)</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-        break;</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; cardForAddress) break;</span>
<a href="#l1.314"></a><span id="l1.314">     }</span>
<a href="#l1.315"></a><span id="l1.315">   }</span>
<a href="#l1.316"></a><span id="l1.316"> </span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-  if (cardForAddress)</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-  {</span>
<a href="#l1.319"></a><span id="l1.319" class="difflineplus">+  if (cardForAddress) {</span>
<a href="#l1.320"></a><span id="l1.320">     bool preferDisplayName = true;</span>
<a href="#l1.321"></a><span id="l1.321" class="difflineminus">-    cardForAddress-&gt;GetPropertyAsBool(&quot;PreferDisplayName&quot;,&amp;preferDisplayName);</span>
<a href="#l1.322"></a><span id="l1.322" class="difflineminus">-</span>
<a href="#l1.323"></a><span id="l1.323" class="difflineminus">-    if (preferDisplayName)</span>
<a href="#l1.324"></a><span id="l1.324" class="difflineminus">-      rv = cardForAddress-&gt;GetDisplayName(displayName);</span>
<a href="#l1.325"></a><span id="l1.325" class="difflineplus">+    cardForAddress-&gt;GetPropertyAsBool(&quot;PreferDisplayName&quot;, &amp;preferDisplayName);</span>
<a href="#l1.326"></a><span id="l1.326" class="difflineplus">+</span>
<a href="#l1.327"></a><span id="l1.327" class="difflineplus">+    if (preferDisplayName) rv = cardForAddress-&gt;GetDisplayName(displayName);</span>
<a href="#l1.328"></a><span id="l1.328">   }</span>
<a href="#l1.329"></a><span id="l1.329"> </span>
<a href="#l1.330"></a><span id="l1.330">   return rv;</span>
<a href="#l1.331"></a><span id="l1.331"> }</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333"> /*</span>
<a href="#l1.334"></a><span id="l1.334">  * The unparsedString has following format:</span>
<a href="#l1.335"></a><span id="l1.335">  * &quot;version|displayname&quot;</span>
<a href="#l1.336"></a><span id="l1.336">  */</span>
<a href="#l1.337"></a><span id="l1.337" class="difflineminus">-static void</span>
<a href="#l1.338"></a><span id="l1.338" class="difflineminus">-GetCachedName(const nsCString&amp; unparsedString,</span>
<a href="#l1.339"></a><span id="l1.339" class="difflineminus">-              int32_t displayVersion,</span>
<a href="#l1.340"></a><span id="l1.340" class="difflineminus">-              nsACString&amp; cachedName)</span>
<a href="#l1.341"></a><span id="l1.341" class="difflineminus">-{</span>
<a href="#l1.342"></a><span id="l1.342" class="difflineplus">+static void GetCachedName(const nsCString &amp;unparsedString,</span>
<a href="#l1.343"></a><span id="l1.343" class="difflineplus">+                          int32_t displayVersion, nsACString &amp;cachedName) {</span>
<a href="#l1.344"></a><span id="l1.344">   nsresult err;</span>
<a href="#l1.345"></a><span id="l1.345"> </span>
<a href="#l1.346"></a><span id="l1.346">   // Get version #.</span>
<a href="#l1.347"></a><span id="l1.347">   int32_t cachedVersion = unparsedString.ToInteger(&amp;err);</span>
<a href="#l1.348"></a><span id="l1.348" class="difflineminus">-  if (cachedVersion != displayVersion)</span>
<a href="#l1.349"></a><span id="l1.349" class="difflineminus">-    return;</span>
<a href="#l1.350"></a><span id="l1.350" class="difflineplus">+  if (cachedVersion != displayVersion) return;</span>
<a href="#l1.351"></a><span id="l1.351"> </span>
<a href="#l1.352"></a><span id="l1.352">   // Get cached name.</span>
<a href="#l1.353"></a><span id="l1.353">   int32_t pos = unparsedString.FindChar('|');</span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-  if (pos != kNotFound)</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-    cachedName = Substring(unparsedString, pos + 1);</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-}</span>
<a href="#l1.357"></a><span id="l1.357" class="difflineminus">-</span>
<a href="#l1.358"></a><span id="l1.358" class="difflineminus">-static void</span>
<a href="#l1.359"></a><span id="l1.359" class="difflineminus">-UpdateCachedName(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.360"></a><span id="l1.360" class="difflineminus">-                 const char *header_field,</span>
<a href="#l1.361"></a><span id="l1.361" class="difflineminus">-                 const nsAString&amp; newName)</span>
<a href="#l1.362"></a><span id="l1.362" class="difflineminus">-{</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+  if (pos != kNotFound) cachedName = Substring(unparsedString, pos + 1);</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+}</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+static void UpdateCachedName(nsIMsgDBHdr *aHdr, const char *header_field,</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+                             const nsAString &amp;newName) {</span>
<a href="#l1.368"></a><span id="l1.368">   nsCString newCachedName;</span>
<a href="#l1.369"></a><span id="l1.369">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.370"></a><span id="l1.370">   int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.371"></a><span id="l1.371"> </span>
<a href="#l1.372"></a><span id="l1.372">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.373"></a><span id="l1.373"> </span>
<a href="#l1.374"></a><span id="l1.374">   // Save version number.</span>
<a href="#l1.375"></a><span id="l1.375">   newCachedName.AppendInt(currentDisplayNameVersion);</span>
<a href="#l1.376"></a><span id="l1.376">   newCachedName.Append('|');</span>
<a href="#l1.377"></a><span id="l1.377"> </span>
<a href="#l1.378"></a><span id="l1.378">   // Save name.</span>
<a href="#l1.379"></a><span id="l1.379">   newCachedName.Append(NS_ConvertUTF16toUTF8(newName));</span>
<a href="#l1.380"></a><span id="l1.380"> </span>
<a href="#l1.381"></a><span id="l1.381" class="difflineminus">-  aHdr-&gt;SetStringProperty(header_field,newCachedName.get());</span>
<a href="#l1.382"></a><span id="l1.382" class="difflineminus">-}</span>
<a href="#l1.383"></a><span id="l1.383" class="difflineminus">-</span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-nsresult</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineminus">-nsMsgDBView::FetchAuthor(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.386"></a><span id="l1.386" class="difflineminus">-                         nsAString &amp;aSenderString)</span>
<a href="#l1.387"></a><span id="l1.387" class="difflineminus">-{</span>
<a href="#l1.388"></a><span id="l1.388" class="difflineplus">+  aHdr-&gt;SetStringProperty(header_field, newCachedName.get());</span>
<a href="#l1.389"></a><span id="l1.389" class="difflineplus">+}</span>
<a href="#l1.390"></a><span id="l1.390" class="difflineplus">+</span>
<a href="#l1.391"></a><span id="l1.391" class="difflineplus">+nsresult nsMsgDBView::FetchAuthor(nsIMsgDBHdr *aHdr, nsAString &amp;aSenderString) {</span>
<a href="#l1.392"></a><span id="l1.392">   nsCString unparsedAuthor;</span>
<a href="#l1.393"></a><span id="l1.393">   bool showCondensedAddresses = false;</span>
<a href="#l1.394"></a><span id="l1.394">   int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.395"></a><span id="l1.395">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.396"></a><span id="l1.396"> </span>
<a href="#l1.397"></a><span id="l1.397">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.398"></a><span id="l1.398">   prefs-&gt;GetBoolPref(&quot;mail.showCondensedAddresses&quot;, &amp;showCondensedAddresses);</span>
<a href="#l1.399"></a><span id="l1.399"> </span>
<a href="#l1.400"></a><span id="l1.400">   aHdr-&gt;GetStringProperty(&quot;sender_name&quot;, getter_Copies(unparsedAuthor));</span>
<a href="#l1.401"></a><span id="l1.401"> </span>
<a href="#l1.402"></a><span id="l1.402">   // If the author is already computed, use it.</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-  if (!unparsedAuthor.IsEmpty())</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineminus">-  {</span>
<a href="#l1.405"></a><span id="l1.405" class="difflineplus">+  if (!unparsedAuthor.IsEmpty()) {</span>
<a href="#l1.406"></a><span id="l1.406">     nsCString cachedDisplayName;</span>
<a href="#l1.407"></a><span id="l1.407">     GetCachedName(unparsedAuthor, currentDisplayNameVersion, cachedDisplayName);</span>
<a href="#l1.408"></a><span id="l1.408" class="difflineminus">-    if (!cachedDisplayName.IsEmpty())</span>
<a href="#l1.409"></a><span id="l1.409" class="difflineminus">-    {</span>
<a href="#l1.410"></a><span id="l1.410" class="difflineplus">+    if (!cachedDisplayName.IsEmpty()) {</span>
<a href="#l1.411"></a><span id="l1.411">       CopyUTF8toUTF16(cachedDisplayName, aSenderString);</span>
<a href="#l1.412"></a><span id="l1.412">       return NS_OK;</span>
<a href="#l1.413"></a><span id="l1.413">     }</span>
<a href="#l1.414"></a><span id="l1.414">   }</span>
<a href="#l1.415"></a><span id="l1.415"> </span>
<a href="#l1.416"></a><span id="l1.416">   nsCString author;</span>
<a href="#l1.417"></a><span id="l1.417" class="difflineminus">-  (void) aHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l1.418"></a><span id="l1.418" class="difflineplus">+  (void)aHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l1.419"></a><span id="l1.419"> </span>
<a href="#l1.420"></a><span id="l1.420">   nsCString headerCharset;</span>
<a href="#l1.421"></a><span id="l1.421">   aHdr-&gt;GetEffectiveCharset(headerCharset);</span>
<a href="#l1.422"></a><span id="l1.422"> </span>
<a href="#l1.423"></a><span id="l1.423">   nsString name;</span>
<a href="#l1.424"></a><span id="l1.424">   nsCString emailAddress;</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-  nsCOMArray&lt;msgIAddressObject&gt; addresses = EncodedHeader(author, headerCharset.get());</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+  nsCOMArray&lt;msgIAddressObject&gt; addresses =</span>
<a href="#l1.427"></a><span id="l1.427" class="difflineplus">+      EncodedHeader(author, headerCharset.get());</span>
<a href="#l1.428"></a><span id="l1.428">   bool multipleAuthors = addresses.Length() &gt; 1;</span>
<a href="#l1.429"></a><span id="l1.429"> </span>
<a href="#l1.430"></a><span id="l1.430">   ExtractFirstAddress(addresses, name, emailAddress);</span>
<a href="#l1.431"></a><span id="l1.431"> </span>
<a href="#l1.432"></a><span id="l1.432">   if (showCondensedAddresses)</span>
<a href="#l1.433"></a><span id="l1.433">     GetDisplayNameInAddressBook(emailAddress, aSenderString);</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435" class="difflineminus">-  if (aSenderString.IsEmpty())</span>
<a href="#l1.436"></a><span id="l1.436" class="difflineminus">-  {</span>
<a href="#l1.437"></a><span id="l1.437" class="difflineplus">+  if (aSenderString.IsEmpty()) {</span>
<a href="#l1.438"></a><span id="l1.438">     // We can't use the display name in the card; use the name contained in</span>
<a href="#l1.439"></a><span id="l1.439">     // the header or email address.</span>
<a href="#l1.440"></a><span id="l1.440">     if (name.IsEmpty()) {</span>
<a href="#l1.441"></a><span id="l1.441">       CopyUTF8toUTF16(emailAddress, aSenderString);</span>
<a href="#l1.442"></a><span id="l1.442">     } else {</span>
<a href="#l1.443"></a><span id="l1.443">       int32_t atPos;</span>
<a href="#l1.444"></a><span id="l1.444">       if ((atPos = name.FindChar('@')) == kNotFound ||</span>
<a href="#l1.445"></a><span id="l1.445">           name.FindChar('.', atPos) == kNotFound) {</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineat">@@ -426,124 +387,110 @@ nsMsgDBView::FetchAuthor(nsIMsgDBHdr * a</span>
<a href="#l1.447"></a><span id="l1.447">         aSenderString = name;</span>
<a href="#l1.448"></a><span id="l1.448">         aSenderString.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l1.449"></a><span id="l1.449">         AppendUTF8toUTF16(emailAddress, aSenderString);</span>
<a href="#l1.450"></a><span id="l1.450">         aSenderString.Append('&gt;');</span>
<a href="#l1.451"></a><span id="l1.451">       }</span>
<a href="#l1.452"></a><span id="l1.452">     }</span>
<a href="#l1.453"></a><span id="l1.453">   }</span>
<a href="#l1.454"></a><span id="l1.454"> </span>
<a href="#l1.455"></a><span id="l1.455" class="difflineminus">-  if (multipleAuthors)</span>
<a href="#l1.456"></a><span id="l1.456" class="difflineminus">-  {</span>
<a href="#l1.457"></a><span id="l1.457" class="difflineplus">+  if (multipleAuthors) {</span>
<a href="#l1.458"></a><span id="l1.458">     aSenderString.AppendLiteral(&quot; &quot;);</span>
<a href="#l1.459"></a><span id="l1.459">     aSenderString.Append(GetString(u&quot;andOthers&quot;));</span>
<a href="#l1.460"></a><span id="l1.460">   }</span>
<a href="#l1.461"></a><span id="l1.461"> </span>
<a href="#l1.462"></a><span id="l1.462">   UpdateCachedName(aHdr, &quot;sender_name&quot;, aSenderString);</span>
<a href="#l1.463"></a><span id="l1.463"> </span>
<a href="#l1.464"></a><span id="l1.464">   return NS_OK;</span>
<a href="#l1.465"></a><span id="l1.465"> }</span>
<a href="#l1.466"></a><span id="l1.466"> </span>
<a href="#l1.467"></a><span id="l1.467" class="difflineminus">-nsresult</span>
<a href="#l1.468"></a><span id="l1.468" class="difflineminus">-nsMsgDBView::FetchAccount(nsIMsgDBHdr * aHdr, nsAString&amp; aAccount)</span>
<a href="#l1.469"></a><span id="l1.469" class="difflineminus">-{</span>
<a href="#l1.470"></a><span id="l1.470" class="difflineplus">+nsresult nsMsgDBView::FetchAccount(nsIMsgDBHdr *aHdr, nsAString &amp;aAccount) {</span>
<a href="#l1.471"></a><span id="l1.471">   nsCString accountKey;</span>
<a href="#l1.472"></a><span id="l1.472">   nsresult rv = aHdr-&gt;GetAccountKey(getter_Copies(accountKey));</span>
<a href="#l1.473"></a><span id="l1.473"> </span>
<a href="#l1.474"></a><span id="l1.474">   // Cache the account manager?</span>
<a href="#l1.475"></a><span id="l1.475">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager(</span>
<a href="#l1.476"></a><span id="l1.476" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l1.477"></a><span id="l1.477" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l1.478"></a><span id="l1.478"> </span>
<a href="#l1.479"></a><span id="l1.479">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.480"></a><span id="l1.480">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l1.481"></a><span id="l1.481">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.482"></a><span id="l1.482">   if (!accountKey.IsEmpty())</span>
<a href="#l1.483"></a><span id="l1.483">     rv = accountManager-&gt;GetAccount(accountKey, getter_AddRefs(account));</span>
<a href="#l1.484"></a><span id="l1.484"> </span>
<a href="#l1.485"></a><span id="l1.485" class="difflineminus">-  if (account)</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineminus">-  {</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+  if (account) {</span>
<a href="#l1.488"></a><span id="l1.488">     account-&gt;GetIncomingServer(getter_AddRefs(server));</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineminus">-  }</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineminus">-  else</span>
<a href="#l1.491"></a><span id="l1.491" class="difflineminus">-  {</span>
<a href="#l1.492"></a><span id="l1.492" class="difflineplus">+  } else {</span>
<a href="#l1.493"></a><span id="l1.493">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.494"></a><span id="l1.494">     aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.495"></a><span id="l1.495" class="difflineminus">-    if (folder)</span>
<a href="#l1.496"></a><span id="l1.496" class="difflineminus">-      folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.497"></a><span id="l1.497" class="difflineplus">+    if (folder) folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.498"></a><span id="l1.498">   }</span>
<a href="#l1.499"></a><span id="l1.499"> </span>
<a href="#l1.500"></a><span id="l1.500">   if (server)</span>
<a href="#l1.501"></a><span id="l1.501">     server-&gt;GetPrettyName(aAccount);</span>
<a href="#l1.502"></a><span id="l1.502">   else</span>
<a href="#l1.503"></a><span id="l1.503">     CopyASCIItoUTF16(accountKey, aAccount);</span>
<a href="#l1.504"></a><span id="l1.504"> </span>
<a href="#l1.505"></a><span id="l1.505">   return NS_OK;</span>
<a href="#l1.506"></a><span id="l1.506"> }</span>
<a href="#l1.507"></a><span id="l1.507"> </span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-nsresult</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineminus">-nsMsgDBView::FetchRecipients(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineminus">-                             nsAString &amp;aRecipientsString)</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineminus">-{</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+nsresult nsMsgDBView::FetchRecipients(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+                                      nsAString &amp;aRecipientsString) {</span>
<a href="#l1.514"></a><span id="l1.514">   nsCString recipients;</span>
<a href="#l1.515"></a><span id="l1.515">   int32_t currentDisplayNameVersion = 0;</span>
<a href="#l1.516"></a><span id="l1.516">   bool showCondensedAddresses = false;</span>
<a href="#l1.517"></a><span id="l1.517">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.518"></a><span id="l1.518"> </span>
<a href="#l1.519"></a><span id="l1.519">   prefs-&gt;GetIntPref(&quot;mail.displayname.version&quot;, &amp;currentDisplayNameVersion);</span>
<a href="#l1.520"></a><span id="l1.520">   prefs-&gt;GetBoolPref(&quot;mail.showCondensedAddresses&quot;, &amp;showCondensedAddresses);</span>
<a href="#l1.521"></a><span id="l1.521"> </span>
<a href="#l1.522"></a><span id="l1.522">   aHdr-&gt;GetStringProperty(&quot;recipient_names&quot;, getter_Copies(recipients));</span>
<a href="#l1.523"></a><span id="l1.523"> </span>
<a href="#l1.524"></a><span id="l1.524" class="difflineminus">-  if (!recipients.IsEmpty())</span>
<a href="#l1.525"></a><span id="l1.525" class="difflineminus">-  {</span>
<a href="#l1.526"></a><span id="l1.526" class="difflineplus">+  if (!recipients.IsEmpty()) {</span>
<a href="#l1.527"></a><span id="l1.527">     nsCString cachedRecipients;</span>
<a href="#l1.528"></a><span id="l1.528">     GetCachedName(recipients, currentDisplayNameVersion, cachedRecipients);</span>
<a href="#l1.529"></a><span id="l1.529"> </span>
<a href="#l1.530"></a><span id="l1.530">     // Recipients have already been cached, check if the addressbook</span>
<a href="#l1.531"></a><span id="l1.531">     // was changed after cache.</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineminus">-    if (!cachedRecipients.IsEmpty())</span>
<a href="#l1.533"></a><span id="l1.533" class="difflineminus">-    {</span>
<a href="#l1.534"></a><span id="l1.534" class="difflineplus">+    if (!cachedRecipients.IsEmpty()) {</span>
<a href="#l1.535"></a><span id="l1.535">       CopyUTF8toUTF16(cachedRecipients, aRecipientsString);</span>
<a href="#l1.536"></a><span id="l1.536">       return NS_OK;</span>
<a href="#l1.537"></a><span id="l1.537">     }</span>
<a href="#l1.538"></a><span id="l1.538">   }</span>
<a href="#l1.539"></a><span id="l1.539"> </span>
<a href="#l1.540"></a><span id="l1.540">   nsCString unparsedRecipients;</span>
<a href="#l1.541"></a><span id="l1.541">   nsresult rv = aHdr-&gt;GetRecipients(getter_Copies(unparsedRecipients));</span>
<a href="#l1.542"></a><span id="l1.542"> </span>
<a href="#l1.543"></a><span id="l1.543">   nsCString headerCharset;</span>
<a href="#l1.544"></a><span id="l1.544">   aHdr-&gt;GetEffectiveCharset(headerCharset);</span>
<a href="#l1.545"></a><span id="l1.545"> </span>
<a href="#l1.546"></a><span id="l1.546">   nsTArray&lt;nsString&gt; names;</span>
<a href="#l1.547"></a><span id="l1.547">   nsTArray&lt;nsCString&gt; emails;</span>
<a href="#l1.548"></a><span id="l1.548">   ExtractAllAddresses(EncodedHeader(unparsedRecipients, headerCharset.get()),</span>
<a href="#l1.549"></a><span id="l1.549" class="difflineminus">-                      names,</span>
<a href="#l1.550"></a><span id="l1.550" class="difflineminus">-                      UTF16ArrayAdapter&lt;&gt;(emails));</span>
<a href="#l1.551"></a><span id="l1.551" class="difflineplus">+                      names, UTF16ArrayAdapter&lt;&gt;(emails));</span>
<a href="#l1.552"></a><span id="l1.552"> </span>
<a href="#l1.553"></a><span id="l1.553">   uint32_t numAddresses = names.Length();</span>
<a href="#l1.554"></a><span id="l1.554"> </span>
<a href="#l1.555"></a><span id="l1.555">   nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.556"></a><span id="l1.556" class="difflineminus">-  nsCOMPtr&lt;nsIAbManager&gt;</span>
<a href="#l1.557"></a><span id="l1.557" class="difflineminus">-    abManager(do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.558"></a><span id="l1.558" class="difflineplus">+  nsCOMPtr&lt;nsIAbManager&gt; abManager(</span>
<a href="#l1.559"></a><span id="l1.559" class="difflineplus">+      do_GetService(&quot;@mozilla.org/abmanager;1&quot;, &amp;rv));</span>
<a href="#l1.560"></a><span id="l1.560"> </span>
<a href="#l1.561"></a><span id="l1.561">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l1.562"></a><span id="l1.562"> </span>
<a href="#l1.563"></a><span id="l1.563">   // Go through each email address in the recipients and compute its</span>
<a href="#l1.564"></a><span id="l1.564">   // display name.</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-  for (uint32_t i = 0; i &lt; numAddresses; i++)</span>
<a href="#l1.566"></a><span id="l1.566" class="difflineminus">-  {</span>
<a href="#l1.567"></a><span id="l1.567" class="difflineplus">+  for (uint32_t i = 0; i &lt; numAddresses; i++) {</span>
<a href="#l1.568"></a><span id="l1.568">     nsString recipient;</span>
<a href="#l1.569"></a><span id="l1.569">     nsCString &amp;curAddress = emails[i];</span>
<a href="#l1.570"></a><span id="l1.570">     nsString &amp;curName = names[i];</span>
<a href="#l1.571"></a><span id="l1.571"> </span>
<a href="#l1.572"></a><span id="l1.572">     if (showCondensedAddresses)</span>
<a href="#l1.573"></a><span id="l1.573">       GetDisplayNameInAddressBook(curAddress, recipient);</span>
<a href="#l1.574"></a><span id="l1.574"> </span>
<a href="#l1.575"></a><span id="l1.575" class="difflineminus">-    if (recipient.IsEmpty())</span>
<a href="#l1.576"></a><span id="l1.576" class="difflineminus">-    {</span>
<a href="#l1.577"></a><span id="l1.577" class="difflineplus">+    if (recipient.IsEmpty()) {</span>
<a href="#l1.578"></a><span id="l1.578">       // We can't use the display name in the card; use the name contained in</span>
<a href="#l1.579"></a><span id="l1.579">       // the header or email address.</span>
<a href="#l1.580"></a><span id="l1.580">       if (curName.IsEmpty()) {</span>
<a href="#l1.581"></a><span id="l1.581">         CopyUTF8toUTF16(curAddress, recipient);</span>
<a href="#l1.582"></a><span id="l1.582">       } else {</span>
<a href="#l1.583"></a><span id="l1.583">         int32_t atPos;</span>
<a href="#l1.584"></a><span id="l1.584">         if ((atPos = curName.FindChar('@')) == kNotFound ||</span>
<a href="#l1.585"></a><span id="l1.585">             curName.FindChar('.', atPos) == kNotFound) {</span>
<a href="#l1.586"></a><span id="l1.586" class="difflineat">@@ -554,194 +501,163 @@ nsMsgDBView::FetchRecipients(nsIMsgDBHdr</span>
<a href="#l1.587"></a><span id="l1.587">           recipient.AppendLiteral(&quot; &lt;&quot;);</span>
<a href="#l1.588"></a><span id="l1.588">           AppendUTF8toUTF16(curAddress, recipient);</span>
<a href="#l1.589"></a><span id="l1.589">           recipient.Append('&gt;');</span>
<a href="#l1.590"></a><span id="l1.590">         }</span>
<a href="#l1.591"></a><span id="l1.591">       }</span>
<a href="#l1.592"></a><span id="l1.592">     }</span>
<a href="#l1.593"></a><span id="l1.593"> </span>
<a href="#l1.594"></a><span id="l1.594">     // Add ', ' between each recipient.</span>
<a href="#l1.595"></a><span id="l1.595" class="difflineminus">-    if (i != 0)</span>
<a href="#l1.596"></a><span id="l1.596" class="difflineminus">-      aRecipientsString.AppendLiteral(u&quot;, &quot;);</span>
<a href="#l1.597"></a><span id="l1.597" class="difflineplus">+    if (i != 0) aRecipientsString.AppendLiteral(u&quot;, &quot;);</span>
<a href="#l1.598"></a><span id="l1.598"> </span>
<a href="#l1.599"></a><span id="l1.599">     aRecipientsString.Append(recipient);</span>
<a href="#l1.600"></a><span id="l1.600">   }</span>
<a href="#l1.601"></a><span id="l1.601"> </span>
<a href="#l1.602"></a><span id="l1.602">   if (numAddresses == 0 &amp;&amp; unparsedRecipients.FindChar(':') != kNotFound) {</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineminus">-    // No addresses and a colon, so an empty group like &quot;undisclosed-recipients: ;&quot;.</span>
<a href="#l1.604"></a><span id="l1.604" class="difflineplus">+    // No addresses and a colon, so an empty group like</span>
<a href="#l1.605"></a><span id="l1.605" class="difflineplus">+    // &quot;undisclosed-recipients: ;&quot;.</span>
<a href="#l1.606"></a><span id="l1.606">     // Add group name so at least something displays.</span>
<a href="#l1.607"></a><span id="l1.607">     nsString group;</span>
<a href="#l1.608"></a><span id="l1.608">     CopyUTF8toUTF16(unparsedRecipients, group);</span>
<a href="#l1.609"></a><span id="l1.609">     aRecipientsString.Assign(group);</span>
<a href="#l1.610"></a><span id="l1.610">   }</span>
<a href="#l1.611"></a><span id="l1.611"> </span>
<a href="#l1.612"></a><span id="l1.612">   UpdateCachedName(aHdr, &quot;recipient_names&quot;, aRecipientsString);</span>
<a href="#l1.613"></a><span id="l1.613"> </span>
<a href="#l1.614"></a><span id="l1.614">   return NS_OK;</span>
<a href="#l1.615"></a><span id="l1.615"> }</span>
<a href="#l1.616"></a><span id="l1.616"> </span>
<a href="#l1.617"></a><span id="l1.617" class="difflineminus">-nsresult</span>
<a href="#l1.618"></a><span id="l1.618" class="difflineminus">-nsMsgDBView::FetchSubject(nsIMsgDBHdr * aMsgHdr,</span>
<a href="#l1.619"></a><span id="l1.619" class="difflineminus">-                          uint32_t aFlags,</span>
<a href="#l1.620"></a><span id="l1.620" class="difflineminus">-                          nsAString &amp;aValue)</span>
<a href="#l1.621"></a><span id="l1.621" class="difflineminus">-{</span>
<a href="#l1.622"></a><span id="l1.622" class="difflineminus">-  if (aFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-  {</span>
<a href="#l1.624"></a><span id="l1.624" class="difflineplus">+nsresult nsMsgDBView::FetchSubject(nsIMsgDBHdr *aMsgHdr, uint32_t aFlags,</span>
<a href="#l1.625"></a><span id="l1.625" class="difflineplus">+                                   nsAString &amp;aValue) {</span>
<a href="#l1.626"></a><span id="l1.626" class="difflineplus">+  if (aFlags &amp; nsMsgMessageFlags::HasRe) {</span>
<a href="#l1.627"></a><span id="l1.627">     nsString subject;</span>
<a href="#l1.628"></a><span id="l1.628">     aMsgHdr-&gt;GetMime2DecodedSubject(subject);</span>
<a href="#l1.629"></a><span id="l1.629">     aValue.AssignLiteral(&quot;Re: &quot;);</span>
<a href="#l1.630"></a><span id="l1.630">     aValue.Append(subject);</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineminus">-  }</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineminus">-  else</span>
<a href="#l1.633"></a><span id="l1.633" class="difflineminus">-  {</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+  } else {</span>
<a href="#l1.635"></a><span id="l1.635">     aMsgHdr-&gt;GetMime2DecodedSubject(aValue);</span>
<a href="#l1.636"></a><span id="l1.636">   }</span>
<a href="#l1.637"></a><span id="l1.637"> </span>
<a href="#l1.638"></a><span id="l1.638">   return NS_OK;</span>
<a href="#l1.639"></a><span id="l1.639"> }</span>
<a href="#l1.640"></a><span id="l1.640"> </span>
<a href="#l1.641"></a><span id="l1.641"> // In case we want to play around with the date string, I've broken it out into</span>
<a href="#l1.642"></a><span id="l1.642"> // a separate routine.  Set rcvDate to true to get the Received: date instead</span>
<a href="#l1.643"></a><span id="l1.643"> // of the Date: date.</span>
<a href="#l1.644"></a><span id="l1.644" class="difflineminus">-nsresult</span>
<a href="#l1.645"></a><span id="l1.645" class="difflineminus">-nsMsgDBView::FetchDate(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.646"></a><span id="l1.646" class="difflineminus">-                       nsAString &amp;aDateString,</span>
<a href="#l1.647"></a><span id="l1.647" class="difflineminus">-                       bool rcvDate)</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineminus">-{</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+nsresult nsMsgDBView::FetchDate(nsIMsgDBHdr *aHdr, nsAString &amp;aDateString,</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineplus">+                                bool rcvDate) {</span>
<a href="#l1.651"></a><span id="l1.651">   PRTime dateOfMsg;</span>
<a href="#l1.652"></a><span id="l1.652">   PRTime dateOfMsgLocal;</span>
<a href="#l1.653"></a><span id="l1.653">   uint32_t rcvDateSecs;</span>
<a href="#l1.654"></a><span id="l1.654">   nsresult rv;</span>
<a href="#l1.655"></a><span id="l1.655"> </span>
<a href="#l1.656"></a><span id="l1.656">   // Silently return Date: instead if Received: is unavailable.</span>
<a href="#l1.657"></a><span id="l1.657" class="difflineminus">-  if (rcvDate)</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-  {</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+  if (rcvDate) {</span>
<a href="#l1.660"></a><span id="l1.660">     rv = aHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, &amp;rcvDateSecs);</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineminus">-    if (rcvDateSecs != 0)</span>
<a href="#l1.662"></a><span id="l1.662" class="difflineminus">-      Seconds2PRTime(rcvDateSecs, &amp;dateOfMsg);</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineminus">-  }</span>
<a href="#l1.664"></a><span id="l1.664" class="difflineminus">-</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-  if (!rcvDate || rcvDateSecs == 0)</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-    rv = aHdr-&gt;GetDate(&amp;dateOfMsg);</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineplus">+    if (rcvDateSecs != 0) Seconds2PRTime(rcvDateSecs, &amp;dateOfMsg);</span>
<a href="#l1.668"></a><span id="l1.668" class="difflineplus">+  }</span>
<a href="#l1.669"></a><span id="l1.669" class="difflineplus">+</span>
<a href="#l1.670"></a><span id="l1.670" class="difflineplus">+  if (!rcvDate || rcvDateSecs == 0) rv = aHdr-&gt;GetDate(&amp;dateOfMsg);</span>
<a href="#l1.671"></a><span id="l1.671"> </span>
<a href="#l1.672"></a><span id="l1.672">   PRTime currentTime = PR_Now();</span>
<a href="#l1.673"></a><span id="l1.673">   PRExplodedTime explodedCurrentTime;</span>
<a href="#l1.674"></a><span id="l1.674">   PR_ExplodeTime(currentTime, PR_LocalTimeParameters, &amp;explodedCurrentTime);</span>
<a href="#l1.675"></a><span id="l1.675">   PRExplodedTime explodedMsgTime;</span>
<a href="#l1.676"></a><span id="l1.676">   PR_ExplodeTime(dateOfMsg, PR_LocalTimeParameters, &amp;explodedMsgTime);</span>
<a href="#l1.677"></a><span id="l1.677"> </span>
<a href="#l1.678"></a><span id="l1.678">   // If the message is from today, don't show the date, only the time (3:15 pm).</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-  // if the message is from the last week, show the day of the week (Mon 3:15 pm).</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-  // in all other cases, show the full date (03/19/01 3:15 pm).</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineplus">+  // If the message is from the last week, show the day of the week</span>
<a href="#l1.682"></a><span id="l1.682" class="difflineplus">+  // (Mon 3:15 pm). In all other cases, show the full date (03/19/01 3:15 pm).</span>
<a href="#l1.683"></a><span id="l1.683"> </span>
<a href="#l1.684"></a><span id="l1.684">   mozilla::nsDateFormatSelector dateFormat = m_dateFormatDefault;</span>
<a href="#l1.685"></a><span id="l1.685">   if (explodedCurrentTime.tm_year == explodedMsgTime.tm_year &amp;&amp;</span>
<a href="#l1.686"></a><span id="l1.686">       explodedCurrentTime.tm_month == explodedMsgTime.tm_month &amp;&amp;</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-      explodedCurrentTime.tm_mday == explodedMsgTime.tm_mday)</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineminus">-  {</span>
<a href="#l1.689"></a><span id="l1.689" class="difflineplus">+      explodedCurrentTime.tm_mday == explodedMsgTime.tm_mday) {</span>
<a href="#l1.690"></a><span id="l1.690">     // Same day.</span>
<a href="#l1.691"></a><span id="l1.691">     dateFormat = m_dateFormatToday;</span>
<a href="#l1.692"></a><span id="l1.692" class="difflineminus">-  }</span>
<a href="#l1.693"></a><span id="l1.693" class="difflineminus">-  else if (currentTime &gt; dateOfMsg)</span>
<a href="#l1.694"></a><span id="l1.694" class="difflineminus">-  {</span>
<a href="#l1.695"></a><span id="l1.695" class="difflineplus">+  } else if (currentTime &gt; dateOfMsg) {</span>
<a href="#l1.696"></a><span id="l1.696">     // The following chunk of code allows us to show a day instead of a number</span>
<a href="#l1.697"></a><span id="l1.697">     // if the message was received within the last 7 days. i.e. Mon 5:10pm</span>
<a href="#l1.698"></a><span id="l1.698">     // (depending on the mail.ui.display.dateformat.thisweek pref).</span>
<a href="#l1.699"></a><span id="l1.699">     // The concrete format used is dependent on a preference setting</span>
<a href="#l1.700"></a><span id="l1.700">     // (see InitDisplayFormats).</span>
<a href="#l1.701"></a><span id="l1.701">     // Convert the times from GMT to local time</span>
<a href="#l1.702"></a><span id="l1.702" class="difflineminus">-    int64_t GMTLocalTimeShift = PR_USEC_PER_SEC *</span>
<a href="#l1.703"></a><span id="l1.703" class="difflineminus">-                                int64_t(explodedCurrentTime.tm_params.tp_gmt_offset +</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-                                explodedCurrentTime.tm_params.tp_dst_offset);</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+    int64_t GMTLocalTimeShift =</span>
<a href="#l1.706"></a><span id="l1.706" class="difflineplus">+        PR_USEC_PER_SEC * int64_t(explodedCurrentTime.tm_params.tp_gmt_offset +</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineplus">+                                  explodedCurrentTime.tm_params.tp_dst_offset);</span>
<a href="#l1.708"></a><span id="l1.708">     currentTime += GMTLocalTimeShift;</span>
<a href="#l1.709"></a><span id="l1.709">     dateOfMsgLocal = dateOfMsg + GMTLocalTimeShift;</span>
<a href="#l1.710"></a><span id="l1.710"> </span>
<a href="#l1.711"></a><span id="l1.711">     // Find the most recent midnight.</span>
<a href="#l1.712"></a><span id="l1.712">     int64_t todaysMicroSeconds = currentTime % PR_USEC_PER_DAY;</span>
<a href="#l1.713"></a><span id="l1.713">     int64_t mostRecentMidnight = currentTime - todaysMicroSeconds;</span>
<a href="#l1.714"></a><span id="l1.714"> </span>
<a href="#l1.715"></a><span id="l1.715">     // Most recent midnight minus 6 days.</span>
<a href="#l1.716"></a><span id="l1.716">     int64_t mostRecentWeek = mostRecentMidnight - (PR_USEC_PER_DAY * 6);</span>
<a href="#l1.717"></a><span id="l1.717"> </span>
<a href="#l1.718"></a><span id="l1.718">     // Was the message sent during the last week?</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineminus">-    if (dateOfMsgLocal &gt;= mostRecentWeek)</span>
<a href="#l1.720"></a><span id="l1.720" class="difflineminus">-      dateFormat = m_dateFormatThisWeek;</span>
<a href="#l1.721"></a><span id="l1.721" class="difflineplus">+    if (dateOfMsgLocal &gt;= mostRecentWeek) dateFormat = m_dateFormatThisWeek;</span>
<a href="#l1.722"></a><span id="l1.722">   }</span>
<a href="#l1.723"></a><span id="l1.723"> </span>
<a href="#l1.724"></a><span id="l1.724">   if (NS_SUCCEEDED(rv))</span>
<a href="#l1.725"></a><span id="l1.725" class="difflineminus">-    rv = mozilla::DateTimeFormat::FormatPRTime(dateFormat,</span>
<a href="#l1.726"></a><span id="l1.726" class="difflineminus">-                                               mozilla::kTimeFormatNoSeconds,</span>
<a href="#l1.727"></a><span id="l1.727" class="difflineminus">-                                               dateOfMsg,</span>
<a href="#l1.728"></a><span id="l1.728" class="difflineminus">-                                               aDateString);</span>
<a href="#l1.729"></a><span id="l1.729" class="difflineplus">+    rv = mozilla::DateTimeFormat::FormatPRTime(</span>
<a href="#l1.730"></a><span id="l1.730" class="difflineplus">+        dateFormat, mozilla::kTimeFormatNoSeconds, dateOfMsg, aDateString);</span>
<a href="#l1.731"></a><span id="l1.731"> </span>
<a href="#l1.732"></a><span id="l1.732">   return rv;</span>
<a href="#l1.733"></a><span id="l1.733"> }</span>
<a href="#l1.734"></a><span id="l1.734"> </span>
<a href="#l1.735"></a><span id="l1.735" class="difflineminus">-nsresult</span>
<a href="#l1.736"></a><span id="l1.736" class="difflineminus">-nsMsgDBView::FetchStatus(uint32_t aFlags,</span>
<a href="#l1.737"></a><span id="l1.737" class="difflineminus">-                         nsAString &amp;aStatusString)</span>
<a href="#l1.738"></a><span id="l1.738" class="difflineminus">-{</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineplus">+nsresult nsMsgDBView::FetchStatus(uint32_t aFlags, nsAString &amp;aStatusString) {</span>
<a href="#l1.740"></a><span id="l1.740">   if (aFlags &amp; nsMsgMessageFlags::Replied)</span>
<a href="#l1.741"></a><span id="l1.741">     aStatusString = kRepliedString;</span>
<a href="#l1.742"></a><span id="l1.742">   else if (aFlags &amp; nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.743"></a><span id="l1.743">     aStatusString = kForwardedString;</span>
<a href="#l1.744"></a><span id="l1.744">   else if (aFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l1.745"></a><span id="l1.745">     aStatusString = kNewString;</span>
<a href="#l1.746"></a><span id="l1.746">   else if (aFlags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l1.747"></a><span id="l1.747">     aStatusString = kReadString;</span>
<a href="#l1.748"></a><span id="l1.748"> </span>
<a href="#l1.749"></a><span id="l1.749">   return NS_OK;</span>
<a href="#l1.750"></a><span id="l1.750"> }</span>
<a href="#l1.751"></a><span id="l1.751"> </span>
<a href="#l1.752"></a><span id="l1.752" class="difflineminus">-nsresult</span>
<a href="#l1.753"></a><span id="l1.753" class="difflineminus">-nsMsgDBView::FetchSize(nsIMsgDBHdr * aHdr,</span>
<a href="#l1.754"></a><span id="l1.754" class="difflineminus">-                       nsAString &amp;aSizeString)</span>
<a href="#l1.755"></a><span id="l1.755" class="difflineminus">-{</span>
<a href="#l1.756"></a><span id="l1.756" class="difflineplus">+nsresult nsMsgDBView::FetchSize(nsIMsgDBHdr *aHdr, nsAString &amp;aSizeString) {</span>
<a href="#l1.757"></a><span id="l1.757">   nsresult rv;</span>
<a href="#l1.758"></a><span id="l1.758">   nsAutoString formattedSizeString;</span>
<a href="#l1.759"></a><span id="l1.759">   uint32_t msgSize = 0;</span>
<a href="#l1.760"></a><span id="l1.760"> </span>
<a href="#l1.761"></a><span id="l1.761">   // For news, show the line count, not the size if the user wants so.</span>
<a href="#l1.762"></a><span id="l1.762" class="difflineminus">-  if (mShowSizeInLines)</span>
<a href="#l1.763"></a><span id="l1.763" class="difflineminus">-  {</span>
<a href="#l1.764"></a><span id="l1.764" class="difflineplus">+  if (mShowSizeInLines) {</span>
<a href="#l1.765"></a><span id="l1.765">     aHdr-&gt;GetLineCount(&amp;msgSize);</span>
<a href="#l1.766"></a><span id="l1.766">     formattedSizeString.AppendInt(msgSize);</span>
<a href="#l1.767"></a><span id="l1.767" class="difflineminus">-  }</span>
<a href="#l1.768"></a><span id="l1.768" class="difflineminus">-  else</span>
<a href="#l1.769"></a><span id="l1.769" class="difflineminus">-  {</span>
<a href="#l1.770"></a><span id="l1.770" class="difflineplus">+  } else {</span>
<a href="#l1.771"></a><span id="l1.771">     uint32_t flags = 0;</span>
<a href="#l1.772"></a><span id="l1.772"> </span>
<a href="#l1.773"></a><span id="l1.773">     aHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.774"></a><span id="l1.774">     if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l1.775"></a><span id="l1.775">       aHdr-&gt;GetUint32Property(&quot;onlineSize&quot;, &amp;msgSize);</span>
<a href="#l1.776"></a><span id="l1.776"> </span>
<a href="#l1.777"></a><span id="l1.777" class="difflineminus">-    if (msgSize == 0)</span>
<a href="#l1.778"></a><span id="l1.778" class="difflineminus">-      aHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l1.779"></a><span id="l1.779" class="difflineplus">+    if (msgSize == 0) aHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l1.780"></a><span id="l1.780"> </span>
<a href="#l1.781"></a><span id="l1.781">     rv = FormatFileSize(msgSize, true, formattedSizeString);</span>
<a href="#l1.782"></a><span id="l1.782">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.783"></a><span id="l1.783">   }</span>
<a href="#l1.784"></a><span id="l1.784"> </span>
<a href="#l1.785"></a><span id="l1.785">   aSizeString = formattedSizeString;</span>
<a href="#l1.786"></a><span id="l1.786">   // The formattingString Length includes the null terminator byte!</span>
<a href="#l1.787"></a><span id="l1.787">   if (!formattedSizeString.Last())</span>
<a href="#l1.788"></a><span id="l1.788">     aSizeString.SetLength(formattedSizeString.Length() - 1);</span>
<a href="#l1.789"></a><span id="l1.789"> </span>
<a href="#l1.790"></a><span id="l1.790">   return NS_OK;</span>
<a href="#l1.791"></a><span id="l1.791"> }</span>
<a href="#l1.792"></a><span id="l1.792"> </span>
<a href="#l1.793"></a><span id="l1.793" class="difflineminus">-nsresult</span>
<a href="#l1.794"></a><span id="l1.794" class="difflineminus">-nsMsgDBView::FetchPriority(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.795"></a><span id="l1.795" class="difflineminus">-                           nsAString &amp; aPriorityString)</span>
<a href="#l1.796"></a><span id="l1.796" class="difflineminus">-{</span>
<a href="#l1.797"></a><span id="l1.797" class="difflineplus">+nsresult nsMsgDBView::FetchPriority(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.798"></a><span id="l1.798" class="difflineplus">+                                    nsAString &amp;aPriorityString) {</span>
<a href="#l1.799"></a><span id="l1.799">   nsMsgPriorityValue priority = nsMsgPriority::notSet;</span>
<a href="#l1.800"></a><span id="l1.800">   aHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.801"></a><span id="l1.801"> </span>
<a href="#l1.802"></a><span id="l1.802" class="difflineminus">-  switch (priority)</span>
<a href="#l1.803"></a><span id="l1.803" class="difflineminus">-  {</span>
<a href="#l1.804"></a><span id="l1.804" class="difflineplus">+  switch (priority) {</span>
<a href="#l1.805"></a><span id="l1.805">     case nsMsgPriority::highest:</span>
<a href="#l1.806"></a><span id="l1.806">       aPriorityString = kHighestPriorityString;</span>
<a href="#l1.807"></a><span id="l1.807">       break;</span>
<a href="#l1.808"></a><span id="l1.808">     case nsMsgPriority::high:</span>
<a href="#l1.809"></a><span id="l1.809">       aPriorityString = kHighPriorityString;</span>
<a href="#l1.810"></a><span id="l1.810">       break;</span>
<a href="#l1.811"></a><span id="l1.811">     case nsMsgPriority::low:</span>
<a href="#l1.812"></a><span id="l1.812">       aPriorityString = kLowPriorityString;</span>
<a href="#l1.813"></a><span id="l1.813" class="difflineat">@@ -754,574 +670,488 @@ nsMsgDBView::FetchPriority(nsIMsgDBHdr *</span>
<a href="#l1.814"></a><span id="l1.814">       break;</span>
<a href="#l1.815"></a><span id="l1.815">     default:</span>
<a href="#l1.816"></a><span id="l1.816">       break;</span>
<a href="#l1.817"></a><span id="l1.817">   }</span>
<a href="#l1.818"></a><span id="l1.818"> </span>
<a href="#l1.819"></a><span id="l1.819">   return NS_OK;</span>
<a href="#l1.820"></a><span id="l1.820"> }</span>
<a href="#l1.821"></a><span id="l1.821"> </span>
<a href="#l1.822"></a><span id="l1.822" class="difflineminus">-nsresult</span>
<a href="#l1.823"></a><span id="l1.823" class="difflineminus">-nsMsgDBView::FetchKeywords(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.824"></a><span id="l1.824" class="difflineminus">-                           nsACString &amp;keywordString)</span>
<a href="#l1.825"></a><span id="l1.825" class="difflineminus">-{</span>
<a href="#l1.826"></a><span id="l1.826" class="difflineplus">+nsresult nsMsgDBView::FetchKeywords(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.827"></a><span id="l1.827" class="difflineplus">+                                    nsACString &amp;keywordString) {</span>
<a href="#l1.828"></a><span id="l1.828">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.829"></a><span id="l1.829">   nsresult rv = NS_OK;</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineminus">-  if (!mTagService)</span>
<a href="#l1.831"></a><span id="l1.831" class="difflineminus">-  {</span>
<a href="#l1.832"></a><span id="l1.832" class="difflineplus">+  if (!mTagService) {</span>
<a href="#l1.833"></a><span id="l1.833">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.834"></a><span id="l1.834">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.835"></a><span id="l1.835">   }</span>
<a href="#l1.836"></a><span id="l1.836">   nsMsgLabelValue label = 0;</span>
<a href="#l1.837"></a><span id="l1.837"> </span>
<a href="#l1.838"></a><span id="l1.838">   rv = aHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l1.839"></a><span id="l1.839">   nsCString keywords;</span>
<a href="#l1.840"></a><span id="l1.840">   aHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineminus">-  if (label &gt; 0)</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineminus">-  {</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+  if (label &gt; 0) {</span>
<a href="#l1.844"></a><span id="l1.844">     nsAutoCString labelStr(&quot;$label&quot;);</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineminus">-    labelStr.Append((char) (label + '0'));</span>
<a href="#l1.846"></a><span id="l1.846" class="difflineminus">-    if (keywords.Find(labelStr, /* ignoreCase = */ true) == -1)</span>
<a href="#l1.847"></a><span id="l1.847" class="difflineminus">-    {</span>
<a href="#l1.848"></a><span id="l1.848" class="difflineminus">-      if (!keywords.IsEmpty())</span>
<a href="#l1.849"></a><span id="l1.849" class="difflineminus">-        keywords.Append(' ');</span>
<a href="#l1.850"></a><span id="l1.850" class="difflineplus">+    labelStr.Append((char)(label + '0'));</span>
<a href="#l1.851"></a><span id="l1.851" class="difflineplus">+    if (keywords.Find(labelStr, /* ignoreCase = */ true) == -1) {</span>
<a href="#l1.852"></a><span id="l1.852" class="difflineplus">+      if (!keywords.IsEmpty()) keywords.Append(' ');</span>
<a href="#l1.853"></a><span id="l1.853"> </span>
<a href="#l1.854"></a><span id="l1.854">       keywords.Append(labelStr);</span>
<a href="#l1.855"></a><span id="l1.855">     }</span>
<a href="#l1.856"></a><span id="l1.856">   }</span>
<a href="#l1.857"></a><span id="l1.857"> </span>
<a href="#l1.858"></a><span id="l1.858">   keywordString = keywords;</span>
<a href="#l1.859"></a><span id="l1.859">   return NS_OK;</span>
<a href="#l1.860"></a><span id="l1.860"> }</span>
<a href="#l1.861"></a><span id="l1.861"> </span>
<a href="#l1.862"></a><span id="l1.862"> // If the row is a collapsed thread, we optionally roll-up the keywords in all</span>
<a href="#l1.863"></a><span id="l1.863"> // the messages in the thread, otherwise, return just the keywords for the row.</span>
<a href="#l1.864"></a><span id="l1.864" class="difflineminus">-nsresult</span>
<a href="#l1.865"></a><span id="l1.865" class="difflineminus">-nsMsgDBView::FetchRowKeywords(nsMsgViewIndex aRow,</span>
<a href="#l1.866"></a><span id="l1.866" class="difflineminus">-                              nsIMsgDBHdr *aHdr,</span>
<a href="#l1.867"></a><span id="l1.867" class="difflineminus">-                              nsACString &amp;keywordString)</span>
<a href="#l1.868"></a><span id="l1.868" class="difflineminus">-{</span>
<a href="#l1.869"></a><span id="l1.869" class="difflineminus">-  nsresult rv = FetchKeywords(aHdr,keywordString);</span>
<a href="#l1.870"></a><span id="l1.870" class="difflineplus">+nsresult nsMsgDBView::FetchRowKeywords(nsMsgViewIndex aRow, nsIMsgDBHdr *aHdr,</span>
<a href="#l1.871"></a><span id="l1.871" class="difflineplus">+                                       nsACString &amp;keywordString) {</span>
<a href="#l1.872"></a><span id="l1.872" class="difflineplus">+  nsresult rv = FetchKeywords(aHdr, keywordString);</span>
<a href="#l1.873"></a><span id="l1.873">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.874"></a><span id="l1.874"> </span>
<a href="#l1.875"></a><span id="l1.875">   bool cascadeKeywordsUp = true;</span>
<a href="#l1.876"></a><span id="l1.876">   nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.877"></a><span id="l1.877">   prefs-&gt;GetBoolPref(&quot;mailnews.display_reply_tag_colors_for_collapsed_threads&quot;,</span>
<a href="#l1.878"></a><span id="l1.878">                      &amp;cascadeKeywordsUp);</span>
<a href="#l1.879"></a><span id="l1.879"> </span>
<a href="#l1.880"></a><span id="l1.880">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.881"></a><span id="l1.881" class="difflineminus">-      cascadeKeywordsUp)</span>
<a href="#l1.882"></a><span id="l1.882" class="difflineminus">-  {</span>
<a href="#l1.883"></a><span id="l1.883" class="difflineplus">+      cascadeKeywordsUp) {</span>
<a href="#l1.884"></a><span id="l1.884">     if ((m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD) &amp;&amp;</span>
<a href="#l1.885"></a><span id="l1.885" class="difflineminus">-        (m_flags[aRow] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.886"></a><span id="l1.886" class="difflineminus">-    {</span>
<a href="#l1.887"></a><span id="l1.887" class="difflineplus">+        (m_flags[aRow] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l1.888"></a><span id="l1.888">       nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.889"></a><span id="l1.889">       rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.890"></a><span id="l1.890" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.891"></a><span id="l1.891" class="difflineminus">-      {</span>
<a href="#l1.892"></a><span id="l1.892" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; thread) {</span>
<a href="#l1.893"></a><span id="l1.893">         uint32_t numChildren;</span>
<a href="#l1.894"></a><span id="l1.894">         thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.895"></a><span id="l1.895">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.896"></a><span id="l1.896">         nsCString moreKeywords;</span>
<a href="#l1.897"></a><span id="l1.897" class="difflineminus">-        for (uint32_t index = 0; index &lt; numChildren; index++)</span>
<a href="#l1.898"></a><span id="l1.898" class="difflineminus">-        {</span>
<a href="#l1.899"></a><span id="l1.899" class="difflineplus">+        for (uint32_t index = 0; index &lt; numChildren; index++) {</span>
<a href="#l1.900"></a><span id="l1.900">           thread-&gt;GetChildHdrAt(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.901"></a><span id="l1.901">           rv = FetchKeywords(msgHdr, moreKeywords);</span>
<a href="#l1.902"></a><span id="l1.902">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.903"></a><span id="l1.903"> </span>
<a href="#l1.904"></a><span id="l1.904">           if (!keywordString.IsEmpty() &amp;&amp; !moreKeywords.IsEmpty())</span>
<a href="#l1.905"></a><span id="l1.905">             keywordString.Append(' ');</span>
<a href="#l1.906"></a><span id="l1.906"> </span>
<a href="#l1.907"></a><span id="l1.907">           keywordString.Append(moreKeywords);</span>
<a href="#l1.908"></a><span id="l1.908">         }</span>
<a href="#l1.909"></a><span id="l1.909">       }</span>
<a href="#l1.910"></a><span id="l1.910">     }</span>
<a href="#l1.911"></a><span id="l1.911">   }</span>
<a href="#l1.912"></a><span id="l1.912"> </span>
<a href="#l1.913"></a><span id="l1.913">   return rv;</span>
<a href="#l1.914"></a><span id="l1.914"> }</span>
<a href="#l1.915"></a><span id="l1.915"> </span>
<a href="#l1.916"></a><span id="l1.916" class="difflineminus">-nsresult</span>
<a href="#l1.917"></a><span id="l1.917" class="difflineminus">-nsMsgDBView::FetchTags(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.918"></a><span id="l1.918" class="difflineminus">-                       nsAString &amp;aTagString)</span>
<a href="#l1.919"></a><span id="l1.919" class="difflineminus">-{</span>
<a href="#l1.920"></a><span id="l1.920" class="difflineplus">+nsresult nsMsgDBView::FetchTags(nsIMsgDBHdr *aHdr, nsAString &amp;aTagString) {</span>
<a href="#l1.921"></a><span id="l1.921">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.922"></a><span id="l1.922">   nsresult rv = NS_OK;</span>
<a href="#l1.923"></a><span id="l1.923" class="difflineminus">-  if (!mTagService)</span>
<a href="#l1.924"></a><span id="l1.924" class="difflineminus">-  {</span>
<a href="#l1.925"></a><span id="l1.925" class="difflineplus">+  if (!mTagService) {</span>
<a href="#l1.926"></a><span id="l1.926">     mTagService = do_GetService(NS_MSGTAGSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.927"></a><span id="l1.927">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.928"></a><span id="l1.928">   }</span>
<a href="#l1.929"></a><span id="l1.929"> </span>
<a href="#l1.930"></a><span id="l1.930">   nsString tags;</span>
<a href="#l1.931"></a><span id="l1.931">   nsCString keywords;</span>
<a href="#l1.932"></a><span id="l1.932">   aHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l1.933"></a><span id="l1.933"> </span>
<a href="#l1.934"></a><span id="l1.934">   nsMsgLabelValue label = 0;</span>
<a href="#l1.935"></a><span id="l1.935">   rv = aHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l1.936"></a><span id="l1.936" class="difflineminus">-  if (label &gt; 0)</span>
<a href="#l1.937"></a><span id="l1.937" class="difflineminus">-  {</span>
<a href="#l1.938"></a><span id="l1.938" class="difflineplus">+  if (label &gt; 0) {</span>
<a href="#l1.939"></a><span id="l1.939">     nsAutoCString labelStr(&quot;$label&quot;);</span>
<a href="#l1.940"></a><span id="l1.940" class="difflineminus">-    labelStr.Append((char) (label + '0'));</span>
<a href="#l1.941"></a><span id="l1.941" class="difflineplus">+    labelStr.Append((char)(label + '0'));</span>
<a href="#l1.942"></a><span id="l1.942">     if (keywords.Find(labelStr, /* ignoreCase = */ true) == -1)</span>
<a href="#l1.943"></a><span id="l1.943">       FetchLabel(aHdr, tags);</span>
<a href="#l1.944"></a><span id="l1.944">   }</span>
<a href="#l1.945"></a><span id="l1.945"> </span>
<a href="#l1.946"></a><span id="l1.946">   nsTArray&lt;nsCString&gt; keywordsArray;</span>
<a href="#l1.947"></a><span id="l1.947">   ParseString(keywords, ' ', keywordsArray);</span>
<a href="#l1.948"></a><span id="l1.948">   nsAutoString tag;</span>
<a href="#l1.949"></a><span id="l1.949"> </span>
<a href="#l1.950"></a><span id="l1.950" class="difflineminus">-  for (uint32_t i = 0; i &lt; keywordsArray.Length(); i++)</span>
<a href="#l1.951"></a><span id="l1.951" class="difflineminus">-  {</span>
<a href="#l1.952"></a><span id="l1.952" class="difflineplus">+  for (uint32_t i = 0; i &lt; keywordsArray.Length(); i++) {</span>
<a href="#l1.953"></a><span id="l1.953">     rv = mTagService-&gt;GetTagForKey(keywordsArray[i], tag);</span>
<a href="#l1.954"></a><span id="l1.954" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; !tag.IsEmpty())</span>
<a href="#l1.955"></a><span id="l1.955" class="difflineminus">-    {</span>
<a href="#l1.956"></a><span id="l1.956" class="difflineminus">-      if (!tags.IsEmpty())</span>
<a href="#l1.957"></a><span id="l1.957" class="difflineminus">-        tags.Append((char16_t) ' ');</span>
<a href="#l1.958"></a><span id="l1.958" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; !tag.IsEmpty()) {</span>
<a href="#l1.959"></a><span id="l1.959" class="difflineplus">+      if (!tags.IsEmpty()) tags.Append((char16_t)' ');</span>
<a href="#l1.960"></a><span id="l1.960"> </span>
<a href="#l1.961"></a><span id="l1.961">       tags.Append(tag);</span>
<a href="#l1.962"></a><span id="l1.962">     }</span>
<a href="#l1.963"></a><span id="l1.963">   }</span>
<a href="#l1.964"></a><span id="l1.964"> </span>
<a href="#l1.965"></a><span id="l1.965">   aTagString = tags;</span>
<a href="#l1.966"></a><span id="l1.966">   return NS_OK;</span>
<a href="#l1.967"></a><span id="l1.967"> }</span>
<a href="#l1.968"></a><span id="l1.968"> </span>
<a href="#l1.969"></a><span id="l1.969" class="difflineminus">-nsresult</span>
<a href="#l1.970"></a><span id="l1.970" class="difflineminus">-nsMsgDBView::FetchLabel(nsIMsgDBHdr *aHdr,</span>
<a href="#l1.971"></a><span id="l1.971" class="difflineminus">-                        nsAString &amp;aLabelString)</span>
<a href="#l1.972"></a><span id="l1.972" class="difflineminus">-{</span>
<a href="#l1.973"></a><span id="l1.973" class="difflineplus">+nsresult nsMsgDBView::FetchLabel(nsIMsgDBHdr *aHdr, nsAString &amp;aLabelString) {</span>
<a href="#l1.974"></a><span id="l1.974">   nsresult rv = NS_OK;</span>
<a href="#l1.975"></a><span id="l1.975">   nsMsgLabelValue label = 0;</span>
<a href="#l1.976"></a><span id="l1.976"> </span>
<a href="#l1.977"></a><span id="l1.977">   NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l1.978"></a><span id="l1.978"> </span>
<a href="#l1.979"></a><span id="l1.979">   rv = aHdr-&gt;GetLabel(&amp;label);</span>
<a href="#l1.980"></a><span id="l1.980">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.981"></a><span id="l1.981"> </span>
<a href="#l1.982"></a><span id="l1.982">   // We don't care if label is not between 1 and PREF_LABELS_MAX inclusive.</span>
<a href="#l1.983"></a><span id="l1.983" class="difflineminus">-  if ((label &lt; 1) || (label &gt; PREF_LABELS_MAX))</span>
<a href="#l1.984"></a><span id="l1.984" class="difflineminus">-  {</span>
<a href="#l1.985"></a><span id="l1.985" class="difflineplus">+  if ((label &lt; 1) || (label &gt; PREF_LABELS_MAX)) {</span>
<a href="#l1.986"></a><span id="l1.986">     aLabelString.Truncate();</span>
<a href="#l1.987"></a><span id="l1.987">     return NS_OK;</span>
<a href="#l1.988"></a><span id="l1.988">   }</span>
<a href="#l1.989"></a><span id="l1.989"> </span>
<a href="#l1.990"></a><span id="l1.990">   // We need to subtract 1 because mLabelPrefDescriptions is 0 based.</span>
<a href="#l1.991"></a><span id="l1.991">   aLabelString = mLabelPrefDescriptions[label - 1];</span>
<a href="#l1.992"></a><span id="l1.992">   return NS_OK;</span>
<a href="#l1.993"></a><span id="l1.993"> }</span>
<a href="#l1.994"></a><span id="l1.994"> </span>
<a href="#l1.995"></a><span id="l1.995"> /**</span>
<a href="#l1.996"></a><span id="l1.996">  * Lowercase the email and remove a possible plus addressing part.</span>
<a href="#l1.997"></a><span id="l1.997">  * E.g. John+test@example.com -&gt; john@example.com.</span>
<a href="#l1.998"></a><span id="l1.998">  */</span>
<a href="#l1.999"></a><span id="l1.999" class="difflineminus">-static void</span>
<a href="#l1.1000"></a><span id="l1.1000" class="difflineminus">-ToLowerCaseDropPlusAddessing(nsCString&amp; aEmail)</span>
<a href="#l1.1001"></a><span id="l1.1001" class="difflineminus">-{</span>
<a href="#l1.1002"></a><span id="l1.1002" class="difflineplus">+static void ToLowerCaseDropPlusAddessing(nsCString &amp;aEmail) {</span>
<a href="#l1.1003"></a><span id="l1.1003">   ToLowerCase(aEmail);</span>
<a href="#l1.1004"></a><span id="l1.1004">   int32_t indPlus;</span>
<a href="#l1.1005"></a><span id="l1.1005" class="difflineminus">-  if ((indPlus = aEmail.FindChar('+')) == kNotFound)</span>
<a href="#l1.1006"></a><span id="l1.1006" class="difflineminus">-    return;</span>
<a href="#l1.1007"></a><span id="l1.1007" class="difflineplus">+  if ((indPlus = aEmail.FindChar('+')) == kNotFound) return;</span>
<a href="#l1.1008"></a><span id="l1.1008">   int32_t indAt;</span>
<a href="#l1.1009"></a><span id="l1.1009">   indAt = aEmail.FindChar('@', indPlus);</span>
<a href="#l1.1010"></a><span id="l1.1010" class="difflineminus">-  if (indAt == kNotFound)</span>
<a href="#l1.1011"></a><span id="l1.1011" class="difflineminus">-    return;</span>
<a href="#l1.1012"></a><span id="l1.1012" class="difflineplus">+  if (indAt == kNotFound) return;</span>
<a href="#l1.1013"></a><span id="l1.1013">   aEmail.ReplaceLiteral(indPlus, indAt - indPlus, &quot;&quot;);</span>
<a href="#l1.1014"></a><span id="l1.1014"> }</span>
<a href="#l1.1015"></a><span id="l1.1015"> </span>
<a href="#l1.1016"></a><span id="l1.1016" class="difflineminus">-bool</span>
<a href="#l1.1017"></a><span id="l1.1017" class="difflineminus">-nsMsgDBView::IsOutgoingMsg(nsIMsgDBHdr* aHdr)</span>
<a href="#l1.1018"></a><span id="l1.1018" class="difflineminus">-{</span>
<a href="#l1.1019"></a><span id="l1.1019" class="difflineplus">+bool nsMsgDBView::IsOutgoingMsg(nsIMsgDBHdr *aHdr) {</span>
<a href="#l1.1020"></a><span id="l1.1020">   nsString author;</span>
<a href="#l1.1021"></a><span id="l1.1021">   aHdr-&gt;GetMime2DecodedAuthor(author);</span>
<a href="#l1.1022"></a><span id="l1.1022"> </span>
<a href="#l1.1023"></a><span id="l1.1023">   nsCString emailAddress;</span>
<a href="#l1.1024"></a><span id="l1.1024">   nsString name;</span>
<a href="#l1.1025"></a><span id="l1.1025">   ExtractFirstAddress(DecodedHeader(author), name, emailAddress);</span>
<a href="#l1.1026"></a><span id="l1.1026">   ToLowerCaseDropPlusAddessing(emailAddress);</span>
<a href="#l1.1027"></a><span id="l1.1027">   return mEmails.Contains(emailAddress);</span>
<a href="#l1.1028"></a><span id="l1.1028"> }</span>
<a href="#l1.1029"></a><span id="l1.1029"> </span>
<a href="#l1.1030"></a><span id="l1.1030" class="difflineminus">-</span>
<a href="#l1.1031"></a><span id="l1.1031"> // If you call SaveAndClearSelection make sure to call RestoreSelection(),</span>
<a href="#l1.1032"></a><span id="l1.1032"> // otherwise m_saveRestoreSelectionDepth will be incorrect and will lead to</span>
<a href="#l1.1033"></a><span id="l1.1033"> // selection msg problems.</span>
<a href="#l1.1034"></a><span id="l1.1034" class="difflineminus">-nsresult</span>
<a href="#l1.1035"></a><span id="l1.1035" class="difflineminus">-nsMsgDBView::SaveAndClearSelection(nsMsgKey *aCurrentMsgKey,</span>
<a href="#l1.1036"></a><span id="l1.1036" class="difflineminus">-                                   nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.1037"></a><span id="l1.1037" class="difflineminus">-{</span>
<a href="#l1.1038"></a><span id="l1.1038" class="difflineplus">+nsresult nsMsgDBView::SaveAndClearSelection(nsMsgKey *aCurrentMsgKey,</span>
<a href="#l1.1039"></a><span id="l1.1039" class="difflineplus">+                                            nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray) {</span>
<a href="#l1.1040"></a><span id="l1.1040">   // We don't do anything on nested Save / Restore calls.</span>
<a href="#l1.1041"></a><span id="l1.1041">   m_saveRestoreSelectionDepth++;</span>
<a href="#l1.1042"></a><span id="l1.1042" class="difflineminus">-  if (m_saveRestoreSelectionDepth != 1)</span>
<a href="#l1.1043"></a><span id="l1.1043" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1044"></a><span id="l1.1044" class="difflineminus">-</span>
<a href="#l1.1045"></a><span id="l1.1045" class="difflineminus">-  if (!mTreeSelection || !mTree)</span>
<a href="#l1.1046"></a><span id="l1.1046" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1047"></a><span id="l1.1047" class="difflineplus">+  if (m_saveRestoreSelectionDepth != 1) return NS_OK;</span>
<a href="#l1.1048"></a><span id="l1.1048" class="difflineplus">+</span>
<a href="#l1.1049"></a><span id="l1.1049" class="difflineplus">+  if (!mTreeSelection || !mTree) return NS_OK;</span>
<a href="#l1.1050"></a><span id="l1.1050"> </span>
<a href="#l1.1051"></a><span id="l1.1051">   // First, freeze selection.</span>
<a href="#l1.1052"></a><span id="l1.1052">   mTreeSelection-&gt;SetSelectEventsSuppressed(true);</span>
<a href="#l1.1053"></a><span id="l1.1053"> </span>
<a href="#l1.1054"></a><span id="l1.1054">   // Second, save the current index.</span>
<a href="#l1.1055"></a><span id="l1.1055" class="difflineminus">-  if (aCurrentMsgKey)</span>
<a href="#l1.1056"></a><span id="l1.1056" class="difflineminus">-  {</span>
<a href="#l1.1057"></a><span id="l1.1057" class="difflineplus">+  if (aCurrentMsgKey) {</span>
<a href="#l1.1058"></a><span id="l1.1058">     int32_t currentIndex;</span>
<a href="#l1.1059"></a><span id="l1.1059">     if (NS_SUCCEEDED(mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex)) &amp;&amp;</span>
<a href="#l1.1060"></a><span id="l1.1060">         currentIndex &gt;= 0 &amp;&amp; uint32_t(currentIndex) &lt; GetSize())</span>
<a href="#l1.1061"></a><span id="l1.1061">       *aCurrentMsgKey = m_keys[currentIndex];</span>
<a href="#l1.1062"></a><span id="l1.1062">     else</span>
<a href="#l1.1063"></a><span id="l1.1063">       *aCurrentMsgKey = nsMsgKey_None;</span>
<a href="#l1.1064"></a><span id="l1.1064">   }</span>
<a href="#l1.1065"></a><span id="l1.1065"> </span>
<a href="#l1.1066"></a><span id="l1.1066">   // Third, get an array of view indices for the selection.</span>
<a href="#l1.1067"></a><span id="l1.1067">   nsMsgViewIndexArray selection;</span>
<a href="#l1.1068"></a><span id="l1.1068">   GetSelectedIndices(selection);</span>
<a href="#l1.1069"></a><span id="l1.1069">   int32_t numIndices = selection.Length();</span>
<a href="#l1.1070"></a><span id="l1.1070">   aMsgKeyArray.SetLength(numIndices);</span>
<a href="#l1.1071"></a><span id="l1.1071"> </span>
<a href="#l1.1072"></a><span id="l1.1072">   // Now store the msg key for each selected item.</span>
<a href="#l1.1073"></a><span id="l1.1073">   nsMsgKey msgKey;</span>
<a href="#l1.1074"></a><span id="l1.1074" class="difflineminus">-  for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l1.1075"></a><span id="l1.1075" class="difflineminus">-  {</span>
<a href="#l1.1076"></a><span id="l1.1076" class="difflineplus">+  for (int32_t index = 0; index &lt; numIndices; index++) {</span>
<a href="#l1.1077"></a><span id="l1.1077">     msgKey = m_keys[selection[index]];</span>
<a href="#l1.1078"></a><span id="l1.1078">     aMsgKeyArray[index] = msgKey;</span>
<a href="#l1.1079"></a><span id="l1.1079">   }</span>
<a href="#l1.1080"></a><span id="l1.1080"> </span>
<a href="#l1.1081"></a><span id="l1.1081">   // Clear the selection, we'll manually restore it later.</span>
<a href="#l1.1082"></a><span id="l1.1082" class="difflineminus">-  if (mTreeSelection)</span>
<a href="#l1.1083"></a><span id="l1.1083" class="difflineminus">-    mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.1084"></a><span id="l1.1084" class="difflineminus">-</span>
<a href="#l1.1085"></a><span id="l1.1085" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.1086"></a><span id="l1.1086" class="difflineminus">-}</span>
<a href="#l1.1087"></a><span id="l1.1087" class="difflineminus">-</span>
<a href="#l1.1088"></a><span id="l1.1088" class="difflineminus">-nsresult</span>
<a href="#l1.1089"></a><span id="l1.1089" class="difflineminus">-nsMsgDBView::RestoreSelection(nsMsgKey aCurrentMsgKey,</span>
<a href="#l1.1090"></a><span id="l1.1090" class="difflineminus">-                              nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray)</span>
<a href="#l1.1091"></a><span id="l1.1091" class="difflineminus">-{</span>
<a href="#l1.1092"></a><span id="l1.1092" class="difflineplus">+  if (mTreeSelection) mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.1093"></a><span id="l1.1093" class="difflineplus">+</span>
<a href="#l1.1094"></a><span id="l1.1094" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.1095"></a><span id="l1.1095" class="difflineplus">+}</span>
<a href="#l1.1096"></a><span id="l1.1096" class="difflineplus">+</span>
<a href="#l1.1097"></a><span id="l1.1097" class="difflineplus">+nsresult nsMsgDBView::RestoreSelection(nsMsgKey aCurrentMsgKey,</span>
<a href="#l1.1098"></a><span id="l1.1098" class="difflineplus">+                                       nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray) {</span>
<a href="#l1.1099"></a><span id="l1.1099">   // We don't do anything on nested Save / Restore calls.</span>
<a href="#l1.1100"></a><span id="l1.1100">   m_saveRestoreSelectionDepth--;</span>
<a href="#l1.1101"></a><span id="l1.1101" class="difflineminus">-  if (m_saveRestoreSelectionDepth)</span>
<a href="#l1.1102"></a><span id="l1.1102" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1103"></a><span id="l1.1103" class="difflineplus">+  if (m_saveRestoreSelectionDepth) return NS_OK;</span>
<a href="#l1.1104"></a><span id="l1.1104"> </span>
<a href="#l1.1105"></a><span id="l1.1105">   // Don't assert.</span>
<a href="#l1.1106"></a><span id="l1.1106" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.1107"></a><span id="l1.1107" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1108"></a><span id="l1.1108" class="difflineplus">+  if (!mTreeSelection) return NS_OK;</span>
<a href="#l1.1109"></a><span id="l1.1109"> </span>
<a href="#l1.1110"></a><span id="l1.1110">   // Turn our message keys into corresponding view indices.</span>
<a href="#l1.1111"></a><span id="l1.1111">   int32_t arraySize = aMsgKeyArray.Length();</span>
<a href="#l1.1112"></a><span id="l1.1112" class="difflineminus">-  nsMsgViewIndex  currentViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.1113"></a><span id="l1.1113" class="difflineminus">-  nsMsgViewIndex  newViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.1114"></a><span id="l1.1114" class="difflineplus">+  nsMsgViewIndex currentViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.1115"></a><span id="l1.1115" class="difflineplus">+  nsMsgViewIndex newViewPosition = nsMsgViewIndex_None;</span>
<a href="#l1.1116"></a><span id="l1.1116"> </span>
<a href="#l1.1117"></a><span id="l1.1117">   // If we are threaded, we need to do a little more work</span>
<a href="#l1.1118"></a><span id="l1.1118">   // we need to find (and expand) all the threads that contain messages</span>
<a href="#l1.1119"></a><span id="l1.1119">   // that we had selected before.</span>
<a href="#l1.1120"></a><span id="l1.1120" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1121"></a><span id="l1.1121" class="difflineminus">-  {</span>
<a href="#l1.1122"></a><span id="l1.1122" class="difflineminus">-    for (int32_t index = 0; index &lt; arraySize; index ++)</span>
<a href="#l1.1123"></a><span id="l1.1123" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.1124"></a><span id="l1.1124" class="difflineplus">+    for (int32_t index = 0; index &lt; arraySize; index++)</span>
<a href="#l1.1125"></a><span id="l1.1125">       FindKey(aMsgKeyArray[index], true /* expand */);</span>
<a href="#l1.1126"></a><span id="l1.1126">   }</span>
<a href="#l1.1127"></a><span id="l1.1127"> </span>
<a href="#l1.1128"></a><span id="l1.1128" class="difflineminus">-  for (int32_t index = 0; index &lt; arraySize; index ++)</span>
<a href="#l1.1129"></a><span id="l1.1129" class="difflineminus">-  {</span>
<a href="#l1.1130"></a><span id="l1.1130" class="difflineplus">+  for (int32_t index = 0; index &lt; arraySize; index++) {</span>
<a href="#l1.1131"></a><span id="l1.1131">     newViewPosition = FindKey(aMsgKeyArray[index], false);</span>
<a href="#l1.1132"></a><span id="l1.1132">     // Add the index back to the selection.</span>
<a href="#l1.1133"></a><span id="l1.1133">     if (newViewPosition != nsMsgViewIndex_None)</span>
<a href="#l1.1134"></a><span id="l1.1134">       mTreeSelection-&gt;ToggleSelect(newViewPosition);</span>
<a href="#l1.1135"></a><span id="l1.1135">   }</span>
<a href="#l1.1136"></a><span id="l1.1136"> </span>
<a href="#l1.1137"></a><span id="l1.1137">   // Make sure the currentView was preserved.</span>
<a href="#l1.1138"></a><span id="l1.1138">   if (aCurrentMsgKey != nsMsgKey_None)</span>
<a href="#l1.1139"></a><span id="l1.1139">     currentViewPosition = FindKey(aCurrentMsgKey, true);</span>
<a href="#l1.1140"></a><span id="l1.1140"> </span>
<a href="#l1.1141"></a><span id="l1.1141" class="difflineminus">-  if (mTree)</span>
<a href="#l1.1142"></a><span id="l1.1142" class="difflineminus">-    mTreeSelection-&gt;SetCurrentIndex(currentViewPosition);</span>
<a href="#l1.1143"></a><span id="l1.1143" class="difflineplus">+  if (mTree) mTreeSelection-&gt;SetCurrentIndex(currentViewPosition);</span>
<a href="#l1.1144"></a><span id="l1.1144"> </span>
<a href="#l1.1145"></a><span id="l1.1145">   // Make sure the current message is once again visible in the thread pane</span>
<a href="#l1.1146"></a><span id="l1.1146">   // so we don't have to go search for it in the thread pane</span>
<a href="#l1.1147"></a><span id="l1.1147">   if (mTree &amp;&amp; currentViewPosition != nsMsgViewIndex_None)</span>
<a href="#l1.1148"></a><span id="l1.1148">     mTree-&gt;EnsureRowIsVisible(currentViewPosition);</span>
<a href="#l1.1149"></a><span id="l1.1149"> </span>
<a href="#l1.1150"></a><span id="l1.1150">   // Unfreeze selection.</span>
<a href="#l1.1151"></a><span id="l1.1151">   mTreeSelection-&gt;SetSelectEventsSuppressed(false);</span>
<a href="#l1.1152"></a><span id="l1.1152">   return NS_OK;</span>
<a href="#l1.1153"></a><span id="l1.1153"> }</span>
<a href="#l1.1154"></a><span id="l1.1154"> </span>
<a href="#l1.1155"></a><span id="l1.1155" class="difflineminus">-nsresult</span>
<a href="#l1.1156"></a><span id="l1.1156" class="difflineminus">-nsMsgDBView::GenerateURIForMsgKey(nsMsgKey aMsgKey,</span>
<a href="#l1.1157"></a><span id="l1.1157" class="difflineminus">-                                  nsIMsgFolder *folder,</span>
<a href="#l1.1158"></a><span id="l1.1158" class="difflineminus">-                                  nsACString &amp; aURI)</span>
<a href="#l1.1159"></a><span id="l1.1159" class="difflineminus">-{</span>
<a href="#l1.1160"></a><span id="l1.1160" class="difflineplus">+nsresult nsMsgDBView::GenerateURIForMsgKey(nsMsgKey aMsgKey,</span>
<a href="#l1.1161"></a><span id="l1.1161" class="difflineplus">+                                           nsIMsgFolder *folder,</span>
<a href="#l1.1162"></a><span id="l1.1162" class="difflineplus">+                                           nsACString &amp;aURI) {</span>
<a href="#l1.1163"></a><span id="l1.1163">   NS_ENSURE_ARG(folder);</span>
<a href="#l1.1164"></a><span id="l1.1164">   return folder-&gt;GenerateMessageURI(aMsgKey, aURI);</span>
<a href="#l1.1165"></a><span id="l1.1165"> }</span>
<a href="#l1.1166"></a><span id="l1.1166"> </span>
<a href="#l1.1167"></a><span id="l1.1167" class="difflineminus">-nsresult</span>
<a href="#l1.1168"></a><span id="l1.1168" class="difflineminus">-nsMsgDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.1169"></a><span id="l1.1169" class="difflineminus">-{</span>
<a href="#l1.1170"></a><span id="l1.1170" class="difflineplus">+nsresult nsMsgDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator) {</span>
<a href="#l1.1171"></a><span id="l1.1171">   return m_db-&gt;EnumerateMessages(enumerator);</span>
<a href="#l1.1172"></a><span id="l1.1172"> }</span>
<a href="#l1.1173"></a><span id="l1.1173"> </span>
<a href="#l1.1174"></a><span id="l1.1174"> NS_IMETHODIMP</span>
<a href="#l1.1175"></a><span id="l1.1175" class="difflineminus">-nsMsgDBView::IsEditable(int32_t row,</span>
<a href="#l1.1176"></a><span id="l1.1176" class="difflineminus">-                        nsTreeColumn* col,</span>
<a href="#l1.1177"></a><span id="l1.1177" class="difflineminus">-                        bool* _retval)</span>
<a href="#l1.1178"></a><span id="l1.1178" class="difflineminus">-{</span>
<a href="#l1.1179"></a><span id="l1.1179" class="difflineplus">+nsMsgDBView::IsEditable(int32_t row, nsTreeColumn *col, bool *_retval) {</span>
<a href="#l1.1180"></a><span id="l1.1180">   NS_ENSURE_ARG_POINTER(col);</span>
<a href="#l1.1181"></a><span id="l1.1181">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.1182"></a><span id="l1.1182">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l1.1183"></a><span id="l1.1183">   // return.</span>
<a href="#l1.1184"></a><span id="l1.1184" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l1.1185"></a><span id="l1.1185" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1186"></a><span id="l1.1186" class="difflineminus">-</span>
<a href="#l1.1187"></a><span id="l1.1187" class="difflineminus">-  if (colHandler)</span>
<a href="#l1.1188"></a><span id="l1.1188" class="difflineminus">-  {</span>
<a href="#l1.1189"></a><span id="l1.1189" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l1.1190"></a><span id="l1.1190" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1191"></a><span id="l1.1191" class="difflineplus">+</span>
<a href="#l1.1192"></a><span id="l1.1192" class="difflineplus">+  if (colHandler) {</span>
<a href="#l1.1193"></a><span id="l1.1193">     colHandler-&gt;IsEditable(row, col, _retval);</span>
<a href="#l1.1194"></a><span id="l1.1194">     return NS_OK;</span>
<a href="#l1.1195"></a><span id="l1.1195">   }</span>
<a href="#l1.1196"></a><span id="l1.1196"> </span>
<a href="#l1.1197"></a><span id="l1.1197">   *_retval = false;</span>
<a href="#l1.1198"></a><span id="l1.1198">   return NS_OK;</span>
<a href="#l1.1199"></a><span id="l1.1199"> }</span>
<a href="#l1.1200"></a><span id="l1.1200"> </span>
<a href="#l1.1201"></a><span id="l1.1201"> NS_IMETHODIMP</span>
<a href="#l1.1202"></a><span id="l1.1202" class="difflineminus">-nsMsgDBView::SetCellValue(int32_t row,</span>
<a href="#l1.1203"></a><span id="l1.1203" class="difflineminus">-                          nsTreeColumn* col,</span>
<a href="#l1.1204"></a><span id="l1.1204" class="difflineminus">-                          const nsAString&amp; value)</span>
<a href="#l1.1205"></a><span id="l1.1205" class="difflineminus">-{</span>
<a href="#l1.1206"></a><span id="l1.1206" class="difflineplus">+nsMsgDBView::SetCellValue(int32_t row, nsTreeColumn *col,</span>
<a href="#l1.1207"></a><span id="l1.1207" class="difflineplus">+                          const nsAString &amp;value) {</span>
<a href="#l1.1208"></a><span id="l1.1208">   return NS_OK;</span>
<a href="#l1.1209"></a><span id="l1.1209"> }</span>
<a href="#l1.1210"></a><span id="l1.1210"> </span>
<a href="#l1.1211"></a><span id="l1.1211"> NS_IMETHODIMP</span>
<a href="#l1.1212"></a><span id="l1.1212" class="difflineminus">-nsMsgDBView::SetCellText(int32_t row,</span>
<a href="#l1.1213"></a><span id="l1.1213" class="difflineminus">-                         nsTreeColumn* col,</span>
<a href="#l1.1214"></a><span id="l1.1214" class="difflineminus">-                         const nsAString&amp; value)</span>
<a href="#l1.1215"></a><span id="l1.1215" class="difflineminus">-{</span>
<a href="#l1.1216"></a><span id="l1.1216" class="difflineplus">+nsMsgDBView::SetCellText(int32_t row, nsTreeColumn *col,</span>
<a href="#l1.1217"></a><span id="l1.1217" class="difflineplus">+                         const nsAString &amp;value) {</span>
<a href="#l1.1218"></a><span id="l1.1218">   return NS_OK;</span>
<a href="#l1.1219"></a><span id="l1.1219"> }</span>
<a href="#l1.1220"></a><span id="l1.1220"> </span>
<a href="#l1.1221"></a><span id="l1.1221"> NS_IMETHODIMP</span>
<a href="#l1.1222"></a><span id="l1.1222" class="difflineminus">-nsMsgDBView::GetRowCount(int32_t *aRowCount)</span>
<a href="#l1.1223"></a><span id="l1.1223" class="difflineminus">-{</span>
<a href="#l1.1224"></a><span id="l1.1224" class="difflineplus">+nsMsgDBView::GetRowCount(int32_t *aRowCount) {</span>
<a href="#l1.1225"></a><span id="l1.1225">   *aRowCount = GetSize();</span>
<a href="#l1.1226"></a><span id="l1.1226">   return NS_OK;</span>
<a href="#l1.1227"></a><span id="l1.1227"> }</span>
<a href="#l1.1228"></a><span id="l1.1228"> </span>
<a href="#l1.1229"></a><span id="l1.1229"> NS_IMETHODIMP</span>
<a href="#l1.1230"></a><span id="l1.1230" class="difflineminus">-nsMsgDBView::GetSelection(nsITreeSelection * *aSelection)</span>
<a href="#l1.1231"></a><span id="l1.1231" class="difflineminus">-{</span>
<a href="#l1.1232"></a><span id="l1.1232" class="difflineplus">+nsMsgDBView::GetSelection(nsITreeSelection **aSelection) {</span>
<a href="#l1.1233"></a><span id="l1.1233">   NS_IF_ADDREF(*aSelection = mTreeSelection);</span>
<a href="#l1.1234"></a><span id="l1.1234">   return NS_OK;</span>
<a href="#l1.1235"></a><span id="l1.1235"> }</span>
<a href="#l1.1236"></a><span id="l1.1236"> </span>
<a href="#l1.1237"></a><span id="l1.1237"> NS_IMETHODIMP</span>
<a href="#l1.1238"></a><span id="l1.1238" class="difflineminus">-nsMsgDBView::SetSelection(nsITreeSelection * aSelection)</span>
<a href="#l1.1239"></a><span id="l1.1239" class="difflineminus">-{</span>
<a href="#l1.1240"></a><span id="l1.1240" class="difflineplus">+nsMsgDBView::SetSelection(nsITreeSelection *aSelection) {</span>
<a href="#l1.1241"></a><span id="l1.1241">   mTreeSelection = aSelection;</span>
<a href="#l1.1242"></a><span id="l1.1242">   return NS_OK;</span>
<a href="#l1.1243"></a><span id="l1.1243"> }</span>
<a href="#l1.1244"></a><span id="l1.1244"> </span>
<a href="#l1.1245"></a><span id="l1.1245"> NS_IMETHODIMP</span>
<a href="#l1.1246"></a><span id="l1.1246" class="difflineminus">-nsMsgDBView::ReloadMessageWithAllParts()</span>
<a href="#l1.1247"></a><span id="l1.1247" class="difflineminus">-{</span>
<a href="#l1.1248"></a><span id="l1.1248" class="difflineminus">-  if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay)</span>
<a href="#l1.1249"></a><span id="l1.1249" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1250"></a><span id="l1.1250" class="difflineplus">+nsMsgDBView::ReloadMessageWithAllParts() {</span>
<a href="#l1.1251"></a><span id="l1.1251" class="difflineplus">+  if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay) return NS_OK;</span>
<a href="#l1.1252"></a><span id="l1.1252"> </span>
<a href="#l1.1253"></a><span id="l1.1253">   nsAutoCString forceAllParts(m_currentlyDisplayedMsgUri);</span>
<a href="#l1.1254"></a><span id="l1.1254">   forceAllParts += (forceAllParts.FindChar('?') == kNotFound) ? '?' : '&amp;';</span>
<a href="#l1.1255"></a><span id="l1.1255">   forceAllParts.AppendLiteral(&quot;fetchCompleteMessage=true&quot;);</span>
<a href="#l1.1256"></a><span id="l1.1256" class="difflineminus">-  nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1257"></a><span id="l1.1257" class="difflineplus">+  nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1258"></a><span id="l1.1258">   NS_ENSURE_TRUE(messenger, NS_ERROR_FAILURE);</span>
<a href="#l1.1259"></a><span id="l1.1259"> </span>
<a href="#l1.1260"></a><span id="l1.1260">   nsresult rv = messenger-&gt;OpenURL(forceAllParts);</span>
<a href="#l1.1261"></a><span id="l1.1261">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1262"></a><span id="l1.1262"> </span>
<a href="#l1.1263"></a><span id="l1.1263">   UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1264"></a><span id="l1.1264">   return NS_OK;</span>
<a href="#l1.1265"></a><span id="l1.1265"> }</span>
<a href="#l1.1266"></a><span id="l1.1266"> </span>
<a href="#l1.1267"></a><span id="l1.1267"> NS_IMETHODIMP</span>
<a href="#l1.1268"></a><span id="l1.1268" class="difflineminus">-nsMsgDBView::ReloadMessage()</span>
<a href="#l1.1269"></a><span id="l1.1269" class="difflineminus">-{</span>
<a href="#l1.1270"></a><span id="l1.1270" class="difflineminus">-  if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay)</span>
<a href="#l1.1271"></a><span id="l1.1271" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1272"></a><span id="l1.1272" class="difflineminus">-</span>
<a href="#l1.1273"></a><span id="l1.1273" class="difflineminus">-  nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1274"></a><span id="l1.1274" class="difflineplus">+nsMsgDBView::ReloadMessage() {</span>
<a href="#l1.1275"></a><span id="l1.1275" class="difflineplus">+  if (m_currentlyDisplayedMsgUri.IsEmpty() || mSuppressMsgDisplay) return NS_OK;</span>
<a href="#l1.1276"></a><span id="l1.1276" class="difflineplus">+</span>
<a href="#l1.1277"></a><span id="l1.1277" class="difflineplus">+  nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1278"></a><span id="l1.1278">   NS_ENSURE_TRUE(messenger, NS_ERROR_FAILURE);</span>
<a href="#l1.1279"></a><span id="l1.1279"> </span>
<a href="#l1.1280"></a><span id="l1.1280">   nsresult rv = messenger-&gt;OpenURL(m_currentlyDisplayedMsgUri);</span>
<a href="#l1.1281"></a><span id="l1.1281">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1282"></a><span id="l1.1282"> </span>
<a href="#l1.1283"></a><span id="l1.1283">   UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1284"></a><span id="l1.1284">   return NS_OK;</span>
<a href="#l1.1285"></a><span id="l1.1285"> }</span>
<a href="#l1.1286"></a><span id="l1.1286"> </span>
<a href="#l1.1287"></a><span id="l1.1287" class="difflineminus">-nsresult</span>
<a href="#l1.1288"></a><span id="l1.1288" class="difflineminus">-nsMsgDBView::UpdateDisplayMessage(nsMsgViewIndex viewPosition)</span>
<a href="#l1.1289"></a><span id="l1.1289" class="difflineminus">-{</span>
<a href="#l1.1290"></a><span id="l1.1290" class="difflineminus">-  if (!mCommandUpdater)</span>
<a href="#l1.1291"></a><span id="l1.1291" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1292"></a><span id="l1.1292" class="difflineminus">-</span>
<a href="#l1.1293"></a><span id="l1.1293" class="difflineminus">-  if (!IsValidIndex(viewPosition))</span>
<a href="#l1.1294"></a><span id="l1.1294" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1295"></a><span id="l1.1295" class="difflineplus">+nsresult nsMsgDBView::UpdateDisplayMessage(nsMsgViewIndex viewPosition) {</span>
<a href="#l1.1296"></a><span id="l1.1296" class="difflineplus">+  if (!mCommandUpdater) return NS_OK;</span>
<a href="#l1.1297"></a><span id="l1.1297" class="difflineplus">+</span>
<a href="#l1.1298"></a><span id="l1.1298" class="difflineplus">+  if (!IsValidIndex(viewPosition)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1299"></a><span id="l1.1299"> </span>
<a href="#l1.1300"></a><span id="l1.1300">   // Get the subject and the folder for the message and inform the front</span>
<a href="#l1.1301"></a><span id="l1.1301">   // end that we changed the message we are currently displaying.</span>
<a href="#l1.1302"></a><span id="l1.1302">   nsresult rv;</span>
<a href="#l1.1303"></a><span id="l1.1303" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1304"></a><span id="l1.1304" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1305"></a><span id="l1.1305">   rv = GetMsgHdrForViewIndex(viewPosition, getter_AddRefs(msgHdr));</span>
<a href="#l1.1306"></a><span id="l1.1306" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1307"></a><span id="l1.1307" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1308"></a><span id="l1.1308"> </span>
<a href="#l1.1309"></a><span id="l1.1309">   nsString subject;</span>
<a href="#l1.1310"></a><span id="l1.1310">   if (viewPosition &gt;= (nsMsgViewIndex)m_flags.Length())</span>
<a href="#l1.1311"></a><span id="l1.1311">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1312"></a><span id="l1.1312">   FetchSubject(msgHdr, m_flags[viewPosition], subject);</span>
<a href="#l1.1313"></a><span id="l1.1313"> </span>
<a href="#l1.1314"></a><span id="l1.1314">   nsCString keywords;</span>
<a href="#l1.1315"></a><span id="l1.1315">   rv = msgHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywords));</span>
<a href="#l1.1316"></a><span id="l1.1316" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1317"></a><span id="l1.1317" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1318"></a><span id="l1.1318"> </span>
<a href="#l1.1319"></a><span id="l1.1319">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = m_viewFolder ? m_viewFolder : m_folder;</span>
<a href="#l1.1320"></a><span id="l1.1320"> </span>
<a href="#l1.1321"></a><span id="l1.1321">   mCommandUpdater-&gt;DisplayMessageChanged(folder, subject, keywords);</span>
<a href="#l1.1322"></a><span id="l1.1322"> </span>
<a href="#l1.1323"></a><span id="l1.1323" class="difflineminus">-  if (folder)</span>
<a href="#l1.1324"></a><span id="l1.1324" class="difflineminus">-  {</span>
<a href="#l1.1325"></a><span id="l1.1325" class="difflineplus">+  if (folder) {</span>
<a href="#l1.1326"></a><span id="l1.1326">     if (viewPosition &gt;= (nsMsgViewIndex)m_keys.Length())</span>
<a href="#l1.1327"></a><span id="l1.1327">       return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1328"></a><span id="l1.1328">     rv = folder-&gt;SetLastMessageLoaded(m_keys[viewPosition]);</span>
<a href="#l1.1329"></a><span id="l1.1329" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1330"></a><span id="l1.1330" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1331"></a><span id="l1.1331">   }</span>
<a href="#l1.1332"></a><span id="l1.1332"> </span>
<a href="#l1.1333"></a><span id="l1.1333">   return NS_OK;</span>
<a href="#l1.1334"></a><span id="l1.1334"> }</span>
<a href="#l1.1335"></a><span id="l1.1335"> </span>
<a href="#l1.1336"></a><span id="l1.1336"> // Given a msg key, we will load the message for it.</span>
<a href="#l1.1337"></a><span id="l1.1337"> NS_IMETHODIMP</span>
<a href="#l1.1338"></a><span id="l1.1338" class="difflineminus">-nsMsgDBView::LoadMessageByMsgKey(nsMsgKey aMsgKey)</span>
<a href="#l1.1339"></a><span id="l1.1339" class="difflineminus">-{</span>
<a href="#l1.1340"></a><span id="l1.1340" class="difflineplus">+nsMsgDBView::LoadMessageByMsgKey(nsMsgKey aMsgKey) {</span>
<a href="#l1.1341"></a><span id="l1.1341">   return LoadMessageByViewIndex(FindKey(aMsgKey, false));</span>
<a href="#l1.1342"></a><span id="l1.1342"> }</span>
<a href="#l1.1343"></a><span id="l1.1343"> </span>
<a href="#l1.1344"></a><span id="l1.1344"> NS_IMETHODIMP</span>
<a href="#l1.1345"></a><span id="l1.1345" class="difflineminus">-nsMsgDBView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.1346"></a><span id="l1.1346" class="difflineminus">-{</span>
<a href="#l1.1347"></a><span id="l1.1347" class="difflineminus">-  if (!IsValidIndex(aViewIndex))</span>
<a href="#l1.1348"></a><span id="l1.1348" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1349"></a><span id="l1.1349" class="difflineplus">+nsMsgDBView::LoadMessageByViewIndex(nsMsgViewIndex aViewIndex) {</span>
<a href="#l1.1350"></a><span id="l1.1350" class="difflineplus">+  if (!IsValidIndex(aViewIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1351"></a><span id="l1.1351"> </span>
<a href="#l1.1352"></a><span id="l1.1352">   nsCString uri;</span>
<a href="#l1.1353"></a><span id="l1.1353">   nsresult rv = GetURIForViewIndex(aViewIndex, uri);</span>
<a href="#l1.1354"></a><span id="l1.1354" class="difflineminus">-  if (!mSuppressMsgDisplay &amp;&amp; !m_currentlyDisplayedMsgUri.Equals(uri))</span>
<a href="#l1.1355"></a><span id="l1.1355" class="difflineminus">-  {</span>
<a href="#l1.1356"></a><span id="l1.1356" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.1357"></a><span id="l1.1357" class="difflineminus">-    nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1358"></a><span id="l1.1358" class="difflineplus">+  if (!mSuppressMsgDisplay &amp;&amp; !m_currentlyDisplayedMsgUri.Equals(uri)) {</span>
<a href="#l1.1359"></a><span id="l1.1359" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1360"></a><span id="l1.1360" class="difflineplus">+    nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.1361"></a><span id="l1.1361">     NS_ENSURE_TRUE(messenger, NS_ERROR_FAILURE);</span>
<a href="#l1.1362"></a><span id="l1.1362">     messenger-&gt;OpenURL(uri);</span>
<a href="#l1.1363"></a><span id="l1.1363">     if (aViewIndex &gt;= (nsMsgViewIndex)m_keys.Length())</span>
<a href="#l1.1364"></a><span id="l1.1364">       return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1365"></a><span id="l1.1365">     m_currentlyDisplayedMsgKey = m_keys[aViewIndex];</span>
<a href="#l1.1366"></a><span id="l1.1366">     m_currentlyDisplayedMsgUri = uri;</span>
<a href="#l1.1367"></a><span id="l1.1367">     m_currentlyDisplayedViewIndex = aViewIndex;</span>
<a href="#l1.1368"></a><span id="l1.1368">     UpdateDisplayMessage(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.1369"></a><span id="l1.1369">   }</span>
<a href="#l1.1370"></a><span id="l1.1370"> </span>
<a href="#l1.1371"></a><span id="l1.1371">   return NS_OK;</span>
<a href="#l1.1372"></a><span id="l1.1372"> }</span>
<a href="#l1.1373"></a><span id="l1.1373"> </span>
<a href="#l1.1374"></a><span id="l1.1374"> NS_IMETHODIMP</span>
<a href="#l1.1375"></a><span id="l1.1375" class="difflineminus">-nsMsgDBView::LoadMessageByUrl(const char *aUrl)</span>
<a href="#l1.1376"></a><span id="l1.1376" class="difflineminus">-{</span>
<a href="#l1.1377"></a><span id="l1.1377" class="difflineplus">+nsMsgDBView::LoadMessageByUrl(const char *aUrl) {</span>
<a href="#l1.1378"></a><span id="l1.1378">   NS_ASSERTION(aUrl, &quot;trying to load a null url&quot;);</span>
<a href="#l1.1379"></a><span id="l1.1379" class="difflineminus">-  if (!mSuppressMsgDisplay)</span>
<a href="#l1.1380"></a><span id="l1.1380" class="difflineminus">-  {</span>
<a href="#l1.1381"></a><span id="l1.1381" class="difflineplus">+  if (!mSuppressMsgDisplay) {</span>
<a href="#l1.1382"></a><span id="l1.1382">     nsresult rv;</span>
<a href="#l1.1383"></a><span id="l1.1383" class="difflineminus">-    nsCOMPtr&lt;nsIMessenger&gt; messenger (do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.1384"></a><span id="l1.1384" class="difflineplus">+    nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.1385"></a><span id="l1.1385">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1386"></a><span id="l1.1386">     messenger-&gt;LoadURL(NULL, nsDependentCString(aUrl));</span>
<a href="#l1.1387"></a><span id="l1.1387">     m_currentlyDisplayedMsgKey = nsMsgKey_None;</span>
<a href="#l1.1388"></a><span id="l1.1388">     m_currentlyDisplayedMsgUri = aUrl;</span>
<a href="#l1.1389"></a><span id="l1.1389">     m_currentlyDisplayedViewIndex = nsMsgViewIndex_None;</span>
<a href="#l1.1390"></a><span id="l1.1390">   }</span>
<a href="#l1.1391"></a><span id="l1.1391"> </span>
<a href="#l1.1392"></a><span id="l1.1392">   return NS_OK;</span>
<a href="#l1.1393"></a><span id="l1.1393"> }</span>
<a href="#l1.1394"></a><span id="l1.1394"> </span>
<a href="#l1.1395"></a><span id="l1.1395"> NS_IMETHODIMP</span>
<a href="#l1.1396"></a><span id="l1.1396" class="difflineminus">-nsMsgDBView::SelectionChangedXPCOM()</span>
<a href="#l1.1397"></a><span id="l1.1397" class="difflineminus">-{</span>
<a href="#l1.1398"></a><span id="l1.1398" class="difflineplus">+nsMsgDBView::SelectionChangedXPCOM() {</span>
<a href="#l1.1399"></a><span id="l1.1399">   // If the currentSelection changed then we have a message to display -</span>
<a href="#l1.1400"></a><span id="l1.1400">   // not if we are in the middle of deleting rows.</span>
<a href="#l1.1401"></a><span id="l1.1401" class="difflineminus">-  if (m_deletingRows)</span>
<a href="#l1.1402"></a><span id="l1.1402" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.1403"></a><span id="l1.1403" class="difflineplus">+  if (m_deletingRows) return NS_OK;</span>
<a href="#l1.1404"></a><span id="l1.1404"> </span>
<a href="#l1.1405"></a><span id="l1.1405">   uint32_t numSelected = 0;</span>
<a href="#l1.1406"></a><span id="l1.1406"> </span>
<a href="#l1.1407"></a><span id="l1.1407">   nsMsgViewIndexArray selection;</span>
<a href="#l1.1408"></a><span id="l1.1408">   GetSelectedIndices(selection);</span>
<a href="#l1.1409"></a><span id="l1.1409">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.1410"></a><span id="l1.1410">   numSelected = selection.Length();</span>
<a href="#l1.1411"></a><span id="l1.1411"> </span>
<a href="#l1.1412"></a><span id="l1.1412">   bool commandsNeedDisablingBecauseOfSelection = false;</span>
<a href="#l1.1413"></a><span id="l1.1413"> </span>
<a href="#l1.1414"></a><span id="l1.1414" class="difflineminus">-  if(indices)</span>
<a href="#l1.1415"></a><span id="l1.1415" class="difflineminus">-  {</span>
<a href="#l1.1416"></a><span id="l1.1416" class="difflineplus">+  if (indices) {</span>
<a href="#l1.1417"></a><span id="l1.1417">     if (WeAreOffline())</span>
<a href="#l1.1418"></a><span id="l1.1418" class="difflineminus">-      commandsNeedDisablingBecauseOfSelection = !OfflineMsgSelected(indices, numSelected);</span>
<a href="#l1.1419"></a><span id="l1.1419" class="difflineplus">+      commandsNeedDisablingBecauseOfSelection =</span>
<a href="#l1.1420"></a><span id="l1.1420" class="difflineplus">+          !OfflineMsgSelected(indices, numSelected);</span>
<a href="#l1.1421"></a><span id="l1.1421"> </span>
<a href="#l1.1422"></a><span id="l1.1422">     if (!NonDummyMsgSelected(indices, numSelected))</span>
<a href="#l1.1423"></a><span id="l1.1423">       commandsNeedDisablingBecauseOfSelection = true;</span>
<a href="#l1.1424"></a><span id="l1.1424">   }</span>
<a href="#l1.1425"></a><span id="l1.1425"> </span>
<a href="#l1.1426"></a><span id="l1.1426">   bool selectionSummarized = false;</span>
<a href="#l1.1427"></a><span id="l1.1427">   mSummarizeFailed = false;</span>
<a href="#l1.1428"></a><span id="l1.1428">   // Let the front-end adjust the message pane appropriately with either</span>
<a href="#l1.1429"></a><span id="l1.1429">   // the message body, or a summary of the selection.</span>
<a href="#l1.1430"></a><span id="l1.1430" class="difflineminus">-  if (mCommandUpdater)</span>
<a href="#l1.1431"></a><span id="l1.1431" class="difflineminus">-  {</span>
<a href="#l1.1432"></a><span id="l1.1432" class="difflineplus">+  if (mCommandUpdater) {</span>
<a href="#l1.1433"></a><span id="l1.1433">     mCommandUpdater-&gt;SummarizeSelection(&amp;selectionSummarized);</span>
<a href="#l1.1434"></a><span id="l1.1434">     // Check if the selection was not summarized, but we expected it to be,</span>
<a href="#l1.1435"></a><span id="l1.1435">     // and if so, remember it so GetHeadersFromSelection won't include</span>
<a href="#l1.1436"></a><span id="l1.1436">     // the messages in collapsed threads.</span>
<a href="#l1.1437"></a><span id="l1.1437">     if (!selectionSummarized &amp;&amp;</span>
<a href="#l1.1438"></a><span id="l1.1438" class="difflineminus">-        (numSelected &gt; 1 || (numSelected == 1 &amp;&amp;</span>
<a href="#l1.1439"></a><span id="l1.1439" class="difflineminus">-                             m_flags[indices[0]] &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.1440"></a><span id="l1.1440" class="difflineminus">-                             OperateOnMsgsInCollapsedThreads())))</span>
<a href="#l1.1441"></a><span id="l1.1441" class="difflineminus">-    {</span>
<a href="#l1.1442"></a><span id="l1.1442" class="difflineplus">+        (numSelected &gt; 1 ||</span>
<a href="#l1.1443"></a><span id="l1.1443" class="difflineplus">+         (numSelected == 1 &amp;&amp; m_flags[indices[0]] &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.1444"></a><span id="l1.1444" class="difflineplus">+          OperateOnMsgsInCollapsedThreads()))) {</span>
<a href="#l1.1445"></a><span id="l1.1445">       mSummarizeFailed = true;</span>
<a href="#l1.1446"></a><span id="l1.1446">     }</span>
<a href="#l1.1447"></a><span id="l1.1447">   }</span>
<a href="#l1.1448"></a><span id="l1.1448"> </span>
<a href="#l1.1449"></a><span id="l1.1449">   bool summaryStateChanged = selectionSummarized != mSelectionSummarized;</span>
<a href="#l1.1450"></a><span id="l1.1450">   mSelectionSummarized = selectionSummarized;</span>
<a href="#l1.1451"></a><span id="l1.1451"> </span>
<a href="#l1.1452"></a><span id="l1.1452">   // If only one item is selected then we want to display a message.</span>
<a href="#l1.1453"></a><span id="l1.1453" class="difflineminus">-  if (mTreeSelection &amp;&amp; numSelected == 1 &amp;&amp; !selectionSummarized)</span>
<a href="#l1.1454"></a><span id="l1.1454" class="difflineminus">-  {</span>
<a href="#l1.1455"></a><span id="l1.1455" class="difflineplus">+  if (mTreeSelection &amp;&amp; numSelected == 1 &amp;&amp; !selectionSummarized) {</span>
<a href="#l1.1456"></a><span id="l1.1456">     int32_t startRange;</span>
<a href="#l1.1457"></a><span id="l1.1457">     int32_t endRange;</span>
<a href="#l1.1458"></a><span id="l1.1458">     nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.1459"></a><span id="l1.1459">     // Tree doesn't care if we failed.</span>
<a href="#l1.1460"></a><span id="l1.1460">     NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l1.1461"></a><span id="l1.1461"> </span>
<a href="#l1.1462"></a><span id="l1.1462">     if (startRange &gt;= 0 &amp;&amp; startRange == endRange &amp;&amp;</span>
<a href="#l1.1463"></a><span id="l1.1463" class="difflineminus">-        uint32_t(startRange) &lt; GetSize())</span>
<a href="#l1.1464"></a><span id="l1.1464" class="difflineminus">-    {</span>
<a href="#l1.1465"></a><span id="l1.1465" class="difflineminus">-      if (!mRemovingRow)</span>
<a href="#l1.1466"></a><span id="l1.1466" class="difflineminus">-      {</span>
<a href="#l1.1467"></a><span id="l1.1467" class="difflineplus">+        uint32_t(startRange) &lt; GetSize()) {</span>
<a href="#l1.1468"></a><span id="l1.1468" class="difflineplus">+      if (!mRemovingRow) {</span>
<a href="#l1.1469"></a><span id="l1.1469">         if (!mSuppressMsgDisplay)</span>
<a href="#l1.1470"></a><span id="l1.1470">           LoadMessageByViewIndex(startRange);</span>
<a href="#l1.1471"></a><span id="l1.1471">         else</span>
<a href="#l1.1472"></a><span id="l1.1472">           UpdateDisplayMessage(startRange);</span>
<a href="#l1.1473"></a><span id="l1.1473">       }</span>
<a href="#l1.1474"></a><span id="l1.1474" class="difflineminus">-    }</span>
<a href="#l1.1475"></a><span id="l1.1475" class="difflineminus">-    else</span>
<a href="#l1.1476"></a><span id="l1.1476" class="difflineminus">-    {</span>
<a href="#l1.1477"></a><span id="l1.1477" class="difflineplus">+    } else {</span>
<a href="#l1.1478"></a><span id="l1.1478">       // Selection seems bogus, so set to 0.</span>
<a href="#l1.1479"></a><span id="l1.1479">       numSelected = 0;</span>
<a href="#l1.1480"></a><span id="l1.1480">     }</span>
<a href="#l1.1481"></a><span id="l1.1481" class="difflineminus">-  }</span>
<a href="#l1.1482"></a><span id="l1.1482" class="difflineminus">-  else {</span>
<a href="#l1.1483"></a><span id="l1.1483" class="difflineplus">+  } else {</span>
<a href="#l1.1484"></a><span id="l1.1484">     // If we have zero or multiple items selected, we shouldn't be displaying</span>
<a href="#l1.1485"></a><span id="l1.1485">     // any message.</span>
<a href="#l1.1486"></a><span id="l1.1486">     m_currentlyDisplayedMsgKey = nsMsgKey_None;</span>
<a href="#l1.1487"></a><span id="l1.1487">     m_currentlyDisplayedMsgUri.Truncate();</span>
<a href="#l1.1488"></a><span id="l1.1488">     m_currentlyDisplayedViewIndex = nsMsgViewIndex_None;</span>
<a href="#l1.1489"></a><span id="l1.1489">   }</span>
<a href="#l1.1490"></a><span id="l1.1490"> </span>
<a href="#l1.1491"></a><span id="l1.1491">   // Determine if we need to push command update notifications out to the UI.</span>
<a href="#l1.1492"></a><span id="l1.1492" class="difflineat">@@ -1343,224 +1173,190 @@ nsMsgDBView::SelectionChangedXPCOM()</span>
<a href="#l1.1493"></a><span id="l1.1493">   bool enableGoForward = false;</span>
<a href="#l1.1494"></a><span id="l1.1494">   bool enableGoBack = false;</span>
<a href="#l1.1495"></a><span id="l1.1495"> </span>
<a href="#l1.1496"></a><span id="l1.1496">   NavigateStatus(nsMsgNavigationType::forward, &amp;enableGoForward);</span>
<a href="#l1.1497"></a><span id="l1.1497">   NavigateStatus(nsMsgNavigationType::back, &amp;enableGoBack);</span>
<a href="#l1.1498"></a><span id="l1.1498">   if (!summaryStateChanged &amp;&amp;</span>
<a href="#l1.1499"></a><span id="l1.1499">       (numSelected == mNumSelectedRows ||</span>
<a href="#l1.1500"></a><span id="l1.1500">        (numSelected &gt; 1 &amp;&amp; mNumSelectedRows &gt; 1)) &amp;&amp;</span>
<a href="#l1.1501"></a><span id="l1.1501" class="difflineminus">-      commandsNeedDisablingBecauseOfSelection == mCommandsNeedDisablingBecauseOfSelection &amp;&amp;</span>
<a href="#l1.1502"></a><span id="l1.1502" class="difflineminus">-      enableGoForward == mGoForwardEnabled &amp;&amp;</span>
<a href="#l1.1503"></a><span id="l1.1503" class="difflineminus">-      enableGoBack == mGoBackEnabled)</span>
<a href="#l1.1504"></a><span id="l1.1504" class="difflineminus">-  {</span>
<a href="#l1.1505"></a><span id="l1.1505" class="difflineplus">+      commandsNeedDisablingBecauseOfSelection ==</span>
<a href="#l1.1506"></a><span id="l1.1506" class="difflineplus">+          mCommandsNeedDisablingBecauseOfSelection &amp;&amp;</span>
<a href="#l1.1507"></a><span id="l1.1507" class="difflineplus">+      enableGoForward == mGoForwardEnabled &amp;&amp; enableGoBack == mGoBackEnabled) {</span>
<a href="#l1.1508"></a><span id="l1.1508">     // Don't update commands if we're suppressing them, or if we're removing</span>
<a href="#l1.1509"></a><span id="l1.1509">     // rows, unless it was the last row.</span>
<a href="#l1.1510"></a><span id="l1.1510" class="difflineminus">-  }</span>
<a href="#l1.1511"></a><span id="l1.1511" class="difflineminus">-  else if (!mSuppressCommandUpdating &amp;&amp;</span>
<a href="#l1.1512"></a><span id="l1.1512" class="difflineminus">-           mCommandUpdater &amp;&amp;</span>
<a href="#l1.1513"></a><span id="l1.1513" class="difflineminus">-           (!mRemovingRow || GetSize() == 0))</span>
<a href="#l1.1514"></a><span id="l1.1514" class="difflineminus">-  {</span>
<a href="#l1.1515"></a><span id="l1.1515" class="difflineplus">+  } else if (!mSuppressCommandUpdating &amp;&amp; mCommandUpdater &amp;&amp;</span>
<a href="#l1.1516"></a><span id="l1.1516" class="difflineplus">+             (!mRemovingRow || GetSize() == 0)) {</span>
<a href="#l1.1517"></a><span id="l1.1517">     mCommandUpdater-&gt;UpdateCommandStatus();</span>
<a href="#l1.1518"></a><span id="l1.1518">   }</span>
<a href="#l1.1519"></a><span id="l1.1519"> </span>
<a href="#l1.1520"></a><span id="l1.1520" class="difflineminus">-  mCommandsNeedDisablingBecauseOfSelection = commandsNeedDisablingBecauseOfSelection;</span>
<a href="#l1.1521"></a><span id="l1.1521" class="difflineplus">+  mCommandsNeedDisablingBecauseOfSelection =</span>
<a href="#l1.1522"></a><span id="l1.1522" class="difflineplus">+      commandsNeedDisablingBecauseOfSelection;</span>
<a href="#l1.1523"></a><span id="l1.1523">   mGoForwardEnabled = enableGoForward;</span>
<a href="#l1.1524"></a><span id="l1.1524">   mGoBackEnabled = enableGoBack;</span>
<a href="#l1.1525"></a><span id="l1.1525">   mNumSelectedRows = numSelected;</span>
<a href="#l1.1526"></a><span id="l1.1526">   return NS_OK;</span>
<a href="#l1.1527"></a><span id="l1.1527"> }</span>
<a href="#l1.1528"></a><span id="l1.1528"> </span>
<a href="#l1.1529"></a><span id="l1.1529" class="difflineminus">-nsresult</span>
<a href="#l1.1530"></a><span id="l1.1530" class="difflineminus">-nsMsgDBView::GetSelectedIndices(nsMsgViewIndexArray&amp; selection)</span>
<a href="#l1.1531"></a><span id="l1.1531" class="difflineminus">-{</span>
<a href="#l1.1532"></a><span id="l1.1532" class="difflineminus">-  if (mTreeSelection)</span>
<a href="#l1.1533"></a><span id="l1.1533" class="difflineminus">-  {</span>
<a href="#l1.1534"></a><span id="l1.1534" class="difflineplus">+nsresult nsMsgDBView::GetSelectedIndices(nsMsgViewIndexArray &amp;selection) {</span>
<a href="#l1.1535"></a><span id="l1.1535" class="difflineplus">+  if (mTreeSelection) {</span>
<a href="#l1.1536"></a><span id="l1.1536">     int32_t viewSize = GetSize();</span>
<a href="#l1.1537"></a><span id="l1.1537">     int32_t count;</span>
<a href="#l1.1538"></a><span id="l1.1538">     mTreeSelection-&gt;GetCount(&amp;count);</span>
<a href="#l1.1539"></a><span id="l1.1539">     selection.SetLength(count);</span>
<a href="#l1.1540"></a><span id="l1.1540">     count = 0;</span>
<a href="#l1.1541"></a><span id="l1.1541">     int32_t selectionCount;</span>
<a href="#l1.1542"></a><span id="l1.1542">     mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l1.1543"></a><span id="l1.1543" class="difflineminus">-    for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l1.1544"></a><span id="l1.1544" class="difflineminus">-    {</span>
<a href="#l1.1545"></a><span id="l1.1545" class="difflineplus">+    for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l1.1546"></a><span id="l1.1546">       int32_t startRange = -1;</span>
<a href="#l1.1547"></a><span id="l1.1547">       int32_t endRange = -1;</span>
<a href="#l1.1548"></a><span id="l1.1548">       mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l1.1549"></a><span id="l1.1549" class="difflineminus">-      if (startRange &gt;= 0 &amp;&amp; startRange &lt; viewSize)</span>
<a href="#l1.1550"></a><span id="l1.1550" class="difflineminus">-      {</span>
<a href="#l1.1551"></a><span id="l1.1551" class="difflineplus">+      if (startRange &gt;= 0 &amp;&amp; startRange &lt; viewSize) {</span>
<a href="#l1.1552"></a><span id="l1.1552">         for (int32_t rangeIndex = startRange;</span>
<a href="#l1.1553"></a><span id="l1.1553" class="difflineminus">-             rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; viewSize;</span>
<a href="#l1.1554"></a><span id="l1.1554" class="difflineminus">-             rangeIndex++)</span>
<a href="#l1.1555"></a><span id="l1.1555" class="difflineminus">-        {</span>
<a href="#l1.1556"></a><span id="l1.1556" class="difflineplus">+             rangeIndex &lt;= endRange &amp;&amp; rangeIndex &lt; viewSize; rangeIndex++) {</span>
<a href="#l1.1557"></a><span id="l1.1557">           selection[count++] = rangeIndex;</span>
<a href="#l1.1558"></a><span id="l1.1558">         }</span>
<a href="#l1.1559"></a><span id="l1.1559">       }</span>
<a href="#l1.1560"></a><span id="l1.1560">     }</span>
<a href="#l1.1561"></a><span id="l1.1561"> </span>
<a href="#l1.1562"></a><span id="l1.1562">     NS_ASSERTION(selection.Length() == uint32_t(count),</span>
<a href="#l1.1563"></a><span id="l1.1563">                  &quot;selection count is wrong&quot;);</span>
<a href="#l1.1564"></a><span id="l1.1564">     selection.SetLength(count);</span>
<a href="#l1.1565"></a><span id="l1.1565" class="difflineminus">-  }</span>
<a href="#l1.1566"></a><span id="l1.1566" class="difflineminus">-  else</span>
<a href="#l1.1567"></a><span id="l1.1567" class="difflineminus">-  {</span>
<a href="#l1.1568"></a><span id="l1.1568" class="difflineplus">+  } else {</span>
<a href="#l1.1569"></a><span id="l1.1569">     // If there is no tree selection object then we must be in stand alone</span>
<a href="#l1.1570"></a><span id="l1.1570">     // message mode. In that case the selected indices are really just the</span>
<a href="#l1.1571"></a><span id="l1.1571">     // current message key.</span>
<a href="#l1.1572"></a><span id="l1.1572">     nsMsgViewIndex viewIndex = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.1573"></a><span id="l1.1573" class="difflineminus">-    if (viewIndex != nsMsgViewIndex_None)</span>
<a href="#l1.1574"></a><span id="l1.1574" class="difflineminus">-      selection.AppendElement(viewIndex);</span>
<a href="#l1.1575"></a><span id="l1.1575" class="difflineplus">+    if (viewIndex != nsMsgViewIndex_None) selection.AppendElement(viewIndex);</span>
<a href="#l1.1576"></a><span id="l1.1576">   }</span>
<a href="#l1.1577"></a><span id="l1.1577"> </span>
<a href="#l1.1578"></a><span id="l1.1578">   return NS_OK;</span>
<a href="#l1.1579"></a><span id="l1.1579"> }</span>
<a href="#l1.1580"></a><span id="l1.1580"> </span>
<a href="#l1.1581"></a><span id="l1.1581"> NS_IMETHODIMP</span>
<a href="#l1.1582"></a><span id="l1.1582" class="difflineminus">-nsMsgDBView::GetRowProperties(int32_t index,</span>
<a href="#l1.1583"></a><span id="l1.1583" class="difflineminus">-                              nsAString&amp; properties)</span>
<a href="#l1.1584"></a><span id="l1.1584" class="difflineminus">-{</span>
<a href="#l1.1585"></a><span id="l1.1585" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1586"></a><span id="l1.1586" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1587"></a><span id="l1.1587" class="difflineplus">+nsMsgDBView::GetRowProperties(int32_t index, nsAString &amp;properties) {</span>
<a href="#l1.1588"></a><span id="l1.1588" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1589"></a><span id="l1.1589"> </span>
<a href="#l1.1590"></a><span id="l1.1590">   // This is where we tell the tree to apply styles to a particular row.</span>
<a href="#l1.1591"></a><span id="l1.1591" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1592"></a><span id="l1.1592" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1593"></a><span id="l1.1593">   nsresult rv = NS_OK;</span>
<a href="#l1.1594"></a><span id="l1.1594"> </span>
<a href="#l1.1595"></a><span id="l1.1595">   rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.1596"></a><span id="l1.1596"> </span>
<a href="#l1.1597"></a><span id="l1.1597" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.1598"></a><span id="l1.1598" class="difflineminus">-  {</span>
<a href="#l1.1599"></a><span id="l1.1599" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.1600"></a><span id="l1.1600">     ClearHdrCache();</span>
<a href="#l1.1601"></a><span id="l1.1601">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1602"></a><span id="l1.1602">   }</span>
<a href="#l1.1603"></a><span id="l1.1603"> </span>
<a href="#l1.1604"></a><span id="l1.1604">   nsCString keywordProperty;</span>
<a href="#l1.1605"></a><span id="l1.1605">   FetchRowKeywords(index, msgHdr, keywordProperty);</span>
<a href="#l1.1606"></a><span id="l1.1606">   if (keywordProperty.IsEmpty()) {</span>
<a href="#l1.1607"></a><span id="l1.1607">     properties.AppendLiteral(&quot; untagged&quot;);</span>
<a href="#l1.1608"></a><span id="l1.1608">   } else {</span>
<a href="#l1.1609"></a><span id="l1.1609">     AppendKeywordProperties(keywordProperty, properties);</span>
<a href="#l1.1610"></a><span id="l1.1610">     properties.AppendLiteral(&quot; tagged&quot;);</span>
<a href="#l1.1611"></a><span id="l1.1611">   }</span>
<a href="#l1.1612"></a><span id="l1.1612"> </span>
<a href="#l1.1613"></a><span id="l1.1613">   // Give the custom column handlers a chance to style the row.</span>
<a href="#l1.1614"></a><span id="l1.1614" class="difflineminus">-  for (int i = 0; i &lt; m_customColumnHandlers.Count(); i++)</span>
<a href="#l1.1615"></a><span id="l1.1615" class="difflineminus">-  {</span>
<a href="#l1.1616"></a><span id="l1.1616" class="difflineplus">+  for (int i = 0; i &lt; m_customColumnHandlers.Count(); i++) {</span>
<a href="#l1.1617"></a><span id="l1.1617">     nsString extra;</span>
<a href="#l1.1618"></a><span id="l1.1618">     m_customColumnHandlers[i]-&gt;GetRowProperties(index, extra);</span>
<a href="#l1.1619"></a><span id="l1.1619" class="difflineminus">-    if (!extra.IsEmpty())</span>
<a href="#l1.1620"></a><span id="l1.1620" class="difflineminus">-    {</span>
<a href="#l1.1621"></a><span id="l1.1621" class="difflineplus">+    if (!extra.IsEmpty()) {</span>
<a href="#l1.1622"></a><span id="l1.1622">       properties.Append(' ');</span>
<a href="#l1.1623"></a><span id="l1.1623">       properties.Append(extra);</span>
<a href="#l1.1624"></a><span id="l1.1624">     }</span>
<a href="#l1.1625"></a><span id="l1.1625">   }</span>
<a href="#l1.1626"></a><span id="l1.1626"> </span>
<a href="#l1.1627"></a><span id="l1.1627">   return NS_OK;</span>
<a href="#l1.1628"></a><span id="l1.1628"> }</span>
<a href="#l1.1629"></a><span id="l1.1629"> </span>
<a href="#l1.1630"></a><span id="l1.1630"> NS_IMETHODIMP</span>
<a href="#l1.1631"></a><span id="l1.1631" class="difflineminus">-nsMsgDBView::GetColumnProperties(nsTreeColumn* col, nsAString&amp; properties)</span>
<a href="#l1.1632"></a><span id="l1.1632" class="difflineminus">-{</span>
<a href="#l1.1633"></a><span id="l1.1633" class="difflineplus">+nsMsgDBView::GetColumnProperties(nsTreeColumn *col, nsAString &amp;properties) {</span>
<a href="#l1.1634"></a><span id="l1.1634">   return NS_OK;</span>
<a href="#l1.1635"></a><span id="l1.1635"> }</span>
<a href="#l1.1636"></a><span id="l1.1636"> </span>
<a href="#l1.1637"></a><span id="l1.1637"> NS_IMETHODIMP</span>
<a href="#l1.1638"></a><span id="l1.1638" class="difflineminus">-nsMsgDBView::GetCellProperties(int32_t aRow,</span>
<a href="#l1.1639"></a><span id="l1.1639" class="difflineminus">-                               nsTreeColumn *col,</span>
<a href="#l1.1640"></a><span id="l1.1640" class="difflineminus">-                               nsAString&amp; properties)</span>
<a href="#l1.1641"></a><span id="l1.1641" class="difflineminus">-{</span>
<a href="#l1.1642"></a><span id="l1.1642" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l1.1643"></a><span id="l1.1643" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1644"></a><span id="l1.1644" class="difflineplus">+nsMsgDBView::GetCellProperties(int32_t aRow, nsTreeColumn *col,</span>
<a href="#l1.1645"></a><span id="l1.1645" class="difflineplus">+                               nsAString &amp;properties) {</span>
<a href="#l1.1646"></a><span id="l1.1646" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1647"></a><span id="l1.1647"> </span>
<a href="#l1.1648"></a><span id="l1.1648">   // This is where we tell the tree to apply styles to a particular row</span>
<a href="#l1.1649"></a><span id="l1.1649">   // i.e. if the row is an unread message...</span>
<a href="#l1.1650"></a><span id="l1.1650"> </span>
<a href="#l1.1651"></a><span id="l1.1651" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1652"></a><span id="l1.1652" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.1653"></a><span id="l1.1653">   nsresult rv = NS_OK;</span>
<a href="#l1.1654"></a><span id="l1.1654"> </span>
<a href="#l1.1655"></a><span id="l1.1655">   rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.1656"></a><span id="l1.1656"> </span>
<a href="#l1.1657"></a><span id="l1.1657" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.1658"></a><span id="l1.1658" class="difflineminus">-  {</span>
<a href="#l1.1659"></a><span id="l1.1659" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.1660"></a><span id="l1.1660">     ClearHdrCache();</span>
<a href="#l1.1661"></a><span id="l1.1661">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1662"></a><span id="l1.1662">   }</span>
<a href="#l1.1663"></a><span id="l1.1663"> </span>
<a href="#l1.1664"></a><span id="l1.1664" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l1.1665"></a><span id="l1.1665" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1666"></a><span id="l1.1666" class="difflineminus">-  if (colHandler != nullptr)</span>
<a href="#l1.1667"></a><span id="l1.1667" class="difflineminus">-  {</span>
<a href="#l1.1668"></a><span id="l1.1668" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l1.1669"></a><span id="l1.1669" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetColumnHandler(colID);</span>
<a href="#l1.1670"></a><span id="l1.1670" class="difflineplus">+  if (colHandler != nullptr) {</span>
<a href="#l1.1671"></a><span id="l1.1671">     colHandler-&gt;GetCellProperties(aRow, col, properties);</span>
<a href="#l1.1672"></a><span id="l1.1672" class="difflineminus">-  }</span>
<a href="#l1.1673"></a><span id="l1.1673" class="difflineminus">-  else if (colID[0] == 'c')</span>
<a href="#l1.1674"></a><span id="l1.1674" class="difflineminus">-  {</span>
<a href="#l1.1675"></a><span id="l1.1675" class="difflineplus">+  } else if (colID[0] == 'c') {</span>
<a href="#l1.1676"></a><span id="l1.1676">     // Correspondent.</span>
<a href="#l1.1677"></a><span id="l1.1677">     if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.1678"></a><span id="l1.1678">       properties.AssignLiteral(&quot;outgoing&quot;);</span>
<a href="#l1.1679"></a><span id="l1.1679">     else</span>
<a href="#l1.1680"></a><span id="l1.1680">       properties.AssignLiteral(&quot;incoming&quot;);</span>
<a href="#l1.1681"></a><span id="l1.1681">   }</span>
<a href="#l1.1682"></a><span id="l1.1682"> </span>
<a href="#l1.1683"></a><span id="l1.1683" class="difflineminus">-  if (!properties.IsEmpty())</span>
<a href="#l1.1684"></a><span id="l1.1684" class="difflineminus">-    properties.Append(' ');</span>
<a href="#l1.1685"></a><span id="l1.1685" class="difflineplus">+  if (!properties.IsEmpty()) properties.Append(' ');</span>
<a href="#l1.1686"></a><span id="l1.1686"> </span>
<a href="#l1.1687"></a><span id="l1.1687">   properties.Append(mMessageType);</span>
<a href="#l1.1688"></a><span id="l1.1688"> </span>
<a href="#l1.1689"></a><span id="l1.1689">   uint32_t flags;</span>
<a href="#l1.1690"></a><span id="l1.1690">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.1691"></a><span id="l1.1691"> </span>
<a href="#l1.1692"></a><span id="l1.1692">   if (!(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l1.1693"></a><span id="l1.1693">     properties.AppendLiteral(&quot; unread&quot;);</span>
<a href="#l1.1694"></a><span id="l1.1694">   else</span>
<a href="#l1.1695"></a><span id="l1.1695">     properties.AppendLiteral(&quot; read&quot;);</span>
<a href="#l1.1696"></a><span id="l1.1696"> </span>
<a href="#l1.1697"></a><span id="l1.1697" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::Replied)</span>
<a href="#l1.1698"></a><span id="l1.1698" class="difflineminus">-    properties.AppendLiteral(&quot; replied&quot;);</span>
<a href="#l1.1699"></a><span id="l1.1699" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::Replied) properties.AppendLiteral(&quot; replied&quot;);</span>
<a href="#l1.1700"></a><span id="l1.1700"> </span>
<a href="#l1.1701"></a><span id="l1.1701">   if (flags &amp; nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.1702"></a><span id="l1.1702">     properties.AppendLiteral(&quot; forwarded&quot;);</span>
<a href="#l1.1703"></a><span id="l1.1703"> </span>
<a href="#l1.1704"></a><span id="l1.1704" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::New)</span>
<a href="#l1.1705"></a><span id="l1.1705" class="difflineminus">-    properties.AppendLiteral(&quot; new&quot;);</span>
<a href="#l1.1706"></a><span id="l1.1706" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::New) properties.AppendLiteral(&quot; new&quot;);</span>
<a href="#l1.1707"></a><span id="l1.1707"> </span>
<a href="#l1.1708"></a><span id="l1.1708">   if (m_flags[aRow] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.1709"></a><span id="l1.1709">     properties.AppendLiteral(&quot; flagged&quot;);</span>
<a href="#l1.1710"></a><span id="l1.1710"> </span>
<a href="#l1.1711"></a><span id="l1.1711">   // For threaded display add the ignoreSubthread property to the</span>
<a href="#l1.1712"></a><span id="l1.1712">   // subthread top row (this row). For non-threaded add it to all rows.</span>
<a href="#l1.1713"></a><span id="l1.1713">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.1714"></a><span id="l1.1714" class="difflineminus">-      (flags &amp; nsMsgMessageFlags::Ignored))</span>
<a href="#l1.1715"></a><span id="l1.1715" class="difflineminus">-  {</span>
<a href="#l1.1716"></a><span id="l1.1716" class="difflineplus">+      (flags &amp; nsMsgMessageFlags::Ignored)) {</span>
<a href="#l1.1717"></a><span id="l1.1717">     properties.AppendLiteral(&quot; ignoreSubthread&quot;);</span>
<a href="#l1.1718"></a><span id="l1.1718" class="difflineminus">-  }</span>
<a href="#l1.1719"></a><span id="l1.1719" class="difflineminus">-  else {</span>
<a href="#l1.1720"></a><span id="l1.1720" class="difflineplus">+  } else {</span>
<a href="#l1.1721"></a><span id="l1.1721">     bool ignored;</span>
<a href="#l1.1722"></a><span id="l1.1722">     msgHdr-&gt;GetIsKilled(&amp;ignored);</span>
<a href="#l1.1723"></a><span id="l1.1723" class="difflineminus">-    if (ignored)</span>
<a href="#l1.1724"></a><span id="l1.1724" class="difflineminus">-      properties.AppendLiteral(&quot; ignoreSubthread&quot;);</span>
<a href="#l1.1725"></a><span id="l1.1725" class="difflineminus">-  }</span>
<a href="#l1.1726"></a><span id="l1.1726" class="difflineminus">-</span>
<a href="#l1.1727"></a><span id="l1.1727" class="difflineminus">-  nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.1728"></a><span id="l1.1728" class="difflineplus">+    if (ignored) properties.AppendLiteral(&quot; ignoreSubthread&quot;);</span>
<a href="#l1.1729"></a><span id="l1.1729" class="difflineplus">+  }</span>
<a href="#l1.1730"></a><span id="l1.1730" class="difflineplus">+</span>
<a href="#l1.1731"></a><span id="l1.1731" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.1732"></a><span id="l1.1732"> </span>
<a href="#l1.1733"></a><span id="l1.1733">   if ((flags &amp; nsMsgMessageFlags::Offline) ||</span>
<a href="#l1.1734"></a><span id="l1.1734">       (localFolder &amp;&amp; !(flags &amp; nsMsgMessageFlags::Partial)))</span>
<a href="#l1.1735"></a><span id="l1.1735">     properties.AppendLiteral(&quot; offline&quot;);</span>
<a href="#l1.1736"></a><span id="l1.1736"> </span>
<a href="#l1.1737"></a><span id="l1.1737">   if (flags &amp; nsMsgMessageFlags::Attachment)</span>
<a href="#l1.1738"></a><span id="l1.1738">     properties.AppendLiteral(&quot; attach&quot;);</span>
<a href="#l1.1739"></a><span id="l1.1739"> </span>
<a href="#l1.1740"></a><span id="l1.1740">   if ((mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) &amp;&amp;</span>
<a href="#l1.1741"></a><span id="l1.1741">       (flags &amp; nsMsgMessageFlags::IMAPDeleted))</span>
<a href="#l1.1742"></a><span id="l1.1742">     properties.AppendLiteral(&quot; imapdeleted&quot;);</span>
<a href="#l1.1743"></a><span id="l1.1743"> </span>
<a href="#l1.1744"></a><span id="l1.1744">   nsCString imageSize;</span>
<a href="#l1.1745"></a><span id="l1.1745">   msgHdr-&gt;GetStringProperty(&quot;imageSize&quot;, getter_Copies(imageSize));</span>
<a href="#l1.1746"></a><span id="l1.1746" class="difflineminus">-  if (!imageSize.IsEmpty())</span>
<a href="#l1.1747"></a><span id="l1.1747" class="difflineminus">-    properties.AppendLiteral(&quot; hasimage&quot;);</span>
<a href="#l1.1748"></a><span id="l1.1748" class="difflineplus">+  if (!imageSize.IsEmpty()) properties.AppendLiteral(&quot; hasimage&quot;);</span>
<a href="#l1.1749"></a><span id="l1.1749"> </span>
<a href="#l1.1750"></a><span id="l1.1750">   nsCString junkScoreStr;</span>
<a href="#l1.1751"></a><span id="l1.1751">   msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.1752"></a><span id="l1.1752">   if (!junkScoreStr.IsEmpty()) {</span>
<a href="#l1.1753"></a><span id="l1.1753">     if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.1754"></a><span id="l1.1754">       properties.AppendLiteral(&quot; junk&quot;);</span>
<a href="#l1.1755"></a><span id="l1.1755">     else</span>
<a href="#l1.1756"></a><span id="l1.1756">       properties.AppendLiteral(&quot; notjunk&quot;);</span>
<a href="#l1.1757"></a><span id="l1.1757" class="difflineat">@@ -1578,38 +1374,34 @@ nsMsgDBView::GetCellProperties(int32_t a</span>
<a href="#l1.1758"></a><span id="l1.1758">   }</span>
<a href="#l1.1759"></a><span id="l1.1759"> </span>
<a href="#l1.1760"></a><span id="l1.1760">   // This is a double fetch of the keywords property since we also fetch</span>
<a href="#l1.1761"></a><span id="l1.1761">   // it for the tags - do we want to do this?</span>
<a href="#l1.1762"></a><span id="l1.1762">   // I'm not sure anyone uses the kw- property, though it could be nice</span>
<a href="#l1.1763"></a><span id="l1.1763">   // for people wanting to extend the thread pane.</span>
<a href="#l1.1764"></a><span id="l1.1764">   nsCString keywordProperty;</span>
<a href="#l1.1765"></a><span id="l1.1765">   msgHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(keywordProperty));</span>
<a href="#l1.1766"></a><span id="l1.1766" class="difflineminus">-  if (!keywordProperty.IsEmpty())</span>
<a href="#l1.1767"></a><span id="l1.1767" class="difflineminus">-  {</span>
<a href="#l1.1768"></a><span id="l1.1768" class="difflineplus">+  if (!keywordProperty.IsEmpty()) {</span>
<a href="#l1.1769"></a><span id="l1.1769">     NS_ConvertUTF8toUTF16 keywords(keywordProperty);</span>
<a href="#l1.1770"></a><span id="l1.1770">     int32_t spaceIndex = 0;</span>
<a href="#l1.1771"></a><span id="l1.1771" class="difflineminus">-    do</span>
<a href="#l1.1772"></a><span id="l1.1772" class="difflineminus">-    {</span>
<a href="#l1.1773"></a><span id="l1.1773" class="difflineplus">+    do {</span>
<a href="#l1.1774"></a><span id="l1.1774">       spaceIndex = keywords.FindChar(' ');</span>
<a href="#l1.1775"></a><span id="l1.1775" class="difflineminus">-      int32_t endOfKeyword = (spaceIndex == -1) ? keywords.Length() : spaceIndex;</span>
<a href="#l1.1776"></a><span id="l1.1776" class="difflineplus">+      int32_t endOfKeyword =</span>
<a href="#l1.1777"></a><span id="l1.1777" class="difflineplus">+          (spaceIndex == -1) ? keywords.Length() : spaceIndex;</span>
<a href="#l1.1778"></a><span id="l1.1778">       properties.AppendLiteral(&quot; kw-&quot;);</span>
<a href="#l1.1779"></a><span id="l1.1779">       properties.Append(StringHead(keywords, endOfKeyword));</span>
<a href="#l1.1780"></a><span id="l1.1780" class="difflineminus">-      if (spaceIndex &gt; 0)</span>
<a href="#l1.1781"></a><span id="l1.1781" class="difflineminus">-        keywords.Cut(0, endOfKeyword + 1);</span>
<a href="#l1.1782"></a><span id="l1.1782" class="difflineminus">-    }</span>
<a href="#l1.1783"></a><span id="l1.1783" class="difflineminus">-    while (spaceIndex &gt; 0);</span>
<a href="#l1.1784"></a><span id="l1.1784" class="difflineplus">+      if (spaceIndex &gt; 0) keywords.Cut(0, endOfKeyword + 1);</span>
<a href="#l1.1785"></a><span id="l1.1785" class="difflineplus">+    } while (spaceIndex &gt; 0);</span>
<a href="#l1.1786"></a><span id="l1.1786">   }</span>
<a href="#l1.1787"></a><span id="l1.1787"> </span>
<a href="#l1.1788"></a><span id="l1.1788"> #ifdef SUPPORT_PRIORITY_COLORS</span>
<a href="#l1.1789"></a><span id="l1.1789">   // Add special styles for priority.</span>
<a href="#l1.1790"></a><span id="l1.1790">   nsMsgPriorityValue priority;</span>
<a href="#l1.1791"></a><span id="l1.1791">   msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.1792"></a><span id="l1.1792" class="difflineminus">-  switch (priority)</span>
<a href="#l1.1793"></a><span id="l1.1793" class="difflineminus">-  {</span>
<a href="#l1.1794"></a><span id="l1.1794" class="difflineplus">+  switch (priority) {</span>
<a href="#l1.1795"></a><span id="l1.1795">     case nsMsgPriority::highest:</span>
<a href="#l1.1796"></a><span id="l1.1796">       properties.append(&quot; priority-highest&quot;);</span>
<a href="#l1.1797"></a><span id="l1.1797">       break;</span>
<a href="#l1.1798"></a><span id="l1.1798">     case nsMsgPriority::high:</span>
<a href="#l1.1799"></a><span id="l1.1799">       properties.append(&quot; priority-high&quot;);</span>
<a href="#l1.1800"></a><span id="l1.1800">       break;</span>
<a href="#l1.1801"></a><span id="l1.1801">     case nsMsgPriority::low:</span>
<a href="#l1.1802"></a><span id="l1.1802">       properties.append(&quot; priority-low&quot;);</span>
<a href="#l1.1803"></a><span id="l1.1803" class="difflineat">@@ -1617,443 +1409,356 @@ nsMsgDBView::GetCellProperties(int32_t a</span>
<a href="#l1.1804"></a><span id="l1.1804">     case nsMsgPriority::lowest:</span>
<a href="#l1.1805"></a><span id="l1.1805">       properties.append(&quot; priority-lowest&quot;);</span>
<a href="#l1.1806"></a><span id="l1.1806">       break;</span>
<a href="#l1.1807"></a><span id="l1.1807">     default:</span>
<a href="#l1.1808"></a><span id="l1.1808">       break;</span>
<a href="#l1.1809"></a><span id="l1.1809">   }</span>
<a href="#l1.1810"></a><span id="l1.1810"> #endif</span>
<a href="#l1.1811"></a><span id="l1.1811"> </span>
<a href="#l1.1812"></a><span id="l1.1812" class="difflineminus">-</span>
<a href="#l1.1813"></a><span id="l1.1813" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.1814"></a><span id="l1.1814" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.1815"></a><span id="l1.1815">   rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.1816"></a><span id="l1.1816" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.1817"></a><span id="l1.1817" class="difflineminus">-  {</span>
<a href="#l1.1818"></a><span id="l1.1818" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; thread) {</span>
<a href="#l1.1819"></a><span id="l1.1819">     uint32_t numUnreadChildren;</span>
<a href="#l1.1820"></a><span id="l1.1820">     thread-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.1821"></a><span id="l1.1821" class="difflineminus">-    if (numUnreadChildren &gt; 0)</span>
<a href="#l1.1822"></a><span id="l1.1822" class="difflineminus">-      properties.AppendLiteral(&quot; hasUnread&quot;);</span>
<a href="#l1.1823"></a><span id="l1.1823" class="difflineplus">+    if (numUnreadChildren &gt; 0) properties.AppendLiteral(&quot; hasUnread&quot;);</span>
<a href="#l1.1824"></a><span id="l1.1824"> </span>
<a href="#l1.1825"></a><span id="l1.1825">     // For threaded display add the ignore/watch properties to the</span>
<a href="#l1.1826"></a><span id="l1.1826">     // thread top row. For non-threaded add it to all rows.</span>
<a href="#l1.1827"></a><span id="l1.1827">     if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) ||</span>
<a href="#l1.1828"></a><span id="l1.1828">         ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.1829"></a><span id="l1.1829" class="difflineminus">-         (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)))</span>
<a href="#l1.1830"></a><span id="l1.1830" class="difflineminus">-    {</span>
<a href="#l1.1831"></a><span id="l1.1831" class="difflineplus">+         (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD))) {</span>
<a href="#l1.1832"></a><span id="l1.1832">       thread-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.1833"></a><span id="l1.1833">       if (flags &amp; nsMsgMessageFlags::Watched)</span>
<a href="#l1.1834"></a><span id="l1.1834">         properties.AppendLiteral(&quot; watch&quot;);</span>
<a href="#l1.1835"></a><span id="l1.1835">       if (flags &amp; nsMsgMessageFlags::Ignored)</span>
<a href="#l1.1836"></a><span id="l1.1836">         properties.AppendLiteral(&quot; ignore&quot;);</span>
<a href="#l1.1837"></a><span id="l1.1837">     }</span>
<a href="#l1.1838"></a><span id="l1.1838">   }</span>
<a href="#l1.1839"></a><span id="l1.1839"> </span>
<a href="#l1.1840"></a><span id="l1.1840">   return NS_OK;</span>
<a href="#l1.1841"></a><span id="l1.1841"> }</span>
<a href="#l1.1842"></a><span id="l1.1842"> </span>
<a href="#l1.1843"></a><span id="l1.1843"> NS_IMETHODIMP</span>
<a href="#l1.1844"></a><span id="l1.1844" class="difflineminus">-nsMsgDBView::IsContainer(int32_t index,</span>
<a href="#l1.1845"></a><span id="l1.1845" class="difflineminus">-                         bool *_retval)</span>
<a href="#l1.1846"></a><span id="l1.1846" class="difflineminus">-{</span>
<a href="#l1.1847"></a><span id="l1.1847" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1848"></a><span id="l1.1848" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1849"></a><span id="l1.1849" class="difflineminus">-</span>
<a href="#l1.1850"></a><span id="l1.1850" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1851"></a><span id="l1.1851" class="difflineminus">-  {</span>
<a href="#l1.1852"></a><span id="l1.1852" class="difflineplus">+nsMsgDBView::IsContainer(int32_t index, bool *_retval) {</span>
<a href="#l1.1853"></a><span id="l1.1853" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1854"></a><span id="l1.1854" class="difflineplus">+</span>
<a href="#l1.1855"></a><span id="l1.1855" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.1856"></a><span id="l1.1856">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1857"></a><span id="l1.1857">     *_retval = !!(flags &amp; MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.1858"></a><span id="l1.1858" class="difflineminus">-  }</span>
<a href="#l1.1859"></a><span id="l1.1859" class="difflineminus">-  else</span>
<a href="#l1.1860"></a><span id="l1.1860" class="difflineminus">-  {</span>
<a href="#l1.1861"></a><span id="l1.1861" class="difflineplus">+  } else {</span>
<a href="#l1.1862"></a><span id="l1.1862">     *_retval = false;</span>
<a href="#l1.1863"></a><span id="l1.1863">   }</span>
<a href="#l1.1864"></a><span id="l1.1864"> </span>
<a href="#l1.1865"></a><span id="l1.1865">   return NS_OK;</span>
<a href="#l1.1866"></a><span id="l1.1866"> }</span>
<a href="#l1.1867"></a><span id="l1.1867"> </span>
<a href="#l1.1868"></a><span id="l1.1868"> NS_IMETHODIMP</span>
<a href="#l1.1869"></a><span id="l1.1869" class="difflineminus">-nsMsgDBView::IsContainerOpen(int32_t index,</span>
<a href="#l1.1870"></a><span id="l1.1870" class="difflineminus">-                             bool *_retval)</span>
<a href="#l1.1871"></a><span id="l1.1871" class="difflineminus">-{</span>
<a href="#l1.1872"></a><span id="l1.1872" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1873"></a><span id="l1.1873" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1874"></a><span id="l1.1874" class="difflineminus">-</span>
<a href="#l1.1875"></a><span id="l1.1875" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1876"></a><span id="l1.1876" class="difflineminus">-  {</span>
<a href="#l1.1877"></a><span id="l1.1877" class="difflineplus">+nsMsgDBView::IsContainerOpen(int32_t index, bool *_retval) {</span>
<a href="#l1.1878"></a><span id="l1.1878" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1879"></a><span id="l1.1879" class="difflineplus">+</span>
<a href="#l1.1880"></a><span id="l1.1880" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.1881"></a><span id="l1.1881">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1882"></a><span id="l1.1882" class="difflineminus">-    *_retval = (flags &amp; MSG_VIEW_FLAG_HASCHILDREN) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Elided);</span>
<a href="#l1.1883"></a><span id="l1.1883" class="difflineminus">-  }</span>
<a href="#l1.1884"></a><span id="l1.1884" class="difflineminus">-  else</span>
<a href="#l1.1885"></a><span id="l1.1885" class="difflineminus">-  {</span>
<a href="#l1.1886"></a><span id="l1.1886" class="difflineplus">+    *_retval = (flags &amp; MSG_VIEW_FLAG_HASCHILDREN) &amp;&amp;</span>
<a href="#l1.1887"></a><span id="l1.1887" class="difflineplus">+               !(flags &amp; nsMsgMessageFlags::Elided);</span>
<a href="#l1.1888"></a><span id="l1.1888" class="difflineplus">+  } else {</span>
<a href="#l1.1889"></a><span id="l1.1889">     *_retval = false;</span>
<a href="#l1.1890"></a><span id="l1.1890">   }</span>
<a href="#l1.1891"></a><span id="l1.1891"> </span>
<a href="#l1.1892"></a><span id="l1.1892">   return NS_OK;</span>
<a href="#l1.1893"></a><span id="l1.1893"> }</span>
<a href="#l1.1894"></a><span id="l1.1894"> </span>
<a href="#l1.1895"></a><span id="l1.1895"> NS_IMETHODIMP</span>
<a href="#l1.1896"></a><span id="l1.1896" class="difflineminus">-nsMsgDBView::IsContainerEmpty(int32_t index,</span>
<a href="#l1.1897"></a><span id="l1.1897" class="difflineminus">-                              bool *_retval)</span>
<a href="#l1.1898"></a><span id="l1.1898" class="difflineminus">-{</span>
<a href="#l1.1899"></a><span id="l1.1899" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1900"></a><span id="l1.1900" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1901"></a><span id="l1.1901" class="difflineminus">-</span>
<a href="#l1.1902"></a><span id="l1.1902" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.1903"></a><span id="l1.1903" class="difflineminus">-  {</span>
<a href="#l1.1904"></a><span id="l1.1904" class="difflineplus">+nsMsgDBView::IsContainerEmpty(int32_t index, bool *_retval) {</span>
<a href="#l1.1905"></a><span id="l1.1905" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1906"></a><span id="l1.1906" class="difflineplus">+</span>
<a href="#l1.1907"></a><span id="l1.1907" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.1908"></a><span id="l1.1908">     uint32_t flags = m_flags[index];</span>
<a href="#l1.1909"></a><span id="l1.1909">     *_retval = !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l1.1910"></a><span id="l1.1910" class="difflineminus">-  }</span>
<a href="#l1.1911"></a><span id="l1.1911" class="difflineminus">-  else</span>
<a href="#l1.1912"></a><span id="l1.1912" class="difflineminus">-  {</span>
<a href="#l1.1913"></a><span id="l1.1913" class="difflineplus">+  } else {</span>
<a href="#l1.1914"></a><span id="l1.1914">     *_retval = false;</span>
<a href="#l1.1915"></a><span id="l1.1915">   }</span>
<a href="#l1.1916"></a><span id="l1.1916"> </span>
<a href="#l1.1917"></a><span id="l1.1917">   return NS_OK;</span>
<a href="#l1.1918"></a><span id="l1.1918"> }</span>
<a href="#l1.1919"></a><span id="l1.1919"> </span>
<a href="#l1.1920"></a><span id="l1.1920"> NS_IMETHODIMP</span>
<a href="#l1.1921"></a><span id="l1.1921" class="difflineminus">-nsMsgDBView::IsSeparator(int32_t index,</span>
<a href="#l1.1922"></a><span id="l1.1922" class="difflineminus">-                         bool *_retval)</span>
<a href="#l1.1923"></a><span id="l1.1923" class="difflineminus">-{</span>
<a href="#l1.1924"></a><span id="l1.1924" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.1925"></a><span id="l1.1925" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1926"></a><span id="l1.1926" class="difflineplus">+nsMsgDBView::IsSeparator(int32_t index, bool *_retval) {</span>
<a href="#l1.1927"></a><span id="l1.1927" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.1928"></a><span id="l1.1928"> </span>
<a href="#l1.1929"></a><span id="l1.1929">   *_retval = false;</span>
<a href="#l1.1930"></a><span id="l1.1930"> </span>
<a href="#l1.1931"></a><span id="l1.1931">   return NS_OK;</span>
<a href="#l1.1932"></a><span id="l1.1932"> }</span>
<a href="#l1.1933"></a><span id="l1.1933"> </span>
<a href="#l1.1934"></a><span id="l1.1934"> NS_IMETHODIMP</span>
<a href="#l1.1935"></a><span id="l1.1935" class="difflineminus">-nsMsgDBView::GetParentIndex(int32_t rowIndex,</span>
<a href="#l1.1936"></a><span id="l1.1936" class="difflineminus">-                            int32_t *_retval)</span>
<a href="#l1.1937"></a><span id="l1.1937" class="difflineminus">-{</span>
<a href="#l1.1938"></a><span id="l1.1938" class="difflineplus">+nsMsgDBView::GetParentIndex(int32_t rowIndex, int32_t *_retval) {</span>
<a href="#l1.1939"></a><span id="l1.1939">   *_retval = -1;</span>
<a href="#l1.1940"></a><span id="l1.1940"> </span>
<a href="#l1.1941"></a><span id="l1.1941">   int32_t rowIndexLevel;</span>
<a href="#l1.1942"></a><span id="l1.1942">   nsresult rv = GetLevel(rowIndex, &amp;rowIndexLevel);</span>
<a href="#l1.1943"></a><span id="l1.1943">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.1944"></a><span id="l1.1944"> </span>
<a href="#l1.1945"></a><span id="l1.1945">   int32_t i;</span>
<a href="#l1.1946"></a><span id="l1.1946" class="difflineminus">-  for(i = rowIndex; i &gt;= 0; i--)</span>
<a href="#l1.1947"></a><span id="l1.1947" class="difflineminus">-  {</span>
<a href="#l1.1948"></a><span id="l1.1948" class="difflineplus">+  for (i = rowIndex; i &gt;= 0; i--) {</span>
<a href="#l1.1949"></a><span id="l1.1949">     int32_t l;</span>
<a href="#l1.1950"></a><span id="l1.1950">     GetLevel(i, &amp;l);</span>
<a href="#l1.1951"></a><span id="l1.1951" class="difflineminus">-    if (l &lt; rowIndexLevel)</span>
<a href="#l1.1952"></a><span id="l1.1952" class="difflineminus">-    {</span>
<a href="#l1.1953"></a><span id="l1.1953" class="difflineplus">+    if (l &lt; rowIndexLevel) {</span>
<a href="#l1.1954"></a><span id="l1.1954">       *_retval = i;</span>
<a href="#l1.1955"></a><span id="l1.1955">       break;</span>
<a href="#l1.1956"></a><span id="l1.1956">     }</span>
<a href="#l1.1957"></a><span id="l1.1957">   }</span>
<a href="#l1.1958"></a><span id="l1.1958"> </span>
<a href="#l1.1959"></a><span id="l1.1959">   return NS_OK;</span>
<a href="#l1.1960"></a><span id="l1.1960"> }</span>
<a href="#l1.1961"></a><span id="l1.1961"> </span>
<a href="#l1.1962"></a><span id="l1.1962"> NS_IMETHODIMP</span>
<a href="#l1.1963"></a><span id="l1.1963" class="difflineminus">-nsMsgDBView::HasNextSibling(int32_t rowIndex,</span>
<a href="#l1.1964"></a><span id="l1.1964" class="difflineminus">-                            int32_t afterIndex,</span>
<a href="#l1.1965"></a><span id="l1.1965" class="difflineminus">-                            bool *_retval)</span>
<a href="#l1.1966"></a><span id="l1.1966" class="difflineminus">-{</span>
<a href="#l1.1967"></a><span id="l1.1967" class="difflineplus">+nsMsgDBView::HasNextSibling(int32_t rowIndex, int32_t afterIndex,</span>
<a href="#l1.1968"></a><span id="l1.1968" class="difflineplus">+                            bool *_retval) {</span>
<a href="#l1.1969"></a><span id="l1.1969">   *_retval = false;</span>
<a href="#l1.1970"></a><span id="l1.1970"> </span>
<a href="#l1.1971"></a><span id="l1.1971">   int32_t rowIndexLevel;</span>
<a href="#l1.1972"></a><span id="l1.1972">   GetLevel(rowIndex, &amp;rowIndexLevel);</span>
<a href="#l1.1973"></a><span id="l1.1973"> </span>
<a href="#l1.1974"></a><span id="l1.1974">   int32_t i;</span>
<a href="#l1.1975"></a><span id="l1.1975">   int32_t count;</span>
<a href="#l1.1976"></a><span id="l1.1976">   GetRowCount(&amp;count);</span>
<a href="#l1.1977"></a><span id="l1.1977" class="difflineminus">-  for(i = afterIndex + 1; i &lt; count; i++)</span>
<a href="#l1.1978"></a><span id="l1.1978" class="difflineminus">-  {</span>
<a href="#l1.1979"></a><span id="l1.1979" class="difflineplus">+  for (i = afterIndex + 1; i &lt; count; i++) {</span>
<a href="#l1.1980"></a><span id="l1.1980">     int32_t l;</span>
<a href="#l1.1981"></a><span id="l1.1981">     GetLevel(i, &amp;l);</span>
<a href="#l1.1982"></a><span id="l1.1982" class="difflineminus">-    if (l &lt; rowIndexLevel)</span>
<a href="#l1.1983"></a><span id="l1.1983" class="difflineminus">-      break;</span>
<a href="#l1.1984"></a><span id="l1.1984" class="difflineminus">-</span>
<a href="#l1.1985"></a><span id="l1.1985" class="difflineminus">-    if (l == rowIndexLevel)</span>
<a href="#l1.1986"></a><span id="l1.1986" class="difflineminus">-    {</span>
<a href="#l1.1987"></a><span id="l1.1987" class="difflineplus">+    if (l &lt; rowIndexLevel) break;</span>
<a href="#l1.1988"></a><span id="l1.1988" class="difflineplus">+</span>
<a href="#l1.1989"></a><span id="l1.1989" class="difflineplus">+    if (l == rowIndexLevel) {</span>
<a href="#l1.1990"></a><span id="l1.1990">       *_retval = true;</span>
<a href="#l1.1991"></a><span id="l1.1991">       break;</span>
<a href="#l1.1992"></a><span id="l1.1992">     }</span>
<a href="#l1.1993"></a><span id="l1.1993">   }</span>
<a href="#l1.1994"></a><span id="l1.1994"> </span>
<a href="#l1.1995"></a><span id="l1.1995">   return NS_OK;</span>
<a href="#l1.1996"></a><span id="l1.1996"> }</span>
<a href="#l1.1997"></a><span id="l1.1997"> </span>
<a href="#l1.1998"></a><span id="l1.1998"> NS_IMETHODIMP</span>
<a href="#l1.1999"></a><span id="l1.1999" class="difflineminus">-nsMsgDBView::GetLevel(int32_t index,</span>
<a href="#l1.2000"></a><span id="l1.2000" class="difflineminus">-                      int32_t *_retval)</span>
<a href="#l1.2001"></a><span id="l1.2001" class="difflineminus">-{</span>
<a href="#l1.2002"></a><span id="l1.2002" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.2003"></a><span id="l1.2003" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2004"></a><span id="l1.2004" class="difflineplus">+nsMsgDBView::GetLevel(int32_t index, int32_t *_retval) {</span>
<a href="#l1.2005"></a><span id="l1.2005" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2006"></a><span id="l1.2006"> </span>
<a href="#l1.2007"></a><span id="l1.2007">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.2008"></a><span id="l1.2008">     *_retval = m_levels[index];</span>
<a href="#l1.2009"></a><span id="l1.2009">   else</span>
<a href="#l1.2010"></a><span id="l1.2010">     *_retval = 0;</span>
<a href="#l1.2011"></a><span id="l1.2011"> </span>
<a href="#l1.2012"></a><span id="l1.2012">   return NS_OK;</span>
<a href="#l1.2013"></a><span id="l1.2013"> }</span>
<a href="#l1.2014"></a><span id="l1.2014"> </span>
<a href="#l1.2015"></a><span id="l1.2015"> // Search view will override this since headers can span db's.</span>
<a href="#l1.2016"></a><span id="l1.2016" class="difflineminus">-nsresult</span>
<a href="#l1.2017"></a><span id="l1.2017" class="difflineminus">-nsMsgDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2018"></a><span id="l1.2018" class="difflineminus">-                                   nsIMsgDBHdr **msgHdr)</span>
<a href="#l1.2019"></a><span id="l1.2019" class="difflineminus">-{</span>
<a href="#l1.2020"></a><span id="l1.2020" class="difflineplus">+nsresult nsMsgDBView::GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2021"></a><span id="l1.2021" class="difflineplus">+                                            nsIMsgDBHdr **msgHdr) {</span>
<a href="#l1.2022"></a><span id="l1.2022">   nsresult rv = NS_OK;</span>
<a href="#l1.2023"></a><span id="l1.2023" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.2024"></a><span id="l1.2024" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2025"></a><span id="l1.2025" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2026"></a><span id="l1.2026"> </span>
<a href="#l1.2027"></a><span id="l1.2027">   nsMsgKey key = m_keys[index];</span>
<a href="#l1.2028"></a><span id="l1.2028" class="difflineminus">-  if (key == nsMsgKey_None || !m_db)</span>
<a href="#l1.2029"></a><span id="l1.2029" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2030"></a><span id="l1.2030" class="difflineminus">-</span>
<a href="#l1.2031"></a><span id="l1.2031" class="difflineminus">-  if (key == m_cachedMsgKey)</span>
<a href="#l1.2032"></a><span id="l1.2032" class="difflineminus">-  {</span>
<a href="#l1.2033"></a><span id="l1.2033" class="difflineplus">+  if (key == nsMsgKey_None || !m_db) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2034"></a><span id="l1.2034" class="difflineplus">+</span>
<a href="#l1.2035"></a><span id="l1.2035" class="difflineplus">+  if (key == m_cachedMsgKey) {</span>
<a href="#l1.2036"></a><span id="l1.2036">     NS_IF_ADDREF(*msgHdr = m_cachedHdr);</span>
<a href="#l1.2037"></a><span id="l1.2037" class="difflineminus">-  }</span>
<a href="#l1.2038"></a><span id="l1.2038" class="difflineminus">-  else</span>
<a href="#l1.2039"></a><span id="l1.2039" class="difflineminus">-  {</span>
<a href="#l1.2040"></a><span id="l1.2040" class="difflineplus">+  } else {</span>
<a href="#l1.2041"></a><span id="l1.2041">     rv = m_db-&gt;GetMsgHdrForKey(key, msgHdr);</span>
<a href="#l1.2042"></a><span id="l1.2042" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l1.2043"></a><span id="l1.2043" class="difflineminus">-    {</span>
<a href="#l1.2044"></a><span id="l1.2044" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.2045"></a><span id="l1.2045">       m_cachedHdr = *msgHdr;</span>
<a href="#l1.2046"></a><span id="l1.2046">       m_cachedMsgKey = key;</span>
<a href="#l1.2047"></a><span id="l1.2047">     }</span>
<a href="#l1.2048"></a><span id="l1.2048">   }</span>
<a href="#l1.2049"></a><span id="l1.2049"> </span>
<a href="#l1.2050"></a><span id="l1.2050">   return rv;</span>
<a href="#l1.2051"></a><span id="l1.2051"> }</span>
<a href="#l1.2052"></a><span id="l1.2052"> </span>
<a href="#l1.2053"></a><span id="l1.2053" class="difflineminus">-void</span>
<a href="#l1.2054"></a><span id="l1.2054" class="difflineminus">-nsMsgDBView::InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l1.2055"></a><span id="l1.2055" class="difflineminus">-                            nsIMsgDBHdr *hdr,</span>
<a href="#l1.2056"></a><span id="l1.2056" class="difflineminus">-                            nsMsgKey msgKey,</span>
<a href="#l1.2057"></a><span id="l1.2057" class="difflineminus">-                            uint32_t flags,</span>
<a href="#l1.2058"></a><span id="l1.2058" class="difflineminus">-                            uint32_t level)</span>
<a href="#l1.2059"></a><span id="l1.2059" class="difflineminus">-{</span>
<a href="#l1.2060"></a><span id="l1.2060" class="difflineminus">-  if ((int32_t) index &lt; 0 || index &gt; m_keys.Length())</span>
<a href="#l1.2061"></a><span id="l1.2061" class="difflineminus">-  {</span>
<a href="#l1.2062"></a><span id="l1.2062" class="difflineplus">+void nsMsgDBView::InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l1.2063"></a><span id="l1.2063" class="difflineplus">+                                 nsMsgKey msgKey, uint32_t flags,</span>
<a href="#l1.2064"></a><span id="l1.2064" class="difflineplus">+                                 uint32_t level) {</span>
<a href="#l1.2065"></a><span id="l1.2065" class="difflineplus">+  if ((int32_t)index &lt; 0 || index &gt; m_keys.Length()) {</span>
<a href="#l1.2066"></a><span id="l1.2066">     // Something's gone wrong in a caller, but we have no clue why.</span>
<a href="#l1.2067"></a><span id="l1.2067">     // Return without adding the header to the view.</span>
<a href="#l1.2068"></a><span id="l1.2068">     NS_ERROR(&quot;Index for message header insertion out of array range!&quot;);</span>
<a href="#l1.2069"></a><span id="l1.2069">     return;</span>
<a href="#l1.2070"></a><span id="l1.2070">   }</span>
<a href="#l1.2071"></a><span id="l1.2071"> </span>
<a href="#l1.2072"></a><span id="l1.2072">   m_keys.InsertElementAt(index, msgKey);</span>
<a href="#l1.2073"></a><span id="l1.2073">   m_flags.InsertElementAt(index, flags);</span>
<a href="#l1.2074"></a><span id="l1.2074">   m_levels.InsertElementAt(index, level);</span>
<a href="#l1.2075"></a><span id="l1.2075"> }</span>
<a href="#l1.2076"></a><span id="l1.2076"> </span>
<a href="#l1.2077"></a><span id="l1.2077" class="difflineminus">-void</span>
<a href="#l1.2078"></a><span id="l1.2078" class="difflineminus">-nsMsgDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr,</span>
<a href="#l1.2079"></a><span id="l1.2079" class="difflineminus">-                         nsMsgViewIndex index,</span>
<a href="#l1.2080"></a><span id="l1.2080" class="difflineminus">-                         nsMsgKey msgKey,</span>
<a href="#l1.2081"></a><span id="l1.2081" class="difflineminus">-                         uint32_t flags,</span>
<a href="#l1.2082"></a><span id="l1.2082" class="difflineminus">-                         uint32_t level)</span>
<a href="#l1.2083"></a><span id="l1.2083" class="difflineminus">-{</span>
<a href="#l1.2084"></a><span id="l1.2084" class="difflineplus">+void nsMsgDBView::SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l1.2085"></a><span id="l1.2085" class="difflineplus">+                              nsMsgKey msgKey, uint32_t flags, uint32_t level) {</span>
<a href="#l1.2086"></a><span id="l1.2086">   m_keys[index] = msgKey;</span>
<a href="#l1.2087"></a><span id="l1.2087">   m_flags[index] = flags;</span>
<a href="#l1.2088"></a><span id="l1.2088">   m_levels[index] = level;</span>
<a href="#l1.2089"></a><span id="l1.2089"> }</span>
<a href="#l1.2090"></a><span id="l1.2090"> </span>
<a href="#l1.2091"></a><span id="l1.2091" class="difflineminus">-nsresult</span>
<a href="#l1.2092"></a><span id="l1.2092" class="difflineminus">-nsMsgDBView::GetFolderForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2093"></a><span id="l1.2093" class="difflineminus">-                                   nsIMsgFolder **aFolder)</span>
<a href="#l1.2094"></a><span id="l1.2094" class="difflineminus">-{</span>
<a href="#l1.2095"></a><span id="l1.2095" class="difflineplus">+nsresult nsMsgDBView::GetFolderForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2096"></a><span id="l1.2096" class="difflineplus">+                                            nsIMsgFolder **aFolder) {</span>
<a href="#l1.2097"></a><span id="l1.2097">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l1.2098"></a><span id="l1.2098">   return NS_OK;</span>
<a href="#l1.2099"></a><span id="l1.2099"> }</span>
<a href="#l1.2100"></a><span id="l1.2100"> </span>
<a href="#l1.2101"></a><span id="l1.2101" class="difflineminus">-nsresult</span>
<a href="#l1.2102"></a><span id="l1.2102" class="difflineminus">-nsMsgDBView::GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2103"></a><span id="l1.2103" class="difflineminus">-                               nsIMsgDatabase **db)</span>
<a href="#l1.2104"></a><span id="l1.2104" class="difflineminus">-{</span>
<a href="#l1.2105"></a><span id="l1.2105" class="difflineplus">+nsresult nsMsgDBView::GetDBForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.2106"></a><span id="l1.2106" class="difflineplus">+                                        nsIMsgDatabase **db) {</span>
<a href="#l1.2107"></a><span id="l1.2107">   NS_IF_ADDREF(*db = m_db);</span>
<a href="#l1.2108"></a><span id="l1.2108">   return NS_OK;</span>
<a href="#l1.2109"></a><span id="l1.2109"> }</span>
<a href="#l1.2110"></a><span id="l1.2110"> </span>
<a href="#l1.2111"></a><span id="l1.2111"> NS_IMETHODIMP</span>
<a href="#l1.2112"></a><span id="l1.2112" class="difflineminus">-nsMsgDBView::GetImageSrc(int32_t aRow,</span>
<a href="#l1.2113"></a><span id="l1.2113" class="difflineminus">-                         nsTreeColumn* aCol,</span>
<a href="#l1.2114"></a><span id="l1.2114" class="difflineminus">-                         nsAString&amp; aValue)</span>
<a href="#l1.2115"></a><span id="l1.2115" class="difflineminus">-{</span>
<a href="#l1.2116"></a><span id="l1.2116" class="difflineplus">+nsMsgDBView::GetImageSrc(int32_t aRow, nsTreeColumn *aCol, nsAString &amp;aValue) {</span>
<a href="#l1.2117"></a><span id="l1.2117">   NS_ENSURE_ARG_POINTER(aCol);</span>
<a href="#l1.2118"></a><span id="l1.2118">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l1.2119"></a><span id="l1.2119">   // return.</span>
<a href="#l1.2120"></a><span id="l1.2120" class="difflineminus">-  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l1.2121"></a><span id="l1.2121" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2122"></a><span id="l1.2122" class="difflineminus">-</span>
<a href="#l1.2123"></a><span id="l1.2123" class="difflineminus">-  if (colHandler)</span>
<a href="#l1.2124"></a><span id="l1.2124" class="difflineminus">-  {</span>
<a href="#l1.2125"></a><span id="l1.2125" class="difflineplus">+  const nsAString &amp;colID = aCol-&gt;GetId();</span>
<a href="#l1.2126"></a><span id="l1.2126" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2127"></a><span id="l1.2127" class="difflineplus">+</span>
<a href="#l1.2128"></a><span id="l1.2128" class="difflineplus">+  if (colHandler) {</span>
<a href="#l1.2129"></a><span id="l1.2129">     colHandler-&gt;GetImageSrc(aRow, aCol, aValue);</span>
<a href="#l1.2130"></a><span id="l1.2130">     return NS_OK;</span>
<a href="#l1.2131"></a><span id="l1.2131">   }</span>
<a href="#l1.2132"></a><span id="l1.2132"> </span>
<a href="#l1.2133"></a><span id="l1.2133">   return NS_OK;</span>
<a href="#l1.2134"></a><span id="l1.2134"> }</span>
<a href="#l1.2135"></a><span id="l1.2135"> </span>
<a href="#l1.2136"></a><span id="l1.2136"> NS_IMETHODIMP</span>
<a href="#l1.2137"></a><span id="l1.2137" class="difflineminus">-nsMsgDBView::GetCellValue(int32_t aRow,</span>
<a href="#l1.2138"></a><span id="l1.2138" class="difflineminus">-                          nsTreeColumn* aCol,</span>
<a href="#l1.2139"></a><span id="l1.2139" class="difflineminus">-                          nsAString&amp; aValue)</span>
<a href="#l1.2140"></a><span id="l1.2140" class="difflineminus">-{</span>
<a href="#l1.2141"></a><span id="l1.2141" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l1.2142"></a><span id="l1.2142" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2143"></a><span id="l1.2143" class="difflineminus">-</span>
<a href="#l1.2144"></a><span id="l1.2144" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2145"></a><span id="l1.2145" class="difflineplus">+nsMsgDBView::GetCellValue(int32_t aRow, nsTreeColumn *aCol, nsAString &amp;aValue) {</span>
<a href="#l1.2146"></a><span id="l1.2146" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2147"></a><span id="l1.2147" class="difflineplus">+</span>
<a href="#l1.2148"></a><span id="l1.2148" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2149"></a><span id="l1.2149">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.2150"></a><span id="l1.2150"> </span>
<a href="#l1.2151"></a><span id="l1.2151" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.2152"></a><span id="l1.2152" class="difflineminus">-  {</span>
<a href="#l1.2153"></a><span id="l1.2153" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.2154"></a><span id="l1.2154">     ClearHdrCache();</span>
<a href="#l1.2155"></a><span id="l1.2155">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2156"></a><span id="l1.2156">   }</span>
<a href="#l1.2157"></a><span id="l1.2157"> </span>
<a href="#l1.2158"></a><span id="l1.2158" class="difflineminus">-  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l1.2159"></a><span id="l1.2159" class="difflineplus">+  const nsAString &amp;colID = aCol-&gt;GetId();</span>
<a href="#l1.2160"></a><span id="l1.2160"> </span>
<a href="#l1.2161"></a><span id="l1.2161">   aValue.Truncate();</span>
<a href="#l1.2162"></a><span id="l1.2162" class="difflineminus">-  if (colID.IsEmpty())</span>
<a href="#l1.2163"></a><span id="l1.2163" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.2164"></a><span id="l1.2164" class="difflineplus">+  if (colID.IsEmpty()) return NS_OK;</span>
<a href="#l1.2165"></a><span id="l1.2165"> </span>
<a href="#l1.2166"></a><span id="l1.2166">   uint32_t flags;</span>
<a href="#l1.2167"></a><span id="l1.2167">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.2168"></a><span id="l1.2168"> </span>
<a href="#l1.2169"></a><span id="l1.2169">   // Provide a string &quot;value&quot; for cells that do not normally have text.</span>
<a href="#l1.2170"></a><span id="l1.2170">   // Use empty string for the normal states &quot;Read&quot;, &quot;Not Starred&quot;,</span>
<a href="#l1.2171"></a><span id="l1.2171">   // &quot;No Attachment&quot; and &quot;Not Junk&quot;.</span>
<a href="#l1.2172"></a><span id="l1.2172" class="difflineminus">-  switch (colID.First())</span>
<a href="#l1.2173"></a><span id="l1.2173" class="difflineminus">-  {</span>
<a href="#l1.2174"></a><span id="l1.2174" class="difflineplus">+  switch (colID.First()) {</span>
<a href="#l1.2175"></a><span id="l1.2175">     case 'a':</span>
<a href="#l1.2176"></a><span id="l1.2176">       if (colID.EqualsLiteral(&quot;attachmentCol&quot;) &amp;&amp;</span>
<a href="#l1.2177"></a><span id="l1.2177" class="difflineminus">-          flags &amp; nsMsgMessageFlags::Attachment)</span>
<a href="#l1.2178"></a><span id="l1.2178" class="difflineminus">-      {</span>
<a href="#l1.2179"></a><span id="l1.2179" class="difflineplus">+          flags &amp; nsMsgMessageFlags::Attachment) {</span>
<a href="#l1.2180"></a><span id="l1.2180">         nsString tmp_str;</span>
<a href="#l1.2181"></a><span id="l1.2181">         tmp_str.Adopt(GetString(u&quot;messageHasAttachment&quot;));</span>
<a href="#l1.2182"></a><span id="l1.2182">         aValue.Assign(tmp_str);</span>
<a href="#l1.2183"></a><span id="l1.2183">       }</span>
<a href="#l1.2184"></a><span id="l1.2184">       break;</span>
<a href="#l1.2185"></a><span id="l1.2185">     case 'f':</span>
<a href="#l1.2186"></a><span id="l1.2186">       if (colID.EqualsLiteral(&quot;flaggedCol&quot;) &amp;&amp;</span>
<a href="#l1.2187"></a><span id="l1.2187" class="difflineminus">-          flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.2188"></a><span id="l1.2188" class="difflineminus">-      {</span>
<a href="#l1.2189"></a><span id="l1.2189" class="difflineplus">+          flags &amp; nsMsgMessageFlags::Marked) {</span>
<a href="#l1.2190"></a><span id="l1.2190">         nsString tmp_str;</span>
<a href="#l1.2191"></a><span id="l1.2191">         tmp_str.Adopt(GetString(u&quot;messageHasFlag&quot;));</span>
<a href="#l1.2192"></a><span id="l1.2192">         aValue.Assign(tmp_str);</span>
<a href="#l1.2193"></a><span id="l1.2193">       }</span>
<a href="#l1.2194"></a><span id="l1.2194">       break;</span>
<a href="#l1.2195"></a><span id="l1.2195">     case 'j':</span>
<a href="#l1.2196"></a><span id="l1.2196" class="difflineminus">-      if (colID.EqualsLiteral(&quot;junkStatusCol&quot;) &amp;&amp;</span>
<a href="#l1.2197"></a><span id="l1.2197" class="difflineminus">-          JunkControlsEnabled(aRow))</span>
<a href="#l1.2198"></a><span id="l1.2198" class="difflineminus">-      {</span>
<a href="#l1.2199"></a><span id="l1.2199" class="difflineplus">+      if (colID.EqualsLiteral(&quot;junkStatusCol&quot;) &amp;&amp; JunkControlsEnabled(aRow)) {</span>
<a href="#l1.2200"></a><span id="l1.2200">         nsCString junkScoreStr;</span>
<a href="#l1.2201"></a><span id="l1.2201">         msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2202"></a><span id="l1.2202">         // Only need to assign a real value for junk, it's empty already</span>
<a href="#l1.2203"></a><span id="l1.2203">         // as it should be for non-junk.</span>
<a href="#l1.2204"></a><span id="l1.2204">         if (!junkScoreStr.IsEmpty() &amp;&amp;</span>
<a href="#l1.2205"></a><span id="l1.2205">             (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE))</span>
<a href="#l1.2206"></a><span id="l1.2206">           aValue.AssignLiteral(&quot;messageJunk&quot;);</span>
<a href="#l1.2207"></a><span id="l1.2207"> </span>
<a href="#l1.2208"></a><span id="l1.2208" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2209"></a><span id="l1.2209" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.2210"></a><span id="l1.2210" class="difflineplus">+                     &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2211"></a><span id="l1.2211">       }</span>
<a href="#l1.2212"></a><span id="l1.2212">       break;</span>
<a href="#l1.2213"></a><span id="l1.2213">     case 't':</span>
<a href="#l1.2214"></a><span id="l1.2214">       if (colID.EqualsLiteral(&quot;threadCol&quot;) &amp;&amp;</span>
<a href="#l1.2215"></a><span id="l1.2215" class="difflineminus">-          (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.2216"></a><span id="l1.2216" class="difflineminus">-      {</span>
<a href="#l1.2217"></a><span id="l1.2217" class="difflineplus">+          (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l1.2218"></a><span id="l1.2218">         // thread column</span>
<a href="#l1.2219"></a><span id="l1.2219">         bool isContainer, isContainerEmpty, isContainerOpen;</span>
<a href="#l1.2220"></a><span id="l1.2220">         IsContainer(aRow, &amp;isContainer);</span>
<a href="#l1.2221"></a><span id="l1.2221" class="difflineminus">-        if (isContainer)</span>
<a href="#l1.2222"></a><span id="l1.2222" class="difflineminus">-        {</span>
<a href="#l1.2223"></a><span id="l1.2223" class="difflineplus">+        if (isContainer) {</span>
<a href="#l1.2224"></a><span id="l1.2224">           IsContainerEmpty(aRow, &amp;isContainerEmpty);</span>
<a href="#l1.2225"></a><span id="l1.2225" class="difflineminus">-          if (!isContainerEmpty)</span>
<a href="#l1.2226"></a><span id="l1.2226" class="difflineminus">-          {</span>
<a href="#l1.2227"></a><span id="l1.2227" class="difflineplus">+          if (!isContainerEmpty) {</span>
<a href="#l1.2228"></a><span id="l1.2228">             nsString tmp_str;</span>
<a href="#l1.2229"></a><span id="l1.2229">             IsContainerOpen(aRow, &amp;isContainerOpen);</span>
<a href="#l1.2230"></a><span id="l1.2230" class="difflineminus">-            tmp_str.Adopt(GetString(isContainerOpen ?</span>
<a href="#l1.2231"></a><span id="l1.2231" class="difflineminus">-                            u&quot;messageExpanded&quot; :</span>
<a href="#l1.2232"></a><span id="l1.2232" class="difflineminus">-                            u&quot;messageCollapsed&quot;));</span>
<a href="#l1.2233"></a><span id="l1.2233" class="difflineplus">+            tmp_str.Adopt(GetString(isContainerOpen ? u&quot;messageExpanded&quot;</span>
<a href="#l1.2234"></a><span id="l1.2234" class="difflineplus">+                                                    : u&quot;messageCollapsed&quot;));</span>
<a href="#l1.2235"></a><span id="l1.2235">             aValue.Assign(tmp_str);</span>
<a href="#l1.2236"></a><span id="l1.2236">           }</span>
<a href="#l1.2237"></a><span id="l1.2237">         }</span>
<a href="#l1.2238"></a><span id="l1.2238">       }</span>
<a href="#l1.2239"></a><span id="l1.2239">       break;</span>
<a href="#l1.2240"></a><span id="l1.2240">     case 'u':</span>
<a href="#l1.2241"></a><span id="l1.2241">       if (colID.EqualsLiteral(&quot;unreadButtonColHeader&quot;) &amp;&amp;</span>
<a href="#l1.2242"></a><span id="l1.2242" class="difflineminus">-          !(flags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l1.2243"></a><span id="l1.2243" class="difflineminus">-      {</span>
<a href="#l1.2244"></a><span id="l1.2244" class="difflineplus">+          !(flags &amp; nsMsgMessageFlags::Read)) {</span>
<a href="#l1.2245"></a><span id="l1.2245">         nsString tmp_str;</span>
<a href="#l1.2246"></a><span id="l1.2246">         tmp_str.Adopt(GetString(u&quot;messageUnread&quot;));</span>
<a href="#l1.2247"></a><span id="l1.2247">         aValue.Assign(tmp_str);</span>
<a href="#l1.2248"></a><span id="l1.2248">       }</span>
<a href="#l1.2249"></a><span id="l1.2249">       break;</span>
<a href="#l1.2250"></a><span id="l1.2250">     default:</span>
<a href="#l1.2251"></a><span id="l1.2251">       aValue.Assign(colID);</span>
<a href="#l1.2252"></a><span id="l1.2252">       break;</span>
<a href="#l1.2253"></a><span id="l1.2253">   }</span>
<a href="#l1.2254"></a><span id="l1.2254"> </span>
<a href="#l1.2255"></a><span id="l1.2255">   return rv;</span>
<a href="#l1.2256"></a><span id="l1.2256"> }</span>
<a href="#l1.2257"></a><span id="l1.2257"> </span>
<a href="#l1.2258"></a><span id="l1.2258" class="difflineminus">-void</span>
<a href="#l1.2259"></a><span id="l1.2259" class="difflineminus">-nsMsgDBView::RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2260"></a><span id="l1.2260" class="difflineminus">-{</span>
<a href="#l1.2261"></a><span id="l1.2261" class="difflineplus">+void nsMsgDBView::RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.2262"></a><span id="l1.2262">   nsCString messageId;</span>
<a href="#l1.2263"></a><span id="l1.2263">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.2264"></a><span id="l1.2264">   if (mRecentlyDeletedArrayIndex &gt;= mRecentlyDeletedMsgIds.Length())</span>
<a href="#l1.2265"></a><span id="l1.2265">     mRecentlyDeletedMsgIds.AppendElement(messageId);</span>
<a href="#l1.2266"></a><span id="l1.2266">   else</span>
<a href="#l1.2267"></a><span id="l1.2267">     mRecentlyDeletedMsgIds[mRecentlyDeletedArrayIndex] = messageId;</span>
<a href="#l1.2268"></a><span id="l1.2268"> </span>
<a href="#l1.2269"></a><span id="l1.2269">   // Only remember last 20 deleted msgs.</span>
<a href="#l1.2270"></a><span id="l1.2270">   mRecentlyDeletedArrayIndex = (mRecentlyDeletedArrayIndex + 1) % 20;</span>
<a href="#l1.2271"></a><span id="l1.2271"> }</span>
<a href="#l1.2272"></a><span id="l1.2272"> </span>
<a href="#l1.2273"></a><span id="l1.2273" class="difflineminus">-bool</span>
<a href="#l1.2274"></a><span id="l1.2274" class="difflineminus">-nsMsgDBView::WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.2275"></a><span id="l1.2275" class="difflineminus">-{</span>
<a href="#l1.2276"></a><span id="l1.2276" class="difflineplus">+bool nsMsgDBView::WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.2277"></a><span id="l1.2277">   nsCString messageId;</span>
<a href="#l1.2278"></a><span id="l1.2278">   msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l1.2279"></a><span id="l1.2279">   return mRecentlyDeletedMsgIds.Contains(messageId);</span>
<a href="#l1.2280"></a><span id="l1.2280"> }</span>
<a href="#l1.2281"></a><span id="l1.2281"> </span>
<a href="#l1.2282"></a><span id="l1.2282"> /**</span>
<a href="#l1.2283"></a><span id="l1.2283">  * CUSTOM COLUMNS.</span>
<a href="#l1.2284"></a><span id="l1.2284">  */</span>
<a href="#l1.2285"></a><span id="l1.2285"> </span>
<a href="#l1.2286"></a><span id="l1.2286"> // Add a custom column handler.</span>
<a href="#l1.2287"></a><span id="l1.2287"> NS_IMETHODIMP</span>
<a href="#l1.2288"></a><span id="l1.2288" class="difflineminus">-nsMsgDBView::AddColumnHandler(const nsAString&amp; column,</span>
<a href="#l1.2289"></a><span id="l1.2289" class="difflineminus">-                              nsIMsgCustomColumnHandler* handler)</span>
<a href="#l1.2290"></a><span id="l1.2290" class="difflineminus">-{</span>
<a href="#l1.2291"></a><span id="l1.2291" class="difflineplus">+nsMsgDBView::AddColumnHandler(const nsAString &amp;column,</span>
<a href="#l1.2292"></a><span id="l1.2292" class="difflineplus">+                              nsIMsgCustomColumnHandler *handler) {</span>
<a href="#l1.2293"></a><span id="l1.2293">   bool custColInSort = false;</span>
<a href="#l1.2294"></a><span id="l1.2294">   size_t index = m_customColumnHandlerIDs.IndexOf(column);</span>
<a href="#l1.2295"></a><span id="l1.2295"> </span>
<a href="#l1.2296"></a><span id="l1.2296">   nsAutoString strColID(column);</span>
<a href="#l1.2297"></a><span id="l1.2297"> </span>
<a href="#l1.2298"></a><span id="l1.2298">   // Does not exist.</span>
<a href="#l1.2299"></a><span id="l1.2299" class="difflineminus">-  if (index == m_customColumnHandlerIDs.NoIndex)</span>
<a href="#l1.2300"></a><span id="l1.2300" class="difflineminus">-  {</span>
<a href="#l1.2301"></a><span id="l1.2301" class="difflineplus">+  if (index == m_customColumnHandlerIDs.NoIndex) {</span>
<a href="#l1.2302"></a><span id="l1.2302">     m_customColumnHandlerIDs.AppendElement(strColID);</span>
<a href="#l1.2303"></a><span id="l1.2303">     m_customColumnHandlers.AppendObject(handler);</span>
<a href="#l1.2304"></a><span id="l1.2304" class="difflineminus">-  }</span>
<a href="#l1.2305"></a><span id="l1.2305" class="difflineminus">-  else</span>
<a href="#l1.2306"></a><span id="l1.2306" class="difflineminus">-  {</span>
<a href="#l1.2307"></a><span id="l1.2307" class="difflineplus">+  } else {</span>
<a href="#l1.2308"></a><span id="l1.2308">     // Insert new handler into the appropriate place in the COMPtr array;</span>
<a href="#l1.2309"></a><span id="l1.2309">     // no need to replace the column ID (it's the same).</span>
<a href="#l1.2310"></a><span id="l1.2310">     m_customColumnHandlers.ReplaceObjectAt(handler, index);</span>
<a href="#l1.2311"></a><span id="l1.2311">   }</span>
<a href="#l1.2312"></a><span id="l1.2312"> </span>
<a href="#l1.2313"></a><span id="l1.2313">   // Check if the column name matches any of the columns in</span>
<a href="#l1.2314"></a><span id="l1.2314">   // m_sortColumns, and if so, set m_sortColumns[i].mColHandler</span>
<a href="#l1.2315"></a><span id="l1.2315" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.2316"></a><span id="l1.2316" class="difflineminus">-  {</span>
<a href="#l1.2317"></a><span id="l1.2317" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++) {</span>
<a href="#l1.2318"></a><span id="l1.2318">     MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.2319"></a><span id="l1.2319">     if (sortInfo.mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2320"></a><span id="l1.2320" class="difflineminus">-        sortInfo.mCustomColumnName.Equals(column))</span>
<a href="#l1.2321"></a><span id="l1.2321" class="difflineminus">-    {</span>
<a href="#l1.2322"></a><span id="l1.2322" class="difflineplus">+        sortInfo.mCustomColumnName.Equals(column)) {</span>
<a href="#l1.2323"></a><span id="l1.2323">       custColInSort = true;</span>
<a href="#l1.2324"></a><span id="l1.2324">       sortInfo.mColHandler = handler;</span>
<a href="#l1.2325"></a><span id="l1.2325">     }</span>
<a href="#l1.2326"></a><span id="l1.2326">   }</span>
<a href="#l1.2327"></a><span id="l1.2327"> </span>
<a href="#l1.2328"></a><span id="l1.2328">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l1.2329"></a><span id="l1.2329">     // Grouped view has its own ways.</span>
<a href="#l1.2330"></a><span id="l1.2330">     return NS_OK;</span>
<a href="#l1.2331"></a><span id="l1.2331" class="difflineat">@@ -2062,195 +1767,175 @@ nsMsgDBView::AddColumnHandler(const nsAS</span>
<a href="#l1.2332"></a><span id="l1.2332">   if (custColInSort &amp;&amp; !CustomColumnsInSortAndNotRegistered())</span>
<a href="#l1.2333"></a><span id="l1.2333">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l1.2334"></a><span id="l1.2334"> </span>
<a href="#l1.2335"></a><span id="l1.2335">   return NS_OK;</span>
<a href="#l1.2336"></a><span id="l1.2336"> }</span>
<a href="#l1.2337"></a><span id="l1.2337"> </span>
<a href="#l1.2338"></a><span id="l1.2338"> // Remove a custom column handler.</span>
<a href="#l1.2339"></a><span id="l1.2339"> NS_IMETHODIMP</span>
<a href="#l1.2340"></a><span id="l1.2340" class="difflineminus">-nsMsgDBView::RemoveColumnHandler(const nsAString&amp; aColID)</span>
<a href="#l1.2341"></a><span id="l1.2341" class="difflineminus">-{</span>
<a href="#l1.2342"></a><span id="l1.2342" class="difflineplus">+nsMsgDBView::RemoveColumnHandler(const nsAString &amp;aColID) {</span>
<a href="#l1.2343"></a><span id="l1.2343">   // Here we should check if the column name matches any of the columns in</span>
<a href="#l1.2344"></a><span id="l1.2344">   // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler.</span>
<a href="#l1.2345"></a><span id="l1.2345">   size_t index = m_customColumnHandlerIDs.IndexOf(aColID);</span>
<a href="#l1.2346"></a><span id="l1.2346"> </span>
<a href="#l1.2347"></a><span id="l1.2347" class="difflineminus">-  if (index != m_customColumnHandlerIDs.NoIndex)</span>
<a href="#l1.2348"></a><span id="l1.2348" class="difflineminus">-  {</span>
<a href="#l1.2349"></a><span id="l1.2349" class="difflineplus">+  if (index != m_customColumnHandlerIDs.NoIndex) {</span>
<a href="#l1.2350"></a><span id="l1.2350">     m_customColumnHandlerIDs.RemoveElementAt(index);</span>
<a href="#l1.2351"></a><span id="l1.2351">     m_customColumnHandlers.RemoveObjectAt(index);</span>
<a href="#l1.2352"></a><span id="l1.2352">     // Check if the column name matches any of the columns in</span>
<a href="#l1.2353"></a><span id="l1.2353">     // m_sortColumns, and if so, clear m_sortColumns[i].mColHandler.</span>
<a href="#l1.2354"></a><span id="l1.2354" class="difflineminus">-    for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.2355"></a><span id="l1.2355" class="difflineminus">-    {</span>
<a href="#l1.2356"></a><span id="l1.2356" class="difflineplus">+    for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++) {</span>
<a href="#l1.2357"></a><span id="l1.2357">       MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.2358"></a><span id="l1.2358">       if (sortInfo.mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2359"></a><span id="l1.2359">           sortInfo.mCustomColumnName.Equals(aColID))</span>
<a href="#l1.2360"></a><span id="l1.2360">         sortInfo.mColHandler = nullptr;</span>
<a href="#l1.2361"></a><span id="l1.2361">     }</span>
<a href="#l1.2362"></a><span id="l1.2362"> </span>
<a href="#l1.2363"></a><span id="l1.2363">     return NS_OK;</span>
<a href="#l1.2364"></a><span id="l1.2364">   }</span>
<a href="#l1.2365"></a><span id="l1.2365"> </span>
<a href="#l1.2366"></a><span id="l1.2366">   // Can't remove a column that isn't currently custom handled.</span>
<a href="#l1.2367"></a><span id="l1.2367">   return NS_ERROR_FAILURE;</span>
<a href="#l1.2368"></a><span id="l1.2368"> }</span>
<a href="#l1.2369"></a><span id="l1.2369"> </span>
<a href="#l1.2370"></a><span id="l1.2370" class="difflineminus">-//TODO: NS_ENSURE_SUCCESS</span>
<a href="#l1.2371"></a><span id="l1.2371" class="difflineminus">-nsIMsgCustomColumnHandler* nsMsgDBView::GetCurColumnHandler()</span>
<a href="#l1.2372"></a><span id="l1.2372" class="difflineminus">-{</span>
<a href="#l1.2373"></a><span id="l1.2373" class="difflineplus">+// TODO: NS_ENSURE_SUCCESS</span>
<a href="#l1.2374"></a><span id="l1.2374" class="difflineplus">+nsIMsgCustomColumnHandler *nsMsgDBView::GetCurColumnHandler() {</span>
<a href="#l1.2375"></a><span id="l1.2375">   return GetColumnHandler(m_curCustomColumn);</span>
<a href="#l1.2376"></a><span id="l1.2376"> }</span>
<a href="#l1.2377"></a><span id="l1.2377"> </span>
<a href="#l1.2378"></a><span id="l1.2378"> NS_IMETHODIMP</span>
<a href="#l1.2379"></a><span id="l1.2379" class="difflineminus">-nsMsgDBView::SetCurCustomColumn(const nsAString&amp; aColID)</span>
<a href="#l1.2380"></a><span id="l1.2380" class="difflineminus">-{</span>
<a href="#l1.2381"></a><span id="l1.2381" class="difflineplus">+nsMsgDBView::SetCurCustomColumn(const nsAString &amp;aColID) {</span>
<a href="#l1.2382"></a><span id="l1.2382">   m_curCustomColumn = aColID;</span>
<a href="#l1.2383"></a><span id="l1.2383" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l1.2384"></a><span id="l1.2384" class="difflineminus">-  {</span>
<a href="#l1.2385"></a><span id="l1.2385" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.2386"></a><span id="l1.2386" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2387"></a><span id="l1.2387" class="difflineminus">-    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.2388"></a><span id="l1.2388" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2389"></a><span id="l1.2389" class="difflineplus">+  if (m_viewFolder) {</span>
<a href="#l1.2390"></a><span id="l1.2390" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.2391"></a><span id="l1.2391" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2392"></a><span id="l1.2392" class="difflineplus">+    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.2393"></a><span id="l1.2393" class="difflineplus">+                                                     getter_AddRefs(db));</span>
<a href="#l1.2394"></a><span id="l1.2394" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2395"></a><span id="l1.2395">     folderInfo-&gt;SetProperty(&quot;customSortCol&quot;, aColID);</span>
<a href="#l1.2396"></a><span id="l1.2396">   }</span>
<a href="#l1.2397"></a><span id="l1.2397"> </span>
<a href="#l1.2398"></a><span id="l1.2398">   return NS_OK;</span>
<a href="#l1.2399"></a><span id="l1.2399"> }</span>
<a href="#l1.2400"></a><span id="l1.2400"> </span>
<a href="#l1.2401"></a><span id="l1.2401"> NS_IMETHODIMP</span>
<a href="#l1.2402"></a><span id="l1.2402" class="difflineminus">-nsMsgDBView::GetCurCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2403"></a><span id="l1.2403" class="difflineminus">-{</span>
<a href="#l1.2404"></a><span id="l1.2404" class="difflineplus">+nsMsgDBView::GetCurCustomColumn(nsAString &amp;result) {</span>
<a href="#l1.2405"></a><span id="l1.2405">   result = m_curCustomColumn;</span>
<a href="#l1.2406"></a><span id="l1.2406">   return NS_OK;</span>
<a href="#l1.2407"></a><span id="l1.2407"> }</span>
<a href="#l1.2408"></a><span id="l1.2408"> </span>
<a href="#l1.2409"></a><span id="l1.2409"> NS_IMETHODIMP</span>
<a href="#l1.2410"></a><span id="l1.2410" class="difflineminus">-nsMsgDBView::GetSecondaryCustomColumn(nsAString &amp;result)</span>
<a href="#l1.2411"></a><span id="l1.2411" class="difflineminus">-{</span>
<a href="#l1.2412"></a><span id="l1.2412" class="difflineplus">+nsMsgDBView::GetSecondaryCustomColumn(nsAString &amp;result) {</span>
<a href="#l1.2413"></a><span id="l1.2413">   result = m_secondaryCustomColumn;</span>
<a href="#l1.2414"></a><span id="l1.2414">   return NS_OK;</span>
<a href="#l1.2415"></a><span id="l1.2415"> }</span>
<a href="#l1.2416"></a><span id="l1.2416"> </span>
<a href="#l1.2417"></a><span id="l1.2417" class="difflineminus">-nsIMsgCustomColumnHandler* nsMsgDBView::GetColumnHandler(const nsAString &amp;colID)</span>
<a href="#l1.2418"></a><span id="l1.2418" class="difflineminus">-{</span>
<a href="#l1.2419"></a><span id="l1.2419" class="difflineplus">+nsIMsgCustomColumnHandler *nsMsgDBView::GetColumnHandler(</span>
<a href="#l1.2420"></a><span id="l1.2420" class="difflineplus">+    const nsAString &amp;colID) {</span>
<a href="#l1.2421"></a><span id="l1.2421">   size_t index = m_customColumnHandlerIDs.IndexOf(colID);</span>
<a href="#l1.2422"></a><span id="l1.2422" class="difflineminus">-  return (index != m_customColumnHandlerIDs.NoIndex) ?</span>
<a href="#l1.2423"></a><span id="l1.2423" class="difflineminus">-    m_customColumnHandlers[index] : nullptr;</span>
<a href="#l1.2424"></a><span id="l1.2424" class="difflineplus">+  return (index != m_customColumnHandlerIDs.NoIndex)</span>
<a href="#l1.2425"></a><span id="l1.2425" class="difflineplus">+             ? m_customColumnHandlers[index]</span>
<a href="#l1.2426"></a><span id="l1.2426" class="difflineplus">+             : nullptr;</span>
<a href="#l1.2427"></a><span id="l1.2427"> }</span>
<a href="#l1.2428"></a><span id="l1.2428"> </span>
<a href="#l1.2429"></a><span id="l1.2429"> NS_IMETHODIMP</span>
<a href="#l1.2430"></a><span id="l1.2430" class="difflineminus">-nsMsgDBView::GetColumnHandler(const nsAString&amp; aColID,</span>
<a href="#l1.2431"></a><span id="l1.2431" class="difflineminus">-                              nsIMsgCustomColumnHandler** aHandler)</span>
<a href="#l1.2432"></a><span id="l1.2432" class="difflineminus">-{</span>
<a href="#l1.2433"></a><span id="l1.2433" class="difflineplus">+nsMsgDBView::GetColumnHandler(const nsAString &amp;aColID,</span>
<a href="#l1.2434"></a><span id="l1.2434" class="difflineplus">+                              nsIMsgCustomColumnHandler **aHandler) {</span>
<a href="#l1.2435"></a><span id="l1.2435">   NS_ENSURE_ARG_POINTER(aHandler);</span>
<a href="#l1.2436"></a><span id="l1.2436">   nsAutoString column(aColID);</span>
<a href="#l1.2437"></a><span id="l1.2437">   NS_IF_ADDREF(*aHandler = GetColumnHandler(column));</span>
<a href="#l1.2438"></a><span id="l1.2438">   return (*aHandler) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l1.2439"></a><span id="l1.2439"> }</span>
<a href="#l1.2440"></a><span id="l1.2440"> </span>
<a href="#l1.2441"></a><span id="l1.2441"> // Check if any active sort columns are custom. If none are custom, return false</span>
<a href="#l1.2442"></a><span id="l1.2442"> // and go on as always. If any are custom, and all are not registered yet,</span>
<a href="#l1.2443"></a><span id="l1.2443"> // return true (so that the caller can postpone sort). When the custom column</span>
<a href="#l1.2444"></a><span id="l1.2444"> // observer is notified with MsgCreateDBView and registers the handler,</span>
<a href="#l1.2445"></a><span id="l1.2445"> // AddColumnHandler will sort once all required handlers are set.</span>
<a href="#l1.2446"></a><span id="l1.2446" class="difflineminus">-bool nsMsgDBView::CustomColumnsInSortAndNotRegistered()</span>
<a href="#l1.2447"></a><span id="l1.2447" class="difflineminus">-{</span>
<a href="#l1.2448"></a><span id="l1.2448" class="difflineplus">+bool nsMsgDBView::CustomColumnsInSortAndNotRegistered() {</span>
<a href="#l1.2449"></a><span id="l1.2449">   // The initial sort on view open has been started, subsequent user initiated</span>
<a href="#l1.2450"></a><span id="l1.2450">   // sort callers can ignore verifying cust col registration.</span>
<a href="#l1.2451"></a><span id="l1.2451">   m_checkedCustomColumns = true;</span>
<a href="#l1.2452"></a><span id="l1.2452"> </span>
<a href="#l1.2453"></a><span id="l1.2453">   // DecodeColumnSort must have already created m_sortColumns, otherwise we</span>
<a href="#l1.2454"></a><span id="l1.2454">   // can't know, but go on anyway.</span>
<a href="#l1.2455"></a><span id="l1.2455" class="difflineminus">-  if (!m_sortColumns.Length())</span>
<a href="#l1.2456"></a><span id="l1.2456" class="difflineminus">-    return false;</span>
<a href="#l1.2457"></a><span id="l1.2457" class="difflineplus">+  if (!m_sortColumns.Length()) return false;</span>
<a href="#l1.2458"></a><span id="l1.2458"> </span>
<a href="#l1.2459"></a><span id="l1.2459">   bool custColNotRegistered = false;</span>
<a href="#l1.2460"></a><span id="l1.2460" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_sortColumns.Length() &amp;&amp; !custColNotRegistered; i++)</span>
<a href="#l1.2461"></a><span id="l1.2461" class="difflineminus">-  {</span>
<a href="#l1.2462"></a><span id="l1.2462" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_sortColumns.Length() &amp;&amp; !custColNotRegistered;</span>
<a href="#l1.2463"></a><span id="l1.2463" class="difflineplus">+       i++) {</span>
<a href="#l1.2464"></a><span id="l1.2464">     if (m_sortColumns[i].mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.2465"></a><span id="l1.2465">         m_sortColumns[i].mColHandler == nullptr)</span>
<a href="#l1.2466"></a><span id="l1.2466">       custColNotRegistered = true;</span>
<a href="#l1.2467"></a><span id="l1.2467">   }</span>
<a href="#l1.2468"></a><span id="l1.2468"> </span>
<a href="#l1.2469"></a><span id="l1.2469">   return custColNotRegistered;</span>
<a href="#l1.2470"></a><span id="l1.2470"> }</span>
<a href="#l1.2471"></a><span id="l1.2471"> // END CUSTOM COLUMNS.</span>
<a href="#l1.2472"></a><span id="l1.2472"> </span>
<a href="#l1.2473"></a><span id="l1.2473"> NS_IMETHODIMP</span>
<a href="#l1.2474"></a><span id="l1.2474" class="difflineminus">-nsMsgDBView::GetCellText(int32_t aRow,</span>
<a href="#l1.2475"></a><span id="l1.2475" class="difflineminus">-                         nsTreeColumn* aCol,</span>
<a href="#l1.2476"></a><span id="l1.2476" class="difflineminus">-                         nsAString&amp; aValue)</span>
<a href="#l1.2477"></a><span id="l1.2477" class="difflineminus">-{</span>
<a href="#l1.2478"></a><span id="l1.2478" class="difflineminus">-  const nsAString&amp; colID = aCol-&gt;GetId();</span>
<a href="#l1.2479"></a><span id="l1.2479" class="difflineminus">-</span>
<a href="#l1.2480"></a><span id="l1.2480" class="difflineminus">-  if (!IsValidIndex(aRow))</span>
<a href="#l1.2481"></a><span id="l1.2481" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2482"></a><span id="l1.2482" class="difflineplus">+nsMsgDBView::GetCellText(int32_t aRow, nsTreeColumn *aCol, nsAString &amp;aValue) {</span>
<a href="#l1.2483"></a><span id="l1.2483" class="difflineplus">+  const nsAString &amp;colID = aCol-&gt;GetId();</span>
<a href="#l1.2484"></a><span id="l1.2484" class="difflineplus">+</span>
<a href="#l1.2485"></a><span id="l1.2485" class="difflineplus">+  if (!IsValidIndex(aRow)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2486"></a><span id="l1.2486"> </span>
<a href="#l1.2487"></a><span id="l1.2487">   aValue.Truncate();</span>
<a href="#l1.2488"></a><span id="l1.2488"> </span>
<a href="#l1.2489"></a><span id="l1.2489">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l1.2490"></a><span id="l1.2490">   // return.</span>
<a href="#l1.2491"></a><span id="l1.2491" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2492"></a><span id="l1.2492" class="difflineminus">-</span>
<a href="#l1.2493"></a><span id="l1.2493" class="difflineminus">-  if (colHandler)</span>
<a href="#l1.2494"></a><span id="l1.2494" class="difflineminus">-  {</span>
<a href="#l1.2495"></a><span id="l1.2495" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2496"></a><span id="l1.2496" class="difflineplus">+</span>
<a href="#l1.2497"></a><span id="l1.2497" class="difflineplus">+  if (colHandler) {</span>
<a href="#l1.2498"></a><span id="l1.2498">     colHandler-&gt;GetCellText(aRow, aCol, aValue);</span>
<a href="#l1.2499"></a><span id="l1.2499">     return NS_OK;</span>
<a href="#l1.2500"></a><span id="l1.2500">   }</span>
<a href="#l1.2501"></a><span id="l1.2501"> </span>
<a href="#l1.2502"></a><span id="l1.2502">   return CellTextForColumn(aRow, colID, aValue);</span>
<a href="#l1.2503"></a><span id="l1.2503"> }</span>
<a href="#l1.2504"></a><span id="l1.2504"> </span>
<a href="#l1.2505"></a><span id="l1.2505"> NS_IMETHODIMP</span>
<a href="#l1.2506"></a><span id="l1.2506" class="difflineminus">-nsMsgDBView::CellTextForColumn(int32_t aRow,</span>
<a href="#l1.2507"></a><span id="l1.2507" class="difflineminus">-                               const nsAString&amp; aColumnName,</span>
<a href="#l1.2508"></a><span id="l1.2508" class="difflineminus">-                               nsAString &amp;aValue)</span>
<a href="#l1.2509"></a><span id="l1.2509" class="difflineminus">-{</span>
<a href="#l1.2510"></a><span id="l1.2510" class="difflineplus">+nsMsgDBView::CellTextForColumn(int32_t aRow, const nsAString &amp;aColumnName,</span>
<a href="#l1.2511"></a><span id="l1.2511" class="difflineplus">+                               nsAString &amp;aValue) {</span>
<a href="#l1.2512"></a><span id="l1.2512">   if (aColumnName.IsEmpty()) {</span>
<a href="#l1.2513"></a><span id="l1.2513">     aValue.Truncate();</span>
<a href="#l1.2514"></a><span id="l1.2514">     return NS_OK;</span>
<a href="#l1.2515"></a><span id="l1.2515">   }</span>
<a href="#l1.2516"></a><span id="l1.2516"> </span>
<a href="#l1.2517"></a><span id="l1.2517">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2518"></a><span id="l1.2518">   nsresult rv = GetMsgHdrForViewIndex(aRow, getter_AddRefs(msgHdr));</span>
<a href="#l1.2519"></a><span id="l1.2519"> </span>
<a href="#l1.2520"></a><span id="l1.2520" class="difflineminus">-  if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.2521"></a><span id="l1.2521" class="difflineminus">-  {</span>
<a href="#l1.2522"></a><span id="l1.2522" class="difflineplus">+  if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.2523"></a><span id="l1.2523">     ClearHdrCache();</span>
<a href="#l1.2524"></a><span id="l1.2524">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2525"></a><span id="l1.2525">   }</span>
<a href="#l1.2526"></a><span id="l1.2526"> </span>
<a href="#l1.2527"></a><span id="l1.2527">   nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.2528"></a><span id="l1.2528"> </span>
<a href="#l1.2529"></a><span id="l1.2529" class="difflineminus">-  switch (aColumnName.First())</span>
<a href="#l1.2530"></a><span id="l1.2530" class="difflineminus">-  {</span>
<a href="#l1.2531"></a><span id="l1.2531" class="difflineplus">+  switch (aColumnName.First()) {</span>
<a href="#l1.2532"></a><span id="l1.2532">     case 's':</span>
<a href="#l1.2533"></a><span id="l1.2533">       if (aColumnName.EqualsLiteral(&quot;subjectCol&quot;))</span>
<a href="#l1.2534"></a><span id="l1.2534">         rv = FetchSubject(msgHdr, m_flags[aRow], aValue);</span>
<a href="#l1.2535"></a><span id="l1.2535">       else if (aColumnName.EqualsLiteral(&quot;senderCol&quot;))</span>
<a href="#l1.2536"></a><span id="l1.2536">         rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2537"></a><span id="l1.2537">       else if (aColumnName.EqualsLiteral(&quot;sizeCol&quot;))</span>
<a href="#l1.2538"></a><span id="l1.2538">         rv = FetchSize(msgHdr, aValue);</span>
<a href="#l1.2539"></a><span id="l1.2539" class="difflineminus">-      else if (aColumnName.EqualsLiteral(&quot;statusCol&quot;))</span>
<a href="#l1.2540"></a><span id="l1.2540" class="difflineminus">-      {</span>
<a href="#l1.2541"></a><span id="l1.2541" class="difflineplus">+      else if (aColumnName.EqualsLiteral(&quot;statusCol&quot;)) {</span>
<a href="#l1.2542"></a><span id="l1.2542">         uint32_t flags;</span>
<a href="#l1.2543"></a><span id="l1.2543">         msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.2544"></a><span id="l1.2544">         rv = FetchStatus(flags, aValue);</span>
<a href="#l1.2545"></a><span id="l1.2545">       }</span>
<a href="#l1.2546"></a><span id="l1.2546">       break;</span>
<a href="#l1.2547"></a><span id="l1.2547">     case 'r':</span>
<a href="#l1.2548"></a><span id="l1.2548">       if (aColumnName.EqualsLiteral(&quot;recipientCol&quot;))</span>
<a href="#l1.2549"></a><span id="l1.2549">         rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2550"></a><span id="l1.2550">       else if (aColumnName.EqualsLiteral(&quot;receivedCol&quot;))</span>
<a href="#l1.2551"></a><span id="l1.2551">         rv = FetchDate(msgHdr, aValue, true);</span>
<a href="#l1.2552"></a><span id="l1.2552">       break;</span>
<a href="#l1.2553"></a><span id="l1.2553">     case 'd':</span>
<a href="#l1.2554"></a><span id="l1.2554" class="difflineminus">-      if (aColumnName.EqualsLiteral(&quot;dateCol&quot;))</span>
<a href="#l1.2555"></a><span id="l1.2555" class="difflineminus">-        rv = FetchDate(msgHdr, aValue);</span>
<a href="#l1.2556"></a><span id="l1.2556" class="difflineplus">+      if (aColumnName.EqualsLiteral(&quot;dateCol&quot;)) rv = FetchDate(msgHdr, aValue);</span>
<a href="#l1.2557"></a><span id="l1.2557">       break;</span>
<a href="#l1.2558"></a><span id="l1.2558">     case 'c':</span>
<a href="#l1.2559"></a><span id="l1.2559">       if (aColumnName.EqualsLiteral(&quot;correspondentCol&quot;)) {</span>
<a href="#l1.2560"></a><span id="l1.2560">         if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.2561"></a><span id="l1.2561">           rv = FetchRecipients(msgHdr, aValue);</span>
<a href="#l1.2562"></a><span id="l1.2562">         else</span>
<a href="#l1.2563"></a><span id="l1.2563">           rv = FetchAuthor(msgHdr, aValue);</span>
<a href="#l1.2564"></a><span id="l1.2564">       }</span>
<a href="#l1.2565"></a><span id="l1.2565" class="difflineat">@@ -2261,69 +1946,58 @@ nsMsgDBView::CellTextForColumn(int32_t a</span>
<a href="#l1.2566"></a><span id="l1.2566">       break;</span>
<a href="#l1.2567"></a><span id="l1.2567">     case 'a':</span>
<a href="#l1.2568"></a><span id="l1.2568">       if (aColumnName.EqualsLiteral(&quot;accountCol&quot;))</span>
<a href="#l1.2569"></a><span id="l1.2569">         rv = FetchAccount(msgHdr, aValue);</span>
<a href="#l1.2570"></a><span id="l1.2570">       break;</span>
<a href="#l1.2571"></a><span id="l1.2571">     case 't':</span>
<a href="#l1.2572"></a><span id="l1.2572">       // total msgs in thread column</span>
<a href="#l1.2573"></a><span id="l1.2573">       if (aColumnName.EqualsLiteral(&quot;totalCol&quot;) &amp;&amp;</span>
<a href="#l1.2574"></a><span id="l1.2574" class="difflineminus">-          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.2575"></a><span id="l1.2575" class="difflineminus">-      {</span>
<a href="#l1.2576"></a><span id="l1.2576" class="difflineminus">-        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2577"></a><span id="l1.2577" class="difflineminus">-        {</span>
<a href="#l1.2578"></a><span id="l1.2578" class="difflineplus">+          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.2579"></a><span id="l1.2579" class="difflineplus">+        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD) {</span>
<a href="#l1.2580"></a><span id="l1.2580">           rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2581"></a><span id="l1.2581" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2582"></a><span id="l1.2582" class="difflineminus">-          {</span>
<a href="#l1.2583"></a><span id="l1.2583" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; thread) {</span>
<a href="#l1.2584"></a><span id="l1.2584">             nsAutoString formattedCountString;</span>
<a href="#l1.2585"></a><span id="l1.2585">             uint32_t numChildren;</span>
<a href="#l1.2586"></a><span id="l1.2586">             thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.2587"></a><span id="l1.2587">             formattedCountString.AppendInt(numChildren);</span>
<a href="#l1.2588"></a><span id="l1.2588">             aValue.Assign(formattedCountString);</span>
<a href="#l1.2589"></a><span id="l1.2589">           }</span>
<a href="#l1.2590"></a><span id="l1.2590">         }</span>
<a href="#l1.2591"></a><span id="l1.2591" class="difflineminus">-      }</span>
<a href="#l1.2592"></a><span id="l1.2592" class="difflineminus">-      else if (aColumnName.EqualsLiteral(&quot;tagsCol&quot;))</span>
<a href="#l1.2593"></a><span id="l1.2593" class="difflineminus">-      {</span>
<a href="#l1.2594"></a><span id="l1.2594" class="difflineplus">+      } else if (aColumnName.EqualsLiteral(&quot;tagsCol&quot;)) {</span>
<a href="#l1.2595"></a><span id="l1.2595">         rv = FetchTags(msgHdr, aValue);</span>
<a href="#l1.2596"></a><span id="l1.2596">       }</span>
<a href="#l1.2597"></a><span id="l1.2597">       break;</span>
<a href="#l1.2598"></a><span id="l1.2598">     case 'u':</span>
<a href="#l1.2599"></a><span id="l1.2599">       // unread msgs in thread col</span>
<a href="#l1.2600"></a><span id="l1.2600">       if (aColumnName.EqualsLiteral(&quot;unreadCol&quot;) &amp;&amp;</span>
<a href="#l1.2601"></a><span id="l1.2601" class="difflineminus">-          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.2602"></a><span id="l1.2602" class="difflineminus">-      {</span>
<a href="#l1.2603"></a><span id="l1.2603" class="difflineminus">-        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.2604"></a><span id="l1.2604" class="difflineminus">-        {</span>
<a href="#l1.2605"></a><span id="l1.2605" class="difflineplus">+          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.2606"></a><span id="l1.2606" class="difflineplus">+        if (m_flags[aRow] &amp; MSG_VIEW_FLAG_ISTHREAD) {</span>
<a href="#l1.2607"></a><span id="l1.2607">           rv = GetThreadContainingIndex(aRow, getter_AddRefs(thread));</span>
<a href="#l1.2608"></a><span id="l1.2608" class="difflineminus">-          if (NS_SUCCEEDED(rv) &amp;&amp; thread)</span>
<a href="#l1.2609"></a><span id="l1.2609" class="difflineminus">-          {</span>
<a href="#l1.2610"></a><span id="l1.2610" class="difflineplus">+          if (NS_SUCCEEDED(rv) &amp;&amp; thread) {</span>
<a href="#l1.2611"></a><span id="l1.2611">             nsAutoString formattedCountString;</span>
<a href="#l1.2612"></a><span id="l1.2612">             uint32_t numUnreadChildren;</span>
<a href="#l1.2613"></a><span id="l1.2613">             thread-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.2614"></a><span id="l1.2614" class="difflineminus">-            if (numUnreadChildren &gt; 0)</span>
<a href="#l1.2615"></a><span id="l1.2615" class="difflineminus">-            {</span>
<a href="#l1.2616"></a><span id="l1.2616" class="difflineplus">+            if (numUnreadChildren &gt; 0) {</span>
<a href="#l1.2617"></a><span id="l1.2617">               formattedCountString.AppendInt(numUnreadChildren);</span>
<a href="#l1.2618"></a><span id="l1.2618">               aValue.Assign(formattedCountString);</span>
<a href="#l1.2619"></a><span id="l1.2619">             }</span>
<a href="#l1.2620"></a><span id="l1.2620">           }</span>
<a href="#l1.2621"></a><span id="l1.2621">         }</span>
<a href="#l1.2622"></a><span id="l1.2622">       }</span>
<a href="#l1.2623"></a><span id="l1.2623">       break;</span>
<a href="#l1.2624"></a><span id="l1.2624" class="difflineminus">-    case 'j':</span>
<a href="#l1.2625"></a><span id="l1.2625" class="difflineminus">-    {</span>
<a href="#l1.2626"></a><span id="l1.2626" class="difflineplus">+    case 'j': {</span>
<a href="#l1.2627"></a><span id="l1.2627">       if (aColumnName.EqualsLiteral(&quot;junkStatusCol&quot;)) {</span>
<a href="#l1.2628"></a><span id="l1.2628">         nsCString junkScoreStr;</span>
<a href="#l1.2629"></a><span id="l1.2629">         msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2630"></a><span id="l1.2630">         CopyASCIItoUTF16(junkScoreStr, aValue);</span>
<a href="#l1.2631"></a><span id="l1.2631">       }</span>
<a href="#l1.2632"></a><span id="l1.2632">       break;</span>
<a href="#l1.2633"></a><span id="l1.2633">     }</span>
<a href="#l1.2634"></a><span id="l1.2634" class="difflineminus">-    case 'i':</span>
<a href="#l1.2635"></a><span id="l1.2635" class="difflineminus">-    {</span>
<a href="#l1.2636"></a><span id="l1.2636" class="difflineplus">+    case 'i': {</span>
<a href="#l1.2637"></a><span id="l1.2637">       if (aColumnName.EqualsLiteral(&quot;idCol&quot;)) {</span>
<a href="#l1.2638"></a><span id="l1.2638">         nsAutoString keyString;</span>
<a href="#l1.2639"></a><span id="l1.2639">         nsMsgKey key;</span>
<a href="#l1.2640"></a><span id="l1.2640">         msgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l1.2641"></a><span id="l1.2641">         keyString.AppendInt((int64_t)key);</span>
<a href="#l1.2642"></a><span id="l1.2642">         aValue.Assign(keyString);</span>
<a href="#l1.2643"></a><span id="l1.2643">       }</span>
<a href="#l1.2644"></a><span id="l1.2644">       break;</span>
<a href="#l1.2645"></a><span id="l1.2645" class="difflineat">@@ -2331,251 +2005,223 @@ nsMsgDBView::CellTextForColumn(int32_t a</span>
<a href="#l1.2646"></a><span id="l1.2646">     default:</span>
<a href="#l1.2647"></a><span id="l1.2647">       break;</span>
<a href="#l1.2648"></a><span id="l1.2648">   }</span>
<a href="#l1.2649"></a><span id="l1.2649"> </span>
<a href="#l1.2650"></a><span id="l1.2650">   return NS_OK;</span>
<a href="#l1.2651"></a><span id="l1.2651"> }</span>
<a href="#l1.2652"></a><span id="l1.2652"> </span>
<a href="#l1.2653"></a><span id="l1.2653"> NS_IMETHODIMP</span>
<a href="#l1.2654"></a><span id="l1.2654" class="difflineminus">-nsMsgDBView::SetTree(mozilla::dom::XULTreeElement *tree)</span>
<a href="#l1.2655"></a><span id="l1.2655" class="difflineminus">-{</span>
<a href="#l1.2656"></a><span id="l1.2656" class="difflineplus">+nsMsgDBView::SetTree(mozilla::dom::XULTreeElement *tree) {</span>
<a href="#l1.2657"></a><span id="l1.2657">   mTree = tree;</span>
<a href="#l1.2658"></a><span id="l1.2658">   return NS_OK;</span>
<a href="#l1.2659"></a><span id="l1.2659"> }</span>
<a href="#l1.2660"></a><span id="l1.2660"> </span>
<a href="#l1.2661"></a><span id="l1.2661"> NS_IMETHODIMP</span>
<a href="#l1.2662"></a><span id="l1.2662" class="difflineminus">-nsMsgDBView::ToggleOpenState(int32_t index)</span>
<a href="#l1.2663"></a><span id="l1.2663" class="difflineminus">-{</span>
<a href="#l1.2664"></a><span id="l1.2664" class="difflineplus">+nsMsgDBView::ToggleOpenState(int32_t index) {</span>
<a href="#l1.2665"></a><span id="l1.2665">   uint32_t numChanged;</span>
<a href="#l1.2666"></a><span id="l1.2666">   nsresult rv = ToggleExpansion(index, &amp;numChanged);</span>
<a href="#l1.2667"></a><span id="l1.2667" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2668"></a><span id="l1.2668" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2669"></a><span id="l1.2669">   return NS_OK;</span>
<a href="#l1.2670"></a><span id="l1.2670"> }</span>
<a href="#l1.2671"></a><span id="l1.2671"> </span>
<a href="#l1.2672"></a><span id="l1.2672"> NS_IMETHODIMP</span>
<a href="#l1.2673"></a><span id="l1.2673" class="difflineminus">-nsMsgDBView::CycleHeader(nsTreeColumn* aCol)</span>
<a href="#l1.2674"></a><span id="l1.2674" class="difflineminus">-{</span>
<a href="#l1.2675"></a><span id="l1.2675" class="difflineplus">+nsMsgDBView::CycleHeader(nsTreeColumn *aCol) {</span>
<a href="#l1.2676"></a><span id="l1.2676">   // Let HandleColumnClick() in threadPane.js handle it</span>
<a href="#l1.2677"></a><span id="l1.2677">   // since it will set / clear the sort indicators.</span>
<a href="#l1.2678"></a><span id="l1.2678">   return NS_OK;</span>
<a href="#l1.2679"></a><span id="l1.2679"> }</span>
<a href="#l1.2680"></a><span id="l1.2680"> </span>
<a href="#l1.2681"></a><span id="l1.2681"> NS_IMETHODIMP</span>
<a href="#l1.2682"></a><span id="l1.2682" class="difflineminus">-nsMsgDBView::CycleCell(int32_t row,</span>
<a href="#l1.2683"></a><span id="l1.2683" class="difflineminus">-                       nsTreeColumn* col)</span>
<a href="#l1.2684"></a><span id="l1.2684" class="difflineminus">-{</span>
<a href="#l1.2685"></a><span id="l1.2685" class="difflineminus">-  if (!IsValidIndex(row))</span>
<a href="#l1.2686"></a><span id="l1.2686" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2687"></a><span id="l1.2687" class="difflineminus">-</span>
<a href="#l1.2688"></a><span id="l1.2688" class="difflineminus">-  const nsAString&amp; colID = col-&gt;GetId();</span>
<a href="#l1.2689"></a><span id="l1.2689" class="difflineplus">+nsMsgDBView::CycleCell(int32_t row, nsTreeColumn *col) {</span>
<a href="#l1.2690"></a><span id="l1.2690" class="difflineplus">+  if (!IsValidIndex(row)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.2691"></a><span id="l1.2691" class="difflineplus">+</span>
<a href="#l1.2692"></a><span id="l1.2692" class="difflineplus">+  const nsAString &amp;colID = col-&gt;GetId();</span>
<a href="#l1.2693"></a><span id="l1.2693"> </span>
<a href="#l1.2694"></a><span id="l1.2694">   // Attempt to retrieve a custom column handler. If it exists call it and</span>
<a href="#l1.2695"></a><span id="l1.2695">   // return.</span>
<a href="#l1.2696"></a><span id="l1.2696" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2697"></a><span id="l1.2697" class="difflineminus">-</span>
<a href="#l1.2698"></a><span id="l1.2698" class="difflineminus">-  if (colHandler)</span>
<a href="#l1.2699"></a><span id="l1.2699" class="difflineminus">-  {</span>
<a href="#l1.2700"></a><span id="l1.2700" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetColumnHandler(colID);</span>
<a href="#l1.2701"></a><span id="l1.2701" class="difflineplus">+</span>
<a href="#l1.2702"></a><span id="l1.2702" class="difflineplus">+  if (colHandler) {</span>
<a href="#l1.2703"></a><span id="l1.2703">     colHandler-&gt;CycleCell(row, col);</span>
<a href="#l1.2704"></a><span id="l1.2704">     return NS_OK;</span>
<a href="#l1.2705"></a><span id="l1.2705">   }</span>
<a href="#l1.2706"></a><span id="l1.2706"> </span>
<a href="#l1.2707"></a><span id="l1.2707">   // The cyclers below don't work for the grouped header dummy row, currently.</span>
<a href="#l1.2708"></a><span id="l1.2708">   // A future implementation should consider both collapsed and expanded state.</span>
<a href="#l1.2709"></a><span id="l1.2709">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort &amp;&amp;</span>
<a href="#l1.2710"></a><span id="l1.2710">       m_flags[row] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.2711"></a><span id="l1.2711">     return NS_OK;</span>
<a href="#l1.2712"></a><span id="l1.2712"> </span>
<a href="#l1.2713"></a><span id="l1.2713" class="difflineminus">-  if (colID.IsEmpty())</span>
<a href="#l1.2714"></a><span id="l1.2714" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.2715"></a><span id="l1.2715" class="difflineminus">-</span>
<a href="#l1.2716"></a><span id="l1.2716" class="difflineminus">-  switch (colID.First())</span>
<a href="#l1.2717"></a><span id="l1.2717" class="difflineminus">-  {</span>
<a href="#l1.2718"></a><span id="l1.2718" class="difflineplus">+  if (colID.IsEmpty()) return NS_OK;</span>
<a href="#l1.2719"></a><span id="l1.2719" class="difflineplus">+</span>
<a href="#l1.2720"></a><span id="l1.2720" class="difflineplus">+  switch (colID.First()) {</span>
<a href="#l1.2721"></a><span id="l1.2721">     case 'u':</span>
<a href="#l1.2722"></a><span id="l1.2722">       if (colID.EqualsLiteral(&quot;unreadButtonColHeader&quot;))</span>
<a href="#l1.2723"></a><span id="l1.2723">         ApplyCommandToIndices(nsMsgViewCommandType::toggleMessageRead,</span>
<a href="#l1.2724"></a><span id="l1.2724" class="difflineminus">-                              (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2725"></a><span id="l1.2725" class="difflineminus">-     break;</span>
<a href="#l1.2726"></a><span id="l1.2726" class="difflineplus">+                              (nsMsgViewIndex *)&amp;row, 1);</span>
<a href="#l1.2727"></a><span id="l1.2727" class="difflineplus">+      break;</span>
<a href="#l1.2728"></a><span id="l1.2728">     case 't':</span>
<a href="#l1.2729"></a><span id="l1.2729" class="difflineminus">-      if (colID.EqualsLiteral(&quot;threadCol&quot;))</span>
<a href="#l1.2730"></a><span id="l1.2730" class="difflineminus">-      {</span>
<a href="#l1.2731"></a><span id="l1.2731" class="difflineplus">+      if (colID.EqualsLiteral(&quot;threadCol&quot;)) {</span>
<a href="#l1.2732"></a><span id="l1.2732">         ExpandAndSelectThreadByIndex(row, false);</span>
<a href="#l1.2733"></a><span id="l1.2733" class="difflineminus">-      }</span>
<a href="#l1.2734"></a><span id="l1.2734" class="difflineminus">-      else if (colID.EqualsLiteral(&quot;tagsCol&quot;))</span>
<a href="#l1.2735"></a><span id="l1.2735" class="difflineminus">-      {</span>
<a href="#l1.2736"></a><span id="l1.2736" class="difflineplus">+      } else if (colID.EqualsLiteral(&quot;tagsCol&quot;)) {</span>
<a href="#l1.2737"></a><span id="l1.2737">         // XXX Do we want to keep this behaviour but switch it to tags?</span>
<a href="#l1.2738"></a><span id="l1.2738">         // We could enumerate over the tags and go to the next one - it looks</span>
<a href="#l1.2739"></a><span id="l1.2739">         // to me like this wasn't working before tags landed, so maybe not</span>
<a href="#l1.2740"></a><span id="l1.2740">         // worth bothering with.</span>
<a href="#l1.2741"></a><span id="l1.2741">       }</span>
<a href="#l1.2742"></a><span id="l1.2742">       break;</span>
<a href="#l1.2743"></a><span id="l1.2743">     case 'f':</span>
<a href="#l1.2744"></a><span id="l1.2744">       if (colID.EqualsLiteral(&quot;flaggedCol&quot;)) {</span>
<a href="#l1.2745"></a><span id="l1.2745">         // toggle the flagged status of the element at row.</span>
<a href="#l1.2746"></a><span id="l1.2746">         if (m_flags[row] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.2747"></a><span id="l1.2747">           ApplyCommandToIndices(nsMsgViewCommandType::unflagMessages,</span>
<a href="#l1.2748"></a><span id="l1.2748" class="difflineminus">-                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2749"></a><span id="l1.2749" class="difflineplus">+                                (nsMsgViewIndex *)&amp;row, 1);</span>
<a href="#l1.2750"></a><span id="l1.2750">         else</span>
<a href="#l1.2751"></a><span id="l1.2751">           ApplyCommandToIndices(nsMsgViewCommandType::flagMessages,</span>
<a href="#l1.2752"></a><span id="l1.2752" class="difflineminus">-                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2753"></a><span id="l1.2753" class="difflineplus">+                                (nsMsgViewIndex *)&amp;row, 1);</span>
<a href="#l1.2754"></a><span id="l1.2754">       }</span>
<a href="#l1.2755"></a><span id="l1.2755">       break;</span>
<a href="#l1.2756"></a><span id="l1.2756" class="difflineminus">-    case 'j':</span>
<a href="#l1.2757"></a><span id="l1.2757" class="difflineminus">-    {</span>
<a href="#l1.2758"></a><span id="l1.2758" class="difflineplus">+    case 'j': {</span>
<a href="#l1.2759"></a><span id="l1.2759">       if (!colID.EqualsLiteral(&quot;junkStatusCol&quot;) || !JunkControlsEnabled(row))</span>
<a href="#l1.2760"></a><span id="l1.2760">         return NS_OK;</span>
<a href="#l1.2761"></a><span id="l1.2761"> </span>
<a href="#l1.2762"></a><span id="l1.2762" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2763"></a><span id="l1.2763" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.2764"></a><span id="l1.2764">       nsresult rv = GetMsgHdrForViewIndex(row, getter_AddRefs(msgHdr));</span>
<a href="#l1.2765"></a><span id="l1.2765" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l1.2766"></a><span id="l1.2766" class="difflineminus">-      {</span>
<a href="#l1.2767"></a><span id="l1.2767" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr) {</span>
<a href="#l1.2768"></a><span id="l1.2768">         nsCString junkScoreStr;</span>
<a href="#l1.2769"></a><span id="l1.2769" class="difflineminus">-        rv = msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2770"></a><span id="l1.2770" class="difflineplus">+        rv =</span>
<a href="#l1.2771"></a><span id="l1.2771" class="difflineplus">+            msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.2772"></a><span id="l1.2772">         if (junkScoreStr.IsEmpty() ||</span>
<a href="#l1.2773"></a><span id="l1.2773">             (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_HAM_SCORE))</span>
<a href="#l1.2774"></a><span id="l1.2774">           ApplyCommandToIndices(nsMsgViewCommandType::junk,</span>
<a href="#l1.2775"></a><span id="l1.2775" class="difflineminus">-                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2776"></a><span id="l1.2776" class="difflineplus">+                                (nsMsgViewIndex *)&amp;row, 1);</span>
<a href="#l1.2777"></a><span id="l1.2777">         else</span>
<a href="#l1.2778"></a><span id="l1.2778">           ApplyCommandToIndices(nsMsgViewCommandType::unjunk,</span>
<a href="#l1.2779"></a><span id="l1.2779" class="difflineminus">-                                (nsMsgViewIndex *) &amp;row, 1);</span>
<a href="#l1.2780"></a><span id="l1.2780" class="difflineminus">-</span>
<a href="#l1.2781"></a><span id="l1.2781" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2782"></a><span id="l1.2782" class="difflineplus">+                                (nsMsgViewIndex *)&amp;row, 1);</span>
<a href="#l1.2783"></a><span id="l1.2783" class="difflineplus">+</span>
<a href="#l1.2784"></a><span id="l1.2784" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.2785"></a><span id="l1.2785" class="difflineplus">+                     &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.2786"></a><span id="l1.2786">       }</span>
<a href="#l1.2787"></a><span id="l1.2787">       break;</span>
<a href="#l1.2788"></a><span id="l1.2788">     }</span>
<a href="#l1.2789"></a><span id="l1.2789">     default:</span>
<a href="#l1.2790"></a><span id="l1.2790">       break;</span>
<a href="#l1.2791"></a><span id="l1.2791">   }</span>
<a href="#l1.2792"></a><span id="l1.2792"> </span>
<a href="#l1.2793"></a><span id="l1.2793">   return NS_OK;</span>
<a href="#l1.2794"></a><span id="l1.2794"> }</span>
<a href="#l1.2795"></a><span id="l1.2795"> </span>
<a href="#l1.2796"></a><span id="l1.2796"> NS_IMETHODIMP</span>
<a href="#l1.2797"></a><span id="l1.2797" class="difflineminus">-nsMsgDBView::PerformAction(const char16_t *action)</span>
<a href="#l1.2798"></a><span id="l1.2798" class="difflineminus">-{</span>
<a href="#l1.2799"></a><span id="l1.2799" class="difflineplus">+nsMsgDBView::PerformAction(const char16_t *action) { return NS_OK; }</span>
<a href="#l1.2800"></a><span id="l1.2800" class="difflineplus">+</span>
<a href="#l1.2801"></a><span id="l1.2801" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l1.2802"></a><span id="l1.2802" class="difflineplus">+nsMsgDBView::PerformActionOnRow(const char16_t *action, int32_t row) {</span>
<a href="#l1.2803"></a><span id="l1.2803">   return NS_OK;</span>
<a href="#l1.2804"></a><span id="l1.2804"> }</span>
<a href="#l1.2805"></a><span id="l1.2805"> </span>
<a href="#l1.2806"></a><span id="l1.2806"> NS_IMETHODIMP</span>
<a href="#l1.2807"></a><span id="l1.2807" class="difflineminus">-nsMsgDBView::PerformActionOnRow(const char16_t *action, int32_t row)</span>
<a href="#l1.2808"></a><span id="l1.2808" class="difflineminus">-{</span>
<a href="#l1.2809"></a><span id="l1.2809" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.2810"></a><span id="l1.2810" class="difflineminus">-}</span>
<a href="#l1.2811"></a><span id="l1.2811" class="difflineminus">-</span>
<a href="#l1.2812"></a><span id="l1.2812" class="difflineminus">-NS_IMETHODIMP</span>
<a href="#l1.2813"></a><span id="l1.2813" class="difflineminus">-nsMsgDBView::PerformActionOnCell(const char16_t *action,</span>
<a href="#l1.2814"></a><span id="l1.2814" class="difflineminus">-                                 int32_t row,</span>
<a href="#l1.2815"></a><span id="l1.2815" class="difflineminus">-                                 nsTreeColumn* col)</span>
<a href="#l1.2816"></a><span id="l1.2816" class="difflineminus">-{</span>
<a href="#l1.2817"></a><span id="l1.2817" class="difflineplus">+nsMsgDBView::PerformActionOnCell(const char16_t *action, int32_t row,</span>
<a href="#l1.2818"></a><span id="l1.2818" class="difflineplus">+                                 nsTreeColumn *col) {</span>
<a href="#l1.2819"></a><span id="l1.2819">   return NS_OK;</span>
<a href="#l1.2820"></a><span id="l1.2820"> }</span>
<a href="#l1.2821"></a><span id="l1.2821"> </span>
<a href="#l1.2822"></a><span id="l1.2822"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.2823"></a><span id="l1.2823"> // end nsITreeView Implementation Methods</span>
<a href="#l1.2824"></a><span id="l1.2824"> ///////////////////////////////////////////////////////////////////////////</span>
<a href="#l1.2825"></a><span id="l1.2825"> </span>
<a href="#l1.2826"></a><span id="l1.2826"> NS_IMETHODIMP</span>
<a href="#l1.2827"></a><span id="l1.2827" class="difflineminus">-nsMsgDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l1.2828"></a><span id="l1.2828" class="difflineminus">-                  nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.2829"></a><span id="l1.2829" class="difflineplus">+nsMsgDBView::Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.2830"></a><span id="l1.2830">                   nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.2831"></a><span id="l1.2831" class="difflineminus">-                  nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l1.2832"></a><span id="l1.2832" class="difflineminus">-                  int32_t *pCount)</span>
<a href="#l1.2833"></a><span id="l1.2833" class="difflineminus">-{</span>
<a href="#l1.2834"></a><span id="l1.2834" class="difflineplus">+                  nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) {</span>
<a href="#l1.2835"></a><span id="l1.2835">   m_viewFlags = viewFlags;</span>
<a href="#l1.2836"></a><span id="l1.2836">   m_sortOrder = sortOrder;</span>
<a href="#l1.2837"></a><span id="l1.2837">   m_sortType = sortType;</span>
<a href="#l1.2838"></a><span id="l1.2838"> </span>
<a href="#l1.2839"></a><span id="l1.2839">   nsresult rv;</span>
<a href="#l1.2840"></a><span id="l1.2840">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l1.2841"></a><span id="l1.2841" class="difflineminus">-    do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.2842"></a><span id="l1.2842" class="difflineplus">+      do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l1.2843"></a><span id="l1.2843"> </span>
<a href="#l1.2844"></a><span id="l1.2844">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2845"></a><span id="l1.2845">   bool userNeedsToAuthenticate = false;</span>
<a href="#l1.2846"></a><span id="l1.2846">   // If we're PasswordProtectLocalCache, then we need to find out if the</span>
<a href="#l1.2847"></a><span id="l1.2847">   // server is authenticated.</span>
<a href="#l1.2848"></a><span id="l1.2848" class="difflineminus">-  (void) accountManager-&gt;GetUserNeedsToAuthenticate(&amp;userNeedsToAuthenticate);</span>
<a href="#l1.2849"></a><span id="l1.2849" class="difflineminus">-  if (userNeedsToAuthenticate)</span>
<a href="#l1.2850"></a><span id="l1.2850" class="difflineminus">-    return NS_MSG_USER_NOT_AUTHENTICATED;</span>
<a href="#l1.2851"></a><span id="l1.2851" class="difflineminus">-</span>
<a href="#l1.2852"></a><span id="l1.2852" class="difflineminus">-  if (folder)</span>
<a href="#l1.2853"></a><span id="l1.2853" class="difflineminus">-  {</span>
<a href="#l1.2854"></a><span id="l1.2854" class="difflineplus">+  (void)accountManager-&gt;GetUserNeedsToAuthenticate(&amp;userNeedsToAuthenticate);</span>
<a href="#l1.2855"></a><span id="l1.2855" class="difflineplus">+  if (userNeedsToAuthenticate) return NS_MSG_USER_NOT_AUTHENTICATED;</span>
<a href="#l1.2856"></a><span id="l1.2856" class="difflineplus">+</span>
<a href="#l1.2857"></a><span id="l1.2857" class="difflineplus">+  if (folder) {</span>
<a href="#l1.2858"></a><span id="l1.2858">     // Search view will have a null folder.</span>
<a href="#l1.2859"></a><span id="l1.2859" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2860"></a><span id="l1.2860" class="difflineminus">-    rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(m_db));</span>
<a href="#l1.2861"></a><span id="l1.2861" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.2862"></a><span id="l1.2862" class="difflineplus">+    rv = folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.2863"></a><span id="l1.2863" class="difflineplus">+                                      getter_AddRefs(m_db));</span>
<a href="#l1.2864"></a><span id="l1.2864">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2865"></a><span id="l1.2865" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2866"></a><span id="l1.2866" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l1.2867"></a><span id="l1.2867" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2868"></a><span id="l1.2868">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2869"></a><span id="l1.2869">     msgDBService-&gt;RegisterPendingListener(folder, this);</span>
<a href="#l1.2870"></a><span id="l1.2870">     m_folder = folder;</span>
<a href="#l1.2871"></a><span id="l1.2871"> </span>
<a href="#l1.2872"></a><span id="l1.2872" class="difflineminus">-    if (!m_viewFolder)</span>
<a href="#l1.2873"></a><span id="l1.2873" class="difflineminus">-    {</span>
<a href="#l1.2874"></a><span id="l1.2874" class="difflineplus">+    if (!m_viewFolder) {</span>
<a href="#l1.2875"></a><span id="l1.2875">       // There is never a viewFolder already set except for the single folder</span>
<a href="#l1.2876"></a><span id="l1.2876">       // saved search case, where the backing folder m_folder is different from</span>
<a href="#l1.2877"></a><span id="l1.2877">       // the m_viewFolder with its own dbFolderInfo state.</span>
<a href="#l1.2878"></a><span id="l1.2878">       m_viewFolder = folder;</span>
<a href="#l1.2879"></a><span id="l1.2879">     }</span>
<a href="#l1.2880"></a><span id="l1.2880"> </span>
<a href="#l1.2881"></a><span id="l1.2881">     SetMRUTimeForFolder(m_viewFolder);</span>
<a href="#l1.2882"></a><span id="l1.2882"> </span>
<a href="#l1.2883"></a><span id="l1.2883">     RestoreSortInfo();</span>
<a href="#l1.2884"></a><span id="l1.2884"> </span>
<a href="#l1.2885"></a><span id="l1.2885">     // Determine if we are in a news folder or not. If yes, we'll show lines</span>
<a href="#l1.2886"></a><span id="l1.2886">     // instead of size, and special icons in the thread pane.</span>
<a href="#l1.2887"></a><span id="l1.2887" class="difflineminus">-    nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.2888"></a><span id="l1.2888" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.2889"></a><span id="l1.2889">     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.2890"></a><span id="l1.2890" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2891"></a><span id="l1.2891" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2892"></a><span id="l1.2892">     nsCString type;</span>
<a href="#l1.2893"></a><span id="l1.2893">     rv = server-&gt;GetType(type);</span>
<a href="#l1.2894"></a><span id="l1.2894" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.2895"></a><span id="l1.2895" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.2896"></a><span id="l1.2896"> </span>
<a href="#l1.2897"></a><span id="l1.2897">     // I'm not sure this is correct, because XF virtual folders with mixed news</span>
<a href="#l1.2898"></a><span id="l1.2898">     // and mail can have this set.</span>
<a href="#l1.2899"></a><span id="l1.2899">     mIsNews = MsgLowerCaseEqualsLiteral(type, &quot;nntp&quot;);</span>
<a href="#l1.2900"></a><span id="l1.2900"> </span>
<a href="#l1.2901"></a><span id="l1.2901">     // Default to a virtual folder if folder not set, since synthetic search</span>
<a href="#l1.2902"></a><span id="l1.2902">     // views may not have a folder.</span>
<a href="#l1.2903"></a><span id="l1.2903">     uint32_t folderFlags = nsMsgFolderFlags::Virtual;</span>
<a href="#l1.2904"></a><span id="l1.2904" class="difflineminus">-    if (folder)</span>
<a href="#l1.2905"></a><span id="l1.2905" class="difflineminus">-      folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l1.2906"></a><span id="l1.2906" class="difflineplus">+    if (folder) folder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l1.2907"></a><span id="l1.2907"> </span>
<a href="#l1.2908"></a><span id="l1.2908">     mIsXFVirtual = folderFlags &amp; nsMsgFolderFlags::Virtual;</span>
<a href="#l1.2909"></a><span id="l1.2909" class="difflineminus">-    if (!mIsXFVirtual &amp;&amp; MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;))</span>
<a href="#l1.2910"></a><span id="l1.2910" class="difflineminus">-      mIsRss = true;</span>
<a href="#l1.2911"></a><span id="l1.2911" class="difflineplus">+    if (!mIsXFVirtual &amp;&amp; MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;)) mIsRss = true;</span>
<a href="#l1.2912"></a><span id="l1.2912"> </span>
<a href="#l1.2913"></a><span id="l1.2913">     // Special case nntp --&gt; news since we'll break themes if we try to be</span>
<a href="#l1.2914"></a><span id="l1.2914">     // consistent.</span>
<a href="#l1.2915"></a><span id="l1.2915">     if (mIsNews)</span>
<a href="#l1.2916"></a><span id="l1.2916">       mMessageType.AssignLiteral(&quot;news&quot;);</span>
<a href="#l1.2917"></a><span id="l1.2917">     else</span>
<a href="#l1.2918"></a><span id="l1.2918">       CopyUTF8toUTF16(type, mMessageType);</span>
<a href="#l1.2919"></a><span id="l1.2919"> </span>
<a href="#l1.2920"></a><span id="l1.2920">     GetImapDeleteModel(nullptr);</span>
<a href="#l1.2921"></a><span id="l1.2921"> </span>
<a href="#l1.2922"></a><span id="l1.2922">     nsCOMPtr&lt;nsIPrefBranch&gt; prefs(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l1.2923"></a><span id="l1.2923" class="difflineminus">-    if (prefs)</span>
<a href="#l1.2924"></a><span id="l1.2924" class="difflineminus">-    {</span>
<a href="#l1.2925"></a><span id="l1.2925" class="difflineplus">+    if (prefs) {</span>
<a href="#l1.2926"></a><span id="l1.2926">       prefs-&gt;GetBoolPref(&quot;mailnews.sort_threads_by_root&quot;, &amp;mSortThreadsByRoot);</span>
<a href="#l1.2927"></a><span id="l1.2927">       if (mIsNews)</span>
<a href="#l1.2928"></a><span id="l1.2928">         prefs-&gt;GetBoolPref(&quot;news.show_size_in_lines&quot;, &amp;mShowSizeInLines);</span>
<a href="#l1.2929"></a><span id="l1.2929">     }</span>
<a href="#l1.2930"></a><span id="l1.2930">   }</span>
<a href="#l1.2931"></a><span id="l1.2931"> </span>
<a href="#l1.2932"></a><span id="l1.2932">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l1.2933"></a><span id="l1.2933">   rv = accountManager-&gt;GetAllIdentities(getter_AddRefs(identities));</span>
<a href="#l1.2934"></a><span id="l1.2934" class="difflineminus">-  if (!identities)</span>
<a href="#l1.2935"></a><span id="l1.2935" class="difflineminus">-    return rv;</span>
<a href="#l1.2936"></a><span id="l1.2936" class="difflineplus">+  if (!identities) return rv;</span>
<a href="#l1.2937"></a><span id="l1.2937"> </span>
<a href="#l1.2938"></a><span id="l1.2938">   uint32_t count;</span>
<a href="#l1.2939"></a><span id="l1.2939">   identities-&gt;GetLength(&amp;count);</span>
<a href="#l1.2940"></a><span id="l1.2940" class="difflineminus">-  for (uint32_t i = 0; i &lt; count; i++)</span>
<a href="#l1.2941"></a><span id="l1.2941" class="difflineminus">-  {</span>
<a href="#l1.2942"></a><span id="l1.2942" class="difflineplus">+  for (uint32_t i = 0; i &lt; count; i++) {</span>
<a href="#l1.2943"></a><span id="l1.2943">     nsCOMPtr&lt;nsIMsgIdentity&gt; identity(do_QueryElementAt(identities, i));</span>
<a href="#l1.2944"></a><span id="l1.2944" class="difflineminus">-    if (!identity)</span>
<a href="#l1.2945"></a><span id="l1.2945" class="difflineminus">-      continue;</span>
<a href="#l1.2946"></a><span id="l1.2946" class="difflineplus">+    if (!identity) continue;</span>
<a href="#l1.2947"></a><span id="l1.2947"> </span>
<a href="#l1.2948"></a><span id="l1.2948">     nsCString email;</span>
<a href="#l1.2949"></a><span id="l1.2949">     identity-&gt;GetEmail(email);</span>
<a href="#l1.2950"></a><span id="l1.2950">     if (!email.IsEmpty()) {</span>
<a href="#l1.2951"></a><span id="l1.2951">       ToLowerCaseDropPlusAddessing(email);</span>
<a href="#l1.2952"></a><span id="l1.2952">       mEmails.PutEntry(email);</span>
<a href="#l1.2953"></a><span id="l1.2953">     }</span>
<a href="#l1.2954"></a><span id="l1.2954"> </span>
<a href="#l1.2955"></a><span id="l1.2955" class="difflineat">@@ -2585,320 +2231,282 @@ nsMsgDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l1.2956"></a><span id="l1.2956">       mEmails.PutEntry(email);</span>
<a href="#l1.2957"></a><span id="l1.2957">     }</span>
<a href="#l1.2958"></a><span id="l1.2958">   }</span>
<a href="#l1.2959"></a><span id="l1.2959"> </span>
<a href="#l1.2960"></a><span id="l1.2960">   return NS_OK;</span>
<a href="#l1.2961"></a><span id="l1.2961"> }</span>
<a href="#l1.2962"></a><span id="l1.2962"> </span>
<a href="#l1.2963"></a><span id="l1.2963"> NS_IMETHODIMP</span>
<a href="#l1.2964"></a><span id="l1.2964" class="difflineminus">-nsMsgDBView::Close()</span>
<a href="#l1.2965"></a><span id="l1.2965" class="difflineminus">-{</span>
<a href="#l1.2966"></a><span id="l1.2966" class="difflineplus">+nsMsgDBView::Close() {</span>
<a href="#l1.2967"></a><span id="l1.2967">   int32_t oldSize = GetSize();</span>
<a href="#l1.2968"></a><span id="l1.2968">   // This is important, because the tree will ask us for our row count, which</span>
<a href="#l1.2969"></a><span id="l1.2969">   // gets determined from the number of keys.</span>
<a href="#l1.2970"></a><span id="l1.2970">   m_keys.Clear();</span>
<a href="#l1.2971"></a><span id="l1.2971">   // Be consistent.</span>
<a href="#l1.2972"></a><span id="l1.2972">   m_flags.Clear();</span>
<a href="#l1.2973"></a><span id="l1.2973">   m_levels.Clear();</span>
<a href="#l1.2974"></a><span id="l1.2974"> </span>
<a href="#l1.2975"></a><span id="l1.2975">   // Clear these out since they no longer apply if we're switching a folder</span>
<a href="#l1.2976"></a><span id="l1.2976" class="difflineminus">-  if (mJunkHdrs)</span>
<a href="#l1.2977"></a><span id="l1.2977" class="difflineminus">-    mJunkHdrs-&gt;Clear();</span>
<a href="#l1.2978"></a><span id="l1.2978" class="difflineplus">+  if (mJunkHdrs) mJunkHdrs-&gt;Clear();</span>
<a href="#l1.2979"></a><span id="l1.2979"> </span>
<a href="#l1.2980"></a><span id="l1.2980">   // This needs to happen after we remove all the keys, since RowCountChanged()</span>
<a href="#l1.2981"></a><span id="l1.2981">   // will call our GetRowCount().</span>
<a href="#l1.2982"></a><span id="l1.2982" class="difflineminus">-  if (mTree)</span>
<a href="#l1.2983"></a><span id="l1.2983" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l1.2984"></a><span id="l1.2984" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l1.2985"></a><span id="l1.2985"> </span>
<a href="#l1.2986"></a><span id="l1.2986">   ClearHdrCache();</span>
<a href="#l1.2987"></a><span id="l1.2987" class="difflineminus">-  if (m_db)</span>
<a href="#l1.2988"></a><span id="l1.2988" class="difflineminus">-  {</span>
<a href="#l1.2989"></a><span id="l1.2989" class="difflineplus">+  if (m_db) {</span>
<a href="#l1.2990"></a><span id="l1.2990">     m_db-&gt;RemoveListener(this);</span>
<a href="#l1.2991"></a><span id="l1.2991">     m_db = nullptr;</span>
<a href="#l1.2992"></a><span id="l1.2992">   }</span>
<a href="#l1.2993"></a><span id="l1.2993" class="difflineminus">-  if (m_folder)</span>
<a href="#l1.2994"></a><span id="l1.2994" class="difflineminus">-  {</span>
<a href="#l1.2995"></a><span id="l1.2995" class="difflineplus">+  if (m_folder) {</span>
<a href="#l1.2996"></a><span id="l1.2996">     nsresult rv;</span>
<a href="#l1.2997"></a><span id="l1.2997" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.2998"></a><span id="l1.2998" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l1.2999"></a><span id="l1.2999" class="difflineplus">+        do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3000"></a><span id="l1.3000">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3001"></a><span id="l1.3001">     msgDBService-&gt;UnregisterPendingListener(this);</span>
<a href="#l1.3002"></a><span id="l1.3002">   }</span>
<a href="#l1.3003"></a><span id="l1.3003"> </span>
<a href="#l1.3004"></a><span id="l1.3004">   return NS_OK;</span>
<a href="#l1.3005"></a><span id="l1.3005"> }</span>
<a href="#l1.3006"></a><span id="l1.3006"> </span>
<a href="#l1.3007"></a><span id="l1.3007"> NS_IMETHODIMP</span>
<a href="#l1.3008"></a><span id="l1.3008"> nsMsgDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l1.3009"></a><span id="l1.3009">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l1.3010"></a><span id="l1.3010">                           nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l1.3011"></a><span id="l1.3011" class="difflineminus">-                          nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l1.3012"></a><span id="l1.3012" class="difflineminus">-                          int32_t *aCount)</span>
<a href="#l1.3013"></a><span id="l1.3013" class="difflineminus">-{</span>
<a href="#l1.3014"></a><span id="l1.3014" class="difflineplus">+                          nsMsgViewFlagsTypeValue aViewFlags, int32_t *aCount) {</span>
<a href="#l1.3015"></a><span id="l1.3015">   NS_ASSERTION(false, &quot;not implemented&quot;);</span>
<a href="#l1.3016"></a><span id="l1.3016">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.3017"></a><span id="l1.3017"> }</span>
<a href="#l1.3018"></a><span id="l1.3018"> </span>
<a href="#l1.3019"></a><span id="l1.3019"> NS_IMETHODIMP</span>
<a href="#l1.3020"></a><span id="l1.3020" class="difflineminus">-nsMsgDBView::Init(nsIMessenger * aMessengerInstance,</span>
<a href="#l1.3021"></a><span id="l1.3021" class="difflineminus">-                  nsIMsgWindow * aMsgWindow,</span>
<a href="#l1.3022"></a><span id="l1.3022" class="difflineminus">-                  nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.3023"></a><span id="l1.3023" class="difflineminus">-{</span>
<a href="#l1.3024"></a><span id="l1.3024" class="difflineplus">+nsMsgDBView::Init(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.3025"></a><span id="l1.3025" class="difflineplus">+                  nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l1.3026"></a><span id="l1.3026">   mMessengerWeak = do_GetWeakReference(aMessengerInstance);</span>
<a href="#l1.3027"></a><span id="l1.3027">   mMsgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l1.3028"></a><span id="l1.3028">   mCommandUpdater = aCmdUpdater;</span>
<a href="#l1.3029"></a><span id="l1.3029">   return NS_OK;</span>
<a href="#l1.3030"></a><span id="l1.3030"> }</span>
<a href="#l1.3031"></a><span id="l1.3031"> </span>
<a href="#l1.3032"></a><span id="l1.3032"> NS_IMETHODIMP</span>
<a href="#l1.3033"></a><span id="l1.3033" class="difflineminus">-nsMsgDBView::SetSuppressCommandUpdating(bool aSuppressCommandUpdating)</span>
<a href="#l1.3034"></a><span id="l1.3034" class="difflineminus">-{</span>
<a href="#l1.3035"></a><span id="l1.3035" class="difflineplus">+nsMsgDBView::SetSuppressCommandUpdating(bool aSuppressCommandUpdating) {</span>
<a href="#l1.3036"></a><span id="l1.3036">   mSuppressCommandUpdating = aSuppressCommandUpdating;</span>
<a href="#l1.3037"></a><span id="l1.3037">   return NS_OK;</span>
<a href="#l1.3038"></a><span id="l1.3038"> }</span>
<a href="#l1.3039"></a><span id="l1.3039"> </span>
<a href="#l1.3040"></a><span id="l1.3040"> NS_IMETHODIMP</span>
<a href="#l1.3041"></a><span id="l1.3041" class="difflineminus">-nsMsgDBView::GetSuppressCommandUpdating(bool * aSuppressCommandUpdating)</span>
<a href="#l1.3042"></a><span id="l1.3042" class="difflineminus">-{</span>
<a href="#l1.3043"></a><span id="l1.3043" class="difflineplus">+nsMsgDBView::GetSuppressCommandUpdating(bool *aSuppressCommandUpdating) {</span>
<a href="#l1.3044"></a><span id="l1.3044">   *aSuppressCommandUpdating = mSuppressCommandUpdating;</span>
<a href="#l1.3045"></a><span id="l1.3045">   return NS_OK;</span>
<a href="#l1.3046"></a><span id="l1.3046"> }</span>
<a href="#l1.3047"></a><span id="l1.3047"> </span>
<a href="#l1.3048"></a><span id="l1.3048"> NS_IMETHODIMP</span>
<a href="#l1.3049"></a><span id="l1.3049" class="difflineminus">-nsMsgDBView::SetSuppressMsgDisplay(bool aSuppressDisplay)</span>
<a href="#l1.3050"></a><span id="l1.3050" class="difflineminus">-{</span>
<a href="#l1.3051"></a><span id="l1.3051" class="difflineplus">+nsMsgDBView::SetSuppressMsgDisplay(bool aSuppressDisplay) {</span>
<a href="#l1.3052"></a><span id="l1.3052">   uint32_t numSelected = 0;</span>
<a href="#l1.3053"></a><span id="l1.3053">   GetNumSelected(&amp;numSelected);</span>
<a href="#l1.3054"></a><span id="l1.3054"> </span>
<a href="#l1.3055"></a><span id="l1.3055">   bool forceDisplay = false;</span>
<a href="#l1.3056"></a><span id="l1.3056">   if (mSuppressMsgDisplay &amp;&amp; !aSuppressDisplay &amp;&amp; numSelected == 1)</span>
<a href="#l1.3057"></a><span id="l1.3057">     forceDisplay = true;</span>
<a href="#l1.3058"></a><span id="l1.3058"> </span>
<a href="#l1.3059"></a><span id="l1.3059">   mSuppressMsgDisplay = aSuppressDisplay;</span>
<a href="#l1.3060"></a><span id="l1.3060" class="difflineminus">-  if (forceDisplay)</span>
<a href="#l1.3061"></a><span id="l1.3061" class="difflineminus">-  {</span>
<a href="#l1.3062"></a><span id="l1.3062" class="difflineplus">+  if (forceDisplay) {</span>
<a href="#l1.3063"></a><span id="l1.3063">     // Get the view indexfor the currently selected message.</span>
<a href="#l1.3064"></a><span id="l1.3064">     nsMsgViewIndex viewIndex;</span>
<a href="#l1.3065"></a><span id="l1.3065">     nsresult rv = GetViewIndexForFirstSelectedMsg(&amp;viewIndex);</span>
<a href="#l1.3066"></a><span id="l1.3066" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l1.3067"></a><span id="l1.3067" class="difflineminus">-      LoadMessageByViewIndex(viewIndex);</span>
<a href="#l1.3068"></a><span id="l1.3068" class="difflineplus">+    if (NS_SUCCEEDED(rv)) LoadMessageByViewIndex(viewIndex);</span>
<a href="#l1.3069"></a><span id="l1.3069">   }</span>
<a href="#l1.3070"></a><span id="l1.3070"> </span>
<a href="#l1.3071"></a><span id="l1.3071">   return NS_OK;</span>
<a href="#l1.3072"></a><span id="l1.3072"> }</span>
<a href="#l1.3073"></a><span id="l1.3073"> </span>
<a href="#l1.3074"></a><span id="l1.3074"> NS_IMETHODIMP</span>
<a href="#l1.3075"></a><span id="l1.3075" class="difflineminus">-nsMsgDBView::GetSuppressMsgDisplay(bool * aSuppressDisplay)</span>
<a href="#l1.3076"></a><span id="l1.3076" class="difflineminus">-{</span>
<a href="#l1.3077"></a><span id="l1.3077" class="difflineplus">+nsMsgDBView::GetSuppressMsgDisplay(bool *aSuppressDisplay) {</span>
<a href="#l1.3078"></a><span id="l1.3078">   *aSuppressDisplay = mSuppressMsgDisplay;</span>
<a href="#l1.3079"></a><span id="l1.3079">   return NS_OK;</span>
<a href="#l1.3080"></a><span id="l1.3080"> }</span>
<a href="#l1.3081"></a><span id="l1.3081"> </span>
<a href="#l1.3082"></a><span id="l1.3082"> NS_IMETHODIMP</span>
<a href="#l1.3083"></a><span id="l1.3083" class="difflineminus">-nsMsgDBView::GetUsingLines(bool * aUsingLines)</span>
<a href="#l1.3084"></a><span id="l1.3084" class="difflineminus">-{</span>
<a href="#l1.3085"></a><span id="l1.3085" class="difflineplus">+nsMsgDBView::GetUsingLines(bool *aUsingLines) {</span>
<a href="#l1.3086"></a><span id="l1.3086">   *aUsingLines = mShowSizeInLines;</span>
<a href="#l1.3087"></a><span id="l1.3087">   return NS_OK;</span>
<a href="#l1.3088"></a><span id="l1.3088"> }</span>
<a href="#l1.3089"></a><span id="l1.3089"> </span>
<a href="#l1.3090"></a><span id="l1.3090" class="difflineminus">-int</span>
<a href="#l1.3091"></a><span id="l1.3091" class="difflineminus">-CompareViewIndices (const void *v1,</span>
<a href="#l1.3092"></a><span id="l1.3092" class="difflineminus">-                    const void *v2,</span>
<a href="#l1.3093"></a><span id="l1.3093" class="difflineminus">-                    void *)</span>
<a href="#l1.3094"></a><span id="l1.3094" class="difflineminus">-{</span>
<a href="#l1.3095"></a><span id="l1.3095" class="difflineminus">-  nsMsgViewIndex i1 = *(nsMsgViewIndex*) v1;</span>
<a href="#l1.3096"></a><span id="l1.3096" class="difflineminus">-  nsMsgViewIndex i2 = *(nsMsgViewIndex*) v2;</span>
<a href="#l1.3097"></a><span id="l1.3097" class="difflineplus">+int CompareViewIndices(const void *v1, const void *v2, void *) {</span>
<a href="#l1.3098"></a><span id="l1.3098" class="difflineplus">+  nsMsgViewIndex i1 = *(nsMsgViewIndex *)v1;</span>
<a href="#l1.3099"></a><span id="l1.3099" class="difflineplus">+  nsMsgViewIndex i2 = *(nsMsgViewIndex *)v2;</span>
<a href="#l1.3100"></a><span id="l1.3100">   return i1 - i2;</span>
<a href="#l1.3101"></a><span id="l1.3101"> }</span>
<a href="#l1.3102"></a><span id="l1.3102"> </span>
<a href="#l1.3103"></a><span id="l1.3103"> NS_IMETHODIMP</span>
<a href="#l1.3104"></a><span id="l1.3104"> nsMsgDBView::GetIndicesForSelection(uint32_t *length,</span>
<a href="#l1.3105"></a><span id="l1.3105" class="difflineminus">-                                    nsMsgViewIndex **indices)</span>
<a href="#l1.3106"></a><span id="l1.3106" class="difflineminus">-{</span>
<a href="#l1.3107"></a><span id="l1.3107" class="difflineplus">+                                    nsMsgViewIndex **indices) {</span>
<a href="#l1.3108"></a><span id="l1.3108">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l1.3109"></a><span id="l1.3109">   *length = 0;</span>
<a href="#l1.3110"></a><span id="l1.3110">   NS_ENSURE_ARG_POINTER(indices);</span>
<a href="#l1.3111"></a><span id="l1.3111">   *indices = nullptr;</span>
<a href="#l1.3112"></a><span id="l1.3112"> </span>
<a href="#l1.3113"></a><span id="l1.3113">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3114"></a><span id="l1.3114">   GetSelectedIndices(selection);</span>
<a href="#l1.3115"></a><span id="l1.3115">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3116"></a><span id="l1.3116" class="difflineminus">-  if (!numIndices)</span>
<a href="#l1.3117"></a><span id="l1.3117" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.3118"></a><span id="l1.3118" class="difflineplus">+  if (!numIndices) return NS_OK;</span>
<a href="#l1.3119"></a><span id="l1.3119"> </span>
<a href="#l1.3120"></a><span id="l1.3120">   *length = numIndices;</span>
<a href="#l1.3121"></a><span id="l1.3121">   uint32_t datalen = numIndices * sizeof(nsMsgViewIndex);</span>
<a href="#l1.3122"></a><span id="l1.3122">   *indices = (nsMsgViewIndex *)moz_xmalloc(datalen);</span>
<a href="#l1.3123"></a><span id="l1.3123" class="difflineminus">-  if (!*indices)</span>
<a href="#l1.3124"></a><span id="l1.3124" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3125"></a><span id="l1.3125" class="difflineplus">+  if (!*indices) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3126"></a><span id="l1.3126"> </span>
<a href="#l1.3127"></a><span id="l1.3127">   memcpy(*indices, selection.Elements(), datalen);</span>
<a href="#l1.3128"></a><span id="l1.3128">   return NS_OK;</span>
<a href="#l1.3129"></a><span id="l1.3129"> }</span>
<a href="#l1.3130"></a><span id="l1.3130"> </span>
<a href="#l1.3131"></a><span id="l1.3131"> NS_IMETHODIMP</span>
<a href="#l1.3132"></a><span id="l1.3132" class="difflineminus">-nsMsgDBView::GetSelectedMsgHdrs(uint32_t *aLength,</span>
<a href="#l1.3133"></a><span id="l1.3133" class="difflineminus">-                                nsIMsgDBHdr ***aResult)</span>
<a href="#l1.3134"></a><span id="l1.3134" class="difflineminus">-{</span>
<a href="#l1.3135"></a><span id="l1.3135" class="difflineplus">+nsMsgDBView::GetSelectedMsgHdrs(uint32_t *aLength, nsIMsgDBHdr ***aResult) {</span>
<a href="#l1.3136"></a><span id="l1.3136">   nsresult rv;</span>
<a href="#l1.3137"></a><span id="l1.3137"> </span>
<a href="#l1.3138"></a><span id="l1.3138">   NS_ENSURE_ARG_POINTER(aLength);</span>
<a href="#l1.3139"></a><span id="l1.3139">   *aLength = 0;</span>
<a href="#l1.3140"></a><span id="l1.3140"> </span>
<a href="#l1.3141"></a><span id="l1.3141">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.3142"></a><span id="l1.3142">   *aResult = nullptr;</span>
<a href="#l1.3143"></a><span id="l1.3143"> </span>
<a href="#l1.3144"></a><span id="l1.3144">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3145"></a><span id="l1.3145">   GetSelectedIndices(selection);</span>
<a href="#l1.3146"></a><span id="l1.3146">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3147"></a><span id="l1.3147" class="difflineminus">-  if (!numIndices)</span>
<a href="#l1.3148"></a><span id="l1.3148" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.3149"></a><span id="l1.3149" class="difflineminus">-</span>
<a href="#l1.3150"></a><span id="l1.3150" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3151"></a><span id="l1.3151" class="difflineplus">+  if (!numIndices) return NS_OK;</span>
<a href="#l1.3152"></a><span id="l1.3152" class="difflineplus">+</span>
<a href="#l1.3153"></a><span id="l1.3153" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l1.3154"></a><span id="l1.3154" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3155"></a><span id="l1.3155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3156"></a><span id="l1.3156">   rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l1.3157"></a><span id="l1.3157">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3158"></a><span id="l1.3158">   uint32_t numMsgsSelected;</span>
<a href="#l1.3159"></a><span id="l1.3159">   messages-&gt;GetLength(&amp;numMsgsSelected);</span>
<a href="#l1.3160"></a><span id="l1.3160"> </span>
<a href="#l1.3161"></a><span id="l1.3161" class="difflineminus">-  nsIMsgDBHdr **headers =</span>
<a href="#l1.3162"></a><span id="l1.3162" class="difflineminus">-    static_cast&lt;nsIMsgDBHdr**&gt;(moz_xmalloc(sizeof(nsIMsgDBHdr*) * numMsgsSelected));</span>
<a href="#l1.3163"></a><span id="l1.3163" class="difflineminus">-</span>
<a href="#l1.3164"></a><span id="l1.3164" class="difflineminus">-  for (uint32_t i = 0; i &lt; numMsgsSelected; i++)</span>
<a href="#l1.3165"></a><span id="l1.3165" class="difflineminus">-  {</span>
<a href="#l1.3166"></a><span id="l1.3166" class="difflineplus">+  nsIMsgDBHdr **headers = static_cast&lt;nsIMsgDBHdr **&gt;(</span>
<a href="#l1.3167"></a><span id="l1.3167" class="difflineplus">+      moz_xmalloc(sizeof(nsIMsgDBHdr *) * numMsgsSelected));</span>
<a href="#l1.3168"></a><span id="l1.3168" class="difflineplus">+</span>
<a href="#l1.3169"></a><span id="l1.3169" class="difflineplus">+  for (uint32_t i = 0; i &lt; numMsgsSelected; i++) {</span>
<a href="#l1.3170"></a><span id="l1.3170">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.3171"></a><span id="l1.3171">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3172"></a><span id="l1.3172">     // Already AddRefed.</span>
<a href="#l1.3173"></a><span id="l1.3173">     msgHdr.forget(&amp;headers[i]);</span>
<a href="#l1.3174"></a><span id="l1.3174">   }</span>
<a href="#l1.3175"></a><span id="l1.3175"> </span>
<a href="#l1.3176"></a><span id="l1.3176">   *aLength = numMsgsSelected;</span>
<a href="#l1.3177"></a><span id="l1.3177">   *aResult = headers;</span>
<a href="#l1.3178"></a><span id="l1.3178">   return NS_OK;</span>
<a href="#l1.3179"></a><span id="l1.3179"> }</span>
<a href="#l1.3180"></a><span id="l1.3180"> </span>
<a href="#l1.3181"></a><span id="l1.3181"> NS_IMETHODIMP</span>
<a href="#l1.3182"></a><span id="l1.3182" class="difflineminus">-nsMsgDBView::GetURIsForSelection(uint32_t *length,</span>
<a href="#l1.3183"></a><span id="l1.3183" class="difflineminus">-                                 char ***uris)</span>
<a href="#l1.3184"></a><span id="l1.3184" class="difflineminus">-{</span>
<a href="#l1.3185"></a><span id="l1.3185" class="difflineplus">+nsMsgDBView::GetURIsForSelection(uint32_t *length, char ***uris) {</span>
<a href="#l1.3186"></a><span id="l1.3186">   nsresult rv = NS_OK;</span>
<a href="#l1.3187"></a><span id="l1.3187"> </span>
<a href="#l1.3188"></a><span id="l1.3188">   NS_ENSURE_ARG_POINTER(length);</span>
<a href="#l1.3189"></a><span id="l1.3189">   *length = 0;</span>
<a href="#l1.3190"></a><span id="l1.3190"> </span>
<a href="#l1.3191"></a><span id="l1.3191">   NS_ENSURE_ARG_POINTER(uris);</span>
<a href="#l1.3192"></a><span id="l1.3192">   *uris = nullptr;</span>
<a href="#l1.3193"></a><span id="l1.3193"> </span>
<a href="#l1.3194"></a><span id="l1.3194">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3195"></a><span id="l1.3195">   GetSelectedIndices(selection);</span>
<a href="#l1.3196"></a><span id="l1.3196">   uint32_t numIndices = selection.Length();</span>
<a href="#l1.3197"></a><span id="l1.3197" class="difflineminus">-  if (!numIndices)</span>
<a href="#l1.3198"></a><span id="l1.3198" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.3199"></a><span id="l1.3199" class="difflineminus">-</span>
<a href="#l1.3200"></a><span id="l1.3200" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3201"></a><span id="l1.3201" class="difflineplus">+  if (!numIndices) return NS_OK;</span>
<a href="#l1.3202"></a><span id="l1.3202" class="difflineplus">+</span>
<a href="#l1.3203"></a><span id="l1.3203" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l1.3204"></a><span id="l1.3204" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3205"></a><span id="l1.3205">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3206"></a><span id="l1.3206">   rv = GetHeadersFromSelection(selection.Elements(), numIndices, messages);</span>
<a href="#l1.3207"></a><span id="l1.3207">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3208"></a><span id="l1.3208">   messages-&gt;GetLength(length);</span>
<a href="#l1.3209"></a><span id="l1.3209">   uint32_t numMsgsSelected = *length;</span>
<a href="#l1.3210"></a><span id="l1.3210"> </span>
<a href="#l1.3211"></a><span id="l1.3211">   char **outArray, **next;</span>
<a href="#l1.3212"></a><span id="l1.3212">   next = outArray = (char **)moz_xmalloc(numMsgsSelected * sizeof(char *));</span>
<a href="#l1.3213"></a><span id="l1.3213" class="difflineminus">-  if (!outArray)</span>
<a href="#l1.3214"></a><span id="l1.3214" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3215"></a><span id="l1.3215" class="difflineminus">-</span>
<a href="#l1.3216"></a><span id="l1.3216" class="difflineminus">-  for (uint32_t i = 0; i &lt; numMsgsSelected; i++)</span>
<a href="#l1.3217"></a><span id="l1.3217" class="difflineminus">-  {</span>
<a href="#l1.3218"></a><span id="l1.3218" class="difflineplus">+  if (!outArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3219"></a><span id="l1.3219" class="difflineplus">+</span>
<a href="#l1.3220"></a><span id="l1.3220" class="difflineplus">+  for (uint32_t i = 0; i &lt; numMsgsSelected; i++) {</span>
<a href="#l1.3221"></a><span id="l1.3221">     nsCString tmpUri;</span>
<a href="#l1.3222"></a><span id="l1.3222">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l1.3223"></a><span id="l1.3223">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3224"></a><span id="l1.3224">     nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.3225"></a><span id="l1.3225">     nsMsgKey msgKey;</span>
<a href="#l1.3226"></a><span id="l1.3226">     msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.3227"></a><span id="l1.3227">     msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.3228"></a><span id="l1.3228">     rv = GenerateURIForMsgKey(msgKey, folder, tmpUri);</span>
<a href="#l1.3229"></a><span id="l1.3229" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3230"></a><span id="l1.3230" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3231"></a><span id="l1.3231">     *next = ToNewCString(tmpUri);</span>
<a href="#l1.3232"></a><span id="l1.3232" class="difflineminus">-    if (!*next)</span>
<a href="#l1.3233"></a><span id="l1.3233" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3234"></a><span id="l1.3234" class="difflineplus">+    if (!*next) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.3235"></a><span id="l1.3235"> </span>
<a href="#l1.3236"></a><span id="l1.3236">     next++;</span>
<a href="#l1.3237"></a><span id="l1.3237">   }</span>
<a href="#l1.3238"></a><span id="l1.3238"> </span>
<a href="#l1.3239"></a><span id="l1.3239">   *uris = outArray;</span>
<a href="#l1.3240"></a><span id="l1.3240">   return NS_OK;</span>
<a href="#l1.3241"></a><span id="l1.3241"> }</span>
<a href="#l1.3242"></a><span id="l1.3242"> </span>
<a href="#l1.3243"></a><span id="l1.3243"> NS_IMETHODIMP</span>
<a href="#l1.3244"></a><span id="l1.3244" class="difflineminus">-nsMsgDBView::GetURIForViewIndex(nsMsgViewIndex index,</span>
<a href="#l1.3245"></a><span id="l1.3245" class="difflineminus">-                                nsACString &amp;result)</span>
<a href="#l1.3246"></a><span id="l1.3246" class="difflineminus">-{</span>
<a href="#l1.3247"></a><span id="l1.3247" class="difflineplus">+nsMsgDBView::GetURIForViewIndex(nsMsgViewIndex index, nsACString &amp;result) {</span>
<a href="#l1.3248"></a><span id="l1.3248">   nsresult rv;</span>
<a href="#l1.3249"></a><span id="l1.3249" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.3250"></a><span id="l1.3250" class="difflineminus">-  if (!folder)</span>
<a href="#l1.3251"></a><span id="l1.3251" class="difflineminus">-  {</span>
<a href="#l1.3252"></a><span id="l1.3252" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.3253"></a><span id="l1.3253" class="difflineplus">+  if (!folder) {</span>
<a href="#l1.3254"></a><span id="l1.3254">     rv = GetFolderForViewIndex(index, getter_AddRefs(folder));</span>
<a href="#l1.3255"></a><span id="l1.3255" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3256"></a><span id="l1.3256" class="difflineminus">-  }</span>
<a href="#l1.3257"></a><span id="l1.3257" class="difflineminus">-</span>
<a href="#l1.3258"></a><span id="l1.3258" class="difflineminus">-  if (index == nsMsgViewIndex_None ||</span>
<a href="#l1.3259"></a><span id="l1.3259" class="difflineminus">-      index &gt;= m_flags.Length() ||</span>
<a href="#l1.3260"></a><span id="l1.3260" class="difflineminus">-      m_flags[index] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.3261"></a><span id="l1.3261" class="difflineminus">-  {</span>
<a href="#l1.3262"></a><span id="l1.3262" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3263"></a><span id="l1.3263" class="difflineplus">+  }</span>
<a href="#l1.3264"></a><span id="l1.3264" class="difflineplus">+</span>
<a href="#l1.3265"></a><span id="l1.3265" class="difflineplus">+  if (index == nsMsgViewIndex_None || index &gt;= m_flags.Length() ||</span>
<a href="#l1.3266"></a><span id="l1.3266" class="difflineplus">+      m_flags[index] &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l1.3267"></a><span id="l1.3267">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.3268"></a><span id="l1.3268">   }</span>
<a href="#l1.3269"></a><span id="l1.3269"> </span>
<a href="#l1.3270"></a><span id="l1.3270">   return GenerateURIForMsgKey(m_keys[index], folder, result);</span>
<a href="#l1.3271"></a><span id="l1.3271"> }</span>
<a href="#l1.3272"></a><span id="l1.3272"> </span>
<a href="#l1.3273"></a><span id="l1.3273"> NS_IMETHODIMP</span>
<a href="#l1.3274"></a><span id="l1.3274"> nsMsgDBView::DoCommandWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3275"></a><span id="l1.3275" class="difflineminus">-                                 nsIMsgFolder *destFolder)</span>
<a href="#l1.3276"></a><span id="l1.3276" class="difflineminus">-{</span>
<a href="#l1.3277"></a><span id="l1.3277" class="difflineplus">+                                 nsIMsgFolder *destFolder) {</span>
<a href="#l1.3278"></a><span id="l1.3278">   NS_ENSURE_ARG_POINTER(destFolder);</span>
<a href="#l1.3279"></a><span id="l1.3279"> </span>
<a href="#l1.3280"></a><span id="l1.3280">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3281"></a><span id="l1.3281"> </span>
<a href="#l1.3282"></a><span id="l1.3282">   GetSelectedIndices(selection);</span>
<a href="#l1.3283"></a><span id="l1.3283"> </span>
<a href="#l1.3284"></a><span id="l1.3284">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3285"></a><span id="l1.3285">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3286"></a><span id="l1.3286"> </span>
<a href="#l1.3287"></a><span id="l1.3287">   nsresult rv = NS_OK;</span>
<a href="#l1.3288"></a><span id="l1.3288" class="difflineminus">-  switch (command)</span>
<a href="#l1.3289"></a><span id="l1.3289" class="difflineminus">-  {</span>
<a href="#l1.3290"></a><span id="l1.3290" class="difflineplus">+  switch (command) {</span>
<a href="#l1.3291"></a><span id="l1.3291">     case nsMsgViewCommandType::copyMessages:</span>
<a href="#l1.3292"></a><span id="l1.3292">     case nsMsgViewCommandType::moveMessages:</span>
<a href="#l1.3293"></a><span id="l1.3293">       NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3294"></a><span id="l1.3294" class="difflineminus">-      rv = ApplyCommandToIndicesWithFolder(command, indices, numIndices, destFolder);</span>
<a href="#l1.3295"></a><span id="l1.3295" class="difflineplus">+      rv = ApplyCommandToIndicesWithFolder(command, indices, numIndices,</span>
<a href="#l1.3296"></a><span id="l1.3296" class="difflineplus">+                                           destFolder);</span>
<a href="#l1.3297"></a><span id="l1.3297">       NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3298"></a><span id="l1.3298">       break;</span>
<a href="#l1.3299"></a><span id="l1.3299">     default:</span>
<a href="#l1.3300"></a><span id="l1.3300">       NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3301"></a><span id="l1.3301">       rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3302"></a><span id="l1.3302">       break;</span>
<a href="#l1.3303"></a><span id="l1.3303">   }</span>
<a href="#l1.3304"></a><span id="l1.3304"> </span>
<a href="#l1.3305"></a><span id="l1.3305">   return rv;</span>
<a href="#l1.3306"></a><span id="l1.3306"> }</span>
<a href="#l1.3307"></a><span id="l1.3307"> </span>
<a href="#l1.3308"></a><span id="l1.3308"> NS_IMETHODIMP</span>
<a href="#l1.3309"></a><span id="l1.3309" class="difflineminus">-nsMsgDBView::DoCommand(nsMsgViewCommandTypeValue command)</span>
<a href="#l1.3310"></a><span id="l1.3310" class="difflineminus">-{</span>
<a href="#l1.3311"></a><span id="l1.3311" class="difflineplus">+nsMsgDBView::DoCommand(nsMsgViewCommandTypeValue command) {</span>
<a href="#l1.3312"></a><span id="l1.3312">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3313"></a><span id="l1.3313"> </span>
<a href="#l1.3314"></a><span id="l1.3314">   GetSelectedIndices(selection);</span>
<a href="#l1.3315"></a><span id="l1.3315"> </span>
<a href="#l1.3316"></a><span id="l1.3316">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3317"></a><span id="l1.3317">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3318"></a><span id="l1.3318">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3319"></a><span id="l1.3319"> </span>
<a href="#l1.3320"></a><span id="l1.3320">   nsresult rv = NS_OK;</span>
<a href="#l1.3321"></a><span id="l1.3321" class="difflineminus">-  switch (command)</span>
<a href="#l1.3322"></a><span id="l1.3322" class="difflineminus">-  {</span>
<a href="#l1.3323"></a><span id="l1.3323" class="difflineplus">+  switch (command) {</span>
<a href="#l1.3324"></a><span id="l1.3324">     case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3325"></a><span id="l1.3325">       return DownloadForOffline(msgWindow, indices, numIndices);</span>
<a href="#l1.3326"></a><span id="l1.3326">     case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3327"></a><span id="l1.3327">       return DownloadFlaggedForOffline(msgWindow);</span>
<a href="#l1.3328"></a><span id="l1.3328">     case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3329"></a><span id="l1.3329">     case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3330"></a><span id="l1.3330">     case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3331"></a><span id="l1.3331">     case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3332"></a><span id="l1.3332" class="difflineat">@@ -2909,196 +2517,173 @@ nsMsgDBView::DoCommand(nsMsgViewCommandT</span>
<a href="#l1.3333"></a><span id="l1.3333">     case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3334"></a><span id="l1.3334">     case nsMsgViewCommandType::junk:</span>
<a href="#l1.3335"></a><span id="l1.3335">     case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3336"></a><span id="l1.3336">       NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3337"></a><span id="l1.3337">       rv = ApplyCommandToIndices(command, indices, numIndices);</span>
<a href="#l1.3338"></a><span id="l1.3338">       NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.3339"></a><span id="l1.3339">       break;</span>
<a href="#l1.3340"></a><span id="l1.3340">     case nsMsgViewCommandType::selectAll:</span>
<a href="#l1.3341"></a><span id="l1.3341" class="difflineminus">-      if (mTreeSelection)</span>
<a href="#l1.3342"></a><span id="l1.3342" class="difflineminus">-      {</span>
<a href="#l1.3343"></a><span id="l1.3343" class="difflineplus">+      if (mTreeSelection) {</span>
<a href="#l1.3344"></a><span id="l1.3344">         // If in threaded mode, we need to expand all before selecting.</span>
<a href="#l1.3345"></a><span id="l1.3345">         if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3346"></a><span id="l1.3346">           rv = ExpandAll();</span>
<a href="#l1.3347"></a><span id="l1.3347"> </span>
<a href="#l1.3348"></a><span id="l1.3348">         mTreeSelection-&gt;SelectAll();</span>
<a href="#l1.3349"></a><span id="l1.3349" class="difflineminus">-        if (mTree)</span>
<a href="#l1.3350"></a><span id="l1.3350" class="difflineminus">-          mTree-&gt;Invalidate();</span>
<a href="#l1.3351"></a><span id="l1.3351" class="difflineplus">+        if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l1.3352"></a><span id="l1.3352">       }</span>
<a href="#l1.3353"></a><span id="l1.3353">       break;</span>
<a href="#l1.3354"></a><span id="l1.3354">     case nsMsgViewCommandType::selectThread:</span>
<a href="#l1.3355"></a><span id="l1.3355">       rv = ExpandAndSelectThread();</span>
<a href="#l1.3356"></a><span id="l1.3356">       break;</span>
<a href="#l1.3357"></a><span id="l1.3357">     case nsMsgViewCommandType::selectFlagged:</span>
<a href="#l1.3358"></a><span id="l1.3358" class="difflineminus">-      if (!mTreeSelection)</span>
<a href="#l1.3359"></a><span id="l1.3359" class="difflineminus">-      {</span>
<a href="#l1.3360"></a><span id="l1.3360" class="difflineplus">+      if (!mTreeSelection) {</span>
<a href="#l1.3361"></a><span id="l1.3361">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3362"></a><span id="l1.3362" class="difflineminus">-      }</span>
<a href="#l1.3363"></a><span id="l1.3363" class="difflineminus">-      else</span>
<a href="#l1.3364"></a><span id="l1.3364" class="difflineminus">-      {</span>
<a href="#l1.3365"></a><span id="l1.3365" class="difflineplus">+      } else {</span>
<a href="#l1.3366"></a><span id="l1.3366">         mTreeSelection-&gt;SetSelectEventsSuppressed(true);</span>
<a href="#l1.3367"></a><span id="l1.3367">         mTreeSelection-&gt;ClearSelection();</span>
<a href="#l1.3368"></a><span id="l1.3368">         // XXX ExpandAll?</span>
<a href="#l1.3369"></a><span id="l1.3369">         nsMsgViewIndex numIndices = GetSize();</span>
<a href="#l1.3370"></a><span id="l1.3370" class="difflineminus">-        for (nsMsgViewIndex curIndex = 0; curIndex &lt; numIndices; curIndex++)</span>
<a href="#l1.3371"></a><span id="l1.3371" class="difflineminus">-        {</span>
<a href="#l1.3372"></a><span id="l1.3372" class="difflineplus">+        for (nsMsgViewIndex curIndex = 0; curIndex &lt; numIndices; curIndex++) {</span>
<a href="#l1.3373"></a><span id="l1.3373">           if (m_flags[curIndex] &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.3374"></a><span id="l1.3374">             mTreeSelection-&gt;ToggleSelect(curIndex);</span>
<a href="#l1.3375"></a><span id="l1.3375">         }</span>
<a href="#l1.3376"></a><span id="l1.3376"> </span>
<a href="#l1.3377"></a><span id="l1.3377">         mTreeSelection-&gt;SetSelectEventsSuppressed(false);</span>
<a href="#l1.3378"></a><span id="l1.3378">       }</span>
<a href="#l1.3379"></a><span id="l1.3379">       break;</span>
<a href="#l1.3380"></a><span id="l1.3380">     case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3381"></a><span id="l1.3381" class="difflineminus">-      if (m_folder)</span>
<a href="#l1.3382"></a><span id="l1.3382" class="difflineminus">-      {</span>
<a href="#l1.3383"></a><span id="l1.3383" class="difflineplus">+      if (m_folder) {</span>
<a href="#l1.3384"></a><span id="l1.3384">         SetSuppressChangeNotifications(true);</span>
<a href="#l1.3385"></a><span id="l1.3385">         rv = m_folder-&gt;MarkAllMessagesRead(msgWindow);</span>
<a href="#l1.3386"></a><span id="l1.3386">         SetSuppressChangeNotifications(false);</span>
<a href="#l1.3387"></a><span id="l1.3387" class="difflineminus">-        if (mTree)</span>
<a href="#l1.3388"></a><span id="l1.3388" class="difflineminus">-          mTree-&gt;Invalidate();</span>
<a href="#l1.3389"></a><span id="l1.3389" class="difflineplus">+        if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l1.3390"></a><span id="l1.3390">       }</span>
<a href="#l1.3391"></a><span id="l1.3391">       break;</span>
<a href="#l1.3392"></a><span id="l1.3392">     case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3393"></a><span id="l1.3393" class="difflineminus">-      rv = ToggleWatched(indices,  numIndices);</span>
<a href="#l1.3394"></a><span id="l1.3394" class="difflineplus">+      rv = ToggleWatched(indices, numIndices);</span>
<a href="#l1.3395"></a><span id="l1.3395">       break;</span>
<a href="#l1.3396"></a><span id="l1.3396">     case nsMsgViewCommandType::expandAll:</span>
<a href="#l1.3397"></a><span id="l1.3397">       rv = ExpandAll();</span>
<a href="#l1.3398"></a><span id="l1.3398">       m_viewFlags |= nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3399"></a><span id="l1.3399">       SetViewFlags(m_viewFlags);</span>
<a href="#l1.3400"></a><span id="l1.3400" class="difflineminus">-      if (mTree)</span>
<a href="#l1.3401"></a><span id="l1.3401" class="difflineminus">-        mTree-&gt;Invalidate();</span>
<a href="#l1.3402"></a><span id="l1.3402" class="difflineplus">+      if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l1.3403"></a><span id="l1.3403"> </span>
<a href="#l1.3404"></a><span id="l1.3404">       break;</span>
<a href="#l1.3405"></a><span id="l1.3405">     case nsMsgViewCommandType::collapseAll:</span>
<a href="#l1.3406"></a><span id="l1.3406">       rv = CollapseAll();</span>
<a href="#l1.3407"></a><span id="l1.3407">       m_viewFlags &amp;= ~nsMsgViewFlagsType::kExpandAll;</span>
<a href="#l1.3408"></a><span id="l1.3408">       SetViewFlags(m_viewFlags);</span>
<a href="#l1.3409"></a><span id="l1.3409" class="difflineminus">-      if(mTree)</span>
<a href="#l1.3410"></a><span id="l1.3410" class="difflineminus">-        mTree-&gt;Invalidate();</span>
<a href="#l1.3411"></a><span id="l1.3411" class="difflineplus">+      if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l1.3412"></a><span id="l1.3412"> </span>
<a href="#l1.3413"></a><span id="l1.3413">       break;</span>
<a href="#l1.3414"></a><span id="l1.3414">     default:</span>
<a href="#l1.3415"></a><span id="l1.3415">       NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3416"></a><span id="l1.3416">       rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3417"></a><span id="l1.3417">       break;</span>
<a href="#l1.3418"></a><span id="l1.3418">   }</span>
<a href="#l1.3419"></a><span id="l1.3419"> </span>
<a href="#l1.3420"></a><span id="l1.3420">   return rv;</span>
<a href="#l1.3421"></a><span id="l1.3421"> }</span>
<a href="#l1.3422"></a><span id="l1.3422"> </span>
<a href="#l1.3423"></a><span id="l1.3423" class="difflineminus">-bool</span>
<a href="#l1.3424"></a><span id="l1.3424" class="difflineminus">-nsMsgDBView::ServerSupportsFilterAfterTheFact()</span>
<a href="#l1.3425"></a><span id="l1.3425" class="difflineminus">-{</span>
<a href="#l1.3426"></a><span id="l1.3426" class="difflineplus">+bool nsMsgDBView::ServerSupportsFilterAfterTheFact() {</span>
<a href="#l1.3427"></a><span id="l1.3427">   // Cross folder virtual folders might not have a folder set.</span>
<a href="#l1.3428"></a><span id="l1.3428" class="difflineminus">-  if (!m_folder)</span>
<a href="#l1.3429"></a><span id="l1.3429" class="difflineminus">-    return false;</span>
<a href="#l1.3430"></a><span id="l1.3430" class="difflineminus">-</span>
<a href="#l1.3431"></a><span id="l1.3431" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3432"></a><span id="l1.3432" class="difflineplus">+  if (!m_folder) return false;</span>
<a href="#l1.3433"></a><span id="l1.3433" class="difflineplus">+</span>
<a href="#l1.3434"></a><span id="l1.3434" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3435"></a><span id="l1.3435">   nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.3436"></a><span id="l1.3436">   // Unexpected.</span>
<a href="#l1.3437"></a><span id="l1.3437" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.3438"></a><span id="l1.3438" class="difflineminus">-    return false;</span>
<a href="#l1.3439"></a><span id="l1.3439" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l1.3440"></a><span id="l1.3440"> </span>
<a href="#l1.3441"></a><span id="l1.3441">   // Filter after the fact is implement using search so if you can't search,</span>
<a href="#l1.3442"></a><span id="l1.3442">   // you can't filter after the fact.</span>
<a href="#l1.3443"></a><span id="l1.3443">   bool canSearch;</span>
<a href="#l1.3444"></a><span id="l1.3444">   rv = server-&gt;GetCanSearchMessages(&amp;canSearch);</span>
<a href="#l1.3445"></a><span id="l1.3445">   // Unexpected.</span>
<a href="#l1.3446"></a><span id="l1.3446" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.3447"></a><span id="l1.3447" class="difflineminus">-    return false;</span>
<a href="#l1.3448"></a><span id="l1.3448" class="difflineplus">+  if (NS_FAILED(rv)) return false;</span>
<a href="#l1.3449"></a><span id="l1.3449"> </span>
<a href="#l1.3450"></a><span id="l1.3450">   return canSearch;</span>
<a href="#l1.3451"></a><span id="l1.3451"> }</span>
<a href="#l1.3452"></a><span id="l1.3452"> </span>
<a href="#l1.3453"></a><span id="l1.3453"> NS_IMETHODIMP</span>
<a href="#l1.3454"></a><span id="l1.3454"> nsMsgDBView::GetCommandStatus(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3455"></a><span id="l1.3455">                               bool *selectable_p,</span>
<a href="#l1.3456"></a><span id="l1.3456" class="difflineminus">-                              nsMsgViewCommandCheckStateValue *selected_p)</span>
<a href="#l1.3457"></a><span id="l1.3457" class="difflineminus">-{</span>
<a href="#l1.3458"></a><span id="l1.3458" class="difflineplus">+                              nsMsgViewCommandCheckStateValue *selected_p) {</span>
<a href="#l1.3459"></a><span id="l1.3459">   nsresult rv = NS_OK;</span>
<a href="#l1.3460"></a><span id="l1.3460"> </span>
<a href="#l1.3461"></a><span id="l1.3461">   bool haveSelection;</span>
<a href="#l1.3462"></a><span id="l1.3462">   int32_t rangeCount;</span>
<a href="#l1.3463"></a><span id="l1.3463">   nsMsgViewIndexArray selection;</span>
<a href="#l1.3464"></a><span id="l1.3464">   GetSelectedIndices(selection);</span>
<a href="#l1.3465"></a><span id="l1.3465">   int32_t numIndices = selection.Length();</span>
<a href="#l1.3466"></a><span id="l1.3466">   nsMsgViewIndex *indices = selection.Elements();</span>
<a href="#l1.3467"></a><span id="l1.3467">   // If range count is non-zero, we have at least one item selected, so we</span>
<a href="#l1.3468"></a><span id="l1.3468">   // have a selection.</span>
<a href="#l1.3469"></a><span id="l1.3469">   if (mTreeSelection &amp;&amp;</span>
<a href="#l1.3470"></a><span id="l1.3470">       NS_SUCCEEDED(mTreeSelection-&gt;GetRangeCount(&amp;rangeCount)) &amp;&amp;</span>
<a href="#l1.3471"></a><span id="l1.3471" class="difflineminus">-      rangeCount &gt; 0)</span>
<a href="#l1.3472"></a><span id="l1.3472" class="difflineminus">-  {</span>
<a href="#l1.3473"></a><span id="l1.3473" class="difflineplus">+      rangeCount &gt; 0) {</span>
<a href="#l1.3474"></a><span id="l1.3474">     haveSelection = NonDummyMsgSelected(indices, numIndices);</span>
<a href="#l1.3475"></a><span id="l1.3475" class="difflineminus">-  }</span>
<a href="#l1.3476"></a><span id="l1.3476" class="difflineminus">-  else</span>
<a href="#l1.3477"></a><span id="l1.3477" class="difflineminus">-  {</span>
<a href="#l1.3478"></a><span id="l1.3478" class="difflineplus">+  } else {</span>
<a href="#l1.3479"></a><span id="l1.3479">     // If we don't have a tree selection we must be in stand alone mode.</span>
<a href="#l1.3480"></a><span id="l1.3480">     haveSelection = IsValidIndex(m_currentlyDisplayedViewIndex);</span>
<a href="#l1.3481"></a><span id="l1.3481">   }</span>
<a href="#l1.3482"></a><span id="l1.3482"> </span>
<a href="#l1.3483"></a><span id="l1.3483" class="difflineminus">-  switch (command)</span>
<a href="#l1.3484"></a><span id="l1.3484" class="difflineminus">-  {</span>
<a href="#l1.3485"></a><span id="l1.3485" class="difflineplus">+  switch (command) {</span>
<a href="#l1.3486"></a><span id="l1.3486">     case nsMsgViewCommandType::deleteMsg:</span>
<a href="#l1.3487"></a><span id="l1.3487" class="difflineminus">-    case nsMsgViewCommandType::deleteNoTrash:</span>
<a href="#l1.3488"></a><span id="l1.3488" class="difflineminus">-    {</span>
<a href="#l1.3489"></a><span id="l1.3489" class="difflineplus">+    case nsMsgViewCommandType::deleteNoTrash: {</span>
<a href="#l1.3490"></a><span id="l1.3490">       bool canDelete;</span>
<a href="#l1.3491"></a><span id="l1.3491">       if (m_folder &amp;&amp;</span>
<a href="#l1.3492"></a><span id="l1.3492">           NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp;</span>
<a href="#l1.3493"></a><span id="l1.3493" class="difflineminus">-          !canDelete)</span>
<a href="#l1.3494"></a><span id="l1.3494" class="difflineminus">-      {</span>
<a href="#l1.3495"></a><span id="l1.3495" class="difflineplus">+          !canDelete) {</span>
<a href="#l1.3496"></a><span id="l1.3496">         *selectable_p = false;</span>
<a href="#l1.3497"></a><span id="l1.3497" class="difflineminus">-      }</span>
<a href="#l1.3498"></a><span id="l1.3498" class="difflineminus">-      else</span>
<a href="#l1.3499"></a><span id="l1.3499" class="difflineminus">-      {</span>
<a href="#l1.3500"></a><span id="l1.3500" class="difflineplus">+      } else {</span>
<a href="#l1.3501"></a><span id="l1.3501">         *selectable_p = haveSelection;</span>
<a href="#l1.3502"></a><span id="l1.3502">       }</span>
<a href="#l1.3503"></a><span id="l1.3503">       break;</span>
<a href="#l1.3504"></a><span id="l1.3504">     }</span>
<a href="#l1.3505"></a><span id="l1.3505">     case nsMsgViewCommandType::applyFilters:</span>
<a href="#l1.3506"></a><span id="l1.3506">       // Disable if no messages.</span>
<a href="#l1.3507"></a><span id="l1.3507">       // XXX todo, check that we have filters, and at least one is enabled.</span>
<a href="#l1.3508"></a><span id="l1.3508">       *selectable_p = GetSize();</span>
<a href="#l1.3509"></a><span id="l1.3509" class="difflineminus">-      if (*selectable_p)</span>
<a href="#l1.3510"></a><span id="l1.3510" class="difflineminus">-        *selectable_p = ServerSupportsFilterAfterTheFact();</span>
<a href="#l1.3511"></a><span id="l1.3511" class="difflineplus">+      if (*selectable_p) *selectable_p = ServerSupportsFilterAfterTheFact();</span>
<a href="#l1.3512"></a><span id="l1.3512"> </span>
<a href="#l1.3513"></a><span id="l1.3513">       break;</span>
<a href="#l1.3514"></a><span id="l1.3514">     case nsMsgViewCommandType::runJunkControls:</span>
<a href="#l1.3515"></a><span id="l1.3515">       // Disable if no messages.</span>
<a href="#l1.3516"></a><span id="l1.3516">       // XXX todo, check that we have JMC enabled?</span>
<a href="#l1.3517"></a><span id="l1.3517">       *selectable_p = GetSize() &amp;&amp; JunkControlsEnabled(nsMsgViewIndex_None);</span>
<a href="#l1.3518"></a><span id="l1.3518">       break;</span>
<a href="#l1.3519"></a><span id="l1.3519" class="difflineminus">-    case nsMsgViewCommandType::deleteJunk:</span>
<a href="#l1.3520"></a><span id="l1.3520" class="difflineminus">-    {</span>
<a href="#l1.3521"></a><span id="l1.3521" class="difflineplus">+    case nsMsgViewCommandType::deleteJunk: {</span>
<a href="#l1.3522"></a><span id="l1.3522">       // Disable if no messages, or if we can't delete (like news and</span>
<a href="#l1.3523"></a><span id="l1.3523">       // certain imap folders).</span>
<a href="#l1.3524"></a><span id="l1.3524">       bool canDelete;</span>
<a href="#l1.3525"></a><span id="l1.3525" class="difflineminus">-      *selectable_p = GetSize() &amp;&amp; m_folder &amp;&amp;</span>
<a href="#l1.3526"></a><span id="l1.3526" class="difflineminus">-                      NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp;</span>
<a href="#l1.3527"></a><span id="l1.3527" class="difflineminus">-                      canDelete;</span>
<a href="#l1.3528"></a><span id="l1.3528" class="difflineplus">+      *selectable_p =</span>
<a href="#l1.3529"></a><span id="l1.3529" class="difflineplus">+          GetSize() &amp;&amp; m_folder &amp;&amp;</span>
<a href="#l1.3530"></a><span id="l1.3530" class="difflineplus">+          NS_SUCCEEDED(m_folder-&gt;GetCanDeleteMessages(&amp;canDelete)) &amp;&amp; canDelete;</span>
<a href="#l1.3531"></a><span id="l1.3531">       break;</span>
<a href="#l1.3532"></a><span id="l1.3532">     }</span>
<a href="#l1.3533"></a><span id="l1.3533">     case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3534"></a><span id="l1.3534">     case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3535"></a><span id="l1.3535">     case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3536"></a><span id="l1.3536">     case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3537"></a><span id="l1.3537">     case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3538"></a><span id="l1.3538">     case nsMsgViewCommandType::toggleThreadWatched:</span>
<a href="#l1.3539"></a><span id="l1.3539">     case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3540"></a><span id="l1.3540">     case nsMsgViewCommandType::downloadSelectedForOffline:</span>
<a href="#l1.3541"></a><span id="l1.3541">       *selectable_p = haveSelection;</span>
<a href="#l1.3542"></a><span id="l1.3542">       break;</span>
<a href="#l1.3543"></a><span id="l1.3543">     case nsMsgViewCommandType::junk:</span>
<a href="#l1.3544"></a><span id="l1.3544">     case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3545"></a><span id="l1.3545" class="difflineminus">-      *selectable_p = haveSelection &amp;&amp; numIndices &amp;&amp; JunkControlsEnabled(selection[0]);</span>
<a href="#l1.3546"></a><span id="l1.3546" class="difflineplus">+      *selectable_p =</span>
<a href="#l1.3547"></a><span id="l1.3547" class="difflineplus">+          haveSelection &amp;&amp; numIndices &amp;&amp; JunkControlsEnabled(selection[0]);</span>
<a href="#l1.3548"></a><span id="l1.3548">       break;</span>
<a href="#l1.3549"></a><span id="l1.3549">     case nsMsgViewCommandType::cmdRequiringMsgBody:</span>
<a href="#l1.3550"></a><span id="l1.3550" class="difflineminus">-      *selectable_p = haveSelection &amp;&amp; (!WeAreOffline() || OfflineMsgSelected(indices, numIndices));</span>
<a href="#l1.3551"></a><span id="l1.3551" class="difflineplus">+      *selectable_p =</span>
<a href="#l1.3552"></a><span id="l1.3552" class="difflineplus">+          haveSelection &amp;&amp;</span>
<a href="#l1.3553"></a><span id="l1.3553" class="difflineplus">+          (!WeAreOffline() || OfflineMsgSelected(indices, numIndices));</span>
<a href="#l1.3554"></a><span id="l1.3554">       break;</span>
<a href="#l1.3555"></a><span id="l1.3555">     case nsMsgViewCommandType::downloadFlaggedForOffline:</span>
<a href="#l1.3556"></a><span id="l1.3556">     case nsMsgViewCommandType::markAllRead:</span>
<a href="#l1.3557"></a><span id="l1.3557">       *selectable_p = true;</span>
<a href="#l1.3558"></a><span id="l1.3558">       break;</span>
<a href="#l1.3559"></a><span id="l1.3559">     default:</span>
<a href="#l1.3560"></a><span id="l1.3560">       NS_ASSERTION(false, &quot;invalid command type&quot;);</span>
<a href="#l1.3561"></a><span id="l1.3561">       rv = NS_ERROR_FAILURE;</span>
<a href="#l1.3562"></a><span id="l1.3562" class="difflineat">@@ -3108,271 +2693,236 @@ nsMsgDBView::GetCommandStatus(nsMsgViewC</span>
<a href="#l1.3563"></a><span id="l1.3563"> }</span>
<a href="#l1.3564"></a><span id="l1.3564"> </span>
<a href="#l1.3565"></a><span id="l1.3565"> // This method needs to be overridden by the various view classes</span>
<a href="#l1.3566"></a><span id="l1.3566"> // that have different kinds of threads. For example, in a</span>
<a href="#l1.3567"></a><span id="l1.3567"> // threaded quick search db view, we'd only want to include children</span>
<a href="#l1.3568"></a><span id="l1.3568"> // of the thread that fit the view (IMO). And when we have threaded</span>
<a href="#l1.3569"></a><span id="l1.3569"> // cross folder views, we would include all the children of the</span>
<a href="#l1.3570"></a><span id="l1.3570"> // cross-folder thread.</span>
<a href="#l1.3571"></a><span id="l1.3571" class="difflineminus">-nsresult</span>
<a href="#l1.3572"></a><span id="l1.3572" class="difflineminus">-nsMsgDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l1.3573"></a><span id="l1.3573" class="difflineminus">-                                   nsIMutableArray *messageArray)</span>
<a href="#l1.3574"></a><span id="l1.3574" class="difflineminus">-{</span>
<a href="#l1.3575"></a><span id="l1.3575" class="difflineplus">+nsresult nsMsgDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l1.3576"></a><span id="l1.3576" class="difflineplus">+                                            nsIMutableArray *messageArray) {</span>
<a href="#l1.3577"></a><span id="l1.3577">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3578"></a><span id="l1.3578">   nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.3579"></a><span id="l1.3579">   GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.3580"></a><span id="l1.3580" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l1.3581"></a><span id="l1.3581" class="difflineminus">-  {</span>
<a href="#l1.3582"></a><span id="l1.3582" class="difflineplus">+  if (!msgHdr) {</span>
<a href="#l1.3583"></a><span id="l1.3583">     NS_ASSERTION(false, &quot;couldn't find message to expand&quot;);</span>
<a href="#l1.3584"></a><span id="l1.3584">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.3585"></a><span id="l1.3585">   }</span>
<a href="#l1.3586"></a><span id="l1.3586"> </span>
<a href="#l1.3587"></a><span id="l1.3587">   nsresult rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.3588"></a><span id="l1.3588">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3589"></a><span id="l1.3589">   uint32_t numChildren;</span>
<a href="#l1.3590"></a><span id="l1.3590">   thread-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.3591"></a><span id="l1.3591" class="difflineminus">-  for (uint32_t i = 1; i &lt; numChildren &amp;&amp; NS_SUCCEEDED(rv); i++)</span>
<a href="#l1.3592"></a><span id="l1.3592" class="difflineminus">-  {</span>
<a href="#l1.3593"></a><span id="l1.3593" class="difflineplus">+  for (uint32_t i = 1; i &lt; numChildren &amp;&amp; NS_SUCCEEDED(rv); i++) {</span>
<a href="#l1.3594"></a><span id="l1.3594">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3595"></a><span id="l1.3595">     rv = thread-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.3596"></a><span id="l1.3596" class="difflineminus">-    if (!msgHdr)</span>
<a href="#l1.3597"></a><span id="l1.3597" class="difflineminus">-      continue;</span>
<a href="#l1.3598"></a><span id="l1.3598" class="difflineplus">+    if (!msgHdr) continue;</span>
<a href="#l1.3599"></a><span id="l1.3599"> </span>
<a href="#l1.3600"></a><span id="l1.3600">     rv = messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l1.3601"></a><span id="l1.3601">   }</span>
<a href="#l1.3602"></a><span id="l1.3602"> </span>
<a href="#l1.3603"></a><span id="l1.3603">   return rv;</span>
<a href="#l1.3604"></a><span id="l1.3604"> }</span>
<a href="#l1.3605"></a><span id="l1.3605"> </span>
<a href="#l1.3606"></a><span id="l1.3606" class="difflineminus">-bool</span>
<a href="#l1.3607"></a><span id="l1.3607" class="difflineminus">-nsMsgDBView::OperateOnMsgsInCollapsedThreads()</span>
<a href="#l1.3608"></a><span id="l1.3608" class="difflineminus">-{</span>
<a href="#l1.3609"></a><span id="l1.3609" class="difflineminus">-  if (mTreeSelection)</span>
<a href="#l1.3610"></a><span id="l1.3610" class="difflineminus">-  {</span>
<a href="#l1.3611"></a><span id="l1.3611" class="difflineplus">+bool nsMsgDBView::OperateOnMsgsInCollapsedThreads() {</span>
<a href="#l1.3612"></a><span id="l1.3612" class="difflineplus">+  if (mTreeSelection) {</span>
<a href="#l1.3613"></a><span id="l1.3613">     RefPtr&lt;mozilla::dom::XULTreeElement&gt; selTree;</span>
<a href="#l1.3614"></a><span id="l1.3614">     mTreeSelection-&gt;GetTree(getter_AddRefs(selTree));</span>
<a href="#l1.3615"></a><span id="l1.3615">     // No tree means stand-alone message window.</span>
<a href="#l1.3616"></a><span id="l1.3616" class="difflineminus">-    if (!selTree)</span>
<a href="#l1.3617"></a><span id="l1.3617" class="difflineminus">-      return false;</span>
<a href="#l1.3618"></a><span id="l1.3618" class="difflineplus">+    if (!selTree) return false;</span>
<a href="#l1.3619"></a><span id="l1.3619">   }</span>
<a href="#l1.3620"></a><span id="l1.3620"> </span>
<a href="#l1.3621"></a><span id="l1.3621">   nsresult rv = NS_OK;</span>
<a href="#l1.3622"></a><span id="l1.3622" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.3623"></a><span id="l1.3623" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l1.3624"></a><span id="l1.3624" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.3625"></a><span id="l1.3625">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l1.3626"></a><span id="l1.3626"> </span>
<a href="#l1.3627"></a><span id="l1.3627">   bool includeCollapsedMsgs = false;</span>
<a href="#l1.3628"></a><span id="l1.3628">   prefBranch-&gt;GetBoolPref(&quot;mail.operate_on_msgs_in_collapsed_threads&quot;,</span>
<a href="#l1.3629"></a><span id="l1.3629">                           &amp;includeCollapsedMsgs);</span>
<a href="#l1.3630"></a><span id="l1.3630">   return includeCollapsedMsgs;</span>
<a href="#l1.3631"></a><span id="l1.3631"> }</span>
<a href="#l1.3632"></a><span id="l1.3632"> </span>
<a href="#l1.3633"></a><span id="l1.3633" class="difflineminus">-nsresult</span>
<a href="#l1.3634"></a><span id="l1.3634" class="difflineminus">-nsMsgDBView::GetHeadersFromSelection(uint32_t *indices,</span>
<a href="#l1.3635"></a><span id="l1.3635" class="difflineminus">-                                     uint32_t numIndices,</span>
<a href="#l1.3636"></a><span id="l1.3636" class="difflineminus">-                                     nsIMutableArray *messageArray)</span>
<a href="#l1.3637"></a><span id="l1.3637" class="difflineminus">-{</span>
<a href="#l1.3638"></a><span id="l1.3638" class="difflineplus">+nsresult nsMsgDBView::GetHeadersFromSelection(uint32_t *indices,</span>
<a href="#l1.3639"></a><span id="l1.3639" class="difflineplus">+                                              uint32_t numIndices,</span>
<a href="#l1.3640"></a><span id="l1.3640" class="difflineplus">+                                              nsIMutableArray *messageArray) {</span>
<a href="#l1.3641"></a><span id="l1.3641">   nsresult rv = NS_OK;</span>
<a href="#l1.3642"></a><span id="l1.3642"> </span>
<a href="#l1.3643"></a><span id="l1.3643">   // Don't include collapsed messages if the front end failed to summarize</span>
<a href="#l1.3644"></a><span id="l1.3644">   // the selection.</span>
<a href="#l1.3645"></a><span id="l1.3645" class="difflineminus">-  bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads() &amp;&amp;</span>
<a href="#l1.3646"></a><span id="l1.3646" class="difflineminus">-                              !mSummarizeFailed;</span>
<a href="#l1.3647"></a><span id="l1.3647" class="difflineplus">+  bool includeCollapsedMsgs =</span>
<a href="#l1.3648"></a><span id="l1.3648" class="difflineplus">+      OperateOnMsgsInCollapsedThreads() &amp;&amp; !mSummarizeFailed;</span>
<a href="#l1.3649"></a><span id="l1.3649"> </span>
<a href="#l1.3650"></a><span id="l1.3650">   for (uint32_t index = 0;</span>
<a href="#l1.3651"></a><span id="l1.3651" class="difflineminus">-       index &lt; (nsMsgViewIndex) numIndices &amp;&amp; NS_SUCCEEDED(rv);</span>
<a href="#l1.3652"></a><span id="l1.3652" class="difflineminus">-       index++)</span>
<a href="#l1.3653"></a><span id="l1.3653" class="difflineminus">-  {</span>
<a href="#l1.3654"></a><span id="l1.3654" class="difflineplus">+       index &lt; (nsMsgViewIndex)numIndices &amp;&amp; NS_SUCCEEDED(rv); index++) {</span>
<a href="#l1.3655"></a><span id="l1.3655">     nsMsgViewIndex viewIndex = indices[index];</span>
<a href="#l1.3656"></a><span id="l1.3656" class="difflineminus">-    if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l1.3657"></a><span id="l1.3657" class="difflineminus">-      continue;</span>
<a href="#l1.3658"></a><span id="l1.3658" class="difflineplus">+    if (viewIndex == nsMsgViewIndex_None) continue;</span>
<a href="#l1.3659"></a><span id="l1.3659"> </span>
<a href="#l1.3660"></a><span id="l1.3660">     uint32_t viewIndexFlags = m_flags[viewIndex];</span>
<a href="#l1.3661"></a><span id="l1.3661" class="difflineminus">-    if (viewIndexFlags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.3662"></a><span id="l1.3662" class="difflineminus">-    {</span>
<a href="#l1.3663"></a><span id="l1.3663" class="difflineplus">+    if (viewIndexFlags &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l1.3664"></a><span id="l1.3664">       // If collapsed dummy header selected, list its children.</span>
<a href="#l1.3665"></a><span id="l1.3665">       if (includeCollapsedMsgs &amp;&amp; viewIndexFlags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.3666"></a><span id="l1.3666">           m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3667"></a><span id="l1.3667">         rv = ListCollapsedChildren(viewIndex, messageArray);</span>
<a href="#l1.3668"></a><span id="l1.3668"> </span>
<a href="#l1.3669"></a><span id="l1.3669">       continue;</span>
<a href="#l1.3670"></a><span id="l1.3670">     }</span>
<a href="#l1.3671"></a><span id="l1.3671"> </span>
<a href="#l1.3672"></a><span id="l1.3672">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3673"></a><span id="l1.3673">     rv = GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.3674"></a><span id="l1.3674" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l1.3675"></a><span id="l1.3675" class="difflineminus">-    {</span>
<a href="#l1.3676"></a><span id="l1.3676" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr) {</span>
<a href="#l1.3677"></a><span id="l1.3677">       rv = messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l1.3678"></a><span id="l1.3678">       if (NS_SUCCEEDED(rv) &amp;&amp; includeCollapsedMsgs &amp;&amp;</span>
<a href="#l1.3679"></a><span id="l1.3679">           viewIndexFlags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.3680"></a><span id="l1.3680">           viewIndexFlags &amp; MSG_VIEW_FLAG_HASCHILDREN &amp;&amp;</span>
<a href="#l1.3681"></a><span id="l1.3681" class="difflineminus">-          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.3682"></a><span id="l1.3682" class="difflineminus">-      {</span>
<a href="#l1.3683"></a><span id="l1.3683" class="difflineplus">+          m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.3684"></a><span id="l1.3684">         rv = ListCollapsedChildren(viewIndex, messageArray);</span>
<a href="#l1.3685"></a><span id="l1.3685">       }</span>
<a href="#l1.3686"></a><span id="l1.3686">     }</span>
<a href="#l1.3687"></a><span id="l1.3687">   }</span>
<a href="#l1.3688"></a><span id="l1.3688"> </span>
<a href="#l1.3689"></a><span id="l1.3689">   return rv;</span>
<a href="#l1.3690"></a><span id="l1.3690"> }</span>
<a href="#l1.3691"></a><span id="l1.3691"> </span>
<a href="#l1.3692"></a><span id="l1.3692" class="difflineminus">-nsresult</span>
<a href="#l1.3693"></a><span id="l1.3693" class="difflineminus">-nsMsgDBView::CopyMessages(nsIMsgWindow *window,</span>
<a href="#l1.3694"></a><span id="l1.3694" class="difflineminus">-                          nsMsgViewIndex *indices,</span>
<a href="#l1.3695"></a><span id="l1.3695" class="difflineminus">-                          int32_t numIndices,</span>
<a href="#l1.3696"></a><span id="l1.3696" class="difflineminus">-                          bool isMove,</span>
<a href="#l1.3697"></a><span id="l1.3697" class="difflineminus">-                          nsIMsgFolder *destFolder)</span>
<a href="#l1.3698"></a><span id="l1.3698" class="difflineminus">-{</span>
<a href="#l1.3699"></a><span id="l1.3699" class="difflineminus">-  if (m_deletingRows)</span>
<a href="#l1.3700"></a><span id="l1.3700" class="difflineminus">-  {</span>
<a href="#l1.3701"></a><span id="l1.3701" class="difflineplus">+nsresult nsMsgDBView::CopyMessages(nsIMsgWindow *window,</span>
<a href="#l1.3702"></a><span id="l1.3702" class="difflineplus">+                                   nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l1.3703"></a><span id="l1.3703" class="difflineplus">+                                   bool isMove, nsIMsgFolder *destFolder) {</span>
<a href="#l1.3704"></a><span id="l1.3704" class="difflineplus">+  if (m_deletingRows) {</span>
<a href="#l1.3705"></a><span id="l1.3705">     NS_ASSERTION(false, &quot;Last move did not complete&quot;);</span>
<a href="#l1.3706"></a><span id="l1.3706">     return NS_OK;</span>
<a href="#l1.3707"></a><span id="l1.3707">   }</span>
<a href="#l1.3708"></a><span id="l1.3708"> </span>
<a href="#l1.3709"></a><span id="l1.3709">   nsresult rv;</span>
<a href="#l1.3710"></a><span id="l1.3710">   NS_ENSURE_ARG_POINTER(destFolder);</span>
<a href="#l1.3711"></a><span id="l1.3711" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3712"></a><span id="l1.3712" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l1.3713"></a><span id="l1.3713" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3714"></a><span id="l1.3714">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3715"></a><span id="l1.3715">   rv = GetHeadersFromSelection(indices, numIndices, messageArray);</span>
<a href="#l1.3716"></a><span id="l1.3716">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3717"></a><span id="l1.3717"> </span>
<a href="#l1.3718"></a><span id="l1.3718">   m_deletingRows = isMove &amp;&amp; mDeleteModel != nsMsgImapDeleteModels::IMAPDelete;</span>
<a href="#l1.3719"></a><span id="l1.3719" class="difflineminus">-  if (m_deletingRows)</span>
<a href="#l1.3720"></a><span id="l1.3720" class="difflineminus">-    mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.3721"></a><span id="l1.3721" class="difflineminus">-</span>
<a href="#l1.3722"></a><span id="l1.3722" class="difflineminus">-  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3723"></a><span id="l1.3723" class="difflineplus">+  if (m_deletingRows) mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.3724"></a><span id="l1.3724" class="difflineplus">+</span>
<a href="#l1.3725"></a><span id="l1.3725" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l1.3726"></a><span id="l1.3726" class="difflineplus">+      do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.3727"></a><span id="l1.3727">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3728"></a><span id="l1.3728"> </span>
<a href="#l1.3729"></a><span id="l1.3729" class="difflineminus">-  return copyService-&gt;CopyMessages(m_folder /* source folder */,</span>
<a href="#l1.3730"></a><span id="l1.3730" class="difflineminus">-                                   messageArray,</span>
<a href="#l1.3731"></a><span id="l1.3731" class="difflineminus">-                                   destFolder,</span>
<a href="#l1.3732"></a><span id="l1.3732" class="difflineminus">-                                   isMove,</span>
<a href="#l1.3733"></a><span id="l1.3733" class="difflineminus">-                                   nullptr /* listener */,</span>
<a href="#l1.3734"></a><span id="l1.3734" class="difflineplus">+  return copyService-&gt;CopyMessages(m_folder /* source folder */, messageArray,</span>
<a href="#l1.3735"></a><span id="l1.3735" class="difflineplus">+                                   destFolder, isMove, nullptr /* listener */,</span>
<a href="#l1.3736"></a><span id="l1.3736">                                    window, true /* allow Undo */);</span>
<a href="#l1.3737"></a><span id="l1.3737"> }</span>
<a href="#l1.3738"></a><span id="l1.3738"> </span>
<a href="#l1.3739"></a><span id="l1.3739" class="difflineminus">-nsresult</span>
<a href="#l1.3740"></a><span id="l1.3740" class="difflineminus">-nsMsgDBView::ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3741"></a><span id="l1.3741" class="difflineminus">-                                             nsMsgViewIndex* indices,</span>
<a href="#l1.3742"></a><span id="l1.3742" class="difflineminus">-                                             int32_t numIndices,</span>
<a href="#l1.3743"></a><span id="l1.3743" class="difflineminus">-                                             nsIMsgFolder *destFolder)</span>
<a href="#l1.3744"></a><span id="l1.3744" class="difflineminus">-{</span>
<a href="#l1.3745"></a><span id="l1.3745" class="difflineplus">+nsresult nsMsgDBView::ApplyCommandToIndicesWithFolder(</span>
<a href="#l1.3746"></a><span id="l1.3746" class="difflineplus">+    nsMsgViewCommandTypeValue command, nsMsgViewIndex *indices,</span>
<a href="#l1.3747"></a><span id="l1.3747" class="difflineplus">+    int32_t numIndices, nsIMsgFolder *destFolder) {</span>
<a href="#l1.3748"></a><span id="l1.3748">   nsresult rv = NS_OK;</span>
<a href="#l1.3749"></a><span id="l1.3749">   NS_ENSURE_ARG_POINTER(destFolder);</span>
<a href="#l1.3750"></a><span id="l1.3750"> </span>
<a href="#l1.3751"></a><span id="l1.3751">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3752"></a><span id="l1.3752" class="difflineminus">-  switch (command)</span>
<a href="#l1.3753"></a><span id="l1.3753" class="difflineminus">-  {</span>
<a href="#l1.3754"></a><span id="l1.3754" class="difflineplus">+  switch (command) {</span>
<a href="#l1.3755"></a><span id="l1.3755">     case nsMsgViewCommandType::copyMessages:</span>
<a href="#l1.3756"></a><span id="l1.3756">       NS_ASSERTION(!(m_folder == destFolder),</span>
<a href="#l1.3757"></a><span id="l1.3757">                    &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3758"></a><span id="l1.3758">       if (m_folder != destFolder)</span>
<a href="#l1.3759"></a><span id="l1.3759" class="difflineminus">-        rv = CopyMessages(msgWindow, indices, numIndices, false /* isMove */, destFolder);</span>
<a href="#l1.3760"></a><span id="l1.3760" class="difflineplus">+        rv = CopyMessages(msgWindow, indices, numIndices, false /* isMove */,</span>
<a href="#l1.3761"></a><span id="l1.3761" class="difflineplus">+                          destFolder);</span>
<a href="#l1.3762"></a><span id="l1.3762"> </span>
<a href="#l1.3763"></a><span id="l1.3763">       break;</span>
<a href="#l1.3764"></a><span id="l1.3764">     case nsMsgViewCommandType::moveMessages:</span>
<a href="#l1.3765"></a><span id="l1.3765">       NS_ASSERTION(!(m_folder == destFolder),</span>
<a href="#l1.3766"></a><span id="l1.3766">                    &quot;The source folder and the destination folder are the same&quot;);</span>
<a href="#l1.3767"></a><span id="l1.3767">       if (m_folder != destFolder)</span>
<a href="#l1.3768"></a><span id="l1.3768" class="difflineminus">-        rv = CopyMessages(msgWindow, indices, numIndices, true /* isMove */, destFolder);</span>
<a href="#l1.3769"></a><span id="l1.3769" class="difflineplus">+        rv = CopyMessages(msgWindow, indices, numIndices, true /* isMove */,</span>
<a href="#l1.3770"></a><span id="l1.3770" class="difflineplus">+                          destFolder);</span>
<a href="#l1.3771"></a><span id="l1.3771"> </span>
<a href="#l1.3772"></a><span id="l1.3772">       break;</span>
<a href="#l1.3773"></a><span id="l1.3773">     default:</span>
<a href="#l1.3774"></a><span id="l1.3774">       NS_ASSERTION(false, &quot;unhandled command&quot;);</span>
<a href="#l1.3775"></a><span id="l1.3775">       rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.3776"></a><span id="l1.3776">       break;</span>
<a href="#l1.3777"></a><span id="l1.3777">   }</span>
<a href="#l1.3778"></a><span id="l1.3778"> </span>
<a href="#l1.3779"></a><span id="l1.3779">   return rv;</span>
<a href="#l1.3780"></a><span id="l1.3780"> }</span>
<a href="#l1.3781"></a><span id="l1.3781"> </span>
<a href="#l1.3782"></a><span id="l1.3782" class="difflineminus">-nsresult</span>
<a href="#l1.3783"></a><span id="l1.3783" class="difflineminus">-nsMsgDBView::ApplyCommandToIndices(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3784"></a><span id="l1.3784" class="difflineminus">-                                   nsMsgViewIndex* indices,</span>
<a href="#l1.3785"></a><span id="l1.3785" class="difflineminus">-                                   int32_t numIndices)</span>
<a href="#l1.3786"></a><span id="l1.3786" class="difflineminus">-{</span>
<a href="#l1.3787"></a><span id="l1.3787" class="difflineplus">+nsresult nsMsgDBView::ApplyCommandToIndices(nsMsgViewCommandTypeValue command,</span>
<a href="#l1.3788"></a><span id="l1.3788" class="difflineplus">+                                            nsMsgViewIndex *indices,</span>
<a href="#l1.3789"></a><span id="l1.3789" class="difflineplus">+                                            int32_t numIndices) {</span>
<a href="#l1.3790"></a><span id="l1.3790">   NS_ASSERTION(numIndices &gt;= 0,</span>
<a href="#l1.3791"></a><span id="l1.3791">                &quot;nsMsgDBView::ApplyCommandToIndices(): numIndices is negative!&quot;);</span>
<a href="#l1.3792"></a><span id="l1.3792"> </span>
<a href="#l1.3793"></a><span id="l1.3793">   // Return quietly, just in case/</span>
<a href="#l1.3794"></a><span id="l1.3794" class="difflineminus">-  if (numIndices == 0)</span>
<a href="#l1.3795"></a><span id="l1.3795" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.3796"></a><span id="l1.3796" class="difflineplus">+  if (numIndices == 0) return NS_OK;</span>
<a href="#l1.3797"></a><span id="l1.3797"> </span>
<a href="#l1.3798"></a><span id="l1.3798">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.3799"></a><span id="l1.3799">   nsresult rv = GetFolderForViewIndex(indices[0], getter_AddRefs(folder));</span>
<a href="#l1.3800"></a><span id="l1.3800">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3801"></a><span id="l1.3801">   if (command == nsMsgViewCommandType::deleteMsg)</span>
<a href="#l1.3802"></a><span id="l1.3802">     return DeleteMessages(msgWindow, indices, numIndices, false);</span>
<a href="#l1.3803"></a><span id="l1.3803"> </span>
<a href="#l1.3804"></a><span id="l1.3804">   if (command == nsMsgViewCommandType::deleteNoTrash)</span>
<a href="#l1.3805"></a><span id="l1.3805">     return DeleteMessages(msgWindow, indices, numIndices, true);</span>
<a href="#l1.3806"></a><span id="l1.3806"> </span>
<a href="#l1.3807"></a><span id="l1.3807">   nsTArray&lt;nsMsgKey&gt; imapUids;</span>
<a href="#l1.3808"></a><span id="l1.3808" class="difflineminus">-  nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l1.3809"></a><span id="l1.3809" class="difflineplus">+  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l1.3810"></a><span id="l1.3810">   bool thisIsImapFolder = (imapFolder != nullptr);</span>
<a href="#l1.3811"></a><span id="l1.3811">   nsCOMPtr&lt;nsIJunkMailPlugin&gt; junkPlugin;</span>
<a href="#l1.3812"></a><span id="l1.3812"> </span>
<a href="#l1.3813"></a><span id="l1.3813">   // If this is a junk command, get the junk plugin.</span>
<a href="#l1.3814"></a><span id="l1.3814">   if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l1.3815"></a><span id="l1.3815" class="difflineminus">-      command == nsMsgViewCommandType::unjunk)</span>
<a href="#l1.3816"></a><span id="l1.3816" class="difflineminus">-  {</span>
<a href="#l1.3817"></a><span id="l1.3817" class="difflineplus">+      command == nsMsgViewCommandType::unjunk) {</span>
<a href="#l1.3818"></a><span id="l1.3818">     // Get the folder from the first item; we assume that</span>
<a href="#l1.3819"></a><span id="l1.3819">     // all messages in the view are from the same folder (no</span>
<a href="#l1.3820"></a><span id="l1.3820">     // more junk status column in the 'search messages' dialog</span>
<a href="#l1.3821"></a><span id="l1.3821">     // like in earlier versions...).</span>
<a href="#l1.3822"></a><span id="l1.3822">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.3823"></a><span id="l1.3823">     rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.3824"></a><span id="l1.3824">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3825"></a><span id="l1.3825"> </span>
<a href="#l1.3826"></a><span id="l1.3826">     nsCOMPtr&lt;nsIMsgFilterPlugin&gt; filterPlugin;</span>
<a href="#l1.3827"></a><span id="l1.3827">     rv = server-&gt;GetSpamFilterPlugin(getter_AddRefs(filterPlugin));</span>
<a href="#l1.3828"></a><span id="l1.3828">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3829"></a><span id="l1.3829"> </span>
<a href="#l1.3830"></a><span id="l1.3830">     junkPlugin = do_QueryInterface(filterPlugin, &amp;rv);</span>
<a href="#l1.3831"></a><span id="l1.3831">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3832"></a><span id="l1.3832" class="difflineminus">-    if (!mJunkHdrs)</span>
<a href="#l1.3833"></a><span id="l1.3833" class="difflineminus">-    {</span>
<a href="#l1.3834"></a><span id="l1.3834" class="difflineplus">+    if (!mJunkHdrs) {</span>
<a href="#l1.3835"></a><span id="l1.3835">       mJunkHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.3836"></a><span id="l1.3836" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.3837"></a><span id="l1.3837" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3838"></a><span id="l1.3838">     }</span>
<a href="#l1.3839"></a><span id="l1.3839">   }</span>
<a href="#l1.3840"></a><span id="l1.3840"> </span>
<a href="#l1.3841"></a><span id="l1.3841" class="difflineminus">-  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l1.3842"></a><span id="l1.3842" class="difflineplus">+  folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications,</span>
<a href="#l1.3843"></a><span id="l1.3843" class="difflineplus">+                              false);</span>
<a href="#l1.3844"></a><span id="l1.3844"> </span>
<a href="#l1.3845"></a><span id="l1.3845">   // No sense going through the code that handles messages in collasped threads</span>
<a href="#l1.3846"></a><span id="l1.3846">   // for mark thread read.</span>
<a href="#l1.3847"></a><span id="l1.3847" class="difflineminus">-  if (command == nsMsgViewCommandType::markThreadRead)</span>
<a href="#l1.3848"></a><span id="l1.3848" class="difflineminus">-  {</span>
<a href="#l1.3849"></a><span id="l1.3849" class="difflineplus">+  if (command == nsMsgViewCommandType::markThreadRead) {</span>
<a href="#l1.3850"></a><span id="l1.3850">     for (int32_t index = 0; index &lt; numIndices; index++)</span>
<a href="#l1.3851"></a><span id="l1.3851">       SetThreadOfMsgReadByIndex(indices[index], imapUids, true);</span>
<a href="#l1.3852"></a><span id="l1.3852" class="difflineminus">-  }</span>
<a href="#l1.3853"></a><span id="l1.3853" class="difflineminus">-  else</span>
<a href="#l1.3854"></a><span id="l1.3854" class="difflineminus">-  {</span>
<a href="#l1.3855"></a><span id="l1.3855" class="difflineplus">+  } else {</span>
<a href="#l1.3856"></a><span id="l1.3856">     // Turn the selection into an array of msg hdrs. This may include messages</span>
<a href="#l1.3857"></a><span id="l1.3857">     // in collapsed threads</span>
<a href="#l1.3858"></a><span id="l1.3858">     uint32_t length;</span>
<a href="#l1.3859"></a><span id="l1.3859" class="difflineminus">-    nsCOMPtr&lt;nsIMutableArray&gt; messages(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3860"></a><span id="l1.3860" class="difflineplus">+    nsCOMPtr&lt;nsIMutableArray&gt; messages(</span>
<a href="#l1.3861"></a><span id="l1.3861" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.3862"></a><span id="l1.3862">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3863"></a><span id="l1.3863">     rv = GetHeadersFromSelection(indices, numIndices, messages);</span>
<a href="#l1.3864"></a><span id="l1.3864">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.3865"></a><span id="l1.3865">     messages-&gt;GetLength(&amp;length);</span>
<a href="#l1.3866"></a><span id="l1.3866"> </span>
<a href="#l1.3867"></a><span id="l1.3867" class="difflineminus">-    if (thisIsImapFolder)</span>
<a href="#l1.3868"></a><span id="l1.3868" class="difflineminus">-      imapUids.SetLength(length);</span>
<a href="#l1.3869"></a><span id="l1.3869" class="difflineminus">-</span>
<a href="#l1.3870"></a><span id="l1.3870" class="difflineminus">-    for (uint32_t i = 0; i &lt; length; i++)</span>
<a href="#l1.3871"></a><span id="l1.3871" class="difflineminus">-    {</span>
<a href="#l1.3872"></a><span id="l1.3872" class="difflineplus">+    if (thisIsImapFolder) imapUids.SetLength(length);</span>
<a href="#l1.3873"></a><span id="l1.3873" class="difflineplus">+</span>
<a href="#l1.3874"></a><span id="l1.3874" class="difflineplus">+    for (uint32_t i = 0; i &lt; length; i++) {</span>
<a href="#l1.3875"></a><span id="l1.3875">       nsMsgKey msgKey;</span>
<a href="#l1.3876"></a><span id="l1.3876">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i);</span>
<a href="#l1.3877"></a><span id="l1.3877">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.3878"></a><span id="l1.3878" class="difflineminus">-      if (thisIsImapFolder)</span>
<a href="#l1.3879"></a><span id="l1.3879" class="difflineminus">-        imapUids[i] = msgKey;</span>
<a href="#l1.3880"></a><span id="l1.3880" class="difflineminus">-</span>
<a href="#l1.3881"></a><span id="l1.3881" class="difflineminus">-      switch (command)</span>
<a href="#l1.3882"></a><span id="l1.3882" class="difflineminus">-      {</span>
<a href="#l1.3883"></a><span id="l1.3883" class="difflineplus">+      if (thisIsImapFolder) imapUids[i] = msgKey;</span>
<a href="#l1.3884"></a><span id="l1.3884" class="difflineplus">+</span>
<a href="#l1.3885"></a><span id="l1.3885" class="difflineplus">+      switch (command) {</span>
<a href="#l1.3886"></a><span id="l1.3886">         case nsMsgViewCommandType::junk:</span>
<a href="#l1.3887"></a><span id="l1.3887">           mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3888"></a><span id="l1.3888">           mJunkHdrs-&gt;AppendElement(msgHdr);</span>
<a href="#l1.3889"></a><span id="l1.3889">           rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l1.3890"></a><span id="l1.3890">                                    nsIJunkMailPlugin::JUNK);</span>
<a href="#l1.3891"></a><span id="l1.3891">           break;</span>
<a href="#l1.3892"></a><span id="l1.3892">         case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3893"></a><span id="l1.3893">           mNumMessagesRemainingInBatch++;</span>
<a href="#l1.3894"></a><span id="l1.3894" class="difflineat">@@ -3389,233 +2939,200 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l1.3895"></a><span id="l1.3895">           // This is completely handled in the code below.</span>
<a href="#l1.3896"></a><span id="l1.3896">           break;</span>
<a href="#l1.3897"></a><span id="l1.3897">         default:</span>
<a href="#l1.3898"></a><span id="l1.3898">           NS_ERROR(&quot;unhandled command&quot;);</span>
<a href="#l1.3899"></a><span id="l1.3899">           break;</span>
<a href="#l1.3900"></a><span id="l1.3900">       }</span>
<a href="#l1.3901"></a><span id="l1.3901">     }</span>
<a href="#l1.3902"></a><span id="l1.3902"> </span>
<a href="#l1.3903"></a><span id="l1.3903" class="difflineminus">-    switch (command)</span>
<a href="#l1.3904"></a><span id="l1.3904" class="difflineminus">-    {</span>
<a href="#l1.3905"></a><span id="l1.3905" class="difflineminus">-      case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l1.3906"></a><span id="l1.3906" class="difflineminus">-      {</span>
<a href="#l1.3907"></a><span id="l1.3907" class="difflineplus">+    switch (command) {</span>
<a href="#l1.3908"></a><span id="l1.3908" class="difflineplus">+      case nsMsgViewCommandType::toggleMessageRead: {</span>
<a href="#l1.3909"></a><span id="l1.3909">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, 0);</span>
<a href="#l1.3910"></a><span id="l1.3910" class="difflineminus">-        if (!msgHdr)</span>
<a href="#l1.3911"></a><span id="l1.3911" class="difflineminus">-          break;</span>
<a href="#l1.3912"></a><span id="l1.3912" class="difflineplus">+        if (!msgHdr) break;</span>
<a href="#l1.3913"></a><span id="l1.3913"> </span>
<a href="#l1.3914"></a><span id="l1.3914">         uint32_t msgFlags;</span>
<a href="#l1.3915"></a><span id="l1.3915">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.3916"></a><span id="l1.3916">         folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l1.3917"></a><span id="l1.3917">                                  !(msgFlags &amp; nsMsgMessageFlags::Read));</span>
<a href="#l1.3918"></a><span id="l1.3918">         break;</span>
<a href="#l1.3919"></a><span id="l1.3919">       }</span>
<a href="#l1.3920"></a><span id="l1.3920">       case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l1.3921"></a><span id="l1.3921">       case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l1.3922"></a><span id="l1.3922" class="difflineminus">-        folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l1.3923"></a><span id="l1.3923" class="difflineminus">-                                 command == nsMsgViewCommandType::markMessagesRead);</span>
<a href="#l1.3924"></a><span id="l1.3924" class="difflineplus">+        folder-&gt;MarkMessagesRead(</span>
<a href="#l1.3925"></a><span id="l1.3925" class="difflineplus">+            messages, command == nsMsgViewCommandType::markMessagesRead);</span>
<a href="#l1.3926"></a><span id="l1.3926">         break;</span>
<a href="#l1.3927"></a><span id="l1.3927">       case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l1.3928"></a><span id="l1.3928">       case nsMsgViewCommandType::flagMessages:</span>
<a href="#l1.3929"></a><span id="l1.3929" class="difflineminus">-        folder-&gt;MarkMessagesFlagged(messages,</span>
<a href="#l1.3930"></a><span id="l1.3930" class="difflineminus">-                                    command == nsMsgViewCommandType::flagMessages);</span>
<a href="#l1.3931"></a><span id="l1.3931" class="difflineplus">+        folder-&gt;MarkMessagesFlagged(</span>
<a href="#l1.3932"></a><span id="l1.3932" class="difflineplus">+            messages, command == nsMsgViewCommandType::flagMessages);</span>
<a href="#l1.3933"></a><span id="l1.3933">         break;</span>
<a href="#l1.3934"></a><span id="l1.3934">       default:</span>
<a href="#l1.3935"></a><span id="l1.3935">         break;</span>
<a href="#l1.3936"></a><span id="l1.3936" class="difflineminus">-</span>
<a href="#l1.3937"></a><span id="l1.3937">     }</span>
<a href="#l1.3938"></a><span id="l1.3938"> </span>
<a href="#l1.3939"></a><span id="l1.3939">     // Provide junk-related batch notifications.</span>
<a href="#l1.3940"></a><span id="l1.3940">     if (command == nsMsgViewCommandType::junk ||</span>
<a href="#l1.3941"></a><span id="l1.3941" class="difflineminus">-        command == nsMsgViewCommandType::unjunk)</span>
<a href="#l1.3942"></a><span id="l1.3942" class="difflineminus">-    {</span>
<a href="#l1.3943"></a><span id="l1.3943" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l1.3944"></a><span id="l1.3944" class="difflineminus">-        notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l1.3945"></a><span id="l1.3945" class="difflineplus">+        command == nsMsgViewCommandType::unjunk) {</span>
<a href="#l1.3946"></a><span id="l1.3946" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l1.3947"></a><span id="l1.3947" class="difflineplus">+          do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l1.3948"></a><span id="l1.3948"> </span>
<a href="#l1.3949"></a><span id="l1.3949">       if (notifier)</span>
<a href="#l1.3950"></a><span id="l1.3950" class="difflineminus">-        notifier-&gt;NotifyItemEvent(messages,</span>
<a href="#l1.3951"></a><span id="l1.3951" class="difflineminus">-                                  NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;),</span>
<a href="#l1.3952"></a><span id="l1.3952" class="difflineminus">-                                  nullptr,</span>
<a href="#l1.3953"></a><span id="l1.3953" class="difflineminus">-                                  (command == nsMsgViewCommandType::junk)</span>
<a href="#l1.3954"></a><span id="l1.3954" class="difflineminus">-                                  ? NS_LITERAL_CSTRING(&quot;junk&quot;)</span>
<a href="#l1.3955"></a><span id="l1.3955" class="difflineminus">-                                  : NS_LITERAL_CSTRING(&quot;notjunk&quot;));</span>
<a href="#l1.3956"></a><span id="l1.3956" class="difflineplus">+        notifier-&gt;NotifyItemEvent(</span>
<a href="#l1.3957"></a><span id="l1.3957" class="difflineplus">+            messages, NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;), nullptr,</span>
<a href="#l1.3958"></a><span id="l1.3958" class="difflineplus">+            (command == nsMsgViewCommandType::junk)</span>
<a href="#l1.3959"></a><span id="l1.3959" class="difflineplus">+                ? NS_LITERAL_CSTRING(&quot;junk&quot;)</span>
<a href="#l1.3960"></a><span id="l1.3960" class="difflineplus">+                : NS_LITERAL_CSTRING(&quot;notjunk&quot;));</span>
<a href="#l1.3961"></a><span id="l1.3961">     }</span>
<a href="#l1.3962"></a><span id="l1.3962">   }</span>
<a href="#l1.3963"></a><span id="l1.3963"> </span>
<a href="#l1.3964"></a><span id="l1.3964">   folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l1.3965"></a><span id="l1.3965"> </span>
<a href="#l1.3966"></a><span id="l1.3966" class="difflineminus">-  if (thisIsImapFolder)</span>
<a href="#l1.3967"></a><span id="l1.3967" class="difflineminus">-  {</span>
<a href="#l1.3968"></a><span id="l1.3968" class="difflineplus">+  if (thisIsImapFolder) {</span>
<a href="#l1.3969"></a><span id="l1.3969">     imapMessageFlagsType flags = kNoImapMsgFlag;</span>
<a href="#l1.3970"></a><span id="l1.3970">     bool addFlags = false;</span>
<a href="#l1.3971"></a><span id="l1.3971">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.3972"></a><span id="l1.3972" class="difflineminus">-    switch (command)</span>
<a href="#l1.3973"></a><span id="l1.3973" class="difflineminus">-    {</span>
<a href="#l1.3974"></a><span id="l1.3974" class="difflineplus">+    switch (command) {</span>
<a href="#l1.3975"></a><span id="l1.3975">       case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l1.3976"></a><span id="l1.3976">         flags |= kImapMsgSeenFlag;</span>
<a href="#l1.3977"></a><span id="l1.3977">         addFlags = true;</span>
<a href="#l1.3978"></a><span id="l1.3978">         break;</span>
<a href="#l1.3979"></a><span id="l1.3979">       case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l1.3980"></a><span id="l1.3980">         flags = kImapMsgDeletedFlag;</span>
<a href="#l1.3981"></a><span id="l1.3981">         addFlags = false;</span>
<a href="#l1.3982"></a><span id="l1.3982">         break;</span>
<a href="#l1.3983"></a><span id="l1.3983">       case nsMsgViewCommandType::junk:</span>
<a href="#l1.3984"></a><span id="l1.3984" class="difflineminus">-        return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l1.3985"></a><span id="l1.3985" class="difflineminus">-                                               NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.3986"></a><span id="l1.3986" class="difflineminus">-                                               NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.3987"></a><span id="l1.3987" class="difflineminus">-                                               imapUids.Elements(),</span>
<a href="#l1.3988"></a><span id="l1.3988" class="difflineminus">-                                               imapUids.Length(),</span>
<a href="#l1.3989"></a><span id="l1.3989" class="difflineminus">-                                               nullptr);</span>
<a href="#l1.3990"></a><span id="l1.3990" class="difflineminus">-      case nsMsgViewCommandType::unjunk:</span>
<a href="#l1.3991"></a><span id="l1.3991" class="difflineminus">-      {</span>
<a href="#l1.3992"></a><span id="l1.3992" class="difflineplus">+        return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l1.3993"></a><span id="l1.3993" class="difflineplus">+            msgWindow, NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.3994"></a><span id="l1.3994" class="difflineplus">+            NS_LITERAL_CSTRING(&quot;NonJunk&quot;), imapUids.Elements(),</span>
<a href="#l1.3995"></a><span id="l1.3995" class="difflineplus">+            imapUids.Length(), nullptr);</span>
<a href="#l1.3996"></a><span id="l1.3996" class="difflineplus">+      case nsMsgViewCommandType::unjunk: {</span>
<a href="#l1.3997"></a><span id="l1.3997">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.3998"></a><span id="l1.3998">         GetHdrForFirstSelectedMessage(getter_AddRefs(msgHdr));</span>
<a href="#l1.3999"></a><span id="l1.3999">         uint32_t msgFlags = 0;</span>
<a href="#l1.4000"></a><span id="l1.4000" class="difflineminus">-        if (msgHdr)</span>
<a href="#l1.4001"></a><span id="l1.4001" class="difflineminus">-          msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.4002"></a><span id="l1.4002" class="difflineplus">+        if (msgHdr) msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.4003"></a><span id="l1.4003"> </span>
<a href="#l1.4004"></a><span id="l1.4004">         if (msgFlags &amp; nsMsgMessageFlags::IMAPDeleted)</span>
<a href="#l1.4005"></a><span id="l1.4005" class="difflineminus">-          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag,</span>
<a href="#l1.4006"></a><span id="l1.4006" class="difflineminus">-                                     false,</span>
<a href="#l1.4007"></a><span id="l1.4007" class="difflineminus">-                                     imapUids.Elements(),</span>
<a href="#l1.4008"></a><span id="l1.4008" class="difflineminus">-                                     imapUids.Length(),</span>
<a href="#l1.4009"></a><span id="l1.4009" class="difflineplus">+          imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false,</span>
<a href="#l1.4010"></a><span id="l1.4010" class="difflineplus">+                                     imapUids.Elements(), imapUids.Length(),</span>
<a href="#l1.4011"></a><span id="l1.4011">                                      nullptr);</span>
<a href="#l1.4012"></a><span id="l1.4012"> </span>
<a href="#l1.4013"></a><span id="l1.4013" class="difflineminus">-        return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l1.4014"></a><span id="l1.4014" class="difflineminus">-                                               NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.4015"></a><span id="l1.4015" class="difflineminus">-                                               NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l1.4016"></a><span id="l1.4016" class="difflineminus">-                                               imapUids.Elements(),</span>
<a href="#l1.4017"></a><span id="l1.4017" class="difflineminus">-                                               imapUids.Length(),</span>
<a href="#l1.4018"></a><span id="l1.4018" class="difflineminus">-                                               nullptr);</span>
<a href="#l1.4019"></a><span id="l1.4019" class="difflineplus">+        return imapFolder-&gt;StoreCustomKeywords(</span>
<a href="#l1.4020"></a><span id="l1.4020" class="difflineplus">+            msgWindow, NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span>
<a href="#l1.4021"></a><span id="l1.4021" class="difflineplus">+            NS_LITERAL_CSTRING(&quot;Junk&quot;), imapUids.Elements(), imapUids.Length(),</span>
<a href="#l1.4022"></a><span id="l1.4022" class="difflineplus">+            nullptr);</span>
<a href="#l1.4023"></a><span id="l1.4023">       }</span>
<a href="#l1.4024"></a><span id="l1.4024">       default:</span>
<a href="#l1.4025"></a><span id="l1.4025">         break;</span>
<a href="#l1.4026"></a><span id="l1.4026">     }</span>
<a href="#l1.4027"></a><span id="l1.4027"> </span>
<a href="#l1.4028"></a><span id="l1.4028">     // Can't get here without thisIsImapThreadPane == TRUE.</span>
<a href="#l1.4029"></a><span id="l1.4029" class="difflineminus">-    if (flags != kNoImapMsgFlag)</span>
<a href="#l1.4030"></a><span id="l1.4030" class="difflineminus">-    {</span>
<a href="#l1.4031"></a><span id="l1.4031" class="difflineminus">-      imapFolder-&gt;StoreImapFlags(flags,</span>
<a href="#l1.4032"></a><span id="l1.4032" class="difflineminus">-                                 addFlags,</span>
<a href="#l1.4033"></a><span id="l1.4033" class="difflineminus">-                                 imapUids.Elements(),</span>
<a href="#l1.4034"></a><span id="l1.4034" class="difflineminus">-                                 imapUids.Length(),</span>
<a href="#l1.4035"></a><span id="l1.4035" class="difflineminus">-                                 nullptr);</span>
<a href="#l1.4036"></a><span id="l1.4036" class="difflineplus">+    if (flags != kNoImapMsgFlag) {</span>
<a href="#l1.4037"></a><span id="l1.4037" class="difflineplus">+      imapFolder-&gt;StoreImapFlags(flags, addFlags, imapUids.Elements(),</span>
<a href="#l1.4038"></a><span id="l1.4038" class="difflineplus">+                                 imapUids.Length(), nullptr);</span>
<a href="#l1.4039"></a><span id="l1.4039">     }</span>
<a href="#l1.4040"></a><span id="l1.4040">   }</span>
<a href="#l1.4041"></a><span id="l1.4041"> </span>
<a href="#l1.4042"></a><span id="l1.4042">   return rv;</span>
<a href="#l1.4043"></a><span id="l1.4043"> }</span>
<a href="#l1.4044"></a><span id="l1.4044"> </span>
<a href="#l1.4045"></a><span id="l1.4045"> /**</span>
<a href="#l1.4046"></a><span id="l1.4046">  * View modifications methods by index.</span>
<a href="#l1.4047"></a><span id="l1.4047">  */</span>
<a href="#l1.4048"></a><span id="l1.4048"> </span>
<a href="#l1.4049"></a><span id="l1.4049"> // This method just removes the specified line from the view. It does</span>
<a href="#l1.4050"></a><span id="l1.4050"> // NOT delete it from the database.</span>
<a href="#l1.4051"></a><span id="l1.4051" class="difflineminus">-nsresult</span>
<a href="#l1.4052"></a><span id="l1.4052" class="difflineminus">-nsMsgDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4053"></a><span id="l1.4053" class="difflineminus">-{</span>
<a href="#l1.4054"></a><span id="l1.4054" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.4055"></a><span id="l1.4055" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4056"></a><span id="l1.4056" class="difflineplus">+nsresult nsMsgDBView::RemoveByIndex(nsMsgViewIndex index) {</span>
<a href="#l1.4057"></a><span id="l1.4057" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4058"></a><span id="l1.4058"> </span>
<a href="#l1.4059"></a><span id="l1.4059">   m_keys.RemoveElementAt(index);</span>
<a href="#l1.4060"></a><span id="l1.4060">   m_flags.RemoveElementAt(index);</span>
<a href="#l1.4061"></a><span id="l1.4061">   m_levels.RemoveElementAt(index);</span>
<a href="#l1.4062"></a><span id="l1.4062"> </span>
<a href="#l1.4063"></a><span id="l1.4063">   // The call to NoteChange() has to happen after we remove the key as</span>
<a href="#l1.4064"></a><span id="l1.4064">   // NoteChange() will call RowCountChanged() which will call our GetRowCount().</span>
<a href="#l1.4065"></a><span id="l1.4065">   // An example where view is not the listener - D&amp;D messages.</span>
<a href="#l1.4066"></a><span id="l1.4066">   if (!m_deletingRows)</span>
<a href="#l1.4067"></a><span id="l1.4067">     NoteChange(index, -1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.4068"></a><span id="l1.4068"> </span>
<a href="#l1.4069"></a><span id="l1.4069">   return NS_OK;</span>
<a href="#l1.4070"></a><span id="l1.4070"> }</span>
<a href="#l1.4071"></a><span id="l1.4071"> </span>
<a href="#l1.4072"></a><span id="l1.4072" class="difflineminus">-nsresult</span>
<a href="#l1.4073"></a><span id="l1.4073" class="difflineminus">-nsMsgDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l1.4074"></a><span id="l1.4074" class="difflineminus">-                            nsMsgViewIndex *indices,</span>
<a href="#l1.4075"></a><span id="l1.4075" class="difflineminus">-                            int32_t numIndices,</span>
<a href="#l1.4076"></a><span id="l1.4076" class="difflineminus">-                            bool deleteStorage)</span>
<a href="#l1.4077"></a><span id="l1.4077" class="difflineminus">-{</span>
<a href="#l1.4078"></a><span id="l1.4078" class="difflineminus">-  if (m_deletingRows)</span>
<a href="#l1.4079"></a><span id="l1.4079" class="difflineminus">-  {</span>
<a href="#l1.4080"></a><span id="l1.4080" class="difflineplus">+nsresult nsMsgDBView::DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l1.4081"></a><span id="l1.4081" class="difflineplus">+                                     nsMsgViewIndex *indices,</span>
<a href="#l1.4082"></a><span id="l1.4082" class="difflineplus">+                                     int32_t numIndices, bool deleteStorage) {</span>
<a href="#l1.4083"></a><span id="l1.4083" class="difflineplus">+  if (m_deletingRows) {</span>
<a href="#l1.4084"></a><span id="l1.4084">     NS_WARNING(&quot;Last delete did not complete&quot;);</span>
<a href="#l1.4085"></a><span id="l1.4085">     return NS_OK;</span>
<a href="#l1.4086"></a><span id="l1.4086">   }</span>
<a href="#l1.4087"></a><span id="l1.4087"> </span>
<a href="#l1.4088"></a><span id="l1.4088">   nsresult rv;</span>
<a href="#l1.4089"></a><span id="l1.4089" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.4090"></a><span id="l1.4090" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l1.4091"></a><span id="l1.4091" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l1.4092"></a><span id="l1.4092">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4093"></a><span id="l1.4093">   rv = GetHeadersFromSelection(indices, numIndices, messageArray);</span>
<a href="#l1.4094"></a><span id="l1.4094">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4095"></a><span id="l1.4095">   uint32_t numMsgs;</span>
<a href="#l1.4096"></a><span id="l1.4096">   messageArray-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l1.4097"></a><span id="l1.4097"> </span>
<a href="#l1.4098"></a><span id="l1.4098">   const char *warnCollapsedPref = &quot;mail.warn_on_collapsed_thread_operation&quot;;</span>
<a href="#l1.4099"></a><span id="l1.4099">   const char *warnShiftDelPref = &quot;mail.warn_on_shift_delete&quot;;</span>
<a href="#l1.4100"></a><span id="l1.4100">   const char *warnNewsPref = &quot;news.warn_on_delete&quot;;</span>
<a href="#l1.4101"></a><span id="l1.4101">   const char *warnTrashDelPref = &quot;mail.warn_on_delete_from_trash&quot;;</span>
<a href="#l1.4102"></a><span id="l1.4102">   const char *activePref = nullptr;</span>
<a href="#l1.4103"></a><span id="l1.4103">   nsString warningName;</span>
<a href="#l1.4104"></a><span id="l1.4104" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.4105"></a><span id="l1.4105" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l1.4106"></a><span id="l1.4106" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.4107"></a><span id="l1.4107">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4108"></a><span id="l1.4108"> </span>
<a href="#l1.4109"></a><span id="l1.4109">   bool trashFolder = false;</span>
<a href="#l1.4110"></a><span id="l1.4110">   rv = m_folder-&gt;GetFlag(nsMsgFolderFlags::Trash, &amp;trashFolder);</span>
<a href="#l1.4111"></a><span id="l1.4111">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4112"></a><span id="l1.4112"> </span>
<a href="#l1.4113"></a><span id="l1.4113" class="difflineminus">-  if (trashFolder)</span>
<a href="#l1.4114"></a><span id="l1.4114" class="difflineminus">-  {</span>
<a href="#l1.4115"></a><span id="l1.4115" class="difflineplus">+  if (trashFolder) {</span>
<a href="#l1.4116"></a><span id="l1.4116">     bool pref = false;</span>
<a href="#l1.4117"></a><span id="l1.4117">     prefBranch-&gt;GetBoolPref(warnTrashDelPref, &amp;pref);</span>
<a href="#l1.4118"></a><span id="l1.4118" class="difflineminus">-    if (pref)</span>
<a href="#l1.4119"></a><span id="l1.4119" class="difflineminus">-    {</span>
<a href="#l1.4120"></a><span id="l1.4120" class="difflineplus">+    if (pref) {</span>
<a href="#l1.4121"></a><span id="l1.4121">       activePref = warnTrashDelPref;</span>
<a href="#l1.4122"></a><span id="l1.4122">       warningName.AssignLiteral(&quot;confirmMsgDelete.deleteFromTrash.desc&quot;);</span>
<a href="#l1.4123"></a><span id="l1.4123">     }</span>
<a href="#l1.4124"></a><span id="l1.4124">   }</span>
<a href="#l1.4125"></a><span id="l1.4125"> </span>
<a href="#l1.4126"></a><span id="l1.4126" class="difflineminus">-  if (!activePref &amp;&amp; (uint32_t(numIndices) != numMsgs))</span>
<a href="#l1.4127"></a><span id="l1.4127" class="difflineminus">-  {</span>
<a href="#l1.4128"></a><span id="l1.4128" class="difflineplus">+  if (!activePref &amp;&amp; (uint32_t(numIndices) != numMsgs)) {</span>
<a href="#l1.4129"></a><span id="l1.4129">     bool pref = false;</span>
<a href="#l1.4130"></a><span id="l1.4130">     prefBranch-&gt;GetBoolPref(warnCollapsedPref, &amp;pref);</span>
<a href="#l1.4131"></a><span id="l1.4131" class="difflineminus">-    if (pref)</span>
<a href="#l1.4132"></a><span id="l1.4132" class="difflineminus">-    {</span>
<a href="#l1.4133"></a><span id="l1.4133" class="difflineplus">+    if (pref) {</span>
<a href="#l1.4134"></a><span id="l1.4134">       activePref = warnCollapsedPref;</span>
<a href="#l1.4135"></a><span id="l1.4135">       warningName.AssignLiteral(&quot;confirmMsgDelete.collapsed.desc&quot;);</span>
<a href="#l1.4136"></a><span id="l1.4136">     }</span>
<a href="#l1.4137"></a><span id="l1.4137">   }</span>
<a href="#l1.4138"></a><span id="l1.4138"> </span>
<a href="#l1.4139"></a><span id="l1.4139" class="difflineminus">-  if (!activePref &amp;&amp; deleteStorage &amp;&amp; !trashFolder)</span>
<a href="#l1.4140"></a><span id="l1.4140" class="difflineminus">-  {</span>
<a href="#l1.4141"></a><span id="l1.4141" class="difflineplus">+  if (!activePref &amp;&amp; deleteStorage &amp;&amp; !trashFolder) {</span>
<a href="#l1.4142"></a><span id="l1.4142">     bool pref = false;</span>
<a href="#l1.4143"></a><span id="l1.4143">     prefBranch-&gt;GetBoolPref(warnShiftDelPref, &amp;pref);</span>
<a href="#l1.4144"></a><span id="l1.4144" class="difflineminus">-    if (pref)</span>
<a href="#l1.4145"></a><span id="l1.4145" class="difflineminus">-    {</span>
<a href="#l1.4146"></a><span id="l1.4146" class="difflineplus">+    if (pref) {</span>
<a href="#l1.4147"></a><span id="l1.4147">       activePref = warnShiftDelPref;</span>
<a href="#l1.4148"></a><span id="l1.4148">       warningName.AssignLiteral(&quot;confirmMsgDelete.deleteNoTrash.desc&quot;);</span>
<a href="#l1.4149"></a><span id="l1.4149">     }</span>
<a href="#l1.4150"></a><span id="l1.4150">   }</span>
<a href="#l1.4151"></a><span id="l1.4151"> </span>
<a href="#l1.4152"></a><span id="l1.4152" class="difflineminus">-  if (!activePref &amp;&amp; mIsNews)</span>
<a href="#l1.4153"></a><span id="l1.4153" class="difflineminus">-  {</span>
<a href="#l1.4154"></a><span id="l1.4154" class="difflineplus">+  if (!activePref &amp;&amp; mIsNews) {</span>
<a href="#l1.4155"></a><span id="l1.4155">     bool pref = false;</span>
<a href="#l1.4156"></a><span id="l1.4156">     prefBranch-&gt;GetBoolPref(warnNewsPref, &amp;pref);</span>
<a href="#l1.4157"></a><span id="l1.4157" class="difflineminus">-    if (pref)</span>
<a href="#l1.4158"></a><span id="l1.4158" class="difflineminus">-    {</span>
<a href="#l1.4159"></a><span id="l1.4159" class="difflineplus">+    if (pref) {</span>
<a href="#l1.4160"></a><span id="l1.4160">       activePref = warnNewsPref;</span>
<a href="#l1.4161"></a><span id="l1.4161">       warningName.AssignLiteral(&quot;confirmMsgDelete.deleteNoTrash.desc&quot;);</span>
<a href="#l1.4162"></a><span id="l1.4162">     }</span>
<a href="#l1.4163"></a><span id="l1.4163">   }</span>
<a href="#l1.4164"></a><span id="l1.4164"> </span>
<a href="#l1.4165"></a><span id="l1.4165" class="difflineminus">-  if (activePref)</span>
<a href="#l1.4166"></a><span id="l1.4166" class="difflineminus">-  {</span>
<a href="#l1.4167"></a><span id="l1.4167" class="difflineplus">+  if (activePref) {</span>
<a href="#l1.4168"></a><span id="l1.4168">     nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l1.4169"></a><span id="l1.4169"> </span>
<a href="#l1.4170"></a><span id="l1.4170" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l1.4171"></a><span id="l1.4171" class="difflineplus">+    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(</span>
<a href="#l1.4172"></a><span id="l1.4172" class="difflineplus">+        do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l1.4173"></a><span id="l1.4173">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4174"></a><span id="l1.4174"> </span>
<a href="#l1.4175"></a><span id="l1.4175">     rv = wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l1.4176"></a><span id="l1.4176">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4177"></a><span id="l1.4177">     // &quot;Don't ask...&quot; - unchecked by default.</span>
<a href="#l1.4178"></a><span id="l1.4178">     bool dontAsk = false;</span>
<a href="#l1.4179"></a><span id="l1.4179">     int32_t buttonPressed = 0;</span>
<a href="#l1.4180"></a><span id="l1.4180"> </span>
<a href="#l1.4181"></a><span id="l1.4181" class="difflineat">@@ -3625,263 +3142,225 @@ nsMsgDBView::DeleteMessages(nsIMsgWindow</span>
<a href="#l1.4182"></a><span id="l1.4182">     nsString buttonApplyNowText;</span>
<a href="#l1.4183"></a><span id="l1.4183">     dialogTitle.Adopt(GetString(u&quot;confirmMsgDelete.title&quot;));</span>
<a href="#l1.4184"></a><span id="l1.4184">     checkboxText.Adopt(GetString(u&quot;confirmMsgDelete.dontAsk.label&quot;));</span>
<a href="#l1.4185"></a><span id="l1.4185">     buttonApplyNowText.Adopt(GetString(u&quot;confirmMsgDelete.delete.label&quot;));</span>
<a href="#l1.4186"></a><span id="l1.4186"> </span>
<a href="#l1.4187"></a><span id="l1.4187">     confirmString.Adopt(GetString(warningName.get()));</span>
<a href="#l1.4188"></a><span id="l1.4188"> </span>
<a href="#l1.4189"></a><span id="l1.4189">     const uint32_t buttonFlags =</span>
<a href="#l1.4190"></a><span id="l1.4190" class="difflineminus">-      (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l1.4191"></a><span id="l1.4191" class="difflineminus">-      (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l1.4192"></a><span id="l1.4192" class="difflineplus">+        (nsIPrompt::BUTTON_TITLE_IS_STRING * nsIPrompt::BUTTON_POS_0) +</span>
<a href="#l1.4193"></a><span id="l1.4193" class="difflineplus">+        (nsIPrompt::BUTTON_TITLE_CANCEL * nsIPrompt::BUTTON_POS_1);</span>
<a href="#l1.4194"></a><span id="l1.4194"> </span>
<a href="#l1.4195"></a><span id="l1.4195">     rv = dialog-&gt;ConfirmEx(dialogTitle.get(), confirmString.get(), buttonFlags,</span>
<a href="#l1.4196"></a><span id="l1.4196">                            buttonApplyNowText.get(), nullptr, nullptr,</span>
<a href="#l1.4197"></a><span id="l1.4197">                            checkboxText.get(), &amp;dontAsk, &amp;buttonPressed);</span>
<a href="#l1.4198"></a><span id="l1.4198">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4199"></a><span id="l1.4199" class="difflineminus">-    if (buttonPressed)</span>
<a href="#l1.4200"></a><span id="l1.4200" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l1.4201"></a><span id="l1.4201" class="difflineminus">-</span>
<a href="#l1.4202"></a><span id="l1.4202" class="difflineminus">-    if (dontAsk)</span>
<a href="#l1.4203"></a><span id="l1.4203" class="difflineminus">-      prefBranch-&gt;SetBoolPref(activePref, false);</span>
<a href="#l1.4204"></a><span id="l1.4204" class="difflineminus">-  }</span>
<a href="#l1.4205"></a><span id="l1.4205" class="difflineminus">-</span>
<a href="#l1.4206"></a><span id="l1.4206" class="difflineminus">-  if (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4207"></a><span id="l1.4207" class="difflineminus">-    m_deletingRows = true;</span>
<a href="#l1.4208"></a><span id="l1.4208" class="difflineminus">-</span>
<a href="#l1.4209"></a><span id="l1.4209" class="difflineminus">-  if (m_deletingRows)</span>
<a href="#l1.4210"></a><span id="l1.4210" class="difflineminus">-    mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.4211"></a><span id="l1.4211" class="difflineminus">-</span>
<a href="#l1.4212"></a><span id="l1.4212" class="difflineminus">-  rv = m_folder-&gt;DeleteMessages(messageArray, window, deleteStorage,</span>
<a href="#l1.4213"></a><span id="l1.4213" class="difflineminus">-                                false, nullptr, true /* allow Undo */);</span>
<a href="#l1.4214"></a><span id="l1.4214" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.4215"></a><span id="l1.4215" class="difflineminus">-    m_deletingRows = false;</span>
<a href="#l1.4216"></a><span id="l1.4216" class="difflineplus">+    if (buttonPressed) return NS_ERROR_FAILURE;</span>
<a href="#l1.4217"></a><span id="l1.4217" class="difflineplus">+</span>
<a href="#l1.4218"></a><span id="l1.4218" class="difflineplus">+    if (dontAsk) prefBranch-&gt;SetBoolPref(activePref, false);</span>
<a href="#l1.4219"></a><span id="l1.4219" class="difflineplus">+  }</span>
<a href="#l1.4220"></a><span id="l1.4220" class="difflineplus">+</span>
<a href="#l1.4221"></a><span id="l1.4221" class="difflineplus">+  if (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete) m_deletingRows = true;</span>
<a href="#l1.4222"></a><span id="l1.4222" class="difflineplus">+</span>
<a href="#l1.4223"></a><span id="l1.4223" class="difflineplus">+  if (m_deletingRows) mIndicesToNoteChange.AppendElements(indices, numIndices);</span>
<a href="#l1.4224"></a><span id="l1.4224" class="difflineplus">+</span>
<a href="#l1.4225"></a><span id="l1.4225" class="difflineplus">+  rv = m_folder-&gt;DeleteMessages(messageArray, window, deleteStorage, false,</span>
<a href="#l1.4226"></a><span id="l1.4226" class="difflineplus">+                                nullptr, true /* allow Undo */);</span>
<a href="#l1.4227"></a><span id="l1.4227" class="difflineplus">+  if (NS_FAILED(rv)) m_deletingRows = false;</span>
<a href="#l1.4228"></a><span id="l1.4228"> </span>
<a href="#l1.4229"></a><span id="l1.4229">   return rv;</span>
<a href="#l1.4230"></a><span id="l1.4230"> }</span>
<a href="#l1.4231"></a><span id="l1.4231"> </span>
<a href="#l1.4232"></a><span id="l1.4232" class="difflineminus">-nsresult</span>
<a href="#l1.4233"></a><span id="l1.4233" class="difflineminus">-nsMsgDBView::DownloadForOffline(nsIMsgWindow *window,</span>
<a href="#l1.4234"></a><span id="l1.4234" class="difflineminus">-                                nsMsgViewIndex *indices,</span>
<a href="#l1.4235"></a><span id="l1.4235" class="difflineminus">-                                int32_t numIndices)</span>
<a href="#l1.4236"></a><span id="l1.4236" class="difflineminus">-{</span>
<a href="#l1.4237"></a><span id="l1.4237" class="difflineplus">+nsresult nsMsgDBView::DownloadForOffline(nsIMsgWindow *window,</span>
<a href="#l1.4238"></a><span id="l1.4238" class="difflineplus">+                                         nsMsgViewIndex *indices,</span>
<a href="#l1.4239"></a><span id="l1.4239" class="difflineplus">+                                         int32_t numIndices) {</span>
<a href="#l1.4240"></a><span id="l1.4240">   nsresult rv = NS_OK;</span>
<a href="#l1.4241"></a><span id="l1.4241" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4242"></a><span id="l1.4242" class="difflineminus">-  for (nsMsgViewIndex index = 0;</span>
<a href="#l1.4243"></a><span id="l1.4243" class="difflineminus">-       index &lt; (nsMsgViewIndex) numIndices;</span>
<a href="#l1.4244"></a><span id="l1.4244" class="difflineminus">-       index++)</span>
<a href="#l1.4245"></a><span id="l1.4245" class="difflineminus">-  {</span>
<a href="#l1.4246"></a><span id="l1.4246" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l1.4247"></a><span id="l1.4247" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4248"></a><span id="l1.4248" class="difflineplus">+  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex)numIndices; index++) {</span>
<a href="#l1.4249"></a><span id="l1.4249">     nsMsgKey key = m_keys[indices[index]];</span>
<a href="#l1.4250"></a><span id="l1.4250" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.4251"></a><span id="l1.4251" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.4252"></a><span id="l1.4252">     rv = m_db-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l1.4253"></a><span id="l1.4253" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4254"></a><span id="l1.4254" class="difflineminus">-    if (msgHdr)</span>
<a href="#l1.4255"></a><span id="l1.4255" class="difflineminus">-    {</span>
<a href="#l1.4256"></a><span id="l1.4256" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4257"></a><span id="l1.4257" class="difflineplus">+    if (msgHdr) {</span>
<a href="#l1.4258"></a><span id="l1.4258">       uint32_t flags;</span>
<a href="#l1.4259"></a><span id="l1.4259">       msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4260"></a><span id="l1.4260">       if (!(flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.4261"></a><span id="l1.4261">         messageArray-&gt;AppendElement(msgHdr);</span>
<a href="#l1.4262"></a><span id="l1.4262">     }</span>
<a href="#l1.4263"></a><span id="l1.4263">   }</span>
<a href="#l1.4264"></a><span id="l1.4264"> </span>
<a href="#l1.4265"></a><span id="l1.4265">   m_folder-&gt;DownloadMessagesForOffline(messageArray, window);</span>
<a href="#l1.4266"></a><span id="l1.4266">   return rv;</span>
<a href="#l1.4267"></a><span id="l1.4267"> }</span>
<a href="#l1.4268"></a><span id="l1.4268"> </span>
<a href="#l1.4269"></a><span id="l1.4269" class="difflineminus">-nsresult</span>
<a href="#l1.4270"></a><span id="l1.4270" class="difflineminus">-nsMsgDBView::DownloadFlaggedForOffline(nsIMsgWindow *window)</span>
<a href="#l1.4271"></a><span id="l1.4271" class="difflineminus">-{</span>
<a href="#l1.4272"></a><span id="l1.4272" class="difflineplus">+nsresult nsMsgDBView::DownloadFlaggedForOffline(nsIMsgWindow *window) {</span>
<a href="#l1.4273"></a><span id="l1.4273">   nsresult rv = NS_OK;</span>
<a href="#l1.4274"></a><span id="l1.4274" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4275"></a><span id="l1.4275" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.4276"></a><span id="l1.4276" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; messageArray(</span>
<a href="#l1.4277"></a><span id="l1.4277" class="difflineplus">+      do_CreateInstance(NS_ARRAY_CONTRACTID));</span>
<a href="#l1.4278"></a><span id="l1.4278" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l1.4279"></a><span id="l1.4279">   rv = GetMessageEnumerator(getter_AddRefs(enumerator));</span>
<a href="#l1.4280"></a><span id="l1.4280" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; enumerator)</span>
<a href="#l1.4281"></a><span id="l1.4281" class="difflineminus">-  {</span>
<a href="#l1.4282"></a><span id="l1.4282" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; enumerator) {</span>
<a href="#l1.4283"></a><span id="l1.4283">     bool hasMore;</span>
<a href="#l1.4284"></a><span id="l1.4284" class="difflineminus">-    while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l1.4285"></a><span id="l1.4285" class="difflineminus">-    {</span>
<a href="#l1.4286"></a><span id="l1.4286" class="difflineminus">-      nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l1.4287"></a><span id="l1.4287" class="difflineplus">+    while (NS_SUCCEEDED(rv = enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.4288"></a><span id="l1.4288" class="difflineplus">+           hasMore) {</span>
<a href="#l1.4289"></a><span id="l1.4289" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l1.4290"></a><span id="l1.4290">       rv = enumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.4291"></a><span id="l1.4291">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;nsMsgDBEnumerator broken&quot;);</span>
<a href="#l1.4292"></a><span id="l1.4292" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l1.4293"></a><span id="l1.4293" class="difflineminus">-      if (pHeader &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l1.4294"></a><span id="l1.4294" class="difflineminus">-      {</span>
<a href="#l1.4295"></a><span id="l1.4295" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; pHeader = do_QueryInterface(supports);</span>
<a href="#l1.4296"></a><span id="l1.4296" class="difflineplus">+      if (pHeader &amp;&amp; NS_SUCCEEDED(rv)) {</span>
<a href="#l1.4297"></a><span id="l1.4297">         uint32_t flags;</span>
<a href="#l1.4298"></a><span id="l1.4298">         pHeader-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4299"></a><span id="l1.4299" class="difflineminus">-        if ((flags &amp; nsMsgMessageFlags::Marked) &amp;&amp; !(flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.4300"></a><span id="l1.4300" class="difflineplus">+        if ((flags &amp; nsMsgMessageFlags::Marked) &amp;&amp;</span>
<a href="#l1.4301"></a><span id="l1.4301" class="difflineplus">+            !(flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.4302"></a><span id="l1.4302">           messageArray-&gt;AppendElement(pHeader);</span>
<a href="#l1.4303"></a><span id="l1.4303">       }</span>
<a href="#l1.4304"></a><span id="l1.4304">     }</span>
<a href="#l1.4305"></a><span id="l1.4305">   }</span>
<a href="#l1.4306"></a><span id="l1.4306"> </span>
<a href="#l1.4307"></a><span id="l1.4307">   m_folder-&gt;DownloadMessagesForOffline(messageArray, window);</span>
<a href="#l1.4308"></a><span id="l1.4308">   return rv;</span>
<a href="#l1.4309"></a><span id="l1.4309"> }</span>
<a href="#l1.4310"></a><span id="l1.4310"> </span>
<a href="#l1.4311"></a><span id="l1.4311"> // Read/unread handling.</span>
<a href="#l1.4312"></a><span id="l1.4312" class="difflineminus">-nsresult</span>
<a href="#l1.4313"></a><span id="l1.4313" class="difflineminus">-nsMsgDBView::ToggleReadByIndex(nsMsgViewIndex index)</span>
<a href="#l1.4314"></a><span id="l1.4314" class="difflineminus">-{</span>
<a href="#l1.4315"></a><span id="l1.4315" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.4316"></a><span id="l1.4316" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4317"></a><span id="l1.4317" class="difflineplus">+nsresult nsMsgDBView::ToggleReadByIndex(nsMsgViewIndex index) {</span>
<a href="#l1.4318"></a><span id="l1.4318" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4319"></a><span id="l1.4319"> </span>
<a href="#l1.4320"></a><span id="l1.4320">   return SetReadByIndex(index, !(m_flags[index] &amp; nsMsgMessageFlags::Read));</span>
<a href="#l1.4321"></a><span id="l1.4321"> }</span>
<a href="#l1.4322"></a><span id="l1.4322"> </span>
<a href="#l1.4323"></a><span id="l1.4323" class="difflineminus">-nsresult</span>
<a href="#l1.4324"></a><span id="l1.4324" class="difflineminus">-nsMsgDBView::SetReadByIndex(nsMsgViewIndex index, bool read)</span>
<a href="#l1.4325"></a><span id="l1.4325" class="difflineminus">-{</span>
<a href="#l1.4326"></a><span id="l1.4326" class="difflineplus">+nsresult nsMsgDBView::SetReadByIndex(nsMsgViewIndex index, bool read) {</span>
<a href="#l1.4327"></a><span id="l1.4327">   nsresult rv;</span>
<a href="#l1.4328"></a><span id="l1.4328"> </span>
<a href="#l1.4329"></a><span id="l1.4329" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.4330"></a><span id="l1.4330" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4331"></a><span id="l1.4331" class="difflineminus">-</span>
<a href="#l1.4332"></a><span id="l1.4332" class="difflineminus">-  if (read)</span>
<a href="#l1.4333"></a><span id="l1.4333" class="difflineminus">-  {</span>
<a href="#l1.4334"></a><span id="l1.4334" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4335"></a><span id="l1.4335" class="difflineplus">+</span>
<a href="#l1.4336"></a><span id="l1.4336" class="difflineplus">+  if (read) {</span>
<a href="#l1.4337"></a><span id="l1.4337">     OrExtraFlag(index, nsMsgMessageFlags::Read);</span>
<a href="#l1.4338"></a><span id="l1.4338">     // MarkRead() will clear this flag in the db and then call OnKeyChange(),</span>
<a href="#l1.4339"></a><span id="l1.4339">     // but because we are the instigator of the change we'll ignore the change.</span>
<a href="#l1.4340"></a><span id="l1.4340">     // So we need to clear it in m_flags to keep the db and m_flags in sync.</span>
<a href="#l1.4341"></a><span id="l1.4341">     AndExtraFlag(index, ~nsMsgMessageFlags::New);</span>
<a href="#l1.4342"></a><span id="l1.4342" class="difflineminus">-  }</span>
<a href="#l1.4343"></a><span id="l1.4343" class="difflineminus">-  else</span>
<a href="#l1.4344"></a><span id="l1.4344" class="difflineminus">-  {</span>
<a href="#l1.4345"></a><span id="l1.4345" class="difflineplus">+  } else {</span>
<a href="#l1.4346"></a><span id="l1.4346">     AndExtraFlag(index, ~nsMsgMessageFlags::Read);</span>
<a href="#l1.4347"></a><span id="l1.4347">   }</span>
<a href="#l1.4348"></a><span id="l1.4348"> </span>
<a href="#l1.4349"></a><span id="l1.4349" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4350"></a><span id="l1.4350" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4351"></a><span id="l1.4351">   rv = GetDBForViewIndex(index, getter_AddRefs(dbToUse));</span>
<a href="#l1.4352"></a><span id="l1.4352">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4353"></a><span id="l1.4353"> </span>
<a href="#l1.4354"></a><span id="l1.4354">   rv = dbToUse-&gt;MarkRead(m_keys[index], read, this);</span>
<a href="#l1.4355"></a><span id="l1.4355">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4356"></a><span id="l1.4356" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.4357"></a><span id="l1.4357" class="difflineminus">-  {</span>
<a href="#l1.4358"></a><span id="l1.4358" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.4359"></a><span id="l1.4359">     nsMsgViewIndex threadIndex = GetThreadIndex(index);</span>
<a href="#l1.4360"></a><span id="l1.4360">     if (threadIndex != index)</span>
<a href="#l1.4361"></a><span id="l1.4361">       NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4362"></a><span id="l1.4362">   }</span>
<a href="#l1.4363"></a><span id="l1.4363"> </span>
<a href="#l1.4364"></a><span id="l1.4364">   return rv;</span>
<a href="#l1.4365"></a><span id="l1.4365"> }</span>
<a href="#l1.4366"></a><span id="l1.4366"> </span>
<a href="#l1.4367"></a><span id="l1.4367" class="difflineminus">-nsresult</span>
<a href="#l1.4368"></a><span id="l1.4368" class="difflineminus">-nsMsgDBView::SetThreadOfMsgReadByIndex(nsMsgViewIndex index,</span>
<a href="#l1.4369"></a><span id="l1.4369" class="difflineminus">-                                       nsTArray&lt;nsMsgKey&gt; &amp;keysMarkedRead,</span>
<a href="#l1.4370"></a><span id="l1.4370" class="difflineminus">-                                       bool /*read*/)</span>
<a href="#l1.4371"></a><span id="l1.4371" class="difflineminus">-{</span>
<a href="#l1.4372"></a><span id="l1.4372" class="difflineplus">+nsresult nsMsgDBView::SetThreadOfMsgReadByIndex(</span>
<a href="#l1.4373"></a><span id="l1.4373" class="difflineplus">+    nsMsgViewIndex index, nsTArray&lt;nsMsgKey&gt; &amp;keysMarkedRead, bool /*read*/) {</span>
<a href="#l1.4374"></a><span id="l1.4374">   nsresult rv;</span>
<a href="#l1.4375"></a><span id="l1.4375"> </span>
<a href="#l1.4376"></a><span id="l1.4376" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.4377"></a><span id="l1.4377" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4378"></a><span id="l1.4378" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4379"></a><span id="l1.4379"> </span>
<a href="#l1.4380"></a><span id="l1.4380">   rv = MarkThreadOfMsgRead(m_keys[index], index, keysMarkedRead, true);</span>
<a href="#l1.4381"></a><span id="l1.4381">   return rv;</span>
<a href="#l1.4382"></a><span id="l1.4382"> }</span>
<a href="#l1.4383"></a><span id="l1.4383"> </span>
<a href="#l1.4384"></a><span id="l1.4384" class="difflineminus">-nsresult</span>
<a href="#l1.4385"></a><span id="l1.4385" class="difflineminus">-nsMsgDBView::SetFlaggedByIndex(nsMsgViewIndex index,</span>
<a href="#l1.4386"></a><span id="l1.4386" class="difflineminus">-                               bool mark)</span>
<a href="#l1.4387"></a><span id="l1.4387" class="difflineminus">-{</span>
<a href="#l1.4388"></a><span id="l1.4388" class="difflineplus">+nsresult nsMsgDBView::SetFlaggedByIndex(nsMsgViewIndex index, bool mark) {</span>
<a href="#l1.4389"></a><span id="l1.4389">   nsresult rv;</span>
<a href="#l1.4390"></a><span id="l1.4390"> </span>
<a href="#l1.4391"></a><span id="l1.4391" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.4392"></a><span id="l1.4392" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4393"></a><span id="l1.4393" class="difflineminus">-</span>
<a href="#l1.4394"></a><span id="l1.4394" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4395"></a><span id="l1.4395" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.4396"></a><span id="l1.4396" class="difflineplus">+</span>
<a href="#l1.4397"></a><span id="l1.4397" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.4398"></a><span id="l1.4398">   rv = GetDBForViewIndex(index, getter_AddRefs(dbToUse));</span>
<a href="#l1.4399"></a><span id="l1.4399">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4400"></a><span id="l1.4400"> </span>
<a href="#l1.4401"></a><span id="l1.4401">   if (mark)</span>
<a href="#l1.4402"></a><span id="l1.4402">     OrExtraFlag(index, nsMsgMessageFlags::Marked);</span>
<a href="#l1.4403"></a><span id="l1.4403">   else</span>
<a href="#l1.4404"></a><span id="l1.4404">     AndExtraFlag(index, ~nsMsgMessageFlags::Marked);</span>
<a href="#l1.4405"></a><span id="l1.4405"> </span>
<a href="#l1.4406"></a><span id="l1.4406">   rv = dbToUse-&gt;MarkMarked(m_keys[index], mark, this);</span>
<a href="#l1.4407"></a><span id="l1.4407">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.4408"></a><span id="l1.4408">   return rv;</span>
<a href="#l1.4409"></a><span id="l1.4409"> }</span>
<a href="#l1.4410"></a><span id="l1.4410"> </span>
<a href="#l1.4411"></a><span id="l1.4411" class="difflineminus">-nsresult</span>
<a href="#l1.4412"></a><span id="l1.4412" class="difflineminus">-nsMsgDBView::SetMsgHdrJunkStatus(nsIJunkMailPlugin *aJunkPlugin,</span>
<a href="#l1.4413"></a><span id="l1.4413" class="difflineminus">-                                 nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.4414"></a><span id="l1.4414" class="difflineminus">-                                 nsMsgJunkStatus aNewClassification)</span>
<a href="#l1.4415"></a><span id="l1.4415" class="difflineminus">-{</span>
<a href="#l1.4416"></a><span id="l1.4416" class="difflineminus">-    // Get the old junk score.</span>
<a href="#l1.4417"></a><span id="l1.4417" class="difflineminus">-    nsCString junkScoreStr;</span>
<a href="#l1.4418"></a><span id="l1.4418" class="difflineminus">-    nsresult rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.4419"></a><span id="l1.4419" class="difflineminus">-</span>
<a href="#l1.4420"></a><span id="l1.4420" class="difflineminus">-    // And the old origin.</span>
<a href="#l1.4421"></a><span id="l1.4421" class="difflineminus">-    nsCString oldOriginStr;</span>
<a href="#l1.4422"></a><span id="l1.4422" class="difflineminus">-    rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscoreorigin&quot;, getter_Copies(oldOriginStr));</span>
<a href="#l1.4423"></a><span id="l1.4423" class="difflineminus">-</span>
<a href="#l1.4424"></a><span id="l1.4424" class="difflineminus">-    // If this was not classified by the user, say so.</span>
<a href="#l1.4425"></a><span id="l1.4425" class="difflineminus">-    nsMsgJunkStatus oldUserClassification;</span>
<a href="#l1.4426"></a><span id="l1.4426" class="difflineminus">-    if (oldOriginStr.get()[0] != 'u')</span>
<a href="#l1.4427"></a><span id="l1.4427" class="difflineminus">-    {</span>
<a href="#l1.4428"></a><span id="l1.4428" class="difflineplus">+nsresult nsMsgDBView::SetMsgHdrJunkStatus(nsIJunkMailPlugin *aJunkPlugin,</span>
<a href="#l1.4429"></a><span id="l1.4429" class="difflineplus">+                                          nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.4430"></a><span id="l1.4430" class="difflineplus">+                                          nsMsgJunkStatus aNewClassification) {</span>
<a href="#l1.4431"></a><span id="l1.4431" class="difflineplus">+  // Get the old junk score.</span>
<a href="#l1.4432"></a><span id="l1.4432" class="difflineplus">+  nsCString junkScoreStr;</span>
<a href="#l1.4433"></a><span id="l1.4433" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.4434"></a><span id="l1.4434" class="difflineplus">+      aMsgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.4435"></a><span id="l1.4435" class="difflineplus">+</span>
<a href="#l1.4436"></a><span id="l1.4436" class="difflineplus">+  // And the old origin.</span>
<a href="#l1.4437"></a><span id="l1.4437" class="difflineplus">+  nsCString oldOriginStr;</span>
<a href="#l1.4438"></a><span id="l1.4438" class="difflineplus">+  rv = aMsgHdr-&gt;GetStringProperty(&quot;junkscoreorigin&quot;,</span>
<a href="#l1.4439"></a><span id="l1.4439" class="difflineplus">+                                  getter_Copies(oldOriginStr));</span>
<a href="#l1.4440"></a><span id="l1.4440" class="difflineplus">+</span>
<a href="#l1.4441"></a><span id="l1.4441" class="difflineplus">+  // If this was not classified by the user, say so.</span>
<a href="#l1.4442"></a><span id="l1.4442" class="difflineplus">+  nsMsgJunkStatus oldUserClassification;</span>
<a href="#l1.4443"></a><span id="l1.4443" class="difflineplus">+  if (oldOriginStr.get()[0] != 'u') {</span>
<a href="#l1.4444"></a><span id="l1.4444" class="difflineplus">+    oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4445"></a><span id="l1.4445" class="difflineplus">+  } else {</span>
<a href="#l1.4446"></a><span id="l1.4446" class="difflineplus">+    // Otherwise, pass the actual user classification.</span>
<a href="#l1.4447"></a><span id="l1.4447" class="difflineplus">+    if (junkScoreStr.IsEmpty())</span>
<a href="#l1.4448"></a><span id="l1.4448">       oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4449"></a><span id="l1.4449" class="difflineminus">-    }</span>
<a href="#l1.4450"></a><span id="l1.4450" class="difflineplus">+    else if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.4451"></a><span id="l1.4451" class="difflineplus">+      oldUserClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l1.4452"></a><span id="l1.4452">     else</span>
<a href="#l1.4453"></a><span id="l1.4453" class="difflineminus">-    {</span>
<a href="#l1.4454"></a><span id="l1.4454" class="difflineminus">-      // Otherwise, pass the actual user classification.</span>
<a href="#l1.4455"></a><span id="l1.4455" class="difflineminus">-      if (junkScoreStr.IsEmpty())</span>
<a href="#l1.4456"></a><span id="l1.4456" class="difflineminus">-        oldUserClassification = nsIJunkMailPlugin::UNCLASSIFIED;</span>
<a href="#l1.4457"></a><span id="l1.4457" class="difflineminus">-      else if (junkScoreStr.ToInteger(&amp;rv) == nsIJunkMailPlugin::IS_SPAM_SCORE)</span>
<a href="#l1.4458"></a><span id="l1.4458" class="difflineminus">-        oldUserClassification = nsIJunkMailPlugin::JUNK;</span>
<a href="#l1.4459"></a><span id="l1.4459" class="difflineminus">-      else</span>
<a href="#l1.4460"></a><span id="l1.4460" class="difflineminus">-        oldUserClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l1.4461"></a><span id="l1.4461" class="difflineminus">-</span>
<a href="#l1.4462"></a><span id="l1.4462" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.4463"></a><span id="l1.4463" class="difflineminus">-    }</span>
<a href="#l1.4464"></a><span id="l1.4464" class="difflineminus">-</span>
<a href="#l1.4465"></a><span id="l1.4465" class="difflineminus">-    // Get the URI for this message so we can pass it to the plugin.</span>
<a href="#l1.4466"></a><span id="l1.4466" class="difflineminus">-    nsCString uri;</span>
<a href="#l1.4467"></a><span id="l1.4467" class="difflineminus">-    nsMsgKey msgKey;</span>
<a href="#l1.4468"></a><span id="l1.4468" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.4469"></a><span id="l1.4469" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.4470"></a><span id="l1.4470" class="difflineminus">-    aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.4471"></a><span id="l1.4471" class="difflineminus">-    rv = aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.4472"></a><span id="l1.4472" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4473"></a><span id="l1.4473" class="difflineminus">-    GenerateURIForMsgKey(msgKey, folder, uri);</span>
<a href="#l1.4474"></a><span id="l1.4474" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4475"></a><span id="l1.4475" class="difflineminus">-    rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l1.4476"></a><span id="l1.4476" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4477"></a><span id="l1.4477" class="difflineminus">-</span>
<a href="#l1.4478"></a><span id="l1.4478" class="difflineminus">-    // Tell the plugin about this change, so that it can (potentially)</span>
<a href="#l1.4479"></a><span id="l1.4479" class="difflineminus">-    // adjust its database appropriately.</span>
<a href="#l1.4480"></a><span id="l1.4480" class="difflineminus">-    nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.4481"></a><span id="l1.4481" class="difflineminus">-    rv = aJunkPlugin-&gt;SetMessageClassification(uri.get(),</span>
<a href="#l1.4482"></a><span id="l1.4482" class="difflineminus">-                                               oldUserClassification,</span>
<a href="#l1.4483"></a><span id="l1.4483" class="difflineminus">-                                               aNewClassification,</span>
<a href="#l1.4484"></a><span id="l1.4484" class="difflineminus">-                                               msgWindow,</span>
<a href="#l1.4485"></a><span id="l1.4485" class="difflineminus">-                                               this);</span>
<a href="#l1.4486"></a><span id="l1.4486" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4487"></a><span id="l1.4487" class="difflineminus">-</span>
<a href="#l1.4488"></a><span id="l1.4488" class="difflineminus">-    // This routine is only reached if the user someone touched the UI</span>
<a href="#l1.4489"></a><span id="l1.4489" class="difflineminus">-    // and told us the junk status of this message.</span>
<a href="#l1.4490"></a><span id="l1.4490" class="difflineminus">-    // Set origin first so that listeners on the junkscore will</span>
<a href="#l1.4491"></a><span id="l1.4491" class="difflineminus">-    // know the correct origin.</span>
<a href="#l1.4492"></a><span id="l1.4492" class="difflineminus">-    rv = db-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;user&quot;);</span>
<a href="#l1.4493"></a><span id="l1.4493" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;SetStringPropertyByIndex failed&quot;);</span>
<a href="#l1.4494"></a><span id="l1.4494" class="difflineminus">-</span>
<a href="#l1.4495"></a><span id="l1.4495" class="difflineminus">-    // Set the junk score on the message itself.</span>
<a href="#l1.4496"></a><span id="l1.4496" class="difflineminus">-    nsAutoCString msgJunkScore;</span>
<a href="#l1.4497"></a><span id="l1.4497" class="difflineminus">-    msgJunkScore.AppendInt(aNewClassification == nsIJunkMailPlugin::JUNK ?</span>
<a href="#l1.4498"></a><span id="l1.4498" class="difflineminus">-                             nsIJunkMailPlugin::IS_SPAM_SCORE :</span>
<a href="#l1.4499"></a><span id="l1.4499" class="difflineminus">-                             nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l1.4500"></a><span id="l1.4500" class="difflineminus">-    db-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l1.4501"></a><span id="l1.4501" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4502"></a><span id="l1.4502" class="difflineminus">-</span>
<a href="#l1.4503"></a><span id="l1.4503" class="difflineminus">-    return rv;</span>
<a href="#l1.4504"></a><span id="l1.4504" class="difflineminus">-}</span>
<a href="#l1.4505"></a><span id="l1.4505" class="difflineminus">-</span>
<a href="#l1.4506"></a><span id="l1.4506" class="difflineminus">-nsresult</span>
<a href="#l1.4507"></a><span id="l1.4507" class="difflineminus">-nsMsgDBView::GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l1.4508"></a><span id="l1.4508" class="difflineminus">-                                 nsIMsgFolder **aFolder)</span>
<a href="#l1.4509"></a><span id="l1.4509" class="difflineminus">-{</span>
<a href="#l1.4510"></a><span id="l1.4510" class="difflineplus">+      oldUserClassification = nsIJunkMailPlugin::GOOD;</span>
<a href="#l1.4511"></a><span id="l1.4511" class="difflineplus">+</span>
<a href="#l1.4512"></a><span id="l1.4512" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;Converting junkScore to integer failed.&quot;);</span>
<a href="#l1.4513"></a><span id="l1.4513" class="difflineplus">+  }</span>
<a href="#l1.4514"></a><span id="l1.4514" class="difflineplus">+</span>
<a href="#l1.4515"></a><span id="l1.4515" class="difflineplus">+  // Get the URI for this message so we can pass it to the plugin.</span>
<a href="#l1.4516"></a><span id="l1.4516" class="difflineplus">+  nsCString uri;</span>
<a href="#l1.4517"></a><span id="l1.4517" class="difflineplus">+  nsMsgKey msgKey;</span>
<a href="#l1.4518"></a><span id="l1.4518" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.4519"></a><span id="l1.4519" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.4520"></a><span id="l1.4520" class="difflineplus">+  aMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.4521"></a><span id="l1.4521" class="difflineplus">+  rv = aMsgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.4522"></a><span id="l1.4522" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4523"></a><span id="l1.4523" class="difflineplus">+  GenerateURIForMsgKey(msgKey, folder, uri);</span>
<a href="#l1.4524"></a><span id="l1.4524" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4525"></a><span id="l1.4525" class="difflineplus">+  rv = folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l1.4526"></a><span id="l1.4526" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4527"></a><span id="l1.4527" class="difflineplus">+</span>
<a href="#l1.4528"></a><span id="l1.4528" class="difflineplus">+  // Tell the plugin about this change, so that it can (potentially)</span>
<a href="#l1.4529"></a><span id="l1.4529" class="difflineplus">+  // adjust its database appropriately.</span>
<a href="#l1.4530"></a><span id="l1.4530" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.4531"></a><span id="l1.4531" class="difflineplus">+  rv = aJunkPlugin-&gt;SetMessageClassification(</span>
<a href="#l1.4532"></a><span id="l1.4532" class="difflineplus">+      uri.get(), oldUserClassification, aNewClassification, msgWindow, this);</span>
<a href="#l1.4533"></a><span id="l1.4533" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4534"></a><span id="l1.4534" class="difflineplus">+</span>
<a href="#l1.4535"></a><span id="l1.4535" class="difflineplus">+  // This routine is only reached if the user someone touched the UI</span>
<a href="#l1.4536"></a><span id="l1.4536" class="difflineplus">+  // and told us the junk status of this message.</span>
<a href="#l1.4537"></a><span id="l1.4537" class="difflineplus">+  // Set origin first so that listeners on the junkscore will</span>
<a href="#l1.4538"></a><span id="l1.4538" class="difflineplus">+  // know the correct origin.</span>
<a href="#l1.4539"></a><span id="l1.4539" class="difflineplus">+  rv = db-&gt;SetStringProperty(msgKey, &quot;junkscoreorigin&quot;, &quot;user&quot;);</span>
<a href="#l1.4540"></a><span id="l1.4540" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;SetStringPropertyByIndex failed&quot;);</span>
<a href="#l1.4541"></a><span id="l1.4541" class="difflineplus">+</span>
<a href="#l1.4542"></a><span id="l1.4542" class="difflineplus">+  // Set the junk score on the message itself.</span>
<a href="#l1.4543"></a><span id="l1.4543" class="difflineplus">+  nsAutoCString msgJunkScore;</span>
<a href="#l1.4544"></a><span id="l1.4544" class="difflineplus">+  msgJunkScore.AppendInt(aNewClassification == nsIJunkMailPlugin::JUNK</span>
<a href="#l1.4545"></a><span id="l1.4545" class="difflineplus">+                             ? nsIJunkMailPlugin::IS_SPAM_SCORE</span>
<a href="#l1.4546"></a><span id="l1.4546" class="difflineplus">+                             : nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l1.4547"></a><span id="l1.4547" class="difflineplus">+  db-&gt;SetStringProperty(msgKey, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l1.4548"></a><span id="l1.4548" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4549"></a><span id="l1.4549" class="difflineplus">+</span>
<a href="#l1.4550"></a><span id="l1.4550" class="difflineplus">+  return rv;</span>
<a href="#l1.4551"></a><span id="l1.4551" class="difflineplus">+}</span>
<a href="#l1.4552"></a><span id="l1.4552" class="difflineplus">+</span>
<a href="#l1.4553"></a><span id="l1.4553" class="difflineplus">+nsresult nsMsgDBView::GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l1.4554"></a><span id="l1.4554" class="difflineplus">+                                          nsIMsgFolder **aFolder) {</span>
<a href="#l1.4555"></a><span id="l1.4555">   NS_IF_ADDREF(*aFolder = m_folder);</span>
<a href="#l1.4556"></a><span id="l1.4556">   return NS_OK;</span>
<a href="#l1.4557"></a><span id="l1.4557"> }</span>
<a href="#l1.4558"></a><span id="l1.4558"> </span>
<a href="#l1.4559"></a><span id="l1.4559"> NS_IMETHODIMP</span>
<a href="#l1.4560"></a><span id="l1.4560"> nsMsgDBView::OnMessageClassified(const char *aMsgURI,</span>
<a href="#l1.4561"></a><span id="l1.4561">                                  nsMsgJunkStatus aClassification,</span>
<a href="#l1.4562"></a><span id="l1.4562">                                  uint32_t aJunkPercent)</span>
<a href="#l1.4563"></a><span id="l1.4563" class="difflineat">@@ -3902,174 +3381,152 @@ nsMsgDBView::OnMessageClassified(const c</span>
<a href="#l1.4564"></a><span id="l1.4564">   uint32_t numJunk;</span>
<a href="#l1.4565"></a><span id="l1.4565">   mJunkHdrs-&gt;GetLength(&amp;numJunk);</span>
<a href="#l1.4566"></a><span id="l1.4566">   NS_ASSERTION(aClassification == nsIJunkMailPlugin::GOOD || numJunk,</span>
<a href="#l1.4567"></a><span id="l1.4567">                &quot;the classification of a manually-marked junk message has &quot;</span>
<a href="#l1.4568"></a><span id="l1.4568">                &quot;been classified as junk, yet there seem to be no such &quot;</span>
<a href="#l1.4569"></a><span id="l1.4569">                &quot;outstanding messages&quot;);</span>
<a href="#l1.4570"></a><span id="l1.4570"> </span>
<a href="#l1.4571"></a><span id="l1.4571">   // Is this the last message in the batch?</span>
<a href="#l1.4572"></a><span id="l1.4572" class="difflineminus">-  if (--mNumMessagesRemainingInBatch == 0 &amp;&amp; numJunk &gt; 0)</span>
<a href="#l1.4573"></a><span id="l1.4573" class="difflineminus">-  {</span>
<a href="#l1.4574"></a><span id="l1.4574" class="difflineplus">+  if (--mNumMessagesRemainingInBatch == 0 &amp;&amp; numJunk &gt; 0) {</span>
<a href="#l1.4575"></a><span id="l1.4575">     PerformActionsOnJunkMsgs(aClassification == nsIJunkMailPlugin::JUNK);</span>
<a href="#l1.4576"></a><span id="l1.4576">     mJunkHdrs-&gt;Clear();</span>
<a href="#l1.4577"></a><span id="l1.4577">   }</span>
<a href="#l1.4578"></a><span id="l1.4578"> </span>
<a href="#l1.4579"></a><span id="l1.4579">   return NS_OK;</span>
<a href="#l1.4580"></a><span id="l1.4580"> }</span>
<a href="#l1.4581"></a><span id="l1.4581"> </span>
<a href="#l1.4582"></a><span id="l1.4582" class="difflineminus">-nsresult</span>
<a href="#l1.4583"></a><span id="l1.4583" class="difflineminus">-nsMsgDBView::PerformActionsOnJunkMsgs(bool msgsAreJunk)</span>
<a href="#l1.4584"></a><span id="l1.4584" class="difflineminus">-{</span>
<a href="#l1.4585"></a><span id="l1.4585" class="difflineplus">+nsresult nsMsgDBView::PerformActionsOnJunkMsgs(bool msgsAreJunk) {</span>
<a href="#l1.4586"></a><span id="l1.4586">   uint32_t numJunkHdrs;</span>
<a href="#l1.4587"></a><span id="l1.4587">   mJunkHdrs-&gt;GetLength(&amp;numJunkHdrs);</span>
<a href="#l1.4588"></a><span id="l1.4588" class="difflineminus">-  if (!numJunkHdrs)</span>
<a href="#l1.4589"></a><span id="l1.4589" class="difflineminus">-  {</span>
<a href="#l1.4590"></a><span id="l1.4590" class="difflineplus">+  if (!numJunkHdrs) {</span>
<a href="#l1.4591"></a><span id="l1.4591">     NS_ERROR(&quot;no indices of marked-as-junk messages to act on&quot;);</span>
<a href="#l1.4592"></a><span id="l1.4592">     return NS_OK;</span>
<a href="#l1.4593"></a><span id="l1.4593">   }</span>
<a href="#l1.4594"></a><span id="l1.4594"> </span>
<a href="#l1.4595"></a><span id="l1.4595">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l1.4596"></a><span id="l1.4596">   nsCOMPtr&lt;nsIMsgDBHdr&gt; firstHdr(do_QueryElementAt(mJunkHdrs, 0));</span>
<a href="#l1.4597"></a><span id="l1.4597">   firstHdr-&gt;GetFolder(getter_AddRefs(srcFolder));</span>
<a href="#l1.4598"></a><span id="l1.4598"> </span>
<a href="#l1.4599"></a><span id="l1.4599">   bool moveMessages, changeReadState;</span>
<a href="#l1.4600"></a><span id="l1.4600">   nsCOMPtr&lt;nsIMsgFolder&gt; targetFolder;</span>
<a href="#l1.4601"></a><span id="l1.4601"> </span>
<a href="#l1.4602"></a><span id="l1.4602">   nsresult rv = DetermineActionsForJunkChange(msgsAreJunk, srcFolder,</span>
<a href="#l1.4603"></a><span id="l1.4603">                                               moveMessages, changeReadState,</span>
<a href="#l1.4604"></a><span id="l1.4604">                                               getter_AddRefs(targetFolder));</span>
<a href="#l1.4605"></a><span id="l1.4605" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4606"></a><span id="l1.4606" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4607"></a><span id="l1.4607"> </span>
<a href="#l1.4608"></a><span id="l1.4608">   // Nothing to do, bail out.</span>
<a href="#l1.4609"></a><span id="l1.4609" class="difflineminus">-  if (!(moveMessages || changeReadState))</span>
<a href="#l1.4610"></a><span id="l1.4610" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.4611"></a><span id="l1.4611" class="difflineminus">-</span>
<a href="#l1.4612"></a><span id="l1.4612" class="difflineminus">-  if (changeReadState)</span>
<a href="#l1.4613"></a><span id="l1.4613" class="difflineminus">-  {</span>
<a href="#l1.4614"></a><span id="l1.4614" class="difflineplus">+  if (!(moveMessages || changeReadState)) return NS_OK;</span>
<a href="#l1.4615"></a><span id="l1.4615" class="difflineplus">+</span>
<a href="#l1.4616"></a><span id="l1.4616" class="difflineplus">+  if (changeReadState) {</span>
<a href="#l1.4617"></a><span id="l1.4617">     // Notes on marking junk as read:</span>
<a href="#l1.4618"></a><span id="l1.4618">     // 1. There are 2 occasions on which junk messages are marked as</span>
<a href="#l1.4619"></a><span id="l1.4619">     //    read: after a manual marking (here and in the front end) and after</span>
<a href="#l1.4620"></a><span id="l1.4620">     //    automatic classification by the bayesian filter (see code for local</span>
<a href="#l1.4621"></a><span id="l1.4621">     //    mail folders and for imap mail folders). The server-specific</span>
<a href="#l1.4622"></a><span id="l1.4622">     //    markAsReadOnSpam pref only applies to the latter, the former is</span>
<a href="#l1.4623"></a><span id="l1.4623">     //    controlled by &quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;.</span>
<a href="#l1.4624"></a><span id="l1.4624">     // 2. Even though move/delete on manual mark may be</span>
<a href="#l1.4625"></a><span id="l1.4625">     //    turned off, we might still need to mark as read.</span>
<a href="#l1.4626"></a><span id="l1.4626"> </span>
<a href="#l1.4627"></a><span id="l1.4627">     NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4628"></a><span id="l1.4628">     rv = srcFolder-&gt;MarkMessagesRead(mJunkHdrs, msgsAreJunk);</span>
<a href="#l1.4629"></a><span id="l1.4629">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4630"></a><span id="l1.4630" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;marking marked-as-junk messages as read failed&quot;);</span>
<a href="#l1.4631"></a><span id="l1.4631" class="difflineminus">-  }</span>
<a href="#l1.4632"></a><span id="l1.4632" class="difflineminus">-</span>
<a href="#l1.4633"></a><span id="l1.4633" class="difflineminus">-  if (moveMessages)</span>
<a href="#l1.4634"></a><span id="l1.4634" class="difflineminus">-  {</span>
<a href="#l1.4635"></a><span id="l1.4635" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.4636"></a><span id="l1.4636" class="difflineplus">+                 &quot;marking marked-as-junk messages as read failed&quot;);</span>
<a href="#l1.4637"></a><span id="l1.4637" class="difflineplus">+  }</span>
<a href="#l1.4638"></a><span id="l1.4638" class="difflineplus">+</span>
<a href="#l1.4639"></a><span id="l1.4639" class="difflineplus">+  if (moveMessages) {</span>
<a href="#l1.4640"></a><span id="l1.4640">     // Check if one of the messages to be junked is actually selected.</span>
<a href="#l1.4641"></a><span id="l1.4641">     // If more than one message being junked, one must be selected.</span>
<a href="#l1.4642"></a><span id="l1.4642">     // If no tree selection at all, must be in stand-alone message window.</span>
<a href="#l1.4643"></a><span id="l1.4643">     bool junkedMsgSelected = numJunkHdrs &gt; 1 || !mTreeSelection;</span>
<a href="#l1.4644"></a><span id="l1.4644">     for (nsMsgViewIndex junkIndex = 0;</span>
<a href="#l1.4645"></a><span id="l1.4645" class="difflineminus">-         !junkedMsgSelected &amp;&amp; junkIndex &lt; numJunkHdrs;</span>
<a href="#l1.4646"></a><span id="l1.4646" class="difflineminus">-         junkIndex++)</span>
<a href="#l1.4647"></a><span id="l1.4647" class="difflineminus">-    {</span>
<a href="#l1.4648"></a><span id="l1.4648" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; junkHdr(do_QueryElementAt(mJunkHdrs, junkIndex, &amp;rv));</span>
<a href="#l1.4649"></a><span id="l1.4649" class="difflineplus">+         !junkedMsgSelected &amp;&amp; junkIndex &lt; numJunkHdrs; junkIndex++) {</span>
<a href="#l1.4650"></a><span id="l1.4650" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; junkHdr(</span>
<a href="#l1.4651"></a><span id="l1.4651" class="difflineplus">+          do_QueryElementAt(mJunkHdrs, junkIndex, &amp;rv));</span>
<a href="#l1.4652"></a><span id="l1.4652">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4653"></a><span id="l1.4653">       nsMsgViewIndex hdrIndex = FindHdr(junkHdr);</span>
<a href="#l1.4654"></a><span id="l1.4654">       if (hdrIndex != nsMsgViewIndex_None)</span>
<a href="#l1.4655"></a><span id="l1.4655">         mTreeSelection-&gt;IsSelected(hdrIndex, &amp;junkedMsgSelected);</span>
<a href="#l1.4656"></a><span id="l1.4656">     }</span>
<a href="#l1.4657"></a><span id="l1.4657"> </span>
<a href="#l1.4658"></a><span id="l1.4658">     // If a junked msg is selected, tell the FE to call</span>
<a href="#l1.4659"></a><span id="l1.4659">     // SetNextMessageAfterDelete() because a delete is coming.</span>
<a href="#l1.4660"></a><span id="l1.4660" class="difflineminus">-    if (junkedMsgSelected &amp;&amp; mCommandUpdater)</span>
<a href="#l1.4661"></a><span id="l1.4661" class="difflineminus">-    {</span>
<a href="#l1.4662"></a><span id="l1.4662" class="difflineplus">+    if (junkedMsgSelected &amp;&amp; mCommandUpdater) {</span>
<a href="#l1.4663"></a><span id="l1.4663">       rv = mCommandUpdater-&gt;UpdateNextMessageAfterDelete();</span>
<a href="#l1.4664"></a><span id="l1.4664" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4665"></a><span id="l1.4665" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4666"></a><span id="l1.4666">     }</span>
<a href="#l1.4667"></a><span id="l1.4667"> </span>
<a href="#l1.4668"></a><span id="l1.4668">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l1.4669"></a><span id="l1.4669">     NoteStartChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4670"></a><span id="l1.4670" class="difflineminus">-    if (targetFolder)</span>
<a href="#l1.4671"></a><span id="l1.4671" class="difflineminus">-    {</span>
<a href="#l1.4672"></a><span id="l1.4672" class="difflineplus">+    if (targetFolder) {</span>
<a href="#l1.4673"></a><span id="l1.4673">       nsCOMPtr&lt;nsIMsgCopyService&gt; copyService =</span>
<a href="#l1.4674"></a><span id="l1.4674" class="difflineminus">-        do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.4675"></a><span id="l1.4675" class="difflineplus">+          do_GetService(NS_MSGCOPYSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.4676"></a><span id="l1.4676"> </span>
<a href="#l1.4677"></a><span id="l1.4677">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4678"></a><span id="l1.4678"> </span>
<a href="#l1.4679"></a><span id="l1.4679" class="difflineminus">-      rv = copyService-&gt;CopyMessages(srcFolder , mJunkHdrs, targetFolder,</span>
<a href="#l1.4680"></a><span id="l1.4680" class="difflineminus">-                                     true, nullptr, msgWindow, true);</span>
<a href="#l1.4681"></a><span id="l1.4681" class="difflineminus">-    }</span>
<a href="#l1.4682"></a><span id="l1.4682" class="difflineminus">-    else if (msgsAreJunk)</span>
<a href="#l1.4683"></a><span id="l1.4683" class="difflineminus">-    {</span>
<a href="#l1.4684"></a><span id="l1.4684" class="difflineminus">-      if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4685"></a><span id="l1.4685" class="difflineminus">-      {</span>
<a href="#l1.4686"></a><span id="l1.4686" class="difflineplus">+      rv = copyService-&gt;CopyMessages(srcFolder, mJunkHdrs, targetFolder, true,</span>
<a href="#l1.4687"></a><span id="l1.4687" class="difflineplus">+                                     nullptr, msgWindow, true);</span>
<a href="#l1.4688"></a><span id="l1.4688" class="difflineplus">+    } else if (msgsAreJunk) {</span>
<a href="#l1.4689"></a><span id="l1.4689" class="difflineplus">+      if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) {</span>
<a href="#l1.4690"></a><span id="l1.4690">         // Unfortunately the DeleteMessages in this case is interpreted by</span>
<a href="#l1.4691"></a><span id="l1.4691">         // IMAP as a delete toggle. So what we have to do is to assemble a</span>
<a href="#l1.4692"></a><span id="l1.4692">         // new delete array, keeping only those that are not deleted.</span>
<a href="#l1.4693"></a><span id="l1.4693">         nsCOMPtr&lt;nsIMutableArray&gt; hdrsToDelete =</span>
<a href="#l1.4694"></a><span id="l1.4694" class="difflineminus">-          do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.4695"></a><span id="l1.4695" class="difflineplus">+            do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l1.4696"></a><span id="l1.4696"> </span>
<a href="#l1.4697"></a><span id="l1.4697">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4698"></a><span id="l1.4698">         uint32_t cnt;</span>
<a href="#l1.4699"></a><span id="l1.4699">         rv = mJunkHdrs-&gt;GetLength(&amp;cnt);</span>
<a href="#l1.4700"></a><span id="l1.4700" class="difflineminus">-        for (uint32_t i = 0; i &lt; cnt; i++)</span>
<a href="#l1.4701"></a><span id="l1.4701" class="difflineminus">-        {</span>
<a href="#l1.4702"></a><span id="l1.4702" class="difflineplus">+        for (uint32_t i = 0; i &lt; cnt; i++) {</span>
<a href="#l1.4703"></a><span id="l1.4703">           nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(mJunkHdrs, i);</span>
<a href="#l1.4704"></a><span id="l1.4704" class="difflineminus">-          if (msgHdr)</span>
<a href="#l1.4705"></a><span id="l1.4705" class="difflineminus">-          {</span>
<a href="#l1.4706"></a><span id="l1.4706" class="difflineplus">+          if (msgHdr) {</span>
<a href="#l1.4707"></a><span id="l1.4707">             uint32_t flags;</span>
<a href="#l1.4708"></a><span id="l1.4708">             msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.4709"></a><span id="l1.4709">             if (!(flags &amp; nsMsgMessageFlags::IMAPDeleted))</span>
<a href="#l1.4710"></a><span id="l1.4710">               hdrsToDelete-&gt;AppendElement(msgHdr);</span>
<a href="#l1.4711"></a><span id="l1.4711">           }</span>
<a href="#l1.4712"></a><span id="l1.4712">         }</span>
<a href="#l1.4713"></a><span id="l1.4713"> </span>
<a href="#l1.4714"></a><span id="l1.4714">         hdrsToDelete-&gt;GetLength(&amp;cnt);</span>
<a href="#l1.4715"></a><span id="l1.4715">         if (cnt)</span>
<a href="#l1.4716"></a><span id="l1.4716">           rv = srcFolder-&gt;DeleteMessages(hdrsToDelete, msgWindow, false, false,</span>
<a href="#l1.4717"></a><span id="l1.4717">                                          nullptr, true);</span>
<a href="#l1.4718"></a><span id="l1.4718" class="difflineminus">-      }</span>
<a href="#l1.4719"></a><span id="l1.4719" class="difflineminus">-      else</span>
<a href="#l1.4720"></a><span id="l1.4720" class="difflineminus">-      {</span>
<a href="#l1.4721"></a><span id="l1.4721" class="difflineplus">+      } else {</span>
<a href="#l1.4722"></a><span id="l1.4722">         rv = srcFolder-&gt;DeleteMessages(mJunkHdrs, msgWindow, false, false,</span>
<a href="#l1.4723"></a><span id="l1.4723">                                        nullptr, true);</span>
<a href="#l1.4724"></a><span id="l1.4724">       }</span>
<a href="#l1.4725"></a><span id="l1.4725" class="difflineminus">-    }</span>
<a href="#l1.4726"></a><span id="l1.4726" class="difflineminus">-    else if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.4727"></a><span id="l1.4727" class="difflineminus">-    {</span>
<a href="#l1.4728"></a><span id="l1.4728" class="difflineplus">+    } else if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) {</span>
<a href="#l1.4729"></a><span id="l1.4729">       nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(srcFolder));</span>
<a href="#l1.4730"></a><span id="l1.4730">       nsTArray&lt;nsMsgKey&gt; imapUids;</span>
<a href="#l1.4731"></a><span id="l1.4731">       imapUids.SetLength(numJunkHdrs);</span>
<a href="#l1.4732"></a><span id="l1.4732" class="difflineminus">-      for (uint32_t i = 0; i &lt; numJunkHdrs; i++)</span>
<a href="#l1.4733"></a><span id="l1.4733" class="difflineminus">-      {</span>
<a href="#l1.4734"></a><span id="l1.4734" class="difflineplus">+      for (uint32_t i = 0; i &lt; numJunkHdrs; i++) {</span>
<a href="#l1.4735"></a><span id="l1.4735">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(mJunkHdrs, i);</span>
<a href="#l1.4736"></a><span id="l1.4736">         msgHdr-&gt;GetMessageKey(&amp;imapUids[i]);</span>
<a href="#l1.4737"></a><span id="l1.4737">       }</span>
<a href="#l1.4738"></a><span id="l1.4738"> </span>
<a href="#l1.4739"></a><span id="l1.4739" class="difflineminus">-      imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false, imapUids.Elements(),</span>
<a href="#l1.4740"></a><span id="l1.4740" class="difflineminus">-                                 imapUids.Length(), nullptr);</span>
<a href="#l1.4741"></a><span id="l1.4741" class="difflineplus">+      imapFolder-&gt;StoreImapFlags(kImapMsgDeletedFlag, false,</span>
<a href="#l1.4742"></a><span id="l1.4742" class="difflineplus">+                                 imapUids.Elements(), imapUids.Length(),</span>
<a href="#l1.4743"></a><span id="l1.4743" class="difflineplus">+                                 nullptr);</span>
<a href="#l1.4744"></a><span id="l1.4744">     }</span>
<a href="#l1.4745"></a><span id="l1.4745"> </span>
<a href="#l1.4746"></a><span id="l1.4746">     NoteEndChange(nsMsgViewNotificationCode::none, 0, 0);</span>
<a href="#l1.4747"></a><span id="l1.4747"> </span>
<a href="#l1.4748"></a><span id="l1.4748">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.4749"></a><span id="l1.4749">                  &quot;move or deletion of message marked-as-junk/non junk failed&quot;);</span>
<a href="#l1.4750"></a><span id="l1.4750">   }</span>
<a href="#l1.4751"></a><span id="l1.4751"> </span>
<a href="#l1.4752"></a><span id="l1.4752">   return rv;</span>
<a href="#l1.4753"></a><span id="l1.4753"> }</span>
<a href="#l1.4754"></a><span id="l1.4754"> </span>
<a href="#l1.4755"></a><span id="l1.4755" class="difflineminus">-nsresult</span>
<a href="#l1.4756"></a><span id="l1.4756" class="difflineminus">-nsMsgDBView::DetermineActionsForJunkChange(bool msgsAreJunk,</span>
<a href="#l1.4757"></a><span id="l1.4757" class="difflineminus">-                                           nsIMsgFolder *srcFolder,</span>
<a href="#l1.4758"></a><span id="l1.4758" class="difflineminus">-                                           bool &amp;moveMessages,</span>
<a href="#l1.4759"></a><span id="l1.4759" class="difflineminus">-                                           bool &amp;changeReadState,</span>
<a href="#l1.4760"></a><span id="l1.4760" class="difflineminus">-                                           nsIMsgFolder** targetFolder)</span>
<a href="#l1.4761"></a><span id="l1.4761" class="difflineminus">-{</span>
<a href="#l1.4762"></a><span id="l1.4762" class="difflineplus">+nsresult nsMsgDBView::DetermineActionsForJunkChange(</span>
<a href="#l1.4763"></a><span id="l1.4763" class="difflineplus">+    bool msgsAreJunk, nsIMsgFolder *srcFolder, bool &amp;moveMessages,</span>
<a href="#l1.4764"></a><span id="l1.4764" class="difflineplus">+    bool &amp;changeReadState, nsIMsgFolder **targetFolder) {</span>
<a href="#l1.4765"></a><span id="l1.4765">   // There are two possible actions which may be performed</span>
<a href="#l1.4766"></a><span id="l1.4766">   // on messages marked as spam: marking as read and moving</span>
<a href="#l1.4767"></a><span id="l1.4767">   // somewhere. When a message is marked as non junk,</span>
<a href="#l1.4768"></a><span id="l1.4768">   // it may be moved to the inbox, and marked unread.</span>
<a href="#l1.4769"></a><span id="l1.4769">   moveMessages = false;</span>
<a href="#l1.4770"></a><span id="l1.4770">   changeReadState = false;</span>
<a href="#l1.4771"></a><span id="l1.4771"> </span>
<a href="#l1.4772"></a><span id="l1.4772">   // The 'somewhere', junkTargetFolder, can be a folder,</span>
<a href="#l1.4773"></a><span id="l1.4773" class="difflineat">@@ -4078,300 +3535,264 @@ nsMsgDBView::DetermineActionsForJunkChan</span>
<a href="#l1.4774"></a><span id="l1.4774"> </span>
<a href="#l1.4775"></a><span id="l1.4775">   uint32_t folderFlags;</span>
<a href="#l1.4776"></a><span id="l1.4776">   srcFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l1.4777"></a><span id="l1.4777"> </span>
<a href="#l1.4778"></a><span id="l1.4778">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.4779"></a><span id="l1.4779">   nsresult rv = srcFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.4780"></a><span id="l1.4780">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4781"></a><span id="l1.4781"> </span>
<a href="#l1.4782"></a><span id="l1.4782" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.4783"></a><span id="l1.4783" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l1.4784"></a><span id="l1.4784" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.4785"></a><span id="l1.4785">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4786"></a><span id="l1.4786"> </span>
<a href="#l1.4787"></a><span id="l1.4787">   // Handle the easy case of marking a junk message as good first.</span>
<a href="#l1.4788"></a><span id="l1.4788">   // Set the move target folder to the inbox, if any.</span>
<a href="#l1.4789"></a><span id="l1.4789" class="difflineminus">-  if (!msgsAreJunk)</span>
<a href="#l1.4790"></a><span id="l1.4790" class="difflineminus">-  {</span>
<a href="#l1.4791"></a><span id="l1.4791" class="difflineminus">-    if (folderFlags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l1.4792"></a><span id="l1.4792" class="difflineminus">-    {</span>
<a href="#l1.4793"></a><span id="l1.4793" class="difflineplus">+  if (!msgsAreJunk) {</span>
<a href="#l1.4794"></a><span id="l1.4794" class="difflineplus">+    if (folderFlags &amp; nsMsgFolderFlags::Junk) {</span>
<a href="#l1.4795"></a><span id="l1.4795">       prefBranch-&gt;GetBoolPref(&quot;mail.spam.markAsNotJunkMarksUnRead&quot;,</span>
<a href="#l1.4796"></a><span id="l1.4796">                               &amp;changeReadState);</span>
<a href="#l1.4797"></a><span id="l1.4797">       nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l1.4798"></a><span id="l1.4798">       rv = server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l1.4799"></a><span id="l1.4799" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4800"></a><span id="l1.4800" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4801"></a><span id="l1.4801">       rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox, targetFolder);</span>
<a href="#l1.4802"></a><span id="l1.4802">       moveMessages = targetFolder != nullptr;</span>
<a href="#l1.4803"></a><span id="l1.4803">     }</span>
<a href="#l1.4804"></a><span id="l1.4804"> </span>
<a href="#l1.4805"></a><span id="l1.4805">     return NS_OK;</span>
<a href="#l1.4806"></a><span id="l1.4806">   }</span>
<a href="#l1.4807"></a><span id="l1.4807"> </span>
<a href="#l1.4808"></a><span id="l1.4808" class="difflineminus">-  nsCOMPtr &lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l1.4809"></a><span id="l1.4809" class="difflineplus">+  nsCOMPtr&lt;nsISpamSettings&gt; spamSettings;</span>
<a href="#l1.4810"></a><span id="l1.4810">   rv = server-&gt;GetSpamSettings(getter_AddRefs(spamSettings));</span>
<a href="#l1.4811"></a><span id="l1.4811">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4812"></a><span id="l1.4812"> </span>
<a href="#l1.4813"></a><span id="l1.4813">   // When the user explicitly marks a message as junk, we can mark it as read,</span>
<a href="#l1.4814"></a><span id="l1.4814">   // too. This is independent of the &quot;markAsReadOnSpam&quot; pref, which applies</span>
<a href="#l1.4815"></a><span id="l1.4815">   // only to automatically-classified messages.</span>
<a href="#l1.4816"></a><span id="l1.4816">   // Note that this behaviour should match the one in the front end for marking</span>
<a href="#l1.4817"></a><span id="l1.4817">   // as junk via toolbar/context menu.</span>
<a href="#l1.4818"></a><span id="l1.4818">   prefBranch-&gt;GetBoolPref(&quot;mailnews.ui.junk.manualMarkAsJunkMarksRead&quot;,</span>
<a href="#l1.4819"></a><span id="l1.4819">                           &amp;changeReadState);</span>
<a href="#l1.4820"></a><span id="l1.4820"> </span>
<a href="#l1.4821"></a><span id="l1.4821">   // Now let's determine whether we'll be taking the second action,</span>
<a href="#l1.4822"></a><span id="l1.4822">   // the move / deletion (and also determine which of these two).</span>
<a href="#l1.4823"></a><span id="l1.4823">   bool manualMark;</span>
<a href="#l1.4824"></a><span id="l1.4824">   (void)spamSettings-&gt;GetManualMark(&amp;manualMark);</span>
<a href="#l1.4825"></a><span id="l1.4825" class="difflineminus">-  if (!manualMark)</span>
<a href="#l1.4826"></a><span id="l1.4826" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.4827"></a><span id="l1.4827" class="difflineplus">+  if (!manualMark) return NS_OK;</span>
<a href="#l1.4828"></a><span id="l1.4828"> </span>
<a href="#l1.4829"></a><span id="l1.4829">   int32_t manualMarkMode;</span>
<a href="#l1.4830"></a><span id="l1.4830">   (void)spamSettings-&gt;GetManualMarkMode(&amp;manualMarkMode);</span>
<a href="#l1.4831"></a><span id="l1.4831">   NS_ASSERTION(manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE ||</span>
<a href="#l1.4832"></a><span id="l1.4832" class="difflineminus">-               manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE,</span>
<a href="#l1.4833"></a><span id="l1.4833" class="difflineplus">+                   manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE,</span>
<a href="#l1.4834"></a><span id="l1.4834">                &quot;bad manual mark mode&quot;);</span>
<a href="#l1.4835"></a><span id="l1.4835"> </span>
<a href="#l1.4836"></a><span id="l1.4836" class="difflineminus">-  if (manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE)</span>
<a href="#l1.4837"></a><span id="l1.4837" class="difflineminus">-  {</span>
<a href="#l1.4838"></a><span id="l1.4838" class="difflineplus">+  if (manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_MOVE) {</span>
<a href="#l1.4839"></a><span id="l1.4839">     // If this is a junk folder (not only &quot;the&quot; junk folder for this account)</span>
<a href="#l1.4840"></a><span id="l1.4840">     // don't do the move.</span>
<a href="#l1.4841"></a><span id="l1.4841" class="difflineminus">-    if (folderFlags &amp; nsMsgFolderFlags::Junk)</span>
<a href="#l1.4842"></a><span id="l1.4842" class="difflineminus">-      return NS_OK;</span>
<a href="#l1.4843"></a><span id="l1.4843" class="difflineplus">+    if (folderFlags &amp; nsMsgFolderFlags::Junk) return NS_OK;</span>
<a href="#l1.4844"></a><span id="l1.4844"> </span>
<a href="#l1.4845"></a><span id="l1.4845">     nsCString spamFolderURI;</span>
<a href="#l1.4846"></a><span id="l1.4846">     rv = spamSettings-&gt;GetSpamFolderURI(getter_Copies(spamFolderURI));</span>
<a href="#l1.4847"></a><span id="l1.4847" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4848"></a><span id="l1.4848" class="difflineminus">-</span>
<a href="#l1.4849"></a><span id="l1.4849" class="difflineminus">-    NS_ASSERTION(!spamFolderURI.IsEmpty(), &quot;spam folder URI is empty, can't move&quot;);</span>
<a href="#l1.4850"></a><span id="l1.4850" class="difflineminus">-    if (!spamFolderURI.IsEmpty())</span>
<a href="#l1.4851"></a><span id="l1.4851" class="difflineminus">-    {</span>
<a href="#l1.4852"></a><span id="l1.4852" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4853"></a><span id="l1.4853" class="difflineplus">+</span>
<a href="#l1.4854"></a><span id="l1.4854" class="difflineplus">+    NS_ASSERTION(!spamFolderURI.IsEmpty(),</span>
<a href="#l1.4855"></a><span id="l1.4855" class="difflineplus">+                 &quot;spam folder URI is empty, can't move&quot;);</span>
<a href="#l1.4856"></a><span id="l1.4856" class="difflineplus">+    if (!spamFolderURI.IsEmpty()) {</span>
<a href="#l1.4857"></a><span id="l1.4857">       rv = FindFolder(spamFolderURI, targetFolder);</span>
<a href="#l1.4858"></a><span id="l1.4858" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.4859"></a><span id="l1.4859" class="difflineminus">-      if (*targetFolder)</span>
<a href="#l1.4860"></a><span id="l1.4860" class="difflineminus">-      {</span>
<a href="#l1.4861"></a><span id="l1.4861" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.4862"></a><span id="l1.4862" class="difflineplus">+      if (*targetFolder) {</span>
<a href="#l1.4863"></a><span id="l1.4863">         moveMessages = true;</span>
<a href="#l1.4864"></a><span id="l1.4864" class="difflineminus">-      }</span>
<a href="#l1.4865"></a><span id="l1.4865" class="difflineminus">-      else</span>
<a href="#l1.4866"></a><span id="l1.4866" class="difflineminus">-      {</span>
<a href="#l1.4867"></a><span id="l1.4867" class="difflineminus">-        // XXX ToDo: GetOrCreateJunkFolder will only create a folder with localized</span>
<a href="#l1.4868"></a><span id="l1.4868" class="difflineminus">-        //           name &quot;Junk&quot; regardless of spamFolderURI. So if someone</span>
<a href="#l1.4869"></a><span id="l1.4869" class="difflineminus">-        //           sets the junk folder to an existing folder of a different</span>
<a href="#l1.4870"></a><span id="l1.4870" class="difflineminus">-        //           name, then deletes that folder, this will fail to create</span>
<a href="#l1.4871"></a><span id="l1.4871" class="difflineminus">-        //           the correct folder.</span>
<a href="#l1.4872"></a><span id="l1.4872" class="difflineplus">+      } else {</span>
<a href="#l1.4873"></a><span id="l1.4873" class="difflineplus">+        // XXX TODO: GetOrCreateJunkFolder will only create a folder with</span>
<a href="#l1.4874"></a><span id="l1.4874" class="difflineplus">+        // localized name &quot;Junk&quot; regardless of spamFolderURI. So if someone</span>
<a href="#l1.4875"></a><span id="l1.4875" class="difflineplus">+        // sets the junk folder to an existing folder of a different name,</span>
<a href="#l1.4876"></a><span id="l1.4876" class="difflineplus">+        // then deletes that folder, this will fail to create the correct</span>
<a href="#l1.4877"></a><span id="l1.4877" class="difflineplus">+        // folder.</span>
<a href="#l1.4878"></a><span id="l1.4878">         rv = GetOrCreateJunkFolder(spamFolderURI, nullptr /* aListener */);</span>
<a href="#l1.4879"></a><span id="l1.4879">         if (NS_SUCCEEDED(rv))</span>
<a href="#l1.4880"></a><span id="l1.4880">           rv = GetExistingFolder(spamFolderURI, targetFolder);</span>
<a href="#l1.4881"></a><span id="l1.4881"> </span>
<a href="#l1.4882"></a><span id="l1.4882">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;GetOrCreateJunkFolder failed&quot;);</span>
<a href="#l1.4883"></a><span id="l1.4883">       }</span>
<a href="#l1.4884"></a><span id="l1.4884">     }</span>
<a href="#l1.4885"></a><span id="l1.4885"> </span>
<a href="#l1.4886"></a><span id="l1.4886">     return NS_OK;</span>
<a href="#l1.4887"></a><span id="l1.4887">   }</span>
<a href="#l1.4888"></a><span id="l1.4888"> </span>
<a href="#l1.4889"></a><span id="l1.4889">   // At this point manualMarkMode == nsISpamSettings::MANUAL_MARK_MODE_DELETE).</span>
<a href="#l1.4890"></a><span id="l1.4890"> </span>
<a href="#l1.4891"></a><span id="l1.4891">   // If this is in the trash, let's not delete.</span>
<a href="#l1.4892"></a><span id="l1.4892" class="difflineminus">-  if (folderFlags &amp; nsMsgFolderFlags::Trash)</span>
<a href="#l1.4893"></a><span id="l1.4893" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.4894"></a><span id="l1.4894" class="difflineplus">+  if (folderFlags &amp; nsMsgFolderFlags::Trash) return NS_OK;</span>
<a href="#l1.4895"></a><span id="l1.4895"> </span>
<a href="#l1.4896"></a><span id="l1.4896">   return srcFolder-&gt;GetCanDeleteMessages(&amp;moveMessages);</span>
<a href="#l1.4897"></a><span id="l1.4897"> }</span>
<a href="#l1.4898"></a><span id="l1.4898"> </span>
<a href="#l1.4899"></a><span id="l1.4899"> // Reversing threads involves reversing the threads but leaving the</span>
<a href="#l1.4900"></a><span id="l1.4900"> // expanded messages ordered relative to the thread, so we</span>
<a href="#l1.4901"></a><span id="l1.4901"> // make a copy of each array and copy them over.</span>
<a href="#l1.4902"></a><span id="l1.4902" class="difflineminus">-void nsMsgDBView::ReverseThreads()</span>
<a href="#l1.4903"></a><span id="l1.4903" class="difflineminus">-{</span>
<a href="#l1.4904"></a><span id="l1.4904" class="difflineplus">+void nsMsgDBView::ReverseThreads() {</span>
<a href="#l1.4905"></a><span id="l1.4905">   nsTArray&lt;uint32_t&gt; newFlagArray;</span>
<a href="#l1.4906"></a><span id="l1.4906">   nsTArray&lt;nsMsgKey&gt; newKeyArray;</span>
<a href="#l1.4907"></a><span id="l1.4907">   nsTArray&lt;uint8_t&gt; newLevelArray;</span>
<a href="#l1.4908"></a><span id="l1.4908"> </span>
<a href="#l1.4909"></a><span id="l1.4909">   uint32_t viewSize = GetSize();</span>
<a href="#l1.4910"></a><span id="l1.4910">   uint32_t startThread = viewSize;</span>
<a href="#l1.4911"></a><span id="l1.4911">   uint32_t nextThread = viewSize;</span>
<a href="#l1.4912"></a><span id="l1.4912">   uint32_t destIndex = 0;</span>
<a href="#l1.4913"></a><span id="l1.4913"> </span>
<a href="#l1.4914"></a><span id="l1.4914">   newKeyArray.SetLength(m_keys.Length());</span>
<a href="#l1.4915"></a><span id="l1.4915">   newFlagArray.SetLength(m_flags.Length());</span>
<a href="#l1.4916"></a><span id="l1.4916">   newLevelArray.SetLength(m_levels.Length());</span>
<a href="#l1.4917"></a><span id="l1.4917"> </span>
<a href="#l1.4918"></a><span id="l1.4918" class="difflineminus">-  while (startThread)</span>
<a href="#l1.4919"></a><span id="l1.4919" class="difflineminus">-  {</span>
<a href="#l1.4920"></a><span id="l1.4920" class="difflineplus">+  while (startThread) {</span>
<a href="#l1.4921"></a><span id="l1.4921">     startThread--;</span>
<a href="#l1.4922"></a><span id="l1.4922"> </span>
<a href="#l1.4923"></a><span id="l1.4923" class="difflineminus">-    if (m_flags[startThread] &amp; MSG_VIEW_FLAG_ISTHREAD)</span>
<a href="#l1.4924"></a><span id="l1.4924" class="difflineminus">-    {</span>
<a href="#l1.4925"></a><span id="l1.4925" class="difflineminus">-      for (uint32_t sourceIndex = startThread; sourceIndex &lt; nextThread; sourceIndex++)</span>
<a href="#l1.4926"></a><span id="l1.4926" class="difflineminus">-      {</span>
<a href="#l1.4927"></a><span id="l1.4927" class="difflineplus">+    if (m_flags[startThread] &amp; MSG_VIEW_FLAG_ISTHREAD) {</span>
<a href="#l1.4928"></a><span id="l1.4928" class="difflineplus">+      for (uint32_t sourceIndex = startThread; sourceIndex &lt; nextThread;</span>
<a href="#l1.4929"></a><span id="l1.4929" class="difflineplus">+           sourceIndex++) {</span>
<a href="#l1.4930"></a><span id="l1.4930">         newKeyArray[destIndex] = m_keys[sourceIndex];</span>
<a href="#l1.4931"></a><span id="l1.4931">         newFlagArray[destIndex] = m_flags[sourceIndex];</span>
<a href="#l1.4932"></a><span id="l1.4932">         newLevelArray[destIndex] = m_levels[sourceIndex];</span>
<a href="#l1.4933"></a><span id="l1.4933">         destIndex++;</span>
<a href="#l1.4934"></a><span id="l1.4934">       }</span>
<a href="#l1.4935"></a><span id="l1.4935">       // Because we're copying in reverse order.</span>
<a href="#l1.4936"></a><span id="l1.4936">       nextThread = startThread;</span>
<a href="#l1.4937"></a><span id="l1.4937">     }</span>
<a href="#l1.4938"></a><span id="l1.4938">   }</span>
<a href="#l1.4939"></a><span id="l1.4939"> </span>
<a href="#l1.4940"></a><span id="l1.4940">   m_keys.SwapElements(newKeyArray);</span>
<a href="#l1.4941"></a><span id="l1.4941">   m_flags.SwapElements(newFlagArray);</span>
<a href="#l1.4942"></a><span id="l1.4942">   m_levels.SwapElements(newLevelArray);</span>
<a href="#l1.4943"></a><span id="l1.4943"> }</span>
<a href="#l1.4944"></a><span id="l1.4944"> </span>
<a href="#l1.4945"></a><span id="l1.4945" class="difflineminus">-void nsMsgDBView::ReverseSort()</span>
<a href="#l1.4946"></a><span id="l1.4946" class="difflineminus">-{</span>
<a href="#l1.4947"></a><span id="l1.4947" class="difflineplus">+void nsMsgDBView::ReverseSort() {</span>
<a href="#l1.4948"></a><span id="l1.4948">   uint32_t topIndex = GetSize();</span>
<a href="#l1.4949"></a><span id="l1.4949"> </span>
<a href="#l1.4950"></a><span id="l1.4950">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.4951"></a><span id="l1.4951"> </span>
<a href="#l1.4952"></a><span id="l1.4952">   // Go up half the array swapping values.</span>
<a href="#l1.4953"></a><span id="l1.4953" class="difflineminus">-  for (uint32_t bottomIndex = 0; bottomIndex &lt; --topIndex; bottomIndex++)</span>
<a href="#l1.4954"></a><span id="l1.4954" class="difflineminus">-  {</span>
<a href="#l1.4955"></a><span id="l1.4955" class="difflineplus">+  for (uint32_t bottomIndex = 0; bottomIndex &lt; --topIndex; bottomIndex++) {</span>
<a href="#l1.4956"></a><span id="l1.4956">     // Swap flags.</span>
<a href="#l1.4957"></a><span id="l1.4957">     uint32_t tempFlags = m_flags[bottomIndex];</span>
<a href="#l1.4958"></a><span id="l1.4958">     m_flags[bottomIndex] = m_flags[topIndex];</span>
<a href="#l1.4959"></a><span id="l1.4959">     m_flags[topIndex] = tempFlags;</span>
<a href="#l1.4960"></a><span id="l1.4960"> </span>
<a href="#l1.4961"></a><span id="l1.4961">     // Swap keys.</span>
<a href="#l1.4962"></a><span id="l1.4962">     nsMsgKey tempKey = m_keys[bottomIndex];</span>
<a href="#l1.4963"></a><span id="l1.4963">     m_keys[bottomIndex] = m_keys[topIndex];</span>
<a href="#l1.4964"></a><span id="l1.4964">     m_keys[topIndex] = tempKey;</span>
<a href="#l1.4965"></a><span id="l1.4965"> </span>
<a href="#l1.4966"></a><span id="l1.4966" class="difflineminus">-    if (folders)</span>
<a href="#l1.4967"></a><span id="l1.4967" class="difflineminus">-    {</span>
<a href="#l1.4968"></a><span id="l1.4968" class="difflineplus">+    if (folders) {</span>
<a href="#l1.4969"></a><span id="l1.4969">       // Swap folders -- needed when search is done across multiple folders.</span>
<a href="#l1.4970"></a><span id="l1.4970">       nsIMsgFolder *bottomFolder = folders-&gt;ObjectAt(bottomIndex);</span>
<a href="#l1.4971"></a><span id="l1.4971">       nsIMsgFolder *topFolder = folders-&gt;ObjectAt(topIndex);</span>
<a href="#l1.4972"></a><span id="l1.4972">       folders-&gt;ReplaceObjectAt(topFolder, bottomIndex);</span>
<a href="#l1.4973"></a><span id="l1.4973">       folders-&gt;ReplaceObjectAt(bottomFolder, topIndex);</span>
<a href="#l1.4974"></a><span id="l1.4974">     }</span>
<a href="#l1.4975"></a><span id="l1.4975"> </span>
<a href="#l1.4976"></a><span id="l1.4976">     // No need to swap elements in m_levels; since we only call</span>
<a href="#l1.4977"></a><span id="l1.4977">     // ReverseSort in non-threaded mode, m_levels are all the same.</span>
<a href="#l1.4978"></a><span id="l1.4978">   }</span>
<a href="#l1.4979"></a><span id="l1.4979"> }</span>
<a href="#l1.4980"></a><span id="l1.4980"> </span>
<a href="#l1.4981"></a><span id="l1.4981" class="difflineminus">-int</span>
<a href="#l1.4982"></a><span id="l1.4982" class="difflineminus">-nsMsgDBView::FnSortIdKey(const void *pItem1,</span>
<a href="#l1.4983"></a><span id="l1.4983" class="difflineminus">-                         const void *pItem2,</span>
<a href="#l1.4984"></a><span id="l1.4984" class="difflineminus">-                         void *privateData)</span>
<a href="#l1.4985"></a><span id="l1.4985" class="difflineminus">-{</span>
<a href="#l1.4986"></a><span id="l1.4986" class="difflineplus">+int nsMsgDBView::FnSortIdKey(const void *pItem1, const void *pItem2,</span>
<a href="#l1.4987"></a><span id="l1.4987" class="difflineplus">+                             void *privateData) {</span>
<a href="#l1.4988"></a><span id="l1.4988">   int32_t retVal = 0;</span>
<a href="#l1.4989"></a><span id="l1.4989"> </span>
<a href="#l1.4990"></a><span id="l1.4990" class="difflineminus">-  IdKey** p1 = (IdKey**)pItem1;</span>
<a href="#l1.4991"></a><span id="l1.4991" class="difflineminus">-  IdKey** p2 = (IdKey**)pItem2;</span>
<a href="#l1.4992"></a><span id="l1.4992" class="difflineminus">-  viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.4993"></a><span id="l1.4993" class="difflineplus">+  IdKey **p1 = (IdKey **)pItem1;</span>
<a href="#l1.4994"></a><span id="l1.4994" class="difflineplus">+  IdKey **p2 = (IdKey **)pItem2;</span>
<a href="#l1.4995"></a><span id="l1.4995" class="difflineplus">+  viewSortInfo *sortInfo = (viewSortInfo *)privateData;</span>
<a href="#l1.4996"></a><span id="l1.4996"> </span>
<a href="#l1.4997"></a><span id="l1.4997">   nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l1.4998"></a><span id="l1.4998"> </span>
<a href="#l1.4999"></a><span id="l1.4999" class="difflineminus">-  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword,</span>
<a href="#l1.5000"></a><span id="l1.5000" class="difflineminus">-                                                             (*p1)-&gt;key,</span>
<a href="#l1.5001"></a><span id="l1.5001" class="difflineminus">-                                                             (*p2)-&gt;dword,</span>
<a href="#l1.5002"></a><span id="l1.5002" class="difflineminus">-                                                             (*p2)-&gt;key,</span>
<a href="#l1.5003"></a><span id="l1.5003" class="difflineminus">-                                                             &amp;retVal);</span>
<a href="#l1.5004"></a><span id="l1.5004" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys(</span>
<a href="#l1.5005"></a><span id="l1.5005" class="difflineplus">+      (*p1)-&gt;dword, (*p1)-&gt;key, (*p2)-&gt;dword, (*p2)-&gt;key, &amp;retVal);</span>
<a href="#l1.5006"></a><span id="l1.5006">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;compare failed&quot;);</span>
<a href="#l1.5007"></a><span id="l1.5007"> </span>
<a href="#l1.5008"></a><span id="l1.5008" class="difflineminus">-  if (retVal)</span>
<a href="#l1.5009"></a><span id="l1.5009" class="difflineminus">-    return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.5010"></a><span id="l1.5010" class="difflineminus">-</span>
<a href="#l1.5011"></a><span id="l1.5011" class="difflineplus">+  if (retVal) return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.5012"></a><span id="l1.5012" class="difflineplus">+</span>
<a href="#l1.5013"></a><span id="l1.5013" class="difflineplus">+  // clang-format off</span>
<a href="#l1.5014"></a><span id="l1.5014">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.5015"></a><span id="l1.5015">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.5016"></a><span id="l1.5016">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.5017"></a><span id="l1.5017" class="difflineplus">+  // clang-format on</span>
<a href="#l1.5018"></a><span id="l1.5018">   else</span>
<a href="#l1.5019"></a><span id="l1.5019" class="difflineminus">-    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.5020"></a><span id="l1.5020" class="difflineminus">-                                         (*p1)-&gt;folder,</span>
<a href="#l1.5021"></a><span id="l1.5021" class="difflineminus">-                                         (*p2)-&gt;id,</span>
<a href="#l1.5022"></a><span id="l1.5022" class="difflineminus">-                                         (*p2)-&gt;folder,</span>
<a href="#l1.5023"></a><span id="l1.5023" class="difflineminus">-                                         sortInfo);</span>
<a href="#l1.5024"></a><span id="l1.5024" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id,</span>
<a href="#l1.5025"></a><span id="l1.5025" class="difflineplus">+                                         (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.5026"></a><span id="l1.5026">   // Here we'd use the secondary sort.</span>
<a href="#l1.5027"></a><span id="l1.5027"> }</span>
<a href="#l1.5028"></a><span id="l1.5028"> </span>
<a href="#l1.5029"></a><span id="l1.5029" class="difflineminus">-int</span>
<a href="#l1.5030"></a><span id="l1.5030" class="difflineminus">-nsMsgDBView::FnSortIdKeyPtr(const void *pItem1,</span>
<a href="#l1.5031"></a><span id="l1.5031" class="difflineminus">-                            const void *pItem2,</span>
<a href="#l1.5032"></a><span id="l1.5032" class="difflineminus">-                            void *privateData)</span>
<a href="#l1.5033"></a><span id="l1.5033" class="difflineminus">-{</span>
<a href="#l1.5034"></a><span id="l1.5034" class="difflineplus">+int nsMsgDBView::FnSortIdKeyPtr(const void *pItem1, const void *pItem2,</span>
<a href="#l1.5035"></a><span id="l1.5035" class="difflineplus">+                                void *privateData) {</span>
<a href="#l1.5036"></a><span id="l1.5036">   int32_t retVal = 0;</span>
<a href="#l1.5037"></a><span id="l1.5037"> </span>
<a href="#l1.5038"></a><span id="l1.5038" class="difflineminus">-  IdKeyPtr** p1 = (IdKeyPtr**)pItem1;</span>
<a href="#l1.5039"></a><span id="l1.5039" class="difflineminus">-  IdKeyPtr** p2 = (IdKeyPtr**)pItem2;</span>
<a href="#l1.5040"></a><span id="l1.5040" class="difflineminus">-  viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.5041"></a><span id="l1.5041" class="difflineplus">+  IdKeyPtr **p1 = (IdKeyPtr **)pItem1;</span>
<a href="#l1.5042"></a><span id="l1.5042" class="difflineplus">+  IdKeyPtr **p2 = (IdKeyPtr **)pItem2;</span>
<a href="#l1.5043"></a><span id="l1.5043" class="difflineplus">+  viewSortInfo *sortInfo = (viewSortInfo *)privateData;</span>
<a href="#l1.5044"></a><span id="l1.5044"> </span>
<a href="#l1.5045"></a><span id="l1.5045">   nsIMsgDatabase *db = sortInfo-&gt;db;</span>
<a href="#l1.5046"></a><span id="l1.5046"> </span>
<a href="#l1.5047"></a><span id="l1.5047" class="difflineminus">-  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys((*p1)-&gt;dword,</span>
<a href="#l1.5048"></a><span id="l1.5048" class="difflineminus">-                                                             (*p1)-&gt;key,</span>
<a href="#l1.5049"></a><span id="l1.5049" class="difflineminus">-                                                             (*p2)-&gt;dword,</span>
<a href="#l1.5050"></a><span id="l1.5050" class="difflineminus">-                                                             (*p2)-&gt;key,</span>
<a href="#l1.5051"></a><span id="l1.5051" class="difflineminus">-                                                             &amp;retVal);</span>
<a href="#l1.5052"></a><span id="l1.5052" class="difflineplus">+  mozilla::DebugOnly&lt;nsresult&gt; rv = db-&gt;CompareCollationKeys(</span>
<a href="#l1.5053"></a><span id="l1.5053" class="difflineplus">+      (*p1)-&gt;dword, (*p1)-&gt;key, (*p2)-&gt;dword, (*p2)-&gt;key, &amp;retVal);</span>
<a href="#l1.5054"></a><span id="l1.5054">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;compare failed&quot;);</span>
<a href="#l1.5055"></a><span id="l1.5055"> </span>
<a href="#l1.5056"></a><span id="l1.5056" class="difflineminus">-  if (retVal)</span>
<a href="#l1.5057"></a><span id="l1.5057" class="difflineminus">-    return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.5058"></a><span id="l1.5058" class="difflineminus">-</span>
<a href="#l1.5059"></a><span id="l1.5059" class="difflineplus">+  if (retVal) return sortInfo-&gt;ascendingSort ? retVal : -retVal;</span>
<a href="#l1.5060"></a><span id="l1.5060" class="difflineplus">+</span>
<a href="#l1.5061"></a><span id="l1.5061" class="difflineplus">+  // clang-format off</span>
<a href="#l1.5062"></a><span id="l1.5062">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.5063"></a><span id="l1.5063">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.5064"></a><span id="l1.5064">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.5065"></a><span id="l1.5065" class="difflineplus">+  // clang-format on</span>
<a href="#l1.5066"></a><span id="l1.5066">   else</span>
<a href="#l1.5067"></a><span id="l1.5067" class="difflineminus">-    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.5068"></a><span id="l1.5068" class="difflineminus">-                                         (*p1)-&gt;folder,</span>
<a href="#l1.5069"></a><span id="l1.5069" class="difflineminus">-                                         (*p2)-&gt;id,</span>
<a href="#l1.5070"></a><span id="l1.5070" class="difflineminus">-                                         (*p2)-&gt;folder,</span>
<a href="#l1.5071"></a><span id="l1.5071" class="difflineminus">-                                         sortInfo);</span>
<a href="#l1.5072"></a><span id="l1.5072" class="difflineminus">-}</span>
<a href="#l1.5073"></a><span id="l1.5073" class="difflineminus">-</span>
<a href="#l1.5074"></a><span id="l1.5074" class="difflineminus">-int</span>
<a href="#l1.5075"></a><span id="l1.5075" class="difflineminus">-nsMsgDBView::FnSortIdUint32(const void *pItem1,</span>
<a href="#l1.5076"></a><span id="l1.5076" class="difflineminus">-                            const void *pItem2,</span>
<a href="#l1.5077"></a><span id="l1.5077" class="difflineminus">-                            void *privateData)</span>
<a href="#l1.5078"></a><span id="l1.5078" class="difflineminus">-{</span>
<a href="#l1.5079"></a><span id="l1.5079" class="difflineminus">-  IdUint32** p1 = (IdUint32**)pItem1;</span>
<a href="#l1.5080"></a><span id="l1.5080" class="difflineminus">-  IdUint32** p2 = (IdUint32**)pItem2;</span>
<a href="#l1.5081"></a><span id="l1.5081" class="difflineminus">-  viewSortInfo* sortInfo = (viewSortInfo *) privateData;</span>
<a href="#l1.5082"></a><span id="l1.5082" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id,</span>
<a href="#l1.5083"></a><span id="l1.5083" class="difflineplus">+                                         (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.5084"></a><span id="l1.5084" class="difflineplus">+}</span>
<a href="#l1.5085"></a><span id="l1.5085" class="difflineplus">+</span>
<a href="#l1.5086"></a><span id="l1.5086" class="difflineplus">+int nsMsgDBView::FnSortIdUint32(const void *pItem1, const void *pItem2,</span>
<a href="#l1.5087"></a><span id="l1.5087" class="difflineplus">+                                void *privateData) {</span>
<a href="#l1.5088"></a><span id="l1.5088" class="difflineplus">+  IdUint32 **p1 = (IdUint32 **)pItem1;</span>
<a href="#l1.5089"></a><span id="l1.5089" class="difflineplus">+  IdUint32 **p2 = (IdUint32 **)pItem2;</span>
<a href="#l1.5090"></a><span id="l1.5090" class="difflineplus">+  viewSortInfo *sortInfo = (viewSortInfo *)privateData;</span>
<a href="#l1.5091"></a><span id="l1.5091"> </span>
<a href="#l1.5092"></a><span id="l1.5092">   if ((*p1)-&gt;dword &gt; (*p2)-&gt;dword)</span>
<a href="#l1.5093"></a><span id="l1.5093">     return (sortInfo-&gt;ascendingSort) ? 1 : -1;</span>
<a href="#l1.5094"></a><span id="l1.5094">   else if ((*p1)-&gt;dword &lt; (*p2)-&gt;dword)</span>
<a href="#l1.5095"></a><span id="l1.5095">     return (sortInfo-&gt;ascendingSort) ? -1 : 1;</span>
<a href="#l1.5096"></a><span id="l1.5096"> </span>
<a href="#l1.5097"></a><span id="l1.5097" class="difflineplus">+  // clang-format off</span>
<a href="#l1.5098"></a><span id="l1.5098">   if (sortInfo-&gt;view-&gt;m_secondarySort == nsMsgViewSortType::byId)</span>
<a href="#l1.5099"></a><span id="l1.5099">     return (sortInfo-&gt;view-&gt;m_secondarySortOrder == nsMsgViewSortOrder::ascending &amp;&amp;</span>
<a href="#l1.5100"></a><span id="l1.5100">             (*p1)-&gt;id &gt;= (*p2)-&gt;id) ? 1 : -1;</span>
<a href="#l1.5101"></a><span id="l1.5101" class="difflineplus">+  // clang-format on</span>
<a href="#l1.5102"></a><span id="l1.5102">   else</span>
<a href="#l1.5103"></a><span id="l1.5103" class="difflineminus">-    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id,</span>
<a href="#l1.5104"></a><span id="l1.5104" class="difflineminus">-                                         (*p1)-&gt;folder,</span>
<a href="#l1.5105"></a><span id="l1.5105" class="difflineminus">-                                         (*p2)-&gt;id,</span>
<a href="#l1.5106"></a><span id="l1.5106" class="difflineminus">-                                         (*p2)-&gt;folder,</span>
<a href="#l1.5107"></a><span id="l1.5107" class="difflineminus">-                                         sortInfo);</span>
<a href="#l1.5108"></a><span id="l1.5108" class="difflineplus">+    return sortInfo-&gt;view-&gt;SecondarySort((*p1)-&gt;id, (*p1)-&gt;folder, (*p2)-&gt;id,</span>
<a href="#l1.5109"></a><span id="l1.5109" class="difflineplus">+                                         (*p2)-&gt;folder, sortInfo);</span>
<a href="#l1.5110"></a><span id="l1.5110"> }</span>
<a href="#l1.5111"></a><span id="l1.5111"> </span>
<a href="#l1.5112"></a><span id="l1.5112"> // XXX are these still correct?</span>
<a href="#l1.5113"></a><span id="l1.5113"> // To compensate for memory alignment required for systems such as HP-UX, these</span>
<a href="#l1.5114"></a><span id="l1.5114" class="difflineminus">-// values must be 4 bytes aligned. Don't break this when modifying the constants.</span>
<a href="#l1.5115"></a><span id="l1.5115" class="difflineplus">+// values must be 4 bytes aligned. Don't break this when modifying the</span>
<a href="#l1.5116"></a><span id="l1.5116" class="difflineplus">+// constants.</span>
<a href="#l1.5117"></a><span id="l1.5117"> const int kMaxSubjectKey = 160;</span>
<a href="#l1.5118"></a><span id="l1.5118" class="difflineminus">-const int kMaxLocationKey = 160; // Also used for account.</span>
<a href="#l1.5119"></a><span id="l1.5119" class="difflineplus">+const int kMaxLocationKey = 160;  // Also used for account.</span>
<a href="#l1.5120"></a><span id="l1.5120"> const int kMaxAuthorKey = 160;</span>
<a href="#l1.5121"></a><span id="l1.5121"> const int kMaxRecipientKey = 80;</span>
<a href="#l1.5122"></a><span id="l1.5122"> </span>
<a href="#l1.5123"></a><span id="l1.5123"> // There are cases when pFieldType is not set:</span>
<a href="#l1.5124"></a><span id="l1.5124"> // one case returns NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5125"></a><span id="l1.5125"> // the other case now return NS_ERROR_NULL_POINTER (this is only when</span>
<a href="#l1.5126"></a><span id="l1.5126"> // colHandler below is null, but is very unlikely).</span>
<a href="#l1.5127"></a><span id="l1.5127"> // The latter case used to return NS_OK, which was incorrect.</span>
<a href="#l1.5128"></a><span id="l1.5128" class="difflineminus">-nsresult nsMsgDBView::GetFieldTypeAndLenForSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5129"></a><span id="l1.5129" class="difflineminus">-                                                uint16_t *pMaxLen,</span>
<a href="#l1.5130"></a><span id="l1.5130" class="difflineminus">-                                                eFieldType *pFieldType,</span>
<a href="#l1.5131"></a><span id="l1.5131" class="difflineminus">-                                                nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5132"></a><span id="l1.5132" class="difflineminus">-{</span>
<a href="#l1.5133"></a><span id="l1.5133" class="difflineplus">+nsresult nsMsgDBView::GetFieldTypeAndLenForSort(</span>
<a href="#l1.5134"></a><span id="l1.5134" class="difflineplus">+    nsMsgViewSortTypeValue sortType, uint16_t *pMaxLen, eFieldType *pFieldType,</span>
<a href="#l1.5135"></a><span id="l1.5135" class="difflineplus">+    nsIMsgCustomColumnHandler *colHandler) {</span>
<a href="#l1.5136"></a><span id="l1.5136">   NS_ENSURE_ARG_POINTER(pMaxLen);</span>
<a href="#l1.5137"></a><span id="l1.5137">   NS_ENSURE_ARG_POINTER(pFieldType);</span>
<a href="#l1.5138"></a><span id="l1.5138"> </span>
<a href="#l1.5139"></a><span id="l1.5139" class="difflineminus">-  switch (sortType)</span>
<a href="#l1.5140"></a><span id="l1.5140" class="difflineminus">-  {</span>
<a href="#l1.5141"></a><span id="l1.5141" class="difflineplus">+  switch (sortType) {</span>
<a href="#l1.5142"></a><span id="l1.5142">     case nsMsgViewSortType::bySubject:</span>
<a href="#l1.5143"></a><span id="l1.5143">       *pFieldType = kCollationKey;</span>
<a href="#l1.5144"></a><span id="l1.5144">       *pMaxLen = kMaxSubjectKey;</span>
<a href="#l1.5145"></a><span id="l1.5145">       break;</span>
<a href="#l1.5146"></a><span id="l1.5146">     case nsMsgViewSortType::byAccount:</span>
<a href="#l1.5147"></a><span id="l1.5147">     case nsMsgViewSortType::byTags:</span>
<a href="#l1.5148"></a><span id="l1.5148">     case nsMsgViewSortType::byLocation:</span>
<a href="#l1.5149"></a><span id="l1.5149">       *pFieldType = kCollationKey;</span>
<a href="#l1.5150"></a><span id="l1.5150" class="difflineat">@@ -4395,77 +3816,68 @@ nsresult nsMsgDBView::GetFieldTypeAndLen</span>
<a href="#l1.5151"></a><span id="l1.5151">     case nsMsgViewSortType::byFlagged:</span>
<a href="#l1.5152"></a><span id="l1.5152">     case nsMsgViewSortType::byUnread:</span>
<a href="#l1.5153"></a><span id="l1.5153">     case nsMsgViewSortType::byStatus:</span>
<a href="#l1.5154"></a><span id="l1.5154">     case nsMsgViewSortType::byJunkStatus:</span>
<a href="#l1.5155"></a><span id="l1.5155">     case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5156"></a><span id="l1.5156">       *pFieldType = kU32;</span>
<a href="#l1.5157"></a><span id="l1.5157">       *pMaxLen = 0;</span>
<a href="#l1.5158"></a><span id="l1.5158">       break;</span>
<a href="#l1.5159"></a><span id="l1.5159" class="difflineminus">-    case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5160"></a><span id="l1.5160" class="difflineminus">-    {</span>
<a href="#l1.5161"></a><span id="l1.5161" class="difflineminus">-      if (colHandler == nullptr)</span>
<a href="#l1.5162"></a><span id="l1.5162" class="difflineminus">-      {</span>
<a href="#l1.5163"></a><span id="l1.5163" class="difflineplus">+    case nsMsgViewSortType::byCustom: {</span>
<a href="#l1.5164"></a><span id="l1.5164" class="difflineplus">+      if (colHandler == nullptr) {</span>
<a href="#l1.5165"></a><span id="l1.5165">         NS_WARNING(&quot;colHandler is null. *pFieldType is not set.&quot;);</span>
<a href="#l1.5166"></a><span id="l1.5166">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l1.5167"></a><span id="l1.5167">       }</span>
<a href="#l1.5168"></a><span id="l1.5168"> </span>
<a href="#l1.5169"></a><span id="l1.5169">       bool isString;</span>
<a href="#l1.5170"></a><span id="l1.5170">       colHandler-&gt;IsString(&amp;isString);</span>
<a href="#l1.5171"></a><span id="l1.5171"> </span>
<a href="#l1.5172"></a><span id="l1.5172" class="difflineminus">-      if (isString)</span>
<a href="#l1.5173"></a><span id="l1.5173" class="difflineminus">-      {</span>
<a href="#l1.5174"></a><span id="l1.5174" class="difflineplus">+      if (isString) {</span>
<a href="#l1.5175"></a><span id="l1.5175">         *pFieldType = kCollationKey;</span>
<a href="#l1.5176"></a><span id="l1.5176">         // 80 - do we need a separate k?</span>
<a href="#l1.5177"></a><span id="l1.5177">         *pMaxLen = kMaxRecipientKey;</span>
<a href="#l1.5178"></a><span id="l1.5178" class="difflineminus">-      }</span>
<a href="#l1.5179"></a><span id="l1.5179" class="difflineminus">-      else</span>
<a href="#l1.5180"></a><span id="l1.5180" class="difflineminus">-      {</span>
<a href="#l1.5181"></a><span id="l1.5181" class="difflineplus">+      } else {</span>
<a href="#l1.5182"></a><span id="l1.5182">         *pFieldType = kU32;</span>
<a href="#l1.5183"></a><span id="l1.5183">         *pMaxLen = 0;</span>
<a href="#l1.5184"></a><span id="l1.5184">       }</span>
<a href="#l1.5185"></a><span id="l1.5185">       break;</span>
<a href="#l1.5186"></a><span id="l1.5186">     }</span>
<a href="#l1.5187"></a><span id="l1.5187">     case nsMsgViewSortType::byNone:</span>
<a href="#l1.5188"></a><span id="l1.5188">       // Bug 901948.</span>
<a href="#l1.5189"></a><span id="l1.5189">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l1.5190"></a><span id="l1.5190" class="difflineminus">-    default:</span>
<a href="#l1.5191"></a><span id="l1.5191" class="difflineminus">-    {</span>
<a href="#l1.5192"></a><span id="l1.5192" class="difflineplus">+    default: {</span>
<a href="#l1.5193"></a><span id="l1.5193">       nsAutoCString message(&quot;unexpected switch value: sortType=&quot;);</span>
<a href="#l1.5194"></a><span id="l1.5194">       message.AppendInt(sortType);</span>
<a href="#l1.5195"></a><span id="l1.5195">       NS_WARNING(message.get());</span>
<a href="#l1.5196"></a><span id="l1.5196">       return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5197"></a><span id="l1.5197">     }</span>
<a href="#l1.5198"></a><span id="l1.5198">   }</span>
<a href="#l1.5199"></a><span id="l1.5199"> </span>
<a href="#l1.5200"></a><span id="l1.5200">   return NS_OK;</span>
<a href="#l1.5201"></a><span id="l1.5201"> }</span>
<a href="#l1.5202"></a><span id="l1.5202"> </span>
<a href="#l1.5203"></a><span id="l1.5203" class="difflineminus">-#define MSG_STATUS_MASK (nsMsgMessageFlags::Replied | nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.5204"></a><span id="l1.5204" class="difflineminus">-</span>
<a href="#l1.5205"></a><span id="l1.5205" class="difflineminus">-nsresult</span>
<a href="#l1.5206"></a><span id="l1.5206" class="difflineminus">-nsMsgDBView::GetStatusSortValue(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5207"></a><span id="l1.5207" class="difflineminus">-                                uint32_t *result)</span>
<a href="#l1.5208"></a><span id="l1.5208" class="difflineminus">-{</span>
<a href="#l1.5209"></a><span id="l1.5209" class="difflineplus">+#define MSG_STATUS_MASK \</span>
<a href="#l1.5210"></a><span id="l1.5210" class="difflineplus">+  (nsMsgMessageFlags::Replied | nsMsgMessageFlags::Forwarded)</span>
<a href="#l1.5211"></a><span id="l1.5211" class="difflineplus">+</span>
<a href="#l1.5212"></a><span id="l1.5212" class="difflineplus">+nsresult nsMsgDBView::GetStatusSortValue(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5213"></a><span id="l1.5213" class="difflineplus">+                                         uint32_t *result) {</span>
<a href="#l1.5214"></a><span id="l1.5214">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5215"></a><span id="l1.5215">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5216"></a><span id="l1.5216"> </span>
<a href="#l1.5217"></a><span id="l1.5217">   uint32_t messageFlags;</span>
<a href="#l1.5218"></a><span id="l1.5218">   nsresult rv = msgHdr-&gt;GetFlags(&amp;messageFlags);</span>
<a href="#l1.5219"></a><span id="l1.5219" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5220"></a><span id="l1.5220" class="difflineminus">-</span>
<a href="#l1.5221"></a><span id="l1.5221" class="difflineminus">-  if (messageFlags &amp; nsMsgMessageFlags::New)</span>
<a href="#l1.5222"></a><span id="l1.5222" class="difflineminus">-  {</span>
<a href="#l1.5223"></a><span id="l1.5223" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5224"></a><span id="l1.5224" class="difflineplus">+</span>
<a href="#l1.5225"></a><span id="l1.5225" class="difflineplus">+  if (messageFlags &amp; nsMsgMessageFlags::New) {</span>
<a href="#l1.5226"></a><span id="l1.5226">     // Happily, new by definition stands alone.</span>
<a href="#l1.5227"></a><span id="l1.5227">     *result = 0;</span>
<a href="#l1.5228"></a><span id="l1.5228">     return NS_OK;</span>
<a href="#l1.5229"></a><span id="l1.5229">   }</span>
<a href="#l1.5230"></a><span id="l1.5230"> </span>
<a href="#l1.5231"></a><span id="l1.5231" class="difflineminus">-  switch (messageFlags &amp; MSG_STATUS_MASK)</span>
<a href="#l1.5232"></a><span id="l1.5232" class="difflineminus">-  {</span>
<a href="#l1.5233"></a><span id="l1.5233" class="difflineplus">+  switch (messageFlags &amp; MSG_STATUS_MASK) {</span>
<a href="#l1.5234"></a><span id="l1.5234">     case nsMsgMessageFlags::Replied:</span>
<a href="#l1.5235"></a><span id="l1.5235">       *result = 2;</span>
<a href="#l1.5236"></a><span id="l1.5236">       break;</span>
<a href="#l1.5237"></a><span id="l1.5237">     case nsMsgMessageFlags::Forwarded | nsMsgMessageFlags::Replied:</span>
<a href="#l1.5238"></a><span id="l1.5238">       *result = 1;</span>
<a href="#l1.5239"></a><span id="l1.5239">       break;</span>
<a href="#l1.5240"></a><span id="l1.5240">     case nsMsgMessageFlags::Forwarded:</span>
<a href="#l1.5241"></a><span id="l1.5241">       *result = 3;</span>
<a href="#l1.5242"></a><span id="l1.5242" class="difflineat">@@ -4476,59 +3888,54 @@ nsMsgDBView::GetStatusSortValue(nsIMsgDB</span>
<a href="#l1.5243"></a><span id="l1.5243">   }</span>
<a href="#l1.5244"></a><span id="l1.5244"> </span>
<a href="#l1.5245"></a><span id="l1.5245">   return NS_OK;</span>
<a href="#l1.5246"></a><span id="l1.5246"> }</span>
<a href="#l1.5247"></a><span id="l1.5247"> </span>
<a href="#l1.5248"></a><span id="l1.5248"> nsresult nsMsgDBView::GetLongField(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5249"></a><span id="l1.5249">                                    nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5250"></a><span id="l1.5250">                                    uint32_t *result,</span>
<a href="#l1.5251"></a><span id="l1.5251" class="difflineminus">-                                   nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5252"></a><span id="l1.5252" class="difflineminus">-{</span>
<a href="#l1.5253"></a><span id="l1.5253" class="difflineplus">+                                   nsIMsgCustomColumnHandler *colHandler) {</span>
<a href="#l1.5254"></a><span id="l1.5254">   nsresult rv;</span>
<a href="#l1.5255"></a><span id="l1.5255">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5256"></a><span id="l1.5256">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5257"></a><span id="l1.5257"> </span>
<a href="#l1.5258"></a><span id="l1.5258">   bool isRead;</span>
<a href="#l1.5259"></a><span id="l1.5259">   uint32_t bits;</span>
<a href="#l1.5260"></a><span id="l1.5260"> </span>
<a href="#l1.5261"></a><span id="l1.5261" class="difflineminus">-  switch (sortType)</span>
<a href="#l1.5262"></a><span id="l1.5262" class="difflineminus">-  {</span>
<a href="#l1.5263"></a><span id="l1.5263" class="difflineplus">+  switch (sortType) {</span>
<a href="#l1.5264"></a><span id="l1.5264">     case nsMsgViewSortType::bySize:</span>
<a href="#l1.5265"></a><span id="l1.5265" class="difflineminus">-      rv = (mShowSizeInLines) ? msgHdr-&gt;GetLineCount(result) :</span>
<a href="#l1.5266"></a><span id="l1.5266" class="difflineminus">-                                msgHdr-&gt;GetMessageSize(result);</span>
<a href="#l1.5267"></a><span id="l1.5267" class="difflineplus">+      rv = (mShowSizeInLines) ? msgHdr-&gt;GetLineCount(result)</span>
<a href="#l1.5268"></a><span id="l1.5268" class="difflineplus">+                              : msgHdr-&gt;GetMessageSize(result);</span>
<a href="#l1.5269"></a><span id="l1.5269">       break;</span>
<a href="#l1.5270"></a><span id="l1.5270">     case nsMsgViewSortType::byPriority:</span>
<a href="#l1.5271"></a><span id="l1.5271">       nsMsgPriorityValue priority;</span>
<a href="#l1.5272"></a><span id="l1.5272">       rv = msgHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l1.5273"></a><span id="l1.5273">       // Treat &quot;none&quot; as &quot;normal&quot; when sorting.</span>
<a href="#l1.5274"></a><span id="l1.5274" class="difflineminus">-      if (priority == nsMsgPriority::none)</span>
<a href="#l1.5275"></a><span id="l1.5275" class="difflineminus">-        priority = nsMsgPriority::normal;</span>
<a href="#l1.5276"></a><span id="l1.5276" class="difflineplus">+      if (priority == nsMsgPriority::none) priority = nsMsgPriority::normal;</span>
<a href="#l1.5277"></a><span id="l1.5277"> </span>
<a href="#l1.5278"></a><span id="l1.5278">       // We want highest priority to have lowest value</span>
<a href="#l1.5279"></a><span id="l1.5279">       // so ascending sort will have highest priority first.</span>
<a href="#l1.5280"></a><span id="l1.5280">       *result = nsMsgPriority::highest - priority;</span>
<a href="#l1.5281"></a><span id="l1.5281">       break;</span>
<a href="#l1.5282"></a><span id="l1.5282">     case nsMsgViewSortType::byStatus:</span>
<a href="#l1.5283"></a><span id="l1.5283" class="difflineminus">-      rv = GetStatusSortValue(msgHdr,result);</span>
<a href="#l1.5284"></a><span id="l1.5284" class="difflineplus">+      rv = GetStatusSortValue(msgHdr, result);</span>
<a href="#l1.5285"></a><span id="l1.5285">       break;</span>
<a href="#l1.5286"></a><span id="l1.5286">     case nsMsgViewSortType::byFlagged:</span>
<a href="#l1.5287"></a><span id="l1.5287">       bits = 0;</span>
<a href="#l1.5288"></a><span id="l1.5288">       rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5289"></a><span id="l1.5289">       // Make flagged come out on top.</span>
<a href="#l1.5290"></a><span id="l1.5290">       *result = !(bits &amp; nsMsgMessageFlags::Marked);</span>
<a href="#l1.5291"></a><span id="l1.5291">       break;</span>
<a href="#l1.5292"></a><span id="l1.5292">     case nsMsgViewSortType::byUnread:</span>
<a href="#l1.5293"></a><span id="l1.5293">       rv = msgHdr-&gt;GetIsRead(&amp;isRead);</span>
<a href="#l1.5294"></a><span id="l1.5294" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5295"></a><span id="l1.5295" class="difflineminus">-        *result = !isRead;</span>
<a href="#l1.5296"></a><span id="l1.5296" class="difflineminus">-</span>
<a href="#l1.5297"></a><span id="l1.5297" class="difflineminus">-      break;</span>
<a href="#l1.5298"></a><span id="l1.5298" class="difflineminus">-    case nsMsgViewSortType::byJunkStatus:</span>
<a href="#l1.5299"></a><span id="l1.5299" class="difflineminus">-    {</span>
<a href="#l1.5300"></a><span id="l1.5300" class="difflineplus">+      if (NS_SUCCEEDED(rv)) *result = !isRead;</span>
<a href="#l1.5301"></a><span id="l1.5301" class="difflineplus">+</span>
<a href="#l1.5302"></a><span id="l1.5302" class="difflineplus">+      break;</span>
<a href="#l1.5303"></a><span id="l1.5303" class="difflineplus">+    case nsMsgViewSortType::byJunkStatus: {</span>
<a href="#l1.5304"></a><span id="l1.5304">       nsCString junkScoreStr;</span>
<a href="#l1.5305"></a><span id="l1.5305">       rv = msgHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l1.5306"></a><span id="l1.5306">       // Unscored messages should come before messages that are scored</span>
<a href="#l1.5307"></a><span id="l1.5307">       // junkScoreStr is &quot;&quot;, and &quot;0&quot; - &quot;100&quot;; normalize to 0 - 101.</span>
<a href="#l1.5308"></a><span id="l1.5308">       *result = junkScoreStr.IsEmpty() ? (0) : atoi(junkScoreStr.get()) + 1;</span>
<a href="#l1.5309"></a><span id="l1.5309">       break;</span>
<a href="#l1.5310"></a><span id="l1.5310">     }</span>
<a href="#l1.5311"></a><span id="l1.5311">     case nsMsgViewSortType::byAttachments:</span>
<a href="#l1.5312"></a><span id="l1.5312" class="difflineat">@@ -4536,708 +3943,628 @@ nsresult nsMsgDBView::GetLongField(nsIMs</span>
<a href="#l1.5313"></a><span id="l1.5313">       rv = msgHdr-&gt;GetFlags(&amp;bits);</span>
<a href="#l1.5314"></a><span id="l1.5314">       *result = !(bits &amp; nsMsgMessageFlags::Attachment);</span>
<a href="#l1.5315"></a><span id="l1.5315">       break;</span>
<a href="#l1.5316"></a><span id="l1.5316">     case nsMsgViewSortType::byDate:</span>
<a href="#l1.5317"></a><span id="l1.5317">       // When sorting threads by date, we may want the date of the newest msg</span>
<a href="#l1.5318"></a><span id="l1.5318">       // in the thread.</span>
<a href="#l1.5319"></a><span id="l1.5319">       if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.5320"></a><span id="l1.5320">           !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.5321"></a><span id="l1.5321" class="difflineminus">-          !mSortThreadsByRoot)</span>
<a href="#l1.5322"></a><span id="l1.5322" class="difflineminus">-      {</span>
<a href="#l1.5323"></a><span id="l1.5323" class="difflineminus">-        nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5324"></a><span id="l1.5324" class="difflineplus">+          !mSortThreadsByRoot) {</span>
<a href="#l1.5325"></a><span id="l1.5325" class="difflineplus">+        nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5326"></a><span id="l1.5326">         rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.5327"></a><span id="l1.5327" class="difflineminus">-        if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5328"></a><span id="l1.5328" class="difflineminus">-        {</span>
<a href="#l1.5329"></a><span id="l1.5329" class="difflineplus">+        if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.5330"></a><span id="l1.5330">           thread-&gt;GetNewestMsgDate(result);</span>
<a href="#l1.5331"></a><span id="l1.5331">           break;</span>
<a href="#l1.5332"></a><span id="l1.5332">         }</span>
<a href="#l1.5333"></a><span id="l1.5333">       }</span>
<a href="#l1.5334"></a><span id="l1.5334">       rv = msgHdr-&gt;GetDateInSeconds(result);</span>
<a href="#l1.5335"></a><span id="l1.5335">       break;</span>
<a href="#l1.5336"></a><span id="l1.5336">     case nsMsgViewSortType::byReceived:</span>
<a href="#l1.5337"></a><span id="l1.5337">       // When sorting threads by received date, we may want the received date</span>
<a href="#l1.5338"></a><span id="l1.5338">       // of the newest msg in the thread.</span>
<a href="#l1.5339"></a><span id="l1.5339">       if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.5340"></a><span id="l1.5340">           !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.5341"></a><span id="l1.5341" class="difflineminus">-          !mSortThreadsByRoot)</span>
<a href="#l1.5342"></a><span id="l1.5342" class="difflineminus">-      {</span>
<a href="#l1.5343"></a><span id="l1.5343" class="difflineminus">-        nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5344"></a><span id="l1.5344" class="difflineplus">+          !mSortThreadsByRoot) {</span>
<a href="#l1.5345"></a><span id="l1.5345" class="difflineplus">+        nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.5346"></a><span id="l1.5346">         rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.5347"></a><span id="l1.5347">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5348"></a><span id="l1.5348">         thread-&gt;GetNewestMsgDate(result);</span>
<a href="#l1.5349"></a><span id="l1.5349" class="difflineminus">-      }</span>
<a href="#l1.5350"></a><span id="l1.5350" class="difflineminus">-      else</span>
<a href="#l1.5351"></a><span id="l1.5351" class="difflineminus">-      {</span>
<a href="#l1.5352"></a><span id="l1.5352" class="difflineplus">+      } else {</span>
<a href="#l1.5353"></a><span id="l1.5353">         // Already in seconds.</span>
<a href="#l1.5354"></a><span id="l1.5354">         rv = msgHdr-&gt;GetUint32Property(&quot;dateReceived&quot;, result);</span>
<a href="#l1.5355"></a><span id="l1.5355">         if (*result == 0)</span>
<a href="#l1.5356"></a><span id="l1.5356">           // Use Date instead, we have no Received property</span>
<a href="#l1.5357"></a><span id="l1.5357">           rv = msgHdr-&gt;GetDateInSeconds(result);</span>
<a href="#l1.5358"></a><span id="l1.5358">       }</span>
<a href="#l1.5359"></a><span id="l1.5359">       break;</span>
<a href="#l1.5360"></a><span id="l1.5360">     case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5361"></a><span id="l1.5361" class="difflineminus">-      if (colHandler != nullptr)</span>
<a href="#l1.5362"></a><span id="l1.5362" class="difflineminus">-      {</span>
<a href="#l1.5363"></a><span id="l1.5363" class="difflineplus">+      if (colHandler != nullptr) {</span>
<a href="#l1.5364"></a><span id="l1.5364">         colHandler-&gt;GetSortLongForRow(msgHdr, result);</span>
<a href="#l1.5365"></a><span id="l1.5365">         rv = NS_OK;</span>
<a href="#l1.5366"></a><span id="l1.5366" class="difflineminus">-      }</span>
<a href="#l1.5367"></a><span id="l1.5367" class="difflineminus">-      else</span>
<a href="#l1.5368"></a><span id="l1.5368" class="difflineminus">-      {</span>
<a href="#l1.5369"></a><span id="l1.5369" class="difflineminus">-        NS_ASSERTION(false, &quot;should not be here (Sort Type: byCustom (Long), but no custom handler)&quot;);</span>
<a href="#l1.5370"></a><span id="l1.5370" class="difflineplus">+      } else {</span>
<a href="#l1.5371"></a><span id="l1.5371" class="difflineplus">+        NS_ASSERTION(false,</span>
<a href="#l1.5372"></a><span id="l1.5372" class="difflineplus">+                     &quot;should not be here (Sort Type: byCustom (Long), but no &quot;</span>
<a href="#l1.5373"></a><span id="l1.5373" class="difflineplus">+                     &quot;custom handler)&quot;);</span>
<a href="#l1.5374"></a><span id="l1.5374">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5375"></a><span id="l1.5375">       }</span>
<a href="#l1.5376"></a><span id="l1.5376">       break;</span>
<a href="#l1.5377"></a><span id="l1.5377">     case nsMsgViewSortType::byNone:</span>
<a href="#l1.5378"></a><span id="l1.5378">       // Bug 901948.</span>
<a href="#l1.5379"></a><span id="l1.5379">       return NS_ERROR_INVALID_ARG;</span>
<a href="#l1.5380"></a><span id="l1.5380"> </span>
<a href="#l1.5381"></a><span id="l1.5381">     case nsMsgViewSortType::byId:</span>
<a href="#l1.5382"></a><span id="l1.5382">       // Handled by caller, since caller knows the key.</span>
<a href="#l1.5383"></a><span id="l1.5383">     default:</span>
<a href="#l1.5384"></a><span id="l1.5384">       NS_ERROR(&quot;should not be here&quot;);</span>
<a href="#l1.5385"></a><span id="l1.5385">       rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5386"></a><span id="l1.5386">       break;</span>
<a href="#l1.5387"></a><span id="l1.5387" class="difflineminus">-    }</span>
<a href="#l1.5388"></a><span id="l1.5388" class="difflineminus">-</span>
<a href="#l1.5389"></a><span id="l1.5389" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5390"></a><span id="l1.5390" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5391"></a><span id="l1.5391" class="difflineminus">-}</span>
<a href="#l1.5392"></a><span id="l1.5392" class="difflineminus">-</span>
<a href="#l1.5393"></a><span id="l1.5393" class="difflineminus">-MsgViewSortColumnInfo::MsgViewSortColumnInfo(const MsgViewSortColumnInfo &amp;other)</span>
<a href="#l1.5394"></a><span id="l1.5394" class="difflineminus">-{</span>
<a href="#l1.5395"></a><span id="l1.5395" class="difflineplus">+  }</span>
<a href="#l1.5396"></a><span id="l1.5396" class="difflineplus">+</span>
<a href="#l1.5397"></a><span id="l1.5397" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5398"></a><span id="l1.5398" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.5399"></a><span id="l1.5399" class="difflineplus">+}</span>
<a href="#l1.5400"></a><span id="l1.5400" class="difflineplus">+</span>
<a href="#l1.5401"></a><span id="l1.5401" class="difflineplus">+MsgViewSortColumnInfo::MsgViewSortColumnInfo(</span>
<a href="#l1.5402"></a><span id="l1.5402" class="difflineplus">+    const MsgViewSortColumnInfo &amp;other) {</span>
<a href="#l1.5403"></a><span id="l1.5403">   mSortType = other.mSortType;</span>
<a href="#l1.5404"></a><span id="l1.5404">   mSortOrder = other.mSortOrder;</span>
<a href="#l1.5405"></a><span id="l1.5405">   mCustomColumnName = other.mCustomColumnName;</span>
<a href="#l1.5406"></a><span id="l1.5406">   mColHandler = other.mColHandler;</span>
<a href="#l1.5407"></a><span id="l1.5407"> }</span>
<a href="#l1.5408"></a><span id="l1.5408"> </span>
<a href="#l1.5409"></a><span id="l1.5409" class="difflineminus">-bool MsgViewSortColumnInfo::operator== (const MsgViewSortColumnInfo&amp; other) const</span>
<a href="#l1.5410"></a><span id="l1.5410" class="difflineminus">-{</span>
<a href="#l1.5411"></a><span id="l1.5411" class="difflineminus">-  return (mSortType == nsMsgViewSortType::byCustom) ?</span>
<a href="#l1.5412"></a><span id="l1.5412" class="difflineminus">-    mCustomColumnName.Equals(other.mCustomColumnName) : mSortType == other.mSortType;</span>
<a href="#l1.5413"></a><span id="l1.5413" class="difflineminus">-}</span>
<a href="#l1.5414"></a><span id="l1.5414" class="difflineminus">-</span>
<a href="#l1.5415"></a><span id="l1.5415" class="difflineminus">-nsresult</span>
<a href="#l1.5416"></a><span id="l1.5416" class="difflineminus">-nsMsgDBView::EncodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5417"></a><span id="l1.5417" class="difflineminus">-{</span>
<a href="#l1.5418"></a><span id="l1.5418" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.5419"></a><span id="l1.5419" class="difflineminus">-  {</span>
<a href="#l1.5420"></a><span id="l1.5420" class="difflineplus">+bool MsgViewSortColumnInfo::operator==(</span>
<a href="#l1.5421"></a><span id="l1.5421" class="difflineplus">+    const MsgViewSortColumnInfo &amp;other) const {</span>
<a href="#l1.5422"></a><span id="l1.5422" class="difflineplus">+  return (mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5423"></a><span id="l1.5423" class="difflineplus">+             ? mCustomColumnName.Equals(other.mCustomColumnName)</span>
<a href="#l1.5424"></a><span id="l1.5424" class="difflineplus">+             : mSortType == other.mSortType;</span>
<a href="#l1.5425"></a><span id="l1.5425" class="difflineplus">+}</span>
<a href="#l1.5426"></a><span id="l1.5426" class="difflineplus">+</span>
<a href="#l1.5427"></a><span id="l1.5427" class="difflineplus">+nsresult nsMsgDBView::EncodeColumnSort(nsString &amp;columnSortString) {</span>
<a href="#l1.5428"></a><span id="l1.5428" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++) {</span>
<a href="#l1.5429"></a><span id="l1.5429">     MsgViewSortColumnInfo &amp;sortInfo = m_sortColumns[i];</span>
<a href="#l1.5430"></a><span id="l1.5430" class="difflineminus">-    columnSortString.Append((char) sortInfo.mSortType);</span>
<a href="#l1.5431"></a><span id="l1.5431" class="difflineminus">-    columnSortString.Append((char) sortInfo.mSortOrder + '0');</span>
<a href="#l1.5432"></a><span id="l1.5432" class="difflineminus">-    if (sortInfo.mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5433"></a><span id="l1.5433" class="difflineminus">-    {</span>
<a href="#l1.5434"></a><span id="l1.5434" class="difflineplus">+    columnSortString.Append((char)sortInfo.mSortType);</span>
<a href="#l1.5435"></a><span id="l1.5435" class="difflineplus">+    columnSortString.Append((char)sortInfo.mSortOrder + '0');</span>
<a href="#l1.5436"></a><span id="l1.5436" class="difflineplus">+    if (sortInfo.mSortType == nsMsgViewSortType::byCustom) {</span>
<a href="#l1.5437"></a><span id="l1.5437">       columnSortString.Append(sortInfo.mCustomColumnName);</span>
<a href="#l1.5438"></a><span id="l1.5438" class="difflineminus">-      columnSortString.Append((char16_t) '\r');</span>
<a href="#l1.5439"></a><span id="l1.5439" class="difflineplus">+      columnSortString.Append((char16_t)'\r');</span>
<a href="#l1.5440"></a><span id="l1.5440">     }</span>
<a href="#l1.5441"></a><span id="l1.5441">   }</span>
<a href="#l1.5442"></a><span id="l1.5442"> </span>
<a href="#l1.5443"></a><span id="l1.5443">   return NS_OK;</span>
<a href="#l1.5444"></a><span id="l1.5444"> }</span>
<a href="#l1.5445"></a><span id="l1.5445"> </span>
<a href="#l1.5446"></a><span id="l1.5446" class="difflineminus">-nsresult</span>
<a href="#l1.5447"></a><span id="l1.5447" class="difflineminus">-nsMsgDBView::DecodeColumnSort(nsString &amp;columnSortString)</span>
<a href="#l1.5448"></a><span id="l1.5448" class="difflineminus">-{</span>
<a href="#l1.5449"></a><span id="l1.5449" class="difflineplus">+nsresult nsMsgDBView::DecodeColumnSort(nsString &amp;columnSortString) {</span>
<a href="#l1.5450"></a><span id="l1.5450">   const char16_t *stringPtr = columnSortString.BeginReading();</span>
<a href="#l1.5451"></a><span id="l1.5451" class="difflineminus">-  while (*stringPtr)</span>
<a href="#l1.5452"></a><span id="l1.5452" class="difflineminus">-  {</span>
<a href="#l1.5453"></a><span id="l1.5453" class="difflineplus">+  while (*stringPtr) {</span>
<a href="#l1.5454"></a><span id="l1.5454">     MsgViewSortColumnInfo sortColumnInfo;</span>
<a href="#l1.5455"></a><span id="l1.5455" class="difflineminus">-    sortColumnInfo.mSortType = (nsMsgViewSortTypeValue) *stringPtr++;</span>
<a href="#l1.5456"></a><span id="l1.5456" class="difflineminus">-    sortColumnInfo.mSortOrder = (nsMsgViewSortOrderValue) (*stringPtr++) - '0';</span>
<a href="#l1.5457"></a><span id="l1.5457" class="difflineminus">-    if (sortColumnInfo.mSortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5458"></a><span id="l1.5458" class="difflineminus">-    {</span>
<a href="#l1.5459"></a><span id="l1.5459" class="difflineplus">+    sortColumnInfo.mSortType = (nsMsgViewSortTypeValue)*stringPtr++;</span>
<a href="#l1.5460"></a><span id="l1.5460" class="difflineplus">+    sortColumnInfo.mSortOrder = (nsMsgViewSortOrderValue)(*stringPtr++) - '0';</span>
<a href="#l1.5461"></a><span id="l1.5461" class="difflineplus">+    if (sortColumnInfo.mSortType == nsMsgViewSortType::byCustom) {</span>
<a href="#l1.5462"></a><span id="l1.5462">       while (*stringPtr &amp;&amp; *stringPtr != '\r')</span>
<a href="#l1.5463"></a><span id="l1.5463">         sortColumnInfo.mCustomColumnName.Append(*stringPtr++);</span>
<a href="#l1.5464"></a><span id="l1.5464"> </span>
<a href="#l1.5465"></a><span id="l1.5465">       sortColumnInfo.mColHandler =</span>
<a href="#l1.5466"></a><span id="l1.5466" class="difflineminus">-        GetColumnHandler(sortColumnInfo.mCustomColumnName);</span>
<a href="#l1.5467"></a><span id="l1.5467" class="difflineplus">+          GetColumnHandler(sortColumnInfo.mCustomColumnName);</span>
<a href="#l1.5468"></a><span id="l1.5468"> </span>
<a href="#l1.5469"></a><span id="l1.5469">       // Advance past '\r'.</span>
<a href="#l1.5470"></a><span id="l1.5470" class="difflineminus">-      if (*stringPtr)</span>
<a href="#l1.5471"></a><span id="l1.5471" class="difflineminus">-        stringPtr++;</span>
<a href="#l1.5472"></a><span id="l1.5472" class="difflineplus">+      if (*stringPtr) stringPtr++;</span>
<a href="#l1.5473"></a><span id="l1.5473">     }</span>
<a href="#l1.5474"></a><span id="l1.5474"> </span>
<a href="#l1.5475"></a><span id="l1.5475">     m_sortColumns.AppendElement(sortColumnInfo);</span>
<a href="#l1.5476"></a><span id="l1.5476">   }</span>
<a href="#l1.5477"></a><span id="l1.5477"> </span>
<a href="#l1.5478"></a><span id="l1.5478">   return NS_OK;</span>
<a href="#l1.5479"></a><span id="l1.5479"> }</span>
<a href="#l1.5480"></a><span id="l1.5480"> </span>
<a href="#l1.5481"></a><span id="l1.5481"> //  Secondary Sort Key: when you select a column to sort, that</span>
<a href="#l1.5482"></a><span id="l1.5482"> //  becomes the new Primary sort key, and all previous sort keys</span>
<a href="#l1.5483"></a><span id="l1.5483"> //  become secondary. For example, if you first click on Date,</span>
<a href="#l1.5484"></a><span id="l1.5484"> //  the messages are sorted by Date; then click on From, and now the</span>
<a href="#l1.5485"></a><span id="l1.5485"> //  messages are sorted by From, and for each value of From the</span>
<a href="#l1.5486"></a><span id="l1.5486"> //  messages are in Date order.</span>
<a href="#l1.5487"></a><span id="l1.5487"> </span>
<a href="#l1.5488"></a><span id="l1.5488" class="difflineminus">-void</span>
<a href="#l1.5489"></a><span id="l1.5489" class="difflineminus">-nsMsgDBView::PushSort(const MsgViewSortColumnInfo &amp;newSort)</span>
<a href="#l1.5490"></a><span id="l1.5490" class="difflineminus">-{</span>
<a href="#l1.5491"></a><span id="l1.5491" class="difflineplus">+void nsMsgDBView::PushSort(const MsgViewSortColumnInfo &amp;newSort) {</span>
<a href="#l1.5492"></a><span id="l1.5492">   // Handle byNone (bug 901948) ala a mail/base/modules/dbViewerWrapper.js</span>
<a href="#l1.5493"></a><span id="l1.5493">   // where we don't push the secondary sort type if it's ::byNone;</span>
<a href="#l1.5494"></a><span id="l1.5494">   // (and secondary sort type is NOT the same as the first sort type</span>
<a href="#l1.5495"></a><span id="l1.5495">   // there). This code should behave the same way.</span>
<a href="#l1.5496"></a><span id="l1.5496"> </span>
<a href="#l1.5497"></a><span id="l1.5497">   // We don't expect to be passed sort type ::byNone,</span>
<a href="#l1.5498"></a><span id="l1.5498">   // but if we are it's safe to ignore it.</span>
<a href="#l1.5499"></a><span id="l1.5499" class="difflineminus">-  if (newSort.mSortType == nsMsgViewSortType::byNone)</span>
<a href="#l1.5500"></a><span id="l1.5500" class="difflineminus">-    return;</span>
<a href="#l1.5501"></a><span id="l1.5501" class="difflineplus">+  if (newSort.mSortType == nsMsgViewSortType::byNone) return;</span>
<a href="#l1.5502"></a><span id="l1.5502"> </span>
<a href="#l1.5503"></a><span id="l1.5503">   // Date and ID are unique keys, so if we are sorting by them we don't</span>
<a href="#l1.5504"></a><span id="l1.5504">   // need to keep any secondary sort keys</span>
<a href="#l1.5505"></a><span id="l1.5505">   if (newSort.mSortType == nsMsgViewSortType::byDate ||</span>
<a href="#l1.5506"></a><span id="l1.5506">       newSort.mSortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5507"></a><span id="l1.5507">     m_sortColumns.Clear();</span>
<a href="#l1.5508"></a><span id="l1.5508"> </span>
<a href="#l1.5509"></a><span id="l1.5509">   m_sortColumns.RemoveElement(newSort);</span>
<a href="#l1.5510"></a><span id="l1.5510">   m_sortColumns.InsertElementAt(0, newSort);</span>
<a href="#l1.5511"></a><span id="l1.5511">   if (m_sortColumns.Length() &gt; kMaxNumSortColumns)</span>
<a href="#l1.5512"></a><span id="l1.5512">     m_sortColumns.RemoveElementAt(kMaxNumSortColumns);</span>
<a href="#l1.5513"></a><span id="l1.5513"> }</span>
<a href="#l1.5514"></a><span id="l1.5514"> </span>
<a href="#l1.5515"></a><span id="l1.5515" class="difflineminus">-nsresult</span>
<a href="#l1.5516"></a><span id="l1.5516" class="difflineminus">-nsMsgDBView::GetCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5517"></a><span id="l1.5517" class="difflineminus">-                             nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5518"></a><span id="l1.5518" class="difflineminus">-                             uint8_t **result,</span>
<a href="#l1.5519"></a><span id="l1.5519" class="difflineminus">-                             uint32_t *len,</span>
<a href="#l1.5520"></a><span id="l1.5520" class="difflineminus">-                             nsIMsgCustomColumnHandler* colHandler)</span>
<a href="#l1.5521"></a><span id="l1.5521" class="difflineminus">-{</span>
<a href="#l1.5522"></a><span id="l1.5522" class="difflineplus">+nsresult nsMsgDBView::GetCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5523"></a><span id="l1.5523" class="difflineplus">+                                      nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5524"></a><span id="l1.5524" class="difflineplus">+                                      uint8_t **result, uint32_t *len,</span>
<a href="#l1.5525"></a><span id="l1.5525" class="difflineplus">+                                      nsIMsgCustomColumnHandler *colHandler) {</span>
<a href="#l1.5526"></a><span id="l1.5526">   nsresult rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5527"></a><span id="l1.5527">   NS_ENSURE_ARG_POINTER(msgHdr);</span>
<a href="#l1.5528"></a><span id="l1.5528">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l1.5529"></a><span id="l1.5529"> </span>
<a href="#l1.5530"></a><span id="l1.5530" class="difflineminus">-  switch (sortType)</span>
<a href="#l1.5531"></a><span id="l1.5531" class="difflineminus">-  {</span>
<a href="#l1.5532"></a><span id="l1.5532" class="difflineplus">+  switch (sortType) {</span>
<a href="#l1.5533"></a><span id="l1.5533">     case nsMsgViewSortType::bySubject:</span>
<a href="#l1.5534"></a><span id="l1.5534">       rv = msgHdr-&gt;GetSubjectCollationKey(len, result);</span>
<a href="#l1.5535"></a><span id="l1.5535">       break;</span>
<a href="#l1.5536"></a><span id="l1.5536">     case nsMsgViewSortType::byLocation:</span>
<a href="#l1.5537"></a><span id="l1.5537">       rv = GetLocationCollationKey(msgHdr, result, len);</span>
<a href="#l1.5538"></a><span id="l1.5538">       break;</span>
<a href="#l1.5539"></a><span id="l1.5539" class="difflineminus">-    case nsMsgViewSortType::byRecipient:</span>
<a href="#l1.5540"></a><span id="l1.5540" class="difflineminus">-    {</span>
<a href="#l1.5541"></a><span id="l1.5541" class="difflineplus">+    case nsMsgViewSortType::byRecipient: {</span>
<a href="#l1.5542"></a><span id="l1.5542">       nsString recipients;</span>
<a href="#l1.5543"></a><span id="l1.5543">       rv = FetchRecipients(msgHdr, recipients);</span>
<a href="#l1.5544"></a><span id="l1.5544" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5545"></a><span id="l1.5545" class="difflineminus">-      {</span>
<a href="#l1.5546"></a><span id="l1.5546" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5547"></a><span id="l1.5547" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.5548"></a><span id="l1.5548" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5549"></a><span id="l1.5549">         // Probably a search view.</span>
<a href="#l1.5550"></a><span id="l1.5550" class="difflineminus">-        if (!dbToUse)</span>
<a href="#l1.5551"></a><span id="l1.5551" class="difflineminus">-        {</span>
<a href="#l1.5552"></a><span id="l1.5552" class="difflineplus">+        if (!dbToUse) {</span>
<a href="#l1.5553"></a><span id="l1.5553">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5554"></a><span id="l1.5554" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5555"></a><span id="l1.5555" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5556"></a><span id="l1.5556">         }</span>
<a href="#l1.5557"></a><span id="l1.5557"> </span>
<a href="#l1.5558"></a><span id="l1.5558">         rv = dbToUse-&gt;CreateCollationKey(recipients, len, result);</span>
<a href="#l1.5559"></a><span id="l1.5559">       }</span>
<a href="#l1.5560"></a><span id="l1.5560">       break;</span>
<a href="#l1.5561"></a><span id="l1.5561">     }</span>
<a href="#l1.5562"></a><span id="l1.5562" class="difflineminus">-    case nsMsgViewSortType::byAuthor:</span>
<a href="#l1.5563"></a><span id="l1.5563" class="difflineminus">-    {</span>
<a href="#l1.5564"></a><span id="l1.5564" class="difflineplus">+    case nsMsgViewSortType::byAuthor: {</span>
<a href="#l1.5565"></a><span id="l1.5565">       rv = msgHdr-&gt;GetAuthorCollationKey(len, result);</span>
<a href="#l1.5566"></a><span id="l1.5566">       nsString author;</span>
<a href="#l1.5567"></a><span id="l1.5567">       rv = FetchAuthor(msgHdr, author);</span>
<a href="#l1.5568"></a><span id="l1.5568" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5569"></a><span id="l1.5569" class="difflineminus">-      {</span>
<a href="#l1.5570"></a><span id="l1.5570" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5571"></a><span id="l1.5571" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.5572"></a><span id="l1.5572" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5573"></a><span id="l1.5573">         // Probably a search view.</span>
<a href="#l1.5574"></a><span id="l1.5574" class="difflineminus">-        if (!dbToUse)</span>
<a href="#l1.5575"></a><span id="l1.5575" class="difflineminus">-        {</span>
<a href="#l1.5576"></a><span id="l1.5576" class="difflineplus">+        if (!dbToUse) {</span>
<a href="#l1.5577"></a><span id="l1.5577">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5578"></a><span id="l1.5578" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5579"></a><span id="l1.5579" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5580"></a><span id="l1.5580">         }</span>
<a href="#l1.5581"></a><span id="l1.5581"> </span>
<a href="#l1.5582"></a><span id="l1.5582">         rv = dbToUse-&gt;CreateCollationKey(author, len, result);</span>
<a href="#l1.5583"></a><span id="l1.5583">       }</span>
<a href="#l1.5584"></a><span id="l1.5584">       break;</span>
<a href="#l1.5585"></a><span id="l1.5585">     }</span>
<a href="#l1.5586"></a><span id="l1.5586">     case nsMsgViewSortType::byAccount:</span>
<a href="#l1.5587"></a><span id="l1.5587" class="difflineminus">-    case nsMsgViewSortType::byTags:</span>
<a href="#l1.5588"></a><span id="l1.5588" class="difflineminus">-    {</span>
<a href="#l1.5589"></a><span id="l1.5589" class="difflineplus">+    case nsMsgViewSortType::byTags: {</span>
<a href="#l1.5590"></a><span id="l1.5590">       nsString str;</span>
<a href="#l1.5591"></a><span id="l1.5591" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5592"></a><span id="l1.5592" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5593"></a><span id="l1.5593"> </span>
<a href="#l1.5594"></a><span id="l1.5594">       if (!dbToUse)</span>
<a href="#l1.5595"></a><span id="l1.5595">         // Probably a search view.</span>
<a href="#l1.5596"></a><span id="l1.5596">         GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.5597"></a><span id="l1.5597"> </span>
<a href="#l1.5598"></a><span id="l1.5598" class="difflineminus">-      rv = (sortType == nsMsgViewSortType::byAccount) ? FetchAccount(msgHdr, str) :</span>
<a href="#l1.5599"></a><span id="l1.5599" class="difflineminus">-                                                        FetchTags(msgHdr, str);</span>
<a href="#l1.5600"></a><span id="l1.5600" class="difflineplus">+      rv = (sortType == nsMsgViewSortType::byAccount)</span>
<a href="#l1.5601"></a><span id="l1.5601" class="difflineplus">+               ? FetchAccount(msgHdr, str)</span>
<a href="#l1.5602"></a><span id="l1.5602" class="difflineplus">+               : FetchTags(msgHdr, str);</span>
<a href="#l1.5603"></a><span id="l1.5603">       if (NS_SUCCEEDED(rv) &amp;&amp; dbToUse)</span>
<a href="#l1.5604"></a><span id="l1.5604">         rv = dbToUse-&gt;CreateCollationKey(str, len, result);</span>
<a href="#l1.5605"></a><span id="l1.5605"> </span>
<a href="#l1.5606"></a><span id="l1.5606">       break;</span>
<a href="#l1.5607"></a><span id="l1.5607">     }</span>
<a href="#l1.5608"></a><span id="l1.5608">     case nsMsgViewSortType::byCustom:</span>
<a href="#l1.5609"></a><span id="l1.5609" class="difflineminus">-      if (colHandler != nullptr)</span>
<a href="#l1.5610"></a><span id="l1.5610" class="difflineminus">-      {</span>
<a href="#l1.5611"></a><span id="l1.5611" class="difflineplus">+      if (colHandler != nullptr) {</span>
<a href="#l1.5612"></a><span id="l1.5612">         nsAutoString strKey;</span>
<a href="#l1.5613"></a><span id="l1.5613">         rv = colHandler-&gt;GetSortStringForRow(msgHdr, strKey);</span>
<a href="#l1.5614"></a><span id="l1.5614" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get sort string for custom row&quot;);</span>
<a href="#l1.5615"></a><span id="l1.5615" class="difflineplus">+        NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l1.5616"></a><span id="l1.5616" class="difflineplus">+                     &quot;failed to get sort string for custom row&quot;);</span>
<a href="#l1.5617"></a><span id="l1.5617">         nsAutoString strTemp(strKey);</span>
<a href="#l1.5618"></a><span id="l1.5618"> </span>
<a href="#l1.5619"></a><span id="l1.5619" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5620"></a><span id="l1.5620" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5621"></a><span id="l1.5621">         // Probably a search view.</span>
<a href="#l1.5622"></a><span id="l1.5622" class="difflineminus">-        if (!dbToUse)</span>
<a href="#l1.5623"></a><span id="l1.5623" class="difflineminus">-        {</span>
<a href="#l1.5624"></a><span id="l1.5624" class="difflineplus">+        if (!dbToUse) {</span>
<a href="#l1.5625"></a><span id="l1.5625">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5626"></a><span id="l1.5626" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5627"></a><span id="l1.5627" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5628"></a><span id="l1.5628">         }</span>
<a href="#l1.5629"></a><span id="l1.5629">         rv = dbToUse-&gt;CreateCollationKey(strKey, len, result);</span>
<a href="#l1.5630"></a><span id="l1.5630" class="difflineminus">-      }</span>
<a href="#l1.5631"></a><span id="l1.5631" class="difflineminus">-      else</span>
<a href="#l1.5632"></a><span id="l1.5632" class="difflineminus">-      {</span>
<a href="#l1.5633"></a><span id="l1.5633" class="difflineminus">-        NS_ERROR(&quot;should not be here (Sort Type: byCustom (String), but no custom handler)&quot;);</span>
<a href="#l1.5634"></a><span id="l1.5634" class="difflineplus">+      } else {</span>
<a href="#l1.5635"></a><span id="l1.5635" class="difflineplus">+        NS_ERROR(</span>
<a href="#l1.5636"></a><span id="l1.5636" class="difflineplus">+            &quot;should not be here (Sort Type: byCustom (String), but no custom &quot;</span>
<a href="#l1.5637"></a><span id="l1.5637" class="difflineplus">+            &quot;handler)&quot;);</span>
<a href="#l1.5638"></a><span id="l1.5638">         rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5639"></a><span id="l1.5639">       }</span>
<a href="#l1.5640"></a><span id="l1.5640">       break;</span>
<a href="#l1.5641"></a><span id="l1.5641" class="difflineminus">-    case nsMsgViewSortType::byCorrespondent:</span>
<a href="#l1.5642"></a><span id="l1.5642" class="difflineminus">-    {</span>
<a href="#l1.5643"></a><span id="l1.5643" class="difflineplus">+    case nsMsgViewSortType::byCorrespondent: {</span>
<a href="#l1.5644"></a><span id="l1.5644">       nsString value;</span>
<a href="#l1.5645"></a><span id="l1.5645">       if (IsOutgoingMsg(msgHdr))</span>
<a href="#l1.5646"></a><span id="l1.5646">         rv = FetchRecipients(msgHdr, value);</span>
<a href="#l1.5647"></a><span id="l1.5647">       else</span>
<a href="#l1.5648"></a><span id="l1.5648">         rv = FetchAuthor(msgHdr, value);</span>
<a href="#l1.5649"></a><span id="l1.5649"> </span>
<a href="#l1.5650"></a><span id="l1.5650" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.5651"></a><span id="l1.5651" class="difflineminus">-      {</span>
<a href="#l1.5652"></a><span id="l1.5652" class="difflineminus">-        nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5653"></a><span id="l1.5653" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.5654"></a><span id="l1.5654" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.5655"></a><span id="l1.5655">         // Probably a search view.</span>
<a href="#l1.5656"></a><span id="l1.5656" class="difflineminus">-        if (!dbToUse)</span>
<a href="#l1.5657"></a><span id="l1.5657" class="difflineminus">-        {</span>
<a href="#l1.5658"></a><span id="l1.5658" class="difflineplus">+        if (!dbToUse) {</span>
<a href="#l1.5659"></a><span id="l1.5659">           rv = GetDBForHeader(msgHdr, getter_AddRefs(dbToUse));</span>
<a href="#l1.5660"></a><span id="l1.5660" class="difflineminus">-          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5661"></a><span id="l1.5661" class="difflineplus">+          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5662"></a><span id="l1.5662">         }</span>
<a href="#l1.5663"></a><span id="l1.5663"> </span>
<a href="#l1.5664"></a><span id="l1.5664">         rv = dbToUse-&gt;CreateCollationKey(value, len, result);</span>
<a href="#l1.5665"></a><span id="l1.5665">       }</span>
<a href="#l1.5666"></a><span id="l1.5666">       break;</span>
<a href="#l1.5667"></a><span id="l1.5667">     }</span>
<a href="#l1.5668"></a><span id="l1.5668">     default:</span>
<a href="#l1.5669"></a><span id="l1.5669">       rv = NS_ERROR_UNEXPECTED;</span>
<a href="#l1.5670"></a><span id="l1.5670">       break;</span>
<a href="#l1.5671"></a><span id="l1.5671">   }</span>
<a href="#l1.5672"></a><span id="l1.5672"> </span>
<a href="#l1.5673"></a><span id="l1.5673">   // Bailing out with failure will stop the sort and leave us in</span>
<a href="#l1.5674"></a><span id="l1.5674">   // a bad state. Try to continue on, instead.</span>
<a href="#l1.5675"></a><span id="l1.5675" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to get the collation key&quot;);</span>
<a href="#l1.5676"></a><span id="l1.5676" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.5677"></a><span id="l1.5677" class="difflineminus">-  {</span>
<a href="#l1.5678"></a><span id="l1.5678" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to get the collation key&quot;);</span>
<a href="#l1.5679"></a><span id="l1.5679" class="difflineplus">+  if (NS_FAILED(rv)) {</span>
<a href="#l1.5680"></a><span id="l1.5680">     *result = nullptr;</span>
<a href="#l1.5681"></a><span id="l1.5681">     *len = 0;</span>
<a href="#l1.5682"></a><span id="l1.5682">   }</span>
<a href="#l1.5683"></a><span id="l1.5683"> </span>
<a href="#l1.5684"></a><span id="l1.5684">   return NS_OK;</span>
<a href="#l1.5685"></a><span id="l1.5685"> }</span>
<a href="#l1.5686"></a><span id="l1.5686"> </span>
<a href="#l1.5687"></a><span id="l1.5687"> // As the location collation key is created getting folder from the msgHdr,</span>
<a href="#l1.5688"></a><span id="l1.5688"> // it is defined in this file and not from the db.</span>
<a href="#l1.5689"></a><span id="l1.5689" class="difflineminus">-nsresult</span>
<a href="#l1.5690"></a><span id="l1.5690" class="difflineminus">-nsMsgDBView::GetLocationCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5691"></a><span id="l1.5691" class="difflineminus">-                                     uint8_t **result,</span>
<a href="#l1.5692"></a><span id="l1.5692" class="difflineminus">-                                     uint32_t *len)</span>
<a href="#l1.5693"></a><span id="l1.5693" class="difflineminus">-{</span>
<a href="#l1.5694"></a><span id="l1.5694" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.5695"></a><span id="l1.5695" class="difflineplus">+nsresult nsMsgDBView::GetLocationCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.5696"></a><span id="l1.5696" class="difflineplus">+                                              uint8_t **result, uint32_t *len) {</span>
<a href="#l1.5697"></a><span id="l1.5697" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.5698"></a><span id="l1.5698"> </span>
<a href="#l1.5699"></a><span id="l1.5699">   nsresult rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.5700"></a><span id="l1.5700" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5701"></a><span id="l1.5701" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.5702"></a><span id="l1.5702" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5703"></a><span id="l1.5703" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse;</span>
<a href="#l1.5704"></a><span id="l1.5704">   rv = folder-&gt;GetMsgDatabase(getter_AddRefs(dbToUse));</span>
<a href="#l1.5705"></a><span id="l1.5705" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5706"></a><span id="l1.5706" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5707"></a><span id="l1.5707"> </span>
<a href="#l1.5708"></a><span id="l1.5708">   nsString locationString;</span>
<a href="#l1.5709"></a><span id="l1.5709">   rv = folder-&gt;GetPrettyName(locationString);</span>
<a href="#l1.5710"></a><span id="l1.5710" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.5711"></a><span id="l1.5711" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5712"></a><span id="l1.5712"> </span>
<a href="#l1.5713"></a><span id="l1.5713">   return dbToUse-&gt;CreateCollationKey(locationString, len, result);</span>
<a href="#l1.5714"></a><span id="l1.5714"> }</span>
<a href="#l1.5715"></a><span id="l1.5715"> </span>
<a href="#l1.5716"></a><span id="l1.5716" class="difflineminus">-nsresult</span>
<a href="#l1.5717"></a><span id="l1.5717" class="difflineminus">-nsMsgDBView::SaveSortInfo(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5718"></a><span id="l1.5718" class="difflineminus">-                          nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l1.5719"></a><span id="l1.5719" class="difflineminus">-{</span>
<a href="#l1.5720"></a><span id="l1.5720" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l1.5721"></a><span id="l1.5721" class="difflineminus">-  {</span>
<a href="#l1.5722"></a><span id="l1.5722" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5723"></a><span id="l1.5723" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5724"></a><span id="l1.5724" class="difflineminus">-    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo), getter_AddRefs(db));</span>
<a href="#l1.5725"></a><span id="l1.5725" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l1.5726"></a><span id="l1.5726" class="difflineminus">-    {</span>
<a href="#l1.5727"></a><span id="l1.5727" class="difflineplus">+nsresult nsMsgDBView::SaveSortInfo(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5728"></a><span id="l1.5728" class="difflineplus">+                                   nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l1.5729"></a><span id="l1.5729" class="difflineplus">+  if (m_viewFolder) {</span>
<a href="#l1.5730"></a><span id="l1.5730" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5731"></a><span id="l1.5731" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5732"></a><span id="l1.5732" class="difflineplus">+    nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.5733"></a><span id="l1.5733" class="difflineplus">+                                                     getter_AddRefs(db));</span>
<a href="#l1.5734"></a><span id="l1.5734" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo) {</span>
<a href="#l1.5735"></a><span id="l1.5735">       // Save off sort type and order, view type and flags.</span>
<a href="#l1.5736"></a><span id="l1.5736">       folderInfo-&gt;SetSortType(sortType);</span>
<a href="#l1.5737"></a><span id="l1.5737">       folderInfo-&gt;SetSortOrder(sortOrder);</span>
<a href="#l1.5738"></a><span id="l1.5738"> </span>
<a href="#l1.5739"></a><span id="l1.5739">       nsString sortColumnsString;</span>
<a href="#l1.5740"></a><span id="l1.5740">       rv = EncodeColumnSort(sortColumnsString);</span>
<a href="#l1.5741"></a><span id="l1.5741">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.5742"></a><span id="l1.5742">       folderInfo-&gt;SetProperty(&quot;sortColumns&quot;, sortColumnsString);</span>
<a href="#l1.5743"></a><span id="l1.5743">     }</span>
<a href="#l1.5744"></a><span id="l1.5744">   }</span>
<a href="#l1.5745"></a><span id="l1.5745"> </span>
<a href="#l1.5746"></a><span id="l1.5746">   return NS_OK;</span>
<a href="#l1.5747"></a><span id="l1.5747"> }</span>
<a href="#l1.5748"></a><span id="l1.5748"> </span>
<a href="#l1.5749"></a><span id="l1.5749" class="difflineminus">-nsresult</span>
<a href="#l1.5750"></a><span id="l1.5750" class="difflineminus">-nsMsgDBView::RestoreSortInfo()</span>
<a href="#l1.5751"></a><span id="l1.5751" class="difflineminus">-{</span>
<a href="#l1.5752"></a><span id="l1.5752" class="difflineminus">-  if (!m_viewFolder)</span>
<a href="#l1.5753"></a><span id="l1.5753" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5754"></a><span id="l1.5754" class="difflineminus">-</span>
<a href="#l1.5755"></a><span id="l1.5755" class="difflineminus">-  nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5756"></a><span id="l1.5756" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5757"></a><span id="l1.5757" class="difflineplus">+nsresult nsMsgDBView::RestoreSortInfo() {</span>
<a href="#l1.5758"></a><span id="l1.5758" class="difflineplus">+  if (!m_viewFolder) return NS_OK;</span>
<a href="#l1.5759"></a><span id="l1.5759" class="difflineplus">+</span>
<a href="#l1.5760"></a><span id="l1.5760" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.5761"></a><span id="l1.5761" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.5762"></a><span id="l1.5762">   nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.5763"></a><span id="l1.5763">                                                    getter_AddRefs(db));</span>
<a href="#l1.5764"></a><span id="l1.5764" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo)</span>
<a href="#l1.5765"></a><span id="l1.5765" class="difflineminus">-  {</span>
<a href="#l1.5766"></a><span id="l1.5766" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; folderInfo) {</span>
<a href="#l1.5767"></a><span id="l1.5767">     // Restore m_sortColumns from db.</span>
<a href="#l1.5768"></a><span id="l1.5768">     nsString sortColumnsString;</span>
<a href="#l1.5769"></a><span id="l1.5769">     folderInfo-&gt;GetProperty(&quot;sortColumns&quot;, sortColumnsString);</span>
<a href="#l1.5770"></a><span id="l1.5770">     DecodeColumnSort(sortColumnsString);</span>
<a href="#l1.5771"></a><span id="l1.5771" class="difflineminus">-    if (m_sortColumns.Length() &gt; 1)</span>
<a href="#l1.5772"></a><span id="l1.5772" class="difflineminus">-    {</span>
<a href="#l1.5773"></a><span id="l1.5773" class="difflineplus">+    if (m_sortColumns.Length() &gt; 1) {</span>
<a href="#l1.5774"></a><span id="l1.5774">       m_secondarySort = m_sortColumns[1].mSortType;</span>
<a href="#l1.5775"></a><span id="l1.5775">       m_secondarySortOrder = m_sortColumns[1].mSortOrder;</span>
<a href="#l1.5776"></a><span id="l1.5776">       m_secondaryCustomColumn = m_sortColumns[1].mCustomColumnName;</span>
<a href="#l1.5777"></a><span id="l1.5777">     }</span>
<a href="#l1.5778"></a><span id="l1.5778"> </span>
<a href="#l1.5779"></a><span id="l1.5779">     // Restore curCustomColumn from db.</span>
<a href="#l1.5780"></a><span id="l1.5780">     folderInfo-&gt;GetProperty(&quot;customSortCol&quot;, m_curCustomColumn);</span>
<a href="#l1.5781"></a><span id="l1.5781">   }</span>
<a href="#l1.5782"></a><span id="l1.5782"> </span>
<a href="#l1.5783"></a><span id="l1.5783">   return NS_OK;</span>
<a href="#l1.5784"></a><span id="l1.5784"> }</span>
<a href="#l1.5785"></a><span id="l1.5785"> </span>
<a href="#l1.5786"></a><span id="l1.5786"> // Called by msgDBView::Sort, at which point any persisted active custom</span>
<a href="#l1.5787"></a><span id="l1.5787"> // columns must be registered. If not, reset their m_sortColumns entries</span>
<a href="#l1.5788"></a><span id="l1.5788"> // to byDate; Sort will fill in values if necessary based on new user sort.</span>
<a href="#l1.5789"></a><span id="l1.5789" class="difflineminus">-void</span>
<a href="#l1.5790"></a><span id="l1.5790" class="difflineminus">-nsMsgDBView::EnsureCustomColumnsValid()</span>
<a href="#l1.5791"></a><span id="l1.5791" class="difflineminus">-{</span>
<a href="#l1.5792"></a><span id="l1.5792" class="difflineminus">-  if (!m_sortColumns.Length())</span>
<a href="#l1.5793"></a><span id="l1.5793" class="difflineminus">-    return;</span>
<a href="#l1.5794"></a><span id="l1.5794" class="difflineminus">-</span>
<a href="#l1.5795"></a><span id="l1.5795" class="difflineminus">-  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++)</span>
<a href="#l1.5796"></a><span id="l1.5796" class="difflineminus">-  {</span>
<a href="#l1.5797"></a><span id="l1.5797" class="difflineplus">+void nsMsgDBView::EnsureCustomColumnsValid() {</span>
<a href="#l1.5798"></a><span id="l1.5798" class="difflineplus">+  if (!m_sortColumns.Length()) return;</span>
<a href="#l1.5799"></a><span id="l1.5799" class="difflineplus">+</span>
<a href="#l1.5800"></a><span id="l1.5800" class="difflineplus">+  for (uint32_t i = 0; i &lt; m_sortColumns.Length(); i++) {</span>
<a href="#l1.5801"></a><span id="l1.5801">     if (m_sortColumns[i].mSortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.5802"></a><span id="l1.5802" class="difflineminus">-        m_sortColumns[i].mColHandler == nullptr)</span>
<a href="#l1.5803"></a><span id="l1.5803" class="difflineminus">-    {</span>
<a href="#l1.5804"></a><span id="l1.5804" class="difflineplus">+        m_sortColumns[i].mColHandler == nullptr) {</span>
<a href="#l1.5805"></a><span id="l1.5805">       m_sortColumns[i].mSortType = nsMsgViewSortType::byDate;</span>
<a href="#l1.5806"></a><span id="l1.5806">       m_sortColumns[i].mCustomColumnName.Truncate();</span>
<a href="#l1.5807"></a><span id="l1.5807">       // There are only two...</span>
<a href="#l1.5808"></a><span id="l1.5808">       if (i == 0 &amp;&amp; m_sortType != nsMsgViewSortType::byCustom)</span>
<a href="#l1.5809"></a><span id="l1.5809">         SetCurCustomColumn(EmptyString());</span>
<a href="#l1.5810"></a><span id="l1.5810" class="difflineminus">-      if (i == 1)</span>
<a href="#l1.5811"></a><span id="l1.5811" class="difflineminus">-        m_secondaryCustomColumn.Truncate();</span>
<a href="#l1.5812"></a><span id="l1.5812" class="difflineplus">+      if (i == 1) m_secondaryCustomColumn.Truncate();</span>
<a href="#l1.5813"></a><span id="l1.5813">     }</span>
<a href="#l1.5814"></a><span id="l1.5814">   }</span>
<a href="#l1.5815"></a><span id="l1.5815"> }</span>
<a href="#l1.5816"></a><span id="l1.5816"> </span>
<a href="#l1.5817"></a><span id="l1.5817" class="difflineminus">-int32_t  nsMsgDBView::SecondarySort(nsMsgKey key1,</span>
<a href="#l1.5818"></a><span id="l1.5818" class="difflineminus">-                                    nsISupports *supports1,</span>
<a href="#l1.5819"></a><span id="l1.5819" class="difflineminus">-                                    nsMsgKey key2,</span>
<a href="#l1.5820"></a><span id="l1.5820" class="difflineminus">-                                    nsISupports *supports2,</span>
<a href="#l1.5821"></a><span id="l1.5821" class="difflineminus">-                                    viewSortInfo *comparisonContext)</span>
<a href="#l1.5822"></a><span id="l1.5822" class="difflineminus">-{</span>
<a href="#l1.5823"></a><span id="l1.5823" class="difflineplus">+int32_t nsMsgDBView::SecondarySort(nsMsgKey key1, nsISupports *supports1,</span>
<a href="#l1.5824"></a><span id="l1.5824" class="difflineplus">+                                   nsMsgKey key2, nsISupports *supports2,</span>
<a href="#l1.5825"></a><span id="l1.5825" class="difflineplus">+                                   viewSortInfo *comparisonContext) {</span>
<a href="#l1.5826"></a><span id="l1.5826">   // We need to make sure that in the case of the secondary sort field also</span>
<a href="#l1.5827"></a><span id="l1.5827">   // matching, we don't recurse.</span>
<a href="#l1.5828"></a><span id="l1.5828" class="difflineminus">-  if (comparisonContext-&gt;isSecondarySort)</span>
<a href="#l1.5829"></a><span id="l1.5829" class="difflineminus">-    return key1 &gt; key2;</span>
<a href="#l1.5830"></a><span id="l1.5830" class="difflineplus">+  if (comparisonContext-&gt;isSecondarySort) return key1 &gt; key2;</span>
<a href="#l1.5831"></a><span id="l1.5831"> </span>
<a href="#l1.5832"></a><span id="l1.5832">   nsCOMPtr&lt;nsIMsgFolder&gt; folder1, folder2;</span>
<a href="#l1.5833"></a><span id="l1.5833" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; hdr1, hdr2;</span>
<a href="#l1.5834"></a><span id="l1.5834" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr1, hdr2;</span>
<a href="#l1.5835"></a><span id="l1.5835">   folder1 = do_QueryInterface(supports1);</span>
<a href="#l1.5836"></a><span id="l1.5836">   folder2 = do_QueryInterface(supports2);</span>
<a href="#l1.5837"></a><span id="l1.5837">   nsresult rv = folder1-&gt;GetMessageHeader(key1, getter_AddRefs(hdr1));</span>
<a href="#l1.5838"></a><span id="l1.5838">   NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l1.5839"></a><span id="l1.5839">   rv = folder2-&gt;GetMessageHeader(key2, getter_AddRefs(hdr2));</span>
<a href="#l1.5840"></a><span id="l1.5840">   NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l1.5841"></a><span id="l1.5841">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.5842"></a><span id="l1.5842">   EntryInfo1.key = nullptr;</span>
<a href="#l1.5843"></a><span id="l1.5843">   EntryInfo2.key = nullptr;</span>
<a href="#l1.5844"></a><span id="l1.5844"> </span>
<a href="#l1.5845"></a><span id="l1.5845" class="difflineminus">-  uint16_t  maxLen;</span>
<a href="#l1.5846"></a><span id="l1.5846" class="difflineplus">+  uint16_t maxLen;</span>
<a href="#l1.5847"></a><span id="l1.5847">   eFieldType fieldType;</span>
<a href="#l1.5848"></a><span id="l1.5848">   nsMsgViewSortTypeValue sortType = comparisonContext-&gt;view-&gt;m_secondarySort;</span>
<a href="#l1.5849"></a><span id="l1.5849" class="difflineminus">-  nsMsgViewSortOrderValue sortOrder = comparisonContext-&gt;view-&gt;m_secondarySortOrder;</span>
<a href="#l1.5850"></a><span id="l1.5850" class="difflineplus">+  nsMsgViewSortOrderValue sortOrder =</span>
<a href="#l1.5851"></a><span id="l1.5851" class="difflineplus">+      comparisonContext-&gt;view-&gt;m_secondarySortOrder;</span>
<a href="#l1.5852"></a><span id="l1.5852"> </span>
<a href="#l1.5853"></a><span id="l1.5853">   // Get the custom column handler for the *secondary* sort and pass it first</span>
<a href="#l1.5854"></a><span id="l1.5854">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.5855"></a><span id="l1.5855">   // GetCollationKey or GetLongField.</span>
<a href="#l1.5856"></a><span id="l1.5856" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = nullptr;</span>
<a href="#l1.5857"></a><span id="l1.5857" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = nullptr;</span>
<a href="#l1.5858"></a><span id="l1.5858">   if (sortType == nsMsgViewSortType::byCustom &amp;&amp;</span>
<a href="#l1.5859"></a><span id="l1.5859">       comparisonContext-&gt;view-&gt;m_sortColumns.Length() &gt; 1)</span>
<a href="#l1.5860"></a><span id="l1.5860">     colHandler = comparisonContext-&gt;view-&gt;m_sortColumns[1].mColHandler;</span>
<a href="#l1.5861"></a><span id="l1.5861"> </span>
<a href="#l1.5862"></a><span id="l1.5862">   // The following may leave fieldType undefined.</span>
<a href="#l1.5863"></a><span id="l1.5863">   // In this case, we can return 0 right away since</span>
<a href="#l1.5864"></a><span id="l1.5864">   // it is the value returned in the default case of</span>
<a href="#l1.5865"></a><span id="l1.5865">   // switch (fieldType) statement below.</span>
<a href="#l1.5866"></a><span id="l1.5866">   rv = GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.5867"></a><span id="l1.5867">   NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l1.5868"></a><span id="l1.5868"> </span>
<a href="#l1.5869"></a><span id="l1.5869">   const void *pValue1 = &amp;EntryInfo1, *pValue2 = &amp;EntryInfo2;</span>
<a href="#l1.5870"></a><span id="l1.5870"> </span>
<a href="#l1.5871"></a><span id="l1.5871" class="difflineminus">-  int (* comparisonFun) (const void *pItem1, const void *pItem2, void *privateData) = nullptr;</span>
<a href="#l1.5872"></a><span id="l1.5872" class="difflineplus">+  int (*comparisonFun)(const void *pItem1, const void *pItem2,</span>
<a href="#l1.5873"></a><span id="l1.5873" class="difflineplus">+                       void *privateData) = nullptr;</span>
<a href="#l1.5874"></a><span id="l1.5874">   int retStatus = 0;</span>
<a href="#l1.5875"></a><span id="l1.5875">   hdr1-&gt;GetMessageKey(&amp;EntryInfo1.id);</span>
<a href="#l1.5876"></a><span id="l1.5876">   hdr2-&gt;GetMessageKey(&amp;EntryInfo2.id);</span>
<a href="#l1.5877"></a><span id="l1.5877"> </span>
<a href="#l1.5878"></a><span id="l1.5878" class="difflineminus">-  switch (fieldType)</span>
<a href="#l1.5879"></a><span id="l1.5879" class="difflineminus">-  {</span>
<a href="#l1.5880"></a><span id="l1.5880" class="difflineplus">+  switch (fieldType) {</span>
<a href="#l1.5881"></a><span id="l1.5881">     case kCollationKey:</span>
<a href="#l1.5882"></a><span id="l1.5882" class="difflineminus">-      rv = GetCollationKey(hdr1, sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.5883"></a><span id="l1.5883" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.5884"></a><span id="l1.5884" class="difflineplus">+      rv = GetCollationKey(hdr1, sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword,</span>
<a href="#l1.5885"></a><span id="l1.5885" class="difflineplus">+                           colHandler);</span>
<a href="#l1.5886"></a><span id="l1.5886" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.5887"></a><span id="l1.5887">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.5888"></a><span id="l1.5888">       break;</span>
<a href="#l1.5889"></a><span id="l1.5889">     case kU32:</span>
<a href="#l1.5890"></a><span id="l1.5890">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5891"></a><span id="l1.5891">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.5892"></a><span id="l1.5892">       else</span>
<a href="#l1.5893"></a><span id="l1.5893">         GetLongField(hdr1, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.5894"></a><span id="l1.5894"> </span>
<a href="#l1.5895"></a><span id="l1.5895">       comparisonFun = FnSortIdUint32;</span>
<a href="#l1.5896"></a><span id="l1.5896">       break;</span>
<a href="#l1.5897"></a><span id="l1.5897">     default:</span>
<a href="#l1.5898"></a><span id="l1.5898">       return 0;</span>
<a href="#l1.5899"></a><span id="l1.5899">   }</span>
<a href="#l1.5900"></a><span id="l1.5900"> </span>
<a href="#l1.5901"></a><span id="l1.5901">   bool saveAscendingSort = comparisonContext-&gt;ascendingSort;</span>
<a href="#l1.5902"></a><span id="l1.5902">   comparisonContext-&gt;isSecondarySort = true;</span>
<a href="#l1.5903"></a><span id="l1.5903" class="difflineminus">-  comparisonContext-&gt;ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.5904"></a><span id="l1.5904" class="difflineminus">-  if (fieldType == kCollationKey)</span>
<a href="#l1.5905"></a><span id="l1.5905" class="difflineminus">-  {</span>
<a href="#l1.5906"></a><span id="l1.5906" class="difflineplus">+  comparisonContext-&gt;ascendingSort =</span>
<a href="#l1.5907"></a><span id="l1.5907" class="difflineplus">+      (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.5908"></a><span id="l1.5908" class="difflineplus">+  if (fieldType == kCollationKey) {</span>
<a href="#l1.5909"></a><span id="l1.5909">     PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.5910"></a><span id="l1.5910" class="difflineminus">-    rv = GetCollationKey(hdr2, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.5911"></a><span id="l1.5911" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.5912"></a><span id="l1.5912" class="difflineminus">-  }</span>
<a href="#l1.5913"></a><span id="l1.5913" class="difflineminus">-  else if (fieldType == kU32)</span>
<a href="#l1.5914"></a><span id="l1.5914" class="difflineminus">-  {</span>
<a href="#l1.5915"></a><span id="l1.5915" class="difflineplus">+    rv = GetCollationKey(hdr2, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword,</span>
<a href="#l1.5916"></a><span id="l1.5916" class="difflineplus">+                         colHandler);</span>
<a href="#l1.5917"></a><span id="l1.5917" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.5918"></a><span id="l1.5918" class="difflineplus">+  } else if (fieldType == kU32) {</span>
<a href="#l1.5919"></a><span id="l1.5919">     if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.5920"></a><span id="l1.5920">       EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.5921"></a><span id="l1.5921">     else</span>
<a href="#l1.5922"></a><span id="l1.5922">       GetLongField(hdr2, sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.5923"></a><span id="l1.5923">   }</span>
<a href="#l1.5924"></a><span id="l1.5924"> </span>
<a href="#l1.5925"></a><span id="l1.5925">   retStatus = (*comparisonFun)(&amp;pValue1, &amp;pValue2, comparisonContext);</span>
<a href="#l1.5926"></a><span id="l1.5926"> </span>
<a href="#l1.5927"></a><span id="l1.5927">   comparisonContext-&gt;isSecondarySort = false;</span>
<a href="#l1.5928"></a><span id="l1.5928">   comparisonContext-&gt;ascendingSort = saveAscendingSort;</span>
<a href="#l1.5929"></a><span id="l1.5929"> </span>
<a href="#l1.5930"></a><span id="l1.5930">   return retStatus;</span>
<a href="#l1.5931"></a><span id="l1.5931"> }</span>
<a href="#l1.5932"></a><span id="l1.5932"> </span>
<a href="#l1.5933"></a><span id="l1.5933" class="difflineminus">-</span>
<a href="#l1.5934"></a><span id="l1.5934"> NS_IMETHODIMP nsMsgDBView::Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l1.5935"></a><span id="l1.5935" class="difflineminus">-                                nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l1.5936"></a><span id="l1.5936" class="difflineminus">-{</span>
<a href="#l1.5937"></a><span id="l1.5937" class="difflineplus">+                                nsMsgViewSortOrderValue sortOrder) {</span>
<a href="#l1.5938"></a><span id="l1.5938">   EnsureCustomColumnsValid();</span>
<a href="#l1.5939"></a><span id="l1.5939"> </span>
<a href="#l1.5940"></a><span id="l1.5940">   // If we're doing a stable sort, we can't just reverse the messages.</span>
<a href="#l1.5941"></a><span id="l1.5941">   // Check also that the custom column we're sorting on hasn't changed.</span>
<a href="#l1.5942"></a><span id="l1.5942">   // Otherwise, to be on the safe side, resort.</span>
<a href="#l1.5943"></a><span id="l1.5943">   // Note: m_curCustomColumn is the desired (possibly new) custom column name,</span>
<a href="#l1.5944"></a><span id="l1.5944">   // while m_sortColumns[0].mCustomColumnName is the name for the last completed</span>
<a href="#l1.5945"></a><span id="l1.5945">   // sort, since these are persisted after each sort.</span>
<a href="#l1.5946"></a><span id="l1.5946">   if (m_sortType == sortType &amp;&amp; m_sortValid &amp;&amp;</span>
<a href="#l1.5947"></a><span id="l1.5947">       (sortType != nsMsgViewSortType::byCustom ||</span>
<a href="#l1.5948"></a><span id="l1.5948">        (sortType == nsMsgViewSortType::byCustom &amp;&amp; m_sortColumns.Length() &amp;&amp;</span>
<a href="#l1.5949"></a><span id="l1.5949">         m_sortColumns[0].mCustomColumnName.Equals(m_curCustomColumn))) &amp;&amp;</span>
<a href="#l1.5950"></a><span id="l1.5950" class="difflineminus">-      m_sortColumns.Length() &lt; 2)</span>
<a href="#l1.5951"></a><span id="l1.5951" class="difflineminus">-  {</span>
<a href="#l1.5952"></a><span id="l1.5952" class="difflineplus">+      m_sortColumns.Length() &lt; 2) {</span>
<a href="#l1.5953"></a><span id="l1.5953">     // Same as it ever was. Do nothing.</span>
<a href="#l1.5954"></a><span id="l1.5954" class="difflineminus">-    if (m_sortOrder == sortOrder)</span>
<a href="#l1.5955"></a><span id="l1.5955" class="difflineminus">-      return NS_OK;</span>
<a href="#l1.5956"></a><span id="l1.5956" class="difflineplus">+    if (m_sortOrder == sortOrder) return NS_OK;</span>
<a href="#l1.5957"></a><span id="l1.5957"> </span>
<a href="#l1.5958"></a><span id="l1.5958">     // For secondary sort, remember the sort order on a per column basis.</span>
<a href="#l1.5959"></a><span id="l1.5959" class="difflineminus">-    if (m_sortColumns.Length())</span>
<a href="#l1.5960"></a><span id="l1.5960" class="difflineminus">-      m_sortColumns[0].mSortOrder = sortOrder;</span>
<a href="#l1.5961"></a><span id="l1.5961" class="difflineplus">+    if (m_sortColumns.Length()) m_sortColumns[0].mSortOrder = sortOrder;</span>
<a href="#l1.5962"></a><span id="l1.5962"> </span>
<a href="#l1.5963"></a><span id="l1.5963">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l1.5964"></a><span id="l1.5964">     if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.5965"></a><span id="l1.5965">       ReverseThreads();</span>
<a href="#l1.5966"></a><span id="l1.5966">     else</span>
<a href="#l1.5967"></a><span id="l1.5967">       ReverseSort();</span>
<a href="#l1.5968"></a><span id="l1.5968"> </span>
<a href="#l1.5969"></a><span id="l1.5969">     m_sortOrder = sortOrder;</span>
<a href="#l1.5970"></a><span id="l1.5970">     // We just reversed the sort order, we still need to invalidate the view.</span>
<a href="#l1.5971"></a><span id="l1.5971">     return NS_OK;</span>
<a href="#l1.5972"></a><span id="l1.5972">   }</span>
<a href="#l1.5973"></a><span id="l1.5973"> </span>
<a href="#l1.5974"></a><span id="l1.5974" class="difflineminus">-  if (sortType == nsMsgViewSortType::byThread)</span>
<a href="#l1.5975"></a><span id="l1.5975" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.5976"></a><span id="l1.5976" class="difflineplus">+  if (sortType == nsMsgViewSortType::byThread) return NS_OK;</span>
<a href="#l1.5977"></a><span id="l1.5977"> </span>
<a href="#l1.5978"></a><span id="l1.5978">   // If a sortType has changed, or the sortType is byCustom and a column has</span>
<a href="#l1.5979"></a><span id="l1.5979">   // changed, this is the new primary sortColumnInfo.</span>
<a href="#l1.5980"></a><span id="l1.5980">   // Note: m_curCustomColumn is the desired (possibly new) custom column name,</span>
<a href="#l1.5981"></a><span id="l1.5981">   // while m_sortColumns[0].mCustomColumnName is the name for the last completed</span>
<a href="#l1.5982"></a><span id="l1.5982">   // sort, since these are persisted after each sort.</span>
<a href="#l1.5983"></a><span id="l1.5983">   if (m_sortType != sortType ||</span>
<a href="#l1.5984"></a><span id="l1.5984">       (sortType == nsMsgViewSortType::byCustom &amp;&amp; m_sortColumns.Length() &amp;&amp;</span>
<a href="#l1.5985"></a><span id="l1.5985" class="difflineminus">-       !m_sortColumns[0].mCustomColumnName.Equals(m_curCustomColumn)))</span>
<a href="#l1.5986"></a><span id="l1.5986" class="difflineminus">-  {</span>
<a href="#l1.5987"></a><span id="l1.5987" class="difflineplus">+       !m_sortColumns[0].mCustomColumnName.Equals(m_curCustomColumn))) {</span>
<a href="#l1.5988"></a><span id="l1.5988">     // For secondary sort, remember the sort order of the original primary sort!</span>
<a href="#l1.5989"></a><span id="l1.5989" class="difflineminus">-    if (m_sortColumns.Length())</span>
<a href="#l1.5990"></a><span id="l1.5990" class="difflineminus">-      m_sortColumns[0].mSortOrder = m_sortOrder;</span>
<a href="#l1.5991"></a><span id="l1.5991" class="difflineplus">+    if (m_sortColumns.Length()) m_sortColumns[0].mSortOrder = m_sortOrder;</span>
<a href="#l1.5992"></a><span id="l1.5992"> </span>
<a href="#l1.5993"></a><span id="l1.5993">     MsgViewSortColumnInfo sortColumnInfo;</span>
<a href="#l1.5994"></a><span id="l1.5994">     sortColumnInfo.mSortType = sortType;</span>
<a href="#l1.5995"></a><span id="l1.5995">     sortColumnInfo.mSortOrder = sortOrder;</span>
<a href="#l1.5996"></a><span id="l1.5996" class="difflineminus">-    if (sortType == nsMsgViewSortType::byCustom)</span>
<a href="#l1.5997"></a><span id="l1.5997" class="difflineminus">-    {</span>
<a href="#l1.5998"></a><span id="l1.5998" class="difflineplus">+    if (sortType == nsMsgViewSortType::byCustom) {</span>
<a href="#l1.5999"></a><span id="l1.5999">       GetCurCustomColumn(sortColumnInfo.mCustomColumnName);</span>
<a href="#l1.6000"></a><span id="l1.6000">       sortColumnInfo.mColHandler = GetCurColumnHandler();</span>
<a href="#l1.6001"></a><span id="l1.6001">     }</span>
<a href="#l1.6002"></a><span id="l1.6002"> </span>
<a href="#l1.6003"></a><span id="l1.6003">     PushSort(sortColumnInfo);</span>
<a href="#l1.6004"></a><span id="l1.6004" class="difflineminus">-  }</span>
<a href="#l1.6005"></a><span id="l1.6005" class="difflineminus">-  else</span>
<a href="#l1.6006"></a><span id="l1.6006" class="difflineminus">-  {</span>
<a href="#l1.6007"></a><span id="l1.6007" class="difflineplus">+  } else {</span>
<a href="#l1.6008"></a><span id="l1.6008">     // For primary sort, remember the sort order on a per column basis.</span>
<a href="#l1.6009"></a><span id="l1.6009" class="difflineminus">-    if (m_sortColumns.Length())</span>
<a href="#l1.6010"></a><span id="l1.6010" class="difflineminus">-      m_sortColumns[0].mSortOrder = sortOrder;</span>
<a href="#l1.6011"></a><span id="l1.6011" class="difflineminus">-  }</span>
<a href="#l1.6012"></a><span id="l1.6012" class="difflineminus">-</span>
<a href="#l1.6013"></a><span id="l1.6013" class="difflineminus">-  if (m_sortColumns.Length() &gt; 1)</span>
<a href="#l1.6014"></a><span id="l1.6014" class="difflineminus">-  {</span>
<a href="#l1.6015"></a><span id="l1.6015" class="difflineplus">+    if (m_sortColumns.Length()) m_sortColumns[0].mSortOrder = sortOrder;</span>
<a href="#l1.6016"></a><span id="l1.6016" class="difflineplus">+  }</span>
<a href="#l1.6017"></a><span id="l1.6017" class="difflineplus">+</span>
<a href="#l1.6018"></a><span id="l1.6018" class="difflineplus">+  if (m_sortColumns.Length() &gt; 1) {</span>
<a href="#l1.6019"></a><span id="l1.6019">     m_secondarySort = m_sortColumns[1].mSortType;</span>
<a href="#l1.6020"></a><span id="l1.6020">     m_secondarySortOrder = m_sortColumns[1].mSortOrder;</span>
<a href="#l1.6021"></a><span id="l1.6021">     m_secondaryCustomColumn = m_sortColumns[1].mCustomColumnName;</span>
<a href="#l1.6022"></a><span id="l1.6022">   }</span>
<a href="#l1.6023"></a><span id="l1.6023"> </span>
<a href="#l1.6024"></a><span id="l1.6024">   SaveSortInfo(sortType, sortOrder);</span>
<a href="#l1.6025"></a><span id="l1.6025">   // Figure out how much memory we'll need, and then malloc it.</span>
<a href="#l1.6026"></a><span id="l1.6026">   uint16_t maxLen;</span>
<a href="#l1.6027"></a><span id="l1.6027">   eFieldType fieldType;</span>
<a href="#l1.6028"></a><span id="l1.6028"> </span>
<a href="#l1.6029"></a><span id="l1.6029">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.6030"></a><span id="l1.6030">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.6031"></a><span id="l1.6031">   // GetCollationKey or GetLongField.</span>
<a href="#l1.6032"></a><span id="l1.6032" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.6033"></a><span id="l1.6033" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.6034"></a><span id="l1.6034"> </span>
<a href="#l1.6035"></a><span id="l1.6035">   // If we did not obtain proper fieldType, it needs to be checked</span>
<a href="#l1.6036"></a><span id="l1.6036">   // because the subsequent code does not handle it very well.</span>
<a href="#l1.6037"></a><span id="l1.6037" class="difflineminus">-  nsresult rv = GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.6038"></a><span id="l1.6038" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.6039"></a><span id="l1.6039" class="difflineplus">+      GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.6040"></a><span id="l1.6040"> </span>
<a href="#l1.6041"></a><span id="l1.6041">   // Don't sort if the field type is not supported: Bug 901948.</span>
<a href="#l1.6042"></a><span id="l1.6042" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.6043"></a><span id="l1.6043" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.6044"></a><span id="l1.6044" class="difflineminus">-</span>
<a href="#l1.6045"></a><span id="l1.6045" class="difflineminus">-  nsTArray&lt;void*&gt; ptrs;</span>
<a href="#l1.6046"></a><span id="l1.6046" class="difflineplus">+  if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l1.6047"></a><span id="l1.6047" class="difflineplus">+</span>
<a href="#l1.6048"></a><span id="l1.6048" class="difflineplus">+  nsTArray&lt;void *&gt; ptrs;</span>
<a href="#l1.6049"></a><span id="l1.6049">   uint32_t arraySize = GetSize();</span>
<a href="#l1.6050"></a><span id="l1.6050"> </span>
<a href="#l1.6051"></a><span id="l1.6051" class="difflineminus">-  if (!arraySize)</span>
<a href="#l1.6052"></a><span id="l1.6052" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.6053"></a><span id="l1.6053" class="difflineplus">+  if (!arraySize) return NS_OK;</span>
<a href="#l1.6054"></a><span id="l1.6054"> </span>
<a href="#l1.6055"></a><span id="l1.6055">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.6056"></a><span id="l1.6056"> </span>
<a href="#l1.6057"></a><span id="l1.6057" class="difflineminus">-  IdKey** pPtrBase = (IdKey**)PR_Malloc(arraySize * sizeof(IdKey*));</span>
<a href="#l1.6058"></a><span id="l1.6058" class="difflineplus">+  IdKey **pPtrBase = (IdKey **)PR_Malloc(arraySize * sizeof(IdKey *));</span>
<a href="#l1.6059"></a><span id="l1.6059">   NS_ASSERTION(pPtrBase, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.6060"></a><span id="l1.6060" class="difflineminus">-  if (!pPtrBase)</span>
<a href="#l1.6061"></a><span id="l1.6061" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.6062"></a><span id="l1.6062" class="difflineplus">+  if (!pPtrBase) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.6063"></a><span id="l1.6063"> </span>
<a href="#l1.6064"></a><span id="l1.6064">   // Remember this pointer so we can free it later.</span>
<a href="#l1.6065"></a><span id="l1.6065">   ptrs.AppendElement((void *)pPtrBase);</span>
<a href="#l1.6066"></a><span id="l1.6066"> </span>
<a href="#l1.6067"></a><span id="l1.6067">   // Build up the beast, so we can sort it.</span>
<a href="#l1.6068"></a><span id="l1.6068">   uint32_t numSoFar = 0;</span>
<a href="#l1.6069"></a><span id="l1.6069">   const uint32_t keyOffset = offsetof(IdKey, key);</span>
<a href="#l1.6070"></a><span id="l1.6070">   // Calc max possible size needed for all the rest.</span>
<a href="#l1.6071"></a><span id="l1.6071">   uint32_t maxSize = (keyOffset + maxLen) * (arraySize - numSoFar);</span>
<a href="#l1.6072"></a><span id="l1.6072"> </span>
<a href="#l1.6073"></a><span id="l1.6073" class="difflineminus">-  const uint32_t maxBlockSize = (uint32_t) 0xf000L;</span>
<a href="#l1.6074"></a><span id="l1.6074" class="difflineplus">+  const uint32_t maxBlockSize = (uint32_t)0xf000L;</span>
<a href="#l1.6075"></a><span id="l1.6075">   uint32_t allocSize = std::min(maxBlockSize, maxSize);</span>
<a href="#l1.6076"></a><span id="l1.6076" class="difflineminus">-  char *pTemp = (char *) PR_Malloc(allocSize);</span>
<a href="#l1.6077"></a><span id="l1.6077" class="difflineplus">+  char *pTemp = (char *)PR_Malloc(allocSize);</span>
<a href="#l1.6078"></a><span id="l1.6078">   NS_ASSERTION(pTemp, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.6079"></a><span id="l1.6079" class="difflineminus">-  if (!pTemp)</span>
<a href="#l1.6080"></a><span id="l1.6080" class="difflineminus">-  {</span>
<a href="#l1.6081"></a><span id="l1.6081" class="difflineplus">+  if (!pTemp) {</span>
<a href="#l1.6082"></a><span id="l1.6082">     FreeAll(&amp;ptrs);</span>
<a href="#l1.6083"></a><span id="l1.6083">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.6084"></a><span id="l1.6084">   }</span>
<a href="#l1.6085"></a><span id="l1.6085"> </span>
<a href="#l1.6086"></a><span id="l1.6086">   // Remember this pointer so we can free it later.</span>
<a href="#l1.6087"></a><span id="l1.6087">   ptrs.AppendElement(pTemp);</span>
<a href="#l1.6088"></a><span id="l1.6088"> </span>
<a href="#l1.6089"></a><span id="l1.6089">   char *pBase = pTemp;</span>
<a href="#l1.6090"></a><span id="l1.6090">   bool more = true;</span>
<a href="#l1.6091"></a><span id="l1.6091"> </span>
<a href="#l1.6092"></a><span id="l1.6092" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6093"></a><span id="l1.6093" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6094"></a><span id="l1.6094">   uint8_t *keyValue = nullptr;</span>
<a href="#l1.6095"></a><span id="l1.6095">   uint32_t longValue;</span>
<a href="#l1.6096"></a><span id="l1.6096" class="difflineminus">-  while (more &amp;&amp; numSoFar &lt; arraySize)</span>
<a href="#l1.6097"></a><span id="l1.6097" class="difflineminus">-  {</span>
<a href="#l1.6098"></a><span id="l1.6098" class="difflineplus">+  while (more &amp;&amp; numSoFar &lt; arraySize) {</span>
<a href="#l1.6099"></a><span id="l1.6099">     nsMsgKey thisKey = m_keys[numSoFar];</span>
<a href="#l1.6100"></a><span id="l1.6100" class="difflineminus">-    if (sortType != nsMsgViewSortType::byId)</span>
<a href="#l1.6101"></a><span id="l1.6101" class="difflineminus">-    {</span>
<a href="#l1.6102"></a><span id="l1.6102" class="difflineplus">+    if (sortType != nsMsgViewSortType::byId) {</span>
<a href="#l1.6103"></a><span id="l1.6103">       rv = GetMsgHdrForViewIndex(numSoFar, getter_AddRefs(msgHdr));</span>
<a href="#l1.6104"></a><span id="l1.6104">       NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; msgHdr, &quot;header not found&quot;);</span>
<a href="#l1.6105"></a><span id="l1.6105" class="difflineminus">-      if (NS_FAILED(rv) || !msgHdr)</span>
<a href="#l1.6106"></a><span id="l1.6106" class="difflineminus">-      {</span>
<a href="#l1.6107"></a><span id="l1.6107" class="difflineplus">+      if (NS_FAILED(rv) || !msgHdr) {</span>
<a href="#l1.6108"></a><span id="l1.6108">         FreeAll(&amp;ptrs);</span>
<a href="#l1.6109"></a><span id="l1.6109">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6110"></a><span id="l1.6110">       }</span>
<a href="#l1.6111"></a><span id="l1.6111" class="difflineminus">-    }</span>
<a href="#l1.6112"></a><span id="l1.6112" class="difflineminus">-    else</span>
<a href="#l1.6113"></a><span id="l1.6113" class="difflineminus">-    {</span>
<a href="#l1.6114"></a><span id="l1.6114" class="difflineplus">+    } else {</span>
<a href="#l1.6115"></a><span id="l1.6115">       msgHdr = nullptr;</span>
<a href="#l1.6116"></a><span id="l1.6116">     }</span>
<a href="#l1.6117"></a><span id="l1.6117"> </span>
<a href="#l1.6118"></a><span id="l1.6118">     // Could be a problem here if the ones that appear here are different than</span>
<a href="#l1.6119"></a><span id="l1.6119">     // the ones already in the array.</span>
<a href="#l1.6120"></a><span id="l1.6120">     uint32_t actualFieldLen = 0;</span>
<a href="#l1.6121"></a><span id="l1.6121"> </span>
<a href="#l1.6122"></a><span id="l1.6122" class="difflineminus">-    if (fieldType == kCollationKey)</span>
<a href="#l1.6123"></a><span id="l1.6123" class="difflineminus">-    {</span>
<a href="#l1.6124"></a><span id="l1.6124" class="difflineminus">-      rv = GetCollationKey(msgHdr, sortType, &amp;keyValue, &amp;actualFieldLen, colHandler);</span>
<a href="#l1.6125"></a><span id="l1.6125" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6126"></a><span id="l1.6126" class="difflineplus">+    if (fieldType == kCollationKey) {</span>
<a href="#l1.6127"></a><span id="l1.6127" class="difflineplus">+      rv = GetCollationKey(msgHdr, sortType, &amp;keyValue, &amp;actualFieldLen,</span>
<a href="#l1.6128"></a><span id="l1.6128" class="difflineplus">+                           colHandler);</span>
<a href="#l1.6129"></a><span id="l1.6129" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6130"></a><span id="l1.6130"> </span>
<a href="#l1.6131"></a><span id="l1.6131">       longValue = actualFieldLen;</span>
<a href="#l1.6132"></a><span id="l1.6132" class="difflineminus">-    }</span>
<a href="#l1.6133"></a><span id="l1.6133" class="difflineminus">-    else</span>
<a href="#l1.6134"></a><span id="l1.6134" class="difflineminus">-    {</span>
<a href="#l1.6135"></a><span id="l1.6135" class="difflineminus">-      if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.6136"></a><span id="l1.6136" class="difflineminus">-      {</span>
<a href="#l1.6137"></a><span id="l1.6137" class="difflineplus">+    } else {</span>
<a href="#l1.6138"></a><span id="l1.6138" class="difflineplus">+      if (sortType == nsMsgViewSortType::byId) {</span>
<a href="#l1.6139"></a><span id="l1.6139">         longValue = thisKey;</span>
<a href="#l1.6140"></a><span id="l1.6140" class="difflineminus">-      }</span>
<a href="#l1.6141"></a><span id="l1.6141" class="difflineminus">-      else</span>
<a href="#l1.6142"></a><span id="l1.6142" class="difflineminus">-      {</span>
<a href="#l1.6143"></a><span id="l1.6143" class="difflineplus">+      } else {</span>
<a href="#l1.6144"></a><span id="l1.6144">         rv = GetLongField(msgHdr, sortType, &amp;longValue, colHandler);</span>
<a href="#l1.6145"></a><span id="l1.6145" class="difflineminus">-        NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6146"></a><span id="l1.6146" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6147"></a><span id="l1.6147">       }</span>
<a href="#l1.6148"></a><span id="l1.6148">     }</span>
<a href="#l1.6149"></a><span id="l1.6149"> </span>
<a href="#l1.6150"></a><span id="l1.6150">     // Check to see if this entry fits into the block we have allocated so far.</span>
<a href="#l1.6151"></a><span id="l1.6151">     // pTemp - pBase = the space we have used so far.</span>
<a href="#l1.6152"></a><span id="l1.6152">     // sizeof(EntryInfo) + fieldLen = space we need for this entry.</span>
<a href="#l1.6153"></a><span id="l1.6153">     // allocSize = size of the current block.</span>
<a href="#l1.6154"></a><span id="l1.6154" class="difflineminus">-    if ((uint32_t)(pTemp - pBase) + (keyOffset + actualFieldLen) &gt;= allocSize)</span>
<a href="#l1.6155"></a><span id="l1.6155" class="difflineminus">-    {</span>
<a href="#l1.6156"></a><span id="l1.6156" class="difflineplus">+    if ((uint32_t)(pTemp - pBase) + (keyOffset + actualFieldLen) &gt;= allocSize) {</span>
<a href="#l1.6157"></a><span id="l1.6157">       maxSize = (keyOffset + maxLen) * (arraySize - numSoFar);</span>
<a href="#l1.6158"></a><span id="l1.6158">       allocSize = std::min(maxBlockSize, maxSize);</span>
<a href="#l1.6159"></a><span id="l1.6159">       // Make sure allocSize is big enough for the current value.</span>
<a href="#l1.6160"></a><span id="l1.6160">       allocSize = std::max(allocSize, keyOffset + actualFieldLen);</span>
<a href="#l1.6161"></a><span id="l1.6161" class="difflineminus">-      pTemp = (char *) PR_Malloc(allocSize);</span>
<a href="#l1.6162"></a><span id="l1.6162" class="difflineplus">+      pTemp = (char *)PR_Malloc(allocSize);</span>
<a href="#l1.6163"></a><span id="l1.6163">       NS_ASSERTION(pTemp, &quot;out of memory, can't sort&quot;);</span>
<a href="#l1.6164"></a><span id="l1.6164" class="difflineminus">-      if (!pTemp)</span>
<a href="#l1.6165"></a><span id="l1.6165" class="difflineminus">-      {</span>
<a href="#l1.6166"></a><span id="l1.6166" class="difflineplus">+      if (!pTemp) {</span>
<a href="#l1.6167"></a><span id="l1.6167">         FreeAll(&amp;ptrs);</span>
<a href="#l1.6168"></a><span id="l1.6168">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.6169"></a><span id="l1.6169">       }</span>
<a href="#l1.6170"></a><span id="l1.6170">       pBase = pTemp;</span>
<a href="#l1.6171"></a><span id="l1.6171">       // Remember this pointer so we can free it later.</span>
<a href="#l1.6172"></a><span id="l1.6172">       ptrs.AppendElement(pTemp);</span>
<a href="#l1.6173"></a><span id="l1.6173">     }</span>
<a href="#l1.6174"></a><span id="l1.6174"> </span>
<a href="#l1.6175"></a><span id="l1.6175">     // Now store this entry away in the allocated memory.</span>
<a href="#l1.6176"></a><span id="l1.6176" class="difflineminus">-    IdKey *info = (IdKey*)pTemp;</span>
<a href="#l1.6177"></a><span id="l1.6177" class="difflineplus">+    IdKey *info = (IdKey *)pTemp;</span>
<a href="#l1.6178"></a><span id="l1.6178">     pPtrBase[numSoFar] = info;</span>
<a href="#l1.6179"></a><span id="l1.6179">     info-&gt;id = thisKey;</span>
<a href="#l1.6180"></a><span id="l1.6180">     info-&gt;bits = m_flags[numSoFar];</span>
<a href="#l1.6181"></a><span id="l1.6181">     info-&gt;dword = longValue;</span>
<a href="#l1.6182"></a><span id="l1.6182" class="difflineminus">-    //info-&gt;pad = 0;</span>
<a href="#l1.6183"></a><span id="l1.6183" class="difflineplus">+    // info-&gt;pad = 0;</span>
<a href="#l1.6184"></a><span id="l1.6184">     info-&gt;folder = folders ? folders-&gt;ObjectAt(numSoFar) : m_folder.get();</span>
<a href="#l1.6185"></a><span id="l1.6185"> </span>
<a href="#l1.6186"></a><span id="l1.6186">     memcpy(info-&gt;key, keyValue, actualFieldLen);</span>
<a href="#l1.6187"></a><span id="l1.6187">     // In order to align memory for systems that require it, such as HP-UX,</span>
<a href="#l1.6188"></a><span id="l1.6188">     // calculate the correct value to pad the actualFieldLen value.</span>
<a href="#l1.6189"></a><span id="l1.6189">     const uint32_t align = sizeof(IdKey) - sizeof(IdUint32) - 1;</span>
<a href="#l1.6190"></a><span id="l1.6190">     actualFieldLen = (actualFieldLen + align) &amp; ~align;</span>
<a href="#l1.6191"></a><span id="l1.6191"> </span>
<a href="#l1.6192"></a><span id="l1.6192" class="difflineat">@@ -5246,690 +4573,577 @@ NS_IMETHODIMP nsMsgDBView::Sort(nsMsgVie</span>
<a href="#l1.6193"></a><span id="l1.6193">     PR_Free(keyValue);</span>
<a href="#l1.6194"></a><span id="l1.6194">   }</span>
<a href="#l1.6195"></a><span id="l1.6195"> </span>
<a href="#l1.6196"></a><span id="l1.6196">   viewSortInfo qsPrivateData;</span>
<a href="#l1.6197"></a><span id="l1.6197">   qsPrivateData.view = this;</span>
<a href="#l1.6198"></a><span id="l1.6198">   qsPrivateData.isSecondarySort = false;</span>
<a href="#l1.6199"></a><span id="l1.6199">   qsPrivateData.ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.6200"></a><span id="l1.6200"> </span>
<a href="#l1.6201"></a><span id="l1.6201" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.6202"></a><span id="l1.6202" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; dbToUse = m_db;</span>
<a href="#l1.6203"></a><span id="l1.6203"> </span>
<a href="#l1.6204"></a><span id="l1.6204">   // Probably a search view.</span>
<a href="#l1.6205"></a><span id="l1.6205" class="difflineminus">-  if (!dbToUse)</span>
<a href="#l1.6206"></a><span id="l1.6206" class="difflineminus">-    GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.6207"></a><span id="l1.6207" class="difflineplus">+  if (!dbToUse) GetDBForViewIndex(0, getter_AddRefs(dbToUse));</span>
<a href="#l1.6208"></a><span id="l1.6208"> </span>
<a href="#l1.6209"></a><span id="l1.6209">   qsPrivateData.db = dbToUse;</span>
<a href="#l1.6210"></a><span id="l1.6210" class="difflineminus">-  if (dbToUse)</span>
<a href="#l1.6211"></a><span id="l1.6211" class="difflineminus">-  {</span>
<a href="#l1.6212"></a><span id="l1.6212" class="difflineplus">+  if (dbToUse) {</span>
<a href="#l1.6213"></a><span id="l1.6213">     // Do the sort.</span>
<a href="#l1.6214"></a><span id="l1.6214" class="difflineminus">-    switch (fieldType)</span>
<a href="#l1.6215"></a><span id="l1.6215" class="difflineminus">-    {</span>
<a href="#l1.6216"></a><span id="l1.6216" class="difflineplus">+    switch (fieldType) {</span>
<a href="#l1.6217"></a><span id="l1.6217">       case kCollationKey:</span>
<a href="#l1.6218"></a><span id="l1.6218" class="difflineminus">-        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdKey, &amp;qsPrivateData);</span>
<a href="#l1.6219"></a><span id="l1.6219" class="difflineplus">+        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey *), FnSortIdKey,</span>
<a href="#l1.6220"></a><span id="l1.6220" class="difflineplus">+                     &amp;qsPrivateData);</span>
<a href="#l1.6221"></a><span id="l1.6221">         break;</span>
<a href="#l1.6222"></a><span id="l1.6222">       case kU32:</span>
<a href="#l1.6223"></a><span id="l1.6223" class="difflineminus">-        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey*), FnSortIdUint32, &amp;qsPrivateData);</span>
<a href="#l1.6224"></a><span id="l1.6224" class="difflineplus">+        NS_QuickSort(pPtrBase, numSoFar, sizeof(IdKey *), FnSortIdUint32,</span>
<a href="#l1.6225"></a><span id="l1.6225" class="difflineplus">+                     &amp;qsPrivateData);</span>
<a href="#l1.6226"></a><span id="l1.6226">         break;</span>
<a href="#l1.6227"></a><span id="l1.6227">       default:</span>
<a href="#l1.6228"></a><span id="l1.6228">         NS_ERROR(&quot;not supposed to get here&quot;);</span>
<a href="#l1.6229"></a><span id="l1.6229">         break;</span>
<a href="#l1.6230"></a><span id="l1.6230">     }</span>
<a href="#l1.6231"></a><span id="l1.6231">   }</span>
<a href="#l1.6232"></a><span id="l1.6232"> </span>
<a href="#l1.6233"></a><span id="l1.6233">   // Now put the IDs into the array in proper order.</span>
<a href="#l1.6234"></a><span id="l1.6234" class="difflineminus">-  for (uint32_t i = 0; i &lt; numSoFar; i++)</span>
<a href="#l1.6235"></a><span id="l1.6235" class="difflineminus">-  {</span>
<a href="#l1.6236"></a><span id="l1.6236" class="difflineplus">+  for (uint32_t i = 0; i &lt; numSoFar; i++) {</span>
<a href="#l1.6237"></a><span id="l1.6237">     m_keys[i] = pPtrBase[i]-&gt;id;</span>
<a href="#l1.6238"></a><span id="l1.6238">     m_flags[i] = pPtrBase[i]-&gt;bits;</span>
<a href="#l1.6239"></a><span id="l1.6239"> </span>
<a href="#l1.6240"></a><span id="l1.6240" class="difflineminus">-    if (folders)</span>
<a href="#l1.6241"></a><span id="l1.6241" class="difflineminus">-      folders-&gt;ReplaceObjectAt(pPtrBase[i]-&gt;folder, i);</span>
<a href="#l1.6242"></a><span id="l1.6242" class="difflineplus">+    if (folders) folders-&gt;ReplaceObjectAt(pPtrBase[i]-&gt;folder, i);</span>
<a href="#l1.6243"></a><span id="l1.6243">   }</span>
<a href="#l1.6244"></a><span id="l1.6244"> </span>
<a href="#l1.6245"></a><span id="l1.6245">   m_sortType = sortType;</span>
<a href="#l1.6246"></a><span id="l1.6246">   m_sortOrder = sortOrder;</span>
<a href="#l1.6247"></a><span id="l1.6247"> </span>
<a href="#l1.6248"></a><span id="l1.6248">   // Free all the memory we allocated.</span>
<a href="#l1.6249"></a><span id="l1.6249">   FreeAll(&amp;ptrs);</span>
<a href="#l1.6250"></a><span id="l1.6250"> </span>
<a href="#l1.6251"></a><span id="l1.6251">   m_sortValid = true;</span>
<a href="#l1.6252"></a><span id="l1.6252" class="difflineminus">-  //m_db-&gt;SetSortInfo(sortType, sortOrder);</span>
<a href="#l1.6253"></a><span id="l1.6253" class="difflineminus">-</span>
<a href="#l1.6254"></a><span id="l1.6254" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.6255"></a><span id="l1.6255" class="difflineminus">-}</span>
<a href="#l1.6256"></a><span id="l1.6256" class="difflineminus">-</span>
<a href="#l1.6257"></a><span id="l1.6257" class="difflineminus">-void</span>
<a href="#l1.6258"></a><span id="l1.6258" class="difflineminus">-nsMsgDBView::FreeAll(nsTArray&lt;void*&gt; *ptrs)</span>
<a href="#l1.6259"></a><span id="l1.6259" class="difflineminus">-{</span>
<a href="#l1.6260"></a><span id="l1.6260" class="difflineplus">+  // m_db-&gt;SetSortInfo(sortType, sortOrder);</span>
<a href="#l1.6261"></a><span id="l1.6261" class="difflineplus">+</span>
<a href="#l1.6262"></a><span id="l1.6262" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.6263"></a><span id="l1.6263" class="difflineplus">+}</span>
<a href="#l1.6264"></a><span id="l1.6264" class="difflineplus">+</span>
<a href="#l1.6265"></a><span id="l1.6265" class="difflineplus">+void nsMsgDBView::FreeAll(nsTArray&lt;void *&gt; *ptrs) {</span>
<a href="#l1.6266"></a><span id="l1.6266">   int32_t i;</span>
<a href="#l1.6267"></a><span id="l1.6267" class="difflineminus">-  int32_t count = (int32_t) ptrs-&gt;Length();</span>
<a href="#l1.6268"></a><span id="l1.6268" class="difflineminus">-  if (count == 0)</span>
<a href="#l1.6269"></a><span id="l1.6269" class="difflineminus">-    return;</span>
<a href="#l1.6270"></a><span id="l1.6270" class="difflineminus">-</span>
<a href="#l1.6271"></a><span id="l1.6271" class="difflineminus">-  for (i=(count - 1);i&gt;=0;i--)</span>
<a href="#l1.6272"></a><span id="l1.6272" class="difflineminus">-    PR_Free((void *) ptrs-&gt;ElementAt(i));</span>
<a href="#l1.6273"></a><span id="l1.6273" class="difflineplus">+  int32_t count = (int32_t)ptrs-&gt;Length();</span>
<a href="#l1.6274"></a><span id="l1.6274" class="difflineplus">+  if (count == 0) return;</span>
<a href="#l1.6275"></a><span id="l1.6275" class="difflineplus">+</span>
<a href="#l1.6276"></a><span id="l1.6276" class="difflineplus">+  for (i = (count - 1); i &gt;= 0; i--) PR_Free((void *)ptrs-&gt;ElementAt(i));</span>
<a href="#l1.6277"></a><span id="l1.6277"> </span>
<a href="#l1.6278"></a><span id="l1.6278">   ptrs-&gt;Clear();</span>
<a href="#l1.6279"></a><span id="l1.6279"> }</span>
<a href="#l1.6280"></a><span id="l1.6280"> </span>
<a href="#l1.6281"></a><span id="l1.6281" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6282"></a><span id="l1.6282" class="difflineminus">-nsMsgDBView::GetIndexOfFirstDisplayedKeyInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.6283"></a><span id="l1.6283" class="difflineminus">-                                                 bool allowDummy)</span>
<a href="#l1.6284"></a><span id="l1.6284" class="difflineminus">-{</span>
<a href="#l1.6285"></a><span id="l1.6285" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetIndexOfFirstDisplayedKeyInThread(</span>
<a href="#l1.6286"></a><span id="l1.6286" class="difflineplus">+    nsIMsgThread *threadHdr, bool allowDummy) {</span>
<a href="#l1.6287"></a><span id="l1.6287">   nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6288"></a><span id="l1.6288">   uint32_t childIndex = 0;</span>
<a href="#l1.6289"></a><span id="l1.6289">   // We could speed up the unreadOnly view by starting our search with the first</span>
<a href="#l1.6290"></a><span id="l1.6290">   // unread message in the thread. Sometimes, that will be wrong, however, so</span>
<a href="#l1.6291"></a><span id="l1.6291">   // let's skip it until we're sure it's necessary.</span>
<a href="#l1.6292"></a><span id="l1.6292">   //  (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6293"></a><span id="l1.6293">   //    ? threadHdr-&gt;GetFirstUnreadKey(m_db) : threadHdr-&gt;GetChildAt(0);</span>
<a href="#l1.6294"></a><span id="l1.6294">   uint32_t numThreadChildren;</span>
<a href="#l1.6295"></a><span id="l1.6295">   threadHdr-&gt;GetNumChildren(&amp;numThreadChildren);</span>
<a href="#l1.6296"></a><span id="l1.6296" class="difflineminus">-  while (retIndex == nsMsgViewIndex_None &amp;&amp; childIndex &lt; numThreadChildren)</span>
<a href="#l1.6297"></a><span id="l1.6297" class="difflineminus">-  {</span>
<a href="#l1.6298"></a><span id="l1.6298" class="difflineplus">+  while (retIndex == nsMsgViewIndex_None &amp;&amp; childIndex &lt; numThreadChildren) {</span>
<a href="#l1.6299"></a><span id="l1.6299">     nsCOMPtr&lt;nsIMsgDBHdr&gt; childHdr;</span>
<a href="#l1.6300"></a><span id="l1.6300">     threadHdr-&gt;GetChildHdrAt(childIndex++, getter_AddRefs(childHdr));</span>
<a href="#l1.6301"></a><span id="l1.6301" class="difflineminus">-    if (childHdr)</span>
<a href="#l1.6302"></a><span id="l1.6302" class="difflineminus">-      retIndex = FindHdr(childHdr, 0, allowDummy);</span>
<a href="#l1.6303"></a><span id="l1.6303" class="difflineplus">+    if (childHdr) retIndex = FindHdr(childHdr, 0, allowDummy);</span>
<a href="#l1.6304"></a><span id="l1.6304">   }</span>
<a href="#l1.6305"></a><span id="l1.6305"> </span>
<a href="#l1.6306"></a><span id="l1.6306">   return retIndex;</span>
<a href="#l1.6307"></a><span id="l1.6307"> }</span>
<a href="#l1.6308"></a><span id="l1.6308"> </span>
<a href="#l1.6309"></a><span id="l1.6309" class="difflineminus">-nsresult</span>
<a href="#l1.6310"></a><span id="l1.6310" class="difflineminus">-nsMsgDBView::GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.6311"></a><span id="l1.6311" class="difflineminus">-                                                 nsIMsgDBHdr **result)</span>
<a href="#l1.6312"></a><span id="l1.6312" class="difflineminus">-{</span>
<a href="#l1.6313"></a><span id="l1.6313" class="difflineplus">+nsresult nsMsgDBView::GetFirstMessageHdrToDisplayInThread(</span>
<a href="#l1.6314"></a><span id="l1.6314" class="difflineplus">+    nsIMsgThread *threadHdr, nsIMsgDBHdr **result) {</span>
<a href="#l1.6315"></a><span id="l1.6315">   nsresult rv;</span>
<a href="#l1.6316"></a><span id="l1.6316"> </span>
<a href="#l1.6317"></a><span id="l1.6317">   if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6318"></a><span id="l1.6318">     rv = threadHdr-&gt;GetFirstUnreadChild(result);</span>
<a href="#l1.6319"></a><span id="l1.6319">   else</span>
<a href="#l1.6320"></a><span id="l1.6320">     rv = threadHdr-&gt;GetChildHdrAt(0, result);</span>
<a href="#l1.6321"></a><span id="l1.6321"> </span>
<a href="#l1.6322"></a><span id="l1.6322">   return rv;</span>
<a href="#l1.6323"></a><span id="l1.6323"> }</span>
<a href="#l1.6324"></a><span id="l1.6324"> </span>
<a href="#l1.6325"></a><span id="l1.6325"> // Find the view index of the thread containing the passed msgKey, if</span>
<a href="#l1.6326"></a><span id="l1.6326"> // the thread is in the view. MsgIndex is passed in as a shortcut if</span>
<a href="#l1.6327"></a><span id="l1.6327"> // it turns out the msgKey is the first message in the thread,</span>
<a href="#l1.6328"></a><span id="l1.6328"> // then we can avoid looking for the msgKey.</span>
<a href="#l1.6329"></a><span id="l1.6329" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6330"></a><span id="l1.6330" class="difflineminus">-nsMsgDBView::ThreadIndexOfMsg(nsMsgKey msgKey,</span>
<a href="#l1.6331"></a><span id="l1.6331" class="difflineminus">-                              nsMsgViewIndex msgIndex /* = nsMsgViewIndex_None */,</span>
<a href="#l1.6332"></a><span id="l1.6332" class="difflineminus">-                              int32_t *pThreadCount /* = NULL */,</span>
<a href="#l1.6333"></a><span id="l1.6333" class="difflineminus">-                              uint32_t *pFlags /* = NULL */)</span>
<a href="#l1.6334"></a><span id="l1.6334" class="difflineminus">-{</span>
<a href="#l1.6335"></a><span id="l1.6335" class="difflineminus">-  if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.6336"></a><span id="l1.6336" class="difflineplus">+nsMsgViewIndex nsMsgDBView::ThreadIndexOfMsg(</span>
<a href="#l1.6337"></a><span id="l1.6337" class="difflineplus">+    nsMsgKey msgKey, nsMsgViewIndex msgIndex /* = nsMsgViewIndex_None */,</span>
<a href="#l1.6338"></a><span id="l1.6338" class="difflineplus">+    int32_t *pThreadCount /* = NULL */, uint32_t *pFlags /* = NULL */) {</span>
<a href="#l1.6339"></a><span id="l1.6339" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.6340"></a><span id="l1.6340">     return nsMsgViewIndex_None;</span>
<a href="#l1.6341"></a><span id="l1.6341"> </span>
<a href="#l1.6342"></a><span id="l1.6342" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6343"></a><span id="l1.6343" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6344"></a><span id="l1.6344">   nsresult rv = m_db-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l1.6345"></a><span id="l1.6345">   NS_ENSURE_SUCCESS(rv, nsMsgViewIndex_None);</span>
<a href="#l1.6346"></a><span id="l1.6346">   return ThreadIndexOfMsgHdr(msgHdr, msgIndex, pThreadCount, pFlags);</span>
<a href="#l1.6347"></a><span id="l1.6347"> }</span>
<a href="#l1.6348"></a><span id="l1.6348"> </span>
<a href="#l1.6349"></a><span id="l1.6349" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6350"></a><span id="l1.6350" class="difflineminus">-nsMsgDBView::GetThreadIndex(nsMsgViewIndex msgIndex)</span>
<a href="#l1.6351"></a><span id="l1.6351" class="difflineminus">-{</span>
<a href="#l1.6352"></a><span id="l1.6352" class="difflineminus">-  if (!IsValidIndex(msgIndex))</span>
<a href="#l1.6353"></a><span id="l1.6353" class="difflineminus">-    return nsMsgViewIndex_None;</span>
<a href="#l1.6354"></a><span id="l1.6354" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetThreadIndex(nsMsgViewIndex msgIndex) {</span>
<a href="#l1.6355"></a><span id="l1.6355" class="difflineplus">+  if (!IsValidIndex(msgIndex)) return nsMsgViewIndex_None;</span>
<a href="#l1.6356"></a><span id="l1.6356"> </span>
<a href="#l1.6357"></a><span id="l1.6357">   // Scan up looking for level 0 message.</span>
<a href="#l1.6358"></a><span id="l1.6358" class="difflineminus">-  while (m_levels[msgIndex] &amp;&amp; msgIndex)</span>
<a href="#l1.6359"></a><span id="l1.6359" class="difflineminus">-    --msgIndex;</span>
<a href="#l1.6360"></a><span id="l1.6360" class="difflineplus">+  while (m_levels[msgIndex] &amp;&amp; msgIndex) --msgIndex;</span>
<a href="#l1.6361"></a><span id="l1.6361"> </span>
<a href="#l1.6362"></a><span id="l1.6362">   return msgIndex;</span>
<a href="#l1.6363"></a><span id="l1.6363"> }</span>
<a href="#l1.6364"></a><span id="l1.6364"> </span>
<a href="#l1.6365"></a><span id="l1.6365" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6366"></a><span id="l1.6366" class="difflineminus">-nsMsgDBView::ThreadIndexOfMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6367"></a><span id="l1.6367" class="difflineminus">-                                 nsMsgViewIndex msgIndex,</span>
<a href="#l1.6368"></a><span id="l1.6368" class="difflineminus">-                                 int32_t *pThreadCount,</span>
<a href="#l1.6369"></a><span id="l1.6369" class="difflineminus">-                                 uint32_t *pFlags)</span>
<a href="#l1.6370"></a><span id="l1.6370" class="difflineminus">-{</span>
<a href="#l1.6371"></a><span id="l1.6371" class="difflineplus">+nsMsgViewIndex nsMsgDBView::ThreadIndexOfMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6372"></a><span id="l1.6372" class="difflineplus">+                                                nsMsgViewIndex msgIndex,</span>
<a href="#l1.6373"></a><span id="l1.6373" class="difflineplus">+                                                int32_t *pThreadCount,</span>
<a href="#l1.6374"></a><span id="l1.6374" class="difflineplus">+                                                uint32_t *pFlags) {</span>
<a href="#l1.6375"></a><span id="l1.6375">   nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.6376"></a><span id="l1.6376">   nsresult rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(threadHdr));</span>
<a href="#l1.6377"></a><span id="l1.6377">   NS_ENSURE_SUCCESS(rv, nsMsgViewIndex_None);</span>
<a href="#l1.6378"></a><span id="l1.6378"> </span>
<a href="#l1.6379"></a><span id="l1.6379">   nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6380"></a><span id="l1.6380"> </span>
<a href="#l1.6381"></a><span id="l1.6381" class="difflineminus">-  if (threadHdr != nullptr)</span>
<a href="#l1.6382"></a><span id="l1.6382" class="difflineminus">-  {</span>
<a href="#l1.6383"></a><span id="l1.6383" class="difflineminus">-    if (msgIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6384"></a><span id="l1.6384" class="difflineminus">-      msgIndex = FindHdr(msgHdr, 0, true);</span>
<a href="#l1.6385"></a><span id="l1.6385" class="difflineplus">+  if (threadHdr != nullptr) {</span>
<a href="#l1.6386"></a><span id="l1.6386" class="difflineplus">+    if (msgIndex == nsMsgViewIndex_None) msgIndex = FindHdr(msgHdr, 0, true);</span>
<a href="#l1.6387"></a><span id="l1.6387"> </span>
<a href="#l1.6388"></a><span id="l1.6388">     // Hdr is not in view, need to find by thread.</span>
<a href="#l1.6389"></a><span id="l1.6389" class="difflineminus">-    if (msgIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6390"></a><span id="l1.6390" class="difflineminus">-    {</span>
<a href="#l1.6391"></a><span id="l1.6391" class="difflineplus">+    if (msgIndex == nsMsgViewIndex_None) {</span>
<a href="#l1.6392"></a><span id="l1.6392">       msgIndex = GetIndexOfFirstDisplayedKeyInThread(threadHdr, true);</span>
<a href="#l1.6393"></a><span id="l1.6393" class="difflineminus">-      // nsMsgKey threadKey = (msgIndex == nsMsgViewIndex_None) ? nsMsgKey_None :</span>
<a href="#l1.6394"></a><span id="l1.6394" class="difflineplus">+      // nsMsgKey threadKey = (msgIndex == nsMsgViewIndex_None) ? nsMsgKey_None</span>
<a href="#l1.6395"></a><span id="l1.6395" class="difflineplus">+      // :</span>
<a href="#l1.6396"></a><span id="l1.6396">       //                                                          GetAt(msgIndex);</span>
<a href="#l1.6397"></a><span id="l1.6397" class="difflineminus">-      if (pFlags)</span>
<a href="#l1.6398"></a><span id="l1.6398" class="difflineminus">-        threadHdr-&gt;GetFlags(pFlags);</span>
<a href="#l1.6399"></a><span id="l1.6399" class="difflineplus">+      if (pFlags) threadHdr-&gt;GetFlags(pFlags);</span>
<a href="#l1.6400"></a><span id="l1.6400">     }</span>
<a href="#l1.6401"></a><span id="l1.6401"> </span>
<a href="#l1.6402"></a><span id="l1.6402">     nsMsgViewIndex startOfThread = msgIndex;</span>
<a href="#l1.6403"></a><span id="l1.6403" class="difflineminus">-    while ((int32_t) startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6404"></a><span id="l1.6404" class="difflineplus">+    while ((int32_t)startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6405"></a><span id="l1.6405">       startOfThread--;</span>
<a href="#l1.6406"></a><span id="l1.6406"> </span>
<a href="#l1.6407"></a><span id="l1.6407">     retIndex = startOfThread;</span>
<a href="#l1.6408"></a><span id="l1.6408" class="difflineminus">-    if (pThreadCount)</span>
<a href="#l1.6409"></a><span id="l1.6409" class="difflineminus">-    {</span>
<a href="#l1.6410"></a><span id="l1.6410" class="difflineplus">+    if (pThreadCount) {</span>
<a href="#l1.6411"></a><span id="l1.6411">       int32_t numChildren = 0;</span>
<a href="#l1.6412"></a><span id="l1.6412">       nsMsgViewIndex threadIndex = startOfThread;</span>
<a href="#l1.6413"></a><span id="l1.6413" class="difflineminus">-      do</span>
<a href="#l1.6414"></a><span id="l1.6414" class="difflineminus">-      {</span>
<a href="#l1.6415"></a><span id="l1.6415" class="difflineplus">+      do {</span>
<a href="#l1.6416"></a><span id="l1.6416">         threadIndex++;</span>
<a href="#l1.6417"></a><span id="l1.6417">         numChildren++;</span>
<a href="#l1.6418"></a><span id="l1.6418" class="difflineminus">-      }</span>
<a href="#l1.6419"></a><span id="l1.6419" class="difflineminus">-      while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6420"></a><span id="l1.6420" class="difflineplus">+      } while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6421"></a><span id="l1.6421"> </span>
<a href="#l1.6422"></a><span id="l1.6422">       *pThreadCount = numChildren;</span>
<a href="#l1.6423"></a><span id="l1.6423">     }</span>
<a href="#l1.6424"></a><span id="l1.6424">   }</span>
<a href="#l1.6425"></a><span id="l1.6425"> </span>
<a href="#l1.6426"></a><span id="l1.6426">   return retIndex;</span>
<a href="#l1.6427"></a><span id="l1.6427"> }</span>
<a href="#l1.6428"></a><span id="l1.6428"> </span>
<a href="#l1.6429"></a><span id="l1.6429" class="difflineminus">-nsMsgKey</span>
<a href="#l1.6430"></a><span id="l1.6430" class="difflineminus">-nsMsgDBView::GetKeyOfFirstMsgInThread(nsMsgKey key)</span>
<a href="#l1.6431"></a><span id="l1.6431" class="difflineminus">-{</span>
<a href="#l1.6432"></a><span id="l1.6432" class="difflineplus">+nsMsgKey nsMsgDBView::GetKeyOfFirstMsgInThread(nsMsgKey key) {</span>
<a href="#l1.6433"></a><span id="l1.6433">   // Just report no key for any failure. This can occur when a</span>
<a href="#l1.6434"></a><span id="l1.6434">   // message is deleted from a threaded view.</span>
<a href="#l1.6435"></a><span id="l1.6435" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6436"></a><span id="l1.6436" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6437"></a><span id="l1.6437" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6438"></a><span id="l1.6438" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6439"></a><span id="l1.6439">   nsresult rv = m_db-&gt;GetMsgHdrForKey(key, getter_AddRefs(msgHdr));</span>
<a href="#l1.6440"></a><span id="l1.6440" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.6441"></a><span id="l1.6441" class="difflineminus">-    return nsMsgKey_None;</span>
<a href="#l1.6442"></a><span id="l1.6442" class="difflineplus">+  if (NS_FAILED(rv)) return nsMsgKey_None;</span>
<a href="#l1.6443"></a><span id="l1.6443"> </span>
<a href="#l1.6444"></a><span id="l1.6444">   rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.6445"></a><span id="l1.6445" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.6446"></a><span id="l1.6446" class="difflineminus">-    return nsMsgKey_None;</span>
<a href="#l1.6447"></a><span id="l1.6447" class="difflineminus">-</span>
<a href="#l1.6448"></a><span id="l1.6448" class="difflineminus">-  nsMsgKey  firstKeyInThread = nsMsgKey_None;</span>
<a href="#l1.6449"></a><span id="l1.6449" class="difflineminus">-</span>
<a href="#l1.6450"></a><span id="l1.6450" class="difflineminus">-  if (!pThread)</span>
<a href="#l1.6451"></a><span id="l1.6451" class="difflineminus">-    return firstKeyInThread;</span>
<a href="#l1.6452"></a><span id="l1.6452" class="difflineplus">+  if (NS_FAILED(rv)) return nsMsgKey_None;</span>
<a href="#l1.6453"></a><span id="l1.6453" class="difflineplus">+</span>
<a href="#l1.6454"></a><span id="l1.6454" class="difflineplus">+  nsMsgKey firstKeyInThread = nsMsgKey_None;</span>
<a href="#l1.6455"></a><span id="l1.6455" class="difflineplus">+</span>
<a href="#l1.6456"></a><span id="l1.6456" class="difflineplus">+  if (!pThread) return firstKeyInThread;</span>
<a href="#l1.6457"></a><span id="l1.6457"> </span>
<a href="#l1.6458"></a><span id="l1.6458">   // ### dmb UnreadOnly - this is wrong. But didn't seem to matter in 4.x</span>
<a href="#l1.6459"></a><span id="l1.6459">   pThread-&gt;GetChildKeyAt(0, &amp;firstKeyInThread);</span>
<a href="#l1.6460"></a><span id="l1.6460">   return firstKeyInThread;</span>
<a href="#l1.6461"></a><span id="l1.6461"> }</span>
<a href="#l1.6462"></a><span id="l1.6462"> </span>
<a href="#l1.6463"></a><span id="l1.6463"> NS_IMETHODIMP</span>
<a href="#l1.6464"></a><span id="l1.6464" class="difflineminus">-nsMsgDBView::GetKeyAt(nsMsgViewIndex index,</span>
<a href="#l1.6465"></a><span id="l1.6465" class="difflineminus">-                      nsMsgKey *result)</span>
<a href="#l1.6466"></a><span id="l1.6466" class="difflineminus">-{</span>
<a href="#l1.6467"></a><span id="l1.6467" class="difflineplus">+nsMsgDBView::GetKeyAt(nsMsgViewIndex index, nsMsgKey *result) {</span>
<a href="#l1.6468"></a><span id="l1.6468">   NS_ENSURE_ARG(result);</span>
<a href="#l1.6469"></a><span id="l1.6469">   *result = GetAt(index);</span>
<a href="#l1.6470"></a><span id="l1.6470">   return NS_OK;</span>
<a href="#l1.6471"></a><span id="l1.6471"> }</span>
<a href="#l1.6472"></a><span id="l1.6472"> </span>
<a href="#l1.6473"></a><span id="l1.6473"> NS_IMETHODIMP</span>
<a href="#l1.6474"></a><span id="l1.6474" class="difflineminus">-nsMsgDBView::GetFlagsAt(nsMsgViewIndex aIndex,</span>
<a href="#l1.6475"></a><span id="l1.6475" class="difflineminus">-                        uint32_t *aResult)</span>
<a href="#l1.6476"></a><span id="l1.6476" class="difflineminus">-{</span>
<a href="#l1.6477"></a><span id="l1.6477" class="difflineplus">+nsMsgDBView::GetFlagsAt(nsMsgViewIndex aIndex, uint32_t *aResult) {</span>
<a href="#l1.6478"></a><span id="l1.6478">   NS_ENSURE_ARG(aResult);</span>
<a href="#l1.6479"></a><span id="l1.6479" class="difflineminus">-  if (!IsValidIndex(aIndex))</span>
<a href="#l1.6480"></a><span id="l1.6480" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6481"></a><span id="l1.6481" class="difflineplus">+  if (!IsValidIndex(aIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6482"></a><span id="l1.6482"> </span>
<a href="#l1.6483"></a><span id="l1.6483">   *aResult = m_flags[aIndex];</span>
<a href="#l1.6484"></a><span id="l1.6484">   return NS_OK;</span>
<a href="#l1.6485"></a><span id="l1.6485"> }</span>
<a href="#l1.6486"></a><span id="l1.6486"> </span>
<a href="#l1.6487"></a><span id="l1.6487"> NS_IMETHODIMP</span>
<a href="#l1.6488"></a><span id="l1.6488" class="difflineminus">-nsMsgDBView::GetMsgHdrAt(nsMsgViewIndex aIndex,</span>
<a href="#l1.6489"></a><span id="l1.6489" class="difflineminus">-                         nsIMsgDBHdr **aResult)</span>
<a href="#l1.6490"></a><span id="l1.6490" class="difflineminus">-{</span>
<a href="#l1.6491"></a><span id="l1.6491" class="difflineplus">+nsMsgDBView::GetMsgHdrAt(nsMsgViewIndex aIndex, nsIMsgDBHdr **aResult) {</span>
<a href="#l1.6492"></a><span id="l1.6492">   NS_ENSURE_ARG(aResult);</span>
<a href="#l1.6493"></a><span id="l1.6493" class="difflineminus">-  if (!IsValidIndex(aIndex))</span>
<a href="#l1.6494"></a><span id="l1.6494" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6495"></a><span id="l1.6495" class="difflineplus">+  if (!IsValidIndex(aIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6496"></a><span id="l1.6496"> </span>
<a href="#l1.6497"></a><span id="l1.6497">   return GetMsgHdrForViewIndex(aIndex, aResult);</span>
<a href="#l1.6498"></a><span id="l1.6498"> }</span>
<a href="#l1.6499"></a><span id="l1.6499"> </span>
<a href="#l1.6500"></a><span id="l1.6500" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6501"></a><span id="l1.6501" class="difflineminus">-nsMsgDBView::FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6502"></a><span id="l1.6502" class="difflineminus">-                     nsMsgViewIndex startIndex,</span>
<a href="#l1.6503"></a><span id="l1.6503" class="difflineminus">-                     bool allowDummy)</span>
<a href="#l1.6504"></a><span id="l1.6504" class="difflineminus">-{</span>
<a href="#l1.6505"></a><span id="l1.6505" class="difflineplus">+nsMsgViewIndex nsMsgDBView::FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6506"></a><span id="l1.6506" class="difflineplus">+                                    nsMsgViewIndex startIndex,</span>
<a href="#l1.6507"></a><span id="l1.6507" class="difflineplus">+                                    bool allowDummy) {</span>
<a href="#l1.6508"></a><span id="l1.6508">   nsMsgKey msgKey;</span>
<a href="#l1.6509"></a><span id="l1.6509">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.6510"></a><span id="l1.6510">   nsMsgViewIndex viewIndex = m_keys.IndexOf(msgKey, startIndex);</span>
<a href="#l1.6511"></a><span id="l1.6511" class="difflineminus">-  if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6512"></a><span id="l1.6512" class="difflineminus">-    return viewIndex;</span>
<a href="#l1.6513"></a><span id="l1.6513" class="difflineplus">+  if (viewIndex == nsMsgViewIndex_None) return viewIndex;</span>
<a href="#l1.6514"></a><span id="l1.6514"> </span>
<a href="#l1.6515"></a><span id="l1.6515">   // If we're supposed to allow dummies, and the previous index is a dummy that</span>
<a href="#l1.6516"></a><span id="l1.6516">   // is not elided, then it must be the dummy corresponding to our node and</span>
<a href="#l1.6517"></a><span id="l1.6517">   // we should return that instead.</span>
<a href="#l1.6518"></a><span id="l1.6518">   if (allowDummy &amp;&amp; viewIndex &amp;&amp;</span>
<a href="#l1.6519"></a><span id="l1.6519" class="difflineminus">-      (m_flags[viewIndex-1] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6520"></a><span id="l1.6520" class="difflineminus">-      !(m_flags[viewIndex-1] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6521"></a><span id="l1.6521" class="difflineminus">-  {</span>
<a href="#l1.6522"></a><span id="l1.6522" class="difflineplus">+      (m_flags[viewIndex - 1] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6523"></a><span id="l1.6523" class="difflineplus">+      !(m_flags[viewIndex - 1] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l1.6524"></a><span id="l1.6524">     viewIndex--;</span>
<a href="#l1.6525"></a><span id="l1.6525" class="difflineminus">-  }</span>
<a href="#l1.6526"></a><span id="l1.6526" class="difflineminus">-  else if (!allowDummy &amp;&amp; m_flags[viewIndex] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6527"></a><span id="l1.6527" class="difflineminus">-  {</span>
<a href="#l1.6528"></a><span id="l1.6528" class="difflineplus">+  } else if (!allowDummy &amp;&amp; m_flags[viewIndex] &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l1.6529"></a><span id="l1.6529">     // We're not allowing dummies, and we found a dummy, look again</span>
<a href="#l1.6530"></a><span id="l1.6530">     // one past the dummy.</span>
<a href="#l1.6531"></a><span id="l1.6531">     return m_keys.IndexOf(msgKey, viewIndex + 1);</span>
<a href="#l1.6532"></a><span id="l1.6532">   }</span>
<a href="#l1.6533"></a><span id="l1.6533"> </span>
<a href="#l1.6534"></a><span id="l1.6534">   return viewIndex;</span>
<a href="#l1.6535"></a><span id="l1.6535"> }</span>
<a href="#l1.6536"></a><span id="l1.6536"> </span>
<a href="#l1.6537"></a><span id="l1.6537" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.6538"></a><span id="l1.6538" class="difflineminus">-nsMsgDBView::FindKey(nsMsgKey key,</span>
<a href="#l1.6539"></a><span id="l1.6539" class="difflineminus">-                     bool expand)</span>
<a href="#l1.6540"></a><span id="l1.6540" class="difflineminus">-{</span>
<a href="#l1.6541"></a><span id="l1.6541" class="difflineplus">+nsMsgViewIndex nsMsgDBView::FindKey(nsMsgKey key, bool expand) {</span>
<a href="#l1.6542"></a><span id="l1.6542">   nsMsgViewIndex retIndex = nsMsgViewIndex_None;</span>
<a href="#l1.6543"></a><span id="l1.6543" class="difflineminus">-  retIndex = (nsMsgViewIndex) (m_keys.IndexOf(key));</span>
<a href="#l1.6544"></a><span id="l1.6544" class="difflineplus">+  retIndex = (nsMsgViewIndex)(m_keys.IndexOf(key));</span>
<a href="#l1.6545"></a><span id="l1.6545">   // For dummy headers, try to expand if the caller says so. And if the thread</span>
<a href="#l1.6546"></a><span id="l1.6546">   // is expanded, ignore the dummy header and return the real header index.</span>
<a href="#l1.6547"></a><span id="l1.6547">   if (retIndex != nsMsgViewIndex_None &amp;&amp;</span>
<a href="#l1.6548"></a><span id="l1.6548">       m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY &amp;&amp;</span>
<a href="#l1.6549"></a><span id="l1.6549" class="difflineminus">-      !(m_flags[retIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.6550"></a><span id="l1.6550" class="difflineminus">-  {</span>
<a href="#l1.6551"></a><span id="l1.6551" class="difflineminus">-    return (nsMsgViewIndex) m_keys.IndexOf(key, retIndex + 1);</span>
<a href="#l1.6552"></a><span id="l1.6552" class="difflineplus">+      !(m_flags[retIndex] &amp; nsMsgMessageFlags::Elided)) {</span>
<a href="#l1.6553"></a><span id="l1.6553" class="difflineplus">+    return (nsMsgViewIndex)m_keys.IndexOf(key, retIndex + 1);</span>
<a href="#l1.6554"></a><span id="l1.6554">   }</span>
<a href="#l1.6555"></a><span id="l1.6555"> </span>
<a href="#l1.6556"></a><span id="l1.6556">   if (key != nsMsgKey_None &amp;&amp;</span>
<a href="#l1.6557"></a><span id="l1.6557" class="difflineminus">-      (retIndex == nsMsgViewIndex_None || m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6558"></a><span id="l1.6558" class="difflineminus">-      expand &amp;&amp; m_db)</span>
<a href="#l1.6559"></a><span id="l1.6559" class="difflineminus">-  {</span>
<a href="#l1.6560"></a><span id="l1.6560" class="difflineplus">+      (retIndex == nsMsgViewIndex_None ||</span>
<a href="#l1.6561"></a><span id="l1.6561" class="difflineplus">+       m_flags[retIndex] &amp; MSG_VIEW_FLAG_DUMMY) &amp;&amp;</span>
<a href="#l1.6562"></a><span id="l1.6562" class="difflineplus">+      expand &amp;&amp; m_db) {</span>
<a href="#l1.6563"></a><span id="l1.6563">     nsMsgKey threadKey = GetKeyOfFirstMsgInThread(key);</span>
<a href="#l1.6564"></a><span id="l1.6564" class="difflineminus">-    if (threadKey != nsMsgKey_None)</span>
<a href="#l1.6565"></a><span id="l1.6565" class="difflineminus">-    {</span>
<a href="#l1.6566"></a><span id="l1.6566" class="difflineplus">+    if (threadKey != nsMsgKey_None) {</span>
<a href="#l1.6567"></a><span id="l1.6567">       nsMsgViewIndex threadIndex = FindKey(threadKey, false);</span>
<a href="#l1.6568"></a><span id="l1.6568" class="difflineminus">-      if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l1.6569"></a><span id="l1.6569" class="difflineminus">-      {</span>
<a href="#l1.6570"></a><span id="l1.6570" class="difflineplus">+      if (threadIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.6571"></a><span id="l1.6571">         uint32_t flags = m_flags[threadIndex];</span>
<a href="#l1.6572"></a><span id="l1.6572">         if ((flags &amp; nsMsgMessageFlags::Elided &amp;&amp;</span>
<a href="#l1.6573"></a><span id="l1.6573">              NS_SUCCEEDED(ExpandByIndex(threadIndex, nullptr))) ||</span>
<a href="#l1.6574"></a><span id="l1.6574" class="difflineminus">-            flags &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.6575"></a><span id="l1.6575" class="difflineminus">-        {</span>
<a href="#l1.6576"></a><span id="l1.6576" class="difflineminus">-          retIndex = (nsMsgViewIndex) m_keys.IndexOf(key, threadIndex + 1);</span>
<a href="#l1.6577"></a><span id="l1.6577" class="difflineplus">+            flags &amp; MSG_VIEW_FLAG_DUMMY) {</span>
<a href="#l1.6578"></a><span id="l1.6578" class="difflineplus">+          retIndex = (nsMsgViewIndex)m_keys.IndexOf(key, threadIndex + 1);</span>
<a href="#l1.6579"></a><span id="l1.6579">         }</span>
<a href="#l1.6580"></a><span id="l1.6580">       }</span>
<a href="#l1.6581"></a><span id="l1.6581">     }</span>
<a href="#l1.6582"></a><span id="l1.6582">   }</span>
<a href="#l1.6583"></a><span id="l1.6583"> </span>
<a href="#l1.6584"></a><span id="l1.6584">   return retIndex;</span>
<a href="#l1.6585"></a><span id="l1.6585"> }</span>
<a href="#l1.6586"></a><span id="l1.6586"> </span>
<a href="#l1.6587"></a><span id="l1.6587" class="difflineminus">-nsresult</span>
<a href="#l1.6588"></a><span id="l1.6588" class="difflineminus">-nsMsgDBView::GetThreadCount(nsMsgViewIndex index,</span>
<a href="#l1.6589"></a><span id="l1.6589" class="difflineminus">-                            uint32_t *pThreadCount)</span>
<a href="#l1.6590"></a><span id="l1.6590" class="difflineminus">-{</span>
<a href="#l1.6591"></a><span id="l1.6591" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6592"></a><span id="l1.6592" class="difflineplus">+nsresult nsMsgDBView::GetThreadCount(nsMsgViewIndex index,</span>
<a href="#l1.6593"></a><span id="l1.6593" class="difflineplus">+                                     uint32_t *pThreadCount) {</span>
<a href="#l1.6594"></a><span id="l1.6594" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6595"></a><span id="l1.6595">   nsresult rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.6596"></a><span id="l1.6596">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6597"></a><span id="l1.6597" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6598"></a><span id="l1.6598" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6599"></a><span id="l1.6599">   rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(pThread));</span>
<a href="#l1.6600"></a><span id="l1.6600">   if (NS_SUCCEEDED(rv) &amp;&amp; pThread != nullptr)</span>
<a href="#l1.6601"></a><span id="l1.6601">     rv = pThread-&gt;GetNumChildren(pThreadCount);</span>
<a href="#l1.6602"></a><span id="l1.6602"> </span>
<a href="#l1.6603"></a><span id="l1.6603">   return rv;</span>
<a href="#l1.6604"></a><span id="l1.6604"> }</span>
<a href="#l1.6605"></a><span id="l1.6605"> </span>
<a href="#l1.6606"></a><span id="l1.6606"> // This counts the number of messages in an expanded thread, given the</span>
<a href="#l1.6607"></a><span id="l1.6607"> // index of the first message in the thread.</span>
<a href="#l1.6608"></a><span id="l1.6608" class="difflineminus">-int32_t</span>
<a href="#l1.6609"></a><span id="l1.6609" class="difflineminus">-nsMsgDBView::CountExpandedThread(nsMsgViewIndex index)</span>
<a href="#l1.6610"></a><span id="l1.6610" class="difflineminus">-{</span>
<a href="#l1.6611"></a><span id="l1.6611" class="difflineplus">+int32_t nsMsgDBView::CountExpandedThread(nsMsgViewIndex index) {</span>
<a href="#l1.6612"></a><span id="l1.6612">   int32_t numInThread = 0;</span>
<a href="#l1.6613"></a><span id="l1.6613">   nsMsgViewIndex startOfThread = index;</span>
<a href="#l1.6614"></a><span id="l1.6614" class="difflineminus">-  while ((int32_t) startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6615"></a><span id="l1.6615" class="difflineplus">+  while ((int32_t)startOfThread &gt;= 0 &amp;&amp; m_levels[startOfThread] != 0)</span>
<a href="#l1.6616"></a><span id="l1.6616">     startOfThread--;</span>
<a href="#l1.6617"></a><span id="l1.6617"> </span>
<a href="#l1.6618"></a><span id="l1.6618">   nsMsgViewIndex threadIndex = startOfThread;</span>
<a href="#l1.6619"></a><span id="l1.6619" class="difflineminus">-  do</span>
<a href="#l1.6620"></a><span id="l1.6620" class="difflineminus">-  {</span>
<a href="#l1.6621"></a><span id="l1.6621" class="difflineplus">+  do {</span>
<a href="#l1.6622"></a><span id="l1.6622">     threadIndex++;</span>
<a href="#l1.6623"></a><span id="l1.6623">     numInThread++;</span>
<a href="#l1.6624"></a><span id="l1.6624" class="difflineminus">-  }</span>
<a href="#l1.6625"></a><span id="l1.6625" class="difflineminus">-  while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6626"></a><span id="l1.6626" class="difflineplus">+  } while (threadIndex &lt; m_levels.Length() &amp;&amp; m_levels[threadIndex] != 0);</span>
<a href="#l1.6627"></a><span id="l1.6627"> </span>
<a href="#l1.6628"></a><span id="l1.6628">   return numInThread;</span>
<a href="#l1.6629"></a><span id="l1.6629"> }</span>
<a href="#l1.6630"></a><span id="l1.6630"> </span>
<a href="#l1.6631"></a><span id="l1.6631"> // Returns the number of lines that would be added (&gt; 0) or removed (&lt; 0)</span>
<a href="#l1.6632"></a><span id="l1.6632"> // if we were to try to expand/collapse the passed index.</span>
<a href="#l1.6633"></a><span id="l1.6633" class="difflineminus">-nsresult</span>
<a href="#l1.6634"></a><span id="l1.6634" class="difflineminus">-nsMsgDBView::ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l1.6635"></a><span id="l1.6635" class="difflineminus">-                            int32_t *expansionDelta)</span>
<a href="#l1.6636"></a><span id="l1.6636" class="difflineminus">-{</span>
<a href="#l1.6637"></a><span id="l1.6637" class="difflineplus">+nsresult nsMsgDBView::ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l1.6638"></a><span id="l1.6638" class="difflineplus">+                                     int32_t *expansionDelta) {</span>
<a href="#l1.6639"></a><span id="l1.6639">   uint32_t numChildren;</span>
<a href="#l1.6640"></a><span id="l1.6640" class="difflineminus">-  nsresult  rv;</span>
<a href="#l1.6641"></a><span id="l1.6641" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.6642"></a><span id="l1.6642"> </span>
<a href="#l1.6643"></a><span id="l1.6643">   *expansionDelta = 0;</span>
<a href="#l1.6644"></a><span id="l1.6644" class="difflineminus">-  if (index &gt;= ((nsMsgViewIndex) m_keys.Length()))</span>
<a href="#l1.6645"></a><span id="l1.6645" class="difflineplus">+  if (index &gt;= ((nsMsgViewIndex)m_keys.Length()))</span>
<a href="#l1.6646"></a><span id="l1.6646">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6647"></a><span id="l1.6647"> </span>
<a href="#l1.6648"></a><span id="l1.6648" class="difflineminus">-  char  flags = m_flags[index];</span>
<a href="#l1.6649"></a><span id="l1.6649" class="difflineminus">-</span>
<a href="#l1.6650"></a><span id="l1.6650" class="difflineminus">-  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.6651"></a><span id="l1.6651" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.6652"></a><span id="l1.6652" class="difflineplus">+  char flags = m_flags[index];</span>
<a href="#l1.6653"></a><span id="l1.6653" class="difflineplus">+</span>
<a href="#l1.6654"></a><span id="l1.6654" class="difflineplus">+  if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) return NS_OK;</span>
<a href="#l1.6655"></a><span id="l1.6655"> </span>
<a href="#l1.6656"></a><span id="l1.6656">   // The client can pass in the key of any message</span>
<a href="#l1.6657"></a><span id="l1.6657">   // in a thread and get the expansion delta for the thread.</span>
<a href="#l1.6658"></a><span id="l1.6658"> </span>
<a href="#l1.6659"></a><span id="l1.6659" class="difflineminus">-  if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6660"></a><span id="l1.6660" class="difflineminus">-  {</span>
<a href="#l1.6661"></a><span id="l1.6661" class="difflineplus">+  if (flags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.6662"></a><span id="l1.6662">     rv = GetThreadCount(index, &amp;numChildren);</span>
<a href="#l1.6663"></a><span id="l1.6663">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6664"></a><span id="l1.6664">     *expansionDelta = numChildren - 1;</span>
<a href="#l1.6665"></a><span id="l1.6665" class="difflineminus">-  }</span>
<a href="#l1.6666"></a><span id="l1.6666" class="difflineminus">-  else</span>
<a href="#l1.6667"></a><span id="l1.6667" class="difflineminus">-  {</span>
<a href="#l1.6668"></a><span id="l1.6668" class="difflineplus">+  } else {</span>
<a href="#l1.6669"></a><span id="l1.6669">     numChildren = CountExpandedThread(index);</span>
<a href="#l1.6670"></a><span id="l1.6670" class="difflineminus">-    *expansionDelta = - (int32_t) (numChildren - 1);</span>
<a href="#l1.6671"></a><span id="l1.6671" class="difflineminus">-  }</span>
<a href="#l1.6672"></a><span id="l1.6672" class="difflineminus">-</span>
<a href="#l1.6673"></a><span id="l1.6673" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.6674"></a><span id="l1.6674" class="difflineminus">-}</span>
<a href="#l1.6675"></a><span id="l1.6675" class="difflineminus">-</span>
<a href="#l1.6676"></a><span id="l1.6676" class="difflineminus">-nsresult</span>
<a href="#l1.6677"></a><span id="l1.6677" class="difflineminus">-nsMsgDBView::ToggleExpansion(nsMsgViewIndex index,</span>
<a href="#l1.6678"></a><span id="l1.6678" class="difflineminus">-                             uint32_t *numChanged)</span>
<a href="#l1.6679"></a><span id="l1.6679" class="difflineminus">-{</span>
<a href="#l1.6680"></a><span id="l1.6680" class="difflineplus">+    *expansionDelta = -(int32_t)(numChildren - 1);</span>
<a href="#l1.6681"></a><span id="l1.6681" class="difflineplus">+  }</span>
<a href="#l1.6682"></a><span id="l1.6682" class="difflineplus">+</span>
<a href="#l1.6683"></a><span id="l1.6683" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.6684"></a><span id="l1.6684" class="difflineplus">+}</span>
<a href="#l1.6685"></a><span id="l1.6685" class="difflineplus">+</span>
<a href="#l1.6686"></a><span id="l1.6686" class="difflineplus">+nsresult nsMsgDBView::ToggleExpansion(nsMsgViewIndex index,</span>
<a href="#l1.6687"></a><span id="l1.6687" class="difflineplus">+                                      uint32_t *numChanged) {</span>
<a href="#l1.6688"></a><span id="l1.6688">   nsresult rv;</span>
<a href="#l1.6689"></a><span id="l1.6689">   NS_ENSURE_ARG(numChanged);</span>
<a href="#l1.6690"></a><span id="l1.6690">   *numChanged = 0;</span>
<a href="#l1.6691"></a><span id="l1.6691">   nsMsgViewIndex threadIndex = GetThreadIndex(index);</span>
<a href="#l1.6692"></a><span id="l1.6692" class="difflineminus">-  if (threadIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6693"></a><span id="l1.6693" class="difflineminus">-  {</span>
<a href="#l1.6694"></a><span id="l1.6694" class="difflineplus">+  if (threadIndex == nsMsgViewIndex_None) {</span>
<a href="#l1.6695"></a><span id="l1.6695">     NS_ASSERTION(false, &quot;couldn't find thread&quot;);</span>
<a href="#l1.6696"></a><span id="l1.6696">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6697"></a><span id="l1.6697">   }</span>
<a href="#l1.6698"></a><span id="l1.6698"> </span>
<a href="#l1.6699"></a><span id="l1.6699" class="difflineminus">-  int32_t  flags = m_flags[threadIndex];</span>
<a href="#l1.6700"></a><span id="l1.6700" class="difflineplus">+  int32_t flags = m_flags[threadIndex];</span>
<a href="#l1.6701"></a><span id="l1.6701"> </span>
<a href="#l1.6702"></a><span id="l1.6702">   // If not a thread, or doesn't have children, no expand/collapse.</span>
<a href="#l1.6703"></a><span id="l1.6703">   // If we add sub-thread expand collapse, this will need to be relaxed.</span>
<a href="#l1.6704"></a><span id="l1.6704">   if (!(flags &amp; MSG_VIEW_FLAG_ISTHREAD) || !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6705"></a><span id="l1.6705">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6706"></a><span id="l1.6706"> </span>
<a href="#l1.6707"></a><span id="l1.6707">   if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6708"></a><span id="l1.6708">     rv = ExpandByIndex(threadIndex, numChanged);</span>
<a href="#l1.6709"></a><span id="l1.6709">   else</span>
<a href="#l1.6710"></a><span id="l1.6710">     rv = CollapseByIndex(threadIndex, numChanged);</span>
<a href="#l1.6711"></a><span id="l1.6711"> </span>
<a href="#l1.6712"></a><span id="l1.6712">   // If we collaps/uncollapse a thread, this changes the selected URIs.</span>
<a href="#l1.6713"></a><span id="l1.6713">   SelectionChangedXPCOM();</span>
<a href="#l1.6714"></a><span id="l1.6714">   return rv;</span>
<a href="#l1.6715"></a><span id="l1.6715"> }</span>
<a href="#l1.6716"></a><span id="l1.6716"> </span>
<a href="#l1.6717"></a><span id="l1.6717" class="difflineminus">-nsresult</span>
<a href="#l1.6718"></a><span id="l1.6718" class="difflineminus">-nsMsgDBView::ExpandAndSelectThread()</span>
<a href="#l1.6719"></a><span id="l1.6719" class="difflineminus">-{</span>
<a href="#l1.6720"></a><span id="l1.6720" class="difflineplus">+nsresult nsMsgDBView::ExpandAndSelectThread() {</span>
<a href="#l1.6721"></a><span id="l1.6721">   nsresult rv;</span>
<a href="#l1.6722"></a><span id="l1.6722"> </span>
<a href="#l1.6723"></a><span id="l1.6723">   NS_ASSERTION(mTreeSelection, &quot;no tree selection&quot;);</span>
<a href="#l1.6724"></a><span id="l1.6724">   if (!mTreeSelection) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6725"></a><span id="l1.6725"> </span>
<a href="#l1.6726"></a><span id="l1.6726">   int32_t index;</span>
<a href="#l1.6727"></a><span id="l1.6727">   rv = mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.6728"></a><span id="l1.6728" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6729"></a><span id="l1.6729" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6730"></a><span id="l1.6730"> </span>
<a href="#l1.6731"></a><span id="l1.6731">   rv = ExpandAndSelectThreadByIndex(index, false);</span>
<a href="#l1.6732"></a><span id="l1.6732" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6733"></a><span id="l1.6733" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.6734"></a><span id="l1.6734" class="difflineminus">-}</span>
<a href="#l1.6735"></a><span id="l1.6735" class="difflineminus">-</span>
<a href="#l1.6736"></a><span id="l1.6736" class="difflineminus">-nsresult</span>
<a href="#l1.6737"></a><span id="l1.6737" class="difflineminus">-nsMsgDBView::ExpandAndSelectThreadByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6738"></a><span id="l1.6738" class="difflineminus">-                                          bool augment)</span>
<a href="#l1.6739"></a><span id="l1.6739" class="difflineminus">-{</span>
<a href="#l1.6740"></a><span id="l1.6740" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.6741"></a><span id="l1.6741" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6742"></a><span id="l1.6742" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6743"></a><span id="l1.6743" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.6744"></a><span id="l1.6744" class="difflineplus">+}</span>
<a href="#l1.6745"></a><span id="l1.6745" class="difflineplus">+</span>
<a href="#l1.6746"></a><span id="l1.6746" class="difflineplus">+nsresult nsMsgDBView::ExpandAndSelectThreadByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6747"></a><span id="l1.6747" class="difflineplus">+                                                   bool augment) {</span>
<a href="#l1.6748"></a><span id="l1.6748" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.6749"></a><span id="l1.6749"> </span>
<a href="#l1.6750"></a><span id="l1.6750">   nsresult rv;</span>
<a href="#l1.6751"></a><span id="l1.6751"> </span>
<a href="#l1.6752"></a><span id="l1.6752">   nsMsgViewIndex threadIndex;</span>
<a href="#l1.6753"></a><span id="l1.6753">   bool inThreadedMode = (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay);</span>
<a href="#l1.6754"></a><span id="l1.6754"> </span>
<a href="#l1.6755"></a><span id="l1.6755" class="difflineminus">-  if (inThreadedMode)</span>
<a href="#l1.6756"></a><span id="l1.6756" class="difflineminus">-  {</span>
<a href="#l1.6757"></a><span id="l1.6757" class="difflineplus">+  if (inThreadedMode) {</span>
<a href="#l1.6758"></a><span id="l1.6758">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6759"></a><span id="l1.6759">     GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.6760"></a><span id="l1.6760">     threadIndex = ThreadIndexOfMsgHdr(msgHdr, index);</span>
<a href="#l1.6761"></a><span id="l1.6761" class="difflineminus">-    if (threadIndex == nsMsgViewIndex_None)</span>
<a href="#l1.6762"></a><span id="l1.6762" class="difflineminus">-    {</span>
<a href="#l1.6763"></a><span id="l1.6763" class="difflineplus">+    if (threadIndex == nsMsgViewIndex_None) {</span>
<a href="#l1.6764"></a><span id="l1.6764">       NS_ASSERTION(false, &quot;couldn't find thread&quot;);</span>
<a href="#l1.6765"></a><span id="l1.6765">       return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6766"></a><span id="l1.6766">     }</span>
<a href="#l1.6767"></a><span id="l1.6767" class="difflineminus">-  }</span>
<a href="#l1.6768"></a><span id="l1.6768" class="difflineminus">-  else</span>
<a href="#l1.6769"></a><span id="l1.6769" class="difflineminus">-  {</span>
<a href="#l1.6770"></a><span id="l1.6770" class="difflineplus">+  } else {</span>
<a href="#l1.6771"></a><span id="l1.6771">     threadIndex = index;</span>
<a href="#l1.6772"></a><span id="l1.6772">   }</span>
<a href="#l1.6773"></a><span id="l1.6773"> </span>
<a href="#l1.6774"></a><span id="l1.6774">   int32_t flags = m_flags[threadIndex];</span>
<a href="#l1.6775"></a><span id="l1.6775">   int32_t count = 0;</span>
<a href="#l1.6776"></a><span id="l1.6776"> </span>
<a href="#l1.6777"></a><span id="l1.6777" class="difflineminus">-  if (inThreadedMode &amp;&amp;</span>
<a href="#l1.6778"></a><span id="l1.6778" class="difflineminus">-      flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.6779"></a><span id="l1.6779" class="difflineminus">-      flags &amp; MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l1.6780"></a><span id="l1.6780" class="difflineminus">-  {</span>
<a href="#l1.6781"></a><span id="l1.6781" class="difflineplus">+  if (inThreadedMode &amp;&amp; flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.6782"></a><span id="l1.6782" class="difflineplus">+      flags &amp; MSG_VIEW_FLAG_HASCHILDREN) {</span>
<a href="#l1.6783"></a><span id="l1.6783">     // If closed, expand this thread.</span>
<a href="#l1.6784"></a><span id="l1.6784" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6785"></a><span id="l1.6785" class="difflineminus">-    {</span>
<a href="#l1.6786"></a><span id="l1.6786" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.6787"></a><span id="l1.6787">       uint32_t numExpanded;</span>
<a href="#l1.6788"></a><span id="l1.6788">       rv = ExpandByIndex(threadIndex, &amp;numExpanded);</span>
<a href="#l1.6789"></a><span id="l1.6789" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.6790"></a><span id="l1.6790" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6791"></a><span id="l1.6791">     }</span>
<a href="#l1.6792"></a><span id="l1.6792"> </span>
<a href="#l1.6793"></a><span id="l1.6793">     // Get the number of messages in the expanded thread so we know how many</span>
<a href="#l1.6794"></a><span id="l1.6794">     // to select.</span>
<a href="#l1.6795"></a><span id="l1.6795">     count = CountExpandedThread(threadIndex);</span>
<a href="#l1.6796"></a><span id="l1.6796" class="difflineminus">-  }</span>
<a href="#l1.6797"></a><span id="l1.6797" class="difflineminus">-  else</span>
<a href="#l1.6798"></a><span id="l1.6798" class="difflineminus">-  {</span>
<a href="#l1.6799"></a><span id="l1.6799" class="difflineplus">+  } else {</span>
<a href="#l1.6800"></a><span id="l1.6800">     count = 1;</span>
<a href="#l1.6801"></a><span id="l1.6801">   }</span>
<a href="#l1.6802"></a><span id="l1.6802"> </span>
<a href="#l1.6803"></a><span id="l1.6803">   NS_ASSERTION(count &gt; 0, &quot;bad count&quot;);</span>
<a href="#l1.6804"></a><span id="l1.6804"> </span>
<a href="#l1.6805"></a><span id="l1.6805">   // Update the selection.</span>
<a href="#l1.6806"></a><span id="l1.6806"> </span>
<a href="#l1.6807"></a><span id="l1.6807">   NS_ASSERTION(mTreeSelection, &quot;no tree selection&quot;);</span>
<a href="#l1.6808"></a><span id="l1.6808" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.6809"></a><span id="l1.6809" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6810"></a><span id="l1.6810" class="difflineplus">+  if (!mTreeSelection) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.6811"></a><span id="l1.6811"> </span>
<a href="#l1.6812"></a><span id="l1.6812">   // The count should be 1 or greater. If there was only one message in the</span>
<a href="#l1.6813"></a><span id="l1.6813">   // thread, we just select it. If more, we select all of them.</span>
<a href="#l1.6814"></a><span id="l1.6814">   mTreeSelection-&gt;RangedSelect(threadIndex + count - 1, threadIndex, augment);</span>
<a href="#l1.6815"></a><span id="l1.6815">   return NS_OK;</span>
<a href="#l1.6816"></a><span id="l1.6816"> }</span>
<a href="#l1.6817"></a><span id="l1.6817"> </span>
<a href="#l1.6818"></a><span id="l1.6818" class="difflineminus">-nsresult</span>
<a href="#l1.6819"></a><span id="l1.6819" class="difflineminus">-nsMsgDBView::ExpandAll()</span>
<a href="#l1.6820"></a><span id="l1.6820" class="difflineminus">-{</span>
<a href="#l1.6821"></a><span id="l1.6821" class="difflineminus">-  if (mTree)</span>
<a href="#l1.6822"></a><span id="l1.6822" class="difflineminus">-    mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.6823"></a><span id="l1.6823" class="difflineminus">-</span>
<a href="#l1.6824"></a><span id="l1.6824" class="difflineminus">-  for (int32_t i = GetSize() - 1; i &gt;= 0; i--)</span>
<a href="#l1.6825"></a><span id="l1.6825" class="difflineminus">-  {</span>
<a href="#l1.6826"></a><span id="l1.6826" class="difflineplus">+nsresult nsMsgDBView::ExpandAll() {</span>
<a href="#l1.6827"></a><span id="l1.6827" class="difflineplus">+  if (mTree) mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.6828"></a><span id="l1.6828" class="difflineplus">+</span>
<a href="#l1.6829"></a><span id="l1.6829" class="difflineplus">+  for (int32_t i = GetSize() - 1; i &gt;= 0; i--) {</span>
<a href="#l1.6830"></a><span id="l1.6830">     uint32_t numExpanded;</span>
<a href="#l1.6831"></a><span id="l1.6831">     uint32_t flags = m_flags[i];</span>
<a href="#l1.6832"></a><span id="l1.6832" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.6833"></a><span id="l1.6833" class="difflineminus">-      ExpandByIndex(i, &amp;numExpanded);</span>
<a href="#l1.6834"></a><span id="l1.6834" class="difflineminus">-  }</span>
<a href="#l1.6835"></a><span id="l1.6835" class="difflineminus">-</span>
<a href="#l1.6836"></a><span id="l1.6836" class="difflineminus">-  if (mTree)</span>
<a href="#l1.6837"></a><span id="l1.6837" class="difflineminus">-    mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.6838"></a><span id="l1.6838" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Elided) ExpandByIndex(i, &amp;numExpanded);</span>
<a href="#l1.6839"></a><span id="l1.6839" class="difflineplus">+  }</span>
<a href="#l1.6840"></a><span id="l1.6840" class="difflineplus">+</span>
<a href="#l1.6841"></a><span id="l1.6841" class="difflineplus">+  if (mTree) mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.6842"></a><span id="l1.6842"> </span>
<a href="#l1.6843"></a><span id="l1.6843">   SelectionChangedXPCOM();</span>
<a href="#l1.6844"></a><span id="l1.6844">   return NS_OK;</span>
<a href="#l1.6845"></a><span id="l1.6845"> }</span>
<a href="#l1.6846"></a><span id="l1.6846"> </span>
<a href="#l1.6847"></a><span id="l1.6847"> NS_IMETHODIMP</span>
<a href="#l1.6848"></a><span id="l1.6848"> nsMsgDBView::GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.6849"></a><span id="l1.6849" class="difflineminus">-                                       nsIMsgThread **pThread)</span>
<a href="#l1.6850"></a><span id="l1.6850" class="difflineminus">-{</span>
<a href="#l1.6851"></a><span id="l1.6851" class="difflineplus">+                                       nsIMsgThread **pThread) {</span>
<a href="#l1.6852"></a><span id="l1.6852">   return m_db-&gt;GetThreadContainingMsgHdr(msgHdr, pThread);</span>
<a href="#l1.6853"></a><span id="l1.6853"> }</span>
<a href="#l1.6854"></a><span id="l1.6854"> </span>
<a href="#l1.6855"></a><span id="l1.6855" class="difflineminus">-nsresult</span>
<a href="#l1.6856"></a><span id="l1.6856" class="difflineminus">-nsMsgDBView::ExpandByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6857"></a><span id="l1.6857" class="difflineminus">-                           uint32_t *pNumExpanded)</span>
<a href="#l1.6858"></a><span id="l1.6858" class="difflineminus">-{</span>
<a href="#l1.6859"></a><span id="l1.6859" class="difflineminus">-  if ((uint32_t) index &gt;= m_keys.Length())</span>
<a href="#l1.6860"></a><span id="l1.6860" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6861"></a><span id="l1.6861" class="difflineplus">+nsresult nsMsgDBView::ExpandByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6862"></a><span id="l1.6862" class="difflineplus">+                                    uint32_t *pNumExpanded) {</span>
<a href="#l1.6863"></a><span id="l1.6863" class="difflineplus">+  if ((uint32_t)index &gt;= m_keys.Length()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6864"></a><span id="l1.6864"> </span>
<a href="#l1.6865"></a><span id="l1.6865">   uint32_t flags = m_flags[index];</span>
<a href="#l1.6866"></a><span id="l1.6866">   uint32_t numExpanded = 0;</span>
<a href="#l1.6867"></a><span id="l1.6867"> </span>
<a href="#l1.6868"></a><span id="l1.6868">   NS_ASSERTION(flags &amp; nsMsgMessageFlags::Elided,</span>
<a href="#l1.6869"></a><span id="l1.6869">                &quot;can't expand an already expanded thread&quot;);</span>
<a href="#l1.6870"></a><span id="l1.6870">   flags &amp;= ~nsMsgMessageFlags::Elided;</span>
<a href="#l1.6871"></a><span id="l1.6871"> </span>
<a href="#l1.6872"></a><span id="l1.6872" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6873"></a><span id="l1.6873" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6874"></a><span id="l1.6874" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.6875"></a><span id="l1.6875" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; pThread;</span>
<a href="#l1.6876"></a><span id="l1.6876">   nsresult rv = GetThreadContainingIndex(index, getter_AddRefs(pThread));</span>
<a href="#l1.6877"></a><span id="l1.6877">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6878"></a><span id="l1.6878" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l1.6879"></a><span id="l1.6879" class="difflineminus">-  {</span>
<a href="#l1.6880"></a><span id="l1.6880" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) {</span>
<a href="#l1.6881"></a><span id="l1.6881">     // Keep top level hdr in thread, even though read.</span>
<a href="#l1.6882"></a><span id="l1.6882" class="difflineminus">-    if (flags &amp; nsMsgMessageFlags::Read)</span>
<a href="#l1.6883"></a><span id="l1.6883" class="difflineminus">-      m_levels.AppendElement(0);</span>
<a href="#l1.6884"></a><span id="l1.6884" class="difflineminus">-</span>
<a href="#l1.6885"></a><span id="l1.6885" class="difflineminus">-    rv = ListUnreadIdsInThread(pThread,  index, &amp;numExpanded);</span>
<a href="#l1.6886"></a><span id="l1.6886" class="difflineminus">-  }</span>
<a href="#l1.6887"></a><span id="l1.6887" class="difflineminus">-  else</span>
<a href="#l1.6888"></a><span id="l1.6888" class="difflineminus">-  {</span>
<a href="#l1.6889"></a><span id="l1.6889" class="difflineminus">-    rv = ListIdsInThread(pThread,  index, &amp;numExpanded);</span>
<a href="#l1.6890"></a><span id="l1.6890" class="difflineminus">-  }</span>
<a href="#l1.6891"></a><span id="l1.6891" class="difflineminus">-</span>
<a href="#l1.6892"></a><span id="l1.6892" class="difflineminus">-  if (numExpanded &gt; 0)</span>
<a href="#l1.6893"></a><span id="l1.6893" class="difflineminus">-  {</span>
<a href="#l1.6894"></a><span id="l1.6894" class="difflineplus">+    if (flags &amp; nsMsgMessageFlags::Read) m_levels.AppendElement(0);</span>
<a href="#l1.6895"></a><span id="l1.6895" class="difflineplus">+</span>
<a href="#l1.6896"></a><span id="l1.6896" class="difflineplus">+    rv = ListUnreadIdsInThread(pThread, index, &amp;numExpanded);</span>
<a href="#l1.6897"></a><span id="l1.6897" class="difflineplus">+  } else {</span>
<a href="#l1.6898"></a><span id="l1.6898" class="difflineplus">+    rv = ListIdsInThread(pThread, index, &amp;numExpanded);</span>
<a href="#l1.6899"></a><span id="l1.6899" class="difflineplus">+  }</span>
<a href="#l1.6900"></a><span id="l1.6900" class="difflineplus">+</span>
<a href="#l1.6901"></a><span id="l1.6901" class="difflineplus">+  if (numExpanded &gt; 0) {</span>
<a href="#l1.6902"></a><span id="l1.6902">     m_flags[index] = flags;</span>
<a href="#l1.6903"></a><span id="l1.6903">     NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.6904"></a><span id="l1.6904">   }</span>
<a href="#l1.6905"></a><span id="l1.6905"> </span>
<a href="#l1.6906"></a><span id="l1.6906" class="difflineminus">-  NoteStartChange(index + 1, numExpanded, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6907"></a><span id="l1.6907" class="difflineminus">-  NoteEndChange(index + 1, numExpanded, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6908"></a><span id="l1.6908" class="difflineminus">-</span>
<a href="#l1.6909"></a><span id="l1.6909" class="difflineminus">-  if (pNumExpanded != nullptr)</span>
<a href="#l1.6910"></a><span id="l1.6910" class="difflineminus">-    *pNumExpanded = numExpanded;</span>
<a href="#l1.6911"></a><span id="l1.6911" class="difflineplus">+  NoteStartChange(index + 1, numExpanded,</span>
<a href="#l1.6912"></a><span id="l1.6912" class="difflineplus">+                  nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6913"></a><span id="l1.6913" class="difflineplus">+  NoteEndChange(index + 1, numExpanded,</span>
<a href="#l1.6914"></a><span id="l1.6914" class="difflineplus">+                nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6915"></a><span id="l1.6915" class="difflineplus">+</span>
<a href="#l1.6916"></a><span id="l1.6916" class="difflineplus">+  if (pNumExpanded != nullptr) *pNumExpanded = numExpanded;</span>
<a href="#l1.6917"></a><span id="l1.6917"> </span>
<a href="#l1.6918"></a><span id="l1.6918">   return rv;</span>
<a href="#l1.6919"></a><span id="l1.6919"> }</span>
<a href="#l1.6920"></a><span id="l1.6920"> </span>
<a href="#l1.6921"></a><span id="l1.6921" class="difflineminus">-nsresult</span>
<a href="#l1.6922"></a><span id="l1.6922" class="difflineminus">-nsMsgDBView::CollapseAll()</span>
<a href="#l1.6923"></a><span id="l1.6923" class="difflineminus">-{</span>
<a href="#l1.6924"></a><span id="l1.6924" class="difflineminus">-  for (uint32_t i = 0; i &lt; GetSize(); i++)</span>
<a href="#l1.6925"></a><span id="l1.6925" class="difflineminus">-  {</span>
<a href="#l1.6926"></a><span id="l1.6926" class="difflineplus">+nsresult nsMsgDBView::CollapseAll() {</span>
<a href="#l1.6927"></a><span id="l1.6927" class="difflineplus">+  for (uint32_t i = 0; i &lt; GetSize(); i++) {</span>
<a href="#l1.6928"></a><span id="l1.6928">     uint32_t numExpanded;</span>
<a href="#l1.6929"></a><span id="l1.6929">     uint32_t flags = m_flags[i];</span>
<a href="#l1.6930"></a><span id="l1.6930" class="difflineminus">-    if (!(flags &amp; nsMsgMessageFlags::Elided) &amp;&amp; (flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6931"></a><span id="l1.6931" class="difflineplus">+    if (!(flags &amp; nsMsgMessageFlags::Elided) &amp;&amp;</span>
<a href="#l1.6932"></a><span id="l1.6932" class="difflineplus">+        (flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6933"></a><span id="l1.6933">       CollapseByIndex(i, &amp;numExpanded);</span>
<a href="#l1.6934"></a><span id="l1.6934">   }</span>
<a href="#l1.6935"></a><span id="l1.6935"> </span>
<a href="#l1.6936"></a><span id="l1.6936">   SelectionChangedXPCOM();</span>
<a href="#l1.6937"></a><span id="l1.6937">   return NS_OK;</span>
<a href="#l1.6938"></a><span id="l1.6938"> }</span>
<a href="#l1.6939"></a><span id="l1.6939"> </span>
<a href="#l1.6940"></a><span id="l1.6940" class="difflineminus">-nsresult</span>
<a href="#l1.6941"></a><span id="l1.6941" class="difflineminus">-nsMsgDBView::CollapseByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6942"></a><span id="l1.6942" class="difflineminus">-                             uint32_t *pNumCollapsed)</span>
<a href="#l1.6943"></a><span id="l1.6943" class="difflineminus">-{</span>
<a href="#l1.6944"></a><span id="l1.6944" class="difflineminus">-  nsresult  rv;</span>
<a href="#l1.6945"></a><span id="l1.6945" class="difflineminus">-  int32_t  flags = m_flags[index];</span>
<a href="#l1.6946"></a><span id="l1.6946" class="difflineminus">-  int32_t  rowDelta = 0;</span>
<a href="#l1.6947"></a><span id="l1.6947" class="difflineplus">+nsresult nsMsgDBView::CollapseByIndex(nsMsgViewIndex index,</span>
<a href="#l1.6948"></a><span id="l1.6948" class="difflineplus">+                                      uint32_t *pNumCollapsed) {</span>
<a href="#l1.6949"></a><span id="l1.6949" class="difflineplus">+  nsresult rv;</span>
<a href="#l1.6950"></a><span id="l1.6950" class="difflineplus">+  int32_t flags = m_flags[index];</span>
<a href="#l1.6951"></a><span id="l1.6951" class="difflineplus">+  int32_t rowDelta = 0;</span>
<a href="#l1.6952"></a><span id="l1.6952"> </span>
<a href="#l1.6953"></a><span id="l1.6953">   if (flags &amp; nsMsgMessageFlags::Elided ||</span>
<a href="#l1.6954"></a><span id="l1.6954">       !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) ||</span>
<a href="#l1.6955"></a><span id="l1.6955" class="difflineminus">-      !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l1.6956"></a><span id="l1.6956" class="difflineminus">-  {</span>
<a href="#l1.6957"></a><span id="l1.6957" class="difflineplus">+      !(flags &amp; MSG_VIEW_FLAG_HASCHILDREN)) {</span>
<a href="#l1.6958"></a><span id="l1.6958">     return NS_OK;</span>
<a href="#l1.6959"></a><span id="l1.6959">   }</span>
<a href="#l1.6960"></a><span id="l1.6960"> </span>
<a href="#l1.6961"></a><span id="l1.6961" class="difflineminus">-  if (index &gt; m_keys.Length())</span>
<a href="#l1.6962"></a><span id="l1.6962" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6963"></a><span id="l1.6963" class="difflineplus">+  if (index &gt; m_keys.Length()) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6964"></a><span id="l1.6964"> </span>
<a href="#l1.6965"></a><span id="l1.6965">   rv = ExpansionDelta(index, &amp;rowDelta);</span>
<a href="#l1.6966"></a><span id="l1.6966">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.6967"></a><span id="l1.6967"> </span>
<a href="#l1.6968"></a><span id="l1.6968">   flags |= nsMsgMessageFlags::Elided;</span>
<a href="#l1.6969"></a><span id="l1.6969"> </span>
<a href="#l1.6970"></a><span id="l1.6970">   m_flags[index] = flags;</span>
<a href="#l1.6971"></a><span id="l1.6971">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.6972"></a><span id="l1.6972"> </span>
<a href="#l1.6973"></a><span id="l1.6973">   // Don't count first header in thread.</span>
<a href="#l1.6974"></a><span id="l1.6974">   int32_t numRemoved = -rowDelta;</span>
<a href="#l1.6975"></a><span id="l1.6975" class="difflineminus">-  if (index + 1 + numRemoved &gt; m_keys.Length())</span>
<a href="#l1.6976"></a><span id="l1.6976" class="difflineminus">-  {</span>
<a href="#l1.6977"></a><span id="l1.6977" class="difflineplus">+  if (index + 1 + numRemoved &gt; m_keys.Length()) {</span>
<a href="#l1.6978"></a><span id="l1.6978">     NS_ERROR(&quot;trying to remove too many rows&quot;);</span>
<a href="#l1.6979"></a><span id="l1.6979">     numRemoved -= (index + 1 + numRemoved) - m_keys.Length();</span>
<a href="#l1.6980"></a><span id="l1.6980" class="difflineminus">-    if (numRemoved &lt;= 0)</span>
<a href="#l1.6981"></a><span id="l1.6981" class="difflineminus">-      return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6982"></a><span id="l1.6982" class="difflineminus">-  }</span>
<a href="#l1.6983"></a><span id="l1.6983" class="difflineminus">-</span>
<a href="#l1.6984"></a><span id="l1.6984" class="difflineminus">-  NoteStartChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6985"></a><span id="l1.6985" class="difflineplus">+    if (numRemoved &lt;= 0) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.6986"></a><span id="l1.6986" class="difflineplus">+  }</span>
<a href="#l1.6987"></a><span id="l1.6987" class="difflineplus">+</span>
<a href="#l1.6988"></a><span id="l1.6988" class="difflineplus">+  NoteStartChange(index + 1, rowDelta,</span>
<a href="#l1.6989"></a><span id="l1.6989" class="difflineplus">+                  nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6990"></a><span id="l1.6990">   // Start at first id after thread.</span>
<a href="#l1.6991"></a><span id="l1.6991">   RemoveRows(index + 1, numRemoved);</span>
<a href="#l1.6992"></a><span id="l1.6992" class="difflineminus">-  if (pNumCollapsed != nullptr)</span>
<a href="#l1.6993"></a><span id="l1.6993" class="difflineminus">-    *pNumCollapsed = numRemoved;</span>
<a href="#l1.6994"></a><span id="l1.6994" class="difflineplus">+  if (pNumCollapsed != nullptr) *pNumCollapsed = numRemoved;</span>
<a href="#l1.6995"></a><span id="l1.6995"> </span>
<a href="#l1.6996"></a><span id="l1.6996">   NoteEndChange(index + 1, rowDelta, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.6997"></a><span id="l1.6997"> </span>
<a href="#l1.6998"></a><span id="l1.6998">   return rv;</span>
<a href="#l1.6999"></a><span id="l1.6999"> }</span>
<a href="#l1.7000"></a><span id="l1.7000"> </span>
<a href="#l1.7001"></a><span id="l1.7001" class="difflineminus">-nsresult</span>
<a href="#l1.7002"></a><span id="l1.7002" class="difflineminus">-nsMsgDBView::OnNewHeader(nsIMsgDBHdr *newHdr,</span>
<a href="#l1.7003"></a><span id="l1.7003" class="difflineminus">-                         nsMsgKey aParentKey,</span>
<a href="#l1.7004"></a><span id="l1.7004" class="difflineminus">-                         bool /*ensureListed*/)</span>
<a href="#l1.7005"></a><span id="l1.7005" class="difflineminus">-{</span>
<a href="#l1.7006"></a><span id="l1.7006" class="difflineplus">+nsresult nsMsgDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey,</span>
<a href="#l1.7007"></a><span id="l1.7007" class="difflineplus">+                                  bool /*ensureListed*/) {</span>
<a href="#l1.7008"></a><span id="l1.7008">   nsresult rv = NS_OK;</span>
<a href="#l1.7009"></a><span id="l1.7009">   // Views can override this behaviour, which is to append to view.</span>
<a href="#l1.7010"></a><span id="l1.7010">   // This is the mail behaviour, but threaded views will want</span>
<a href="#l1.7011"></a><span id="l1.7011">   // to insert in order...</span>
<a href="#l1.7012"></a><span id="l1.7012" class="difflineminus">-  if (newHdr)</span>
<a href="#l1.7013"></a><span id="l1.7013" class="difflineminus">-    rv = AddHdr(newHdr);</span>
<a href="#l1.7014"></a><span id="l1.7014" class="difflineplus">+  if (newHdr) rv = AddHdr(newHdr);</span>
<a href="#l1.7015"></a><span id="l1.7015"> </span>
<a href="#l1.7016"></a><span id="l1.7016">   return rv;</span>
<a href="#l1.7017"></a><span id="l1.7017"> }</span>
<a href="#l1.7018"></a><span id="l1.7018"> </span>
<a href="#l1.7019"></a><span id="l1.7019"> NS_IMETHODIMP</span>
<a href="#l1.7020"></a><span id="l1.7020"> nsMsgDBView::GetThreadContainingIndex(nsMsgViewIndex index,</span>
<a href="#l1.7021"></a><span id="l1.7021" class="difflineminus">-                                      nsIMsgThread **resultThread)</span>
<a href="#l1.7022"></a><span id="l1.7022" class="difflineminus">-{</span>
<a href="#l1.7023"></a><span id="l1.7023" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7024"></a><span id="l1.7024" class="difflineplus">+                                      nsIMsgThread **resultThread) {</span>
<a href="#l1.7025"></a><span id="l1.7025" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7026"></a><span id="l1.7026">   nsresult rv = GetMsgHdrForViewIndex(index, getter_AddRefs(msgHdr));</span>
<a href="#l1.7027"></a><span id="l1.7027">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.7028"></a><span id="l1.7028">   return GetThreadContainingMsgHdr(msgHdr, resultThread);</span>
<a href="#l1.7029"></a><span id="l1.7029"> }</span>
<a href="#l1.7030"></a><span id="l1.7030"> </span>
<a href="#l1.7031"></a><span id="l1.7031" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.7032"></a><span id="l1.7032" class="difflineminus">-nsMsgDBView::GetIndexForThread(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.7033"></a><span id="l1.7033" class="difflineminus">-{</span>
<a href="#l1.7034"></a><span id="l1.7034" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetIndexForThread(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.7035"></a><span id="l1.7035">   // Take advantage of the fact that we're already sorted</span>
<a href="#l1.7036"></a><span id="l1.7036">   // and find the insert index via a binary search, though expanded threads</span>
<a href="#l1.7037"></a><span id="l1.7037">   // make that tricky.</span>
<a href="#l1.7038"></a><span id="l1.7038"> </span>
<a href="#l1.7039"></a><span id="l1.7039">   nsMsgViewIndex highIndex = m_keys.Length();</span>
<a href="#l1.7040"></a><span id="l1.7040">   nsMsgViewIndex lowIndex = 0;</span>
<a href="#l1.7041"></a><span id="l1.7041">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.7042"></a><span id="l1.7042">   EntryInfo1.key = nullptr;</span>
<a href="#l1.7043"></a><span id="l1.7043">   EntryInfo2.key = nullptr;</span>
<a href="#l1.7044"></a><span id="l1.7044"> </span>
<a href="#l1.7045"></a><span id="l1.7045">   nsresult rv;</span>
<a href="#l1.7046"></a><span id="l1.7046" class="difflineminus">-  uint16_t  maxLen;</span>
<a href="#l1.7047"></a><span id="l1.7047" class="difflineplus">+  uint16_t maxLen;</span>
<a href="#l1.7048"></a><span id="l1.7048">   eFieldType fieldType;</span>
<a href="#l1.7049"></a><span id="l1.7049"> </span>
<a href="#l1.7050"></a><span id="l1.7050">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.7051"></a><span id="l1.7051">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.7052"></a><span id="l1.7052">   // GetCollationKey or GetLongField.</span>
<a href="#l1.7053"></a><span id="l1.7053" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.7054"></a><span id="l1.7054" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.7055"></a><span id="l1.7055"> </span>
<a href="#l1.7056"></a><span id="l1.7056">   // The following may leave fieldType undefined.</span>
<a href="#l1.7057"></a><span id="l1.7057">   // In this case, we can return highIndex right away since</span>
<a href="#l1.7058"></a><span id="l1.7058">   // it is the value returned in the default case of</span>
<a href="#l1.7059"></a><span id="l1.7059">   // switch (fieldType) statement below.</span>
<a href="#l1.7060"></a><span id="l1.7060">   rv = GetFieldTypeAndLenForSort(m_sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.7061"></a><span id="l1.7061">   NS_ENSURE_SUCCESS(rv, highIndex);</span>
<a href="#l1.7062"></a><span id="l1.7062"> </span>
<a href="#l1.7063"></a><span id="l1.7063" class="difflineat">@@ -5938,463 +5152,398 @@ nsMsgDBView::GetIndexForThread(nsIMsgDBH</span>
<a href="#l1.7064"></a><span id="l1.7064">   int retStatus = 0;</span>
<a href="#l1.7065"></a><span id="l1.7065">   msgHdr-&gt;GetMessageKey(&amp;EntryInfo1.id);</span>
<a href="#l1.7066"></a><span id="l1.7066">   msgHdr-&gt;GetFolder(&amp;EntryInfo1.folder);</span>
<a href="#l1.7067"></a><span id="l1.7067">   EntryInfo1.folder-&gt;Release();</span>
<a href="#l1.7068"></a><span id="l1.7068"> </span>
<a href="#l1.7069"></a><span id="l1.7069">   viewSortInfo comparisonContext;</span>
<a href="#l1.7070"></a><span id="l1.7070">   comparisonContext.view = this;</span>
<a href="#l1.7071"></a><span id="l1.7071">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.7072"></a><span id="l1.7072" class="difflineminus">-  comparisonContext.ascendingSort = (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7073"></a><span id="l1.7073" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; hdrDB;</span>
<a href="#l1.7074"></a><span id="l1.7074" class="difflineplus">+  comparisonContext.ascendingSort =</span>
<a href="#l1.7075"></a><span id="l1.7075" class="difflineplus">+      (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7076"></a><span id="l1.7076" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; hdrDB;</span>
<a href="#l1.7077"></a><span id="l1.7077">   EntryInfo1.folder-&gt;GetMsgDatabase(getter_AddRefs(hdrDB));</span>
<a href="#l1.7078"></a><span id="l1.7078">   comparisonContext.db = hdrDB.get();</span>
<a href="#l1.7079"></a><span id="l1.7079" class="difflineminus">-  switch (fieldType)</span>
<a href="#l1.7080"></a><span id="l1.7080" class="difflineminus">-  {</span>
<a href="#l1.7081"></a><span id="l1.7081" class="difflineplus">+  switch (fieldType) {</span>
<a href="#l1.7082"></a><span id="l1.7082">     case kCollationKey:</span>
<a href="#l1.7083"></a><span id="l1.7083" class="difflineminus">-      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7084"></a><span id="l1.7084" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7085"></a><span id="l1.7085" class="difflineplus">+      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key,</span>
<a href="#l1.7086"></a><span id="l1.7086" class="difflineplus">+                           &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7087"></a><span id="l1.7087" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7088"></a><span id="l1.7088">       break;</span>
<a href="#l1.7089"></a><span id="l1.7089">     case kU32:</span>
<a href="#l1.7090"></a><span id="l1.7090">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7091"></a><span id="l1.7091">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.7092"></a><span id="l1.7092">       else</span>
<a href="#l1.7093"></a><span id="l1.7093">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7094"></a><span id="l1.7094"> </span>
<a href="#l1.7095"></a><span id="l1.7095">       break;</span>
<a href="#l1.7096"></a><span id="l1.7096">     default:</span>
<a href="#l1.7097"></a><span id="l1.7097">       return highIndex;</span>
<a href="#l1.7098"></a><span id="l1.7098">   }</span>
<a href="#l1.7099"></a><span id="l1.7099"> </span>
<a href="#l1.7100"></a><span id="l1.7100" class="difflineminus">-  while (highIndex &gt; lowIndex)</span>
<a href="#l1.7101"></a><span id="l1.7101" class="difflineminus">-  {</span>
<a href="#l1.7102"></a><span id="l1.7102" class="difflineplus">+  while (highIndex &gt; lowIndex) {</span>
<a href="#l1.7103"></a><span id="l1.7103">     nsMsgViewIndex tryIndex = (lowIndex + highIndex) / 2;</span>
<a href="#l1.7104"></a><span id="l1.7104">     // Need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.7105"></a><span id="l1.7105" class="difflineminus">-    while (m_levels[tryIndex] &amp;&amp; tryIndex)</span>
<a href="#l1.7106"></a><span id="l1.7106" class="difflineminus">-      tryIndex--;</span>
<a href="#l1.7107"></a><span id="l1.7107" class="difflineminus">-</span>
<a href="#l1.7108"></a><span id="l1.7108" class="difflineminus">-    if (tryIndex &lt; lowIndex)</span>
<a href="#l1.7109"></a><span id="l1.7109" class="difflineminus">-    {</span>
<a href="#l1.7110"></a><span id="l1.7110" class="difflineplus">+    while (m_levels[tryIndex] &amp;&amp; tryIndex) tryIndex--;</span>
<a href="#l1.7111"></a><span id="l1.7111" class="difflineplus">+</span>
<a href="#l1.7112"></a><span id="l1.7112" class="difflineplus">+    if (tryIndex &lt; lowIndex) {</span>
<a href="#l1.7113"></a><span id="l1.7113">       NS_ERROR(&quot;try index shouldn't be less than low index&quot;);</span>
<a href="#l1.7114"></a><span id="l1.7114">       break;</span>
<a href="#l1.7115"></a><span id="l1.7115">     }</span>
<a href="#l1.7116"></a><span id="l1.7116"> </span>
<a href="#l1.7117"></a><span id="l1.7117">     EntryInfo2.id = m_keys[tryIndex];</span>
<a href="#l1.7118"></a><span id="l1.7118">     GetFolderForViewIndex(tryIndex, &amp;EntryInfo2.folder);</span>
<a href="#l1.7119"></a><span id="l1.7119">     EntryInfo2.folder-&gt;Release();</span>
<a href="#l1.7120"></a><span id="l1.7120"> </span>
<a href="#l1.7121"></a><span id="l1.7121" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7122"></a><span id="l1.7122" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.7123"></a><span id="l1.7123" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7124"></a><span id="l1.7124" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.7125"></a><span id="l1.7125">     // ### this should get the db from the folder...</span>
<a href="#l1.7126"></a><span id="l1.7126">     GetDBForViewIndex(tryIndex, getter_AddRefs(db));</span>
<a href="#l1.7127"></a><span id="l1.7127" class="difflineminus">-    if (db)</span>
<a href="#l1.7128"></a><span id="l1.7128" class="difflineminus">-      rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7129"></a><span id="l1.7129" class="difflineminus">-</span>
<a href="#l1.7130"></a><span id="l1.7130" class="difflineminus">-    if (!tryHdr)</span>
<a href="#l1.7131"></a><span id="l1.7131" class="difflineminus">-      break;</span>
<a href="#l1.7132"></a><span id="l1.7132" class="difflineminus">-</span>
<a href="#l1.7133"></a><span id="l1.7133" class="difflineminus">-    if (tryHdr == msgHdr)</span>
<a href="#l1.7134"></a><span id="l1.7134" class="difflineminus">-    {</span>
<a href="#l1.7135"></a><span id="l1.7135" class="difflineplus">+    if (db) rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7136"></a><span id="l1.7136" class="difflineplus">+</span>
<a href="#l1.7137"></a><span id="l1.7137" class="difflineplus">+    if (!tryHdr) break;</span>
<a href="#l1.7138"></a><span id="l1.7138" class="difflineplus">+</span>
<a href="#l1.7139"></a><span id="l1.7139" class="difflineplus">+    if (tryHdr == msgHdr) {</span>
<a href="#l1.7140"></a><span id="l1.7140">       NS_WARNING(&quot;didn't expect header to already be in view&quot;);</span>
<a href="#l1.7141"></a><span id="l1.7141">       highIndex = tryIndex;</span>
<a href="#l1.7142"></a><span id="l1.7142">       break;</span>
<a href="#l1.7143"></a><span id="l1.7143">     }</span>
<a href="#l1.7144"></a><span id="l1.7144"> </span>
<a href="#l1.7145"></a><span id="l1.7145" class="difflineminus">-    if (fieldType == kCollationKey)</span>
<a href="#l1.7146"></a><span id="l1.7146" class="difflineminus">-    {</span>
<a href="#l1.7147"></a><span id="l1.7147" class="difflineplus">+    if (fieldType == kCollationKey) {</span>
<a href="#l1.7148"></a><span id="l1.7148">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.7149"></a><span id="l1.7149" class="difflineminus">-      rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7150"></a><span id="l1.7150" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7151"></a><span id="l1.7151" class="difflineplus">+      rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key,</span>
<a href="#l1.7152"></a><span id="l1.7152" class="difflineplus">+                           &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7153"></a><span id="l1.7153" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7154"></a><span id="l1.7154">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7155"></a><span id="l1.7155" class="difflineminus">-    }</span>
<a href="#l1.7156"></a><span id="l1.7156" class="difflineminus">-    else if (fieldType == kU32)</span>
<a href="#l1.7157"></a><span id="l1.7157" class="difflineminus">-    {</span>
<a href="#l1.7158"></a><span id="l1.7158" class="difflineplus">+    } else if (fieldType == kU32) {</span>
<a href="#l1.7159"></a><span id="l1.7159">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7160"></a><span id="l1.7160">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.7161"></a><span id="l1.7161">       else</span>
<a href="#l1.7162"></a><span id="l1.7162">         GetLongField(tryHdr, m_sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7163"></a><span id="l1.7163"> </span>
<a href="#l1.7164"></a><span id="l1.7164">       retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7165"></a><span id="l1.7165">     }</span>
<a href="#l1.7166"></a><span id="l1.7166"> </span>
<a href="#l1.7167"></a><span id="l1.7167" class="difflineminus">-    if (retStatus == 0)</span>
<a href="#l1.7168"></a><span id="l1.7168" class="difflineminus">-    {</span>
<a href="#l1.7169"></a><span id="l1.7169" class="difflineplus">+    if (retStatus == 0) {</span>
<a href="#l1.7170"></a><span id="l1.7170">       highIndex = tryIndex;</span>
<a href="#l1.7171"></a><span id="l1.7171">       break;</span>
<a href="#l1.7172"></a><span id="l1.7172">     }</span>
<a href="#l1.7173"></a><span id="l1.7173"> </span>
<a href="#l1.7174"></a><span id="l1.7174" class="difflineminus">-    if (retStatus &lt; 0)</span>
<a href="#l1.7175"></a><span id="l1.7175" class="difflineminus">-    {</span>
<a href="#l1.7176"></a><span id="l1.7176" class="difflineplus">+    if (retStatus &lt; 0) {</span>
<a href="#l1.7177"></a><span id="l1.7177">       highIndex = tryIndex;</span>
<a href="#l1.7178"></a><span id="l1.7178">       // We already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.7179"></a><span id="l1.7179" class="difflineminus">-    }</span>
<a href="#l1.7180"></a><span id="l1.7180" class="difflineminus">-    else</span>
<a href="#l1.7181"></a><span id="l1.7181" class="difflineminus">-    {</span>
<a href="#l1.7182"></a><span id="l1.7182" class="difflineplus">+    } else {</span>
<a href="#l1.7183"></a><span id="l1.7183">       lowIndex = tryIndex + 1;</span>
<a href="#l1.7184"></a><span id="l1.7184" class="difflineminus">-      while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex])</span>
<a href="#l1.7185"></a><span id="l1.7185" class="difflineminus">-        lowIndex++;</span>
<a href="#l1.7186"></a><span id="l1.7186" class="difflineplus">+      while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex]) lowIndex++;</span>
<a href="#l1.7187"></a><span id="l1.7187">     }</span>
<a href="#l1.7188"></a><span id="l1.7188">   }</span>
<a href="#l1.7189"></a><span id="l1.7189"> </span>
<a href="#l1.7190"></a><span id="l1.7190">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.7191"></a><span id="l1.7191">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.7192"></a><span id="l1.7192">   return highIndex;</span>
<a href="#l1.7193"></a><span id="l1.7193"> }</span>
<a href="#l1.7194"></a><span id="l1.7194"> </span>
<a href="#l1.7195"></a><span id="l1.7195" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.7196"></a><span id="l1.7196" class="difflineminus">-nsMsgDBView::GetInsertIndexHelper(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7197"></a><span id="l1.7197" class="difflineminus">-                                  nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l1.7198"></a><span id="l1.7198" class="difflineminus">-                                  nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l1.7199"></a><span id="l1.7199" class="difflineminus">-                                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.7200"></a><span id="l1.7200" class="difflineminus">-                                  nsMsgViewSortTypeValue sortType)</span>
<a href="#l1.7201"></a><span id="l1.7201" class="difflineminus">-{</span>
<a href="#l1.7202"></a><span id="l1.7202" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetInsertIndexHelper(</span>
<a href="#l1.7203"></a><span id="l1.7203" class="difflineplus">+    nsIMsgDBHdr *msgHdr, nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l1.7204"></a><span id="l1.7204" class="difflineplus">+    nsCOMArray&lt;nsIMsgFolder&gt; *folders, nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l1.7205"></a><span id="l1.7205" class="difflineplus">+    nsMsgViewSortTypeValue sortType) {</span>
<a href="#l1.7206"></a><span id="l1.7206">   nsMsgViewIndex highIndex = keys.Length();</span>
<a href="#l1.7207"></a><span id="l1.7207">   nsMsgViewIndex lowIndex = 0;</span>
<a href="#l1.7208"></a><span id="l1.7208">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.7209"></a><span id="l1.7209">   EntryInfo1.key = nullptr;</span>
<a href="#l1.7210"></a><span id="l1.7210">   EntryInfo2.key = nullptr;</span>
<a href="#l1.7211"></a><span id="l1.7211"> </span>
<a href="#l1.7212"></a><span id="l1.7212">   nsresult rv;</span>
<a href="#l1.7213"></a><span id="l1.7213" class="difflineminus">-  uint16_t  maxLen;</span>
<a href="#l1.7214"></a><span id="l1.7214" class="difflineplus">+  uint16_t maxLen;</span>
<a href="#l1.7215"></a><span id="l1.7215">   eFieldType fieldType;</span>
<a href="#l1.7216"></a><span id="l1.7216"> </span>
<a href="#l1.7217"></a><span id="l1.7217">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.7218"></a><span id="l1.7218">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.7219"></a><span id="l1.7219">   // GetCollationKey or GetLongField.</span>
<a href="#l1.7220"></a><span id="l1.7220" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.7221"></a><span id="l1.7221" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.7222"></a><span id="l1.7222"> </span>
<a href="#l1.7223"></a><span id="l1.7223">   // The following may leave fieldType undefined.</span>
<a href="#l1.7224"></a><span id="l1.7224">   // In this case, we can return highIndex right away since</span>
<a href="#l1.7225"></a><span id="l1.7225">   // it is the value returned in the default case of</span>
<a href="#l1.7226"></a><span id="l1.7226">   // switch (fieldType) statement below.</span>
<a href="#l1.7227"></a><span id="l1.7227">   rv = GetFieldTypeAndLenForSort(sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.7228"></a><span id="l1.7228">   NS_ENSURE_SUCCESS(rv, highIndex);</span>
<a href="#l1.7229"></a><span id="l1.7229"> </span>
<a href="#l1.7230"></a><span id="l1.7230">   const void *pValue1 = &amp;EntryInfo1, *pValue2 = &amp;EntryInfo2;</span>
<a href="#l1.7231"></a><span id="l1.7231"> </span>
<a href="#l1.7232"></a><span id="l1.7232" class="difflineminus">-  int (* comparisonFun) (const void *pItem1, const void *pItem2, void *privateData) = nullptr;</span>
<a href="#l1.7233"></a><span id="l1.7233" class="difflineplus">+  int (*comparisonFun)(const void *pItem1, const void *pItem2,</span>
<a href="#l1.7234"></a><span id="l1.7234" class="difflineplus">+                       void *privateData) = nullptr;</span>
<a href="#l1.7235"></a><span id="l1.7235">   int retStatus = 0;</span>
<a href="#l1.7236"></a><span id="l1.7236">   msgHdr-&gt;GetMessageKey(&amp;EntryInfo1.id);</span>
<a href="#l1.7237"></a><span id="l1.7237">   msgHdr-&gt;GetFolder(&amp;EntryInfo1.folder);</span>
<a href="#l1.7238"></a><span id="l1.7238">   EntryInfo1.folder-&gt;Release();</span>
<a href="#l1.7239"></a><span id="l1.7239"> </span>
<a href="#l1.7240"></a><span id="l1.7240">   viewSortInfo comparisonContext;</span>
<a href="#l1.7241"></a><span id="l1.7241">   comparisonContext.view = this;</span>
<a href="#l1.7242"></a><span id="l1.7242">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.7243"></a><span id="l1.7243" class="difflineminus">-  comparisonContext.ascendingSort = (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7244"></a><span id="l1.7244" class="difflineplus">+  comparisonContext.ascendingSort =</span>
<a href="#l1.7245"></a><span id="l1.7245" class="difflineplus">+      (sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7246"></a><span id="l1.7246">   rv = EntryInfo1.folder-&gt;GetMsgDatabase(&amp;comparisonContext.db);</span>
<a href="#l1.7247"></a><span id="l1.7247">   NS_ENSURE_SUCCESS(rv, highIndex);</span>
<a href="#l1.7248"></a><span id="l1.7248">   comparisonContext.db-&gt;Release();</span>
<a href="#l1.7249"></a><span id="l1.7249"> </span>
<a href="#l1.7250"></a><span id="l1.7250" class="difflineminus">-  switch (fieldType)</span>
<a href="#l1.7251"></a><span id="l1.7251" class="difflineminus">-  {</span>
<a href="#l1.7252"></a><span id="l1.7252" class="difflineplus">+  switch (fieldType) {</span>
<a href="#l1.7253"></a><span id="l1.7253">     case kCollationKey:</span>
<a href="#l1.7254"></a><span id="l1.7254" class="difflineminus">-      rv = GetCollationKey(msgHdr, sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7255"></a><span id="l1.7255" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7256"></a><span id="l1.7256" class="difflineplus">+      rv = GetCollationKey(msgHdr, sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword,</span>
<a href="#l1.7257"></a><span id="l1.7257" class="difflineplus">+                           colHandler);</span>
<a href="#l1.7258"></a><span id="l1.7258" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7259"></a><span id="l1.7259">       comparisonFun = FnSortIdKeyPtr;</span>
<a href="#l1.7260"></a><span id="l1.7260">       break;</span>
<a href="#l1.7261"></a><span id="l1.7261">     case kU32:</span>
<a href="#l1.7262"></a><span id="l1.7262">       if (sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7263"></a><span id="l1.7263">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.7264"></a><span id="l1.7264">       else</span>
<a href="#l1.7265"></a><span id="l1.7265">         GetLongField(msgHdr, sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7266"></a><span id="l1.7266"> </span>
<a href="#l1.7267"></a><span id="l1.7267">       comparisonFun = FnSortIdUint32;</span>
<a href="#l1.7268"></a><span id="l1.7268">       break;</span>
<a href="#l1.7269"></a><span id="l1.7269">     default:</span>
<a href="#l1.7270"></a><span id="l1.7270">       return highIndex;</span>
<a href="#l1.7271"></a><span id="l1.7271">   }</span>
<a href="#l1.7272"></a><span id="l1.7272"> </span>
<a href="#l1.7273"></a><span id="l1.7273" class="difflineminus">-  while (highIndex &gt; lowIndex)</span>
<a href="#l1.7274"></a><span id="l1.7274" class="difflineminus">-  {</span>
<a href="#l1.7275"></a><span id="l1.7275" class="difflineplus">+  while (highIndex &gt; lowIndex) {</span>
<a href="#l1.7276"></a><span id="l1.7276">     nsMsgViewIndex tryIndex = (lowIndex + highIndex - 1) / 2;</span>
<a href="#l1.7277"></a><span id="l1.7277">     EntryInfo2.id = keys[tryIndex];</span>
<a href="#l1.7278"></a><span id="l1.7278">     EntryInfo2.folder = folders ? folders-&gt;ObjectAt(tryIndex) : m_folder.get();</span>
<a href="#l1.7279"></a><span id="l1.7279"> </span>
<a href="#l1.7280"></a><span id="l1.7280" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7281"></a><span id="l1.7281" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7282"></a><span id="l1.7282">     EntryInfo2.folder-&gt;GetMessageHeader(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7283"></a><span id="l1.7283" class="difflineminus">-    if (!tryHdr)</span>
<a href="#l1.7284"></a><span id="l1.7284" class="difflineminus">-      break;</span>
<a href="#l1.7285"></a><span id="l1.7285" class="difflineminus">-</span>
<a href="#l1.7286"></a><span id="l1.7286" class="difflineminus">-    if (fieldType == kCollationKey)</span>
<a href="#l1.7287"></a><span id="l1.7287" class="difflineminus">-    {</span>
<a href="#l1.7288"></a><span id="l1.7288" class="difflineplus">+    if (!tryHdr) break;</span>
<a href="#l1.7289"></a><span id="l1.7289" class="difflineplus">+</span>
<a href="#l1.7290"></a><span id="l1.7290" class="difflineplus">+    if (fieldType == kCollationKey) {</span>
<a href="#l1.7291"></a><span id="l1.7291">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.7292"></a><span id="l1.7292" class="difflineminus">-      rv = GetCollationKey(tryHdr, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7293"></a><span id="l1.7293" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7294"></a><span id="l1.7294" class="difflineminus">-    }</span>
<a href="#l1.7295"></a><span id="l1.7295" class="difflineminus">-    else if (fieldType == kU32)</span>
<a href="#l1.7296"></a><span id="l1.7296" class="difflineminus">-    {</span>
<a href="#l1.7297"></a><span id="l1.7297" class="difflineplus">+      rv = GetCollationKey(tryHdr, sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword,</span>
<a href="#l1.7298"></a><span id="l1.7298" class="difflineplus">+                           colHandler);</span>
<a href="#l1.7299"></a><span id="l1.7299" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7300"></a><span id="l1.7300" class="difflineplus">+    } else if (fieldType == kU32) {</span>
<a href="#l1.7301"></a><span id="l1.7301">       if (sortType == nsMsgViewSortType::byId) {</span>
<a href="#l1.7302"></a><span id="l1.7302">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.7303"></a><span id="l1.7303" class="difflineminus">-      }</span>
<a href="#l1.7304"></a><span id="l1.7304" class="difflineminus">-      else {</span>
<a href="#l1.7305"></a><span id="l1.7305" class="difflineplus">+      } else {</span>
<a href="#l1.7306"></a><span id="l1.7306">         GetLongField(tryHdr, sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7307"></a><span id="l1.7307">       }</span>
<a href="#l1.7308"></a><span id="l1.7308">     }</span>
<a href="#l1.7309"></a><span id="l1.7309"> </span>
<a href="#l1.7310"></a><span id="l1.7310">     retStatus = (*comparisonFun)(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7311"></a><span id="l1.7311" class="difflineminus">-    if (retStatus == 0)</span>
<a href="#l1.7312"></a><span id="l1.7312" class="difflineminus">-    {</span>
<a href="#l1.7313"></a><span id="l1.7313" class="difflineplus">+    if (retStatus == 0) {</span>
<a href="#l1.7314"></a><span id="l1.7314">       highIndex = tryIndex;</span>
<a href="#l1.7315"></a><span id="l1.7315">       break;</span>
<a href="#l1.7316"></a><span id="l1.7316">     }</span>
<a href="#l1.7317"></a><span id="l1.7317"> </span>
<a href="#l1.7318"></a><span id="l1.7318" class="difflineminus">-    if (retStatus &lt; 0)</span>
<a href="#l1.7319"></a><span id="l1.7319" class="difflineminus">-    {</span>
<a href="#l1.7320"></a><span id="l1.7320" class="difflineplus">+    if (retStatus &lt; 0) {</span>
<a href="#l1.7321"></a><span id="l1.7321">       highIndex = tryIndex;</span>
<a href="#l1.7322"></a><span id="l1.7322" class="difflineminus">-    }</span>
<a href="#l1.7323"></a><span id="l1.7323" class="difflineminus">-    else</span>
<a href="#l1.7324"></a><span id="l1.7324" class="difflineminus">-    {</span>
<a href="#l1.7325"></a><span id="l1.7325" class="difflineplus">+    } else {</span>
<a href="#l1.7326"></a><span id="l1.7326">       lowIndex = tryIndex + 1;</span>
<a href="#l1.7327"></a><span id="l1.7327">     }</span>
<a href="#l1.7328"></a><span id="l1.7328">   }</span>
<a href="#l1.7329"></a><span id="l1.7329"> </span>
<a href="#l1.7330"></a><span id="l1.7330">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.7331"></a><span id="l1.7331">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.7332"></a><span id="l1.7332">   return highIndex;</span>
<a href="#l1.7333"></a><span id="l1.7333"> }</span>
<a href="#l1.7334"></a><span id="l1.7334"> </span>
<a href="#l1.7335"></a><span id="l1.7335" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.7336"></a><span id="l1.7336" class="difflineminus">-nsMsgDBView::GetInsertIndex(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.7337"></a><span id="l1.7337" class="difflineminus">-{</span>
<a href="#l1.7338"></a><span id="l1.7338" class="difflineminus">-  if (!GetSize())</span>
<a href="#l1.7339"></a><span id="l1.7339" class="difflineminus">-    return 0;</span>
<a href="#l1.7340"></a><span id="l1.7340" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetInsertIndex(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.7341"></a><span id="l1.7341" class="difflineplus">+  if (!GetSize()) return 0;</span>
<a href="#l1.7342"></a><span id="l1.7342"> </span>
<a href="#l1.7343"></a><span id="l1.7343">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0 &amp;&amp;</span>
<a href="#l1.7344"></a><span id="l1.7344">       !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) &amp;&amp;</span>
<a href="#l1.7345"></a><span id="l1.7345" class="difflineminus">-      m_sortOrder != nsMsgViewSortType::byId)</span>
<a href="#l1.7346"></a><span id="l1.7346" class="difflineminus">-  {</span>
<a href="#l1.7347"></a><span id="l1.7347" class="difflineplus">+      m_sortOrder != nsMsgViewSortType::byId) {</span>
<a href="#l1.7348"></a><span id="l1.7348">     return GetIndexForThread(msgHdr);</span>
<a href="#l1.7349"></a><span id="l1.7349">   }</span>
<a href="#l1.7350"></a><span id="l1.7350"> </span>
<a href="#l1.7351"></a><span id="l1.7351" class="difflineminus">-  return GetInsertIndexHelper(msgHdr, m_keys, GetFolders(), m_sortOrder, m_sortType);</span>
<a href="#l1.7352"></a><span id="l1.7352" class="difflineminus">-}</span>
<a href="#l1.7353"></a><span id="l1.7353" class="difflineminus">-</span>
<a href="#l1.7354"></a><span id="l1.7354" class="difflineminus">-nsresult</span>
<a href="#l1.7355"></a><span id="l1.7355" class="difflineminus">-nsMsgDBView::AddHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7356"></a><span id="l1.7356" class="difflineminus">-                    nsMsgViewIndex *resultIndex)</span>
<a href="#l1.7357"></a><span id="l1.7357" class="difflineminus">-{</span>
<a href="#l1.7358"></a><span id="l1.7358" class="difflineminus">-  uint32_t  flags = 0;</span>
<a href="#l1.7359"></a><span id="l1.7359" class="difflineplus">+  return GetInsertIndexHelper(msgHdr, m_keys, GetFolders(), m_sortOrder,</span>
<a href="#l1.7360"></a><span id="l1.7360" class="difflineplus">+                              m_sortType);</span>
<a href="#l1.7361"></a><span id="l1.7361" class="difflineplus">+}</span>
<a href="#l1.7362"></a><span id="l1.7362" class="difflineplus">+</span>
<a href="#l1.7363"></a><span id="l1.7363" class="difflineplus">+nsresult nsMsgDBView::AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex) {</span>
<a href="#l1.7364"></a><span id="l1.7364" class="difflineplus">+  uint32_t flags = 0;</span>
<a href="#l1.7365"></a><span id="l1.7365"> #ifdef DEBUG_bienvenu</span>
<a href="#l1.7366"></a><span id="l1.7366" class="difflineminus">-  NS_ASSERTION(m_keys.Length() == m_flags.Length() &amp;&amp; (int) m_keys.Length() == m_levels.Length(), &quot;view arrays out of sync!&quot;);</span>
<a href="#l1.7367"></a><span id="l1.7367" class="difflineplus">+  NS_ASSERTION(m_keys.Length() == m_flags.Length() &amp;&amp;</span>
<a href="#l1.7368"></a><span id="l1.7368" class="difflineplus">+                   (int)m_keys.Length() == m_levels.Length(),</span>
<a href="#l1.7369"></a><span id="l1.7369" class="difflineplus">+               &quot;view arrays out of sync!&quot;);</span>
<a href="#l1.7370"></a><span id="l1.7370"> #endif</span>
<a href="#l1.7371"></a><span id="l1.7371"> </span>
<a href="#l1.7372"></a><span id="l1.7372" class="difflineminus">-  if (resultIndex)</span>
<a href="#l1.7373"></a><span id="l1.7373" class="difflineminus">-    *resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.7374"></a><span id="l1.7374" class="difflineminus">-</span>
<a href="#l1.7375"></a><span id="l1.7375" class="difflineminus">-  if (!GetShowingIgnored())</span>
<a href="#l1.7376"></a><span id="l1.7376" class="difflineminus">-  {</span>
<a href="#l1.7377"></a><span id="l1.7377" class="difflineminus">-    nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.7378"></a><span id="l1.7378" class="difflineplus">+  if (resultIndex) *resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.7379"></a><span id="l1.7379" class="difflineplus">+</span>
<a href="#l1.7380"></a><span id="l1.7380" class="difflineplus">+  if (!GetShowingIgnored()) {</span>
<a href="#l1.7381"></a><span id="l1.7381" class="difflineplus">+    nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.7382"></a><span id="l1.7382">     GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l1.7383"></a><span id="l1.7383" class="difflineminus">-    if (thread)</span>
<a href="#l1.7384"></a><span id="l1.7384" class="difflineminus">-    {</span>
<a href="#l1.7385"></a><span id="l1.7385" class="difflineplus">+    if (thread) {</span>
<a href="#l1.7386"></a><span id="l1.7386">       thread-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.7387"></a><span id="l1.7387" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Ignored)</span>
<a href="#l1.7388"></a><span id="l1.7388" class="difflineminus">-        return NS_OK;</span>
<a href="#l1.7389"></a><span id="l1.7389" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Ignored) return NS_OK;</span>
<a href="#l1.7390"></a><span id="l1.7390">     }</span>
<a href="#l1.7391"></a><span id="l1.7391"> </span>
<a href="#l1.7392"></a><span id="l1.7392">     bool ignored;</span>
<a href="#l1.7393"></a><span id="l1.7393">     msgHdr-&gt;GetIsKilled(&amp;ignored);</span>
<a href="#l1.7394"></a><span id="l1.7394" class="difflineminus">-    if (ignored)</span>
<a href="#l1.7395"></a><span id="l1.7395" class="difflineminus">-       return NS_OK;</span>
<a href="#l1.7396"></a><span id="l1.7396" class="difflineplus">+    if (ignored) return NS_OK;</span>
<a href="#l1.7397"></a><span id="l1.7397">   }</span>
<a href="#l1.7398"></a><span id="l1.7398"> </span>
<a href="#l1.7399"></a><span id="l1.7399">   nsMsgKey msgKey, threadId;</span>
<a href="#l1.7400"></a><span id="l1.7400">   nsMsgKey threadParent;</span>
<a href="#l1.7401"></a><span id="l1.7401">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7402"></a><span id="l1.7402">   msgHdr-&gt;GetThreadId(&amp;threadId);</span>
<a href="#l1.7403"></a><span id="l1.7403">   msgHdr-&gt;GetThreadParent(&amp;threadParent);</span>
<a href="#l1.7404"></a><span id="l1.7404"> </span>
<a href="#l1.7405"></a><span id="l1.7405">   msgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l1.7406"></a><span id="l1.7406">   // XXX this isn't quite right, is it?</span>
<a href="#l1.7407"></a><span id="l1.7407">   // Should be checking that our thread parent key is none?</span>
<a href="#l1.7408"></a><span id="l1.7408" class="difflineminus">-  if (threadParent == nsMsgKey_None)</span>
<a href="#l1.7409"></a><span id="l1.7409" class="difflineminus">-    flags |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l1.7410"></a><span id="l1.7410" class="difflineplus">+  if (threadParent == nsMsgKey_None) flags |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l1.7411"></a><span id="l1.7411"> </span>
<a href="#l1.7412"></a><span id="l1.7412">   nsMsgViewIndex insertIndex = GetInsertIndex(msgHdr);</span>
<a href="#l1.7413"></a><span id="l1.7413" class="difflineminus">-  if (insertIndex == nsMsgViewIndex_None)</span>
<a href="#l1.7414"></a><span id="l1.7414" class="difflineminus">-  {</span>
<a href="#l1.7415"></a><span id="l1.7415" class="difflineplus">+  if (insertIndex == nsMsgViewIndex_None) {</span>
<a href="#l1.7416"></a><span id="l1.7416">     // If unreadonly, level is 0 because we must be the only msg in the thread.</span>
<a href="#l1.7417"></a><span id="l1.7417">     int32_t levelToAdd = 0;</span>
<a href="#l1.7418"></a><span id="l1.7418"> </span>
<a href="#l1.7419"></a><span id="l1.7419" class="difflineminus">-    if (m_sortOrder == nsMsgViewSortOrder::ascending)</span>
<a href="#l1.7420"></a><span id="l1.7420" class="difflineminus">-    {</span>
<a href="#l1.7421"></a><span id="l1.7421" class="difflineplus">+    if (m_sortOrder == nsMsgViewSortOrder::ascending) {</span>
<a href="#l1.7422"></a><span id="l1.7422">       InsertMsgHdrAt(GetSize(), msgHdr, msgKey, flags, levelToAdd);</span>
<a href="#l1.7423"></a><span id="l1.7423" class="difflineminus">-      if (resultIndex)</span>
<a href="#l1.7424"></a><span id="l1.7424" class="difflineminus">-        *resultIndex = GetSize() - 1;</span>
<a href="#l1.7425"></a><span id="l1.7425" class="difflineplus">+      if (resultIndex) *resultIndex = GetSize() - 1;</span>
<a href="#l1.7426"></a><span id="l1.7426"> </span>
<a href="#l1.7427"></a><span id="l1.7427">       // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l1.7428"></a><span id="l1.7428">       // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7429"></a><span id="l1.7429">       // GetRowCount().</span>
<a href="#l1.7430"></a><span id="l1.7430">       NoteChange(GetSize() - 1, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7431"></a><span id="l1.7431" class="difflineminus">-    }</span>
<a href="#l1.7432"></a><span id="l1.7432" class="difflineminus">-    else</span>
<a href="#l1.7433"></a><span id="l1.7433" class="difflineminus">-    {</span>
<a href="#l1.7434"></a><span id="l1.7434" class="difflineplus">+    } else {</span>
<a href="#l1.7435"></a><span id="l1.7435">       InsertMsgHdrAt(0, msgHdr, msgKey, flags, levelToAdd);</span>
<a href="#l1.7436"></a><span id="l1.7436" class="difflineminus">-      if (resultIndex)</span>
<a href="#l1.7437"></a><span id="l1.7437" class="difflineminus">-        *resultIndex = 0;</span>
<a href="#l1.7438"></a><span id="l1.7438" class="difflineplus">+      if (resultIndex) *resultIndex = 0;</span>
<a href="#l1.7439"></a><span id="l1.7439"> </span>
<a href="#l1.7440"></a><span id="l1.7440">       // The call to NoteChange() has to happen after we insert the key as</span>
<a href="#l1.7441"></a><span id="l1.7441">       // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7442"></a><span id="l1.7442">       // GetRowCount().</span>
<a href="#l1.7443"></a><span id="l1.7443">       NoteChange(0, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7444"></a><span id="l1.7444">     }</span>
<a href="#l1.7445"></a><span id="l1.7445"> </span>
<a href="#l1.7446"></a><span id="l1.7446">     m_sortValid = false;</span>
<a href="#l1.7447"></a><span id="l1.7447" class="difflineminus">-  }</span>
<a href="#l1.7448"></a><span id="l1.7448" class="difflineminus">-  else</span>
<a href="#l1.7449"></a><span id="l1.7449" class="difflineminus">-  {</span>
<a href="#l1.7450"></a><span id="l1.7450" class="difflineplus">+  } else {</span>
<a href="#l1.7451"></a><span id="l1.7451">     InsertMsgHdrAt(insertIndex, msgHdr, msgKey, flags, 0);</span>
<a href="#l1.7452"></a><span id="l1.7452" class="difflineminus">-    if (resultIndex)</span>
<a href="#l1.7453"></a><span id="l1.7453" class="difflineminus">-      *resultIndex = insertIndex;</span>
<a href="#l1.7454"></a><span id="l1.7454" class="difflineplus">+    if (resultIndex) *resultIndex = insertIndex;</span>
<a href="#l1.7455"></a><span id="l1.7455"> </span>
<a href="#l1.7456"></a><span id="l1.7456">     // The call to NoteChange() has to happen after we add the key as</span>
<a href="#l1.7457"></a><span id="l1.7457">     // NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.7458"></a><span id="l1.7458">     // GetRowCount().</span>
<a href="#l1.7459"></a><span id="l1.7459">     NoteChange(insertIndex, 1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.7460"></a><span id="l1.7460">   }</span>
<a href="#l1.7461"></a><span id="l1.7461"> </span>
<a href="#l1.7462"></a><span id="l1.7462">   OnHeaderAddedOrDeleted();</span>
<a href="#l1.7463"></a><span id="l1.7463">   return NS_OK;</span>
<a href="#l1.7464"></a><span id="l1.7464"> }</span>
<a href="#l1.7465"></a><span id="l1.7465"> </span>
<a href="#l1.7466"></a><span id="l1.7466" class="difflineminus">-bool</span>
<a href="#l1.7467"></a><span id="l1.7467" class="difflineminus">-nsMsgDBView::WantsThisThread(nsIMsgThread * /*threadHdr*/)</span>
<a href="#l1.7468"></a><span id="l1.7468" class="difflineminus">-{</span>
<a href="#l1.7469"></a><span id="l1.7469" class="difflineplus">+bool nsMsgDBView::WantsThisThread(nsIMsgThread * /*threadHdr*/) {</span>
<a href="#l1.7470"></a><span id="l1.7470">   // Default is to want all threads.</span>
<a href="#l1.7471"></a><span id="l1.7471">   return true;</span>
<a href="#l1.7472"></a><span id="l1.7472"> }</span>
<a href="#l1.7473"></a><span id="l1.7473"> </span>
<a href="#l1.7474"></a><span id="l1.7474" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.7475"></a><span id="l1.7475" class="difflineminus">-nsMsgDBView::FindParentInThread(nsMsgKey parentKey,</span>
<a href="#l1.7476"></a><span id="l1.7476" class="difflineminus">-                                nsMsgViewIndex startOfThreadViewIndex)</span>
<a href="#l1.7477"></a><span id="l1.7477" class="difflineminus">-{</span>
<a href="#l1.7478"></a><span id="l1.7478" class="difflineplus">+nsMsgViewIndex nsMsgDBView::FindParentInThread(</span>
<a href="#l1.7479"></a><span id="l1.7479" class="difflineplus">+    nsMsgKey parentKey, nsMsgViewIndex startOfThreadViewIndex) {</span>
<a href="#l1.7480"></a><span id="l1.7480">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7481"></a><span id="l1.7481" class="difflineminus">-  while (parentKey != nsMsgKey_None)</span>
<a href="#l1.7482"></a><span id="l1.7482" class="difflineminus">-  {</span>
<a href="#l1.7483"></a><span id="l1.7483" class="difflineminus">-    nsMsgViewIndex parentIndex = m_keys.IndexOf(parentKey, startOfThreadViewIndex);</span>
<a href="#l1.7484"></a><span id="l1.7484" class="difflineminus">-    if (parentIndex != nsMsgViewIndex_None)</span>
<a href="#l1.7485"></a><span id="l1.7485" class="difflineminus">-      return parentIndex;</span>
<a href="#l1.7486"></a><span id="l1.7486" class="difflineplus">+  while (parentKey != nsMsgKey_None) {</span>
<a href="#l1.7487"></a><span id="l1.7487" class="difflineplus">+    nsMsgViewIndex parentIndex =</span>
<a href="#l1.7488"></a><span id="l1.7488" class="difflineplus">+        m_keys.IndexOf(parentKey, startOfThreadViewIndex);</span>
<a href="#l1.7489"></a><span id="l1.7489" class="difflineplus">+    if (parentIndex != nsMsgViewIndex_None) return parentIndex;</span>
<a href="#l1.7490"></a><span id="l1.7490"> </span>
<a href="#l1.7491"></a><span id="l1.7491">     if (NS_FAILED(m_db-&gt;GetMsgHdrForKey(parentKey, getter_AddRefs(msgHdr))))</span>
<a href="#l1.7492"></a><span id="l1.7492">       break;</span>
<a href="#l1.7493"></a><span id="l1.7493"> </span>
<a href="#l1.7494"></a><span id="l1.7494">     msgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l1.7495"></a><span id="l1.7495">   }</span>
<a href="#l1.7496"></a><span id="l1.7496"> </span>
<a href="#l1.7497"></a><span id="l1.7497">   return startOfThreadViewIndex;</span>
<a href="#l1.7498"></a><span id="l1.7498"> }</span>
<a href="#l1.7499"></a><span id="l1.7499"> </span>
<a href="#l1.7500"></a><span id="l1.7500" class="difflineminus">-nsresult</span>
<a href="#l1.7501"></a><span id="l1.7501" class="difflineminus">-nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l1.7502"></a><span id="l1.7502" class="difflineminus">-                                  nsMsgKey parentKey,</span>
<a href="#l1.7503"></a><span id="l1.7503" class="difflineminus">-                                  uint32_t level,</span>
<a href="#l1.7504"></a><span id="l1.7504" class="difflineminus">-                                  nsMsgViewIndex *viewIndex,</span>
<a href="#l1.7505"></a><span id="l1.7505" class="difflineminus">-                                  uint32_t *pNumListed)</span>
<a href="#l1.7506"></a><span id="l1.7506" class="difflineminus">-{</span>
<a href="#l1.7507"></a><span id="l1.7507" class="difflineplus">+nsresult nsMsgDBView::ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l1.7508"></a><span id="l1.7508" class="difflineplus">+                                           nsMsgKey parentKey, uint32_t level,</span>
<a href="#l1.7509"></a><span id="l1.7509" class="difflineplus">+                                           nsMsgViewIndex *viewIndex,</span>
<a href="#l1.7510"></a><span id="l1.7510" class="difflineplus">+                                           uint32_t *pNumListed) {</span>
<a href="#l1.7511"></a><span id="l1.7511">   nsresult rv = NS_OK;</span>
<a href="#l1.7512"></a><span id="l1.7512" class="difflineminus">-  nsCOMPtr &lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l1.7513"></a><span id="l1.7513" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l1.7514"></a><span id="l1.7514">   threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l1.7515"></a><span id="l1.7515">   uint32_t numChildren;</span>
<a href="#l1.7516"></a><span id="l1.7516" class="difflineminus">-  (void) threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7517"></a><span id="l1.7517" class="difflineplus">+  (void)threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7518"></a><span id="l1.7518">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.7519"></a><span id="l1.7519">   // Bogus, but harmless.</span>
<a href="#l1.7520"></a><span id="l1.7520" class="difflineminus">-  if (!numChildren)</span>
<a href="#l1.7521"></a><span id="l1.7521" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.7522"></a><span id="l1.7522" class="difflineplus">+  if (!numChildren) return NS_OK;</span>
<a href="#l1.7523"></a><span id="l1.7523"> </span>
<a href="#l1.7524"></a><span id="l1.7524">   // Account for the existing thread root.</span>
<a href="#l1.7525"></a><span id="l1.7525">   numChildren--;</span>
<a href="#l1.7526"></a><span id="l1.7526"> </span>
<a href="#l1.7527"></a><span id="l1.7527">   // Skip the first one.</span>
<a href="#l1.7528"></a><span id="l1.7528">   bool hasMore;</span>
<a href="#l1.7529"></a><span id="l1.7529" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l1.7530"></a><span id="l1.7530" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7531"></a><span id="l1.7531" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l1.7532"></a><span id="l1.7532" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7533"></a><span id="l1.7533">   while (NS_SUCCEEDED(rv) &amp;&amp;</span>
<a href="#l1.7534"></a><span id="l1.7534">          NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l1.7535"></a><span id="l1.7535" class="difflineminus">-         hasMore)</span>
<a href="#l1.7536"></a><span id="l1.7536" class="difflineminus">-  {</span>
<a href="#l1.7537"></a><span id="l1.7537" class="difflineplus">+         hasMore) {</span>
<a href="#l1.7538"></a><span id="l1.7538">     rv = msgEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l1.7539"></a><span id="l1.7539" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l1.7540"></a><span id="l1.7540" class="difflineminus">-    {</span>
<a href="#l1.7541"></a><span id="l1.7541" class="difflineminus">-      if (*pNumListed == numChildren)</span>
<a href="#l1.7542"></a><span id="l1.7542" class="difflineminus">-      {</span>
<a href="#l1.7543"></a><span id="l1.7543" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; supports) {</span>
<a href="#l1.7544"></a><span id="l1.7544" class="difflineplus">+      if (*pNumListed == numChildren) {</span>
<a href="#l1.7545"></a><span id="l1.7545">         MOZ_ASSERT_UNREACHABLE(&quot;thread corrupt in db&quot;);</span>
<a href="#l1.7546"></a><span id="l1.7546">         // If we've listed more messages than are in the thread, then the db</span>
<a href="#l1.7547"></a><span id="l1.7547">         // is corrupt, and we should invalidate it.</span>
<a href="#l1.7548"></a><span id="l1.7548">         // We'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7549"></a><span id="l1.7549">         // though for now it probably won't get paid attention to.</span>
<a href="#l1.7550"></a><span id="l1.7550">         m_db-&gt;SetSummaryValid(false);</span>
<a href="#l1.7551"></a><span id="l1.7551">         rv = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l1.7552"></a><span id="l1.7552">         break;</span>
<a href="#l1.7553"></a><span id="l1.7553">       }</span>
<a href="#l1.7554"></a><span id="l1.7554"> </span>
<a href="#l1.7555"></a><span id="l1.7555">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l1.7556"></a><span id="l1.7556" class="difflineminus">-      if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l1.7557"></a><span id="l1.7557" class="difflineminus">-      {</span>
<a href="#l1.7558"></a><span id="l1.7558" class="difflineplus">+      if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored)) {</span>
<a href="#l1.7559"></a><span id="l1.7559">         bool ignored;</span>
<a href="#l1.7560"></a><span id="l1.7560">         msgHdr-&gt;GetIsKilled(&amp;ignored);</span>
<a href="#l1.7561"></a><span id="l1.7561">         // We are not going to process subthreads, horribly invalidating the</span>
<a href="#l1.7562"></a><span id="l1.7562">         // numChildren characteristic.</span>
<a href="#l1.7563"></a><span id="l1.7563" class="difflineminus">-        if (ignored)</span>
<a href="#l1.7564"></a><span id="l1.7564" class="difflineminus">-          continue;</span>
<a href="#l1.7565"></a><span id="l1.7565" class="difflineplus">+        if (ignored) continue;</span>
<a href="#l1.7566"></a><span id="l1.7566">       }</span>
<a href="#l1.7567"></a><span id="l1.7567"> </span>
<a href="#l1.7568"></a><span id="l1.7568">       nsMsgKey msgKey;</span>
<a href="#l1.7569"></a><span id="l1.7569">       uint32_t msgFlags, newFlags;</span>
<a href="#l1.7570"></a><span id="l1.7570">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7571"></a><span id="l1.7571">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.7572"></a><span id="l1.7572">       AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.7573"></a><span id="l1.7573" class="difflineminus">-      SetMsgHdrAt(msgHdr, *viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, level);</span>
<a href="#l1.7574"></a><span id="l1.7574" class="difflineplus">+      SetMsgHdrAt(msgHdr, *viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS,</span>
<a href="#l1.7575"></a><span id="l1.7575" class="difflineplus">+                  level);</span>
<a href="#l1.7576"></a><span id="l1.7576">       // Turn off thread or elided bit if they got turned on (maybe from new</span>
<a href="#l1.7577"></a><span id="l1.7577">       // only view?)</span>
<a href="#l1.7578"></a><span id="l1.7578">       msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided),</span>
<a href="#l1.7579"></a><span id="l1.7579">                        &amp;newFlags);</span>
<a href="#l1.7580"></a><span id="l1.7580">       (*pNumListed)++;</span>
<a href="#l1.7581"></a><span id="l1.7581">       (*viewIndex)++;</span>
<a href="#l1.7582"></a><span id="l1.7582" class="difflineminus">-      rv = ListIdsInThreadOrder(threadHdr, msgKey, level + 1, viewIndex, pNumListed);</span>
<a href="#l1.7583"></a><span id="l1.7583" class="difflineplus">+      rv = ListIdsInThreadOrder(threadHdr, msgKey, level + 1, viewIndex,</span>
<a href="#l1.7584"></a><span id="l1.7584" class="difflineplus">+                                pNumListed);</span>
<a href="#l1.7585"></a><span id="l1.7585">     }</span>
<a href="#l1.7586"></a><span id="l1.7586">   }</span>
<a href="#l1.7587"></a><span id="l1.7587"> </span>
<a href="#l1.7588"></a><span id="l1.7588">   // We don't want to return the rv from the enumerator when it reaches the</span>
<a href="#l1.7589"></a><span id="l1.7589">   // end, do we?</span>
<a href="#l1.7590"></a><span id="l1.7590">   return rv;</span>
<a href="#l1.7591"></a><span id="l1.7591"> }</span>
<a href="#l1.7592"></a><span id="l1.7592"> </span>
<a href="#l1.7593"></a><span id="l1.7593" class="difflineminus">-bool</span>
<a href="#l1.7594"></a><span id="l1.7594" class="difflineminus">-nsMsgDBView::InsertEmptyRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.7595"></a><span id="l1.7595" class="difflineminus">-                             int32_t numRows)</span>
<a href="#l1.7596"></a><span id="l1.7596" class="difflineminus">-{</span>
<a href="#l1.7597"></a><span id="l1.7597" class="difflineplus">+bool nsMsgDBView::InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows) {</span>
<a href="#l1.7598"></a><span id="l1.7598">   return m_keys.InsertElementsAt(viewIndex, numRows, 0) &amp;&amp;</span>
<a href="#l1.7599"></a><span id="l1.7599">          m_flags.InsertElementsAt(viewIndex, numRows, 0) &amp;&amp;</span>
<a href="#l1.7600"></a><span id="l1.7600">          m_levels.InsertElementsAt(viewIndex, numRows, 1);</span>
<a href="#l1.7601"></a><span id="l1.7601"> }</span>
<a href="#l1.7602"></a><span id="l1.7602"> </span>
<a href="#l1.7603"></a><span id="l1.7603" class="difflineminus">-void</span>
<a href="#l1.7604"></a><span id="l1.7604" class="difflineminus">-nsMsgDBView::RemoveRows(nsMsgViewIndex viewIndex,</span>
<a href="#l1.7605"></a><span id="l1.7605" class="difflineminus">-                        int32_t numRows)</span>
<a href="#l1.7606"></a><span id="l1.7606" class="difflineminus">-{</span>
<a href="#l1.7607"></a><span id="l1.7607" class="difflineplus">+void nsMsgDBView::RemoveRows(nsMsgViewIndex viewIndex, int32_t numRows) {</span>
<a href="#l1.7608"></a><span id="l1.7608">   m_keys.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7609"></a><span id="l1.7609">   m_flags.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7610"></a><span id="l1.7610">   m_levels.RemoveElementsAt(viewIndex, numRows);</span>
<a href="#l1.7611"></a><span id="l1.7611"> }</span>
<a href="#l1.7612"></a><span id="l1.7612"> </span>
<a href="#l1.7613"></a><span id="l1.7613"> NS_IMETHODIMP</span>
<a href="#l1.7614"></a><span id="l1.7614" class="difflineminus">-nsMsgDBView::InsertTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7615"></a><span id="l1.7615" class="difflineminus">-                            uint32_t aNumRows,</span>
<a href="#l1.7616"></a><span id="l1.7616" class="difflineminus">-                            nsMsgKey aKey,</span>
<a href="#l1.7617"></a><span id="l1.7617" class="difflineminus">-                            nsMsgViewFlagsTypeValue aFlags,</span>
<a href="#l1.7618"></a><span id="l1.7618" class="difflineminus">-                            uint32_t aLevel,</span>
<a href="#l1.7619"></a><span id="l1.7619" class="difflineminus">-                            nsIMsgFolder *aFolder)</span>
<a href="#l1.7620"></a><span id="l1.7620" class="difflineminus">-{</span>
<a href="#l1.7621"></a><span id="l1.7621" class="difflineminus">-  if (GetSize() &lt; aIndex)</span>
<a href="#l1.7622"></a><span id="l1.7622" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7623"></a><span id="l1.7623" class="difflineplus">+nsMsgDBView::InsertTreeRows(nsMsgViewIndex aIndex, uint32_t aNumRows,</span>
<a href="#l1.7624"></a><span id="l1.7624" class="difflineplus">+                            nsMsgKey aKey, nsMsgViewFlagsTypeValue aFlags,</span>
<a href="#l1.7625"></a><span id="l1.7625" class="difflineplus">+                            uint32_t aLevel, nsIMsgFolder *aFolder) {</span>
<a href="#l1.7626"></a><span id="l1.7626" class="difflineplus">+  if (GetSize() &lt; aIndex) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7627"></a><span id="l1.7627"> </span>
<a href="#l1.7628"></a><span id="l1.7628">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.7629"></a><span id="l1.7629" class="difflineminus">-  if (folders)</span>
<a href="#l1.7630"></a><span id="l1.7630" class="difflineminus">-  {</span>
<a href="#l1.7631"></a><span id="l1.7631" class="difflineplus">+  if (folders) {</span>
<a href="#l1.7632"></a><span id="l1.7632">     // In a search/xfvf view only, a folder is required.</span>
<a href="#l1.7633"></a><span id="l1.7633">     NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l1.7634"></a><span id="l1.7634">     for (size_t i = 0; i &lt; aNumRows; i++)</span>
<a href="#l1.7635"></a><span id="l1.7635">       // Insert into m_folders.</span>
<a href="#l1.7636"></a><span id="l1.7636">       if (!folders-&gt;InsertObjectAt(aFolder, aIndex + i))</span>
<a href="#l1.7637"></a><span id="l1.7637">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7638"></a><span id="l1.7638">   }</span>
<a href="#l1.7639"></a><span id="l1.7639"> </span>
<a href="#l1.7640"></a><span id="l1.7640" class="difflineat">@@ -6402,118 +5551,101 @@ nsMsgDBView::InsertTreeRows(nsMsgViewInd</span>
<a href="#l1.7641"></a><span id="l1.7641">       m_flags.InsertElementsAt(aIndex, aNumRows, aFlags) &amp;&amp;</span>
<a href="#l1.7642"></a><span id="l1.7642">       m_levels.InsertElementsAt(aIndex, aNumRows, aLevel))</span>
<a href="#l1.7643"></a><span id="l1.7643">     return NS_OK;</span>
<a href="#l1.7644"></a><span id="l1.7644"> </span>
<a href="#l1.7645"></a><span id="l1.7645">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7646"></a><span id="l1.7646"> }</span>
<a href="#l1.7647"></a><span id="l1.7647"> </span>
<a href="#l1.7648"></a><span id="l1.7648"> NS_IMETHODIMP</span>
<a href="#l1.7649"></a><span id="l1.7649" class="difflineminus">-nsMsgDBView::RemoveTreeRows(nsMsgViewIndex aIndex,</span>
<a href="#l1.7650"></a><span id="l1.7650" class="difflineminus">-                            uint32_t aNumRows)</span>
<a href="#l1.7651"></a><span id="l1.7651" class="difflineminus">-{</span>
<a href="#l1.7652"></a><span id="l1.7652" class="difflineplus">+nsMsgDBView::RemoveTreeRows(nsMsgViewIndex aIndex, uint32_t aNumRows) {</span>
<a href="#l1.7653"></a><span id="l1.7653">   // Prevent a crash if attempting to remove rows which don't exist.</span>
<a href="#l1.7654"></a><span id="l1.7654" class="difflineminus">-  if (GetSize() &lt; aIndex + aNumRows)</span>
<a href="#l1.7655"></a><span id="l1.7655" class="difflineminus">-    return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7656"></a><span id="l1.7656" class="difflineplus">+  if (GetSize() &lt; aIndex + aNumRows) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7657"></a><span id="l1.7657"> </span>
<a href="#l1.7658"></a><span id="l1.7658">   nsMsgDBView::RemoveRows(aIndex, aNumRows);</span>
<a href="#l1.7659"></a><span id="l1.7659"> </span>
<a href="#l1.7660"></a><span id="l1.7660">   nsCOMArray&lt;nsIMsgFolder&gt; *folders = GetFolders();</span>
<a href="#l1.7661"></a><span id="l1.7661">   if (folders)</span>
<a href="#l1.7662"></a><span id="l1.7662">     // In a search/xfvf view only, remove from m_folders.</span>
<a href="#l1.7663"></a><span id="l1.7663" class="difflineminus">-    if (!folders-&gt;RemoveObjectsAt(aIndex, aNumRows))</span>
<a href="#l1.7664"></a><span id="l1.7664" class="difflineminus">-      return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7665"></a><span id="l1.7665" class="difflineminus">-</span>
<a href="#l1.7666"></a><span id="l1.7666" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.7667"></a><span id="l1.7667" class="difflineminus">-}</span>
<a href="#l1.7668"></a><span id="l1.7668" class="difflineminus">-</span>
<a href="#l1.7669"></a><span id="l1.7669" class="difflineminus">-nsresult</span>
<a href="#l1.7670"></a><span id="l1.7670" class="difflineminus">-nsMsgDBView::ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.7671"></a><span id="l1.7671" class="difflineminus">-                             nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.7672"></a><span id="l1.7672" class="difflineminus">-                             uint32_t *pNumListed)</span>
<a href="#l1.7673"></a><span id="l1.7673" class="difflineminus">-{</span>
<a href="#l1.7674"></a><span id="l1.7674" class="difflineplus">+    if (!folders-&gt;RemoveObjectsAt(aIndex, aNumRows)) return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.7675"></a><span id="l1.7675" class="difflineplus">+</span>
<a href="#l1.7676"></a><span id="l1.7676" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.7677"></a><span id="l1.7677" class="difflineplus">+}</span>
<a href="#l1.7678"></a><span id="l1.7678" class="difflineplus">+</span>
<a href="#l1.7679"></a><span id="l1.7679" class="difflineplus">+nsresult nsMsgDBView::ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.7680"></a><span id="l1.7680" class="difflineplus">+                                      nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.7681"></a><span id="l1.7681" class="difflineplus">+                                      uint32_t *pNumListed) {</span>
<a href="#l1.7682"></a><span id="l1.7682">   NS_ENSURE_ARG(threadHdr);</span>
<a href="#l1.7683"></a><span id="l1.7683">   // These children ids should be in thread order.</span>
<a href="#l1.7684"></a><span id="l1.7684">   nsresult rv = NS_OK;</span>
<a href="#l1.7685"></a><span id="l1.7685">   uint32_t i;</span>
<a href="#l1.7686"></a><span id="l1.7686">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l1.7687"></a><span id="l1.7687">   *pNumListed = 0;</span>
<a href="#l1.7688"></a><span id="l1.7688"> </span>
<a href="#l1.7689"></a><span id="l1.7689">   uint32_t numChildren;</span>
<a href="#l1.7690"></a><span id="l1.7690">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.7691"></a><span id="l1.7691">   NS_ASSERTION(numChildren, &quot;Empty thread in view/db&quot;);</span>
<a href="#l1.7692"></a><span id="l1.7692" class="difflineminus">-  if (!numChildren)</span>
<a href="#l1.7693"></a><span id="l1.7693" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.7694"></a><span id="l1.7694" class="difflineplus">+  if (!numChildren) return NS_OK;</span>
<a href="#l1.7695"></a><span id="l1.7695"> </span>
<a href="#l1.7696"></a><span id="l1.7696">   // Account for the existing thread root.</span>
<a href="#l1.7697"></a><span id="l1.7697">   numChildren--;</span>
<a href="#l1.7698"></a><span id="l1.7698" class="difflineminus">-  if (!InsertEmptyRows(viewIndex, numChildren))</span>
<a href="#l1.7699"></a><span id="l1.7699" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.7700"></a><span id="l1.7700" class="difflineplus">+  if (!InsertEmptyRows(viewIndex, numChildren)) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.7701"></a><span id="l1.7701"> </span>
<a href="#l1.7702"></a><span id="l1.7702">   // ### need to rework this when we implemented threading in group views.</span>
<a href="#l1.7703"></a><span id="l1.7703">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.7704"></a><span id="l1.7704" class="difflineminus">-      !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l1.7705"></a><span id="l1.7705" class="difflineminus">-  {</span>
<a href="#l1.7706"></a><span id="l1.7706" class="difflineplus">+      !(m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)) {</span>
<a href="#l1.7707"></a><span id="l1.7707">     nsMsgKey parentKey = m_keys[startOfThreadViewIndex];</span>
<a href="#l1.7708"></a><span id="l1.7708">     // If the thread is bigger than the hdr cache, expanding the thread</span>
<a href="#l1.7709"></a><span id="l1.7709">     // can be slow. Increasing the hdr cache size will help a fair amount.</span>
<a href="#l1.7710"></a><span id="l1.7710">     uint32_t hdrCacheSize;</span>
<a href="#l1.7711"></a><span id="l1.7711">     m_db-&gt;GetMsgHdrCacheSize(&amp;hdrCacheSize);</span>
<a href="#l1.7712"></a><span id="l1.7712" class="difflineminus">-    if (numChildren &gt; hdrCacheSize)</span>
<a href="#l1.7713"></a><span id="l1.7713" class="difflineminus">-      m_db-&gt;SetMsgHdrCacheSize(numChildren);</span>
<a href="#l1.7714"></a><span id="l1.7714" class="difflineplus">+    if (numChildren &gt; hdrCacheSize) m_db-&gt;SetMsgHdrCacheSize(numChildren);</span>
<a href="#l1.7715"></a><span id="l1.7715"> </span>
<a href="#l1.7716"></a><span id="l1.7716">     // If this fails, *pNumListed will be 0, and we'll fall back to just</span>
<a href="#l1.7717"></a><span id="l1.7717">     // enumerating the messages in the thread below.</span>
<a href="#l1.7718"></a><span id="l1.7718">     rv = ListIdsInThreadOrder(threadHdr, parentKey, 1, &amp;viewIndex, pNumListed);</span>
<a href="#l1.7719"></a><span id="l1.7719" class="difflineminus">-    if (numChildren &gt; hdrCacheSize)</span>
<a href="#l1.7720"></a><span id="l1.7720" class="difflineminus">-      m_db-&gt;SetMsgHdrCacheSize(hdrCacheSize);</span>
<a href="#l1.7721"></a><span id="l1.7721" class="difflineminus">-  }</span>
<a href="#l1.7722"></a><span id="l1.7722" class="difflineminus">-</span>
<a href="#l1.7723"></a><span id="l1.7723" class="difflineminus">-  if (! *pNumListed)</span>
<a href="#l1.7724"></a><span id="l1.7724" class="difflineminus">-  {</span>
<a href="#l1.7725"></a><span id="l1.7725" class="difflineplus">+    if (numChildren &gt; hdrCacheSize) m_db-&gt;SetMsgHdrCacheSize(hdrCacheSize);</span>
<a href="#l1.7726"></a><span id="l1.7726" class="difflineplus">+  }</span>
<a href="#l1.7727"></a><span id="l1.7727" class="difflineplus">+</span>
<a href="#l1.7728"></a><span id="l1.7728" class="difflineplus">+  if (!*pNumListed) {</span>
<a href="#l1.7729"></a><span id="l1.7729">     uint32_t ignoredHeaders = 0;</span>
<a href="#l1.7730"></a><span id="l1.7730">     // If we're not threaded, just list em out in db order.</span>
<a href="#l1.7731"></a><span id="l1.7731" class="difflineminus">-    for (i = 1; i &lt;= numChildren; i++)</span>
<a href="#l1.7732"></a><span id="l1.7732" class="difflineminus">-    {</span>
<a href="#l1.7733"></a><span id="l1.7733" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7734"></a><span id="l1.7734" class="difflineplus">+    for (i = 1; i &lt;= numChildren; i++) {</span>
<a href="#l1.7735"></a><span id="l1.7735" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.7736"></a><span id="l1.7736">       threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.7737"></a><span id="l1.7737"> </span>
<a href="#l1.7738"></a><span id="l1.7738" class="difflineminus">-      if (msgHdr != nullptr)</span>
<a href="#l1.7739"></a><span id="l1.7739" class="difflineminus">-      {</span>
<a href="#l1.7740"></a><span id="l1.7740" class="difflineminus">-        if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l1.7741"></a><span id="l1.7741" class="difflineminus">-        {</span>
<a href="#l1.7742"></a><span id="l1.7742" class="difflineplus">+      if (msgHdr != nullptr) {</span>
<a href="#l1.7743"></a><span id="l1.7743" class="difflineplus">+        if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored)) {</span>
<a href="#l1.7744"></a><span id="l1.7744">           bool killed;</span>
<a href="#l1.7745"></a><span id="l1.7745">           msgHdr-&gt;GetIsKilled(&amp;killed);</span>
<a href="#l1.7746"></a><span id="l1.7746" class="difflineminus">-          if (killed)</span>
<a href="#l1.7747"></a><span id="l1.7747" class="difflineminus">-          {</span>
<a href="#l1.7748"></a><span id="l1.7748" class="difflineplus">+          if (killed) {</span>
<a href="#l1.7749"></a><span id="l1.7749">             ignoredHeaders++;</span>
<a href="#l1.7750"></a><span id="l1.7750">             continue;</span>
<a href="#l1.7751"></a><span id="l1.7751">           }</span>
<a href="#l1.7752"></a><span id="l1.7752">         }</span>
<a href="#l1.7753"></a><span id="l1.7753"> </span>
<a href="#l1.7754"></a><span id="l1.7754">         nsMsgKey msgKey;</span>
<a href="#l1.7755"></a><span id="l1.7755">         uint32_t msgFlags, newFlags;</span>
<a href="#l1.7756"></a><span id="l1.7756">         msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7757"></a><span id="l1.7757">         msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.7758"></a><span id="l1.7758">         AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.7759"></a><span id="l1.7759">         SetMsgHdrAt(msgHdr, viewIndex, msgKey, msgFlags &amp; ~MSG_VIEW_FLAGS, 1);</span>
<a href="#l1.7760"></a><span id="l1.7760">         // Here, we're either flat, or we're grouped - in either case,</span>
<a href="#l1.7761"></a><span id="l1.7761">         // level is 1. Turn off thread or elided bit if they got turned on</span>
<a href="#l1.7762"></a><span id="l1.7762">         // (maybe from new only view?).</span>
<a href="#l1.7763"></a><span id="l1.7763">         if (i &gt; 0)</span>
<a href="#l1.7764"></a><span id="l1.7764" class="difflineminus">-          msgHdr-&gt;AndFlags(~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided),</span>
<a href="#l1.7765"></a><span id="l1.7765" class="difflineminus">-                           &amp;newFlags);</span>
<a href="#l1.7766"></a><span id="l1.7766" class="difflineplus">+          msgHdr-&gt;AndFlags(</span>
<a href="#l1.7767"></a><span id="l1.7767" class="difflineplus">+              ~(MSG_VIEW_FLAG_ISTHREAD | nsMsgMessageFlags::Elided), &amp;newFlags);</span>
<a href="#l1.7768"></a><span id="l1.7768"> </span>
<a href="#l1.7769"></a><span id="l1.7769">         (*pNumListed)++;</span>
<a href="#l1.7770"></a><span id="l1.7770">         viewIndex++;</span>
<a href="#l1.7771"></a><span id="l1.7771">       }</span>
<a href="#l1.7772"></a><span id="l1.7772">     }</span>
<a href="#l1.7773"></a><span id="l1.7773"> </span>
<a href="#l1.7774"></a><span id="l1.7774" class="difflineminus">-    if (ignoredHeaders + *pNumListed &lt; numChildren)</span>
<a href="#l1.7775"></a><span id="l1.7775" class="difflineminus">-    {</span>
<a href="#l1.7776"></a><span id="l1.7776" class="difflineplus">+    if (ignoredHeaders + *pNumListed &lt; numChildren) {</span>
<a href="#l1.7777"></a><span id="l1.7777">       MOZ_ASSERT_UNREACHABLE(&quot;thread corrupt in db&quot;);</span>
<a href="#l1.7778"></a><span id="l1.7778">       // If we've listed fewer messages than are in the thread, then the db</span>
<a href="#l1.7779"></a><span id="l1.7779">       // is corrupt, and we should invalidate it.</span>
<a href="#l1.7780"></a><span id="l1.7780">       // We'll use this rv to indicate there's something wrong with the db</span>
<a href="#l1.7781"></a><span id="l1.7781">       // though for now it probably won't get paid attention to.</span>
<a href="#l1.7782"></a><span id="l1.7782">       m_db-&gt;SetSummaryValid(false);</span>
<a href="#l1.7783"></a><span id="l1.7783">       rv = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l1.7784"></a><span id="l1.7784">     }</span>
<a href="#l1.7785"></a><span id="l1.7785" class="difflineat">@@ -6522,68 +5654,58 @@ nsMsgDBView::ListIdsInThread(nsIMsgThrea</span>
<a href="#l1.7786"></a><span id="l1.7786">   // We may have added too many elements (i.e., subthreads were cut).</span>
<a href="#l1.7787"></a><span id="l1.7787">   // XXX Fix for cross folder view case.</span>
<a href="#l1.7788"></a><span id="l1.7788">   if (*pNumListed &lt; numChildren)</span>
<a href="#l1.7789"></a><span id="l1.7789">     RemoveRows(viewIndex, numChildren - *pNumListed);</span>
<a href="#l1.7790"></a><span id="l1.7790"> </span>
<a href="#l1.7791"></a><span id="l1.7791">   return rv;</span>
<a href="#l1.7792"></a><span id="l1.7792"> }</span>
<a href="#l1.7793"></a><span id="l1.7793"> </span>
<a href="#l1.7794"></a><span id="l1.7794" class="difflineminus">-int32_t</span>
<a href="#l1.7795"></a><span id="l1.7795" class="difflineminus">-nsMsgDBView::FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7796"></a><span id="l1.7796" class="difflineminus">-                               nsMsgViewIndex startOfThread,</span>
<a href="#l1.7797"></a><span id="l1.7797" class="difflineminus">-                               nsMsgViewIndex viewIndex)</span>
<a href="#l1.7798"></a><span id="l1.7798" class="difflineminus">-{</span>
<a href="#l1.7799"></a><span id="l1.7799" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; curMsgHdr = msgHdr;</span>
<a href="#l1.7800"></a><span id="l1.7800" class="difflineplus">+int32_t nsMsgDBView::FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.7801"></a><span id="l1.7801" class="difflineplus">+                                       nsMsgViewIndex startOfThread,</span>
<a href="#l1.7802"></a><span id="l1.7802" class="difflineplus">+                                       nsMsgViewIndex viewIndex) {</span>
<a href="#l1.7803"></a><span id="l1.7803" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; curMsgHdr = msgHdr;</span>
<a href="#l1.7804"></a><span id="l1.7804">   nsMsgKey msgKey;</span>
<a href="#l1.7805"></a><span id="l1.7805">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7806"></a><span id="l1.7806"> </span>
<a href="#l1.7807"></a><span id="l1.7807">   // Look through the ancestors of the passed in msgHdr in turn, looking for</span>
<a href="#l1.7808"></a><span id="l1.7808">   // them in the view, up to the start of the thread. If we find an ancestor,</span>
<a href="#l1.7809"></a><span id="l1.7809">   // then our level is one greater than the level of the ancestor.</span>
<a href="#l1.7810"></a><span id="l1.7810" class="difflineminus">-  while (curMsgHdr)</span>
<a href="#l1.7811"></a><span id="l1.7811" class="difflineminus">-  {</span>
<a href="#l1.7812"></a><span id="l1.7812" class="difflineplus">+  while (curMsgHdr) {</span>
<a href="#l1.7813"></a><span id="l1.7813">     nsMsgKey parentKey;</span>
<a href="#l1.7814"></a><span id="l1.7814">     curMsgHdr-&gt;GetThreadParent(&amp;parentKey);</span>
<a href="#l1.7815"></a><span id="l1.7815" class="difflineminus">-    if (parentKey == nsMsgKey_None)</span>
<a href="#l1.7816"></a><span id="l1.7816" class="difflineminus">-      break;</span>
<a href="#l1.7817"></a><span id="l1.7817" class="difflineplus">+    if (parentKey == nsMsgKey_None) break;</span>
<a href="#l1.7818"></a><span id="l1.7818"> </span>
<a href="#l1.7819"></a><span id="l1.7819">     // Scan up to find view index of ancestor, if any.</span>
<a href="#l1.7820"></a><span id="l1.7820">     for (nsMsgViewIndex indexToTry = viewIndex;</span>
<a href="#l1.7821"></a><span id="l1.7821" class="difflineminus">-         indexToTry &amp;&amp; indexToTry-- &gt;= startOfThread; )</span>
<a href="#l1.7822"></a><span id="l1.7822" class="difflineminus">-    {</span>
<a href="#l1.7823"></a><span id="l1.7823" class="difflineminus">-      if (m_keys[indexToTry] == parentKey)</span>
<a href="#l1.7824"></a><span id="l1.7824" class="difflineminus">-        return m_levels[indexToTry] + 1;</span>
<a href="#l1.7825"></a><span id="l1.7825" class="difflineplus">+         indexToTry &amp;&amp; indexToTry-- &gt;= startOfThread;) {</span>
<a href="#l1.7826"></a><span id="l1.7826" class="difflineplus">+      if (m_keys[indexToTry] == parentKey) return m_levels[indexToTry] + 1;</span>
<a href="#l1.7827"></a><span id="l1.7827">     }</span>
<a href="#l1.7828"></a><span id="l1.7828"> </span>
<a href="#l1.7829"></a><span id="l1.7829">     // If msgHdr's key is its parentKey, we'll loop forever, so protect</span>
<a href="#l1.7830"></a><span id="l1.7830">     // against that corruption.</span>
<a href="#l1.7831"></a><span id="l1.7831" class="difflineminus">-    if (msgKey == parentKey ||</span>
<a href="#l1.7832"></a><span id="l1.7832" class="difflineminus">-        NS_FAILED(m_db-&gt;GetMsgHdrForKey(parentKey, getter_AddRefs(curMsgHdr))))</span>
<a href="#l1.7833"></a><span id="l1.7833" class="difflineminus">-    {</span>
<a href="#l1.7834"></a><span id="l1.7834" class="difflineminus">-      NS_ERROR(&quot;msgKey == parentKey, or GetMsgHdrForKey failed, this used to be an infinite loop condition&quot;);</span>
<a href="#l1.7835"></a><span id="l1.7835" class="difflineplus">+    if (msgKey == parentKey || NS_FAILED(m_db-&gt;GetMsgHdrForKey(</span>
<a href="#l1.7836"></a><span id="l1.7836" class="difflineplus">+                                   parentKey, getter_AddRefs(curMsgHdr)))) {</span>
<a href="#l1.7837"></a><span id="l1.7837" class="difflineplus">+      NS_ERROR(</span>
<a href="#l1.7838"></a><span id="l1.7838" class="difflineplus">+          &quot;msgKey == parentKey, or GetMsgHdrForKey failed, this used to be an &quot;</span>
<a href="#l1.7839"></a><span id="l1.7839" class="difflineplus">+          &quot;infinite loop condition&quot;);</span>
<a href="#l1.7840"></a><span id="l1.7840">       curMsgHdr = nullptr;</span>
<a href="#l1.7841"></a><span id="l1.7841" class="difflineminus">-    }</span>
<a href="#l1.7842"></a><span id="l1.7842" class="difflineminus">-    else</span>
<a href="#l1.7843"></a><span id="l1.7843" class="difflineminus">-    {</span>
<a href="#l1.7844"></a><span id="l1.7844" class="difflineplus">+    } else {</span>
<a href="#l1.7845"></a><span id="l1.7845">       // Need to update msgKey so the check for a msgHdr with matching</span>
<a href="#l1.7846"></a><span id="l1.7846">       // key+parentKey will work after first time through loop.</span>
<a href="#l1.7847"></a><span id="l1.7847">       curMsgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.7848"></a><span id="l1.7848">     }</span>
<a href="#l1.7849"></a><span id="l1.7849">   }</span>
<a href="#l1.7850"></a><span id="l1.7850"> </span>
<a href="#l1.7851"></a><span id="l1.7851">   return 1;</span>
<a href="#l1.7852"></a><span id="l1.7852"> }</span>
<a href="#l1.7853"></a><span id="l1.7853"> </span>
<a href="#l1.7854"></a><span id="l1.7854"> // XXX Can this be combined with GetIndexForThread??</span>
<a href="#l1.7855"></a><span id="l1.7855" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.7856"></a><span id="l1.7856" class="difflineminus">-nsMsgDBView::GetThreadRootIndex(nsIMsgDBHdr *msgHdr)</span>
<a href="#l1.7857"></a><span id="l1.7857" class="difflineminus">-{</span>
<a href="#l1.7858"></a><span id="l1.7858" class="difflineminus">-  if (!msgHdr)</span>
<a href="#l1.7859"></a><span id="l1.7859" class="difflineminus">-  {</span>
<a href="#l1.7860"></a><span id="l1.7860" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetThreadRootIndex(nsIMsgDBHdr *msgHdr) {</span>
<a href="#l1.7861"></a><span id="l1.7861" class="difflineplus">+  if (!msgHdr) {</span>
<a href="#l1.7862"></a><span id="l1.7862">     NS_WARNING(&quot;null msgHdr parameter&quot;);</span>
<a href="#l1.7863"></a><span id="l1.7863">     return nsMsgViewIndex_None;</span>
<a href="#l1.7864"></a><span id="l1.7864">   }</span>
<a href="#l1.7865"></a><span id="l1.7865"> </span>
<a href="#l1.7866"></a><span id="l1.7866">   // Take advantage of the fact that we're already sorted</span>
<a href="#l1.7867"></a><span id="l1.7867">   // and find the thread root via a binary search.</span>
<a href="#l1.7868"></a><span id="l1.7868"> </span>
<a href="#l1.7869"></a><span id="l1.7869">   nsMsgViewIndex highIndex = m_keys.Length();</span>
<a href="#l1.7870"></a><span id="l1.7870" class="difflineat">@@ -6594,17 +5716,17 @@ nsMsgDBView::GetThreadRootIndex(nsIMsgDB</span>
<a href="#l1.7871"></a><span id="l1.7871"> </span>
<a href="#l1.7872"></a><span id="l1.7872">   nsresult rv;</span>
<a href="#l1.7873"></a><span id="l1.7873">   uint16_t maxLen;</span>
<a href="#l1.7874"></a><span id="l1.7874">   eFieldType fieldType;</span>
<a href="#l1.7875"></a><span id="l1.7875"> </span>
<a href="#l1.7876"></a><span id="l1.7876">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.7877"></a><span id="l1.7877">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.7878"></a><span id="l1.7878">   // GetCollationKey or GetLongField.</span>
<a href="#l1.7879"></a><span id="l1.7879" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.7880"></a><span id="l1.7880" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.7881"></a><span id="l1.7881"> </span>
<a href="#l1.7882"></a><span id="l1.7882">   // The following may leave fieldType undefined.</span>
<a href="#l1.7883"></a><span id="l1.7883">   // In this case, we can return highIndex right away since</span>
<a href="#l1.7884"></a><span id="l1.7884">   // it is the value returned in the default case of</span>
<a href="#l1.7885"></a><span id="l1.7885">   // switch (fieldType) statement below.</span>
<a href="#l1.7886"></a><span id="l1.7886">   rv = GetFieldTypeAndLenForSort(m_sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.7887"></a><span id="l1.7887">   NS_ENSURE_SUCCESS(rv, highIndex);</span>
<a href="#l1.7888"></a><span id="l1.7888"> </span>
<a href="#l1.7889"></a><span id="l1.7889" class="difflineat">@@ -6613,707 +5735,610 @@ nsMsgDBView::GetThreadRootIndex(nsIMsgDB</span>
<a href="#l1.7890"></a><span id="l1.7890">   int retStatus = 0;</span>
<a href="#l1.7891"></a><span id="l1.7891">   msgHdr-&gt;GetMessageKey(&amp;EntryInfo1.id);</span>
<a href="#l1.7892"></a><span id="l1.7892">   msgHdr-&gt;GetFolder(&amp;EntryInfo1.folder);</span>
<a href="#l1.7893"></a><span id="l1.7893">   EntryInfo1.folder-&gt;Release();</span>
<a href="#l1.7894"></a><span id="l1.7894"> </span>
<a href="#l1.7895"></a><span id="l1.7895">   viewSortInfo comparisonContext;</span>
<a href="#l1.7896"></a><span id="l1.7896">   comparisonContext.view = this;</span>
<a href="#l1.7897"></a><span id="l1.7897">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.7898"></a><span id="l1.7898" class="difflineminus">-  comparisonContext.ascendingSort = (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7899"></a><span id="l1.7899" class="difflineplus">+  comparisonContext.ascendingSort =</span>
<a href="#l1.7900"></a><span id="l1.7900" class="difflineplus">+      (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.7901"></a><span id="l1.7901">   nsCOMPtr&lt;nsIMsgDatabase&gt; hdrDB;</span>
<a href="#l1.7902"></a><span id="l1.7902">   EntryInfo1.folder-&gt;GetMsgDatabase(getter_AddRefs(hdrDB));</span>
<a href="#l1.7903"></a><span id="l1.7903">   comparisonContext.db = hdrDB.get();</span>
<a href="#l1.7904"></a><span id="l1.7904"> </span>
<a href="#l1.7905"></a><span id="l1.7905" class="difflineminus">-  switch (fieldType)</span>
<a href="#l1.7906"></a><span id="l1.7906" class="difflineminus">-  {</span>
<a href="#l1.7907"></a><span id="l1.7907" class="difflineplus">+  switch (fieldType) {</span>
<a href="#l1.7908"></a><span id="l1.7908">     case kCollationKey:</span>
<a href="#l1.7909"></a><span id="l1.7909" class="difflineminus">-      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7910"></a><span id="l1.7910" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7911"></a><span id="l1.7911" class="difflineplus">+      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo1.key,</span>
<a href="#l1.7912"></a><span id="l1.7912" class="difflineplus">+                           &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7913"></a><span id="l1.7913" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7914"></a><span id="l1.7914">       break;</span>
<a href="#l1.7915"></a><span id="l1.7915">     case kU32:</span>
<a href="#l1.7916"></a><span id="l1.7916">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7917"></a><span id="l1.7917">         EntryInfo1.dword = EntryInfo1.id;</span>
<a href="#l1.7918"></a><span id="l1.7918">       else</span>
<a href="#l1.7919"></a><span id="l1.7919">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo1.dword, colHandler);</span>
<a href="#l1.7920"></a><span id="l1.7920"> </span>
<a href="#l1.7921"></a><span id="l1.7921">       break;</span>
<a href="#l1.7922"></a><span id="l1.7922">     default:</span>
<a href="#l1.7923"></a><span id="l1.7923">       return highIndex;</span>
<a href="#l1.7924"></a><span id="l1.7924">   }</span>
<a href="#l1.7925"></a><span id="l1.7925"> </span>
<a href="#l1.7926"></a><span id="l1.7926" class="difflineminus">-  while (highIndex &gt; lowIndex)</span>
<a href="#l1.7927"></a><span id="l1.7927" class="difflineminus">-  {</span>
<a href="#l1.7928"></a><span id="l1.7928" class="difflineplus">+  while (highIndex &gt; lowIndex) {</span>
<a href="#l1.7929"></a><span id="l1.7929">     nsMsgViewIndex tryIndex = (lowIndex + highIndex) / 2;</span>
<a href="#l1.7930"></a><span id="l1.7930">     // Need to adjust tryIndex if it's not a thread.</span>
<a href="#l1.7931"></a><span id="l1.7931" class="difflineminus">-    while (m_levels[tryIndex] &amp;&amp; tryIndex)</span>
<a href="#l1.7932"></a><span id="l1.7932" class="difflineminus">-      tryIndex--;</span>
<a href="#l1.7933"></a><span id="l1.7933" class="difflineminus">-</span>
<a href="#l1.7934"></a><span id="l1.7934" class="difflineminus">-    if (tryIndex &lt; lowIndex)</span>
<a href="#l1.7935"></a><span id="l1.7935" class="difflineminus">-    {</span>
<a href="#l1.7936"></a><span id="l1.7936" class="difflineplus">+    while (m_levels[tryIndex] &amp;&amp; tryIndex) tryIndex--;</span>
<a href="#l1.7937"></a><span id="l1.7937" class="difflineplus">+</span>
<a href="#l1.7938"></a><span id="l1.7938" class="difflineplus">+    if (tryIndex &lt; lowIndex) {</span>
<a href="#l1.7939"></a><span id="l1.7939">       NS_ERROR(&quot;try index shouldn't be less than low index&quot;);</span>
<a href="#l1.7940"></a><span id="l1.7940">       break;</span>
<a href="#l1.7941"></a><span id="l1.7941">     }</span>
<a href="#l1.7942"></a><span id="l1.7942"> </span>
<a href="#l1.7943"></a><span id="l1.7943">     EntryInfo2.id = m_keys[tryIndex];</span>
<a href="#l1.7944"></a><span id="l1.7944">     GetFolderForViewIndex(tryIndex, &amp;EntryInfo2.folder);</span>
<a href="#l1.7945"></a><span id="l1.7945">     EntryInfo2.folder-&gt;Release();</span>
<a href="#l1.7946"></a><span id="l1.7946"> </span>
<a href="#l1.7947"></a><span id="l1.7947">     nsCOMPtr&lt;nsIMsgDBHdr&gt; tryHdr;</span>
<a href="#l1.7948"></a><span id="l1.7948">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.7949"></a><span id="l1.7949">     // ### this should get the db from the folder...</span>
<a href="#l1.7950"></a><span id="l1.7950">     GetDBForViewIndex(tryIndex, getter_AddRefs(db));</span>
<a href="#l1.7951"></a><span id="l1.7951" class="difflineminus">-    if (db)</span>
<a href="#l1.7952"></a><span id="l1.7952" class="difflineminus">-      rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7953"></a><span id="l1.7953" class="difflineminus">-</span>
<a href="#l1.7954"></a><span id="l1.7954" class="difflineminus">-    if (!tryHdr)</span>
<a href="#l1.7955"></a><span id="l1.7955" class="difflineminus">-      break;</span>
<a href="#l1.7956"></a><span id="l1.7956" class="difflineminus">-</span>
<a href="#l1.7957"></a><span id="l1.7957" class="difflineminus">-    if (tryHdr == msgHdr)</span>
<a href="#l1.7958"></a><span id="l1.7958" class="difflineminus">-    {</span>
<a href="#l1.7959"></a><span id="l1.7959" class="difflineplus">+    if (db) rv = db-&gt;GetMsgHdrForKey(EntryInfo2.id, getter_AddRefs(tryHdr));</span>
<a href="#l1.7960"></a><span id="l1.7960" class="difflineplus">+</span>
<a href="#l1.7961"></a><span id="l1.7961" class="difflineplus">+    if (!tryHdr) break;</span>
<a href="#l1.7962"></a><span id="l1.7962" class="difflineplus">+</span>
<a href="#l1.7963"></a><span id="l1.7963" class="difflineplus">+    if (tryHdr == msgHdr) {</span>
<a href="#l1.7964"></a><span id="l1.7964">       highIndex = tryIndex;</span>
<a href="#l1.7965"></a><span id="l1.7965">       break;</span>
<a href="#l1.7966"></a><span id="l1.7966">     }</span>
<a href="#l1.7967"></a><span id="l1.7967"> </span>
<a href="#l1.7968"></a><span id="l1.7968" class="difflineminus">-    if (fieldType == kCollationKey)</span>
<a href="#l1.7969"></a><span id="l1.7969" class="difflineminus">-    {</span>
<a href="#l1.7970"></a><span id="l1.7970" class="difflineplus">+    if (fieldType == kCollationKey) {</span>
<a href="#l1.7971"></a><span id="l1.7971">       PR_FREEIF(EntryInfo2.key);</span>
<a href="#l1.7972"></a><span id="l1.7972" class="difflineminus">-      rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7973"></a><span id="l1.7973" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.7974"></a><span id="l1.7974" class="difflineplus">+      rv = GetCollationKey(tryHdr, m_sortType, &amp;EntryInfo2.key,</span>
<a href="#l1.7975"></a><span id="l1.7975" class="difflineplus">+                           &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7976"></a><span id="l1.7976" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.7977"></a><span id="l1.7977">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7978"></a><span id="l1.7978" class="difflineminus">-    }</span>
<a href="#l1.7979"></a><span id="l1.7979" class="difflineminus">-    else if (fieldType == kU32)</span>
<a href="#l1.7980"></a><span id="l1.7980" class="difflineminus">-    {</span>
<a href="#l1.7981"></a><span id="l1.7981" class="difflineplus">+    } else if (fieldType == kU32) {</span>
<a href="#l1.7982"></a><span id="l1.7982">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.7983"></a><span id="l1.7983">         EntryInfo2.dword = EntryInfo2.id;</span>
<a href="#l1.7984"></a><span id="l1.7984">       else</span>
<a href="#l1.7985"></a><span id="l1.7985">         GetLongField(tryHdr, m_sortType, &amp;EntryInfo2.dword, colHandler);</span>
<a href="#l1.7986"></a><span id="l1.7986"> </span>
<a href="#l1.7987"></a><span id="l1.7987">       retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.7988"></a><span id="l1.7988">     }</span>
<a href="#l1.7989"></a><span id="l1.7989"> </span>
<a href="#l1.7990"></a><span id="l1.7990" class="difflineminus">-    if (retStatus == 0)</span>
<a href="#l1.7991"></a><span id="l1.7991" class="difflineminus">-    {</span>
<a href="#l1.7992"></a><span id="l1.7992" class="difflineplus">+    if (retStatus == 0) {</span>
<a href="#l1.7993"></a><span id="l1.7993">       highIndex = tryIndex;</span>
<a href="#l1.7994"></a><span id="l1.7994">       break;</span>
<a href="#l1.7995"></a><span id="l1.7995">     }</span>
<a href="#l1.7996"></a><span id="l1.7996"> </span>
<a href="#l1.7997"></a><span id="l1.7997" class="difflineminus">-    if (retStatus &lt; 0)</span>
<a href="#l1.7998"></a><span id="l1.7998" class="difflineminus">-    {</span>
<a href="#l1.7999"></a><span id="l1.7999" class="difflineplus">+    if (retStatus &lt; 0) {</span>
<a href="#l1.8000"></a><span id="l1.8000">       highIndex = tryIndex;</span>
<a href="#l1.8001"></a><span id="l1.8001">       // We already made sure tryIndex was at a thread at the top of the loop.</span>
<a href="#l1.8002"></a><span id="l1.8002" class="difflineminus">-    }</span>
<a href="#l1.8003"></a><span id="l1.8003" class="difflineminus">-    else</span>
<a href="#l1.8004"></a><span id="l1.8004" class="difflineminus">-    {</span>
<a href="#l1.8005"></a><span id="l1.8005" class="difflineplus">+    } else {</span>
<a href="#l1.8006"></a><span id="l1.8006">       lowIndex = tryIndex + 1;</span>
<a href="#l1.8007"></a><span id="l1.8007" class="difflineminus">-      while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex])</span>
<a href="#l1.8008"></a><span id="l1.8008" class="difflineminus">-        lowIndex++;</span>
<a href="#l1.8009"></a><span id="l1.8009" class="difflineplus">+      while (lowIndex &lt; GetSize() &amp;&amp; m_levels[lowIndex]) lowIndex++;</span>
<a href="#l1.8010"></a><span id="l1.8010">     }</span>
<a href="#l1.8011"></a><span id="l1.8011">   }</span>
<a href="#l1.8012"></a><span id="l1.8012"> </span>
<a href="#l1.8013"></a><span id="l1.8013">   nsCOMPtr&lt;nsIMsgDBHdr&gt; resultHdr;</span>
<a href="#l1.8014"></a><span id="l1.8014">   GetMsgHdrForViewIndex(highIndex, getter_AddRefs(resultHdr));</span>
<a href="#l1.8015"></a><span id="l1.8015"> </span>
<a href="#l1.8016"></a><span id="l1.8016" class="difflineminus">-  if (resultHdr != msgHdr)</span>
<a href="#l1.8017"></a><span id="l1.8017" class="difflineminus">-  {</span>
<a href="#l1.8018"></a><span id="l1.8018" class="difflineplus">+  if (resultHdr != msgHdr) {</span>
<a href="#l1.8019"></a><span id="l1.8019">     NS_WARNING(&quot;didn't find hdr&quot;);</span>
<a href="#l1.8020"></a><span id="l1.8020">     highIndex = FindHdr(msgHdr);</span>
<a href="#l1.8021"></a><span id="l1.8021"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.8022"></a><span id="l1.8022" class="difflineminus">-    if (highIndex != nsMsgViewIndex_None)</span>
<a href="#l1.8023"></a><span id="l1.8023" class="difflineminus">-    {</span>
<a href="#l1.8024"></a><span id="l1.8024" class="difflineplus">+    if (highIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.8025"></a><span id="l1.8025">       NS_WARNING(&quot;but find hdr did&quot;);</span>
<a href="#l1.8026"></a><span id="l1.8026">       printf(&quot;level of found hdr = %d\n&quot;, m_levels[highIndex]);</span>
<a href="#l1.8027"></a><span id="l1.8027">       ValidateSort();</span>
<a href="#l1.8028"></a><span id="l1.8028">     }</span>
<a href="#l1.8029"></a><span id="l1.8029"> #endif</span>
<a href="#l1.8030"></a><span id="l1.8030">     return highIndex;</span>
<a href="#l1.8031"></a><span id="l1.8031">   }</span>
<a href="#l1.8032"></a><span id="l1.8032"> </span>
<a href="#l1.8033"></a><span id="l1.8033">   PR_Free(EntryInfo1.key);</span>
<a href="#l1.8034"></a><span id="l1.8034">   PR_Free(EntryInfo2.key);</span>
<a href="#l1.8035"></a><span id="l1.8035">   return msgHdr == resultHdr ? highIndex : nsMsgViewIndex_None;</span>
<a href="#l1.8036"></a><span id="l1.8036"> }</span>
<a href="#l1.8037"></a><span id="l1.8037"> </span>
<a href="#l1.8038"></a><span id="l1.8038"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.8039"></a><span id="l1.8039"> </span>
<a href="#l1.8040"></a><span id="l1.8040" class="difflineminus">-void</span>
<a href="#l1.8041"></a><span id="l1.8041" class="difflineminus">-nsMsgDBView::InitEntryInfoForIndex(nsMsgViewIndex i,</span>
<a href="#l1.8042"></a><span id="l1.8042" class="difflineminus">-                                   IdKeyPtr &amp;EntryInfo)</span>
<a href="#l1.8043"></a><span id="l1.8043" class="difflineminus">-{</span>
<a href="#l1.8044"></a><span id="l1.8044" class="difflineplus">+void nsMsgDBView::InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo) {</span>
<a href="#l1.8045"></a><span id="l1.8045">   EntryInfo.key = nullptr;</span>
<a href="#l1.8046"></a><span id="l1.8046"> </span>
<a href="#l1.8047"></a><span id="l1.8047">   nsresult rv;</span>
<a href="#l1.8048"></a><span id="l1.8048">   uint16_t maxLen;</span>
<a href="#l1.8049"></a><span id="l1.8049">   eFieldType fieldType;</span>
<a href="#l1.8050"></a><span id="l1.8050"> </span>
<a href="#l1.8051"></a><span id="l1.8051">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.8052"></a><span id="l1.8052">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.8053"></a><span id="l1.8053">   // GetCollationKey or GetLongField.</span>
<a href="#l1.8054"></a><span id="l1.8054" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.8055"></a><span id="l1.8055" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.8056"></a><span id="l1.8056"> </span>
<a href="#l1.8057"></a><span id="l1.8057">   // The following may leave fieldType undefined.</span>
<a href="#l1.8058"></a><span id="l1.8058">   rv = GetFieldTypeAndLenForSort(m_sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.8059"></a><span id="l1.8059" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to obtain fieldType&quot;);</span>
<a href="#l1.8060"></a><span id="l1.8060" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to obtain fieldType&quot;);</span>
<a href="#l1.8061"></a><span id="l1.8061"> </span>
<a href="#l1.8062"></a><span id="l1.8062">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8063"></a><span id="l1.8063">   GetMsgHdrForViewIndex(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.8064"></a><span id="l1.8064"> </span>
<a href="#l1.8065"></a><span id="l1.8065">   msgHdr-&gt;GetMessageKey(&amp;EntryInfo.id);</span>
<a href="#l1.8066"></a><span id="l1.8066">   msgHdr-&gt;GetFolder(&amp;EntryInfo.folder);</span>
<a href="#l1.8067"></a><span id="l1.8067">   EntryInfo.folder-&gt;Release();</span>
<a href="#l1.8068"></a><span id="l1.8068"> </span>
<a href="#l1.8069"></a><span id="l1.8069">   nsCOMPtr&lt;nsIMsgDatabase&gt; hdrDB;</span>
<a href="#l1.8070"></a><span id="l1.8070">   EntryInfo.folder-&gt;GetMsgDatabase(getter_AddRefs(hdrDB));</span>
<a href="#l1.8071"></a><span id="l1.8071" class="difflineminus">-  switch (fieldType)</span>
<a href="#l1.8072"></a><span id="l1.8072" class="difflineminus">-  {</span>
<a href="#l1.8073"></a><span id="l1.8073" class="difflineplus">+  switch (fieldType) {</span>
<a href="#l1.8074"></a><span id="l1.8074">     case kCollationKey:</span>
<a href="#l1.8075"></a><span id="l1.8075">       PR_FREEIF(EntryInfo.key);</span>
<a href="#l1.8076"></a><span id="l1.8076" class="difflineminus">-      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo.key, &amp;EntryInfo.dword, colHandler);</span>
<a href="#l1.8077"></a><span id="l1.8077" class="difflineminus">-      NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to create collation key&quot;);</span>
<a href="#l1.8078"></a><span id="l1.8078" class="difflineplus">+      rv = GetCollationKey(msgHdr, m_sortType, &amp;EntryInfo.key, &amp;EntryInfo.dword,</span>
<a href="#l1.8079"></a><span id="l1.8079" class="difflineplus">+                           colHandler);</span>
<a href="#l1.8080"></a><span id="l1.8080" class="difflineplus">+      NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to create collation key&quot;);</span>
<a href="#l1.8081"></a><span id="l1.8081">       break;</span>
<a href="#l1.8082"></a><span id="l1.8082">     case kU32:</span>
<a href="#l1.8083"></a><span id="l1.8083">       if (m_sortType == nsMsgViewSortType::byId)</span>
<a href="#l1.8084"></a><span id="l1.8084">         EntryInfo.dword = EntryInfo.id;</span>
<a href="#l1.8085"></a><span id="l1.8085">       else</span>
<a href="#l1.8086"></a><span id="l1.8086">         GetLongField(msgHdr, m_sortType, &amp;EntryInfo.dword, colHandler);</span>
<a href="#l1.8087"></a><span id="l1.8087"> </span>
<a href="#l1.8088"></a><span id="l1.8088">       break;</span>
<a href="#l1.8089"></a><span id="l1.8089">     default:</span>
<a href="#l1.8090"></a><span id="l1.8090">       NS_ERROR(&quot;invalid field type&quot;);</span>
<a href="#l1.8091"></a><span id="l1.8091">   }</span>
<a href="#l1.8092"></a><span id="l1.8092"> }</span>
<a href="#l1.8093"></a><span id="l1.8093"> </span>
<a href="#l1.8094"></a><span id="l1.8094" class="difflineminus">-void</span>
<a href="#l1.8095"></a><span id="l1.8095" class="difflineminus">-nsMsgDBView::ValidateSort()</span>
<a href="#l1.8096"></a><span id="l1.8096" class="difflineminus">-{</span>
<a href="#l1.8097"></a><span id="l1.8097" class="difflineplus">+void nsMsgDBView::ValidateSort() {</span>
<a href="#l1.8098"></a><span id="l1.8098">   IdKeyPtr EntryInfo1, EntryInfo2;</span>
<a href="#l1.8099"></a><span id="l1.8099">   nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr1, hdr2;</span>
<a href="#l1.8100"></a><span id="l1.8100"> </span>
<a href="#l1.8101"></a><span id="l1.8101" class="difflineminus">-  uint16_t  maxLen;</span>
<a href="#l1.8102"></a><span id="l1.8102" class="difflineplus">+  uint16_t maxLen;</span>
<a href="#l1.8103"></a><span id="l1.8103">   eFieldType fieldType;</span>
<a href="#l1.8104"></a><span id="l1.8104"> </span>
<a href="#l1.8105"></a><span id="l1.8105">   // Get the custom column handler for the primary sort and pass it first</span>
<a href="#l1.8106"></a><span id="l1.8106">   // to GetFieldTypeAndLenForSort to get the fieldType and then either</span>
<a href="#l1.8107"></a><span id="l1.8107">   // GetCollationKey or GetLongField.</span>
<a href="#l1.8108"></a><span id="l1.8108" class="difflineminus">-  nsIMsgCustomColumnHandler* colHandler = GetCurColumnHandler();</span>
<a href="#l1.8109"></a><span id="l1.8109" class="difflineplus">+  nsIMsgCustomColumnHandler *colHandler = GetCurColumnHandler();</span>
<a href="#l1.8110"></a><span id="l1.8110"> </span>
<a href="#l1.8111"></a><span id="l1.8111">   // It is not entirely clear what we should do since,</span>
<a href="#l1.8112"></a><span id="l1.8112">   // if fieldType is not available, there is no way to know</span>
<a href="#l1.8113"></a><span id="l1.8113">   // how to compare the field to check for sorting.</span>
<a href="#l1.8114"></a><span id="l1.8114">   // So we bomb out here. It is OK since this is debug code</span>
<a href="#l1.8115"></a><span id="l1.8115">   // inside  #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.8116"></a><span id="l1.8116">   rv = GetFieldTypeAndLenForSort(m_sortType, &amp;maxLen, &amp;fieldType, colHandler);</span>
<a href="#l1.8117"></a><span id="l1.8117" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(rv),&quot;failed to obtain fieldType&quot;);</span>
<a href="#l1.8118"></a><span id="l1.8118" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to obtain fieldType&quot;);</span>
<a href="#l1.8119"></a><span id="l1.8119"> </span>
<a href="#l1.8120"></a><span id="l1.8120">   viewSortInfo comparisonContext;</span>
<a href="#l1.8121"></a><span id="l1.8121">   comparisonContext.view = this;</span>
<a href="#l1.8122"></a><span id="l1.8122">   comparisonContext.isSecondarySort = false;</span>
<a href="#l1.8123"></a><span id="l1.8123" class="difflineminus">-  comparisonContext.ascendingSort = (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.8124"></a><span id="l1.8124" class="difflineplus">+  comparisonContext.ascendingSort =</span>
<a href="#l1.8125"></a><span id="l1.8125" class="difflineplus">+      (m_sortOrder == nsMsgViewSortOrder::ascending);</span>
<a href="#l1.8126"></a><span id="l1.8126">   nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8127"></a><span id="l1.8127">   GetDBForViewIndex(0, getter_AddRefs(db));</span>
<a href="#l1.8128"></a><span id="l1.8128">   // This is only for comparing collation keys - it could be any db.</span>
<a href="#l1.8129"></a><span id="l1.8129">   comparisonContext.db = db.get();</span>
<a href="#l1.8130"></a><span id="l1.8130"> </span>
<a href="#l1.8131"></a><span id="l1.8131" class="difflineminus">-  for (nsMsgViewIndex i = 0; i &lt; m_keys.Length();)</span>
<a href="#l1.8132"></a><span id="l1.8132" class="difflineminus">-  {</span>
<a href="#l1.8133"></a><span id="l1.8133" class="difflineplus">+  for (nsMsgViewIndex i = 0; i &lt; m_keys.Length();) {</span>
<a href="#l1.8134"></a><span id="l1.8134">     // Ignore non threads.</span>
<a href="#l1.8135"></a><span id="l1.8135" class="difflineminus">-    if (m_levels[i])</span>
<a href="#l1.8136"></a><span id="l1.8136" class="difflineminus">-    {</span>
<a href="#l1.8137"></a><span id="l1.8137" class="difflineplus">+    if (m_levels[i]) {</span>
<a href="#l1.8138"></a><span id="l1.8138">       i++;</span>
<a href="#l1.8139"></a><span id="l1.8139">       continue;</span>
<a href="#l1.8140"></a><span id="l1.8140">     }</span>
<a href="#l1.8141"></a><span id="l1.8141"> </span>
<a href="#l1.8142"></a><span id="l1.8142">     // Find next header.</span>
<a href="#l1.8143"></a><span id="l1.8143">     nsMsgViewIndex j = i + 1;</span>
<a href="#l1.8144"></a><span id="l1.8144" class="difflineminus">-    while (j &lt; m_keys.Length() &amp;&amp; m_levels[j])</span>
<a href="#l1.8145"></a><span id="l1.8145" class="difflineminus">-      j++;</span>
<a href="#l1.8146"></a><span id="l1.8146" class="difflineminus">-</span>
<a href="#l1.8147"></a><span id="l1.8147" class="difflineminus">-    if (j == m_keys.Length())</span>
<a href="#l1.8148"></a><span id="l1.8148" class="difflineminus">-      break;</span>
<a href="#l1.8149"></a><span id="l1.8149" class="difflineplus">+    while (j &lt; m_keys.Length() &amp;&amp; m_levels[j]) j++;</span>
<a href="#l1.8150"></a><span id="l1.8150" class="difflineplus">+</span>
<a href="#l1.8151"></a><span id="l1.8151" class="difflineplus">+    if (j == m_keys.Length()) break;</span>
<a href="#l1.8152"></a><span id="l1.8152"> </span>
<a href="#l1.8153"></a><span id="l1.8153">     InitEntryInfoForIndex(i, EntryInfo1);</span>
<a href="#l1.8154"></a><span id="l1.8154">     InitEntryInfoForIndex(j, EntryInfo2);</span>
<a href="#l1.8155"></a><span id="l1.8155">     const void *pValue1 = &amp;EntryInfo1, *pValue2 = &amp;EntryInfo2;</span>
<a href="#l1.8156"></a><span id="l1.8156">     int retStatus = 0;</span>
<a href="#l1.8157"></a><span id="l1.8157">     if (fieldType == kCollationKey)</span>
<a href="#l1.8158"></a><span id="l1.8158">       retStatus = FnSortIdKeyPtr(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.8159"></a><span id="l1.8159">     else if (fieldType == kU32)</span>
<a href="#l1.8160"></a><span id="l1.8160">       retStatus = FnSortIdUint32(&amp;pValue1, &amp;pValue2, &amp;comparisonContext);</span>
<a href="#l1.8161"></a><span id="l1.8161"> </span>
<a href="#l1.8162"></a><span id="l1.8162" class="difflineminus">-    if (retStatus &amp;&amp; (retStatus &lt; 0) == (m_sortOrder == nsMsgViewSortOrder::ascending))</span>
<a href="#l1.8163"></a><span id="l1.8163" class="difflineminus">-    {</span>
<a href="#l1.8164"></a><span id="l1.8164" class="difflineplus">+    if (retStatus &amp;&amp;</span>
<a href="#l1.8165"></a><span id="l1.8165" class="difflineplus">+        (retStatus &lt; 0) == (m_sortOrder == nsMsgViewSortOrder::ascending)) {</span>
<a href="#l1.8166"></a><span id="l1.8166">       NS_ERROR(&quot;view not sorted correctly&quot;);</span>
<a href="#l1.8167"></a><span id="l1.8167">       break;</span>
<a href="#l1.8168"></a><span id="l1.8168">     }</span>
<a href="#l1.8169"></a><span id="l1.8169">     // j is the new i.</span>
<a href="#l1.8170"></a><span id="l1.8170">     i = j;</span>
<a href="#l1.8171"></a><span id="l1.8171">   }</span>
<a href="#l1.8172"></a><span id="l1.8172"> }</span>
<a href="#l1.8173"></a><span id="l1.8173"> </span>
<a href="#l1.8174"></a><span id="l1.8174"> #endif</span>
<a href="#l1.8175"></a><span id="l1.8175"> </span>
<a href="#l1.8176"></a><span id="l1.8176" class="difflineminus">-nsresult</span>
<a href="#l1.8177"></a><span id="l1.8177" class="difflineminus">-nsMsgDBView::ListUnreadIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l1.8178"></a><span id="l1.8178" class="difflineminus">-                                   nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.8179"></a><span id="l1.8179" class="difflineminus">-                                   uint32_t *pNumListed)</span>
<a href="#l1.8180"></a><span id="l1.8180" class="difflineminus">-{</span>
<a href="#l1.8181"></a><span id="l1.8181" class="difflineplus">+nsresult nsMsgDBView::ListUnreadIdsInThread(</span>
<a href="#l1.8182"></a><span id="l1.8182" class="difflineplus">+    nsIMsgThread *threadHdr, nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l1.8183"></a><span id="l1.8183" class="difflineplus">+    uint32_t *pNumListed) {</span>
<a href="#l1.8184"></a><span id="l1.8184">   NS_ENSURE_ARG(threadHdr);</span>
<a href="#l1.8185"></a><span id="l1.8185">   // These children ids should be in thread order.</span>
<a href="#l1.8186"></a><span id="l1.8186">   nsMsgViewIndex viewIndex = startOfThreadViewIndex + 1;</span>
<a href="#l1.8187"></a><span id="l1.8187">   *pNumListed = 0;</span>
<a href="#l1.8188"></a><span id="l1.8188">   nsMsgKey topLevelMsgKey = m_keys[startOfThreadViewIndex];</span>
<a href="#l1.8189"></a><span id="l1.8189"> </span>
<a href="#l1.8190"></a><span id="l1.8190">   uint32_t numChildren;</span>
<a href="#l1.8191"></a><span id="l1.8191">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.8192"></a><span id="l1.8192">   uint32_t i;</span>
<a href="#l1.8193"></a><span id="l1.8193" class="difflineminus">-  for (i = 0; i &lt; numChildren; i++)</span>
<a href="#l1.8194"></a><span id="l1.8194" class="difflineminus">-  {</span>
<a href="#l1.8195"></a><span id="l1.8195" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8196"></a><span id="l1.8196" class="difflineplus">+  for (i = 0; i &lt; numChildren; i++) {</span>
<a href="#l1.8197"></a><span id="l1.8197" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8198"></a><span id="l1.8198">     threadHdr-&gt;GetChildHdrAt(i, getter_AddRefs(msgHdr));</span>
<a href="#l1.8199"></a><span id="l1.8199" class="difflineminus">-    if (msgHdr != nullptr)</span>
<a href="#l1.8200"></a><span id="l1.8200" class="difflineminus">-    {</span>
<a href="#l1.8201"></a><span id="l1.8201" class="difflineminus">-      if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l1.8202"></a><span id="l1.8202" class="difflineminus">-      {</span>
<a href="#l1.8203"></a><span id="l1.8203" class="difflineplus">+    if (msgHdr != nullptr) {</span>
<a href="#l1.8204"></a><span id="l1.8204" class="difflineplus">+      if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored)) {</span>
<a href="#l1.8205"></a><span id="l1.8205">         bool killed;</span>
<a href="#l1.8206"></a><span id="l1.8206">         msgHdr-&gt;GetIsKilled(&amp;killed);</span>
<a href="#l1.8207"></a><span id="l1.8207" class="difflineminus">-        if (killed)</span>
<a href="#l1.8208"></a><span id="l1.8208" class="difflineminus">-          continue;</span>
<a href="#l1.8209"></a><span id="l1.8209" class="difflineplus">+        if (killed) continue;</span>
<a href="#l1.8210"></a><span id="l1.8210">       }</span>
<a href="#l1.8211"></a><span id="l1.8211"> </span>
<a href="#l1.8212"></a><span id="l1.8212">       nsMsgKey msgKey;</span>
<a href="#l1.8213"></a><span id="l1.8213">       uint32_t msgFlags;</span>
<a href="#l1.8214"></a><span id="l1.8214">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.8215"></a><span id="l1.8215">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.8216"></a><span id="l1.8216">       bool isRead = AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l1.8217"></a><span id="l1.8217" class="difflineminus">-      if (!isRead)</span>
<a href="#l1.8218"></a><span id="l1.8218" class="difflineminus">-      {</span>
<a href="#l1.8219"></a><span id="l1.8219" class="difflineplus">+      if (!isRead) {</span>
<a href="#l1.8220"></a><span id="l1.8220">         // Just make sure flag is right in db.</span>
<a href="#l1.8221"></a><span id="l1.8221">         m_db-&gt;MarkHdrRead(msgHdr, false, nullptr);</span>
<a href="#l1.8222"></a><span id="l1.8222" class="difflineminus">-        if (msgKey != topLevelMsgKey)</span>
<a href="#l1.8223"></a><span id="l1.8223" class="difflineminus">-        {</span>
<a href="#l1.8224"></a><span id="l1.8224" class="difflineminus">-          InsertMsgHdrAt(viewIndex, msgHdr, msgKey, msgFlags,</span>
<a href="#l1.8225"></a><span id="l1.8225" class="difflineminus">-                         FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l1.8226"></a><span id="l1.8226" class="difflineplus">+        if (msgKey != topLevelMsgKey) {</span>
<a href="#l1.8227"></a><span id="l1.8227" class="difflineplus">+          InsertMsgHdrAt(</span>
<a href="#l1.8228"></a><span id="l1.8228" class="difflineplus">+              viewIndex, msgHdr, msgKey, msgFlags,</span>
<a href="#l1.8229"></a><span id="l1.8229" class="difflineplus">+              FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l1.8230"></a><span id="l1.8230">           viewIndex++;</span>
<a href="#l1.8231"></a><span id="l1.8231">           (*pNumListed)++;</span>
<a href="#l1.8232"></a><span id="l1.8232">         }</span>
<a href="#l1.8233"></a><span id="l1.8233">       }</span>
<a href="#l1.8234"></a><span id="l1.8234">     }</span>
<a href="#l1.8235"></a><span id="l1.8235">   }</span>
<a href="#l1.8236"></a><span id="l1.8236"> </span>
<a href="#l1.8237"></a><span id="l1.8237">   return NS_OK;</span>
<a href="#l1.8238"></a><span id="l1.8238"> }</span>
<a href="#l1.8239"></a><span id="l1.8239"> </span>
<a href="#l1.8240"></a><span id="l1.8240"> NS_IMETHODIMP</span>
<a href="#l1.8241"></a><span id="l1.8241" class="difflineminus">-nsMsgDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.8242"></a><span id="l1.8242" class="difflineminus">-                               uint32_t aOldFlags,</span>
<a href="#l1.8243"></a><span id="l1.8243" class="difflineplus">+nsMsgDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l1.8244"></a><span id="l1.8244">                                uint32_t aNewFlags,</span>
<a href="#l1.8245"></a><span id="l1.8245" class="difflineminus">-                               nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8246"></a><span id="l1.8246" class="difflineminus">-{</span>
<a href="#l1.8247"></a><span id="l1.8247" class="difflineplus">+                               nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8248"></a><span id="l1.8248">   // If we're not the instigator, update flags if this key is in our view.</span>
<a href="#l1.8249"></a><span id="l1.8249" class="difflineminus">-  if (aInstigator != this)</span>
<a href="#l1.8250"></a><span id="l1.8250" class="difflineminus">-  {</span>
<a href="#l1.8251"></a><span id="l1.8251" class="difflineplus">+  if (aInstigator != this) {</span>
<a href="#l1.8252"></a><span id="l1.8252">     NS_ENSURE_ARG_POINTER(aHdrChanged);</span>
<a href="#l1.8253"></a><span id="l1.8253">     nsMsgKey msgKey;</span>
<a href="#l1.8254"></a><span id="l1.8254">     aHdrChanged-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.8255"></a><span id="l1.8255">     nsMsgViewIndex index = FindHdr(aHdrChanged);</span>
<a href="#l1.8256"></a><span id="l1.8256" class="difflineminus">-    if (index != nsMsgViewIndex_None)</span>
<a href="#l1.8257"></a><span id="l1.8257" class="difflineminus">-    {</span>
<a href="#l1.8258"></a><span id="l1.8258" class="difflineplus">+    if (index != nsMsgViewIndex_None) {</span>
<a href="#l1.8259"></a><span id="l1.8259">       uint32_t viewOnlyFlags =</span>
<a href="#l1.8260"></a><span id="l1.8260" class="difflineminus">-        m_flags[index] &amp; (MSG_VIEW_FLAGS | nsMsgMessageFlags::Elided);</span>
<a href="#l1.8261"></a><span id="l1.8261" class="difflineplus">+          m_flags[index] &amp; (MSG_VIEW_FLAGS | nsMsgMessageFlags::Elided);</span>
<a href="#l1.8262"></a><span id="l1.8262"> </span>
<a href="#l1.8263"></a><span id="l1.8263">       // XXX what about saving the old view only flags, like IsThread and</span>
<a href="#l1.8264"></a><span id="l1.8264">       // HasChildren?</span>
<a href="#l1.8265"></a><span id="l1.8265">       // I think we'll want to save those away.</span>
<a href="#l1.8266"></a><span id="l1.8266">       m_flags[index] = aNewFlags | viewOnlyFlags;</span>
<a href="#l1.8267"></a><span id="l1.8267">       // Tell the view the extra flag changed, so it can</span>
<a href="#l1.8268"></a><span id="l1.8268">       // update the previous view, if any.</span>
<a href="#l1.8269"></a><span id="l1.8269">       OnExtraFlagChanged(index, aNewFlags);</span>
<a href="#l1.8270"></a><span id="l1.8270">       NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.8271"></a><span id="l1.8271">     }</span>
<a href="#l1.8272"></a><span id="l1.8272"> </span>
<a href="#l1.8273"></a><span id="l1.8273">     uint32_t deltaFlags = (aOldFlags ^ aNewFlags);</span>
<a href="#l1.8274"></a><span id="l1.8274" class="difflineminus">-    if (deltaFlags &amp; (nsMsgMessageFlags::Read | nsMsgMessageFlags::New))</span>
<a href="#l1.8275"></a><span id="l1.8275" class="difflineminus">-    {</span>
<a href="#l1.8276"></a><span id="l1.8276" class="difflineplus">+    if (deltaFlags &amp; (nsMsgMessageFlags::Read | nsMsgMessageFlags::New)) {</span>
<a href="#l1.8277"></a><span id="l1.8277">       nsMsgViewIndex threadIndex =</span>
<a href="#l1.8278"></a><span id="l1.8278" class="difflineminus">-        ThreadIndexOfMsgHdr(aHdrChanged, index, nullptr, nullptr);</span>
<a href="#l1.8279"></a><span id="l1.8279" class="difflineplus">+          ThreadIndexOfMsgHdr(aHdrChanged, index, nullptr, nullptr);</span>
<a href="#l1.8280"></a><span id="l1.8280"> </span>
<a href="#l1.8281"></a><span id="l1.8281">       // May need to fix thread counts.</span>
<a href="#l1.8282"></a><span id="l1.8282">       if (threadIndex != nsMsgViewIndex_None &amp;&amp; threadIndex != index)</span>
<a href="#l1.8283"></a><span id="l1.8283">         NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.8284"></a><span id="l1.8284">     }</span>
<a href="#l1.8285"></a><span id="l1.8285" class="difflineminus">- }</span>
<a href="#l1.8286"></a><span id="l1.8286" class="difflineplus">+  }</span>
<a href="#l1.8287"></a><span id="l1.8287"> </span>
<a href="#l1.8288"></a><span id="l1.8288">   // Don't need to propagate notifications, right?</span>
<a href="#l1.8289"></a><span id="l1.8289">   return NS_OK;</span>
<a href="#l1.8290"></a><span id="l1.8290"> }</span>
<a href="#l1.8291"></a><span id="l1.8291"> </span>
<a href="#l1.8292"></a><span id="l1.8292"> NS_IMETHODIMP</span>
<a href="#l1.8293"></a><span id="l1.8293" class="difflineminus">-nsMsgDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.8294"></a><span id="l1.8294" class="difflineminus">-                          nsMsgKey aParentKey,</span>
<a href="#l1.8295"></a><span id="l1.8295" class="difflineminus">-                          int32_t aFlags,</span>
<a href="#l1.8296"></a><span id="l1.8296" class="difflineminus">-                          nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8297"></a><span id="l1.8297" class="difflineminus">-{</span>
<a href="#l1.8298"></a><span id="l1.8298" class="difflineplus">+nsMsgDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey,</span>
<a href="#l1.8299"></a><span id="l1.8299" class="difflineplus">+                          int32_t aFlags, nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8300"></a><span id="l1.8300">   nsMsgViewIndex deletedIndex = FindHdr(aHdrChanged);</span>
<a href="#l1.8301"></a><span id="l1.8301" class="difflineminus">-  if (IsValidIndex(deletedIndex))</span>
<a href="#l1.8302"></a><span id="l1.8302" class="difflineminus">-  {</span>
<a href="#l1.8303"></a><span id="l1.8303" class="difflineplus">+  if (IsValidIndex(deletedIndex)) {</span>
<a href="#l1.8304"></a><span id="l1.8304">     // Check if this message is currently selected. If it is, tell the frontend</span>
<a href="#l1.8305"></a><span id="l1.8305">     // to be prepared for a delete.</span>
<a href="#l1.8306"></a><span id="l1.8306" class="difflineminus">-    if (mTreeSelection &amp;&amp; mCommandUpdater)</span>
<a href="#l1.8307"></a><span id="l1.8307" class="difflineminus">-    {</span>
<a href="#l1.8308"></a><span id="l1.8308" class="difflineplus">+    if (mTreeSelection &amp;&amp; mCommandUpdater) {</span>
<a href="#l1.8309"></a><span id="l1.8309">       bool isMsgSelected = false;</span>
<a href="#l1.8310"></a><span id="l1.8310">       mTreeSelection-&gt;IsSelected(deletedIndex, &amp;isMsgSelected);</span>
<a href="#l1.8311"></a><span id="l1.8311" class="difflineminus">-      if (isMsgSelected)</span>
<a href="#l1.8312"></a><span id="l1.8312" class="difflineminus">-        mCommandUpdater-&gt;UpdateNextMessageAfterDelete();</span>
<a href="#l1.8313"></a><span id="l1.8313" class="difflineplus">+      if (isMsgSelected) mCommandUpdater-&gt;UpdateNextMessageAfterDelete();</span>
<a href="#l1.8314"></a><span id="l1.8314">     }</span>
<a href="#l1.8315"></a><span id="l1.8315"> </span>
<a href="#l1.8316"></a><span id="l1.8316">     RemoveByIndex(deletedIndex);</span>
<a href="#l1.8317"></a><span id="l1.8317">   }</span>
<a href="#l1.8318"></a><span id="l1.8318"> </span>
<a href="#l1.8319"></a><span id="l1.8319">   return NS_OK;</span>
<a href="#l1.8320"></a><span id="l1.8320"> }</span>
<a href="#l1.8321"></a><span id="l1.8321"> </span>
<a href="#l1.8322"></a><span id="l1.8322"> NS_IMETHODIMP</span>
<a href="#l1.8323"></a><span id="l1.8323" class="difflineminus">-nsMsgDBView::OnHdrAdded(nsIMsgDBHdr *aHdrChanged,</span>
<a href="#l1.8324"></a><span id="l1.8324" class="difflineminus">-                        nsMsgKey aParentKey,</span>
<a href="#l1.8325"></a><span id="l1.8325" class="difflineminus">-                        int32_t aFlags,</span>
<a href="#l1.8326"></a><span id="l1.8326" class="difflineminus">-                        nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8327"></a><span id="l1.8327" class="difflineminus">-{</span>
<a href="#l1.8328"></a><span id="l1.8328" class="difflineplus">+nsMsgDBView::OnHdrAdded(nsIMsgDBHdr *aHdrChanged, nsMsgKey aParentKey,</span>
<a href="#l1.8329"></a><span id="l1.8329" class="difflineplus">+                        int32_t aFlags, nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8330"></a><span id="l1.8330">   return OnNewHeader(aHdrChanged, aParentKey, false);</span>
<a href="#l1.8331"></a><span id="l1.8331">   // Probably also want to pass that parent key in, since we went to the</span>
<a href="#l1.8332"></a><span id="l1.8332">   // trouble of figuring out what it is.</span>
<a href="#l1.8333"></a><span id="l1.8333"> }</span>
<a href="#l1.8334"></a><span id="l1.8334"> </span>
<a href="#l1.8335"></a><span id="l1.8335"> NS_IMETHODIMP</span>
<a href="#l1.8336"></a><span id="l1.8336" class="difflineminus">-nsMsgDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange,</span>
<a href="#l1.8337"></a><span id="l1.8337" class="difflineminus">-                                  bool aPreChange,</span>
<a href="#l1.8338"></a><span id="l1.8338" class="difflineplus">+nsMsgDBView::OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange,</span>
<a href="#l1.8339"></a><span id="l1.8339">                                   uint32_t *aStatus,</span>
<a href="#l1.8340"></a><span id="l1.8340" class="difflineminus">-                                  nsIDBChangeListener * aInstigator)</span>
<a href="#l1.8341"></a><span id="l1.8341" class="difflineminus">-{</span>
<a href="#l1.8342"></a><span id="l1.8342" class="difflineminus">-  if (aPreChange)</span>
<a href="#l1.8343"></a><span id="l1.8343" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.8344"></a><span id="l1.8344" class="difflineminus">-</span>
<a href="#l1.8345"></a><span id="l1.8345" class="difflineminus">-  if (aHdrToChange)</span>
<a href="#l1.8346"></a><span id="l1.8346" class="difflineminus">-  {</span>
<a href="#l1.8347"></a><span id="l1.8347" class="difflineplus">+                                  nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8348"></a><span id="l1.8348" class="difflineplus">+  if (aPreChange) return NS_OK;</span>
<a href="#l1.8349"></a><span id="l1.8349" class="difflineplus">+</span>
<a href="#l1.8350"></a><span id="l1.8350" class="difflineplus">+  if (aHdrToChange) {</span>
<a href="#l1.8351"></a><span id="l1.8351">     nsMsgViewIndex index = FindHdr(aHdrToChange);</span>
<a href="#l1.8352"></a><span id="l1.8352">     if (index != nsMsgViewIndex_None)</span>
<a href="#l1.8353"></a><span id="l1.8353">       NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.8354"></a><span id="l1.8354">   }</span>
<a href="#l1.8355"></a><span id="l1.8355"> </span>
<a href="#l1.8356"></a><span id="l1.8356">   return NS_OK;</span>
<a href="#l1.8357"></a><span id="l1.8357"> }</span>
<a href="#l1.8358"></a><span id="l1.8358"> </span>
<a href="#l1.8359"></a><span id="l1.8359"> NS_IMETHODIMP</span>
<a href="#l1.8360"></a><span id="l1.8360" class="difflineminus">-nsMsgDBView::OnParentChanged (nsMsgKey aKeyChanged,</span>
<a href="#l1.8361"></a><span id="l1.8361" class="difflineminus">-                              nsMsgKey oldParent,</span>
<a href="#l1.8362"></a><span id="l1.8362" class="difflineminus">-                              nsMsgKey newParent,</span>
<a href="#l1.8363"></a><span id="l1.8363" class="difflineminus">-                              nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8364"></a><span id="l1.8364" class="difflineminus">-{</span>
<a href="#l1.8365"></a><span id="l1.8365" class="difflineplus">+nsMsgDBView::OnParentChanged(nsMsgKey aKeyChanged, nsMsgKey oldParent,</span>
<a href="#l1.8366"></a><span id="l1.8366" class="difflineplus">+                             nsMsgKey newParent,</span>
<a href="#l1.8367"></a><span id="l1.8367" class="difflineplus">+                             nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8368"></a><span id="l1.8368">   return NS_OK;</span>
<a href="#l1.8369"></a><span id="l1.8369"> }</span>
<a href="#l1.8370"></a><span id="l1.8370"> </span>
<a href="#l1.8371"></a><span id="l1.8371"> NS_IMETHODIMP</span>
<a href="#l1.8372"></a><span id="l1.8372" class="difflineminus">-nsMsgDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator)</span>
<a href="#l1.8373"></a><span id="l1.8373" class="difflineminus">-{</span>
<a href="#l1.8374"></a><span id="l1.8374" class="difflineminus">-  if (m_db)</span>
<a href="#l1.8375"></a><span id="l1.8375" class="difflineminus">-  {</span>
<a href="#l1.8376"></a><span id="l1.8376" class="difflineplus">+nsMsgDBView::OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator) {</span>
<a href="#l1.8377"></a><span id="l1.8377" class="difflineplus">+  if (m_db) {</span>
<a href="#l1.8378"></a><span id="l1.8378">     m_db-&gt;RemoveListener(this);</span>
<a href="#l1.8379"></a><span id="l1.8379">     m_db = nullptr;</span>
<a href="#l1.8380"></a><span id="l1.8380">   }</span>
<a href="#l1.8381"></a><span id="l1.8381"> </span>
<a href="#l1.8382"></a><span id="l1.8382">   int32_t saveSize = GetSize();</span>
<a href="#l1.8383"></a><span id="l1.8383">   ClearHdrCache();</span>
<a href="#l1.8384"></a><span id="l1.8384"> </span>
<a href="#l1.8385"></a><span id="l1.8385">   // This is important, because the tree will ask us for our</span>
<a href="#l1.8386"></a><span id="l1.8386">   // row count, which get determine from the number of keys.</span>
<a href="#l1.8387"></a><span id="l1.8387">   m_keys.Clear();</span>
<a href="#l1.8388"></a><span id="l1.8388">   // Be consistent.</span>
<a href="#l1.8389"></a><span id="l1.8389">   m_flags.Clear();</span>
<a href="#l1.8390"></a><span id="l1.8390">   m_levels.Clear();</span>
<a href="#l1.8391"></a><span id="l1.8391"> </span>
<a href="#l1.8392"></a><span id="l1.8392">   // Tell the tree all the rows have gone away.</span>
<a href="#l1.8393"></a><span id="l1.8393" class="difflineminus">-  if (mTree)</span>
<a href="#l1.8394"></a><span id="l1.8394" class="difflineminus">-    mTree-&gt;RowCountChanged(0, -saveSize);</span>
<a href="#l1.8395"></a><span id="l1.8395" class="difflineplus">+  if (mTree) mTree-&gt;RowCountChanged(0, -saveSize);</span>
<a href="#l1.8396"></a><span id="l1.8396"> </span>
<a href="#l1.8397"></a><span id="l1.8397">   return NS_OK;</span>
<a href="#l1.8398"></a><span id="l1.8398"> }</span>
<a href="#l1.8399"></a><span id="l1.8399"> </span>
<a href="#l1.8400"></a><span id="l1.8400"> NS_IMETHODIMP</span>
<a href="#l1.8401"></a><span id="l1.8401" class="difflineminus">-nsMsgDBView::OnEvent(nsIMsgDatabase *aDB,</span>
<a href="#l1.8402"></a><span id="l1.8402" class="difflineminus">-                     const char *aEvent)</span>
<a href="#l1.8403"></a><span id="l1.8403" class="difflineminus">-{</span>
<a href="#l1.8404"></a><span id="l1.8404" class="difflineminus">-  if (!strcmp(aEvent, &quot;DBOpened&quot;))</span>
<a href="#l1.8405"></a><span id="l1.8405" class="difflineminus">-    m_db = aDB;</span>
<a href="#l1.8406"></a><span id="l1.8406" class="difflineplus">+nsMsgDBView::OnEvent(nsIMsgDatabase *aDB, const char *aEvent) {</span>
<a href="#l1.8407"></a><span id="l1.8407" class="difflineplus">+  if (!strcmp(aEvent, &quot;DBOpened&quot;)) m_db = aDB;</span>
<a href="#l1.8408"></a><span id="l1.8408"> </span>
<a href="#l1.8409"></a><span id="l1.8409">   return NS_OK;</span>
<a href="#l1.8410"></a><span id="l1.8410"> }</span>
<a href="#l1.8411"></a><span id="l1.8411"> </span>
<a href="#l1.8412"></a><span id="l1.8412"> NS_IMETHODIMP</span>
<a href="#l1.8413"></a><span id="l1.8413" class="difflineminus">-nsMsgDBView::OnReadChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8414"></a><span id="l1.8414" class="difflineminus">-{</span>
<a href="#l1.8415"></a><span id="l1.8415" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.8416"></a><span id="l1.8416" class="difflineminus">-}</span>
<a href="#l1.8417"></a><span id="l1.8417" class="difflineplus">+nsMsgDBView::OnReadChanged(nsIDBChangeListener *aInstigator) { return NS_OK; }</span>
<a href="#l1.8418"></a><span id="l1.8418"> </span>
<a href="#l1.8419"></a><span id="l1.8419"> NS_IMETHODIMP</span>
<a href="#l1.8420"></a><span id="l1.8420" class="difflineminus">-nsMsgDBView::OnJunkScoreChanged(nsIDBChangeListener *aInstigator)</span>
<a href="#l1.8421"></a><span id="l1.8421" class="difflineminus">-{</span>
<a href="#l1.8422"></a><span id="l1.8422" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.8423"></a><span id="l1.8423" class="difflineminus">-}</span>
<a href="#l1.8424"></a><span id="l1.8424" class="difflineminus">-</span>
<a href="#l1.8425"></a><span id="l1.8425" class="difflineminus">-void</span>
<a href="#l1.8426"></a><span id="l1.8426" class="difflineminus">-nsMsgDBView::ClearHdrCache()</span>
<a href="#l1.8427"></a><span id="l1.8427" class="difflineminus">-{</span>
<a href="#l1.8428"></a><span id="l1.8428" class="difflineplus">+nsMsgDBView::OnJunkScoreChanged(nsIDBChangeListener *aInstigator) {</span>
<a href="#l1.8429"></a><span id="l1.8429" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.8430"></a><span id="l1.8430" class="difflineplus">+}</span>
<a href="#l1.8431"></a><span id="l1.8431" class="difflineplus">+</span>
<a href="#l1.8432"></a><span id="l1.8432" class="difflineplus">+void nsMsgDBView::ClearHdrCache() {</span>
<a href="#l1.8433"></a><span id="l1.8433">   m_cachedHdr = nullptr;</span>
<a href="#l1.8434"></a><span id="l1.8434">   m_cachedMsgKey = nsMsgKey_None;</span>
<a href="#l1.8435"></a><span id="l1.8435"> }</span>
<a href="#l1.8436"></a><span id="l1.8436"> </span>
<a href="#l1.8437"></a><span id="l1.8437"> NS_IMETHODIMP</span>
<a href="#l1.8438"></a><span id="l1.8438" class="difflineminus">-nsMsgDBView::SetSuppressChangeNotifications(bool aSuppressChangeNotifications)</span>
<a href="#l1.8439"></a><span id="l1.8439" class="difflineminus">-{</span>
<a href="#l1.8440"></a><span id="l1.8440" class="difflineplus">+nsMsgDBView::SetSuppressChangeNotifications(bool aSuppressChangeNotifications) {</span>
<a href="#l1.8441"></a><span id="l1.8441">   mSuppressChangeNotification = aSuppressChangeNotifications;</span>
<a href="#l1.8442"></a><span id="l1.8442">   return NS_OK;</span>
<a href="#l1.8443"></a><span id="l1.8443"> }</span>
<a href="#l1.8444"></a><span id="l1.8444"> </span>
<a href="#l1.8445"></a><span id="l1.8445"> NS_IMETHODIMP</span>
<a href="#l1.8446"></a><span id="l1.8446" class="difflineminus">-nsMsgDBView::GetSuppressChangeNotifications(bool * aSuppressChangeNotifications)</span>
<a href="#l1.8447"></a><span id="l1.8447" class="difflineminus">-{</span>
<a href="#l1.8448"></a><span id="l1.8448" class="difflineplus">+nsMsgDBView::GetSuppressChangeNotifications(</span>
<a href="#l1.8449"></a><span id="l1.8449" class="difflineplus">+    bool *aSuppressChangeNotifications) {</span>
<a href="#l1.8450"></a><span id="l1.8450">   NS_ENSURE_ARG_POINTER(aSuppressChangeNotifications);</span>
<a href="#l1.8451"></a><span id="l1.8451">   *aSuppressChangeNotifications = mSuppressChangeNotification;</span>
<a href="#l1.8452"></a><span id="l1.8452">   return NS_OK;</span>
<a href="#l1.8453"></a><span id="l1.8453"> }</span>
<a href="#l1.8454"></a><span id="l1.8454"> </span>
<a href="#l1.8455"></a><span id="l1.8455"> NS_IMETHODIMP</span>
<a href="#l1.8456"></a><span id="l1.8456" class="difflineminus">-nsMsgDBView::NoteChange(nsMsgViewIndex firstLineChanged,</span>
<a href="#l1.8457"></a><span id="l1.8457" class="difflineminus">-                        int32_t numChanged,</span>
<a href="#l1.8458"></a><span id="l1.8458" class="difflineminus">-                        nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.8459"></a><span id="l1.8459" class="difflineminus">-{</span>
<a href="#l1.8460"></a><span id="l1.8460" class="difflineminus">-  if (mTree &amp;&amp; !mSuppressChangeNotification)</span>
<a href="#l1.8461"></a><span id="l1.8461" class="difflineminus">-  {</span>
<a href="#l1.8462"></a><span id="l1.8462" class="difflineminus">-    switch (changeType)</span>
<a href="#l1.8463"></a><span id="l1.8463" class="difflineminus">-    {</span>
<a href="#l1.8464"></a><span id="l1.8464" class="difflineplus">+nsMsgDBView::NoteChange(nsMsgViewIndex firstLineChanged, int32_t numChanged,</span>
<a href="#l1.8465"></a><span id="l1.8465" class="difflineplus">+                        nsMsgViewNotificationCodeValue changeType) {</span>
<a href="#l1.8466"></a><span id="l1.8466" class="difflineplus">+  if (mTree &amp;&amp; !mSuppressChangeNotification) {</span>
<a href="#l1.8467"></a><span id="l1.8467" class="difflineplus">+    switch (changeType) {</span>
<a href="#l1.8468"></a><span id="l1.8468">       case nsMsgViewNotificationCode::changed:</span>
<a href="#l1.8469"></a><span id="l1.8469" class="difflineminus">-        mTree-&gt;InvalidateRange(firstLineChanged, firstLineChanged + numChanged - 1);</span>
<a href="#l1.8470"></a><span id="l1.8470" class="difflineplus">+        mTree-&gt;InvalidateRange(firstLineChanged,</span>
<a href="#l1.8471"></a><span id="l1.8471" class="difflineplus">+                               firstLineChanged + numChanged - 1);</span>
<a href="#l1.8472"></a><span id="l1.8472">         break;</span>
<a href="#l1.8473"></a><span id="l1.8473">       case nsMsgViewNotificationCode::insertOrDelete:</span>
<a href="#l1.8474"></a><span id="l1.8474" class="difflineminus">-        if (numChanged &lt; 0)</span>
<a href="#l1.8475"></a><span id="l1.8475" class="difflineminus">-          mRemovingRow = true;</span>
<a href="#l1.8476"></a><span id="l1.8476" class="difflineplus">+        if (numChanged &lt; 0) mRemovingRow = true;</span>
<a href="#l1.8477"></a><span id="l1.8477"> </span>
<a href="#l1.8478"></a><span id="l1.8478">         // The caller needs to have adjusted m_keys before getting here, since</span>
<a href="#l1.8479"></a><span id="l1.8479">         // RowCountChanged() will call our GetRowCount().</span>
<a href="#l1.8480"></a><span id="l1.8480">         mTree-&gt;RowCountChanged(firstLineChanged, numChanged);</span>
<a href="#l1.8481"></a><span id="l1.8481">         mRemovingRow = false;</span>
<a href="#l1.8482"></a><span id="l1.8482">         MOZ_FALLTHROUGH;</span>
<a href="#l1.8483"></a><span id="l1.8483">       case nsMsgViewNotificationCode::all:</span>
<a href="#l1.8484"></a><span id="l1.8484">         ClearHdrCache();</span>
<a href="#l1.8485"></a><span id="l1.8485">         break;</span>
<a href="#l1.8486"></a><span id="l1.8486">     }</span>
<a href="#l1.8487"></a><span id="l1.8487">   }</span>
<a href="#l1.8488"></a><span id="l1.8488"> </span>
<a href="#l1.8489"></a><span id="l1.8489">   return NS_OK;</span>
<a href="#l1.8490"></a><span id="l1.8490"> }</span>
<a href="#l1.8491"></a><span id="l1.8491"> </span>
<a href="#l1.8492"></a><span id="l1.8492" class="difflineminus">-void</span>
<a href="#l1.8493"></a><span id="l1.8493" class="difflineminus">-nsMsgDBView::NoteStartChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.8494"></a><span id="l1.8494" class="difflineminus">-                             int32_t numChanged,</span>
<a href="#l1.8495"></a><span id="l1.8495" class="difflineminus">-                             nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.8496"></a><span id="l1.8496" class="difflineminus">-{</span>
<a href="#l1.8497"></a><span id="l1.8497" class="difflineminus">-}</span>
<a href="#l1.8498"></a><span id="l1.8498" class="difflineminus">-</span>
<a href="#l1.8499"></a><span id="l1.8499" class="difflineminus">-void</span>
<a href="#l1.8500"></a><span id="l1.8500" class="difflineminus">-nsMsgDBView::NoteEndChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.8501"></a><span id="l1.8501" class="difflineminus">-                           int32_t numChanged,</span>
<a href="#l1.8502"></a><span id="l1.8502" class="difflineminus">-                           nsMsgViewNotificationCodeValue changeType)</span>
<a href="#l1.8503"></a><span id="l1.8503" class="difflineminus">-{</span>
<a href="#l1.8504"></a><span id="l1.8504" class="difflineplus">+void nsMsgDBView::NoteStartChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.8505"></a><span id="l1.8505" class="difflineplus">+                                  int32_t numChanged,</span>
<a href="#l1.8506"></a><span id="l1.8506" class="difflineplus">+                                  nsMsgViewNotificationCodeValue changeType) {}</span>
<a href="#l1.8507"></a><span id="l1.8507" class="difflineplus">+</span>
<a href="#l1.8508"></a><span id="l1.8508" class="difflineplus">+void nsMsgDBView::NoteEndChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l1.8509"></a><span id="l1.8509" class="difflineplus">+                                int32_t numChanged,</span>
<a href="#l1.8510"></a><span id="l1.8510" class="difflineplus">+                                nsMsgViewNotificationCodeValue changeType) {</span>
<a href="#l1.8511"></a><span id="l1.8511">   // Send the notification now.</span>
<a href="#l1.8512"></a><span id="l1.8512">   NoteChange(firstlineChanged, numChanged, changeType);</span>
<a href="#l1.8513"></a><span id="l1.8513"> }</span>
<a href="#l1.8514"></a><span id="l1.8514"> </span>
<a href="#l1.8515"></a><span id="l1.8515"> NS_IMETHODIMP</span>
<a href="#l1.8516"></a><span id="l1.8516" class="difflineminus">-nsMsgDBView::GetSortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8517"></a><span id="l1.8517" class="difflineminus">-{</span>
<a href="#l1.8518"></a><span id="l1.8518" class="difflineplus">+nsMsgDBView::GetSortOrder(nsMsgViewSortOrderValue *aSortOrder) {</span>
<a href="#l1.8519"></a><span id="l1.8519">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8520"></a><span id="l1.8520">   *aSortOrder = m_sortOrder;</span>
<a href="#l1.8521"></a><span id="l1.8521">   return NS_OK;</span>
<a href="#l1.8522"></a><span id="l1.8522"> }</span>
<a href="#l1.8523"></a><span id="l1.8523"> </span>
<a href="#l1.8524"></a><span id="l1.8524"> NS_IMETHODIMP</span>
<a href="#l1.8525"></a><span id="l1.8525" class="difflineminus">-nsMsgDBView::GetSortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8526"></a><span id="l1.8526" class="difflineminus">-{</span>
<a href="#l1.8527"></a><span id="l1.8527" class="difflineplus">+nsMsgDBView::GetSortType(nsMsgViewSortTypeValue *aSortType) {</span>
<a href="#l1.8528"></a><span id="l1.8528">   NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8529"></a><span id="l1.8529">   *aSortType = m_sortType;</span>
<a href="#l1.8530"></a><span id="l1.8530">   return NS_OK;</span>
<a href="#l1.8531"></a><span id="l1.8531"> }</span>
<a href="#l1.8532"></a><span id="l1.8532"> </span>
<a href="#l1.8533"></a><span id="l1.8533"> NS_IMETHODIMP</span>
<a href="#l1.8534"></a><span id="l1.8534" class="difflineminus">-nsMsgDBView::SetSortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8535"></a><span id="l1.8535" class="difflineminus">-{</span>
<a href="#l1.8536"></a><span id="l1.8536" class="difflineplus">+nsMsgDBView::SetSortType(nsMsgViewSortTypeValue aSortType) {</span>
<a href="#l1.8537"></a><span id="l1.8537">   m_sortType = aSortType;</span>
<a href="#l1.8538"></a><span id="l1.8538">   return NS_OK;</span>
<a href="#l1.8539"></a><span id="l1.8539"> }</span>
<a href="#l1.8540"></a><span id="l1.8540"> </span>
<a href="#l1.8541"></a><span id="l1.8541"> NS_IMETHODIMP</span>
<a href="#l1.8542"></a><span id="l1.8542" class="difflineminus">-nsMsgDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l1.8543"></a><span id="l1.8543" class="difflineminus">-{</span>
<a href="#l1.8544"></a><span id="l1.8544" class="difflineplus">+nsMsgDBView::GetViewType(nsMsgViewTypeValue *aViewType) {</span>
<a href="#l1.8545"></a><span id="l1.8545">   NS_ERROR(&quot;you should be overriding this&quot;);</span>
<a href="#l1.8546"></a><span id="l1.8546">   return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.8547"></a><span id="l1.8547"> }</span>
<a href="#l1.8548"></a><span id="l1.8548"> </span>
<a href="#l1.8549"></a><span id="l1.8549"> NS_IMETHODIMP</span>
<a href="#l1.8550"></a><span id="l1.8550" class="difflineminus">-nsMsgDBView::GetSecondarySortOrder(nsMsgViewSortOrderValue *aSortOrder)</span>
<a href="#l1.8551"></a><span id="l1.8551" class="difflineminus">-{</span>
<a href="#l1.8552"></a><span id="l1.8552" class="difflineplus">+nsMsgDBView::GetSecondarySortOrder(nsMsgViewSortOrderValue *aSortOrder) {</span>
<a href="#l1.8553"></a><span id="l1.8553">   NS_ENSURE_ARG_POINTER(aSortOrder);</span>
<a href="#l1.8554"></a><span id="l1.8554">   *aSortOrder = m_secondarySortOrder;</span>
<a href="#l1.8555"></a><span id="l1.8555">   return NS_OK;</span>
<a href="#l1.8556"></a><span id="l1.8556"> }</span>
<a href="#l1.8557"></a><span id="l1.8557"> </span>
<a href="#l1.8558"></a><span id="l1.8558"> NS_IMETHODIMP</span>
<a href="#l1.8559"></a><span id="l1.8559" class="difflineminus">-nsMsgDBView::SetSecondarySortOrder(nsMsgViewSortOrderValue aSortOrder)</span>
<a href="#l1.8560"></a><span id="l1.8560" class="difflineminus">-{</span>
<a href="#l1.8561"></a><span id="l1.8561" class="difflineplus">+nsMsgDBView::SetSecondarySortOrder(nsMsgViewSortOrderValue aSortOrder) {</span>
<a href="#l1.8562"></a><span id="l1.8562">   m_secondarySortOrder = aSortOrder;</span>
<a href="#l1.8563"></a><span id="l1.8563">   return NS_OK;</span>
<a href="#l1.8564"></a><span id="l1.8564"> }</span>
<a href="#l1.8565"></a><span id="l1.8565"> </span>
<a href="#l1.8566"></a><span id="l1.8566"> NS_IMETHODIMP</span>
<a href="#l1.8567"></a><span id="l1.8567" class="difflineminus">-nsMsgDBView::GetSecondarySortType(nsMsgViewSortTypeValue *aSortType)</span>
<a href="#l1.8568"></a><span id="l1.8568" class="difflineminus">-{</span>
<a href="#l1.8569"></a><span id="l1.8569" class="difflineplus">+nsMsgDBView::GetSecondarySortType(nsMsgViewSortTypeValue *aSortType) {</span>
<a href="#l1.8570"></a><span id="l1.8570">   NS_ENSURE_ARG_POINTER(aSortType);</span>
<a href="#l1.8571"></a><span id="l1.8571">   *aSortType = m_secondarySort;</span>
<a href="#l1.8572"></a><span id="l1.8572">   return NS_OK;</span>
<a href="#l1.8573"></a><span id="l1.8573"> }</span>
<a href="#l1.8574"></a><span id="l1.8574"> </span>
<a href="#l1.8575"></a><span id="l1.8575"> NS_IMETHODIMP</span>
<a href="#l1.8576"></a><span id="l1.8576" class="difflineminus">-nsMsgDBView::SetSecondarySortType(nsMsgViewSortTypeValue aSortType)</span>
<a href="#l1.8577"></a><span id="l1.8577" class="difflineminus">-{</span>
<a href="#l1.8578"></a><span id="l1.8578" class="difflineplus">+nsMsgDBView::SetSecondarySortType(nsMsgViewSortTypeValue aSortType) {</span>
<a href="#l1.8579"></a><span id="l1.8579">   m_secondarySort = aSortType;</span>
<a href="#l1.8580"></a><span id="l1.8580">   return NS_OK;</span>
<a href="#l1.8581"></a><span id="l1.8581"> }</span>
<a href="#l1.8582"></a><span id="l1.8582"> </span>
<a href="#l1.8583"></a><span id="l1.8583" class="difflineminus">-nsresult</span>
<a href="#l1.8584"></a><span id="l1.8584" class="difflineminus">-nsMsgDBView::PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo)</span>
<a href="#l1.8585"></a><span id="l1.8585" class="difflineminus">-{</span>
<a href="#l1.8586"></a><span id="l1.8586" class="difflineplus">+nsresult nsMsgDBView::PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo) {</span>
<a href="#l1.8587"></a><span id="l1.8587">   nsresult rv = m_db-&gt;GetDBFolderInfo(dbFolderInfo);</span>
<a href="#l1.8588"></a><span id="l1.8588">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8589"></a><span id="l1.8589">   // Save off sort type and order, view type and flags.</span>
<a href="#l1.8590"></a><span id="l1.8590">   (*dbFolderInfo)-&gt;SetSortType(m_sortType);</span>
<a href="#l1.8591"></a><span id="l1.8591">   (*dbFolderInfo)-&gt;SetSortOrder(m_sortOrder);</span>
<a href="#l1.8592"></a><span id="l1.8592">   (*dbFolderInfo)-&gt;SetViewFlags(m_viewFlags);</span>
<a href="#l1.8593"></a><span id="l1.8593">   nsMsgViewTypeValue viewType;</span>
<a href="#l1.8594"></a><span id="l1.8594">   GetViewType(&amp;viewType);</span>
<a href="#l1.8595"></a><span id="l1.8595">   (*dbFolderInfo)-&gt;SetViewType(viewType);</span>
<a href="#l1.8596"></a><span id="l1.8596">   return rv;</span>
<a href="#l1.8597"></a><span id="l1.8597"> }</span>
<a href="#l1.8598"></a><span id="l1.8598"> </span>
<a href="#l1.8599"></a><span id="l1.8599"> NS_IMETHODIMP</span>
<a href="#l1.8600"></a><span id="l1.8600" class="difflineminus">-nsMsgDBView::GetViewFlags(nsMsgViewFlagsTypeValue *aViewFlags)</span>
<a href="#l1.8601"></a><span id="l1.8601" class="difflineminus">-{</span>
<a href="#l1.8602"></a><span id="l1.8602" class="difflineplus">+nsMsgDBView::GetViewFlags(nsMsgViewFlagsTypeValue *aViewFlags) {</span>
<a href="#l1.8603"></a><span id="l1.8603">   NS_ENSURE_ARG_POINTER(aViewFlags);</span>
<a href="#l1.8604"></a><span id="l1.8604">   *aViewFlags = m_viewFlags;</span>
<a href="#l1.8605"></a><span id="l1.8605">   return NS_OK;</span>
<a href="#l1.8606"></a><span id="l1.8606"> }</span>
<a href="#l1.8607"></a><span id="l1.8607"> </span>
<a href="#l1.8608"></a><span id="l1.8608"> NS_IMETHODIMP</span>
<a href="#l1.8609"></a><span id="l1.8609" class="difflineminus">-nsMsgDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags)</span>
<a href="#l1.8610"></a><span id="l1.8610" class="difflineminus">-{</span>
<a href="#l1.8611"></a><span id="l1.8611" class="difflineplus">+nsMsgDBView::SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) {</span>
<a href="#l1.8612"></a><span id="l1.8612">   // If we're turning off threaded display, we need to expand all so that all</span>
<a href="#l1.8613"></a><span id="l1.8613">   // messages will be displayed.</span>
<a href="#l1.8614"></a><span id="l1.8614">   if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay &amp;&amp;</span>
<a href="#l1.8615"></a><span id="l1.8615" class="difflineminus">-      !(aViewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8616"></a><span id="l1.8616" class="difflineminus">-  {</span>
<a href="#l1.8617"></a><span id="l1.8617" class="difflineplus">+      !(aViewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l1.8618"></a><span id="l1.8618">     ExpandAll();</span>
<a href="#l1.8619"></a><span id="l1.8619">     // Invalidate the sort so sorting will do something.</span>
<a href="#l1.8620"></a><span id="l1.8620">     m_sortValid = false;</span>
<a href="#l1.8621"></a><span id="l1.8621">   }</span>
<a href="#l1.8622"></a><span id="l1.8622"> </span>
<a href="#l1.8623"></a><span id="l1.8623">   m_viewFlags = aViewFlags;</span>
<a href="#l1.8624"></a><span id="l1.8624"> </span>
<a href="#l1.8625"></a><span id="l1.8625" class="difflineminus">-  if (m_viewFolder)</span>
<a href="#l1.8626"></a><span id="l1.8626" class="difflineminus">-  {</span>
<a href="#l1.8627"></a><span id="l1.8627" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8628"></a><span id="l1.8628" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.8629"></a><span id="l1.8629" class="difflineplus">+  if (m_viewFolder) {</span>
<a href="#l1.8630"></a><span id="l1.8630" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8631"></a><span id="l1.8631" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l1.8632"></a><span id="l1.8632">     nsresult rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(folderInfo),</span>
<a href="#l1.8633"></a><span id="l1.8633">                                                      getter_AddRefs(db));</span>
<a href="#l1.8634"></a><span id="l1.8634" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.8635"></a><span id="l1.8635" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8636"></a><span id="l1.8636">     return folderInfo-&gt;SetViewFlags(aViewFlags);</span>
<a href="#l1.8637"></a><span id="l1.8637" class="difflineminus">-  }</span>
<a href="#l1.8638"></a><span id="l1.8638" class="difflineminus">-  else</span>
<a href="#l1.8639"></a><span id="l1.8639" class="difflineplus">+  } else</span>
<a href="#l1.8640"></a><span id="l1.8640">     return NS_OK;</span>
<a href="#l1.8641"></a><span id="l1.8641"> }</span>
<a href="#l1.8642"></a><span id="l1.8642"> </span>
<a href="#l1.8643"></a><span id="l1.8643" class="difflineminus">-nsresult</span>
<a href="#l1.8644"></a><span id="l1.8644" class="difflineminus">-nsMsgDBView::MarkThreadOfMsgRead(nsMsgKey msgId,</span>
<a href="#l1.8645"></a><span id="l1.8645" class="difflineminus">-                                 nsMsgViewIndex msgIndex,</span>
<a href="#l1.8646"></a><span id="l1.8646" class="difflineminus">-                                 nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8647"></a><span id="l1.8647" class="difflineminus">-                                 bool bRead)</span>
<a href="#l1.8648"></a><span id="l1.8648" class="difflineminus">-{</span>
<a href="#l1.8649"></a><span id="l1.8649" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8650"></a><span id="l1.8650" class="difflineplus">+nsresult nsMsgDBView::MarkThreadOfMsgRead(nsMsgKey msgId,</span>
<a href="#l1.8651"></a><span id="l1.8651" class="difflineplus">+                                          nsMsgViewIndex msgIndex,</span>
<a href="#l1.8652"></a><span id="l1.8652" class="difflineplus">+                                          nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8653"></a><span id="l1.8653" class="difflineplus">+                                          bool bRead) {</span>
<a href="#l1.8654"></a><span id="l1.8654" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8655"></a><span id="l1.8655">   nsresult rv = GetThreadContainingIndex(msgIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8656"></a><span id="l1.8656">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8657"></a><span id="l1.8657"> </span>
<a href="#l1.8658"></a><span id="l1.8658">   nsMsgViewIndex threadIndex;</span>
<a href="#l1.8659"></a><span id="l1.8659"> </span>
<a href="#l1.8660"></a><span id="l1.8660">   NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8661"></a><span id="l1.8661" class="difflineminus">-  if (!threadHdr)</span>
<a href="#l1.8662"></a><span id="l1.8662" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.8663"></a><span id="l1.8663" class="difflineplus">+  if (!threadHdr) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.8664"></a><span id="l1.8664"> </span>
<a href="#l1.8665"></a><span id="l1.8665">   nsCOMPtr&lt;nsIMsgDBHdr&gt; firstHdr;</span>
<a href="#l1.8666"></a><span id="l1.8666">   rv = threadHdr-&gt;GetChildHdrAt(0, getter_AddRefs(firstHdr));</span>
<a href="#l1.8667"></a><span id="l1.8667">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8668"></a><span id="l1.8668">   nsMsgKey firstHdrId;</span>
<a href="#l1.8669"></a><span id="l1.8669">   firstHdr-&gt;GetMessageKey(&amp;firstHdrId);</span>
<a href="#l1.8670"></a><span id="l1.8670">   if (msgId != firstHdrId)</span>
<a href="#l1.8671"></a><span id="l1.8671">     threadIndex = GetIndexOfFirstDisplayedKeyInThread(threadHdr);</span>
<a href="#l1.8672"></a><span id="l1.8672">   else</span>
<a href="#l1.8673"></a><span id="l1.8673">     threadIndex = msgIndex;</span>
<a href="#l1.8674"></a><span id="l1.8674"> </span>
<a href="#l1.8675"></a><span id="l1.8675">   return MarkThreadRead(threadHdr, threadIndex, idsMarkedRead, bRead);</span>
<a href="#l1.8676"></a><span id="l1.8676"> }</span>
<a href="#l1.8677"></a><span id="l1.8677"> </span>
<a href="#l1.8678"></a><span id="l1.8678" class="difflineminus">-nsresult</span>
<a href="#l1.8679"></a><span id="l1.8679" class="difflineminus">-nsMsgDBView::MarkThreadRead(nsIMsgThread *threadHdr,</span>
<a href="#l1.8680"></a><span id="l1.8680" class="difflineminus">-                            nsMsgViewIndex threadIndex,</span>
<a href="#l1.8681"></a><span id="l1.8681" class="difflineminus">-                            nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8682"></a><span id="l1.8682" class="difflineminus">-                            bool bRead)</span>
<a href="#l1.8683"></a><span id="l1.8683" class="difflineminus">-{</span>
<a href="#l1.8684"></a><span id="l1.8684" class="difflineplus">+nsresult nsMsgDBView::MarkThreadRead(nsIMsgThread *threadHdr,</span>
<a href="#l1.8685"></a><span id="l1.8685" class="difflineplus">+                                     nsMsgViewIndex threadIndex,</span>
<a href="#l1.8686"></a><span id="l1.8686" class="difflineplus">+                                     nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l1.8687"></a><span id="l1.8687" class="difflineplus">+                                     bool bRead) {</span>
<a href="#l1.8688"></a><span id="l1.8688">   uint32_t numChildren;</span>
<a href="#l1.8689"></a><span id="l1.8689">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l1.8690"></a><span id="l1.8690">   idsMarkedRead.SetCapacity(numChildren);</span>
<a href="#l1.8691"></a><span id="l1.8691" class="difflineminus">-  for (int32_t childIndex = 0; childIndex &lt; (int32_t) numChildren ; childIndex++)</span>
<a href="#l1.8692"></a><span id="l1.8692" class="difflineminus">-  {</span>
<a href="#l1.8693"></a><span id="l1.8693" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8694"></a><span id="l1.8694" class="difflineplus">+  for (int32_t childIndex = 0; childIndex &lt; (int32_t)numChildren;</span>
<a href="#l1.8695"></a><span id="l1.8695" class="difflineplus">+       childIndex++) {</span>
<a href="#l1.8696"></a><span id="l1.8696" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8697"></a><span id="l1.8697">     threadHdr-&gt;GetChildHdrAt(childIndex, getter_AddRefs(msgHdr));</span>
<a href="#l1.8698"></a><span id="l1.8698">     NS_ASSERTION(msgHdr, &quot;msgHdr is null&quot;);</span>
<a href="#l1.8699"></a><span id="l1.8699" class="difflineminus">-    if (!msgHdr)</span>
<a href="#l1.8700"></a><span id="l1.8700" class="difflineminus">-      continue;</span>
<a href="#l1.8701"></a><span id="l1.8701" class="difflineplus">+    if (!msgHdr) continue;</span>
<a href="#l1.8702"></a><span id="l1.8702"> </span>
<a href="#l1.8703"></a><span id="l1.8703">     bool isRead;</span>
<a href="#l1.8704"></a><span id="l1.8704">     nsMsgKey hdrMsgId;</span>
<a href="#l1.8705"></a><span id="l1.8705">     msgHdr-&gt;GetMessageKey(&amp;hdrMsgId);</span>
<a href="#l1.8706"></a><span id="l1.8706">     nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l1.8707"></a><span id="l1.8707">     nsresult rv = GetDBForHeader(msgHdr, getter_AddRefs(db));</span>
<a href="#l1.8708"></a><span id="l1.8708">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8709"></a><span id="l1.8709">     db-&gt;IsRead(hdrMsgId, &amp;isRead);</span>
<a href="#l1.8710"></a><span id="l1.8710"> </span>
<a href="#l1.8711"></a><span id="l1.8711" class="difflineminus">-    if (isRead != bRead)</span>
<a href="#l1.8712"></a><span id="l1.8712" class="difflineminus">-    {</span>
<a href="#l1.8713"></a><span id="l1.8713" class="difflineplus">+    if (isRead != bRead) {</span>
<a href="#l1.8714"></a><span id="l1.8714">       // MarkHdrRead will change the unread count on the thread.</span>
<a href="#l1.8715"></a><span id="l1.8715">       db-&gt;MarkHdrRead(msgHdr, bRead, nullptr);</span>
<a href="#l1.8716"></a><span id="l1.8716">       // Insert at the front. Should we insert at the end?</span>
<a href="#l1.8717"></a><span id="l1.8717">       idsMarkedRead.InsertElementAt(0, hdrMsgId);</span>
<a href="#l1.8718"></a><span id="l1.8718">     }</span>
<a href="#l1.8719"></a><span id="l1.8719">   }</span>
<a href="#l1.8720"></a><span id="l1.8720"> </span>
<a href="#l1.8721"></a><span id="l1.8721">   return NS_OK;</span>
<a href="#l1.8722"></a><span id="l1.8722"> }</span>
<a href="#l1.8723"></a><span id="l1.8723"> </span>
<a href="#l1.8724"></a><span id="l1.8724" class="difflineminus">-bool</span>
<a href="#l1.8725"></a><span id="l1.8725" class="difflineminus">-nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.8726"></a><span id="l1.8726" class="difflineminus">-                            uint32_t *msgFlags)</span>
<a href="#l1.8727"></a><span id="l1.8727" class="difflineminus">-{</span>
<a href="#l1.8728"></a><span id="l1.8728" class="difflineplus">+bool nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr *msgHdr, uint32_t *msgFlags) {</span>
<a href="#l1.8729"></a><span id="l1.8729">   // If we're a cross-folder view, just bail on this.</span>
<a href="#l1.8730"></a><span id="l1.8730" class="difflineminus">-  if (GetFolders())</span>
<a href="#l1.8731"></a><span id="l1.8731" class="difflineminus">-    return *msgFlags &amp; nsMsgMessageFlags::Read;</span>
<a href="#l1.8732"></a><span id="l1.8732" class="difflineplus">+  if (GetFolders()) return *msgFlags &amp; nsMsgMessageFlags::Read;</span>
<a href="#l1.8733"></a><span id="l1.8733"> </span>
<a href="#l1.8734"></a><span id="l1.8734">   bool isRead = false;</span>
<a href="#l1.8735"></a><span id="l1.8735">   nsMsgKey msgKey;</span>
<a href="#l1.8736"></a><span id="l1.8736">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l1.8737"></a><span id="l1.8737">   m_db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l1.8738"></a><span id="l1.8738">   // Just make sure flag is right in db.</span>
<a href="#l1.8739"></a><span id="l1.8739"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l1.8740"></a><span id="l1.8740">   NS_ASSERTION(isRead == ((*msgFlags &amp; nsMsgMessageFlags::Read) != 0),</span>
<a href="#l1.8741"></a><span id="l1.8741" class="difflineat">@@ -7326,317 +6351,260 @@ nsMsgDBView::AdjustReadFlag(nsIMsgDBHdr </span>
<a href="#l1.8742"></a><span id="l1.8742"> </span>
<a href="#l1.8743"></a><span id="l1.8743">   m_db-&gt;MarkHdrRead(msgHdr, isRead, nullptr);</span>
<a href="#l1.8744"></a><span id="l1.8744">   return isRead;</span>
<a href="#l1.8745"></a><span id="l1.8745"> }</span>
<a href="#l1.8746"></a><span id="l1.8746"> </span>
<a href="#l1.8747"></a><span id="l1.8747"> // Starting from startIndex, performs the passed in navigation, including</span>
<a href="#l1.8748"></a><span id="l1.8748"> // any marking read needed, and returns the resultId and resultIndex of the</span>
<a href="#l1.8749"></a><span id="l1.8749"> // destination of the navigation.  If no message is found in the view,</span>
<a href="#l1.8750"></a><span id="l1.8750" class="difflineminus">-// it returns a resultId of nsMsgKey_None and an resultIndex of nsMsgViewIndex_None.</span>
<a href="#l1.8751"></a><span id="l1.8751" class="difflineplus">+// it returns a resultId of nsMsgKey_None and an resultIndex of</span>
<a href="#l1.8752"></a><span id="l1.8752" class="difflineplus">+// nsMsgViewIndex_None.</span>
<a href="#l1.8753"></a><span id="l1.8753"> NS_IMETHODIMP</span>
<a href="#l1.8754"></a><span id="l1.8754" class="difflineminus">-nsMsgDBView::ViewNavigate(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.8755"></a><span id="l1.8755" class="difflineminus">-                          nsMsgKey *pResultKey,</span>
<a href="#l1.8756"></a><span id="l1.8756" class="difflineplus">+nsMsgDBView::ViewNavigate(nsMsgNavigationTypeValue motion, nsMsgKey *pResultKey,</span>
<a href="#l1.8757"></a><span id="l1.8757">                           nsMsgViewIndex *pResultIndex,</span>
<a href="#l1.8758"></a><span id="l1.8758" class="difflineminus">-                          nsMsgViewIndex *pThreadIndex,</span>
<a href="#l1.8759"></a><span id="l1.8759" class="difflineminus">-                          bool wrap)</span>
<a href="#l1.8760"></a><span id="l1.8760" class="difflineminus">-{</span>
<a href="#l1.8761"></a><span id="l1.8761" class="difflineplus">+                          nsMsgViewIndex *pThreadIndex, bool wrap) {</span>
<a href="#l1.8762"></a><span id="l1.8762">   NS_ENSURE_ARG_POINTER(pResultKey);</span>
<a href="#l1.8763"></a><span id="l1.8763">   NS_ENSURE_ARG_POINTER(pResultIndex);</span>
<a href="#l1.8764"></a><span id="l1.8764">   NS_ENSURE_ARG_POINTER(pThreadIndex);</span>
<a href="#l1.8765"></a><span id="l1.8765"> </span>
<a href="#l1.8766"></a><span id="l1.8766">   int32_t currentIndex;</span>
<a href="#l1.8767"></a><span id="l1.8767">   nsMsgViewIndex startIndex;</span>
<a href="#l1.8768"></a><span id="l1.8768"> </span>
<a href="#l1.8769"></a><span id="l1.8769" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.8770"></a><span id="l1.8770" class="difflineminus">-  {</span>
<a href="#l1.8771"></a><span id="l1.8771" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.8772"></a><span id="l1.8772">     // We must be in stand alone message mode.</span>
<a href="#l1.8773"></a><span id="l1.8773">     currentIndex = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.8774"></a><span id="l1.8774" class="difflineminus">-  }</span>
<a href="#l1.8775"></a><span id="l1.8775" class="difflineminus">-  else</span>
<a href="#l1.8776"></a><span id="l1.8776" class="difflineminus">-  {</span>
<a href="#l1.8777"></a><span id="l1.8777" class="difflineplus">+  } else {</span>
<a href="#l1.8778"></a><span id="l1.8778">     nsresult rv = mTreeSelection-&gt;GetCurrentIndex(&amp;currentIndex);</span>
<a href="#l1.8779"></a><span id="l1.8779">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8780"></a><span id="l1.8780">   }</span>
<a href="#l1.8781"></a><span id="l1.8781"> </span>
<a href="#l1.8782"></a><span id="l1.8782">   startIndex = currentIndex;</span>
<a href="#l1.8783"></a><span id="l1.8783" class="difflineminus">-  return nsMsgDBView::NavigateFromPos(motion,</span>
<a href="#l1.8784"></a><span id="l1.8784" class="difflineminus">-                                      startIndex,</span>
<a href="#l1.8785"></a><span id="l1.8785" class="difflineminus">-                                      pResultKey,</span>
<a href="#l1.8786"></a><span id="l1.8786" class="difflineminus">-                                      pResultIndex,</span>
<a href="#l1.8787"></a><span id="l1.8787" class="difflineminus">-                                      pThreadIndex,</span>
<a href="#l1.8788"></a><span id="l1.8788" class="difflineminus">-                                      wrap);</span>
<a href="#l1.8789"></a><span id="l1.8789" class="difflineminus">-}</span>
<a href="#l1.8790"></a><span id="l1.8790" class="difflineminus">-</span>
<a href="#l1.8791"></a><span id="l1.8791" class="difflineminus">-nsresult</span>
<a href="#l1.8792"></a><span id="l1.8792" class="difflineminus">-nsMsgDBView::NavigateFromPos(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.8793"></a><span id="l1.8793" class="difflineminus">-                             nsMsgViewIndex startIndex,</span>
<a href="#l1.8794"></a><span id="l1.8794" class="difflineminus">-                             nsMsgKey *pResultKey,</span>
<a href="#l1.8795"></a><span id="l1.8795" class="difflineminus">-                             nsMsgViewIndex *pResultIndex,</span>
<a href="#l1.8796"></a><span id="l1.8796" class="difflineminus">-                             nsMsgViewIndex *pThreadIndex,</span>
<a href="#l1.8797"></a><span id="l1.8797" class="difflineminus">-                             bool wrap)</span>
<a href="#l1.8798"></a><span id="l1.8798" class="difflineminus">-{</span>
<a href="#l1.8799"></a><span id="l1.8799" class="difflineplus">+  return nsMsgDBView::NavigateFromPos(motion, startIndex, pResultKey,</span>
<a href="#l1.8800"></a><span id="l1.8800" class="difflineplus">+                                      pResultIndex, pThreadIndex, wrap);</span>
<a href="#l1.8801"></a><span id="l1.8801" class="difflineplus">+}</span>
<a href="#l1.8802"></a><span id="l1.8802" class="difflineplus">+</span>
<a href="#l1.8803"></a><span id="l1.8803" class="difflineplus">+nsresult nsMsgDBView::NavigateFromPos(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.8804"></a><span id="l1.8804" class="difflineplus">+                                      nsMsgViewIndex startIndex,</span>
<a href="#l1.8805"></a><span id="l1.8805" class="difflineplus">+                                      nsMsgKey *pResultKey,</span>
<a href="#l1.8806"></a><span id="l1.8806" class="difflineplus">+                                      nsMsgViewIndex *pResultIndex,</span>
<a href="#l1.8807"></a><span id="l1.8807" class="difflineplus">+                                      nsMsgViewIndex *pThreadIndex, bool wrap) {</span>
<a href="#l1.8808"></a><span id="l1.8808">   nsresult rv = NS_OK;</span>
<a href="#l1.8809"></a><span id="l1.8809">   nsMsgKey resultThreadKey;</span>
<a href="#l1.8810"></a><span id="l1.8810">   nsMsgViewIndex curIndex;</span>
<a href="#l1.8811"></a><span id="l1.8811">   nsMsgViewIndex lastIndex =</span>
<a href="#l1.8812"></a><span id="l1.8812" class="difflineminus">-    (GetSize() &gt; 0) ? (nsMsgViewIndex) GetSize() - 1 : nsMsgViewIndex_None;</span>
<a href="#l1.8813"></a><span id="l1.8813" class="difflineplus">+      (GetSize() &gt; 0) ? (nsMsgViewIndex)GetSize() - 1 : nsMsgViewIndex_None;</span>
<a href="#l1.8814"></a><span id="l1.8814">   nsMsgViewIndex threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8815"></a><span id="l1.8815"> </span>
<a href="#l1.8816"></a><span id="l1.8816">   // If there aren't any messages in the view, bail out.</span>
<a href="#l1.8817"></a><span id="l1.8817" class="difflineminus">-  if (GetSize() &lt;= 0)</span>
<a href="#l1.8818"></a><span id="l1.8818" class="difflineminus">-  {</span>
<a href="#l1.8819"></a><span id="l1.8819" class="difflineplus">+  if (GetSize() &lt;= 0) {</span>
<a href="#l1.8820"></a><span id="l1.8820">     *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8821"></a><span id="l1.8821">     *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8822"></a><span id="l1.8822">     return NS_OK;</span>
<a href="#l1.8823"></a><span id="l1.8823">   }</span>
<a href="#l1.8824"></a><span id="l1.8824"> </span>
<a href="#l1.8825"></a><span id="l1.8825" class="difflineminus">-  switch (motion)</span>
<a href="#l1.8826"></a><span id="l1.8826" class="difflineminus">-  {</span>
<a href="#l1.8827"></a><span id="l1.8827" class="difflineplus">+  switch (motion) {</span>
<a href="#l1.8828"></a><span id="l1.8828">     case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.8829"></a><span id="l1.8829">       *pResultIndex = 0;</span>
<a href="#l1.8830"></a><span id="l1.8830">       *pResultKey = m_keys[0];</span>
<a href="#l1.8831"></a><span id="l1.8831">       break;</span>
<a href="#l1.8832"></a><span id="l1.8832">     case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.8833"></a><span id="l1.8833">       // Return same index and id on next on last message.</span>
<a href="#l1.8834"></a><span id="l1.8834">       *pResultIndex = std::min(startIndex + 1, lastIndex);</span>
<a href="#l1.8835"></a><span id="l1.8835">       *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8836"></a><span id="l1.8836">       break;</span>
<a href="#l1.8837"></a><span id="l1.8837">     case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.8838"></a><span id="l1.8838" class="difflineminus">-      *pResultIndex =</span>
<a href="#l1.8839"></a><span id="l1.8839" class="difflineminus">-        (startIndex != nsMsgViewIndex_None &amp;&amp; startIndex &gt; 0) ? startIndex - 1 : 0;</span>
<a href="#l1.8840"></a><span id="l1.8840" class="difflineplus">+      *pResultIndex = (startIndex != nsMsgViewIndex_None &amp;&amp; startIndex &gt; 0)</span>
<a href="#l1.8841"></a><span id="l1.8841" class="difflineplus">+                          ? startIndex - 1</span>
<a href="#l1.8842"></a><span id="l1.8842" class="difflineplus">+                          : 0;</span>
<a href="#l1.8843"></a><span id="l1.8843">       *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8844"></a><span id="l1.8844">       break;</span>
<a href="#l1.8845"></a><span id="l1.8845">     case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.8846"></a><span id="l1.8846">       *pResultIndex = lastIndex;</span>
<a href="#l1.8847"></a><span id="l1.8847">       *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8848"></a><span id="l1.8848">       break;</span>
<a href="#l1.8849"></a><span id="l1.8849">     case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.8850"></a><span id="l1.8850">       rv = FindFirstFlagged(pResultIndex);</span>
<a href="#l1.8851"></a><span id="l1.8851" class="difflineminus">-      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8852"></a><span id="l1.8852" class="difflineminus">-        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8853"></a><span id="l1.8853" class="difflineplus">+      if (IsValidIndex(*pResultIndex)) *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8854"></a><span id="l1.8854"> </span>
<a href="#l1.8855"></a><span id="l1.8855">       break;</span>
<a href="#l1.8856"></a><span id="l1.8856">     case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.8857"></a><span id="l1.8857">       rv = FindNextFlagged(startIndex + 1, pResultIndex);</span>
<a href="#l1.8858"></a><span id="l1.8858" class="difflineminus">-      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8859"></a><span id="l1.8859" class="difflineminus">-        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8860"></a><span id="l1.8860" class="difflineplus">+      if (IsValidIndex(*pResultIndex)) *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8861"></a><span id="l1.8861"> </span>
<a href="#l1.8862"></a><span id="l1.8862">       break;</span>
<a href="#l1.8863"></a><span id="l1.8863">     case nsMsgNavigationType::previousFlagged:</span>
<a href="#l1.8864"></a><span id="l1.8864">       rv = FindPrevFlagged(startIndex, pResultIndex);</span>
<a href="#l1.8865"></a><span id="l1.8865" class="difflineminus">-      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8866"></a><span id="l1.8866" class="difflineminus">-        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8867"></a><span id="l1.8867" class="difflineplus">+      if (IsValidIndex(*pResultIndex)) *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8868"></a><span id="l1.8868"> </span>
<a href="#l1.8869"></a><span id="l1.8869">       break;</span>
<a href="#l1.8870"></a><span id="l1.8870">     case nsMsgNavigationType::firstNew:</span>
<a href="#l1.8871"></a><span id="l1.8871">       rv = FindFirstNew(pResultIndex);</span>
<a href="#l1.8872"></a><span id="l1.8872" class="difflineminus">-      if (IsValidIndex(*pResultIndex))</span>
<a href="#l1.8873"></a><span id="l1.8873" class="difflineminus">-        *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8874"></a><span id="l1.8874" class="difflineplus">+      if (IsValidIndex(*pResultIndex)) *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8875"></a><span id="l1.8875"> </span>
<a href="#l1.8876"></a><span id="l1.8876">       break;</span>
<a href="#l1.8877"></a><span id="l1.8877">     case nsMsgNavigationType::firstUnreadMessage:</span>
<a href="#l1.8878"></a><span id="l1.8878">       startIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8879"></a><span id="l1.8879">       // Note fall through - is this motion ever used?</span>
<a href="#l1.8880"></a><span id="l1.8880">       MOZ_FALLTHROUGH;</span>
<a href="#l1.8881"></a><span id="l1.8881">     case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.8882"></a><span id="l1.8882">       for (curIndex = (startIndex == nsMsgViewIndex_None) ? 0 : startIndex;</span>
<a href="#l1.8883"></a><span id="l1.8883">            curIndex &lt;= lastIndex &amp;&amp; lastIndex != nsMsgViewIndex_None;</span>
<a href="#l1.8884"></a><span id="l1.8884" class="difflineminus">-           curIndex++)</span>
<a href="#l1.8885"></a><span id="l1.8885" class="difflineminus">-      {</span>
<a href="#l1.8886"></a><span id="l1.8886" class="difflineplus">+           curIndex++) {</span>
<a href="#l1.8887"></a><span id="l1.8887">         uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.8888"></a><span id="l1.8888">         // Don't return start index since navigate should move.</span>
<a href="#l1.8889"></a><span id="l1.8889">         if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp;</span>
<a href="#l1.8890"></a><span id="l1.8890" class="difflineminus">-            (curIndex != startIndex))</span>
<a href="#l1.8891"></a><span id="l1.8891" class="difflineminus">-        {</span>
<a href="#l1.8892"></a><span id="l1.8892" class="difflineplus">+            (curIndex != startIndex)) {</span>
<a href="#l1.8893"></a><span id="l1.8893">           *pResultIndex = curIndex;</span>
<a href="#l1.8894"></a><span id="l1.8894">           *pResultKey = m_keys[*pResultIndex];</span>
<a href="#l1.8895"></a><span id="l1.8895">           break;</span>
<a href="#l1.8896"></a><span id="l1.8896">         }</span>
<a href="#l1.8897"></a><span id="l1.8897"> </span>
<a href="#l1.8898"></a><span id="l1.8898">         // Check for collapsed thread with new children.</span>
<a href="#l1.8899"></a><span id="l1.8899">         if ((m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) &amp;&amp;</span>
<a href="#l1.8900"></a><span id="l1.8900">             flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.8901"></a><span id="l1.8901" class="difflineminus">-            flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.8902"></a><span id="l1.8902" class="difflineminus">-        {</span>
<a href="#l1.8903"></a><span id="l1.8903" class="difflineminus">-          nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8904"></a><span id="l1.8904" class="difflineplus">+            flags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.8905"></a><span id="l1.8905" class="difflineplus">+          nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8906"></a><span id="l1.8906">           GetThreadContainingIndex(curIndex, getter_AddRefs(threadHdr));</span>
<a href="#l1.8907"></a><span id="l1.8907">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8908"></a><span id="l1.8908"> </span>
<a href="#l1.8909"></a><span id="l1.8909">           NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8910"></a><span id="l1.8910" class="difflineminus">-          if (!threadHdr)</span>
<a href="#l1.8911"></a><span id="l1.8911" class="difflineminus">-            continue;</span>
<a href="#l1.8912"></a><span id="l1.8912" class="difflineplus">+          if (!threadHdr) continue;</span>
<a href="#l1.8913"></a><span id="l1.8913"> </span>
<a href="#l1.8914"></a><span id="l1.8914">           uint32_t numUnreadChildren;</span>
<a href="#l1.8915"></a><span id="l1.8915">           threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8916"></a><span id="l1.8916" class="difflineminus">-          if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8917"></a><span id="l1.8917" class="difflineminus">-          {</span>
<a href="#l1.8918"></a><span id="l1.8918" class="difflineplus">+          if (numUnreadChildren &gt; 0) {</span>
<a href="#l1.8919"></a><span id="l1.8919">             uint32_t numExpanded;</span>
<a href="#l1.8920"></a><span id="l1.8920">             ExpandByIndex(curIndex, &amp;numExpanded);</span>
<a href="#l1.8921"></a><span id="l1.8921">             lastIndex += numExpanded;</span>
<a href="#l1.8922"></a><span id="l1.8922" class="difflineminus">-            if (pThreadIndex)</span>
<a href="#l1.8923"></a><span id="l1.8923" class="difflineminus">-              *pThreadIndex = curIndex;</span>
<a href="#l1.8924"></a><span id="l1.8924" class="difflineplus">+            if (pThreadIndex) *pThreadIndex = curIndex;</span>
<a href="#l1.8925"></a><span id="l1.8925">           }</span>
<a href="#l1.8926"></a><span id="l1.8926">         }</span>
<a href="#l1.8927"></a><span id="l1.8927">       }</span>
<a href="#l1.8928"></a><span id="l1.8928"> </span>
<a href="#l1.8929"></a><span id="l1.8929" class="difflineminus">-      if (curIndex &gt; lastIndex)</span>
<a href="#l1.8930"></a><span id="l1.8930" class="difflineminus">-      {</span>
<a href="#l1.8931"></a><span id="l1.8931" class="difflineplus">+      if (curIndex &gt; lastIndex) {</span>
<a href="#l1.8932"></a><span id="l1.8932">         // Wrap around by starting at index 0.</span>
<a href="#l1.8933"></a><span id="l1.8933" class="difflineminus">-        if (wrap)</span>
<a href="#l1.8934"></a><span id="l1.8934" class="difflineminus">-        {</span>
<a href="#l1.8935"></a><span id="l1.8935" class="difflineplus">+        if (wrap) {</span>
<a href="#l1.8936"></a><span id="l1.8936">           nsMsgKey startKey = GetAt(startIndex);</span>
<a href="#l1.8937"></a><span id="l1.8937">           rv = NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.8938"></a><span id="l1.8938" class="difflineminus">-                               nsMsgViewIndex_None,</span>
<a href="#l1.8939"></a><span id="l1.8939" class="difflineminus">-                               pResultKey,</span>
<a href="#l1.8940"></a><span id="l1.8940" class="difflineminus">-                               pResultIndex,</span>
<a href="#l1.8941"></a><span id="l1.8941" class="difflineminus">-                               pThreadIndex,</span>
<a href="#l1.8942"></a><span id="l1.8942" class="difflineminus">-                               false);</span>
<a href="#l1.8943"></a><span id="l1.8943" class="difflineminus">-</span>
<a href="#l1.8944"></a><span id="l1.8944" class="difflineminus">-          if (*pResultKey == startKey)</span>
<a href="#l1.8945"></a><span id="l1.8945" class="difflineminus">-          {</span>
<a href="#l1.8946"></a><span id="l1.8946" class="difflineplus">+                               nsMsgViewIndex_None, pResultKey, pResultIndex,</span>
<a href="#l1.8947"></a><span id="l1.8947" class="difflineplus">+                               pThreadIndex, false);</span>
<a href="#l1.8948"></a><span id="l1.8948" class="difflineplus">+</span>
<a href="#l1.8949"></a><span id="l1.8949" class="difflineplus">+          if (*pResultKey == startKey) {</span>
<a href="#l1.8950"></a><span id="l1.8950">             // wrapped around and found start message!</span>
<a href="#l1.8951"></a><span id="l1.8951">             *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8952"></a><span id="l1.8952">             *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8953"></a><span id="l1.8953">           }</span>
<a href="#l1.8954"></a><span id="l1.8954" class="difflineminus">-        }</span>
<a href="#l1.8955"></a><span id="l1.8955" class="difflineminus">-        else</span>
<a href="#l1.8956"></a><span id="l1.8956" class="difflineminus">-        {</span>
<a href="#l1.8957"></a><span id="l1.8957" class="difflineplus">+        } else {</span>
<a href="#l1.8958"></a><span id="l1.8958">           *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.8959"></a><span id="l1.8959">           *pResultKey = nsMsgKey_None;</span>
<a href="#l1.8960"></a><span id="l1.8960">         }</span>
<a href="#l1.8961"></a><span id="l1.8961">       }</span>
<a href="#l1.8962"></a><span id="l1.8962">       break;</span>
<a href="#l1.8963"></a><span id="l1.8963">     case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.8964"></a><span id="l1.8964" class="difflineminus">-      if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8965"></a><span id="l1.8965" class="difflineminus">-        break;</span>
<a href="#l1.8966"></a><span id="l1.8966" class="difflineplus">+      if (startIndex == nsMsgViewIndex_None) break;</span>
<a href="#l1.8967"></a><span id="l1.8967"> </span>
<a href="#l1.8968"></a><span id="l1.8968">       rv = FindPrevUnread(m_keys[startIndex], pResultKey, &amp;resultThreadKey);</span>
<a href="#l1.8969"></a><span id="l1.8969" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l1.8970"></a><span id="l1.8970" class="difflineminus">-      {</span>
<a href="#l1.8971"></a><span id="l1.8971" class="difflineplus">+      if (NS_SUCCEEDED(rv)) {</span>
<a href="#l1.8972"></a><span id="l1.8972">         *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.8973"></a><span id="l1.8973">         if (*pResultKey != resultThreadKey &amp;&amp;</span>
<a href="#l1.8974"></a><span id="l1.8974" class="difflineminus">-            (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.8975"></a><span id="l1.8975" class="difflineminus">-        {</span>
<a href="#l1.8976"></a><span id="l1.8976" class="difflineminus">-          threadIndex  = GetThreadIndex(*pResultIndex);</span>
<a href="#l1.8977"></a><span id="l1.8977" class="difflineminus">-          if (*pResultIndex == nsMsgViewIndex_None)</span>
<a href="#l1.8978"></a><span id="l1.8978" class="difflineminus">-          {</span>
<a href="#l1.8979"></a><span id="l1.8979" class="difflineminus">-            nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8980"></a><span id="l1.8980" class="difflineminus">-            nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8981"></a><span id="l1.8981" class="difflineplus">+            (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) {</span>
<a href="#l1.8982"></a><span id="l1.8982" class="difflineplus">+          threadIndex = GetThreadIndex(*pResultIndex);</span>
<a href="#l1.8983"></a><span id="l1.8983" class="difflineplus">+          if (*pResultIndex == nsMsgViewIndex_None) {</span>
<a href="#l1.8984"></a><span id="l1.8984" class="difflineplus">+            nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l1.8985"></a><span id="l1.8985" class="difflineplus">+            nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.8986"></a><span id="l1.8986">             rv = m_db-&gt;GetMsgHdrForKey(*pResultKey, getter_AddRefs(msgHdr));</span>
<a href="#l1.8987"></a><span id="l1.8987">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8988"></a><span id="l1.8988">             rv = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(threadHdr));</span>
<a href="#l1.8989"></a><span id="l1.8989">             NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.8990"></a><span id="l1.8990"> </span>
<a href="#l1.8991"></a><span id="l1.8991">             NS_ASSERTION(threadHdr, &quot;threadHdr is null&quot;);</span>
<a href="#l1.8992"></a><span id="l1.8992" class="difflineminus">-            if (threadHdr)</span>
<a href="#l1.8993"></a><span id="l1.8993" class="difflineminus">-              break;</span>
<a href="#l1.8994"></a><span id="l1.8994" class="difflineplus">+            if (threadHdr) break;</span>
<a href="#l1.8995"></a><span id="l1.8995"> </span>
<a href="#l1.8996"></a><span id="l1.8996">             uint32_t numUnreadChildren;</span>
<a href="#l1.8997"></a><span id="l1.8997">             threadHdr-&gt;GetNumUnreadChildren(&amp;numUnreadChildren);</span>
<a href="#l1.8998"></a><span id="l1.8998" class="difflineminus">-            if (numUnreadChildren &gt; 0)</span>
<a href="#l1.8999"></a><span id="l1.8999" class="difflineminus">-            {</span>
<a href="#l1.9000"></a><span id="l1.9000" class="difflineplus">+            if (numUnreadChildren &gt; 0) {</span>
<a href="#l1.9001"></a><span id="l1.9001">               uint32_t numExpanded;</span>
<a href="#l1.9002"></a><span id="l1.9002">               ExpandByIndex(threadIndex, &amp;numExpanded);</span>
<a href="#l1.9003"></a><span id="l1.9003">             }</span>
<a href="#l1.9004"></a><span id="l1.9004"> </span>
<a href="#l1.9005"></a><span id="l1.9005">             *pResultIndex = FindViewIndex(*pResultKey);</span>
<a href="#l1.9006"></a><span id="l1.9006">           }</span>
<a href="#l1.9007"></a><span id="l1.9007">         }</span>
<a href="#l1.9008"></a><span id="l1.9008"> </span>
<a href="#l1.9009"></a><span id="l1.9009" class="difflineminus">-        if (pThreadIndex)</span>
<a href="#l1.9010"></a><span id="l1.9010" class="difflineminus">-          *pThreadIndex = threadIndex;</span>
<a href="#l1.9011"></a><span id="l1.9011" class="difflineplus">+        if (pThreadIndex) *pThreadIndex = threadIndex;</span>
<a href="#l1.9012"></a><span id="l1.9012">       }</span>
<a href="#l1.9013"></a><span id="l1.9013">       break;</span>
<a href="#l1.9014"></a><span id="l1.9014">     case nsMsgNavigationType::lastUnreadMessage:</span>
<a href="#l1.9015"></a><span id="l1.9015">       break;</span>
<a href="#l1.9016"></a><span id="l1.9016">     case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.9017"></a><span id="l1.9017">       if (startIndex != nsMsgViewIndex_None)</span>
<a href="#l1.9018"></a><span id="l1.9018" class="difflineminus">-        ApplyCommandToIndices(nsMsgViewCommandType::markThreadRead, &amp;startIndex, 1);</span>
<a href="#l1.9019"></a><span id="l1.9019" class="difflineminus">-</span>
<a href="#l1.9020"></a><span id="l1.9020" class="difflineminus">-      return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.9021"></a><span id="l1.9021" class="difflineminus">-                             startIndex,</span>
<a href="#l1.9022"></a><span id="l1.9022" class="difflineminus">-                             pResultKey,</span>
<a href="#l1.9023"></a><span id="l1.9023" class="difflineminus">-                             pResultIndex,</span>
<a href="#l1.9024"></a><span id="l1.9024" class="difflineminus">-                             pThreadIndex,</span>
<a href="#l1.9025"></a><span id="l1.9025" class="difflineminus">-                             true);</span>
<a href="#l1.9026"></a><span id="l1.9026" class="difflineminus">-    case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.9027"></a><span id="l1.9027" class="difflineminus">-    {</span>
<a href="#l1.9028"></a><span id="l1.9028" class="difflineplus">+        ApplyCommandToIndices(nsMsgViewCommandType::markThreadRead, &amp;startIndex,</span>
<a href="#l1.9029"></a><span id="l1.9029" class="difflineplus">+                              1);</span>
<a href="#l1.9030"></a><span id="l1.9030" class="difflineplus">+</span>
<a href="#l1.9031"></a><span id="l1.9031" class="difflineplus">+      return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage, startIndex,</span>
<a href="#l1.9032"></a><span id="l1.9032" class="difflineplus">+                             pResultKey, pResultIndex, pThreadIndex, true);</span>
<a href="#l1.9033"></a><span id="l1.9033" class="difflineplus">+    case nsMsgNavigationType::toggleThreadKilled: {</span>
<a href="#l1.9034"></a><span id="l1.9034">       bool resultKilled;</span>
<a href="#l1.9035"></a><span id="l1.9035">       nsMsgViewIndexArray selection;</span>
<a href="#l1.9036"></a><span id="l1.9036">       GetSelectedIndices(selection);</span>
<a href="#l1.9037"></a><span id="l1.9037" class="difflineminus">-      ToggleIgnored(selection.Elements(), selection.Length(), &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.9038"></a><span id="l1.9038" class="difflineminus">-      if (resultKilled)</span>
<a href="#l1.9039"></a><span id="l1.9039" class="difflineminus">-      {</span>
<a href="#l1.9040"></a><span id="l1.9040" class="difflineplus">+      ToggleIgnored(selection.Elements(), selection.Length(), &amp;threadIndex,</span>
<a href="#l1.9041"></a><span id="l1.9041" class="difflineplus">+                    &amp;resultKilled);</span>
<a href="#l1.9042"></a><span id="l1.9042" class="difflineplus">+      if (resultKilled) {</span>
<a href="#l1.9043"></a><span id="l1.9043">         return NavigateFromPos(nsMsgNavigationType::nextUnreadThread,</span>
<a href="#l1.9044"></a><span id="l1.9044" class="difflineminus">-                               threadIndex,</span>
<a href="#l1.9045"></a><span id="l1.9045" class="difflineminus">-                               pResultKey,</span>
<a href="#l1.9046"></a><span id="l1.9046" class="difflineminus">-                               pResultIndex,</span>
<a href="#l1.9047"></a><span id="l1.9047" class="difflineminus">-                               pThreadIndex,</span>
<a href="#l1.9048"></a><span id="l1.9048" class="difflineminus">-                               true);</span>
<a href="#l1.9049"></a><span id="l1.9049" class="difflineminus">-      }</span>
<a href="#l1.9050"></a><span id="l1.9050" class="difflineminus">-      else</span>
<a href="#l1.9051"></a><span id="l1.9051" class="difflineminus">-      {</span>
<a href="#l1.9052"></a><span id="l1.9052" class="difflineplus">+                               threadIndex, pResultKey, pResultIndex,</span>
<a href="#l1.9053"></a><span id="l1.9053" class="difflineplus">+                               pThreadIndex, true);</span>
<a href="#l1.9054"></a><span id="l1.9054" class="difflineplus">+      } else {</span>
<a href="#l1.9055"></a><span id="l1.9055">         *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9056"></a><span id="l1.9056">         *pResultKey = nsMsgKey_None;</span>
<a href="#l1.9057"></a><span id="l1.9057">         return NS_OK;</span>
<a href="#l1.9058"></a><span id="l1.9058">       }</span>
<a href="#l1.9059"></a><span id="l1.9059">     }</span>
<a href="#l1.9060"></a><span id="l1.9060" class="difflineminus">-    case nsMsgNavigationType::toggleSubthreadKilled:</span>
<a href="#l1.9061"></a><span id="l1.9061" class="difflineminus">-    {</span>
<a href="#l1.9062"></a><span id="l1.9062" class="difflineplus">+    case nsMsgNavigationType::toggleSubthreadKilled: {</span>
<a href="#l1.9063"></a><span id="l1.9063">       bool resultKilled;</span>
<a href="#l1.9064"></a><span id="l1.9064">       nsMsgViewIndexArray selection;</span>
<a href="#l1.9065"></a><span id="l1.9065">       GetSelectedIndices(selection);</span>
<a href="#l1.9066"></a><span id="l1.9066">       ToggleMessageKilled(selection.Elements(), selection.Length(),</span>
<a href="#l1.9067"></a><span id="l1.9067">                           &amp;threadIndex, &amp;resultKilled);</span>
<a href="#l1.9068"></a><span id="l1.9068" class="difflineminus">-      if (resultKilled)</span>
<a href="#l1.9069"></a><span id="l1.9069" class="difflineminus">-      {</span>
<a href="#l1.9070"></a><span id="l1.9070" class="difflineplus">+      if (resultKilled) {</span>
<a href="#l1.9071"></a><span id="l1.9071">         return NavigateFromPos(nsMsgNavigationType::nextUnreadMessage,</span>
<a href="#l1.9072"></a><span id="l1.9072" class="difflineminus">-                               threadIndex,</span>
<a href="#l1.9073"></a><span id="l1.9073" class="difflineminus">-                               pResultKey,</span>
<a href="#l1.9074"></a><span id="l1.9074" class="difflineminus">-                               pResultIndex,</span>
<a href="#l1.9075"></a><span id="l1.9075" class="difflineminus">-                               pThreadIndex,</span>
<a href="#l1.9076"></a><span id="l1.9076" class="difflineminus">-                               true);</span>
<a href="#l1.9077"></a><span id="l1.9077" class="difflineminus">-      }</span>
<a href="#l1.9078"></a><span id="l1.9078" class="difflineminus">-      else</span>
<a href="#l1.9079"></a><span id="l1.9079" class="difflineminus">-      {</span>
<a href="#l1.9080"></a><span id="l1.9080" class="difflineplus">+                               threadIndex, pResultKey, pResultIndex,</span>
<a href="#l1.9081"></a><span id="l1.9081" class="difflineplus">+                               pThreadIndex, true);</span>
<a href="#l1.9082"></a><span id="l1.9082" class="difflineplus">+      } else {</span>
<a href="#l1.9083"></a><span id="l1.9083">         *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9084"></a><span id="l1.9084">         *pResultKey = nsMsgKey_None;</span>
<a href="#l1.9085"></a><span id="l1.9085">         return NS_OK;</span>
<a href="#l1.9086"></a><span id="l1.9086">       }</span>
<a href="#l1.9087"></a><span id="l1.9087">     }</span>
<a href="#l1.9088"></a><span id="l1.9088">     // Check where navigate says this will take us. If we have the message</span>
<a href="#l1.9089"></a><span id="l1.9089">     // in the view, return it. Otherwise, return an error.</span>
<a href="#l1.9090"></a><span id="l1.9090">     case nsMsgNavigationType::back:</span>
<a href="#l1.9091"></a><span id="l1.9091" class="difflineminus">-    case nsMsgNavigationType::forward:</span>
<a href="#l1.9092"></a><span id="l1.9092" class="difflineminus">-    {</span>
<a href="#l1.9093"></a><span id="l1.9093" class="difflineplus">+    case nsMsgNavigationType::forward: {</span>
<a href="#l1.9094"></a><span id="l1.9094">       nsCString folderUri, msgUri;</span>
<a href="#l1.9095"></a><span id="l1.9095">       nsCString viewFolderUri;</span>
<a href="#l1.9096"></a><span id="l1.9096">       nsCOMPtr&lt;nsIMsgFolder&gt; curFolder = m_viewFolder ? m_viewFolder : m_folder;</span>
<a href="#l1.9097"></a><span id="l1.9097" class="difflineminus">-      if (curFolder)</span>
<a href="#l1.9098"></a><span id="l1.9098" class="difflineminus">-        curFolder-&gt;GetURI(viewFolderUri);</span>
<a href="#l1.9099"></a><span id="l1.9099" class="difflineminus">-</span>
<a href="#l1.9100"></a><span id="l1.9100" class="difflineminus">-      int32_t relPos = (motion == nsMsgNavigationType::forward) ?</span>
<a href="#l1.9101"></a><span id="l1.9101" class="difflineminus">-                         1 :</span>
<a href="#l1.9102"></a><span id="l1.9102" class="difflineminus">-                         (m_currentlyDisplayedMsgKey != nsMsgKey_None) ? -1 : 0;</span>
<a href="#l1.9103"></a><span id="l1.9103" class="difflineplus">+      if (curFolder) curFolder-&gt;GetURI(viewFolderUri);</span>
<a href="#l1.9104"></a><span id="l1.9104" class="difflineplus">+</span>
<a href="#l1.9105"></a><span id="l1.9105" class="difflineplus">+      // clang-format off</span>
<a href="#l1.9106"></a><span id="l1.9106" class="difflineplus">+      int32_t relPos = (motion == nsMsgNavigationType::forward)</span>
<a href="#l1.9107"></a><span id="l1.9107" class="difflineplus">+              ? 1 : (m_currentlyDisplayedMsgKey != nsMsgKey_None) ? -1 : 0;</span>
<a href="#l1.9108"></a><span id="l1.9108" class="difflineplus">+      // clang-format off</span>
<a href="#l1.9109"></a><span id="l1.9109">       int32_t curPos;</span>
<a href="#l1.9110"></a><span id="l1.9110">       nsresult rv;</span>
<a href="#l1.9111"></a><span id="l1.9111">       nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak, &amp;rv));</span>
<a href="#l1.9112"></a><span id="l1.9112">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9113"></a><span id="l1.9113">       rv = messenger-&gt;GetFolderUriAtNavigatePos(relPos, folderUri);</span>
<a href="#l1.9114"></a><span id="l1.9114">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9115"></a><span id="l1.9115">       // Empty viewFolderUri means we're in a search results view.</span>
<a href="#l1.9116"></a><span id="l1.9116" class="difflineminus">-      if (viewFolderUri.IsEmpty() || folderUri.Equals(viewFolderUri))</span>
<a href="#l1.9117"></a><span id="l1.9117" class="difflineminus">-      {</span>
<a href="#l1.9118"></a><span id="l1.9118" class="difflineplus">+      if (viewFolderUri.IsEmpty() || folderUri.Equals(viewFolderUri)) {</span>
<a href="#l1.9119"></a><span id="l1.9119">         nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l1.9120"></a><span id="l1.9120">         rv = messenger-&gt;GetMsgUriAtNavigatePos(relPos, msgUri);</span>
<a href="#l1.9121"></a><span id="l1.9121">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9122"></a><span id="l1.9122">         messenger-&gt;MsgHdrFromURI(msgUri, getter_AddRefs(msgHdr));</span>
<a href="#l1.9123"></a><span id="l1.9123" class="difflineminus">-        if (msgHdr)</span>
<a href="#l1.9124"></a><span id="l1.9124" class="difflineminus">-        {</span>
<a href="#l1.9125"></a><span id="l1.9125" class="difflineplus">+        if (msgHdr) {</span>
<a href="#l1.9126"></a><span id="l1.9126">           messenger-&gt;GetNavigatePos(&amp;curPos);</span>
<a href="#l1.9127"></a><span id="l1.9127">           curPos += relPos;</span>
<a href="#l1.9128"></a><span id="l1.9128">           *pResultIndex = FindHdr(msgHdr);</span>
<a href="#l1.9129"></a><span id="l1.9129">           messenger-&gt;SetNavigatePos(curPos);</span>
<a href="#l1.9130"></a><span id="l1.9130">           msgHdr-&gt;GetMessageKey(pResultKey);</span>
<a href="#l1.9131"></a><span id="l1.9131">           return NS_OK;</span>
<a href="#l1.9132"></a><span id="l1.9132">         }</span>
<a href="#l1.9133"></a><span id="l1.9133">       }</span>
<a href="#l1.9134"></a><span id="l1.9134" class="difflineat">@@ -7649,51 +6617,45 @@ nsMsgDBView::NavigateFromPos(nsMsgNaviga</span>
<a href="#l1.9135"></a><span id="l1.9135">       NS_ERROR(&quot;unsupported motion&quot;);</span>
<a href="#l1.9136"></a><span id="l1.9136">       break;</span>
<a href="#l1.9137"></a><span id="l1.9137">   }</span>
<a href="#l1.9138"></a><span id="l1.9138"> </span>
<a href="#l1.9139"></a><span id="l1.9139">   return NS_OK;</span>
<a href="#l1.9140"></a><span id="l1.9140"> }</span>
<a href="#l1.9141"></a><span id="l1.9141"> </span>
<a href="#l1.9142"></a><span id="l1.9142"> NS_IMETHODIMP</span>
<a href="#l1.9143"></a><span id="l1.9143" class="difflineminus">-nsMsgDBView::NavigateStatus(nsMsgNavigationTypeValue motion,</span>
<a href="#l1.9144"></a><span id="l1.9144" class="difflineminus">-                            bool *_retval)</span>
<a href="#l1.9145"></a><span id="l1.9145" class="difflineminus">-{</span>
<a href="#l1.9146"></a><span id="l1.9146" class="difflineplus">+nsMsgDBView::NavigateStatus(nsMsgNavigationTypeValue motion, bool *_retval) {</span>
<a href="#l1.9147"></a><span id="l1.9147">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.9148"></a><span id="l1.9148"> </span>
<a href="#l1.9149"></a><span id="l1.9149">   bool enable = false;</span>
<a href="#l1.9150"></a><span id="l1.9150">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l1.9151"></a><span id="l1.9151">   nsMsgKey resultKey = nsMsgKey_None;</span>
<a href="#l1.9152"></a><span id="l1.9152">   int32_t index = nsMsgKey_None;</span>
<a href="#l1.9153"></a><span id="l1.9153">   nsMsgViewIndex resultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9154"></a><span id="l1.9154">   if (mTreeSelection)</span>
<a href="#l1.9155"></a><span id="l1.9155" class="difflineminus">-    (void) mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.9156"></a><span id="l1.9156" class="difflineplus">+    (void)mTreeSelection-&gt;GetCurrentIndex(&amp;index);</span>
<a href="#l1.9157"></a><span id="l1.9157">   else</span>
<a href="#l1.9158"></a><span id="l1.9158">     index = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.9159"></a><span id="l1.9159"> </span>
<a href="#l1.9160"></a><span id="l1.9160">   nsCOMPtr&lt;nsIMessenger&gt; messenger(do_QueryReferent(mMessengerWeak));</span>
<a href="#l1.9161"></a><span id="l1.9161">   // Warning - we no longer validate index up front because fe passes in -1</span>
<a href="#l1.9162"></a><span id="l1.9162">   // for no selection, so if you use index, be sure to validate it before</span>
<a href="#l1.9163"></a><span id="l1.9163">   // using it as an array index.</span>
<a href="#l1.9164"></a><span id="l1.9164" class="difflineminus">-  switch (motion)</span>
<a href="#l1.9165"></a><span id="l1.9165" class="difflineminus">-  {</span>
<a href="#l1.9166"></a><span id="l1.9166" class="difflineplus">+  switch (motion) {</span>
<a href="#l1.9167"></a><span id="l1.9167">     case nsMsgNavigationType::firstMessage:</span>
<a href="#l1.9168"></a><span id="l1.9168">     case nsMsgNavigationType::lastMessage:</span>
<a href="#l1.9169"></a><span id="l1.9169" class="difflineminus">-      if (GetSize() &gt; 0)</span>
<a href="#l1.9170"></a><span id="l1.9170" class="difflineminus">-        enable = true;</span>
<a href="#l1.9171"></a><span id="l1.9171" class="difflineplus">+      if (GetSize() &gt; 0) enable = true;</span>
<a href="#l1.9172"></a><span id="l1.9172"> </span>
<a href="#l1.9173"></a><span id="l1.9173">       break;</span>
<a href="#l1.9174"></a><span id="l1.9174">     case nsMsgNavigationType::nextMessage:</span>
<a href="#l1.9175"></a><span id="l1.9175" class="difflineminus">-      if (IsValidIndex(index) &amp;&amp; uint32_t(index) &lt; GetSize() - 1)</span>
<a href="#l1.9176"></a><span id="l1.9176" class="difflineminus">-        enable = true;</span>
<a href="#l1.9177"></a><span id="l1.9177" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; uint32_t(index) &lt; GetSize() - 1) enable = true;</span>
<a href="#l1.9178"></a><span id="l1.9178"> </span>
<a href="#l1.9179"></a><span id="l1.9179">       break;</span>
<a href="#l1.9180"></a><span id="l1.9180">     case nsMsgNavigationType::previousMessage:</span>
<a href="#l1.9181"></a><span id="l1.9181" class="difflineminus">-      if (IsValidIndex(index) &amp;&amp; index != 0 &amp;&amp; GetSize() &gt; 1)</span>
<a href="#l1.9182"></a><span id="l1.9182" class="difflineminus">-        enable = true;</span>
<a href="#l1.9183"></a><span id="l1.9183" class="difflineplus">+      if (IsValidIndex(index) &amp;&amp; index != 0 &amp;&amp; GetSize() &gt; 1) enable = true;</span>
<a href="#l1.9184"></a><span id="l1.9184"> </span>
<a href="#l1.9185"></a><span id="l1.9185">       break;</span>
<a href="#l1.9186"></a><span id="l1.9186">     case nsMsgNavigationType::firstFlagged:</span>
<a href="#l1.9187"></a><span id="l1.9187">       rv = FindFirstFlagged(&amp;resultIndex);</span>
<a href="#l1.9188"></a><span id="l1.9188">       enable = (NS_SUCCEEDED(rv) &amp;&amp; resultIndex != nsMsgViewIndex_None);</span>
<a href="#l1.9189"></a><span id="l1.9189">       break;</span>
<a href="#l1.9190"></a><span id="l1.9190">     case nsMsgNavigationType::nextFlagged:</span>
<a href="#l1.9191"></a><span id="l1.9191">       rv = FindNextFlagged(index + 1, &amp;resultIndex);</span>
<a href="#l1.9192"></a><span id="l1.9192" class="difflineat">@@ -7716,38 +6678,36 @@ nsMsgDBView::NavigateStatus(nsMsgNavigat</span>
<a href="#l1.9193"></a><span id="l1.9193">     case nsMsgNavigationType::nextFolder:</span>
<a href="#l1.9194"></a><span id="l1.9194">     case nsMsgNavigationType::nextUnreadThread:</span>
<a href="#l1.9195"></a><span id="l1.9195">     case nsMsgNavigationType::nextUnreadMessage:</span>
<a href="#l1.9196"></a><span id="l1.9196">     case nsMsgNavigationType::toggleThreadKilled:</span>
<a href="#l1.9197"></a><span id="l1.9197">       // Always enabled.</span>
<a href="#l1.9198"></a><span id="l1.9198">       enable = true;</span>
<a href="#l1.9199"></a><span id="l1.9199">       break;</span>
<a href="#l1.9200"></a><span id="l1.9200">     case nsMsgNavigationType::previousUnreadMessage:</span>
<a href="#l1.9201"></a><span id="l1.9201" class="difflineminus">-      if (IsValidIndex(index))</span>
<a href="#l1.9202"></a><span id="l1.9202" class="difflineminus">-      {</span>
<a href="#l1.9203"></a><span id="l1.9203" class="difflineplus">+      if (IsValidIndex(index)) {</span>
<a href="#l1.9204"></a><span id="l1.9204">         nsMsgKey threadId;</span>
<a href="#l1.9205"></a><span id="l1.9205">         rv = FindPrevUnread(m_keys[index], &amp;resultKey, &amp;threadId);</span>
<a href="#l1.9206"></a><span id="l1.9206">         enable = (resultKey != nsMsgKey_None);</span>
<a href="#l1.9207"></a><span id="l1.9207">       }</span>
<a href="#l1.9208"></a><span id="l1.9208">       break;</span>
<a href="#l1.9209"></a><span id="l1.9209">     case nsMsgNavigationType::forward:</span>
<a href="#l1.9210"></a><span id="l1.9210">     case nsMsgNavigationType::back:</span>
<a href="#l1.9211"></a><span id="l1.9211">       uint32_t curPos;</span>
<a href="#l1.9212"></a><span id="l1.9212">       uint32_t historyCount;</span>
<a href="#l1.9213"></a><span id="l1.9213" class="difflineminus">-      if (messenger)</span>
<a href="#l1.9214"></a><span id="l1.9214" class="difflineminus">-      {</span>
<a href="#l1.9215"></a><span id="l1.9215" class="difflineplus">+      if (messenger) {</span>
<a href="#l1.9216"></a><span id="l1.9216">         messenger-&gt;GetNavigateHistory(&amp;curPos, &amp;historyCount, nullptr);</span>
<a href="#l1.9217"></a><span id="l1.9217" class="difflineminus">-        int32_t desiredPos = (int32_t) curPos;</span>
<a href="#l1.9218"></a><span id="l1.9218" class="difflineplus">+        int32_t desiredPos = (int32_t)curPos;</span>
<a href="#l1.9219"></a><span id="l1.9219">         if (motion == nsMsgNavigationType::forward)</span>
<a href="#l1.9220"></a><span id="l1.9220">           desiredPos++;</span>
<a href="#l1.9221"></a><span id="l1.9221">         else</span>
<a href="#l1.9222"></a><span id="l1.9222">           //? operator code didn't work for me.</span>
<a href="#l1.9223"></a><span id="l1.9223">           desiredPos--;</span>
<a href="#l1.9224"></a><span id="l1.9224"> </span>
<a href="#l1.9225"></a><span id="l1.9225" class="difflineminus">-        enable = (desiredPos &gt;= 0 &amp;&amp; desiredPos &lt; (int32_t) historyCount / 2);</span>
<a href="#l1.9226"></a><span id="l1.9226" class="difflineplus">+        enable = (desiredPos &gt;= 0 &amp;&amp; desiredPos &lt; (int32_t)historyCount / 2);</span>
<a href="#l1.9227"></a><span id="l1.9227">       }</span>
<a href="#l1.9228"></a><span id="l1.9228">       break;</span>
<a href="#l1.9229"></a><span id="l1.9229">     default:</span>
<a href="#l1.9230"></a><span id="l1.9230">       NS_ERROR(&quot;unexpected&quot;);</span>
<a href="#l1.9231"></a><span id="l1.9231">       break;</span>
<a href="#l1.9232"></a><span id="l1.9232">   }</span>
<a href="#l1.9233"></a><span id="l1.9233"> </span>
<a href="#l1.9234"></a><span id="l1.9234">   *_retval = enable;</span>
<a href="#l1.9235"></a><span id="l1.9235" class="difflineat">@@ -7755,976 +6715,824 @@ nsMsgDBView::NavigateStatus(nsMsgNavigat</span>
<a href="#l1.9236"></a><span id="l1.9236"> }</span>
<a href="#l1.9237"></a><span id="l1.9237"> </span>
<a href="#l1.9238"></a><span id="l1.9238"> // Note that these routines do NOT expand collapsed threads! This mimics the</span>
<a href="#l1.9239"></a><span id="l1.9239"> // old behaviour, but it's also because we don't remember whether a thread</span>
<a href="#l1.9240"></a><span id="l1.9240"> // contains a flagged message the same way we remember if a thread contains</span>
<a href="#l1.9241"></a><span id="l1.9241"> // new messages. It would be painful to dive down into each collapsed thread</span>
<a href="#l1.9242"></a><span id="l1.9242"> // to update navigate status. We could cache this info, but it would still be</span>
<a href="#l1.9243"></a><span id="l1.9243"> // expensive the first time this status needs to get updated.</span>
<a href="#l1.9244"></a><span id="l1.9244" class="difflineminus">-nsresult</span>
<a href="#l1.9245"></a><span id="l1.9245" class="difflineminus">-nsMsgDBView::FindNextFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9246"></a><span id="l1.9246" class="difflineminus">-                             nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9247"></a><span id="l1.9247" class="difflineminus">-{</span>
<a href="#l1.9248"></a><span id="l1.9248" class="difflineminus">-  nsMsgViewIndex lastIndex = (nsMsgViewIndex) GetSize() - 1;</span>
<a href="#l1.9249"></a><span id="l1.9249" class="difflineplus">+nsresult nsMsgDBView::FindNextFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9250"></a><span id="l1.9250" class="difflineplus">+                                      nsMsgViewIndex *pResultIndex) {</span>
<a href="#l1.9251"></a><span id="l1.9251" class="difflineplus">+  nsMsgViewIndex lastIndex = (nsMsgViewIndex)GetSize() - 1;</span>
<a href="#l1.9252"></a><span id="l1.9252">   nsMsgViewIndex curIndex;</span>
<a href="#l1.9253"></a><span id="l1.9253"> </span>
<a href="#l1.9254"></a><span id="l1.9254">   *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9255"></a><span id="l1.9255"> </span>
<a href="#l1.9256"></a><span id="l1.9256" class="difflineminus">-  if (GetSize() &gt; 0)</span>
<a href="#l1.9257"></a><span id="l1.9257" class="difflineminus">-  {</span>
<a href="#l1.9258"></a><span id="l1.9258" class="difflineminus">-    for (curIndex = startIndex; curIndex &lt;= lastIndex; curIndex++)</span>
<a href="#l1.9259"></a><span id="l1.9259" class="difflineminus">-    {</span>
<a href="#l1.9260"></a><span id="l1.9260" class="difflineplus">+  if (GetSize() &gt; 0) {</span>
<a href="#l1.9261"></a><span id="l1.9261" class="difflineplus">+    for (curIndex = startIndex; curIndex &lt;= lastIndex; curIndex++) {</span>
<a href="#l1.9262"></a><span id="l1.9262">       uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9263"></a><span id="l1.9263" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9264"></a><span id="l1.9264" class="difflineminus">-      {</span>
<a href="#l1.9265"></a><span id="l1.9265" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked) {</span>
<a href="#l1.9266"></a><span id="l1.9266">         *pResultIndex = curIndex;</span>
<a href="#l1.9267"></a><span id="l1.9267">         break;</span>
<a href="#l1.9268"></a><span id="l1.9268">       }</span>
<a href="#l1.9269"></a><span id="l1.9269">     }</span>
<a href="#l1.9270"></a><span id="l1.9270">   }</span>
<a href="#l1.9271"></a><span id="l1.9271"> </span>
<a href="#l1.9272"></a><span id="l1.9272">   return NS_OK;</span>
<a href="#l1.9273"></a><span id="l1.9273"> }</span>
<a href="#l1.9274"></a><span id="l1.9274"> </span>
<a href="#l1.9275"></a><span id="l1.9275" class="difflineminus">-nsresult</span>
<a href="#l1.9276"></a><span id="l1.9276" class="difflineminus">-nsMsgDBView::FindFirstNew(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9277"></a><span id="l1.9277" class="difflineminus">-{</span>
<a href="#l1.9278"></a><span id="l1.9278" class="difflineminus">-  if (m_db)</span>
<a href="#l1.9279"></a><span id="l1.9279" class="difflineminus">-  {</span>
<a href="#l1.9280"></a><span id="l1.9280" class="difflineplus">+nsresult nsMsgDBView::FindFirstNew(nsMsgViewIndex *pResultIndex) {</span>
<a href="#l1.9281"></a><span id="l1.9281" class="difflineplus">+  if (m_db) {</span>
<a href="#l1.9282"></a><span id="l1.9282">     nsMsgKey firstNewKey = nsMsgKey_None;</span>
<a href="#l1.9283"></a><span id="l1.9283">     m_db-&gt;GetFirstNew(&amp;firstNewKey);</span>
<a href="#l1.9284"></a><span id="l1.9284" class="difflineminus">-    *pResultIndex = (firstNewKey != nsMsgKey_None) ?</span>
<a href="#l1.9285"></a><span id="l1.9285" class="difflineminus">-                      FindKey(firstNewKey, true) : nsMsgViewIndex_None;</span>
<a href="#l1.9286"></a><span id="l1.9286" class="difflineminus">-  }</span>
<a href="#l1.9287"></a><span id="l1.9287" class="difflineminus">-</span>
<a href="#l1.9288"></a><span id="l1.9288" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9289"></a><span id="l1.9289" class="difflineminus">-}</span>
<a href="#l1.9290"></a><span id="l1.9290" class="difflineminus">-</span>
<a href="#l1.9291"></a><span id="l1.9291" class="difflineminus">-nsresult</span>
<a href="#l1.9292"></a><span id="l1.9292" class="difflineminus">-nsMsgDBView::FindPrevUnread(nsMsgKey startKey,</span>
<a href="#l1.9293"></a><span id="l1.9293" class="difflineminus">-                            nsMsgKey *pResultKey,</span>
<a href="#l1.9294"></a><span id="l1.9294" class="difflineminus">-                            nsMsgKey *resultThreadId)</span>
<a href="#l1.9295"></a><span id="l1.9295" class="difflineminus">-{</span>
<a href="#l1.9296"></a><span id="l1.9296" class="difflineplus">+    *pResultIndex = (firstNewKey != nsMsgKey_None) ? FindKey(firstNewKey, true)</span>
<a href="#l1.9297"></a><span id="l1.9297" class="difflineplus">+                                                   : nsMsgViewIndex_None;</span>
<a href="#l1.9298"></a><span id="l1.9298" class="difflineplus">+  }</span>
<a href="#l1.9299"></a><span id="l1.9299" class="difflineplus">+</span>
<a href="#l1.9300"></a><span id="l1.9300" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9301"></a><span id="l1.9301" class="difflineplus">+}</span>
<a href="#l1.9302"></a><span id="l1.9302" class="difflineplus">+</span>
<a href="#l1.9303"></a><span id="l1.9303" class="difflineplus">+nsresult nsMsgDBView::FindPrevUnread(nsMsgKey startKey, nsMsgKey *pResultKey,</span>
<a href="#l1.9304"></a><span id="l1.9304" class="difflineplus">+                                     nsMsgKey *resultThreadId) {</span>
<a href="#l1.9305"></a><span id="l1.9305">   nsMsgViewIndex startIndex = FindViewIndex(startKey);</span>
<a href="#l1.9306"></a><span id="l1.9306">   nsMsgViewIndex curIndex = startIndex;</span>
<a href="#l1.9307"></a><span id="l1.9307">   nsresult rv = NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9308"></a><span id="l1.9308"> </span>
<a href="#l1.9309"></a><span id="l1.9309" class="difflineminus">-  if (startIndex == nsMsgViewIndex_None)</span>
<a href="#l1.9310"></a><span id="l1.9310" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9311"></a><span id="l1.9311" class="difflineplus">+  if (startIndex == nsMsgViewIndex_None) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.9312"></a><span id="l1.9312"> </span>
<a href="#l1.9313"></a><span id="l1.9313">   *pResultKey = nsMsgKey_None;</span>
<a href="#l1.9314"></a><span id="l1.9314" class="difflineminus">-  if (resultThreadId)</span>
<a href="#l1.9315"></a><span id="l1.9315" class="difflineminus">-    *resultThreadId = nsMsgKey_None;</span>
<a href="#l1.9316"></a><span id="l1.9316" class="difflineminus">-</span>
<a href="#l1.9317"></a><span id="l1.9317" class="difflineminus">-  for (; (int) curIndex &gt;= 0 &amp;&amp; (*pResultKey == nsMsgKey_None); curIndex--)</span>
<a href="#l1.9318"></a><span id="l1.9318" class="difflineminus">-  {</span>
<a href="#l1.9319"></a><span id="l1.9319" class="difflineplus">+  if (resultThreadId) *resultThreadId = nsMsgKey_None;</span>
<a href="#l1.9320"></a><span id="l1.9320" class="difflineplus">+</span>
<a href="#l1.9321"></a><span id="l1.9321" class="difflineplus">+  for (; (int)curIndex &gt;= 0 &amp;&amp; (*pResultKey == nsMsgKey_None); curIndex--) {</span>
<a href="#l1.9322"></a><span id="l1.9322">     uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9323"></a><span id="l1.9323" class="difflineminus">-    if (curIndex != startIndex &amp;&amp;</span>
<a href="#l1.9324"></a><span id="l1.9324" class="difflineminus">-        flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.9325"></a><span id="l1.9325" class="difflineminus">-        flags &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.9326"></a><span id="l1.9326" class="difflineminus">-    {</span>
<a href="#l1.9327"></a><span id="l1.9327" class="difflineplus">+    if (curIndex != startIndex &amp;&amp; flags &amp; MSG_VIEW_FLAG_ISTHREAD &amp;&amp;</span>
<a href="#l1.9328"></a><span id="l1.9328" class="difflineplus">+        flags &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.9329"></a><span id="l1.9329">       NS_ERROR(&quot;fix this&quot;);</span>
<a href="#l1.9330"></a><span id="l1.9330">       // nsMsgKey threadId = m_keys[curIndex];</span>
<a href="#l1.9331"></a><span id="l1.9331">       // rv = m_db-&gt;GetUnreadKeyInThread(threadId, pResultKey, resultThreadId);</span>
<a href="#l1.9332"></a><span id="l1.9332" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; (*pResultKey != nsMsgKey_None))</span>
<a href="#l1.9333"></a><span id="l1.9333" class="difflineminus">-        break;</span>
<a href="#l1.9334"></a><span id="l1.9334" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; (*pResultKey != nsMsgKey_None)) break;</span>
<a href="#l1.9335"></a><span id="l1.9335">     }</span>
<a href="#l1.9336"></a><span id="l1.9336"> </span>
<a href="#l1.9337"></a><span id="l1.9337">     if (!(flags &amp; (nsMsgMessageFlags::Read | MSG_VIEW_FLAG_DUMMY)) &amp;&amp;</span>
<a href="#l1.9338"></a><span id="l1.9338" class="difflineminus">-        (curIndex != startIndex))</span>
<a href="#l1.9339"></a><span id="l1.9339" class="difflineminus">-    {</span>
<a href="#l1.9340"></a><span id="l1.9340" class="difflineplus">+        (curIndex != startIndex)) {</span>
<a href="#l1.9341"></a><span id="l1.9341">       *pResultKey = m_keys[curIndex];</span>
<a href="#l1.9342"></a><span id="l1.9342">       rv = NS_OK;</span>
<a href="#l1.9343"></a><span id="l1.9343">       break;</span>
<a href="#l1.9344"></a><span id="l1.9344">     }</span>
<a href="#l1.9345"></a><span id="l1.9345">   }</span>
<a href="#l1.9346"></a><span id="l1.9346"> </span>
<a href="#l1.9347"></a><span id="l1.9347">   // Found unread message but we don't know the thread.</span>
<a href="#l1.9348"></a><span id="l1.9348" class="difflineminus">-  NS_ASSERTION(!(*pResultKey != nsMsgKey_None &amp;&amp;</span>
<a href="#l1.9349"></a><span id="l1.9349" class="difflineminus">-               resultThreadId &amp;&amp;</span>
<a href="#l1.9350"></a><span id="l1.9350" class="difflineminus">-               *resultThreadId == nsMsgKey_None), &quot;fix this&quot;);</span>
<a href="#l1.9351"></a><span id="l1.9351" class="difflineplus">+  NS_ASSERTION(!(*pResultKey != nsMsgKey_None &amp;&amp; resultThreadId &amp;&amp;</span>
<a href="#l1.9352"></a><span id="l1.9352" class="difflineplus">+                 *resultThreadId == nsMsgKey_None),</span>
<a href="#l1.9353"></a><span id="l1.9353" class="difflineplus">+               &quot;fix this&quot;);</span>
<a href="#l1.9354"></a><span id="l1.9354">   return rv;</span>
<a href="#l1.9355"></a><span id="l1.9355"> }</span>
<a href="#l1.9356"></a><span id="l1.9356"> </span>
<a href="#l1.9357"></a><span id="l1.9357" class="difflineminus">-nsresult</span>
<a href="#l1.9358"></a><span id="l1.9358" class="difflineminus">-nsMsgDBView::FindFirstFlagged(nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9359"></a><span id="l1.9359" class="difflineminus">-{</span>
<a href="#l1.9360"></a><span id="l1.9360" class="difflineplus">+nsresult nsMsgDBView::FindFirstFlagged(nsMsgViewIndex *pResultIndex) {</span>
<a href="#l1.9361"></a><span id="l1.9361">   return FindNextFlagged(0, pResultIndex);</span>
<a href="#l1.9362"></a><span id="l1.9362"> }</span>
<a href="#l1.9363"></a><span id="l1.9363"> </span>
<a href="#l1.9364"></a><span id="l1.9364" class="difflineminus">-nsresult</span>
<a href="#l1.9365"></a><span id="l1.9365" class="difflineminus">-nsMsgDBView::FindPrevFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9366"></a><span id="l1.9366" class="difflineminus">-                             nsMsgViewIndex *pResultIndex)</span>
<a href="#l1.9367"></a><span id="l1.9367" class="difflineminus">-{</span>
<a href="#l1.9368"></a><span id="l1.9368" class="difflineplus">+nsresult nsMsgDBView::FindPrevFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l1.9369"></a><span id="l1.9369" class="difflineplus">+                                      nsMsgViewIndex *pResultIndex) {</span>
<a href="#l1.9370"></a><span id="l1.9370">   nsMsgViewIndex curIndex;</span>
<a href="#l1.9371"></a><span id="l1.9371"> </span>
<a href="#l1.9372"></a><span id="l1.9372">   *pResultIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9373"></a><span id="l1.9373"> </span>
<a href="#l1.9374"></a><span id="l1.9374" class="difflineminus">-  if (GetSize() &gt; 0 &amp;&amp; IsValidIndex(startIndex))</span>
<a href="#l1.9375"></a><span id="l1.9375" class="difflineminus">-  {</span>
<a href="#l1.9376"></a><span id="l1.9376" class="difflineplus">+  if (GetSize() &gt; 0 &amp;&amp; IsValidIndex(startIndex)) {</span>
<a href="#l1.9377"></a><span id="l1.9377">     curIndex = startIndex;</span>
<a href="#l1.9378"></a><span id="l1.9378" class="difflineminus">-    do</span>
<a href="#l1.9379"></a><span id="l1.9379" class="difflineminus">-    {</span>
<a href="#l1.9380"></a><span id="l1.9380" class="difflineminus">-      if (curIndex != 0)</span>
<a href="#l1.9381"></a><span id="l1.9381" class="difflineminus">-        curIndex--;</span>
<a href="#l1.9382"></a><span id="l1.9382" class="difflineplus">+    do {</span>
<a href="#l1.9383"></a><span id="l1.9383" class="difflineplus">+      if (curIndex != 0) curIndex--;</span>
<a href="#l1.9384"></a><span id="l1.9384"> </span>
<a href="#l1.9385"></a><span id="l1.9385">       uint32_t flags = m_flags[curIndex];</span>
<a href="#l1.9386"></a><span id="l1.9386" class="difflineminus">-      if (flags &amp; nsMsgMessageFlags::Marked)</span>
<a href="#l1.9387"></a><span id="l1.9387" class="difflineminus">-      {</span>
<a href="#l1.9388"></a><span id="l1.9388" class="difflineplus">+      if (flags &amp; nsMsgMessageFlags::Marked) {</span>
<a href="#l1.9389"></a><span id="l1.9389">         *pResultIndex = curIndex;</span>
<a href="#l1.9390"></a><span id="l1.9390">         break;</span>
<a href="#l1.9391"></a><span id="l1.9391">       }</span>
<a href="#l1.9392"></a><span id="l1.9392">     } while (curIndex != 0);</span>
<a href="#l1.9393"></a><span id="l1.9393">   }</span>
<a href="#l1.9394"></a><span id="l1.9394"> </span>
<a href="#l1.9395"></a><span id="l1.9395">   return NS_OK;</span>
<a href="#l1.9396"></a><span id="l1.9396"> }</span>
<a href="#l1.9397"></a><span id="l1.9397"> </span>
<a href="#l1.9398"></a><span id="l1.9398" class="difflineminus">-bool</span>
<a href="#l1.9399"></a><span id="l1.9399" class="difflineminus">-nsMsgDBView::IsValidIndex(nsMsgViewIndex index)</span>
<a href="#l1.9400"></a><span id="l1.9400" class="difflineminus">-{</span>
<a href="#l1.9401"></a><span id="l1.9401" class="difflineplus">+bool nsMsgDBView::IsValidIndex(nsMsgViewIndex index) {</span>
<a href="#l1.9402"></a><span id="l1.9402">   return index != nsMsgViewIndex_None &amp;&amp;</span>
<a href="#l1.9403"></a><span id="l1.9403" class="difflineminus">-         (index &lt; (nsMsgViewIndex) m_keys.Length());</span>
<a href="#l1.9404"></a><span id="l1.9404" class="difflineminus">-}</span>
<a href="#l1.9405"></a><span id="l1.9405" class="difflineminus">-</span>
<a href="#l1.9406"></a><span id="l1.9406" class="difflineminus">-nsresult</span>
<a href="#l1.9407"></a><span id="l1.9407" class="difflineminus">-nsMsgDBView::OrExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9408"></a><span id="l1.9408" class="difflineminus">-                         uint32_t orflag)</span>
<a href="#l1.9409"></a><span id="l1.9409" class="difflineminus">-{</span>
<a href="#l1.9410"></a><span id="l1.9410" class="difflineminus">-  uint32_t  flag;</span>
<a href="#l1.9411"></a><span id="l1.9411" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.9412"></a><span id="l1.9412" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9413"></a><span id="l1.9413" class="difflineplus">+         (index &lt; (nsMsgViewIndex)m_keys.Length());</span>
<a href="#l1.9414"></a><span id="l1.9414" class="difflineplus">+}</span>
<a href="#l1.9415"></a><span id="l1.9415" class="difflineplus">+</span>
<a href="#l1.9416"></a><span id="l1.9416" class="difflineplus">+nsresult nsMsgDBView::OrExtraFlag(nsMsgViewIndex index, uint32_t orflag) {</span>
<a href="#l1.9417"></a><span id="l1.9417" class="difflineplus">+  uint32_t flag;</span>
<a href="#l1.9418"></a><span id="l1.9418" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9419"></a><span id="l1.9419"> </span>
<a href="#l1.9420"></a><span id="l1.9420">   flag = m_flags[index];</span>
<a href="#l1.9421"></a><span id="l1.9421">   flag |= orflag;</span>
<a href="#l1.9422"></a><span id="l1.9422">   m_flags[index] = flag;</span>
<a href="#l1.9423"></a><span id="l1.9423">   OnExtraFlagChanged(index, flag);</span>
<a href="#l1.9424"></a><span id="l1.9424">   return NS_OK;</span>
<a href="#l1.9425"></a><span id="l1.9425"> }</span>
<a href="#l1.9426"></a><span id="l1.9426"> </span>
<a href="#l1.9427"></a><span id="l1.9427" class="difflineminus">-nsresult</span>
<a href="#l1.9428"></a><span id="l1.9428" class="difflineminus">-nsMsgDBView::AndExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9429"></a><span id="l1.9429" class="difflineminus">-                          uint32_t andflag)</span>
<a href="#l1.9430"></a><span id="l1.9430" class="difflineminus">-{</span>
<a href="#l1.9431"></a><span id="l1.9431" class="difflineminus">-  uint32_t  flag;</span>
<a href="#l1.9432"></a><span id="l1.9432" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.9433"></a><span id="l1.9433" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9434"></a><span id="l1.9434" class="difflineplus">+nsresult nsMsgDBView::AndExtraFlag(nsMsgViewIndex index, uint32_t andflag) {</span>
<a href="#l1.9435"></a><span id="l1.9435" class="difflineplus">+  uint32_t flag;</span>
<a href="#l1.9436"></a><span id="l1.9436" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9437"></a><span id="l1.9437"> </span>
<a href="#l1.9438"></a><span id="l1.9438">   flag = m_flags[index];</span>
<a href="#l1.9439"></a><span id="l1.9439">   flag &amp;= andflag;</span>
<a href="#l1.9440"></a><span id="l1.9440">   m_flags[index] = flag;</span>
<a href="#l1.9441"></a><span id="l1.9441">   OnExtraFlagChanged(index, flag);</span>
<a href="#l1.9442"></a><span id="l1.9442">   return NS_OK;</span>
<a href="#l1.9443"></a><span id="l1.9443"> }</span>
<a href="#l1.9444"></a><span id="l1.9444"> </span>
<a href="#l1.9445"></a><span id="l1.9445" class="difflineminus">-nsresult</span>
<a href="#l1.9446"></a><span id="l1.9446" class="difflineminus">-nsMsgDBView::SetExtraFlag(nsMsgViewIndex index,</span>
<a href="#l1.9447"></a><span id="l1.9447" class="difflineminus">-                          uint32_t extraflag)</span>
<a href="#l1.9448"></a><span id="l1.9448" class="difflineminus">-{</span>
<a href="#l1.9449"></a><span id="l1.9449" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.9450"></a><span id="l1.9450" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9451"></a><span id="l1.9451" class="difflineplus">+nsresult nsMsgDBView::SetExtraFlag(nsMsgViewIndex index, uint32_t extraflag) {</span>
<a href="#l1.9452"></a><span id="l1.9452" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9453"></a><span id="l1.9453"> </span>
<a href="#l1.9454"></a><span id="l1.9454">   m_flags[index] = extraflag;</span>
<a href="#l1.9455"></a><span id="l1.9455">   OnExtraFlagChanged(index, extraflag);</span>
<a href="#l1.9456"></a><span id="l1.9456">   return NS_OK;</span>
<a href="#l1.9457"></a><span id="l1.9457"> }</span>
<a href="#l1.9458"></a><span id="l1.9458"> </span>
<a href="#l1.9459"></a><span id="l1.9459" class="difflineminus">-nsresult</span>
<a href="#l1.9460"></a><span id="l1.9460" class="difflineminus">-nsMsgDBView::ToggleIgnored(nsMsgViewIndex * indices,</span>
<a href="#l1.9461"></a><span id="l1.9461" class="difflineminus">-                           int32_t numIndices,</span>
<a href="#l1.9462"></a><span id="l1.9462" class="difflineminus">-                           nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9463"></a><span id="l1.9463" class="difflineminus">-                           bool *resultToggleState)</span>
<a href="#l1.9464"></a><span id="l1.9464" class="difflineminus">-{</span>
<a href="#l1.9465"></a><span id="l1.9465" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9466"></a><span id="l1.9466" class="difflineplus">+nsresult nsMsgDBView::ToggleIgnored(nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l1.9467"></a><span id="l1.9467" class="difflineplus">+                                    nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9468"></a><span id="l1.9468" class="difflineplus">+                                    bool *resultToggleState) {</span>
<a href="#l1.9469"></a><span id="l1.9469" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9470"></a><span id="l1.9470"> </span>
<a href="#l1.9471"></a><span id="l1.9471">   // Ignored state is toggled based on the first selected thread.</span>
<a href="#l1.9472"></a><span id="l1.9472" class="difflineminus">-  nsMsgViewIndex threadIndex = GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9473"></a><span id="l1.9473" class="difflineplus">+  nsMsgViewIndex threadIndex =</span>
<a href="#l1.9474"></a><span id="l1.9474" class="difflineplus">+      GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9475"></a><span id="l1.9475">   uint32_t threadFlags;</span>
<a href="#l1.9476"></a><span id="l1.9476">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9477"></a><span id="l1.9477">   uint32_t ignored = threadFlags &amp; nsMsgMessageFlags::Ignored;</span>
<a href="#l1.9478"></a><span id="l1.9478"> </span>
<a href="#l1.9479"></a><span id="l1.9479">   // Process threads in reverse order.</span>
<a href="#l1.9480"></a><span id="l1.9480">   // Otherwise collapsing the threads will invalidate the indices.</span>
<a href="#l1.9481"></a><span id="l1.9481">   threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9482"></a><span id="l1.9482" class="difflineminus">-  while (numIndices)</span>
<a href="#l1.9483"></a><span id="l1.9483" class="difflineminus">-  {</span>
<a href="#l1.9484"></a><span id="l1.9484" class="difflineplus">+  while (numIndices) {</span>
<a href="#l1.9485"></a><span id="l1.9485">     numIndices--;</span>
<a href="#l1.9486"></a><span id="l1.9486" class="difflineminus">-    if (indices[numIndices] &lt; threadIndex)</span>
<a href="#l1.9487"></a><span id="l1.9487" class="difflineminus">-    {</span>
<a href="#l1.9488"></a><span id="l1.9488" class="difflineminus">-      threadIndex = GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9489"></a><span id="l1.9489" class="difflineplus">+    if (indices[numIndices] &lt; threadIndex) {</span>
<a href="#l1.9490"></a><span id="l1.9490" class="difflineplus">+      threadIndex =</span>
<a href="#l1.9491"></a><span id="l1.9491" class="difflineplus">+          GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9492"></a><span id="l1.9492">       thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9493"></a><span id="l1.9493">       if ((threadFlags &amp; nsMsgMessageFlags::Ignored) == ignored)</span>
<a href="#l1.9494"></a><span id="l1.9494">         SetThreadIgnored(thread, threadIndex, !ignored);</span>
<a href="#l1.9495"></a><span id="l1.9495">     }</span>
<a href="#l1.9496"></a><span id="l1.9496">   }</span>
<a href="#l1.9497"></a><span id="l1.9497"> </span>
<a href="#l1.9498"></a><span id="l1.9498" class="difflineminus">-  if (resultIndex)</span>
<a href="#l1.9499"></a><span id="l1.9499" class="difflineminus">-    *resultIndex = threadIndex;</span>
<a href="#l1.9500"></a><span id="l1.9500" class="difflineminus">-</span>
<a href="#l1.9501"></a><span id="l1.9501" class="difflineminus">-  if (resultToggleState)</span>
<a href="#l1.9502"></a><span id="l1.9502" class="difflineminus">-    *resultToggleState = !ignored;</span>
<a href="#l1.9503"></a><span id="l1.9503" class="difflineminus">-</span>
<a href="#l1.9504"></a><span id="l1.9504" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9505"></a><span id="l1.9505" class="difflineminus">-}</span>
<a href="#l1.9506"></a><span id="l1.9506" class="difflineminus">-</span>
<a href="#l1.9507"></a><span id="l1.9507" class="difflineminus">-nsresult</span>
<a href="#l1.9508"></a><span id="l1.9508" class="difflineminus">-nsMsgDBView::ToggleMessageKilled(nsMsgViewIndex * indices,</span>
<a href="#l1.9509"></a><span id="l1.9509" class="difflineminus">-                                 int32_t numIndices,</span>
<a href="#l1.9510"></a><span id="l1.9510" class="difflineminus">-                                 nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9511"></a><span id="l1.9511" class="difflineminus">-                                 bool *resultToggleState)</span>
<a href="#l1.9512"></a><span id="l1.9512" class="difflineminus">-{</span>
<a href="#l1.9513"></a><span id="l1.9513" class="difflineplus">+  if (resultIndex) *resultIndex = threadIndex;</span>
<a href="#l1.9514"></a><span id="l1.9514" class="difflineplus">+</span>
<a href="#l1.9515"></a><span id="l1.9515" class="difflineplus">+  if (resultToggleState) *resultToggleState = !ignored;</span>
<a href="#l1.9516"></a><span id="l1.9516" class="difflineplus">+</span>
<a href="#l1.9517"></a><span id="l1.9517" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9518"></a><span id="l1.9518" class="difflineplus">+}</span>
<a href="#l1.9519"></a><span id="l1.9519" class="difflineplus">+</span>
<a href="#l1.9520"></a><span id="l1.9520" class="difflineplus">+nsresult nsMsgDBView::ToggleMessageKilled(nsMsgViewIndex *indices,</span>
<a href="#l1.9521"></a><span id="l1.9521" class="difflineplus">+                                          int32_t numIndices,</span>
<a href="#l1.9522"></a><span id="l1.9522" class="difflineplus">+                                          nsMsgViewIndex *resultIndex,</span>
<a href="#l1.9523"></a><span id="l1.9523" class="difflineplus">+                                          bool *resultToggleState) {</span>
<a href="#l1.9524"></a><span id="l1.9524">   NS_ENSURE_ARG_POINTER(resultToggleState);</span>
<a href="#l1.9525"></a><span id="l1.9525"> </span>
<a href="#l1.9526"></a><span id="l1.9526" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l1.9527"></a><span id="l1.9527" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; header;</span>
<a href="#l1.9528"></a><span id="l1.9528">   // Ignored state is toggled based on the first selected message.</span>
<a href="#l1.9529"></a><span id="l1.9529">   nsresult rv = GetMsgHdrForViewIndex(indices[0], getter_AddRefs(header));</span>
<a href="#l1.9530"></a><span id="l1.9530">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9531"></a><span id="l1.9531"> </span>
<a href="#l1.9532"></a><span id="l1.9532">   uint32_t msgFlags;</span>
<a href="#l1.9533"></a><span id="l1.9533">   header-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.9534"></a><span id="l1.9534">   uint32_t ignored = msgFlags &amp; nsMsgMessageFlags::Ignored;</span>
<a href="#l1.9535"></a><span id="l1.9535"> </span>
<a href="#l1.9536"></a><span id="l1.9536">   // Process messages in reverse order.</span>
<a href="#l1.9537"></a><span id="l1.9537">   // Otherwise the indices may be invalidated.</span>
<a href="#l1.9538"></a><span id="l1.9538">   nsMsgViewIndex msgIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9539"></a><span id="l1.9539" class="difflineminus">-  while (numIndices)</span>
<a href="#l1.9540"></a><span id="l1.9540" class="difflineminus">-  {</span>
<a href="#l1.9541"></a><span id="l1.9541" class="difflineplus">+  while (numIndices) {</span>
<a href="#l1.9542"></a><span id="l1.9542">     numIndices--;</span>
<a href="#l1.9543"></a><span id="l1.9543" class="difflineminus">-    if (indices[numIndices] &lt; msgIndex)</span>
<a href="#l1.9544"></a><span id="l1.9544" class="difflineminus">-    {</span>
<a href="#l1.9545"></a><span id="l1.9545" class="difflineplus">+    if (indices[numIndices] &lt; msgIndex) {</span>
<a href="#l1.9546"></a><span id="l1.9546">       msgIndex = indices[numIndices];</span>
<a href="#l1.9547"></a><span id="l1.9547">       rv = GetMsgHdrForViewIndex(msgIndex, getter_AddRefs(header));</span>
<a href="#l1.9548"></a><span id="l1.9548">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9549"></a><span id="l1.9549">       header-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l1.9550"></a><span id="l1.9550">       if ((msgFlags &amp; nsMsgMessageFlags::Ignored) == ignored)</span>
<a href="#l1.9551"></a><span id="l1.9551">         SetSubthreadKilled(header, msgIndex, !ignored);</span>
<a href="#l1.9552"></a><span id="l1.9552">     }</span>
<a href="#l1.9553"></a><span id="l1.9553">   }</span>
<a href="#l1.9554"></a><span id="l1.9554"> </span>
<a href="#l1.9555"></a><span id="l1.9555" class="difflineminus">-  if (resultIndex)</span>
<a href="#l1.9556"></a><span id="l1.9556" class="difflineminus">-    *resultIndex = msgIndex;</span>
<a href="#l1.9557"></a><span id="l1.9557" class="difflineminus">-</span>
<a href="#l1.9558"></a><span id="l1.9558" class="difflineminus">-  if (resultToggleState)</span>
<a href="#l1.9559"></a><span id="l1.9559" class="difflineminus">-    *resultToggleState = !ignored;</span>
<a href="#l1.9560"></a><span id="l1.9560" class="difflineminus">-</span>
<a href="#l1.9561"></a><span id="l1.9561" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9562"></a><span id="l1.9562" class="difflineminus">-}</span>
<a href="#l1.9563"></a><span id="l1.9563" class="difflineminus">-</span>
<a href="#l1.9564"></a><span id="l1.9564" class="difflineminus">-nsMsgViewIndex</span>
<a href="#l1.9565"></a><span id="l1.9565" class="difflineminus">-nsMsgDBView::GetThreadFromMsgIndex(nsMsgViewIndex index,</span>
<a href="#l1.9566"></a><span id="l1.9566" class="difflineminus">-                                   nsIMsgThread **threadHdr)</span>
<a href="#l1.9567"></a><span id="l1.9567" class="difflineminus">-{</span>
<a href="#l1.9568"></a><span id="l1.9568" class="difflineplus">+  if (resultIndex) *resultIndex = msgIndex;</span>
<a href="#l1.9569"></a><span id="l1.9569" class="difflineplus">+</span>
<a href="#l1.9570"></a><span id="l1.9570" class="difflineplus">+  if (resultToggleState) *resultToggleState = !ignored;</span>
<a href="#l1.9571"></a><span id="l1.9571" class="difflineplus">+</span>
<a href="#l1.9572"></a><span id="l1.9572" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9573"></a><span id="l1.9573" class="difflineplus">+}</span>
<a href="#l1.9574"></a><span id="l1.9574" class="difflineplus">+</span>
<a href="#l1.9575"></a><span id="l1.9575" class="difflineplus">+nsMsgViewIndex nsMsgDBView::GetThreadFromMsgIndex(nsMsgViewIndex index,</span>
<a href="#l1.9576"></a><span id="l1.9576" class="difflineplus">+                                                  nsIMsgThread **threadHdr) {</span>
<a href="#l1.9577"></a><span id="l1.9577">   nsMsgKey msgKey = GetAt(index);</span>
<a href="#l1.9578"></a><span id="l1.9578">   nsMsgViewIndex threadIndex;</span>
<a href="#l1.9579"></a><span id="l1.9579"> </span>
<a href="#l1.9580"></a><span id="l1.9580" class="difflineminus">-  if (threadHdr == nullptr)</span>
<a href="#l1.9581"></a><span id="l1.9581" class="difflineminus">-    return nsMsgViewIndex_None;</span>
<a href="#l1.9582"></a><span id="l1.9582" class="difflineplus">+  if (threadHdr == nullptr) return nsMsgViewIndex_None;</span>
<a href="#l1.9583"></a><span id="l1.9583"> </span>
<a href="#l1.9584"></a><span id="l1.9584">   nsresult rv = GetThreadContainingIndex(index, threadHdr);</span>
<a href="#l1.9585"></a><span id="l1.9585" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,nsMsgViewIndex_None);</span>
<a href="#l1.9586"></a><span id="l1.9586" class="difflineminus">-</span>
<a href="#l1.9587"></a><span id="l1.9587" class="difflineminus">-  if (*threadHdr == nullptr)</span>
<a href="#l1.9588"></a><span id="l1.9588" class="difflineminus">-    return nsMsgViewIndex_None;</span>
<a href="#l1.9589"></a><span id="l1.9589" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nsMsgViewIndex_None);</span>
<a href="#l1.9590"></a><span id="l1.9590" class="difflineplus">+</span>
<a href="#l1.9591"></a><span id="l1.9591" class="difflineplus">+  if (*threadHdr == nullptr) return nsMsgViewIndex_None;</span>
<a href="#l1.9592"></a><span id="l1.9592"> </span>
<a href="#l1.9593"></a><span id="l1.9593">   nsMsgKey threadKey;</span>
<a href="#l1.9594"></a><span id="l1.9594">   (*threadHdr)-&gt;GetThreadKey(&amp;threadKey);</span>
<a href="#l1.9595"></a><span id="l1.9595" class="difflineminus">-  if (msgKey !=threadKey)</span>
<a href="#l1.9596"></a><span id="l1.9596" class="difflineplus">+  if (msgKey != threadKey)</span>
<a href="#l1.9597"></a><span id="l1.9597">     threadIndex = GetIndexOfFirstDisplayedKeyInThread(*threadHdr);</span>
<a href="#l1.9598"></a><span id="l1.9598">   else</span>
<a href="#l1.9599"></a><span id="l1.9599">     threadIndex = index;</span>
<a href="#l1.9600"></a><span id="l1.9600"> </span>
<a href="#l1.9601"></a><span id="l1.9601">   return threadIndex;</span>
<a href="#l1.9602"></a><span id="l1.9602"> }</span>
<a href="#l1.9603"></a><span id="l1.9603"> </span>
<a href="#l1.9604"></a><span id="l1.9604" class="difflineminus">-nsresult</span>
<a href="#l1.9605"></a><span id="l1.9605" class="difflineminus">-nsMsgDBView::ToggleWatched(nsMsgViewIndex* indices,</span>
<a href="#l1.9606"></a><span id="l1.9606" class="difflineminus">-                           int32_t numIndices)</span>
<a href="#l1.9607"></a><span id="l1.9607" class="difflineminus">-{</span>
<a href="#l1.9608"></a><span id="l1.9608" class="difflineminus">-  nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9609"></a><span id="l1.9609" class="difflineplus">+nsresult nsMsgDBView::ToggleWatched(nsMsgViewIndex *indices,</span>
<a href="#l1.9610"></a><span id="l1.9610" class="difflineplus">+                                    int32_t numIndices) {</span>
<a href="#l1.9611"></a><span id="l1.9611" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9612"></a><span id="l1.9612"> </span>
<a href="#l1.9613"></a><span id="l1.9613">   // Watched state is toggled based on the first selected thread.</span>
<a href="#l1.9614"></a><span id="l1.9614" class="difflineminus">-  nsMsgViewIndex threadIndex = GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9615"></a><span id="l1.9615" class="difflineplus">+  nsMsgViewIndex threadIndex =</span>
<a href="#l1.9616"></a><span id="l1.9616" class="difflineplus">+      GetThreadFromMsgIndex(indices[0], getter_AddRefs(thread));</span>
<a href="#l1.9617"></a><span id="l1.9617">   uint32_t threadFlags;</span>
<a href="#l1.9618"></a><span id="l1.9618">   thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9619"></a><span id="l1.9619">   uint32_t watched = threadFlags &amp; nsMsgMessageFlags::Watched;</span>
<a href="#l1.9620"></a><span id="l1.9620"> </span>
<a href="#l1.9621"></a><span id="l1.9621">   // Process threads in reverse order for consistency with ToggleIgnored.</span>
<a href="#l1.9622"></a><span id="l1.9622">   threadIndex = nsMsgViewIndex_None;</span>
<a href="#l1.9623"></a><span id="l1.9623" class="difflineminus">-  while (numIndices)</span>
<a href="#l1.9624"></a><span id="l1.9624" class="difflineminus">-  {</span>
<a href="#l1.9625"></a><span id="l1.9625" class="difflineplus">+  while (numIndices) {</span>
<a href="#l1.9626"></a><span id="l1.9626">     numIndices--;</span>
<a href="#l1.9627"></a><span id="l1.9627" class="difflineminus">-    if (indices[numIndices] &lt; threadIndex)</span>
<a href="#l1.9628"></a><span id="l1.9628" class="difflineminus">-    {</span>
<a href="#l1.9629"></a><span id="l1.9629" class="difflineminus">-      threadIndex = GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9630"></a><span id="l1.9630" class="difflineplus">+    if (indices[numIndices] &lt; threadIndex) {</span>
<a href="#l1.9631"></a><span id="l1.9631" class="difflineplus">+      threadIndex =</span>
<a href="#l1.9632"></a><span id="l1.9632" class="difflineplus">+          GetThreadFromMsgIndex(indices[numIndices], getter_AddRefs(thread));</span>
<a href="#l1.9633"></a><span id="l1.9633">       thread-&gt;GetFlags(&amp;threadFlags);</span>
<a href="#l1.9634"></a><span id="l1.9634">       if ((threadFlags &amp; nsMsgMessageFlags::Watched) == watched)</span>
<a href="#l1.9635"></a><span id="l1.9635">         SetThreadWatched(thread, threadIndex, !watched);</span>
<a href="#l1.9636"></a><span id="l1.9636">     }</span>
<a href="#l1.9637"></a><span id="l1.9637">   }</span>
<a href="#l1.9638"></a><span id="l1.9638"> </span>
<a href="#l1.9639"></a><span id="l1.9639">   return NS_OK;</span>
<a href="#l1.9640"></a><span id="l1.9640"> }</span>
<a href="#l1.9641"></a><span id="l1.9641"> </span>
<a href="#l1.9642"></a><span id="l1.9642" class="difflineminus">-nsresult</span>
<a href="#l1.9643"></a><span id="l1.9643" class="difflineminus">-nsMsgDBView::SetThreadIgnored(nsIMsgThread *thread,</span>
<a href="#l1.9644"></a><span id="l1.9644" class="difflineminus">-                              nsMsgViewIndex threadIndex,</span>
<a href="#l1.9645"></a><span id="l1.9645" class="difflineminus">-                              bool ignored)</span>
<a href="#l1.9646"></a><span id="l1.9646" class="difflineminus">-{</span>
<a href="#l1.9647"></a><span id="l1.9647" class="difflineminus">-  if (!IsValidIndex(threadIndex))</span>
<a href="#l1.9648"></a><span id="l1.9648" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9649"></a><span id="l1.9649" class="difflineplus">+nsresult nsMsgDBView::SetThreadIgnored(nsIMsgThread *thread,</span>
<a href="#l1.9650"></a><span id="l1.9650" class="difflineplus">+                                       nsMsgViewIndex threadIndex,</span>
<a href="#l1.9651"></a><span id="l1.9651" class="difflineplus">+                                       bool ignored) {</span>
<a href="#l1.9652"></a><span id="l1.9652" class="difflineplus">+  if (!IsValidIndex(threadIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9653"></a><span id="l1.9653"> </span>
<a href="#l1.9654"></a><span id="l1.9654">   NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9655"></a><span id="l1.9655" class="difflineminus">-  if (ignored)</span>
<a href="#l1.9656"></a><span id="l1.9656" class="difflineminus">-  {</span>
<a href="#l1.9657"></a><span id="l1.9657" class="difflineplus">+  if (ignored) {</span>
<a href="#l1.9658"></a><span id="l1.9658">     nsTArray&lt;nsMsgKey&gt; idsMarkedRead;</span>
<a href="#l1.9659"></a><span id="l1.9659">     MarkThreadRead(thread, threadIndex, idsMarkedRead, true);</span>
<a href="#l1.9660"></a><span id="l1.9660">     CollapseByIndex(threadIndex, nullptr);</span>
<a href="#l1.9661"></a><span id="l1.9661">   }</span>
<a href="#l1.9662"></a><span id="l1.9662"> </span>
<a href="#l1.9663"></a><span id="l1.9663" class="difflineminus">-  if (!m_db)</span>
<a href="#l1.9664"></a><span id="l1.9664" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.9665"></a><span id="l1.9665" class="difflineplus">+  if (!m_db) return NS_ERROR_FAILURE;</span>
<a href="#l1.9666"></a><span id="l1.9666"> </span>
<a href="#l1.9667"></a><span id="l1.9667">   return m_db-&gt;MarkThreadIgnored(thread, m_keys[threadIndex], ignored, this);</span>
<a href="#l1.9668"></a><span id="l1.9668"> }</span>
<a href="#l1.9669"></a><span id="l1.9669"> </span>
<a href="#l1.9670"></a><span id="l1.9670" class="difflineminus">-nsresult</span>
<a href="#l1.9671"></a><span id="l1.9671" class="difflineminus">-nsMsgDBView::SetSubthreadKilled(nsIMsgDBHdr *header,</span>
<a href="#l1.9672"></a><span id="l1.9672" class="difflineminus">-                                nsMsgViewIndex msgIndex,</span>
<a href="#l1.9673"></a><span id="l1.9673" class="difflineminus">-                                bool ignored)</span>
<a href="#l1.9674"></a><span id="l1.9674" class="difflineminus">-{</span>
<a href="#l1.9675"></a><span id="l1.9675" class="difflineminus">-  if (!IsValidIndex(msgIndex))</span>
<a href="#l1.9676"></a><span id="l1.9676" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9677"></a><span id="l1.9677" class="difflineplus">+nsresult nsMsgDBView::SetSubthreadKilled(nsIMsgDBHdr *header,</span>
<a href="#l1.9678"></a><span id="l1.9678" class="difflineplus">+                                         nsMsgViewIndex msgIndex,</span>
<a href="#l1.9679"></a><span id="l1.9679" class="difflineplus">+                                         bool ignored) {</span>
<a href="#l1.9680"></a><span id="l1.9680" class="difflineplus">+  if (!IsValidIndex(msgIndex)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9681"></a><span id="l1.9681"> </span>
<a href="#l1.9682"></a><span id="l1.9682">   NoteChange(msgIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9683"></a><span id="l1.9683"> </span>
<a href="#l1.9684"></a><span id="l1.9684" class="difflineminus">-  if (!m_db)</span>
<a href="#l1.9685"></a><span id="l1.9685" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.9686"></a><span id="l1.9686" class="difflineplus">+  if (!m_db) return NS_ERROR_FAILURE;</span>
<a href="#l1.9687"></a><span id="l1.9687"> </span>
<a href="#l1.9688"></a><span id="l1.9688">   nsresult rv = m_db-&gt;MarkHeaderKilled(header, ignored, this);</span>
<a href="#l1.9689"></a><span id="l1.9689">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9690"></a><span id="l1.9690"> </span>
<a href="#l1.9691"></a><span id="l1.9691" class="difflineminus">-  if (ignored)</span>
<a href="#l1.9692"></a><span id="l1.9692" class="difflineminus">-  {</span>
<a href="#l1.9693"></a><span id="l1.9693" class="difflineminus">-    nsCOMPtr &lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9694"></a><span id="l1.9694" class="difflineplus">+  if (ignored) {</span>
<a href="#l1.9695"></a><span id="l1.9695" class="difflineplus">+    nsCOMPtr&lt;nsIMsgThread&gt; thread;</span>
<a href="#l1.9696"></a><span id="l1.9696">     nsresult rv;</span>
<a href="#l1.9697"></a><span id="l1.9697">     rv = GetThreadContainingMsgHdr(header, getter_AddRefs(thread));</span>
<a href="#l1.9698"></a><span id="l1.9698">     // So we didn't mark threads read.</span>
<a href="#l1.9699"></a><span id="l1.9699" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l1.9700"></a><span id="l1.9700" class="difflineminus">-      return NS_OK;</span>
<a href="#l1.9701"></a><span id="l1.9701" class="difflineplus">+    if (NS_FAILED(rv)) return NS_OK;</span>
<a href="#l1.9702"></a><span id="l1.9702"> </span>
<a href="#l1.9703"></a><span id="l1.9703">     uint32_t children, current;</span>
<a href="#l1.9704"></a><span id="l1.9704">     thread-&gt;GetNumChildren(&amp;children);</span>
<a href="#l1.9705"></a><span id="l1.9705"> </span>
<a href="#l1.9706"></a><span id="l1.9706">     nsMsgKey headKey;</span>
<a href="#l1.9707"></a><span id="l1.9707">     header-&gt;GetMessageKey(&amp;headKey);</span>
<a href="#l1.9708"></a><span id="l1.9708"> </span>
<a href="#l1.9709"></a><span id="l1.9709" class="difflineminus">-    for (current = 0; current &lt; children; current++)</span>
<a href="#l1.9710"></a><span id="l1.9710" class="difflineminus">-    {</span>
<a href="#l1.9711"></a><span id="l1.9711" class="difflineplus">+    for (current = 0; current &lt; children; current++) {</span>
<a href="#l1.9712"></a><span id="l1.9712">       nsMsgKey newKey;</span>
<a href="#l1.9713"></a><span id="l1.9713">       thread-&gt;GetChildKeyAt(current, &amp;newKey);</span>
<a href="#l1.9714"></a><span id="l1.9714" class="difflineminus">-      if (newKey == headKey)</span>
<a href="#l1.9715"></a><span id="l1.9715" class="difflineminus">-        break;</span>
<a href="#l1.9716"></a><span id="l1.9716" class="difflineplus">+      if (newKey == headKey) break;</span>
<a href="#l1.9717"></a><span id="l1.9717">     }</span>
<a href="#l1.9718"></a><span id="l1.9718"> </span>
<a href="#l1.9719"></a><span id="l1.9719">     // Process all messages, starting with this message.</span>
<a href="#l1.9720"></a><span id="l1.9720" class="difflineminus">-    for (; current &lt; children; current++)</span>
<a href="#l1.9721"></a><span id="l1.9721" class="difflineminus">-    {</span>
<a href="#l1.9722"></a><span id="l1.9722" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.9723"></a><span id="l1.9723" class="difflineplus">+    for (; current &lt; children; current++) {</span>
<a href="#l1.9724"></a><span id="l1.9724" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.9725"></a><span id="l1.9725">       bool isKilled;</span>
<a href="#l1.9726"></a><span id="l1.9726"> </span>
<a href="#l1.9727"></a><span id="l1.9727">       thread-&gt;GetChildHdrAt(current, getter_AddRefs(nextHdr));</span>
<a href="#l1.9728"></a><span id="l1.9728">       nextHdr-&gt;GetIsKilled(&amp;isKilled);</span>
<a href="#l1.9729"></a><span id="l1.9729"> </span>
<a href="#l1.9730"></a><span id="l1.9730">       // Ideally, the messages should stop processing here.</span>
<a href="#l1.9731"></a><span id="l1.9731">       // However, the children are ordered not by thread...</span>
<a href="#l1.9732"></a><span id="l1.9732" class="difflineminus">-      if (isKilled)</span>
<a href="#l1.9733"></a><span id="l1.9733" class="difflineminus">-        nextHdr-&gt;MarkRead(true);</span>
<a href="#l1.9734"></a><span id="l1.9734" class="difflineplus">+      if (isKilled) nextHdr-&gt;MarkRead(true);</span>
<a href="#l1.9735"></a><span id="l1.9735">     }</span>
<a href="#l1.9736"></a><span id="l1.9736">   }</span>
<a href="#l1.9737"></a><span id="l1.9737"> </span>
<a href="#l1.9738"></a><span id="l1.9738">   return NS_OK;</span>
<a href="#l1.9739"></a><span id="l1.9739"> }</span>
<a href="#l1.9740"></a><span id="l1.9740"> </span>
<a href="#l1.9741"></a><span id="l1.9741" class="difflineminus">-nsresult</span>
<a href="#l1.9742"></a><span id="l1.9742" class="difflineminus">-nsMsgDBView::SetThreadWatched(nsIMsgThread *thread,</span>
<a href="#l1.9743"></a><span id="l1.9743" class="difflineminus">-                              nsMsgViewIndex index,</span>
<a href="#l1.9744"></a><span id="l1.9744" class="difflineminus">-                              bool watched)</span>
<a href="#l1.9745"></a><span id="l1.9745" class="difflineminus">-{</span>
<a href="#l1.9746"></a><span id="l1.9746" class="difflineminus">-  if (!IsValidIndex(index))</span>
<a href="#l1.9747"></a><span id="l1.9747" class="difflineminus">-    return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9748"></a><span id="l1.9748" class="difflineplus">+nsresult nsMsgDBView::SetThreadWatched(nsIMsgThread *thread,</span>
<a href="#l1.9749"></a><span id="l1.9749" class="difflineplus">+                                       nsMsgViewIndex index, bool watched) {</span>
<a href="#l1.9750"></a><span id="l1.9750" class="difflineplus">+  if (!IsValidIndex(index)) return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.9751"></a><span id="l1.9751"> </span>
<a href="#l1.9752"></a><span id="l1.9752">   NoteChange(index, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l1.9753"></a><span id="l1.9753">   return m_db-&gt;MarkThreadWatched(thread, m_keys[index], watched, this);</span>
<a href="#l1.9754"></a><span id="l1.9754"> }</span>
<a href="#l1.9755"></a><span id="l1.9755"> </span>
<a href="#l1.9756"></a><span id="l1.9756"> NS_IMETHODIMP</span>
<a href="#l1.9757"></a><span id="l1.9757" class="difflineminus">-nsMsgDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9758"></a><span id="l1.9758" class="difflineminus">-{</span>
<a href="#l1.9759"></a><span id="l1.9759" class="difflineplus">+nsMsgDBView::GetMsgFolder(nsIMsgFolder **aMsgFolder) {</span>
<a href="#l1.9760"></a><span id="l1.9760">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l1.9761"></a><span id="l1.9761">   NS_IF_ADDREF(*aMsgFolder = m_folder);</span>
<a href="#l1.9762"></a><span id="l1.9762">   return NS_OK;</span>
<a href="#l1.9763"></a><span id="l1.9763"> }</span>
<a href="#l1.9764"></a><span id="l1.9764"> </span>
<a href="#l1.9765"></a><span id="l1.9765"> NS_IMETHODIMP</span>
<a href="#l1.9766"></a><span id="l1.9766" class="difflineminus">-nsMsgDBView::SetViewFolder(nsIMsgFolder *aMsgFolder)</span>
<a href="#l1.9767"></a><span id="l1.9767" class="difflineminus">-{</span>
<a href="#l1.9768"></a><span id="l1.9768" class="difflineplus">+nsMsgDBView::SetViewFolder(nsIMsgFolder *aMsgFolder) {</span>
<a href="#l1.9769"></a><span id="l1.9769">   m_viewFolder = aMsgFolder;</span>
<a href="#l1.9770"></a><span id="l1.9770">   return NS_OK;</span>
<a href="#l1.9771"></a><span id="l1.9771"> }</span>
<a href="#l1.9772"></a><span id="l1.9772"> </span>
<a href="#l1.9773"></a><span id="l1.9773"> NS_IMETHODIMP</span>
<a href="#l1.9774"></a><span id="l1.9774" class="difflineminus">-nsMsgDBView::GetViewFolder(nsIMsgFolder **aMsgFolder)</span>
<a href="#l1.9775"></a><span id="l1.9775" class="difflineminus">-{</span>
<a href="#l1.9776"></a><span id="l1.9776" class="difflineplus">+nsMsgDBView::GetViewFolder(nsIMsgFolder **aMsgFolder) {</span>
<a href="#l1.9777"></a><span id="l1.9777">   NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l1.9778"></a><span id="l1.9778">   NS_IF_ADDREF(*aMsgFolder = m_viewFolder);</span>
<a href="#l1.9779"></a><span id="l1.9779">   return NS_OK;</span>
<a href="#l1.9780"></a><span id="l1.9780"> }</span>
<a href="#l1.9781"></a><span id="l1.9781"> </span>
<a href="#l1.9782"></a><span id="l1.9782"> NS_IMETHODIMP</span>
<a href="#l1.9783"></a><span id="l1.9783" class="difflineminus">-nsMsgDBView::GetNumSelected(uint32_t *aNumSelected)</span>
<a href="#l1.9784"></a><span id="l1.9784" class="difflineminus">-{</span>
<a href="#l1.9785"></a><span id="l1.9785" class="difflineplus">+nsMsgDBView::GetNumSelected(uint32_t *aNumSelected) {</span>
<a href="#l1.9786"></a><span id="l1.9786">   NS_ENSURE_ARG_POINTER(aNumSelected);</span>
<a href="#l1.9787"></a><span id="l1.9787"> </span>
<a href="#l1.9788"></a><span id="l1.9788" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.9789"></a><span id="l1.9789" class="difflineminus">-  {</span>
<a href="#l1.9790"></a><span id="l1.9790" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.9791"></a><span id="l1.9791">     // No tree selection can mean we're in the stand alone mode.</span>
<a href="#l1.9792"></a><span id="l1.9792">     *aNumSelected = (m_currentlyDisplayedMsgKey != nsMsgKey_None) ? 1 : 0;</span>
<a href="#l1.9793"></a><span id="l1.9793">     return NS_OK;</span>
<a href="#l1.9794"></a><span id="l1.9794">   }</span>
<a href="#l1.9795"></a><span id="l1.9795"> </span>
<a href="#l1.9796"></a><span id="l1.9796">   bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads();</span>
<a href="#l1.9797"></a><span id="l1.9797"> </span>
<a href="#l1.9798"></a><span id="l1.9798">   // We call this a lot from the front end JS, so make it fast.</span>
<a href="#l1.9799"></a><span id="l1.9799" class="difflineminus">-  nsresult rv = mTreeSelection-&gt;GetCount((int32_t*)aNumSelected);</span>
<a href="#l1.9800"></a><span id="l1.9800" class="difflineplus">+  nsresult rv = mTreeSelection-&gt;GetCount((int32_t *)aNumSelected);</span>
<a href="#l1.9801"></a><span id="l1.9801">   if (!*aNumSelected || !includeCollapsedMsgs ||</span>
<a href="#l1.9802"></a><span id="l1.9802">       !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l1.9803"></a><span id="l1.9803">     return rv;</span>
<a href="#l1.9804"></a><span id="l1.9804"> </span>
<a href="#l1.9805"></a><span id="l1.9805">   int32_t numSelectedIncludingCollapsed = *aNumSelected;</span>
<a href="#l1.9806"></a><span id="l1.9806">   nsMsgViewIndexArray selection;</span>
<a href="#l1.9807"></a><span id="l1.9807">   GetSelectedIndices(selection);</span>
<a href="#l1.9808"></a><span id="l1.9808">   int32_t numIndices = selection.Length();</span>
<a href="#l1.9809"></a><span id="l1.9809">   // Iterate over the selection, counting up the messages in collapsed</span>
<a href="#l1.9810"></a><span id="l1.9810">   // threads.</span>
<a href="#l1.9811"></a><span id="l1.9811" class="difflineminus">-  for (int32_t i = 0; i &lt; numIndices; i++)</span>
<a href="#l1.9812"></a><span id="l1.9812" class="difflineminus">-  {</span>
<a href="#l1.9813"></a><span id="l1.9813" class="difflineminus">-    if (m_flags[selection[i]] &amp; nsMsgMessageFlags::Elided)</span>
<a href="#l1.9814"></a><span id="l1.9814" class="difflineminus">-    {</span>
<a href="#l1.9815"></a><span id="l1.9815" class="difflineplus">+  for (int32_t i = 0; i &lt; numIndices; i++) {</span>
<a href="#l1.9816"></a><span id="l1.9816" class="difflineplus">+    if (m_flags[selection[i]] &amp; nsMsgMessageFlags::Elided) {</span>
<a href="#l1.9817"></a><span id="l1.9817">       int32_t collapsedCount;</span>
<a href="#l1.9818"></a><span id="l1.9818">       ExpansionDelta(selection[i], &amp;collapsedCount);</span>
<a href="#l1.9819"></a><span id="l1.9819">       numSelectedIncludingCollapsed += collapsedCount;</span>
<a href="#l1.9820"></a><span id="l1.9820">     }</span>
<a href="#l1.9821"></a><span id="l1.9821">   }</span>
<a href="#l1.9822"></a><span id="l1.9822"> </span>
<a href="#l1.9823"></a><span id="l1.9823">   *aNumSelected = numSelectedIncludingCollapsed;</span>
<a href="#l1.9824"></a><span id="l1.9824">   return rv;</span>
<a href="#l1.9825"></a><span id="l1.9825"> }</span>
<a href="#l1.9826"></a><span id="l1.9826"> </span>
<a href="#l1.9827"></a><span id="l1.9827"> NS_IMETHODIMP</span>
<a href="#l1.9828"></a><span id="l1.9828" class="difflineminus">-nsMsgDBView::GetNumMsgsInView(int32_t *aNumMsgs)</span>
<a href="#l1.9829"></a><span id="l1.9829" class="difflineminus">-{</span>
<a href="#l1.9830"></a><span id="l1.9830" class="difflineplus">+nsMsgDBView::GetNumMsgsInView(int32_t *aNumMsgs) {</span>
<a href="#l1.9831"></a><span id="l1.9831">   NS_ENSURE_ARG_POINTER(aNumMsgs);</span>
<a href="#l1.9832"></a><span id="l1.9832" class="difflineminus">-  return (m_folder) ? m_folder-&gt;GetTotalMessages(false, aNumMsgs) :</span>
<a href="#l1.9833"></a><span id="l1.9833" class="difflineminus">-                      NS_ERROR_FAILURE;</span>
<a href="#l1.9834"></a><span id="l1.9834" class="difflineplus">+  return (m_folder) ? m_folder-&gt;GetTotalMessages(false, aNumMsgs)</span>
<a href="#l1.9835"></a><span id="l1.9835" class="difflineplus">+                    : NS_ERROR_FAILURE;</span>
<a href="#l1.9836"></a><span id="l1.9836"> }</span>
<a href="#l1.9837"></a><span id="l1.9837"> </span>
<a href="#l1.9838"></a><span id="l1.9838"> /**</span>
<a href="#l1.9839"></a><span id="l1.9839">  * @note For the IMAP delete model, this applies to both deleting and</span>
<a href="#l1.9840"></a><span id="l1.9840">  *       undeleting a message.</span>
<a href="#l1.9841"></a><span id="l1.9841">  */</span>
<a href="#l1.9842"></a><span id="l1.9842"> NS_IMETHODIMP</span>
<a href="#l1.9843"></a><span id="l1.9843" class="difflineminus">-nsMsgDBView::GetMsgToSelectAfterDelete(nsMsgViewIndex *msgToSelectAfterDelete)</span>
<a href="#l1.9844"></a><span id="l1.9844" class="difflineminus">-{</span>
<a href="#l1.9845"></a><span id="l1.9845" class="difflineplus">+nsMsgDBView::GetMsgToSelectAfterDelete(nsMsgViewIndex *msgToSelectAfterDelete) {</span>
<a href="#l1.9846"></a><span id="l1.9846">   NS_ENSURE_ARG_POINTER(msgToSelectAfterDelete);</span>
<a href="#l1.9847"></a><span id="l1.9847">   *msgToSelectAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l1.9848"></a><span id="l1.9848"> </span>
<a href="#l1.9849"></a><span id="l1.9849">   bool isMultiSelect = false;</span>
<a href="#l1.9850"></a><span id="l1.9850">   int32_t startFirstRange = nsMsgViewIndex_None;</span>
<a href="#l1.9851"></a><span id="l1.9851">   int32_t endFirstRange = nsMsgViewIndex_None;</span>
<a href="#l1.9852"></a><span id="l1.9852" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.9853"></a><span id="l1.9853" class="difflineminus">-  {</span>
<a href="#l1.9854"></a><span id="l1.9854" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.9855"></a><span id="l1.9855">     // If we don't have a tree selection then we must be in stand alone mode.</span>
<a href="#l1.9856"></a><span id="l1.9856">     // return the index of the current message key as the first selected index.</span>
<a href="#l1.9857"></a><span id="l1.9857">     *msgToSelectAfterDelete = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.9858"></a><span id="l1.9858" class="difflineminus">-  }</span>
<a href="#l1.9859"></a><span id="l1.9859" class="difflineminus">-  else</span>
<a href="#l1.9860"></a><span id="l1.9860" class="difflineminus">-  {</span>
<a href="#l1.9861"></a><span id="l1.9861" class="difflineplus">+  } else {</span>
<a href="#l1.9862"></a><span id="l1.9862">     int32_t selectionCount;</span>
<a href="#l1.9863"></a><span id="l1.9863">     int32_t startRange;</span>
<a href="#l1.9864"></a><span id="l1.9864">     int32_t endRange;</span>
<a href="#l1.9865"></a><span id="l1.9865">     nsresult rv = mTreeSelection-&gt;GetRangeCount(&amp;selectionCount);</span>
<a href="#l1.9866"></a><span id="l1.9866">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9867"></a><span id="l1.9867" class="difflineminus">-    for (int32_t i = 0; i &lt; selectionCount; i++)</span>
<a href="#l1.9868"></a><span id="l1.9868" class="difflineminus">-    {</span>
<a href="#l1.9869"></a><span id="l1.9869" class="difflineplus">+    for (int32_t i = 0; i &lt; selectionCount; i++) {</span>
<a href="#l1.9870"></a><span id="l1.9870">       rv = mTreeSelection-&gt;GetRangeAt(i, &amp;startRange, &amp;endRange);</span>
<a href="#l1.9871"></a><span id="l1.9871">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9872"></a><span id="l1.9872"> </span>
<a href="#l1.9873"></a><span id="l1.9873">       // Save off the first range in case we need it later.</span>
<a href="#l1.9874"></a><span id="l1.9874" class="difflineminus">-      if (i == 0)</span>
<a href="#l1.9875"></a><span id="l1.9875" class="difflineminus">-      {</span>
<a href="#l1.9876"></a><span id="l1.9876" class="difflineplus">+      if (i == 0) {</span>
<a href="#l1.9877"></a><span id="l1.9877">         startFirstRange = startRange;</span>
<a href="#l1.9878"></a><span id="l1.9878">         endFirstRange = endRange;</span>
<a href="#l1.9879"></a><span id="l1.9879" class="difflineminus">-      }</span>
<a href="#l1.9880"></a><span id="l1.9880" class="difflineminus">-      else</span>
<a href="#l1.9881"></a><span id="l1.9881" class="difflineminus">-      {</span>
<a href="#l1.9882"></a><span id="l1.9882" class="difflineplus">+      } else {</span>
<a href="#l1.9883"></a><span id="l1.9883">         // If the tree selection is goofy (eg adjacent or overlapping ranges),</span>
<a href="#l1.9884"></a><span id="l1.9884">         // complain about it, but don't try and cope.  Just live with the fact</span>
<a href="#l1.9885"></a><span id="l1.9885">         // that one of the deleted messages is going to end up selected.</span>
<a href="#l1.9886"></a><span id="l1.9886" class="difflineminus">-        NS_WARNING_ASSERTION(endFirstRange != startRange,</span>
<a href="#l1.9887"></a><span id="l1.9887" class="difflineminus">-                             &quot;goofy tree selection state: two ranges are adjacent!&quot;);</span>
<a href="#l1.9888"></a><span id="l1.9888" class="difflineplus">+        NS_WARNING_ASSERTION(</span>
<a href="#l1.9889"></a><span id="l1.9889" class="difflineplus">+            endFirstRange != startRange,</span>
<a href="#l1.9890"></a><span id="l1.9890" class="difflineplus">+            &quot;goofy tree selection state: two ranges are adjacent!&quot;);</span>
<a href="#l1.9891"></a><span id="l1.9891">       }</span>
<a href="#l1.9892"></a><span id="l1.9892"> </span>
<a href="#l1.9893"></a><span id="l1.9893" class="difflineminus">-      *msgToSelectAfterDelete = std::min(*msgToSelectAfterDelete,</span>
<a href="#l1.9894"></a><span id="l1.9894" class="difflineminus">-                                         (nsMsgViewIndex)startRange);</span>
<a href="#l1.9895"></a><span id="l1.9895" class="difflineplus">+      *msgToSelectAfterDelete =</span>
<a href="#l1.9896"></a><span id="l1.9896" class="difflineplus">+          std::min(*msgToSelectAfterDelete, (nsMsgViewIndex)startRange);</span>
<a href="#l1.9897"></a><span id="l1.9897">     }</span>
<a href="#l1.9898"></a><span id="l1.9898"> </span>
<a href="#l1.9899"></a><span id="l1.9899">     // Multiple selection either using Ctrl, Shift, or one of the affordances</span>
<a href="#l1.9900"></a><span id="l1.9900">     // to select an entire thread.</span>
<a href="#l1.9901"></a><span id="l1.9901" class="difflineminus">-    isMultiSelect = (selectionCount &gt; 1 || (endRange-startRange) &gt; 0);</span>
<a href="#l1.9902"></a><span id="l1.9902" class="difflineminus">-  }</span>
<a href="#l1.9903"></a><span id="l1.9903" class="difflineminus">-</span>
<a href="#l1.9904"></a><span id="l1.9904" class="difflineminus">-  if (*msgToSelectAfterDelete == nsMsgViewIndex_None)</span>
<a href="#l1.9905"></a><span id="l1.9905" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.9906"></a><span id="l1.9906" class="difflineplus">+    isMultiSelect = (selectionCount &gt; 1 || (endRange - startRange) &gt; 0);</span>
<a href="#l1.9907"></a><span id="l1.9907" class="difflineplus">+  }</span>
<a href="#l1.9908"></a><span id="l1.9908" class="difflineplus">+</span>
<a href="#l1.9909"></a><span id="l1.9909" class="difflineplus">+  if (*msgToSelectAfterDelete == nsMsgViewIndex_None) return NS_OK;</span>
<a href="#l1.9910"></a><span id="l1.9910"> </span>
<a href="#l1.9911"></a><span id="l1.9911">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.9912"></a><span id="l1.9912">   GetMsgFolder(getter_AddRefs(folder));</span>
<a href="#l1.9913"></a><span id="l1.9913">   nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(folder);</span>
<a href="#l1.9914"></a><span id="l1.9914">   bool thisIsImapFolder = (imapFolder != nullptr);</span>
<a href="#l1.9915"></a><span id="l1.9915">   // Need to update the imap-delete model, can change more than once in a</span>
<a href="#l1.9916"></a><span id="l1.9916">   // session.</span>
<a href="#l1.9917"></a><span id="l1.9917" class="difflineminus">-  if (thisIsImapFolder)</span>
<a href="#l1.9918"></a><span id="l1.9918" class="difflineminus">-    GetImapDeleteModel(nullptr);</span>
<a href="#l1.9919"></a><span id="l1.9919" class="difflineplus">+  if (thisIsImapFolder) GetImapDeleteModel(nullptr);</span>
<a href="#l1.9920"></a><span id="l1.9920"> </span>
<a href="#l1.9921"></a><span id="l1.9921">   // If mail.delete_matches_sort_order is true,</span>
<a href="#l1.9922"></a><span id="l1.9922">   // for views sorted in descending order (newest at the top), make</span>
<a href="#l1.9923"></a><span id="l1.9923">   // msgToSelectAfterDelete advance in the same direction as the sort order.</span>
<a href="#l1.9924"></a><span id="l1.9924">   bool deleteMatchesSort = false;</span>
<a href="#l1.9925"></a><span id="l1.9925" class="difflineminus">-  if (m_sortOrder == nsMsgViewSortOrder::descending &amp;&amp; *msgToSelectAfterDelete)</span>
<a href="#l1.9926"></a><span id="l1.9926" class="difflineminus">-  {</span>
<a href="#l1.9927"></a><span id="l1.9927" class="difflineplus">+  if (m_sortOrder == nsMsgViewSortOrder::descending &amp;&amp;</span>
<a href="#l1.9928"></a><span id="l1.9928" class="difflineplus">+      *msgToSelectAfterDelete) {</span>
<a href="#l1.9929"></a><span id="l1.9929">     nsresult rv;</span>
<a href="#l1.9930"></a><span id="l1.9930" class="difflineminus">-    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch (do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.9931"></a><span id="l1.9931" class="difflineplus">+    nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(</span>
<a href="#l1.9932"></a><span id="l1.9932" class="difflineplus">+        do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l1.9933"></a><span id="l1.9933">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.9934"></a><span id="l1.9934" class="difflineminus">-    prefBranch-&gt;GetBoolPref(&quot;mail.delete_matches_sort_order&quot;, &amp;deleteMatchesSort);</span>
<a href="#l1.9935"></a><span id="l1.9935" class="difflineminus">-  }</span>
<a href="#l1.9936"></a><span id="l1.9936" class="difflineminus">-</span>
<a href="#l1.9937"></a><span id="l1.9937" class="difflineminus">-  if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete)</span>
<a href="#l1.9938"></a><span id="l1.9938" class="difflineminus">-  {</span>
<a href="#l1.9939"></a><span id="l1.9939" class="difflineminus">-    if (isMultiSelect)</span>
<a href="#l1.9940"></a><span id="l1.9940" class="difflineminus">-    {</span>
<a href="#l1.9941"></a><span id="l1.9941" class="difflineplus">+    prefBranch-&gt;GetBoolPref(&quot;mail.delete_matches_sort_order&quot;,</span>
<a href="#l1.9942"></a><span id="l1.9942" class="difflineplus">+                            &amp;deleteMatchesSort);</span>
<a href="#l1.9943"></a><span id="l1.9943" class="difflineplus">+  }</span>
<a href="#l1.9944"></a><span id="l1.9944" class="difflineplus">+</span>
<a href="#l1.9945"></a><span id="l1.9945" class="difflineplus">+  if (mDeleteModel == nsMsgImapDeleteModels::IMAPDelete) {</span>
<a href="#l1.9946"></a><span id="l1.9946" class="difflineplus">+    if (isMultiSelect) {</span>
<a href="#l1.9947"></a><span id="l1.9947">       if (deleteMatchesSort)</span>
<a href="#l1.9948"></a><span id="l1.9948">         *msgToSelectAfterDelete = startFirstRange - 1;</span>
<a href="#l1.9949"></a><span id="l1.9949">       else</span>
<a href="#l1.9950"></a><span id="l1.9950">         *msgToSelectAfterDelete = endFirstRange + 1;</span>
<a href="#l1.9951"></a><span id="l1.9951" class="difflineminus">-    }</span>
<a href="#l1.9952"></a><span id="l1.9952" class="difflineminus">-    else</span>
<a href="#l1.9953"></a><span id="l1.9953" class="difflineminus">-    {</span>
<a href="#l1.9954"></a><span id="l1.9954" class="difflineplus">+    } else {</span>
<a href="#l1.9955"></a><span id="l1.9955">       if (deleteMatchesSort)</span>
<a href="#l1.9956"></a><span id="l1.9956">         *msgToSelectAfterDelete -= 1;</span>
<a href="#l1.9957"></a><span id="l1.9957">       else</span>
<a href="#l1.9958"></a><span id="l1.9958">         *msgToSelectAfterDelete += 1;</span>
<a href="#l1.9959"></a><span id="l1.9959">     }</span>
<a href="#l1.9960"></a><span id="l1.9960" class="difflineminus">-  }</span>
<a href="#l1.9961"></a><span id="l1.9961" class="difflineminus">-  else if (deleteMatchesSort)</span>
<a href="#l1.9962"></a><span id="l1.9962" class="difflineminus">-  {</span>
<a href="#l1.9963"></a><span id="l1.9963" class="difflineplus">+  } else if (deleteMatchesSort) {</span>
<a href="#l1.9964"></a><span id="l1.9964">     *msgToSelectAfterDelete -= 1;</span>
<a href="#l1.9965"></a><span id="l1.9965">   }</span>
<a href="#l1.9966"></a><span id="l1.9966"> </span>
<a href="#l1.9967"></a><span id="l1.9967">   return NS_OK;</span>
<a href="#l1.9968"></a><span id="l1.9968"> }</span>
<a href="#l1.9969"></a><span id="l1.9969"> </span>
<a href="#l1.9970"></a><span id="l1.9970"> NS_IMETHODIMP</span>
<a href="#l1.9971"></a><span id="l1.9971" class="difflineminus">-nsMsgDBView::GetRemoveRowOnMoveOrDelete(bool *aRemoveRowOnMoveOrDelete)</span>
<a href="#l1.9972"></a><span id="l1.9972" class="difflineminus">-{</span>
<a href="#l1.9973"></a><span id="l1.9973" class="difflineplus">+nsMsgDBView::GetRemoveRowOnMoveOrDelete(bool *aRemoveRowOnMoveOrDelete) {</span>
<a href="#l1.9974"></a><span id="l1.9974">   NS_ENSURE_ARG_POINTER(aRemoveRowOnMoveOrDelete);</span>
<a href="#l1.9975"></a><span id="l1.9975" class="difflineminus">-  nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.9976"></a><span id="l1.9976" class="difflineminus">-  if (!imapFolder)</span>
<a href="#l1.9977"></a><span id="l1.9977" class="difflineminus">-  {</span>
<a href="#l1.9978"></a><span id="l1.9978" class="difflineplus">+  nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.9979"></a><span id="l1.9979" class="difflineplus">+  if (!imapFolder) {</span>
<a href="#l1.9980"></a><span id="l1.9980">     *aRemoveRowOnMoveOrDelete = true;</span>
<a href="#l1.9981"></a><span id="l1.9981">     return NS_OK;</span>
<a href="#l1.9982"></a><span id="l1.9982">   }</span>
<a href="#l1.9983"></a><span id="l1.9983"> </span>
<a href="#l1.9984"></a><span id="l1.9984">   // Need to update the imap-delete model, can change more than once in a</span>
<a href="#l1.9985"></a><span id="l1.9985">   // session.</span>
<a href="#l1.9986"></a><span id="l1.9986">   GetImapDeleteModel(nullptr);</span>
<a href="#l1.9987"></a><span id="l1.9987"> </span>
<a href="#l1.9988"></a><span id="l1.9988">   // Unlike the other imap delete models, &quot;mark as deleted&quot; does not remove</span>
<a href="#l1.9989"></a><span id="l1.9989">   // rows on delete (or move).</span>
<a href="#l1.9990"></a><span id="l1.9990" class="difflineminus">-  *aRemoveRowOnMoveOrDelete = (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete);</span>
<a href="#l1.9991"></a><span id="l1.9991" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.9992"></a><span id="l1.9992" class="difflineminus">-}</span>
<a href="#l1.9993"></a><span id="l1.9993" class="difflineminus">-</span>
<a href="#l1.9994"></a><span id="l1.9994" class="difflineplus">+  *aRemoveRowOnMoveOrDelete =</span>
<a href="#l1.9995"></a><span id="l1.9995" class="difflineplus">+      (mDeleteModel != nsMsgImapDeleteModels::IMAPDelete);</span>
<a href="#l1.9996"></a><span id="l1.9996" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.9997"></a><span id="l1.9997" class="difflineplus">+}</span>
<a href="#l1.9998"></a><span id="l1.9998"> </span>
<a href="#l1.9999"></a><span id="l1.9999"> NS_IMETHODIMP</span>
<a href="#l1.10000"></a><span id="l1.10000" class="difflineminus">-nsMsgDBView::GetCurrentlyDisplayedMessage(nsMsgViewIndex *currentlyDisplayedMessage)</span>
<a href="#l1.10001"></a><span id="l1.10001" class="difflineminus">-{</span>
<a href="#l1.10002"></a><span id="l1.10002" class="difflineplus">+nsMsgDBView::GetCurrentlyDisplayedMessage(</span>
<a href="#l1.10003"></a><span id="l1.10003" class="difflineplus">+    nsMsgViewIndex *currentlyDisplayedMessage) {</span>
<a href="#l1.10004"></a><span id="l1.10004">   NS_ENSURE_ARG_POINTER(currentlyDisplayedMessage);</span>
<a href="#l1.10005"></a><span id="l1.10005">   *currentlyDisplayedMessage = FindViewIndex(m_currentlyDisplayedMsgKey);</span>
<a href="#l1.10006"></a><span id="l1.10006">   return NS_OK;</span>
<a href="#l1.10007"></a><span id="l1.10007"> }</span>
<a href="#l1.10008"></a><span id="l1.10008"> </span>
<a href="#l1.10009"></a><span id="l1.10009"> // If nothing selected, return an NS_ERROR.</span>
<a href="#l1.10010"></a><span id="l1.10010"> NS_IMETHODIMP</span>
<a href="#l1.10011"></a><span id="l1.10011" class="difflineminus">-nsMsgDBView::GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr)</span>
<a href="#l1.10012"></a><span id="l1.10012" class="difflineminus">-{</span>
<a href="#l1.10013"></a><span id="l1.10013" class="difflineplus">+nsMsgDBView::GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr) {</span>
<a href="#l1.10014"></a><span id="l1.10014">   NS_ENSURE_ARG_POINTER(hdr);</span>
<a href="#l1.10015"></a><span id="l1.10015"> </span>
<a href="#l1.10016"></a><span id="l1.10016">   nsresult rv;</span>
<a href="#l1.10017"></a><span id="l1.10017">   nsMsgKey key;</span>
<a href="#l1.10018"></a><span id="l1.10018">   rv = GetKeyForFirstSelectedMessage(&amp;key);</span>
<a href="#l1.10019"></a><span id="l1.10019">   // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10020"></a><span id="l1.10020" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.10021"></a><span id="l1.10021" class="difflineminus">-    return rv;</span>
<a href="#l1.10022"></a><span id="l1.10022" class="difflineminus">-</span>
<a href="#l1.10023"></a><span id="l1.10023" class="difflineminus">-  if (!m_db)</span>
<a href="#l1.10024"></a><span id="l1.10024" class="difflineminus">-    return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.10025"></a><span id="l1.10025" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.10026"></a><span id="l1.10026" class="difflineplus">+</span>
<a href="#l1.10027"></a><span id="l1.10027" class="difflineplus">+  if (!m_db) return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l1.10028"></a><span id="l1.10028"> </span>
<a href="#l1.10029"></a><span id="l1.10029">   rv = m_db-&gt;GetMsgHdrForKey(key, hdr);</span>
<a href="#l1.10030"></a><span id="l1.10030" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10031"></a><span id="l1.10031" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10032"></a><span id="l1.10032">   return NS_OK;</span>
<a href="#l1.10033"></a><span id="l1.10033"> }</span>
<a href="#l1.10034"></a><span id="l1.10034"> </span>
<a href="#l1.10035"></a><span id="l1.10035"> // If nothing selected, return an NS_ERROR.</span>
<a href="#l1.10036"></a><span id="l1.10036"> NS_IMETHODIMP</span>
<a href="#l1.10037"></a><span id="l1.10037" class="difflineminus">-nsMsgDBView::GetURIForFirstSelectedMessage(nsACString &amp;uri)</span>
<a href="#l1.10038"></a><span id="l1.10038" class="difflineminus">-{</span>
<a href="#l1.10039"></a><span id="l1.10039" class="difflineplus">+nsMsgDBView::GetURIForFirstSelectedMessage(nsACString &amp;uri) {</span>
<a href="#l1.10040"></a><span id="l1.10040">   nsresult rv;</span>
<a href="#l1.10041"></a><span id="l1.10041">   nsMsgViewIndex viewIndex;</span>
<a href="#l1.10042"></a><span id="l1.10042">   rv = GetViewIndexForFirstSelectedMsg(&amp;viewIndex);</span>
<a href="#l1.10043"></a><span id="l1.10043">   // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10044"></a><span id="l1.10044" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.10045"></a><span id="l1.10045" class="difflineminus">-    return rv;</span>
<a href="#l1.10046"></a><span id="l1.10046" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.10047"></a><span id="l1.10047"> </span>
<a href="#l1.10048"></a><span id="l1.10048">   return GetURIForViewIndex(viewIndex, uri);</span>
<a href="#l1.10049"></a><span id="l1.10049"> }</span>
<a href="#l1.10050"></a><span id="l1.10050"> </span>
<a href="#l1.10051"></a><span id="l1.10051"> NS_IMETHODIMP</span>
<a href="#l1.10052"></a><span id="l1.10052" class="difflineminus">-nsMsgDBView::OnDeleteCompleted(bool aSucceeded)</span>
<a href="#l1.10053"></a><span id="l1.10053" class="difflineminus">-{</span>
<a href="#l1.10054"></a><span id="l1.10054" class="difflineminus">-  if (m_deletingRows &amp;&amp; aSucceeded)</span>
<a href="#l1.10055"></a><span id="l1.10055" class="difflineminus">-  {</span>
<a href="#l1.10056"></a><span id="l1.10056" class="difflineplus">+nsMsgDBView::OnDeleteCompleted(bool aSucceeded) {</span>
<a href="#l1.10057"></a><span id="l1.10057" class="difflineplus">+  if (m_deletingRows &amp;&amp; aSucceeded) {</span>
<a href="#l1.10058"></a><span id="l1.10058">     uint32_t numIndices = mIndicesToNoteChange.Length();</span>
<a href="#l1.10059"></a><span id="l1.10059" class="difflineminus">-    if (numIndices &amp;&amp; mTree)</span>
<a href="#l1.10060"></a><span id="l1.10060" class="difflineminus">-    {</span>
<a href="#l1.10061"></a><span id="l1.10061" class="difflineminus">-      if (numIndices &gt; 1)</span>
<a href="#l1.10062"></a><span id="l1.10062" class="difflineminus">-        mIndicesToNoteChange.Sort();</span>
<a href="#l1.10063"></a><span id="l1.10063" class="difflineplus">+    if (numIndices &amp;&amp; mTree) {</span>
<a href="#l1.10064"></a><span id="l1.10064" class="difflineplus">+      if (numIndices &gt; 1) mIndicesToNoteChange.Sort();</span>
<a href="#l1.10065"></a><span id="l1.10065"> </span>
<a href="#l1.10066"></a><span id="l1.10066">       // The call to NoteChange() has to happen after we are done removing the</span>
<a href="#l1.10067"></a><span id="l1.10067">       // keys as NoteChange() will call RowCountChanged() which will call our</span>
<a href="#l1.10068"></a><span id="l1.10068">       // GetRowCount().</span>
<a href="#l1.10069"></a><span id="l1.10069" class="difflineminus">-      if (numIndices &gt; 1)</span>
<a href="#l1.10070"></a><span id="l1.10070" class="difflineminus">-        mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.10071"></a><span id="l1.10071" class="difflineplus">+      if (numIndices &gt; 1) mTree-&gt;BeginUpdateBatch();</span>
<a href="#l1.10072"></a><span id="l1.10072"> </span>
<a href="#l1.10073"></a><span id="l1.10073">       for (uint32_t i = 0; i &lt; numIndices; i++)</span>
<a href="#l1.10074"></a><span id="l1.10074" class="difflineminus">-        NoteChange(mIndicesToNoteChange[i], -1, nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.10075"></a><span id="l1.10075" class="difflineminus">-</span>
<a href="#l1.10076"></a><span id="l1.10076" class="difflineminus">-      if (numIndices &gt; 1)</span>
<a href="#l1.10077"></a><span id="l1.10077" class="difflineminus">-        mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.10078"></a><span id="l1.10078" class="difflineplus">+        NoteChange(mIndicesToNoteChange[i], -1,</span>
<a href="#l1.10079"></a><span id="l1.10079" class="difflineplus">+                   nsMsgViewNotificationCode::insertOrDelete);</span>
<a href="#l1.10080"></a><span id="l1.10080" class="difflineplus">+</span>
<a href="#l1.10081"></a><span id="l1.10081" class="difflineplus">+      if (numIndices &gt; 1) mTree-&gt;EndUpdateBatch();</span>
<a href="#l1.10082"></a><span id="l1.10082">     }</span>
<a href="#l1.10083"></a><span id="l1.10083"> </span>
<a href="#l1.10084"></a><span id="l1.10084">     mIndicesToNoteChange.Clear();</span>
<a href="#l1.10085"></a><span id="l1.10085">   }</span>
<a href="#l1.10086"></a><span id="l1.10086"> </span>
<a href="#l1.10087"></a><span id="l1.10087" class="difflineminus">- m_deletingRows = false;</span>
<a href="#l1.10088"></a><span id="l1.10088" class="difflineminus">- return NS_OK;</span>
<a href="#l1.10089"></a><span id="l1.10089" class="difflineplus">+  m_deletingRows = false;</span>
<a href="#l1.10090"></a><span id="l1.10090" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.10091"></a><span id="l1.10091"> }</span>
<a href="#l1.10092"></a><span id="l1.10092"> </span>
<a href="#l1.10093"></a><span id="l1.10093"> NS_IMETHODIMP</span>
<a href="#l1.10094"></a><span id="l1.10094" class="difflineminus">-nsMsgDBView::GetDb(nsIMsgDatabase **aDB)</span>
<a href="#l1.10095"></a><span id="l1.10095" class="difflineminus">-{</span>
<a href="#l1.10096"></a><span id="l1.10096" class="difflineplus">+nsMsgDBView::GetDb(nsIMsgDatabase **aDB) {</span>
<a href="#l1.10097"></a><span id="l1.10097">   NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l1.10098"></a><span id="l1.10098">   NS_IF_ADDREF(*aDB = m_db);</span>
<a href="#l1.10099"></a><span id="l1.10099">   return NS_OK;</span>
<a href="#l1.10100"></a><span id="l1.10100"> }</span>
<a href="#l1.10101"></a><span id="l1.10101"> </span>
<a href="#l1.10102"></a><span id="l1.10102" class="difflineminus">-bool</span>
<a href="#l1.10103"></a><span id="l1.10103" class="difflineminus">-nsMsgDBView::OfflineMsgSelected(nsMsgViewIndex * indices,</span>
<a href="#l1.10104"></a><span id="l1.10104" class="difflineminus">-                                int32_t numIndices)</span>
<a href="#l1.10105"></a><span id="l1.10105" class="difflineminus">-{</span>
<a href="#l1.10106"></a><span id="l1.10106" class="difflineminus">-  nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.10107"></a><span id="l1.10107" class="difflineminus">-  if (localFolder)</span>
<a href="#l1.10108"></a><span id="l1.10108" class="difflineminus">-    return true;</span>
<a href="#l1.10109"></a><span id="l1.10109" class="difflineminus">-</span>
<a href="#l1.10110"></a><span id="l1.10110" class="difflineminus">-  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex) numIndices; index++)</span>
<a href="#l1.10111"></a><span id="l1.10111" class="difflineminus">-  {</span>
<a href="#l1.10112"></a><span id="l1.10112" class="difflineplus">+bool nsMsgDBView::OfflineMsgSelected(nsMsgViewIndex *indices,</span>
<a href="#l1.10113"></a><span id="l1.10113" class="difflineplus">+                                     int32_t numIndices) {</span>
<a href="#l1.10114"></a><span id="l1.10114" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l1.10115"></a><span id="l1.10115" class="difflineplus">+  if (localFolder) return true;</span>
<a href="#l1.10116"></a><span id="l1.10116" class="difflineplus">+</span>
<a href="#l1.10117"></a><span id="l1.10117" class="difflineplus">+  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex)numIndices; index++) {</span>
<a href="#l1.10118"></a><span id="l1.10118">     // For cross-folder saved searches, we need to check if any message</span>
<a href="#l1.10119"></a><span id="l1.10119">     // is in a local folder.</span>
<a href="#l1.10120"></a><span id="l1.10120" class="difflineminus">-    if (!m_folder)</span>
<a href="#l1.10121"></a><span id="l1.10121" class="difflineminus">-    {</span>
<a href="#l1.10122"></a><span id="l1.10122" class="difflineplus">+    if (!m_folder) {</span>
<a href="#l1.10123"></a><span id="l1.10123">       nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.10124"></a><span id="l1.10124">       GetFolderForViewIndex(indices[index], getter_AddRefs(folder));</span>
<a href="#l1.10125"></a><span id="l1.10125" class="difflineminus">-      nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l1.10126"></a><span id="l1.10126" class="difflineminus">-      if (localFolder)</span>
<a href="#l1.10127"></a><span id="l1.10127" class="difflineminus">-        return true;</span>
<a href="#l1.10128"></a><span id="l1.10128" class="difflineplus">+      nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l1.10129"></a><span id="l1.10129" class="difflineplus">+      if (localFolder) return true;</span>
<a href="#l1.10130"></a><span id="l1.10130">     }</span>
<a href="#l1.10131"></a><span id="l1.10131"> </span>
<a href="#l1.10132"></a><span id="l1.10132">     uint32_t flags = m_flags[indices[index]];</span>
<a href="#l1.10133"></a><span id="l1.10133" class="difflineminus">-    if ((flags &amp; nsMsgMessageFlags::Offline))</span>
<a href="#l1.10134"></a><span id="l1.10134" class="difflineminus">-      return true;</span>
<a href="#l1.10135"></a><span id="l1.10135" class="difflineplus">+    if ((flags &amp; nsMsgMessageFlags::Offline)) return true;</span>
<a href="#l1.10136"></a><span id="l1.10136">   }</span>
<a href="#l1.10137"></a><span id="l1.10137"> </span>
<a href="#l1.10138"></a><span id="l1.10138">   return false;</span>
<a href="#l1.10139"></a><span id="l1.10139"> }</span>
<a href="#l1.10140"></a><span id="l1.10140"> </span>
<a href="#l1.10141"></a><span id="l1.10141" class="difflineminus">-bool</span>
<a href="#l1.10142"></a><span id="l1.10142" class="difflineminus">-nsMsgDBView::NonDummyMsgSelected(nsMsgViewIndex * indices,</span>
<a href="#l1.10143"></a><span id="l1.10143" class="difflineminus">-                                 int32_t numIndices)</span>
<a href="#l1.10144"></a><span id="l1.10144" class="difflineminus">-{</span>
<a href="#l1.10145"></a><span id="l1.10145" class="difflineplus">+bool nsMsgDBView::NonDummyMsgSelected(nsMsgViewIndex *indices,</span>
<a href="#l1.10146"></a><span id="l1.10146" class="difflineplus">+                                      int32_t numIndices) {</span>
<a href="#l1.10147"></a><span id="l1.10147">   bool includeCollapsedMsgs = OperateOnMsgsInCollapsedThreads();</span>
<a href="#l1.10148"></a><span id="l1.10148"> </span>
<a href="#l1.10149"></a><span id="l1.10149" class="difflineminus">-  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex) numIndices; index++)</span>
<a href="#l1.10150"></a><span id="l1.10150" class="difflineminus">-  {</span>
<a href="#l1.10151"></a><span id="l1.10151" class="difflineplus">+  for (nsMsgViewIndex index = 0; index &lt; (nsMsgViewIndex)numIndices; index++) {</span>
<a href="#l1.10152"></a><span id="l1.10152">     uint32_t flags = m_flags[indices[index]];</span>
<a href="#l1.10153"></a><span id="l1.10153">     // We now treat having a collapsed dummy message selected as if</span>
<a href="#l1.10154"></a><span id="l1.10154">     // the whole group was selected so we can apply commands to the group.</span>
<a href="#l1.10155"></a><span id="l1.10155">     if (!(flags &amp; MSG_VIEW_FLAG_DUMMY) ||</span>
<a href="#l1.10156"></a><span id="l1.10156">         (flags &amp; nsMsgMessageFlags::Elided &amp;&amp; includeCollapsedMsgs))</span>
<a href="#l1.10157"></a><span id="l1.10157">       return true;</span>
<a href="#l1.10158"></a><span id="l1.10158">   }</span>
<a href="#l1.10159"></a><span id="l1.10159"> </span>
<a href="#l1.10160"></a><span id="l1.10160">   return false;</span>
<a href="#l1.10161"></a><span id="l1.10161"> }</span>
<a href="#l1.10162"></a><span id="l1.10162"> </span>
<a href="#l1.10163"></a><span id="l1.10163"> NS_IMETHODIMP</span>
<a href="#l1.10164"></a><span id="l1.10164" class="difflineminus">-nsMsgDBView::GetViewIndexForFirstSelectedMsg(nsMsgViewIndex *aViewIndex)</span>
<a href="#l1.10165"></a><span id="l1.10165" class="difflineminus">-{</span>
<a href="#l1.10166"></a><span id="l1.10166" class="difflineplus">+nsMsgDBView::GetViewIndexForFirstSelectedMsg(nsMsgViewIndex *aViewIndex) {</span>
<a href="#l1.10167"></a><span id="l1.10167">   NS_ENSURE_ARG_POINTER(aViewIndex);</span>
<a href="#l1.10168"></a><span id="l1.10168">   // If we don't have a tree selection we must be in stand alone mode...</span>
<a href="#l1.10169"></a><span id="l1.10169" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.10170"></a><span id="l1.10170" class="difflineminus">-  {</span>
<a href="#l1.10171"></a><span id="l1.10171" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.10172"></a><span id="l1.10172">     *aViewIndex = m_currentlyDisplayedViewIndex;</span>
<a href="#l1.10173"></a><span id="l1.10173">     return NS_OK;</span>
<a href="#l1.10174"></a><span id="l1.10174">   }</span>
<a href="#l1.10175"></a><span id="l1.10175"> </span>
<a href="#l1.10176"></a><span id="l1.10176">   int32_t startRange;</span>
<a href="#l1.10177"></a><span id="l1.10177">   int32_t endRange;</span>
<a href="#l1.10178"></a><span id="l1.10178">   nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.10179"></a><span id="l1.10179">   // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10180"></a><span id="l1.10180" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.10181"></a><span id="l1.10181" class="difflineminus">-    return rv;</span>
<a href="#l1.10182"></a><span id="l1.10182" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.10183"></a><span id="l1.10183"> </span>
<a href="#l1.10184"></a><span id="l1.10184">   // Check that the first index is valid, it may not be if nothing is selected.</span>
<a href="#l1.10185"></a><span id="l1.10185">   if (startRange &lt; 0 || uint32_t(startRange) &gt;= GetSize())</span>
<a href="#l1.10186"></a><span id="l1.10186">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.10187"></a><span id="l1.10187"> </span>
<a href="#l1.10188"></a><span id="l1.10188">   *aViewIndex = startRange;</span>
<a href="#l1.10189"></a><span id="l1.10189">   return NS_OK;</span>
<a href="#l1.10190"></a><span id="l1.10190"> }</span>
<a href="#l1.10191"></a><span id="l1.10191"> </span>
<a href="#l1.10192"></a><span id="l1.10192"> NS_IMETHODIMP</span>
<a href="#l1.10193"></a><span id="l1.10193" class="difflineminus">-nsMsgDBView::GetKeyForFirstSelectedMessage(nsMsgKey *key)</span>
<a href="#l1.10194"></a><span id="l1.10194" class="difflineminus">-{</span>
<a href="#l1.10195"></a><span id="l1.10195" class="difflineplus">+nsMsgDBView::GetKeyForFirstSelectedMessage(nsMsgKey *key) {</span>
<a href="#l1.10196"></a><span id="l1.10196">   NS_ENSURE_ARG_POINTER(key);</span>
<a href="#l1.10197"></a><span id="l1.10197">   // If we don't have a tree selection we must be in stand alone mode...</span>
<a href="#l1.10198"></a><span id="l1.10198" class="difflineminus">-  if (!mTreeSelection)</span>
<a href="#l1.10199"></a><span id="l1.10199" class="difflineminus">-  {</span>
<a href="#l1.10200"></a><span id="l1.10200" class="difflineplus">+  if (!mTreeSelection) {</span>
<a href="#l1.10201"></a><span id="l1.10201">     *key = m_currentlyDisplayedMsgKey;</span>
<a href="#l1.10202"></a><span id="l1.10202">     return NS_OK;</span>
<a href="#l1.10203"></a><span id="l1.10203">   }</span>
<a href="#l1.10204"></a><span id="l1.10204"> </span>
<a href="#l1.10205"></a><span id="l1.10205">   int32_t startRange;</span>
<a href="#l1.10206"></a><span id="l1.10206">   int32_t endRange;</span>
<a href="#l1.10207"></a><span id="l1.10207">   nsresult rv = mTreeSelection-&gt;GetRangeAt(0, &amp;startRange, &amp;endRange);</span>
<a href="#l1.10208"></a><span id="l1.10208">   // Don't assert, it is legal for nothing to be selected.</span>
<a href="#l1.10209"></a><span id="l1.10209" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l1.10210"></a><span id="l1.10210" class="difflineminus">-    return rv;</span>
<a href="#l1.10211"></a><span id="l1.10211" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.10212"></a><span id="l1.10212"> </span>
<a href="#l1.10213"></a><span id="l1.10213">   // Check that the first index is valid, it may not be if nothing is selected.</span>
<a href="#l1.10214"></a><span id="l1.10214">   if (startRange &lt; 0 || uint32_t(startRange) &gt;= GetSize())</span>
<a href="#l1.10215"></a><span id="l1.10215">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l1.10216"></a><span id="l1.10216"> </span>
<a href="#l1.10217"></a><span id="l1.10217">   if (m_flags[startRange] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.10218"></a><span id="l1.10218">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l1.10219"></a><span id="l1.10219"> </span>
<a href="#l1.10220"></a><span id="l1.10220">   *key = m_keys[startRange];</span>
<a href="#l1.10221"></a><span id="l1.10221">   return NS_OK;</span>
<a href="#l1.10222"></a><span id="l1.10222"> }</span>
<a href="#l1.10223"></a><span id="l1.10223"> </span>
<a href="#l1.10224"></a><span id="l1.10224" class="difflineminus">-nsCOMArray&lt;nsIMsgFolder&gt;* nsMsgDBView::GetFolders()</span>
<a href="#l1.10225"></a><span id="l1.10225" class="difflineminus">-{</span>
<a href="#l1.10226"></a><span id="l1.10226" class="difflineminus">-  return nullptr;</span>
<a href="#l1.10227"></a><span id="l1.10227" class="difflineminus">-}</span>
<a href="#l1.10228"></a><span id="l1.10228" class="difflineminus">-</span>
<a href="#l1.10229"></a><span id="l1.10229" class="difflineminus">-nsresult</span>
<a href="#l1.10230"></a><span id="l1.10230" class="difflineminus">-nsMsgDBView::AdjustRowCount(int32_t rowCountBeforeSort,</span>
<a href="#l1.10231"></a><span id="l1.10231" class="difflineminus">-                            int32_t rowCountAfterSort)</span>
<a href="#l1.10232"></a><span id="l1.10232" class="difflineminus">-{</span>
<a href="#l1.10233"></a><span id="l1.10233" class="difflineplus">+nsCOMArray&lt;nsIMsgFolder&gt; *nsMsgDBView::GetFolders() { return nullptr; }</span>
<a href="#l1.10234"></a><span id="l1.10234" class="difflineplus">+</span>
<a href="#l1.10235"></a><span id="l1.10235" class="difflineplus">+nsresult nsMsgDBView::AdjustRowCount(int32_t rowCountBeforeSort,</span>
<a href="#l1.10236"></a><span id="l1.10236" class="difflineplus">+                                     int32_t rowCountAfterSort) {</span>
<a href="#l1.10237"></a><span id="l1.10237">   int32_t rowChange = rowCountAfterSort - rowCountBeforeSort;</span>
<a href="#l1.10238"></a><span id="l1.10238"> </span>
<a href="#l1.10239"></a><span id="l1.10239" class="difflineminus">-  if (rowChange)</span>
<a href="#l1.10240"></a><span id="l1.10240" class="difflineminus">-  {</span>
<a href="#l1.10241"></a><span id="l1.10241" class="difflineplus">+  if (rowChange) {</span>
<a href="#l1.10242"></a><span id="l1.10242">     // This is not safe to use when you have a selection.</span>
<a href="#l1.10243"></a><span id="l1.10243">     // RowCountChanged() will call AdjustSelection().</span>
<a href="#l1.10244"></a><span id="l1.10244">     uint32_t numSelected = 0;</span>
<a href="#l1.10245"></a><span id="l1.10245">     GetNumSelected(&amp;numSelected);</span>
<a href="#l1.10246"></a><span id="l1.10246" class="difflineminus">-    NS_ASSERTION(numSelected == 0,</span>
<a href="#l1.10247"></a><span id="l1.10247" class="difflineminus">-                 &quot;it is not save to call AdjustRowCount() when you have a selection&quot;);</span>
<a href="#l1.10248"></a><span id="l1.10248" class="difflineminus">-</span>
<a href="#l1.10249"></a><span id="l1.10249" class="difflineminus">-    if (mTree)</span>
<a href="#l1.10250"></a><span id="l1.10250" class="difflineminus">-      mTree-&gt;RowCountChanged(0, rowChange);</span>
<a href="#l1.10251"></a><span id="l1.10251" class="difflineminus">-  }</span>
<a href="#l1.10252"></a><span id="l1.10252" class="difflineminus">-</span>
<a href="#l1.10253"></a><span id="l1.10253" class="difflineminus">-  return NS_OK;</span>
<a href="#l1.10254"></a><span id="l1.10254" class="difflineminus">-}</span>
<a href="#l1.10255"></a><span id="l1.10255" class="difflineminus">-</span>
<a href="#l1.10256"></a><span id="l1.10256" class="difflineminus">-nsresult</span>
<a href="#l1.10257"></a><span id="l1.10257" class="difflineminus">-nsMsgDBView::GetImapDeleteModel(nsIMsgFolder *folder)</span>
<a href="#l1.10258"></a><span id="l1.10258" class="difflineminus">-{</span>
<a href="#l1.10259"></a><span id="l1.10259" class="difflineminus">-   nsresult rv = NS_OK;</span>
<a href="#l1.10260"></a><span id="l1.10260" class="difflineminus">-   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10261"></a><span id="l1.10261" class="difflineminus">-   // For the search view.</span>
<a href="#l1.10262"></a><span id="l1.10262" class="difflineminus">-   if (folder)</span>
<a href="#l1.10263"></a><span id="l1.10263" class="difflineminus">-     folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10264"></a><span id="l1.10264" class="difflineminus">-   else if (m_folder)</span>
<a href="#l1.10265"></a><span id="l1.10265" class="difflineminus">-     m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10266"></a><span id="l1.10266" class="difflineminus">-</span>
<a href="#l1.10267"></a><span id="l1.10267" class="difflineminus">-   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l1.10268"></a><span id="l1.10268" class="difflineminus">-   if (NS_SUCCEEDED(rv) &amp;&amp; imapServer )</span>
<a href="#l1.10269"></a><span id="l1.10269" class="difflineminus">-     imapServer-&gt;GetDeleteModel(&amp;mDeleteModel);</span>
<a href="#l1.10270"></a><span id="l1.10270" class="difflineminus">-</span>
<a href="#l1.10271"></a><span id="l1.10271" class="difflineminus">-   return rv;</span>
<a href="#l1.10272"></a><span id="l1.10272" class="difflineplus">+    NS_ASSERTION(</span>
<a href="#l1.10273"></a><span id="l1.10273" class="difflineplus">+        numSelected == 0,</span>
<a href="#l1.10274"></a><span id="l1.10274" class="difflineplus">+        &quot;it is not save to call AdjustRowCount() when you have a selection&quot;);</span>
<a href="#l1.10275"></a><span id="l1.10275" class="difflineplus">+</span>
<a href="#l1.10276"></a><span id="l1.10276" class="difflineplus">+    if (mTree) mTree-&gt;RowCountChanged(0, rowChange);</span>
<a href="#l1.10277"></a><span id="l1.10277" class="difflineplus">+  }</span>
<a href="#l1.10278"></a><span id="l1.10278" class="difflineplus">+</span>
<a href="#l1.10279"></a><span id="l1.10279" class="difflineplus">+  return NS_OK;</span>
<a href="#l1.10280"></a><span id="l1.10280" class="difflineplus">+}</span>
<a href="#l1.10281"></a><span id="l1.10281" class="difflineplus">+</span>
<a href="#l1.10282"></a><span id="l1.10282" class="difflineplus">+nsresult nsMsgDBView::GetImapDeleteModel(nsIMsgFolder *folder) {</span>
<a href="#l1.10283"></a><span id="l1.10283" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l1.10284"></a><span id="l1.10284" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10285"></a><span id="l1.10285" class="difflineplus">+  // For the search view.</span>
<a href="#l1.10286"></a><span id="l1.10286" class="difflineplus">+  if (folder)</span>
<a href="#l1.10287"></a><span id="l1.10287" class="difflineplus">+    folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10288"></a><span id="l1.10288" class="difflineplus">+  else if (m_folder)</span>
<a href="#l1.10289"></a><span id="l1.10289" class="difflineplus">+    m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10290"></a><span id="l1.10290" class="difflineplus">+</span>
<a href="#l1.10291"></a><span id="l1.10291" class="difflineplus">+  nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l1.10292"></a><span id="l1.10292" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; imapServer) imapServer-&gt;GetDeleteModel(&amp;mDeleteModel);</span>
<a href="#l1.10293"></a><span id="l1.10293" class="difflineplus">+</span>
<a href="#l1.10294"></a><span id="l1.10294" class="difflineplus">+  return rv;</span>
<a href="#l1.10295"></a><span id="l1.10295"> }</span>
<a href="#l1.10296"></a><span id="l1.10296"> </span>
<a href="#l1.10297"></a><span id="l1.10297"> //</span>
<a href="#l1.10298"></a><span id="l1.10298"> // CanDrop</span>
<a href="#l1.10299"></a><span id="l1.10299"> //</span>
<a href="#l1.10300"></a><span id="l1.10300"> // Can't drop on the thread pane.</span>
<a href="#l1.10301"></a><span id="l1.10301"> //</span>
<a href="#l1.10302"></a><span id="l1.10302"> NS_IMETHODIMP</span>
<a href="#l1.10303"></a><span id="l1.10303" class="difflineminus">-nsMsgDBView::CanDrop(int32_t index,</span>
<a href="#l1.10304"></a><span id="l1.10304" class="difflineminus">-                     int32_t orient,</span>
<a href="#l1.10305"></a><span id="l1.10305" class="difflineminus">-                     mozilla::dom::DataTransfer *dataTransfer,</span>
<a href="#l1.10306"></a><span id="l1.10306" class="difflineminus">-                     bool *_retval)</span>
<a href="#l1.10307"></a><span id="l1.10307" class="difflineminus">-{</span>
<a href="#l1.10308"></a><span id="l1.10308" class="difflineplus">+nsMsgDBView::CanDrop(int32_t index, int32_t orient,</span>
<a href="#l1.10309"></a><span id="l1.10309" class="difflineplus">+                     mozilla::dom::DataTransfer *dataTransfer, bool *_retval) {</span>
<a href="#l1.10310"></a><span id="l1.10310">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l1.10311"></a><span id="l1.10311">   *_retval = false;</span>
<a href="#l1.10312"></a><span id="l1.10312"> </span>
<a href="#l1.10313"></a><span id="l1.10313">   return NS_OK;</span>
<a href="#l1.10314"></a><span id="l1.10314"> }</span>
<a href="#l1.10315"></a><span id="l1.10315"> </span>
<a href="#l1.10316"></a><span id="l1.10316"> //</span>
<a href="#l1.10317"></a><span id="l1.10317"> // Drop</span>
<a href="#l1.10318"></a><span id="l1.10318"> //</span>
<a href="#l1.10319"></a><span id="l1.10319"> // Can't drop on the thread pane.</span>
<a href="#l1.10320"></a><span id="l1.10320"> //</span>
<a href="#l1.10321"></a><span id="l1.10321"> NS_IMETHODIMP</span>
<a href="#l1.10322"></a><span id="l1.10322" class="difflineminus">-nsMsgDBView::Drop(int32_t row,</span>
<a href="#l1.10323"></a><span id="l1.10323" class="difflineminus">-                  int32_t orient,</span>
<a href="#l1.10324"></a><span id="l1.10324" class="difflineminus">-                  mozilla::dom::DataTransfer *dataTransfer)</span>
<a href="#l1.10325"></a><span id="l1.10325" class="difflineminus">-{</span>
<a href="#l1.10326"></a><span id="l1.10326" class="difflineplus">+nsMsgDBView::Drop(int32_t row, int32_t orient,</span>
<a href="#l1.10327"></a><span id="l1.10327" class="difflineplus">+                  mozilla::dom::DataTransfer *dataTransfer) {</span>
<a href="#l1.10328"></a><span id="l1.10328">   return NS_OK;</span>
<a href="#l1.10329"></a><span id="l1.10329"> }</span>
<a href="#l1.10330"></a><span id="l1.10330"> </span>
<a href="#l1.10331"></a><span id="l1.10331"> //</span>
<a href="#l1.10332"></a><span id="l1.10332"> // IsSorted</span>
<a href="#l1.10333"></a><span id="l1.10333"> //</span>
<a href="#l1.10334"></a><span id="l1.10334"> // ...</span>
<a href="#l1.10335"></a><span id="l1.10335"> //</span>
<a href="#l1.10336"></a><span id="l1.10336"> NS_IMETHODIMP</span>
<a href="#l1.10337"></a><span id="l1.10337" class="difflineminus">-nsMsgDBView::IsSorted(bool *_retval)</span>
<a href="#l1.10338"></a><span id="l1.10338" class="difflineminus">-{</span>
<a href="#l1.10339"></a><span id="l1.10339" class="difflineplus">+nsMsgDBView::IsSorted(bool *_retval) {</span>
<a href="#l1.10340"></a><span id="l1.10340">   *_retval = false;</span>
<a href="#l1.10341"></a><span id="l1.10341">   return NS_OK;</span>
<a href="#l1.10342"></a><span id="l1.10342"> }</span>
<a href="#l1.10343"></a><span id="l1.10343"> </span>
<a href="#l1.10344"></a><span id="l1.10344"> NS_IMETHODIMP</span>
<a href="#l1.10345"></a><span id="l1.10345" class="difflineminus">-nsMsgDBView::SelectFolderMsgByKey(nsIMsgFolder *aFolder,</span>
<a href="#l1.10346"></a><span id="l1.10346" class="difflineminus">-                                  nsMsgKey aKey)</span>
<a href="#l1.10347"></a><span id="l1.10347" class="difflineminus">-{</span>
<a href="#l1.10348"></a><span id="l1.10348" class="difflineplus">+nsMsgDBView::SelectFolderMsgByKey(nsIMsgFolder *aFolder, nsMsgKey aKey) {</span>
<a href="#l1.10349"></a><span id="l1.10349">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l1.10350"></a><span id="l1.10350" class="difflineminus">-  if (aKey == nsMsgKey_None)</span>
<a href="#l1.10351"></a><span id="l1.10351" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.10352"></a><span id="l1.10352" class="difflineplus">+  if (aKey == nsMsgKey_None) return NS_ERROR_FAILURE;</span>
<a href="#l1.10353"></a><span id="l1.10353"> </span>
<a href="#l1.10354"></a><span id="l1.10354">   // This is OK for non search views.</span>
<a href="#l1.10355"></a><span id="l1.10355"> </span>
<a href="#l1.10356"></a><span id="l1.10356">   nsMsgViewIndex viewIndex = FindKey(aKey, true /* expand */);</span>
<a href="#l1.10357"></a><span id="l1.10357"> </span>
<a href="#l1.10358"></a><span id="l1.10358" class="difflineminus">-  if (mTree)</span>
<a href="#l1.10359"></a><span id="l1.10359" class="difflineminus">-    mTreeSelection-&gt;SetCurrentIndex(viewIndex);</span>
<a href="#l1.10360"></a><span id="l1.10360" class="difflineplus">+  if (mTree) mTreeSelection-&gt;SetCurrentIndex(viewIndex);</span>
<a href="#l1.10361"></a><span id="l1.10361"> </span>
<a href="#l1.10362"></a><span id="l1.10362">   // Make sure the current message is once again visible in the thread pane</span>
<a href="#l1.10363"></a><span id="l1.10363">   // so we don't have to go search for it in the thread pane.</span>
<a href="#l1.10364"></a><span id="l1.10364" class="difflineminus">-  if (mTree &amp;&amp; viewIndex != nsMsgViewIndex_None)</span>
<a href="#l1.10365"></a><span id="l1.10365" class="difflineminus">-  {</span>
<a href="#l1.10366"></a><span id="l1.10366" class="difflineplus">+  if (mTree &amp;&amp; viewIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.10367"></a><span id="l1.10367">     mTreeSelection-&gt;Select(viewIndex);</span>
<a href="#l1.10368"></a><span id="l1.10368">     mTree-&gt;EnsureRowIsVisible(viewIndex);</span>
<a href="#l1.10369"></a><span id="l1.10369">   }</span>
<a href="#l1.10370"></a><span id="l1.10370"> </span>
<a href="#l1.10371"></a><span id="l1.10371">   return NS_OK;</span>
<a href="#l1.10372"></a><span id="l1.10372"> }</span>
<a href="#l1.10373"></a><span id="l1.10373"> </span>
<a href="#l1.10374"></a><span id="l1.10374"> NS_IMETHODIMP</span>
<a href="#l1.10375"></a><span id="l1.10375" class="difflineminus">-nsMsgDBView::SelectMsgByKey(nsMsgKey aKey)</span>
<a href="#l1.10376"></a><span id="l1.10376" class="difflineminus">-{</span>
<a href="#l1.10377"></a><span id="l1.10377" class="difflineplus">+nsMsgDBView::SelectMsgByKey(nsMsgKey aKey) {</span>
<a href="#l1.10378"></a><span id="l1.10378">   NS_ASSERTION(aKey != nsMsgKey_None, &quot;bad key&quot;);</span>
<a href="#l1.10379"></a><span id="l1.10379" class="difflineminus">-  if (aKey == nsMsgKey_None)</span>
<a href="#l1.10380"></a><span id="l1.10380" class="difflineminus">-    return NS_OK;</span>
<a href="#l1.10381"></a><span id="l1.10381" class="difflineplus">+  if (aKey == nsMsgKey_None) return NS_OK;</span>
<a href="#l1.10382"></a><span id="l1.10382"> </span>
<a href="#l1.10383"></a><span id="l1.10383">   // Use SaveAndClearSelection()</span>
<a href="#l1.10384"></a><span id="l1.10384">   // and RestoreSelection() so that we'll clear the current selection</span>
<a href="#l1.10385"></a><span id="l1.10385">   // but pass in a different key array so that we'll</span>
<a href="#l1.10386"></a><span id="l1.10386">   // select (and load) the desired message.</span>
<a href="#l1.10387"></a><span id="l1.10387"> </span>
<a href="#l1.10388"></a><span id="l1.10388">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l1.10389"></a><span id="l1.10389">   nsresult rv = SaveAndClearSelection(nullptr, preservedSelection);</span>
<a href="#l1.10390"></a><span id="l1.10390" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10391"></a><span id="l1.10391" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10392"></a><span id="l1.10392"> </span>
<a href="#l1.10393"></a><span id="l1.10393">   // Now, restore our desired selection.</span>
<a href="#l1.10394"></a><span id="l1.10394">   AutoTArray&lt;nsMsgKey, 1&gt; keyArray;</span>
<a href="#l1.10395"></a><span id="l1.10395">   keyArray.AppendElement(aKey);</span>
<a href="#l1.10396"></a><span id="l1.10396"> </span>
<a href="#l1.10397"></a><span id="l1.10397">   // If the key was not found</span>
<a href="#l1.10398"></a><span id="l1.10398">   // (this can happen with &quot;remember last selected message&quot;)</span>
<a href="#l1.10399"></a><span id="l1.10399">   // nothing will be selected.</span>
<a href="#l1.10400"></a><span id="l1.10400">   rv = RestoreSelection(aKey, keyArray);</span>
<a href="#l1.10401"></a><span id="l1.10401" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10402"></a><span id="l1.10402" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10403"></a><span id="l1.10403">   return NS_OK;</span>
<a href="#l1.10404"></a><span id="l1.10404"> }</span>
<a href="#l1.10405"></a><span id="l1.10405"> </span>
<a href="#l1.10406"></a><span id="l1.10406"> NS_IMETHODIMP</span>
<a href="#l1.10407"></a><span id="l1.10407"> nsMsgDBView::CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l1.10408"></a><span id="l1.10408">                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.10409"></a><span id="l1.10409">                          nsIMsgDBViewCommandUpdater *aCmdUpdater,</span>
<a href="#l1.10410"></a><span id="l1.10410" class="difflineminus">-                         nsIMsgDBView **_retval)</span>
<a href="#l1.10411"></a><span id="l1.10411" class="difflineminus">-{</span>
<a href="#l1.10412"></a><span id="l1.10412" class="difflineminus">-  nsMsgDBView* newMsgDBView = new nsMsgDBView();</span>
<a href="#l1.10413"></a><span id="l1.10413" class="difflineminus">-</span>
<a href="#l1.10414"></a><span id="l1.10414" class="difflineminus">-  nsresult rv = CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.10415"></a><span id="l1.10415" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10416"></a><span id="l1.10416" class="difflineplus">+                         nsIMsgDBView **_retval) {</span>
<a href="#l1.10417"></a><span id="l1.10417" class="difflineplus">+  nsMsgDBView *newMsgDBView = new nsMsgDBView();</span>
<a href="#l1.10418"></a><span id="l1.10418" class="difflineplus">+</span>
<a href="#l1.10419"></a><span id="l1.10419" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.10420"></a><span id="l1.10420" class="difflineplus">+      CopyDBView(newMsgDBView, aMessengerInstance, aMsgWindow, aCmdUpdater);</span>
<a href="#l1.10421"></a><span id="l1.10421" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10422"></a><span id="l1.10422"> </span>
<a href="#l1.10423"></a><span id="l1.10423">   NS_IF_ADDREF(*_retval = newMsgDBView);</span>
<a href="#l1.10424"></a><span id="l1.10424">   return NS_OK;</span>
<a href="#l1.10425"></a><span id="l1.10425"> }</span>
<a href="#l1.10426"></a><span id="l1.10426"> </span>
<a href="#l1.10427"></a><span id="l1.10427" class="difflineminus">-nsresult</span>
<a href="#l1.10428"></a><span id="l1.10428" class="difflineminus">-nsMsgDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l1.10429"></a><span id="l1.10429" class="difflineminus">-                        nsIMessenger *aMessengerInstance,</span>
<a href="#l1.10430"></a><span id="l1.10430" class="difflineminus">-                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.10431"></a><span id="l1.10431" class="difflineminus">-                        nsIMsgDBViewCommandUpdater *aCmdUpdater)</span>
<a href="#l1.10432"></a><span id="l1.10432" class="difflineminus">-{</span>
<a href="#l1.10433"></a><span id="l1.10433" class="difflineplus">+nsresult nsMsgDBView::CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l1.10434"></a><span id="l1.10434" class="difflineplus">+                                 nsIMessenger *aMessengerInstance,</span>
<a href="#l1.10435"></a><span id="l1.10435" class="difflineplus">+                                 nsIMsgWindow *aMsgWindow,</span>
<a href="#l1.10436"></a><span id="l1.10436" class="difflineplus">+                                 nsIMsgDBViewCommandUpdater *aCmdUpdater) {</span>
<a href="#l1.10437"></a><span id="l1.10437">   NS_ENSURE_ARG_POINTER(aNewMsgDBView);</span>
<a href="#l1.10438"></a><span id="l1.10438" class="difflineminus">-  if (aMsgWindow)</span>
<a href="#l1.10439"></a><span id="l1.10439" class="difflineminus">-  {</span>
<a href="#l1.10440"></a><span id="l1.10440" class="difflineplus">+  if (aMsgWindow) {</span>
<a href="#l1.10441"></a><span id="l1.10441">     aNewMsgDBView-&gt;mMsgWindowWeak = do_GetWeakReference(aMsgWindow);</span>
<a href="#l1.10442"></a><span id="l1.10442" class="difflineminus">-    aMsgWindow-&gt;SetOpenFolder(m_viewFolder? m_viewFolder : m_folder);</span>
<a href="#l1.10443"></a><span id="l1.10443" class="difflineplus">+    aMsgWindow-&gt;SetOpenFolder(m_viewFolder ? m_viewFolder : m_folder);</span>
<a href="#l1.10444"></a><span id="l1.10444">   }</span>
<a href="#l1.10445"></a><span id="l1.10445"> </span>
<a href="#l1.10446"></a><span id="l1.10446">   aNewMsgDBView-&gt;mMessengerWeak = do_GetWeakReference(aMessengerInstance);</span>
<a href="#l1.10447"></a><span id="l1.10447">   aNewMsgDBView-&gt;mCommandUpdater = aCmdUpdater;</span>
<a href="#l1.10448"></a><span id="l1.10448">   aNewMsgDBView-&gt;m_folder = m_folder;</span>
<a href="#l1.10449"></a><span id="l1.10449">   aNewMsgDBView-&gt;m_viewFlags = m_viewFlags;</span>
<a href="#l1.10450"></a><span id="l1.10450">   aNewMsgDBView-&gt;m_sortOrder = m_sortOrder;</span>
<a href="#l1.10451"></a><span id="l1.10451">   aNewMsgDBView-&gt;m_sortType = m_sortType;</span>
<a href="#l1.10452"></a><span id="l1.10452">   aNewMsgDBView-&gt;m_curCustomColumn = m_curCustomColumn;</span>
<a href="#l1.10453"></a><span id="l1.10453">   aNewMsgDBView-&gt;m_secondarySort = m_secondarySort;</span>
<a href="#l1.10454"></a><span id="l1.10454">   aNewMsgDBView-&gt;m_secondarySortOrder = m_secondarySortOrder;</span>
<a href="#l1.10455"></a><span id="l1.10455">   aNewMsgDBView-&gt;m_secondaryCustomColumn = m_secondaryCustomColumn;</span>
<a href="#l1.10456"></a><span id="l1.10456">   aNewMsgDBView-&gt;m_db = m_db;</span>
<a href="#l1.10457"></a><span id="l1.10457" class="difflineminus">-  if (m_db)</span>
<a href="#l1.10458"></a><span id="l1.10458" class="difflineminus">-    aNewMsgDBView-&gt;m_db-&gt;AddListener(aNewMsgDBView);</span>
<a href="#l1.10459"></a><span id="l1.10459" class="difflineplus">+  if (m_db) aNewMsgDBView-&gt;m_db-&gt;AddListener(aNewMsgDBView);</span>
<a href="#l1.10460"></a><span id="l1.10460"> </span>
<a href="#l1.10461"></a><span id="l1.10461">   aNewMsgDBView-&gt;mIsNews = mIsNews;</span>
<a href="#l1.10462"></a><span id="l1.10462">   aNewMsgDBView-&gt;mIsRss = mIsRss;</span>
<a href="#l1.10463"></a><span id="l1.10463">   aNewMsgDBView-&gt;mIsXFVirtual = mIsXFVirtual;</span>
<a href="#l1.10464"></a><span id="l1.10464">   aNewMsgDBView-&gt;mShowSizeInLines = mShowSizeInLines;</span>
<a href="#l1.10465"></a><span id="l1.10465">   aNewMsgDBView-&gt;mDeleteModel = mDeleteModel;</span>
<a href="#l1.10466"></a><span id="l1.10466">   aNewMsgDBView-&gt;m_flags = m_flags;</span>
<a href="#l1.10467"></a><span id="l1.10467">   aNewMsgDBView-&gt;m_levels = m_levels;</span>
<a href="#l1.10468"></a><span id="l1.10468" class="difflineat">@@ -8732,228 +7540,193 @@ nsMsgDBView::CopyDBView(nsMsgDBView *aNe</span>
<a href="#l1.10469"></a><span id="l1.10469"> </span>
<a href="#l1.10470"></a><span id="l1.10470">   aNewMsgDBView-&gt;m_customColumnHandlerIDs = m_customColumnHandlerIDs;</span>
<a href="#l1.10471"></a><span id="l1.10471">   aNewMsgDBView-&gt;m_customColumnHandlers.AppendObjects(m_customColumnHandlers);</span>
<a href="#l1.10472"></a><span id="l1.10472"> </span>
<a href="#l1.10473"></a><span id="l1.10473">   return NS_OK;</span>
<a href="#l1.10474"></a><span id="l1.10474"> }</span>
<a href="#l1.10475"></a><span id="l1.10475"> </span>
<a href="#l1.10476"></a><span id="l1.10476"> NS_IMETHODIMP</span>
<a href="#l1.10477"></a><span id="l1.10477" class="difflineminus">-nsMsgDBView::GetSearchSession(nsIMsgSearchSession* *aSession)</span>
<a href="#l1.10478"></a><span id="l1.10478" class="difflineminus">-{</span>
<a href="#l1.10479"></a><span id="l1.10479" class="difflineplus">+nsMsgDBView::GetSearchSession(nsIMsgSearchSession **aSession) {</span>
<a href="#l1.10480"></a><span id="l1.10480">   NS_ASSERTION(false, &quot;should be overridden by child class&quot;);</span>
<a href="#l1.10481"></a><span id="l1.10481">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.10482"></a><span id="l1.10482"> }</span>
<a href="#l1.10483"></a><span id="l1.10483"> </span>
<a href="#l1.10484"></a><span id="l1.10484"> NS_IMETHODIMP</span>
<a href="#l1.10485"></a><span id="l1.10485" class="difflineminus">-nsMsgDBView::SetSearchSession(nsIMsgSearchSession *aSession)</span>
<a href="#l1.10486"></a><span id="l1.10486" class="difflineminus">-{</span>
<a href="#l1.10487"></a><span id="l1.10487" class="difflineplus">+nsMsgDBView::SetSearchSession(nsIMsgSearchSession *aSession) {</span>
<a href="#l1.10488"></a><span id="l1.10488">   NS_ASSERTION(false, &quot;should be overridden by child class&quot;);</span>
<a href="#l1.10489"></a><span id="l1.10489">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l1.10490"></a><span id="l1.10490"> }</span>
<a href="#l1.10491"></a><span id="l1.10491"> </span>
<a href="#l1.10492"></a><span id="l1.10492"> NS_IMETHODIMP</span>
<a href="#l1.10493"></a><span id="l1.10493" class="difflineminus">-nsMsgDBView::GetSupportsThreading(bool *aResult)</span>
<a href="#l1.10494"></a><span id="l1.10494" class="difflineminus">-{</span>
<a href="#l1.10495"></a><span id="l1.10495" class="difflineplus">+nsMsgDBView::GetSupportsThreading(bool *aResult) {</span>
<a href="#l1.10496"></a><span id="l1.10496">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.10497"></a><span id="l1.10497">   *aResult = true;</span>
<a href="#l1.10498"></a><span id="l1.10498">   return NS_OK;</span>
<a href="#l1.10499"></a><span id="l1.10499"> }</span>
<a href="#l1.10500"></a><span id="l1.10500"> </span>
<a href="#l1.10501"></a><span id="l1.10501"> NS_IMETHODIMP</span>
<a href="#l1.10502"></a><span id="l1.10502" class="difflineminus">-nsMsgDBView::FindIndexFromKey(nsMsgKey aMsgKey,</span>
<a href="#l1.10503"></a><span id="l1.10503" class="difflineminus">-                              bool aExpand,</span>
<a href="#l1.10504"></a><span id="l1.10504" class="difflineminus">-                              nsMsgViewIndex *aIndex)</span>
<a href="#l1.10505"></a><span id="l1.10505" class="difflineminus">-{</span>
<a href="#l1.10506"></a><span id="l1.10506" class="difflineplus">+nsMsgDBView::FindIndexFromKey(nsMsgKey aMsgKey, bool aExpand,</span>
<a href="#l1.10507"></a><span id="l1.10507" class="difflineplus">+                              nsMsgViewIndex *aIndex) {</span>
<a href="#l1.10508"></a><span id="l1.10508">   NS_ENSURE_ARG_POINTER(aIndex);</span>
<a href="#l1.10509"></a><span id="l1.10509">   *aIndex = FindKey(aMsgKey, aExpand);</span>
<a href="#l1.10510"></a><span id="l1.10510">   return NS_OK;</span>
<a href="#l1.10511"></a><span id="l1.10511"> }</span>
<a href="#l1.10512"></a><span id="l1.10512"> </span>
<a href="#l1.10513"></a><span id="l1.10513"> NS_IMETHODIMP</span>
<a href="#l1.10514"></a><span id="l1.10514" class="difflineminus">-nsMsgDBView::FindIndexOfMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l1.10515"></a><span id="l1.10515" class="difflineminus">-                               bool aExpand,</span>
<a href="#l1.10516"></a><span id="l1.10516" class="difflineminus">-                               nsMsgViewIndex *aIndex)</span>
<a href="#l1.10517"></a><span id="l1.10517" class="difflineminus">-{</span>
<a href="#l1.10518"></a><span id="l1.10518" class="difflineplus">+nsMsgDBView::FindIndexOfMsgHdr(nsIMsgDBHdr *aMsgHdr, bool aExpand,</span>
<a href="#l1.10519"></a><span id="l1.10519" class="difflineplus">+                               nsMsgViewIndex *aIndex) {</span>
<a href="#l1.10520"></a><span id="l1.10520">   NS_ENSURE_ARG(aMsgHdr);</span>
<a href="#l1.10521"></a><span id="l1.10521">   NS_ENSURE_ARG_POINTER(aIndex);</span>
<a href="#l1.10522"></a><span id="l1.10522"> </span>
<a href="#l1.10523"></a><span id="l1.10523" class="difflineminus">-  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l1.10524"></a><span id="l1.10524" class="difflineminus">-  {</span>
<a href="#l1.10525"></a><span id="l1.10525" class="difflineplus">+  if (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) {</span>
<a href="#l1.10526"></a><span id="l1.10526">     nsMsgViewIndex threadIndex = ThreadIndexOfMsgHdr(aMsgHdr);</span>
<a href="#l1.10527"></a><span id="l1.10527" class="difflineminus">-    if (threadIndex != nsMsgViewIndex_None)</span>
<a href="#l1.10528"></a><span id="l1.10528" class="difflineminus">-    {</span>
<a href="#l1.10529"></a><span id="l1.10529" class="difflineplus">+    if (threadIndex != nsMsgViewIndex_None) {</span>
<a href="#l1.10530"></a><span id="l1.10530">       if (aExpand &amp;&amp; (m_flags[threadIndex] &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l1.10531"></a><span id="l1.10531">         ExpandByIndex(threadIndex, nullptr);</span>
<a href="#l1.10532"></a><span id="l1.10532"> </span>
<a href="#l1.10533"></a><span id="l1.10533">       *aIndex = FindHdr(aMsgHdr, threadIndex);</span>
<a href="#l1.10534"></a><span id="l1.10534" class="difflineminus">-    }</span>
<a href="#l1.10535"></a><span id="l1.10535" class="difflineminus">-    else</span>
<a href="#l1.10536"></a><span id="l1.10536" class="difflineminus">-    {</span>
<a href="#l1.10537"></a><span id="l1.10537" class="difflineplus">+    } else {</span>
<a href="#l1.10538"></a><span id="l1.10538">       *aIndex = nsMsgViewIndex_None;</span>
<a href="#l1.10539"></a><span id="l1.10539">     }</span>
<a href="#l1.10540"></a><span id="l1.10540" class="difflineminus">-  }</span>
<a href="#l1.10541"></a><span id="l1.10541" class="difflineminus">-  else</span>
<a href="#l1.10542"></a><span id="l1.10542" class="difflineminus">-  {</span>
<a href="#l1.10543"></a><span id="l1.10543" class="difflineplus">+  } else {</span>
<a href="#l1.10544"></a><span id="l1.10544">     *aIndex = FindHdr(aMsgHdr);</span>
<a href="#l1.10545"></a><span id="l1.10545">   }</span>
<a href="#l1.10546"></a><span id="l1.10546"> </span>
<a href="#l1.10547"></a><span id="l1.10547">   return NS_OK;</span>
<a href="#l1.10548"></a><span id="l1.10548"> }</span>
<a href="#l1.10549"></a><span id="l1.10549"> </span>
<a href="#l1.10550"></a><span id="l1.10550" class="difflineminus">-static void</span>
<a href="#l1.10551"></a><span id="l1.10551" class="difflineminus">-getDateFormatPref(nsIPrefBranch* _prefBranch,</span>
<a href="#l1.10552"></a><span id="l1.10552" class="difflineminus">-                  const char* _prefLocalName,</span>
<a href="#l1.10553"></a><span id="l1.10553" class="difflineminus">-                  mozilla::nsDateFormatSelector&amp; _format )</span>
<a href="#l1.10554"></a><span id="l1.10554" class="difflineminus">-{</span>
<a href="#l1.10555"></a><span id="l1.10555" class="difflineplus">+static void getDateFormatPref(nsIPrefBranch *_prefBranch,</span>
<a href="#l1.10556"></a><span id="l1.10556" class="difflineplus">+                              const char *_prefLocalName,</span>
<a href="#l1.10557"></a><span id="l1.10557" class="difflineplus">+                              mozilla::nsDateFormatSelector &amp;_format) {</span>
<a href="#l1.10558"></a><span id="l1.10558">   // Read.</span>
<a href="#l1.10559"></a><span id="l1.10559" class="difflineminus">-  int32_t nFormatSetting( 0 );</span>
<a href="#l1.10560"></a><span id="l1.10560" class="difflineminus">-  nsresult result = _prefBranch-&gt;GetIntPref( _prefLocalName, &amp;nFormatSetting );</span>
<a href="#l1.10561"></a><span id="l1.10561" class="difflineminus">-  if ( NS_SUCCEEDED( result ) )</span>
<a href="#l1.10562"></a><span id="l1.10562" class="difflineminus">-  {</span>
<a href="#l1.10563"></a><span id="l1.10563" class="difflineplus">+  int32_t nFormatSetting(0);</span>
<a href="#l1.10564"></a><span id="l1.10564" class="difflineplus">+  nsresult result = _prefBranch-&gt;GetIntPref(_prefLocalName, &amp;nFormatSetting);</span>
<a href="#l1.10565"></a><span id="l1.10565" class="difflineplus">+  if (NS_SUCCEEDED(result)) {</span>
<a href="#l1.10566"></a><span id="l1.10566">     // Translate.</span>
<a href="#l1.10567"></a><span id="l1.10567">     mozilla::nsDateFormatSelector res;</span>
<a href="#l1.10568"></a><span id="l1.10568">     res = static_cast&lt;mozilla::nsDateFormatSelector&gt;(nFormatSetting);</span>
<a href="#l1.10569"></a><span id="l1.10569">     // Transfer if valid.</span>
<a href="#l1.10570"></a><span id="l1.10570">     if (res &gt;= mozilla::kDateFormatNone &amp;&amp; res &lt;= mozilla::kDateFormatWeekday)</span>
<a href="#l1.10571"></a><span id="l1.10571">       _format = res;</span>
<a href="#l1.10572"></a><span id="l1.10572">   }</span>
<a href="#l1.10573"></a><span id="l1.10573"> }</span>
<a href="#l1.10574"></a><span id="l1.10574"> </span>
<a href="#l1.10575"></a><span id="l1.10575" class="difflineminus">-nsresult nsMsgDBView::InitDisplayFormats()</span>
<a href="#l1.10576"></a><span id="l1.10576" class="difflineminus">-{</span>
<a href="#l1.10577"></a><span id="l1.10577" class="difflineminus">-  m_dateFormatDefault   = mozilla::kDateFormatShort;</span>
<a href="#l1.10578"></a><span id="l1.10578" class="difflineminus">-  m_dateFormatThisWeek  = mozilla::kDateFormatShort;</span>
<a href="#l1.10579"></a><span id="l1.10579" class="difflineminus">-  m_dateFormatToday     = mozilla::kDateFormatNone;</span>
<a href="#l1.10580"></a><span id="l1.10580" class="difflineplus">+nsresult nsMsgDBView::InitDisplayFormats() {</span>
<a href="#l1.10581"></a><span id="l1.10581" class="difflineplus">+  m_dateFormatDefault = mozilla::kDateFormatShort;</span>
<a href="#l1.10582"></a><span id="l1.10582" class="difflineplus">+  m_dateFormatThisWeek = mozilla::kDateFormatShort;</span>
<a href="#l1.10583"></a><span id="l1.10583" class="difflineplus">+  m_dateFormatToday = mozilla::kDateFormatNone;</span>
<a href="#l1.10584"></a><span id="l1.10584"> </span>
<a href="#l1.10585"></a><span id="l1.10585">   nsresult rv = NS_OK;</span>
<a href="#l1.10586"></a><span id="l1.10586" class="difflineminus">-  nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.10587"></a><span id="l1.10587" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10588"></a><span id="l1.10588" class="difflineplus">+  nsCOMPtr&lt;nsIPrefService&gt; prefs =</span>
<a href="#l1.10589"></a><span id="l1.10589" class="difflineplus">+      do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l1.10590"></a><span id="l1.10590" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10591"></a><span id="l1.10591">   nsCOMPtr&lt;nsIPrefBranch&gt; dateFormatPrefs;</span>
<a href="#l1.10592"></a><span id="l1.10592" class="difflineminus">-  rv = prefs-&gt;GetBranch(&quot;mail.ui.display.dateformat.&quot;, getter_AddRefs(dateFormatPrefs));</span>
<a href="#l1.10593"></a><span id="l1.10593" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l1.10594"></a><span id="l1.10594" class="difflineminus">-</span>
<a href="#l1.10595"></a><span id="l1.10595" class="difflineminus">-  getDateFormatPref( dateFormatPrefs, &quot;default&quot;, m_dateFormatDefault );</span>
<a href="#l1.10596"></a><span id="l1.10596" class="difflineminus">-  getDateFormatPref( dateFormatPrefs, &quot;thisweek&quot;, m_dateFormatThisWeek );</span>
<a href="#l1.10597"></a><span id="l1.10597" class="difflineminus">-  getDateFormatPref( dateFormatPrefs, &quot;today&quot;, m_dateFormatToday );</span>
<a href="#l1.10598"></a><span id="l1.10598" class="difflineplus">+  rv = prefs-&gt;GetBranch(&quot;mail.ui.display.dateformat.&quot;,</span>
<a href="#l1.10599"></a><span id="l1.10599" class="difflineplus">+                        getter_AddRefs(dateFormatPrefs));</span>
<a href="#l1.10600"></a><span id="l1.10600" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10601"></a><span id="l1.10601" class="difflineplus">+</span>
<a href="#l1.10602"></a><span id="l1.10602" class="difflineplus">+  getDateFormatPref(dateFormatPrefs, &quot;default&quot;, m_dateFormatDefault);</span>
<a href="#l1.10603"></a><span id="l1.10603" class="difflineplus">+  getDateFormatPref(dateFormatPrefs, &quot;thisweek&quot;, m_dateFormatThisWeek);</span>
<a href="#l1.10604"></a><span id="l1.10604" class="difflineplus">+  getDateFormatPref(dateFormatPrefs, &quot;today&quot;, m_dateFormatToday);</span>
<a href="#l1.10605"></a><span id="l1.10605">   return rv;</span>
<a href="#l1.10606"></a><span id="l1.10606"> }</span>
<a href="#l1.10607"></a><span id="l1.10607"> </span>
<a href="#l1.10608"></a><span id="l1.10608" class="difflineminus">-void</span>
<a href="#l1.10609"></a><span id="l1.10609" class="difflineminus">-nsMsgDBView::SetMRUTimeForFolder(nsIMsgFolder *folder)</span>
<a href="#l1.10610"></a><span id="l1.10610" class="difflineminus">-{</span>
<a href="#l1.10611"></a><span id="l1.10611" class="difflineplus">+void nsMsgDBView::SetMRUTimeForFolder(nsIMsgFolder *folder) {</span>
<a href="#l1.10612"></a><span id="l1.10612">   uint32_t seconds;</span>
<a href="#l1.10613"></a><span id="l1.10613">   PRTime2Seconds(PR_Now(), &amp;seconds);</span>
<a href="#l1.10614"></a><span id="l1.10614">   nsAutoCString nowStr;</span>
<a href="#l1.10615"></a><span id="l1.10615">   nowStr.AppendInt(seconds);</span>
<a href="#l1.10616"></a><span id="l1.10616">   folder-&gt;SetStringProperty(MRU_TIME_PROPERTY, nowStr);</span>
<a href="#l1.10617"></a><span id="l1.10617"> }</span>
<a href="#l1.10618"></a><span id="l1.10618"> </span>
<a href="#l1.10619"></a><span id="l1.10619" class="difflineminus">-nsMsgDBView::nsMsgViewHdrEnumerator::nsMsgViewHdrEnumerator(nsMsgDBView *view)</span>
<a href="#l1.10620"></a><span id="l1.10620" class="difflineminus">-{</span>
<a href="#l1.10621"></a><span id="l1.10621" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::nsMsgViewHdrEnumerator(nsMsgDBView *view) {</span>
<a href="#l1.10622"></a><span id="l1.10622">   // We need to clone the view because the caller may clear the</span>
<a href="#l1.10623"></a><span id="l1.10623">   // current view immediately. It also makes it easier to expand all</span>
<a href="#l1.10624"></a><span id="l1.10624">   // if we're working on a copy.</span>
<a href="#l1.10625"></a><span id="l1.10625">   nsCOMPtr&lt;nsIMsgDBView&gt; clonedView;</span>
<a href="#l1.10626"></a><span id="l1.10626">   view-&gt;CloneDBView(nullptr, nullptr, nullptr, getter_AddRefs(clonedView));</span>
<a href="#l1.10627"></a><span id="l1.10627" class="difflineminus">-  m_view = static_cast&lt;nsMsgDBView*&gt;(clonedView.get());</span>
<a href="#l1.10628"></a><span id="l1.10628" class="difflineplus">+  m_view = static_cast&lt;nsMsgDBView *&gt;(clonedView.get());</span>
<a href="#l1.10629"></a><span id="l1.10629">   // Make sure we enumerate over collapsed threads by expanding all.</span>
<a href="#l1.10630"></a><span id="l1.10630">   m_view-&gt;ExpandAll();</span>
<a href="#l1.10631"></a><span id="l1.10631">   m_curHdrIndex = 0;</span>
<a href="#l1.10632"></a><span id="l1.10632"> }</span>
<a href="#l1.10633"></a><span id="l1.10633"> </span>
<a href="#l1.10634"></a><span id="l1.10634" class="difflineminus">-nsMsgDBView::nsMsgViewHdrEnumerator::~nsMsgViewHdrEnumerator()</span>
<a href="#l1.10635"></a><span id="l1.10635" class="difflineminus">-{</span>
<a href="#l1.10636"></a><span id="l1.10636" class="difflineminus">-  if (m_view)</span>
<a href="#l1.10637"></a><span id="l1.10637" class="difflineminus">-    m_view-&gt;Close();</span>
<a href="#l1.10638"></a><span id="l1.10638" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::~nsMsgViewHdrEnumerator() {</span>
<a href="#l1.10639"></a><span id="l1.10639" class="difflineplus">+  if (m_view) m_view-&gt;Close();</span>
<a href="#l1.10640"></a><span id="l1.10640"> }</span>
<a href="#l1.10641"></a><span id="l1.10641"> </span>
<a href="#l1.10642"></a><span id="l1.10642"> NS_IMETHODIMP</span>
<a href="#l1.10643"></a><span id="l1.10643" class="difflineminus">-nsMsgDBView::nsMsgViewHdrEnumerator::GetNext(nsISupports **aItem)</span>
<a href="#l1.10644"></a><span id="l1.10644" class="difflineminus">-{</span>
<a href="#l1.10645"></a><span id="l1.10645" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::GetNext(nsISupports **aItem) {</span>
<a href="#l1.10646"></a><span id="l1.10646">   NS_ENSURE_ARG_POINTER(aItem);</span>
<a href="#l1.10647"></a><span id="l1.10647"> </span>
<a href="#l1.10648"></a><span id="l1.10648" class="difflineminus">-  if (m_curHdrIndex &gt;= m_view-&gt;GetSize())</span>
<a href="#l1.10649"></a><span id="l1.10649" class="difflineminus">-    return NS_ERROR_FAILURE;</span>
<a href="#l1.10650"></a><span id="l1.10650" class="difflineplus">+  if (m_curHdrIndex &gt;= m_view-&gt;GetSize()) return NS_ERROR_FAILURE;</span>
<a href="#l1.10651"></a><span id="l1.10651"> </span>
<a href="#l1.10652"></a><span id="l1.10652">   // Ignore dummy header. We won't have empty groups, so</span>
<a href="#l1.10653"></a><span id="l1.10653">   // we know the view index is good.</span>
<a href="#l1.10654"></a><span id="l1.10654" class="difflineminus">-  if (m_view-&gt;m_flags[m_curHdrIndex] &amp; MSG_VIEW_FLAG_DUMMY)</span>
<a href="#l1.10655"></a><span id="l1.10655" class="difflineminus">-    ++m_curHdrIndex;</span>
<a href="#l1.10656"></a><span id="l1.10656" class="difflineplus">+  if (m_view-&gt;m_flags[m_curHdrIndex] &amp; MSG_VIEW_FLAG_DUMMY) ++m_curHdrIndex;</span>
<a href="#l1.10657"></a><span id="l1.10657"> </span>
<a href="#l1.10658"></a><span id="l1.10658">   nsCOMPtr&lt;nsIMsgDBHdr&gt; nextHdr;</span>
<a href="#l1.10659"></a><span id="l1.10659"> </span>
<a href="#l1.10660"></a><span id="l1.10660" class="difflineminus">-  nsresult rv = m_view-&gt;GetMsgHdrForViewIndex(m_curHdrIndex++, getter_AddRefs(nextHdr));</span>
<a href="#l1.10661"></a><span id="l1.10661" class="difflineplus">+  nsresult rv =</span>
<a href="#l1.10662"></a><span id="l1.10662" class="difflineplus">+      m_view-&gt;GetMsgHdrForViewIndex(m_curHdrIndex++, getter_AddRefs(nextHdr));</span>
<a href="#l1.10663"></a><span id="l1.10663">   nextHdr.forget(aItem);</span>
<a href="#l1.10664"></a><span id="l1.10664">   return rv;</span>
<a href="#l1.10665"></a><span id="l1.10665"> }</span>
<a href="#l1.10666"></a><span id="l1.10666"> </span>
<a href="#l1.10667"></a><span id="l1.10667"> NS_IMETHODIMP</span>
<a href="#l1.10668"></a><span id="l1.10668" class="difflineminus">-nsMsgDBView::nsMsgViewHdrEnumerator::HasMoreElements(bool *aResult)</span>
<a href="#l1.10669"></a><span id="l1.10669" class="difflineminus">-{</span>
<a href="#l1.10670"></a><span id="l1.10670" class="difflineplus">+nsMsgDBView::nsMsgViewHdrEnumerator::HasMoreElements(bool *aResult) {</span>
<a href="#l1.10671"></a><span id="l1.10671">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l1.10672"></a><span id="l1.10672">   *aResult = m_curHdrIndex &lt; m_view-&gt;GetSize();</span>
<a href="#l1.10673"></a><span id="l1.10673">   return NS_OK;</span>
<a href="#l1.10674"></a><span id="l1.10674"> }</span>
<a href="#l1.10675"></a><span id="l1.10675"> </span>
<a href="#l1.10676"></a><span id="l1.10676" class="difflineminus">-nsresult</span>
<a href="#l1.10677"></a><span id="l1.10677" class="difflineminus">-nsMsgDBView::GetViewEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l1.10678"></a><span id="l1.10678" class="difflineminus">-{</span>
<a href="#l1.10679"></a><span id="l1.10679" class="difflineplus">+nsresult nsMsgDBView::GetViewEnumerator(nsISimpleEnumerator **enumerator) {</span>
<a href="#l1.10680"></a><span id="l1.10680">   NS_IF_ADDREF(*enumerator = new nsMsgViewHdrEnumerator(this));</span>
<a href="#l1.10681"></a><span id="l1.10681">   return (*enumerator) ? NS_OK : NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l1.10682"></a><span id="l1.10682"> }</span>
<a href="#l1.10683"></a><span id="l1.10683"> </span>
<a href="#l1.10684"></a><span id="l1.10684" class="difflineminus">-nsresult</span>
<a href="#l1.10685"></a><span id="l1.10685" class="difflineminus">-nsMsgDBView::GetDBForHeader(nsIMsgDBHdr *msgHdr,</span>
<a href="#l1.10686"></a><span id="l1.10686" class="difflineminus">-                            nsIMsgDatabase **db)</span>
<a href="#l1.10687"></a><span id="l1.10687" class="difflineminus">-{</span>
<a href="#l1.10688"></a><span id="l1.10688" class="difflineplus">+nsresult nsMsgDBView::GetDBForHeader(nsIMsgDBHdr *msgHdr, nsIMsgDatabase **db) {</span>
<a href="#l1.10689"></a><span id="l1.10689">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l1.10690"></a><span id="l1.10690">   nsresult rv = msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l1.10691"></a><span id="l1.10691">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l1.10692"></a><span id="l1.10692">   return folder-&gt;GetMsgDatabase(db);</span>
<a href="#l1.10693"></a><span id="l1.10693"> }</span>
<a href="#l1.10694"></a><span id="l1.10694"> </span>
<a href="#l1.10695"></a><span id="l1.10695"> /**</span>
<a href="#l1.10696"></a><span id="l1.10696">  * Determine whether junk commands should be enabled on this view.</span>
<a href="#l1.10697"></a><span id="l1.10697">  * Junk commands are always enabled for mail. For nntp and rss, they</span>
<a href="#l1.10698"></a><span id="l1.10698">  * may be selectively enabled using an inherited folder property.</span>
<a href="#l1.10699"></a><span id="l1.10699">  *</span>
<a href="#l1.10700"></a><span id="l1.10700">  * @param  aViewIndex  view index of the message to check</span>
<a href="#l1.10701"></a><span id="l1.10701">  * @return             true if junk controls should be enabled</span>
<a href="#l1.10702"></a><span id="l1.10702">  */</span>
<a href="#l1.10703"></a><span id="l1.10703" class="difflineminus">-bool</span>
<a href="#l1.10704"></a><span id="l1.10704" class="difflineminus">-nsMsgDBView::JunkControlsEnabled(nsMsgViewIndex aViewIndex)</span>
<a href="#l1.10705"></a><span id="l1.10705" class="difflineminus">-{</span>
<a href="#l1.10706"></a><span id="l1.10706" class="difflineplus">+bool nsMsgDBView::JunkControlsEnabled(nsMsgViewIndex aViewIndex) {</span>
<a href="#l1.10707"></a><span id="l1.10707">   // For normal mail, junk commands are always enabled.</span>
<a href="#l1.10708"></a><span id="l1.10708" class="difflineminus">-  if (!(mIsNews || mIsRss || mIsXFVirtual))</span>
<a href="#l1.10709"></a><span id="l1.10709" class="difflineminus">-    return true;</span>
<a href="#l1.10710"></a><span id="l1.10710" class="difflineplus">+  if (!(mIsNews || mIsRss || mIsXFVirtual)) return true;</span>
<a href="#l1.10711"></a><span id="l1.10711"> </span>
<a href="#l1.10712"></a><span id="l1.10712">   // We need to check per message or folder.</span>
<a href="#l1.10713"></a><span id="l1.10713" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.10714"></a><span id="l1.10714" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = m_folder;</span>
<a href="#l1.10715"></a><span id="l1.10715">   if (!folder &amp;&amp; IsValidIndex(aViewIndex))</span>
<a href="#l1.10716"></a><span id="l1.10716">     GetFolderForViewIndex(aViewIndex, getter_AddRefs(folder));</span>
<a href="#l1.10717"></a><span id="l1.10717"> </span>
<a href="#l1.10718"></a><span id="l1.10718" class="difflineminus">-  if (folder)</span>
<a href="#l1.10719"></a><span id="l1.10719" class="difflineminus">-  {</span>
<a href="#l1.10720"></a><span id="l1.10720" class="difflineplus">+  if (folder) {</span>
<a href="#l1.10721"></a><span id="l1.10721">     // Check if this is a mail message in search folders.</span>
<a href="#l1.10722"></a><span id="l1.10722" class="difflineminus">-    if (mIsXFVirtual)</span>
<a href="#l1.10723"></a><span id="l1.10723" class="difflineminus">-    {</span>
<a href="#l1.10724"></a><span id="l1.10724" class="difflineminus">-      nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10725"></a><span id="l1.10725" class="difflineplus">+    if (mIsXFVirtual) {</span>
<a href="#l1.10726"></a><span id="l1.10726" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l1.10727"></a><span id="l1.10727">       folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l1.10728"></a><span id="l1.10728">       nsAutoCString type;</span>
<a href="#l1.10729"></a><span id="l1.10729" class="difflineminus">-      if (server)</span>
<a href="#l1.10730"></a><span id="l1.10730" class="difflineminus">-        server-&gt;GetType(type);</span>
<a href="#l1.10731"></a><span id="l1.10731" class="difflineplus">+      if (server) server-&gt;GetType(type);</span>
<a href="#l1.10732"></a><span id="l1.10732"> </span>
<a href="#l1.10733"></a><span id="l1.10733">       if (!(MsgLowerCaseEqualsLiteral(type, &quot;nntp&quot;) ||</span>
<a href="#l1.10734"></a><span id="l1.10734">             MsgLowerCaseEqualsLiteral(type, &quot;rss&quot;)))</span>
<a href="#l1.10735"></a><span id="l1.10735">         return true;</span>
<a href="#l1.10736"></a><span id="l1.10736">     }</span>
<a href="#l1.10737"></a><span id="l1.10737"> </span>
<a href="#l1.10738"></a><span id="l1.10738">     // For rss and news, check the inherited folder property.</span>
<a href="#l1.10739"></a><span id="l1.10739">     nsAutoCString junkEnableOverride;</span>
<a href="#l1.10740"></a><span id="l1.10740">     folder-&gt;GetInheritedStringProperty(&quot;dobayes.mailnews@mozilla.org#junk&quot;,</span>
<a href="#l1.10741"></a><span id="l1.10741">                                        junkEnableOverride);</span>
<a href="#l1.10742"></a><span id="l1.10742" class="difflineminus">-    if (junkEnableOverride.EqualsLiteral(&quot;true&quot;))</span>
<a href="#l1.10743"></a><span id="l1.10743" class="difflineminus">-      return true;</span>
<a href="#l1.10744"></a><span id="l1.10744" class="difflineplus">+    if (junkEnableOverride.EqualsLiteral(&quot;true&quot;)) return true;</span>
<a href="#l1.10745"></a><span id="l1.10745">   }</span>
<a href="#l1.10746"></a><span id="l1.10746"> </span>
<a href="#l1.10747"></a><span id="l1.10747">   return false;</span>
<a href="#l1.10748"></a><span id="l1.10748"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -26,146 +26,140 @@</span>
<a href="#l2.4"></a><span id="l2.4"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l2.5"></a><span id="l2.5"> #include &quot;nsTArray.h&quot;</span>
<a href="#l2.6"></a><span id="l2.6"> #include &quot;nsTHashtable.h&quot;</span>
<a href="#l2.7"></a><span id="l2.7"> #include &quot;nsHashKeys.h&quot;</span>
<a href="#l2.8"></a><span id="l2.8"> #include &quot;nsIMsgCustomColumnHandler.h&quot;</span>
<a href="#l2.9"></a><span id="l2.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l2.10"></a><span id="l2.10"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsSimpleEnumerator.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#define MESSENGER_STRING_URL &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> typedef AutoTArray&lt;nsMsgViewIndex, 1&gt; nsMsgViewIndexArray;</span>
<a href="#l2.16"></a><span id="l2.16"> static_assert(nsMsgViewIndex(nsMsgViewIndexArray::NoIndex) ==</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-  nsMsgViewIndex_None, &quot;These need to be the same value.&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+                  nsMsgViewIndex_None,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+              &quot;These need to be the same value.&quot;);</span>
<a href="#l2.20"></a><span id="l2.20"> </span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-enum eFieldType {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-    kCollationKey,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-    kU32</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-};</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+enum eFieldType { kCollationKey, kU32 };</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27"> // This is used in an nsTArray&lt;&gt; to keep track of a multi-column sort.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-class MsgViewSortColumnInfo</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-{</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-public:</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+class MsgViewSortColumnInfo {</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+ public:</span>
<a href="#l2.33"></a><span id="l2.33">   MsgViewSortColumnInfo(const MsgViewSortColumnInfo &amp;other);</span>
<a href="#l2.34"></a><span id="l2.34">   MsgViewSortColumnInfo() {}</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  bool operator == (const MsgViewSortColumnInfo &amp;other) const;</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+  bool operator==(const MsgViewSortColumnInfo &amp;other) const;</span>
<a href="#l2.37"></a><span id="l2.37">   nsMsgViewSortTypeValue mSortType;</span>
<a href="#l2.38"></a><span id="l2.38">   nsMsgViewSortOrderValue mSortOrder;</span>
<a href="#l2.39"></a><span id="l2.39">   // If mSortType == byCustom, info about the custom column sort.</span>
<a href="#l2.40"></a><span id="l2.40">   nsString mCustomColumnName;</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-  nsCOMPtr &lt;nsIMsgCustomColumnHandler&gt; mColHandler;</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-} ;</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+  nsCOMPtr&lt;nsIMsgCustomColumnHandler&gt; mColHandler;</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+};</span>
<a href="#l2.45"></a><span id="l2.45"> </span>
<a href="#l2.46"></a><span id="l2.46"> // Reserve the top 8 bits in the msg flags for the view-only flags.</span>
<a href="#l2.47"></a><span id="l2.47"> #define MSG_VIEW_FLAGS 0xEE000000</span>
<a href="#l2.48"></a><span id="l2.48"> #define MSG_VIEW_FLAG_HASCHILDREN 0x40000000</span>
<a href="#l2.49"></a><span id="l2.49"> #define MSG_VIEW_FLAG_DUMMY 0x20000000</span>
<a href="#l2.50"></a><span id="l2.50"> #define MSG_VIEW_FLAG_ISTHREAD 0x8000000</span>
<a href="#l2.51"></a><span id="l2.51"> #define MSG_VIEW_FLAG_OUTGOING 0x2000000</span>
<a href="#l2.52"></a><span id="l2.52"> #define MSG_VIEW_FLAG_INCOMING 0x1000000</span>
<a href="#l2.53"></a><span id="l2.53"> </span>
<a href="#l2.54"></a><span id="l2.54"> // There currently only 5 labels defined.</span>
<a href="#l2.55"></a><span id="l2.55"> #define PREF_LABELS_MAX 5</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-#define PREF_LABELS_DESCRIPTION  &quot;mailnews.labels.description.&quot;</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-#define PREF_LABELS_COLOR  &quot;mailnews.labels.color.&quot;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+#define PREF_LABELS_DESCRIPTION &quot;mailnews.labels.description.&quot;</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+#define PREF_LABELS_COLOR &quot;mailnews.labels.color.&quot;</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-struct IdUint32</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-{</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-  nsMsgKey    id;</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-  uint32_t    bits;</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  uint32_t    dword;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-  nsIMsgFolder* folder;</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+struct IdUint32 {</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  nsMsgKey id;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  uint32_t bits;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  uint32_t dword;</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  nsIMsgFolder *folder;</span>
<a href="#l2.72"></a><span id="l2.72"> };</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-struct IdKey : public IdUint32</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-{</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+struct IdKey : public IdUint32 {</span>
<a href="#l2.77"></a><span id="l2.77">   // Actually a variable length array, whose actual size is determined</span>
<a href="#l2.78"></a><span id="l2.78">   // when the struct is allocated.</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-  uint8_t     key[1];</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  uint8_t key[1];</span>
<a href="#l2.81"></a><span id="l2.81"> };</span>
<a href="#l2.82"></a><span id="l2.82"> </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-struct IdKeyPtr : public IdUint32</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-{</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-  uint8_t     *key;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+struct IdKeyPtr : public IdUint32 {</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+  uint8_t *key;</span>
<a href="#l2.88"></a><span id="l2.88"> };</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90"> // This is an abstract implementation class.</span>
<a href="#l2.91"></a><span id="l2.91"> // The actual view objects will be instances of sub-classes of this class.</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineminus">-class nsMsgDBView : public nsIMsgDBView, public nsIDBChangeListener,</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+class nsMsgDBView : public nsIMsgDBView,</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+                    public nsIDBChangeListener,</span>
<a href="#l2.95"></a><span id="l2.95">                     public nsITreeView,</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-                    public nsIJunkMailClassificationListener</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-{</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-public:</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+                    public nsIJunkMailClassificationListener {</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+ public:</span>
<a href="#l2.101"></a><span id="l2.101">   nsMsgDBView();</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103">   NS_DECL_ISUPPORTS</span>
<a href="#l2.104"></a><span id="l2.104">   NS_DECL_NSIMSGDBVIEW</span>
<a href="#l2.105"></a><span id="l2.105">   NS_DECL_NSIDBCHANGELISTENER</span>
<a href="#l2.106"></a><span id="l2.106">   NS_DECL_NSITREEVIEW</span>
<a href="#l2.107"></a><span id="l2.107">   NS_DECL_NSIJUNKMAILCLASSIFICATIONLISTENER</span>
<a href="#l2.108"></a><span id="l2.108"> </span>
<a href="#l2.109"></a><span id="l2.109">   nsMsgViewIndex GetInsertIndexHelper(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.110"></a><span id="l2.110">                                       nsTArray&lt;nsMsgKey&gt; &amp;keys,</span>
<a href="#l2.111"></a><span id="l2.111">                                       nsCOMArray&lt;nsIMsgFolder&gt; *folders,</span>
<a href="#l2.112"></a><span id="l2.112">                                       nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l2.113"></a><span id="l2.113">                                       nsMsgViewSortTypeValue sortType);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  int32_t  SecondarySort(nsMsgKey key1,</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineminus">-                         nsISupports *folder1,</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineminus">-                         nsMsgKey key2,</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-                         nsISupports *folder2,</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-                         class viewSortInfo *comparisonContext);</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+  int32_t SecondarySort(nsMsgKey key1, nsISupports *folder1, nsMsgKey key2,</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+                        nsISupports *folder2,</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+                        class viewSortInfo *comparisonContext);</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-protected:</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+ protected:</span>
<a href="#l2.125"></a><span id="l2.125">   virtual ~nsMsgDBView();</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127">   static nsrefcnt gInstanceCount;</span>
<a href="#l2.128"></a><span id="l2.128"> </span>
<a href="#l2.129"></a><span id="l2.129" class="difflineminus">-  static char16_t* kHighestPriorityString;</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-  static char16_t* kHighPriorityString;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-  static char16_t* kLowestPriorityString;</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-  static char16_t* kLowPriorityString;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-  static char16_t* kNormalPriorityString;</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+  static char16_t *kHighestPriorityString;</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+  static char16_t *kHighPriorityString;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+  static char16_t *kLowestPriorityString;</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+  static char16_t *kLowPriorityString;</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+  static char16_t *kNormalPriorityString;</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  static char16_t* kReadString;</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-  static char16_t* kRepliedString;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  static char16_t* kForwardedString;</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineminus">-  static char16_t* kNewString;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  static char16_t *kReadString;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  static char16_t *kRepliedString;</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+  static char16_t *kForwardedString;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+  static char16_t *kNewString;</span>
<a href="#l2.148"></a><span id="l2.148"> </span>
<a href="#l2.149"></a><span id="l2.149">   RefPtr&lt;mozilla::dom::XULTreeElement&gt; mTree;</span>
<a href="#l2.150"></a><span id="l2.150">   nsCOMPtr&lt;nsITreeSelection&gt; mTreeSelection;</span>
<a href="#l2.151"></a><span id="l2.151">   // We cache this to determine when to push command status notifications.</span>
<a href="#l2.152"></a><span id="l2.152">   uint32_t mNumSelectedRows;</span>
<a href="#l2.153"></a><span id="l2.153">   // Set when the message pane is collapsed.</span>
<a href="#l2.154"></a><span id="l2.154">   bool mSuppressMsgDisplay;</span>
<a href="#l2.155"></a><span id="l2.155">   bool mSuppressCommandUpdating;</span>
<a href="#l2.156"></a><span id="l2.156">   // Set when we're telling the outline a row is being removed. Used to</span>
<a href="#l2.157"></a><span id="l2.157">   // suppress msg loading during delete/move operations.</span>
<a href="#l2.158"></a><span id="l2.158">   bool mRemovingRow;</span>
<a href="#l2.159"></a><span id="l2.159">   bool mCommandsNeedDisablingBecauseOfSelection;</span>
<a href="#l2.160"></a><span id="l2.160">   bool mSuppressChangeNotification;</span>
<a href="#l2.161"></a><span id="l2.161">   bool mGoForwardEnabled;</span>
<a href="#l2.162"></a><span id="l2.162">   bool mGoBackEnabled;</span>
<a href="#l2.163"></a><span id="l2.163"> </span>
<a href="#l2.164"></a><span id="l2.164" class="difflineminus">-  virtual const char * GetViewName(void) {return &quot;MsgDBView&quot;; }</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineminus">-  nsresult FetchAuthor(nsIMsgDBHdr * aHdr, nsAString &amp;aAuthorString);</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineminus">-  nsresult FetchRecipients(nsIMsgDBHdr * aHdr, nsAString &amp;aRecipientsString);</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineminus">-  nsresult FetchSubject(nsIMsgDBHdr * aMsgHdr, uint32_t aFlags, nsAString &amp;aValue);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineminus">-  nsresult FetchDate(nsIMsgDBHdr * aHdr, nsAString &amp; aDateString, bool rcvDate = false);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+  virtual const char *GetViewName(void) { return &quot;MsgDBView&quot;; }</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  nsresult FetchAuthor(nsIMsgDBHdr *aHdr, nsAString &amp;aAuthorString);</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+  nsresult FetchRecipients(nsIMsgDBHdr *aHdr, nsAString &amp;aRecipientsString);</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  nsresult FetchSubject(nsIMsgDBHdr *aMsgHdr, uint32_t aFlags,</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+                        nsAString &amp;aValue);</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  nsresult FetchDate(nsIMsgDBHdr *aHdr, nsAString &amp;aDateString,</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+                     bool rcvDate = false);</span>
<a href="#l2.176"></a><span id="l2.176">   nsresult FetchStatus(uint32_t aFlags, nsAString &amp;aStatusString);</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-  nsresult FetchSize(nsIMsgDBHdr * aHdr, nsAString &amp; aSizeString);</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-  nsresult FetchPriority(nsIMsgDBHdr *aHdr, nsAString &amp; aPriorityString);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-  nsresult FetchLabel(nsIMsgDBHdr *aHdr, nsAString &amp; aLabelString);</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineminus">-  nsresult FetchTags(nsIMsgDBHdr *aHdr, nsAString &amp; aTagString);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineminus">-  nsresult FetchKeywords(nsIMsgDBHdr *aHdr, nsACString &amp; keywordString);</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+  nsresult FetchSize(nsIMsgDBHdr *aHdr, nsAString &amp;aSizeString);</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+  nsresult FetchPriority(nsIMsgDBHdr *aHdr, nsAString &amp;aPriorityString);</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+  nsresult FetchLabel(nsIMsgDBHdr *aHdr, nsAString &amp;aLabelString);</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+  nsresult FetchTags(nsIMsgDBHdr *aHdr, nsAString &amp;aTagString);</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+  nsresult FetchKeywords(nsIMsgDBHdr *aHdr, nsACString &amp;keywordString);</span>
<a href="#l2.187"></a><span id="l2.187">   nsresult FetchRowKeywords(nsMsgViewIndex aRow, nsIMsgDBHdr *aHdr,</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineminus">-                            nsACString &amp; keywordString);</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineminus">-  nsresult FetchAccount(nsIMsgDBHdr * aHdr, nsAString&amp; aAccount);</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineminus">-  bool IsOutgoingMsg(nsIMsgDBHdr * aHdr);</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+                            nsACString &amp;keywordString);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+  nsresult FetchAccount(nsIMsgDBHdr *aHdr, nsAString &amp;aAccount);</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+  bool IsOutgoingMsg(nsIMsgDBHdr *aHdr);</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">   // The default enumerator is over the db, but things like</span>
<a href="#l2.196"></a><span id="l2.196">   // quick search views will enumerate just the displayed messages.</span>
<a href="#l2.197"></a><span id="l2.197">   virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator);</span>
<a href="#l2.198"></a><span id="l2.198">   // this is a message enumerator that enumerates based on the view contents</span>
<a href="#l2.199"></a><span id="l2.199">   virtual nsresult GetViewEnumerator(nsISimpleEnumerator **enumerator);</span>
<a href="#l2.200"></a><span id="l2.200"> </span>
<a href="#l2.201"></a><span id="l2.201">   // Save and Restore Selection are a pair of routines you should</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineat">@@ -180,32 +174,39 @@ protected:</span>
<a href="#l2.203"></a><span id="l2.203">                                  nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray);</span>
<a href="#l2.204"></a><span id="l2.204">   nsresult RestoreSelection(nsMsgKey aCurrentmsgKey,</span>
<a href="#l2.205"></a><span id="l2.205">                             nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray);</span>
<a href="#l2.206"></a><span id="l2.206"> </span>
<a href="#l2.207"></a><span id="l2.207">   // This is not safe to use when you have a selection.</span>
<a href="#l2.208"></a><span id="l2.208">   // RowCountChanged() will call AdjustSelection().</span>
<a href="#l2.209"></a><span id="l2.209">   // It should be called after SaveAndClearSelection() and before</span>
<a href="#l2.210"></a><span id="l2.210">   // RestoreSelection().</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-  nsresult AdjustRowCount(int32_t rowCountBeforeSort, int32_t rowCountAfterSort);</span>
<a href="#l2.212"></a><span id="l2.212" class="difflineplus">+  nsresult AdjustRowCount(int32_t rowCountBeforeSort,</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineplus">+                          int32_t rowCountAfterSort);</span>
<a href="#l2.214"></a><span id="l2.214"> </span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-  nsresult GetSelectedIndices(nsMsgViewIndexArray&amp; selection);</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-  nsresult GenerateURIForMsgKey(nsMsgKey aMsgKey, nsIMsgFolder *folder, nsACString &amp;aURI);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+  nsresult GetSelectedIndices(nsMsgViewIndexArray &amp;selection);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+  nsresult GenerateURIForMsgKey(nsMsgKey aMsgKey, nsIMsgFolder *folder,</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+                                nsACString &amp;aURI);</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221">   // Routines used in building up view.</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineminus">-  virtual bool WantsThisThread(nsIMsgThread * thread);</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineminus">-  virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex = nullptr);</span>
<a href="#l2.224"></a><span id="l2.224" class="difflineminus">-  bool GetShowingIgnored() {return (m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored) != 0;}</span>
<a href="#l2.225"></a><span id="l2.225" class="difflineplus">+  virtual bool WantsThisThread(nsIMsgThread *thread);</span>
<a href="#l2.226"></a><span id="l2.226" class="difflineplus">+  virtual nsresult AddHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineplus">+                          nsMsgViewIndex *resultIndex = nullptr);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineplus">+  bool GetShowingIgnored() {</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+    return (m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored) != 0;</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+  }</span>
<a href="#l2.231"></a><span id="l2.231">   bool OperateOnMsgsInCollapsedThreads();</span>
<a href="#l2.232"></a><span id="l2.232"> </span>
<a href="#l2.233"></a><span id="l2.233" class="difflineminus">-  virtual nsresult OnNewHeader(nsIMsgDBHdr *aNewHdr, nsMsgKey parentKey, bool ensureListed);</span>
<a href="#l2.234"></a><span id="l2.234" class="difflineplus">+  virtual nsresult OnNewHeader(nsIMsgDBHdr *aNewHdr, nsMsgKey parentKey,</span>
<a href="#l2.235"></a><span id="l2.235" class="difflineplus">+                               bool ensureListed);</span>
<a href="#l2.236"></a><span id="l2.236">   virtual nsMsgViewIndex GetInsertIndex(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.237"></a><span id="l2.237">   nsMsgViewIndex GetIndexForThread(nsIMsgDBHdr *hdr);</span>
<a href="#l2.238"></a><span id="l2.238">   nsMsgViewIndex GetThreadRootIndex(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.239"></a><span id="l2.239" class="difflineminus">-  virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr);</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineplus">+  virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index,</span>
<a href="#l2.241"></a><span id="l2.241" class="difflineplus">+                                         nsIMsgDBHdr **msgHdr);</span>
<a href="#l2.242"></a><span id="l2.242">   // Given a view index, return the index of the top-level msg in the thread.</span>
<a href="#l2.243"></a><span id="l2.243">   nsMsgViewIndex GetThreadIndex(nsMsgViewIndex msgIndex);</span>
<a href="#l2.244"></a><span id="l2.244"> </span>
<a href="#l2.245"></a><span id="l2.245">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l2.246"></a><span id="l2.246">                               nsMsgKey msgKey, uint32_t flags, uint32_t level);</span>
<a href="#l2.247"></a><span id="l2.247">   virtual void SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l2.248"></a><span id="l2.248">                            nsMsgKey msgKey, uint32_t flags, uint32_t level);</span>
<a href="#l2.249"></a><span id="l2.249">   virtual bool InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows);</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineat">@@ -225,102 +226,95 @@ protected:</span>
<a href="#l2.251"></a><span id="l2.251">    * @param allowDummy Should dummy headers be returned when the non-dummy</span>
<a href="#l2.252"></a><span id="l2.252">    *     header is available?  If the root node of the thread is a dummy header</span>
<a href="#l2.253"></a><span id="l2.253">    *     and you pass false, then we will return the first child of the thread</span>
<a href="#l2.254"></a><span id="l2.254">    *     unless the thread is elided, in which case we will return the root.</span>
<a href="#l2.255"></a><span id="l2.255">    *     If you pass true, we will always return the root.</span>
<a href="#l2.256"></a><span id="l2.256">    * @return the view index of the first message in the thread, if any.</span>
<a href="#l2.257"></a><span id="l2.257">    */</span>
<a href="#l2.258"></a><span id="l2.258">   nsMsgViewIndex GetIndexOfFirstDisplayedKeyInThread(nsIMsgThread *threadHdr,</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineminus">-                                                     bool allowDummy=false);</span>
<a href="#l2.260"></a><span id="l2.260" class="difflineplus">+                                                     bool allowDummy = false);</span>
<a href="#l2.261"></a><span id="l2.261">   virtual nsresult GetFirstMessageHdrToDisplayInThread(nsIMsgThread *threadHdr,</span>
<a href="#l2.262"></a><span id="l2.262">                                                        nsIMsgDBHdr **result);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-  virtual nsMsgViewIndex ThreadIndexOfMsg(nsMsgKey msgKey,</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-                                          nsMsgViewIndex msgIndex = nsMsgViewIndex_None,</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-                                          int32_t *pThreadCount = nullptr,</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-                                          uint32_t *pFlags = nullptr);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineminus">-  nsMsgViewIndex ThreadIndexOfMsgHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineminus">-                                     nsMsgViewIndex msgIndex = nsMsgViewIndex_None,</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineminus">-                                     int32_t *pThreadCount = nullptr,</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineminus">-                                     uint32_t *pFlags = nullptr);</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+  virtual nsMsgViewIndex ThreadIndexOfMsg(</span>
<a href="#l2.272"></a><span id="l2.272" class="difflineplus">+      nsMsgKey msgKey, nsMsgViewIndex msgIndex = nsMsgViewIndex_None,</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineplus">+      int32_t *pThreadCount = nullptr, uint32_t *pFlags = nullptr);</span>
<a href="#l2.274"></a><span id="l2.274" class="difflineplus">+  nsMsgViewIndex ThreadIndexOfMsgHdr(</span>
<a href="#l2.275"></a><span id="l2.275" class="difflineplus">+      nsIMsgDBHdr *msgHdr, nsMsgViewIndex msgIndex = nsMsgViewIndex_None,</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineplus">+      int32_t *pThreadCount = nullptr, uint32_t *pFlags = nullptr);</span>
<a href="#l2.277"></a><span id="l2.277">   nsMsgKey GetKeyOfFirstMsgInThread(nsMsgKey key);</span>
<a href="#l2.278"></a><span id="l2.278">   int32_t CountExpandedThread(nsMsgViewIndex index);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-  virtual  nsresult ExpansionDelta(nsMsgViewIndex index, int32_t *expansionDelta);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  virtual nsresult ExpansionDelta(nsMsgViewIndex index,</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+                                  int32_t *expansionDelta);</span>
<a href="#l2.282"></a><span id="l2.282">   void ReverseSort();</span>
<a href="#l2.283"></a><span id="l2.283">   void ReverseThreads();</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-  nsresult SaveSortInfo(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+  nsresult SaveSortInfo(nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineplus">+                        nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l2.287"></a><span id="l2.287">   nsresult RestoreSortInfo();</span>
<a href="#l2.288"></a><span id="l2.288">   nsresult PersistFolderInfo(nsIDBFolderInfo **dbFolderInfo);</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-  void     SetMRUTimeForFolder(nsIMsgFolder *folder);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineplus">+  void SetMRUTimeForFolder(nsIMsgFolder *folder);</span>
<a href="#l2.291"></a><span id="l2.291"> </span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-  nsMsgKey GetAt(nsMsgViewIndex index)</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-           {return m_keys.SafeElementAt(index, nsMsgKey_None);}</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+  nsMsgKey GetAt(nsMsgViewIndex index) {</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    return m_keys.SafeElementAt(index, nsMsgKey_None);</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+  }</span>
<a href="#l2.297"></a><span id="l2.297"> </span>
<a href="#l2.298"></a><span id="l2.298" class="difflineminus">-  nsMsgViewIndex FindViewIndex(nsMsgKey  key)</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineminus">-                 {return FindKey(key, false);}</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+  nsMsgViewIndex FindViewIndex(nsMsgKey key) { return FindKey(key, false); }</span>
<a href="#l2.301"></a><span id="l2.301">   /**</span>
<a href="#l2.302"></a><span id="l2.302">    * Find the message header if it is visible in this view.  (Messages in</span>
<a href="#l2.303"></a><span id="l2.303">    *     threads/groups that are elided will not be</span>
<a href="#l2.304"></a><span id="l2.304">    * @param msgHdr Message header to look for.</span>
<a href="#l2.305"></a><span id="l2.305">    * @param startIndex The index to start looking from.</span>
<a href="#l2.306"></a><span id="l2.306">    * @param allowDummy Are dummy headers acceptable?  If yes, then for a group</span>
<a href="#l2.307"></a><span id="l2.307">    *     with a dummy header, we return the root of the thread (the dummy</span>
<a href="#l2.308"></a><span id="l2.308">    *     header), otherwise we return the actual &quot;content&quot; header for the</span>
<a href="#l2.309"></a><span id="l2.309">    *     message.</span>
<a href="#l2.310"></a><span id="l2.310">    * @return The view index of the header found, if any.</span>
<a href="#l2.311"></a><span id="l2.311">    */</span>
<a href="#l2.312"></a><span id="l2.312">   virtual nsMsgViewIndex FindHdr(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.313"></a><span id="l2.313">                                  nsMsgViewIndex startIndex = 0,</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-                                 bool allowDummy=false);</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+                                 bool allowDummy = false);</span>
<a href="#l2.316"></a><span id="l2.316">   virtual nsMsgViewIndex FindKey(nsMsgKey key, bool expand);</span>
<a href="#l2.317"></a><span id="l2.317">   virtual nsresult GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db);</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineminus">-  virtual nsCOMArray&lt;nsIMsgFolder&gt;* GetFolders();</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineminus">-  virtual nsresult GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder);</span>
<a href="#l2.320"></a><span id="l2.320" class="difflineplus">+  virtual nsCOMArray&lt;nsIMsgFolder&gt; *GetFolders();</span>
<a href="#l2.321"></a><span id="l2.321" class="difflineplus">+  virtual nsresult GetFolderFromMsgURI(const char *aMsgURI,</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineplus">+                                       nsIMsgFolder **aFolder);</span>
<a href="#l2.323"></a><span id="l2.323"> </span>
<a href="#l2.324"></a><span id="l2.324">   virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l2.325"></a><span id="l2.325">                                    nsMsgViewIndex viewIndex,</span>
<a href="#l2.326"></a><span id="l2.326">                                    uint32_t *pNumListed);</span>
<a href="#l2.327"></a><span id="l2.327">   nsresult ListUnreadIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l2.328"></a><span id="l2.328">                                  nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l2.329"></a><span id="l2.329">                                  uint32_t *pNumListed);</span>
<a href="#l2.330"></a><span id="l2.330">   nsMsgViewIndex FindParentInThread(nsMsgKey parentKey,</span>
<a href="#l2.331"></a><span id="l2.331">                                     nsMsgViewIndex startOfThreadViewIndex);</span>
<a href="#l2.332"></a><span id="l2.332">   virtual nsresult ListIdsInThreadOrder(nsIMsgThread *threadHdr,</span>
<a href="#l2.333"></a><span id="l2.333">                                         nsMsgKey parentKey, uint32_t level,</span>
<a href="#l2.334"></a><span id="l2.334">                                         nsMsgViewIndex *viewIndex,</span>
<a href="#l2.335"></a><span id="l2.335">                                         uint32_t *pNumListed);</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-  uint32_t GetSize(void) {return(m_keys.Length());}</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineplus">+  uint32_t GetSize(void) { return (m_keys.Length()); }</span>
<a href="#l2.338"></a><span id="l2.338"> </span>
<a href="#l2.339"></a><span id="l2.339">   // Notification APIs.</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineminus">-  void  NoteStartChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineminus">-                        int32_t numChanged,</span>
<a href="#l2.342"></a><span id="l2.342" class="difflineminus">-                        nsMsgViewNotificationCodeValue changeType);</span>
<a href="#l2.343"></a><span id="l2.343" class="difflineminus">-  void  NoteEndChange(nsMsgViewIndex firstlineChanged,</span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-                      int32_t numChanged,</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-                      nsMsgViewNotificationCodeValue changeType);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineplus">+  void NoteStartChange(nsMsgViewIndex firstlineChanged, int32_t numChanged,</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineplus">+                       nsMsgViewNotificationCodeValue changeType);</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  void NoteEndChange(nsMsgViewIndex firstlineChanged, int32_t numChanged,</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+                     nsMsgViewNotificationCodeValue changeType);</span>
<a href="#l2.350"></a><span id="l2.350"> </span>
<a href="#l2.351"></a><span id="l2.351">   // For commands.</span>
<a href="#l2.352"></a><span id="l2.352">   virtual nsresult ApplyCommandToIndices(nsMsgViewCommandTypeValue command,</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-                                         nsMsgViewIndex* indices,</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+                                         nsMsgViewIndex *indices,</span>
<a href="#l2.355"></a><span id="l2.355">                                          int32_t numIndices);</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineminus">-  virtual nsresult ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command,</span>
<a href="#l2.357"></a><span id="l2.357" class="difflineminus">-                                                   nsMsgViewIndex* indices,</span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-                                                   int32_t numIndices,</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-                                                   nsIMsgFolder *destFolder);</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-  virtual nsresult CopyMessages(nsIMsgWindow *window,</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-                                nsMsgViewIndex *indices,</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineminus">-                                int32_t numIndices,</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineminus">-                                bool isMove,</span>
<a href="#l2.364"></a><span id="l2.364" class="difflineplus">+  virtual nsresult ApplyCommandToIndicesWithFolder(</span>
<a href="#l2.365"></a><span id="l2.365" class="difflineplus">+      nsMsgViewCommandTypeValue command, nsMsgViewIndex *indices,</span>
<a href="#l2.366"></a><span id="l2.366" class="difflineplus">+      int32_t numIndices, nsIMsgFolder *destFolder);</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineplus">+  virtual nsresult CopyMessages(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+                                int32_t numIndices, bool isMove,</span>
<a href="#l2.369"></a><span id="l2.369">                                 nsIMsgFolder *destFolder);</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-  virtual nsresult DeleteMessages(nsIMsgWindow *window,</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineminus">-                                  nsMsgViewIndex *indices,</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineminus">-                                  int32_t numIndices,</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineminus">-                                  bool deleteStorage);</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineminus">-  nsresult GetHeadersFromSelection(uint32_t *indices,</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineminus">-                                   uint32_t numIndices,</span>
<a href="#l2.376"></a><span id="l2.376" class="difflineplus">+  virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineplus">+                                  int32_t numIndices, bool deleteStorage);</span>
<a href="#l2.378"></a><span id="l2.378" class="difflineplus">+  nsresult GetHeadersFromSelection(uint32_t *indices, uint32_t numIndices,</span>
<a href="#l2.379"></a><span id="l2.379">                                    nsIMutableArray *messageArray);</span>
<a href="#l2.380"></a><span id="l2.380">   virtual nsresult ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l2.381"></a><span id="l2.381">                                          nsIMutableArray *messageArray);</span>
<a href="#l2.382"></a><span id="l2.382"> </span>
<a href="#l2.383"></a><span id="l2.383">   nsresult SetMsgHdrJunkStatus(nsIJunkMailPlugin *aJunkPlugin,</span>
<a href="#l2.384"></a><span id="l2.384">                                nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l2.385"></a><span id="l2.385">                                nsMsgJunkStatus aNewClassification);</span>
<a href="#l2.386"></a><span id="l2.386">   nsresult ToggleReadByIndex(nsMsgViewIndex index);</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineat">@@ -329,147 +323,147 @@ protected:</span>
<a href="#l2.388"></a><span id="l2.388">                                      nsTArray&lt;nsMsgKey&gt; &amp;keysMarkedRead,</span>
<a href="#l2.389"></a><span id="l2.389">                                      bool read);</span>
<a href="#l2.390"></a><span id="l2.390">   nsresult SetFlaggedByIndex(nsMsgViewIndex index, bool mark);</span>
<a href="#l2.391"></a><span id="l2.391">   nsresult SetLabelByIndex(nsMsgViewIndex index, nsMsgLabelValue label);</span>
<a href="#l2.392"></a><span id="l2.392">   nsresult OrExtraFlag(nsMsgViewIndex index, uint32_t orflag);</span>
<a href="#l2.393"></a><span id="l2.393">   nsresult AndExtraFlag(nsMsgViewIndex index, uint32_t andflag);</span>
<a href="#l2.394"></a><span id="l2.394">   nsresult SetExtraFlag(nsMsgViewIndex index, uint32_t extraflag);</span>
<a href="#l2.395"></a><span id="l2.395">   virtual nsresult RemoveByIndex(nsMsgViewIndex index);</span>
<a href="#l2.396"></a><span id="l2.396" class="difflineminus">-  virtual void OnExtraFlagChanged(nsMsgViewIndex /*index*/, uint32_t /*extraFlag*/) {}</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineplus">+  virtual void OnExtraFlagChanged(nsMsgViewIndex /*index*/,</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+                                  uint32_t /*extraFlag*/) {}</span>
<a href="#l2.399"></a><span id="l2.399">   virtual void OnHeaderAddedOrDeleted() {}</span>
<a href="#l2.400"></a><span id="l2.400" class="difflineminus">-  nsresult ToggleWatched( nsMsgViewIndex* indices,  int32_t numIndices);</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-  nsresult SetThreadWatched(nsIMsgThread *thread, nsMsgViewIndex index, bool watched);</span>
<a href="#l2.402"></a><span id="l2.402" class="difflineminus">-  nsresult SetThreadIgnored(nsIMsgThread *thread, nsMsgViewIndex threadIndex, bool ignored);</span>
<a href="#l2.403"></a><span id="l2.403" class="difflineminus">-  nsresult SetSubthreadKilled(nsIMsgDBHdr *header, nsMsgViewIndex msgIndex, bool ignored);</span>
<a href="#l2.404"></a><span id="l2.404" class="difflineminus">-  nsresult DownloadForOffline(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices);</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineplus">+  nsresult ToggleWatched(nsMsgViewIndex *indices, int32_t numIndices);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+  nsresult SetThreadWatched(nsIMsgThread *thread, nsMsgViewIndex index,</span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+                            bool watched);</span>
<a href="#l2.408"></a><span id="l2.408" class="difflineplus">+  nsresult SetThreadIgnored(nsIMsgThread *thread, nsMsgViewIndex threadIndex,</span>
<a href="#l2.409"></a><span id="l2.409" class="difflineplus">+                            bool ignored);</span>
<a href="#l2.410"></a><span id="l2.410" class="difflineplus">+  nsresult SetSubthreadKilled(nsIMsgDBHdr *header, nsMsgViewIndex msgIndex,</span>
<a href="#l2.411"></a><span id="l2.411" class="difflineplus">+                              bool ignored);</span>
<a href="#l2.412"></a><span id="l2.412" class="difflineplus">+  nsresult DownloadForOffline(nsIMsgWindow *window, nsMsgViewIndex *indices,</span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+                              int32_t numIndices);</span>
<a href="#l2.414"></a><span id="l2.414">   nsresult DownloadFlaggedForOffline(nsIMsgWindow *window);</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineminus">-  nsMsgViewIndex  GetThreadFromMsgIndex(nsMsgViewIndex index, nsIMsgThread **threadHdr);</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineplus">+  nsMsgViewIndex GetThreadFromMsgIndex(nsMsgViewIndex index,</span>
<a href="#l2.417"></a><span id="l2.417" class="difflineplus">+                                       nsIMsgThread **threadHdr);</span>
<a href="#l2.418"></a><span id="l2.418">   /// Should junk commands be enabled for the current message in the view?</span>
<a href="#l2.419"></a><span id="l2.419">   bool JunkControlsEnabled(nsMsgViewIndex aViewIndex);</span>
<a href="#l2.420"></a><span id="l2.420"> </span>
<a href="#l2.421"></a><span id="l2.421">   // For sorting.</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-  nsresult GetFieldTypeAndLenForSort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineminus">-                                     uint16_t *pMaxLen,</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-                                     eFieldType *pFieldType,</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineminus">-                                     nsIMsgCustomColumnHandler* colHandler = nullptr);</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineminus">-  nsresult GetCollationKey(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineminus">-                           nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineminus">-                           uint8_t **result,</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineminus">-                           uint32_t *len,</span>
<a href="#l2.430"></a><span id="l2.430" class="difflineminus">-                           nsIMsgCustomColumnHandler* colHandler = nullptr);</span>
<a href="#l2.431"></a><span id="l2.431" class="difflineminus">-  nsresult GetLongField(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.432"></a><span id="l2.432" class="difflineminus">-                        nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.433"></a><span id="l2.433" class="difflineplus">+  nsresult GetFieldTypeAndLenForSort(</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineplus">+      nsMsgViewSortTypeValue sortType, uint16_t *pMaxLen,</span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+      eFieldType *pFieldType, nsIMsgCustomColumnHandler *colHandler = nullptr);</span>
<a href="#l2.436"></a><span id="l2.436" class="difflineplus">+  nsresult GetCollationKey(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.437"></a><span id="l2.437" class="difflineplus">+                           uint8_t **result, uint32_t *len,</span>
<a href="#l2.438"></a><span id="l2.438" class="difflineplus">+                           nsIMsgCustomColumnHandler *colHandler = nullptr);</span>
<a href="#l2.439"></a><span id="l2.439" class="difflineplus">+  nsresult GetLongField(nsIMsgDBHdr *msgHdr, nsMsgViewSortTypeValue sortType,</span>
<a href="#l2.440"></a><span id="l2.440">                         uint32_t *result,</span>
<a href="#l2.441"></a><span id="l2.441" class="difflineminus">-                        nsIMsgCustomColumnHandler* colHandler = nullptr);</span>
<a href="#l2.442"></a><span id="l2.442" class="difflineplus">+                        nsIMsgCustomColumnHandler *colHandler = nullptr);</span>
<a href="#l2.443"></a><span id="l2.443"> </span>
<a href="#l2.444"></a><span id="l2.444" class="difflineminus">-  static int FnSortIdKey(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineminus">-  static int FnSortIdKeyPtr(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineminus">-  static int FnSortIdUint32(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+  static int FnSortIdKey(const void *pItem1, const void *pItem2,</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+                         void *privateData);</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+  static int FnSortIdKeyPtr(const void *pItem1, const void *pItem2,</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+                            void *privateData);</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+  static int FnSortIdUint32(const void *pItem1, const void *pItem2,</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+                            void *privateData);</span>
<a href="#l2.453"></a><span id="l2.453"> </span>
<a href="#l2.454"></a><span id="l2.454">   nsresult GetStatusSortValue(nsIMsgDBHdr *msgHdr, uint32_t *result);</span>
<a href="#l2.455"></a><span id="l2.455" class="difflineminus">-  nsresult GetLocationCollationKey(nsIMsgDBHdr *msgHdr, uint8_t **result, uint32_t *len);</span>
<a href="#l2.456"></a><span id="l2.456" class="difflineplus">+  nsresult GetLocationCollationKey(nsIMsgDBHdr *msgHdr, uint8_t **result,</span>
<a href="#l2.457"></a><span id="l2.457" class="difflineplus">+                                   uint32_t *len);</span>
<a href="#l2.458"></a><span id="l2.458">   void PushSort(const MsgViewSortColumnInfo &amp;newSort);</span>
<a href="#l2.459"></a><span id="l2.459">   nsresult EncodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l2.460"></a><span id="l2.460">   nsresult DecodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l2.461"></a><span id="l2.461">   // For view navigation.</span>
<a href="#l2.462"></a><span id="l2.462">   nsresult NavigateFromPos(nsMsgNavigationTypeValue motion,</span>
<a href="#l2.463"></a><span id="l2.463" class="difflineminus">-                           nsMsgViewIndex startIndex,</span>
<a href="#l2.464"></a><span id="l2.464" class="difflineminus">-                           nsMsgKey *pResultKey,</span>
<a href="#l2.465"></a><span id="l2.465" class="difflineplus">+                           nsMsgViewIndex startIndex, nsMsgKey *pResultKey,</span>
<a href="#l2.466"></a><span id="l2.466">                            nsMsgViewIndex *pResultIndex,</span>
<a href="#l2.467"></a><span id="l2.467" class="difflineminus">-                           nsMsgViewIndex *pThreadIndex,</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-                           bool wrap);</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineminus">-  nsresult FindNextFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.470"></a><span id="l2.470" class="difflineplus">+                           nsMsgViewIndex *pThreadIndex, bool wrap);</span>
<a href="#l2.471"></a><span id="l2.471" class="difflineplus">+  nsresult FindNextFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l2.472"></a><span id="l2.472" class="difflineplus">+                           nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.473"></a><span id="l2.473">   nsresult FindFirstNew(nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.474"></a><span id="l2.474" class="difflineminus">-  nsresult FindPrevUnread(nsMsgKey startKey, nsMsgKey *pResultKey, nsMsgKey *resultThreadId);</span>
<a href="#l2.475"></a><span id="l2.475" class="difflineplus">+  nsresult FindPrevUnread(nsMsgKey startKey, nsMsgKey *pResultKey,</span>
<a href="#l2.476"></a><span id="l2.476" class="difflineplus">+                          nsMsgKey *resultThreadId);</span>
<a href="#l2.477"></a><span id="l2.477">   nsresult FindFirstFlagged(nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineminus">-  nsresult FindPrevFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.479"></a><span id="l2.479" class="difflineminus">-  nsresult MarkThreadOfMsgRead(nsMsgKey msgId,</span>
<a href="#l2.480"></a><span id="l2.480" class="difflineminus">-                               nsMsgViewIndex msgIndex,</span>
<a href="#l2.481"></a><span id="l2.481" class="difflineminus">-                               nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l2.482"></a><span id="l2.482" class="difflineminus">-                               bool bRead);</span>
<a href="#l2.483"></a><span id="l2.483" class="difflineminus">-  nsresult MarkThreadRead(nsIMsgThread *threadHdr,</span>
<a href="#l2.484"></a><span id="l2.484" class="difflineminus">-                          nsMsgViewIndex threadIndex,</span>
<a href="#l2.485"></a><span id="l2.485" class="difflineminus">-                          nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead,</span>
<a href="#l2.486"></a><span id="l2.486" class="difflineminus">-                          bool bRead);</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineplus">+  nsresult FindPrevFlagged(nsMsgViewIndex startIndex,</span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+                           nsMsgViewIndex *pResultIndex);</span>
<a href="#l2.489"></a><span id="l2.489" class="difflineplus">+  nsresult MarkThreadOfMsgRead(nsMsgKey msgId, nsMsgViewIndex msgIndex,</span>
<a href="#l2.490"></a><span id="l2.490" class="difflineplus">+                               nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead);</span>
<a href="#l2.491"></a><span id="l2.491" class="difflineplus">+  nsresult MarkThreadRead(nsIMsgThread *threadHdr, nsMsgViewIndex threadIndex,</span>
<a href="#l2.492"></a><span id="l2.492" class="difflineplus">+                          nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead);</span>
<a href="#l2.493"></a><span id="l2.493">   bool IsValidIndex(nsMsgViewIndex index);</span>
<a href="#l2.494"></a><span id="l2.494" class="difflineminus">-  nsresult ToggleIgnored(nsMsgViewIndex * indices,</span>
<a href="#l2.495"></a><span id="l2.495" class="difflineminus">-                         int32_t numIndices,</span>
<a href="#l2.496"></a><span id="l2.496" class="difflineminus">-                         nsMsgViewIndex *resultIndex,</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineminus">-                         bool *resultToggleState);</span>
<a href="#l2.498"></a><span id="l2.498" class="difflineminus">-  nsresult ToggleMessageKilled(nsMsgViewIndex * indices,</span>
<a href="#l2.499"></a><span id="l2.499" class="difflineminus">-                               int32_t numIndices,</span>
<a href="#l2.500"></a><span id="l2.500" class="difflineplus">+  nsresult ToggleIgnored(nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l2.501"></a><span id="l2.501" class="difflineplus">+                         nsMsgViewIndex *resultIndex, bool *resultToggleState);</span>
<a href="#l2.502"></a><span id="l2.502" class="difflineplus">+  nsresult ToggleMessageKilled(nsMsgViewIndex *indices, int32_t numIndices,</span>
<a href="#l2.503"></a><span id="l2.503">                                nsMsgViewIndex *resultIndex,</span>
<a href="#l2.504"></a><span id="l2.504">                                bool *resultToggleState);</span>
<a href="#l2.505"></a><span id="l2.505" class="difflineminus">-  bool OfflineMsgSelected(nsMsgViewIndex * indices, int32_t numIndices);</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-  bool NonDummyMsgSelected(nsMsgViewIndex * indices, int32_t numIndices);</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineminus">-  char16_t * GetString(const char16_t *aStringName);</span>
<a href="#l2.508"></a><span id="l2.508" class="difflineminus">-  nsresult GetPrefLocalizedString(const char *aPrefName, nsString&amp; aResult);</span>
<a href="#l2.509"></a><span id="l2.509" class="difflineminus">-  nsresult AppendKeywordProperties(const nsACString&amp; keywords,</span>
<a href="#l2.510"></a><span id="l2.510" class="difflineminus">-                                   nsAString&amp; properties);</span>
<a href="#l2.511"></a><span id="l2.511" class="difflineplus">+  bool OfflineMsgSelected(nsMsgViewIndex *indices, int32_t numIndices);</span>
<a href="#l2.512"></a><span id="l2.512" class="difflineplus">+  bool NonDummyMsgSelected(nsMsgViewIndex *indices, int32_t numIndices);</span>
<a href="#l2.513"></a><span id="l2.513" class="difflineplus">+  char16_t *GetString(const char16_t *aStringName);</span>
<a href="#l2.514"></a><span id="l2.514" class="difflineplus">+  nsresult GetPrefLocalizedString(const char *aPrefName, nsString &amp;aResult);</span>
<a href="#l2.515"></a><span id="l2.515" class="difflineplus">+  nsresult AppendKeywordProperties(const nsACString &amp;keywords,</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineplus">+                                   nsAString &amp;properties);</span>
<a href="#l2.517"></a><span id="l2.517">   nsresult InitLabelStrings(void);</span>
<a href="#l2.518"></a><span id="l2.518">   nsresult CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l2.519"></a><span id="l2.519">                       nsIMessenger *aMessengerInstance,</span>
<a href="#l2.520"></a><span id="l2.520">                       nsIMsgWindow *aMsgWindow,</span>
<a href="#l2.521"></a><span id="l2.521">                       nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l2.522"></a><span id="l2.522">   void InitializeLiterals();</span>
<a href="#l2.523"></a><span id="l2.523">   virtual int32_t FindLevelInThread(nsIMsgDBHdr *msgHdr,</span>
<a href="#l2.524"></a><span id="l2.524">                                     nsMsgViewIndex startOfThread,</span>
<a href="#l2.525"></a><span id="l2.525">                                     nsMsgViewIndex viewIndex);</span>
<a href="#l2.526"></a><span id="l2.526">   nsresult GetImapDeleteModel(nsIMsgFolder *folder);</span>
<a href="#l2.527"></a><span id="l2.527">   nsresult UpdateDisplayMessage(nsMsgViewIndex viewPosition);</span>
<a href="#l2.528"></a><span id="l2.528">   nsresult GetDBForHeader(nsIMsgDBHdr *msgHdr, nsIMsgDatabase **db);</span>
<a href="#l2.529"></a><span id="l2.529"> </span>
<a href="#l2.530"></a><span id="l2.530">   bool AdjustReadFlag(nsIMsgDBHdr *msgHdr, uint32_t *msgFlags);</span>
<a href="#l2.531"></a><span id="l2.531" class="difflineminus">-  void FreeAll(nsTArray&lt;void*&gt; *ptrs);</span>
<a href="#l2.532"></a><span id="l2.532" class="difflineplus">+  void FreeAll(nsTArray&lt;void *&gt; *ptrs);</span>
<a href="#l2.533"></a><span id="l2.533">   void ClearHdrCache();</span>
<a href="#l2.534"></a><span id="l2.534">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l2.535"></a><span id="l2.535">   nsTArray&lt;uint32_t&gt; m_flags;</span>
<a href="#l2.536"></a><span id="l2.536">   nsTArray&lt;uint8_t&gt; m_levels;</span>
<a href="#l2.537"></a><span id="l2.537">   nsMsgImapDeleteModel mDeleteModel;</span>
<a href="#l2.538"></a><span id="l2.538"> </span>
<a href="#l2.539"></a><span id="l2.539">   // Cache the most recently asked for header and corresponding msgKey.</span>
<a href="#l2.540"></a><span id="l2.540" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt;  m_cachedHdr;</span>
<a href="#l2.541"></a><span id="l2.541" class="difflineminus">-  nsMsgKey                m_cachedMsgKey;</span>
<a href="#l2.542"></a><span id="l2.542" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; m_cachedHdr;</span>
<a href="#l2.543"></a><span id="l2.543" class="difflineplus">+  nsMsgKey m_cachedMsgKey;</span>
<a href="#l2.544"></a><span id="l2.544"> </span>
<a href="#l2.545"></a><span id="l2.545">   // We need to store the message key for the message we are currently</span>
<a href="#l2.546"></a><span id="l2.546">   // displaying to ensure we don't try to redisplay the same message just</span>
<a href="#l2.547"></a><span id="l2.547">   // because the selection changed (i.e. after a sort).</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineminus">-  nsMsgKey                m_currentlyDisplayedMsgKey;</span>
<a href="#l2.549"></a><span id="l2.549" class="difflineminus">-  nsCString               m_currentlyDisplayedMsgUri;</span>
<a href="#l2.550"></a><span id="l2.550" class="difflineminus">-  nsMsgViewIndex          m_currentlyDisplayedViewIndex;</span>
<a href="#l2.551"></a><span id="l2.551" class="difflineplus">+  nsMsgKey m_currentlyDisplayedMsgKey;</span>
<a href="#l2.552"></a><span id="l2.552" class="difflineplus">+  nsCString m_currentlyDisplayedMsgUri;</span>
<a href="#l2.553"></a><span id="l2.553" class="difflineplus">+  nsMsgViewIndex m_currentlyDisplayedViewIndex;</span>
<a href="#l2.554"></a><span id="l2.554">   // If we're deleting messages, we want to hold off loading messages on</span>
<a href="#l2.555"></a><span id="l2.555">   // selection changed until the delete is done and we want to batch</span>
<a href="#l2.556"></a><span id="l2.556">   // notifications.</span>
<a href="#l2.557"></a><span id="l2.557">   bool m_deletingRows;</span>
<a href="#l2.558"></a><span id="l2.558">   // For certain special folders and descendants of those folders</span>
<a href="#l2.559"></a><span id="l2.559">   // (like the &quot;Sent&quot; folder, &quot;Sent/Old Sent&quot;).</span>
<a href="#l2.560"></a><span id="l2.560">   // The Sender column really shows recipients.</span>
<a href="#l2.561"></a><span id="l2.561"> </span>
<a href="#l2.562"></a><span id="l2.562">   // Server types for this view's folder</span>
<a href="#l2.563"></a><span id="l2.563" class="difflineminus">-  bool mIsNews;             // We have special icons for news.</span>
<a href="#l2.564"></a><span id="l2.564" class="difflineminus">-  bool mIsRss;              // RSS affects enabling of junk commands.</span>
<a href="#l2.565"></a><span id="l2.565" class="difflineminus">-  bool mIsXFVirtual;        // A virtual folder with multiple folders.</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineplus">+  bool mIsNews;       // We have special icons for news.</span>
<a href="#l2.567"></a><span id="l2.567" class="difflineplus">+  bool mIsRss;        // RSS affects enabling of junk commands.</span>
<a href="#l2.568"></a><span id="l2.568" class="difflineplus">+  bool mIsXFVirtual;  // A virtual folder with multiple folders.</span>
<a href="#l2.569"></a><span id="l2.569"> </span>
<a href="#l2.570"></a><span id="l2.570">   bool mShowSizeInLines;    // For news we show lines instead of size when true.</span>
<a href="#l2.571"></a><span id="l2.571">   bool mSortThreadsByRoot;  // As opposed to by the newest message.</span>
<a href="#l2.572"></a><span id="l2.572">   bool m_sortValid;</span>
<a href="#l2.573"></a><span id="l2.573">   bool m_checkedCustomColumns;</span>
<a href="#l2.574"></a><span id="l2.574">   bool mSelectionSummarized;</span>
<a href="#l2.575"></a><span id="l2.575">   // We asked the front end to summarize the selection and it did not.</span>
<a href="#l2.576"></a><span id="l2.576">   bool mSummarizeFailed;</span>
<a href="#l2.577"></a><span id="l2.577">   uint8_t m_saveRestoreSelectionDepth;</span>
<a href="#l2.578"></a><span id="l2.578"> </span>
<a href="#l2.579"></a><span id="l2.579" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l2.581"></a><span id="l2.581" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l2.582"></a><span id="l2.582" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l2.583"></a><span id="l2.583">   // For virtual folders, the VF db.</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; m_viewFolder;</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_viewFolder;</span>
<a href="#l2.586"></a><span id="l2.586">   nsString mMessageType;</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineminus">-  nsTArray &lt;MsgViewSortColumnInfo&gt; m_sortColumns;</span>
<a href="#l2.588"></a><span id="l2.588" class="difflineminus">-  nsMsgViewSortTypeValue  m_sortType;</span>
<a href="#l2.589"></a><span id="l2.589" class="difflineplus">+  nsTArray&lt;MsgViewSortColumnInfo&gt; m_sortColumns;</span>
<a href="#l2.590"></a><span id="l2.590" class="difflineplus">+  nsMsgViewSortTypeValue m_sortType;</span>
<a href="#l2.591"></a><span id="l2.591">   nsMsgViewSortOrderValue m_sortOrder;</span>
<a href="#l2.592"></a><span id="l2.592">   nsString m_curCustomColumn;</span>
<a href="#l2.593"></a><span id="l2.593">   nsMsgViewSortTypeValue m_secondarySort;</span>
<a href="#l2.594"></a><span id="l2.594">   nsMsgViewSortOrderValue m_secondarySortOrder;</span>
<a href="#l2.595"></a><span id="l2.595">   nsString m_secondaryCustomColumn;</span>
<a href="#l2.596"></a><span id="l2.596">   nsMsgViewFlagsTypeValue m_viewFlags;</span>
<a href="#l2.597"></a><span id="l2.597"> </span>
<a href="#l2.598"></a><span id="l2.598">   // I18N date formatter service which we'll want to cache locally.</span>
<a href="#l2.599"></a><span id="l2.599" class="difflineat">@@ -503,60 +497,56 @@ protected:</span>
<a href="#l2.600"></a><span id="l2.600">   // the array as a list of the XX most recently deleted msgs.</span>
<a href="#l2.601"></a><span id="l2.601">   nsTArray&lt;nsCString&gt; mRecentlyDeletedMsgIds;</span>
<a href="#l2.602"></a><span id="l2.602">   uint32_t mRecentlyDeletedArrayIndex;</span>
<a href="#l2.603"></a><span id="l2.603">   void RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.604"></a><span id="l2.604">   bool WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr);</span>
<a href="#l2.605"></a><span id="l2.605"> </span>
<a href="#l2.606"></a><span id="l2.606">   // These hold pointers (and IDs) for the nsIMsgCustomColumnHandler object</span>
<a href="#l2.607"></a><span id="l2.607">   // that constitutes the custom column handler.</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-  nsCOMArray &lt;nsIMsgCustomColumnHandler&gt; m_customColumnHandlers;</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineplus">+  nsCOMArray&lt;nsIMsgCustomColumnHandler&gt; m_customColumnHandlers;</span>
<a href="#l2.610"></a><span id="l2.610">   nsTArray&lt;nsString&gt; m_customColumnHandlerIDs;</span>
<a href="#l2.611"></a><span id="l2.611"> </span>
<a href="#l2.612"></a><span id="l2.612" class="difflineminus">-  nsIMsgCustomColumnHandler* GetColumnHandler(const nsAString &amp;colID);</span>
<a href="#l2.613"></a><span id="l2.613" class="difflineminus">-  nsIMsgCustomColumnHandler* GetCurColumnHandler();</span>
<a href="#l2.614"></a><span id="l2.614" class="difflineplus">+  nsIMsgCustomColumnHandler *GetColumnHandler(const nsAString &amp;colID);</span>
<a href="#l2.615"></a><span id="l2.615" class="difflineplus">+  nsIMsgCustomColumnHandler *GetCurColumnHandler();</span>
<a href="#l2.616"></a><span id="l2.616">   bool CustomColumnsInSortAndNotRegistered();</span>
<a href="#l2.617"></a><span id="l2.617">   void EnsureCustomColumnsValid();</span>
<a href="#l2.618"></a><span id="l2.618"> </span>
<a href="#l2.619"></a><span id="l2.619"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-void InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo);</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-void ValidateSort();</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineplus">+  void InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo);</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineplus">+  void ValidateSort();</span>
<a href="#l2.624"></a><span id="l2.624"> #endif</span>
<a href="#l2.625"></a><span id="l2.625"> </span>
<a href="#l2.626"></a><span id="l2.626" class="difflineminus">-protected:</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineminus">-  static nsresult   InitDisplayFormats();</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+ protected:</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+  static nsresult InitDisplayFormats();</span>
<a href="#l2.630"></a><span id="l2.630"> </span>
<a href="#l2.631"></a><span id="l2.631" class="difflineminus">-private:</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineminus">-  static mozilla::nsDateFormatSelector  m_dateFormatDefault;</span>
<a href="#l2.633"></a><span id="l2.633" class="difflineminus">-  static mozilla::nsDateFormatSelector  m_dateFormatThisWeek;</span>
<a href="#l2.634"></a><span id="l2.634" class="difflineminus">-  static mozilla::nsDateFormatSelector  m_dateFormatToday;</span>
<a href="#l2.635"></a><span id="l2.635" class="difflineplus">+ private:</span>
<a href="#l2.636"></a><span id="l2.636" class="difflineplus">+  static mozilla::nsDateFormatSelector m_dateFormatDefault;</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineplus">+  static mozilla::nsDateFormatSelector m_dateFormatThisWeek;</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineplus">+  static mozilla::nsDateFormatSelector m_dateFormatToday;</span>
<a href="#l2.639"></a><span id="l2.639">   bool ServerSupportsFilterAfterTheFact();</span>
<a href="#l2.640"></a><span id="l2.640"> </span>
<a href="#l2.641"></a><span id="l2.641">   nsresult PerformActionsOnJunkMsgs(bool msgsAreJunk);</span>
<a href="#l2.642"></a><span id="l2.642">   nsresult DetermineActionsForJunkChange(bool msgsAreJunk,</span>
<a href="#l2.643"></a><span id="l2.643">                                          nsIMsgFolder *srcFolder,</span>
<a href="#l2.644"></a><span id="l2.644">                                          bool &amp;moveMessages,</span>
<a href="#l2.645"></a><span id="l2.645">                                          bool &amp;changeReadState,</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineminus">-                                         nsIMsgFolder** targetFolder);</span>
<a href="#l2.647"></a><span id="l2.647" class="difflineplus">+                                         nsIMsgFolder **targetFolder);</span>
<a href="#l2.648"></a><span id="l2.648"> </span>
<a href="#l2.649"></a><span id="l2.649" class="difflineminus">-  class nsMsgViewHdrEnumerator final : public nsSimpleEnumerator</span>
<a href="#l2.650"></a><span id="l2.650" class="difflineminus">-  {</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-  public:</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-    const nsID&amp; DefaultInterface() override</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-    {</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-      return NS_GET_IID(nsIMsgDBHdr);</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-    }</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineplus">+  class nsMsgViewHdrEnumerator final : public nsSimpleEnumerator {</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineplus">+   public:</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineplus">+    const nsID &amp;DefaultInterface() override { return NS_GET_IID(nsIMsgDBHdr); }</span>
<a href="#l2.659"></a><span id="l2.659"> </span>
<a href="#l2.660"></a><span id="l2.660">     // nsISimpleEnumerator methods:</span>
<a href="#l2.661"></a><span id="l2.661">     NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l2.662"></a><span id="l2.662"> </span>
<a href="#l2.663"></a><span id="l2.663">     // nsMsgThreadEnumerator methods:</span>
<a href="#l2.664"></a><span id="l2.664">     explicit nsMsgViewHdrEnumerator(nsMsgDBView *view);</span>
<a href="#l2.665"></a><span id="l2.665"> </span>
<a href="#l2.666"></a><span id="l2.666">     RefPtr&lt;nsMsgDBView&gt; m_view;</span>
<a href="#l2.667"></a><span id="l2.667">     nsMsgViewIndex m_curHdrIndex;</span>
<a href="#l2.668"></a><span id="l2.668"> </span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-  private:</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineplus">+   private:</span>
<a href="#l2.671"></a><span id="l2.671">     ~nsMsgViewHdrEnumerator() override;</span>
<a href="#l2.672"></a><span id="l2.672">   };</span>
<a href="#l2.673"></a><span id="l2.673"> };</span>
<a href="#l2.674"></a><span id="l2.674"> </span>
<a href="#l2.675"></a><span id="l2.675"> #endif</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

