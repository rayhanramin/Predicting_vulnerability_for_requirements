<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24814:49bf37634232a6237ccc84219a365000affc9739</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 49bf37634232a6237ccc84219a365000affc9739" />
<meta property="og:url" content="/comm-central/rev/49bf37634232a6237ccc84219a365000affc9739" />
<meta property="og:description" content="Bug 1478572 - Turn on ESLint in mail/components/compose; r=jorgk, aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 49bf37634232a6237ccc84219a365000affc9739 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/49bf37634232a6237ccc84219a365000affc9739">shortlog</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/49bf37634232a6237ccc84219a365000affc9739">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739">files</a> |
changeset |
<a href="/comm-central/raw-rev/49bf37634232a6237ccc84219a365000affc9739">raw</a>  | <a href="/comm-central/archive/49bf37634232a6237ccc84219a365000affc9739.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/compose; r=jorgk, aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 26 Sep 2018 11:32:06 +1200</td></tr>

<tr>
 <td>changeset 24814</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/49bf37634232a6237ccc84219a365000affc9739">49bf37634232a6237ccc84219a365000affc9739</a></td>
</tr>



<tr>
<td>parent 24813</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bff3cba93b7ce29a2a0747c540e4ec59461b54b1">bff3cba93b7ce29a2a0747c540e4ec59461b54b1</a>
</td>
</tr>

<tr>
<td>child 24815</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9a567595d18a5e0a8aa8ba229fba6e080a82a620">9a567595d18a5e0a8aa8ba229fba6e080a82a620</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=49bf37634232a6237ccc84219a365000affc9739">14930</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 25 Sep 2018 23:32:56 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9a567595d18a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a567595d18a5e0a8aa8ba229fba6e080a82a620">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9a567595d18a5e0a8aa8ba229fba6e080a82a620&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a567595d18a5e0a8aa8ba229fba6e080a82a620&newProject=comm-central&newRevision=49bf37634232a6237ccc84219a365000affc9739&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a567595d18a5e0a8aa8ba229fba6e080a82a620&newProject=comm-central&newRevision=49bf37634232a6237ccc84219a365000affc9739&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9a567595d18a5e0a8aa8ba229fba6e080a82a620&newProject=comm-central&newRevision=49bf37634232a6237ccc84219a365000affc9739&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a>, <a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">1478572</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1478572">Bug 1478572</a> - Turn on ESLint in mail/components/compose; r=jorgk, aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">mail/components/compose/content/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">mail/components/compose/content/addressingWidgetOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/addressingWidgetOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">mail/components/compose/content/bigFileObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/bigFileObserver.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">mail/components/compose/content/cloudAttachmentLinkManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">file</a> |
<a href="/comm-central/annotate/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">annotate</a> |
<a href="/comm-central/diff/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">diff</a> |
<a href="/comm-central/comparison/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">comparison</a> |
<a href="/comm-central/log/49bf37634232a6237ccc84219a365000affc9739/mail/components/compose/content/cloudAttachmentLinkManager.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,17 +47,16 @@ mailnews/test/*</span>
<a href="#l1.4"></a><span id="l1.4"> mailnews/extensions/*</span>
<a href="#l1.5"></a><span id="l1.5"> !mailnews/extensions/newsblog</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> # mail exclusions</span>
<a href="#l1.8"></a><span id="l1.8"> mail/app/**</span>
<a href="#l1.9"></a><span id="l1.9"> mail/base/**</span>
<a href="#l1.10"></a><span id="l1.10"> mail/branding/**</span>
<a href="#l1.11"></a><span id="l1.11"> mail/components/cloudfile/**</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/components/compose/**</span>
<a href="#l1.13"></a><span id="l1.13"> mail/components/im/**</span>
<a href="#l1.14"></a><span id="l1.14"> mail/components/newmailaccount/**</span>
<a href="#l1.15"></a><span id="l1.15"> mail/components/search/**</span>
<a href="#l1.16"></a><span id="l1.16"> mail/config/**</span>
<a href="#l1.17"></a><span id="l1.17"> mail/extensions/**</span>
<a href="#l1.18"></a><span id="l1.18"> mail/installer/**</span>
<a href="#l1.19"></a><span id="l1.19"> mail/locales/**</span>
<a href="#l1.20"></a><span id="l1.20"> mail/test/**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/components/compose/content/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/* eslint-env node */</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+module.exports = {</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+  globals: {</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+    // editor/ui/composer/content/ComposerCommands.js</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    doStatefulCommand: true,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    SaveDocument: true,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+    // editor/ui/composer/content/editor.js</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    EditorCleanup: true,</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    EditorSetFontSize: true,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    EditorSharedStartup: true,</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+    gChromeState: true,</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+    gDefaultBackgroundColor: true,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    gDefaultTextColor: true,</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    GetBodyElement: true,</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+    initLocalFontFaceMenu: true,</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+    onBackgroundColorChange: true,</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    onFontColorChange: true,</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+    // editor/ui/composer/content/editorUtilities.js:</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+    GetCurrentCommandManager: true,</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+    GetCurrentEditor: true,</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    GetCurrentEditorElement: true,</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+    // mail/base/content/contentAreaClick.js</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    openLinkExternally: true,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+    // mail/base/content/mailCore.js</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+    CreateAttachmentTransferData: true,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    MailToolboxCustomizeDone: true,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    openOptionsDialog: true,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+    // mail/base/content/mail-compacttheme.js</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+    CompactTheme: true,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    // mail/base/content/nsDragAndDrop.js</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+    FlavourSet: true,</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+    nsDragAndDrop: true,</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    // mail/base/content/toolbarIconColor.js</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    ToolbarIconColor: true,</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    // mail/base/content/utilityOverlay.js</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    goToggleToolbar: true,</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+    openContentTab: true,</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+    // mailnews/addrbook/content/abDragDrop.js</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    DragAddressOverTargetControl: true,</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+    // mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+    MsgAccountManager: true,</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+    verifyAccounts: true,</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+    // toolkit/components/printing/content/printUtils.js</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+    PrintUtils: true,</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+    // toolkit/content/globalOverlay.js</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+    goDoCommand: true,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+    goSetCommandEnabled: true,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+    goUpdateCommand: true,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+    // toolkit/content/viewZoomOverlay.js</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+    ZoomManager: true,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+  },</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,53 +1,41 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+/* import-globals-from addressingWidgetOverlay.js */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10"> /**</span>
<a href="#l3.11"></a><span id="l3.11">  * Commands for the message composition window.</span>
<a href="#l3.12"></a><span id="l3.12">  */</span>
<a href="#l3.13"></a><span id="l3.13"> </span>
<a href="#l3.14"></a><span id="l3.14"> // Ensure the activity modules are loaded for this window.</span>
<a href="#l3.15"></a><span id="l3.15"> ChromeUtils.import(&quot;resource:///modules/activity/activityModules.jsm&quot;);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/attachmentChecker.js&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+const { GetAttachmentKeywords } = ChromeUtils.import(&quot;resource:///modules/attachmentChecker.js&quot;, null);</span>
<a href="#l3.18"></a><span id="l3.18"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+const { MimeParser } = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;, null);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+const { allAccountsSorted } = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;, null);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+const { fixIterator, toArray } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;, null);</span>
<a href="#l3.26"></a><span id="l3.26"> ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l3.27"></a><span id="l3.27"> ChromeUtils.import(&quot;resource:///modules/MailUtils.js&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> ChromeUtils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l3.29"></a><span id="l3.29"> ChromeUtils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l3.30"></a><span id="l3.30"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.31"></a><span id="l3.31"> ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l3.32"></a><span id="l3.32"> ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34"> ChromeUtils.defineModuleGetter(this, &quot;OS&quot;, &quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l3.35"></a><span id="l3.35"> ChromeUtils.defineModuleGetter(this, &quot;ShortcutUtils&quot;,</span>
<a href="#l3.36"></a><span id="l3.36">                                &quot;resource://gre/modules/ShortcutUtils.jsm&quot;);</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> XPCOMUtils.defineLazyModuleGetters(this, {</span>
<a href="#l3.39"></a><span id="l3.39">   LightweightThemeManager: &quot;resource://gre/modules/LightweightThemeManager.jsm&quot;,</span>
<a href="#l3.40"></a><span id="l3.40"> });</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-/**</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">- * interfaces</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">- */</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-var nsIMsgCompDeliverMode = Ci.nsIMsgCompDeliverMode;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-var nsIMsgCompSendFormat = Ci.nsIMsgCompSendFormat;</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-var nsIMsgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-var nsIMsgCompType = Ci.nsIMsgCompType;</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-var nsIMsgCompFormat = Ci.nsIMsgCompFormat;</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-var nsIAbPreferMailFormat = Ci.nsIAbPreferMailFormat;</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-var nsIPlaintextEditorMail = Ci.nsIPlaintextEditor;</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineminus">-var nsISupportsString = Ci.nsISupportsString;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineminus">-var mozISpellCheckingEngine = Ci.mozISpellCheckingEngine;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-</span>
<a href="#l3.55"></a><span id="l3.55"> var sDictCount = 0;</span>
<a href="#l3.56"></a><span id="l3.56"> </span>
<a href="#l3.57"></a><span id="l3.57"> /**</span>
<a href="#l3.58"></a><span id="l3.58">  * Global message window object. This is used by mail-offline.js and therefore</span>
<a href="#l3.59"></a><span id="l3.59">  * should not be renamed. We need to avoid doing this kind of cross file global</span>
<a href="#l3.60"></a><span id="l3.60">  * stuff in the future and instead pass this object as parameter when needed by</span>
<a href="#l3.61"></a><span id="l3.61">  * functions in the other js file.</span>
<a href="#l3.62"></a><span id="l3.62">  */</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineat">@@ -113,53 +101,51 @@ var gAutoSaveInterval;</span>
<a href="#l3.64"></a><span id="l3.64"> var gAutoSaveTimeout;</span>
<a href="#l3.65"></a><span id="l3.65"> var gAutoSaveKickedIn;</span>
<a href="#l3.66"></a><span id="l3.66"> var gEditingDraft;</span>
<a href="#l3.67"></a><span id="l3.67"> var gAttachmentsSize;</span>
<a href="#l3.68"></a><span id="l3.68"> var gNumUploadingAttachments;</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70"> var kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-function InitializeGlobalVariables()</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineminus">-{</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineplus">+function InitializeGlobalVariables() {</span>
<a href="#l3.75"></a><span id="l3.75">   gMessenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l3.76"></a><span id="l3.76">                  .createInstance(Ci.nsIMessenger);</span>
<a href="#l3.77"></a><span id="l3.77"> </span>
<a href="#l3.78"></a><span id="l3.78">   gMsgCompose = null;</span>
<a href="#l3.79"></a><span id="l3.79">   gOriginalMsgURI = null;</span>
<a href="#l3.80"></a><span id="l3.80">   gWindowLocked = false;</span>
<a href="#l3.81"></a><span id="l3.81">   gContentChanged = false;</span>
<a href="#l3.82"></a><span id="l3.82">   gSubjectChanged = false;</span>
<a href="#l3.83"></a><span id="l3.83">   gCurrentIdentity = null;</span>
<a href="#l3.84"></a><span id="l3.84">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l3.85"></a><span id="l3.85">   gSendOperationInProgress = false;</span>
<a href="#l3.86"></a><span id="l3.86">   gSaveOperationInProgress = false;</span>
<a href="#l3.87"></a><span id="l3.87">   gAutoSaving = false;</span>
<a href="#l3.88"></a><span id="l3.88">   gCloseWindowAfterSave = false;</span>
<a href="#l3.89"></a><span id="l3.89">   gSavedSendNowKey = null;</span>
<a href="#l3.90"></a><span id="l3.90" class="difflineminus">-  gSendFormat = nsIMsgCompSendFormat.AskUser;</span>
<a href="#l3.91"></a><span id="l3.91" class="difflineminus">-  gCharsetConvertManager = Cc['@mozilla.org/charset-converter-manager;1'].getService(Ci.nsICharsetConverterManager);</span>
<a href="#l3.92"></a><span id="l3.92" class="difflineplus">+  gSendFormat = Ci.nsIMsgCompSendFormat.AskUser;</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineplus">+  gCharsetConvertManager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;].getService(Ci.nsICharsetConverterManager);</span>
<a href="#l3.94"></a><span id="l3.94">   gManualAttachmentReminder = false;</span>
<a href="#l3.95"></a><span id="l3.95">   gDisableAttachmentReminder = false;</span>
<a href="#l3.96"></a><span id="l3.96">   gLanguageObserver = null;</span>
<a href="#l3.97"></a><span id="l3.97"> </span>
<a href="#l3.98"></a><span id="l3.98">   gLastWindowToHaveFocus = null;</span>
<a href="#l3.99"></a><span id="l3.99">   gReceiptOptionChanged = false;</span>
<a href="#l3.100"></a><span id="l3.100">   gDSNOptionChanged = false;</span>
<a href="#l3.101"></a><span id="l3.101">   gAttachVCardOptionChanged = false;</span>
<a href="#l3.102"></a><span id="l3.102">   gAttachmentsSize = 0;</span>
<a href="#l3.103"></a><span id="l3.103">   gNumUploadingAttachments = 0;</span>
<a href="#l3.104"></a><span id="l3.104">   msgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l3.105"></a><span id="l3.105">                 .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l3.106"></a><span id="l3.106">   MailServices.mailSession.AddMsgWindow(msgWindow);</span>
<a href="#l3.107"></a><span id="l3.107"> }</span>
<a href="#l3.108"></a><span id="l3.108"> InitializeGlobalVariables();</span>
<a href="#l3.109"></a><span id="l3.109"> </span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-function ReleaseGlobalVariables()</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-{</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+function ReleaseGlobalVariables() {</span>
<a href="#l3.113"></a><span id="l3.113">   gCurrentIdentity = null;</span>
<a href="#l3.114"></a><span id="l3.114">   gCharsetConvertManager = null;</span>
<a href="#l3.115"></a><span id="l3.115">   gMsgCompose = null;</span>
<a href="#l3.116"></a><span id="l3.116">   gOriginalMsgURI = null;</span>
<a href="#l3.117"></a><span id="l3.117">   gMessenger = null;</span>
<a href="#l3.118"></a><span id="l3.118">   gDisableAttachmentReminder = false;</span>
<a href="#l3.119"></a><span id="l3.119">   _gComposeBundle = null;</span>
<a href="#l3.120"></a><span id="l3.120">   MailServices.mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineat">@@ -179,62 +165,61 @@ function getPrettyKey(aKeyId) {</span>
<a href="#l3.122"></a><span id="l3.122"> /**</span>
<a href="#l3.123"></a><span id="l3.123">  * Disables or enables editable elements in the window.</span>
<a href="#l3.124"></a><span id="l3.124">  * The elements to operate on are marked with the &quot;disableonsend&quot; attribute.</span>
<a href="#l3.125"></a><span id="l3.125">  * This includes elements like the address list, attachment list, subject</span>
<a href="#l3.126"></a><span id="l3.126">  * and message body.</span>
<a href="#l3.127"></a><span id="l3.127">  *</span>
<a href="#l3.128"></a><span id="l3.128">  * @param aDisable  true = disable items. false = enable items.</span>
<a href="#l3.129"></a><span id="l3.129">  */</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-function updateEditableFields(aDisable)</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-{</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+function updateEditableFields(aDisable) {</span>
<a href="#l3.133"></a><span id="l3.133">   if (!gMsgCompose)</span>
<a href="#l3.134"></a><span id="l3.134">     return;</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">   if (aDisable)</span>
<a href="#l3.137"></a><span id="l3.137" class="difflineminus">-    gMsgCompose.editor.flags |= nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineplus">+    gMsgCompose.editor.flags |= Ci.nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l3.139"></a><span id="l3.139">   else</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineminus">-    gMsgCompose.editor.flags &amp;= ~nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l3.141"></a><span id="l3.141" class="difflineplus">+    gMsgCompose.editor.flags &amp;= ~Ci.nsIPlaintextEditor.eEditorReadonlyMask;</span>
<a href="#l3.142"></a><span id="l3.142"> </span>
<a href="#l3.143"></a><span id="l3.143">   let elements = document.querySelectorAll('[disableonsend=&quot;true&quot;]');</span>
<a href="#l3.144"></a><span id="l3.144">   for (let i = 0; i &lt; elements.length; i++)</span>
<a href="#l3.145"></a><span id="l3.145">     elements[i].disabled = aDisable;</span>
<a href="#l3.146"></a><span id="l3.146"> }</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148"> var PrintPreviewListener = {</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-  getPrintPreviewBrowser: function() {</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+  getPrintPreviewBrowser() {</span>
<a href="#l3.151"></a><span id="l3.151">     let browser = document.getElementById(&quot;cppBrowser&quot;);</span>
<a href="#l3.152"></a><span id="l3.152">     if (!gChromeState)</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineminus">-      gChromeState = new Object;</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+      gChromeState = {};</span>
<a href="#l3.155"></a><span id="l3.155">     preparePrintPreviewTitleHeader();</span>
<a href="#l3.156"></a><span id="l3.156">     if (!browser) {</span>
<a href="#l3.157"></a><span id="l3.157">       browser = document.createElement(&quot;browser&quot;);</span>
<a href="#l3.158"></a><span id="l3.158">       browser.setAttribute(&quot;id&quot;, &quot;cppBrowser&quot;);</span>
<a href="#l3.159"></a><span id="l3.159">       browser.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l3.160"></a><span id="l3.160">       browser.setAttribute(&quot;disablehistory&quot;, &quot;true&quot;);</span>
<a href="#l3.161"></a><span id="l3.161">       browser.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l3.162"></a><span id="l3.162">       document.getElementById(&quot;headers-parent&quot;).</span>
<a href="#l3.163"></a><span id="l3.163">         insertBefore(browser, document.getElementById(&quot;appcontent&quot;));</span>
<a href="#l3.164"></a><span id="l3.164">     }</span>
<a href="#l3.165"></a><span id="l3.165">     return browser;</span>
<a href="#l3.166"></a><span id="l3.166">   },</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineminus">-  getSourceBrowser: function() {</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+  getSourceBrowser() {</span>
<a href="#l3.169"></a><span id="l3.169">     return GetCurrentEditorElement();</span>
<a href="#l3.170"></a><span id="l3.170">   },</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineminus">-  getNavToolbox: function() {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+  getNavToolbox() {</span>
<a href="#l3.173"></a><span id="l3.173">     return document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l3.174"></a><span id="l3.174">   },</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineminus">-  onEnter: function() {</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+  onEnter() {</span>
<a href="#l3.177"></a><span id="l3.177">     toggleAffectedChrome(true);</span>
<a href="#l3.178"></a><span id="l3.178">   },</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineminus">-  onExit: function() {</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+  onExit() {</span>
<a href="#l3.181"></a><span id="l3.181">     document.getElementById(&quot;cppBrowser&quot;).collapsed = true;</span>
<a href="#l3.182"></a><span id="l3.182">     toggleAffectedChrome(false);</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineminus">-  }</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineminus">-}</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+  },</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineplus">+};</span>
<a href="#l3.187"></a><span id="l3.187"> </span>
<a href="#l3.188"></a><span id="l3.188"> function sidebar_is_hidden() {</span>
<a href="#l3.189"></a><span id="l3.189">   let sidebar_box = document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l3.190"></a><span id="l3.190">   return sidebar_box.getAttribute(&quot;hidden&quot;) == &quot;true&quot;;</span>
<a href="#l3.191"></a><span id="l3.191"> }</span>
<a href="#l3.192"></a><span id="l3.192"> </span>
<a href="#l3.193"></a><span id="l3.193"> function sidebar_is_collapsed() {</span>
<a href="#l3.194"></a><span id="l3.194">   let sidebar_splitter = document.getElementById(&quot;sidebar-splitter&quot;);</span>
<a href="#l3.195"></a><span id="l3.195" class="difflineat">@@ -261,64 +246,60 @@ function SidebarGetState() {</span>
<a href="#l3.196"></a><span id="l3.196"> function preparePrintPreviewTitleHeader() {</span>
<a href="#l3.197"></a><span id="l3.197">   // For title header of print (preview), use message content document title</span>
<a href="#l3.198"></a><span id="l3.198">   // if existing, otherwise message subject. To apply the message subject,</span>
<a href="#l3.199"></a><span id="l3.199">   // we temporarily change the title of message content document before going</span>
<a href="#l3.200"></a><span id="l3.200">   // into print preview (workaround for bug 1396455).</span>
<a href="#l3.201"></a><span id="l3.201">   let msgDocument = getBrowser().contentDocument;</span>
<a href="#l3.202"></a><span id="l3.202">   let msgSubject = GetMsgSubjectElement().value.trim() ||</span>
<a href="#l3.203"></a><span id="l3.203">                    getComposeBundle().getString(&quot;defaultSubject&quot;);</span>
<a href="#l3.204"></a><span id="l3.204" class="difflineminus">-  gChromeState.msgDocumentHadTitle = !!msgDocument.querySelector('title');</span>
<a href="#l3.205"></a><span id="l3.205" class="difflineplus">+  gChromeState.msgDocumentHadTitle = !!msgDocument.querySelector(&quot;title&quot;);</span>
<a href="#l3.206"></a><span id="l3.206">   gChromeState.msgDocumentTitle = msgDocument.title;</span>
<a href="#l3.207"></a><span id="l3.207">   msgDocument.title = msgDocument.title || msgSubject;</span>
<a href="#l3.208"></a><span id="l3.208"> }</span>
<a href="#l3.209"></a><span id="l3.209"> </span>
<a href="#l3.210"></a><span id="l3.210"> /**</span>
<a href="#l3.211"></a><span id="l3.211">  * When going in and out of Print Preview, hide or show respective UI elements.</span>
<a href="#l3.212"></a><span id="l3.212">  *</span>
<a href="#l3.213"></a><span id="l3.213">  * @param aHide  true:  Hide UI elements to go into print preview mode.</span>
<a href="#l3.214"></a><span id="l3.214">  *               false: Restore UI elements to their previous state to exit</span>
<a href="#l3.215"></a><span id="l3.215">  *                      print preview mode.</span>
<a href="#l3.216"></a><span id="l3.216">  */</span>
<a href="#l3.217"></a><span id="l3.217" class="difflineminus">-function toggleAffectedChrome(aHide)</span>
<a href="#l3.218"></a><span id="l3.218" class="difflineminus">-{</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+function toggleAffectedChrome(aHide) {</span>
<a href="#l3.220"></a><span id="l3.220">   // Chrome to toggle includes:</span>
<a href="#l3.221"></a><span id="l3.221">   //   (*) menubar</span>
<a href="#l3.222"></a><span id="l3.222">   //   (*) toolbox</span>
<a href="#l3.223"></a><span id="l3.223">   //   (*) message headers box</span>
<a href="#l3.224"></a><span id="l3.224">   //   (*) sidebar</span>
<a href="#l3.225"></a><span id="l3.225">   //   (*) statusbar</span>
<a href="#l3.226"></a><span id="l3.226">   let statusbar = document.getElementById(&quot;status-bar&quot;);</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228">   // Contacts Sidebar states map as follows:</span>
<a href="#l3.229"></a><span id="l3.229">   //   hidden    =&gt; hide/show nothing</span>
<a href="#l3.230"></a><span id="l3.230">   //   collapsed =&gt; hide/show only the splitter</span>
<a href="#l3.231"></a><span id="l3.231">   //   shown     =&gt; hide/show the splitter and the box</span>
<a href="#l3.232"></a><span id="l3.232"> </span>
<a href="#l3.233"></a><span id="l3.233" class="difflineminus">-  if (aHide)</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineminus">-  {</span>
<a href="#l3.235"></a><span id="l3.235" class="difflineplus">+  if (aHide) {</span>
<a href="#l3.236"></a><span id="l3.236">     // Going into print preview mode.</span>
<a href="#l3.237"></a><span id="l3.237">     SetComposeWindowTitle(true);</span>
<a href="#l3.238"></a><span id="l3.238">     // Hide headers box, Contacts Sidebar, and Status Bar</span>
<a href="#l3.239"></a><span id="l3.239">     // after remembering their current state where applicable.</span>
<a href="#l3.240"></a><span id="l3.240">     document.getElementById(&quot;headers-box&quot;).hidden = true;</span>
<a href="#l3.241"></a><span id="l3.241">     gChromeState.sidebar = SidebarGetState();</span>
<a href="#l3.242"></a><span id="l3.242">     SidebarSetState(&quot;hidden&quot;);</span>
<a href="#l3.243"></a><span id="l3.243">     gChromeState.statusbarWasHidden = statusbar.hidden;</span>
<a href="#l3.244"></a><span id="l3.244">     statusbar.hidden = true;</span>
<a href="#l3.245"></a><span id="l3.245" class="difflineminus">-  }</span>
<a href="#l3.246"></a><span id="l3.246" class="difflineminus">-  else</span>
<a href="#l3.247"></a><span id="l3.247" class="difflineminus">-  {</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineplus">+  } else {</span>
<a href="#l3.249"></a><span id="l3.249">     // Restoring normal mode (i.e. leaving print preview mode).</span>
<a href="#l3.250"></a><span id="l3.250">     SetComposeWindowTitle();</span>
<a href="#l3.251"></a><span id="l3.251">     // Restore original &quot;empty&quot; HTML document title of the message, or remove</span>
<a href="#l3.252"></a><span id="l3.252">     // the temporary title tag altogether if there was none before.</span>
<a href="#l3.253"></a><span id="l3.253">     let msgDocument = getBrowser().contentDocument;</span>
<a href="#l3.254"></a><span id="l3.254">     if (!gChromeState.msgDocumentHadTitle) {</span>
<a href="#l3.255"></a><span id="l3.255" class="difflineminus">-      msgDocument.querySelector('title').remove();</span>
<a href="#l3.256"></a><span id="l3.256" class="difflineplus">+      msgDocument.querySelector(&quot;title&quot;).remove();</span>
<a href="#l3.257"></a><span id="l3.257">     } else {</span>
<a href="#l3.258"></a><span id="l3.258">       msgDocument.title = gChromeState.msgDocumentTitle;</span>
<a href="#l3.259"></a><span id="l3.259">     }</span>
<a href="#l3.260"></a><span id="l3.260"> </span>
<a href="#l3.261"></a><span id="l3.261">     // Restore Contacts Sidebar, headers box, and Status Bar.</span>
<a href="#l3.262"></a><span id="l3.262">     SidebarSetState(gChromeState.sidebar);</span>
<a href="#l3.263"></a><span id="l3.263">     document.getElementById(&quot;headers-box&quot;).hidden = false;</span>
<a href="#l3.264"></a><span id="l3.264">     statusbar.hidden = gChromeState.statusbarWasHidden;</span>
<a href="#l3.265"></a><span id="l3.265" class="difflineat">@@ -328,27 +309,27 @@ function toggleAffectedChrome(aHide)</span>
<a href="#l3.266"></a><span id="l3.266">   document.getElementById(&quot;appcontent&quot;).collapsed = aHide;</span>
<a href="#l3.267"></a><span id="l3.267"> }</span>
<a href="#l3.268"></a><span id="l3.268"> </span>
<a href="#l3.269"></a><span id="l3.269"> /**</span>
<a href="#l3.270"></a><span id="l3.270">  * Small helper function to check whether the node passed in is a signature.</span>
<a href="#l3.271"></a><span id="l3.271">  * Note that a text node is not a DOM element, hence .localName can't be used.</span>
<a href="#l3.272"></a><span id="l3.272">  */</span>
<a href="#l3.273"></a><span id="l3.273"> function isSignature(aNode) {</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineminus">-  return [&quot;DIV&quot;,&quot;PRE&quot;].includes(aNode.nodeName) &amp;&amp;</span>
<a href="#l3.275"></a><span id="l3.275" class="difflineplus">+  return [&quot;DIV&quot;, &quot;PRE&quot;].includes(aNode.nodeName) &amp;&amp;</span>
<a href="#l3.276"></a><span id="l3.276">          aNode.classList.contains(&quot;moz-signature&quot;);</span>
<a href="#l3.277"></a><span id="l3.277"> }</span>
<a href="#l3.278"></a><span id="l3.278"> </span>
<a href="#l3.279"></a><span id="l3.279"> var stateListener = {</span>
<a href="#l3.280"></a><span id="l3.280" class="difflineminus">-  NotifyComposeFieldsReady: function() {</span>
<a href="#l3.281"></a><span id="l3.281" class="difflineplus">+  NotifyComposeFieldsReady() {</span>
<a href="#l3.282"></a><span id="l3.282">     ComposeFieldsReady();</span>
<a href="#l3.283"></a><span id="l3.283">     updateSendCommands(true);</span>
<a href="#l3.284"></a><span id="l3.284">   },</span>
<a href="#l3.285"></a><span id="l3.285"> </span>
<a href="#l3.286"></a><span id="l3.286" class="difflineminus">-  NotifyComposeBodyReady: function() {</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+  NotifyComposeBodyReady() {</span>
<a href="#l3.288"></a><span id="l3.288">     // Look all the possible compose types (nsIMsgComposeParams.idl):</span>
<a href="#l3.289"></a><span id="l3.289">     switch (gComposeType) {</span>
<a href="#l3.290"></a><span id="l3.290"> </span>
<a href="#l3.291"></a><span id="l3.291">     case Ci.nsIMsgCompType.MailToUrl:</span>
<a href="#l3.292"></a><span id="l3.292">       gBodyFromArgs = true;</span>
<a href="#l3.293"></a><span id="l3.293">     case Ci.nsIMsgCompType.New:</span>
<a href="#l3.294"></a><span id="l3.294">     case Ci.nsIMsgCompType.NewsPost:</span>
<a href="#l3.295"></a><span id="l3.295">     case Ci.nsIMsgCompType.ForwardAsAttachment:</span>
<a href="#l3.296"></a><span id="l3.296" class="difflineat">@@ -404,17 +385,17 @@ var stateListener = {</span>
<a href="#l3.297"></a><span id="l3.297">       editor.resetModificationCount();</span>
<a href="#l3.298"></a><span id="l3.298">       selection.collapse(startNode, start);</span>
<a href="#l3.299"></a><span id="l3.299">     }</span>
<a href="#l3.300"></a><span id="l3.300">     if (gMsgCompose.composeHTML)</span>
<a href="#l3.301"></a><span id="l3.301">       loadHTMLMsgPrefs();</span>
<a href="#l3.302"></a><span id="l3.302">     AdjustFocus();</span>
<a href="#l3.303"></a><span id="l3.303">   },</span>
<a href="#l3.304"></a><span id="l3.304"> </span>
<a href="#l3.305"></a><span id="l3.305" class="difflineminus">-  NotifyComposeBodyReadyNew: function() {</span>
<a href="#l3.306"></a><span id="l3.306" class="difflineplus">+  NotifyComposeBodyReadyNew() {</span>
<a href="#l3.307"></a><span id="l3.307">     let useParagraph = Services.prefs.getBoolPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l3.308"></a><span id="l3.308">     let insertParagraph = gMsgCompose.composeHTML &amp;&amp; useParagraph;</span>
<a href="#l3.309"></a><span id="l3.309"> </span>
<a href="#l3.310"></a><span id="l3.310">     let mailBody = getBrowser().contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l3.311"></a><span id="l3.311">     if (insertParagraph &amp;&amp; gBodyFromArgs) {</span>
<a href="#l3.312"></a><span id="l3.312">       // Check for &quot;empty&quot; body before allowing paragraph to be inserted.</span>
<a href="#l3.313"></a><span id="l3.313">       // Non-empty bodies in a new message can occur when clicking on a</span>
<a href="#l3.314"></a><span id="l3.314">       // mailto link or when using the command line option -compose.</span>
<a href="#l3.315"></a><span id="l3.315" class="difflineat">@@ -444,17 +425,17 @@ var stateListener = {</span>
<a href="#l3.316"></a><span id="l3.316">       editor.beginningOfDocument();</span>
<a href="#l3.317"></a><span id="l3.317">       editor.enableUndo(true);</span>
<a href="#l3.318"></a><span id="l3.318">       editor.resetModificationCount();</span>
<a href="#l3.319"></a><span id="l3.319">     } else {</span>
<a href="#l3.320"></a><span id="l3.320">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l3.321"></a><span id="l3.321">     }</span>
<a href="#l3.322"></a><span id="l3.322">   },</span>
<a href="#l3.323"></a><span id="l3.323"> </span>
<a href="#l3.324"></a><span id="l3.324" class="difflineminus">-  NotifyComposeBodyReadyReply: function() {</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineplus">+  NotifyComposeBodyReadyReply() {</span>
<a href="#l3.326"></a><span id="l3.326">     // Control insertion of line breaks.</span>
<a href="#l3.327"></a><span id="l3.327">     let useParagraph = Services.prefs.getBoolPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l3.328"></a><span id="l3.328">     if (gMsgCompose.composeHTML &amp;&amp; useParagraph) {</span>
<a href="#l3.329"></a><span id="l3.329">       let mailBody = getBrowser().contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l3.330"></a><span id="l3.330">       let editor = GetCurrentEditor();</span>
<a href="#l3.331"></a><span id="l3.331">       let selection = editor.selection;</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">       // Make sure the selection isn't inside the signature.</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineat">@@ -488,17 +469,17 @@ var stateListener = {</span>
<a href="#l3.335"></a><span id="l3.335"> </span>
<a href="#l3.336"></a><span id="l3.336">       editor.enableUndo(true);</span>
<a href="#l3.337"></a><span id="l3.337">       editor.resetModificationCount();</span>
<a href="#l3.338"></a><span id="l3.338">     } else {</span>
<a href="#l3.339"></a><span id="l3.339">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l3.340"></a><span id="l3.340">     }</span>
<a href="#l3.341"></a><span id="l3.341">   },</span>
<a href="#l3.342"></a><span id="l3.342"> </span>
<a href="#l3.343"></a><span id="l3.343" class="difflineminus">-  NotifyComposeBodyReadyForwardInline: function() {</span>
<a href="#l3.344"></a><span id="l3.344" class="difflineplus">+  NotifyComposeBodyReadyForwardInline() {</span>
<a href="#l3.345"></a><span id="l3.345">     let mailBody = getBrowser().contentDocument.querySelector(&quot;body&quot;);</span>
<a href="#l3.346"></a><span id="l3.346">     let editor = GetCurrentEditor();</span>
<a href="#l3.347"></a><span id="l3.347">     let selection = editor.selection;</span>
<a href="#l3.348"></a><span id="l3.348"> </span>
<a href="#l3.349"></a><span id="l3.349">     editor.enableUndo(false);</span>
<a href="#l3.350"></a><span id="l3.350"> </span>
<a href="#l3.351"></a><span id="l3.351">     // Control insertion of line breaks.</span>
<a href="#l3.352"></a><span id="l3.352">     selection.collapse(mailBody, 0);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineat">@@ -517,547 +498,533 @@ var stateListener = {</span>
<a href="#l3.354"></a><span id="l3.354">       document.getElementById(&quot;cmd_paragraphState&quot;).setAttribute(&quot;state&quot;, &quot;&quot;);</span>
<a href="#l3.355"></a><span id="l3.355">     }</span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357">     editor.beginningOfDocument();</span>
<a href="#l3.358"></a><span id="l3.358">     editor.enableUndo(true);</span>
<a href="#l3.359"></a><span id="l3.359">     editor.resetModificationCount();</span>
<a href="#l3.360"></a><span id="l3.360">   },</span>
<a href="#l3.361"></a><span id="l3.361"> </span>
<a href="#l3.362"></a><span id="l3.362" class="difflineminus">-  ComposeProcessDone: function(aResult) {</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+  ComposeProcessDone(aResult) {</span>
<a href="#l3.364"></a><span id="l3.364">     ToggleWindowLock(false);</span>
<a href="#l3.365"></a><span id="l3.365"> </span>
<a href="#l3.366"></a><span id="l3.366" class="difflineminus">-    if (aResult== Cr.NS_OK)</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-    {</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+    if (aResult == Cr.NS_OK) {</span>
<a href="#l3.369"></a><span id="l3.369">       if (!gAutoSaving)</span>
<a href="#l3.370"></a><span id="l3.370">         SetContentAndBodyAsUnmodified();</span>
<a href="#l3.371"></a><span id="l3.371"> </span>
<a href="#l3.372"></a><span id="l3.372" class="difflineminus">-      if (gCloseWindowAfterSave)</span>
<a href="#l3.373"></a><span id="l3.373" class="difflineminus">-      {</span>
<a href="#l3.374"></a><span id="l3.374" class="difflineplus">+      if (gCloseWindowAfterSave) {</span>
<a href="#l3.375"></a><span id="l3.375">         // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l3.376"></a><span id="l3.376">         if (gMsgCompose)</span>
<a href="#l3.377"></a><span id="l3.377">           gMsgCompose.onSendNotPerformed(null, Cr.NS_ERROR_ABORT);</span>
<a href="#l3.378"></a><span id="l3.378"> </span>
<a href="#l3.379"></a><span id="l3.379">         MsgComposeCloseWindow();</span>
<a href="#l3.380"></a><span id="l3.380">       }</span>
<a href="#l3.381"></a><span id="l3.381" class="difflineminus">-    }</span>
<a href="#l3.382"></a><span id="l3.382" class="difflineminus">-    // else if we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l3.383"></a><span id="l3.383" class="difflineminus">-    // as changed, so that we won't lose the changes.</span>
<a href="#l3.384"></a><span id="l3.384" class="difflineminus">-    else if (gAutoSaving)</span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-    {</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineplus">+    } else if (gAutoSaving) {</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+      // If we failed to save, and we're autosaving, need to re-mark the editor</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+      // as changed, so that we won't lose the changes.</span>
<a href="#l3.389"></a><span id="l3.389">       gMsgCompose.bodyModified = true;</span>
<a href="#l3.390"></a><span id="l3.390">       gContentChanged = true;</span>
<a href="#l3.391"></a><span id="l3.391">     }</span>
<a href="#l3.392"></a><span id="l3.392">     gAutoSaving = false;</span>
<a href="#l3.393"></a><span id="l3.393">     gCloseWindowAfterSave = false;</span>
<a href="#l3.394"></a><span id="l3.394">   },</span>
<a href="#l3.395"></a><span id="l3.395"> </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-  SaveInFolderDone: function(folderURI) {</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+  SaveInFolderDone(folderURI) {</span>
<a href="#l3.398"></a><span id="l3.398">     DisplaySaveFolderDlg(folderURI);</span>
<a href="#l3.399"></a><span id="l3.399" class="difflineminus">-  }</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineplus">+  },</span>
<a href="#l3.401"></a><span id="l3.401"> };</span>
<a href="#l3.402"></a><span id="l3.402"> </span>
<a href="#l3.403"></a><span id="l3.403"> var gSendListener = {</span>
<a href="#l3.404"></a><span id="l3.404">   // nsIMsgSendListener</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineminus">-  onStartSending: function (aMsgID, aMsgSize) {},</span>
<a href="#l3.406"></a><span id="l3.406" class="difflineminus">-  onProgress: function (aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l3.407"></a><span id="l3.407" class="difflineminus">-  onStatus: function (aMsgID, aMsg) {},</span>
<a href="#l3.408"></a><span id="l3.408" class="difflineminus">-  onStopSending: function (aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineplus">+  onStartSending(aMsgID, aMsgSize) {},</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+  onProgress(aMsgID, aProgress, aProgressMax) {},</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineplus">+  onStatus(aMsgID, aMsg) {},</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineplus">+  onStopSending(aMsgID, aStatus, aMsg, aReturnFile) {</span>
<a href="#l3.413"></a><span id="l3.413">     if (Components.isSuccessCode(aStatus))</span>
<a href="#l3.414"></a><span id="l3.414">       Services.obs.notifyObservers(null, &quot;mail:composeSendSucceeded&quot;);</span>
<a href="#l3.415"></a><span id="l3.415">   },</span>
<a href="#l3.416"></a><span id="l3.416" class="difflineminus">-  onGetDraftFolderURI: function (aFolderURI) {},</span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-  onSendNotPerformed: function (aMsgID, aStatus) {},</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineplus">+  onGetDraftFolderURI(aFolderURI) {},</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+  onSendNotPerformed(aMsgID, aStatus) {},</span>
<a href="#l3.420"></a><span id="l3.420"> };</span>
<a href="#l3.421"></a><span id="l3.421"> </span>
<a href="#l3.422"></a><span id="l3.422"> // all progress notifications are done through the nsIWebProgressListener implementation...</span>
<a href="#l3.423"></a><span id="l3.423"> var progressListener = {</span>
<a href="#l3.424"></a><span id="l3.424" class="difflineminus">-    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l3.425"></a><span id="l3.425" class="difflineminus">-    {</span>
<a href="#l3.426"></a><span id="l3.426" class="difflineminus">-      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START)</span>
<a href="#l3.427"></a><span id="l3.427" class="difflineminus">-      {</span>
<a href="#l3.428"></a><span id="l3.428" class="difflineminus">-        document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineplus">+    onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_START) {</span>
<a href="#l3.431"></a><span id="l3.431" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).setAttribute(&quot;mode&quot;, &quot;undetermined&quot;);</span>
<a href="#l3.432"></a><span id="l3.432">         document.getElementById(&quot;statusbar-progresspanel&quot;).collapsed = false;</span>
<a href="#l3.433"></a><span id="l3.433">       }</span>
<a href="#l3.434"></a><span id="l3.434"> </span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l3.436"></a><span id="l3.436" class="difflineminus">-      {</span>
<a href="#l3.437"></a><span id="l3.437" class="difflineplus">+      if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l3.438"></a><span id="l3.438">         gSendOperationInProgress = false;</span>
<a href="#l3.439"></a><span id="l3.439">         gSaveOperationInProgress = false;</span>
<a href="#l3.440"></a><span id="l3.440" class="difflineminus">-        document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;normal&quot; );</span>
<a href="#l3.441"></a><span id="l3.441" class="difflineminus">-        document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, 0 );</span>
<a href="#l3.442"></a><span id="l3.442" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).setAttribute(&quot;mode&quot;, &quot;normal&quot;);</span>
<a href="#l3.443"></a><span id="l3.443" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).setAttribute(&quot;value&quot;, 0);</span>
<a href="#l3.444"></a><span id="l3.444">         document.getElementById(&quot;statusbar-progresspanel&quot;).collapsed = true;</span>
<a href="#l3.445"></a><span id="l3.445" class="difflineminus">-        document.getElementById('statusText').setAttribute('label', '');</span>
<a href="#l3.446"></a><span id="l3.446" class="difflineplus">+        document.getElementById(&quot;statusText&quot;).setAttribute(&quot;label&quot;, &quot;&quot;);</span>
<a href="#l3.447"></a><span id="l3.447">       }</span>
<a href="#l3.448"></a><span id="l3.448">     },</span>
<a href="#l3.449"></a><span id="l3.449"> </span>
<a href="#l3.450"></a><span id="l3.450" class="difflineminus">-    onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-    {</span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+    onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l3.453"></a><span id="l3.453">       // Calculate percentage.</span>
<a href="#l3.454"></a><span id="l3.454">       var percent;</span>
<a href="#l3.455"></a><span id="l3.455" class="difflineminus">-      if ( aMaxTotalProgress &gt; 0 )</span>
<a href="#l3.456"></a><span id="l3.456" class="difflineminus">-      {</span>
<a href="#l3.457"></a><span id="l3.457" class="difflineminus">-        percent = Math.round( (aCurTotalProgress*100)/aMaxTotalProgress );</span>
<a href="#l3.458"></a><span id="l3.458" class="difflineminus">-        if ( percent &gt; 100 )</span>
<a href="#l3.459"></a><span id="l3.459" class="difflineplus">+      if (aMaxTotalProgress &gt; 0) {</span>
<a href="#l3.460"></a><span id="l3.460" class="difflineplus">+        percent = Math.round((aCurTotalProgress * 100) / aMaxTotalProgress);</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineplus">+        if (percent &gt; 100)</span>
<a href="#l3.462"></a><span id="l3.462">           percent = 100;</span>
<a href="#l3.463"></a><span id="l3.463"> </span>
<a href="#l3.464"></a><span id="l3.464" class="difflineminus">-        document.getElementById('compose-progressmeter').removeAttribute(&quot;mode&quot;);</span>
<a href="#l3.465"></a><span id="l3.465" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).removeAttribute(&quot;mode&quot;);</span>
<a href="#l3.466"></a><span id="l3.466"> </span>
<a href="#l3.467"></a><span id="l3.467">         // Advance progress meter.</span>
<a href="#l3.468"></a><span id="l3.468" class="difflineminus">-        document.getElementById('compose-progressmeter').setAttribute( &quot;value&quot;, percent );</span>
<a href="#l3.469"></a><span id="l3.469" class="difflineminus">-      }</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineminus">-      else</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineminus">-      {</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).setAttribute(&quot;value&quot;, percent);</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+      } else {</span>
<a href="#l3.474"></a><span id="l3.474">         // Progress meter should be barber-pole in this case.</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineminus">-        document.getElementById('compose-progressmeter').setAttribute( &quot;mode&quot;, &quot;undetermined&quot; );</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+        document.getElementById(&quot;compose-progressmeter&quot;).setAttribute(&quot;mode&quot;, &quot;undetermined&quot;);</span>
<a href="#l3.477"></a><span id="l3.477">       }</span>
<a href="#l3.478"></a><span id="l3.478">     },</span>
<a href="#l3.479"></a><span id="l3.479"> </span>
<a href="#l3.480"></a><span id="l3.480" class="difflineminus">-    onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags)</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineminus">-    {</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+    onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {</span>
<a href="#l3.483"></a><span id="l3.483">       // we can ignore this notification</span>
<a href="#l3.484"></a><span id="l3.484">     },</span>
<a href="#l3.485"></a><span id="l3.485"> </span>
<a href="#l3.486"></a><span id="l3.486" class="difflineminus">-    onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage)</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineminus">-    {</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+    onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l3.489"></a><span id="l3.489">       // Looks like it's possible that we get call while the document has been already delete!</span>
<a href="#l3.490"></a><span id="l3.490">       // therefore we need to protect ourself by using try/catch</span>
<a href="#l3.491"></a><span id="l3.491">       try {</span>
<a href="#l3.492"></a><span id="l3.492">         let statusText = document.getElementById(&quot;statusText&quot;);</span>
<a href="#l3.493"></a><span id="l3.493">         if (statusText)</span>
<a href="#l3.494"></a><span id="l3.494">           statusText.setAttribute(&quot;label&quot;, aMessage);</span>
<a href="#l3.495"></a><span id="l3.495">       } catch (ex) {}</span>
<a href="#l3.496"></a><span id="l3.496">     },</span>
<a href="#l3.497"></a><span id="l3.497"> </span>
<a href="#l3.498"></a><span id="l3.498" class="difflineminus">-    onSecurityChange: function(aWebProgress, aRequest, state)</span>
<a href="#l3.499"></a><span id="l3.499" class="difflineminus">-    {</span>
<a href="#l3.500"></a><span id="l3.500" class="difflineplus">+    onSecurityChange(aWebProgress, aRequest, state) {</span>
<a href="#l3.501"></a><span id="l3.501">       // we can ignore this notification</span>
<a href="#l3.502"></a><span id="l3.502">     },</span>
<a href="#l3.503"></a><span id="l3.503"> </span>
<a href="#l3.504"></a><span id="l3.504">     QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l3.505"></a><span id="l3.505">                                             &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l3.506"></a><span id="l3.506"> };</span>
<a href="#l3.507"></a><span id="l3.507"> </span>
<a href="#l3.508"></a><span id="l3.508"> var defaultController = {</span>
<a href="#l3.509"></a><span id="l3.509">   commands: {</span>
<a href="#l3.510"></a><span id="l3.510">     cmd_attachFile: {</span>
<a href="#l3.511"></a><span id="l3.511" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.512"></a><span id="l3.512" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.513"></a><span id="l3.513">         return !gWindowLocked;</span>
<a href="#l3.514"></a><span id="l3.514">       },</span>
<a href="#l3.515"></a><span id="l3.515" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.516"></a><span id="l3.516" class="difflineplus">+      doCommand() {</span>
<a href="#l3.517"></a><span id="l3.517">         AttachFile();</span>
<a href="#l3.518"></a><span id="l3.518" class="difflineminus">-      }</span>
<a href="#l3.519"></a><span id="l3.519" class="difflineplus">+      },</span>
<a href="#l3.520"></a><span id="l3.520">     },</span>
<a href="#l3.521"></a><span id="l3.521"> </span>
<a href="#l3.522"></a><span id="l3.522">     cmd_attachCloud: {</span>
<a href="#l3.523"></a><span id="l3.523" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.524"></a><span id="l3.524" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.525"></a><span id="l3.525">         // Hide the command entirely if there are no cloud accounts or</span>
<a href="#l3.526"></a><span id="l3.526">         // the feature is disbled.</span>
<a href="#l3.527"></a><span id="l3.527">         let cmd = document.getElementById(&quot;cmd_attachCloud&quot;);</span>
<a href="#l3.528"></a><span id="l3.528">         cmd.hidden = !Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l3.529"></a><span id="l3.529">                      (cloudFileAccounts.accounts.length == 0) ||</span>
<a href="#l3.530"></a><span id="l3.530">                      Services.io.offline;</span>
<a href="#l3.531"></a><span id="l3.531">         return !cmd.hidden &amp;&amp; !gWindowLocked;</span>
<a href="#l3.532"></a><span id="l3.532">       },</span>
<a href="#l3.533"></a><span id="l3.533" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.534"></a><span id="l3.534" class="difflineplus">+      doCommand() {</span>
<a href="#l3.535"></a><span id="l3.535">         // We should never actually call this, since the &lt;command&gt; node calls</span>
<a href="#l3.536"></a><span id="l3.536">         // a different function.</span>
<a href="#l3.537"></a><span id="l3.537" class="difflineminus">-      }</span>
<a href="#l3.538"></a><span id="l3.538" class="difflineplus">+      },</span>
<a href="#l3.539"></a><span id="l3.539">     },</span>
<a href="#l3.540"></a><span id="l3.540"> </span>
<a href="#l3.541"></a><span id="l3.541">     cmd_attachPage: {</span>
<a href="#l3.542"></a><span id="l3.542" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.543"></a><span id="l3.543" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.544"></a><span id="l3.544">         return !gWindowLocked;</span>
<a href="#l3.545"></a><span id="l3.545">       },</span>
<a href="#l3.546"></a><span id="l3.546" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.547"></a><span id="l3.547" class="difflineplus">+      doCommand() {</span>
<a href="#l3.548"></a><span id="l3.548">         AttachPage();</span>
<a href="#l3.549"></a><span id="l3.549" class="difflineminus">-      }</span>
<a href="#l3.550"></a><span id="l3.550" class="difflineplus">+      },</span>
<a href="#l3.551"></a><span id="l3.551">     },</span>
<a href="#l3.552"></a><span id="l3.552"> </span>
<a href="#l3.553"></a><span id="l3.553">     cmd_toggleAttachmentPane: {</span>
<a href="#l3.554"></a><span id="l3.554" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.555"></a><span id="l3.555" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.556"></a><span id="l3.556">         let cmdToggleAttachmentPane =</span>
<a href="#l3.557"></a><span id="l3.557">           document.getElementById(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.558"></a><span id="l3.558">         let paneShown = !document.getElementById(&quot;attachments-box&quot;).collapsed;</span>
<a href="#l3.559"></a><span id="l3.559">         cmdToggleAttachmentPane.setAttribute(&quot;checked&quot;, paneShown);</span>
<a href="#l3.560"></a><span id="l3.560"> </span>
<a href="#l3.561"></a><span id="l3.561">         // Enable this command when the compose window isn't locked.</span>
<a href="#l3.562"></a><span id="l3.562">         return !gWindowLocked;</span>
<a href="#l3.563"></a><span id="l3.563">       },</span>
<a href="#l3.564"></a><span id="l3.564" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.565"></a><span id="l3.565" class="difflineplus">+      doCommand() {</span>
<a href="#l3.566"></a><span id="l3.566">         toggleAttachmentPane();</span>
<a href="#l3.567"></a><span id="l3.567" class="difflineminus">-      }</span>
<a href="#l3.568"></a><span id="l3.568" class="difflineplus">+      },</span>
<a href="#l3.569"></a><span id="l3.569">     },</span>
<a href="#l3.570"></a><span id="l3.570"> </span>
<a href="#l3.571"></a><span id="l3.571">     cmd_reorderAttachments: {</span>
<a href="#l3.572"></a><span id="l3.572" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.573"></a><span id="l3.573" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.574"></a><span id="l3.574">         if (attachmentsCount() == 0) {</span>
<a href="#l3.575"></a><span id="l3.575">           let reorderAttachmentsPanel =</span>
<a href="#l3.576"></a><span id="l3.576">             document.getElementById(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l3.577"></a><span id="l3.577">           if (reorderAttachmentsPanel.state == &quot;open&quot;) {</span>
<a href="#l3.578"></a><span id="l3.578">             // When the panel is open and all attachments get deleted,</span>
<a href="#l3.579"></a><span id="l3.579">             // we get notified here and want to close the panel.</span>
<a href="#l3.580"></a><span id="l3.580">             reorderAttachmentsPanel.hidePopup();</span>
<a href="#l3.581"></a><span id="l3.581">           }</span>
<a href="#l3.582"></a><span id="l3.582">         }</span>
<a href="#l3.583"></a><span id="l3.583">         return (attachmentsCount() &gt; 1);</span>
<a href="#l3.584"></a><span id="l3.584">       },</span>
<a href="#l3.585"></a><span id="l3.585" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.586"></a><span id="l3.586" class="difflineplus">+      doCommand() {</span>
<a href="#l3.587"></a><span id="l3.587">         showReorderAttachmentsPanel();</span>
<a href="#l3.588"></a><span id="l3.588" class="difflineminus">-      }</span>
<a href="#l3.589"></a><span id="l3.589" class="difflineplus">+      },</span>
<a href="#l3.590"></a><span id="l3.590">     },</span>
<a href="#l3.591"></a><span id="l3.591"> </span>
<a href="#l3.592"></a><span id="l3.592">     cmd_removeAllAttachments: {</span>
<a href="#l3.593"></a><span id="l3.593" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.594"></a><span id="l3.594" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.595"></a><span id="l3.595">         return !gWindowLocked &amp;&amp; attachmentsCount() &gt; 0;</span>
<a href="#l3.596"></a><span id="l3.596">       },</span>
<a href="#l3.597"></a><span id="l3.597" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.598"></a><span id="l3.598" class="difflineplus">+      doCommand() {</span>
<a href="#l3.599"></a><span id="l3.599">         RemoveAllAttachments();</span>
<a href="#l3.600"></a><span id="l3.600" class="difflineminus">-      }</span>
<a href="#l3.601"></a><span id="l3.601" class="difflineplus">+      },</span>
<a href="#l3.602"></a><span id="l3.602">     },</span>
<a href="#l3.603"></a><span id="l3.603"> </span>
<a href="#l3.604"></a><span id="l3.604">     cmd_close: {</span>
<a href="#l3.605"></a><span id="l3.605" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.606"></a><span id="l3.606" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.607"></a><span id="l3.607">         return !gWindowLocked;</span>
<a href="#l3.608"></a><span id="l3.608">       },</span>
<a href="#l3.609"></a><span id="l3.609" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.610"></a><span id="l3.610" class="difflineplus">+      doCommand() {</span>
<a href="#l3.611"></a><span id="l3.611">         DoCommandClose();</span>
<a href="#l3.612"></a><span id="l3.612" class="difflineminus">-      }</span>
<a href="#l3.613"></a><span id="l3.613" class="difflineplus">+      },</span>
<a href="#l3.614"></a><span id="l3.614">     },</span>
<a href="#l3.615"></a><span id="l3.615"> </span>
<a href="#l3.616"></a><span id="l3.616">     cmd_saveDefault: {</span>
<a href="#l3.617"></a><span id="l3.617" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.618"></a><span id="l3.618" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.619"></a><span id="l3.619">         return !gWindowLocked;</span>
<a href="#l3.620"></a><span id="l3.620">       },</span>
<a href="#l3.621"></a><span id="l3.621" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.622"></a><span id="l3.622" class="difflineplus">+      doCommand() {</span>
<a href="#l3.623"></a><span id="l3.623">         Save();</span>
<a href="#l3.624"></a><span id="l3.624" class="difflineminus">-      }</span>
<a href="#l3.625"></a><span id="l3.625" class="difflineplus">+      },</span>
<a href="#l3.626"></a><span id="l3.626">     },</span>
<a href="#l3.627"></a><span id="l3.627"> </span>
<a href="#l3.628"></a><span id="l3.628">     cmd_saveAsFile: {</span>
<a href="#l3.629"></a><span id="l3.629" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.630"></a><span id="l3.630" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.631"></a><span id="l3.631">         return !gWindowLocked;</span>
<a href="#l3.632"></a><span id="l3.632">       },</span>
<a href="#l3.633"></a><span id="l3.633" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.634"></a><span id="l3.634" class="difflineplus">+      doCommand() {</span>
<a href="#l3.635"></a><span id="l3.635">         SaveAsFile(true);</span>
<a href="#l3.636"></a><span id="l3.636" class="difflineminus">-      }</span>
<a href="#l3.637"></a><span id="l3.637" class="difflineplus">+      },</span>
<a href="#l3.638"></a><span id="l3.638">     },</span>
<a href="#l3.639"></a><span id="l3.639"> </span>
<a href="#l3.640"></a><span id="l3.640">     cmd_saveAsDraft: {</span>
<a href="#l3.641"></a><span id="l3.641" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.642"></a><span id="l3.642" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.643"></a><span id="l3.643">         return !gWindowLocked;</span>
<a href="#l3.644"></a><span id="l3.644">       },</span>
<a href="#l3.645"></a><span id="l3.645" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.646"></a><span id="l3.646" class="difflineplus">+      doCommand() {</span>
<a href="#l3.647"></a><span id="l3.647">         SaveAsDraft();</span>
<a href="#l3.648"></a><span id="l3.648" class="difflineminus">-      }</span>
<a href="#l3.649"></a><span id="l3.649" class="difflineplus">+      },</span>
<a href="#l3.650"></a><span id="l3.650">     },</span>
<a href="#l3.651"></a><span id="l3.651"> </span>
<a href="#l3.652"></a><span id="l3.652">     cmd_saveAsTemplate: {</span>
<a href="#l3.653"></a><span id="l3.653" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.654"></a><span id="l3.654" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.655"></a><span id="l3.655">         return !gWindowLocked;</span>
<a href="#l3.656"></a><span id="l3.656">       },</span>
<a href="#l3.657"></a><span id="l3.657" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.658"></a><span id="l3.658" class="difflineplus">+      doCommand() {</span>
<a href="#l3.659"></a><span id="l3.659">         SaveAsTemplate();</span>
<a href="#l3.660"></a><span id="l3.660" class="difflineminus">-      }</span>
<a href="#l3.661"></a><span id="l3.661" class="difflineplus">+      },</span>
<a href="#l3.662"></a><span id="l3.662">     },</span>
<a href="#l3.663"></a><span id="l3.663"> </span>
<a href="#l3.664"></a><span id="l3.664">     cmd_sendButton: {</span>
<a href="#l3.665"></a><span id="l3.665" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.666"></a><span id="l3.666" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.667"></a><span id="l3.667">         return !gWindowLocked &amp;&amp; !gNumUploadingAttachments &amp;&amp; !gSendLocked;</span>
<a href="#l3.668"></a><span id="l3.668">       },</span>
<a href="#l3.669"></a><span id="l3.669" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.670"></a><span id="l3.670" class="difflineplus">+      doCommand() {</span>
<a href="#l3.671"></a><span id="l3.671">         if (Services.io.offline)</span>
<a href="#l3.672"></a><span id="l3.672">           SendMessageLater();</span>
<a href="#l3.673"></a><span id="l3.673">         else</span>
<a href="#l3.674"></a><span id="l3.674">           SendMessage();</span>
<a href="#l3.675"></a><span id="l3.675" class="difflineminus">-      }</span>
<a href="#l3.676"></a><span id="l3.676" class="difflineplus">+      },</span>
<a href="#l3.677"></a><span id="l3.677">     },</span>
<a href="#l3.678"></a><span id="l3.678"> </span>
<a href="#l3.679"></a><span id="l3.679">     cmd_sendNow: {</span>
<a href="#l3.680"></a><span id="l3.680" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.681"></a><span id="l3.681" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.682"></a><span id="l3.682">         return !gWindowLocked &amp;&amp; !Services.io.offline &amp;&amp; !gSendLocked &amp;&amp;</span>
<a href="#l3.683"></a><span id="l3.683">                !gNumUploadingAttachments;</span>
<a href="#l3.684"></a><span id="l3.684">       },</span>
<a href="#l3.685"></a><span id="l3.685" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.686"></a><span id="l3.686" class="difflineplus">+      doCommand() {</span>
<a href="#l3.687"></a><span id="l3.687">         SendMessage();</span>
<a href="#l3.688"></a><span id="l3.688" class="difflineminus">-      }</span>
<a href="#l3.689"></a><span id="l3.689" class="difflineplus">+      },</span>
<a href="#l3.690"></a><span id="l3.690">     },</span>
<a href="#l3.691"></a><span id="l3.691"> </span>
<a href="#l3.692"></a><span id="l3.692">     cmd_sendLater: {</span>
<a href="#l3.693"></a><span id="l3.693" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.694"></a><span id="l3.694" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.695"></a><span id="l3.695">         return !gWindowLocked &amp;&amp; !gNumUploadingAttachments &amp;&amp; !gSendLocked;</span>
<a href="#l3.696"></a><span id="l3.696">       },</span>
<a href="#l3.697"></a><span id="l3.697" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.698"></a><span id="l3.698" class="difflineplus">+      doCommand() {</span>
<a href="#l3.699"></a><span id="l3.699">         SendMessageLater();</span>
<a href="#l3.700"></a><span id="l3.700" class="difflineminus">-      }</span>
<a href="#l3.701"></a><span id="l3.701" class="difflineplus">+      },</span>
<a href="#l3.702"></a><span id="l3.702">     },</span>
<a href="#l3.703"></a><span id="l3.703"> </span>
<a href="#l3.704"></a><span id="l3.704">     cmd_sendWithCheck: {</span>
<a href="#l3.705"></a><span id="l3.705" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.706"></a><span id="l3.706" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.707"></a><span id="l3.707">         return !gWindowLocked &amp;&amp; !gNumUploadingAttachments &amp;&amp; !gSendLocked;</span>
<a href="#l3.708"></a><span id="l3.708">       },</span>
<a href="#l3.709"></a><span id="l3.709" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.710"></a><span id="l3.710" class="difflineplus">+      doCommand() {</span>
<a href="#l3.711"></a><span id="l3.711">         SendMessageWithCheck();</span>
<a href="#l3.712"></a><span id="l3.712" class="difflineminus">-      }</span>
<a href="#l3.713"></a><span id="l3.713" class="difflineplus">+      },</span>
<a href="#l3.714"></a><span id="l3.714">     },</span>
<a href="#l3.715"></a><span id="l3.715"> </span>
<a href="#l3.716"></a><span id="l3.716">     cmd_printSetup: {</span>
<a href="#l3.717"></a><span id="l3.717" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.718"></a><span id="l3.718" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.719"></a><span id="l3.719">         return !gWindowLocked;</span>
<a href="#l3.720"></a><span id="l3.720">       },</span>
<a href="#l3.721"></a><span id="l3.721" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.722"></a><span id="l3.722" class="difflineplus">+      doCommand() {</span>
<a href="#l3.723"></a><span id="l3.723">         PrintUtils.showPageSetup();</span>
<a href="#l3.724"></a><span id="l3.724" class="difflineminus">-      }</span>
<a href="#l3.725"></a><span id="l3.725" class="difflineplus">+      },</span>
<a href="#l3.726"></a><span id="l3.726">     },</span>
<a href="#l3.727"></a><span id="l3.727"> </span>
<a href="#l3.728"></a><span id="l3.728">     cmd_print: {</span>
<a href="#l3.729"></a><span id="l3.729" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.730"></a><span id="l3.730" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.731"></a><span id="l3.731">         return !gWindowLocked;</span>
<a href="#l3.732"></a><span id="l3.732">       },</span>
<a href="#l3.733"></a><span id="l3.733" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.734"></a><span id="l3.734" class="difflineplus">+      doCommand() {</span>
<a href="#l3.735"></a><span id="l3.735">         DoCommandPrint();</span>
<a href="#l3.736"></a><span id="l3.736" class="difflineminus">-      }</span>
<a href="#l3.737"></a><span id="l3.737" class="difflineplus">+      },</span>
<a href="#l3.738"></a><span id="l3.738">     },</span>
<a href="#l3.739"></a><span id="l3.739"> </span>
<a href="#l3.740"></a><span id="l3.740">     cmd_printPreview: {</span>
<a href="#l3.741"></a><span id="l3.741" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.742"></a><span id="l3.742" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.743"></a><span id="l3.743">         return !gWindowLocked;</span>
<a href="#l3.744"></a><span id="l3.744">       },</span>
<a href="#l3.745"></a><span id="l3.745" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.746"></a><span id="l3.746" class="difflineplus">+      doCommand() {</span>
<a href="#l3.747"></a><span id="l3.747">         DoCommandPrintPreview();</span>
<a href="#l3.748"></a><span id="l3.748" class="difflineminus">-      }</span>
<a href="#l3.749"></a><span id="l3.749" class="difflineplus">+      },</span>
<a href="#l3.750"></a><span id="l3.750">     },</span>
<a href="#l3.751"></a><span id="l3.751"> </span>
<a href="#l3.752"></a><span id="l3.752">     cmd_delete: {</span>
<a href="#l3.753"></a><span id="l3.753" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.754"></a><span id="l3.754" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.755"></a><span id="l3.755">         let cmdDelete = document.getElementById(&quot;cmd_delete&quot;);</span>
<a href="#l3.756"></a><span id="l3.756">         let textValue = cmdDelete.getAttribute(&quot;valueDefault&quot;);</span>
<a href="#l3.757"></a><span id="l3.757">         let accesskeyValue = cmdDelete.getAttribute(&quot;valueDefaultAccessKey&quot;);</span>
<a href="#l3.758"></a><span id="l3.758"> </span>
<a href="#l3.759"></a><span id="l3.759">         cmdDelete.setAttribute(&quot;label&quot;, textValue);</span>
<a href="#l3.760"></a><span id="l3.760">         cmdDelete.setAttribute(&quot;accesskey&quot;, accesskeyValue);</span>
<a href="#l3.761"></a><span id="l3.761"> </span>
<a href="#l3.762"></a><span id="l3.762">         return false;</span>
<a href="#l3.763"></a><span id="l3.763">       },</span>
<a href="#l3.764"></a><span id="l3.764" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.765"></a><span id="l3.765" class="difflineminus">-      }</span>
<a href="#l3.766"></a><span id="l3.766" class="difflineplus">+      doCommand() {</span>
<a href="#l3.767"></a><span id="l3.767" class="difflineplus">+      },</span>
<a href="#l3.768"></a><span id="l3.768">     },</span>
<a href="#l3.769"></a><span id="l3.769"> </span>
<a href="#l3.770"></a><span id="l3.770">     cmd_account: {</span>
<a href="#l3.771"></a><span id="l3.771" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.772"></a><span id="l3.772" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.773"></a><span id="l3.773">         return true;</span>
<a href="#l3.774"></a><span id="l3.774">       },</span>
<a href="#l3.775"></a><span id="l3.775" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.776"></a><span id="l3.776" class="difflineplus">+      doCommand() {</span>
<a href="#l3.777"></a><span id="l3.777">         let currentAccountKey = getCurrentAccountKey();</span>
<a href="#l3.778"></a><span id="l3.778">         let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l3.779"></a><span id="l3.779">         MsgAccountManager(null, account.incomingServer);</span>
<a href="#l3.780"></a><span id="l3.780" class="difflineminus">-      }</span>
<a href="#l3.781"></a><span id="l3.781" class="difflineplus">+      },</span>
<a href="#l3.782"></a><span id="l3.782">     },</span>
<a href="#l3.783"></a><span id="l3.783"> </span>
<a href="#l3.784"></a><span id="l3.784">     cmd_showFormatToolbar: {</span>
<a href="#l3.785"></a><span id="l3.785" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.786"></a><span id="l3.786" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.787"></a><span id="l3.787">         return gMsgCompose &amp;&amp; gMsgCompose.composeHTML;</span>
<a href="#l3.788"></a><span id="l3.788">       },</span>
<a href="#l3.789"></a><span id="l3.789" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.790"></a><span id="l3.790" class="difflineplus">+      doCommand() {</span>
<a href="#l3.791"></a><span id="l3.791">         goToggleToolbar(&quot;FormatToolbar&quot;, &quot;menu_showFormatToolbar&quot;);</span>
<a href="#l3.792"></a><span id="l3.792" class="difflineminus">-      }</span>
<a href="#l3.793"></a><span id="l3.793" class="difflineplus">+      },</span>
<a href="#l3.794"></a><span id="l3.794">     },</span>
<a href="#l3.795"></a><span id="l3.795"> </span>
<a href="#l3.796"></a><span id="l3.796">     cmd_quoteMessage: {</span>
<a href="#l3.797"></a><span id="l3.797" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.798"></a><span id="l3.798" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.799"></a><span id="l3.799">         let selectedURIs = GetSelectedMessages();</span>
<a href="#l3.800"></a><span id="l3.800" class="difflineminus">-        return (selectedURIs &amp;&amp; selectedURIs.length &gt; 0)</span>
<a href="#l3.801"></a><span id="l3.801" class="difflineplus">+        return (selectedURIs &amp;&amp; selectedURIs.length &gt; 0);</span>
<a href="#l3.802"></a><span id="l3.802">       },</span>
<a href="#l3.803"></a><span id="l3.803" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.804"></a><span id="l3.804" class="difflineplus">+      doCommand() {</span>
<a href="#l3.805"></a><span id="l3.805">         QuoteSelectedMessage();</span>
<a href="#l3.806"></a><span id="l3.806" class="difflineminus">-      }</span>
<a href="#l3.807"></a><span id="l3.807" class="difflineplus">+      },</span>
<a href="#l3.808"></a><span id="l3.808">     },</span>
<a href="#l3.809"></a><span id="l3.809"> </span>
<a href="#l3.810"></a><span id="l3.810">     cmd_fullZoomReduce: {</span>
<a href="#l3.811"></a><span id="l3.811" class="difflineminus">-      isEnabled: function () {</span>
<a href="#l3.812"></a><span id="l3.812" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.813"></a><span id="l3.813">         return true;</span>
<a href="#l3.814"></a><span id="l3.814">       },</span>
<a href="#l3.815"></a><span id="l3.815" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.816"></a><span id="l3.816" class="difflineplus">+      doCommand() {</span>
<a href="#l3.817"></a><span id="l3.817">         ZoomManager.reduce();</span>
<a href="#l3.818"></a><span id="l3.818" class="difflineminus">-      }</span>
<a href="#l3.819"></a><span id="l3.819" class="difflineplus">+      },</span>
<a href="#l3.820"></a><span id="l3.820">     },</span>
<a href="#l3.821"></a><span id="l3.821"> </span>
<a href="#l3.822"></a><span id="l3.822">     cmd_fullZoomEnlarge: {</span>
<a href="#l3.823"></a><span id="l3.823" class="difflineminus">-      isEnabled: function () {</span>
<a href="#l3.824"></a><span id="l3.824" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.825"></a><span id="l3.825">         return true;</span>
<a href="#l3.826"></a><span id="l3.826">       },</span>
<a href="#l3.827"></a><span id="l3.827" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.828"></a><span id="l3.828" class="difflineplus">+      doCommand() {</span>
<a href="#l3.829"></a><span id="l3.829">         ZoomManager.enlarge();</span>
<a href="#l3.830"></a><span id="l3.830" class="difflineminus">-      }</span>
<a href="#l3.831"></a><span id="l3.831" class="difflineplus">+      },</span>
<a href="#l3.832"></a><span id="l3.832">     },</span>
<a href="#l3.833"></a><span id="l3.833"> </span>
<a href="#l3.834"></a><span id="l3.834">     cmd_fullZoomReset: {</span>
<a href="#l3.835"></a><span id="l3.835" class="difflineminus">-      isEnabled: function () {</span>
<a href="#l3.836"></a><span id="l3.836" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.837"></a><span id="l3.837">         return true;</span>
<a href="#l3.838"></a><span id="l3.838">       },</span>
<a href="#l3.839"></a><span id="l3.839" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.840"></a><span id="l3.840" class="difflineplus">+      doCommand() {</span>
<a href="#l3.841"></a><span id="l3.841">         ZoomManager.reset();</span>
<a href="#l3.842"></a><span id="l3.842" class="difflineminus">-      }</span>
<a href="#l3.843"></a><span id="l3.843" class="difflineplus">+      },</span>
<a href="#l3.844"></a><span id="l3.844">     },</span>
<a href="#l3.845"></a><span id="l3.845"> </span>
<a href="#l3.846"></a><span id="l3.846">     cmd_spelling: {</span>
<a href="#l3.847"></a><span id="l3.847" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.848"></a><span id="l3.848" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.849"></a><span id="l3.849">         return true;</span>
<a href="#l3.850"></a><span id="l3.850">       },</span>
<a href="#l3.851"></a><span id="l3.851" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.852"></a><span id="l3.852" class="difflineplus">+      doCommand() {</span>
<a href="#l3.853"></a><span id="l3.853">         window.cancelSendMessage = false;</span>
<a href="#l3.854"></a><span id="l3.854">         var skipBlockQuotes =</span>
<a href="#l3.855"></a><span id="l3.855">           (window.document.documentElement.getAttribute(&quot;windowtype&quot;) ==</span>
<a href="#l3.856"></a><span id="l3.856">           &quot;msgcompose&quot;);</span>
<a href="#l3.857"></a><span id="l3.857">         window.openDialog(&quot;chrome://editor/content/EdSpellCheck.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l3.858"></a><span id="l3.858">                           &quot;dialog,close,titlebar,modal,resizable&quot;,</span>
<a href="#l3.859"></a><span id="l3.859">                           false, skipBlockQuotes, true);</span>
<a href="#l3.860"></a><span id="l3.860" class="difflineminus">-      }</span>
<a href="#l3.861"></a><span id="l3.861" class="difflineplus">+      },</span>
<a href="#l3.862"></a><span id="l3.862">     },</span>
<a href="#l3.863"></a><span id="l3.863"> </span>
<a href="#l3.864"></a><span id="l3.864">     cmd_fullZoomToggle: {</span>
<a href="#l3.865"></a><span id="l3.865" class="difflineminus">-      isEnabled: function () {</span>
<a href="#l3.866"></a><span id="l3.866" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.867"></a><span id="l3.867">         return true;</span>
<a href="#l3.868"></a><span id="l3.868">       },</span>
<a href="#l3.869"></a><span id="l3.869" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.870"></a><span id="l3.870" class="difflineplus">+      doCommand() {</span>
<a href="#l3.871"></a><span id="l3.871">         ZoomManager.toggleZoom();</span>
<a href="#l3.872"></a><span id="l3.872" class="difflineminus">-      }</span>
<a href="#l3.873"></a><span id="l3.873" class="difflineplus">+      },</span>
<a href="#l3.874"></a><span id="l3.874">     },</span>
<a href="#l3.875"></a><span id="l3.875">   },</span>
<a href="#l3.876"></a><span id="l3.876"> </span>
<a href="#l3.877"></a><span id="l3.877" class="difflineminus">-  supportsCommand: function(aCommand) {</span>
<a href="#l3.878"></a><span id="l3.878" class="difflineplus">+  supportsCommand(aCommand) {</span>
<a href="#l3.879"></a><span id="l3.879">     return (aCommand in this.commands);</span>
<a href="#l3.880"></a><span id="l3.880">   },</span>
<a href="#l3.881"></a><span id="l3.881"> </span>
<a href="#l3.882"></a><span id="l3.882" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l3.883"></a><span id="l3.883" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l3.884"></a><span id="l3.884">     if (!this.supportsCommand(aCommand))</span>
<a href="#l3.885"></a><span id="l3.885">       return false;</span>
<a href="#l3.886"></a><span id="l3.886">     return this.commands[aCommand].isEnabled();</span>
<a href="#l3.887"></a><span id="l3.887">   },</span>
<a href="#l3.888"></a><span id="l3.888"> </span>
<a href="#l3.889"></a><span id="l3.889" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l3.890"></a><span id="l3.890" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l3.891"></a><span id="l3.891">     if (!this.supportsCommand(aCommand))</span>
<a href="#l3.892"></a><span id="l3.892">       return;</span>
<a href="#l3.893"></a><span id="l3.893">     var cmd = this.commands[aCommand];</span>
<a href="#l3.894"></a><span id="l3.894">     if (!cmd.isEnabled())</span>
<a href="#l3.895"></a><span id="l3.895">       return;</span>
<a href="#l3.896"></a><span id="l3.896">     cmd.doCommand();</span>
<a href="#l3.897"></a><span id="l3.897">   },</span>
<a href="#l3.898"></a><span id="l3.898"> </span>
<a href="#l3.899"></a><span id="l3.899" class="difflineminus">-  onEvent: function(event) {},</span>
<a href="#l3.900"></a><span id="l3.900" class="difflineplus">+  onEvent(event) {},</span>
<a href="#l3.901"></a><span id="l3.901"> };</span>
<a href="#l3.902"></a><span id="l3.902"> </span>
<a href="#l3.903"></a><span id="l3.903"> var attachmentBucketController = {</span>
<a href="#l3.904"></a><span id="l3.904">   commands: {</span>
<a href="#l3.905"></a><span id="l3.905">     cmd_selectAll: {</span>
<a href="#l3.906"></a><span id="l3.906" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.907"></a><span id="l3.907" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.908"></a><span id="l3.908">         return true;</span>
<a href="#l3.909"></a><span id="l3.909">       },</span>
<a href="#l3.910"></a><span id="l3.910" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.911"></a><span id="l3.911" class="difflineplus">+      doCommand() {</span>
<a href="#l3.912"></a><span id="l3.912">         document.getElementById(&quot;attachmentBucket&quot;).selectAll();</span>
<a href="#l3.913"></a><span id="l3.913" class="difflineminus">-      }</span>
<a href="#l3.914"></a><span id="l3.914" class="difflineplus">+      },</span>
<a href="#l3.915"></a><span id="l3.915">     },</span>
<a href="#l3.916"></a><span id="l3.916"> </span>
<a href="#l3.917"></a><span id="l3.917">     cmd_delete: {</span>
<a href="#l3.918"></a><span id="l3.918" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.919"></a><span id="l3.919" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.920"></a><span id="l3.920">         let selectedCount = attachmentsSelectedCount();</span>
<a href="#l3.921"></a><span id="l3.921">         let cmdDelete = document.getElementById(&quot;cmd_delete&quot;);</span>
<a href="#l3.922"></a><span id="l3.922">         let textValue = getComposeBundle().getString(&quot;removeAttachmentMsgs&quot;);</span>
<a href="#l3.923"></a><span id="l3.923">         textValue = PluralForm.get(selectedCount, textValue);</span>
<a href="#l3.924"></a><span id="l3.924">         let accesskeyValue = cmdDelete.getAttribute(&quot;valueRemoveAttachmentAccessKey&quot;);</span>
<a href="#l3.925"></a><span id="l3.925">         cmdDelete.setAttribute(&quot;label&quot;, textValue);</span>
<a href="#l3.926"></a><span id="l3.926">         cmdDelete.setAttribute(&quot;accesskey&quot;, accesskeyValue);</span>
<a href="#l3.927"></a><span id="l3.927"> </span>
<a href="#l3.928"></a><span id="l3.928">         return selectedCount &gt; 0;</span>
<a href="#l3.929"></a><span id="l3.929">       },</span>
<a href="#l3.930"></a><span id="l3.930" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.931"></a><span id="l3.931" class="difflineplus">+      doCommand() {</span>
<a href="#l3.932"></a><span id="l3.932">         RemoveSelectedAttachment();</span>
<a href="#l3.933"></a><span id="l3.933" class="difflineminus">-      }</span>
<a href="#l3.934"></a><span id="l3.934" class="difflineplus">+      },</span>
<a href="#l3.935"></a><span id="l3.935">     },</span>
<a href="#l3.936"></a><span id="l3.936"> </span>
<a href="#l3.937"></a><span id="l3.937">     cmd_openAttachment: {</span>
<a href="#l3.938"></a><span id="l3.938" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.939"></a><span id="l3.939" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.940"></a><span id="l3.940">         return attachmentsSelectedCount() == 1;</span>
<a href="#l3.941"></a><span id="l3.941">       },</span>
<a href="#l3.942"></a><span id="l3.942" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.943"></a><span id="l3.943" class="difflineplus">+      doCommand() {</span>
<a href="#l3.944"></a><span id="l3.944">         OpenSelectedAttachment();</span>
<a href="#l3.945"></a><span id="l3.945" class="difflineminus">-      }</span>
<a href="#l3.946"></a><span id="l3.946" class="difflineplus">+      },</span>
<a href="#l3.947"></a><span id="l3.947">     },</span>
<a href="#l3.948"></a><span id="l3.948"> </span>
<a href="#l3.949"></a><span id="l3.949">     cmd_renameAttachment: {</span>
<a href="#l3.950"></a><span id="l3.950" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.951"></a><span id="l3.951" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.952"></a><span id="l3.952">         return attachmentsSelectedCount() == 1;</span>
<a href="#l3.953"></a><span id="l3.953">       },</span>
<a href="#l3.954"></a><span id="l3.954" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.955"></a><span id="l3.955" class="difflineplus">+      doCommand() {</span>
<a href="#l3.956"></a><span id="l3.956">         RenameSelectedAttachment();</span>
<a href="#l3.957"></a><span id="l3.957" class="difflineminus">-      }</span>
<a href="#l3.958"></a><span id="l3.958" class="difflineplus">+      },</span>
<a href="#l3.959"></a><span id="l3.959">     },</span>
<a href="#l3.960"></a><span id="l3.960"> </span>
<a href="#l3.961"></a><span id="l3.961">     cmd_moveAttachmentUp: {</span>
<a href="#l3.962"></a><span id="l3.962" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.963"></a><span id="l3.963" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.964"></a><span id="l3.964">         return attachmentsSelectedCount() &gt; 0 &amp;&amp;</span>
<a href="#l3.965"></a><span id="l3.965">                !attachmentsSelectionIsBlock(&quot;top&quot;);</span>
<a href="#l3.966"></a><span id="l3.966">       },</span>
<a href="#l3.967"></a><span id="l3.967" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.968"></a><span id="l3.968" class="difflineplus">+      doCommand() {</span>
<a href="#l3.969"></a><span id="l3.969">         moveSelectedAttachments(&quot;up&quot;);</span>
<a href="#l3.970"></a><span id="l3.970" class="difflineminus">-      }</span>
<a href="#l3.971"></a><span id="l3.971" class="difflineplus">+      },</span>
<a href="#l3.972"></a><span id="l3.972">     },</span>
<a href="#l3.973"></a><span id="l3.973"> </span>
<a href="#l3.974"></a><span id="l3.974">     cmd_moveAttachmentDown: {</span>
<a href="#l3.975"></a><span id="l3.975" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.976"></a><span id="l3.976" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.977"></a><span id="l3.977">         return attachmentsSelectedCount() &gt; 0 &amp;&amp;</span>
<a href="#l3.978"></a><span id="l3.978">                !attachmentsSelectionIsBlock(&quot;bottom&quot;);</span>
<a href="#l3.979"></a><span id="l3.979">       },</span>
<a href="#l3.980"></a><span id="l3.980" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.981"></a><span id="l3.981" class="difflineplus">+      doCommand() {</span>
<a href="#l3.982"></a><span id="l3.982">         moveSelectedAttachments(&quot;down&quot;);</span>
<a href="#l3.983"></a><span id="l3.983" class="difflineminus">-      }</span>
<a href="#l3.984"></a><span id="l3.984" class="difflineplus">+      },</span>
<a href="#l3.985"></a><span id="l3.985">     },</span>
<a href="#l3.986"></a><span id="l3.986"> </span>
<a href="#l3.987"></a><span id="l3.987">     cmd_moveAttachmentBundleUp: {</span>
<a href="#l3.988"></a><span id="l3.988" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.989"></a><span id="l3.989" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.990"></a><span id="l3.990">         return attachmentsSelectedCount() &gt; 1 &amp;&amp;</span>
<a href="#l3.991"></a><span id="l3.991">                !attachmentsSelectionIsBlock();</span>
<a href="#l3.992"></a><span id="l3.992">       },</span>
<a href="#l3.993"></a><span id="l3.993" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.994"></a><span id="l3.994" class="difflineplus">+      doCommand() {</span>
<a href="#l3.995"></a><span id="l3.995">         moveSelectedAttachments(&quot;bundleUp&quot;);</span>
<a href="#l3.996"></a><span id="l3.996" class="difflineminus">-      }</span>
<a href="#l3.997"></a><span id="l3.997" class="difflineplus">+      },</span>
<a href="#l3.998"></a><span id="l3.998">     },</span>
<a href="#l3.999"></a><span id="l3.999"> </span>
<a href="#l3.1000"></a><span id="l3.1000">     cmd_moveAttachmentBundleDown: {</span>
<a href="#l3.1001"></a><span id="l3.1001" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1002"></a><span id="l3.1002" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1003"></a><span id="l3.1003">         return attachmentsSelectedCount() &gt; 1 &amp;&amp;</span>
<a href="#l3.1004"></a><span id="l3.1004">                !attachmentsSelectionIsBlock();</span>
<a href="#l3.1005"></a><span id="l3.1005">       },</span>
<a href="#l3.1006"></a><span id="l3.1006" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1007"></a><span id="l3.1007" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1008"></a><span id="l3.1008">         moveSelectedAttachments(&quot;bundleDown&quot;);</span>
<a href="#l3.1009"></a><span id="l3.1009" class="difflineminus">-      }</span>
<a href="#l3.1010"></a><span id="l3.1010" class="difflineplus">+      },</span>
<a href="#l3.1011"></a><span id="l3.1011">     },</span>
<a href="#l3.1012"></a><span id="l3.1012"> </span>
<a href="#l3.1013"></a><span id="l3.1013">     cmd_moveAttachmentTop: {</span>
<a href="#l3.1014"></a><span id="l3.1014" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1015"></a><span id="l3.1015" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1016"></a><span id="l3.1016">         return attachmentsSelectedCount() &gt; 0 &amp;&amp;</span>
<a href="#l3.1017"></a><span id="l3.1017">                !attachmentsSelectionIsBlock(&quot;top&quot;);</span>
<a href="#l3.1018"></a><span id="l3.1018">       },</span>
<a href="#l3.1019"></a><span id="l3.1019" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1020"></a><span id="l3.1020" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1021"></a><span id="l3.1021">         moveSelectedAttachments(&quot;top&quot;);</span>
<a href="#l3.1022"></a><span id="l3.1022" class="difflineminus">-      }</span>
<a href="#l3.1023"></a><span id="l3.1023" class="difflineplus">+      },</span>
<a href="#l3.1024"></a><span id="l3.1024">     },</span>
<a href="#l3.1025"></a><span id="l3.1025"> </span>
<a href="#l3.1026"></a><span id="l3.1026">     cmd_moveAttachmentBottom: {</span>
<a href="#l3.1027"></a><span id="l3.1027" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1028"></a><span id="l3.1028" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1029"></a><span id="l3.1029">         return attachmentsSelectedCount() &gt; 0 &amp;&amp;</span>
<a href="#l3.1030"></a><span id="l3.1030">                !attachmentsSelectionIsBlock(&quot;bottom&quot;);</span>
<a href="#l3.1031"></a><span id="l3.1031">       },</span>
<a href="#l3.1032"></a><span id="l3.1032" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1033"></a><span id="l3.1033" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1034"></a><span id="l3.1034">         moveSelectedAttachments(&quot;bottom&quot;);</span>
<a href="#l3.1035"></a><span id="l3.1035" class="difflineminus">-      }</span>
<a href="#l3.1036"></a><span id="l3.1036" class="difflineplus">+      },</span>
<a href="#l3.1037"></a><span id="l3.1037">     },</span>
<a href="#l3.1038"></a><span id="l3.1038"> </span>
<a href="#l3.1039"></a><span id="l3.1039">     cmd_sortAttachmentsToggle: {</span>
<a href="#l3.1040"></a><span id="l3.1040" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1041"></a><span id="l3.1041" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1042"></a><span id="l3.1042">         let attachmentsSelCount = attachmentsSelectedCount();</span>
<a href="#l3.1043"></a><span id="l3.1043">         let sortSelection;</span>
<a href="#l3.1044"></a><span id="l3.1044">         let currSortOrder;</span>
<a href="#l3.1045"></a><span id="l3.1045">         let isBlock;</span>
<a href="#l3.1046"></a><span id="l3.1046">         let btnAscending;</span>
<a href="#l3.1047"></a><span id="l3.1047">         let toggleCmd = document.getElementById(&quot;cmd_sortAttachmentsToggle&quot;);</span>
<a href="#l3.1048"></a><span id="l3.1048">         let toggleBtn = document.getElementById(&quot;btn_sortAttachmentsToggle&quot;);</span>
<a href="#l3.1049"></a><span id="l3.1049">         let sortDirection;</span>
<a href="#l3.1050"></a><span id="l3.1050" class="difflineat">@@ -1083,17 +1050,17 @@ var attachmentBucketController = {</span>
<a href="#l3.1051"></a><span id="l3.1051">           } else {</span>
<a href="#l3.1052"></a><span id="l3.1052">             sortDirection = &quot;descending&quot;;</span>
<a href="#l3.1053"></a><span id="l3.1053">             btnLabelAttr = &quot;label-selection-ZA&quot;;</span>
<a href="#l3.1054"></a><span id="l3.1054">           }</span>
<a href="#l3.1055"></a><span id="l3.1055">         } else { // attachmentsSelectedCount() &lt;= 1 or all attachments selected</span>
<a href="#l3.1056"></a><span id="l3.1056">           // Sort all attachments.</span>
<a href="#l3.1057"></a><span id="l3.1057">           sortSelection = false;</span>
<a href="#l3.1058"></a><span id="l3.1058">           currSortOrder = attachmentsGetSortOrder();</span>
<a href="#l3.1059"></a><span id="l3.1059" class="difflineminus">-          btnAscending = !(currSortOrder == &quot;ascending&quot;)</span>
<a href="#l3.1060"></a><span id="l3.1060" class="difflineplus">+          btnAscending = !(currSortOrder == &quot;ascending&quot;);</span>
<a href="#l3.1061"></a><span id="l3.1061">           // Set sortDirection for toggleCmd, and respective button face.</span>
<a href="#l3.1062"></a><span id="l3.1062">           if (btnAscending) {</span>
<a href="#l3.1063"></a><span id="l3.1063">             sortDirection = &quot;ascending&quot;;</span>
<a href="#l3.1064"></a><span id="l3.1064">             btnLabelAttr = &quot;label-AZ&quot;;</span>
<a href="#l3.1065"></a><span id="l3.1065">           } else {</span>
<a href="#l3.1066"></a><span id="l3.1066">             sortDirection = &quot;descending&quot;;</span>
<a href="#l3.1067"></a><span id="l3.1067">             btnLabelAttr = &quot;label-ZA&quot;;</span>
<a href="#l3.1068"></a><span id="l3.1068">           }</span>
<a href="#l3.1069"></a><span id="l3.1069" class="difflineat">@@ -1103,23 +1070,23 @@ var attachmentBucketController = {</span>
<a href="#l3.1070"></a><span id="l3.1070">         toggleCmd.setAttribute(&quot;sortdirection&quot;, sortDirection);</span>
<a href="#l3.1071"></a><span id="l3.1071">         // The button's icon is set dynamically via CSS involving the button's</span>
<a href="#l3.1072"></a><span id="l3.1072">         // sortdirection attribute, which is forwarded by the command.</span>
<a href="#l3.1073"></a><span id="l3.1073">         toggleBtn.setAttribute(&quot;label&quot;, toggleBtn.getAttribute(btnLabelAttr));</span>
<a href="#l3.1074"></a><span id="l3.1074"> </span>
<a href="#l3.1075"></a><span id="l3.1075">         return sortSelection ? !(currSortOrder == &quot;equivalent&quot; &amp;&amp; isBlock)</span>
<a href="#l3.1076"></a><span id="l3.1076">                              : !(currSortOrder == &quot;equivalent&quot;);</span>
<a href="#l3.1077"></a><span id="l3.1077">       },</span>
<a href="#l3.1078"></a><span id="l3.1078" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1079"></a><span id="l3.1079" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1080"></a><span id="l3.1080">         moveSelectedAttachments(&quot;toggleSort&quot;);</span>
<a href="#l3.1081"></a><span id="l3.1081" class="difflineminus">-      }</span>
<a href="#l3.1082"></a><span id="l3.1082" class="difflineplus">+      },</span>
<a href="#l3.1083"></a><span id="l3.1083">     },</span>
<a href="#l3.1084"></a><span id="l3.1084"> </span>
<a href="#l3.1085"></a><span id="l3.1085">     cmd_convertCloud: {</span>
<a href="#l3.1086"></a><span id="l3.1086" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1087"></a><span id="l3.1087" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1088"></a><span id="l3.1088">         // Hide the command entirely if Filelink is disabled, or if there are</span>
<a href="#l3.1089"></a><span id="l3.1089">         // no cloud accounts.</span>
<a href="#l3.1090"></a><span id="l3.1090">         let cmd = document.getElementById(&quot;cmd_convertCloud&quot;);</span>
<a href="#l3.1091"></a><span id="l3.1091"> </span>
<a href="#l3.1092"></a><span id="l3.1092">         cmd.hidden = (!Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l3.1093"></a><span id="l3.1093">                       cloudFileAccounts.accounts.length == 0) ||</span>
<a href="#l3.1094"></a><span id="l3.1094">                       Services.io.offline;</span>
<a href="#l3.1095"></a><span id="l3.1095">         if (cmd.hidden)</span>
<a href="#l3.1096"></a><span id="l3.1096" class="difflineat">@@ -1127,41 +1094,41 @@ var attachmentBucketController = {</span>
<a href="#l3.1097"></a><span id="l3.1097"> </span>
<a href="#l3.1098"></a><span id="l3.1098">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1099"></a><span id="l3.1099">         for (let item of bucket.selectedItems) {</span>
<a href="#l3.1100"></a><span id="l3.1100">           if (item.uploading)</span>
<a href="#l3.1101"></a><span id="l3.1101">             return false;</span>
<a href="#l3.1102"></a><span id="l3.1102">         }</span>
<a href="#l3.1103"></a><span id="l3.1103">         return true;</span>
<a href="#l3.1104"></a><span id="l3.1104">       },</span>
<a href="#l3.1105"></a><span id="l3.1105" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1106"></a><span id="l3.1106" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1107"></a><span id="l3.1107">         // We should never actually call this, since the &lt;command&gt; node calls</span>
<a href="#l3.1108"></a><span id="l3.1108">         // a different function.</span>
<a href="#l3.1109"></a><span id="l3.1109" class="difflineminus">-      }</span>
<a href="#l3.1110"></a><span id="l3.1110" class="difflineplus">+      },</span>
<a href="#l3.1111"></a><span id="l3.1111">     },</span>
<a href="#l3.1112"></a><span id="l3.1112"> </span>
<a href="#l3.1113"></a><span id="l3.1113">     cmd_convertAttachment: {</span>
<a href="#l3.1114"></a><span id="l3.1114" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1115"></a><span id="l3.1115" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1116"></a><span id="l3.1116">         if (!Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;))</span>
<a href="#l3.1117"></a><span id="l3.1117">           return false;</span>
<a href="#l3.1118"></a><span id="l3.1118"> </span>
<a href="#l3.1119"></a><span id="l3.1119">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1120"></a><span id="l3.1120">         for (let item of bucket.selectedItems) {</span>
<a href="#l3.1121"></a><span id="l3.1121">           if (item.uploading)</span>
<a href="#l3.1122"></a><span id="l3.1122">             return false;</span>
<a href="#l3.1123"></a><span id="l3.1123">         }</span>
<a href="#l3.1124"></a><span id="l3.1124">         return true;</span>
<a href="#l3.1125"></a><span id="l3.1125">       },</span>
<a href="#l3.1126"></a><span id="l3.1126" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1127"></a><span id="l3.1127" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1128"></a><span id="l3.1128">         convertSelectedToRegularAttachment();</span>
<a href="#l3.1129"></a><span id="l3.1129" class="difflineminus">-      }</span>
<a href="#l3.1130"></a><span id="l3.1130" class="difflineplus">+      },</span>
<a href="#l3.1131"></a><span id="l3.1131">     },</span>
<a href="#l3.1132"></a><span id="l3.1132"> </span>
<a href="#l3.1133"></a><span id="l3.1133">     cmd_cancelUpload: {</span>
<a href="#l3.1134"></a><span id="l3.1134" class="difflineminus">-      isEnabled: function() {</span>
<a href="#l3.1135"></a><span id="l3.1135" class="difflineplus">+      isEnabled() {</span>
<a href="#l3.1136"></a><span id="l3.1136">         let cmd = document.getElementById(&quot;composeAttachmentContext_cancelUploadItem&quot;);</span>
<a href="#l3.1137"></a><span id="l3.1137"> </span>
<a href="#l3.1138"></a><span id="l3.1138">         // If Filelink is disabled, hide this menuitem and bailout.</span>
<a href="#l3.1139"></a><span id="l3.1139">         if (!Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;)) {</span>
<a href="#l3.1140"></a><span id="l3.1140">           cmd.hidden = true;</span>
<a href="#l3.1141"></a><span id="l3.1141">           return false;</span>
<a href="#l3.1142"></a><span id="l3.1142">         }</span>
<a href="#l3.1143"></a><span id="l3.1143"> </span>
<a href="#l3.1144"></a><span id="l3.1144" class="difflineat">@@ -1175,136 +1142,127 @@ var attachmentBucketController = {</span>
<a href="#l3.1145"></a><span id="l3.1145"> </span>
<a href="#l3.1146"></a><span id="l3.1146">         // Hide the command entirely if the selected attachments aren't cloud</span>
<a href="#l3.1147"></a><span id="l3.1147">         // files.</span>
<a href="#l3.1148"></a><span id="l3.1148">         // For some reason, the hidden property isn't propagating from the cmd</span>
<a href="#l3.1149"></a><span id="l3.1149">         // to the menuitem.</span>
<a href="#l3.1150"></a><span id="l3.1150">         cmd.hidden = true;</span>
<a href="#l3.1151"></a><span id="l3.1151">         return false;</span>
<a href="#l3.1152"></a><span id="l3.1152">       },</span>
<a href="#l3.1153"></a><span id="l3.1153" class="difflineminus">-      doCommand: function() {</span>
<a href="#l3.1154"></a><span id="l3.1154" class="difflineplus">+      doCommand() {</span>
<a href="#l3.1155"></a><span id="l3.1155">         let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.1156"></a><span id="l3.1156">                                   .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l3.1157"></a><span id="l3.1157"> </span>
<a href="#l3.1158"></a><span id="l3.1158">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1159"></a><span id="l3.1159">         for (let item of bucket.selectedItems) {</span>
<a href="#l3.1160"></a><span id="l3.1160">           if (item &amp;&amp; item.uploading) {</span>
<a href="#l3.1161"></a><span id="l3.1161">             let file = fileHandler.getFileFromURLSpec(item.attachment.url);</span>
<a href="#l3.1162"></a><span id="l3.1162">             item.cloudProvider.cancelFileUpload(file);</span>
<a href="#l3.1163"></a><span id="l3.1163">           }</span>
<a href="#l3.1164"></a><span id="l3.1164">         }</span>
<a href="#l3.1165"></a><span id="l3.1165">       },</span>
<a href="#l3.1166"></a><span id="l3.1166">     },</span>
<a href="#l3.1167"></a><span id="l3.1167">   },</span>
<a href="#l3.1168"></a><span id="l3.1168"> </span>
<a href="#l3.1169"></a><span id="l3.1169" class="difflineminus">-  supportsCommand: function(aCommand) {</span>
<a href="#l3.1170"></a><span id="l3.1170" class="difflineplus">+  supportsCommand(aCommand) {</span>
<a href="#l3.1171"></a><span id="l3.1171">     return (aCommand in this.commands);</span>
<a href="#l3.1172"></a><span id="l3.1172">   },</span>
<a href="#l3.1173"></a><span id="l3.1173"> </span>
<a href="#l3.1174"></a><span id="l3.1174" class="difflineminus">-  isCommandEnabled: function(aCommand) {</span>
<a href="#l3.1175"></a><span id="l3.1175" class="difflineplus">+  isCommandEnabled(aCommand) {</span>
<a href="#l3.1176"></a><span id="l3.1176">     if (!this.supportsCommand(aCommand))</span>
<a href="#l3.1177"></a><span id="l3.1177">       return false;</span>
<a href="#l3.1178"></a><span id="l3.1178">     return this.commands[aCommand].isEnabled();</span>
<a href="#l3.1179"></a><span id="l3.1179">   },</span>
<a href="#l3.1180"></a><span id="l3.1180"> </span>
<a href="#l3.1181"></a><span id="l3.1181" class="difflineminus">-  doCommand: function(aCommand) {</span>
<a href="#l3.1182"></a><span id="l3.1182" class="difflineplus">+  doCommand(aCommand) {</span>
<a href="#l3.1183"></a><span id="l3.1183">     if (!this.supportsCommand(aCommand))</span>
<a href="#l3.1184"></a><span id="l3.1184">       return;</span>
<a href="#l3.1185"></a><span id="l3.1185">     var cmd = this.commands[aCommand];</span>
<a href="#l3.1186"></a><span id="l3.1186">     if (!cmd.isEnabled())</span>
<a href="#l3.1187"></a><span id="l3.1187">       return;</span>
<a href="#l3.1188"></a><span id="l3.1188">     cmd.doCommand();</span>
<a href="#l3.1189"></a><span id="l3.1189">   },</span>
<a href="#l3.1190"></a><span id="l3.1190"> </span>
<a href="#l3.1191"></a><span id="l3.1191" class="difflineminus">-  onEvent: function(event) {},</span>
<a href="#l3.1192"></a><span id="l3.1192" class="difflineplus">+  onEvent(event) {},</span>
<a href="#l3.1193"></a><span id="l3.1193"> };</span>
<a href="#l3.1194"></a><span id="l3.1194"> </span>
<a href="#l3.1195"></a><span id="l3.1195"> /**</span>
<a href="#l3.1196"></a><span id="l3.1196">  * Start composing a new message.</span>
<a href="#l3.1197"></a><span id="l3.1197">  */</span>
<a href="#l3.1198"></a><span id="l3.1198" class="difflineminus">-function goOpenNewMessage(aEvent)</span>
<a href="#l3.1199"></a><span id="l3.1199" class="difflineminus">-{</span>
<a href="#l3.1200"></a><span id="l3.1200" class="difflineplus">+function goOpenNewMessage(aEvent) {</span>
<a href="#l3.1201"></a><span id="l3.1201">   // If aEvent is passed, check if Shift key was pressed for composition in</span>
<a href="#l3.1202"></a><span id="l3.1202">   // non-default format (HTML vs. plaintext).</span>
<a href="#l3.1203"></a><span id="l3.1203">   let msgCompFormat = (aEvent &amp;&amp; aEvent.shiftKey) ?</span>
<a href="#l3.1204"></a><span id="l3.1204">     Ci.nsIMsgCompFormat.OppositeOfDefault :</span>
<a href="#l3.1205"></a><span id="l3.1205">     Ci.nsIMsgCompFormat.Default;</span>
<a href="#l3.1206"></a><span id="l3.1206"> </span>
<a href="#l3.1207"></a><span id="l3.1207">   let identity = getCurrentIdentity();</span>
<a href="#l3.1208"></a><span id="l3.1208">   MailServices.compose.OpenComposeWindow(null, null, null,</span>
<a href="#l3.1209"></a><span id="l3.1209">     Ci.nsIMsgCompType.New,</span>
<a href="#l3.1210"></a><span id="l3.1210">     msgCompFormat, identity, null);</span>
<a href="#l3.1211"></a><span id="l3.1211"> }</span>
<a href="#l3.1212"></a><span id="l3.1212"> </span>
<a href="#l3.1213"></a><span id="l3.1213" class="difflineminus">-function QuoteSelectedMessage()</span>
<a href="#l3.1214"></a><span id="l3.1214" class="difflineminus">-{</span>
<a href="#l3.1215"></a><span id="l3.1215" class="difflineplus">+function QuoteSelectedMessage() {</span>
<a href="#l3.1216"></a><span id="l3.1216">   var selectedURIs = GetSelectedMessages();</span>
<a href="#l3.1217"></a><span id="l3.1217">   if (selectedURIs)</span>
<a href="#l3.1218"></a><span id="l3.1218">     for (let i = 0; i &lt; selectedURIs.length; i++)</span>
<a href="#l3.1219"></a><span id="l3.1219">       gMsgCompose.quoteMessage(selectedURIs[i]);</span>
<a href="#l3.1220"></a><span id="l3.1220"> }</span>
<a href="#l3.1221"></a><span id="l3.1221"> </span>
<a href="#l3.1222"></a><span id="l3.1222" class="difflineminus">-function GetSelectedMessages()</span>
<a href="#l3.1223"></a><span id="l3.1223" class="difflineminus">-{</span>
<a href="#l3.1224"></a><span id="l3.1224" class="difflineplus">+function GetSelectedMessages() {</span>
<a href="#l3.1225"></a><span id="l3.1225">   let mailWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l3.1226"></a><span id="l3.1226">   return (mailWindow) ? mailWindow.gFolderDisplay.selectedMessageUris : null;</span>
<a href="#l3.1227"></a><span id="l3.1227"> }</span>
<a href="#l3.1228"></a><span id="l3.1228"> </span>
<a href="#l3.1229"></a><span id="l3.1229" class="difflineminus">-function SetupCommandUpdateHandlers()</span>
<a href="#l3.1230"></a><span id="l3.1230" class="difflineminus">-{</span>
<a href="#l3.1231"></a><span id="l3.1231" class="difflineplus">+function SetupCommandUpdateHandlers() {</span>
<a href="#l3.1232"></a><span id="l3.1232">   let attachmentBucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1233"></a><span id="l3.1233"> </span>
<a href="#l3.1234"></a><span id="l3.1234">   top.controllers.appendController(defaultController);</span>
<a href="#l3.1235"></a><span id="l3.1235">   attachmentBucket.controllers.appendController(attachmentBucketController);</span>
<a href="#l3.1236"></a><span id="l3.1236"> </span>
<a href="#l3.1237"></a><span id="l3.1237">   document.getElementById(&quot;optionsMenuPopup&quot;)</span>
<a href="#l3.1238"></a><span id="l3.1238">           .addEventListener(&quot;popupshowing&quot;, updateOptionItems, true);</span>
<a href="#l3.1239"></a><span id="l3.1239"> }</span>
<a href="#l3.1240"></a><span id="l3.1240"> </span>
<a href="#l3.1241"></a><span id="l3.1241" class="difflineminus">-function UnloadCommandUpdateHandlers()</span>
<a href="#l3.1242"></a><span id="l3.1242" class="difflineminus">-{</span>
<a href="#l3.1243"></a><span id="l3.1243" class="difflineplus">+function UnloadCommandUpdateHandlers() {</span>
<a href="#l3.1244"></a><span id="l3.1244">   let attachmentBucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1245"></a><span id="l3.1245"> </span>
<a href="#l3.1246"></a><span id="l3.1246">   document.getElementById(&quot;optionsMenuPopup&quot;)</span>
<a href="#l3.1247"></a><span id="l3.1247">           .removeEventListener(&quot;popupshowing&quot;, updateOptionItems, true);</span>
<a href="#l3.1248"></a><span id="l3.1248"> </span>
<a href="#l3.1249"></a><span id="l3.1249">   attachmentBucket.controllers.removeController(attachmentBucketController);</span>
<a href="#l3.1250"></a><span id="l3.1250">   top.controllers.removeController(defaultController);</span>
<a href="#l3.1251"></a><span id="l3.1251"> }</span>
<a href="#l3.1252"></a><span id="l3.1252"> </span>
<a href="#l3.1253"></a><span id="l3.1253" class="difflineminus">-function CommandUpdate_MsgCompose()</span>
<a href="#l3.1254"></a><span id="l3.1254" class="difflineminus">-{</span>
<a href="#l3.1255"></a><span id="l3.1255" class="difflineplus">+function CommandUpdate_MsgCompose() {</span>
<a href="#l3.1256"></a><span id="l3.1256">   var focusedWindow = top.document.commandDispatcher.focusedWindow;</span>
<a href="#l3.1257"></a><span id="l3.1257"> </span>
<a href="#l3.1258"></a><span id="l3.1258">   // we're just setting focus to where it was before</span>
<a href="#l3.1259"></a><span id="l3.1259">   if (focusedWindow == gLastWindowToHaveFocus)</span>
<a href="#l3.1260"></a><span id="l3.1260">     return;</span>
<a href="#l3.1261"></a><span id="l3.1261"> </span>
<a href="#l3.1262"></a><span id="l3.1262">   gLastWindowToHaveFocus = focusedWindow;</span>
<a href="#l3.1263"></a><span id="l3.1263">   updateComposeItems();</span>
<a href="#l3.1264"></a><span id="l3.1264"> }</span>
<a href="#l3.1265"></a><span id="l3.1265"> </span>
<a href="#l3.1266"></a><span id="l3.1266" class="difflineminus">-function findbarFindReplace()</span>
<a href="#l3.1267"></a><span id="l3.1267" class="difflineminus">-{</span>
<a href="#l3.1268"></a><span id="l3.1268" class="difflineplus">+function findbarFindReplace() {</span>
<a href="#l3.1269"></a><span id="l3.1269">   SetMsgBodyFrameFocus();</span>
<a href="#l3.1270"></a><span id="l3.1270">   let findbar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l3.1271"></a><span id="l3.1271">   findbar.close();</span>
<a href="#l3.1272"></a><span id="l3.1272">   goDoCommand(&quot;cmd_findReplace&quot;);</span>
<a href="#l3.1273"></a><span id="l3.1273">   findbar.open();</span>
<a href="#l3.1274"></a><span id="l3.1274"> }</span>
<a href="#l3.1275"></a><span id="l3.1275"> </span>
<a href="#l3.1276"></a><span id="l3.1276" class="difflineminus">-function updateComposeItems()</span>
<a href="#l3.1277"></a><span id="l3.1277" class="difflineminus">-{</span>
<a href="#l3.1278"></a><span id="l3.1278" class="difflineplus">+function updateComposeItems() {</span>
<a href="#l3.1279"></a><span id="l3.1279">   try {</span>
<a href="#l3.1280"></a><span id="l3.1280">     // Edit Menu</span>
<a href="#l3.1281"></a><span id="l3.1281">     goUpdateCommand(&quot;cmd_rewrap&quot;);</span>
<a href="#l3.1282"></a><span id="l3.1282"> </span>
<a href="#l3.1283"></a><span id="l3.1283">     // Insert Menu</span>
<a href="#l3.1284"></a><span id="l3.1284" class="difflineminus">-    if (gMsgCompose &amp;&amp; gMsgCompose.composeHTML)</span>
<a href="#l3.1285"></a><span id="l3.1285" class="difflineminus">-    {</span>
<a href="#l3.1286"></a><span id="l3.1286" class="difflineplus">+    if (gMsgCompose &amp;&amp; gMsgCompose.composeHTML) {</span>
<a href="#l3.1287"></a><span id="l3.1287">       goUpdateCommand(&quot;cmd_renderedHTMLEnabler&quot;);</span>
<a href="#l3.1288"></a><span id="l3.1288">       goUpdateCommand(&quot;cmd_fontColor&quot;);</span>
<a href="#l3.1289"></a><span id="l3.1289">       goUpdateCommand(&quot;cmd_backgroundColor&quot;);</span>
<a href="#l3.1290"></a><span id="l3.1290">       goUpdateCommand(&quot;cmd_decreaseFontStep&quot;);</span>
<a href="#l3.1291"></a><span id="l3.1291">       goUpdateCommand(&quot;cmd_increaseFontStep&quot;);</span>
<a href="#l3.1292"></a><span id="l3.1292">       goUpdateCommand(&quot;cmd_bold&quot;);</span>
<a href="#l3.1293"></a><span id="l3.1293">       goUpdateCommand(&quot;cmd_italic&quot;);</span>
<a href="#l3.1294"></a><span id="l3.1294">       goUpdateCommand(&quot;cmd_underline&quot;);</span>
<a href="#l3.1295"></a><span id="l3.1295" class="difflineat">@@ -1316,136 +1274,126 @@ function updateComposeItems()</span>
<a href="#l3.1296"></a><span id="l3.1296">       goUpdateCommand(&quot;cmd_smiley&quot;);</span>
<a href="#l3.1297"></a><span id="l3.1297">     }</span>
<a href="#l3.1298"></a><span id="l3.1298"> </span>
<a href="#l3.1299"></a><span id="l3.1299">     // Options Menu</span>
<a href="#l3.1300"></a><span id="l3.1300">     goUpdateCommand(&quot;cmd_spelling&quot;);</span>
<a href="#l3.1301"></a><span id="l3.1301"> </span>
<a href="#l3.1302"></a><span id="l3.1302">     // Workaround to update 'Quote' toolbar button. (See bug 609926.)</span>
<a href="#l3.1303"></a><span id="l3.1303">     goUpdateCommand(&quot;cmd_quoteMessage&quot;);</span>
<a href="#l3.1304"></a><span id="l3.1304" class="difflineminus">-  } catch(e) {}</span>
<a href="#l3.1305"></a><span id="l3.1305" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.1306"></a><span id="l3.1306"> }</span>
<a href="#l3.1307"></a><span id="l3.1307"> </span>
<a href="#l3.1308"></a><span id="l3.1308"> /**</span>
<a href="#l3.1309"></a><span id="l3.1309">  * Disables or restores all toolbar items (menus/buttons) in the window.</span>
<a href="#l3.1310"></a><span id="l3.1310">  *</span>
<a href="#l3.1311"></a><span id="l3.1311">  * @param aDisable  true = disable all items. false = restore items to the state</span>
<a href="#l3.1312"></a><span id="l3.1312">  *                  stored before disabling them.</span>
<a href="#l3.1313"></a><span id="l3.1313">  */</span>
<a href="#l3.1314"></a><span id="l3.1314" class="difflineminus">-function updateAllItems(aDisable)</span>
<a href="#l3.1315"></a><span id="l3.1315" class="difflineminus">-{</span>
<a href="#l3.1316"></a><span id="l3.1316" class="difflineplus">+function updateAllItems(aDisable) {</span>
<a href="#l3.1317"></a><span id="l3.1317">   function getDisabledState(aElement) {</span>
<a href="#l3.1318"></a><span id="l3.1318">     if (&quot;disabled&quot; in aElement)</span>
<a href="#l3.1319"></a><span id="l3.1319">       return (aElement.disabled ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l3.1320"></a><span id="l3.1320">     else if (!aElement.hasAttribute(&quot;disabled&quot;))</span>
<a href="#l3.1321"></a><span id="l3.1321">       return &quot;&quot;;</span>
<a href="#l3.1322"></a><span id="l3.1322" class="difflineminus">-    else</span>
<a href="#l3.1323"></a><span id="l3.1323" class="difflineminus">-      return aElement.getAttribute(&quot;disabled&quot;);</span>
<a href="#l3.1324"></a><span id="l3.1324" class="difflineplus">+    return aElement.getAttribute(&quot;disabled&quot;);</span>
<a href="#l3.1325"></a><span id="l3.1325">   }</span>
<a href="#l3.1326"></a><span id="l3.1326"> </span>
<a href="#l3.1327"></a><span id="l3.1327">   function setDisabledState(aElement, aValue) {</span>
<a href="#l3.1328"></a><span id="l3.1328">     if (&quot;disabled&quot; in aElement)</span>
<a href="#l3.1329"></a><span id="l3.1329">       aElement.disabled = (aValue == &quot;true&quot;);</span>
<a href="#l3.1330"></a><span id="l3.1330">     else if (aValue == &quot;&quot;)</span>
<a href="#l3.1331"></a><span id="l3.1331">       aElement.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.1332"></a><span id="l3.1332">     else</span>
<a href="#l3.1333"></a><span id="l3.1333">       aElement.setAttribute(&quot;disabled&quot;, aValue);</span>
<a href="#l3.1334"></a><span id="l3.1334">   }</span>
<a href="#l3.1335"></a><span id="l3.1335"> </span>
<a href="#l3.1336"></a><span id="l3.1336"> </span>
<a href="#l3.1337"></a><span id="l3.1337">   // This array will contain HTMLCollection objects as members.</span>
<a href="#l3.1338"></a><span id="l3.1338">   let commandItemCollections = [];</span>
<a href="#l3.1339"></a><span id="l3.1339">   commandItemCollections.push(document.getElementsByTagName(&quot;menu&quot;));</span>
<a href="#l3.1340"></a><span id="l3.1340">   commandItemCollections.push(document.getElementsByTagName(&quot;toolbarbutton&quot;));</span>
<a href="#l3.1341"></a><span id="l3.1341" class="difflineminus">-  commandItemCollections.push(document.querySelectorAll('[command]'));</span>
<a href="#l3.1342"></a><span id="l3.1342" class="difflineminus">-  commandItemCollections.push(document.querySelectorAll('[oncommand]'));</span>
<a href="#l3.1343"></a><span id="l3.1343" class="difflineplus">+  commandItemCollections.push(document.querySelectorAll(&quot;[command]&quot;));</span>
<a href="#l3.1344"></a><span id="l3.1344" class="difflineplus">+  commandItemCollections.push(document.querySelectorAll(&quot;[oncommand]&quot;));</span>
<a href="#l3.1345"></a><span id="l3.1345">   for (let itemCollection of commandItemCollections) {</span>
<a href="#l3.1346"></a><span id="l3.1346">     for (let item = 0; item &lt; itemCollection.length; item++) {</span>
<a href="#l3.1347"></a><span id="l3.1347">       let commandItem = itemCollection[item];</span>
<a href="#l3.1348"></a><span id="l3.1348">       if (aDisable) {</span>
<a href="#l3.1349"></a><span id="l3.1349">         // Any element can appear multiple times in the commandItemCollections</span>
<a href="#l3.1350"></a><span id="l3.1350">         // list so only act on it if we didn't already set the &quot;stateBeforeSend&quot;</span>
<a href="#l3.1351"></a><span id="l3.1351">         // attribute on previous visit.</span>
<a href="#l3.1352"></a><span id="l3.1352">         if (!commandItem.hasAttribute(&quot;stateBeforeSend&quot;)) {</span>
<a href="#l3.1353"></a><span id="l3.1353">           commandItem.setAttribute(&quot;stateBeforeSend&quot;, getDisabledState(commandItem));</span>
<a href="#l3.1354"></a><span id="l3.1354">           setDisabledState(commandItem, true);</span>
<a href="#l3.1355"></a><span id="l3.1355">         }</span>
<a href="#l3.1356"></a><span id="l3.1356" class="difflineminus">-      }</span>
<a href="#l3.1357"></a><span id="l3.1357" class="difflineminus">-      else {</span>
<a href="#l3.1358"></a><span id="l3.1358" class="difflineplus">+      } else if (commandItem.hasAttribute(&quot;stateBeforeSend&quot;)) {</span>
<a href="#l3.1359"></a><span id="l3.1359">         // Any element can appear multiple times in the commandItemCollections</span>
<a href="#l3.1360"></a><span id="l3.1360">         // list so only act on it if it still has the &quot;stateBeforeSend&quot;</span>
<a href="#l3.1361"></a><span id="l3.1361">         // attribute.</span>
<a href="#l3.1362"></a><span id="l3.1362" class="difflineminus">-        if (commandItem.hasAttribute(&quot;stateBeforeSend&quot;)) {</span>
<a href="#l3.1363"></a><span id="l3.1363" class="difflineminus">-          setDisabledState(commandItem, commandItem.getAttribute(&quot;stateBeforeSend&quot;));</span>
<a href="#l3.1364"></a><span id="l3.1364" class="difflineminus">-          commandItem.removeAttribute(&quot;stateBeforeSend&quot;);</span>
<a href="#l3.1365"></a><span id="l3.1365" class="difflineminus">-        }</span>
<a href="#l3.1366"></a><span id="l3.1366" class="difflineplus">+        setDisabledState(commandItem, commandItem.getAttribute(&quot;stateBeforeSend&quot;));</span>
<a href="#l3.1367"></a><span id="l3.1367" class="difflineplus">+        commandItem.removeAttribute(&quot;stateBeforeSend&quot;);</span>
<a href="#l3.1368"></a><span id="l3.1368">       }</span>
<a href="#l3.1369"></a><span id="l3.1369">     }</span>
<a href="#l3.1370"></a><span id="l3.1370">   }</span>
<a href="#l3.1371"></a><span id="l3.1371"> }</span>
<a href="#l3.1372"></a><span id="l3.1372"> </span>
<a href="#l3.1373"></a><span id="l3.1373" class="difflineminus">-function InitFileSaveAsMenu()</span>
<a href="#l3.1374"></a><span id="l3.1374" class="difflineminus">-{</span>
<a href="#l3.1375"></a><span id="l3.1375" class="difflineplus">+function InitFileSaveAsMenu() {</span>
<a href="#l3.1376"></a><span id="l3.1376">   document.getElementById(&quot;cmd_saveAsFile&quot;)</span>
<a href="#l3.1377"></a><span id="l3.1377">           .setAttribute(&quot;checked&quot;, defaultSaveOperation == &quot;file&quot;);</span>
<a href="#l3.1378"></a><span id="l3.1378">   document.getElementById(&quot;cmd_saveAsDraft&quot;)</span>
<a href="#l3.1379"></a><span id="l3.1379">           .setAttribute(&quot;checked&quot;, defaultSaveOperation == &quot;draft&quot;);</span>
<a href="#l3.1380"></a><span id="l3.1380">   document.getElementById(&quot;cmd_saveAsTemplate&quot;)</span>
<a href="#l3.1381"></a><span id="l3.1381">           .setAttribute(&quot;checked&quot;, defaultSaveOperation == &quot;template&quot;);</span>
<a href="#l3.1382"></a><span id="l3.1382"> }</span>
<a href="#l3.1383"></a><span id="l3.1383"> </span>
<a href="#l3.1384"></a><span id="l3.1384" class="difflineminus">-function openEditorContextMenu(popup)</span>
<a href="#l3.1385"></a><span id="l3.1385" class="difflineminus">-{</span>
<a href="#l3.1386"></a><span id="l3.1386" class="difflineplus">+function openEditorContextMenu(popup) {</span>
<a href="#l3.1387"></a><span id="l3.1387">   gSpellChecker.clearSuggestionsFromMenu();</span>
<a href="#l3.1388"></a><span id="l3.1388">   gSpellChecker.initFromEvent(document.popupRangeParent, document.popupRangeOffset);</span>
<a href="#l3.1389"></a><span id="l3.1389">   var onMisspelling = gSpellChecker.overMisspelling;</span>
<a href="#l3.1390"></a><span id="l3.1390" class="difflineminus">-  document.getElementById('spellCheckSuggestionsSeparator').hidden = !onMisspelling;</span>
<a href="#l3.1391"></a><span id="l3.1391" class="difflineminus">-  document.getElementById('spellCheckAddToDictionary').hidden = !onMisspelling;</span>
<a href="#l3.1392"></a><span id="l3.1392" class="difflineminus">-  document.getElementById('spellCheckIgnoreWord').hidden = !onMisspelling;</span>
<a href="#l3.1393"></a><span id="l3.1393" class="difflineminus">-  var separator = document.getElementById('spellCheckAddSep');</span>
<a href="#l3.1394"></a><span id="l3.1394" class="difflineplus">+  document.getElementById(&quot;spellCheckSuggestionsSeparator&quot;).hidden = !onMisspelling;</span>
<a href="#l3.1395"></a><span id="l3.1395" class="difflineplus">+  document.getElementById(&quot;spellCheckAddToDictionary&quot;).hidden = !onMisspelling;</span>
<a href="#l3.1396"></a><span id="l3.1396" class="difflineplus">+  document.getElementById(&quot;spellCheckIgnoreWord&quot;).hidden = !onMisspelling;</span>
<a href="#l3.1397"></a><span id="l3.1397" class="difflineplus">+  var separator = document.getElementById(&quot;spellCheckAddSep&quot;);</span>
<a href="#l3.1398"></a><span id="l3.1398">   separator.hidden = !onMisspelling;</span>
<a href="#l3.1399"></a><span id="l3.1399" class="difflineminus">-  document.getElementById('spellCheckNoSuggestions').hidden = !onMisspelling ||</span>
<a href="#l3.1400"></a><span id="l3.1400" class="difflineplus">+  document.getElementById(&quot;spellCheckNoSuggestions&quot;).hidden = !onMisspelling ||</span>
<a href="#l3.1401"></a><span id="l3.1401">       gSpellChecker.addSuggestionsToMenu(popup, separator, 5);</span>
<a href="#l3.1402"></a><span id="l3.1402"> </span>
<a href="#l3.1403"></a><span id="l3.1403">   // We ought to do that, otherwise changing dictionaries will have no effect!</span>
<a href="#l3.1404"></a><span id="l3.1404">   // InlineSpellChecker only registers callbacks for entries that are not the</span>
<a href="#l3.1405"></a><span id="l3.1405">   // current dictionary, so if we changed dictionaries in the meanwhile, we must</span>
<a href="#l3.1406"></a><span id="l3.1406">   // rebuild the list so that the right callbacks are registered in the Language</span>
<a href="#l3.1407"></a><span id="l3.1407">   // menu.</span>
<a href="#l3.1408"></a><span id="l3.1408">   gSpellChecker.clearDictionaryListFromMenu();</span>
<a href="#l3.1409"></a><span id="l3.1409">   let dictMenu = document.getElementById(&quot;spellCheckDictionariesMenu&quot;);</span>
<a href="#l3.1410"></a><span id="l3.1410">   let dictSep = document.getElementById(&quot;spellCheckLanguageSeparator&quot;);</span>
<a href="#l3.1411"></a><span id="l3.1411">   gSpellChecker.addDictionaryListToMenu(dictMenu, dictSep);</span>
<a href="#l3.1412"></a><span id="l3.1412"> </span>
<a href="#l3.1413"></a><span id="l3.1413">   updateEditItems();</span>
<a href="#l3.1414"></a><span id="l3.1414"> }</span>
<a href="#l3.1415"></a><span id="l3.1415"> </span>
<a href="#l3.1416"></a><span id="l3.1416" class="difflineminus">-function updateEditItems()</span>
<a href="#l3.1417"></a><span id="l3.1417" class="difflineminus">-{</span>
<a href="#l3.1418"></a><span id="l3.1418" class="difflineplus">+function updateEditItems() {</span>
<a href="#l3.1419"></a><span id="l3.1419">   goUpdateCommand(&quot;cmd_paste&quot;);</span>
<a href="#l3.1420"></a><span id="l3.1420">   goUpdateCommand(&quot;cmd_pasteNoFormatting&quot;);</span>
<a href="#l3.1421"></a><span id="l3.1421">   goUpdateCommand(&quot;cmd_pasteQuote&quot;);</span>
<a href="#l3.1422"></a><span id="l3.1422">   goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l3.1423"></a><span id="l3.1423">   goUpdateCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l3.1424"></a><span id="l3.1424">   goUpdateCommand(&quot;cmd_reorderAttachments&quot;);</span>
<a href="#l3.1425"></a><span id="l3.1425">   goUpdateCommand(&quot;cmd_selectAll&quot;);</span>
<a href="#l3.1426"></a><span id="l3.1426">   goUpdateCommand(&quot;cmd_openAttachment&quot;);</span>
<a href="#l3.1427"></a><span id="l3.1427">   goUpdateCommand(&quot;cmd_findReplace&quot;);</span>
<a href="#l3.1428"></a><span id="l3.1428">   goUpdateCommand(&quot;cmd_find&quot;);</span>
<a href="#l3.1429"></a><span id="l3.1429">   goUpdateCommand(&quot;cmd_findNext&quot;);</span>
<a href="#l3.1430"></a><span id="l3.1430">   goUpdateCommand(&quot;cmd_findPrev&quot;);</span>
<a href="#l3.1431"></a><span id="l3.1431"> }</span>
<a href="#l3.1432"></a><span id="l3.1432"> </span>
<a href="#l3.1433"></a><span id="l3.1433" class="difflineminus">-function updateViewItems()</span>
<a href="#l3.1434"></a><span id="l3.1434" class="difflineminus">-{</span>
<a href="#l3.1435"></a><span id="l3.1435" class="difflineplus">+function updateViewItems() {</span>
<a href="#l3.1436"></a><span id="l3.1436">   goUpdateCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.1437"></a><span id="l3.1437"> }</span>
<a href="#l3.1438"></a><span id="l3.1438"> </span>
<a href="#l3.1439"></a><span id="l3.1439" class="difflineminus">-function updateAttachmentItems()</span>
<a href="#l3.1440"></a><span id="l3.1440" class="difflineminus">-{</span>
<a href="#l3.1441"></a><span id="l3.1441" class="difflineplus">+function updateAttachmentItems() {</span>
<a href="#l3.1442"></a><span id="l3.1442">   goUpdateCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.1443"></a><span id="l3.1443">   goUpdateCommand(&quot;cmd_attachCloud&quot;);</span>
<a href="#l3.1444"></a><span id="l3.1444">   goUpdateCommand(&quot;cmd_convertCloud&quot;);</span>
<a href="#l3.1445"></a><span id="l3.1445">   goUpdateCommand(&quot;cmd_convertAttachment&quot;);</span>
<a href="#l3.1446"></a><span id="l3.1446">   goUpdateCommand(&quot;cmd_cancelUpload&quot;);</span>
<a href="#l3.1447"></a><span id="l3.1447">   goUpdateCommand(&quot;cmd_delete&quot;);</span>
<a href="#l3.1448"></a><span id="l3.1448">   goUpdateCommand(&quot;cmd_removeAllAttachments&quot;);</span>
<a href="#l3.1449"></a><span id="l3.1449">   goUpdateCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l3.1450"></a><span id="l3.1450" class="difflineat">@@ -1463,34 +1411,32 @@ function updateReorderAttachmentsItems()</span>
<a href="#l3.1451"></a><span id="l3.1451">   goUpdateCommand(&quot;cmd_moveAttachmentTop&quot;);</span>
<a href="#l3.1452"></a><span id="l3.1452">   goUpdateCommand(&quot;cmd_moveAttachmentBottom&quot;);</span>
<a href="#l3.1453"></a><span id="l3.1453">   goUpdateCommand(&quot;cmd_sortAttachmentsToggle&quot;);</span>
<a href="#l3.1454"></a><span id="l3.1454"> }</span>
<a href="#l3.1455"></a><span id="l3.1455"> </span>
<a href="#l3.1456"></a><span id="l3.1456"> /**</span>
<a href="#l3.1457"></a><span id="l3.1457">  * Update all the commands for sending a message to reflect their current state.</span>
<a href="#l3.1458"></a><span id="l3.1458">  */</span>
<a href="#l3.1459"></a><span id="l3.1459" class="difflineminus">-function updateSendCommands(aHaveController)</span>
<a href="#l3.1460"></a><span id="l3.1460" class="difflineminus">-{</span>
<a href="#l3.1461"></a><span id="l3.1461" class="difflineplus">+function updateSendCommands(aHaveController) {</span>
<a href="#l3.1462"></a><span id="l3.1462">   updateSendLock();</span>
<a href="#l3.1463"></a><span id="l3.1463">   if (aHaveController) {</span>
<a href="#l3.1464"></a><span id="l3.1464">     goUpdateCommand(&quot;cmd_sendButton&quot;);</span>
<a href="#l3.1465"></a><span id="l3.1465">     goUpdateCommand(&quot;cmd_sendNow&quot;);</span>
<a href="#l3.1466"></a><span id="l3.1466">     goUpdateCommand(&quot;cmd_sendLater&quot;);</span>
<a href="#l3.1467"></a><span id="l3.1467">     goUpdateCommand(&quot;cmd_sendWithCheck&quot;);</span>
<a href="#l3.1468"></a><span id="l3.1468">   } else {</span>
<a href="#l3.1469"></a><span id="l3.1469" class="difflineminus">-    goSetCommandEnabled(&quot;cmd_sendButton&quot;,    defaultController.isCommandEnabled(&quot;cmd_sendButton&quot;));</span>
<a href="#l3.1470"></a><span id="l3.1470" class="difflineminus">-    goSetCommandEnabled(&quot;cmd_sendNow&quot;,       defaultController.isCommandEnabled(&quot;cmd_sendNow&quot;));</span>
<a href="#l3.1471"></a><span id="l3.1471" class="difflineminus">-    goSetCommandEnabled(&quot;cmd_sendLater&quot;,     defaultController.isCommandEnabled(&quot;cmd_sendLater&quot;));</span>
<a href="#l3.1472"></a><span id="l3.1472" class="difflineplus">+    goSetCommandEnabled(&quot;cmd_sendButton&quot;, defaultController.isCommandEnabled(&quot;cmd_sendButton&quot;));</span>
<a href="#l3.1473"></a><span id="l3.1473" class="difflineplus">+    goSetCommandEnabled(&quot;cmd_sendNow&quot;, defaultController.isCommandEnabled(&quot;cmd_sendNow&quot;));</span>
<a href="#l3.1474"></a><span id="l3.1474" class="difflineplus">+    goSetCommandEnabled(&quot;cmd_sendLater&quot;, defaultController.isCommandEnabled(&quot;cmd_sendLater&quot;));</span>
<a href="#l3.1475"></a><span id="l3.1475">     goSetCommandEnabled(&quot;cmd_sendWithCheck&quot;, defaultController.isCommandEnabled(&quot;cmd_sendWithCheck&quot;));</span>
<a href="#l3.1476"></a><span id="l3.1476">   }</span>
<a href="#l3.1477"></a><span id="l3.1477"> }</span>
<a href="#l3.1478"></a><span id="l3.1478"> </span>
<a href="#l3.1479"></a><span id="l3.1479" class="difflineminus">-function addAttachCloudMenuItems(aParentMenu)</span>
<a href="#l3.1480"></a><span id="l3.1480" class="difflineminus">-{</span>
<a href="#l3.1481"></a><span id="l3.1481" class="difflineplus">+function addAttachCloudMenuItems(aParentMenu) {</span>
<a href="#l3.1482"></a><span id="l3.1482">   while (aParentMenu.hasChildNodes())</span>
<a href="#l3.1483"></a><span id="l3.1483">     aParentMenu.lastChild.remove();</span>
<a href="#l3.1484"></a><span id="l3.1484"> </span>
<a href="#l3.1485"></a><span id="l3.1485">   for (let cloudProvider of cloudFileAccounts.accounts) {</span>
<a href="#l3.1486"></a><span id="l3.1486">     let item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l3.1487"></a><span id="l3.1487">     let iconClass = cloudProvider.iconClass;</span>
<a href="#l3.1488"></a><span id="l3.1488">     item.cloudProvider = cloudProvider;</span>
<a href="#l3.1489"></a><span id="l3.1489">     item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l3.1490"></a><span id="l3.1490" class="difflineat">@@ -1498,18 +1444,17 @@ function addAttachCloudMenuItems(aParent</span>
<a href="#l3.1491"></a><span id="l3.1491">     if (iconClass) {</span>
<a href="#l3.1492"></a><span id="l3.1492">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l3.1493"></a><span id="l3.1493">       item.setAttribute(&quot;image&quot;, iconClass);</span>
<a href="#l3.1494"></a><span id="l3.1494">     }</span>
<a href="#l3.1495"></a><span id="l3.1495">     aParentMenu.appendChild(item);</span>
<a href="#l3.1496"></a><span id="l3.1496">   }</span>
<a href="#l3.1497"></a><span id="l3.1497"> }</span>
<a href="#l3.1498"></a><span id="l3.1498"> </span>
<a href="#l3.1499"></a><span id="l3.1499" class="difflineminus">-function addConvertCloudMenuItems(aParentMenu, aAfterNodeId, aRadioGroup)</span>
<a href="#l3.1500"></a><span id="l3.1500" class="difflineminus">-{</span>
<a href="#l3.1501"></a><span id="l3.1501" class="difflineplus">+function addConvertCloudMenuItems(aParentMenu, aAfterNodeId, aRadioGroup) {</span>
<a href="#l3.1502"></a><span id="l3.1502">   let attachment = document.getElementById(&quot;attachmentBucket&quot;).selectedItem;</span>
<a href="#l3.1503"></a><span id="l3.1503">   let afterNode = document.getElementById(aAfterNodeId);</span>
<a href="#l3.1504"></a><span id="l3.1504">   while (afterNode.nextSibling)</span>
<a href="#l3.1505"></a><span id="l3.1505">     afterNode.nextSibling.remove();</span>
<a href="#l3.1506"></a><span id="l3.1506"> </span>
<a href="#l3.1507"></a><span id="l3.1507">   if (!attachment.sendViaCloud) {</span>
<a href="#l3.1508"></a><span id="l3.1508">     let item = document.getElementById(&quot;convertCloudMenuItems_popup_convertAttachment&quot;);</span>
<a href="#l3.1509"></a><span id="l3.1509">     item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.1510"></a><span id="l3.1510" class="difflineat">@@ -1521,45 +1466,43 @@ function addConvertCloudMenuItems(aParen</span>
<a href="#l3.1511"></a><span id="l3.1511">     item.cloudProvider = cloudProvider;</span>
<a href="#l3.1512"></a><span id="l3.1512">     item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l3.1513"></a><span id="l3.1513">     item.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l3.1514"></a><span id="l3.1514">     item.setAttribute(&quot;name&quot;, aRadioGroup);</span>
<a href="#l3.1515"></a><span id="l3.1515"> </span>
<a href="#l3.1516"></a><span id="l3.1516">     if (attachment.cloudProvider &amp;&amp;</span>
<a href="#l3.1517"></a><span id="l3.1517">         attachment.cloudProvider.accountKey == cloudProvider.accountKey) {</span>
<a href="#l3.1518"></a><span id="l3.1518">       item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.1519"></a><span id="l3.1519" class="difflineminus">-    }</span>
<a href="#l3.1520"></a><span id="l3.1520" class="difflineminus">-    else if (iconClass) {</span>
<a href="#l3.1521"></a><span id="l3.1521" class="difflineplus">+    } else if (iconClass) {</span>
<a href="#l3.1522"></a><span id="l3.1522">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l3.1523"></a><span id="l3.1523">       item.setAttribute(&quot;image&quot;, iconClass);</span>
<a href="#l3.1524"></a><span id="l3.1524">     }</span>
<a href="#l3.1525"></a><span id="l3.1525"> </span>
<a href="#l3.1526"></a><span id="l3.1526">     aParentMenu.appendChild(item);</span>
<a href="#l3.1527"></a><span id="l3.1527">   }</span>
<a href="#l3.1528"></a><span id="l3.1528"> }</span>
<a href="#l3.1529"></a><span id="l3.1529"> </span>
<a href="#l3.1530"></a><span id="l3.1530" class="difflineminus">-function uploadListener(aAttachment, aFile, aCloudProvider)</span>
<a href="#l3.1531"></a><span id="l3.1531" class="difflineminus">-{</span>
<a href="#l3.1532"></a><span id="l3.1532" class="difflineplus">+function uploadListener(aAttachment, aFile, aCloudProvider) {</span>
<a href="#l3.1533"></a><span id="l3.1533">   this.attachment = aAttachment;</span>
<a href="#l3.1534"></a><span id="l3.1534">   this.file = aFile;</span>
<a href="#l3.1535"></a><span id="l3.1535">   this.cloudProvider = aCloudProvider;</span>
<a href="#l3.1536"></a><span id="l3.1536"> </span>
<a href="#l3.1537"></a><span id="l3.1537">   // Notify the UI that we're starting the upload process: disable send commands</span>
<a href="#l3.1538"></a><span id="l3.1538">   // and show a &quot;connecting&quot; icon for the attachment.</span>
<a href="#l3.1539"></a><span id="l3.1539">   this.attachment.sendViaCloud = true;</span>
<a href="#l3.1540"></a><span id="l3.1540">   gNumUploadingAttachments++;</span>
<a href="#l3.1541"></a><span id="l3.1541">   updateSendCommands(true);</span>
<a href="#l3.1542"></a><span id="l3.1542"> </span>
<a href="#l3.1543"></a><span id="l3.1543">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1544"></a><span id="l3.1544">   let item = bucket.findItemForAttachment(this.attachment);</span>
<a href="#l3.1545"></a><span id="l3.1545">   if (item) {</span>
<a href="#l3.1546"></a><span id="l3.1546">     item.image = &quot;chrome://messenger/skin/icons/connecting.png&quot;;</span>
<a href="#l3.1547"></a><span id="l3.1547">     item.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l3.1548"></a><span id="l3.1548">       getComposeBundle().getFormattedString(&quot;cloudFileUploadingTooltip&quot;, [</span>
<a href="#l3.1549"></a><span id="l3.1549" class="difflineminus">-        cloudFileAccounts.getDisplayName(this.cloudProvider)</span>
<a href="#l3.1550"></a><span id="l3.1550" class="difflineplus">+        cloudFileAccounts.getDisplayName(this.cloudProvider),</span>
<a href="#l3.1551"></a><span id="l3.1551">       ]));</span>
<a href="#l3.1552"></a><span id="l3.1552">     item.uploading = true;</span>
<a href="#l3.1553"></a><span id="l3.1553">     item.cloudProvider = this.cloudProvider;</span>
<a href="#l3.1554"></a><span id="l3.1554">   }</span>
<a href="#l3.1555"></a><span id="l3.1555"> }</span>
<a href="#l3.1556"></a><span id="l3.1556"> </span>
<a href="#l3.1557"></a><span id="l3.1557"> uploadListener.prototype = {</span>
<a href="#l3.1558"></a><span id="l3.1558">   onStartRequest: function uploadListener_onStartRequest(aRequest, aContext) {</span>
<a href="#l3.1559"></a><span id="l3.1559" class="difflineat">@@ -1579,17 +1522,17 @@ uploadListener.prototype = {</span>
<a href="#l3.1560"></a><span id="l3.1560">       this.attachment.contentLocation = this.cloudProvider.urlForFile(this.file);</span>
<a href="#l3.1561"></a><span id="l3.1561">       this.attachment.cloudProviderKey = this.cloudProvider.accountKey;</span>
<a href="#l3.1562"></a><span id="l3.1562">       if (attachmentItem) {</span>
<a href="#l3.1563"></a><span id="l3.1563">         // Update relevant bits on the attachment list item.</span>
<a href="#l3.1564"></a><span id="l3.1564">         if (!attachmentItem.originalUrl)</span>
<a href="#l3.1565"></a><span id="l3.1565">           attachmentItem.originalUrl = originalUrl;</span>
<a href="#l3.1566"></a><span id="l3.1566">         attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l3.1567"></a><span id="l3.1567">           getComposeBundle().getFormattedString(&quot;cloudFileUploadedTooltip&quot;, [</span>
<a href="#l3.1568"></a><span id="l3.1568" class="difflineminus">-            cloudFileAccounts.getDisplayName(this.cloudProvider)</span>
<a href="#l3.1569"></a><span id="l3.1569" class="difflineplus">+            cloudFileAccounts.getDisplayName(this.cloudProvider),</span>
<a href="#l3.1570"></a><span id="l3.1570">           ]));</span>
<a href="#l3.1571"></a><span id="l3.1571">         attachmentItem.uploading = false;</span>
<a href="#l3.1572"></a><span id="l3.1572"> </span>
<a href="#l3.1573"></a><span id="l3.1573">         // Set the icon for the attachment.</span>
<a href="#l3.1574"></a><span id="l3.1574">         let iconClass = this.cloudProvider.iconClass;</span>
<a href="#l3.1575"></a><span id="l3.1575">         if (iconClass)</span>
<a href="#l3.1576"></a><span id="l3.1576">           attachmentItem.image = iconClass;</span>
<a href="#l3.1577"></a><span id="l3.1577">         else {</span>
<a href="#l3.1578"></a><span id="l3.1578" class="difflineat">@@ -1598,18 +1541,17 @@ uploadListener.prototype = {</span>
<a href="#l3.1579"></a><span id="l3.1579">           attachmentItem.image = null;</span>
<a href="#l3.1580"></a><span id="l3.1580">         }</span>
<a href="#l3.1581"></a><span id="l3.1581">       }</span>
<a href="#l3.1582"></a><span id="l3.1582"> </span>
<a href="#l3.1583"></a><span id="l3.1583">       let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l3.1584"></a><span id="l3.1584">       event.initEvent(&quot;attachment-uploaded&quot;, true, true);</span>
<a href="#l3.1585"></a><span id="l3.1585">       attachmentItem.dispatchEvent(new Event(&quot;attachment-uploaded&quot;,</span>
<a href="#l3.1586"></a><span id="l3.1586">         { bubbles: true, cancelable: true }));</span>
<a href="#l3.1587"></a><span id="l3.1587" class="difflineminus">-    }</span>
<a href="#l3.1588"></a><span id="l3.1588" class="difflineminus">-    else {</span>
<a href="#l3.1589"></a><span id="l3.1589" class="difflineplus">+    } else {</span>
<a href="#l3.1590"></a><span id="l3.1590">       let title;</span>
<a href="#l3.1591"></a><span id="l3.1591">       let msg;</span>
<a href="#l3.1592"></a><span id="l3.1592">       let displayName = cloudFileAccounts.getDisplayName(this.cloudProvider);</span>
<a href="#l3.1593"></a><span id="l3.1593">       let bundle = getComposeBundle();</span>
<a href="#l3.1594"></a><span id="l3.1594">       let displayError = true;</span>
<a href="#l3.1595"></a><span id="l3.1595">       switch (aStatusCode) {</span>
<a href="#l3.1596"></a><span id="l3.1596">       case this.cloudProvider.authErr:</span>
<a href="#l3.1597"></a><span id="l3.1597">         title = bundle.getString(&quot;errorCloudFileAuth.title&quot;);</span>
<a href="#l3.1598"></a><span id="l3.1598" class="difflineat">@@ -1678,21 +1620,20 @@ uploadListener.prototype = {</span>
<a href="#l3.1599"></a><span id="l3.1599">       }</span>
<a href="#l3.1600"></a><span id="l3.1600">     }</span>
<a href="#l3.1601"></a><span id="l3.1601"> </span>
<a href="#l3.1602"></a><span id="l3.1602">     gNumUploadingAttachments--;</span>
<a href="#l3.1603"></a><span id="l3.1603">     updateSendCommands(true);</span>
<a href="#l3.1604"></a><span id="l3.1604">   },</span>
<a href="#l3.1605"></a><span id="l3.1605"> </span>
<a href="#l3.1606"></a><span id="l3.1606">   QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;,</span>
<a href="#l3.1607"></a><span id="l3.1607" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;])</span>
<a href="#l3.1608"></a><span id="l3.1608" class="difflineplus">+                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l3.1609"></a><span id="l3.1609"> };</span>
<a href="#l3.1610"></a><span id="l3.1610"> </span>
<a href="#l3.1611"></a><span id="l3.1611" class="difflineminus">-function deletionListener(aAttachment, aCloudProvider)</span>
<a href="#l3.1612"></a><span id="l3.1612" class="difflineminus">-{</span>
<a href="#l3.1613"></a><span id="l3.1613" class="difflineplus">+function deletionListener(aAttachment, aCloudProvider) {</span>
<a href="#l3.1614"></a><span id="l3.1614">   this.attachment = aAttachment;</span>
<a href="#l3.1615"></a><span id="l3.1615">   this.cloudProvider = aCloudProvider;</span>
<a href="#l3.1616"></a><span id="l3.1616"> }</span>
<a href="#l3.1617"></a><span id="l3.1617"> </span>
<a href="#l3.1618"></a><span id="l3.1618"> deletionListener.prototype = {</span>
<a href="#l3.1619"></a><span id="l3.1619">   onStartRequest: function deletionListener_onStartRequest(aRequest, aContext) {</span>
<a href="#l3.1620"></a><span id="l3.1620">   },</span>
<a href="#l3.1621"></a><span id="l3.1621"> </span>
<a href="#l3.1622"></a><span id="l3.1622" class="difflineat">@@ -1704,77 +1645,71 @@ deletionListener.prototype = {</span>
<a href="#l3.1623"></a><span id="l3.1623">         getComposeBundle().getString(&quot;errorCloudFileDeletion.title&quot;),</span>
<a href="#l3.1624"></a><span id="l3.1624">         getComposeBundle().getFormattedString(&quot;errorCloudFileDeletion.message&quot;,</span>
<a href="#l3.1625"></a><span id="l3.1625">                                               [displayName,</span>
<a href="#l3.1626"></a><span id="l3.1626">                                                this.attachment.name]));</span>
<a href="#l3.1627"></a><span id="l3.1627">     }</span>
<a href="#l3.1628"></a><span id="l3.1628">   },</span>
<a href="#l3.1629"></a><span id="l3.1629"> </span>
<a href="#l3.1630"></a><span id="l3.1630">   QueryInterface: ChromeUtils.generateQI([&quot;nsIRequestObserver&quot;,</span>
<a href="#l3.1631"></a><span id="l3.1631" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;])</span>
<a href="#l3.1632"></a><span id="l3.1632" class="difflineplus">+                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l3.1633"></a><span id="l3.1633"> };</span>
<a href="#l3.1634"></a><span id="l3.1634"> </span>
<a href="#l3.1635"></a><span id="l3.1635"> /**</span>
<a href="#l3.1636"></a><span id="l3.1636">  * Prompt the user for a list of files to attach via a cloud provider.</span>
<a href="#l3.1637"></a><span id="l3.1637">  *</span>
<a href="#l3.1638"></a><span id="l3.1638">  * @param aProvider the cloud provider to upload the files to</span>
<a href="#l3.1639"></a><span id="l3.1639">  */</span>
<a href="#l3.1640"></a><span id="l3.1640" class="difflineminus">-function attachToCloud(aProvider)</span>
<a href="#l3.1641"></a><span id="l3.1641" class="difflineminus">-{</span>
<a href="#l3.1642"></a><span id="l3.1642" class="difflineplus">+function attachToCloud(aProvider) {</span>
<a href="#l3.1643"></a><span id="l3.1643">   // We need to let the user pick local file(s) to upload to the cloud and</span>
<a href="#l3.1644"></a><span id="l3.1644">   // gather url(s) to those files.</span>
<a href="#l3.1645"></a><span id="l3.1645">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l3.1646"></a><span id="l3.1646" class="difflineminus">-             .createInstance(nsIFilePicker);</span>
<a href="#l3.1647"></a><span id="l3.1647" class="difflineplus">+             .createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.1648"></a><span id="l3.1648">   fp.init(window, getComposeBundle().getFormattedString(</span>
<a href="#l3.1649"></a><span id="l3.1649">             &quot;chooseFileToAttachViaCloud&quot;,</span>
<a href="#l3.1650"></a><span id="l3.1650">             [cloudFileAccounts.getDisplayName(aProvider)]),</span>
<a href="#l3.1651"></a><span id="l3.1651" class="difflineminus">-          nsIFilePicker.modeOpenMultiple);</span>
<a href="#l3.1652"></a><span id="l3.1652" class="difflineplus">+          Ci.nsIFilePicker.modeOpenMultiple);</span>
<a href="#l3.1653"></a><span id="l3.1653"> </span>
<a href="#l3.1654"></a><span id="l3.1654">   var lastDirectory = GetLastAttachDirectory();</span>
<a href="#l3.1655"></a><span id="l3.1655">   if (lastDirectory)</span>
<a href="#l3.1656"></a><span id="l3.1656">     fp.displayDirectory = lastDirectory;</span>
<a href="#l3.1657"></a><span id="l3.1657"> </span>
<a href="#l3.1658"></a><span id="l3.1658" class="difflineminus">-  let files = [];</span>
<a href="#l3.1659"></a><span id="l3.1659" class="difflineminus">-</span>
<a href="#l3.1660"></a><span id="l3.1660" class="difflineminus">-  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l3.1661"></a><span id="l3.1661" class="difflineplus">+  fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l3.1662"></a><span id="l3.1662">   fp.open(rv =&gt; {</span>
<a href="#l3.1663"></a><span id="l3.1663" class="difflineminus">-    if (rv != nsIFilePicker.returnOK || !fp.files) {</span>
<a href="#l3.1664"></a><span id="l3.1664" class="difflineplus">+    if (rv != Ci.nsIFilePicker.returnOK || !fp.files) {</span>
<a href="#l3.1665"></a><span id="l3.1665">       return;</span>
<a href="#l3.1666"></a><span id="l3.1666">     }</span>
<a href="#l3.1667"></a><span id="l3.1667"> </span>
<a href="#l3.1668"></a><span id="l3.1668" class="difflineminus">-    let files = Array.from(fixIterator(fp.files,</span>
<a href="#l3.1669"></a><span id="l3.1669" class="difflineminus">-                             Ci.nsIFile))</span>
<a href="#l3.1670"></a><span id="l3.1670" class="difflineplus">+    let files = Array.from(fixIterator(fp.files, Ci.nsIFile));</span>
<a href="#l3.1671"></a><span id="l3.1671">     let attachments = files.map(f =&gt; FileToAttachment(f));</span>
<a href="#l3.1672"></a><span id="l3.1672"> </span>
<a href="#l3.1673"></a><span id="l3.1673">     let i = 0;</span>
<a href="#l3.1674"></a><span id="l3.1674" class="difflineminus">-    let items = AddAttachments(attachments, function(aItem) {</span>
<a href="#l3.1675"></a><span id="l3.1675" class="difflineplus">+    AddAttachments(attachments, function(aItem) {</span>
<a href="#l3.1676"></a><span id="l3.1676">       let listener = new uploadListener(attachments[i], files[i], aProvider);</span>
<a href="#l3.1677"></a><span id="l3.1677">       try {</span>
<a href="#l3.1678"></a><span id="l3.1678">         aProvider.uploadFile(files[i], listener);</span>
<a href="#l3.1679"></a><span id="l3.1679" class="difflineminus">-      }</span>
<a href="#l3.1680"></a><span id="l3.1680" class="difflineminus">-      catch (ex) {</span>
<a href="#l3.1681"></a><span id="l3.1681" class="difflineplus">+      } catch (ex) {</span>
<a href="#l3.1682"></a><span id="l3.1682">         listener.onStopRequest(null, null, ex.result);</span>
<a href="#l3.1683"></a><span id="l3.1683">       }</span>
<a href="#l3.1684"></a><span id="l3.1684">       i++;</span>
<a href="#l3.1685"></a><span id="l3.1685">     });</span>
<a href="#l3.1686"></a><span id="l3.1686"> </span>
<a href="#l3.1687"></a><span id="l3.1687">     dispatchAttachmentBucketEvent(&quot;attachments-uploading&quot;, attachments);</span>
<a href="#l3.1688"></a><span id="l3.1688" class="difflineminus">-    SetLastAttachDirectory(files[files.length-1]);</span>
<a href="#l3.1689"></a><span id="l3.1689" class="difflineplus">+    SetLastAttachDirectory(files[files.length - 1]);</span>
<a href="#l3.1690"></a><span id="l3.1690">   });</span>
<a href="#l3.1691"></a><span id="l3.1691"> }</span>
<a href="#l3.1692"></a><span id="l3.1692"> </span>
<a href="#l3.1693"></a><span id="l3.1693"> /**</span>
<a href="#l3.1694"></a><span id="l3.1694">  * Convert an array of attachments to cloud attachments.</span>
<a href="#l3.1695"></a><span id="l3.1695">  *</span>
<a href="#l3.1696"></a><span id="l3.1696">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l3.1697"></a><span id="l3.1697">  *        question</span>
<a href="#l3.1698"></a><span id="l3.1698">  * @param aProvider the cloud provider to upload the files to</span>
<a href="#l3.1699"></a><span id="l3.1699">  */</span>
<a href="#l3.1700"></a><span id="l3.1700" class="difflineminus">-function convertListItemsToCloudAttachment(aItems, aProvider)</span>
<a href="#l3.1701"></a><span id="l3.1701" class="difflineminus">-{</span>
<a href="#l3.1702"></a><span id="l3.1702" class="difflineplus">+function convertListItemsToCloudAttachment(aItems, aProvider) {</span>
<a href="#l3.1703"></a><span id="l3.1703">   // If we want to display an offline error message, we should do it here.</span>
<a href="#l3.1704"></a><span id="l3.1704">   // No sense in doing the delete and upload and having them fail.</span>
<a href="#l3.1705"></a><span id="l3.1705">   if (Services.io.offline)</span>
<a href="#l3.1706"></a><span id="l3.1706">     return;</span>
<a href="#l3.1707"></a><span id="l3.1707"> </span>
<a href="#l3.1708"></a><span id="l3.1708">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.1709"></a><span id="l3.1709">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l3.1710"></a><span id="l3.1710">   let convertedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l3.1711"></a><span id="l3.1711" class="difflineat">@@ -1790,23 +1725,21 @@ function convertListItemsToCloudAttachme</span>
<a href="#l3.1712"></a><span id="l3.1712">     }</span>
<a href="#l3.1713"></a><span id="l3.1713"> </span>
<a href="#l3.1714"></a><span id="l3.1714">     let file = fileHandler.getFileFromURLSpec(url);</span>
<a href="#l3.1715"></a><span id="l3.1715">     if (item.cloudProvider) {</span>
<a href="#l3.1716"></a><span id="l3.1716">       item.cloudProvider.deleteFile(</span>
<a href="#l3.1717"></a><span id="l3.1717">         file, new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l3.1718"></a><span id="l3.1718">     }</span>
<a href="#l3.1719"></a><span id="l3.1719"> </span>
<a href="#l3.1720"></a><span id="l3.1720" class="difflineplus">+    let listener = new uploadListener(item.attachment, file, aProvider);</span>
<a href="#l3.1721"></a><span id="l3.1721">     try {</span>
<a href="#l3.1722"></a><span id="l3.1722" class="difflineminus">-      let listener = new uploadListener(item.attachment, file,</span>
<a href="#l3.1723"></a><span id="l3.1723" class="difflineminus">-                                        aProvider);</span>
<a href="#l3.1724"></a><span id="l3.1724">       aProvider.uploadFile(file, listener);</span>
<a href="#l3.1725"></a><span id="l3.1725">       convertedAttachments.appendElement(item.attachment);</span>
<a href="#l3.1726"></a><span id="l3.1726" class="difflineminus">-    }</span>
<a href="#l3.1727"></a><span id="l3.1727" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.1728"></a><span id="l3.1728" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.1729"></a><span id="l3.1729">       listener.onStopRequest(null, null, ex.result);</span>
<a href="#l3.1730"></a><span id="l3.1730">     }</span>
<a href="#l3.1731"></a><span id="l3.1731">   }</span>
<a href="#l3.1732"></a><span id="l3.1732"> </span>
<a href="#l3.1733"></a><span id="l3.1733">   if (convertedAttachments.length &gt; 0) {</span>
<a href="#l3.1734"></a><span id="l3.1734">     dispatchAttachmentBucketEvent(&quot;attachments-converted&quot;, convertedAttachments);</span>
<a href="#l3.1735"></a><span id="l3.1735">     Services.obs.notifyObservers(convertedAttachments,</span>
<a href="#l3.1736"></a><span id="l3.1736">                                  &quot;mail:attachmentsConverted&quot;,</span>
<a href="#l3.1737"></a><span id="l3.1737" class="difflineat">@@ -1814,30 +1747,28 @@ function convertListItemsToCloudAttachme</span>
<a href="#l3.1738"></a><span id="l3.1738">   }</span>
<a href="#l3.1739"></a><span id="l3.1739"> }</span>
<a href="#l3.1740"></a><span id="l3.1740"> </span>
<a href="#l3.1741"></a><span id="l3.1741"> /**</span>
<a href="#l3.1742"></a><span id="l3.1742">  * Convert the selected attachments to cloud attachments.</span>
<a href="#l3.1743"></a><span id="l3.1743">  *</span>
<a href="#l3.1744"></a><span id="l3.1744">  * @param aProvider the cloud provider to upload the files to</span>
<a href="#l3.1745"></a><span id="l3.1745">  */</span>
<a href="#l3.1746"></a><span id="l3.1746" class="difflineminus">-function convertSelectedToCloudAttachment(aProvider)</span>
<a href="#l3.1747"></a><span id="l3.1747" class="difflineminus">-{</span>
<a href="#l3.1748"></a><span id="l3.1748" class="difflineplus">+function convertSelectedToCloudAttachment(aProvider) {</span>
<a href="#l3.1749"></a><span id="l3.1749">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1750"></a><span id="l3.1750">   convertListItemsToCloudAttachment([...bucket.selectedItems], aProvider);</span>
<a href="#l3.1751"></a><span id="l3.1751"> }</span>
<a href="#l3.1752"></a><span id="l3.1752"> </span>
<a href="#l3.1753"></a><span id="l3.1753"> /**</span>
<a href="#l3.1754"></a><span id="l3.1754">  * Convert an array of nsIMsgAttachments to cloud attachments.</span>
<a href="#l3.1755"></a><span id="l3.1755">  *</span>
<a href="#l3.1756"></a><span id="l3.1756">  * @param aAttachments an array of nsIMsgAttachments</span>
<a href="#l3.1757"></a><span id="l3.1757">  * @param aProvider the cloud provider to upload the files to</span>
<a href="#l3.1758"></a><span id="l3.1758">  */</span>
<a href="#l3.1759"></a><span id="l3.1759" class="difflineminus">-function convertToCloudAttachment(aAttachments, aProvider)</span>
<a href="#l3.1760"></a><span id="l3.1760" class="difflineminus">-{</span>
<a href="#l3.1761"></a><span id="l3.1761" class="difflineplus">+function convertToCloudAttachment(aAttachments, aProvider) {</span>
<a href="#l3.1762"></a><span id="l3.1762">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1763"></a><span id="l3.1763">   let items = [];</span>
<a href="#l3.1764"></a><span id="l3.1764">   for (let attachment of aAttachments) {</span>
<a href="#l3.1765"></a><span id="l3.1765">     let item = bucket.findItemForAttachment(attachment);</span>
<a href="#l3.1766"></a><span id="l3.1766">     if (item)</span>
<a href="#l3.1767"></a><span id="l3.1767">       items.push(item);</span>
<a href="#l3.1768"></a><span id="l3.1768">   }</span>
<a href="#l3.1769"></a><span id="l3.1769"> </span>
<a href="#l3.1770"></a><span id="l3.1770" class="difflineat">@@ -1845,35 +1776,33 @@ function convertToCloudAttachment(aAttac</span>
<a href="#l3.1771"></a><span id="l3.1771"> }</span>
<a href="#l3.1772"></a><span id="l3.1772"> </span>
<a href="#l3.1773"></a><span id="l3.1773"> /**</span>
<a href="#l3.1774"></a><span id="l3.1774">  * Convert an array of attachments to regular (non-cloud) attachments.</span>
<a href="#l3.1775"></a><span id="l3.1775">  *</span>
<a href="#l3.1776"></a><span id="l3.1776">  * @param aItems an array of &lt;attachmentitem&gt;s containing the attachments in</span>
<a href="#l3.1777"></a><span id="l3.1777">  *        question</span>
<a href="#l3.1778"></a><span id="l3.1778">  */</span>
<a href="#l3.1779"></a><span id="l3.1779" class="difflineminus">-function convertListItemsToRegularAttachment(aItems)</span>
<a href="#l3.1780"></a><span id="l3.1780" class="difflineminus">-{</span>
<a href="#l3.1781"></a><span id="l3.1781" class="difflineplus">+function convertListItemsToRegularAttachment(aItems) {</span>
<a href="#l3.1782"></a><span id="l3.1782">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.1783"></a><span id="l3.1783">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l3.1784"></a><span id="l3.1784">   let convertedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l3.1785"></a><span id="l3.1785">                                .createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.1786"></a><span id="l3.1786"> </span>
<a href="#l3.1787"></a><span id="l3.1787">   for (let item of aItems) {</span>
<a href="#l3.1788"></a><span id="l3.1788">     if (!item.attachment.sendViaCloud || !item.cloudProvider)</span>
<a href="#l3.1789"></a><span id="l3.1789">       continue;</span>
<a href="#l3.1790"></a><span id="l3.1790"> </span>
<a href="#l3.1791"></a><span id="l3.1791">     let file = fileHandler.getFileFromURLSpec(item.originalUrl);</span>
<a href="#l3.1792"></a><span id="l3.1792">     try {</span>
<a href="#l3.1793"></a><span id="l3.1793">       // This will fail for drafts, but we can still send the message</span>
<a href="#l3.1794"></a><span id="l3.1794">       // with a normal attachment.</span>
<a href="#l3.1795"></a><span id="l3.1795">       item.cloudProvider.deleteFile(</span>
<a href="#l3.1796"></a><span id="l3.1796">         file, new deletionListener(item.attachment, item.cloudProvider));</span>
<a href="#l3.1797"></a><span id="l3.1797" class="difflineminus">-    }</span>
<a href="#l3.1798"></a><span id="l3.1798" class="difflineminus">-    catch (ex) {</span>
<a href="#l3.1799"></a><span id="l3.1799" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.1800"></a><span id="l3.1800">        Cu.reportError(ex);</span>
<a href="#l3.1801"></a><span id="l3.1801">     }</span>
<a href="#l3.1802"></a><span id="l3.1802"> </span>
<a href="#l3.1803"></a><span id="l3.1803">     item.attachment.url = item.originalUrl;</span>
<a href="#l3.1804"></a><span id="l3.1804">     item.setAttribute(&quot;tooltiptext&quot;, item.attachment.url);</span>
<a href="#l3.1805"></a><span id="l3.1805">     item.attachment.sendViaCloud = false;</span>
<a href="#l3.1806"></a><span id="l3.1806"> </span>
<a href="#l3.1807"></a><span id="l3.1807">     delete item.cloudProvider;</span>
<a href="#l3.1808"></a><span id="l3.1808" class="difflineat">@@ -1891,287 +1820,264 @@ function convertListItemsToRegularAttach</span>
<a href="#l3.1809"></a><span id="l3.1809">   // it may be needed to identify the attachment. But clear it out now.</span>
<a href="#l3.1810"></a><span id="l3.1810">   for (let item of aItems)</span>
<a href="#l3.1811"></a><span id="l3.1811">     delete item.attachment.contentLocation;</span>
<a href="#l3.1812"></a><span id="l3.1812"> }</span>
<a href="#l3.1813"></a><span id="l3.1813"> </span>
<a href="#l3.1814"></a><span id="l3.1814"> /**</span>
<a href="#l3.1815"></a><span id="l3.1815">  * Convert the selected attachments to regular (non-cloud) attachments.</span>
<a href="#l3.1816"></a><span id="l3.1816">  */</span>
<a href="#l3.1817"></a><span id="l3.1817" class="difflineminus">-function convertSelectedToRegularAttachment()</span>
<a href="#l3.1818"></a><span id="l3.1818" class="difflineminus">-{</span>
<a href="#l3.1819"></a><span id="l3.1819" class="difflineplus">+function convertSelectedToRegularAttachment() {</span>
<a href="#l3.1820"></a><span id="l3.1820">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1821"></a><span id="l3.1821">   convertListItemsToRegularAttachment([...bucket.selectedItems]);</span>
<a href="#l3.1822"></a><span id="l3.1822"> }</span>
<a href="#l3.1823"></a><span id="l3.1823"> </span>
<a href="#l3.1824"></a><span id="l3.1824"> /**</span>
<a href="#l3.1825"></a><span id="l3.1825">  * Convert an array of nsIMsgAttachments to regular (non-cloud) attachments.</span>
<a href="#l3.1826"></a><span id="l3.1826">  *</span>
<a href="#l3.1827"></a><span id="l3.1827">  * @param aAttachments an array of nsIMsgAttachments</span>
<a href="#l3.1828"></a><span id="l3.1828">  */</span>
<a href="#l3.1829"></a><span id="l3.1829" class="difflineminus">-function convertToRegularAttachment(aAttachments)</span>
<a href="#l3.1830"></a><span id="l3.1830" class="difflineminus">-{</span>
<a href="#l3.1831"></a><span id="l3.1831" class="difflineplus">+function convertToRegularAttachment(aAttachments) {</span>
<a href="#l3.1832"></a><span id="l3.1832">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.1833"></a><span id="l3.1833">   let items = [];</span>
<a href="#l3.1834"></a><span id="l3.1834">   for (let attachment of aAttachments) {</span>
<a href="#l3.1835"></a><span id="l3.1835">     let item = bucket.findItemForAttachment(attachment);</span>
<a href="#l3.1836"></a><span id="l3.1836">     if (item)</span>
<a href="#l3.1837"></a><span id="l3.1837">       items.push(item);</span>
<a href="#l3.1838"></a><span id="l3.1838">   }</span>
<a href="#l3.1839"></a><span id="l3.1839"> </span>
<a href="#l3.1840"></a><span id="l3.1840">   convertListItemsToRegularAttachment(items);</span>
<a href="#l3.1841"></a><span id="l3.1841"> }</span>
<a href="#l3.1842"></a><span id="l3.1842"> </span>
<a href="#l3.1843"></a><span id="l3.1843" class="difflineminus">-function updateOptionItems()</span>
<a href="#l3.1844"></a><span id="l3.1844" class="difflineminus">-{</span>
<a href="#l3.1845"></a><span id="l3.1845" class="difflineplus">+function updateOptionItems() {</span>
<a href="#l3.1846"></a><span id="l3.1846">   goUpdateCommand(&quot;cmd_quoteMessage&quot;);</span>
<a href="#l3.1847"></a><span id="l3.1847"> }</span>
<a href="#l3.1848"></a><span id="l3.1848"> </span>
<a href="#l3.1849"></a><span id="l3.1849"> /* messageComposeOfflineQuitObserver is notified whenever the network</span>
<a href="#l3.1850"></a><span id="l3.1850">  * connection status has switched to offline, or when the application</span>
<a href="#l3.1851"></a><span id="l3.1851">  * has received a request to quit.</span>
<a href="#l3.1852"></a><span id="l3.1852">  */</span>
<a href="#l3.1853"></a><span id="l3.1853" class="difflineminus">-var messageComposeOfflineQuitObserver =</span>
<a href="#l3.1854"></a><span id="l3.1854" class="difflineminus">-{</span>
<a href="#l3.1855"></a><span id="l3.1855" class="difflineminus">-  observe: function(aSubject, aTopic, aData)</span>
<a href="#l3.1856"></a><span id="l3.1856" class="difflineminus">-  {</span>
<a href="#l3.1857"></a><span id="l3.1857" class="difflineplus">+var messageComposeOfflineQuitObserver = {</span>
<a href="#l3.1858"></a><span id="l3.1858" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.1859"></a><span id="l3.1859">     // sanity checks</span>
<a href="#l3.1860"></a><span id="l3.1860" class="difflineminus">-    if (aTopic == &quot;network:offline-status-changed&quot;)</span>
<a href="#l3.1861"></a><span id="l3.1861" class="difflineminus">-    {</span>
<a href="#l3.1862"></a><span id="l3.1862" class="difflineplus">+    if (aTopic == &quot;network:offline-status-changed&quot;) {</span>
<a href="#l3.1863"></a><span id="l3.1863">       MessageComposeOfflineStateChanged(Services.io.offline);</span>
<a href="#l3.1864"></a><span id="l3.1864" class="difflineplus">+    } else if (aTopic == &quot;quit-application-requested&quot;</span>
<a href="#l3.1865"></a><span id="l3.1865" class="difflineplus">+        &amp;&amp; (aSubject instanceof Ci.nsISupportsPRBool)</span>
<a href="#l3.1866"></a><span id="l3.1866" class="difflineplus">+        &amp;&amp; !aSubject.data) {</span>
<a href="#l3.1867"></a><span id="l3.1867" class="difflineplus">+      // Check whether to veto the quit request</span>
<a href="#l3.1868"></a><span id="l3.1868" class="difflineplus">+      // (unless another observer already did).</span>
<a href="#l3.1869"></a><span id="l3.1869" class="difflineplus">+      aSubject.data = !ComposeCanClose();</span>
<a href="#l3.1870"></a><span id="l3.1870">     }</span>
<a href="#l3.1871"></a><span id="l3.1871" class="difflineminus">-    // check whether to veto the quit request (unless another observer already</span>
<a href="#l3.1872"></a><span id="l3.1872" class="difflineminus">-    // did)</span>
<a href="#l3.1873"></a><span id="l3.1873" class="difflineminus">-    else if (aTopic == &quot;quit-application-requested&quot;</span>
<a href="#l3.1874"></a><span id="l3.1874" class="difflineminus">-        &amp;&amp; (aSubject instanceof Ci.nsISupportsPRBool)</span>
<a href="#l3.1875"></a><span id="l3.1875" class="difflineminus">-        &amp;&amp; !aSubject.data)</span>
<a href="#l3.1876"></a><span id="l3.1876" class="difflineminus">-      aSubject.data = !ComposeCanClose();</span>
<a href="#l3.1877"></a><span id="l3.1877" class="difflineminus">-  }</span>
<a href="#l3.1878"></a><span id="l3.1878" class="difflineminus">-}</span>
<a href="#l3.1879"></a><span id="l3.1879" class="difflineminus">-</span>
<a href="#l3.1880"></a><span id="l3.1880" class="difflineminus">-function AddMessageComposeOfflineQuitObserver()</span>
<a href="#l3.1881"></a><span id="l3.1881" class="difflineminus">-{</span>
<a href="#l3.1882"></a><span id="l3.1882" class="difflineplus">+  },</span>
<a href="#l3.1883"></a><span id="l3.1883" class="difflineplus">+};</span>
<a href="#l3.1884"></a><span id="l3.1884" class="difflineplus">+</span>
<a href="#l3.1885"></a><span id="l3.1885" class="difflineplus">+function AddMessageComposeOfflineQuitObserver() {</span>
<a href="#l3.1886"></a><span id="l3.1886">   Services.obs.addObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l3.1887"></a><span id="l3.1887">                            &quot;network:offline-status-changed&quot;);</span>
<a href="#l3.1888"></a><span id="l3.1888">   Services.obs.addObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l3.1889"></a><span id="l3.1889">                            &quot;quit-application-requested&quot;);</span>
<a href="#l3.1890"></a><span id="l3.1890"> </span>
<a href="#l3.1891"></a><span id="l3.1891">   // set the initial state of the send button</span>
<a href="#l3.1892"></a><span id="l3.1892">   MessageComposeOfflineStateChanged(Services.io.offline);</span>
<a href="#l3.1893"></a><span id="l3.1893"> }</span>
<a href="#l3.1894"></a><span id="l3.1894"> </span>
<a href="#l3.1895"></a><span id="l3.1895" class="difflineminus">-function RemoveMessageComposeOfflineQuitObserver()</span>
<a href="#l3.1896"></a><span id="l3.1896" class="difflineminus">-{</span>
<a href="#l3.1897"></a><span id="l3.1897" class="difflineplus">+function RemoveMessageComposeOfflineQuitObserver() {</span>
<a href="#l3.1898"></a><span id="l3.1898">   Services.obs.removeObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l3.1899"></a><span id="l3.1899">                               &quot;network:offline-status-changed&quot;);</span>
<a href="#l3.1900"></a><span id="l3.1900">   Services.obs.removeObserver(messageComposeOfflineQuitObserver,</span>
<a href="#l3.1901"></a><span id="l3.1901">                               &quot;quit-application-requested&quot;);</span>
<a href="#l3.1902"></a><span id="l3.1902"> }</span>
<a href="#l3.1903"></a><span id="l3.1903"> </span>
<a href="#l3.1904"></a><span id="l3.1904" class="difflineminus">-function MessageComposeOfflineStateChanged(goingOffline)</span>
<a href="#l3.1905"></a><span id="l3.1905" class="difflineminus">-{</span>
<a href="#l3.1906"></a><span id="l3.1906" class="difflineplus">+function MessageComposeOfflineStateChanged(goingOffline) {</span>
<a href="#l3.1907"></a><span id="l3.1907">   try {</span>
<a href="#l3.1908"></a><span id="l3.1908">     var sendButton = document.getElementById(&quot;button-send&quot;);</span>
<a href="#l3.1909"></a><span id="l3.1909">     var sendNowMenuItem = document.getElementById(&quot;menu-item-send-now&quot;);</span>
<a href="#l3.1910"></a><span id="l3.1910"> </span>
<a href="#l3.1911"></a><span id="l3.1911">     if (!gSavedSendNowKey) {</span>
<a href="#l3.1912"></a><span id="l3.1912" class="difflineminus">-      gSavedSendNowKey = sendNowMenuItem.getAttribute('key');</span>
<a href="#l3.1913"></a><span id="l3.1913" class="difflineplus">+      gSavedSendNowKey = sendNowMenuItem.getAttribute(&quot;key&quot;);</span>
<a href="#l3.1914"></a><span id="l3.1914">     }</span>
<a href="#l3.1915"></a><span id="l3.1915"> </span>
<a href="#l3.1916"></a><span id="l3.1916">     // don't use goUpdateCommand here ... the defaultController might not be installed yet</span>
<a href="#l3.1917"></a><span id="l3.1917">     updateSendCommands(false);</span>
<a href="#l3.1918"></a><span id="l3.1918"> </span>
<a href="#l3.1919"></a><span id="l3.1919" class="difflineminus">-    if (goingOffline)</span>
<a href="#l3.1920"></a><span id="l3.1920" class="difflineminus">-    {</span>
<a href="#l3.1921"></a><span id="l3.1921" class="difflineminus">-      sendButton.label = sendButton.getAttribute('later_label');</span>
<a href="#l3.1922"></a><span id="l3.1922" class="difflineminus">-      sendButton.setAttribute('tooltiptext', sendButton.getAttribute('later_tooltiptext'));</span>
<a href="#l3.1923"></a><span id="l3.1923" class="difflineminus">-      sendNowMenuItem.removeAttribute('key');</span>
<a href="#l3.1924"></a><span id="l3.1924" class="difflineminus">-    }</span>
<a href="#l3.1925"></a><span id="l3.1925" class="difflineminus">-    else</span>
<a href="#l3.1926"></a><span id="l3.1926" class="difflineminus">-    {</span>
<a href="#l3.1927"></a><span id="l3.1927" class="difflineminus">-      sendButton.label = sendButton.getAttribute('now_label');</span>
<a href="#l3.1928"></a><span id="l3.1928" class="difflineminus">-      sendButton.setAttribute('tooltiptext', sendButton.getAttribute('now_tooltiptext'));</span>
<a href="#l3.1929"></a><span id="l3.1929" class="difflineplus">+    if (goingOffline) {</span>
<a href="#l3.1930"></a><span id="l3.1930" class="difflineplus">+      sendButton.label = sendButton.getAttribute(&quot;later_label&quot;);</span>
<a href="#l3.1931"></a><span id="l3.1931" class="difflineplus">+      sendButton.setAttribute(&quot;tooltiptext&quot;, sendButton.getAttribute(&quot;later_tooltiptext&quot;));</span>
<a href="#l3.1932"></a><span id="l3.1932" class="difflineplus">+      sendNowMenuItem.removeAttribute(&quot;key&quot;);</span>
<a href="#l3.1933"></a><span id="l3.1933" class="difflineplus">+    } else {</span>
<a href="#l3.1934"></a><span id="l3.1934" class="difflineplus">+      sendButton.label = sendButton.getAttribute(&quot;now_label&quot;);</span>
<a href="#l3.1935"></a><span id="l3.1935" class="difflineplus">+      sendButton.setAttribute(&quot;tooltiptext&quot;, sendButton.getAttribute(&quot;now_tooltiptext&quot;));</span>
<a href="#l3.1936"></a><span id="l3.1936">       if (gSavedSendNowKey) {</span>
<a href="#l3.1937"></a><span id="l3.1937" class="difflineminus">-        sendNowMenuItem.setAttribute('key', gSavedSendNowKey);</span>
<a href="#l3.1938"></a><span id="l3.1938" class="difflineplus">+        sendNowMenuItem.setAttribute(&quot;key&quot;, gSavedSendNowKey);</span>
<a href="#l3.1939"></a><span id="l3.1939">       }</span>
<a href="#l3.1940"></a><span id="l3.1940">     }</span>
<a href="#l3.1941"></a><span id="l3.1941" class="difflineminus">-</span>
<a href="#l3.1942"></a><span id="l3.1942" class="difflineminus">-  } catch(e) {}</span>
<a href="#l3.1943"></a><span id="l3.1943" class="difflineminus">-}</span>
<a href="#l3.1944"></a><span id="l3.1944" class="difflineminus">-</span>
<a href="#l3.1945"></a><span id="l3.1945" class="difflineminus">-function DoCommandClose()</span>
<a href="#l3.1946"></a><span id="l3.1946" class="difflineminus">-{</span>
<a href="#l3.1947"></a><span id="l3.1947" class="difflineplus">+  } catch (e) {}</span>
<a href="#l3.1948"></a><span id="l3.1948" class="difflineplus">+}</span>
<a href="#l3.1949"></a><span id="l3.1949" class="difflineplus">+</span>
<a href="#l3.1950"></a><span id="l3.1950" class="difflineplus">+function DoCommandClose() {</span>
<a href="#l3.1951"></a><span id="l3.1951">   if (ComposeCanClose()) {</span>
<a href="#l3.1952"></a><span id="l3.1952"> </span>
<a href="#l3.1953"></a><span id="l3.1953">     // Notify the SendListener that Send has been aborted and Stopped</span>
<a href="#l3.1954"></a><span id="l3.1954">     if (gMsgCompose)</span>
<a href="#l3.1955"></a><span id="l3.1955">       gMsgCompose.onSendNotPerformed(null, Cr.NS_ERROR_ABORT);</span>
<a href="#l3.1956"></a><span id="l3.1956"> </span>
<a href="#l3.1957"></a><span id="l3.1957">     // This destroys the window for us.</span>
<a href="#l3.1958"></a><span id="l3.1958">     MsgComposeCloseWindow();</span>
<a href="#l3.1959"></a><span id="l3.1959">   }</span>
<a href="#l3.1960"></a><span id="l3.1960"> </span>
<a href="#l3.1961"></a><span id="l3.1961">   return false;</span>
<a href="#l3.1962"></a><span id="l3.1962"> }</span>
<a href="#l3.1963"></a><span id="l3.1963"> </span>
<a href="#l3.1964"></a><span id="l3.1964" class="difflineminus">-function DoCommandPrint()</span>
<a href="#l3.1965"></a><span id="l3.1965" class="difflineminus">-{</span>
<a href="#l3.1966"></a><span id="l3.1966" class="difflineplus">+function DoCommandPrint() {</span>
<a href="#l3.1967"></a><span id="l3.1967">   try {</span>
<a href="#l3.1968"></a><span id="l3.1968">     let editor = GetCurrentEditorElement();</span>
<a href="#l3.1969"></a><span id="l3.1969">     PrintUtils.printWindow(editor.outerWindowID, editor);</span>
<a href="#l3.1970"></a><span id="l3.1970" class="difflineminus">-  } catch(ex) {dump(&quot;#PRINT ERROR: &quot; + ex + &quot;\n&quot;);}</span>
<a href="#l3.1971"></a><span id="l3.1971" class="difflineminus">-}</span>
<a href="#l3.1972"></a><span id="l3.1972" class="difflineminus">-</span>
<a href="#l3.1973"></a><span id="l3.1973" class="difflineminus">-function DoCommandPrintPreview()</span>
<a href="#l3.1974"></a><span id="l3.1974" class="difflineminus">-{</span>
<a href="#l3.1975"></a><span id="l3.1975" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.1976"></a><span id="l3.1976" class="difflineplus">+    dump(&quot;#PRINT ERROR: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.1977"></a><span id="l3.1977" class="difflineplus">+  }</span>
<a href="#l3.1978"></a><span id="l3.1978" class="difflineplus">+}</span>
<a href="#l3.1979"></a><span id="l3.1979" class="difflineplus">+</span>
<a href="#l3.1980"></a><span id="l3.1980" class="difflineplus">+function DoCommandPrintPreview() {</span>
<a href="#l3.1981"></a><span id="l3.1981">   try {</span>
<a href="#l3.1982"></a><span id="l3.1982">     PrintUtils.printPreview(PrintPreviewListener);</span>
<a href="#l3.1983"></a><span id="l3.1983" class="difflineminus">-    } catch(ex) { Cu.reportError(ex); }</span>
<a href="#l3.1984"></a><span id="l3.1984" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.1985"></a><span id="l3.1985" class="difflineplus">+    Cu.reportError(ex);</span>
<a href="#l3.1986"></a><span id="l3.1986" class="difflineplus">+  }</span>
<a href="#l3.1987"></a><span id="l3.1987"> }</span>
<a href="#l3.1988"></a><span id="l3.1988"> </span>
<a href="#l3.1989"></a><span id="l3.1989"> /**</span>
<a href="#l3.1990"></a><span id="l3.1990">  * Locks/Unlocks the window widgets while a message is being saved/sent.</span>
<a href="#l3.1991"></a><span id="l3.1991">  * Locking means to disable all possible items in the window so that</span>
<a href="#l3.1992"></a><span id="l3.1992">  * the user can't click/activate anything.</span>
<a href="#l3.1993"></a><span id="l3.1993">  *</span>
<a href="#l3.1994"></a><span id="l3.1994">  * @param aDisable  true = lock the window. false = unlock the window.</span>
<a href="#l3.1995"></a><span id="l3.1995">  */</span>
<a href="#l3.1996"></a><span id="l3.1996" class="difflineminus">-function ToggleWindowLock(aDisable)</span>
<a href="#l3.1997"></a><span id="l3.1997" class="difflineminus">-{</span>
<a href="#l3.1998"></a><span id="l3.1998" class="difflineplus">+function ToggleWindowLock(aDisable) {</span>
<a href="#l3.1999"></a><span id="l3.1999">   gWindowLocked = aDisable;</span>
<a href="#l3.2000"></a><span id="l3.2000">   updateAllItems(aDisable);</span>
<a href="#l3.2001"></a><span id="l3.2001">   updateEditableFields(aDisable);</span>
<a href="#l3.2002"></a><span id="l3.2002">   if (!aDisable)</span>
<a href="#l3.2003"></a><span id="l3.2003">     updateComposeItems();</span>
<a href="#l3.2004"></a><span id="l3.2004"> }</span>
<a href="#l3.2005"></a><span id="l3.2005"> </span>
<a href="#l3.2006"></a><span id="l3.2006"> /* This function will go away soon as now arguments are passed to the window using a object of type nsMsgComposeParams instead of a string */</span>
<a href="#l3.2007"></a><span id="l3.2007" class="difflineminus">-function GetArgs(originalData)</span>
<a href="#l3.2008"></a><span id="l3.2008" class="difflineminus">-{</span>
<a href="#l3.2009"></a><span id="l3.2009" class="difflineminus">-  var args = new Object();</span>
<a href="#l3.2010"></a><span id="l3.2010" class="difflineplus">+function GetArgs(originalData) {</span>
<a href="#l3.2011"></a><span id="l3.2011" class="difflineplus">+  var args = {};</span>
<a href="#l3.2012"></a><span id="l3.2012"> </span>
<a href="#l3.2013"></a><span id="l3.2013">   if (originalData == &quot;&quot;)</span>
<a href="#l3.2014"></a><span id="l3.2014">     return null;</span>
<a href="#l3.2015"></a><span id="l3.2015"> </span>
<a href="#l3.2016"></a><span id="l3.2016">   var data = &quot;&quot;;</span>
<a href="#l3.2017"></a><span id="l3.2017">   var separator = String.fromCharCode(1);</span>
<a href="#l3.2018"></a><span id="l3.2018"> </span>
<a href="#l3.2019"></a><span id="l3.2019">   var quoteChar = &quot;&quot;;</span>
<a href="#l3.2020"></a><span id="l3.2020">   var prevChar = &quot;&quot;;</span>
<a href="#l3.2021"></a><span id="l3.2021">   var nextChar = &quot;&quot;;</span>
<a href="#l3.2022"></a><span id="l3.2022" class="difflineminus">-  for (let i = 0; i &lt; originalData.length; i++, prevChar = aChar)</span>
<a href="#l3.2023"></a><span id="l3.2023" class="difflineminus">-  {</span>
<a href="#l3.2024"></a><span id="l3.2024" class="difflineminus">-    var aChar = originalData.charAt(i)</span>
<a href="#l3.2025"></a><span id="l3.2025" class="difflineminus">-    var aCharCode = originalData.charCodeAt(i)</span>
<a href="#l3.2026"></a><span id="l3.2026" class="difflineplus">+  for (let i = 0; i &lt; originalData.length; i++, prevChar = aChar) {</span>
<a href="#l3.2027"></a><span id="l3.2027" class="difflineplus">+    var aChar = originalData.charAt(i);</span>
<a href="#l3.2028"></a><span id="l3.2028" class="difflineplus">+    var aCharCode = originalData.charCodeAt(i);</span>
<a href="#l3.2029"></a><span id="l3.2029">     if ( i &lt; originalData.length - 1)</span>
<a href="#l3.2030"></a><span id="l3.2030">       nextChar = originalData.charAt(i + 1);</span>
<a href="#l3.2031"></a><span id="l3.2031">     else</span>
<a href="#l3.2032"></a><span id="l3.2032">       nextChar = &quot;&quot;;</span>
<a href="#l3.2033"></a><span id="l3.2033"> </span>
<a href="#l3.2034"></a><span id="l3.2034" class="difflineminus">-    if (aChar == quoteChar &amp;&amp; (nextChar == &quot;,&quot; || nextChar == &quot;&quot;))</span>
<a href="#l3.2035"></a><span id="l3.2035" class="difflineminus">-    {</span>
<a href="#l3.2036"></a><span id="l3.2036" class="difflineplus">+    if (aChar == quoteChar &amp;&amp; (nextChar == &quot;,&quot; || nextChar == &quot;&quot;)) {</span>
<a href="#l3.2037"></a><span id="l3.2037">       quoteChar = &quot;&quot;;</span>
<a href="#l3.2038"></a><span id="l3.2038">       data += aChar;</span>
<a href="#l3.2039"></a><span id="l3.2039" class="difflineminus">-    }</span>
<a href="#l3.2040"></a><span id="l3.2040" class="difflineminus">-    else if ((aCharCode == 39 || aCharCode == 34) &amp;&amp; prevChar == &quot;=&quot;) //quote or double quote</span>
<a href="#l3.2041"></a><span id="l3.2041" class="difflineminus">-    {</span>
<a href="#l3.2042"></a><span id="l3.2042" class="difflineplus">+    } else if ((aCharCode == 39 || aCharCode == 34) &amp;&amp; prevChar == &quot;=&quot;) { // quote or double quote</span>
<a href="#l3.2043"></a><span id="l3.2043">       if (quoteChar == &quot;&quot;)</span>
<a href="#l3.2044"></a><span id="l3.2044">         quoteChar = aChar;</span>
<a href="#l3.2045"></a><span id="l3.2045">       data += aChar;</span>
<a href="#l3.2046"></a><span id="l3.2046" class="difflineminus">-    }</span>
<a href="#l3.2047"></a><span id="l3.2047" class="difflineminus">-    else if (aChar == &quot;,&quot;)</span>
<a href="#l3.2048"></a><span id="l3.2048" class="difflineminus">-    {</span>
<a href="#l3.2049"></a><span id="l3.2049" class="difflineplus">+    } else if (aChar == &quot;,&quot;) {</span>
<a href="#l3.2050"></a><span id="l3.2050">       if (quoteChar == &quot;&quot;)</span>
<a href="#l3.2051"></a><span id="l3.2051">         data += separator;</span>
<a href="#l3.2052"></a><span id="l3.2052">       else</span>
<a href="#l3.2053"></a><span id="l3.2053" class="difflineminus">-        data += aChar</span>
<a href="#l3.2054"></a><span id="l3.2054" class="difflineplus">+        data += aChar;</span>
<a href="#l3.2055"></a><span id="l3.2055" class="difflineplus">+    } else {</span>
<a href="#l3.2056"></a><span id="l3.2056" class="difflineplus">+      data += aChar;</span>
<a href="#l3.2057"></a><span id="l3.2057">     }</span>
<a href="#l3.2058"></a><span id="l3.2058" class="difflineminus">-    else</span>
<a href="#l3.2059"></a><span id="l3.2059" class="difflineminus">-      data += aChar</span>
<a href="#l3.2060"></a><span id="l3.2060">   }</span>
<a href="#l3.2061"></a><span id="l3.2061"> </span>
<a href="#l3.2062"></a><span id="l3.2062">   var pairs = data.split(separator);</span>
<a href="#l3.2063"></a><span id="l3.2063" class="difflineminus">-//  dump(&quot;Compose: argument: {&quot; + data + &quot;}\n&quot;);</span>
<a href="#l3.2064"></a><span id="l3.2064" class="difflineminus">-</span>
<a href="#l3.2065"></a><span id="l3.2065" class="difflineminus">-  for (let i = pairs.length - 1; i &gt;= 0; i--)</span>
<a href="#l3.2066"></a><span id="l3.2066" class="difflineminus">-  {</span>
<a href="#l3.2067"></a><span id="l3.2067" class="difflineminus">-    var pos = pairs[i].indexOf('=');</span>
<a href="#l3.2068"></a><span id="l3.2068" class="difflineplus">+  // dump(&quot;Compose: argument: {&quot; + data + &quot;}\n&quot;);</span>
<a href="#l3.2069"></a><span id="l3.2069" class="difflineplus">+</span>
<a href="#l3.2070"></a><span id="l3.2070" class="difflineplus">+  for (let i = pairs.length - 1; i &gt;= 0; i--) {</span>
<a href="#l3.2071"></a><span id="l3.2071" class="difflineplus">+    var pos = pairs[i].indexOf(&quot;=&quot;);</span>
<a href="#l3.2072"></a><span id="l3.2072">     if (pos == -1)</span>
<a href="#l3.2073"></a><span id="l3.2073">       continue;</span>
<a href="#l3.2074"></a><span id="l3.2074">     var argname = pairs[i].substring(0, pos);</span>
<a href="#l3.2075"></a><span id="l3.2075">     var argvalue = pairs[i].substring(pos + 1);</span>
<a href="#l3.2076"></a><span id="l3.2076" class="difflineminus">-    if (argvalue.startsWith(&quot;'&quot;) &amp;&amp; argvalue.endsWith(&quot;'&quot;))</span>
<a href="#l3.2077"></a><span id="l3.2077" class="difflineplus">+    if (argvalue.startsWith(&quot;'&quot;) &amp;&amp; argvalue.endsWith(&quot;'&quot;)) {</span>
<a href="#l3.2078"></a><span id="l3.2078">       args[argname] = argvalue.substring(1, argvalue.length - 1);</span>
<a href="#l3.2079"></a><span id="l3.2079" class="difflineminus">-    else</span>
<a href="#l3.2080"></a><span id="l3.2080" class="difflineplus">+    } else {</span>
<a href="#l3.2081"></a><span id="l3.2081">       try {</span>
<a href="#l3.2082"></a><span id="l3.2082">         args[argname] = decodeURIComponent(argvalue);</span>
<a href="#l3.2083"></a><span id="l3.2083" class="difflineminus">-      } catch (e) {args[argname] = argvalue;}</span>
<a href="#l3.2084"></a><span id="l3.2084" class="difflineplus">+      } catch (e) {</span>
<a href="#l3.2085"></a><span id="l3.2085" class="difflineplus">+        args[argname] = argvalue;</span>
<a href="#l3.2086"></a><span id="l3.2086" class="difflineplus">+      }</span>
<a href="#l3.2087"></a><span id="l3.2087" class="difflineplus">+    }</span>
<a href="#l3.2088"></a><span id="l3.2088">     // dump(&quot;[&quot; + argname + &quot;=&quot; + args[argname] + &quot;]\n&quot;);</span>
<a href="#l3.2089"></a><span id="l3.2089">   }</span>
<a href="#l3.2090"></a><span id="l3.2090">   return args;</span>
<a href="#l3.2091"></a><span id="l3.2091"> }</span>
<a href="#l3.2092"></a><span id="l3.2092"> </span>
<a href="#l3.2093"></a><span id="l3.2093" class="difflineminus">-function ComposeFieldsReady()</span>
<a href="#l3.2094"></a><span id="l3.2094" class="difflineminus">-{</span>
<a href="#l3.2095"></a><span id="l3.2095" class="difflineplus">+function ComposeFieldsReady() {</span>
<a href="#l3.2096"></a><span id="l3.2096">   // Limit the charsets to those we think are safe to encode (i.e., they are in</span>
<a href="#l3.2097"></a><span id="l3.2097">   // the charset menu). Easiest way to normalize this is to use the TextDecoder</span>
<a href="#l3.2098"></a><span id="l3.2098">   // to get the canonical alias and default if it isn't valid.</span>
<a href="#l3.2099"></a><span id="l3.2099">   let charset;</span>
<a href="#l3.2100"></a><span id="l3.2100">   try {</span>
<a href="#l3.2101"></a><span id="l3.2101">     charset = new TextDecoder(gMsgCompose.compFields.characterSet).encoding;</span>
<a href="#l3.2102"></a><span id="l3.2102">   } catch (e) {</span>
<a href="#l3.2103"></a><span id="l3.2103">     charset = gMsgCompose.compFields.defaultCharacterSet;</span>
<a href="#l3.2104"></a><span id="l3.2104">   }</span>
<a href="#l3.2105"></a><span id="l3.2105">   SetDocumentCharacterSet(charset);</span>
<a href="#l3.2106"></a><span id="l3.2106"> </span>
<a href="#l3.2107"></a><span id="l3.2107" class="difflineminus">-  //If we are in plain text, we need to set the wrap column</span>
<a href="#l3.2108"></a><span id="l3.2108" class="difflineminus">-  if (! gMsgCompose.composeHTML) {</span>
<a href="#l3.2109"></a><span id="l3.2109" class="difflineplus">+  // If we are in plain text, we need to set the wrap column</span>
<a href="#l3.2110"></a><span id="l3.2110" class="difflineplus">+  if (!gMsgCompose.composeHTML) {</span>
<a href="#l3.2111"></a><span id="l3.2111">     try {</span>
<a href="#l3.2112"></a><span id="l3.2112" class="difflineminus">-      gMsgCompose.editor.QueryInterface(nsIPlaintextEditorMail).wrapWidth</span>
<a href="#l3.2113"></a><span id="l3.2113" class="difflineplus">+      gMsgCompose.editor.QueryInterface(Ci.nsIPlaintextEditor).wrapWidth</span>
<a href="#l3.2114"></a><span id="l3.2114">           = gMsgCompose.wrapLength;</span>
<a href="#l3.2115"></a><span id="l3.2115" class="difflineminus">-    }</span>
<a href="#l3.2116"></a><span id="l3.2116" class="difflineminus">-    catch (e) {</span>
<a href="#l3.2117"></a><span id="l3.2117" class="difflineplus">+    } catch (e) {</span>
<a href="#l3.2118"></a><span id="l3.2118">       dump(&quot;### textEditor.wrapWidth exception text: &quot; + e + &quot; - failed\n&quot;);</span>
<a href="#l3.2119"></a><span id="l3.2119">     }</span>
<a href="#l3.2120"></a><span id="l3.2120">   }</span>
<a href="#l3.2121"></a><span id="l3.2121">   CompFields2Recipients(gMsgCompose.compFields);</span>
<a href="#l3.2122"></a><span id="l3.2122">   SetComposeWindowTitle();</span>
<a href="#l3.2123"></a><span id="l3.2123">   updateEditableFields(false);</span>
<a href="#l3.2124"></a><span id="l3.2124"> }</span>
<a href="#l3.2125"></a><span id="l3.2125"> </span>
<a href="#l3.2126"></a><span id="l3.2126"> // checks if the passed in string is a mailto url, if it is, generates nsIMsgComposeParams</span>
<a href="#l3.2127"></a><span id="l3.2127"> // for the url and returns them.</span>
<a href="#l3.2128"></a><span id="l3.2128" class="difflineminus">-function handleMailtoArgs(mailtoUrl)</span>
<a href="#l3.2129"></a><span id="l3.2129" class="difflineminus">-{</span>
<a href="#l3.2130"></a><span id="l3.2130" class="difflineplus">+function handleMailtoArgs(mailtoUrl) {</span>
<a href="#l3.2131"></a><span id="l3.2131">   // see if the string is a mailto url....do this by checking the first 7 characters of the string</span>
<a href="#l3.2132"></a><span id="l3.2132" class="difflineminus">-  if (mailtoUrl.toLowerCase().startsWith(&quot;mailto:&quot;))</span>
<a href="#l3.2133"></a><span id="l3.2133" class="difflineminus">-  {</span>
<a href="#l3.2134"></a><span id="l3.2134" class="difflineplus">+  if (mailtoUrl.toLowerCase().startsWith(&quot;mailto:&quot;)) {</span>
<a href="#l3.2135"></a><span id="l3.2135">     // if it is a mailto url, turn the mailto url into a MsgComposeParams object....</span>
<a href="#l3.2136"></a><span id="l3.2136">     let uri = Services.io.newURI(mailtoUrl);</span>
<a href="#l3.2137"></a><span id="l3.2137"> </span>
<a href="#l3.2138"></a><span id="l3.2138">     if (uri) {</span>
<a href="#l3.2139"></a><span id="l3.2139">       return MailServices.compose.getParamsForMailto(uri);</span>
<a href="#l3.2140"></a><span id="l3.2140">     }</span>
<a href="#l3.2141"></a><span id="l3.2141">   }</span>
<a href="#l3.2142"></a><span id="l3.2142"> </span>
<a href="#l3.2143"></a><span id="l3.2143">   return null;</span>
<a href="#l3.2144"></a><span id="l3.2144"> }</span>
<a href="#l3.2145"></a><span id="l3.2145"> </span>
<a href="#l3.2146"></a><span id="l3.2146"> /**</span>
<a href="#l3.2147"></a><span id="l3.2147">  * Handle ESC keypress from composition window for</span>
<a href="#l3.2148"></a><span id="l3.2148">  * notifications with close button in the</span>
<a href="#l3.2149"></a><span id="l3.2149">  * attachmentNotificationBox.</span>
<a href="#l3.2150"></a><span id="l3.2150">  */</span>
<a href="#l3.2151"></a><span id="l3.2151" class="difflineminus">-function handleEsc()</span>
<a href="#l3.2152"></a><span id="l3.2152" class="difflineminus">-{</span>
<a href="#l3.2153"></a><span id="l3.2153" class="difflineplus">+function handleEsc() {</span>
<a href="#l3.2154"></a><span id="l3.2154">   let activeElement = document.activeElement;</span>
<a href="#l3.2155"></a><span id="l3.2155"> </span>
<a href="#l3.2156"></a><span id="l3.2156">   // If findbar is visible and the focus is in the message body,</span>
<a href="#l3.2157"></a><span id="l3.2157">   // hide it. (Focus on the findbar is handled by findbar itself).</span>
<a href="#l3.2158"></a><span id="l3.2158" class="difflineminus">-  let findbar = document.getElementById('FindToolbar');</span>
<a href="#l3.2159"></a><span id="l3.2159" class="difflineplus">+  let findbar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l3.2160"></a><span id="l3.2160">   if (!findbar.hidden &amp;&amp; activeElement.id == &quot;content-frame&quot;) {</span>
<a href="#l3.2161"></a><span id="l3.2161">     findbar.close();</span>
<a href="#l3.2162"></a><span id="l3.2162">     return;</span>
<a href="#l3.2163"></a><span id="l3.2163">   }</span>
<a href="#l3.2164"></a><span id="l3.2164"> </span>
<a href="#l3.2165"></a><span id="l3.2165">   // If there is a notification in the attachmentNotificationBox</span>
<a href="#l3.2166"></a><span id="l3.2166">   // AND focus is in message body, subject field or on the notification,</span>
<a href="#l3.2167"></a><span id="l3.2167">   // hide it.</span>
<a href="#l3.2168"></a><span id="l3.2168" class="difflineat">@@ -2180,18 +2086,17 @@ function handleEsc()</span>
<a href="#l3.2169"></a><span id="l3.2169">   if (notification &amp;&amp; (activeElement.id == &quot;content-frame&quot; ||</span>
<a href="#l3.2170"></a><span id="l3.2170">       activeElement.parentNode.parentNode.id == &quot;msgSubject&quot; ||</span>
<a href="#l3.2171"></a><span id="l3.2171">       notification.contains(activeElement) ||</span>
<a href="#l3.2172"></a><span id="l3.2172">       activeElement.classList.contains(&quot;messageCloseButton&quot;))) {</span>
<a href="#l3.2173"></a><span id="l3.2173">     notification.close();</span>
<a href="#l3.2174"></a><span id="l3.2174">   }</span>
<a href="#l3.2175"></a><span id="l3.2175"> }</span>
<a href="#l3.2176"></a><span id="l3.2176"> </span>
<a href="#l3.2177"></a><span id="l3.2177" class="difflineminus">-function disableAttachmentReminder()</span>
<a href="#l3.2178"></a><span id="l3.2178" class="difflineminus">-{</span>
<a href="#l3.2179"></a><span id="l3.2179" class="difflineplus">+function disableAttachmentReminder() {</span>
<a href="#l3.2180"></a><span id="l3.2180">   gDisableAttachmentReminder = true;</span>
<a href="#l3.2181"></a><span id="l3.2181">   toggleAttachmentReminder(false);</span>
<a href="#l3.2182"></a><span id="l3.2182"> }</span>
<a href="#l3.2183"></a><span id="l3.2183"> </span>
<a href="#l3.2184"></a><span id="l3.2184"> /**</span>
<a href="#l3.2185"></a><span id="l3.2185">  * This state machine manages all showing and hiding of the attachment</span>
<a href="#l3.2186"></a><span id="l3.2186">  * notification bar. It is only called if any change happened so that</span>
<a href="#l3.2187"></a><span id="l3.2187">  * recalculating of the notification is needed:</span>
<a href="#l3.2188"></a><span id="l3.2188" class="difflineat">@@ -2207,18 +2112,17 @@ function disableAttachmentReminder()</span>
<a href="#l3.2189"></a><span id="l3.2189">  * keywords and attachments were removed (but not when we have keywords and</span>
<a href="#l3.2190"></a><span id="l3.2190">  * manual reminder was just turned off). We always show the notification</span>
<a href="#l3.2191"></a><span id="l3.2191">  * again if keywords change (if no attachments and no manual reminder).</span>
<a href="#l3.2192"></a><span id="l3.2192">  *</span>
<a href="#l3.2193"></a><span id="l3.2193">  * @param aForce  If set to true, notification will be shown immediately if</span>
<a href="#l3.2194"></a><span id="l3.2194">  *                there are any keywords. If set to false, it is shown only when</span>
<a href="#l3.2195"></a><span id="l3.2195">  *                they have changed.</span>
<a href="#l3.2196"></a><span id="l3.2196">  */</span>
<a href="#l3.2197"></a><span id="l3.2197" class="difflineminus">-function manageAttachmentNotification(aForce = false)</span>
<a href="#l3.2198"></a><span id="l3.2198" class="difflineminus">-{</span>
<a href="#l3.2199"></a><span id="l3.2199" class="difflineplus">+function manageAttachmentNotification(aForce = false) {</span>
<a href="#l3.2200"></a><span id="l3.2200">   let keywords;</span>
<a href="#l3.2201"></a><span id="l3.2201">   let keywordsCount = 0;</span>
<a href="#l3.2202"></a><span id="l3.2202"> </span>
<a href="#l3.2203"></a><span id="l3.2203">   // First see if the notification is to be hidden due to reasons other than</span>
<a href="#l3.2204"></a><span id="l3.2204">   // not having keywords.</span>
<a href="#l3.2205"></a><span id="l3.2205">   let removeNotification = attachmentNotificationSupressed();</span>
<a href="#l3.2206"></a><span id="l3.2206"> </span>
<a href="#l3.2207"></a><span id="l3.2207">   // If that is not true, we need to look at the state of keywords.</span>
<a href="#l3.2208"></a><span id="l3.2208" class="difflineat">@@ -2283,41 +2187,41 @@ function manageAttachmentNotification(aF</span>
<a href="#l3.2209"></a><span id="l3.2209">   msgText.setAttribute(&quot;value&quot;, textValue);</span>
<a href="#l3.2210"></a><span id="l3.2210">   let msgKeywords = document.createElement(&quot;label&quot;);</span>
<a href="#l3.2211"></a><span id="l3.2211">   msg.appendChild(msgKeywords);</span>
<a href="#l3.2212"></a><span id="l3.2212">   msgKeywords.id = &quot;attachmentKeywords&quot;;</span>
<a href="#l3.2213"></a><span id="l3.2213">   msgKeywords.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l3.2214"></a><span id="l3.2214">   msgKeywords.setAttribute(&quot;flex&quot;, &quot;1000&quot;);</span>
<a href="#l3.2215"></a><span id="l3.2215">   msgKeywords.setAttribute(&quot;value&quot;, keywords);</span>
<a href="#l3.2216"></a><span id="l3.2216">   let addButton = {</span>
<a href="#l3.2217"></a><span id="l3.2217" class="difflineminus">-    accessKey : getComposeBundle().getString(&quot;addAttachmentButton.accesskey&quot;),</span>
<a href="#l3.2218"></a><span id="l3.2218" class="difflineplus">+    accessKey: getComposeBundle().getString(&quot;addAttachmentButton.accesskey&quot;),</span>
<a href="#l3.2219"></a><span id="l3.2219">     label: getComposeBundle().getString(&quot;addAttachmentButton&quot;),</span>
<a href="#l3.2220"></a><span id="l3.2220" class="difflineminus">-    callback: function (aNotificationBar, aButton) {</span>
<a href="#l3.2221"></a><span id="l3.2221" class="difflineplus">+    callback(aNotificationBar, aButton) {</span>
<a href="#l3.2222"></a><span id="l3.2222">       goDoCommand(&quot;cmd_attachFile&quot;);</span>
<a href="#l3.2223"></a><span id="l3.2223">       return true; // keep notification open (the state machine will decide on it later)</span>
<a href="#l3.2224"></a><span id="l3.2224" class="difflineminus">-    }</span>
<a href="#l3.2225"></a><span id="l3.2225" class="difflineplus">+    },</span>
<a href="#l3.2226"></a><span id="l3.2226">   };</span>
<a href="#l3.2227"></a><span id="l3.2227"> </span>
<a href="#l3.2228"></a><span id="l3.2228">   let remindLaterMenuPopup = document.createElement(&quot;menupopup&quot;);</span>
<a href="#l3.2229"></a><span id="l3.2229">   remindLaterMenuPopup.id = &quot;reminderBarPopup&quot;;</span>
<a href="#l3.2230"></a><span id="l3.2230">   let disableAttachmentReminder = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l3.2231"></a><span id="l3.2231">   disableAttachmentReminder.id = &quot;disableReminder&quot;;</span>
<a href="#l3.2232"></a><span id="l3.2232">   disableAttachmentReminder.setAttribute(&quot;label&quot;,</span>
<a href="#l3.2233"></a><span id="l3.2233">     getComposeBundle().getString(&quot;disableAttachmentReminderButton&quot;));</span>
<a href="#l3.2234"></a><span id="l3.2234">   disableAttachmentReminder.setAttribute(&quot;command&quot;, &quot;cmd_doNotRemindForAttachments&quot;);</span>
<a href="#l3.2235"></a><span id="l3.2235">   remindLaterMenuPopup.appendChild(disableAttachmentReminder);</span>
<a href="#l3.2236"></a><span id="l3.2236"> </span>
<a href="#l3.2237"></a><span id="l3.2237">   let remindButton = {</span>
<a href="#l3.2238"></a><span id="l3.2238">     type: &quot;menu-button&quot;,</span>
<a href="#l3.2239"></a><span id="l3.2239" class="difflineminus">-    accessKey : getComposeBundle().getString(&quot;remindLaterButton.accesskey&quot;),</span>
<a href="#l3.2240"></a><span id="l3.2240" class="difflineplus">+    accessKey: getComposeBundle().getString(&quot;remindLaterButton.accesskey&quot;),</span>
<a href="#l3.2241"></a><span id="l3.2241">     label: getComposeBundle().getString(&quot;remindLaterButton&quot;),</span>
<a href="#l3.2242"></a><span id="l3.2242">     popup: remindLaterMenuPopup,</span>
<a href="#l3.2243"></a><span id="l3.2243" class="difflineminus">-    callback: function (aNotificationBar, aButton) {</span>
<a href="#l3.2244"></a><span id="l3.2244" class="difflineplus">+    callback(aNotificationBar, aButton) {</span>
<a href="#l3.2245"></a><span id="l3.2245">       toggleAttachmentReminder(true);</span>
<a href="#l3.2246"></a><span id="l3.2246" class="difflineminus">-    }</span>
<a href="#l3.2247"></a><span id="l3.2247" class="difflineplus">+    },</span>
<a href="#l3.2248"></a><span id="l3.2248">   };</span>
<a href="#l3.2249"></a><span id="l3.2249"> </span>
<a href="#l3.2250"></a><span id="l3.2250">   notification = nBox.appendNotification(&quot;&quot;, &quot;attachmentReminder&quot;,</span>
<a href="#l3.2251"></a><span id="l3.2251">                                /* fake out the image so we can do it in CSS */</span>
<a href="#l3.2252"></a><span id="l3.2252">                                &quot;null&quot;,</span>
<a href="#l3.2253"></a><span id="l3.2253">                                nBox.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l3.2254"></a><span id="l3.2254">                                [addButton, remindButton]);</span>
<a href="#l3.2255"></a><span id="l3.2255">   let buttons = notification.childNodes[0];</span>
<a href="#l3.2256"></a><span id="l3.2256" class="difflineat">@@ -2334,35 +2238,33 @@ function attachmentNotificationSupressed</span>
<a href="#l3.2257"></a><span id="l3.2257"> }</span>
<a href="#l3.2258"></a><span id="l3.2258"> </span>
<a href="#l3.2259"></a><span id="l3.2259"> var attachmentWorker = new Worker(&quot;resource:///modules/attachmentChecker.js&quot;);</span>
<a href="#l3.2260"></a><span id="l3.2260"> </span>
<a href="#l3.2261"></a><span id="l3.2261"> // The array of currently found keywords. Or null if keyword detection wasn't</span>
<a href="#l3.2262"></a><span id="l3.2262"> // run yet so we don't know.</span>
<a href="#l3.2263"></a><span id="l3.2263"> attachmentWorker.lastMessage = null;</span>
<a href="#l3.2264"></a><span id="l3.2264"> </span>
<a href="#l3.2265"></a><span id="l3.2265" class="difflineminus">-attachmentWorker.onerror = function(error)</span>
<a href="#l3.2266"></a><span id="l3.2266" class="difflineminus">-{</span>
<a href="#l3.2267"></a><span id="l3.2267" class="difflineplus">+attachmentWorker.onerror = function(error) {</span>
<a href="#l3.2268"></a><span id="l3.2268">   Cu.reportError(&quot;Attachment Notification Worker error!!! &quot; + error.message);</span>
<a href="#l3.2269"></a><span id="l3.2269">   throw error;</span>
<a href="#l3.2270"></a><span id="l3.2270"> };</span>
<a href="#l3.2271"></a><span id="l3.2271"> </span>
<a href="#l3.2272"></a><span id="l3.2272"> /**</span>
<a href="#l3.2273"></a><span id="l3.2273">  * Called when attachmentWorker finishes checking of the message for keywords.</span>
<a href="#l3.2274"></a><span id="l3.2274">  *</span>
<a href="#l3.2275"></a><span id="l3.2275">  * @param event    If defined, event.data contains an array of found keywords.</span>
<a href="#l3.2276"></a><span id="l3.2276">  * @param aManage  If set to true and we determine keywords have changed,</span>
<a href="#l3.2277"></a><span id="l3.2277">  *                 manage the notification.</span>
<a href="#l3.2278"></a><span id="l3.2278">  *                 If set to false, just store the new keyword list but do not</span>
<a href="#l3.2279"></a><span id="l3.2279">  *                 touch the notification. That effectively eats the</span>
<a href="#l3.2280"></a><span id="l3.2280">  *                 &quot;keywords changed&quot; event which usually shows the notification</span>
<a href="#l3.2281"></a><span id="l3.2281">  *                 if it was hidden. See manageAttachmentNotification().</span>
<a href="#l3.2282"></a><span id="l3.2282">  */</span>
<a href="#l3.2283"></a><span id="l3.2283" class="difflineminus">-attachmentWorker.onmessage = function(event, aManage = true)</span>
<a href="#l3.2284"></a><span id="l3.2284" class="difflineminus">-{</span>
<a href="#l3.2285"></a><span id="l3.2285" class="difflineplus">+attachmentWorker.onmessage = function(event, aManage = true) {</span>
<a href="#l3.2286"></a><span id="l3.2286">   // Exit if keywords haven't changed.</span>
<a href="#l3.2287"></a><span id="l3.2287">   if (!event || (attachmentWorker.lastMessage &amp;&amp;</span>
<a href="#l3.2288"></a><span id="l3.2288">                 (event.data.toString() == attachmentWorker.lastMessage.toString())))</span>
<a href="#l3.2289"></a><span id="l3.2289">     return;</span>
<a href="#l3.2290"></a><span id="l3.2290"> </span>
<a href="#l3.2291"></a><span id="l3.2291">   let data = event ? event.data : [];</span>
<a href="#l3.2292"></a><span id="l3.2292">   attachmentWorker.lastMessage = data.slice(0);</span>
<a href="#l3.2293"></a><span id="l3.2293">   if (aManage)</span>
<a href="#l3.2294"></a><span id="l3.2294" class="difflineat">@@ -2401,17 +2303,17 @@ function AttachmentsChanged(aShowPane, a</span>
<a href="#l3.2295"></a><span id="l3.2295">  * 1) The dictionary that was selected in the preference is removed.</span>
<a href="#l3.2296"></a><span id="l3.2296">  * 2) The selected dictionary changes the way it announces itself to the system,</span>
<a href="#l3.2297"></a><span id="l3.2297">  *    so for example &quot;it_IT&quot; changes to &quot;it-IT&quot; and the previously stored</span>
<a href="#l3.2298"></a><span id="l3.2298">  *    preference value doesn't apply any more.</span>
<a href="#l3.2299"></a><span id="l3.2299">  */</span>
<a href="#l3.2300"></a><span id="l3.2300"> function getValidSpellcheckerDictionary(draftLanguage) {</span>
<a href="#l3.2301"></a><span id="l3.2301">   let prefValue = Services.prefs.getCharPref(&quot;spellchecker.dictionary&quot;);</span>
<a href="#l3.2302"></a><span id="l3.2302">   let spellChecker = Cc[&quot;@mozilla.org/spellchecker/engine;1&quot;]</span>
<a href="#l3.2303"></a><span id="l3.2303" class="difflineminus">-                       .getService(mozISpellCheckingEngine);</span>
<a href="#l3.2304"></a><span id="l3.2304" class="difflineplus">+                       .getService(Ci.mozISpellCheckingEngine);</span>
<a href="#l3.2305"></a><span id="l3.2305">   let o1 = {};</span>
<a href="#l3.2306"></a><span id="l3.2306">   let o2 = {};</span>
<a href="#l3.2307"></a><span id="l3.2307">   spellChecker.getDictionaryList(o1, o2);</span>
<a href="#l3.2308"></a><span id="l3.2308">   let dictList = o1.value;</span>
<a href="#l3.2309"></a><span id="l3.2309">   let count    = o2.value;</span>
<a href="#l3.2310"></a><span id="l3.2310"> </span>
<a href="#l3.2311"></a><span id="l3.2311">   if (count == 0) {</span>
<a href="#l3.2312"></a><span id="l3.2312">     // If there are no dictionaries, we can't check the value, so return it.</span>
<a href="#l3.2313"></a><span id="l3.2313" class="difflineat">@@ -2428,25 +2330,24 @@ function getValidSpellcheckerDictionary(</span>
<a href="#l3.2314"></a><span id="l3.2314">     return prefValue;</span>
<a href="#l3.2315"></a><span id="l3.2315">   }</span>
<a href="#l3.2316"></a><span id="l3.2316"> </span>
<a href="#l3.2317"></a><span id="l3.2317">   // Set a valid value, any value will do.</span>
<a href="#l3.2318"></a><span id="l3.2318">   Services.prefs.setCharPref(&quot;spellchecker.dictionary&quot;, dictList[0]);</span>
<a href="#l3.2319"></a><span id="l3.2319">   return dictList[0];</span>
<a href="#l3.2320"></a><span id="l3.2320"> }</span>
<a href="#l3.2321"></a><span id="l3.2321"> </span>
<a href="#l3.2322"></a><span id="l3.2322" class="difflineminus">-var dictionaryRemovalObserver =</span>
<a href="#l3.2323"></a><span id="l3.2323" class="difflineminus">-{</span>
<a href="#l3.2324"></a><span id="l3.2324" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.2325"></a><span id="l3.2325" class="difflineplus">+var dictionaryRemovalObserver = {</span>
<a href="#l3.2326"></a><span id="l3.2326" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.2327"></a><span id="l3.2327">     if (aTopic != &quot;spellcheck-dictionary-remove&quot;) {</span>
<a href="#l3.2328"></a><span id="l3.2328">       return;</span>
<a href="#l3.2329"></a><span id="l3.2329">     }</span>
<a href="#l3.2330"></a><span id="l3.2330">     let language = document.documentElement.getAttribute(&quot;lang&quot;);</span>
<a href="#l3.2331"></a><span id="l3.2331">     let spellChecker = Cc[&quot;@mozilla.org/spellchecker/engine;1&quot;]</span>
<a href="#l3.2332"></a><span id="l3.2332" class="difflineminus">-                         .getService(mozISpellCheckingEngine);</span>
<a href="#l3.2333"></a><span id="l3.2333" class="difflineplus">+                         .getService(Ci.mozISpellCheckingEngine);</span>
<a href="#l3.2334"></a><span id="l3.2334">     let o1 = {};</span>
<a href="#l3.2335"></a><span id="l3.2335">     let o2 = {};</span>
<a href="#l3.2336"></a><span id="l3.2336">     spellChecker.getDictionaryList(o1, o2);</span>
<a href="#l3.2337"></a><span id="l3.2337">     let dictList = o1.value;</span>
<a href="#l3.2338"></a><span id="l3.2338">     let count    = o2.value;</span>
<a href="#l3.2339"></a><span id="l3.2339"> </span>
<a href="#l3.2340"></a><span id="l3.2340">     if (count &gt; 0 &amp;&amp; dictList.includes(language)) {</span>
<a href="#l3.2341"></a><span id="l3.2341">       // There still is a dictionary for the language of the document.</span>
<a href="#l3.2342"></a><span id="l3.2342" class="difflineat">@@ -2462,28 +2363,28 @@ var dictionaryRemovalObserver =</span>
<a href="#l3.2343"></a><span id="l3.2343">       // Fix the preference while we're here. We know it's invalid.</span>
<a href="#l3.2344"></a><span id="l3.2344">       Services.prefs.setCharPref(&quot;spellchecker.dictionary&quot;, language);</span>
<a href="#l3.2345"></a><span id="l3.2345">     }</span>
<a href="#l3.2346"></a><span id="l3.2346">     document.documentElement.setAttribute(&quot;lang&quot;, language);</span>
<a href="#l3.2347"></a><span id="l3.2347">   },</span>
<a href="#l3.2348"></a><span id="l3.2348"> </span>
<a href="#l3.2349"></a><span id="l3.2349">   isAdded: false,</span>
<a href="#l3.2350"></a><span id="l3.2350"> </span>
<a href="#l3.2351"></a><span id="l3.2351" class="difflineminus">-  addObserver: function() {</span>
<a href="#l3.2352"></a><span id="l3.2352" class="difflineplus">+  addObserver() {</span>
<a href="#l3.2353"></a><span id="l3.2353">     Services.obs.addObserver(this, &quot;spellcheck-dictionary-remove&quot;);</span>
<a href="#l3.2354"></a><span id="l3.2354">     this.isAdded = true;</span>
<a href="#l3.2355"></a><span id="l3.2355">   },</span>
<a href="#l3.2356"></a><span id="l3.2356"> </span>
<a href="#l3.2357"></a><span id="l3.2357" class="difflineminus">-  removeObserver: function() {</span>
<a href="#l3.2358"></a><span id="l3.2358" class="difflineplus">+  removeObserver() {</span>
<a href="#l3.2359"></a><span id="l3.2359">     if (this.isAdded) {</span>
<a href="#l3.2360"></a><span id="l3.2360">       Services.obs.removeObserver(this, &quot;spellcheck-dictionary-remove&quot;);</span>
<a href="#l3.2361"></a><span id="l3.2361">       this.isAdded = false;</span>
<a href="#l3.2362"></a><span id="l3.2362">     }</span>
<a href="#l3.2363"></a><span id="l3.2363" class="difflineminus">-  }</span>
<a href="#l3.2364"></a><span id="l3.2364" class="difflineminus">-}</span>
<a href="#l3.2365"></a><span id="l3.2365" class="difflineplus">+  },</span>
<a href="#l3.2366"></a><span id="l3.2366" class="difflineplus">+};</span>
<a href="#l3.2367"></a><span id="l3.2367"> </span>
<a href="#l3.2368"></a><span id="l3.2368"> /**</span>
<a href="#l3.2369"></a><span id="l3.2369">  * On paste or drop, we may want to modify the content before inserting it into</span>
<a href="#l3.2370"></a><span id="l3.2370">  * the editor, replacing file URLs with data URLs when appropriate.</span>
<a href="#l3.2371"></a><span id="l3.2371">  */</span>
<a href="#l3.2372"></a><span id="l3.2372"> function onPasteOrDrop(e) {</span>
<a href="#l3.2373"></a><span id="l3.2373">   // For paste use e.clipboardData, for drop use e.dataTransfer.</span>
<a href="#l3.2374"></a><span id="l3.2374">   let dataTransfer = (&quot;clipboardData&quot; in e) ? e.clipboardData : e.dataTransfer;</span>
<a href="#l3.2375"></a><span id="l3.2375" class="difflineat">@@ -2551,17 +2452,17 @@ function onPasteOrDrop(e) {</span>
<a href="#l3.2376"></a><span id="l3.2376">       let doTheInsert = function() {</span>
<a href="#l3.2377"></a><span id="l3.2377">         // Now run it through sanitation to make sure there wasn't any</span>
<a href="#l3.2378"></a><span id="l3.2378">         // unwanted things in the content.</span>
<a href="#l3.2379"></a><span id="l3.2379">         let ParserUtils = Cc[&quot;@mozilla.org/parserutils;1&quot;]</span>
<a href="#l3.2380"></a><span id="l3.2380">           .getService(Ci.nsIParserUtils);</span>
<a href="#l3.2381"></a><span id="l3.2381">         let html2 = ParserUtils.sanitize(doc.documentElement.innerHTML,</span>
<a href="#l3.2382"></a><span id="l3.2382">                                        ParserUtils.SanitizerAllowStyle);</span>
<a href="#l3.2383"></a><span id="l3.2383">         getBrowser().contentDocument.execCommand(&quot;insertHTML&quot;, false, html2);</span>
<a href="#l3.2384"></a><span id="l3.2384" class="difflineminus">-      }</span>
<a href="#l3.2385"></a><span id="l3.2385" class="difflineplus">+      };</span>
<a href="#l3.2386"></a><span id="l3.2386"> </span>
<a href="#l3.2387"></a><span id="l3.2387">       // Everything checks out. Convert file to data URL.</span>
<a href="#l3.2388"></a><span id="l3.2388">       let reader = new FileReader();</span>
<a href="#l3.2389"></a><span id="l3.2389">       reader.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l3.2390"></a><span id="l3.2390">         let dataURL = reader.result;</span>
<a href="#l3.2391"></a><span id="l3.2391">         pendingConversions--;</span>
<a href="#l3.2392"></a><span id="l3.2392">         img.src = dataURL;</span>
<a href="#l3.2393"></a><span id="l3.2393">         if (pendingConversions == 0) {</span>
<a href="#l3.2394"></a><span id="l3.2394" class="difflineat">@@ -2576,18 +2477,18 @@ function onPasteOrDrop(e) {</span>
<a href="#l3.2395"></a><span id="l3.2395">       });</span>
<a href="#l3.2396"></a><span id="l3.2396"> </span>
<a href="#l3.2397"></a><span id="l3.2397">       pendingConversions++;</span>
<a href="#l3.2398"></a><span id="l3.2398">       reader.readAsDataURL(file);</span>
<a href="#l3.2399"></a><span id="l3.2399">     });</span>
<a href="#l3.2400"></a><span id="l3.2400">   }</span>
<a href="#l3.2401"></a><span id="l3.2401"> }</span>
<a href="#l3.2402"></a><span id="l3.2402"> </span>
<a href="#l3.2403"></a><span id="l3.2403" class="difflineminus">-function ComposeStartup(aParams)</span>
<a href="#l3.2404"></a><span id="l3.2404" class="difflineminus">-{</span>
<a href="#l3.2405"></a><span id="l3.2405" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l3.2406"></a><span id="l3.2406" class="difflineplus">+function ComposeStartup(aParams) {</span>
<a href="#l3.2407"></a><span id="l3.2407">   // Findbar overlay</span>
<a href="#l3.2408"></a><span id="l3.2408">   if (!document.getElementById(&quot;findbar-replaceButton&quot;)) {</span>
<a href="#l3.2409"></a><span id="l3.2409">     let replaceButton = document.createElement(&quot;toolbarbutton&quot;);</span>
<a href="#l3.2410"></a><span id="l3.2410">     replaceButton.setAttribute(&quot;id&quot;, &quot;findbar-replaceButton&quot;);</span>
<a href="#l3.2411"></a><span id="l3.2411">     replaceButton.setAttribute(&quot;class&quot;, &quot;findbar-button tabbable&quot;);</span>
<a href="#l3.2412"></a><span id="l3.2412">     replaceButton.setAttribute(&quot;label&quot;, getComposeBundle().getString(&quot;replaceButton.label&quot;));</span>
<a href="#l3.2413"></a><span id="l3.2413">     replaceButton.setAttribute(&quot;accesskey&quot;, getComposeBundle().getString(&quot;replaceButton.accesskey&quot;));</span>
<a href="#l3.2414"></a><span id="l3.2414">     replaceButton.setAttribute(&quot;tooltiptext&quot;, getComposeBundle().getString(&quot;replaceButton.tooltip&quot;));</span>
<a href="#l3.2415"></a><span id="l3.2415" class="difflineat">@@ -2608,31 +2509,30 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2416"></a><span id="l3.2416">   if (aParams)</span>
<a href="#l3.2417"></a><span id="l3.2417">     params = aParams;</span>
<a href="#l3.2418"></a><span id="l3.2418">   else if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l3.2419"></a><span id="l3.2419">     try {</span>
<a href="#l3.2420"></a><span id="l3.2420">       if (window.arguments[0] instanceof Ci.nsIMsgComposeParams)</span>
<a href="#l3.2421"></a><span id="l3.2421">         params = window.arguments[0];</span>
<a href="#l3.2422"></a><span id="l3.2422">       else</span>
<a href="#l3.2423"></a><span id="l3.2423">         params = handleMailtoArgs(window.arguments[0]);</span>
<a href="#l3.2424"></a><span id="l3.2424" class="difflineplus">+    } catch (ex) {</span>
<a href="#l3.2425"></a><span id="l3.2425" class="difflineplus">+      dump(&quot;ERROR with parameters: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.2426"></a><span id="l3.2426">     }</span>
<a href="#l3.2427"></a><span id="l3.2427" class="difflineminus">-    catch(ex) { dump(&quot;ERROR with parameters: &quot; + ex + &quot;\n&quot;); }</span>
<a href="#l3.2428"></a><span id="l3.2428"> </span>
<a href="#l3.2429"></a><span id="l3.2429">     // if still no dice, try and see if the params is an old fashioned list of string attributes</span>
<a href="#l3.2430"></a><span id="l3.2430">     // XXX can we get rid of this yet?</span>
<a href="#l3.2431"></a><span id="l3.2431" class="difflineminus">-    if (!params)</span>
<a href="#l3.2432"></a><span id="l3.2432" class="difflineminus">-    {</span>
<a href="#l3.2433"></a><span id="l3.2433" class="difflineplus">+    if (!params) {</span>
<a href="#l3.2434"></a><span id="l3.2434">       args = GetArgs(window.arguments[0]);</span>
<a href="#l3.2435"></a><span id="l3.2435">     }</span>
<a href="#l3.2436"></a><span id="l3.2436">   }</span>
<a href="#l3.2437"></a><span id="l3.2437"> </span>
<a href="#l3.2438"></a><span id="l3.2438">   // Set a sane starting width/height for all resolutions on new profiles.</span>
<a href="#l3.2439"></a><span id="l3.2439">   // Do this before the window loads.</span>
<a href="#l3.2440"></a><span id="l3.2440" class="difflineminus">-  if (!document.documentElement.hasAttribute(&quot;width&quot;))</span>
<a href="#l3.2441"></a><span id="l3.2441" class="difflineminus">-  {</span>
<a href="#l3.2442"></a><span id="l3.2442" class="difflineplus">+  if (!document.documentElement.hasAttribute(&quot;width&quot;)) {</span>
<a href="#l3.2443"></a><span id="l3.2443">     // Prefer 860x800.</span>
<a href="#l3.2444"></a><span id="l3.2444">     let defaultHeight = Math.min(screen.availHeight, 800);</span>
<a href="#l3.2445"></a><span id="l3.2445">     let defaultWidth = Math.min(screen.availWidth, 860);</span>
<a href="#l3.2446"></a><span id="l3.2446"> </span>
<a href="#l3.2447"></a><span id="l3.2447">     // On small screens, default to maximized state.</span>
<a href="#l3.2448"></a><span id="l3.2448">     if (defaultHeight &lt;= 600)</span>
<a href="#l3.2449"></a><span id="l3.2449">       document.documentElement.setAttribute(&quot;sizemode&quot;, &quot;maximized&quot;);</span>
<a href="#l3.2450"></a><span id="l3.2450"> </span>
<a href="#l3.2451"></a><span id="l3.2451" class="difflineat">@@ -2674,24 +2574,23 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2452"></a><span id="l3.2452">     FillIdentityList(identityList);</span>
<a href="#l3.2453"></a><span id="l3.2453"> </span>
<a href="#l3.2454"></a><span id="l3.2454">   if (!params) {</span>
<a href="#l3.2455"></a><span id="l3.2455">     // This code will go away soon as now arguments are passed to the window using a object of type nsMsgComposeParams instead of a string</span>
<a href="#l3.2456"></a><span id="l3.2456"> </span>
<a href="#l3.2457"></a><span id="l3.2457">     params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l3.2458"></a><span id="l3.2458">     params.composeFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l3.2459"></a><span id="l3.2459"> </span>
<a href="#l3.2460"></a><span id="l3.2460" class="difflineminus">-    if (args) { //Convert old fashion arguments into params</span>
<a href="#l3.2461"></a><span id="l3.2461" class="difflineplus">+    if (args) { // Convert old fashion arguments into params</span>
<a href="#l3.2462"></a><span id="l3.2462">       var composeFields = params.composeFields;</span>
<a href="#l3.2463"></a><span id="l3.2463">       if (args.bodyislink == &quot;true&quot;)</span>
<a href="#l3.2464"></a><span id="l3.2464">         params.bodyIsLink = true;</span>
<a href="#l3.2465"></a><span id="l3.2465">       if (args.type)</span>
<a href="#l3.2466"></a><span id="l3.2466">         params.type = args.type;</span>
<a href="#l3.2467"></a><span id="l3.2467" class="difflineminus">-      if (args.format)</span>
<a href="#l3.2468"></a><span id="l3.2468" class="difflineminus">-      {</span>
<a href="#l3.2469"></a><span id="l3.2469" class="difflineplus">+      if (args.format) {</span>
<a href="#l3.2470"></a><span id="l3.2470">         // Only use valid values.</span>
<a href="#l3.2471"></a><span id="l3.2471">         if (args.format == Ci.nsIMsgCompFormat.PlainText ||</span>
<a href="#l3.2472"></a><span id="l3.2472">             args.format == Ci.nsIMsgCompFormat.HTML ||</span>
<a href="#l3.2473"></a><span id="l3.2473">             args.format == Ci.nsIMsgCompFormat.OppositeOfDefault)</span>
<a href="#l3.2474"></a><span id="l3.2474">           params.format = args.format;</span>
<a href="#l3.2475"></a><span id="l3.2475">         else if (args.format.toLowerCase().trim() == &quot;html&quot;)</span>
<a href="#l3.2476"></a><span id="l3.2476">           params.format = Ci.nsIMsgCompFormat.HTML;</span>
<a href="#l3.2477"></a><span id="l3.2477">         else if (args.format.toLowerCase().trim() == &quot;text&quot;)</span>
<a href="#l3.2478"></a><span id="l3.2478" class="difflineat">@@ -2708,45 +2607,39 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2479"></a><span id="l3.2479">       if (args.cc)</span>
<a href="#l3.2480"></a><span id="l3.2480">         composeFields.cc = args.cc;</span>
<a href="#l3.2481"></a><span id="l3.2481">       if (args.bcc)</span>
<a href="#l3.2482"></a><span id="l3.2482">         composeFields.bcc = args.bcc;</span>
<a href="#l3.2483"></a><span id="l3.2483">       if (args.newsgroups)</span>
<a href="#l3.2484"></a><span id="l3.2484">         composeFields.newsgroups = args.newsgroups;</span>
<a href="#l3.2485"></a><span id="l3.2485">       if (args.subject)</span>
<a href="#l3.2486"></a><span id="l3.2486">         composeFields.subject = args.subject;</span>
<a href="#l3.2487"></a><span id="l3.2487" class="difflineminus">-      if (args.attachment)</span>
<a href="#l3.2488"></a><span id="l3.2488" class="difflineminus">-      {</span>
<a href="#l3.2489"></a><span id="l3.2489" class="difflineplus">+      if (args.attachment) {</span>
<a href="#l3.2490"></a><span id="l3.2490">         let attachmentList = args.attachment.split(&quot;,&quot;);</span>
<a href="#l3.2491"></a><span id="l3.2491">         let commandLine = Cc[&quot;@mozilla.org/toolkit/command-line;1&quot;]</span>
<a href="#l3.2492"></a><span id="l3.2492">                             .createInstance();</span>
<a href="#l3.2493"></a><span id="l3.2493" class="difflineminus">-        for (let attachmentName of attachmentList)</span>
<a href="#l3.2494"></a><span id="l3.2494" class="difflineminus">-        {</span>
<a href="#l3.2495"></a><span id="l3.2495" class="difflineplus">+        for (let attachmentName of attachmentList) {</span>
<a href="#l3.2496"></a><span id="l3.2496">           // resolveURI does all the magic around working out what the</span>
<a href="#l3.2497"></a><span id="l3.2497">           // attachment is, including web pages, and generating the correct uri.</span>
<a href="#l3.2498"></a><span id="l3.2498">           let uri = commandLine.resolveURI(attachmentName);</span>
<a href="#l3.2499"></a><span id="l3.2499">           let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l3.2500"></a><span id="l3.2500">                              .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l3.2501"></a><span id="l3.2501">           // If uri is for a file and it exists set the attachment size.</span>
<a href="#l3.2502"></a><span id="l3.2502" class="difflineminus">-          if (uri instanceof Ci.nsIFileURL)</span>
<a href="#l3.2503"></a><span id="l3.2503" class="difflineminus">-          {</span>
<a href="#l3.2504"></a><span id="l3.2504" class="difflineplus">+          if (uri instanceof Ci.nsIFileURL) {</span>
<a href="#l3.2505"></a><span id="l3.2505">             if (uri.file.exists())</span>
<a href="#l3.2506"></a><span id="l3.2506">               attachment.size = uri.file.fileSize;</span>
<a href="#l3.2507"></a><span id="l3.2507">             else</span>
<a href="#l3.2508"></a><span id="l3.2508">               attachment = null;</span>
<a href="#l3.2509"></a><span id="l3.2509">           }</span>
<a href="#l3.2510"></a><span id="l3.2510"> </span>
<a href="#l3.2511"></a><span id="l3.2511">           // Only want to attach if a file that exists or it is not a file.</span>
<a href="#l3.2512"></a><span id="l3.2512" class="difflineminus">-          if (attachment)</span>
<a href="#l3.2513"></a><span id="l3.2513" class="difflineminus">-          {</span>
<a href="#l3.2514"></a><span id="l3.2514" class="difflineplus">+          if (attachment) {</span>
<a href="#l3.2515"></a><span id="l3.2515">             attachment.url = uri.spec;</span>
<a href="#l3.2516"></a><span id="l3.2516">             composeFields.addAttachment(attachment);</span>
<a href="#l3.2517"></a><span id="l3.2517" class="difflineminus">-          }</span>
<a href="#l3.2518"></a><span id="l3.2518" class="difflineminus">-          else</span>
<a href="#l3.2519"></a><span id="l3.2519" class="difflineminus">-          {</span>
<a href="#l3.2520"></a><span id="l3.2520" class="difflineplus">+          } else {</span>
<a href="#l3.2521"></a><span id="l3.2521">             let title = getComposeBundle().getString(&quot;errorFileAttachTitle&quot;);</span>
<a href="#l3.2522"></a><span id="l3.2522">             let msg = getComposeBundle().getFormattedString(&quot;errorFileAttachMessage&quot;,</span>
<a href="#l3.2523"></a><span id="l3.2523">                                                         [attachmentName]);</span>
<a href="#l3.2524"></a><span id="l3.2524">             Services.prompt.alert(null, title, msg);</span>
<a href="#l3.2525"></a><span id="l3.2525">           }</span>
<a href="#l3.2526"></a><span id="l3.2526">         }</span>
<a href="#l3.2527"></a><span id="l3.2527">       }</span>
<a href="#l3.2528"></a><span id="l3.2528">       if (args.newshost)</span>
<a href="#l3.2529"></a><span id="l3.2529" class="difflineat">@@ -2760,18 +2653,17 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2530"></a><span id="l3.2530">         }</span>
<a href="#l3.2531"></a><span id="l3.2531">         msgFile.initWithPath(args.message);</span>
<a href="#l3.2532"></a><span id="l3.2532"> </span>
<a href="#l3.2533"></a><span id="l3.2533">         if (!msgFile.exists()) {</span>
<a href="#l3.2534"></a><span id="l3.2534">           let title = getComposeBundle().getString(&quot;errorFileMessageTitle&quot;);</span>
<a href="#l3.2535"></a><span id="l3.2535">           let msg = getComposeBundle().getFormattedString(&quot;errorFileMessageMessage&quot;,</span>
<a href="#l3.2536"></a><span id="l3.2536">                                                           [args.message]);</span>
<a href="#l3.2537"></a><span id="l3.2537">           Services.prompt.alert(null, title, msg);</span>
<a href="#l3.2538"></a><span id="l3.2538" class="difflineminus">-        }</span>
<a href="#l3.2539"></a><span id="l3.2539" class="difflineminus">-        else {</span>
<a href="#l3.2540"></a><span id="l3.2540" class="difflineplus">+        } else {</span>
<a href="#l3.2541"></a><span id="l3.2541">           let data = &quot;&quot;;</span>
<a href="#l3.2542"></a><span id="l3.2542">           let fstream = null;</span>
<a href="#l3.2543"></a><span id="l3.2543">           let cstream = null;</span>
<a href="#l3.2544"></a><span id="l3.2544"> </span>
<a href="#l3.2545"></a><span id="l3.2545">           try {</span>
<a href="#l3.2546"></a><span id="l3.2546">             fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l3.2547"></a><span id="l3.2547">                         .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l3.2548"></a><span id="l3.2548">             cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l3.2549"></a><span id="l3.2549" class="difflineat">@@ -2805,39 +2697,38 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2550"></a><span id="l3.2550"> </span>
<a href="#l3.2551"></a><span id="l3.2551">             if (params.format != Ci.nsIMsgCompFormat.PlainText &amp;&amp;</span>
<a href="#l3.2552"></a><span id="l3.2552">                 (args.message.endsWith(&quot;.htm&quot;) || args.message.endsWith(&quot;.html&quot;) ||</span>
<a href="#l3.2553"></a><span id="l3.2553">                  data.substr(pos, 14).toLowerCase() == &quot;&lt;!doctype html&quot; ||</span>
<a href="#l3.2554"></a><span id="l3.2554">                  data.substr(pos, 5).toLowerCase() == &quot;&lt;html&quot;)) {</span>
<a href="#l3.2555"></a><span id="l3.2555">               // We replace line breaks because otherwise they'll be converted to</span>
<a href="#l3.2556"></a><span id="l3.2556">               // &lt;br&gt; in nsMsgCompose::BuildBodyMessageAndSignature().</span>
<a href="#l3.2557"></a><span id="l3.2557">               // Don't do the conversion if the user asked explicitly for plain text.</span>
<a href="#l3.2558"></a><span id="l3.2558" class="difflineminus">-              data = data.replace(/\r?\n/g,&quot; &quot;);</span>
<a href="#l3.2559"></a><span id="l3.2559" class="difflineplus">+              data = data.replace(/\r?\n/g, &quot; &quot;);</span>
<a href="#l3.2560"></a><span id="l3.2560">             }</span>
<a href="#l3.2561"></a><span id="l3.2561">             gBodyFromArgs = true;</span>
<a href="#l3.2562"></a><span id="l3.2562">             composeFields.body = data;</span>
<a href="#l3.2563"></a><span id="l3.2563">           }</span>
<a href="#l3.2564"></a><span id="l3.2564">         }</span>
<a href="#l3.2565"></a><span id="l3.2565" class="difflineminus">-      }</span>
<a href="#l3.2566"></a><span id="l3.2566" class="difflineminus">-      else if (args.body) {</span>
<a href="#l3.2567"></a><span id="l3.2567" class="difflineplus">+      } else if (args.body) {</span>
<a href="#l3.2568"></a><span id="l3.2568">         gBodyFromArgs = true;</span>
<a href="#l3.2569"></a><span id="l3.2569">         composeFields.body = args.body;</span>
<a href="#l3.2570"></a><span id="l3.2570">       }</span>
<a href="#l3.2571"></a><span id="l3.2571">     }</span>
<a href="#l3.2572"></a><span id="l3.2572">   }</span>
<a href="#l3.2573"></a><span id="l3.2573"> </span>
<a href="#l3.2574"></a><span id="l3.2574">   gComposeType = params.type;</span>
<a href="#l3.2575"></a><span id="l3.2575"> </span>
<a href="#l3.2576"></a><span id="l3.2576">   // Detect correct identity when missing or mismatched.</span>
<a href="#l3.2577"></a><span id="l3.2577">   // An identity with no email is likely not valid.</span>
<a href="#l3.2578"></a><span id="l3.2578">   // When editing a draft, 'params.identity' is pre-populated with the identity</span>
<a href="#l3.2579"></a><span id="l3.2579">   // that created the draft or the identity owning the draft folder for a &quot;foreign&quot;,</span>
<a href="#l3.2580"></a><span id="l3.2580">   // draft, see ComposeMessage() in mailCommands.js. We don't want the latter,</span>
<a href="#l3.2581"></a><span id="l3.2581">   // so use the creator identity which could be null.</span>
<a href="#l3.2582"></a><span id="l3.2582" class="difflineminus">-  if (gComposeType == nsIMsgCompType.Draft) {</span>
<a href="#l3.2583"></a><span id="l3.2583" class="difflineplus">+  if (gComposeType == Ci.nsIMsgCompType.Draft) {</span>
<a href="#l3.2584"></a><span id="l3.2584">     let creatorKey = params.composeFields.creatorIdentityKey;</span>
<a href="#l3.2585"></a><span id="l3.2585">     params.identity = creatorKey ? getIdentityForKey(creatorKey) : null;</span>
<a href="#l3.2586"></a><span id="l3.2586">   }</span>
<a href="#l3.2587"></a><span id="l3.2587">   let from = [];</span>
<a href="#l3.2588"></a><span id="l3.2588">   if (params.composeFields.from)</span>
<a href="#l3.2589"></a><span id="l3.2589">     from = MailServices.headerParser</span>
<a href="#l3.2590"></a><span id="l3.2590">                        .parseEncodedHeader(params.composeFields.from, null);</span>
<a href="#l3.2591"></a><span id="l3.2591">   from = (from.length &amp;&amp; from[0] &amp;&amp; from[0].email) ?</span>
<a href="#l3.2592"></a><span id="l3.2592" class="difflineat">@@ -2879,21 +2770,19 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2593"></a><span id="l3.2593">   }</span>
<a href="#l3.2594"></a><span id="l3.2594"> </span>
<a href="#l3.2595"></a><span id="l3.2595">   identityList.selectedItem =</span>
<a href="#l3.2596"></a><span id="l3.2596">     identityList.getElementsByAttribute(&quot;identitykey&quot;, params.identity.key)[0];</span>
<a href="#l3.2597"></a><span id="l3.2597"> </span>
<a href="#l3.2598"></a><span id="l3.2598">   // Here we set the From from the original message, be it a draft or another</span>
<a href="#l3.2599"></a><span id="l3.2599">   // message, for example a template, we want to &quot;edit as new&quot;.</span>
<a href="#l3.2600"></a><span id="l3.2600">   // Only do this if the message is our own draft or template.</span>
<a href="#l3.2601"></a><span id="l3.2601" class="difflineminus">-  if (params.composeFields.creatorIdentityKey &amp;&amp; params.composeFields.from)</span>
<a href="#l3.2602"></a><span id="l3.2602" class="difflineminus">-  {</span>
<a href="#l3.2603"></a><span id="l3.2603" class="difflineplus">+  if (params.composeFields.creatorIdentityKey &amp;&amp; params.composeFields.from) {</span>
<a href="#l3.2604"></a><span id="l3.2604">     let from = MailServices.headerParser.parseEncodedHeader(params.composeFields.from, null).join(&quot;, &quot;);</span>
<a href="#l3.2605"></a><span id="l3.2605" class="difflineminus">-    if (from != identityList.value)</span>
<a href="#l3.2606"></a><span id="l3.2606" class="difflineminus">-    {</span>
<a href="#l3.2607"></a><span id="l3.2607" class="difflineplus">+    if (from != identityList.value) {</span>
<a href="#l3.2608"></a><span id="l3.2608">       MakeFromFieldEditable(true);</span>
<a href="#l3.2609"></a><span id="l3.2609">       identityList.value = from;</span>
<a href="#l3.2610"></a><span id="l3.2610">     }</span>
<a href="#l3.2611"></a><span id="l3.2611">   }</span>
<a href="#l3.2612"></a><span id="l3.2612">   LoadIdentity(true);</span>
<a href="#l3.2613"></a><span id="l3.2613"> </span>
<a href="#l3.2614"></a><span id="l3.2614">   // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l3.2615"></a><span id="l3.2615">   var editorElement = GetCurrentEditorElement();</span>
<a href="#l3.2616"></a><span id="l3.2616" class="difflineat">@@ -2904,17 +2793,17 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2617"></a><span id="l3.2617">   // For our purposes we need the URI of the message being processed, not its</span>
<a href="#l3.2618"></a><span id="l3.2618">   // original ancestor.</span>
<a href="#l3.2619"></a><span id="l3.2619">   gOriginalMsgURI = params.originalMsgURI;</span>
<a href="#l3.2620"></a><span id="l3.2620">   gMsgCompose = MailServices.compose.initCompose(params, window, editorElement.docShell);</span>
<a href="#l3.2621"></a><span id="l3.2621"> </span>
<a href="#l3.2622"></a><span id="l3.2622">   gMsgCompose.addMsgSendListener(gSendListener);</span>
<a href="#l3.2623"></a><span id="l3.2623"> </span>
<a href="#l3.2624"></a><span id="l3.2624">   document.getElementById(&quot;returnReceiptMenu&quot;)</span>
<a href="#l3.2625"></a><span id="l3.2625" class="difflineminus">-          .setAttribute('checked', gMsgCompose.compFields.returnReceipt);</span>
<a href="#l3.2626"></a><span id="l3.2626" class="difflineplus">+          .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.returnReceipt);</span>
<a href="#l3.2627"></a><span id="l3.2627">   document.getElementById(&quot;dsnMenu&quot;)</span>
<a href="#l3.2628"></a><span id="l3.2628">           .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.DSN);</span>
<a href="#l3.2629"></a><span id="l3.2629">   document.getElementById(&quot;cmd_attachVCard&quot;)</span>
<a href="#l3.2630"></a><span id="l3.2630">           .setAttribute(&quot;checked&quot;, gMsgCompose.compFields.attachVCard);</span>
<a href="#l3.2631"></a><span id="l3.2631">   toggleAttachmentReminder(gMsgCompose.compFields.attachmentReminder);</span>
<a href="#l3.2632"></a><span id="l3.2632">   gSendFormat = gMsgCompose.compFields.deliveryFormat;</span>
<a href="#l3.2633"></a><span id="l3.2633">   SetCompositionAsPerDeliveryFormat(gSendFormat);</span>
<a href="#l3.2634"></a><span id="l3.2634">   SelectDeliveryFormatMenuOption(gSendFormat);</span>
<a href="#l3.2635"></a><span id="l3.2635" class="difflineat">@@ -2929,63 +2818,58 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2636"></a><span id="l3.2636"> </span>
<a href="#l3.2637"></a><span id="l3.2637">   let languageToSet = getValidSpellcheckerDictionary(draftLanguage);</span>
<a href="#l3.2638"></a><span id="l3.2638">   document.documentElement.setAttribute(&quot;lang&quot;, languageToSet);</span>
<a href="#l3.2639"></a><span id="l3.2639"> </span>
<a href="#l3.2640"></a><span id="l3.2640">   let editortype = gMsgCompose.composeHTML ? &quot;htmlmail&quot; : &quot;textmail&quot;;</span>
<a href="#l3.2641"></a><span id="l3.2641">   editorElement.makeEditable(editortype, true);</span>
<a href="#l3.2642"></a><span id="l3.2642"> </span>
<a href="#l3.2643"></a><span id="l3.2643">   // setEditorType MUST be called before setContentWindow</span>
<a href="#l3.2644"></a><span id="l3.2644" class="difflineminus">-  if (gMsgCompose.composeHTML)</span>
<a href="#l3.2645"></a><span id="l3.2645" class="difflineminus">-  {</span>
<a href="#l3.2646"></a><span id="l3.2646" class="difflineplus">+  if (gMsgCompose.composeHTML) {</span>
<a href="#l3.2647"></a><span id="l3.2647">     initLocalFontFaceMenu(document.getElementById(&quot;FontFacePopup&quot;));</span>
<a href="#l3.2648"></a><span id="l3.2648" class="difflineminus">-  }</span>
<a href="#l3.2649"></a><span id="l3.2649" class="difflineminus">-  else</span>
<a href="#l3.2650"></a><span id="l3.2650" class="difflineminus">-  {</span>
<a href="#l3.2651"></a><span id="l3.2651" class="difflineplus">+  } else {</span>
<a href="#l3.2652"></a><span id="l3.2652">     // We are editing in plain text mode.</span>
<a href="#l3.2653"></a><span id="l3.2653">     // The SetCompositionAsPerDeliveryFormat call above already hid</span>
<a href="#l3.2654"></a><span id="l3.2654">     // the HTML toolbar, format and insert menus.</span>
<a href="#l3.2655"></a><span id="l3.2655">     // Also remove the delivery format from the options menu.</span>
<a href="#l3.2656"></a><span id="l3.2656">     document.getElementById(&quot;outputFormatMenu&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l3.2657"></a><span id="l3.2657">   }</span>
<a href="#l3.2658"></a><span id="l3.2658"> </span>
<a href="#l3.2659"></a><span id="l3.2659">   // Do setup common to Message Composer and Web Composer.</span>
<a href="#l3.2660"></a><span id="l3.2660">   EditorSharedStartup();</span>
<a href="#l3.2661"></a><span id="l3.2661"> </span>
<a href="#l3.2662"></a><span id="l3.2662" class="difflineminus">-  if (params.bodyIsLink)</span>
<a href="#l3.2663"></a><span id="l3.2663" class="difflineminus">-  {</span>
<a href="#l3.2664"></a><span id="l3.2664" class="difflineplus">+  if (params.bodyIsLink) {</span>
<a href="#l3.2665"></a><span id="l3.2665">     let body = gMsgCompose.compFields.body;</span>
<a href="#l3.2666"></a><span id="l3.2666" class="difflineminus">-    if (gMsgCompose.composeHTML)</span>
<a href="#l3.2667"></a><span id="l3.2667" class="difflineminus">-    {</span>
<a href="#l3.2668"></a><span id="l3.2668" class="difflineplus">+    if (gMsgCompose.composeHTML) {</span>
<a href="#l3.2669"></a><span id="l3.2669">       let cleanBody;</span>
<a href="#l3.2670"></a><span id="l3.2670">       try {</span>
<a href="#l3.2671"></a><span id="l3.2671">         cleanBody = decodeURI(body);</span>
<a href="#l3.2672"></a><span id="l3.2672" class="difflineminus">-      } catch(e) { cleanBody = body; }</span>
<a href="#l3.2673"></a><span id="l3.2673" class="difflineplus">+      } catch (e) {</span>
<a href="#l3.2674"></a><span id="l3.2674" class="difflineplus">+        cleanBody = body;</span>
<a href="#l3.2675"></a><span id="l3.2675" class="difflineplus">+      }</span>
<a href="#l3.2676"></a><span id="l3.2676"> </span>
<a href="#l3.2677"></a><span id="l3.2677">       body = body.replace(/&amp;/g, &quot;&amp;amp;&quot;);</span>
<a href="#l3.2678"></a><span id="l3.2678">       gMsgCompose.compFields.body =</span>
<a href="#l3.2679"></a><span id="l3.2679">         &quot;&lt;br /&gt;&lt;a href=\&quot;&quot; + body + &quot;\&quot;&gt;&quot; + cleanBody + &quot;&lt;/a&gt;&lt;br /&gt;&quot;;</span>
<a href="#l3.2680"></a><span id="l3.2680" class="difflineminus">-    }</span>
<a href="#l3.2681"></a><span id="l3.2681" class="difflineminus">-    else</span>
<a href="#l3.2682"></a><span id="l3.2682" class="difflineminus">-    {</span>
<a href="#l3.2683"></a><span id="l3.2683" class="difflineplus">+    } else {</span>
<a href="#l3.2684"></a><span id="l3.2684">       gMsgCompose.compFields.body = &quot;\n&lt;&quot; + body + &quot;&gt;\n&quot;;</span>
<a href="#l3.2685"></a><span id="l3.2685">     }</span>
<a href="#l3.2686"></a><span id="l3.2686">   }</span>
<a href="#l3.2687"></a><span id="l3.2687"> </span>
<a href="#l3.2688"></a><span id="l3.2688">   GetMsgSubjectElement().value = gMsgCompose.compFields.subject;</span>
<a href="#l3.2689"></a><span id="l3.2689"> </span>
<a href="#l3.2690"></a><span id="l3.2690">   AddAttachments(gMsgCompose.compFields.attachments, null, false);</span>
<a href="#l3.2691"></a><span id="l3.2691"> </span>
<a href="#l3.2692"></a><span id="l3.2692">   if (Services.prefs.getBoolPref(</span>
<a href="#l3.2693"></a><span id="l3.2693">       &quot;mail.compose.show_attachment_pane&quot;)) {</span>
<a href="#l3.2694"></a><span id="l3.2694">     toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l3.2695"></a><span id="l3.2695">   }</span>
<a href="#l3.2696"></a><span id="l3.2696"> </span>
<a href="#l3.2697"></a><span id="l3.2697">   document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(</span>
<a href="#l3.2698"></a><span id="l3.2698" class="difflineminus">-    new Event(&quot;compose-window-init&quot;, { bubbles: false , cancelable: true }));</span>
<a href="#l3.2699"></a><span id="l3.2699" class="difflineplus">+    new Event(&quot;compose-window-init&quot;, { bubbles: false, cancelable: true }));</span>
<a href="#l3.2700"></a><span id="l3.2700"> </span>
<a href="#l3.2701"></a><span id="l3.2701">   gMsgCompose.RegisterStateListener(stateListener);</span>
<a href="#l3.2702"></a><span id="l3.2702"> </span>
<a href="#l3.2703"></a><span id="l3.2703">   // Add an observer to be called when document is done loading,</span>
<a href="#l3.2704"></a><span id="l3.2704">   // which creates the editor.</span>
<a href="#l3.2705"></a><span id="l3.2705">   try {</span>
<a href="#l3.2706"></a><span id="l3.2706">     GetCurrentCommandManager().</span>
<a href="#l3.2707"></a><span id="l3.2707">             addCommandObserver(gMsgEditorCreationObserver, &quot;obs_documentCreated&quot;);</span>
<a href="#l3.2708"></a><span id="l3.2708" class="difflineat">@@ -2994,56 +2878,52 @@ function ComposeStartup(aParams)</span>
<a href="#l3.2709"></a><span id="l3.2709">     editorElement.webNavigation.loadURI(&quot;about:blank&quot;, 0, null, null, null);</span>
<a href="#l3.2710"></a><span id="l3.2710">   } catch (e) {</span>
<a href="#l3.2711"></a><span id="l3.2711">     Cu.reportError(e);</span>
<a href="#l3.2712"></a><span id="l3.2712">   }</span>
<a href="#l3.2713"></a><span id="l3.2713"> </span>
<a href="#l3.2714"></a><span id="l3.2714">   gEditingDraft = gMsgCompose.compFields.draftId;</span>
<a href="#l3.2715"></a><span id="l3.2715"> </span>
<a href="#l3.2716"></a><span id="l3.2716">   // finally, see if we need to auto open the address sidebar.</span>
<a href="#l3.2717"></a><span id="l3.2717" class="difflineminus">-  var sideBarBox = document.getElementById('sidebar-box');</span>
<a href="#l3.2718"></a><span id="l3.2718" class="difflineminus">-  if (sideBarBox.getAttribute(&quot;sidebarVisible&quot;) == &quot;true&quot;)</span>
<a href="#l3.2719"></a><span id="l3.2719" class="difflineminus">-  {</span>
<a href="#l3.2720"></a><span id="l3.2720" class="difflineplus">+  var sideBarBox = document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l3.2721"></a><span id="l3.2721" class="difflineplus">+  if (sideBarBox.getAttribute(&quot;sidebarVisible&quot;) == &quot;true&quot;) {</span>
<a href="#l3.2722"></a><span id="l3.2722">     // if we aren't supposed to have the side bar hidden, make sure it is visible</span>
<a href="#l3.2723"></a><span id="l3.2723">     if (document.getElementById(&quot;sidebar&quot;).getAttribute(&quot;src&quot;) == &quot;&quot;)</span>
<a href="#l3.2724"></a><span id="l3.2724">       setTimeout(toggleAddressPicker, 0);   // do this on a delay so we don't hurt perf. on bringing up a new compose window</span>
<a href="#l3.2725"></a><span id="l3.2725">   }</span>
<a href="#l3.2726"></a><span id="l3.2726">   gAutoSaveInterval = getPref(&quot;mail.compose.autosave&quot;) ?</span>
<a href="#l3.2727"></a><span id="l3.2727">     getPref(&quot;mail.compose.autosaveinterval&quot;) * 60000 : 0;</span>
<a href="#l3.2728"></a><span id="l3.2728"> </span>
<a href="#l3.2729"></a><span id="l3.2729">   if (gAutoSaveInterval)</span>
<a href="#l3.2730"></a><span id="l3.2730">     gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l3.2731"></a><span id="l3.2731"> </span>
<a href="#l3.2732"></a><span id="l3.2732">   gAutoSaveKickedIn = false;</span>
<a href="#l3.2733"></a><span id="l3.2733"> }</span>
<a href="#l3.2734"></a><span id="l3.2734" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l3.2735"></a><span id="l3.2735"> </span>
<a href="#l3.2736"></a><span id="l3.2736"> function splitEmailAddress(aEmail) {</span>
<a href="#l3.2737"></a><span id="l3.2737">   let at = aEmail.lastIndexOf(&quot;@&quot;);</span>
<a href="#l3.2738"></a><span id="l3.2738">   return (at != -1) ? [aEmail.slice(0, at), aEmail.slice(at + 1)] : [aEmail, &quot;&quot;];</span>
<a href="#l3.2739"></a><span id="l3.2739"> }</span>
<a href="#l3.2740"></a><span id="l3.2740"> </span>
<a href="#l3.2741"></a><span id="l3.2741"> // Emails are equal ignoring +suffixes (email+suffix@example.com).</span>
<a href="#l3.2742"></a><span id="l3.2742"> function emailSimilar(a, b) {</span>
<a href="#l3.2743"></a><span id="l3.2743">   if (!a || !b)</span>
<a href="#l3.2744"></a><span id="l3.2744">     return a == b;</span>
<a href="#l3.2745"></a><span id="l3.2745">   a = splitEmailAddress(a.toLowerCase());</span>
<a href="#l3.2746"></a><span id="l3.2746">   b = splitEmailAddress(b.toLowerCase());</span>
<a href="#l3.2747"></a><span id="l3.2747">   return a[1] == b[1] &amp;&amp; a[0].split(&quot;+&quot;, 1)[0] == b[0].split(&quot;+&quot;, 1)[0];</span>
<a href="#l3.2748"></a><span id="l3.2748"> }</span>
<a href="#l3.2749"></a><span id="l3.2749"> </span>
<a href="#l3.2750"></a><span id="l3.2750"> // The new, nice, simple way of getting notified when a new editor has been created</span>
<a href="#l3.2751"></a><span id="l3.2751" class="difflineminus">-var gMsgEditorCreationObserver =</span>
<a href="#l3.2752"></a><span id="l3.2752" class="difflineminus">-{</span>
<a href="#l3.2753"></a><span id="l3.2753" class="difflineminus">-  observe: function(aSubject, aTopic, aData)</span>
<a href="#l3.2754"></a><span id="l3.2754" class="difflineminus">-  {</span>
<a href="#l3.2755"></a><span id="l3.2755" class="difflineminus">-    if (aTopic == &quot;obs_documentCreated&quot;)</span>
<a href="#l3.2756"></a><span id="l3.2756" class="difflineminus">-    {</span>
<a href="#l3.2757"></a><span id="l3.2757" class="difflineplus">+var gMsgEditorCreationObserver = {</span>
<a href="#l3.2758"></a><span id="l3.2758" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.2759"></a><span id="l3.2759" class="difflineplus">+    if (aTopic == &quot;obs_documentCreated&quot;) {</span>
<a href="#l3.2760"></a><span id="l3.2760">       var editor = GetCurrentEditor();</span>
<a href="#l3.2761"></a><span id="l3.2761" class="difflineminus">-      if (editor &amp;&amp; GetCurrentCommandManager() == aSubject)</span>
<a href="#l3.2762"></a><span id="l3.2762" class="difflineminus">-      {</span>
<a href="#l3.2763"></a><span id="l3.2763" class="difflineplus">+      if (editor &amp;&amp; GetCurrentCommandManager() == aSubject) {</span>
<a href="#l3.2764"></a><span id="l3.2764">         var editorStyle = editor.QueryInterface(Ci.nsIEditorStyleSheets);</span>
<a href="#l3.2765"></a><span id="l3.2765">         // We use addOverrideStyleSheet rather than addStyleSheet so that we get</span>
<a href="#l3.2766"></a><span id="l3.2766">         // a synchronous load, rather than having a late-finishing async load</span>
<a href="#l3.2767"></a><span id="l3.2767">         // mark our editor as modified when the user hasn't typed anything yet,</span>
<a href="#l3.2768"></a><span id="l3.2768">         // but that means the sheet must not @import slow things, especially</span>
<a href="#l3.2769"></a><span id="l3.2769">         // not over the network.</span>
<a href="#l3.2770"></a><span id="l3.2770">         editorStyle.addOverrideStyleSheet(&quot;chrome://messenger/skin/messageQuotes.css&quot;);</span>
<a href="#l3.2771"></a><span id="l3.2771">         InitEditor();</span>
<a href="#l3.2772"></a><span id="l3.2772" class="difflineat">@@ -3051,85 +2931,78 @@ var gMsgEditorCreationObserver =</span>
<a href="#l3.2773"></a><span id="l3.2773">       // Now that we know this document is an editor, update commands now if</span>
<a href="#l3.2774"></a><span id="l3.2774">       // the document has focus, or next time it receives focus via</span>
<a href="#l3.2775"></a><span id="l3.2775">       // CommandUpdate_MsgCompose()</span>
<a href="#l3.2776"></a><span id="l3.2776">       if (gLastWindowToHaveFocus == document.commandDispatcher.focusedWindow)</span>
<a href="#l3.2777"></a><span id="l3.2777">         updateComposeItems();</span>
<a href="#l3.2778"></a><span id="l3.2778">       else</span>
<a href="#l3.2779"></a><span id="l3.2779">         gLastWindowToHaveFocus = null;</span>
<a href="#l3.2780"></a><span id="l3.2780">     }</span>
<a href="#l3.2781"></a><span id="l3.2781" class="difflineminus">-  }</span>
<a href="#l3.2782"></a><span id="l3.2782" class="difflineminus">-}</span>
<a href="#l3.2783"></a><span id="l3.2783" class="difflineminus">-</span>
<a href="#l3.2784"></a><span id="l3.2784" class="difflineminus">-function WizCallback(state)</span>
<a href="#l3.2785"></a><span id="l3.2785" class="difflineminus">-{</span>
<a href="#l3.2786"></a><span id="l3.2786" class="difflineminus">-  if (state){</span>
<a href="#l3.2787"></a><span id="l3.2787" class="difflineplus">+  },</span>
<a href="#l3.2788"></a><span id="l3.2788" class="difflineplus">+};</span>
<a href="#l3.2789"></a><span id="l3.2789" class="difflineplus">+</span>
<a href="#l3.2790"></a><span id="l3.2790" class="difflineplus">+function WizCallback(state) {</span>
<a href="#l3.2791"></a><span id="l3.2791" class="difflineplus">+  if (state) {</span>
<a href="#l3.2792"></a><span id="l3.2792">     ComposeStartup(null);</span>
<a href="#l3.2793"></a><span id="l3.2793" class="difflineminus">-  }</span>
<a href="#l3.2794"></a><span id="l3.2794" class="difflineminus">-  else</span>
<a href="#l3.2795"></a><span id="l3.2795" class="difflineminus">-  {</span>
<a href="#l3.2796"></a><span id="l3.2796" class="difflineplus">+  } else {</span>
<a href="#l3.2797"></a><span id="l3.2797">     // The account wizard is still closing so we can't close just yet</span>
<a href="#l3.2798"></a><span id="l3.2798">     setTimeout(MsgComposeCloseWindow, 0);</span>
<a href="#l3.2799"></a><span id="l3.2799">   }</span>
<a href="#l3.2800"></a><span id="l3.2800"> }</span>
<a href="#l3.2801"></a><span id="l3.2801"> </span>
<a href="#l3.2802"></a><span id="l3.2802" class="difflineminus">-function ComposeLoad()</span>
<a href="#l3.2803"></a><span id="l3.2803" class="difflineminus">-{</span>
<a href="#l3.2804"></a><span id="l3.2804" class="difflineplus">+function ComposeLoad() {</span>
<a href="#l3.2805"></a><span id="l3.2805">   try {</span>
<a href="#l3.2806"></a><span id="l3.2806">     var other_headers = getPref(&quot;mail.compose.other.header&quot;);</span>
<a href="#l3.2807"></a><span id="l3.2807" class="difflineminus">-  }</span>
<a href="#l3.2808"></a><span id="l3.2808" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.2809"></a><span id="l3.2809" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.2810"></a><span id="l3.2810">     dump(&quot;failed to get the mail.compose.other.header pref\n&quot;);</span>
<a href="#l3.2811"></a><span id="l3.2811">   }</span>
<a href="#l3.2812"></a><span id="l3.2812"> </span>
<a href="#l3.2813"></a><span id="l3.2813">   AddMessageComposeOfflineQuitObserver();</span>
<a href="#l3.2814"></a><span id="l3.2814"> </span>
<a href="#l3.2815"></a><span id="l3.2815">   setupAutocomplete();</span>
<a href="#l3.2816"></a><span id="l3.2816"> </span>
<a href="#l3.2817"></a><span id="l3.2817">   try {</span>
<a href="#l3.2818"></a><span id="l3.2818">     SetupCommandUpdateHandlers();</span>
<a href="#l3.2819"></a><span id="l3.2819">     // This will do migration, or create a new account if we need to.</span>
<a href="#l3.2820"></a><span id="l3.2820">     // We also want to open the account wizard if no identities are found</span>
<a href="#l3.2821"></a><span id="l3.2821">     var state = verifyAccounts(WizCallback, true);</span>
<a href="#l3.2822"></a><span id="l3.2822"> </span>
<a href="#l3.2823"></a><span id="l3.2823">     if (other_headers) {</span>
<a href="#l3.2824"></a><span id="l3.2824" class="difflineminus">-      var selectNode = document.getElementById('addressCol1#1');</span>
<a href="#l3.2825"></a><span id="l3.2825" class="difflineplus">+      var selectNode = document.getElementById(&quot;addressCol1#1&quot;);</span>
<a href="#l3.2826"></a><span id="l3.2826">       var other_headers_Array = other_headers.split(&quot;,&quot;);</span>
<a href="#l3.2827"></a><span id="l3.2827">       for (let i = 0; i &lt; other_headers_Array.length; i++)</span>
<a href="#l3.2828"></a><span id="l3.2828">         selectNode.appendItem(other_headers_Array[i] + &quot;:&quot;, &quot;addr_other&quot;);</span>
<a href="#l3.2829"></a><span id="l3.2829">     }</span>
<a href="#l3.2830"></a><span id="l3.2830">     if (state)</span>
<a href="#l3.2831"></a><span id="l3.2831">       ComposeStartup(null);</span>
<a href="#l3.2832"></a><span id="l3.2832" class="difflineminus">-  }</span>
<a href="#l3.2833"></a><span id="l3.2833" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.2834"></a><span id="l3.2834" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.2835"></a><span id="l3.2835">     Cu.reportError(ex);</span>
<a href="#l3.2836"></a><span id="l3.2836">     Services.prompt.alert(window, getComposeBundle().getString(&quot;initErrorDlogTitle&quot;),</span>
<a href="#l3.2837"></a><span id="l3.2837">                           getComposeBundle().getString(&quot;initErrorDlgMessage&quot;));</span>
<a href="#l3.2838"></a><span id="l3.2838"> </span>
<a href="#l3.2839"></a><span id="l3.2839">     MsgComposeCloseWindow();</span>
<a href="#l3.2840"></a><span id="l3.2840">     return;</span>
<a href="#l3.2841"></a><span id="l3.2841">   }</span>
<a href="#l3.2842"></a><span id="l3.2842"> </span>
<a href="#l3.2843"></a><span id="l3.2843">   CompactTheme.init();</span>
<a href="#l3.2844"></a><span id="l3.2844">   ToolbarIconColor.init();</span>
<a href="#l3.2845"></a><span id="l3.2845"> </span>
<a href="#l3.2846"></a><span id="l3.2846">   // initialize the customizeDone method on the customizeable toolbar</span>
<a href="#l3.2847"></a><span id="l3.2847">   var toolbox = document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l3.2848"></a><span id="l3.2848">   toolbox.customizeDone = function(aEvent) { MailToolboxCustomizeDone(aEvent, &quot;CustomizeComposeToolbar&quot;); };</span>
<a href="#l3.2849"></a><span id="l3.2849"> </span>
<a href="#l3.2850"></a><span id="l3.2850" class="difflineminus">-  var toolbarset = document.getElementById('customToolbars');</span>
<a href="#l3.2851"></a><span id="l3.2851" class="difflineplus">+  var toolbarset = document.getElementById(&quot;customToolbars&quot;);</span>
<a href="#l3.2852"></a><span id="l3.2852">   toolbox.toolbarset = toolbarset;</span>
<a href="#l3.2853"></a><span id="l3.2853"> </span>
<a href="#l3.2854"></a><span id="l3.2854">   awInitializeNumberOfRowsShown();</span>
<a href="#l3.2855"></a><span id="l3.2855">   updateAttachmentPane();</span>
<a href="#l3.2856"></a><span id="l3.2856">   attachmentBucketMarkEmptyBucket();</span>
<a href="#l3.2857"></a><span id="l3.2857"> }</span>
<a href="#l3.2858"></a><span id="l3.2858"> </span>
<a href="#l3.2859"></a><span id="l3.2859" class="difflineminus">-function ComposeUnload()</span>
<a href="#l3.2860"></a><span id="l3.2860" class="difflineminus">-{</span>
<a href="#l3.2861"></a><span id="l3.2861" class="difflineplus">+function ComposeUnload() {</span>
<a href="#l3.2862"></a><span id="l3.2862">   // Send notification that the window is going away completely.</span>
<a href="#l3.2863"></a><span id="l3.2863">   document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(</span>
<a href="#l3.2864"></a><span id="l3.2864">     new Event(&quot;compose-window-unload&quot;, { bubbles: false, cancelable: false }));</span>
<a href="#l3.2865"></a><span id="l3.2865"> </span>
<a href="#l3.2866"></a><span id="l3.2866">   GetCurrentCommandManager().removeCommandObserver(gMsgEditorCreationObserver,</span>
<a href="#l3.2867"></a><span id="l3.2867">                                                    &quot;obs_documentCreated&quot;);</span>
<a href="#l3.2868"></a><span id="l3.2868">   UnloadCommandUpdateHandlers();</span>
<a href="#l3.2869"></a><span id="l3.2869"> </span>
<a href="#l3.2870"></a><span id="l3.2870" class="difflineat">@@ -3157,128 +3030,119 @@ function ComposeUnload()</span>
<a href="#l3.2871"></a><span id="l3.2871">   if (gAutoSaveTimeout)</span>
<a href="#l3.2872"></a><span id="l3.2872">     clearTimeout(gAutoSaveTimeout);</span>
<a href="#l3.2873"></a><span id="l3.2873">   if (msgWindow)</span>
<a href="#l3.2874"></a><span id="l3.2874">     msgWindow.closeWindow();</span>
<a href="#l3.2875"></a><span id="l3.2875"> </span>
<a href="#l3.2876"></a><span id="l3.2876">   ReleaseGlobalVariables();</span>
<a href="#l3.2877"></a><span id="l3.2877"> }</span>
<a href="#l3.2878"></a><span id="l3.2878"> </span>
<a href="#l3.2879"></a><span id="l3.2879" class="difflineminus">-function SetDocumentCharacterSet(aCharset)</span>
<a href="#l3.2880"></a><span id="l3.2880" class="difflineminus">-{</span>
<a href="#l3.2881"></a><span id="l3.2881" class="difflineplus">+function SetDocumentCharacterSet(aCharset) {</span>
<a href="#l3.2882"></a><span id="l3.2882">   if (gMsgCompose) {</span>
<a href="#l3.2883"></a><span id="l3.2883">     gMsgCompose.SetDocumentCharset(aCharset);</span>
<a href="#l3.2884"></a><span id="l3.2884">     updateEncodingInStatusBar();</span>
<a href="#l3.2885"></a><span id="l3.2885" class="difflineplus">+  } else {</span>
<a href="#l3.2886"></a><span id="l3.2886" class="difflineplus">+    dump(&quot;Compose has not been created!\n&quot;);</span>
<a href="#l3.2887"></a><span id="l3.2887">   }</span>
<a href="#l3.2888"></a><span id="l3.2888" class="difflineminus">-  else</span>
<a href="#l3.2889"></a><span id="l3.2889" class="difflineminus">-    dump(&quot;Compose has not been created!\n&quot;);</span>
<a href="#l3.2890"></a><span id="l3.2890"> }</span>
<a href="#l3.2891"></a><span id="l3.2891"> </span>
<a href="#l3.2892"></a><span id="l3.2892"> /**</span>
<a href="#l3.2893"></a><span id="l3.2893">  * Return the full display string for any non-default text encoding of the</span>
<a href="#l3.2894"></a><span id="l3.2894">  * current composition (friendly name plus official character set name).</span>
<a href="#l3.2895"></a><span id="l3.2895">  * For the default text encoding, return empty string (&quot;&quot;), to reduce</span>
<a href="#l3.2896"></a><span id="l3.2896">  * ux-complexity, e.g. for the default Status Bar display.</span>
<a href="#l3.2897"></a><span id="l3.2897">  * Note: The default is retrieved from mailnews.send_default_charset.</span>
<a href="#l3.2898"></a><span id="l3.2898">  *</span>
<a href="#l3.2899"></a><span id="l3.2899">  * @return string representation of non-default charset, otherwise &quot;&quot;.</span>
<a href="#l3.2900"></a><span id="l3.2900">  */</span>
<a href="#l3.2901"></a><span id="l3.2901" class="difflineminus">-function GetCharsetUIString()</span>
<a href="#l3.2902"></a><span id="l3.2902" class="difflineminus">-{</span>
<a href="#l3.2903"></a><span id="l3.2903" class="difflineplus">+function GetCharsetUIString() {</span>
<a href="#l3.2904"></a><span id="l3.2904">   // The charset here is already the canonical charset (not an alias).</span>
<a href="#l3.2905"></a><span id="l3.2905">   let charset = gMsgCompose.compFields.characterSet;</span>
<a href="#l3.2906"></a><span id="l3.2906">   if (!charset)</span>
<a href="#l3.2907"></a><span id="l3.2907">     return &quot;&quot;;</span>
<a href="#l3.2908"></a><span id="l3.2908"> </span>
<a href="#l3.2909"></a><span id="l3.2909">   if (charset.toLowerCase() != gMsgCompose.compFields.defaultCharacterSet.toLowerCase()) {</span>
<a href="#l3.2910"></a><span id="l3.2910">     try {</span>
<a href="#l3.2911"></a><span id="l3.2911">       return gCharsetConvertManager.getCharsetTitle(charset);</span>
<a href="#l3.2912"></a><span id="l3.2912" class="difflineminus">-    }</span>
<a href="#l3.2913"></a><span id="l3.2913" class="difflineminus">-    catch(e) { // Not a canonical charset after all...</span>
<a href="#l3.2914"></a><span id="l3.2914" class="difflineplus">+    } catch (e) { // Not a canonical charset after all...</span>
<a href="#l3.2915"></a><span id="l3.2915">       Cu.reportError(&quot;No charset title for charset=&quot; + charset);</span>
<a href="#l3.2916"></a><span id="l3.2916">       return charset;</span>
<a href="#l3.2917"></a><span id="l3.2917">     }</span>
<a href="#l3.2918"></a><span id="l3.2918">   }</span>
<a href="#l3.2919"></a><span id="l3.2919">   return &quot;&quot;;</span>
<a href="#l3.2920"></a><span id="l3.2920"> }</span>
<a href="#l3.2921"></a><span id="l3.2921"> </span>
<a href="#l3.2922"></a><span id="l3.2922"> // Add-ons can override this to customize the behavior.</span>
<a href="#l3.2923"></a><span id="l3.2923" class="difflineminus">-function DoSpellCheckBeforeSend()</span>
<a href="#l3.2924"></a><span id="l3.2924" class="difflineminus">-{</span>
<a href="#l3.2925"></a><span id="l3.2925" class="difflineplus">+function DoSpellCheckBeforeSend() {</span>
<a href="#l3.2926"></a><span id="l3.2926">   return getPref(&quot;mail.SpellCheckBeforeSend&quot;);</span>
<a href="#l3.2927"></a><span id="l3.2927"> }</span>
<a href="#l3.2928"></a><span id="l3.2928"> </span>
<a href="#l3.2929"></a><span id="l3.2929"> /**</span>
<a href="#l3.2930"></a><span id="l3.2930">  * Handles message sending operations.</span>
<a href="#l3.2931"></a><span id="l3.2931">  * @param msgType nsIMsgCompDeliverMode of the operation.</span>
<a href="#l3.2932"></a><span id="l3.2932">  */</span>
<a href="#l3.2933"></a><span id="l3.2933" class="difflineminus">-function GenericSendMessage(msgType)</span>
<a href="#l3.2934"></a><span id="l3.2934" class="difflineminus">-{</span>
<a href="#l3.2935"></a><span id="l3.2935" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l3.2936"></a><span id="l3.2936" class="difflineplus">+function GenericSendMessage(msgType) {</span>
<a href="#l3.2937"></a><span id="l3.2937">   var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.2938"></a><span id="l3.2938"> </span>
<a href="#l3.2939"></a><span id="l3.2939">   Recipients2CompFields(msgCompFields);</span>
<a href="#l3.2940"></a><span id="l3.2940">   let addresses = MailServices.headerParser</span>
<a href="#l3.2941"></a><span id="l3.2941">                               .makeFromDisplayAddress(GetMsgIdentityElement().value);</span>
<a href="#l3.2942"></a><span id="l3.2942">   msgCompFields.from = MailServices.headerParser.makeMimeHeader(addresses, addresses.length);</span>
<a href="#l3.2943"></a><span id="l3.2943">   var subject = GetMsgSubjectElement().value;</span>
<a href="#l3.2944"></a><span id="l3.2944">   msgCompFields.subject = subject;</span>
<a href="#l3.2945"></a><span id="l3.2945">   Attachments2CompFields(msgCompFields);</span>
<a href="#l3.2946"></a><span id="l3.2946">   // Some other msgCompFields have already been updated instantly in their respective</span>
<a href="#l3.2947"></a><span id="l3.2947">   // toggle functions, e.g. ToggleReturnReceipt(), ToggleDSN(),  ToggleAttachVCard(),</span>
<a href="#l3.2948"></a><span id="l3.2948">   // and toggleAttachmentReminder().</span>
<a href="#l3.2949"></a><span id="l3.2949"> </span>
<a href="#l3.2950"></a><span id="l3.2950" class="difflineminus">-  let sending = msgType == nsIMsgCompDeliverMode.Now ||</span>
<a href="#l3.2951"></a><span id="l3.2951" class="difflineminus">-      msgType == nsIMsgCompDeliverMode.Later ||</span>
<a href="#l3.2952"></a><span id="l3.2952" class="difflineminus">-      msgType == nsIMsgCompDeliverMode.Background;</span>
<a href="#l3.2953"></a><span id="l3.2953" class="difflineminus">-  if (sending)</span>
<a href="#l3.2954"></a><span id="l3.2954" class="difflineminus">-  {</span>
<a href="#l3.2955"></a><span id="l3.2955" class="difflineplus">+  let sending = msgType == Ci.nsIMsgCompDeliverMode.Now ||</span>
<a href="#l3.2956"></a><span id="l3.2956" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.Later ||</span>
<a href="#l3.2957"></a><span id="l3.2957" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.Background;</span>
<a href="#l3.2958"></a><span id="l3.2958" class="difflineplus">+  if (sending) {</span>
<a href="#l3.2959"></a><span id="l3.2959">     expandRecipients();</span>
<a href="#l3.2960"></a><span id="l3.2960">     // Check if e-mail addresses are complete, in case user turned off</span>
<a href="#l3.2961"></a><span id="l3.2961">     // autocomplete to local domain.</span>
<a href="#l3.2962"></a><span id="l3.2962">     if (!CheckValidEmailAddress(msgCompFields))</span>
<a href="#l3.2963"></a><span id="l3.2963">       return;</span>
<a href="#l3.2964"></a><span id="l3.2964"> </span>
<a href="#l3.2965"></a><span id="l3.2965">     // Do we need to check the spelling?</span>
<a href="#l3.2966"></a><span id="l3.2966" class="difflineminus">-    if (DoSpellCheckBeforeSend())</span>
<a href="#l3.2967"></a><span id="l3.2967" class="difflineminus">-    {</span>
<a href="#l3.2968"></a><span id="l3.2968" class="difflineplus">+    if (DoSpellCheckBeforeSend()) {</span>
<a href="#l3.2969"></a><span id="l3.2969">       // We disable spellcheck for the following -subject line, attachment</span>
<a href="#l3.2970"></a><span id="l3.2970">       // pane, identity and addressing widget therefore we need to explicitly</span>
<a href="#l3.2971"></a><span id="l3.2971">       // focus on the mail body when we have to do a spellcheck.</span>
<a href="#l3.2972"></a><span id="l3.2972">       SetMsgBodyFrameFocus();</span>
<a href="#l3.2973"></a><span id="l3.2973">       window.cancelSendMessage = false;</span>
<a href="#l3.2974"></a><span id="l3.2974">       window.openDialog(&quot;chrome://editor/content/EdSpellCheck.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l3.2975"></a><span id="l3.2975">                         &quot;dialog,close,titlebar,modal,resizable&quot;, true, true, false);</span>
<a href="#l3.2976"></a><span id="l3.2976"> </span>
<a href="#l3.2977"></a><span id="l3.2977">       if (window.cancelSendMessage)</span>
<a href="#l3.2978"></a><span id="l3.2978">         return;</span>
<a href="#l3.2979"></a><span id="l3.2979">     }</span>
<a href="#l3.2980"></a><span id="l3.2980"> </span>
<a href="#l3.2981"></a><span id="l3.2981">     // Strip trailing spaces and long consecutive WSP sequences from the</span>
<a href="#l3.2982"></a><span id="l3.2982">     // subject line to prevent getting only WSP chars on a folded line.</span>
<a href="#l3.2983"></a><span id="l3.2983">     let fixedSubject = subject.replace(/\s{74,}/g, &quot;    &quot;).trimRight();</span>
<a href="#l3.2984"></a><span id="l3.2984" class="difflineminus">-    if (fixedSubject != subject)</span>
<a href="#l3.2985"></a><span id="l3.2985" class="difflineminus">-    {</span>
<a href="#l3.2986"></a><span id="l3.2986" class="difflineplus">+    if (fixedSubject != subject) {</span>
<a href="#l3.2987"></a><span id="l3.2987">       subject = fixedSubject;</span>
<a href="#l3.2988"></a><span id="l3.2988">       msgCompFields.subject = fixedSubject;</span>
<a href="#l3.2989"></a><span id="l3.2989">       GetMsgSubjectElement().value = fixedSubject;</span>
<a href="#l3.2990"></a><span id="l3.2990">     }</span>
<a href="#l3.2991"></a><span id="l3.2991"> </span>
<a href="#l3.2992"></a><span id="l3.2992">     // Remind the person if there isn't a subject</span>
<a href="#l3.2993"></a><span id="l3.2993" class="difflineminus">-    if (subject == &quot;&quot;)</span>
<a href="#l3.2994"></a><span id="l3.2994" class="difflineminus">-    {</span>
<a href="#l3.2995"></a><span id="l3.2995" class="difflineplus">+    if (subject == &quot;&quot;) {</span>
<a href="#l3.2996"></a><span id="l3.2996">       if (Services.prompt.confirmEx(</span>
<a href="#l3.2997"></a><span id="l3.2997">             window,</span>
<a href="#l3.2998"></a><span id="l3.2998">             getComposeBundle().getString(&quot;subjectEmptyTitle&quot;),</span>
<a href="#l3.2999"></a><span id="l3.2999">             getComposeBundle().getString(&quot;subjectEmptyMessage&quot;),</span>
<a href="#l3.3000"></a><span id="l3.3000">             (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l3.3001"></a><span id="l3.3001">             (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l3.3002"></a><span id="l3.3002">             getComposeBundle().getString(&quot;sendWithEmptySubjectButton&quot;),</span>
<a href="#l3.3003"></a><span id="l3.3003">             getComposeBundle().getString(&quot;cancelSendingButton&quot;),</span>
<a href="#l3.3004"></a><span id="l3.3004" class="difflineminus">-            null, null, {value:0}) == 1)</span>
<a href="#l3.3005"></a><span id="l3.3005" class="difflineminus">-      {</span>
<a href="#l3.3006"></a><span id="l3.3006" class="difflineplus">+            null, null, {value: 0}) == 1) {</span>
<a href="#l3.3007"></a><span id="l3.3007">         GetMsgSubjectElement().focus();</span>
<a href="#l3.3008"></a><span id="l3.3008">         return;</span>
<a href="#l3.3009"></a><span id="l3.3009">       }</span>
<a href="#l3.3010"></a><span id="l3.3010">     }</span>
<a href="#l3.3011"></a><span id="l3.3011"> </span>
<a href="#l3.3012"></a><span id="l3.3012">     // Attachment Reminder: Alert the user if</span>
<a href="#l3.3013"></a><span id="l3.3013">     //  - the user requested &quot;Remind me later&quot; from either the notification bar or the menu</span>
<a href="#l3.3014"></a><span id="l3.3014">     //    (alert regardless of the number of files already attached: we can't guess for how many</span>
<a href="#l3.3015"></a><span id="l3.3015" class="difflineat">@@ -3287,48 +3151,45 @@ function GenericSendMessage(msgType)</span>
<a href="#l3.3016"></a><span id="l3.3016">     //    that the message has no attachment(s) yet, message still contains some attachment</span>
<a href="#l3.3017"></a><span id="l3.3017">     //    keywords, and notification was not dismissed).</span>
<a href="#l3.3018"></a><span id="l3.3018">     if (gManualAttachmentReminder || (getPref(&quot;mail.compose.attachment_reminder_aggressive&quot;) &amp;&amp;</span>
<a href="#l3.3019"></a><span id="l3.3019">          document.getElementById(&quot;attachmentNotificationBox&quot;)</span>
<a href="#l3.3020"></a><span id="l3.3020">                  .getNotificationWithValue(&quot;attachmentReminder&quot;))) {</span>
<a href="#l3.3021"></a><span id="l3.3021">       let flags = Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_IS_STRING +</span>
<a href="#l3.3022"></a><span id="l3.3022">                   Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_IS_STRING;</span>
<a href="#l3.3023"></a><span id="l3.3023">       let hadForgotten = Services.prompt.confirmEx(window,</span>
<a href="#l3.3024"></a><span id="l3.3024" class="difflineminus">-                            getComposeBundle().getString(&quot;attachmentReminderTitle&quot;),</span>
<a href="#l3.3025"></a><span id="l3.3025" class="difflineminus">-                            getComposeBundle().getString(&quot;attachmentReminderMsg&quot;),</span>
<a href="#l3.3026"></a><span id="l3.3026" class="difflineminus">-                            flags,</span>
<a href="#l3.3027"></a><span id="l3.3027" class="difflineminus">-                            getComposeBundle().getString(&quot;attachmentReminderFalseAlarm&quot;),</span>
<a href="#l3.3028"></a><span id="l3.3028" class="difflineminus">-                            getComposeBundle().getString(&quot;attachmentReminderYesIForgot&quot;),</span>
<a href="#l3.3029"></a><span id="l3.3029" class="difflineminus">-                            null, null, {value:0});</span>
<a href="#l3.3030"></a><span id="l3.3030" class="difflineplus">+                         getComposeBundle().getString(&quot;attachmentReminderTitle&quot;),</span>
<a href="#l3.3031"></a><span id="l3.3031" class="difflineplus">+                         getComposeBundle().getString(&quot;attachmentReminderMsg&quot;),</span>
<a href="#l3.3032"></a><span id="l3.3032" class="difflineplus">+                         flags,</span>
<a href="#l3.3033"></a><span id="l3.3033" class="difflineplus">+                         getComposeBundle().getString(&quot;attachmentReminderFalseAlarm&quot;),</span>
<a href="#l3.3034"></a><span id="l3.3034" class="difflineplus">+                         getComposeBundle().getString(&quot;attachmentReminderYesIForgot&quot;),</span>
<a href="#l3.3035"></a><span id="l3.3035" class="difflineplus">+                         null, null, {value: 0});</span>
<a href="#l3.3036"></a><span id="l3.3036">       // Deactivate manual attachment reminder after showing the alert to avoid alert loop.</span>
<a href="#l3.3037"></a><span id="l3.3037">       // We also deactivate reminder when user ignores alert with [x] or [ESC].</span>
<a href="#l3.3038"></a><span id="l3.3038">       if (gManualAttachmentReminder)</span>
<a href="#l3.3039"></a><span id="l3.3039">         toggleAttachmentReminder(false);</span>
<a href="#l3.3040"></a><span id="l3.3040"> </span>
<a href="#l3.3041"></a><span id="l3.3041">       if (hadForgotten)</span>
<a href="#l3.3042"></a><span id="l3.3042">         return;</span>
<a href="#l3.3043"></a><span id="l3.3043">     }</span>
<a href="#l3.3044"></a><span id="l3.3044"> </span>
<a href="#l3.3045"></a><span id="l3.3045">     // Check if the user tries to send a message to a newsgroup through a mail</span>
<a href="#l3.3046"></a><span id="l3.3046">     // account.</span>
<a href="#l3.3047"></a><span id="l3.3047">     var currentAccountKey = getCurrentAccountKey();</span>
<a href="#l3.3048"></a><span id="l3.3048">     let account = MailServices.accounts.getAccount(currentAccountKey);</span>
<a href="#l3.3049"></a><span id="l3.3049" class="difflineminus">-    if (!account)</span>
<a href="#l3.3050"></a><span id="l3.3050" class="difflineminus">-    {</span>
<a href="#l3.3051"></a><span id="l3.3051" class="difflineplus">+    if (!account) {</span>
<a href="#l3.3052"></a><span id="l3.3052">       throw new Error(&quot;currentAccountKey '&quot; + currentAccountKey +</span>
<a href="#l3.3053"></a><span id="l3.3053">                       &quot;' has no matching account!&quot;);</span>
<a href="#l3.3054"></a><span id="l3.3054">     }</span>
<a href="#l3.3055"></a><span id="l3.3055" class="difflineminus">-    if (account.incomingServer.type != &quot;nntp&quot; &amp;&amp; msgCompFields.newsgroups != &quot;&quot;)</span>
<a href="#l3.3056"></a><span id="l3.3056" class="difflineminus">-    {</span>
<a href="#l3.3057"></a><span id="l3.3057" class="difflineplus">+    if (account.incomingServer.type != &quot;nntp&quot; &amp;&amp; msgCompFields.newsgroups != &quot;&quot;) {</span>
<a href="#l3.3058"></a><span id="l3.3058">       const kDontAskAgainPref = &quot;mail.compose.dontWarnMail2Newsgroup&quot;;</span>
<a href="#l3.3059"></a><span id="l3.3059">       // default to ask user if the pref is not set</span>
<a href="#l3.3060"></a><span id="l3.3060">       let dontAskAgain = getPref(kDontAskAgainPref);</span>
<a href="#l3.3061"></a><span id="l3.3061" class="difflineminus">-      if (!dontAskAgain)</span>
<a href="#l3.3062"></a><span id="l3.3062" class="difflineminus">-      {</span>
<a href="#l3.3063"></a><span id="l3.3063" class="difflineminus">-        let checkbox = {value:false};</span>
<a href="#l3.3064"></a><span id="l3.3064" class="difflineplus">+      if (!dontAskAgain) {</span>
<a href="#l3.3065"></a><span id="l3.3065" class="difflineplus">+        let checkbox = {value: false};</span>
<a href="#l3.3066"></a><span id="l3.3066">         let okToProceed = Services.prompt.confirmCheck(</span>
<a href="#l3.3067"></a><span id="l3.3067">                               window,</span>
<a href="#l3.3068"></a><span id="l3.3068">                               getComposeBundle().getString(&quot;noNewsgroupSupportTitle&quot;),</span>
<a href="#l3.3069"></a><span id="l3.3069">                               getComposeBundle().getString(&quot;recipientDlogMessage&quot;),</span>
<a href="#l3.3070"></a><span id="l3.3070">                               getComposeBundle().getString(&quot;CheckMsg&quot;),</span>
<a href="#l3.3071"></a><span id="l3.3071">                               checkbox);</span>
<a href="#l3.3072"></a><span id="l3.3072">         if (!okToProceed)</span>
<a href="#l3.3073"></a><span id="l3.3073">           return;</span>
<a href="#l3.3074"></a><span id="l3.3074" class="difflineat">@@ -3343,78 +3204,72 @@ function GenericSendMessage(msgType)</span>
<a href="#l3.3075"></a><span id="l3.3075">       msgCompFields.newsgroups = &quot;&quot;;</span>
<a href="#l3.3076"></a><span id="l3.3076">     }</span>
<a href="#l3.3077"></a><span id="l3.3077"> </span>
<a href="#l3.3078"></a><span id="l3.3078">     // Before sending the message, check what to do with HTML message,</span>
<a href="#l3.3079"></a><span id="l3.3079">     // eventually abort.</span>
<a href="#l3.3080"></a><span id="l3.3080">     var convert = DetermineConvertibility();</span>
<a href="#l3.3081"></a><span id="l3.3081">     var action = DetermineHTMLAction(convert);</span>
<a href="#l3.3082"></a><span id="l3.3082"> </span>
<a href="#l3.3083"></a><span id="l3.3083" class="difflineminus">-    if (action == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l3.3084"></a><span id="l3.3084" class="difflineminus">-    {</span>
<a href="#l3.3085"></a><span id="l3.3085" class="difflineminus">-      var recommAction = (convert == nsIMsgCompConvertible.No)</span>
<a href="#l3.3086"></a><span id="l3.3086" class="difflineminus">-                          ? nsIMsgCompSendFormat.AskUser</span>
<a href="#l3.3087"></a><span id="l3.3087" class="difflineminus">-                          : nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.3088"></a><span id="l3.3088" class="difflineminus">-      var result2 = {action:recommAction, convertible:convert, abort:false};</span>
<a href="#l3.3089"></a><span id="l3.3089" class="difflineplus">+    if (action == Ci.nsIMsgCompSendFormat.AskUser) {</span>
<a href="#l3.3090"></a><span id="l3.3090" class="difflineplus">+      var recommAction = (convert == Ci.nsIMsgCompConvertible.No)</span>
<a href="#l3.3091"></a><span id="l3.3091" class="difflineplus">+                          ? Ci.nsIMsgCompSendFormat.AskUser</span>
<a href="#l3.3092"></a><span id="l3.3092" class="difflineplus">+                          : Ci.nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.3093"></a><span id="l3.3093" class="difflineplus">+      var result2 = {action: recommAction, convertible: convert, abort: false};</span>
<a href="#l3.3094"></a><span id="l3.3094">       window.openDialog(&quot;chrome://messenger/content/messengercompose/askSendFormat.xul&quot;,</span>
<a href="#l3.3095"></a><span id="l3.3095">                         &quot;askSendFormatDialog&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l3.3096"></a><span id="l3.3096">                         result2);</span>
<a href="#l3.3097"></a><span id="l3.3097">       if (result2.abort)</span>
<a href="#l3.3098"></a><span id="l3.3098">         return;</span>
<a href="#l3.3099"></a><span id="l3.3099">       action = result2.action;</span>
<a href="#l3.3100"></a><span id="l3.3100">     }</span>
<a href="#l3.3101"></a><span id="l3.3101"> </span>
<a href="#l3.3102"></a><span id="l3.3102">     // We will remember the users &quot;send format&quot; decision in the address</span>
<a href="#l3.3103"></a><span id="l3.3103">     // collector code (see nsAbAddressCollector::CollectAddress())</span>
<a href="#l3.3104"></a><span id="l3.3104">     // by using msgCompFields.forcePlainText and msgCompFields.useMultipartAlternative</span>
<a href="#l3.3105"></a><span id="l3.3105">     // to determine the nsIAbPreferMailFormat (unknown, plaintext, or html).</span>
<a href="#l3.3106"></a><span id="l3.3106">     // If the user sends both, we remember html.</span>
<a href="#l3.3107"></a><span id="l3.3107" class="difflineminus">-    switch (action)</span>
<a href="#l3.3108"></a><span id="l3.3108" class="difflineminus">-    {</span>
<a href="#l3.3109"></a><span id="l3.3109" class="difflineminus">-      case nsIMsgCompSendFormat.PlainText:</span>
<a href="#l3.3110"></a><span id="l3.3110" class="difflineplus">+    switch (action) {</span>
<a href="#l3.3111"></a><span id="l3.3111" class="difflineplus">+      case Ci.nsIMsgCompSendFormat.PlainText:</span>
<a href="#l3.3112"></a><span id="l3.3112">         msgCompFields.forcePlainText = true;</span>
<a href="#l3.3113"></a><span id="l3.3113">         msgCompFields.useMultipartAlternative = false;</span>
<a href="#l3.3114"></a><span id="l3.3114">         break;</span>
<a href="#l3.3115"></a><span id="l3.3115" class="difflineminus">-      case nsIMsgCompSendFormat.HTML:</span>
<a href="#l3.3116"></a><span id="l3.3116" class="difflineplus">+      case Ci.nsIMsgCompSendFormat.HTML:</span>
<a href="#l3.3117"></a><span id="l3.3117">         msgCompFields.forcePlainText = false;</span>
<a href="#l3.3118"></a><span id="l3.3118">         msgCompFields.useMultipartAlternative = false;</span>
<a href="#l3.3119"></a><span id="l3.3119">         break;</span>
<a href="#l3.3120"></a><span id="l3.3120" class="difflineminus">-      case nsIMsgCompSendFormat.Both:</span>
<a href="#l3.3121"></a><span id="l3.3121" class="difflineplus">+      case Ci.nsIMsgCompSendFormat.Both:</span>
<a href="#l3.3122"></a><span id="l3.3122">         msgCompFields.forcePlainText = false;</span>
<a href="#l3.3123"></a><span id="l3.3123">         msgCompFields.useMultipartAlternative = true;</span>
<a href="#l3.3124"></a><span id="l3.3124">         break;</span>
<a href="#l3.3125"></a><span id="l3.3125">       default:</span>
<a href="#l3.3126"></a><span id="l3.3126">         throw new Error(&quot;Invalid nsIMsgCompSendFormat action; action=&quot; + action);</span>
<a href="#l3.3127"></a><span id="l3.3127">     }</span>
<a href="#l3.3128"></a><span id="l3.3128">   }</span>
<a href="#l3.3129"></a><span id="l3.3129"> </span>
<a href="#l3.3130"></a><span id="l3.3130">   // hook for extra compose pre-processing</span>
<a href="#l3.3131"></a><span id="l3.3131">   Services.obs.notifyObservers(window, &quot;mail:composeOnSend&quot;);</span>
<a href="#l3.3132"></a><span id="l3.3132"> </span>
<a href="#l3.3133"></a><span id="l3.3133">   var originalCharset = gMsgCompose.compFields.characterSet;</span>
<a href="#l3.3134"></a><span id="l3.3134">   // Check if the headers of composing mail can be converted to a mail charset.</span>
<a href="#l3.3135"></a><span id="l3.3135" class="difflineminus">-  if (msgType == nsIMsgCompDeliverMode.Now ||</span>
<a href="#l3.3136"></a><span id="l3.3136" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.Later ||</span>
<a href="#l3.3137"></a><span id="l3.3137" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.Background ||</span>
<a href="#l3.3138"></a><span id="l3.3138" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.Save ||</span>
<a href="#l3.3139"></a><span id="l3.3139" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l3.3140"></a><span id="l3.3140" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l3.3141"></a><span id="l3.3141" class="difflineminus">-    msgType == nsIMsgCompDeliverMode.SaveAsTemplate)</span>
<a href="#l3.3142"></a><span id="l3.3142" class="difflineminus">-  {</span>
<a href="#l3.3143"></a><span id="l3.3143" class="difflineminus">-    var fallbackCharset = new Object;</span>
<a href="#l3.3144"></a><span id="l3.3144" class="difflineplus">+  if (msgType == Ci.nsIMsgCompDeliverMode.Now ||</span>
<a href="#l3.3145"></a><span id="l3.3145" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.Later ||</span>
<a href="#l3.3146"></a><span id="l3.3146" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.Background ||</span>
<a href="#l3.3147"></a><span id="l3.3147" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.Save ||</span>
<a href="#l3.3148"></a><span id="l3.3148" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l3.3149"></a><span id="l3.3149" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l3.3150"></a><span id="l3.3150" class="difflineplus">+      msgType == Ci.nsIMsgCompDeliverMode.SaveAsTemplate) {</span>
<a href="#l3.3151"></a><span id="l3.3151" class="difflineplus">+    var fallbackCharset = {};</span>
<a href="#l3.3152"></a><span id="l3.3152">     // Check encoding, switch to UTF-8 if the default encoding doesn't fit</span>
<a href="#l3.3153"></a><span id="l3.3153">     // and disable_fallback_to_utf8 isn't set for this encoding.</span>
<a href="#l3.3154"></a><span id="l3.3154" class="difflineminus">-    if (!gMsgCompose.checkCharsetConversion(getCurrentIdentity(), fallbackCharset))</span>
<a href="#l3.3155"></a><span id="l3.3155" class="difflineminus">-    {</span>
<a href="#l3.3156"></a><span id="l3.3156" class="difflineplus">+    if (!gMsgCompose.checkCharsetConversion(getCurrentIdentity(), fallbackCharset)) {</span>
<a href="#l3.3157"></a><span id="l3.3157">       var disableFallback = false;</span>
<a href="#l3.3158"></a><span id="l3.3158" class="difflineminus">-      try</span>
<a href="#l3.3159"></a><span id="l3.3159" class="difflineminus">-      {</span>
<a href="#l3.3160"></a><span id="l3.3160" class="difflineplus">+      try {</span>
<a href="#l3.3161"></a><span id="l3.3161">         disableFallback = getPref(&quot;mailnews.disable_fallback_to_utf8.&quot; + originalCharset);</span>
<a href="#l3.3162"></a><span id="l3.3162" class="difflineminus">-      }</span>
<a href="#l3.3163"></a><span id="l3.3163" class="difflineminus">-      catch (e) {}</span>
<a href="#l3.3164"></a><span id="l3.3164" class="difflineplus">+      } catch (e) {}</span>
<a href="#l3.3165"></a><span id="l3.3165">       if (disableFallback)</span>
<a href="#l3.3166"></a><span id="l3.3166">         msgCompFields.needToCheckCharset = false;</span>
<a href="#l3.3167"></a><span id="l3.3167">       else</span>
<a href="#l3.3168"></a><span id="l3.3168">         fallbackCharset.value = &quot;UTF-8&quot;;</span>
<a href="#l3.3169"></a><span id="l3.3169">     }</span>
<a href="#l3.3170"></a><span id="l3.3170"> </span>
<a href="#l3.3171"></a><span id="l3.3171">     if (fallbackCharset &amp;&amp;</span>
<a href="#l3.3172"></a><span id="l3.3172">         fallbackCharset.value &amp;&amp; fallbackCharset.value != &quot;&quot;)</span>
<a href="#l3.3173"></a><span id="l3.3173" class="difflineat">@@ -3428,104 +3283,101 @@ function GenericSendMessage(msgType)</span>
<a href="#l3.3174"></a><span id="l3.3174">     var event = document.createEvent(&quot;UIEvents&quot;);</span>
<a href="#l3.3175"></a><span id="l3.3175">     event.initEvent(&quot;compose-send-message&quot;, false, true);</span>
<a href="#l3.3176"></a><span id="l3.3176">     var msgcomposeWindow = document.getElementById(&quot;msgcomposeWindow&quot;);</span>
<a href="#l3.3177"></a><span id="l3.3177">     msgcomposeWindow.setAttribute(&quot;msgtype&quot;, msgType);</span>
<a href="#l3.3178"></a><span id="l3.3178">     msgcomposeWindow.dispatchEvent(event);</span>
<a href="#l3.3179"></a><span id="l3.3179">     if (event.defaultPrevented)</span>
<a href="#l3.3180"></a><span id="l3.3180">       throw Cr.NS_ERROR_ABORT;</span>
<a href="#l3.3181"></a><span id="l3.3181"> </span>
<a href="#l3.3182"></a><span id="l3.3182" class="difflineminus">-    gAutoSaving = (msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.3183"></a><span id="l3.3183" class="difflineplus">+    gAutoSaving = (msgType == Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.3184"></a><span id="l3.3184"> </span>
<a href="#l3.3185"></a><span id="l3.3185">     // disable the ui if we're not auto-saving</span>
<a href="#l3.3186"></a><span id="l3.3186" class="difflineminus">-    if (!gAutoSaving)</span>
<a href="#l3.3187"></a><span id="l3.3187" class="difflineplus">+    if (!gAutoSaving) {</span>
<a href="#l3.3188"></a><span id="l3.3188">       ToggleWindowLock(true);</span>
<a href="#l3.3189"></a><span id="l3.3189" class="difflineminus">-</span>
<a href="#l3.3190"></a><span id="l3.3190" class="difflineminus">-    // If we're auto saving, mark the body as not changed here, and not</span>
<a href="#l3.3191"></a><span id="l3.3191" class="difflineminus">-    // when the save is done, because the user might change it between now</span>
<a href="#l3.3192"></a><span id="l3.3192" class="difflineminus">-    // and when the save is done.</span>
<a href="#l3.3193"></a><span id="l3.3193" class="difflineminus">-    else</span>
<a href="#l3.3194"></a><span id="l3.3194" class="difflineminus">-    {</span>
<a href="#l3.3195"></a><span id="l3.3195" class="difflineplus">+    } else {</span>
<a href="#l3.3196"></a><span id="l3.3196" class="difflineplus">+      // If we're auto saving, mark the body as not changed here, and not</span>
<a href="#l3.3197"></a><span id="l3.3197" class="difflineplus">+      // when the save is done, because the user might change it between now</span>
<a href="#l3.3198"></a><span id="l3.3198" class="difflineplus">+      // and when the save is done.</span>
<a href="#l3.3199"></a><span id="l3.3199">       SetContentAndBodyAsUnmodified();</span>
<a href="#l3.3200"></a><span id="l3.3200">     }</span>
<a href="#l3.3201"></a><span id="l3.3201"> </span>
<a href="#l3.3202"></a><span id="l3.3202">     var progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l3.3203"></a><span id="l3.3203">                      .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l3.3204"></a><span id="l3.3204" class="difflineminus">-    if (progress)</span>
<a href="#l3.3205"></a><span id="l3.3205" class="difflineminus">-    {</span>
<a href="#l3.3206"></a><span id="l3.3206" class="difflineplus">+    if (progress) {</span>
<a href="#l3.3207"></a><span id="l3.3207">       progress.registerListener(progressListener);</span>
<a href="#l3.3208"></a><span id="l3.3208" class="difflineminus">-      if (msgType == nsIMsgCompDeliverMode.Save ||</span>
<a href="#l3.3209"></a><span id="l3.3209" class="difflineminus">-          msgType == nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l3.3210"></a><span id="l3.3210" class="difflineminus">-          msgType == nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l3.3211"></a><span id="l3.3211" class="difflineminus">-          msgType == nsIMsgCompDeliverMode.SaveAsTemplate)</span>
<a href="#l3.3212"></a><span id="l3.3212" class="difflineplus">+      if (msgType == Ci.nsIMsgCompDeliverMode.Save ||</span>
<a href="#l3.3213"></a><span id="l3.3213" class="difflineplus">+          msgType == Ci.nsIMsgCompDeliverMode.SaveAsDraft ||</span>
<a href="#l3.3214"></a><span id="l3.3214" class="difflineplus">+          msgType == Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft ||</span>
<a href="#l3.3215"></a><span id="l3.3215" class="difflineplus">+          msgType == Ci.nsIMsgCompDeliverMode.SaveAsTemplate)</span>
<a href="#l3.3216"></a><span id="l3.3216">         gSaveOperationInProgress = true;</span>
<a href="#l3.3217"></a><span id="l3.3217">       else</span>
<a href="#l3.3218"></a><span id="l3.3218">         gSendOperationInProgress = true;</span>
<a href="#l3.3219"></a><span id="l3.3219">     }</span>
<a href="#l3.3220"></a><span id="l3.3220">     msgWindow.domWindow = window;</span>
<a href="#l3.3221"></a><span id="l3.3221">     msgWindow.rootDocShell.allowAuth = true;</span>
<a href="#l3.3222"></a><span id="l3.3222">     gMsgCompose.SendMsg(msgType, getCurrentIdentity(),</span>
<a href="#l3.3223"></a><span id="l3.3223">                         getCurrentAccountKey(), msgWindow, progress);</span>
<a href="#l3.3224"></a><span id="l3.3224" class="difflineminus">-  }</span>
<a href="#l3.3225"></a><span id="l3.3225" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.3226"></a><span id="l3.3226" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.3227"></a><span id="l3.3227">     Cu.reportError(&quot;GenericSendMessage FAILED: &quot; + ex);</span>
<a href="#l3.3228"></a><span id="l3.3228">     ToggleWindowLock(false);</span>
<a href="#l3.3229"></a><span id="l3.3229">   }</span>
<a href="#l3.3230"></a><span id="l3.3230">   if (gMsgCompose &amp;&amp; originalCharset != gMsgCompose.compFields.characterSet)</span>
<a href="#l3.3231"></a><span id="l3.3231">     SetDocumentCharacterSet(gMsgCompose.compFields.characterSet);</span>
<a href="#l3.3232"></a><span id="l3.3232"> }</span>
<a href="#l3.3233"></a><span id="l3.3233" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l3.3234"></a><span id="l3.3234"> </span>
<a href="#l3.3235"></a><span id="l3.3235"> /**</span>
<a href="#l3.3236"></a><span id="l3.3236">  * Check if the given address is valid (contains a @).</span>
<a href="#l3.3237"></a><span id="l3.3237">  *</span>
<a href="#l3.3238"></a><span id="l3.3238">  * @param aAddress  The address string to check.</span>
<a href="#l3.3239"></a><span id="l3.3239">  */</span>
<a href="#l3.3240"></a><span id="l3.3240"> function isValidAddress(aAddress) {</span>
<a href="#l3.3241"></a><span id="l3.3241">   return (aAddress.includes(&quot;@&quot;, 1) &amp;&amp; !aAddress.endsWith(&quot;@&quot;));</span>
<a href="#l3.3242"></a><span id="l3.3242"> }</span>
<a href="#l3.3243"></a><span id="l3.3243"> </span>
<a href="#l3.3244"></a><span id="l3.3244"> /**</span>
<a href="#l3.3245"></a><span id="l3.3245">  * Keep the Send buttons disabled until any recipient is entered.</span>
<a href="#l3.3246"></a><span id="l3.3246">  */</span>
<a href="#l3.3247"></a><span id="l3.3247" class="difflineminus">-function updateSendLock()</span>
<a href="#l3.3248"></a><span id="l3.3248" class="difflineminus">-{</span>
<a href="#l3.3249"></a><span id="l3.3249" class="difflineplus">+function updateSendLock() {</span>
<a href="#l3.3250"></a><span id="l3.3250">   gSendLocked = true;</span>
<a href="#l3.3251"></a><span id="l3.3251">   if (!gMsgCompose)</span>
<a href="#l3.3252"></a><span id="l3.3252">     return;</span>
<a href="#l3.3253"></a><span id="l3.3253"> </span>
<a href="#l3.3254"></a><span id="l3.3254">   const mailTypes = [ &quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_bcc&quot; ];</span>
<a href="#l3.3255"></a><span id="l3.3255"> </span>
<a href="#l3.3256"></a><span id="l3.3256">   // Enable the send buttons if anything usable was entered into at least one</span>
<a href="#l3.3257"></a><span id="l3.3257">   // recipient field.</span>
<a href="#l3.3258"></a><span id="l3.3258" class="difflineminus">-  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row ++)</span>
<a href="#l3.3259"></a><span id="l3.3259" class="difflineminus">-  {</span>
<a href="#l3.3260"></a><span id="l3.3260" class="difflineplus">+  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l3.3261"></a><span id="l3.3261">     let popupValue = awGetPopupElement(row).value;</span>
<a href="#l3.3262"></a><span id="l3.3262">     let inputValue = awGetInputElement(row).value.trim();</span>
<a href="#l3.3263"></a><span id="l3.3263" class="difflineminus">-    let listNames = null;</span>
<a href="#l3.3264"></a><span id="l3.3264" class="difflineminus">-    if ((mailTypes.includes(popupValue) &amp;&amp;</span>
<a href="#l3.3265"></a><span id="l3.3265" class="difflineminus">-         // a properly looking email address</span>
<a href="#l3.3266"></a><span id="l3.3266" class="difflineminus">-        (isValidAddress(inputValue) ||</span>
<a href="#l3.3267"></a><span id="l3.3267" class="difflineminus">-         // a valid mailing list name in some or our addressbooks</span>
<a href="#l3.3268"></a><span id="l3.3268" class="difflineminus">-         ((listNames = MimeParser.parseHeaderField(inputValue, MimeParser.HEADER_ADDRESS)) &amp;&amp;</span>
<a href="#l3.3269"></a><span id="l3.3269" class="difflineminus">-          listNames.length &gt; 0 &amp;&amp; MailServices.ab.mailListNameExists(listNames[0].name))</span>
<a href="#l3.3270"></a><span id="l3.3270" class="difflineminus">-        )) || ((popupValue == &quot;addr_newsgroups&quot;) &amp;&amp; (inputValue != &quot;&quot;)))</span>
<a href="#l3.3271"></a><span id="l3.3271" class="difflineminus">-    {</span>
<a href="#l3.3272"></a><span id="l3.3272" class="difflineplus">+    if (mailTypes.includes(popupValue)) {</span>
<a href="#l3.3273"></a><span id="l3.3273" class="difflineplus">+      if (isValidAddress(inputValue)) { // a properly looking email address</span>
<a href="#l3.3274"></a><span id="l3.3274" class="difflineplus">+        gSendLocked = false;</span>
<a href="#l3.3275"></a><span id="l3.3275" class="difflineplus">+        break;</span>
<a href="#l3.3276"></a><span id="l3.3276" class="difflineplus">+      } else { // a valid mailing list name in some or our addressbooks</span>
<a href="#l3.3277"></a><span id="l3.3277" class="difflineplus">+        let listNames = MimeParser.parseHeaderField(inputValue, MimeParser.HEADER_ADDRESS);</span>
<a href="#l3.3278"></a><span id="l3.3278" class="difflineplus">+        if (listNames.length &gt; 0 &amp;&amp; MailServices.ab.mailListNameExists(listNames[0].name)) {</span>
<a href="#l3.3279"></a><span id="l3.3279" class="difflineplus">+          gSendLocked = false;</span>
<a href="#l3.3280"></a><span id="l3.3280" class="difflineplus">+          break;</span>
<a href="#l3.3281"></a><span id="l3.3281" class="difflineplus">+        }</span>
<a href="#l3.3282"></a><span id="l3.3282" class="difflineplus">+      }</span>
<a href="#l3.3283"></a><span id="l3.3283" class="difflineplus">+    } else if (popupValue == &quot;addr_newsgroups&quot; &amp;&amp; inputValue != &quot;&quot;) {</span>
<a href="#l3.3284"></a><span id="l3.3284">       gSendLocked = false;</span>
<a href="#l3.3285"></a><span id="l3.3285">       break;</span>
<a href="#l3.3286"></a><span id="l3.3286">     }</span>
<a href="#l3.3287"></a><span id="l3.3287">   }</span>
<a href="#l3.3288"></a><span id="l3.3288"> }</span>
<a href="#l3.3289"></a><span id="l3.3289"> </span>
<a href="#l3.3290"></a><span id="l3.3290"> /**</span>
<a href="#l3.3291"></a><span id="l3.3291">  * Check if the entered addresses are valid and alert the user if they are not.</span>
<a href="#l3.3292"></a><span id="l3.3292">  *</span>
<a href="#l3.3293"></a><span id="l3.3293">  * @param aMsgCompFields  A nsIMsgCompFields object containing the fields to check.</span>
<a href="#l3.3294"></a><span id="l3.3294">  */</span>
<a href="#l3.3295"></a><span id="l3.3295" class="difflineminus">-function CheckValidEmailAddress(aMsgCompFields)</span>
<a href="#l3.3296"></a><span id="l3.3296" class="difflineminus">-{</span>
<a href="#l3.3297"></a><span id="l3.3297" class="difflineplus">+function CheckValidEmailAddress(aMsgCompFields) {</span>
<a href="#l3.3298"></a><span id="l3.3298">   let invalidStr;</span>
<a href="#l3.3299"></a><span id="l3.3299">   let recipientCount = 0;</span>
<a href="#l3.3300"></a><span id="l3.3300">   // Check that each of the To, CC, and BCC recipients contains a '@'.</span>
<a href="#l3.3301"></a><span id="l3.3301">   for (let type of [&quot;to&quot;, &quot;cc&quot;, &quot;bcc&quot;]) {</span>
<a href="#l3.3302"></a><span id="l3.3302">     let recipients = aMsgCompFields.splitRecipients(aMsgCompFields[type], false, {});</span>
<a href="#l3.3303"></a><span id="l3.3303">     // MsgCompFields contains only non-empty recipients.</span>
<a href="#l3.3304"></a><span id="l3.3304">     recipientCount += recipients.length;</span>
<a href="#l3.3305"></a><span id="l3.3305">     for (let recipient of recipients) {</span>
<a href="#l3.3306"></a><span id="l3.3306" class="difflineat">@@ -3539,385 +3391,367 @@ function CheckValidEmailAddress(aMsgComp</span>
<a href="#l3.3307"></a><span id="l3.3307">   }</span>
<a href="#l3.3308"></a><span id="l3.3308"> </span>
<a href="#l3.3309"></a><span id="l3.3309">   if (recipientCount == 0 &amp;&amp; aMsgCompFields.newsgroups.trim() == &quot;&quot;) {</span>
<a href="#l3.3310"></a><span id="l3.3310">     Services.prompt.alert(window, getComposeBundle().getString(&quot;addressInvalidTitle&quot;),</span>
<a href="#l3.3311"></a><span id="l3.3311">                           getComposeBundle().getString(&quot;noRecipients&quot;));</span>
<a href="#l3.3312"></a><span id="l3.3312">     return false;</span>
<a href="#l3.3313"></a><span id="l3.3313">   }</span>
<a href="#l3.3314"></a><span id="l3.3314"> </span>
<a href="#l3.3315"></a><span id="l3.3315" class="difflineminus">-  if (invalidStr)</span>
<a href="#l3.3316"></a><span id="l3.3316" class="difflineminus">-  {</span>
<a href="#l3.3317"></a><span id="l3.3317" class="difflineplus">+  if (invalidStr) {</span>
<a href="#l3.3318"></a><span id="l3.3318">     Services.prompt.alert(window, getComposeBundle().getString(&quot;addressInvalidTitle&quot;),</span>
<a href="#l3.3319"></a><span id="l3.3319">                           getComposeBundle().getFormattedString(&quot;addressInvalid&quot;,</span>
<a href="#l3.3320"></a><span id="l3.3320">                           [invalidStr], 1));</span>
<a href="#l3.3321"></a><span id="l3.3321">     return false;</span>
<a href="#l3.3322"></a><span id="l3.3322">   }</span>
<a href="#l3.3323"></a><span id="l3.3323"> </span>
<a href="#l3.3324"></a><span id="l3.3324">   return true;</span>
<a href="#l3.3325"></a><span id="l3.3325"> }</span>
<a href="#l3.3326"></a><span id="l3.3326"> </span>
<a href="#l3.3327"></a><span id="l3.3327" class="difflineminus">-function SendMessage()</span>
<a href="#l3.3328"></a><span id="l3.3328" class="difflineminus">-{</span>
<a href="#l3.3329"></a><span id="l3.3329" class="difflineplus">+function SendMessage() {</span>
<a href="#l3.3330"></a><span id="l3.3330">   let sendInBackground =</span>
<a href="#l3.3331"></a><span id="l3.3331">     Services.prefs.getBoolPref(&quot;mailnews.sendInBackground&quot;);</span>
<a href="#l3.3332"></a><span id="l3.3332">   if (sendInBackground &amp;&amp; (AppConstants.platform != &quot;macosx&quot;)) {</span>
<a href="#l3.3333"></a><span id="l3.3333">     let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l3.3334"></a><span id="l3.3334">     let count = 0;</span>
<a href="#l3.3335"></a><span id="l3.3335">     while (enumerator.hasMoreElements() &amp;&amp; count &lt; 2) {</span>
<a href="#l3.3336"></a><span id="l3.3336" class="difflineminus">-      let win = enumerator.getNext();</span>
<a href="#l3.3337"></a><span id="l3.3337" class="difflineplus">+      enumerator.getNext();</span>
<a href="#l3.3338"></a><span id="l3.3338">       count++;</span>
<a href="#l3.3339"></a><span id="l3.3339">     }</span>
<a href="#l3.3340"></a><span id="l3.3340">     if (count == 1)</span>
<a href="#l3.3341"></a><span id="l3.3341">       sendInBackground = false;</span>
<a href="#l3.3342"></a><span id="l3.3342">   }</span>
<a href="#l3.3343"></a><span id="l3.3343"> </span>
<a href="#l3.3344"></a><span id="l3.3344">   GenericSendMessage(sendInBackground ?</span>
<a href="#l3.3345"></a><span id="l3.3345" class="difflineminus">-                     nsIMsgCompDeliverMode.Background :</span>
<a href="#l3.3346"></a><span id="l3.3346" class="difflineminus">-                     nsIMsgCompDeliverMode.Now);</span>
<a href="#l3.3347"></a><span id="l3.3347" class="difflineplus">+                     Ci.nsIMsgCompDeliverMode.Background :</span>
<a href="#l3.3348"></a><span id="l3.3348" class="difflineplus">+                     Ci.nsIMsgCompDeliverMode.Now);</span>
<a href="#l3.3349"></a><span id="l3.3349">   ExitFullscreenMode();</span>
<a href="#l3.3350"></a><span id="l3.3350"> }</span>
<a href="#l3.3351"></a><span id="l3.3351"> </span>
<a href="#l3.3352"></a><span id="l3.3352" class="difflineminus">-function SendMessageWithCheck()</span>
<a href="#l3.3353"></a><span id="l3.3353" class="difflineminus">-{</span>
<a href="#l3.3354"></a><span id="l3.3354" class="difflineminus">-    var warn = getPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l3.3355"></a><span id="l3.3355" class="difflineminus">-</span>
<a href="#l3.3356"></a><span id="l3.3356" class="difflineminus">-    if (warn) {</span>
<a href="#l3.3357"></a><span id="l3.3357" class="difflineminus">-        let checkValue = {value:false};</span>
<a href="#l3.3358"></a><span id="l3.3358" class="difflineminus">-        let buttonPressed = Services.prompt.confirmEx(window,</span>
<a href="#l3.3359"></a><span id="l3.3359" class="difflineminus">-              getComposeBundle().getString('sendMessageCheckWindowTitle'),</span>
<a href="#l3.3360"></a><span id="l3.3360" class="difflineminus">-              getComposeBundle().getString('sendMessageCheckLabel'),</span>
<a href="#l3.3361"></a><span id="l3.3361" class="difflineminus">-              (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l3.3362"></a><span id="l3.3362" class="difflineminus">-              (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l3.3363"></a><span id="l3.3363" class="difflineminus">-              getComposeBundle().getString('sendMessageCheckSendButtonLabel'),</span>
<a href="#l3.3364"></a><span id="l3.3364" class="difflineminus">-              null, null,</span>
<a href="#l3.3365"></a><span id="l3.3365" class="difflineminus">-              getComposeBundle().getString('CheckMsg'),</span>
<a href="#l3.3366"></a><span id="l3.3366" class="difflineminus">-              checkValue);</span>
<a href="#l3.3367"></a><span id="l3.3367" class="difflineminus">-        if (buttonPressed != 0) {</span>
<a href="#l3.3368"></a><span id="l3.3368" class="difflineminus">-            return;</span>
<a href="#l3.3369"></a><span id="l3.3369" class="difflineminus">-        }</span>
<a href="#l3.3370"></a><span id="l3.3370" class="difflineminus">-        if (checkValue.value) {</span>
<a href="#l3.3371"></a><span id="l3.3371" class="difflineminus">-            Services.prefs.setBoolPref(&quot;mail.warn_on_send_accel_key&quot;, false);</span>
<a href="#l3.3372"></a><span id="l3.3372" class="difflineminus">-        }</span>
<a href="#l3.3373"></a><span id="l3.3373" class="difflineplus">+function SendMessageWithCheck() {</span>
<a href="#l3.3374"></a><span id="l3.3374" class="difflineplus">+  var warn = getPref(&quot;mail.warn_on_send_accel_key&quot;);</span>
<a href="#l3.3375"></a><span id="l3.3375" class="difflineplus">+</span>
<a href="#l3.3376"></a><span id="l3.3376" class="difflineplus">+  if (warn) {</span>
<a href="#l3.3377"></a><span id="l3.3377" class="difflineplus">+    let bundle = getComposeBundle();</span>
<a href="#l3.3378"></a><span id="l3.3378" class="difflineplus">+    let checkValue = {value: false};</span>
<a href="#l3.3379"></a><span id="l3.3379" class="difflineplus">+    let buttonPressed = Services.prompt.confirmEx(window,</span>
<a href="#l3.3380"></a><span id="l3.3380" class="difflineplus">+      bundle.getString(&quot;sendMessageCheckWindowTitle&quot;),</span>
<a href="#l3.3381"></a><span id="l3.3381" class="difflineplus">+      bundle.getString(&quot;sendMessageCheckLabel&quot;),</span>
<a href="#l3.3382"></a><span id="l3.3382" class="difflineplus">+      (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l3.3383"></a><span id="l3.3383" class="difflineplus">+      (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1),</span>
<a href="#l3.3384"></a><span id="l3.3384" class="difflineplus">+      bundle.getString(&quot;sendMessageCheckSendButtonLabel&quot;),</span>
<a href="#l3.3385"></a><span id="l3.3385" class="difflineplus">+      null, null,</span>
<a href="#l3.3386"></a><span id="l3.3386" class="difflineplus">+      bundle.getString(&quot;CheckMsg&quot;),</span>
<a href="#l3.3387"></a><span id="l3.3387" class="difflineplus">+      checkValue);</span>
<a href="#l3.3388"></a><span id="l3.3388" class="difflineplus">+    if (buttonPressed != 0) {</span>
<a href="#l3.3389"></a><span id="l3.3389" class="difflineplus">+      return;</span>
<a href="#l3.3390"></a><span id="l3.3390">     }</span>
<a href="#l3.3391"></a><span id="l3.3391" class="difflineplus">+    if (checkValue.value) {</span>
<a href="#l3.3392"></a><span id="l3.3392" class="difflineplus">+      Services.prefs.setBoolPref(&quot;mail.warn_on_send_accel_key&quot;, false);</span>
<a href="#l3.3393"></a><span id="l3.3393" class="difflineplus">+    }</span>
<a href="#l3.3394"></a><span id="l3.3394" class="difflineplus">+  }</span>
<a href="#l3.3395"></a><span id="l3.3395"> </span>
<a href="#l3.3396"></a><span id="l3.3396">   let sendInBackground = Services.prefs.getBoolPref(&quot;mailnews.sendInBackground&quot;);</span>
<a href="#l3.3397"></a><span id="l3.3397"> </span>
<a href="#l3.3398"></a><span id="l3.3398" class="difflineminus">-  GenericSendMessage(Services.io.offline ? nsIMsgCompDeliverMode.Later :</span>
<a href="#l3.3399"></a><span id="l3.3399" class="difflineminus">-                     (sendInBackground ?</span>
<a href="#l3.3400"></a><span id="l3.3400" class="difflineminus">-                      nsIMsgCompDeliverMode.Background :</span>
<a href="#l3.3401"></a><span id="l3.3401" class="difflineminus">-                      nsIMsgCompDeliverMode.Now));</span>
<a href="#l3.3402"></a><span id="l3.3402" class="difflineminus">-</span>
<a href="#l3.3403"></a><span id="l3.3403" class="difflineplus">+  let mode;</span>
<a href="#l3.3404"></a><span id="l3.3404" class="difflineplus">+  if (Services.io.offline) {</span>
<a href="#l3.3405"></a><span id="l3.3405" class="difflineplus">+    mode = Ci.nsIMsgCompDeliverMode.Later;</span>
<a href="#l3.3406"></a><span id="l3.3406" class="difflineplus">+  } else {</span>
<a href="#l3.3407"></a><span id="l3.3407" class="difflineplus">+    mode = sendInBackground ? Ci.nsIMsgCompDeliverMode.Background : Ci.nsIMsgCompDeliverMode.Now;</span>
<a href="#l3.3408"></a><span id="l3.3408" class="difflineplus">+  }</span>
<a href="#l3.3409"></a><span id="l3.3409" class="difflineplus">+  GenericSendMessage(mode);</span>
<a href="#l3.3410"></a><span id="l3.3410">   ExitFullscreenMode();</span>
<a href="#l3.3411"></a><span id="l3.3411"> }</span>
<a href="#l3.3412"></a><span id="l3.3412"> </span>
<a href="#l3.3413"></a><span id="l3.3413" class="difflineminus">-function SendMessageLater()</span>
<a href="#l3.3414"></a><span id="l3.3414" class="difflineminus">-{</span>
<a href="#l3.3415"></a><span id="l3.3415" class="difflineminus">-  GenericSendMessage(nsIMsgCompDeliverMode.Later);</span>
<a href="#l3.3416"></a><span id="l3.3416" class="difflineplus">+function SendMessageLater() {</span>
<a href="#l3.3417"></a><span id="l3.3417" class="difflineplus">+  GenericSendMessage(Ci.nsIMsgCompDeliverMode.Later);</span>
<a href="#l3.3418"></a><span id="l3.3418">   ExitFullscreenMode();</span>
<a href="#l3.3419"></a><span id="l3.3419"> }</span>
<a href="#l3.3420"></a><span id="l3.3420"> </span>
<a href="#l3.3421"></a><span id="l3.3421" class="difflineminus">-function ExitFullscreenMode()</span>
<a href="#l3.3422"></a><span id="l3.3422" class="difflineminus">-{</span>
<a href="#l3.3423"></a><span id="l3.3423" class="difflineplus">+function ExitFullscreenMode() {</span>
<a href="#l3.3424"></a><span id="l3.3424">   // On OS X we need to deliberately exit full screen mode after sending.</span>
<a href="#l3.3425"></a><span id="l3.3425">   if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l3.3426"></a><span id="l3.3426">     window.fullScreen = false;</span>
<a href="#l3.3427"></a><span id="l3.3427">   }</span>
<a href="#l3.3428"></a><span id="l3.3428"> }</span>
<a href="#l3.3429"></a><span id="l3.3429"> </span>
<a href="#l3.3430"></a><span id="l3.3430" class="difflineminus">-function Save()</span>
<a href="#l3.3431"></a><span id="l3.3431" class="difflineminus">-{</span>
<a href="#l3.3432"></a><span id="l3.3432" class="difflineminus">-  switch (defaultSaveOperation)</span>
<a href="#l3.3433"></a><span id="l3.3433" class="difflineminus">-  {</span>
<a href="#l3.3434"></a><span id="l3.3434" class="difflineminus">-    case &quot;file&quot;     : SaveAsFile(false);      break;</span>
<a href="#l3.3435"></a><span id="l3.3435" class="difflineminus">-    case &quot;template&quot; : SaveAsTemplate(false);  break;</span>
<a href="#l3.3436"></a><span id="l3.3436" class="difflineminus">-    default         : SaveAsDraft(false);     break;</span>
<a href="#l3.3437"></a><span id="l3.3437" class="difflineplus">+function Save() {</span>
<a href="#l3.3438"></a><span id="l3.3438" class="difflineplus">+  switch (defaultSaveOperation) {</span>
<a href="#l3.3439"></a><span id="l3.3439" class="difflineplus">+    case &quot;file&quot;:</span>
<a href="#l3.3440"></a><span id="l3.3440" class="difflineplus">+      SaveAsFile(false);</span>
<a href="#l3.3441"></a><span id="l3.3441" class="difflineplus">+      break;</span>
<a href="#l3.3442"></a><span id="l3.3442" class="difflineplus">+    case &quot;template&quot;:</span>
<a href="#l3.3443"></a><span id="l3.3443" class="difflineplus">+      SaveAsTemplate(false);</span>
<a href="#l3.3444"></a><span id="l3.3444" class="difflineplus">+      break;</span>
<a href="#l3.3445"></a><span id="l3.3445" class="difflineplus">+    default:</span>
<a href="#l3.3446"></a><span id="l3.3446" class="difflineplus">+      SaveAsDraft(false);</span>
<a href="#l3.3447"></a><span id="l3.3447" class="difflineplus">+      break;</span>
<a href="#l3.3448"></a><span id="l3.3448">   }</span>
<a href="#l3.3449"></a><span id="l3.3449"> }</span>
<a href="#l3.3450"></a><span id="l3.3450"> </span>
<a href="#l3.3451"></a><span id="l3.3451" class="difflineminus">-function SaveAsFile(saveAs)</span>
<a href="#l3.3452"></a><span id="l3.3452" class="difflineminus">-{</span>
<a href="#l3.3453"></a><span id="l3.3453" class="difflineplus">+function SaveAsFile(saveAs) {</span>
<a href="#l3.3454"></a><span id="l3.3454">   var subject = GetMsgSubjectElement().value;</span>
<a href="#l3.3455"></a><span id="l3.3455">   GetCurrentEditorElement().contentDocument.title = subject;</span>
<a href="#l3.3456"></a><span id="l3.3456"> </span>
<a href="#l3.3457"></a><span id="l3.3457" class="difflineminus">-  if (gMsgCompose.bodyConvertible() == nsIMsgCompConvertible.Plain)</span>
<a href="#l3.3458"></a><span id="l3.3458" class="difflineplus">+  if (gMsgCompose.bodyConvertible() == Ci.nsIMsgCompConvertible.Plain)</span>
<a href="#l3.3459"></a><span id="l3.3459">     SaveDocument(saveAs, false, &quot;text/plain&quot;);</span>
<a href="#l3.3460"></a><span id="l3.3460">   else</span>
<a href="#l3.3461"></a><span id="l3.3461">     SaveDocument(saveAs, false, &quot;text/html&quot;);</span>
<a href="#l3.3462"></a><span id="l3.3462">   defaultSaveOperation = &quot;file&quot;;</span>
<a href="#l3.3463"></a><span id="l3.3463"> }</span>
<a href="#l3.3464"></a><span id="l3.3464"> </span>
<a href="#l3.3465"></a><span id="l3.3465" class="difflineminus">-function SaveAsDraft()</span>
<a href="#l3.3466"></a><span id="l3.3466" class="difflineminus">-{</span>
<a href="#l3.3467"></a><span id="l3.3467" class="difflineplus">+function SaveAsDraft() {</span>
<a href="#l3.3468"></a><span id="l3.3468">   gAutoSaveKickedIn = false;</span>
<a href="#l3.3469"></a><span id="l3.3469">   gEditingDraft = true;</span>
<a href="#l3.3470"></a><span id="l3.3470"> </span>
<a href="#l3.3471"></a><span id="l3.3471" class="difflineminus">-  GenericSendMessage(nsIMsgCompDeliverMode.SaveAsDraft);</span>
<a href="#l3.3472"></a><span id="l3.3472" class="difflineplus">+  GenericSendMessage(Ci.nsIMsgCompDeliverMode.SaveAsDraft);</span>
<a href="#l3.3473"></a><span id="l3.3473">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l3.3474"></a><span id="l3.3474"> }</span>
<a href="#l3.3475"></a><span id="l3.3475"> </span>
<a href="#l3.3476"></a><span id="l3.3476" class="difflineminus">-function SaveAsTemplate()</span>
<a href="#l3.3477"></a><span id="l3.3477" class="difflineminus">-{</span>
<a href="#l3.3478"></a><span id="l3.3478" class="difflineplus">+function SaveAsTemplate() {</span>
<a href="#l3.3479"></a><span id="l3.3479">   gAutoSaveKickedIn = false;</span>
<a href="#l3.3480"></a><span id="l3.3480">   gEditingDraft = false;</span>
<a href="#l3.3481"></a><span id="l3.3481"> </span>
<a href="#l3.3482"></a><span id="l3.3482">   let savedReferences = null;</span>
<a href="#l3.3483"></a><span id="l3.3483">   if (gMsgCompose &amp;&amp; gMsgCompose.compFields) {</span>
<a href="#l3.3484"></a><span id="l3.3484">     // Clear References header. When we use the template, we don't want that</span>
<a href="#l3.3485"></a><span id="l3.3485">     // header, yet, &quot;edit as new message&quot; maintains it. So we need to clear</span>
<a href="#l3.3486"></a><span id="l3.3486">     // it when saving the template.</span>
<a href="#l3.3487"></a><span id="l3.3487">     // Note: The In-Reply-To header is the last entry in the references header,</span>
<a href="#l3.3488"></a><span id="l3.3488">     // so it will get cleared as well.</span>
<a href="#l3.3489"></a><span id="l3.3489">     savedReferences = gMsgCompose.compFields.references;</span>
<a href="#l3.3490"></a><span id="l3.3490">     gMsgCompose.compFields.references = null;</span>
<a href="#l3.3491"></a><span id="l3.3491">   }</span>
<a href="#l3.3492"></a><span id="l3.3492"> </span>
<a href="#l3.3493"></a><span id="l3.3493" class="difflineminus">-  GenericSendMessage(nsIMsgCompDeliverMode.SaveAsTemplate);</span>
<a href="#l3.3494"></a><span id="l3.3494" class="difflineplus">+  GenericSendMessage(Ci.nsIMsgCompDeliverMode.SaveAsTemplate);</span>
<a href="#l3.3495"></a><span id="l3.3495">   defaultSaveOperation = &quot;template&quot;;</span>
<a href="#l3.3496"></a><span id="l3.3496"> </span>
<a href="#l3.3497"></a><span id="l3.3497">   if (savedReferences)</span>
<a href="#l3.3498"></a><span id="l3.3498">     gMsgCompose.compFields.references = savedReferences;</span>
<a href="#l3.3499"></a><span id="l3.3499"> }</span>
<a href="#l3.3500"></a><span id="l3.3500"> </span>
<a href="#l3.3501"></a><span id="l3.3501"> // Sets the additional FCC, in addition to the default FCC.</span>
<a href="#l3.3502"></a><span id="l3.3502" class="difflineminus">-function MessageFcc(aFolder)</span>
<a href="#l3.3503"></a><span id="l3.3503" class="difflineminus">-{</span>
<a href="#l3.3504"></a><span id="l3.3504" class="difflineplus">+function MessageFcc(aFolder) {</span>
<a href="#l3.3505"></a><span id="l3.3505">   if (!gMsgCompose)</span>
<a href="#l3.3506"></a><span id="l3.3506">     return;</span>
<a href="#l3.3507"></a><span id="l3.3507"> </span>
<a href="#l3.3508"></a><span id="l3.3508">   var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3509"></a><span id="l3.3509">   if (!msgCompFields)</span>
<a href="#l3.3510"></a><span id="l3.3510">     return;</span>
<a href="#l3.3511"></a><span id="l3.3511"> </span>
<a href="#l3.3512"></a><span id="l3.3512">   // Get the uri for the folder to FCC into.</span>
<a href="#l3.3513"></a><span id="l3.3513">   var fccURI = aFolder.URI;</span>
<a href="#l3.3514"></a><span id="l3.3514">   msgCompFields.fcc2 = (msgCompFields.fcc2 == fccURI) ? &quot;nocopy://&quot; : fccURI;</span>
<a href="#l3.3515"></a><span id="l3.3515"> }</span>
<a href="#l3.3516"></a><span id="l3.3516"> </span>
<a href="#l3.3517"></a><span id="l3.3517" class="difflineminus">-function updatePriorityMenu()</span>
<a href="#l3.3518"></a><span id="l3.3518" class="difflineminus">-{</span>
<a href="#l3.3519"></a><span id="l3.3519" class="difflineminus">-  if (gMsgCompose)</span>
<a href="#l3.3520"></a><span id="l3.3520" class="difflineminus">-  {</span>
<a href="#l3.3521"></a><span id="l3.3521" class="difflineplus">+function updatePriorityMenu() {</span>
<a href="#l3.3522"></a><span id="l3.3522" class="difflineplus">+  if (gMsgCompose) {</span>
<a href="#l3.3523"></a><span id="l3.3523">     var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3524"></a><span id="l3.3524" class="difflineminus">-    if (msgCompFields &amp;&amp; msgCompFields.priority)</span>
<a href="#l3.3525"></a><span id="l3.3525" class="difflineminus">-    {</span>
<a href="#l3.3526"></a><span id="l3.3526" class="difflineminus">-      var priorityMenu = document.getElementById('priorityMenu' );</span>
<a href="#l3.3527"></a><span id="l3.3527" class="difflineminus">-      priorityMenu.querySelector('[checked=&quot;true&quot;]').removeAttribute('checked');</span>
<a href="#l3.3528"></a><span id="l3.3528" class="difflineminus">-      priorityMenu.querySelector('[value=&quot;' + msgCompFields.priority + '&quot;]').setAttribute('checked', 'true');</span>
<a href="#l3.3529"></a><span id="l3.3529" class="difflineplus">+    if (msgCompFields &amp;&amp; msgCompFields.priority) {</span>
<a href="#l3.3530"></a><span id="l3.3530" class="difflineplus">+      var priorityMenu = document.getElementById(&quot;priorityMenu&quot;);</span>
<a href="#l3.3531"></a><span id="l3.3531" class="difflineplus">+      priorityMenu.querySelector('[checked=&quot;true&quot;]').removeAttribute(&quot;checked&quot;);</span>
<a href="#l3.3532"></a><span id="l3.3532" class="difflineplus">+      priorityMenu.querySelector('[value=&quot;' + msgCompFields.priority + '&quot;]').setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.3533"></a><span id="l3.3533">     }</span>
<a href="#l3.3534"></a><span id="l3.3534">   }</span>
<a href="#l3.3535"></a><span id="l3.3535"> }</span>
<a href="#l3.3536"></a><span id="l3.3536"> </span>
<a href="#l3.3537"></a><span id="l3.3537" class="difflineminus">-function updatePriorityToolbarButton(newPriorityValue)</span>
<a href="#l3.3538"></a><span id="l3.3538" class="difflineminus">-{</span>
<a href="#l3.3539"></a><span id="l3.3539" class="difflineminus">-  var prioritymenu = document.getElementById('priorityMenu-button');</span>
<a href="#l3.3540"></a><span id="l3.3540" class="difflineplus">+function updatePriorityToolbarButton(newPriorityValue) {</span>
<a href="#l3.3541"></a><span id="l3.3541" class="difflineplus">+  var prioritymenu = document.getElementById(&quot;priorityMenu-button&quot;);</span>
<a href="#l3.3542"></a><span id="l3.3542">   if (prioritymenu)</span>
<a href="#l3.3543"></a><span id="l3.3543">     prioritymenu.value = newPriorityValue;</span>
<a href="#l3.3544"></a><span id="l3.3544"> }</span>
<a href="#l3.3545"></a><span id="l3.3545"> </span>
<a href="#l3.3546"></a><span id="l3.3546" class="difflineminus">-function PriorityMenuSelect(target)</span>
<a href="#l3.3547"></a><span id="l3.3547" class="difflineminus">-{</span>
<a href="#l3.3548"></a><span id="l3.3548" class="difflineminus">-  if (gMsgCompose)</span>
<a href="#l3.3549"></a><span id="l3.3549" class="difflineminus">-  {</span>
<a href="#l3.3550"></a><span id="l3.3550" class="difflineplus">+function PriorityMenuSelect(target) {</span>
<a href="#l3.3551"></a><span id="l3.3551" class="difflineplus">+  if (gMsgCompose) {</span>
<a href="#l3.3552"></a><span id="l3.3552">     var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3553"></a><span id="l3.3553">     if (msgCompFields)</span>
<a href="#l3.3554"></a><span id="l3.3554" class="difflineminus">-      msgCompFields.priority = target.getAttribute('value');</span>
<a href="#l3.3555"></a><span id="l3.3555" class="difflineplus">+      msgCompFields.priority = target.getAttribute(&quot;value&quot;);</span>
<a href="#l3.3556"></a><span id="l3.3556"> </span>
<a href="#l3.3557"></a><span id="l3.3557">     // keep priority toolbar button in synch with possible changes via the menu item</span>
<a href="#l3.3558"></a><span id="l3.3558" class="difflineminus">-    updatePriorityToolbarButton(target.getAttribute('value'));</span>
<a href="#l3.3559"></a><span id="l3.3559" class="difflineplus">+    updatePriorityToolbarButton(target.getAttribute(&quot;value&quot;));</span>
<a href="#l3.3560"></a><span id="l3.3560">   }</span>
<a href="#l3.3561"></a><span id="l3.3561"> }</span>
<a href="#l3.3562"></a><span id="l3.3562"> </span>
<a href="#l3.3563"></a><span id="l3.3563"> /**</span>
<a href="#l3.3564"></a><span id="l3.3564">  * Shows HTML formatting menus/toolbars if they are useful for the selected</span>
<a href="#l3.3565"></a><span id="l3.3565">  * message delivery format. E.g. they are not needed for plain text format.</span>
<a href="#l3.3566"></a><span id="l3.3566">  *</span>
<a href="#l3.3567"></a><span id="l3.3567">  * @param aDeliveryFormat  The chosen output format from the nsIMsgCompSendFormat enum.</span>
<a href="#l3.3568"></a><span id="l3.3568">  */</span>
<a href="#l3.3569"></a><span id="l3.3569" class="difflineminus">-function SetCompositionAsPerDeliveryFormat(aDeliveryFormat)</span>
<a href="#l3.3570"></a><span id="l3.3570" class="difflineminus">-{</span>
<a href="#l3.3571"></a><span id="l3.3571" class="difflineplus">+function SetCompositionAsPerDeliveryFormat(aDeliveryFormat) {</span>
<a href="#l3.3572"></a><span id="l3.3572">   let format_toolbar = document.getElementById(&quot;FormatToolbar&quot;);</span>
<a href="#l3.3573"></a><span id="l3.3573">   let format_menu = document.getElementById(&quot;formatMenu&quot;);</span>
<a href="#l3.3574"></a><span id="l3.3574">   let insert_menu = document.getElementById(&quot;insertMenu&quot;);</span>
<a href="#l3.3575"></a><span id="l3.3575">   let view_menuitem = document.getElementById(&quot;menu_showFormatToolbar&quot;);</span>
<a href="#l3.3576"></a><span id="l3.3576"> </span>
<a href="#l3.3577"></a><span id="l3.3577">   let hideMenus = !gMsgCompose.composeHTML;</span>
<a href="#l3.3578"></a><span id="l3.3578">   format_menu.hidden = hideMenus;</span>
<a href="#l3.3579"></a><span id="l3.3579">   insert_menu.hidden = hideMenus;</span>
<a href="#l3.3580"></a><span id="l3.3580">   view_menuitem.hidden = hideMenus;</span>
<a href="#l3.3581"></a><span id="l3.3581">   // Hide the HTML toolbar for a plain text composition</span>
<a href="#l3.3582"></a><span id="l3.3582">   // or the user manually hid the toolbar on the view menu.</span>
<a href="#l3.3583"></a><span id="l3.3583">   format_toolbar.hidden = hideMenus ||</span>
<a href="#l3.3584"></a><span id="l3.3584">     (view_menuitem.getAttribute(&quot;checked&quot;) == &quot;false&quot;);</span>
<a href="#l3.3585"></a><span id="l3.3585"> }</span>
<a href="#l3.3586"></a><span id="l3.3586"> </span>
<a href="#l3.3587"></a><span id="l3.3587" class="difflineminus">-function SelectDeliveryFormatMenuOption(aDeliveryFormat)</span>
<a href="#l3.3588"></a><span id="l3.3588" class="difflineminus">-{</span>
<a href="#l3.3589"></a><span id="l3.3589" class="difflineplus">+function SelectDeliveryFormatMenuOption(aDeliveryFormat) {</span>
<a href="#l3.3590"></a><span id="l3.3590">   let deliveryFormat;</span>
<a href="#l3.3591"></a><span id="l3.3591"> </span>
<a href="#l3.3592"></a><span id="l3.3592" class="difflineminus">-  switch(aDeliveryFormat) {</span>
<a href="#l3.3593"></a><span id="l3.3593" class="difflineminus">-    case nsIMsgCompSendFormat.PlainText:</span>
<a href="#l3.3594"></a><span id="l3.3594" class="difflineplus">+  switch (aDeliveryFormat) {</span>
<a href="#l3.3595"></a><span id="l3.3595" class="difflineplus">+    case Ci.nsIMsgCompSendFormat.PlainText:</span>
<a href="#l3.3596"></a><span id="l3.3596">       deliveryFormat = &quot;format_plain&quot;;</span>
<a href="#l3.3597"></a><span id="l3.3597">       break;</span>
<a href="#l3.3598"></a><span id="l3.3598" class="difflineminus">-    case nsIMsgCompSendFormat.HTML:</span>
<a href="#l3.3599"></a><span id="l3.3599" class="difflineplus">+    case Ci.nsIMsgCompSendFormat.HTML:</span>
<a href="#l3.3600"></a><span id="l3.3600">       deliveryFormat = &quot;format_html&quot;;</span>
<a href="#l3.3601"></a><span id="l3.3601">       break;</span>
<a href="#l3.3602"></a><span id="l3.3602" class="difflineminus">-    case nsIMsgCompSendFormat.Both:</span>
<a href="#l3.3603"></a><span id="l3.3603" class="difflineplus">+    case Ci.nsIMsgCompSendFormat.Both:</span>
<a href="#l3.3604"></a><span id="l3.3604">       deliveryFormat = &quot;format_both&quot;;</span>
<a href="#l3.3605"></a><span id="l3.3605">       break;</span>
<a href="#l3.3606"></a><span id="l3.3606" class="difflineminus">-    case nsIMsgCompSendFormat.AskUser:</span>
<a href="#l3.3607"></a><span id="l3.3607" class="difflineplus">+    case Ci.nsIMsgCompSendFormat.AskUser:</span>
<a href="#l3.3608"></a><span id="l3.3608">     default:</span>
<a href="#l3.3609"></a><span id="l3.3609">       deliveryFormat = &quot;format_auto&quot;;</span>
<a href="#l3.3610"></a><span id="l3.3610">   }</span>
<a href="#l3.3611"></a><span id="l3.3611"> </span>
<a href="#l3.3612"></a><span id="l3.3612">   document.getElementById(deliveryFormat).setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.3613"></a><span id="l3.3613"> }</span>
<a href="#l3.3614"></a><span id="l3.3614"> </span>
<a href="#l3.3615"></a><span id="l3.3615" class="difflineminus">-function OutputFormatMenuSelect(target)</span>
<a href="#l3.3616"></a><span id="l3.3616" class="difflineminus">-{</span>
<a href="#l3.3617"></a><span id="l3.3617" class="difflineplus">+function OutputFormatMenuSelect(target) {</span>
<a href="#l3.3618"></a><span id="l3.3618">   let currentSendFormat = gSendFormat;</span>
<a href="#l3.3619"></a><span id="l3.3619"> </span>
<a href="#l3.3620"></a><span id="l3.3620">   if (gMsgCompose) {</span>
<a href="#l3.3621"></a><span id="l3.3621">     let msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3622"></a><span id="l3.3622">     if (msgCompFields) {</span>
<a href="#l3.3623"></a><span id="l3.3623">       switch (target.getAttribute(&quot;id&quot;)) {</span>
<a href="#l3.3624"></a><span id="l3.3624">         case &quot;format_plain&quot;:</span>
<a href="#l3.3625"></a><span id="l3.3625" class="difflineminus">-          gSendFormat = nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.3626"></a><span id="l3.3626" class="difflineplus">+          gSendFormat = Ci.nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.3627"></a><span id="l3.3627">           break;</span>
<a href="#l3.3628"></a><span id="l3.3628">         case &quot;format_html&quot;:</span>
<a href="#l3.3629"></a><span id="l3.3629" class="difflineminus">-          gSendFormat = nsIMsgCompSendFormat.HTML;</span>
<a href="#l3.3630"></a><span id="l3.3630" class="difflineplus">+          gSendFormat = Ci.nsIMsgCompSendFormat.HTML;</span>
<a href="#l3.3631"></a><span id="l3.3631">           break;</span>
<a href="#l3.3632"></a><span id="l3.3632">         case &quot;format_both&quot;:</span>
<a href="#l3.3633"></a><span id="l3.3633" class="difflineminus">-          gSendFormat = nsIMsgCompSendFormat.Both;</span>
<a href="#l3.3634"></a><span id="l3.3634" class="difflineplus">+          gSendFormat = Ci.nsIMsgCompSendFormat.Both;</span>
<a href="#l3.3635"></a><span id="l3.3635">           break;</span>
<a href="#l3.3636"></a><span id="l3.3636">         case &quot;format_auto&quot;:</span>
<a href="#l3.3637"></a><span id="l3.3637">         default:</span>
<a href="#l3.3638"></a><span id="l3.3638" class="difflineminus">-          gSendFormat = nsIMsgCompSendFormat.AskUser;</span>
<a href="#l3.3639"></a><span id="l3.3639" class="difflineplus">+          gSendFormat = Ci.nsIMsgCompSendFormat.AskUser;</span>
<a href="#l3.3640"></a><span id="l3.3640">       }</span>
<a href="#l3.3641"></a><span id="l3.3641">     }</span>
<a href="#l3.3642"></a><span id="l3.3642"> </span>
<a href="#l3.3643"></a><span id="l3.3643">     SetCompositionAsPerDeliveryFormat(gSendFormat);</span>
<a href="#l3.3644"></a><span id="l3.3644">     gMsgCompose.compFields.deliveryFormat = gSendFormat;</span>
<a href="#l3.3645"></a><span id="l3.3645">     gContentChanged = currentSendFormat != gSendFormat;</span>
<a href="#l3.3646"></a><span id="l3.3646">   }</span>
<a href="#l3.3647"></a><span id="l3.3647"> }</span>
<a href="#l3.3648"></a><span id="l3.3648"> </span>
<a href="#l3.3649"></a><span id="l3.3649"> // walk through the recipients list and add them to the inline spell checker ignore list</span>
<a href="#l3.3650"></a><span id="l3.3650" class="difflineminus">-function addRecipientsToIgnoreList(aAddressesToAdd)</span>
<a href="#l3.3651"></a><span id="l3.3651" class="difflineminus">-{</span>
<a href="#l3.3652"></a><span id="l3.3652" class="difflineminus">-  if (gSpellChecker.enabled)</span>
<a href="#l3.3653"></a><span id="l3.3653" class="difflineminus">-  {</span>
<a href="#l3.3654"></a><span id="l3.3654" class="difflineplus">+function addRecipientsToIgnoreList(aAddressesToAdd) {</span>
<a href="#l3.3655"></a><span id="l3.3655" class="difflineplus">+  if (gSpellChecker.enabled) {</span>
<a href="#l3.3656"></a><span id="l3.3656">     // break the list of potentially many recipients back into individual names</span>
<a href="#l3.3657"></a><span id="l3.3657">     var emailAddresses = {};</span>
<a href="#l3.3658"></a><span id="l3.3658">     var names = {};</span>
<a href="#l3.3659"></a><span id="l3.3659">     var fullNames = {};</span>
<a href="#l3.3660"></a><span id="l3.3660" class="difflineminus">-    let numAddresses = MailServices.headerParser.parseHeadersWithArray(aAddressesToAdd, emailAddresses, names, fullNames);</span>
<a href="#l3.3661"></a><span id="l3.3661" class="difflineplus">+    MailServices.headerParser.parseHeadersWithArray(aAddressesToAdd, emailAddresses, names, fullNames);</span>
<a href="#l3.3662"></a><span id="l3.3662">     if (!names)</span>
<a href="#l3.3663"></a><span id="l3.3663">       return;</span>
<a href="#l3.3664"></a><span id="l3.3664">     let tokenizedNames = [];</span>
<a href="#l3.3665"></a><span id="l3.3665"> </span>
<a href="#l3.3666"></a><span id="l3.3666">     // Each name could consist of multiple word delimited by either commas or spaces, i.e. Green Lantern</span>
<a href="#l3.3667"></a><span id="l3.3667">     // or Lantern,Green. Tokenize on comma first, then tokenize again on spaces.</span>
<a href="#l3.3668"></a><span id="l3.3668" class="difflineminus">-    for (let name in names.value)</span>
<a href="#l3.3669"></a><span id="l3.3669" class="difflineminus">-    {</span>
<a href="#l3.3670"></a><span id="l3.3670" class="difflineplus">+    for (let name in names.value) {</span>
<a href="#l3.3671"></a><span id="l3.3671">       if (!names.value[name])</span>
<a href="#l3.3672"></a><span id="l3.3672">         continue;</span>
<a href="#l3.3673"></a><span id="l3.3673" class="difflineminus">-      let splitNames = names.value[name].split(',');</span>
<a href="#l3.3674"></a><span id="l3.3674" class="difflineminus">-      for (let i = 0; i &lt; splitNames.length; i++)</span>
<a href="#l3.3675"></a><span id="l3.3675" class="difflineminus">-      {</span>
<a href="#l3.3676"></a><span id="l3.3676" class="difflineplus">+      let splitNames = names.value[name].split(&quot;,&quot;);</span>
<a href="#l3.3677"></a><span id="l3.3677" class="difflineplus">+      for (let i = 0; i &lt; splitNames.length; i++) {</span>
<a href="#l3.3678"></a><span id="l3.3678">         // now tokenize off of white space</span>
<a href="#l3.3679"></a><span id="l3.3679" class="difflineminus">-        let splitNamesFromWhiteSpaceArray = splitNames[i].split(' ');</span>
<a href="#l3.3680"></a><span id="l3.3680" class="difflineplus">+        let splitNamesFromWhiteSpaceArray = splitNames[i].split(&quot; &quot;);</span>
<a href="#l3.3681"></a><span id="l3.3681">         for (let whiteSpaceIndex = 0; whiteSpaceIndex &lt; splitNamesFromWhiteSpaceArray.length; whiteSpaceIndex++)</span>
<a href="#l3.3682"></a><span id="l3.3682">           if (splitNamesFromWhiteSpaceArray[whiteSpaceIndex])</span>
<a href="#l3.3683"></a><span id="l3.3683">             tokenizedNames.push(splitNamesFromWhiteSpaceArray[whiteSpaceIndex]);</span>
<a href="#l3.3684"></a><span id="l3.3684">       }</span>
<a href="#l3.3685"></a><span id="l3.3685">     }</span>
<a href="#l3.3686"></a><span id="l3.3686">     spellCheckReadyObserver.addWordsToIgnore(tokenizedNames);</span>
<a href="#l3.3687"></a><span id="l3.3687">   }</span>
<a href="#l3.3688"></a><span id="l3.3688"> }</span>
<a href="#l3.3689"></a><span id="l3.3689"> </span>
<a href="#l3.3690"></a><span id="l3.3690"> /**</span>
<a href="#l3.3691"></a><span id="l3.3691">  * Observer waiting for spell checker to become initialized or to complete</span>
<a href="#l3.3692"></a><span id="l3.3692">  * checking. When it fires, it pushes new words to be ignored to the speller.</span>
<a href="#l3.3693"></a><span id="l3.3693">  */</span>
<a href="#l3.3694"></a><span id="l3.3694" class="difflineminus">-var spellCheckReadyObserver =</span>
<a href="#l3.3695"></a><span id="l3.3695" class="difflineminus">-{</span>
<a href="#l3.3696"></a><span id="l3.3696" class="difflineplus">+var spellCheckReadyObserver = {</span>
<a href="#l3.3697"></a><span id="l3.3697">   _topic: &quot;inlineSpellChecker-spellCheck-ended&quot;,</span>
<a href="#l3.3698"></a><span id="l3.3698"> </span>
<a href="#l3.3699"></a><span id="l3.3699">   _ignoreWords: [],</span>
<a href="#l3.3700"></a><span id="l3.3700"> </span>
<a href="#l3.3701"></a><span id="l3.3701" class="difflineminus">-  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l3.3702"></a><span id="l3.3702" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l3.3703"></a><span id="l3.3703">     if (aTopic != this._topic) {</span>
<a href="#l3.3704"></a><span id="l3.3704">       return;</span>
<a href="#l3.3705"></a><span id="l3.3705">     }</span>
<a href="#l3.3706"></a><span id="l3.3706"> </span>
<a href="#l3.3707"></a><span id="l3.3707">     this.removeObserver();</span>
<a href="#l3.3708"></a><span id="l3.3708">     this._addWords();</span>
<a href="#l3.3709"></a><span id="l3.3709">   },</span>
<a href="#l3.3710"></a><span id="l3.3710"> </span>
<a href="#l3.3711"></a><span id="l3.3711">   _isAdded: false,</span>
<a href="#l3.3712"></a><span id="l3.3712"> </span>
<a href="#l3.3713"></a><span id="l3.3713" class="difflineminus">-  addObserver: function() {</span>
<a href="#l3.3714"></a><span id="l3.3714" class="difflineplus">+  addObserver() {</span>
<a href="#l3.3715"></a><span id="l3.3715">     if (this._isAdded)</span>
<a href="#l3.3716"></a><span id="l3.3716">       return;</span>
<a href="#l3.3717"></a><span id="l3.3717"> </span>
<a href="#l3.3718"></a><span id="l3.3718">     Services.obs.addObserver(this, this._topic);</span>
<a href="#l3.3719"></a><span id="l3.3719">     this._isAdded = true;</span>
<a href="#l3.3720"></a><span id="l3.3720">   },</span>
<a href="#l3.3721"></a><span id="l3.3721"> </span>
<a href="#l3.3722"></a><span id="l3.3722" class="difflineminus">-  removeObserver: function() {</span>
<a href="#l3.3723"></a><span id="l3.3723" class="difflineplus">+  removeObserver() {</span>
<a href="#l3.3724"></a><span id="l3.3724">     if (!this._isAdded)</span>
<a href="#l3.3725"></a><span id="l3.3725">       return;</span>
<a href="#l3.3726"></a><span id="l3.3726"> </span>
<a href="#l3.3727"></a><span id="l3.3727">     Services.obs.removeObserver(this, this._topic);</span>
<a href="#l3.3728"></a><span id="l3.3728">     this._clearPendingWords();</span>
<a href="#l3.3729"></a><span id="l3.3729">     this._isAdded = false;</span>
<a href="#l3.3730"></a><span id="l3.3730">   },</span>
<a href="#l3.3731"></a><span id="l3.3731"> </span>
<a href="#l3.3732"></a><span id="l3.3732" class="difflineminus">-  addWordsToIgnore: function (aIgnoreWords) {</span>
<a href="#l3.3733"></a><span id="l3.3733" class="difflineplus">+  addWordsToIgnore(aIgnoreWords) {</span>
<a href="#l3.3734"></a><span id="l3.3734">     this._ignoreWords.push(...aIgnoreWords);</span>
<a href="#l3.3735"></a><span id="l3.3735">     if (gSpellChecker.mInlineSpellChecker.spellCheckPending) {</span>
<a href="#l3.3736"></a><span id="l3.3736">       // spellchecker is enabled, but we must wait for its init to complete</span>
<a href="#l3.3737"></a><span id="l3.3737">       this.addObserver();</span>
<a href="#l3.3738"></a><span id="l3.3738">     } else {</span>
<a href="#l3.3739"></a><span id="l3.3739">       this._addWords();</span>
<a href="#l3.3740"></a><span id="l3.3740">     }</span>
<a href="#l3.3741"></a><span id="l3.3741">   },</span>
<a href="#l3.3742"></a><span id="l3.3742"> </span>
<a href="#l3.3743"></a><span id="l3.3743" class="difflineminus">-  _addWords: function() {</span>
<a href="#l3.3744"></a><span id="l3.3744" class="difflineplus">+  _addWords() {</span>
<a href="#l3.3745"></a><span id="l3.3745">     // At the time the speller finally got initialized, we may already be closing</span>
<a href="#l3.3746"></a><span id="l3.3746">     // the compose together with the speller, so we need to check if they</span>
<a href="#l3.3747"></a><span id="l3.3747">     // are still valid.</span>
<a href="#l3.3748"></a><span id="l3.3748">     if (gMsgCompose &amp;&amp; gSpellChecker.enabled) {</span>
<a href="#l3.3749"></a><span id="l3.3749">       gSpellChecker.mInlineSpellChecker.ignoreWords(this._ignoreWords, this._ignoreWords.length);</span>
<a href="#l3.3750"></a><span id="l3.3750">     }</span>
<a href="#l3.3751"></a><span id="l3.3751">     this._clearPendingWords();</span>
<a href="#l3.3752"></a><span id="l3.3752">   },</span>
<a href="#l3.3753"></a><span id="l3.3753"> </span>
<a href="#l3.3754"></a><span id="l3.3754">   _clearPendingWords() {</span>
<a href="#l3.3755"></a><span id="l3.3755">     this._ignoreWords.length = 0;</span>
<a href="#l3.3756"></a><span id="l3.3756" class="difflineminus">-  }</span>
<a href="#l3.3757"></a><span id="l3.3757" class="difflineminus">-}</span>
<a href="#l3.3758"></a><span id="l3.3758" class="difflineminus">-</span>
<a href="#l3.3759"></a><span id="l3.3759" class="difflineminus">-function onAddressColCommand(aAddressWidgetId)</span>
<a href="#l3.3760"></a><span id="l3.3760" class="difflineminus">-{</span>
<a href="#l3.3761"></a><span id="l3.3761" class="difflineplus">+  },</span>
<a href="#l3.3762"></a><span id="l3.3762" class="difflineplus">+};</span>
<a href="#l3.3763"></a><span id="l3.3763" class="difflineplus">+</span>
<a href="#l3.3764"></a><span id="l3.3764" class="difflineplus">+function onAddressColCommand(aAddressWidgetId) {</span>
<a href="#l3.3765"></a><span id="l3.3765">   gContentChanged = true;</span>
<a href="#l3.3766"></a><span id="l3.3766" class="difflineminus">-  awSetAutoComplete(aAddressWidgetId.slice(aAddressWidgetId.lastIndexOf('#') + 1));</span>
<a href="#l3.3767"></a><span id="l3.3767" class="difflineplus">+  awSetAutoComplete(aAddressWidgetId.slice(aAddressWidgetId.lastIndexOf(&quot;#&quot;) + 1));</span>
<a href="#l3.3768"></a><span id="l3.3768">   updateSendCommands(true);</span>
<a href="#l3.3769"></a><span id="l3.3769"> }</span>
<a href="#l3.3770"></a><span id="l3.3770"> </span>
<a href="#l3.3771"></a><span id="l3.3771"> /**</span>
<a href="#l3.3772"></a><span id="l3.3772">  * Called if the list of recipients changed in any way.</span>
<a href="#l3.3773"></a><span id="l3.3773">  *</span>
<a href="#l3.3774"></a><span id="l3.3774">  * @param aAutomatic  Set to true if the change of recipients was invoked</span>
<a href="#l3.3775"></a><span id="l3.3775">  *                    programmatically and should not be considered a change</span>
<a href="#l3.3776"></a><span id="l3.3776">  *                    of message content.</span>
<a href="#l3.3777"></a><span id="l3.3777">  */</span>
<a href="#l3.3778"></a><span id="l3.3778" class="difflineminus">-function onRecipientsChanged(aAutomatic)</span>
<a href="#l3.3779"></a><span id="l3.3779" class="difflineminus">-{</span>
<a href="#l3.3780"></a><span id="l3.3780" class="difflineplus">+function onRecipientsChanged(aAutomatic) {</span>
<a href="#l3.3781"></a><span id="l3.3781">   if (!aAutomatic) {</span>
<a href="#l3.3782"></a><span id="l3.3782">     gContentChanged = true;</span>
<a href="#l3.3783"></a><span id="l3.3783">   }</span>
<a href="#l3.3784"></a><span id="l3.3784">   updateSendCommands(true);</span>
<a href="#l3.3785"></a><span id="l3.3785"> }</span>
<a href="#l3.3786"></a><span id="l3.3786"> </span>
<a href="#l3.3787"></a><span id="l3.3787"> /**</span>
<a href="#l3.3788"></a><span id="l3.3788">  * Show the popup identified by aPopupID</span>
<a href="#l3.3789"></a><span id="l3.3789" class="difflineat">@@ -3942,24 +3776,23 @@ function onRecipientsChanged(aAutomatic)</span>
<a href="#l3.3790"></a><span id="l3.3790"> function showPopupById(aPopupID, aAnchorID, aPosition = &quot;after_start&quot;,</span>
<a href="#l3.3791"></a><span id="l3.3791">                        x, y, isContextMenu, attributesOverride, triggerEvent) {</span>
<a href="#l3.3792"></a><span id="l3.3792">   let popup = document.getElementById(aPopupID);</span>
<a href="#l3.3793"></a><span id="l3.3793">   let anchor = document.getElementById(aAnchorID);</span>
<a href="#l3.3794"></a><span id="l3.3794">   popup.openPopup(anchor, aPosition, x, y,</span>
<a href="#l3.3795"></a><span id="l3.3795">                   isContextMenu, attributesOverride, triggerEvent);</span>
<a href="#l3.3796"></a><span id="l3.3796"> }</span>
<a href="#l3.3797"></a><span id="l3.3797"> </span>
<a href="#l3.3798"></a><span id="l3.3798" class="difflineminus">-function InitLanguageMenu()</span>
<a href="#l3.3799"></a><span id="l3.3799" class="difflineminus">-{</span>
<a href="#l3.3800"></a><span id="l3.3800" class="difflineminus">-  var languageMenuList = document.getElementById('languageMenuList');</span>
<a href="#l3.3801"></a><span id="l3.3801" class="difflineplus">+function InitLanguageMenu() {</span>
<a href="#l3.3802"></a><span id="l3.3802" class="difflineplus">+  var languageMenuList = document.getElementById(&quot;languageMenuList&quot;);</span>
<a href="#l3.3803"></a><span id="l3.3803">   if (!languageMenuList)</span>
<a href="#l3.3804"></a><span id="l3.3804">     return;</span>
<a href="#l3.3805"></a><span id="l3.3805"> </span>
<a href="#l3.3806"></a><span id="l3.3806" class="difflineminus">-  var spellChecker = Cc['@mozilla.org/spellchecker/engine;1']</span>
<a href="#l3.3807"></a><span id="l3.3807" class="difflineminus">-                       .getService(mozISpellCheckingEngine);</span>
<a href="#l3.3808"></a><span id="l3.3808" class="difflineplus">+  var spellChecker = Cc[&quot;@mozilla.org/spellchecker/engine;1&quot;]</span>
<a href="#l3.3809"></a><span id="l3.3809" class="difflineplus">+                       .getService(Ci.mozISpellCheckingEngine);</span>
<a href="#l3.3810"></a><span id="l3.3810">   var o1 = {};</span>
<a href="#l3.3811"></a><span id="l3.3811">   var o2 = {};</span>
<a href="#l3.3812"></a><span id="l3.3812"> </span>
<a href="#l3.3813"></a><span id="l3.3813">   // Get the list of dictionaries from</span>
<a href="#l3.3814"></a><span id="l3.3814">   // the spellchecker.</span>
<a href="#l3.3815"></a><span id="l3.3815"> </span>
<a href="#l3.3816"></a><span id="l3.3816">   spellChecker.getDictionaryList(o1, o2);</span>
<a href="#l3.3817"></a><span id="l3.3817"> </span>
<a href="#l3.3818"></a><span id="l3.3818" class="difflineat">@@ -3974,28 +3807,26 @@ function InitLanguageMenu()</span>
<a href="#l3.3819"></a><span id="l3.3819">   sDictCount = count;</span>
<a href="#l3.3820"></a><span id="l3.3820"> </span>
<a href="#l3.3821"></a><span id="l3.3821">   var sortedList = gSpellChecker.sortDictionaryList(dictList);</span>
<a href="#l3.3822"></a><span id="l3.3822"> </span>
<a href="#l3.3823"></a><span id="l3.3823">   // Remove any languages from the list.</span>
<a href="#l3.3824"></a><span id="l3.3824">   while (languageMenuList.hasChildNodes())</span>
<a href="#l3.3825"></a><span id="l3.3825">     languageMenuList.lastChild.remove();</span>
<a href="#l3.3826"></a><span id="l3.3826"> </span>
<a href="#l3.3827"></a><span id="l3.3827" class="difflineminus">-  for (let i = 0; i &lt; count; i++)</span>
<a href="#l3.3828"></a><span id="l3.3828" class="difflineminus">-  {</span>
<a href="#l3.3829"></a><span id="l3.3829" class="difflineplus">+  for (let i = 0; i &lt; count; i++) {</span>
<a href="#l3.3830"></a><span id="l3.3830">     var item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l3.3831"></a><span id="l3.3831">     item.setAttribute(&quot;label&quot;, sortedList[i].label);</span>
<a href="#l3.3832"></a><span id="l3.3832">     item.setAttribute(&quot;value&quot;, sortedList[i].id);</span>
<a href="#l3.3833"></a><span id="l3.3833" class="difflineminus">-    item.setAttribute('type', 'radio');</span>
<a href="#l3.3834"></a><span id="l3.3834" class="difflineplus">+    item.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l3.3835"></a><span id="l3.3835">     languageMenuList.appendChild(item);</span>
<a href="#l3.3836"></a><span id="l3.3836">   }</span>
<a href="#l3.3837"></a><span id="l3.3837"> }</span>
<a href="#l3.3838"></a><span id="l3.3838"> </span>
<a href="#l3.3839"></a><span id="l3.3839" class="difflineminus">-function OnShowDictionaryMenu(aTarget)</span>
<a href="#l3.3840"></a><span id="l3.3840" class="difflineminus">-{</span>
<a href="#l3.3841"></a><span id="l3.3841" class="difflineplus">+function OnShowDictionaryMenu(aTarget) {</span>
<a href="#l3.3842"></a><span id="l3.3842">   InitLanguageMenu();</span>
<a href="#l3.3843"></a><span id="l3.3843">   let curLang = document.documentElement.getAttribute(&quot;lang&quot;);</span>
<a href="#l3.3844"></a><span id="l3.3844">   if (!curLang)</span>
<a href="#l3.3845"></a><span id="l3.3845">     return;</span>
<a href="#l3.3846"></a><span id="l3.3846"> </span>
<a href="#l3.3847"></a><span id="l3.3847">   let language = aTarget.querySelector('[value=&quot;' + curLang + '&quot;]');</span>
<a href="#l3.3848"></a><span id="l3.3848">   if (language)</span>
<a href="#l3.3849"></a><span id="l3.3849">     language.setAttribute(&quot;checked&quot;, true);</span>
<a href="#l3.3850"></a><span id="l3.3850" class="difflineat">@@ -4003,18 +3834,17 @@ function OnShowDictionaryMenu(aTarget)</span>
<a href="#l3.3851"></a><span id="l3.3851"> </span>
<a href="#l3.3852"></a><span id="l3.3852"> /**</span>
<a href="#l3.3853"></a><span id="l3.3853">  * Change the language of the composition and if we are using inline</span>
<a href="#l3.3854"></a><span id="l3.3854">  * spell check, recheck the message with the new dictionary.</span>
<a href="#l3.3855"></a><span id="l3.3855">  *</span>
<a href="#l3.3856"></a><span id="l3.3856">  * Note: called from the &quot;Check Spelling&quot; panel in SelectLanguage().</span>
<a href="#l3.3857"></a><span id="l3.3857">  * @param aLang  New language to set.</span>
<a href="#l3.3858"></a><span id="l3.3858">  */</span>
<a href="#l3.3859"></a><span id="l3.3859" class="difflineminus">-function ComposeChangeLanguage(aLang)</span>
<a href="#l3.3860"></a><span id="l3.3860" class="difflineminus">-{</span>
<a href="#l3.3861"></a><span id="l3.3861" class="difflineplus">+function ComposeChangeLanguage(aLang) {</span>
<a href="#l3.3862"></a><span id="l3.3862">   if (document.documentElement.getAttribute(&quot;lang&quot;) != aLang) {</span>
<a href="#l3.3863"></a><span id="l3.3863">     // Update the document language as well (needed to synchronise</span>
<a href="#l3.3864"></a><span id="l3.3864">     // the subject).</span>
<a href="#l3.3865"></a><span id="l3.3865">     document.documentElement.setAttribute(&quot;lang&quot;, aLang);</span>
<a href="#l3.3866"></a><span id="l3.3866"> </span>
<a href="#l3.3867"></a><span id="l3.3867">     let spellChecker = gSpellChecker.mInlineSpellChecker.spellChecker;</span>
<a href="#l3.3868"></a><span id="l3.3868">     if (spellChecker) {</span>
<a href="#l3.3869"></a><span id="l3.3869">       spellChecker.SetCurrentDictionary(aLang);</span>
<a href="#l3.3870"></a><span id="l3.3870" class="difflineat">@@ -4036,24 +3866,22 @@ function ComposeChangeLanguage(aLang)</span>
<a href="#l3.3871"></a><span id="l3.3871"> }</span>
<a href="#l3.3872"></a><span id="l3.3872"> </span>
<a href="#l3.3873"></a><span id="l3.3873"> /**</span>
<a href="#l3.3874"></a><span id="l3.3874">  * Change the language of the composition and if we are using inline</span>
<a href="#l3.3875"></a><span id="l3.3875">  * spell check, recheck the message with the new dictionary.</span>
<a href="#l3.3876"></a><span id="l3.3876">  *</span>
<a href="#l3.3877"></a><span id="l3.3877">  * @param event  Event of selecting an item in the spelling button menulist popup.</span>
<a href="#l3.3878"></a><span id="l3.3878">  */</span>
<a href="#l3.3879"></a><span id="l3.3879" class="difflineminus">-function ChangeLanguage(event)</span>
<a href="#l3.3880"></a><span id="l3.3880" class="difflineminus">-{</span>
<a href="#l3.3881"></a><span id="l3.3881" class="difflineplus">+function ChangeLanguage(event) {</span>
<a href="#l3.3882"></a><span id="l3.3882">   ComposeChangeLanguage(event.target.value);</span>
<a href="#l3.3883"></a><span id="l3.3883">   event.stopPropagation();</span>
<a href="#l3.3884"></a><span id="l3.3884"> }</span>
<a href="#l3.3885"></a><span id="l3.3885"> </span>
<a href="#l3.3886"></a><span id="l3.3886" class="difflineminus">-function updateLanguageInStatusBar()</span>
<a href="#l3.3887"></a><span id="l3.3887" class="difflineminus">-{</span>
<a href="#l3.3888"></a><span id="l3.3888" class="difflineplus">+function updateLanguageInStatusBar() {</span>
<a href="#l3.3889"></a><span id="l3.3889">   InitLanguageMenu();</span>
<a href="#l3.3890"></a><span id="l3.3890">   let languageMenuList = document.getElementById(&quot;languageMenuList&quot;);</span>
<a href="#l3.3891"></a><span id="l3.3891">   let spellCheckStatusPanel = document.getElementById(&quot;spellCheckStatusPanel&quot;);</span>
<a href="#l3.3892"></a><span id="l3.3892">   let languageStatusButton = document.getElementById(&quot;languageStatusButton&quot;);</span>
<a href="#l3.3893"></a><span id="l3.3893">   if (!languageMenuList || !spellCheckStatusPanel || !languageStatusButton) {</span>
<a href="#l3.3894"></a><span id="l3.3894">     return;</span>
<a href="#l3.3895"></a><span id="l3.3895">   }</span>
<a href="#l3.3896"></a><span id="l3.3896"> </span>
<a href="#l3.3897"></a><span id="l3.3897" class="difflineat">@@ -4072,87 +3900,78 @@ function updateLanguageInStatusBar()</span>
<a href="#l3.3898"></a><span id="l3.3898">     if (item.getAttribute(&quot;value&quot;) == language) {</span>
<a href="#l3.3899"></a><span id="l3.3899">       languageStatusButton.label = item.getAttribute(&quot;label&quot;);</span>
<a href="#l3.3900"></a><span id="l3.3900">       break;</span>
<a href="#l3.3901"></a><span id="l3.3901">     }</span>
<a href="#l3.3902"></a><span id="l3.3902">     item = item.nextSibling;</span>
<a href="#l3.3903"></a><span id="l3.3903">   }</span>
<a href="#l3.3904"></a><span id="l3.3904"> }</span>
<a href="#l3.3905"></a><span id="l3.3905"> </span>
<a href="#l3.3906"></a><span id="l3.3906" class="difflineminus">-function updateEncodingInStatusBar()</span>
<a href="#l3.3907"></a><span id="l3.3907" class="difflineminus">-{</span>
<a href="#l3.3908"></a><span id="l3.3908" class="difflineplus">+function updateEncodingInStatusBar() {</span>
<a href="#l3.3909"></a><span id="l3.3909">   let encodingUIString = GetCharsetUIString();</span>
<a href="#l3.3910"></a><span id="l3.3910">   let encodingStatusPanel = document.getElementById(&quot;encodingStatusPanel&quot;);</span>
<a href="#l3.3911"></a><span id="l3.3911">   if (!encodingStatusPanel) {</span>
<a href="#l3.3912"></a><span id="l3.3912">     return;</span>
<a href="#l3.3913"></a><span id="l3.3913">   }</span>
<a href="#l3.3914"></a><span id="l3.3914"> </span>
<a href="#l3.3915"></a><span id="l3.3915">   // Update status display; no status display for default text encoding.</span>
<a href="#l3.3916"></a><span id="l3.3916">   encodingStatusPanel.collapsed = !(encodingStatusPanel.label = encodingUIString);</span>
<a href="#l3.3917"></a><span id="l3.3917"> }</span>
<a href="#l3.3918"></a><span id="l3.3918"> </span>
<a href="#l3.3919"></a><span id="l3.3919" class="difflineminus">-function ToggleReturnReceipt(target)</span>
<a href="#l3.3920"></a><span id="l3.3920" class="difflineminus">-{</span>
<a href="#l3.3921"></a><span id="l3.3921" class="difflineminus">-    var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3922"></a><span id="l3.3922" class="difflineminus">-    if (msgCompFields)</span>
<a href="#l3.3923"></a><span id="l3.3923" class="difflineminus">-    {</span>
<a href="#l3.3924"></a><span id="l3.3924" class="difflineminus">-        msgCompFields.returnReceipt = ! msgCompFields.returnReceipt;</span>
<a href="#l3.3925"></a><span id="l3.3925" class="difflineminus">-        target.setAttribute('checked', msgCompFields.returnReceipt);</span>
<a href="#l3.3926"></a><span id="l3.3926" class="difflineminus">-        gReceiptOptionChanged = true;</span>
<a href="#l3.3927"></a><span id="l3.3927" class="difflineminus">-    }</span>
<a href="#l3.3928"></a><span id="l3.3928" class="difflineminus">-}</span>
<a href="#l3.3929"></a><span id="l3.3929" class="difflineminus">-</span>
<a href="#l3.3930"></a><span id="l3.3930" class="difflineminus">-function ToggleDSN(target)</span>
<a href="#l3.3931"></a><span id="l3.3931" class="difflineminus">-{</span>
<a href="#l3.3932"></a><span id="l3.3932" class="difflineminus">-    var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3933"></a><span id="l3.3933" class="difflineminus">-    if (msgCompFields)</span>
<a href="#l3.3934"></a><span id="l3.3934" class="difflineminus">-    {</span>
<a href="#l3.3935"></a><span id="l3.3935" class="difflineminus">-        msgCompFields.DSN = ! msgCompFields.DSN;</span>
<a href="#l3.3936"></a><span id="l3.3936" class="difflineminus">-        target.setAttribute('checked', msgCompFields.DSN);</span>
<a href="#l3.3937"></a><span id="l3.3937" class="difflineminus">-        gDSNOptionChanged = true;</span>
<a href="#l3.3938"></a><span id="l3.3938" class="difflineminus">-    }</span>
<a href="#l3.3939"></a><span id="l3.3939" class="difflineminus">-}</span>
<a href="#l3.3940"></a><span id="l3.3940" class="difflineminus">-</span>
<a href="#l3.3941"></a><span id="l3.3941" class="difflineminus">-function ToggleAttachVCard(target)</span>
<a href="#l3.3942"></a><span id="l3.3942" class="difflineminus">-{</span>
<a href="#l3.3943"></a><span id="l3.3943" class="difflineplus">+function ToggleReturnReceipt(target) {</span>
<a href="#l3.3944"></a><span id="l3.3944" class="difflineplus">+  var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3945"></a><span id="l3.3945" class="difflineplus">+  if (msgCompFields) {</span>
<a href="#l3.3946"></a><span id="l3.3946" class="difflineplus">+    msgCompFields.returnReceipt = !msgCompFields.returnReceipt;</span>
<a href="#l3.3947"></a><span id="l3.3947" class="difflineplus">+    target.setAttribute(&quot;checked&quot;, msgCompFields.returnReceipt);</span>
<a href="#l3.3948"></a><span id="l3.3948" class="difflineplus">+    gReceiptOptionChanged = true;</span>
<a href="#l3.3949"></a><span id="l3.3949" class="difflineplus">+  }</span>
<a href="#l3.3950"></a><span id="l3.3950" class="difflineplus">+}</span>
<a href="#l3.3951"></a><span id="l3.3951" class="difflineplus">+</span>
<a href="#l3.3952"></a><span id="l3.3952" class="difflineplus">+function ToggleDSN(target) {</span>
<a href="#l3.3953"></a><span id="l3.3953">   var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3954"></a><span id="l3.3954" class="difflineminus">-  if (msgCompFields)</span>
<a href="#l3.3955"></a><span id="l3.3955" class="difflineminus">-  {</span>
<a href="#l3.3956"></a><span id="l3.3956" class="difflineminus">-    msgCompFields.attachVCard = ! msgCompFields.attachVCard;</span>
<a href="#l3.3957"></a><span id="l3.3957" class="difflineminus">-    target.setAttribute('checked', msgCompFields.attachVCard);</span>
<a href="#l3.3958"></a><span id="l3.3958" class="difflineplus">+  if (msgCompFields) {</span>
<a href="#l3.3959"></a><span id="l3.3959" class="difflineplus">+    msgCompFields.DSN = !msgCompFields.DSN;</span>
<a href="#l3.3960"></a><span id="l3.3960" class="difflineplus">+    target.setAttribute(&quot;checked&quot;, msgCompFields.DSN);</span>
<a href="#l3.3961"></a><span id="l3.3961" class="difflineplus">+    gDSNOptionChanged = true;</span>
<a href="#l3.3962"></a><span id="l3.3962" class="difflineplus">+  }</span>
<a href="#l3.3963"></a><span id="l3.3963" class="difflineplus">+}</span>
<a href="#l3.3964"></a><span id="l3.3964" class="difflineplus">+</span>
<a href="#l3.3965"></a><span id="l3.3965" class="difflineplus">+function ToggleAttachVCard(target) {</span>
<a href="#l3.3966"></a><span id="l3.3966" class="difflineplus">+  var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.3967"></a><span id="l3.3967" class="difflineplus">+  if (msgCompFields) {</span>
<a href="#l3.3968"></a><span id="l3.3968" class="difflineplus">+    msgCompFields.attachVCard = !msgCompFields.attachVCard;</span>
<a href="#l3.3969"></a><span id="l3.3969" class="difflineplus">+    target.setAttribute(&quot;checked&quot;, msgCompFields.attachVCard);</span>
<a href="#l3.3970"></a><span id="l3.3970">     gAttachVCardOptionChanged = true;</span>
<a href="#l3.3971"></a><span id="l3.3971">   }</span>
<a href="#l3.3972"></a><span id="l3.3972"> }</span>
<a href="#l3.3973"></a><span id="l3.3973"> </span>
<a href="#l3.3974"></a><span id="l3.3974"> /**</span>
<a href="#l3.3975"></a><span id="l3.3975">  * Toggles or sets the status of manual Attachment Reminder, i.e. whether</span>
<a href="#l3.3976"></a><span id="l3.3976">  * the user will get the &quot;Attachment Reminder&quot; alert before sending or not.</span>
<a href="#l3.3977"></a><span id="l3.3977">  * Toggles checkmark on &quot;Remind me later&quot; menuitem and internal</span>
<a href="#l3.3978"></a><span id="l3.3978">  * gManualAttachmentReminder flag accordingly.</span>
<a href="#l3.3979"></a><span id="l3.3979">  *</span>
<a href="#l3.3980"></a><span id="l3.3980">  * @param aState (optional) true = activate reminder.</span>
<a href="#l3.3981"></a><span id="l3.3981">  *                          false = deactivate reminder.</span>
<a href="#l3.3982"></a><span id="l3.3982">  *                          (default) = toggle reminder state.</span>
<a href="#l3.3983"></a><span id="l3.3983">  */</span>
<a href="#l3.3984"></a><span id="l3.3984" class="difflineminus">-function toggleAttachmentReminder(aState = !gManualAttachmentReminder)</span>
<a href="#l3.3985"></a><span id="l3.3985" class="difflineminus">-{</span>
<a href="#l3.3986"></a><span id="l3.3986" class="difflineplus">+function toggleAttachmentReminder(aState = !gManualAttachmentReminder) {</span>
<a href="#l3.3987"></a><span id="l3.3987">   gManualAttachmentReminder = aState;</span>
<a href="#l3.3988"></a><span id="l3.3988">   document.getElementById(&quot;cmd_remindLater&quot;)</span>
<a href="#l3.3989"></a><span id="l3.3989">           .setAttribute(&quot;checked&quot;, aState);</span>
<a href="#l3.3990"></a><span id="l3.3990">   gMsgCompose.compFields.attachmentReminder = aState;</span>
<a href="#l3.3991"></a><span id="l3.3991"> </span>
<a href="#l3.3992"></a><span id="l3.3992">   // If we enabled manual reminder, the reminder can't be turned off.</span>
<a href="#l3.3993"></a><span id="l3.3993">   if (aState)</span>
<a href="#l3.3994"></a><span id="l3.3994">     gDisableAttachmentReminder = false;</span>
<a href="#l3.3995"></a><span id="l3.3995"> </span>
<a href="#l3.3996"></a><span id="l3.3996">   manageAttachmentNotification(false);</span>
<a href="#l3.3997"></a><span id="l3.3997"> }</span>
<a href="#l3.3998"></a><span id="l3.3998"> </span>
<a href="#l3.3999"></a><span id="l3.3999" class="difflineminus">-function FillIdentityList(menulist)</span>
<a href="#l3.4000"></a><span id="l3.4000" class="difflineminus">-{</span>
<a href="#l3.4001"></a><span id="l3.4001" class="difflineplus">+function FillIdentityList(menulist) {</span>
<a href="#l3.4002"></a><span id="l3.4002">   let accounts = allAccountsSorted(true);</span>
<a href="#l3.4003"></a><span id="l3.4003"> </span>
<a href="#l3.4004"></a><span id="l3.4004">   let accountHadSeparator = false;</span>
<a href="#l3.4005"></a><span id="l3.4005">   let firstAccountWithIdentities = true;</span>
<a href="#l3.4006"></a><span id="l3.4006">   for (let acc = 0; acc &lt; accounts.length; acc++) {</span>
<a href="#l3.4007"></a><span id="l3.4007">     let account = accounts[acc];</span>
<a href="#l3.4008"></a><span id="l3.4008">     let identities = toArray(fixIterator(account.identities,</span>
<a href="#l3.4009"></a><span id="l3.4009">                                          Ci.nsIMsgIdentity));</span>
<a href="#l3.4010"></a><span id="l3.4010" class="difflineat">@@ -4188,59 +4007,51 @@ function FillIdentityList(menulist)</span>
<a href="#l3.4011"></a><span id="l3.4011">     }</span>
<a href="#l3.4012"></a><span id="l3.4012">   }</span>
<a href="#l3.4013"></a><span id="l3.4013"> </span>
<a href="#l3.4014"></a><span id="l3.4014">   menulist.menupopup.appendChild(document.createElement(&quot;menuseparator&quot;));</span>
<a href="#l3.4015"></a><span id="l3.4015">   menulist.menupopup.appendChild(document.createElement(&quot;menuitem&quot;))</span>
<a href="#l3.4016"></a><span id="l3.4016">           .setAttribute(&quot;command&quot;, &quot;cmd_customizeFromAddress&quot;);</span>
<a href="#l3.4017"></a><span id="l3.4017"> }</span>
<a href="#l3.4018"></a><span id="l3.4018"> </span>
<a href="#l3.4019"></a><span id="l3.4019" class="difflineminus">-function getCurrentAccountKey()</span>
<a href="#l3.4020"></a><span id="l3.4020" class="difflineminus">-{</span>
<a href="#l3.4021"></a><span id="l3.4021" class="difflineplus">+function getCurrentAccountKey() {</span>
<a href="#l3.4022"></a><span id="l3.4022">   // Get the account's key.</span>
<a href="#l3.4023"></a><span id="l3.4023">   let identityList = GetMsgIdentityElement();</span>
<a href="#l3.4024"></a><span id="l3.4024">   return identityList.selectedItem.getAttribute(&quot;accountkey&quot;);</span>
<a href="#l3.4025"></a><span id="l3.4025"> }</span>
<a href="#l3.4026"></a><span id="l3.4026"> </span>
<a href="#l3.4027"></a><span id="l3.4027" class="difflineminus">-function getCurrentIdentityKey()</span>
<a href="#l3.4028"></a><span id="l3.4028" class="difflineminus">-{</span>
<a href="#l3.4029"></a><span id="l3.4029" class="difflineplus">+function getCurrentIdentityKey() {</span>
<a href="#l3.4030"></a><span id="l3.4030">   // Get the identity key.</span>
<a href="#l3.4031"></a><span id="l3.4031">   let identityList = GetMsgIdentityElement();</span>
<a href="#l3.4032"></a><span id="l3.4032">   return identityList.selectedItem.getAttribute(&quot;identitykey&quot;);</span>
<a href="#l3.4033"></a><span id="l3.4033"> }</span>
<a href="#l3.4034"></a><span id="l3.4034"> </span>
<a href="#l3.4035"></a><span id="l3.4035" class="difflineminus">-function getIdentityForKey(key)</span>
<a href="#l3.4036"></a><span id="l3.4036" class="difflineminus">-{</span>
<a href="#l3.4037"></a><span id="l3.4037" class="difflineplus">+function getIdentityForKey(key) {</span>
<a href="#l3.4038"></a><span id="l3.4038">   return MailServices.accounts.getIdentity(key);</span>
<a href="#l3.4039"></a><span id="l3.4039"> }</span>
<a href="#l3.4040"></a><span id="l3.4040"> </span>
<a href="#l3.4041"></a><span id="l3.4041" class="difflineminus">-function getCurrentIdentity()</span>
<a href="#l3.4042"></a><span id="l3.4042" class="difflineminus">-{</span>
<a href="#l3.4043"></a><span id="l3.4043" class="difflineplus">+function getCurrentIdentity() {</span>
<a href="#l3.4044"></a><span id="l3.4044">   return getIdentityForKey(getCurrentIdentityKey());</span>
<a href="#l3.4045"></a><span id="l3.4045"> }</span>
<a href="#l3.4046"></a><span id="l3.4046"> </span>
<a href="#l3.4047"></a><span id="l3.4047" class="difflineminus">-function AdjustFocus()</span>
<a href="#l3.4048"></a><span id="l3.4048" class="difflineminus">-{</span>
<a href="#l3.4049"></a><span id="l3.4049" class="difflineminus">-  //dump(&quot;XXX adjusting focus\n&quot;);</span>
<a href="#l3.4050"></a><span id="l3.4050" class="difflineplus">+function AdjustFocus() {</span>
<a href="#l3.4051"></a><span id="l3.4051" class="difflineplus">+  // dump(&quot;XXX adjusting focus\n&quot;);</span>
<a href="#l3.4052"></a><span id="l3.4052">   var element = awGetInputElement(awGetNumberOfRecipients());</span>
<a href="#l3.4053"></a><span id="l3.4053">   if (element.value == &quot;&quot;) {</span>
<a href="#l3.4054"></a><span id="l3.4054" class="difflineminus">-      //dump(&quot;XXX focus on address\n&quot;);</span>
<a href="#l3.4055"></a><span id="l3.4055" class="difflineminus">-      awSetFocus(awGetNumberOfRecipients(), element);</span>
<a href="#l3.4056"></a><span id="l3.4056" class="difflineminus">-  }</span>
<a href="#l3.4057"></a><span id="l3.4057" class="difflineminus">-  else</span>
<a href="#l3.4058"></a><span id="l3.4058" class="difflineminus">-  {</span>
<a href="#l3.4059"></a><span id="l3.4059" class="difflineminus">-      element = GetMsgSubjectElement();</span>
<a href="#l3.4060"></a><span id="l3.4060" class="difflineminus">-      if (element.value == &quot;&quot;) {</span>
<a href="#l3.4061"></a><span id="l3.4061" class="difflineminus">-        //dump(&quot;XXX focus on subject\n&quot;);</span>
<a href="#l3.4062"></a><span id="l3.4062" class="difflineminus">-        element.focus();</span>
<a href="#l3.4063"></a><span id="l3.4063" class="difflineminus">-      }</span>
<a href="#l3.4064"></a><span id="l3.4064" class="difflineminus">-      else {</span>
<a href="#l3.4065"></a><span id="l3.4065" class="difflineminus">-        //dump(&quot;XXX focus on body\n&quot;);</span>
<a href="#l3.4066"></a><span id="l3.4066" class="difflineminus">-        SetMsgBodyFrameFocus();</span>
<a href="#l3.4067"></a><span id="l3.4067" class="difflineminus">-      }</span>
<a href="#l3.4068"></a><span id="l3.4068" class="difflineplus">+    // dump(&quot;XXX focus on address\n&quot;);</span>
<a href="#l3.4069"></a><span id="l3.4069" class="difflineplus">+    awSetFocus(awGetNumberOfRecipients(), element);</span>
<a href="#l3.4070"></a><span id="l3.4070" class="difflineplus">+  } else {</span>
<a href="#l3.4071"></a><span id="l3.4071" class="difflineplus">+    element = GetMsgSubjectElement();</span>
<a href="#l3.4072"></a><span id="l3.4072" class="difflineplus">+    if (element.value == &quot;&quot;) {</span>
<a href="#l3.4073"></a><span id="l3.4073" class="difflineplus">+      // dump(&quot;XXX focus on subject\n&quot;);</span>
<a href="#l3.4074"></a><span id="l3.4074" class="difflineplus">+      element.focus();</span>
<a href="#l3.4075"></a><span id="l3.4075" class="difflineplus">+    } else {</span>
<a href="#l3.4076"></a><span id="l3.4076" class="difflineplus">+      // dump(&quot;XXX focus on body\n&quot;);</span>
<a href="#l3.4077"></a><span id="l3.4077" class="difflineplus">+      SetMsgBodyFrameFocus();</span>
<a href="#l3.4078"></a><span id="l3.4078" class="difflineplus">+    }</span>
<a href="#l3.4079"></a><span id="l3.4079">   }</span>
<a href="#l3.4080"></a><span id="l3.4080"> }</span>
<a href="#l3.4081"></a><span id="l3.4081"> </span>
<a href="#l3.4082"></a><span id="l3.4082"> /**</span>
<a href="#l3.4083"></a><span id="l3.4083">  * Set the compose window title with flavors (Write | Print Preview).</span>
<a href="#l3.4084"></a><span id="l3.4084">  *</span>
<a href="#l3.4085"></a><span id="l3.4085">  * @param isPrintPreview (optional) true:  Set title for 'Print Preview' window.</span>
<a href="#l3.4086"></a><span id="l3.4086">  *                                  false: Set title for 'Write' window (default).</span>
<a href="#l3.4087"></a><span id="l3.4087" class="difflineat">@@ -4254,26 +4065,24 @@ function SetComposeWindowTitle(isPrintPr</span>
<a href="#l3.4088"></a><span id="l3.4088">   let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.4089"></a><span id="l3.4089">   let newTitle = getComposeBundle().getFormattedString(aStringName,</span>
<a href="#l3.4090"></a><span id="l3.4090">                                                        [subject, brandShortName]);</span>
<a href="#l3.4091"></a><span id="l3.4091">   document.title = newTitle;</span>
<a href="#l3.4092"></a><span id="l3.4092"> }</span>
<a href="#l3.4093"></a><span id="l3.4093"> </span>
<a href="#l3.4094"></a><span id="l3.4094"> // Check for changes to document and allow saving before closing</span>
<a href="#l3.4095"></a><span id="l3.4095"> // This is hooked up to the OS's window close widget (e.g., &quot;X&quot; for Windows)</span>
<a href="#l3.4096"></a><span id="l3.4096" class="difflineminus">-function ComposeCanClose()</span>
<a href="#l3.4097"></a><span id="l3.4097" class="difflineminus">-{</span>
<a href="#l3.4098"></a><span id="l3.4098" class="difflineplus">+function ComposeCanClose() {</span>
<a href="#l3.4099"></a><span id="l3.4099">   // No open compose window?</span>
<a href="#l3.4100"></a><span id="l3.4100">   if (!gMsgCompose)</span>
<a href="#l3.4101"></a><span id="l3.4101">     return true;</span>
<a href="#l3.4102"></a><span id="l3.4102"> </span>
<a href="#l3.4103"></a><span id="l3.4103">   // Do this early, so ldap sessions have a better chance to</span>
<a href="#l3.4104"></a><span id="l3.4104">   // cleanup after themselves.</span>
<a href="#l3.4105"></a><span id="l3.4105" class="difflineminus">-  if (gSendOperationInProgress || gSaveOperationInProgress)</span>
<a href="#l3.4106"></a><span id="l3.4106" class="difflineminus">-  {</span>
<a href="#l3.4107"></a><span id="l3.4107" class="difflineplus">+  if (gSendOperationInProgress || gSaveOperationInProgress) {</span>
<a href="#l3.4108"></a><span id="l3.4108">     let result;</span>
<a href="#l3.4109"></a><span id="l3.4109"> </span>
<a href="#l3.4110"></a><span id="l3.4110">     let brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l3.4111"></a><span id="l3.4111">     let brandShortName = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.4112"></a><span id="l3.4112">     let promptTitle = gSendOperationInProgress ?</span>
<a href="#l3.4113"></a><span id="l3.4113">       getComposeBundle().getString(&quot;quitComposeWindowTitle&quot;) :</span>
<a href="#l3.4114"></a><span id="l3.4114">       getComposeBundle().getString(&quot;quitComposeWindowSaveTitle&quot;);</span>
<a href="#l3.4115"></a><span id="l3.4115">     let promptMsg = gSendOperationInProgress ?</span>
<a href="#l3.4116"></a><span id="l3.4116" class="difflineat">@@ -4282,174 +4091,158 @@ function ComposeCanClose()</span>
<a href="#l3.4117"></a><span id="l3.4117">       getComposeBundle().getFormattedString(&quot;quitComposeWindowSaveMessage&quot;,</span>
<a href="#l3.4118"></a><span id="l3.4118">         [brandShortName], 1);</span>
<a href="#l3.4119"></a><span id="l3.4119">     let quitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowQuitButtonLabel2&quot;);</span>
<a href="#l3.4120"></a><span id="l3.4120">     let waitButtonLabel = getComposeBundle().getString(&quot;quitComposeWindowWaitButtonLabel2&quot;);</span>
<a href="#l3.4121"></a><span id="l3.4121"> </span>
<a href="#l3.4122"></a><span id="l3.4122">     result = Services.prompt.confirmEx(window, promptTitle, promptMsg,</span>
<a href="#l3.4123"></a><span id="l3.4123">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l3.4124"></a><span id="l3.4124">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l3.4125"></a><span id="l3.4125" class="difflineminus">-        waitButtonLabel, quitButtonLabel, null, null, {value:0});</span>
<a href="#l3.4126"></a><span id="l3.4126" class="difflineminus">-</span>
<a href="#l3.4127"></a><span id="l3.4127" class="difflineminus">-    if (result == 1)</span>
<a href="#l3.4128"></a><span id="l3.4128" class="difflineminus">-    {</span>
<a href="#l3.4129"></a><span id="l3.4129" class="difflineplus">+        waitButtonLabel, quitButtonLabel, null, null, {value: 0});</span>
<a href="#l3.4130"></a><span id="l3.4130" class="difflineplus">+</span>
<a href="#l3.4131"></a><span id="l3.4131" class="difflineplus">+    if (result == 1) {</span>
<a href="#l3.4132"></a><span id="l3.4132">       gMsgCompose.abort();</span>
<a href="#l3.4133"></a><span id="l3.4133">       return true;</span>
<a href="#l3.4134"></a><span id="l3.4134">     }</span>
<a href="#l3.4135"></a><span id="l3.4135">     return false;</span>
<a href="#l3.4136"></a><span id="l3.4136">   }</span>
<a href="#l3.4137"></a><span id="l3.4137"> </span>
<a href="#l3.4138"></a><span id="l3.4138">   // Returns FALSE only if user cancels save action</span>
<a href="#l3.4139"></a><span id="l3.4139" class="difflineminus">-  if (gContentChanged || gMsgCompose.bodyModified || gAutoSaveKickedIn)</span>
<a href="#l3.4140"></a><span id="l3.4140" class="difflineminus">-  {</span>
<a href="#l3.4141"></a><span id="l3.4141" class="difflineplus">+  if (gContentChanged || gMsgCompose.bodyModified || gAutoSaveKickedIn) {</span>
<a href="#l3.4142"></a><span id="l3.4142">     // call window.focus, since we need to pop up a dialog</span>
<a href="#l3.4143"></a><span id="l3.4143">     // and therefore need to be visible (to prevent user confusion)</span>
<a href="#l3.4144"></a><span id="l3.4144">     window.focus();</span>
<a href="#l3.4145"></a><span id="l3.4145">     let draftFolderURI = gCurrentIdentity.draftFolder;</span>
<a href="#l3.4146"></a><span id="l3.4146">     let draftFolderName = MailUtils.getFolderForURI(draftFolderURI).prettyName;</span>
<a href="#l3.4147"></a><span id="l3.4147">     let result = Services.prompt</span>
<a href="#l3.4148"></a><span id="l3.4148">                          .confirmEx(window,</span>
<a href="#l3.4149"></a><span id="l3.4149">                                     getComposeBundle().getString(&quot;saveDlogTitle&quot;),</span>
<a href="#l3.4150"></a><span id="l3.4150">                                     getComposeBundle().getFormattedString(&quot;saveDlogMessages3&quot;, [draftFolderName]),</span>
<a href="#l3.4151"></a><span id="l3.4151">                                     (Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l3.4152"></a><span id="l3.4152">                                     (Services.prompt.BUTTON_TITLE_CANCEL * Services.prompt.BUTTON_POS_1) +</span>
<a href="#l3.4153"></a><span id="l3.4153">                                     (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_2),</span>
<a href="#l3.4154"></a><span id="l3.4154">                                     null,</span>
<a href="#l3.4155"></a><span id="l3.4155">                                     null,</span>
<a href="#l3.4156"></a><span id="l3.4156">                                     getComposeBundle().getString(&quot;discardButtonLabel&quot;),</span>
<a href="#l3.4157"></a><span id="l3.4157" class="difflineminus">-                                    null, {value:0});</span>
<a href="#l3.4158"></a><span id="l3.4158" class="difflineminus">-    switch (result)</span>
<a href="#l3.4159"></a><span id="l3.4159" class="difflineminus">-    {</span>
<a href="#l3.4160"></a><span id="l3.4160" class="difflineminus">-      case 0: //Save</span>
<a href="#l3.4161"></a><span id="l3.4161" class="difflineplus">+                                    null, {value: 0});</span>
<a href="#l3.4162"></a><span id="l3.4162" class="difflineplus">+    switch (result) {</span>
<a href="#l3.4163"></a><span id="l3.4163" class="difflineplus">+      case 0: // Save</span>
<a href="#l3.4164"></a><span id="l3.4164">         // Since we're going to save the message, we tell toolkit that</span>
<a href="#l3.4165"></a><span id="l3.4165">         // the close command failed, by returning false, and then</span>
<a href="#l3.4166"></a><span id="l3.4166">         // we close the window ourselves after the save is done.</span>
<a href="#l3.4167"></a><span id="l3.4167">         gCloseWindowAfterSave = true;</span>
<a href="#l3.4168"></a><span id="l3.4168">         // We catch the exception because we need to tell toolkit that it</span>
<a href="#l3.4169"></a><span id="l3.4169">         // shouldn't close the window, because we're going to close it</span>
<a href="#l3.4170"></a><span id="l3.4170">         // ourselves. If we don't tell toolkit that, and then close the window</span>
<a href="#l3.4171"></a><span id="l3.4171">         // ourselves, the toolkit code that keeps track of the open windows</span>
<a href="#l3.4172"></a><span id="l3.4172">         // gets off by one and the app can close unexpectedly on os's that</span>
<a href="#l3.4173"></a><span id="l3.4173">         // shutdown the app when the last window is closed.</span>
<a href="#l3.4174"></a><span id="l3.4174">         try {</span>
<a href="#l3.4175"></a><span id="l3.4175" class="difflineminus">-          GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.4176"></a><span id="l3.4176" class="difflineminus">-        }</span>
<a href="#l3.4177"></a><span id="l3.4177" class="difflineminus">-        catch (ex) {</span>
<a href="#l3.4178"></a><span id="l3.4178" class="difflineplus">+          GenericSendMessage(Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.4179"></a><span id="l3.4179" class="difflineplus">+        } catch (ex) {</span>
<a href="#l3.4180"></a><span id="l3.4180">           Cu.reportError(ex);</span>
<a href="#l3.4181"></a><span id="l3.4181">         }</span>
<a href="#l3.4182"></a><span id="l3.4182">         return false;</span>
<a href="#l3.4183"></a><span id="l3.4183" class="difflineminus">-      case 1: //Cancel</span>
<a href="#l3.4184"></a><span id="l3.4184" class="difflineplus">+      case 1: // Cancel</span>
<a href="#l3.4185"></a><span id="l3.4185">         return false;</span>
<a href="#l3.4186"></a><span id="l3.4186" class="difflineminus">-      case 2: //Don't Save</span>
<a href="#l3.4187"></a><span id="l3.4187" class="difflineplus">+      case 2: // Don't Save</span>
<a href="#l3.4188"></a><span id="l3.4188">         // don't delete the draft if we didn't start off editing a draft</span>
<a href="#l3.4189"></a><span id="l3.4189">         // and the user hasn't explicitly saved it.</span>
<a href="#l3.4190"></a><span id="l3.4190">         if (!gEditingDraft &amp;&amp; gAutoSaveKickedIn)</span>
<a href="#l3.4191"></a><span id="l3.4191">           RemoveDraft();</span>
<a href="#l3.4192"></a><span id="l3.4192">         break;</span>
<a href="#l3.4193"></a><span id="l3.4193">     }</span>
<a href="#l3.4194"></a><span id="l3.4194">   }</span>
<a href="#l3.4195"></a><span id="l3.4195"> </span>
<a href="#l3.4196"></a><span id="l3.4196">   return true;</span>
<a href="#l3.4197"></a><span id="l3.4197"> }</span>
<a href="#l3.4198"></a><span id="l3.4198"> </span>
<a href="#l3.4199"></a><span id="l3.4199" class="difflineminus">-function RemoveDraft()</span>
<a href="#l3.4200"></a><span id="l3.4200" class="difflineminus">-{</span>
<a href="#l3.4201"></a><span id="l3.4201" class="difflineminus">-  try</span>
<a href="#l3.4202"></a><span id="l3.4202" class="difflineminus">-  {</span>
<a href="#l3.4203"></a><span id="l3.4203" class="difflineplus">+function RemoveDraft() {</span>
<a href="#l3.4204"></a><span id="l3.4204" class="difflineplus">+  try {</span>
<a href="#l3.4205"></a><span id="l3.4205">     var draftUri = gMsgCompose.compFields.draftId;</span>
<a href="#l3.4206"></a><span id="l3.4206" class="difflineminus">-    var msgKey = draftUri.substr(draftUri.indexOf('#') + 1);</span>
<a href="#l3.4207"></a><span id="l3.4207" class="difflineminus">-    var rdf = Cc['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l3.4208"></a><span id="l3.4208" class="difflineplus">+    var msgKey = draftUri.substr(draftUri.indexOf(&quot;#&quot;) + 1);</span>
<a href="#l3.4209"></a><span id="l3.4209" class="difflineplus">+    var rdf = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l3.4210"></a><span id="l3.4210">                 .getService(Ci.nsIRDFService);</span>
<a href="#l3.4211"></a><span id="l3.4211"> </span>
<a href="#l3.4212"></a><span id="l3.4212">     var folder = rdf.GetResource(gMsgCompose.savedFolderURI)</span>
<a href="#l3.4213"></a><span id="l3.4213">                     .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l3.4214"></a><span id="l3.4214">     try {</span>
<a href="#l3.4215"></a><span id="l3.4215" class="difflineminus">-      if (folder.flags &amp; Ci.nsMsgFolderFlags.Drafts)</span>
<a href="#l3.4216"></a><span id="l3.4216" class="difflineminus">-      {</span>
<a href="#l3.4217"></a><span id="l3.4217" class="difflineplus">+      if (folder.flags &amp; Ci.nsMsgFolderFlags.Drafts) {</span>
<a href="#l3.4218"></a><span id="l3.4218">         var msgs = Cc[&quot;@mozilla.org/array;1&quot;].</span>
<a href="#l3.4219"></a><span id="l3.4219">             createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.4220"></a><span id="l3.4220">         msgs.appendElement(folder.GetMessageHeader(msgKey));</span>
<a href="#l3.4221"></a><span id="l3.4221">         folder.deleteMessages(msgs, null, true, false, null, false);</span>
<a href="#l3.4222"></a><span id="l3.4222">       }</span>
<a href="#l3.4223"></a><span id="l3.4223" class="difflineminus">-    }</span>
<a href="#l3.4224"></a><span id="l3.4224" class="difflineminus">-    catch (ex) // couldn't find header - perhaps an imap folder.</span>
<a href="#l3.4225"></a><span id="l3.4225" class="difflineminus">-    {</span>
<a href="#l3.4226"></a><span id="l3.4226" class="difflineplus">+    } catch (ex) { // couldn't find header - perhaps an imap folder.</span>
<a href="#l3.4227"></a><span id="l3.4227">       var imapFolder = folder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l3.4228"></a><span id="l3.4228" class="difflineminus">-      var keyArray = new Array;</span>
<a href="#l3.4229"></a><span id="l3.4229" class="difflineplus">+      var keyArray = [];</span>
<a href="#l3.4230"></a><span id="l3.4230">       keyArray[0] = msgKey;</span>
<a href="#l3.4231"></a><span id="l3.4231">       imapFolder.storeImapFlags(8, true, keyArray, 1, null);</span>
<a href="#l3.4232"></a><span id="l3.4232">     }</span>
<a href="#l3.4233"></a><span id="l3.4233">   } catch (ex) {}</span>
<a href="#l3.4234"></a><span id="l3.4234"> }</span>
<a href="#l3.4235"></a><span id="l3.4235"> </span>
<a href="#l3.4236"></a><span id="l3.4236" class="difflineminus">-function SetContentAndBodyAsUnmodified()</span>
<a href="#l3.4237"></a><span id="l3.4237" class="difflineminus">-{</span>
<a href="#l3.4238"></a><span id="l3.4238" class="difflineplus">+function SetContentAndBodyAsUnmodified() {</span>
<a href="#l3.4239"></a><span id="l3.4239">   gMsgCompose.bodyModified = false;</span>
<a href="#l3.4240"></a><span id="l3.4240">   gContentChanged = false;</span>
<a href="#l3.4241"></a><span id="l3.4241"> }</span>
<a href="#l3.4242"></a><span id="l3.4242"> </span>
<a href="#l3.4243"></a><span id="l3.4243" class="difflineminus">-function MsgComposeCloseWindow()</span>
<a href="#l3.4244"></a><span id="l3.4244" class="difflineminus">-{</span>
<a href="#l3.4245"></a><span id="l3.4245" class="difflineplus">+function MsgComposeCloseWindow() {</span>
<a href="#l3.4246"></a><span id="l3.4246">   if (gMsgCompose)</span>
<a href="#l3.4247"></a><span id="l3.4247">     gMsgCompose.CloseWindow();</span>
<a href="#l3.4248"></a><span id="l3.4248">   else</span>
<a href="#l3.4249"></a><span id="l3.4249">     window.close();</span>
<a href="#l3.4250"></a><span id="l3.4250"> }</span>
<a href="#l3.4251"></a><span id="l3.4251"> </span>
<a href="#l3.4252"></a><span id="l3.4252" class="difflineminus">-function GetLastAttachDirectory()</span>
<a href="#l3.4253"></a><span id="l3.4253" class="difflineminus">-{</span>
<a href="#l3.4254"></a><span id="l3.4254" class="difflineplus">+function GetLastAttachDirectory() {</span>
<a href="#l3.4255"></a><span id="l3.4255">   var lastDirectory;</span>
<a href="#l3.4256"></a><span id="l3.4256"> </span>
<a href="#l3.4257"></a><span id="l3.4257">   try {</span>
<a href="#l3.4258"></a><span id="l3.4258">     lastDirectory = Services.prefs</span>
<a href="#l3.4259"></a><span id="l3.4259">                             .getComplexValue(kComposeAttachDirPrefName,</span>
<a href="#l3.4260"></a><span id="l3.4260">                                              Ci.nsIFile);</span>
<a href="#l3.4261"></a><span id="l3.4261" class="difflineminus">-  }</span>
<a href="#l3.4262"></a><span id="l3.4262" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.4263"></a><span id="l3.4263" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.4264"></a><span id="l3.4264">     // this will fail the first time we attach a file</span>
<a href="#l3.4265"></a><span id="l3.4265">     // as we won't have a pref value.</span>
<a href="#l3.4266"></a><span id="l3.4266">     lastDirectory = null;</span>
<a href="#l3.4267"></a><span id="l3.4267">   }</span>
<a href="#l3.4268"></a><span id="l3.4268"> </span>
<a href="#l3.4269"></a><span id="l3.4269">   return lastDirectory;</span>
<a href="#l3.4270"></a><span id="l3.4270"> }</span>
<a href="#l3.4271"></a><span id="l3.4271"> </span>
<a href="#l3.4272"></a><span id="l3.4272"> // attachedLocalFile must be a nsIFile</span>
<a href="#l3.4273"></a><span id="l3.4273" class="difflineminus">-function SetLastAttachDirectory(attachedLocalFile)</span>
<a href="#l3.4274"></a><span id="l3.4274" class="difflineminus">-{</span>
<a href="#l3.4275"></a><span id="l3.4275" class="difflineplus">+function SetLastAttachDirectory(attachedLocalFile) {</span>
<a href="#l3.4276"></a><span id="l3.4276">   try {</span>
<a href="#l3.4277"></a><span id="l3.4277">     let file = attachedLocalFile.QueryInterface(Ci.nsIFile);</span>
<a href="#l3.4278"></a><span id="l3.4278">     let parent = file.parent.QueryInterface(Ci.nsIFile);</span>
<a href="#l3.4279"></a><span id="l3.4279"> </span>
<a href="#l3.4280"></a><span id="l3.4280">     Services.prefs.setComplexValue(kComposeAttachDirPrefName,</span>
<a href="#l3.4281"></a><span id="l3.4281">                                    Ci.nsIFile, parent);</span>
<a href="#l3.4282"></a><span id="l3.4282" class="difflineminus">-  }</span>
<a href="#l3.4283"></a><span id="l3.4283" class="difflineminus">-  catch (ex) {</span>
<a href="#l3.4284"></a><span id="l3.4284" class="difflineplus">+  } catch (ex) {</span>
<a href="#l3.4285"></a><span id="l3.4285">     dump(&quot;error: SetLastAttachDirectory failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.4286"></a><span id="l3.4286">   }</span>
<a href="#l3.4287"></a><span id="l3.4287"> }</span>
<a href="#l3.4288"></a><span id="l3.4288"> </span>
<a href="#l3.4289"></a><span id="l3.4289" class="difflineminus">-function AttachFile()</span>
<a href="#l3.4290"></a><span id="l3.4290" class="difflineminus">-{</span>
<a href="#l3.4291"></a><span id="l3.4291" class="difflineplus">+function AttachFile() {</span>
<a href="#l3.4292"></a><span id="l3.4292">   if (attachmentsCount() &gt; 0) {</span>
<a href="#l3.4293"></a><span id="l3.4293">     // If there are existing attachments already, restore attachment pane before</span>
<a href="#l3.4294"></a><span id="l3.4294">     // showing the file picker so that user can see them while adding more.</span>
<a href="#l3.4295"></a><span id="l3.4295">     toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l3.4296"></a><span id="l3.4296">   }</span>
<a href="#l3.4297"></a><span id="l3.4297"> </span>
<a href="#l3.4298"></a><span id="l3.4298" class="difflineminus">-  //Get file using nsIFilePicker and convert to URL</span>
<a href="#l3.4299"></a><span id="l3.4299" class="difflineminus">-  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l3.4300"></a><span id="l3.4300" class="difflineplus">+  // Get file using nsIFilePicker and convert to URL</span>
<a href="#l3.4301"></a><span id="l3.4301" class="difflineplus">+  let fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(Ci.nsIFilePicker);</span>
<a href="#l3.4302"></a><span id="l3.4302">   fp.init(window, getComposeBundle().getString(&quot;chooseFileToAttach&quot;),</span>
<a href="#l3.4303"></a><span id="l3.4303" class="difflineminus">-          nsIFilePicker.modeOpenMultiple);</span>
<a href="#l3.4304"></a><span id="l3.4304" class="difflineplus">+          Ci.nsIFilePicker.modeOpenMultiple);</span>
<a href="#l3.4305"></a><span id="l3.4305"> </span>
<a href="#l3.4306"></a><span id="l3.4306">   let lastDirectory = GetLastAttachDirectory();</span>
<a href="#l3.4307"></a><span id="l3.4307">   if (lastDirectory)</span>
<a href="#l3.4308"></a><span id="l3.4308">     fp.displayDirectory = lastDirectory;</span>
<a href="#l3.4309"></a><span id="l3.4309"> </span>
<a href="#l3.4310"></a><span id="l3.4310" class="difflineminus">-  fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l3.4311"></a><span id="l3.4311" class="difflineplus">+  fp.appendFilters(Ci.nsIFilePicker.filterAll);</span>
<a href="#l3.4312"></a><span id="l3.4312">   fp.open(rv =&gt; {</span>
<a href="#l3.4313"></a><span id="l3.4313">     if (rv != Ci.nsIFilePicker.returnOK || !fp.files)</span>
<a href="#l3.4314"></a><span id="l3.4314">       return;</span>
<a href="#l3.4315"></a><span id="l3.4315"> </span>
<a href="#l3.4316"></a><span id="l3.4316">     let file;</span>
<a href="#l3.4317"></a><span id="l3.4317">     let attachments = [];</span>
<a href="#l3.4318"></a><span id="l3.4318"> </span>
<a href="#l3.4319"></a><span id="l3.4319">     for (file of fixIterator(fp.files, Ci.nsIFile))</span>
<a href="#l3.4320"></a><span id="l3.4320" class="difflineat">@@ -4461,18 +4254,17 @@ function AttachFile()</span>
<a href="#l3.4321"></a><span id="l3.4321"> }</span>
<a href="#l3.4322"></a><span id="l3.4322"> </span>
<a href="#l3.4323"></a><span id="l3.4323"> /**</span>
<a href="#l3.4324"></a><span id="l3.4324">  * Convert an nsIFile instance into an nsIMsgAttachment.</span>
<a href="#l3.4325"></a><span id="l3.4325">  *</span>
<a href="#l3.4326"></a><span id="l3.4326">  * @param file the nsIFile</span>
<a href="#l3.4327"></a><span id="l3.4327">  * @return an attachment pointing to the file</span>
<a href="#l3.4328"></a><span id="l3.4328">  */</span>
<a href="#l3.4329"></a><span id="l3.4329" class="difflineminus">-function FileToAttachment(file)</span>
<a href="#l3.4330"></a><span id="l3.4330" class="difflineminus">-{</span>
<a href="#l3.4331"></a><span id="l3.4331" class="difflineplus">+function FileToAttachment(file) {</span>
<a href="#l3.4332"></a><span id="l3.4332">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.4333"></a><span id="l3.4333">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l3.4334"></a><span id="l3.4334">   let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l3.4335"></a><span id="l3.4335">                      .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l3.4336"></a><span id="l3.4336"> </span>
<a href="#l3.4337"></a><span id="l3.4337">   attachment.url = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l3.4338"></a><span id="l3.4338">   attachment.size = file.fileSize;</span>
<a href="#l3.4339"></a><span id="l3.4339">   return attachment;</span>
<a href="#l3.4340"></a><span id="l3.4340" class="difflineat">@@ -4486,18 +4278,17 @@ function FileToAttachment(file)</span>
<a href="#l3.4341"></a><span id="l3.4341">  *                      attachments. Anything iterable with fixIterator is</span>
<a href="#l3.4342"></a><span id="l3.4342">  *                      accepted.</span>
<a href="#l3.4343"></a><span id="l3.4343">  * @param aCallback     an optional callback function called immediately after</span>
<a href="#l3.4344"></a><span id="l3.4344">  *                      adding each attachment. Takes one argument:</span>
<a href="#l3.4345"></a><span id="l3.4345">  *                      the newly-added &lt;attachmentitem&gt; node.</span>
<a href="#l3.4346"></a><span id="l3.4346">  * @param aContentChanged {Boolean}  optional value to assign to gContentChanged</span>
<a href="#l3.4347"></a><span id="l3.4347">  *                                   after adding attachments; defaults to true.</span>
<a href="#l3.4348"></a><span id="l3.4348">  */</span>
<a href="#l3.4349"></a><span id="l3.4349" class="difflineminus">-function AddAttachments(aAttachments, aCallback, aContentChanged = true)</span>
<a href="#l3.4350"></a><span id="l3.4350" class="difflineminus">-{</span>
<a href="#l3.4351"></a><span id="l3.4351" class="difflineplus">+function AddAttachments(aAttachments, aCallback, aContentChanged = true) {</span>
<a href="#l3.4352"></a><span id="l3.4352">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4353"></a><span id="l3.4353">   let addedAttachments = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l3.4354"></a><span id="l3.4354">                            .createInstance(Ci.nsIMutableArray);</span>
<a href="#l3.4355"></a><span id="l3.4355">   let items = [];</span>
<a href="#l3.4356"></a><span id="l3.4356"> </span>
<a href="#l3.4357"></a><span id="l3.4357">   for (let attachment of fixIterator(aAttachments,</span>
<a href="#l3.4358"></a><span id="l3.4358">                                      Ci.nsIMsgAttachment)) {</span>
<a href="#l3.4359"></a><span id="l3.4359">     if (!(attachment &amp;&amp; attachment.url) ||</span>
<a href="#l3.4360"></a><span id="l3.4360" class="difflineat">@@ -4519,31 +4310,31 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l3.4361"></a><span id="l3.4361">     let item = bucket.appendItem(attachment);</span>
<a href="#l3.4362"></a><span id="l3.4362">     addedAttachments.appendElement(attachment);</span>
<a href="#l3.4363"></a><span id="l3.4363"> </span>
<a href="#l3.4364"></a><span id="l3.4364">     if (attachment.size != -1)</span>
<a href="#l3.4365"></a><span id="l3.4365">       gAttachmentsSize += attachment.size;</span>
<a href="#l3.4366"></a><span id="l3.4366"> </span>
<a href="#l3.4367"></a><span id="l3.4367">     try {</span>
<a href="#l3.4368"></a><span id="l3.4368">       item.setAttribute(&quot;tooltiptext&quot;, decodeURI(attachment.url));</span>
<a href="#l3.4369"></a><span id="l3.4369" class="difflineminus">-    }</span>
<a href="#l3.4370"></a><span id="l3.4370" class="difflineminus">-    catch(e) {</span>
<a href="#l3.4371"></a><span id="l3.4371" class="difflineplus">+    } catch (e) {</span>
<a href="#l3.4372"></a><span id="l3.4372">       item.setAttribute(&quot;tooltiptext&quot;, attachment.url);</span>
<a href="#l3.4373"></a><span id="l3.4373">     }</span>
<a href="#l3.4374"></a><span id="l3.4374">     item.addEventListener(&quot;command&quot;, OpenSelectedAttachment);</span>
<a href="#l3.4375"></a><span id="l3.4375"> </span>
<a href="#l3.4376"></a><span id="l3.4376">     if (attachment.sendViaCloud) {</span>
<a href="#l3.4377"></a><span id="l3.4377">       try {</span>
<a href="#l3.4378"></a><span id="l3.4378">         let cloudProvider = cloudFileAccounts.getAccount(attachment.cloudProviderKey);</span>
<a href="#l3.4379"></a><span id="l3.4379">         item.cloudProvider = cloudProvider;</span>
<a href="#l3.4380"></a><span id="l3.4380">         item.image = cloudProvider.iconClass;</span>
<a href="#l3.4381"></a><span id="l3.4381">         item.originalUrl = attachment.url;</span>
<a href="#l3.4382"></a><span id="l3.4382" class="difflineminus">-      } catch (ex) {dump(ex);}</span>
<a href="#l3.4383"></a><span id="l3.4383" class="difflineminus">-    }</span>
<a href="#l3.4384"></a><span id="l3.4384" class="difflineminus">-    else {</span>
<a href="#l3.4385"></a><span id="l3.4385" class="difflineplus">+      } catch (ex) {</span>
<a href="#l3.4386"></a><span id="l3.4386" class="difflineplus">+        dump(ex);</span>
<a href="#l3.4387"></a><span id="l3.4387" class="difflineplus">+      }</span>
<a href="#l3.4388"></a><span id="l3.4388" class="difflineplus">+    } else {</span>
<a href="#l3.4389"></a><span id="l3.4389">       // For local file urls, we are better off using the full file url because</span>
<a href="#l3.4390"></a><span id="l3.4390">       // moz-icon will actually resolve the file url and get the right icon from</span>
<a href="#l3.4391"></a><span id="l3.4391">       // the file url. All other urls, we should try to extract the file name from</span>
<a href="#l3.4392"></a><span id="l3.4392">       // them. This fixes issues where an icon wasn't showing up if you dragged a</span>
<a href="#l3.4393"></a><span id="l3.4393">       // web url that had a query or reference string after the file name and for</span>
<a href="#l3.4394"></a><span id="l3.4394">       // mailnews urls where the filename is hidden in the url as a &amp;filename=</span>
<a href="#l3.4395"></a><span id="l3.4395">       // part.</span>
<a href="#l3.4396"></a><span id="l3.4396">       let url = Services.io.newURI(attachment.url);</span>
<a href="#l3.4397"></a><span id="l3.4397" class="difflineat">@@ -4588,30 +4379,28 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l3.4398"></a><span id="l3.4398"> }</span>
<a href="#l3.4399"></a><span id="l3.4399"> </span>
<a href="#l3.4400"></a><span id="l3.4400"> /**</span>
<a href="#l3.4401"></a><span id="l3.4401">  * Get the number of all attachments of the message.</span>
<a href="#l3.4402"></a><span id="l3.4402">  *</span>
<a href="#l3.4403"></a><span id="l3.4403">  * @return the number of all attachment items in attachmentBucket;</span>
<a href="#l3.4404"></a><span id="l3.4404">  *         0 if attachmentBucket not found or no attachments in the list.</span>
<a href="#l3.4405"></a><span id="l3.4405">  */</span>
<a href="#l3.4406"></a><span id="l3.4406" class="difflineminus">-function attachmentsCount()</span>
<a href="#l3.4407"></a><span id="l3.4407" class="difflineminus">-{</span>
<a href="#l3.4408"></a><span id="l3.4408" class="difflineplus">+function attachmentsCount() {</span>
<a href="#l3.4409"></a><span id="l3.4409">   let bucketList = GetMsgAttachmentElement();</span>
<a href="#l3.4410"></a><span id="l3.4410">   return (bucketList) ? bucketList.itemCount : 0;</span>
<a href="#l3.4411"></a><span id="l3.4411"> }</span>
<a href="#l3.4412"></a><span id="l3.4412"> </span>
<a href="#l3.4413"></a><span id="l3.4413"> /**</span>
<a href="#l3.4414"></a><span id="l3.4414">  * Get the number of selected attachments.</span>
<a href="#l3.4415"></a><span id="l3.4415">  *</span>
<a href="#l3.4416"></a><span id="l3.4416">  * @return {number}  the number of selected attachments, or 0 if there are</span>
<a href="#l3.4417"></a><span id="l3.4417">  *                   no attachments selected, no attachments, or no attachmentBucket</span>
<a href="#l3.4418"></a><span id="l3.4418">  */</span>
<a href="#l3.4419"></a><span id="l3.4419" class="difflineminus">-function attachmentsSelectedCount()</span>
<a href="#l3.4420"></a><span id="l3.4420" class="difflineminus">-{</span>
<a href="#l3.4421"></a><span id="l3.4421" class="difflineplus">+function attachmentsSelectedCount() {</span>
<a href="#l3.4422"></a><span id="l3.4422">   let bucketList = GetMsgAttachmentElement();</span>
<a href="#l3.4423"></a><span id="l3.4423">   return (bucketList) ? bucketList.selectedCount : 0;</span>
<a href="#l3.4424"></a><span id="l3.4424"> }</span>
<a href="#l3.4425"></a><span id="l3.4425"> </span>
<a href="#l3.4426"></a><span id="l3.4426"> /**</span>
<a href="#l3.4427"></a><span id="l3.4427">  * Returns a sorted-by-index, &quot;non-live&quot; array of attachment list items.</span>
<a href="#l3.4428"></a><span id="l3.4428">  *</span>
<a href="#l3.4429"></a><span id="l3.4429">  * @param aAscending {boolean}: true (default): sort return array ascending</span>
<a href="#l3.4430"></a><span id="l3.4430" class="difflineat">@@ -4660,18 +4449,17 @@ function attachmentsGetSortedArray(aAsce</span>
<a href="#l3.4431"></a><span id="l3.4431">  * Returns a sorted-by-index, &quot;non-live&quot; array of selected attachment list items.</span>
<a href="#l3.4432"></a><span id="l3.4432">  *</span>
<a href="#l3.4433"></a><span id="l3.4433">  * @param aAscending {boolean}: true (default): sort return array ascending</span>
<a href="#l3.4434"></a><span id="l3.4434">  *                              false         : sort return array descending</span>
<a href="#l3.4435"></a><span id="l3.4435">  * @return {array} an array of selected listitem elements in attachmentBucket</span>
<a href="#l3.4436"></a><span id="l3.4436">  *                 listbox, &quot;non-live&quot; and sorted by their index in the list;</span>
<a href="#l3.4437"></a><span id="l3.4437">  *                 [] if no attachments selected</span>
<a href="#l3.4438"></a><span id="l3.4438">  */</span>
<a href="#l3.4439"></a><span id="l3.4439" class="difflineminus">-function attachmentsSelectionGetSortedArray(aAscending = true)</span>
<a href="#l3.4440"></a><span id="l3.4440" class="difflineminus">-{</span>
<a href="#l3.4441"></a><span id="l3.4441" class="difflineplus">+function attachmentsSelectionGetSortedArray(aAscending = true) {</span>
<a href="#l3.4442"></a><span id="l3.4442">   return attachmentsGetSortedArray(aAscending, true);</span>
<a href="#l3.4443"></a><span id="l3.4443"> }</span>
<a href="#l3.4444"></a><span id="l3.4444"> </span>
<a href="#l3.4445"></a><span id="l3.4445"> /**</span>
<a href="#l3.4446"></a><span id="l3.4446">  * Return true if the selected attachment items are a coherent block in the list,</span>
<a href="#l3.4447"></a><span id="l3.4447">  * otherwise false.</span>
<a href="#l3.4448"></a><span id="l3.4448">  *</span>
<a href="#l3.4449"></a><span id="l3.4449">  * @param aListPosition (optional)  &quot;top&quot;   : Return true only if the block is</span>
<a href="#l3.4450"></a><span id="l3.4450" class="difflineat">@@ -4681,18 +4469,17 @@ function attachmentsSelectionGetSortedAr</span>
<a href="#l3.4451"></a><span id="l3.4451">  * @return {boolean} true : The selected attachment items are a coherent block</span>
<a href="#l3.4452"></a><span id="l3.4452">  *                          (at the list edge if/as specified by 'aListPosition'),</span>
<a href="#l3.4453"></a><span id="l3.4453">  *                          or only 1 item selected.</span>
<a href="#l3.4454"></a><span id="l3.4454">  *                   false: The selected attachment items are NOT a coherent block</span>
<a href="#l3.4455"></a><span id="l3.4455">  *                          (at the list edge if/as specified by 'aListPosition'),</span>
<a href="#l3.4456"></a><span id="l3.4456">  *                          or no attachments selected, or no attachments,</span>
<a href="#l3.4457"></a><span id="l3.4457">  *                          or no attachmentBucket.</span>
<a href="#l3.4458"></a><span id="l3.4458">  */</span>
<a href="#l3.4459"></a><span id="l3.4459" class="difflineminus">-function attachmentsSelectionIsBlock(aListPosition)</span>
<a href="#l3.4460"></a><span id="l3.4460" class="difflineminus">-{</span>
<a href="#l3.4461"></a><span id="l3.4461" class="difflineplus">+function attachmentsSelectionIsBlock(aListPosition) {</span>
<a href="#l3.4462"></a><span id="l3.4462">   let selectedCount = attachmentsSelectedCount();</span>
<a href="#l3.4463"></a><span id="l3.4463">   if (selectedCount &lt; 1)</span>
<a href="#l3.4464"></a><span id="l3.4464">     // No attachments selected, no attachments, or no attachmentBucket.</span>
<a href="#l3.4465"></a><span id="l3.4465">     return false;</span>
<a href="#l3.4466"></a><span id="l3.4466"> </span>
<a href="#l3.4467"></a><span id="l3.4467">   let bucketList = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4468"></a><span id="l3.4468">   let selItems = attachmentsSelectionGetSortedArray();</span>
<a href="#l3.4469"></a><span id="l3.4469">   let indexFirstSelAttachment =</span>
<a href="#l3.4470"></a><span id="l3.4470" class="difflineat">@@ -4710,28 +4497,25 @@ function attachmentsSelectionIsBlock(aLi</span>
<a href="#l3.4471"></a><span id="l3.4471">     // True if selection is a coherent block at the bottom of the list.</span>
<a href="#l3.4472"></a><span id="l3.4472">     return (indexLastSelAttachment == (attachmentsCount() - 1)) &amp;&amp; isBlock;</span>
<a href="#l3.4473"></a><span id="l3.4473">   default:</span>
<a href="#l3.4474"></a><span id="l3.4474">     // True if selection is a coherent block.</span>
<a href="#l3.4475"></a><span id="l3.4475">     return isBlock;</span>
<a href="#l3.4476"></a><span id="l3.4476">   }</span>
<a href="#l3.4477"></a><span id="l3.4477"> }</span>
<a href="#l3.4478"></a><span id="l3.4478"> </span>
<a href="#l3.4479"></a><span id="l3.4479" class="difflineminus">-function AttachPage()</span>
<a href="#l3.4480"></a><span id="l3.4480" class="difflineminus">-{</span>
<a href="#l3.4481"></a><span id="l3.4481" class="difflineminus">-  let result = {value:&quot;http://&quot;};</span>
<a href="#l3.4482"></a><span id="l3.4482" class="difflineplus">+function AttachPage() {</span>
<a href="#l3.4483"></a><span id="l3.4483" class="difflineplus">+  let result = {value: &quot;http://&quot;};</span>
<a href="#l3.4484"></a><span id="l3.4484">   if (Services.prompt.prompt(window,</span>
<a href="#l3.4485"></a><span id="l3.4485">                       getComposeBundle().getString(&quot;attachPageDlogTitle&quot;),</span>
<a href="#l3.4486"></a><span id="l3.4486">                       getComposeBundle().getString(&quot;attachPageDlogMessage&quot;),</span>
<a href="#l3.4487"></a><span id="l3.4487">                       result,</span>
<a href="#l3.4488"></a><span id="l3.4488">                       null,</span>
<a href="#l3.4489"></a><span id="l3.4489" class="difflineminus">-                      {value:0}))</span>
<a href="#l3.4490"></a><span id="l3.4490" class="difflineminus">-  {</span>
<a href="#l3.4491"></a><span id="l3.4491" class="difflineminus">-    if (result.value.length &lt;= &quot;http://&quot;.length)</span>
<a href="#l3.4492"></a><span id="l3.4492" class="difflineminus">-    {</span>
<a href="#l3.4493"></a><span id="l3.4493" class="difflineplus">+                      {value: 0})) {</span>
<a href="#l3.4494"></a><span id="l3.4494" class="difflineplus">+    if (result.value.length &lt;= &quot;http://&quot;.length) {</span>
<a href="#l3.4495"></a><span id="l3.4495">       // Nothing filled, just show the dialog again.</span>
<a href="#l3.4496"></a><span id="l3.4496">       AttachPage();</span>
<a href="#l3.4497"></a><span id="l3.4497">       return;</span>
<a href="#l3.4498"></a><span id="l3.4498">     }</span>
<a href="#l3.4499"></a><span id="l3.4499"> </span>
<a href="#l3.4500"></a><span id="l3.4500">     let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l3.4501"></a><span id="l3.4501">                        .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l3.4502"></a><span id="l3.4502">     attachment.url = result.value;</span>
<a href="#l3.4503"></a><span id="l3.4503" class="difflineat">@@ -4739,47 +4523,42 @@ function AttachPage()</span>
<a href="#l3.4504"></a><span id="l3.4504">   }</span>
<a href="#l3.4505"></a><span id="l3.4505"> }</span>
<a href="#l3.4506"></a><span id="l3.4506"> </span>
<a href="#l3.4507"></a><span id="l3.4507"> /**</span>
<a href="#l3.4508"></a><span id="l3.4508">  * Check if the given fileURL already exists in the attachment bucket.</span>
<a href="#l3.4509"></a><span id="l3.4509">  * @param fileURL the URL (as a String) of the file to check</span>
<a href="#l3.4510"></a><span id="l3.4510">  * @return true if the fileURL is already attached</span>
<a href="#l3.4511"></a><span id="l3.4511">  */</span>
<a href="#l3.4512"></a><span id="l3.4512" class="difflineminus">-function DuplicateFileAlreadyAttached(fileURL)</span>
<a href="#l3.4513"></a><span id="l3.4513" class="difflineminus">-{</span>
<a href="#l3.4514"></a><span id="l3.4514" class="difflineminus">-  var bucket = document.getElementById('attachmentBucket');</span>
<a href="#l3.4515"></a><span id="l3.4515" class="difflineplus">+function DuplicateFileAlreadyAttached(fileURL) {</span>
<a href="#l3.4516"></a><span id="l3.4516" class="difflineplus">+  var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4517"></a><span id="l3.4517">   let rowCount = bucket.getRowCount();</span>
<a href="#l3.4518"></a><span id="l3.4518" class="difflineminus">-  for (let i = 0; i &lt; rowCount; i++)</span>
<a href="#l3.4519"></a><span id="l3.4519" class="difflineminus">-  {</span>
<a href="#l3.4520"></a><span id="l3.4520" class="difflineplus">+  for (let i = 0; i &lt; rowCount; i++) {</span>
<a href="#l3.4521"></a><span id="l3.4521">     let attachment = bucket.getItemAtIndex(i).attachment;</span>
<a href="#l3.4522"></a><span id="l3.4522">     if (attachment &amp;&amp; attachment.url == fileURL)</span>
<a href="#l3.4523"></a><span id="l3.4523">       return true;</span>
<a href="#l3.4524"></a><span id="l3.4524">   }</span>
<a href="#l3.4525"></a><span id="l3.4525">   return false;</span>
<a href="#l3.4526"></a><span id="l3.4526"> }</span>
<a href="#l3.4527"></a><span id="l3.4527"> </span>
<a href="#l3.4528"></a><span id="l3.4528" class="difflineminus">-function Attachments2CompFields(compFields)</span>
<a href="#l3.4529"></a><span id="l3.4529" class="difflineminus">-{</span>
<a href="#l3.4530"></a><span id="l3.4530" class="difflineminus">-  var bucket = document.getElementById('attachmentBucket');</span>
<a href="#l3.4531"></a><span id="l3.4531" class="difflineminus">-</span>
<a href="#l3.4532"></a><span id="l3.4532" class="difflineminus">-  //First, we need to clear all attachment in the compose fields</span>
<a href="#l3.4533"></a><span id="l3.4533" class="difflineplus">+function Attachments2CompFields(compFields) {</span>
<a href="#l3.4534"></a><span id="l3.4534" class="difflineplus">+  var bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4535"></a><span id="l3.4535" class="difflineplus">+</span>
<a href="#l3.4536"></a><span id="l3.4536" class="difflineplus">+  // First, we need to clear all attachment in the compose fields</span>
<a href="#l3.4537"></a><span id="l3.4537">   compFields.removeAttachments();</span>
<a href="#l3.4538"></a><span id="l3.4538"> </span>
<a href="#l3.4539"></a><span id="l3.4539">   let rowCount = bucket.getRowCount();</span>
<a href="#l3.4540"></a><span id="l3.4540" class="difflineminus">-  for (let i = 0; i &lt; rowCount; i++)</span>
<a href="#l3.4541"></a><span id="l3.4541" class="difflineminus">-  {</span>
<a href="#l3.4542"></a><span id="l3.4542" class="difflineplus">+  for (let i = 0; i &lt; rowCount; i++) {</span>
<a href="#l3.4543"></a><span id="l3.4543">     let attachment = bucket.getItemAtIndex(i).attachment;</span>
<a href="#l3.4544"></a><span id="l3.4544">     if (attachment)</span>
<a href="#l3.4545"></a><span id="l3.4545">       compFields.addAttachment(attachment);</span>
<a href="#l3.4546"></a><span id="l3.4546">   }</span>
<a href="#l3.4547"></a><span id="l3.4547"> }</span>
<a href="#l3.4548"></a><span id="l3.4548"> </span>
<a href="#l3.4549"></a><span id="l3.4549" class="difflineminus">-function RemoveAllAttachments()</span>
<a href="#l3.4550"></a><span id="l3.4550" class="difflineminus">-{</span>
<a href="#l3.4551"></a><span id="l3.4551" class="difflineplus">+function RemoveAllAttachments() {</span>
<a href="#l3.4552"></a><span id="l3.4552">   // Ensure that attachment pane is shown before removing all attachments.</span>
<a href="#l3.4553"></a><span id="l3.4553">   toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l3.4554"></a><span id="l3.4554"> </span>
<a href="#l3.4555"></a><span id="l3.4555">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4556"></a><span id="l3.4556">   if (bucket.itemCount == 0)</span>
<a href="#l3.4557"></a><span id="l3.4557">     return;</span>
<a href="#l3.4558"></a><span id="l3.4558"> </span>
<a href="#l3.4559"></a><span id="l3.4559">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.4560"></a><span id="l3.4560" class="difflineat">@@ -4823,31 +4602,29 @@ function RemoveAllAttachments()</span>
<a href="#l3.4561"></a><span id="l3.4561"> </span>
<a href="#l3.4562"></a><span id="l3.4562"> /**</span>
<a href="#l3.4563"></a><span id="l3.4563">  * Show or hide the attachment pane after updating its header bar information</span>
<a href="#l3.4564"></a><span id="l3.4564">  * (number and total file size of attachments) and tooltip.</span>
<a href="#l3.4565"></a><span id="l3.4565">  *</span>
<a href="#l3.4566"></a><span id="l3.4566">  * @param aShowBucket {Boolean} true: show the attachment pane</span>
<a href="#l3.4567"></a><span id="l3.4567">  *                              false (or omitted): hide the attachment pane</span>
<a href="#l3.4568"></a><span id="l3.4568">  */</span>
<a href="#l3.4569"></a><span id="l3.4569" class="difflineminus">-function UpdateAttachmentBucket(aShowBucket)</span>
<a href="#l3.4570"></a><span id="l3.4570" class="difflineminus">-{</span>
<a href="#l3.4571"></a><span id="l3.4571" class="difflineplus">+function UpdateAttachmentBucket(aShowBucket) {</span>
<a href="#l3.4572"></a><span id="l3.4572">   updateAttachmentPane(aShowBucket ? &quot;show&quot; : &quot;hide&quot;);</span>
<a href="#l3.4573"></a><span id="l3.4573"> }</span>
<a href="#l3.4574"></a><span id="l3.4574"> </span>
<a href="#l3.4575"></a><span id="l3.4575"> /**</span>
<a href="#l3.4576"></a><span id="l3.4576">  * Update the header bar information (number and total file size of attachments)</span>
<a href="#l3.4577"></a><span id="l3.4577">  * and tooltip of attachment pane, then (optionally) show or hide the pane.</span>
<a href="#l3.4578"></a><span id="l3.4578">  *</span>
<a href="#l3.4579"></a><span id="l3.4579">  * @param aShowPane {string} &quot;show&quot;:  show the attachment pane</span>
<a href="#l3.4580"></a><span id="l3.4580">  *                           &quot;hide&quot;:  hide the attachment pane</span>
<a href="#l3.4581"></a><span id="l3.4581">  *                           omitted: just update without changing pane visibility</span>
<a href="#l3.4582"></a><span id="l3.4582">  */</span>
<a href="#l3.4583"></a><span id="l3.4583" class="difflineminus">-function updateAttachmentPane(aShowPane)</span>
<a href="#l3.4584"></a><span id="l3.4584" class="difflineminus">-{</span>
<a href="#l3.4585"></a><span id="l3.4585" class="difflineplus">+function updateAttachmentPane(aShowPane) {</span>
<a href="#l3.4586"></a><span id="l3.4586">   let bucket = GetMsgAttachmentElement();</span>
<a href="#l3.4587"></a><span id="l3.4587">   let bucketCountLabel = document.getElementById(&quot;attachmentBucketCount&quot;);</span>
<a href="#l3.4588"></a><span id="l3.4588">   let words = getComposeBundle().getString(&quot;attachmentCount&quot;);</span>
<a href="#l3.4589"></a><span id="l3.4589">   let count = bucket.itemCount;</span>
<a href="#l3.4590"></a><span id="l3.4590">   let countStr = PluralForm.get(count, words).replace(&quot;#1&quot;, count);</span>
<a href="#l3.4591"></a><span id="l3.4591"> </span>
<a href="#l3.4592"></a><span id="l3.4592">   bucketCountLabel.value = countStr;</span>
<a href="#l3.4593"></a><span id="l3.4593">   document.getElementById(&quot;attachmentBucketSize&quot;).value =</span>
<a href="#l3.4594"></a><span id="l3.4594" class="difflineat">@@ -4864,18 +4641,17 @@ function updateAttachmentPane(aShowPane)</span>
<a href="#l3.4595"></a><span id="l3.4595">   // If aShowPane argument is omitted, it's just updating, so we're done.</span>
<a href="#l3.4596"></a><span id="l3.4596">   if (aShowPane === undefined)</span>
<a href="#l3.4597"></a><span id="l3.4597">     return;</span>
<a href="#l3.4598"></a><span id="l3.4598"> </span>
<a href="#l3.4599"></a><span id="l3.4599">   // Otherwise, show or hide the panel per aShowPane argument.</span>
<a href="#l3.4600"></a><span id="l3.4600">   toggleAttachmentPane(aShowPane);</span>
<a href="#l3.4601"></a><span id="l3.4601"> }</span>
<a href="#l3.4602"></a><span id="l3.4602"> </span>
<a href="#l3.4603"></a><span id="l3.4603" class="difflineminus">-function RemoveSelectedAttachment()</span>
<a href="#l3.4604"></a><span id="l3.4604" class="difflineminus">-{</span>
<a href="#l3.4605"></a><span id="l3.4605" class="difflineplus">+function RemoveSelectedAttachment() {</span>
<a href="#l3.4606"></a><span id="l3.4606">   let bucket = GetMsgAttachmentElement();</span>
<a href="#l3.4607"></a><span id="l3.4607">   if (bucket.selectedCount == 0)</span>
<a href="#l3.4608"></a><span id="l3.4608">     return;</span>
<a href="#l3.4609"></a><span id="l3.4609"> </span>
<a href="#l3.4610"></a><span id="l3.4610">   // Remember the current focus index so we can try to restore it when done.</span>
<a href="#l3.4611"></a><span id="l3.4611">   let focusIndex = bucket.currentIndex;</span>
<a href="#l3.4612"></a><span id="l3.4612"> </span>
<a href="#l3.4613"></a><span id="l3.4613">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.4614"></a><span id="l3.4614" class="difflineat">@@ -4908,42 +4684,42 @@ function RemoveSelectedAttachment()</span>
<a href="#l3.4615"></a><span id="l3.4615">     item.remove();</span>
<a href="#l3.4616"></a><span id="l3.4616">   }</span>
<a href="#l3.4617"></a><span id="l3.4617"> </span>
<a href="#l3.4618"></a><span id="l3.4618">   // Bug workaround: Force update of selectedCount and selectedItem, both wrong</span>
<a href="#l3.4619"></a><span id="l3.4619">   // after item removal, to avoid confusion for listening command controllers.</span>
<a href="#l3.4620"></a><span id="l3.4620">   bucket.clearSelection();</span>
<a href="#l3.4621"></a><span id="l3.4621"> </span>
<a href="#l3.4622"></a><span id="l3.4622">   // Try to restore original focus or somewhere close by.</span>
<a href="#l3.4623"></a><span id="l3.4623" class="difflineminus">-  bucket.currentIndex = (focusIndex &lt; bucket.itemCount) ?   // If possible,</span>
<a href="#l3.4624"></a><span id="l3.4624" class="difflineminus">-                        focusIndex   // restore focus at original position;</span>
<a href="#l3.4625"></a><span id="l3.4625" class="difflineminus">-                      : ( (bucket.itemCount &gt; 0) ? // else: if attachments exist,</span>
<a href="#l3.4626"></a><span id="l3.4626" class="difflineminus">-                          (bucket.itemCount - 1)   // focus last item;</span>
<a href="#l3.4627"></a><span id="l3.4627" class="difflineminus">-                        : -1)                      // else: nothing to focus.</span>
<a href="#l3.4628"></a><span id="l3.4628" class="difflineplus">+  if (focusIndex &lt; bucket.itemCount) { // If possible,</span>
<a href="#l3.4629"></a><span id="l3.4629" class="difflineplus">+    bucket.currentIndex = focusIndex;  // restore focus at original position;</span>
<a href="#l3.4630"></a><span id="l3.4630" class="difflineplus">+  } else {</span>
<a href="#l3.4631"></a><span id="l3.4631" class="difflineplus">+    bucket.currentIndex = (bucket.itemCount &gt; 0) ? // else: if attachments exist,</span>
<a href="#l3.4632"></a><span id="l3.4632" class="difflineplus">+                          (bucket.itemCount - 1) : // focus last item;</span>
<a href="#l3.4633"></a><span id="l3.4633" class="difflineplus">+                          -1;                      // else: nothing to focus.</span>
<a href="#l3.4634"></a><span id="l3.4634" class="difflineplus">+  }</span>
<a href="#l3.4635"></a><span id="l3.4635"> </span>
<a href="#l3.4636"></a><span id="l3.4636">   AttachmentsChanged();</span>
<a href="#l3.4637"></a><span id="l3.4637">   dispatchAttachmentBucketEvent(&quot;attachments-removed&quot;, removedAttachments);</span>
<a href="#l3.4638"></a><span id="l3.4638"> }</span>
<a href="#l3.4639"></a><span id="l3.4639"> </span>
<a href="#l3.4640"></a><span id="l3.4640" class="difflineminus">-function RenameSelectedAttachment()</span>
<a href="#l3.4641"></a><span id="l3.4641" class="difflineminus">-{</span>
<a href="#l3.4642"></a><span id="l3.4642" class="difflineplus">+function RenameSelectedAttachment() {</span>
<a href="#l3.4643"></a><span id="l3.4643">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4644"></a><span id="l3.4644">   if (bucket.selectedItems.length != 1)</span>
<a href="#l3.4645"></a><span id="l3.4645">     return; // not one attachment selected</span>
<a href="#l3.4646"></a><span id="l3.4646"> </span>
<a href="#l3.4647"></a><span id="l3.4647">   let item = bucket.getSelectedItem(0);</span>
<a href="#l3.4648"></a><span id="l3.4648">   let attachmentName = {value: item.attachment.name};</span>
<a href="#l3.4649"></a><span id="l3.4649">   if (Services.prompt</span>
<a href="#l3.4650"></a><span id="l3.4650">               .prompt(window,</span>
<a href="#l3.4651"></a><span id="l3.4651">                       getComposeBundle().getString(&quot;renameAttachmentTitle&quot;),</span>
<a href="#l3.4652"></a><span id="l3.4652">                       getComposeBundle().getString(&quot;renameAttachmentMessage&quot;),</span>
<a href="#l3.4653"></a><span id="l3.4653">                       attachmentName,</span>
<a href="#l3.4654"></a><span id="l3.4654">                       null,</span>
<a href="#l3.4655"></a><span id="l3.4655" class="difflineminus">-                      {value: 0}))</span>
<a href="#l3.4656"></a><span id="l3.4656" class="difflineminus">-  {</span>
<a href="#l3.4657"></a><span id="l3.4657" class="difflineplus">+                      {value: 0})) {</span>
<a href="#l3.4658"></a><span id="l3.4658">     if (attachmentName.value == &quot;&quot;)</span>
<a href="#l3.4659"></a><span id="l3.4659">       return; // name was not filled, bail out</span>
<a href="#l3.4660"></a><span id="l3.4660"> </span>
<a href="#l3.4661"></a><span id="l3.4661">     let originalName = item.attachment.name;</span>
<a href="#l3.4662"></a><span id="l3.4662">     item.attachment.name = attachmentName.value;</span>
<a href="#l3.4663"></a><span id="l3.4663">     item.setAttribute(&quot;name&quot;, attachmentName.value);</span>
<a href="#l3.4664"></a><span id="l3.4664"> </span>
<a href="#l3.4665"></a><span id="l3.4665">     gContentChanged = true;</span>
<a href="#l3.4666"></a><span id="l3.4666" class="difflineat">@@ -4969,18 +4745,18 @@ function RenameSelectedAttachment()</span>
<a href="#l3.4667"></a><span id="l3.4667">  * @param aDirection  &quot;up&quot;        : Move attachments up in the list.</span>
<a href="#l3.4668"></a><span id="l3.4668">  *                    &quot;down&quot;      : Move attachments down in the list.</span>
<a href="#l3.4669"></a><span id="l3.4669">  *                    &quot;top&quot;       : Move attachments to the top of the list.</span>
<a href="#l3.4670"></a><span id="l3.4670">  *                    &quot;bottom&quot;    : Move attachments to the bottom of the list.</span>
<a href="#l3.4671"></a><span id="l3.4671">  *                    &quot;bundleUp&quot;  : Move attachments together (upwards).</span>
<a href="#l3.4672"></a><span id="l3.4672">  *                    &quot;bundleDown&quot;: Move attachments together (downwards).</span>
<a href="#l3.4673"></a><span id="l3.4673">  *                    &quot;toggleSort&quot;: Sort attachments alphabetically (toggle).</span>
<a href="#l3.4674"></a><span id="l3.4674">  */</span>
<a href="#l3.4675"></a><span id="l3.4675" class="difflineminus">-function moveSelectedAttachments(aDirection)</span>
<a href="#l3.4676"></a><span id="l3.4676" class="difflineminus">-{</span>
<a href="#l3.4677"></a><span id="l3.4677" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l3.4678"></a><span id="l3.4678" class="difflineplus">+function moveSelectedAttachments(aDirection) {</span>
<a href="#l3.4679"></a><span id="l3.4679">   // Command controllers will bail out if no or all attachments are selected,</span>
<a href="#l3.4680"></a><span id="l3.4680">   // or if block selections can't be moved, or if other direction-specific</span>
<a href="#l3.4681"></a><span id="l3.4681">   // adverse circumstances prevent the intended movement.</span>
<a href="#l3.4682"></a><span id="l3.4682"> </span>
<a href="#l3.4683"></a><span id="l3.4683">   if (!aDirection)</span>
<a href="#l3.4684"></a><span id="l3.4684">     return;</span>
<a href="#l3.4685"></a><span id="l3.4685"> </span>
<a href="#l3.4686"></a><span id="l3.4686">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4687"></a><span id="l3.4687" class="difflineat">@@ -4998,17 +4774,17 @@ function moveSelectedAttachments(aDirect</span>
<a href="#l3.4688"></a><span id="l3.4688">   bucket.currentItem = null;</span>
<a href="#l3.4689"></a><span id="l3.4689">   let upwards;</span>
<a href="#l3.4690"></a><span id="l3.4690">   let targetItem;</span>
<a href="#l3.4691"></a><span id="l3.4691"> </span>
<a href="#l3.4692"></a><span id="l3.4692">   switch (aDirection) {</span>
<a href="#l3.4693"></a><span id="l3.4693">     case &quot;up&quot;:</span>
<a href="#l3.4694"></a><span id="l3.4694">     case &quot;down&quot;:</span>
<a href="#l3.4695"></a><span id="l3.4695">       // Move selected attachments upwards/downwards.</span>
<a href="#l3.4696"></a><span id="l3.4696" class="difflineminus">-      upwards = (aDirection == &quot;up&quot;) ? true : false;</span>
<a href="#l3.4697"></a><span id="l3.4697" class="difflineplus">+      upwards = aDirection == &quot;up&quot;;</span>
<a href="#l3.4698"></a><span id="l3.4698">       let blockItems = [];</span>
<a href="#l3.4699"></a><span id="l3.4699"> </span>
<a href="#l3.4700"></a><span id="l3.4700">       for (let item of selItems) {</span>
<a href="#l3.4701"></a><span id="l3.4701">         // Handle adjacent selected items en block, via blockItems array.</span>
<a href="#l3.4702"></a><span id="l3.4702">         blockItems.push(item); // Add current selItem to blockItems.</span>
<a href="#l3.4703"></a><span id="l3.4703">         let nextItem = item.nextSibling;</span>
<a href="#l3.4704"></a><span id="l3.4704">         if (!nextItem || !nextItem.selected) {</span>
<a href="#l3.4705"></a><span id="l3.4705">           // If current selItem is the last blockItem, check out its adjacent</span>
<a href="#l3.4706"></a><span id="l3.4706" class="difflineat">@@ -5042,33 +4818,34 @@ function moveSelectedAttachments(aDirect</span>
<a href="#l3.4707"></a><span id="l3.4707">         // Add next selItem to the block and see if that's the end of the block.</span>
<a href="#l3.4708"></a><span id="l3.4708">       } // Next selItem.</span>
<a href="#l3.4709"></a><span id="l3.4709"> </span>
<a href="#l3.4710"></a><span id="l3.4710">       // Ensure helpful visibility of moved items (scroll into view if needed):</span>
<a href="#l3.4711"></a><span id="l3.4711">       // If first item of selection is now at the top, first list item.</span>
<a href="#l3.4712"></a><span id="l3.4712">       // Else if last item of selection is now at the bottom, last list item.</span>
<a href="#l3.4713"></a><span id="l3.4713">       // Otherwise, let's see where we are going by ensuring visibility of the</span>
<a href="#l3.4714"></a><span id="l3.4714">       // nearest unselected sibling of selection according to direction of move.</span>
<a href="#l3.4715"></a><span id="l3.4715" class="difflineminus">-      visibleIndex = (bucket.getIndexOfItem(selItems[0]) == 0) ? 0</span>
<a href="#l3.4716"></a><span id="l3.4716" class="difflineminus">-                   : ((bucket.getIndexOfItem(selItems[selItems.length - 1]) ==</span>
<a href="#l3.4717"></a><span id="l3.4717" class="difflineminus">-                       (bucket.itemCount - 1)) ?</span>
<a href="#l3.4718"></a><span id="l3.4718" class="difflineminus">-                       (bucket.itemCount - 1)</span>
<a href="#l3.4719"></a><span id="l3.4719" class="difflineminus">-                     : (upwards ? bucket.getIndexOfItem(selItems[0].previousSibling)</span>
<a href="#l3.4720"></a><span id="l3.4720" class="difflineminus">-                       : bucket.getIndexOfItem(selItems[selItems.length - 1].nextSibling)</span>
<a href="#l3.4721"></a><span id="l3.4721" class="difflineminus">-                       )</span>
<a href="#l3.4722"></a><span id="l3.4722" class="difflineminus">-                     );</span>
<a href="#l3.4723"></a><span id="l3.4723" class="difflineplus">+      if (bucket.getIndexOfItem(selItems[0]) == 0) {</span>
<a href="#l3.4724"></a><span id="l3.4724" class="difflineplus">+        visibleIndex = 0;</span>
<a href="#l3.4725"></a><span id="l3.4725" class="difflineplus">+      } else if (bucket.getIndexOfItem(selItems[selItems.length - 1]) == (bucket.itemCount - 1)) {</span>
<a href="#l3.4726"></a><span id="l3.4726" class="difflineplus">+        visibleIndex = bucket.itemCount - 1;</span>
<a href="#l3.4727"></a><span id="l3.4727" class="difflineplus">+      } else if (upwards) {</span>
<a href="#l3.4728"></a><span id="l3.4728" class="difflineplus">+        visibleIndex = bucket.getIndexOfItem(selItems[0].previousSibling);</span>
<a href="#l3.4729"></a><span id="l3.4729" class="difflineplus">+      } else {</span>
<a href="#l3.4730"></a><span id="l3.4730" class="difflineplus">+        visibleIndex = bucket.getIndexOfItem(selItems[selItems.length - 1].nextSibling);</span>
<a href="#l3.4731"></a><span id="l3.4731" class="difflineplus">+      }</span>
<a href="#l3.4732"></a><span id="l3.4732">       break;</span>
<a href="#l3.4733"></a><span id="l3.4733"> </span>
<a href="#l3.4734"></a><span id="l3.4734">     case &quot;top&quot;:</span>
<a href="#l3.4735"></a><span id="l3.4735">     case &quot;bottom&quot;:</span>
<a href="#l3.4736"></a><span id="l3.4736">     case &quot;bundleUp&quot;:</span>
<a href="#l3.4737"></a><span id="l3.4737">     case &quot;bundleDown&quot;:</span>
<a href="#l3.4738"></a><span id="l3.4738">       // Bundle selected attachments to top/bottom of the list or upwards/downwards.</span>
<a href="#l3.4739"></a><span id="l3.4739"> </span>
<a href="#l3.4740"></a><span id="l3.4740" class="difflineminus">-      upwards = ([&quot;top&quot;, &quot;bundleUp&quot;].includes(aDirection)) ? true : false;</span>
<a href="#l3.4741"></a><span id="l3.4741" class="difflineplus">+      upwards = [&quot;top&quot;, &quot;bundleUp&quot;].includes(aDirection);</span>
<a href="#l3.4742"></a><span id="l3.4742">       // Downwards: Reverse order of selItems so we can use the same algorithm.</span>
<a href="#l3.4743"></a><span id="l3.4743">       if (!upwards)</span>
<a href="#l3.4744"></a><span id="l3.4744">         selItems.reverse();</span>
<a href="#l3.4745"></a><span id="l3.4745"> </span>
<a href="#l3.4746"></a><span id="l3.4746">       if ([&quot;top&quot;, &quot;bottom&quot;].includes(aDirection)) {</span>
<a href="#l3.4747"></a><span id="l3.4747">         let listEdgeItem = bucket.getItemAtIndex(upwards ? 0 : bucket.itemCount - 1);</span>
<a href="#l3.4748"></a><span id="l3.4748">         let selEdgeItem = selItems[0];</span>
<a href="#l3.4749"></a><span id="l3.4749">         if (selEdgeItem != listEdgeItem) {</span>
<a href="#l3.4750"></a><span id="l3.4750" class="difflineat">@@ -5190,16 +4967,17 @@ function moveSelectedAttachments(aDirect</span>
<a href="#l3.4751"></a><span id="l3.4751">   bucket.currentItem = focusItem;</span>
<a href="#l3.4752"></a><span id="l3.4752">   // Ensure smart visibility of a relevant item according to direction.</span>
<a href="#l3.4753"></a><span id="l3.4753">   bucket.ensureIndexIsVisible(visibleIndex);</span>
<a href="#l3.4754"></a><span id="l3.4754"> </span>
<a href="#l3.4755"></a><span id="l3.4755">   // Moving selected items around does not trigger auto-updating of our command</span>
<a href="#l3.4756"></a><span id="l3.4756">   // handlers, so we must do it now as the position of selected items has changed.</span>
<a href="#l3.4757"></a><span id="l3.4757">   updateReorderAttachmentsItems();</span>
<a href="#l3.4758"></a><span id="l3.4758"> }</span>
<a href="#l3.4759"></a><span id="l3.4759" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l3.4760"></a><span id="l3.4760"> </span>
<a href="#l3.4761"></a><span id="l3.4761"> function keyToggleAttachmentPaneOnCommand() {</span>
<a href="#l3.4762"></a><span id="l3.4762">   // For easy and efficient UX with (access key == command key), remember that</span>
<a href="#l3.4763"></a><span id="l3.4763">   // we're coming from key_toggleAttachmentPane before going into command handling.</span>
<a href="#l3.4764"></a><span id="l3.4764">   document.getElementById(&quot;cmd_toggleAttachmentPane&quot;).setAttribute(&quot;eventsource&quot;,</span>
<a href="#l3.4765"></a><span id="l3.4765">                                                                    &quot;key&quot;);</span>
<a href="#l3.4766"></a><span id="l3.4766">   goDoCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.4767"></a><span id="l3.4767"> }</span>
<a href="#l3.4768"></a><span id="l3.4768" class="difflineat">@@ -5226,17 +5004,17 @@ function toggleAttachmentPane(aAction = </span>
<a href="#l3.4769"></a><span id="l3.4769">       // If attachment pane is currently shown:</span>
<a href="#l3.4770"></a><span id="l3.4770">       if (!bucketHasFocus &amp;&amp; eventSource == &quot;key&quot;) {</span>
<a href="#l3.4771"></a><span id="l3.4771">         // If we get here via key_toggleAttachmentPane, here's where we mimick</span>
<a href="#l3.4772"></a><span id="l3.4772">         // access key functionality: First focus the pane if it isn't focused yet.</span>
<a href="#l3.4773"></a><span id="l3.4773">         bucket.focus();</span>
<a href="#l3.4774"></a><span id="l3.4774">       } else {</span>
<a href="#l3.4775"></a><span id="l3.4775">         // If bucket has focus, or if we get here via menu-click or header-click,</span>
<a href="#l3.4776"></a><span id="l3.4776">         // just toggle.</span>
<a href="#l3.4777"></a><span id="l3.4777" class="difflineminus">-        aAction = &quot;hide&quot;</span>
<a href="#l3.4778"></a><span id="l3.4778" class="difflineplus">+        aAction = &quot;hide&quot;;</span>
<a href="#l3.4779"></a><span id="l3.4779">       }</span>
<a href="#l3.4780"></a><span id="l3.4780">     } else {</span>
<a href="#l3.4781"></a><span id="l3.4781">       // If attachment pane is currently hidden, show it.</span>
<a href="#l3.4782"></a><span id="l3.4782">       aAction = &quot;show&quot;;</span>
<a href="#l3.4783"></a><span id="l3.4783">     }</span>
<a href="#l3.4784"></a><span id="l3.4784">   }</span>
<a href="#l3.4785"></a><span id="l3.4785"> </span>
<a href="#l3.4786"></a><span id="l3.4786">   switch (aAction) {</span>
<a href="#l3.4787"></a><span id="l3.4787" class="difflineat">@@ -5281,17 +5059,17 @@ function showReorderAttachmentsPanel() {</span>
<a href="#l3.4788"></a><span id="l3.4788">  *</span>
<a href="#l3.4789"></a><span id="l3.4789">  * @return {string} &quot;ascending&quot; : Sort order is ascending.</span>
<a href="#l3.4790"></a><span id="l3.4790">  *                  &quot;descending&quot;: Sort order is descending.</span>
<a href="#l3.4791"></a><span id="l3.4791">  *                  &quot;equivalent&quot;: The names of all selected items are equivalent.</span>
<a href="#l3.4792"></a><span id="l3.4792">  *                  &quot;&quot;          : There's no sort order, or only 1 item selected,</span>
<a href="#l3.4793"></a><span id="l3.4793">  *                                or no items selected, or no attachments,</span>
<a href="#l3.4794"></a><span id="l3.4794">  *                                or no attachmentBucket.</span>
<a href="#l3.4795"></a><span id="l3.4795">  */</span>
<a href="#l3.4796"></a><span id="l3.4796" class="difflineminus">-function attachmentsSelectionGetSortOrder(){</span>
<a href="#l3.4797"></a><span id="l3.4797" class="difflineplus">+function attachmentsSelectionGetSortOrder() {</span>
<a href="#l3.4798"></a><span id="l3.4798">   return attachmentsGetSortOrder(true);</span>
<a href="#l3.4799"></a><span id="l3.4799"> }</span>
<a href="#l3.4800"></a><span id="l3.4800"> </span>
<a href="#l3.4801"></a><span id="l3.4801"> /**</span>
<a href="#l3.4802"></a><span id="l3.4802">  * Returns a string representing the current sort order of attachment items</span>
<a href="#l3.4803"></a><span id="l3.4803">  * by their names.</span>
<a href="#l3.4804"></a><span id="l3.4804">  *</span>
<a href="#l3.4805"></a><span id="l3.4805">  * @param aSelectedOnly {boolean}: true: return sort order of selected items only.</span>
<a href="#l3.4806"></a><span id="l3.4806" class="difflineat">@@ -5299,17 +5077,17 @@ function attachmentsSelectionGetSortOrde</span>
<a href="#l3.4807"></a><span id="l3.4807">  *</span>
<a href="#l3.4808"></a><span id="l3.4808">  * @return {string} &quot;ascending&quot; : Sort order is ascending.</span>
<a href="#l3.4809"></a><span id="l3.4809">  *                  &quot;descending&quot;: Sort order is descending.</span>
<a href="#l3.4810"></a><span id="l3.4810">  *                  &quot;equivalent&quot;: The names of the items are equivalent.</span>
<a href="#l3.4811"></a><span id="l3.4811">  *                  &quot;&quot;          : There's no sort order, or no attachments,</span>
<a href="#l3.4812"></a><span id="l3.4812">  *                                or no attachmentBucket; or (with aSelectedOnly),</span>
<a href="#l3.4813"></a><span id="l3.4813">  *                                only 1 item selected, or no items selected.</span>
<a href="#l3.4814"></a><span id="l3.4814">  */</span>
<a href="#l3.4815"></a><span id="l3.4815" class="difflineminus">-function attachmentsGetSortOrder(aSelectedOnly = false){</span>
<a href="#l3.4816"></a><span id="l3.4816" class="difflineplus">+function attachmentsGetSortOrder(aSelectedOnly = false) {</span>
<a href="#l3.4817"></a><span id="l3.4817">   let listItems;</span>
<a href="#l3.4818"></a><span id="l3.4818">   if (aSelectedOnly) {</span>
<a href="#l3.4819"></a><span id="l3.4819">     if (attachmentsSelectedCount() &lt;= 1)</span>
<a href="#l3.4820"></a><span id="l3.4820">       return &quot;&quot;;</span>
<a href="#l3.4821"></a><span id="l3.4821"> </span>
<a href="#l3.4822"></a><span id="l3.4822">     listItems = attachmentsSelectionGetSortedArray();</span>
<a href="#l3.4823"></a><span id="l3.4823">   } else { // aSelectedOnly == false</span>
<a href="#l3.4824"></a><span id="l3.4824">     if (attachmentsCount() &lt; 1)</span>
<a href="#l3.4825"></a><span id="l3.4825" class="difflineat">@@ -5350,17 +5128,17 @@ function reorderAttachmentsPanelOnPopupS</span>
<a href="#l3.4826"></a><span id="l3.4826">   let panel = document.getElementById(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l3.4827"></a><span id="l3.4827">   let buttonsNodeList = panel.querySelectorAll(&quot;.panelButton&quot;);</span>
<a href="#l3.4828"></a><span id="l3.4828">   let buttons = [...buttonsNodeList]; // convert NodeList to Array</span>
<a href="#l3.4829"></a><span id="l3.4829">   // Let's add some pretty keyboard shortcuts to the buttons.</span>
<a href="#l3.4830"></a><span id="l3.4830">   buttons.forEach(btn =&gt; {</span>
<a href="#l3.4831"></a><span id="l3.4831">     if (btn.hasAttribute(&quot;key&quot;)) {</span>
<a href="#l3.4832"></a><span id="l3.4832">       btn.setAttribute(&quot;prettykey&quot;, getPrettyKey(btn.getAttribute(&quot;key&quot;)));</span>
<a href="#l3.4833"></a><span id="l3.4833">     }</span>
<a href="#l3.4834"></a><span id="l3.4834" class="difflineminus">-  })</span>
<a href="#l3.4835"></a><span id="l3.4835" class="difflineplus">+  });</span>
<a href="#l3.4836"></a><span id="l3.4836">   // Focus attachment bucket to activate attachmentBucketController, which is</span>
<a href="#l3.4837"></a><span id="l3.4837">   // required for updating the reorder commands.</span>
<a href="#l3.4838"></a><span id="l3.4838">   document.getElementById(&quot;attachmentBucket&quot;).focus();</span>
<a href="#l3.4839"></a><span id="l3.4839">   // We're updating commands before showing the panel so that button states</span>
<a href="#l3.4840"></a><span id="l3.4840">   // don't change after the panel is shown, and also because focus is still</span>
<a href="#l3.4841"></a><span id="l3.4841">   // in attachment bucket right now, which is required for updating them.</span>
<a href="#l3.4842"></a><span id="l3.4842">   updateReorderAttachmentsItems();</span>
<a href="#l3.4843"></a><span id="l3.4843"> }</span>
<a href="#l3.4844"></a><span id="l3.4844" class="difflineat">@@ -5447,18 +5225,17 @@ function attachmentBucketOnKeyPress(aEve</span>
<a href="#l3.4845"></a><span id="l3.4845">       goDoCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.4846"></a><span id="l3.4846">   }</span>
<a href="#l3.4847"></a><span id="l3.4847"> }</span>
<a href="#l3.4848"></a><span id="l3.4848"> </span>
<a href="#l3.4849"></a><span id="l3.4849"> function attachmentBucketOnDragStart(aEvent) {</span>
<a href="#l3.4850"></a><span id="l3.4850">   nsDragAndDrop.startDrag(aEvent, attachmentBucketDNDObserver);</span>
<a href="#l3.4851"></a><span id="l3.4851"> }</span>
<a href="#l3.4852"></a><span id="l3.4852"> </span>
<a href="#l3.4853"></a><span id="l3.4853" class="difflineminus">-function attachmentBucketOnClick(aEvent)</span>
<a href="#l3.4854"></a><span id="l3.4854" class="difflineminus">-{</span>
<a href="#l3.4855"></a><span id="l3.4855" class="difflineplus">+function attachmentBucketOnClick(aEvent) {</span>
<a href="#l3.4856"></a><span id="l3.4856">   // Handle click on attachment pane whitespace:</span>
<a href="#l3.4857"></a><span id="l3.4857">   // - With selected attachments, clear selection first.</span>
<a href="#l3.4858"></a><span id="l3.4858">   // - Otherwise, e.g. on a plain empty bucket, show 'Attach File(s)' dialog.</span>
<a href="#l3.4859"></a><span id="l3.4859">   if (attachmentsSelectedCount() == 0) {</span>
<a href="#l3.4860"></a><span id="l3.4860">     let boundTarget = document.getBindingParent(aEvent.originalTarget);</span>
<a href="#l3.4861"></a><span id="l3.4861">     if (aEvent.button == 0 &amp;&amp; boundTarget &amp;&amp; boundTarget.localName == &quot;scrollbox&quot;)</span>
<a href="#l3.4862"></a><span id="l3.4862">       goDoCommand(&quot;cmd_attachFile&quot;);</span>
<a href="#l3.4863"></a><span id="l3.4863">   }</span>
<a href="#l3.4864"></a><span id="l3.4864" class="difflineat">@@ -5466,24 +5243,23 @@ function attachmentBucketOnClick(aEvent)</span>
<a href="#l3.4865"></a><span id="l3.4865"> </span>
<a href="#l3.4866"></a><span id="l3.4866"> function attachmentBucketOnSelect() {</span>
<a href="#l3.4867"></a><span id="l3.4867">   attachmentBucketUpdateTooltips();</span>
<a href="#l3.4868"></a><span id="l3.4868">   updateAttachmentItems();</span>
<a href="#l3.4869"></a><span id="l3.4869"> }</span>
<a href="#l3.4870"></a><span id="l3.4870"> </span>
<a href="#l3.4871"></a><span id="l3.4871"> function attachmentBucketUpdateTooltips() {</span>
<a href="#l3.4872"></a><span id="l3.4872">   let bucket = GetMsgAttachmentElement();</span>
<a href="#l3.4873"></a><span id="l3.4873" class="difflineminus">-  let bucketHeader = document.getElementById(&quot;attachments-header-box&quot;);</span>
<a href="#l3.4874"></a><span id="l3.4874"> </span>
<a href="#l3.4875"></a><span id="l3.4875">   // Attachment pane whitespace tooltip</span>
<a href="#l3.4876"></a><span id="l3.4876">   if (attachmentsSelectedCount() &gt; 0) {</span>
<a href="#l3.4877"></a><span id="l3.4877" class="difflineminus">-    bucket.tooltipText=</span>
<a href="#l3.4878"></a><span id="l3.4878" class="difflineplus">+    bucket.tooltipText =</span>
<a href="#l3.4879"></a><span id="l3.4879">       getComposeBundle().getString(&quot;attachmentBucketClearSelectionTooltip&quot;);</span>
<a href="#l3.4880"></a><span id="l3.4880">   } else {</span>
<a href="#l3.4881"></a><span id="l3.4881" class="difflineminus">-    bucket.tooltipText=</span>
<a href="#l3.4882"></a><span id="l3.4882" class="difflineplus">+    bucket.tooltipText =</span>
<a href="#l3.4883"></a><span id="l3.4883">       getComposeBundle().getString(&quot;attachmentBucketAttachFilesTooltip&quot;);</span>
<a href="#l3.4884"></a><span id="l3.4884">   }</span>
<a href="#l3.4885"></a><span id="l3.4885"> }</span>
<a href="#l3.4886"></a><span id="l3.4886"> </span>
<a href="#l3.4887"></a><span id="l3.4887"> function attachmentBucketHeaderOnClick(aEvent) {</span>
<a href="#l3.4888"></a><span id="l3.4888">   if (aEvent.button == 0) {</span>
<a href="#l3.4889"></a><span id="l3.4889">     // Left click</span>
<a href="#l3.4890"></a><span id="l3.4890">     goDoCommand(&quot;cmd_toggleAttachmentPane&quot;);</span>
<a href="#l3.4891"></a><span id="l3.4891" class="difflineat">@@ -5497,169 +5273,150 @@ function attachmentBucketCloseButtonOnCo</span>
<a href="#l3.4892"></a><span id="l3.4892"> function attachmentBucketSizerOnMouseUp() {</span>
<a href="#l3.4893"></a><span id="l3.4893">   updateViewItems();</span>
<a href="#l3.4894"></a><span id="l3.4894">   if (document.getElementById(&quot;attachments-box&quot;).collapsed) {</span>
<a href="#l3.4895"></a><span id="l3.4895">     // If user collapsed the attachment pane, move focus to message body.</span>
<a href="#l3.4896"></a><span id="l3.4896">     SetMsgBodyFrameFocus();</span>
<a href="#l3.4897"></a><span id="l3.4897">   }</span>
<a href="#l3.4898"></a><span id="l3.4898"> }</span>
<a href="#l3.4899"></a><span id="l3.4899"> </span>
<a href="#l3.4900"></a><span id="l3.4900" class="difflineminus">-function AttachmentElementHasItems()</span>
<a href="#l3.4901"></a><span id="l3.4901" class="difflineminus">-{</span>
<a href="#l3.4902"></a><span id="l3.4902" class="difflineplus">+function AttachmentElementHasItems() {</span>
<a href="#l3.4903"></a><span id="l3.4903">   var element = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4904"></a><span id="l3.4904">   return element ? (element.getRowCount() &gt; 0) : false;</span>
<a href="#l3.4905"></a><span id="l3.4905"> }</span>
<a href="#l3.4906"></a><span id="l3.4906"> </span>
<a href="#l3.4907"></a><span id="l3.4907"> function attachmentBucketMarkEmptyBucket() {</span>
<a href="#l3.4908"></a><span id="l3.4908">   let attachmentBucket = GetMsgAttachmentElement();</span>
<a href="#l3.4909"></a><span id="l3.4909">   let attachmentsBox = document.getElementById(&quot;attachments-box&quot;);</span>
<a href="#l3.4910"></a><span id="l3.4910">   if (attachmentBucket.itemCount &gt; 0) {</span>
<a href="#l3.4911"></a><span id="l3.4911">     attachmentsBox.removeAttribute(&quot;empty&quot;);</span>
<a href="#l3.4912"></a><span id="l3.4912">   } else {</span>
<a href="#l3.4913"></a><span id="l3.4913">     attachmentsBox.setAttribute(&quot;empty&quot;, &quot;true&quot;);</span>
<a href="#l3.4914"></a><span id="l3.4914">   }</span>
<a href="#l3.4915"></a><span id="l3.4915"> }</span>
<a href="#l3.4916"></a><span id="l3.4916"> </span>
<a href="#l3.4917"></a><span id="l3.4917" class="difflineminus">-function OpenSelectedAttachment()</span>
<a href="#l3.4918"></a><span id="l3.4918" class="difflineminus">-{</span>
<a href="#l3.4919"></a><span id="l3.4919" class="difflineplus">+function OpenSelectedAttachment() {</span>
<a href="#l3.4920"></a><span id="l3.4920">   let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.4921"></a><span id="l3.4921" class="difflineminus">-  if (bucket.selectedItems.length == 1)</span>
<a href="#l3.4922"></a><span id="l3.4922" class="difflineminus">-  {</span>
<a href="#l3.4923"></a><span id="l3.4923" class="difflineplus">+  if (bucket.selectedItems.length == 1) {</span>
<a href="#l3.4924"></a><span id="l3.4924">     let attachmentUrl = bucket.getSelectedItem(0).attachment.url;</span>
<a href="#l3.4925"></a><span id="l3.4925"> </span>
<a href="#l3.4926"></a><span id="l3.4926">     let messagePrefix = /^mailbox-message:|^imap-message:|^news-message:/i;</span>
<a href="#l3.4927"></a><span id="l3.4927" class="difflineminus">-    if (messagePrefix.test(attachmentUrl))</span>
<a href="#l3.4928"></a><span id="l3.4928" class="difflineminus">-    {</span>
<a href="#l3.4929"></a><span id="l3.4929" class="difflineplus">+    if (messagePrefix.test(attachmentUrl)) {</span>
<a href="#l3.4930"></a><span id="l3.4930">       // we must be dealing with a forwarded attachment, treat this special</span>
<a href="#l3.4931"></a><span id="l3.4931">       let msgHdr = gMessenger.messageServiceFromURI(attachmentUrl).messageURIToMsgHdr(attachmentUrl);</span>
<a href="#l3.4932"></a><span id="l3.4932">       if (msgHdr)</span>
<a href="#l3.4933"></a><span id="l3.4933">         MailUtils.openMessageInNewWindow(msgHdr);</span>
<a href="#l3.4934"></a><span id="l3.4934" class="difflineminus">-    }</span>
<a href="#l3.4935"></a><span id="l3.4935" class="difflineminus">-    else</span>
<a href="#l3.4936"></a><span id="l3.4936" class="difflineminus">-    {</span>
<a href="#l3.4937"></a><span id="l3.4937" class="difflineplus">+    } else {</span>
<a href="#l3.4938"></a><span id="l3.4938">       // Turn the URL into a nsIURI object then open it.</span>
<a href="#l3.4939"></a><span id="l3.4939">       let uri = Services.io.newURI(attachmentUrl);</span>
<a href="#l3.4940"></a><span id="l3.4940" class="difflineminus">-      if (uri)</span>
<a href="#l3.4941"></a><span id="l3.4941" class="difflineminus">-      {</span>
<a href="#l3.4942"></a><span id="l3.4942" class="difflineplus">+      if (uri) {</span>
<a href="#l3.4943"></a><span id="l3.4943">         let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l3.4944"></a><span id="l3.4944">                                                      null,</span>
<a href="#l3.4945"></a><span id="l3.4945">                                                      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l3.4946"></a><span id="l3.4946">                                                      null,</span>
<a href="#l3.4947"></a><span id="l3.4947">                                                      Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l3.4948"></a><span id="l3.4948">                                                      Ci.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l3.4949"></a><span id="l3.4949" class="difflineminus">-        if (channel)</span>
<a href="#l3.4950"></a><span id="l3.4950" class="difflineminus">-        {</span>
<a href="#l3.4951"></a><span id="l3.4951" class="difflineplus">+        if (channel) {</span>
<a href="#l3.4952"></a><span id="l3.4952">           let uriLoader = Cc[&quot;@mozilla.org/uriloader;1&quot;].getService(Ci.nsIURILoader);</span>
<a href="#l3.4953"></a><span id="l3.4953">           uriLoader.openURI(channel, true, new nsAttachmentOpener());</span>
<a href="#l3.4954"></a><span id="l3.4954">         }</span>
<a href="#l3.4955"></a><span id="l3.4955">       }</span>
<a href="#l3.4956"></a><span id="l3.4956">     }</span>
<a href="#l3.4957"></a><span id="l3.4957">   } // if one attachment selected</span>
<a href="#l3.4958"></a><span id="l3.4958"> }</span>
<a href="#l3.4959"></a><span id="l3.4959"> </span>
<a href="#l3.4960"></a><span id="l3.4960" class="difflineminus">-function nsAttachmentOpener()</span>
<a href="#l3.4961"></a><span id="l3.4961" class="difflineminus">-{</span>
<a href="#l3.4962"></a><span id="l3.4962" class="difflineminus">-}</span>
<a href="#l3.4963"></a><span id="l3.4963" class="difflineminus">-</span>
<a href="#l3.4964"></a><span id="l3.4964" class="difflineminus">-nsAttachmentOpener.prototype =</span>
<a href="#l3.4965"></a><span id="l3.4965" class="difflineminus">-{</span>
<a href="#l3.4966"></a><span id="l3.4966" class="difflineplus">+function nsAttachmentOpener() {</span>
<a href="#l3.4967"></a><span id="l3.4967" class="difflineplus">+}</span>
<a href="#l3.4968"></a><span id="l3.4968" class="difflineplus">+</span>
<a href="#l3.4969"></a><span id="l3.4969" class="difflineplus">+nsAttachmentOpener.prototype = {</span>
<a href="#l3.4970"></a><span id="l3.4970">   QueryInterface: ChromeUtils.generateQI([&quot;nsIURIContentListener&quot;,</span>
<a href="#l3.4971"></a><span id="l3.4971">                                           &quot;nsIInterfaceRequestor&quot;]),</span>
<a href="#l3.4972"></a><span id="l3.4972"> </span>
<a href="#l3.4973"></a><span id="l3.4973" class="difflineminus">-  onStartURIOpen: function(uri)</span>
<a href="#l3.4974"></a><span id="l3.4974" class="difflineminus">-  {</span>
<a href="#l3.4975"></a><span id="l3.4975" class="difflineplus">+  onStartURIOpen(uri) {</span>
<a href="#l3.4976"></a><span id="l3.4976">     return false;</span>
<a href="#l3.4977"></a><span id="l3.4977">   },</span>
<a href="#l3.4978"></a><span id="l3.4978"> </span>
<a href="#l3.4979"></a><span id="l3.4979" class="difflineminus">-  doContent: function(contentType, isContentPreferred, request, contentHandler)</span>
<a href="#l3.4980"></a><span id="l3.4980" class="difflineminus">-  {</span>
<a href="#l3.4981"></a><span id="l3.4981" class="difflineplus">+  doContent(contentType, isContentPreferred, request, contentHandler) {</span>
<a href="#l3.4982"></a><span id="l3.4982">     // If we came here to display an attached message, make sure we provide a type.</span>
<a href="#l3.4983"></a><span id="l3.4983">     if (/[?&amp;]part=/i.test(request.URI.query)) {</span>
<a href="#l3.4984"></a><span id="l3.4984">       let newQuery = request.URI.query + &quot;&amp;type=message/rfc822&quot;;</span>
<a href="#l3.4985"></a><span id="l3.4985">       request.URI = request.URI.mutate().setQuery(newQuery).finalize();</span>
<a href="#l3.4986"></a><span id="l3.4986">     }</span>
<a href="#l3.4987"></a><span id="l3.4987">     let newHandler = Cc[&quot;@mozilla.org/uriloader/content-handler;1?type=application/x-message-display&quot;]</span>
<a href="#l3.4988"></a><span id="l3.4988">                        .createInstance(Ci.nsIContentHandler);</span>
<a href="#l3.4989"></a><span id="l3.4989">     newHandler.handleContent(&quot;application/x-message-display&quot;, this, request);</span>
<a href="#l3.4990"></a><span id="l3.4990">     return true;</span>
<a href="#l3.4991"></a><span id="l3.4991">   },</span>
<a href="#l3.4992"></a><span id="l3.4992"> </span>
<a href="#l3.4993"></a><span id="l3.4993" class="difflineminus">-  isPreferred: function(contentType, desiredContentType)</span>
<a href="#l3.4994"></a><span id="l3.4994" class="difflineminus">-  {</span>
<a href="#l3.4995"></a><span id="l3.4995" class="difflineplus">+  isPreferred(contentType, desiredContentType) {</span>
<a href="#l3.4996"></a><span id="l3.4996">     if (contentType == &quot;message/rfc822&quot;)</span>
<a href="#l3.4997"></a><span id="l3.4997">       return true;</span>
<a href="#l3.4998"></a><span id="l3.4998">     return false;</span>
<a href="#l3.4999"></a><span id="l3.4999">   },</span>
<a href="#l3.5000"></a><span id="l3.5000"> </span>
<a href="#l3.5001"></a><span id="l3.5001" class="difflineminus">-  canHandleContent: function(contentType, isContentPreferred, desiredContentType)</span>
<a href="#l3.5002"></a><span id="l3.5002" class="difflineminus">-  {</span>
<a href="#l3.5003"></a><span id="l3.5003" class="difflineplus">+  canHandleContent(contentType, isContentPreferred, desiredContentType) {</span>
<a href="#l3.5004"></a><span id="l3.5004">     return false;</span>
<a href="#l3.5005"></a><span id="l3.5005">   },</span>
<a href="#l3.5006"></a><span id="l3.5006"> </span>
<a href="#l3.5007"></a><span id="l3.5007" class="difflineminus">-  getInterface: function(iid)</span>
<a href="#l3.5008"></a><span id="l3.5008" class="difflineminus">-  {</span>
<a href="#l3.5009"></a><span id="l3.5009" class="difflineplus">+  getInterface(iid) {</span>
<a href="#l3.5010"></a><span id="l3.5010">     if (iid.equals(Ci.nsIDOMWindow)) {</span>
<a href="#l3.5011"></a><span id="l3.5011">       return window;</span>
<a href="#l3.5012"></a><span id="l3.5012" class="difflineminus">-    } else if (iid.equals(Ci.nsIDocShell)) {</span>
<a href="#l3.5013"></a><span id="l3.5013" class="difflineplus">+    }</span>
<a href="#l3.5014"></a><span id="l3.5014" class="difflineplus">+    if (iid.equals(Ci.nsIDocShell)) {</span>
<a href="#l3.5015"></a><span id="l3.5015">       return window.docShell;</span>
<a href="#l3.5016"></a><span id="l3.5016" class="difflineminus">-    } else {</span>
<a href="#l3.5017"></a><span id="l3.5017" class="difflineminus">-      return this.QueryInterface(iid);</span>
<a href="#l3.5018"></a><span id="l3.5018">     }</span>
<a href="#l3.5019"></a><span id="l3.5019" class="difflineplus">+    return this.QueryInterface(iid);</span>
<a href="#l3.5020"></a><span id="l3.5020">   },</span>
<a href="#l3.5021"></a><span id="l3.5021"> </span>
<a href="#l3.5022"></a><span id="l3.5022">   loadCookie: null,</span>
<a href="#l3.5023"></a><span id="l3.5023" class="difflineminus">-  parentContentListener: null</span>
<a href="#l3.5024"></a><span id="l3.5024" class="difflineminus">-}</span>
<a href="#l3.5025"></a><span id="l3.5025" class="difflineplus">+  parentContentListener: null,</span>
<a href="#l3.5026"></a><span id="l3.5026" class="difflineplus">+};</span>
<a href="#l3.5027"></a><span id="l3.5027"> </span>
<a href="#l3.5028"></a><span id="l3.5028"> /**</span>
<a href="#l3.5029"></a><span id="l3.5029">  * Check what to do with HTML message according to what preference we have</span>
<a href="#l3.5030"></a><span id="l3.5030">  * stored for the recipients.</span>
<a href="#l3.5031"></a><span id="l3.5031">  *</span>
<a href="#l3.5032"></a><span id="l3.5032">  * @param convertible  An nsIMsgCompConvertible constant describing</span>
<a href="#l3.5033"></a><span id="l3.5033">  *                     message convertibility to plain text.</span>
<a href="#l3.5034"></a><span id="l3.5034">  */</span>
<a href="#l3.5035"></a><span id="l3.5035" class="difflineminus">-function DetermineHTMLAction(convertible)</span>
<a href="#l3.5036"></a><span id="l3.5036" class="difflineminus">-{</span>
<a href="#l3.5037"></a><span id="l3.5037" class="difflineplus">+function DetermineHTMLAction(convertible) {</span>
<a href="#l3.5038"></a><span id="l3.5038">   if (!gMsgCompose.composeHTML)</span>
<a href="#l3.5039"></a><span id="l3.5039" class="difflineminus">-    return nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.5040"></a><span id="l3.5040" class="difflineminus">-</span>
<a href="#l3.5041"></a><span id="l3.5041" class="difflineminus">-  if (gSendFormat == nsIMsgCompSendFormat.AskUser)</span>
<a href="#l3.5042"></a><span id="l3.5042" class="difflineplus">+    return Ci.nsIMsgCompSendFormat.PlainText;</span>
<a href="#l3.5043"></a><span id="l3.5043" class="difflineplus">+</span>
<a href="#l3.5044"></a><span id="l3.5044" class="difflineplus">+  if (gSendFormat == Ci.nsIMsgCompSendFormat.AskUser)</span>
<a href="#l3.5045"></a><span id="l3.5045">     return gMsgCompose.determineHTMLAction(convertible);</span>
<a href="#l3.5046"></a><span id="l3.5046"> </span>
<a href="#l3.5047"></a><span id="l3.5047">   return gSendFormat;</span>
<a href="#l3.5048"></a><span id="l3.5048"> }</span>
<a href="#l3.5049"></a><span id="l3.5049"> </span>
<a href="#l3.5050"></a><span id="l3.5050"> /**</span>
<a href="#l3.5051"></a><span id="l3.5051">  * Expands mailinglists found in the recipient fields.</span>
<a href="#l3.5052"></a><span id="l3.5052">  */</span>
<a href="#l3.5053"></a><span id="l3.5053" class="difflineminus">-function expandRecipients()</span>
<a href="#l3.5054"></a><span id="l3.5054" class="difflineminus">-{</span>
<a href="#l3.5055"></a><span id="l3.5055" class="difflineplus">+function expandRecipients() {</span>
<a href="#l3.5056"></a><span id="l3.5056">   gMsgCompose.expandMailingLists();</span>
<a href="#l3.5057"></a><span id="l3.5057"> }</span>
<a href="#l3.5058"></a><span id="l3.5058"> </span>
<a href="#l3.5059"></a><span id="l3.5059" class="difflineminus">-function DetermineConvertibility()</span>
<a href="#l3.5060"></a><span id="l3.5060" class="difflineminus">-{</span>
<a href="#l3.5061"></a><span id="l3.5061" class="difflineminus">-    if (!gMsgCompose.composeHTML)</span>
<a href="#l3.5062"></a><span id="l3.5062" class="difflineminus">-        return nsIMsgCompConvertible.Plain;</span>
<a href="#l3.5063"></a><span id="l3.5063" class="difflineminus">-</span>
<a href="#l3.5064"></a><span id="l3.5064" class="difflineminus">-    try {</span>
<a href="#l3.5065"></a><span id="l3.5065" class="difflineminus">-        return gMsgCompose.bodyConvertible();</span>
<a href="#l3.5066"></a><span id="l3.5066" class="difflineminus">-    } catch(ex) {}</span>
<a href="#l3.5067"></a><span id="l3.5067" class="difflineminus">-    return nsIMsgCompConvertible.No;</span>
<a href="#l3.5068"></a><span id="l3.5068" class="difflineplus">+function DetermineConvertibility() {</span>
<a href="#l3.5069"></a><span id="l3.5069" class="difflineplus">+  if (!gMsgCompose.composeHTML)</span>
<a href="#l3.5070"></a><span id="l3.5070" class="difflineplus">+    return Ci.nsIMsgCompConvertible.Plain;</span>
<a href="#l3.5071"></a><span id="l3.5071" class="difflineplus">+</span>
<a href="#l3.5072"></a><span id="l3.5072" class="difflineplus">+  try {</span>
<a href="#l3.5073"></a><span id="l3.5073" class="difflineplus">+    return gMsgCompose.bodyConvertible();</span>
<a href="#l3.5074"></a><span id="l3.5074" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.5075"></a><span id="l3.5075" class="difflineplus">+  return Ci.nsIMsgCompConvertible.No;</span>
<a href="#l3.5076"></a><span id="l3.5076"> }</span>
<a href="#l3.5077"></a><span id="l3.5077"> </span>
<a href="#l3.5078"></a><span id="l3.5078"> /**</span>
<a href="#l3.5079"></a><span id="l3.5079">  * Hides addressing options (To, CC, Bcc, Newsgroup, Followup-To, etc.)</span>
<a href="#l3.5080"></a><span id="l3.5080">  * that are not relevant for the account type used for sending.</span>
<a href="#l3.5081"></a><span id="l3.5081">  *</span>
<a href="#l3.5082"></a><span id="l3.5082">  * @param aAccountKey  Key of the account that is currently selected</span>
<a href="#l3.5083"></a><span id="l3.5083">  *                     as the sending account.</span>
<a href="#l3.5084"></a><span id="l3.5084">  */</span>
<a href="#l3.5085"></a><span id="l3.5085" class="difflineminus">-function hideIrrelevantAddressingOptions(aAccountKey)</span>
<a href="#l3.5086"></a><span id="l3.5086" class="difflineminus">-{</span>
<a href="#l3.5087"></a><span id="l3.5087" class="difflineplus">+function hideIrrelevantAddressingOptions(aAccountKey) {</span>
<a href="#l3.5088"></a><span id="l3.5088">   let hideNews = true;</span>
<a href="#l3.5089"></a><span id="l3.5089">   for (let account of fixIterator(MailServices.accounts.accounts,</span>
<a href="#l3.5090"></a><span id="l3.5090">                                   Ci.nsIMsgAccount)) {</span>
<a href="#l3.5091"></a><span id="l3.5091">     if (account.incomingServer.type == &quot;nntp&quot;)</span>
<a href="#l3.5092"></a><span id="l3.5092">       hideNews = false;</span>
<a href="#l3.5093"></a><span id="l3.5093">   }</span>
<a href="#l3.5094"></a><span id="l3.5094">   // If there is no News (NNTP) account existing then</span>
<a href="#l3.5095"></a><span id="l3.5095">   // hide the Newsgroup and Followup-To recipient type in all the menulists.</span>
<a href="#l3.5096"></a><span id="l3.5096" class="difflineat">@@ -5669,44 +5426,41 @@ function hideIrrelevantAddressingOptions</span>
<a href="#l3.5097"></a><span id="l3.5097">     .querySelectorAll('menuitem[value=&quot;addr_newsgroups&quot;], menuitem[value=&quot;addr_followup&quot;]');</span>
<a href="#l3.5098"></a><span id="l3.5098">   // Collapsing the menuitem only prevents it getting chosen, it does not</span>
<a href="#l3.5099"></a><span id="l3.5099">   // affect the menulist widget display when Newsgroup is already selected.</span>
<a href="#l3.5100"></a><span id="l3.5100">   for (let item of newsTypes) {</span>
<a href="#l3.5101"></a><span id="l3.5101">     item.collapsed = hideNews;</span>
<a href="#l3.5102"></a><span id="l3.5102">   }</span>
<a href="#l3.5103"></a><span id="l3.5103"> }</span>
<a href="#l3.5104"></a><span id="l3.5104"> </span>
<a href="#l3.5105"></a><span id="l3.5105" class="difflineminus">-function LoadIdentity(startup)</span>
<a href="#l3.5106"></a><span id="l3.5106" class="difflineminus">-{</span>
<a href="#l3.5107"></a><span id="l3.5107" class="difflineplus">+function LoadIdentity(startup) {</span>
<a href="#l3.5108"></a><span id="l3.5108">     var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l3.5109"></a><span id="l3.5109">     var prevIdentity = gCurrentIdentity;</span>
<a href="#l3.5110"></a><span id="l3.5110"> </span>
<a href="#l3.5111"></a><span id="l3.5111">     if (identityElement) {</span>
<a href="#l3.5112"></a><span id="l3.5112">         var idKey = identityElement.selectedItem.getAttribute(&quot;identitykey&quot;);</span>
<a href="#l3.5113"></a><span id="l3.5113">         gCurrentIdentity = MailServices.accounts.getIdentity(idKey);</span>
<a href="#l3.5114"></a><span id="l3.5114"> </span>
<a href="#l3.5115"></a><span id="l3.5115">         let accountKey = null;</span>
<a href="#l3.5116"></a><span id="l3.5116">         // Set the account key value on the menu list.</span>
<a href="#l3.5117"></a><span id="l3.5117">         if (identityElement.selectedItem) {</span>
<a href="#l3.5118"></a><span id="l3.5118">           accountKey = identityElement.selectedItem.getAttribute(&quot;accountkey&quot;);</span>
<a href="#l3.5119"></a><span id="l3.5119">           identityElement.setAttribute(&quot;accountkey&quot;, accountKey);</span>
<a href="#l3.5120"></a><span id="l3.5120">           hideIrrelevantAddressingOptions(accountKey);</span>
<a href="#l3.5121"></a><span id="l3.5121">         }</span>
<a href="#l3.5122"></a><span id="l3.5122"> </span>
<a href="#l3.5123"></a><span id="l3.5123">         let maxRecipients = awGetMaxRecipients();</span>
<a href="#l3.5124"></a><span id="l3.5124" class="difflineminus">-        for (let i = 1; i &lt;= maxRecipients; i++)</span>
<a href="#l3.5125"></a><span id="l3.5125" class="difflineminus">-        {</span>
<a href="#l3.5126"></a><span id="l3.5126" class="difflineplus">+        for (let i = 1; i &lt;= maxRecipients; i++) {</span>
<a href="#l3.5127"></a><span id="l3.5127">           let params = JSON.parse(awGetInputElement(i).searchParam);</span>
<a href="#l3.5128"></a><span id="l3.5128">           params.idKey = idKey;</span>
<a href="#l3.5129"></a><span id="l3.5129">           params.accountKey = accountKey;</span>
<a href="#l3.5130"></a><span id="l3.5130">           awGetInputElement(i).searchParam = JSON.stringify(params);</span>
<a href="#l3.5131"></a><span id="l3.5131">         }</span>
<a href="#l3.5132"></a><span id="l3.5132"> </span>
<a href="#l3.5133"></a><span id="l3.5133" class="difflineminus">-        if (!startup &amp;&amp; prevIdentity &amp;&amp; idKey != prevIdentity.key)</span>
<a href="#l3.5134"></a><span id="l3.5134" class="difflineminus">-        {</span>
<a href="#l3.5135"></a><span id="l3.5135" class="difflineplus">+        if (!startup &amp;&amp; prevIdentity &amp;&amp; idKey != prevIdentity.key) {</span>
<a href="#l3.5136"></a><span id="l3.5136">           var prevReplyTo = prevIdentity.replyTo;</span>
<a href="#l3.5137"></a><span id="l3.5137">           var prevCc = &quot;&quot;;</span>
<a href="#l3.5138"></a><span id="l3.5138">           var prevBcc = &quot;&quot;;</span>
<a href="#l3.5139"></a><span id="l3.5139">           var prevReceipt = prevIdentity.requestReturnReceipt;</span>
<a href="#l3.5140"></a><span id="l3.5140">           var prevDSN = prevIdentity.DSN;</span>
<a href="#l3.5141"></a><span id="l3.5141">           var prevAttachVCard = prevIdentity.attachVCard;</span>
<a href="#l3.5142"></a><span id="l3.5142"> </span>
<a href="#l3.5143"></a><span id="l3.5143">           if (prevIdentity.doCc)</span>
<a href="#l3.5144"></a><span id="l3.5144" class="difflineat">@@ -5728,67 +5482,61 @@ function LoadIdentity(startup)</span>
<a href="#l3.5145"></a><span id="l3.5145">           if (gCurrentIdentity.doBcc)</span>
<a href="#l3.5146"></a><span id="l3.5146">             newBcc += gCurrentIdentity.doBccList;</span>
<a href="#l3.5147"></a><span id="l3.5147"> </span>
<a href="#l3.5148"></a><span id="l3.5148">           var needToCleanUp = false;</span>
<a href="#l3.5149"></a><span id="l3.5149">           var msgCompFields = gMsgCompose.compFields;</span>
<a href="#l3.5150"></a><span id="l3.5150"> </span>
<a href="#l3.5151"></a><span id="l3.5151">           if (!gReceiptOptionChanged &amp;&amp;</span>
<a href="#l3.5152"></a><span id="l3.5152">               prevReceipt == msgCompFields.returnReceipt &amp;&amp;</span>
<a href="#l3.5153"></a><span id="l3.5153" class="difflineminus">-              prevReceipt != newReceipt)</span>
<a href="#l3.5154"></a><span id="l3.5154" class="difflineminus">-          {</span>
<a href="#l3.5155"></a><span id="l3.5155" class="difflineplus">+              prevReceipt != newReceipt) {</span>
<a href="#l3.5156"></a><span id="l3.5156">             msgCompFields.returnReceipt = newReceipt;</span>
<a href="#l3.5157"></a><span id="l3.5157" class="difflineminus">-            document.getElementById(&quot;returnReceiptMenu&quot;).setAttribute('checked',msgCompFields.returnReceipt);</span>
<a href="#l3.5158"></a><span id="l3.5158" class="difflineplus">+            document.getElementById(&quot;returnReceiptMenu&quot;).setAttribute(&quot;checked&quot;, msgCompFields.returnReceipt);</span>
<a href="#l3.5159"></a><span id="l3.5159">           }</span>
<a href="#l3.5160"></a><span id="l3.5160"> </span>
<a href="#l3.5161"></a><span id="l3.5161">           if (!gDSNOptionChanged &amp;&amp;</span>
<a href="#l3.5162"></a><span id="l3.5162">               prevDSN == msgCompFields.DSN &amp;&amp;</span>
<a href="#l3.5163"></a><span id="l3.5163" class="difflineminus">-              prevDSN != newDSN)</span>
<a href="#l3.5164"></a><span id="l3.5164" class="difflineminus">-          {</span>
<a href="#l3.5165"></a><span id="l3.5165" class="difflineplus">+              prevDSN != newDSN) {</span>
<a href="#l3.5166"></a><span id="l3.5166">             msgCompFields.DSN = newDSN;</span>
<a href="#l3.5167"></a><span id="l3.5167" class="difflineminus">-            document.getElementById(&quot;dsnMenu&quot;).setAttribute('checked',msgCompFields.DSN);</span>
<a href="#l3.5168"></a><span id="l3.5168" class="difflineplus">+            document.getElementById(&quot;dsnMenu&quot;).setAttribute(&quot;checked&quot;, msgCompFields.DSN);</span>
<a href="#l3.5169"></a><span id="l3.5169">           }</span>
<a href="#l3.5170"></a><span id="l3.5170"> </span>
<a href="#l3.5171"></a><span id="l3.5171">           if (!gAttachVCardOptionChanged &amp;&amp;</span>
<a href="#l3.5172"></a><span id="l3.5172">               prevAttachVCard == msgCompFields.attachVCard &amp;&amp;</span>
<a href="#l3.5173"></a><span id="l3.5173" class="difflineminus">-              prevAttachVCard != newAttachVCard)</span>
<a href="#l3.5174"></a><span id="l3.5174" class="difflineminus">-          {</span>
<a href="#l3.5175"></a><span id="l3.5175" class="difflineplus">+              prevAttachVCard != newAttachVCard) {</span>
<a href="#l3.5176"></a><span id="l3.5176">             msgCompFields.attachVCard = newAttachVCard;</span>
<a href="#l3.5177"></a><span id="l3.5177" class="difflineminus">-            document.getElementById(&quot;cmd_attachVCard&quot;).setAttribute('checked',msgCompFields.attachVCard);</span>
<a href="#l3.5178"></a><span id="l3.5178" class="difflineplus">+            document.getElementById(&quot;cmd_attachVCard&quot;).setAttribute(&quot;checked&quot;, msgCompFields.attachVCard);</span>
<a href="#l3.5179"></a><span id="l3.5179">           }</span>
<a href="#l3.5180"></a><span id="l3.5180"> </span>
<a href="#l3.5181"></a><span id="l3.5181" class="difflineminus">-          if (newReplyTo != prevReplyTo)</span>
<a href="#l3.5182"></a><span id="l3.5182" class="difflineminus">-          {</span>
<a href="#l3.5183"></a><span id="l3.5183" class="difflineplus">+          if (newReplyTo != prevReplyTo) {</span>
<a href="#l3.5184"></a><span id="l3.5184">             needToCleanUp = true;</span>
<a href="#l3.5185"></a><span id="l3.5185">             if (prevReplyTo != &quot;&quot;)</span>
<a href="#l3.5186"></a><span id="l3.5186">               awRemoveRecipients(msgCompFields, &quot;addr_reply&quot;, prevReplyTo);</span>
<a href="#l3.5187"></a><span id="l3.5187">             if (newReplyTo != &quot;&quot;)</span>
<a href="#l3.5188"></a><span id="l3.5188">               awAddRecipients(msgCompFields, &quot;addr_reply&quot;, newReplyTo);</span>
<a href="#l3.5189"></a><span id="l3.5189">           }</span>
<a href="#l3.5190"></a><span id="l3.5190"> </span>
<a href="#l3.5191"></a><span id="l3.5191">           let toAddrs = new Set(msgCompFields.splitRecipients(</span>
<a href="#l3.5192"></a><span id="l3.5192">             msgCompFields.to, true, {}));</span>
<a href="#l3.5193"></a><span id="l3.5193">           let ccAddrs = new Set(msgCompFields.splitRecipients(</span>
<a href="#l3.5194"></a><span id="l3.5194">             msgCompFields.cc, true, {}));</span>
<a href="#l3.5195"></a><span id="l3.5195"> </span>
<a href="#l3.5196"></a><span id="l3.5196" class="difflineminus">-          if (newCc != prevCc)</span>
<a href="#l3.5197"></a><span id="l3.5197" class="difflineminus">-          {</span>
<a href="#l3.5198"></a><span id="l3.5198" class="difflineplus">+          if (newCc != prevCc) {</span>
<a href="#l3.5199"></a><span id="l3.5199">             needToCleanUp = true;</span>
<a href="#l3.5200"></a><span id="l3.5200">             if (prevCc)</span>
<a href="#l3.5201"></a><span id="l3.5201">               awRemoveRecipients(msgCompFields, &quot;addr_cc&quot;, prevCc);</span>
<a href="#l3.5202"></a><span id="l3.5202">             if (newCc) {</span>
<a href="#l3.5203"></a><span id="l3.5203">               // Ensure none of the Ccs are already in To.</span>
<a href="#l3.5204"></a><span id="l3.5204">               let cc2 = msgCompFields.splitRecipients(newCc, true, {});</span>
<a href="#l3.5205"></a><span id="l3.5205">               newCc = cc2.filter(x =&gt; !toAddrs.has(x)).join(&quot;, &quot;);</span>
<a href="#l3.5206"></a><span id="l3.5206">               awAddRecipients(msgCompFields, &quot;addr_cc&quot;, newCc);</span>
<a href="#l3.5207"></a><span id="l3.5207">             }</span>
<a href="#l3.5208"></a><span id="l3.5208">           }</span>
<a href="#l3.5209"></a><span id="l3.5209"> </span>
<a href="#l3.5210"></a><span id="l3.5210" class="difflineminus">-          if (newBcc != prevBcc)</span>
<a href="#l3.5211"></a><span id="l3.5211" class="difflineminus">-          {</span>
<a href="#l3.5212"></a><span id="l3.5212" class="difflineplus">+          if (newBcc != prevBcc) {</span>
<a href="#l3.5213"></a><span id="l3.5213">             needToCleanUp = true;</span>
<a href="#l3.5214"></a><span id="l3.5214">             if (prevBcc)</span>
<a href="#l3.5215"></a><span id="l3.5215">               awRemoveRecipients(msgCompFields, &quot;addr_bcc&quot;, prevBcc);</span>
<a href="#l3.5216"></a><span id="l3.5216">             if (newBcc) {</span>
<a href="#l3.5217"></a><span id="l3.5217">               // Ensure none of the Bccs are already in To or Cc.</span>
<a href="#l3.5218"></a><span id="l3.5218">               let bcc2 = msgCompFields.splitRecipients(newBcc, true, {});</span>
<a href="#l3.5219"></a><span id="l3.5219">               let toCcAddrs = new Set([...toAddrs, ...ccAddrs]);</span>
<a href="#l3.5220"></a><span id="l3.5220">               newBcc = bcc2.filter(x =&gt; !toCcAddrs.has(x)).join(&quot;, &quot;);</span>
<a href="#l3.5221"></a><span id="l3.5221" class="difflineat">@@ -5796,92 +5544,91 @@ function LoadIdentity(startup)</span>
<a href="#l3.5222"></a><span id="l3.5222">             }</span>
<a href="#l3.5223"></a><span id="l3.5223">           }</span>
<a href="#l3.5224"></a><span id="l3.5224"> </span>
<a href="#l3.5225"></a><span id="l3.5225">           if (needToCleanUp)</span>
<a href="#l3.5226"></a><span id="l3.5226">             awCleanupRows();</span>
<a href="#l3.5227"></a><span id="l3.5227"> </span>
<a href="#l3.5228"></a><span id="l3.5228">           try {</span>
<a href="#l3.5229"></a><span id="l3.5229">             gMsgCompose.identity = gCurrentIdentity;</span>
<a href="#l3.5230"></a><span id="l3.5230" class="difflineminus">-          } catch (ex) { dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);}</span>
<a href="#l3.5231"></a><span id="l3.5231" class="difflineminus">-</span>
<a href="#l3.5232"></a><span id="l3.5232" class="difflineminus">-          var event = document.createEvent('Events');</span>
<a href="#l3.5233"></a><span id="l3.5233" class="difflineminus">-          event.initEvent('compose-from-changed', false, true);</span>
<a href="#l3.5234"></a><span id="l3.5234" class="difflineplus">+          } catch (ex) {</span>
<a href="#l3.5235"></a><span id="l3.5235" class="difflineplus">+            dump(&quot;### Cannot change the identity: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l3.5236"></a><span id="l3.5236" class="difflineplus">+          }</span>
<a href="#l3.5237"></a><span id="l3.5237" class="difflineplus">+</span>
<a href="#l3.5238"></a><span id="l3.5238" class="difflineplus">+          var event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l3.5239"></a><span id="l3.5239" class="difflineplus">+          event.initEvent(&quot;compose-from-changed&quot;, false, true);</span>
<a href="#l3.5240"></a><span id="l3.5240">           document.getElementById(&quot;msgcomposeWindow&quot;).dispatchEvent(event);</span>
<a href="#l3.5241"></a><span id="l3.5241"> </span>
<a href="#l3.5242"></a><span id="l3.5242">           gComposeNotificationBar.clearIdentityWarning();</span>
<a href="#l3.5243"></a><span id="l3.5243">         }</span>
<a href="#l3.5244"></a><span id="l3.5244"> </span>
<a href="#l3.5245"></a><span id="l3.5245">       if (!startup) {</span>
<a href="#l3.5246"></a><span id="l3.5246">           if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l3.5247"></a><span id="l3.5247" class="difflineminus">-            document.getElementById('addressCol2#1').highlightNonMatches = true;</span>
<a href="#l3.5248"></a><span id="l3.5248" class="difflineplus">+            document.getElementById(&quot;addressCol2#1&quot;).highlightNonMatches = true;</span>
<a href="#l3.5249"></a><span id="l3.5249"> </span>
<a href="#l3.5250"></a><span id="l3.5250">           // Only do this if we aren't starting up...</span>
<a href="#l3.5251"></a><span id="l3.5251">           // It gets done as part of startup already.</span>
<a href="#l3.5252"></a><span id="l3.5252">           addRecipientsToIgnoreList(gCurrentIdentity.fullAddress);</span>
<a href="#l3.5253"></a><span id="l3.5253"> </span>
<a href="#l3.5254"></a><span id="l3.5254">           // If the From field is editable, reset the address from the identity.</span>
<a href="#l3.5255"></a><span id="l3.5255" class="difflineminus">-          if (identityElement.editable)</span>
<a href="#l3.5256"></a><span id="l3.5256" class="difflineminus">-          {</span>
<a href="#l3.5257"></a><span id="l3.5257" class="difflineplus">+          if (identityElement.editable) {</span>
<a href="#l3.5258"></a><span id="l3.5258">             identityElement.value = identityElement.selectedItem.value;</span>
<a href="#l3.5259"></a><span id="l3.5259" class="difflineminus">-            identityElement.inputField.placeholder = getComposeBundle().getFormattedString(&quot;msgIdentityPlaceholder&quot;, [identityElement.selectedItem.value]);</span>
<a href="#l3.5260"></a><span id="l3.5260" class="difflineplus">+            identityElement.inputField.placeholder = getComposeBundle().getFormattedString(</span>
<a href="#l3.5261"></a><span id="l3.5261" class="difflineplus">+              &quot;msgIdentityPlaceholder&quot;, [identityElement.selectedItem.value]</span>
<a href="#l3.5262"></a><span id="l3.5262" class="difflineplus">+            );</span>
<a href="#l3.5263"></a><span id="l3.5263">           }</span>
<a href="#l3.5264"></a><span id="l3.5264">       }</span>
<a href="#l3.5265"></a><span id="l3.5265">     }</span>
<a href="#l3.5266"></a><span id="l3.5266"> }</span>
<a href="#l3.5267"></a><span id="l3.5267"> </span>
<a href="#l3.5268"></a><span id="l3.5268" class="difflineminus">-function MakeFromFieldEditable(ignoreWarning)</span>
<a href="#l3.5269"></a><span id="l3.5269" class="difflineminus">-{</span>
<a href="#l3.5270"></a><span id="l3.5270" class="difflineminus">-  if (!ignoreWarning &amp;&amp; !getPref(&quot;mail.compose.warned_about_customize_from&quot;))</span>
<a href="#l3.5271"></a><span id="l3.5271" class="difflineminus">-  {</span>
<a href="#l3.5272"></a><span id="l3.5272" class="difflineplus">+function MakeFromFieldEditable(ignoreWarning) {</span>
<a href="#l3.5273"></a><span id="l3.5273" class="difflineplus">+  let bundle = getComposeBundle();</span>
<a href="#l3.5274"></a><span id="l3.5274" class="difflineplus">+  if (!ignoreWarning &amp;&amp; !getPref(&quot;mail.compose.warned_about_customize_from&quot;)) {</span>
<a href="#l3.5275"></a><span id="l3.5275">     var check = { value: false };</span>
<a href="#l3.5276"></a><span id="l3.5276">     if (Services.prompt.confirmEx(window,</span>
<a href="#l3.5277"></a><span id="l3.5277" class="difflineminus">-          getComposeBundle().getString(&quot;customizeFromAddressTitle&quot;),</span>
<a href="#l3.5278"></a><span id="l3.5278" class="difflineminus">-          getComposeBundle().getString(&quot;customizeFromAddressWarning&quot;),</span>
<a href="#l3.5279"></a><span id="l3.5279" class="difflineplus">+          bundle.getString(&quot;customizeFromAddressTitle&quot;),</span>
<a href="#l3.5280"></a><span id="l3.5280" class="difflineplus">+          bundle.getString(&quot;customizeFromAddressWarning&quot;),</span>
<a href="#l3.5281"></a><span id="l3.5281">           Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_OK +</span>
<a href="#l3.5282"></a><span id="l3.5282">           Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_CANCEL +</span>
<a href="#l3.5283"></a><span id="l3.5283">           Services.prompt.BUTTON_POS_1_DEFAULT,</span>
<a href="#l3.5284"></a><span id="l3.5284">           null, null, null,</span>
<a href="#l3.5285"></a><span id="l3.5285" class="difflineminus">-          getComposeBundle().getString(&quot;customizeFromAddressIgnore&quot;),</span>
<a href="#l3.5286"></a><span id="l3.5286" class="difflineplus">+          bundle.getString(&quot;customizeFromAddressIgnore&quot;),</span>
<a href="#l3.5287"></a><span id="l3.5287">           check) != 0)</span>
<a href="#l3.5288"></a><span id="l3.5288">       return;</span>
<a href="#l3.5289"></a><span id="l3.5289">     Services.prefs.setBoolPref(&quot;mail.compose.warned_about_customize_from&quot;, check.value);</span>
<a href="#l3.5290"></a><span id="l3.5290">   }</span>
<a href="#l3.5291"></a><span id="l3.5291"> </span>
<a href="#l3.5292"></a><span id="l3.5292">   var customizeMenuitem = document.getElementById(&quot;cmd_customizeFromAddress&quot;);</span>
<a href="#l3.5293"></a><span id="l3.5293">   customizeMenuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.5294"></a><span id="l3.5294">   var identityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l3.5295"></a><span id="l3.5295">   identityElement.removeAttribute(&quot;type&quot;);</span>
<a href="#l3.5296"></a><span id="l3.5296">   identityElement.setAttribute(&quot;editable&quot;, &quot;true&quot;);</span>
<a href="#l3.5297"></a><span id="l3.5297">   identityElement.focus();</span>
<a href="#l3.5298"></a><span id="l3.5298">   identityElement.value = identityElement.selectedItem.value;</span>
<a href="#l3.5299"></a><span id="l3.5299">   identityElement.select();</span>
<a href="#l3.5300"></a><span id="l3.5300" class="difflineminus">-  identityElement.inputField.placeholder = getComposeBundle().getFormattedString(&quot;msgIdentityPlaceholder&quot;, [identityElement.selectedItem.value]);</span>
<a href="#l3.5301"></a><span id="l3.5301" class="difflineminus">-}</span>
<a href="#l3.5302"></a><span id="l3.5302" class="difflineminus">-</span>
<a href="#l3.5303"></a><span id="l3.5303" class="difflineminus">-function setupAutocomplete()</span>
<a href="#l3.5304"></a><span id="l3.5304" class="difflineminus">-{</span>
<a href="#l3.5305"></a><span id="l3.5305" class="difflineplus">+  identityElement.inputField.placeholder = bundle.getFormattedString(&quot;msgIdentityPlaceholder&quot;, [identityElement.selectedItem.value]);</span>
<a href="#l3.5306"></a><span id="l3.5306" class="difflineplus">+}</span>
<a href="#l3.5307"></a><span id="l3.5307" class="difflineplus">+</span>
<a href="#l3.5308"></a><span id="l3.5308" class="difflineplus">+function setupAutocomplete() {</span>
<a href="#l3.5309"></a><span id="l3.5309">   var autoCompleteWidget = document.getElementById(&quot;addressCol2#1&quot;);</span>
<a href="#l3.5310"></a><span id="l3.5310">   try {</span>
<a href="#l3.5311"></a><span id="l3.5311">     // Request that input that isn't matched be highlighted.</span>
<a href="#l3.5312"></a><span id="l3.5312">     // This element then gets cloned for subsequent rows, so they should</span>
<a href="#l3.5313"></a><span id="l3.5313">     // honor it as well.</span>
<a href="#l3.5314"></a><span id="l3.5314">     if (getPref(&quot;mail.autoComplete.highlightNonMatches&quot;))</span>
<a href="#l3.5315"></a><span id="l3.5315">       autoCompleteWidget.highlightNonMatches = true;</span>
<a href="#l3.5316"></a><span id="l3.5316">   } catch (ex) {}</span>
<a href="#l3.5317"></a><span id="l3.5317"> }</span>
<a href="#l3.5318"></a><span id="l3.5318"> </span>
<a href="#l3.5319"></a><span id="l3.5319" class="difflineminus">-function fromKeyPress(event)</span>
<a href="#l3.5320"></a><span id="l3.5320" class="difflineminus">-{</span>
<a href="#l3.5321"></a><span id="l3.5321" class="difflineplus">+function fromKeyPress(event) {</span>
<a href="#l3.5322"></a><span id="l3.5322">   if (event.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l3.5323"></a><span id="l3.5323">     awSetFocus(1, awGetInputElement(1));</span>
<a href="#l3.5324"></a><span id="l3.5324"> }</span>
<a href="#l3.5325"></a><span id="l3.5325"> </span>
<a href="#l3.5326"></a><span id="l3.5326" class="difflineminus">-function subjectKeyPress(event)</span>
<a href="#l3.5327"></a><span id="l3.5327" class="difflineminus">-{</span>
<a href="#l3.5328"></a><span id="l3.5328" class="difflineplus">+function subjectKeyPress(event) {</span>
<a href="#l3.5329"></a><span id="l3.5329">   gSubjectChanged = true;</span>
<a href="#l3.5330"></a><span id="l3.5330">   if (event.keyCode == KeyEvent.DOM_VK_RETURN)</span>
<a href="#l3.5331"></a><span id="l3.5331">     SetMsgBodyFrameFocus();</span>
<a href="#l3.5332"></a><span id="l3.5332"> }</span>
<a href="#l3.5333"></a><span id="l3.5333"> </span>
<a href="#l3.5334"></a><span id="l3.5334"> // we can drag and drop addresses, files, messages and urls into the compose envelope</span>
<a href="#l3.5335"></a><span id="l3.5335"> var envelopeDragObserver = {</span>
<a href="#l3.5336"></a><span id="l3.5336"> </span>
<a href="#l3.5337"></a><span id="l3.5337" class="difflineat">@@ -5895,18 +5642,17 @@ var envelopeDragObserver = {</span>
<a href="#l3.5338"></a><span id="l3.5338">    * @param aEvent the drag-and-drop event being performed</span>
<a href="#l3.5339"></a><span id="l3.5339">    * @return {attachmentitem|string} the adjusted drop target:</span>
<a href="#l3.5340"></a><span id="l3.5340">    *                                 - an attachmentitem node for inserting</span>
<a href="#l3.5341"></a><span id="l3.5341">    *                                   *before*</span>
<a href="#l3.5342"></a><span id="l3.5342">    *                                 - &quot;none&quot; if this isn't a valid insertion point</span>
<a href="#l3.5343"></a><span id="l3.5343">    *                                 - &quot;afterLastItem&quot; for appending at the</span>
<a href="#l3.5344"></a><span id="l3.5344">    *                                   bottom of the list.</span>
<a href="#l3.5345"></a><span id="l3.5345">    */</span>
<a href="#l3.5346"></a><span id="l3.5346" class="difflineminus">-  _adjustDropTarget: function(aEvent)</span>
<a href="#l3.5347"></a><span id="l3.5347" class="difflineminus">-  {</span>
<a href="#l3.5348"></a><span id="l3.5348" class="difflineplus">+  _adjustDropTarget(aEvent) {</span>
<a href="#l3.5349"></a><span id="l3.5349">     let target = aEvent.target;</span>
<a href="#l3.5350"></a><span id="l3.5350">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.5351"></a><span id="l3.5351"> </span>
<a href="#l3.5352"></a><span id="l3.5352">     if (target == bucket) {</span>
<a href="#l3.5353"></a><span id="l3.5353">       // Dragging or dropping at top/bottom border of the listbox</span>
<a href="#l3.5354"></a><span id="l3.5354">       let box = target.boxObject;</span>
<a href="#l3.5355"></a><span id="l3.5355">       if ((aEvent.screenY - box.screenY) / box.height &lt; 0.5) {</span>
<a href="#l3.5356"></a><span id="l3.5356">         target = bucket.firstChild;</span>
<a href="#l3.5357"></a><span id="l3.5357" class="difflineat">@@ -5928,17 +5674,17 @@ var envelopeDragObserver = {</span>
<a href="#l3.5358"></a><span id="l3.5358">       }</span>
<a href="#l3.5359"></a><span id="l3.5359">     }</span>
<a href="#l3.5360"></a><span id="l3.5360"> </span>
<a href="#l3.5361"></a><span id="l3.5361">     // Target is an attachmentitem.</span>
<a href="#l3.5362"></a><span id="l3.5362">     if (target.tagName == &quot;attachmentitem&quot;) {</span>
<a href="#l3.5363"></a><span id="l3.5363">       // If we're dragging/dropping in bottom half of attachmentitem,</span>
<a href="#l3.5364"></a><span id="l3.5364">       // adjust target to target.nextSibling (to show dropmarker above that).</span>
<a href="#l3.5365"></a><span id="l3.5365">       let box = target.boxObject;</span>
<a href="#l3.5366"></a><span id="l3.5366" class="difflineminus">-      if((aEvent.screenY - box.screenY) / box.height &gt;= 0.5) {</span>
<a href="#l3.5367"></a><span id="l3.5367" class="difflineplus">+      if ((aEvent.screenY - box.screenY) / box.height &gt;= 0.5) {</span>
<a href="#l3.5368"></a><span id="l3.5368">         target = target.nextSibling;</span>
<a href="#l3.5369"></a><span id="l3.5369"> </span>
<a href="#l3.5370"></a><span id="l3.5370">         // If there's no target.nextSibling, we're dragging/dropping</span>
<a href="#l3.5371"></a><span id="l3.5371">         // to the bottom of the list.</span>
<a href="#l3.5372"></a><span id="l3.5372">         if (!target) {</span>
<a href="#l3.5373"></a><span id="l3.5373">           // We can't move a bottom block selection to the bottom.</span>
<a href="#l3.5374"></a><span id="l3.5374">           if (attachmentsSelectionIsBlock(&quot;bottom&quot;))</span>
<a href="#l3.5375"></a><span id="l3.5375">             return &quot;none&quot;;</span>
<a href="#l3.5376"></a><span id="l3.5376" class="difflineat">@@ -5961,44 +5707,41 @@ var envelopeDragObserver = {</span>
<a href="#l3.5377"></a><span id="l3.5377">           return &quot;none&quot;;</span>
<a href="#l3.5378"></a><span id="l3.5378">       }</span>
<a href="#l3.5379"></a><span id="l3.5379">       return target;</span>
<a href="#l3.5380"></a><span id="l3.5380">     }</span>
<a href="#l3.5381"></a><span id="l3.5381"> </span>
<a href="#l3.5382"></a><span id="l3.5382">     return &quot;none&quot;;</span>
<a href="#l3.5383"></a><span id="l3.5383">   },</span>
<a href="#l3.5384"></a><span id="l3.5384"> </span>
<a href="#l3.5385"></a><span id="l3.5385" class="difflineminus">-  _showDropMarker: function(targetItem)</span>
<a href="#l3.5386"></a><span id="l3.5386" class="difflineminus">-  {</span>
<a href="#l3.5387"></a><span id="l3.5387" class="difflineplus">+  _showDropMarker(targetItem) {</span>
<a href="#l3.5388"></a><span id="l3.5388">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.5389"></a><span id="l3.5389"> </span>
<a href="#l3.5390"></a><span id="l3.5390">     let oldDropMarkerItem =</span>
<a href="#l3.5391"></a><span id="l3.5391">       bucket.querySelector(&quot;attachmentitem[dropOn]&quot;);</span>
<a href="#l3.5392"></a><span id="l3.5392">     if (oldDropMarkerItem)</span>
<a href="#l3.5393"></a><span id="l3.5393">       oldDropMarkerItem.removeAttribute(&quot;dropOn&quot;);</span>
<a href="#l3.5394"></a><span id="l3.5394"> </span>
<a href="#l3.5395"></a><span id="l3.5395">     if (targetItem == &quot;afterLastItem&quot;) {</span>
<a href="#l3.5396"></a><span id="l3.5396">       targetItem = bucket.lastChild;</span>
<a href="#l3.5397"></a><span id="l3.5397">       targetItem.setAttribute(&quot;dropOn&quot;, &quot;bottom&quot;);</span>
<a href="#l3.5398"></a><span id="l3.5398">     } else {</span>
<a href="#l3.5399"></a><span id="l3.5399">       targetItem.setAttribute(&quot;dropOn&quot;, &quot;top&quot;);</span>
<a href="#l3.5400"></a><span id="l3.5400">     }</span>
<a href="#l3.5401"></a><span id="l3.5401">   },</span>
<a href="#l3.5402"></a><span id="l3.5402"> </span>
<a href="#l3.5403"></a><span id="l3.5403" class="difflineminus">-  _hideDropMarker: function()</span>
<a href="#l3.5404"></a><span id="l3.5404" class="difflineminus">-  {</span>
<a href="#l3.5405"></a><span id="l3.5405" class="difflineplus">+  _hideDropMarker() {</span>
<a href="#l3.5406"></a><span id="l3.5406">    let oldDropMarkerItem =</span>
<a href="#l3.5407"></a><span id="l3.5407">      document.getElementById(&quot;attachmentBucket&quot;)</span>
<a href="#l3.5408"></a><span id="l3.5408">              .querySelector(&quot;attachmentitem[dropOn]&quot;);</span>
<a href="#l3.5409"></a><span id="l3.5409">     if (oldDropMarkerItem)</span>
<a href="#l3.5410"></a><span id="l3.5410">       oldDropMarkerItem.removeAttribute(&quot;dropOn&quot;);</span>
<a href="#l3.5411"></a><span id="l3.5411">   },</span>
<a href="#l3.5412"></a><span id="l3.5412"> </span>
<a href="#l3.5413"></a><span id="l3.5413" class="difflineminus">-  onDrop: function (aEvent, aData, aDragSession)</span>
<a href="#l3.5414"></a><span id="l3.5414" class="difflineminus">-  {</span>
<a href="#l3.5415"></a><span id="l3.5415" class="difflineplus">+  onDrop(aEvent, aData, aDragSession) {</span>
<a href="#l3.5416"></a><span id="l3.5416">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.5417"></a><span id="l3.5417">     let dragSourceNode = aDragSession.sourceNode;</span>
<a href="#l3.5418"></a><span id="l3.5418">     if (dragSourceNode &amp;&amp; dragSourceNode.parentNode == bucket) {</span>
<a href="#l3.5419"></a><span id="l3.5419">       // We dragged from the attachment pane onto itself, so instead of</span>
<a href="#l3.5420"></a><span id="l3.5420">       // attaching a new object, we're just reordering them.</span>
<a href="#l3.5421"></a><span id="l3.5421"> </span>
<a href="#l3.5422"></a><span id="l3.5422">       // Adjust the drop target according to mouse position on list (items).</span>
<a href="#l3.5423"></a><span id="l3.5423">       let target = this._adjustDropTarget(aEvent);</span>
<a href="#l3.5424"></a><span id="l3.5424" class="difflineat">@@ -6067,30 +5810,28 @@ var envelopeDragObserver = {</span>
<a href="#l3.5425"></a><span id="l3.5425">       bucket.currentItem = focus;</span>
<a href="#l3.5426"></a><span id="l3.5426">       this._hideDropMarker();</span>
<a href="#l3.5427"></a><span id="l3.5427">       return;</span>
<a href="#l3.5428"></a><span id="l3.5428">     }</span>
<a href="#l3.5429"></a><span id="l3.5429"> </span>
<a href="#l3.5430"></a><span id="l3.5430">     let dataList = aData.dataList;</span>
<a href="#l3.5431"></a><span id="l3.5431">     let attachments = [];</span>
<a href="#l3.5432"></a><span id="l3.5432"> </span>
<a href="#l3.5433"></a><span id="l3.5433" class="difflineminus">-    for (let dataListObj of dataList)</span>
<a href="#l3.5434"></a><span id="l3.5434" class="difflineminus">-    {</span>
<a href="#l3.5435"></a><span id="l3.5435" class="difflineplus">+    for (let dataListObj of dataList) {</span>
<a href="#l3.5436"></a><span id="l3.5436">       let item = dataListObj.first;</span>
<a href="#l3.5437"></a><span id="l3.5437">       let rawData = item.data;</span>
<a href="#l3.5438"></a><span id="l3.5438">       let isValidAttachment = false;</span>
<a href="#l3.5439"></a><span id="l3.5439">       let prettyName;</span>
<a href="#l3.5440"></a><span id="l3.5440">       let size;</span>
<a href="#l3.5441"></a><span id="l3.5441"> </span>
<a href="#l3.5442"></a><span id="l3.5442">       // We could be dropping an attachment of various flavours OR an address;</span>
<a href="#l3.5443"></a><span id="l3.5443">       // check and do the right thing.</span>
<a href="#l3.5444"></a><span id="l3.5444">       // Note that case blocks {...} are recommended to avoid redeclaration errors</span>
<a href="#l3.5445"></a><span id="l3.5445">       // when using 'let'.</span>
<a href="#l3.5446"></a><span id="l3.5446" class="difflineminus">-      switch (item.flavour.contentType)</span>
<a href="#l3.5447"></a><span id="l3.5447" class="difflineminus">-      {</span>
<a href="#l3.5448"></a><span id="l3.5448" class="difflineplus">+      switch (item.flavour.contentType) {</span>
<a href="#l3.5449"></a><span id="l3.5449">         // Process attachments.</span>
<a href="#l3.5450"></a><span id="l3.5450">         case &quot;application/x-moz-file&quot;: {</span>
<a href="#l3.5451"></a><span id="l3.5451">           let fileHandler = Services.io</span>
<a href="#l3.5452"></a><span id="l3.5452">                                     .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l3.5453"></a><span id="l3.5453">                                     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l3.5454"></a><span id="l3.5454">           if (!rawData.exists() || !rawData.isReadable()) {</span>
<a href="#l3.5455"></a><span id="l3.5455">             // For some reason we couldn't read the file just dragged. Permission problem?</span>
<a href="#l3.5456"></a><span id="l3.5456">             Cu.reportError(&quot;Couldn't access the dragged file &quot; + rawData.leafName);</span>
<a href="#l3.5457"></a><span id="l3.5457" class="difflineat">@@ -6126,18 +5867,17 @@ var envelopeDragObserver = {</span>
<a href="#l3.5458"></a><span id="l3.5458"> </span>
<a href="#l3.5459"></a><span id="l3.5459">           // If this is a URL (or selected text), check if it's a valid URL</span>
<a href="#l3.5460"></a><span id="l3.5460">           // by checking if we can extract a scheme using Services.io.</span>
<a href="#l3.5461"></a><span id="l3.5461">           // Don't attach invalid or mailto: URLs.</span>
<a href="#l3.5462"></a><span id="l3.5462">           try {</span>
<a href="#l3.5463"></a><span id="l3.5463">             let scheme = Services.io.extractScheme(rawData);</span>
<a href="#l3.5464"></a><span id="l3.5464">             if (scheme != &quot;mailto&quot;)</span>
<a href="#l3.5465"></a><span id="l3.5465">               isValidAttachment = true;</span>
<a href="#l3.5466"></a><span id="l3.5466" class="difflineminus">-          }</span>
<a href="#l3.5467"></a><span id="l3.5467" class="difflineminus">-          catch (ex) {}</span>
<a href="#l3.5468"></a><span id="l3.5468" class="difflineplus">+          } catch (ex) {}</span>
<a href="#l3.5469"></a><span id="l3.5469">           break;</span>
<a href="#l3.5470"></a><span id="l3.5470">         }</span>
<a href="#l3.5471"></a><span id="l3.5471"> </span>
<a href="#l3.5472"></a><span id="l3.5472">         // Process address: Drop it into recipient field.</span>
<a href="#l3.5473"></a><span id="l3.5473">         case &quot;text/x-moz-address&quot;: {</span>
<a href="#l3.5474"></a><span id="l3.5474">           if (rawData) {</span>
<a href="#l3.5475"></a><span id="l3.5475">             DropRecipient(aEvent.target, rawData);</span>
<a href="#l3.5476"></a><span id="l3.5476"> </span>
<a href="#l3.5477"></a><span id="l3.5477" class="difflineat">@@ -6166,18 +5906,17 @@ var envelopeDragObserver = {</span>
<a href="#l3.5478"></a><span id="l3.5478">       }</span>
<a href="#l3.5479"></a><span id="l3.5479">     }</span>
<a href="#l3.5480"></a><span id="l3.5480"> </span>
<a href="#l3.5481"></a><span id="l3.5481">     // Add attachments if any.</span>
<a href="#l3.5482"></a><span id="l3.5482">     if (attachments.length &gt; 0)</span>
<a href="#l3.5483"></a><span id="l3.5483">       AddAttachments(attachments);</span>
<a href="#l3.5484"></a><span id="l3.5484">   },</span>
<a href="#l3.5485"></a><span id="l3.5485"> </span>
<a href="#l3.5486"></a><span id="l3.5486" class="difflineminus">-  onDragOver: function (aEvent, aFlavour, aDragSession)</span>
<a href="#l3.5487"></a><span id="l3.5487" class="difflineminus">-  {</span>
<a href="#l3.5488"></a><span id="l3.5488" class="difflineplus">+  onDragOver(aEvent, aFlavour, aDragSession) {</span>
<a href="#l3.5489"></a><span id="l3.5489">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.5490"></a><span id="l3.5490">     let dragSourceNode = aDragSession.sourceNode;</span>
<a href="#l3.5491"></a><span id="l3.5491">     if (dragSourceNode &amp;&amp; dragSourceNode.parentNode == bucket) {</span>
<a href="#l3.5492"></a><span id="l3.5492">       // If we're dragging from the attachment bucket onto itself, we need to</span>
<a href="#l3.5493"></a><span id="l3.5493">       // show a drop marker.</span>
<a href="#l3.5494"></a><span id="l3.5494"> </span>
<a href="#l3.5495"></a><span id="l3.5495">       let target = this._adjustDropTarget(aEvent);</span>
<a href="#l3.5496"></a><span id="l3.5496"> </span>
<a href="#l3.5497"></a><span id="l3.5497" class="difflineat">@@ -6196,145 +5935,124 @@ var envelopeDragObserver = {</span>
<a href="#l3.5498"></a><span id="l3.5498">     if (aFlavour.contentType != &quot;text/x-moz-address&quot;) {</span>
<a href="#l3.5499"></a><span id="l3.5499">       // Make sure the attachment pane is visible during drag over.</span>
<a href="#l3.5500"></a><span id="l3.5500">       toggleAttachmentPane(&quot;show&quot;);</span>
<a href="#l3.5501"></a><span id="l3.5501">     } else {</span>
<a href="#l3.5502"></a><span id="l3.5502">       DragAddressOverTargetControl(aEvent);</span>
<a href="#l3.5503"></a><span id="l3.5503">     }</span>
<a href="#l3.5504"></a><span id="l3.5504">   },</span>
<a href="#l3.5505"></a><span id="l3.5505"> </span>
<a href="#l3.5506"></a><span id="l3.5506" class="difflineminus">-  onDragExit: function (aEvent, aDragSession)</span>
<a href="#l3.5507"></a><span id="l3.5507" class="difflineminus">-  {</span>
<a href="#l3.5508"></a><span id="l3.5508" class="difflineplus">+  onDragExit(aEvent, aDragSession) {</span>
<a href="#l3.5509"></a><span id="l3.5509">     this._hideDropMarker();</span>
<a href="#l3.5510"></a><span id="l3.5510">   },</span>
<a href="#l3.5511"></a><span id="l3.5511"> </span>
<a href="#l3.5512"></a><span id="l3.5512" class="difflineminus">-  getSupportedFlavours: function ()</span>
<a href="#l3.5513"></a><span id="l3.5513" class="difflineminus">-  {</span>
<a href="#l3.5514"></a><span id="l3.5514" class="difflineplus">+  getSupportedFlavours() {</span>
<a href="#l3.5515"></a><span id="l3.5515">     let flavourSet = new FlavourSet();</span>
<a href="#l3.5516"></a><span id="l3.5516">     // Prefer &quot;text/x-moz-address&quot;, so when an address from the address book</span>
<a href="#l3.5517"></a><span id="l3.5517">     // is dragged, this flavour is tested first. Otherwise the attachment</span>
<a href="#l3.5518"></a><span id="l3.5518">     // bucket would open since the addresses also carry the</span>
<a href="#l3.5519"></a><span id="l3.5519">     // &quot;application/x-moz-file&quot; flavour.</span>
<a href="#l3.5520"></a><span id="l3.5520">     flavourSet.appendFlavour(&quot;text/x-moz-address&quot;);</span>
<a href="#l3.5521"></a><span id="l3.5521">     flavourSet.appendFlavour(&quot;text/x-moz-message&quot;);</span>
<a href="#l3.5522"></a><span id="l3.5522">     flavourSet.appendFlavour(&quot;application/x-moz-file&quot;, &quot;nsIFile&quot;);</span>
<a href="#l3.5523"></a><span id="l3.5523">     flavourSet.appendFlavour(&quot;text/x-moz-url&quot;);</span>
<a href="#l3.5524"></a><span id="l3.5524">     return flavourSet;</span>
<a href="#l3.5525"></a><span id="l3.5525" class="difflineminus">-  }</span>
<a href="#l3.5526"></a><span id="l3.5526" class="difflineplus">+  },</span>
<a href="#l3.5527"></a><span id="l3.5527"> };</span>
<a href="#l3.5528"></a><span id="l3.5528"> </span>
<a href="#l3.5529"></a><span id="l3.5529"> var attachmentBucketDNDObserver = {</span>
<a href="#l3.5530"></a><span id="l3.5530" class="difflineminus">-  onDragStart: function (aEvent, aAttachmentData, aDragAction)</span>
<a href="#l3.5531"></a><span id="l3.5531" class="difflineminus">-  {</span>
<a href="#l3.5532"></a><span id="l3.5532" class="difflineplus">+  onDragStart(aEvent, aAttachmentData, aDragAction) {</span>
<a href="#l3.5533"></a><span id="l3.5533">     var target = aEvent.target;</span>
<a href="#l3.5534"></a><span id="l3.5534"> </span>
<a href="#l3.5535"></a><span id="l3.5535">     if (target.localName == &quot;attachmentitem&quot;)</span>
<a href="#l3.5536"></a><span id="l3.5536">       aAttachmentData.data = CreateAttachmentTransferData(target.attachment);</span>
<a href="#l3.5537"></a><span id="l3.5537" class="difflineminus">-  }</span>
<a href="#l3.5538"></a><span id="l3.5538" class="difflineplus">+  },</span>
<a href="#l3.5539"></a><span id="l3.5539"> };</span>
<a href="#l3.5540"></a><span id="l3.5540"> </span>
<a href="#l3.5541"></a><span id="l3.5541" class="difflineminus">-function DisplaySaveFolderDlg(folderURI)</span>
<a href="#l3.5542"></a><span id="l3.5542" class="difflineminus">-{</span>
<a href="#l3.5543"></a><span id="l3.5543" class="difflineminus">-  try</span>
<a href="#l3.5544"></a><span id="l3.5544" class="difflineminus">-  {</span>
<a href="#l3.5545"></a><span id="l3.5545" class="difflineplus">+function DisplaySaveFolderDlg(folderURI) {</span>
<a href="#l3.5546"></a><span id="l3.5546" class="difflineplus">+  try {</span>
<a href="#l3.5547"></a><span id="l3.5547">     var showDialog = gCurrentIdentity.showSaveMsgDlg;</span>
<a href="#l3.5548"></a><span id="l3.5548" class="difflineminus">-  }</span>
<a href="#l3.5549"></a><span id="l3.5549" class="difflineminus">-  catch (e)</span>
<a href="#l3.5550"></a><span id="l3.5550" class="difflineminus">-  {</span>
<a href="#l3.5551"></a><span id="l3.5551" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.5552"></a><span id="l3.5552">     return;</span>
<a href="#l3.5553"></a><span id="l3.5553">   }</span>
<a href="#l3.5554"></a><span id="l3.5554"> </span>
<a href="#l3.5555"></a><span id="l3.5555" class="difflineminus">-  if (showDialog){</span>
<a href="#l3.5556"></a><span id="l3.5556" class="difflineplus">+  if (showDialog) {</span>
<a href="#l3.5557"></a><span id="l3.5557">     let msgfolder = MailUtils.getFolderForURI(folderURI, true);</span>
<a href="#l3.5558"></a><span id="l3.5558">     if (!msgfolder)</span>
<a href="#l3.5559"></a><span id="l3.5559">       return;</span>
<a href="#l3.5560"></a><span id="l3.5560" class="difflineminus">-    let checkbox = {value:0};</span>
<a href="#l3.5561"></a><span id="l3.5561" class="difflineminus">-    let SaveDlgTitle = getComposeBundle().getString(&quot;SaveDialogTitle&quot;);</span>
<a href="#l3.5562"></a><span id="l3.5562" class="difflineplus">+    let checkbox = {value: 0};</span>
<a href="#l3.5563"></a><span id="l3.5563" class="difflineplus">+    let bundle = getComposeBundle();</span>
<a href="#l3.5564"></a><span id="l3.5564" class="difflineplus">+    let SaveDlgTitle = bundle.getString(&quot;SaveDialogTitle&quot;);</span>
<a href="#l3.5565"></a><span id="l3.5565">     let dlgMsg = bundle.getFormattedString(&quot;SaveDialogMsg&quot;,</span>
<a href="#l3.5566"></a><span id="l3.5566">                                            [msgfolder.name,</span>
<a href="#l3.5567"></a><span id="l3.5567">                                             msgfolder.server.prettyName]);</span>
<a href="#l3.5568"></a><span id="l3.5568"> </span>
<a href="#l3.5569"></a><span id="l3.5569" class="difflineminus">-    let CheckMsg = bundle.getString(&quot;CheckMsg&quot;);</span>
<a href="#l3.5570"></a><span id="l3.5570" class="difflineminus">-    Services.prompt</span>
<a href="#l3.5571"></a><span id="l3.5571" class="difflineminus">-            .alertCheck(window, SaveDlgTitle, dlgMsg,</span>
<a href="#l3.5572"></a><span id="l3.5572" class="difflineminus">-                        getComposeBundle().getString(&quot;CheckMsg&quot;), checkbox);</span>
<a href="#l3.5573"></a><span id="l3.5573" class="difflineplus">+    Services.prompt.alertCheck(window, SaveDlgTitle, dlgMsg,</span>
<a href="#l3.5574"></a><span id="l3.5574" class="difflineplus">+                               bundle.getString(&quot;CheckMsg&quot;), checkbox);</span>
<a href="#l3.5575"></a><span id="l3.5575">     try {</span>
<a href="#l3.5576"></a><span id="l3.5576" class="difflineminus">-          gCurrentIdentity.showSaveMsgDlg = !checkbox.value;</span>
<a href="#l3.5577"></a><span id="l3.5577" class="difflineminus">-    }//try</span>
<a href="#l3.5578"></a><span id="l3.5578" class="difflineminus">-    catch (e) {</span>
<a href="#l3.5579"></a><span id="l3.5579" class="difflineminus">-    return;</span>
<a href="#l3.5580"></a><span id="l3.5580" class="difflineminus">-    }//catch</span>
<a href="#l3.5581"></a><span id="l3.5581" class="difflineminus">-</span>
<a href="#l3.5582"></a><span id="l3.5582" class="difflineminus">-  }//if</span>
<a href="#l3.5583"></a><span id="l3.5583" class="difflineminus">-  return;</span>
<a href="#l3.5584"></a><span id="l3.5584" class="difflineminus">-}</span>
<a href="#l3.5585"></a><span id="l3.5585" class="difflineminus">-</span>
<a href="#l3.5586"></a><span id="l3.5586" class="difflineminus">-function SetMsgAddressingWidgetTreeElementFocus()</span>
<a href="#l3.5587"></a><span id="l3.5587" class="difflineminus">-{</span>
<a href="#l3.5588"></a><span id="l3.5588" class="difflineplus">+      gCurrentIdentity.showSaveMsgDlg = !checkbox.value;</span>
<a href="#l3.5589"></a><span id="l3.5589" class="difflineplus">+    } catch (e) {</span>
<a href="#l3.5590"></a><span id="l3.5590" class="difflineplus">+    }</span>
<a href="#l3.5591"></a><span id="l3.5591" class="difflineplus">+  }</span>
<a href="#l3.5592"></a><span id="l3.5592" class="difflineplus">+}</span>
<a href="#l3.5593"></a><span id="l3.5593" class="difflineplus">+</span>
<a href="#l3.5594"></a><span id="l3.5594" class="difflineplus">+function SetMsgAddressingWidgetTreeElementFocus() {</span>
<a href="#l3.5595"></a><span id="l3.5595">   let lastRecipientInputElement = awGetInputElement(awGetNumberOfRecipients());</span>
<a href="#l3.5596"></a><span id="l3.5596">   awSetFocus(awGetNumberOfRecipients(), lastRecipientInputElement);</span>
<a href="#l3.5597"></a><span id="l3.5597"> }</span>
<a href="#l3.5598"></a><span id="l3.5598"> </span>
<a href="#l3.5599"></a><span id="l3.5599" class="difflineminus">-function SetMsgIdentityElementFocus()</span>
<a href="#l3.5600"></a><span id="l3.5600" class="difflineminus">-{</span>
<a href="#l3.5601"></a><span id="l3.5601" class="difflineplus">+function SetMsgIdentityElementFocus() {</span>
<a href="#l3.5602"></a><span id="l3.5602">   GetMsgIdentityElement().focus();</span>
<a href="#l3.5603"></a><span id="l3.5603"> }</span>
<a href="#l3.5604"></a><span id="l3.5604"> </span>
<a href="#l3.5605"></a><span id="l3.5605" class="difflineminus">-function SetMsgSubjectElementFocus()</span>
<a href="#l3.5606"></a><span id="l3.5606" class="difflineminus">-{</span>
<a href="#l3.5607"></a><span id="l3.5607" class="difflineplus">+function SetMsgSubjectElementFocus() {</span>
<a href="#l3.5608"></a><span id="l3.5608">   GetMsgSubjectElement().focus();</span>
<a href="#l3.5609"></a><span id="l3.5609"> }</span>
<a href="#l3.5610"></a><span id="l3.5610"> </span>
<a href="#l3.5611"></a><span id="l3.5611" class="difflineminus">-function SetMsgAttachmentElementFocus()</span>
<a href="#l3.5612"></a><span id="l3.5612" class="difflineminus">-{</span>
<a href="#l3.5613"></a><span id="l3.5613" class="difflineplus">+function SetMsgAttachmentElementFocus() {</span>
<a href="#l3.5614"></a><span id="l3.5614">   // Caveat: Callers must ensure that attachment pane is visible.</span>
<a href="#l3.5615"></a><span id="l3.5615">   GetMsgAttachmentElement().focus();</span>
<a href="#l3.5616"></a><span id="l3.5616"> }</span>
<a href="#l3.5617"></a><span id="l3.5617"> </span>
<a href="#l3.5618"></a><span id="l3.5618"> /**</span>
<a href="#l3.5619"></a><span id="l3.5619">  * Focus the people search input in contacts side bar.</span>
<a href="#l3.5620"></a><span id="l3.5620">  */</span>
<a href="#l3.5621"></a><span id="l3.5621"> function focusContactsSidebarSearchInput() {</span>
<a href="#l3.5622"></a><span id="l3.5622">   // Caveat: Callers must ensure that contacts side bar is visible.</span>
<a href="#l3.5623"></a><span id="l3.5623">   sidebarDocumentGetElementById(&quot;peopleSearchInput&quot;, &quot;abContactsPanel&quot;).focus();</span>
<a href="#l3.5624"></a><span id="l3.5624"> }</span>
<a href="#l3.5625"></a><span id="l3.5625"> </span>
<a href="#l3.5626"></a><span id="l3.5626" class="difflineminus">-function SetMsgBodyFrameFocus()</span>
<a href="#l3.5627"></a><span id="l3.5627" class="difflineminus">-{</span>
<a href="#l3.5628"></a><span id="l3.5628" class="difflineplus">+function SetMsgBodyFrameFocus() {</span>
<a href="#l3.5629"></a><span id="l3.5629">   // window.content.focus() fails to blur the currently focused element</span>
<a href="#l3.5630"></a><span id="l3.5630">   document.commandDispatcher</span>
<a href="#l3.5631"></a><span id="l3.5631">           .advanceFocusIntoSubtree(document.getElementById(&quot;appcontent&quot;));</span>
<a href="#l3.5632"></a><span id="l3.5632"> }</span>
<a href="#l3.5633"></a><span id="l3.5633"> </span>
<a href="#l3.5634"></a><span id="l3.5634" class="difflineminus">-function GetMsgAddressingWidgetTreeElement()</span>
<a href="#l3.5635"></a><span id="l3.5635" class="difflineminus">-{</span>
<a href="#l3.5636"></a><span id="l3.5636" class="difflineplus">+function GetMsgAddressingWidgetTreeElement() {</span>
<a href="#l3.5637"></a><span id="l3.5637">   if (!gMsgAddressingWidgetTreeElement)</span>
<a href="#l3.5638"></a><span id="l3.5638">     gMsgAddressingWidgetTreeElement = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l3.5639"></a><span id="l3.5639"> </span>
<a href="#l3.5640"></a><span id="l3.5640">   return gMsgAddressingWidgetTreeElement;</span>
<a href="#l3.5641"></a><span id="l3.5641"> }</span>
<a href="#l3.5642"></a><span id="l3.5642"> </span>
<a href="#l3.5643"></a><span id="l3.5643" class="difflineminus">-function GetMsgIdentityElement()</span>
<a href="#l3.5644"></a><span id="l3.5644" class="difflineminus">-{</span>
<a href="#l3.5645"></a><span id="l3.5645" class="difflineplus">+function GetMsgIdentityElement() {</span>
<a href="#l3.5646"></a><span id="l3.5646">   if (!gMsgIdentityElement)</span>
<a href="#l3.5647"></a><span id="l3.5647">     gMsgIdentityElement = document.getElementById(&quot;msgIdentity&quot;);</span>
<a href="#l3.5648"></a><span id="l3.5648"> </span>
<a href="#l3.5649"></a><span id="l3.5649">   return gMsgIdentityElement;</span>
<a href="#l3.5650"></a><span id="l3.5650"> }</span>
<a href="#l3.5651"></a><span id="l3.5651"> </span>
<a href="#l3.5652"></a><span id="l3.5652" class="difflineminus">-function GetMsgSubjectElement()</span>
<a href="#l3.5653"></a><span id="l3.5653" class="difflineminus">-{</span>
<a href="#l3.5654"></a><span id="l3.5654" class="difflineplus">+function GetMsgSubjectElement() {</span>
<a href="#l3.5655"></a><span id="l3.5655">   if (!gMsgSubjectElement)</span>
<a href="#l3.5656"></a><span id="l3.5656">     gMsgSubjectElement = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l3.5657"></a><span id="l3.5657"> </span>
<a href="#l3.5658"></a><span id="l3.5658">   return gMsgSubjectElement;</span>
<a href="#l3.5659"></a><span id="l3.5659"> }</span>
<a href="#l3.5660"></a><span id="l3.5660"> </span>
<a href="#l3.5661"></a><span id="l3.5661" class="difflineminus">-function GetMsgAttachmentElement()</span>
<a href="#l3.5662"></a><span id="l3.5662" class="difflineminus">-{</span>
<a href="#l3.5663"></a><span id="l3.5663" class="difflineplus">+function GetMsgAttachmentElement() {</span>
<a href="#l3.5664"></a><span id="l3.5664">   if (!gMsgAttachmentElement)</span>
<a href="#l3.5665"></a><span id="l3.5665">     gMsgAttachmentElement = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l3.5666"></a><span id="l3.5666"> </span>
<a href="#l3.5667"></a><span id="l3.5667">   return gMsgAttachmentElement;</span>
<a href="#l3.5668"></a><span id="l3.5668"> }</span>
<a href="#l3.5669"></a><span id="l3.5669"> </span>
<a href="#l3.5670"></a><span id="l3.5670"> /**</span>
<a href="#l3.5671"></a><span id="l3.5671">  * Get an element by ID in the current sidebar browser document.</span>
<a href="#l3.5672"></a><span id="l3.5672" class="difflineat">@@ -6355,41 +6073,39 @@ function sidebarDocumentGetElementById(a</span>
<a href="#l3.5673"></a><span id="l3.5673">     if (sidebarDocument.getElementById(aPageId)) {</span>
<a href="#l3.5674"></a><span id="l3.5674">       return sidebarDocument.getElementById(aId);</span>
<a href="#l3.5675"></a><span id="l3.5675">     }</span>
<a href="#l3.5676"></a><span id="l3.5676">     return null;</span>
<a href="#l3.5677"></a><span id="l3.5677">   }</span>
<a href="#l3.5678"></a><span id="l3.5678">   return sidebarDocument.getElementById(aId);</span>
<a href="#l3.5679"></a><span id="l3.5679"> }</span>
<a href="#l3.5680"></a><span id="l3.5680"> </span>
<a href="#l3.5681"></a><span id="l3.5681" class="difflineminus">-function GetMsgHeadersToolbarElement()</span>
<a href="#l3.5682"></a><span id="l3.5682" class="difflineminus">-{</span>
<a href="#l3.5683"></a><span id="l3.5683" class="difflineplus">+function GetMsgHeadersToolbarElement() {</span>
<a href="#l3.5684"></a><span id="l3.5684">   if (!gMsgHeadersToolbarElement)</span>
<a href="#l3.5685"></a><span id="l3.5685">     gMsgHeadersToolbarElement = document.getElementById(&quot;MsgHeadersToolbar&quot;);</span>
<a href="#l3.5686"></a><span id="l3.5686"> </span>
<a href="#l3.5687"></a><span id="l3.5687">   return gMsgHeadersToolbarElement;</span>
<a href="#l3.5688"></a><span id="l3.5688"> }</span>
<a href="#l3.5689"></a><span id="l3.5689"> </span>
<a href="#l3.5690"></a><span id="l3.5690"> /**</span>
<a href="#l3.5691"></a><span id="l3.5691">  * Determine which element of the fast-track focus ring has focus.</span>
<a href="#l3.5692"></a><span id="l3.5692">  * Note that only elements of the fast-track focus ring will be returned.</span>
<a href="#l3.5693"></a><span id="l3.5693">  *</span>
<a href="#l3.5694"></a><span id="l3.5694">  * @return an element node of the fast-track focus ring if the node or one of</span>
<a href="#l3.5695"></a><span id="l3.5695">  *         its descendants has focus, otherwise null.</span>
<a href="#l3.5696"></a><span id="l3.5696">  */</span>
<a href="#l3.5697"></a><span id="l3.5697" class="difflineminus">-function WhichElementHasFocus()</span>
<a href="#l3.5698"></a><span id="l3.5698" class="difflineminus">-{</span>
<a href="#l3.5699"></a><span id="l3.5699" class="difflineplus">+function WhichElementHasFocus() {</span>
<a href="#l3.5700"></a><span id="l3.5700">   let msgIdentityElement = GetMsgIdentityElement();</span>
<a href="#l3.5701"></a><span id="l3.5701">   let msgAddressingWidgetTreeElement = GetMsgAddressingWidgetTreeElement();</span>
<a href="#l3.5702"></a><span id="l3.5702">   let msgSubjectElement = GetMsgSubjectElement();</span>
<a href="#l3.5703"></a><span id="l3.5703">   let msgAttachmentElement = GetMsgAttachmentElement();</span>
<a href="#l3.5704"></a><span id="l3.5704">   let abContactsPanelElement = sidebarDocumentGetElementById(&quot;abContactsPanel&quot;);</span>
<a href="#l3.5705"></a><span id="l3.5705"> </span>
<a href="#l3.5706"></a><span id="l3.5706" class="difflineminus">-  if (top.document.commandDispatcher.focusedWindow == content)</span>
<a href="#l3.5707"></a><span id="l3.5707" class="difflineminus">-    return content;</span>
<a href="#l3.5708"></a><span id="l3.5708" class="difflineplus">+  if (top.document.commandDispatcher.focusedWindow == window.content)</span>
<a href="#l3.5709"></a><span id="l3.5709" class="difflineplus">+    return window.content;</span>
<a href="#l3.5710"></a><span id="l3.5710"> </span>
<a href="#l3.5711"></a><span id="l3.5711">   let currentNode = top.document.commandDispatcher.focusedElement;</span>
<a href="#l3.5712"></a><span id="l3.5712">   while (currentNode) {</span>
<a href="#l3.5713"></a><span id="l3.5713">     if (currentNode == msgIdentityElement ||</span>
<a href="#l3.5714"></a><span id="l3.5714">         currentNode == msgAddressingWidgetTreeElement ||</span>
<a href="#l3.5715"></a><span id="l3.5715">         currentNode == msgSubjectElement ||</span>
<a href="#l3.5716"></a><span id="l3.5716">         currentNode == msgAttachmentElement ||</span>
<a href="#l3.5717"></a><span id="l3.5717">         currentNode == abContactsPanelElement) {</span>
<a href="#l3.5718"></a><span id="l3.5718" class="difflineat">@@ -6406,18 +6122,17 @@ function WhichElementHasFocus()</span>
<a href="#l3.5719"></a><span id="l3.5719">  * in the message compose window. Ctrl+[Shift+]Tab | [Shift+]F6 on Windows.</span>
<a href="#l3.5720"></a><span id="l3.5720">  *</span>
<a href="#l3.5721"></a><span id="l3.5721">  * The default element to switch to when going in either direction (with or</span>
<a href="#l3.5722"></a><span id="l3.5722">  * without shift key pressed) is the AddressingWidgetTreeElement.</span>
<a href="#l3.5723"></a><span id="l3.5723">  *</span>
<a href="#l3.5724"></a><span id="l3.5724">  * The only exception is when the MsgHeadersToolbar is collapsed,</span>
<a href="#l3.5725"></a><span id="l3.5725">  * then the focus will always be on the body of the message.</span>
<a href="#l3.5726"></a><span id="l3.5726">  */</span>
<a href="#l3.5727"></a><span id="l3.5727" class="difflineminus">-function SwitchElementFocus(event)</span>
<a href="#l3.5728"></a><span id="l3.5728" class="difflineminus">-{</span>
<a href="#l3.5729"></a><span id="l3.5729" class="difflineplus">+function SwitchElementFocus(event) {</span>
<a href="#l3.5730"></a><span id="l3.5730">   let focusedElement = WhichElementHasFocus();</span>
<a href="#l3.5731"></a><span id="l3.5731"> </span>
<a href="#l3.5732"></a><span id="l3.5732">   if (!focusedElement) {</span>
<a href="#l3.5733"></a><span id="l3.5733">     // None of the pre-defined focus ring elements has focus: This should never</span>
<a href="#l3.5734"></a><span id="l3.5734">     // happen with the default installation, but might happen with add-ons.</span>
<a href="#l3.5735"></a><span id="l3.5735">     // In that case, default to focusing the address widget as the first element</span>
<a href="#l3.5736"></a><span id="l3.5736">     // of the focus ring.</span>
<a href="#l3.5737"></a><span id="l3.5737">     SetMsgAddressingWidgetTreeElementFocus();</span>
<a href="#l3.5738"></a><span id="l3.5738" class="difflineat">@@ -6436,17 +6151,17 @@ function SwitchElementFocus(event)</span>
<a href="#l3.5739"></a><span id="l3.5739">             sidebarDocumentGetElementById(&quot;abContactsPanel&quot;))</span>
<a href="#l3.5740"></a><span id="l3.5740">           focusContactsSidebarSearchInput();</span>
<a href="#l3.5741"></a><span id="l3.5741">         else</span>
<a href="#l3.5742"></a><span id="l3.5742">           SetMsgBodyFrameFocus();</span>
<a href="#l3.5743"></a><span id="l3.5743">         break;</span>
<a href="#l3.5744"></a><span id="l3.5744">       case sidebarDocumentGetElementById(&quot;abContactsPanel&quot;):</span>
<a href="#l3.5745"></a><span id="l3.5745">         SetMsgBodyFrameFocus();</span>
<a href="#l3.5746"></a><span id="l3.5746">         break;</span>
<a href="#l3.5747"></a><span id="l3.5747" class="difflineminus">-      case content: // message body</span>
<a href="#l3.5748"></a><span id="l3.5748" class="difflineplus">+      case window.content: // message body</span>
<a href="#l3.5749"></a><span id="l3.5749">         // Only set focus to the attachment element if it is shown.</span>
<a href="#l3.5750"></a><span id="l3.5750">         if (!document.getElementById(&quot;attachments-box&quot;).collapsed)</span>
<a href="#l3.5751"></a><span id="l3.5751">           SetMsgAttachmentElementFocus();</span>
<a href="#l3.5752"></a><span id="l3.5752">         else</span>
<a href="#l3.5753"></a><span id="l3.5753">           SetMsgSubjectElementFocus();</span>
<a href="#l3.5754"></a><span id="l3.5754">         break;</span>
<a href="#l3.5755"></a><span id="l3.5755">       case gMsgAttachmentElement:</span>
<a href="#l3.5756"></a><span id="l3.5756">         SetMsgSubjectElementFocus();</span>
<a href="#l3.5757"></a><span id="l3.5757" class="difflineat">@@ -6466,17 +6181,17 @@ function SwitchElementFocus(event)</span>
<a href="#l3.5758"></a><span id="l3.5758">         if (!document.getElementById(&quot;attachments-box&quot;).collapsed)</span>
<a href="#l3.5759"></a><span id="l3.5759">           SetMsgAttachmentElementFocus();</span>
<a href="#l3.5760"></a><span id="l3.5760">         else</span>
<a href="#l3.5761"></a><span id="l3.5761">           SetMsgBodyFrameFocus();</span>
<a href="#l3.5762"></a><span id="l3.5762">         break;</span>
<a href="#l3.5763"></a><span id="l3.5763">       case gMsgAttachmentElement:</span>
<a href="#l3.5764"></a><span id="l3.5764">         SetMsgBodyFrameFocus();</span>
<a href="#l3.5765"></a><span id="l3.5765">         break;</span>
<a href="#l3.5766"></a><span id="l3.5766" class="difflineminus">-      case content:</span>
<a href="#l3.5767"></a><span id="l3.5767" class="difflineplus">+      case window.content:</span>
<a href="#l3.5768"></a><span id="l3.5768">         // Only set focus to the contacts side bar (search box) if it is shown.</span>
<a href="#l3.5769"></a><span id="l3.5769">         if (!sidebar_is_hidden() &amp;&amp;</span>
<a href="#l3.5770"></a><span id="l3.5770">             sidebarDocumentGetElementById(&quot;abContactsPanel&quot;))</span>
<a href="#l3.5771"></a><span id="l3.5771">           focusContactsSidebarSearchInput();</span>
<a href="#l3.5772"></a><span id="l3.5772">         else</span>
<a href="#l3.5773"></a><span id="l3.5773">           SetMsgIdentityElementFocus();</span>
<a href="#l3.5774"></a><span id="l3.5774">         break;</span>
<a href="#l3.5775"></a><span id="l3.5775">       case sidebarDocumentGetElementById(&quot;abContactsPanel&quot;):</span>
<a href="#l3.5776"></a><span id="l3.5776" class="difflineat">@@ -6488,33 +6203,32 @@ function SwitchElementFocus(event)</span>
<a href="#l3.5777"></a><span id="l3.5777">     }</span>
<a href="#l3.5778"></a><span id="l3.5778">   }</span>
<a href="#l3.5779"></a><span id="l3.5779"> }</span>
<a href="#l3.5780"></a><span id="l3.5780"> </span>
<a href="#l3.5781"></a><span id="l3.5781"> function sidebarCloseButtonOnCommand() {</span>
<a href="#l3.5782"></a><span id="l3.5782">   toggleAddressPicker();</span>
<a href="#l3.5783"></a><span id="l3.5783"> }</span>
<a href="#l3.5784"></a><span id="l3.5784"> </span>
<a href="#l3.5785"></a><span id="l3.5785" class="difflineminus">-function toggleAddressPicker()</span>
<a href="#l3.5786"></a><span id="l3.5786" class="difflineminus">-{</span>
<a href="#l3.5787"></a><span id="l3.5787" class="difflineplus">+function toggleAddressPicker() {</span>
<a href="#l3.5788"></a><span id="l3.5788">   // Caveat: This function erroneously assumes that only abContactsPanel can</span>
<a href="#l3.5789"></a><span id="l3.5789">   // be shown in the sidebar browser, so it will fail if any other src is shown</span>
<a href="#l3.5790"></a><span id="l3.5790">   // as we do not reliably enforce abContactsPanel.xul as src of the sidebar</span>
<a href="#l3.5791"></a><span id="l3.5791">   // &lt;browser&gt;. Currently we don't show anything else in the sidebar, but</span>
<a href="#l3.5792"></a><span id="l3.5792">   // add-ons might.</span>
<a href="#l3.5793"></a><span id="l3.5793">   let sidebarBox = document.getElementById(&quot;sidebar-box&quot;);</span>
<a href="#l3.5794"></a><span id="l3.5794">   let sidebarSplitter = document.getElementById(&quot;sidebar-splitter&quot;);</span>
<a href="#l3.5795"></a><span id="l3.5795">   let sidebar = document.getElementById(&quot;sidebar&quot;);</span>
<a href="#l3.5796"></a><span id="l3.5796">   let viewAddressPicker = document.getElementById(&quot;viewAddressPicker&quot;);</span>
<a href="#l3.5797"></a><span id="l3.5797"> </span>
<a href="#l3.5798"></a><span id="l3.5798">   if (sidebarBox.hidden) {</span>
<a href="#l3.5799"></a><span id="l3.5799">     // Show contacts sidebar.</span>
<a href="#l3.5800"></a><span id="l3.5800">     sidebarBox.hidden = false;</span>
<a href="#l3.5801"></a><span id="l3.5801">     sidebarSplitter.hidden = false;</span>
<a href="#l3.5802"></a><span id="l3.5802" class="difflineminus">-    viewAddressPicker.setAttribute(&quot;checked&quot;,&quot;true&quot;);</span>
<a href="#l3.5803"></a><span id="l3.5803" class="difflineplus">+    viewAddressPicker.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l3.5804"></a><span id="l3.5804"> </span>
<a href="#l3.5805"></a><span id="l3.5805">     let sidebarUrl = sidebar.getAttribute(&quot;src&quot;);</span>
<a href="#l3.5806"></a><span id="l3.5806">     // If we have yet to initialize the src URL on the sidebar, then go ahead</span>
<a href="#l3.5807"></a><span id="l3.5807">     // and do so now... We do this lazily here, so we don't spend time when</span>
<a href="#l3.5808"></a><span id="l3.5808">     // bringing up the compose window loading the address book data sources.</span>
<a href="#l3.5809"></a><span id="l3.5809">     // Only when the user opens the address picker, do we set the src URL</span>
<a href="#l3.5810"></a><span id="l3.5810">     // for the sidebar.</span>
<a href="#l3.5811"></a><span id="l3.5811">     if (sidebarUrl == &quot;&quot;)</span>
<a href="#l3.5812"></a><span id="l3.5812" class="difflineat">@@ -6543,96 +6257,87 @@ function toggleAddressPicker()</span>
<a href="#l3.5813"></a><span id="l3.5813">     // otherwise the body. If we didn't do that, focus may stay inside the closed</span>
<a href="#l3.5814"></a><span id="l3.5814">     // Contacts sidebar and then the main window/frame does not respond to accesskeys.</span>
<a href="#l3.5815"></a><span id="l3.5815">     // This may be fixed by bug 570835.</span>
<a href="#l3.5816"></a><span id="l3.5816">     let composerBox = document.getElementById(&quot;headers-parent&quot;);</span>
<a href="#l3.5817"></a><span id="l3.5817">     let focusedElement = composerBox.querySelector(&quot;:focus&quot;) ||</span>
<a href="#l3.5818"></a><span id="l3.5818">                          composerBox.querySelector('[focused=&quot;true&quot;]');</span>
<a href="#l3.5819"></a><span id="l3.5819">     if (focusedElement) {</span>
<a href="#l3.5820"></a><span id="l3.5820">       focusedElement.focus();</span>
<a href="#l3.5821"></a><span id="l3.5821" class="difflineplus">+    } else if (!GetMsgSubjectElement().value) {</span>
<a href="#l3.5822"></a><span id="l3.5822" class="difflineplus">+      SetMsgSubjectElementFocus();</span>
<a href="#l3.5823"></a><span id="l3.5823">     } else {</span>
<a href="#l3.5824"></a><span id="l3.5824" class="difflineminus">-      if (!GetMsgSubjectElement().value)</span>
<a href="#l3.5825"></a><span id="l3.5825" class="difflineminus">-        SetMsgSubjectElementFocus();</span>
<a href="#l3.5826"></a><span id="l3.5826" class="difflineminus">-      else</span>
<a href="#l3.5827"></a><span id="l3.5827" class="difflineminus">-        SetMsgBodyFrameFocus();</span>
<a href="#l3.5828"></a><span id="l3.5828" class="difflineplus">+      SetMsgBodyFrameFocus();</span>
<a href="#l3.5829"></a><span id="l3.5829">     }</span>
<a href="#l3.5830"></a><span id="l3.5830">   }</span>
<a href="#l3.5831"></a><span id="l3.5831"> }</span>
<a href="#l3.5832"></a><span id="l3.5832"> </span>
<a href="#l3.5833"></a><span id="l3.5833"> // Public method called by addons.</span>
<a href="#l3.5834"></a><span id="l3.5834" class="difflineminus">-function AddRecipient(aRecipientType, aAddress)</span>
<a href="#l3.5835"></a><span id="l3.5835" class="difflineminus">-{</span>
<a href="#l3.5836"></a><span id="l3.5836" class="difflineplus">+function AddRecipient(aRecipientType, aAddress) {</span>
<a href="#l3.5837"></a><span id="l3.5837">   awAddRecipientsArray(aRecipientType, [aAddress]);</span>
<a href="#l3.5838"></a><span id="l3.5838"> }</span>
<a href="#l3.5839"></a><span id="l3.5839"> </span>
<a href="#l3.5840"></a><span id="l3.5840"> // Public method called by the contants sidebar.</span>
<a href="#l3.5841"></a><span id="l3.5841" class="difflineminus">-function AddRecipientsArray(aRecipientType, aAddressArray)</span>
<a href="#l3.5842"></a><span id="l3.5842" class="difflineminus">-{</span>
<a href="#l3.5843"></a><span id="l3.5843" class="difflineplus">+function AddRecipientsArray(aRecipientType, aAddressArray) {</span>
<a href="#l3.5844"></a><span id="l3.5844">   awAddRecipientsArray(aRecipientType, aAddressArray);</span>
<a href="#l3.5845"></a><span id="l3.5845"> }</span>
<a href="#l3.5846"></a><span id="l3.5846"> </span>
<a href="#l3.5847"></a><span id="l3.5847" class="difflineminus">-function loadHTMLMsgPrefs()</span>
<a href="#l3.5848"></a><span id="l3.5848" class="difflineminus">-{</span>
<a href="#l3.5849"></a><span id="l3.5849" class="difflineplus">+function loadHTMLMsgPrefs() {</span>
<a href="#l3.5850"></a><span id="l3.5850">   var fontFace;</span>
<a href="#l3.5851"></a><span id="l3.5851">   var fontSize;</span>
<a href="#l3.5852"></a><span id="l3.5852">   var textColor;</span>
<a href="#l3.5853"></a><span id="l3.5853">   var bgColor;</span>
<a href="#l3.5854"></a><span id="l3.5854"> </span>
<a href="#l3.5855"></a><span id="l3.5855">   try {</span>
<a href="#l3.5856"></a><span id="l3.5856">     fontFace = getPref(&quot;msgcompose.font_face&quot;, true);</span>
<a href="#l3.5857"></a><span id="l3.5857" class="difflineminus">-    doStatefulCommand('cmd_fontFace', fontFace);</span>
<a href="#l3.5858"></a><span id="l3.5858" class="difflineplus">+    doStatefulCommand(&quot;cmd_fontFace&quot;, fontFace);</span>
<a href="#l3.5859"></a><span id="l3.5859">   } catch (e) {}</span>
<a href="#l3.5860"></a><span id="l3.5860"> </span>
<a href="#l3.5861"></a><span id="l3.5861">   try {</span>
<a href="#l3.5862"></a><span id="l3.5862">     fontSize = getPref(&quot;msgcompose.font_size&quot;);</span>
<a href="#l3.5863"></a><span id="l3.5863">     EditorSetFontSize(fontSize);</span>
<a href="#l3.5864"></a><span id="l3.5864">   } catch (e) {}</span>
<a href="#l3.5865"></a><span id="l3.5865"> </span>
<a href="#l3.5866"></a><span id="l3.5866">   var bodyElement = GetBodyElement();</span>
<a href="#l3.5867"></a><span id="l3.5867"> </span>
<a href="#l3.5868"></a><span id="l3.5868">   try {</span>
<a href="#l3.5869"></a><span id="l3.5869">     textColor = getPref(&quot;msgcompose.text_color&quot;);</span>
<a href="#l3.5870"></a><span id="l3.5870" class="difflineminus">-    if (!bodyElement.getAttribute(&quot;text&quot;))</span>
<a href="#l3.5871"></a><span id="l3.5871" class="difflineminus">-    {</span>
<a href="#l3.5872"></a><span id="l3.5872" class="difflineminus">-    bodyElement.setAttribute(&quot;text&quot;, textColor);</span>
<a href="#l3.5873"></a><span id="l3.5873" class="difflineminus">-    gDefaultTextColor = textColor;</span>
<a href="#l3.5874"></a><span id="l3.5874" class="difflineminus">-    document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);</span>
<a href="#l3.5875"></a><span id="l3.5875" class="difflineminus">-    onFontColorChange();</span>
<a href="#l3.5876"></a><span id="l3.5876" class="difflineplus">+    if (!bodyElement.getAttribute(&quot;text&quot;)) {</span>
<a href="#l3.5877"></a><span id="l3.5877" class="difflineplus">+      bodyElement.setAttribute(&quot;text&quot;, textColor);</span>
<a href="#l3.5878"></a><span id="l3.5878" class="difflineplus">+      gDefaultTextColor = textColor;</span>
<a href="#l3.5879"></a><span id="l3.5879" class="difflineplus">+      document.getElementById(&quot;cmd_fontColor&quot;).setAttribute(&quot;state&quot;, textColor);</span>
<a href="#l3.5880"></a><span id="l3.5880" class="difflineplus">+      onFontColorChange();</span>
<a href="#l3.5881"></a><span id="l3.5881">     }</span>
<a href="#l3.5882"></a><span id="l3.5882">   } catch (e) {}</span>
<a href="#l3.5883"></a><span id="l3.5883"> </span>
<a href="#l3.5884"></a><span id="l3.5884">   try {</span>
<a href="#l3.5885"></a><span id="l3.5885">     bgColor = getPref(&quot;msgcompose.background_color&quot;);</span>
<a href="#l3.5886"></a><span id="l3.5886" class="difflineminus">-    if (!bodyElement.getAttribute(&quot;bgcolor&quot;))</span>
<a href="#l3.5887"></a><span id="l3.5887" class="difflineminus">-    {</span>
<a href="#l3.5888"></a><span id="l3.5888" class="difflineminus">-    bodyElement.setAttribute(&quot;bgcolor&quot;, bgColor);</span>
<a href="#l3.5889"></a><span id="l3.5889" class="difflineminus">-    gDefaultBackgroundColor = bgColor;</span>
<a href="#l3.5890"></a><span id="l3.5890" class="difflineminus">-    document.getElementById(&quot;cmd_backgroundColor&quot;).setAttribute(&quot;state&quot;, bgColor);</span>
<a href="#l3.5891"></a><span id="l3.5891" class="difflineminus">-    onBackgroundColorChange();</span>
<a href="#l3.5892"></a><span id="l3.5892" class="difflineplus">+    if (!bodyElement.getAttribute(&quot;bgcolor&quot;)) {</span>
<a href="#l3.5893"></a><span id="l3.5893" class="difflineplus">+      bodyElement.setAttribute(&quot;bgcolor&quot;, bgColor);</span>
<a href="#l3.5894"></a><span id="l3.5894" class="difflineplus">+      gDefaultBackgroundColor = bgColor;</span>
<a href="#l3.5895"></a><span id="l3.5895" class="difflineplus">+      document.getElementById(&quot;cmd_backgroundColor&quot;).setAttribute(&quot;state&quot;, bgColor);</span>
<a href="#l3.5896"></a><span id="l3.5896" class="difflineplus">+      onBackgroundColorChange();</span>
<a href="#l3.5897"></a><span id="l3.5897">     }</span>
<a href="#l3.5898"></a><span id="l3.5898">   } catch (e) {}</span>
<a href="#l3.5899"></a><span id="l3.5899"> }</span>
<a href="#l3.5900"></a><span id="l3.5900"> </span>
<a href="#l3.5901"></a><span id="l3.5901" class="difflineminus">-function AutoSave()</span>
<a href="#l3.5902"></a><span id="l3.5902" class="difflineminus">-{</span>
<a href="#l3.5903"></a><span id="l3.5903" class="difflineplus">+function AutoSave() {</span>
<a href="#l3.5904"></a><span id="l3.5904">   if (gMsgCompose.editor &amp;&amp; (gContentChanged || gMsgCompose.bodyModified) &amp;&amp;</span>
<a href="#l3.5905"></a><span id="l3.5905" class="difflineminus">-      !gSendOperationInProgress &amp;&amp; !gSaveOperationInProgress)</span>
<a href="#l3.5906"></a><span id="l3.5906" class="difflineminus">-  {</span>
<a href="#l3.5907"></a><span id="l3.5907" class="difflineminus">-    GenericSendMessage(nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.5908"></a><span id="l3.5908" class="difflineplus">+      !gSendOperationInProgress &amp;&amp; !gSaveOperationInProgress) {</span>
<a href="#l3.5909"></a><span id="l3.5909" class="difflineplus">+    GenericSendMessage(Ci.nsIMsgCompDeliverMode.AutoSaveAsDraft);</span>
<a href="#l3.5910"></a><span id="l3.5910">     gAutoSaveKickedIn = true;</span>
<a href="#l3.5911"></a><span id="l3.5911">   }</span>
<a href="#l3.5912"></a><span id="l3.5912"> </span>
<a href="#l3.5913"></a><span id="l3.5913">   gAutoSaveTimeout = setTimeout(AutoSave, gAutoSaveInterval);</span>
<a href="#l3.5914"></a><span id="l3.5914"> }</span>
<a href="#l3.5915"></a><span id="l3.5915"> </span>
<a href="#l3.5916"></a><span id="l3.5916"> /**</span>
<a href="#l3.5917"></a><span id="l3.5917">  * Periodically check for keywords in the message.</span>
<a href="#l3.5918"></a><span id="l3.5918">  */</span>
<a href="#l3.5919"></a><span id="l3.5919" class="difflineminus">-var gAttachmentNotifier =</span>
<a href="#l3.5920"></a><span id="l3.5920" class="difflineminus">-{</span>
<a href="#l3.5921"></a><span id="l3.5921" class="difflineplus">+var gAttachmentNotifier = {</span>
<a href="#l3.5922"></a><span id="l3.5922">   _obs: null,</span>
<a href="#l3.5923"></a><span id="l3.5923"> </span>
<a href="#l3.5924"></a><span id="l3.5924">   enabled: false,</span>
<a href="#l3.5925"></a><span id="l3.5925"> </span>
<a href="#l3.5926"></a><span id="l3.5926">   init: function gAN_init(aDocument) {</span>
<a href="#l3.5927"></a><span id="l3.5927">     if (this._obs)</span>
<a href="#l3.5928"></a><span id="l3.5928">       this.shutdown();</span>
<a href="#l3.5929"></a><span id="l3.5929"> </span>
<a href="#l3.5930"></a><span id="l3.5930" class="difflineat">@@ -6671,34 +6376,33 @@ var gAttachmentNotifier =</span>
<a href="#l3.5931"></a><span id="l3.5931">                                                Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l3.5932"></a><span id="l3.5932">   },</span>
<a href="#l3.5933"></a><span id="l3.5933"> </span>
<a href="#l3.5934"></a><span id="l3.5934">   /**</span>
<a href="#l3.5935"></a><span id="l3.5935">    * Checks for new keywords synchronously and run the usual handler.</span>
<a href="#l3.5936"></a><span id="l3.5936">    *</span>
<a href="#l3.5937"></a><span id="l3.5937">    * @param aManage  Determines whether to manage the notification according to keywords found.</span>
<a href="#l3.5938"></a><span id="l3.5938">    */</span>
<a href="#l3.5939"></a><span id="l3.5939" class="difflineminus">-  redetectKeywords: function(aManage) {</span>
<a href="#l3.5940"></a><span id="l3.5940" class="difflineplus">+  redetectKeywords(aManage) {</span>
<a href="#l3.5941"></a><span id="l3.5941">     if (!this.enabled)</span>
<a href="#l3.5942"></a><span id="l3.5942">       return;</span>
<a href="#l3.5943"></a><span id="l3.5943"> </span>
<a href="#l3.5944"></a><span id="l3.5944">     attachmentWorker.onmessage({ data: this._checkForAttachmentKeywords(false) }, aManage);</span>
<a href="#l3.5945"></a><span id="l3.5945">   },</span>
<a href="#l3.5946"></a><span id="l3.5946"> </span>
<a href="#l3.5947"></a><span id="l3.5947">   /**</span>
<a href="#l3.5948"></a><span id="l3.5948">    * Check if there are any keywords in the message.</span>
<a href="#l3.5949"></a><span id="l3.5949">    *</span>
<a href="#l3.5950"></a><span id="l3.5950">    * @param async  Whether we should run the regex checker asynchronously or not.</span>
<a href="#l3.5951"></a><span id="l3.5951">    *</span>
<a href="#l3.5952"></a><span id="l3.5952">    * @return  If async is true, attachmentWorker.message is called with the array</span>
<a href="#l3.5953"></a><span id="l3.5953">    *          of found keywords and this function returns null.</span>
<a href="#l3.5954"></a><span id="l3.5954">    *          If it is false, the array is returned from this function immediately.</span>
<a href="#l3.5955"></a><span id="l3.5955">    */</span>
<a href="#l3.5956"></a><span id="l3.5956" class="difflineminus">-  _checkForAttachmentKeywords: function(async)</span>
<a href="#l3.5957"></a><span id="l3.5957" class="difflineminus">-  {</span>
<a href="#l3.5958"></a><span id="l3.5958" class="difflineplus">+  _checkForAttachmentKeywords(async) {</span>
<a href="#l3.5959"></a><span id="l3.5959">     if (!this.enabled)</span>
<a href="#l3.5960"></a><span id="l3.5960">       return (async ? null : []);</span>
<a href="#l3.5961"></a><span id="l3.5961"> </span>
<a href="#l3.5962"></a><span id="l3.5962">     if (attachmentNotificationSupressed()) {</span>
<a href="#l3.5963"></a><span id="l3.5963">       // If we know we don't need to show the notification,</span>
<a href="#l3.5964"></a><span id="l3.5964">       // we can skip the expensive checking of keywords in the message.</span>
<a href="#l3.5965"></a><span id="l3.5965">       // but mark it in the .lastMessage that the keywords are unknown.</span>
<a href="#l3.5966"></a><span id="l3.5966">       attachmentWorker.lastMessage = null;</span>
<a href="#l3.5967"></a><span id="l3.5967" class="difflineat">@@ -6760,23 +6464,23 @@ var gAttachmentNotifier =</span>
<a href="#l3.5968"></a><span id="l3.5968">     if (fwdIndex &gt; 0)</span>
<a href="#l3.5969"></a><span id="l3.5969">       mailData = mailData.substring(0, fwdIndex);</span>
<a href="#l3.5970"></a><span id="l3.5970"> </span>
<a href="#l3.5971"></a><span id="l3.5971">     // Prepend the subject to see if the subject contains any attachment</span>
<a href="#l3.5972"></a><span id="l3.5972">     // keywords too, after making sure that the subject has changed.</span>
<a href="#l3.5973"></a><span id="l3.5973">     let subject = GetMsgSubjectElement().value;</span>
<a href="#l3.5974"></a><span id="l3.5974">     if (subject &amp;&amp; (gSubjectChanged ||</span>
<a href="#l3.5975"></a><span id="l3.5975">        (gEditingDraft &amp;&amp;</span>
<a href="#l3.5976"></a><span id="l3.5976" class="difflineminus">-         (gComposeType == nsIMsgCompType.New ||</span>
<a href="#l3.5977"></a><span id="l3.5977" class="difflineminus">-         gComposeType == nsIMsgCompType.NewsPost ||</span>
<a href="#l3.5978"></a><span id="l3.5978" class="difflineminus">-         gComposeType == nsIMsgCompType.Draft ||</span>
<a href="#l3.5979"></a><span id="l3.5979" class="difflineminus">-         gComposeType == nsIMsgCompType.Template ||</span>
<a href="#l3.5980"></a><span id="l3.5980" class="difflineminus">-         gComposeType == nsIMsgCompType.EditTemplate ||</span>
<a href="#l3.5981"></a><span id="l3.5981" class="difflineminus">-         gComposeType == nsIMsgCompType.EditAsNew ||</span>
<a href="#l3.5982"></a><span id="l3.5982" class="difflineminus">-         gComposeType == nsIMsgCompType.MailToUrl))))</span>
<a href="#l3.5983"></a><span id="l3.5983" class="difflineplus">+         (gComposeType == Ci.nsIMsgCompType.New ||</span>
<a href="#l3.5984"></a><span id="l3.5984" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.NewsPost ||</span>
<a href="#l3.5985"></a><span id="l3.5985" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.Draft ||</span>
<a href="#l3.5986"></a><span id="l3.5986" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.Template ||</span>
<a href="#l3.5987"></a><span id="l3.5987" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.EditTemplate ||</span>
<a href="#l3.5988"></a><span id="l3.5988" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.EditAsNew ||</span>
<a href="#l3.5989"></a><span id="l3.5989" class="difflineplus">+          gComposeType == Ci.nsIMsgCompType.MailToUrl))))</span>
<a href="#l3.5990"></a><span id="l3.5990">       mailData = subject + &quot; &quot; + mailData;</span>
<a href="#l3.5991"></a><span id="l3.5991"> </span>
<a href="#l3.5992"></a><span id="l3.5992">     if (!async)</span>
<a href="#l3.5993"></a><span id="l3.5993">       return GetAttachmentKeywords(mailData, keywordsInCsv);</span>
<a href="#l3.5994"></a><span id="l3.5994"> </span>
<a href="#l3.5995"></a><span id="l3.5995">     attachmentWorker.postMessage([mailData, keywordsInCsv]);</span>
<a href="#l3.5996"></a><span id="l3.5996">     return null;</span>
<a href="#l3.5997"></a><span id="l3.5997">   },</span>
<a href="#l3.5998"></a><span id="l3.5998" class="difflineat">@@ -6785,60 +6489,56 @@ var gAttachmentNotifier =</span>
<a href="#l3.5999"></a><span id="l3.5999">     if (this._obs)</span>
<a href="#l3.6000"></a><span id="l3.6000">       this._obs.disconnect();</span>
<a href="#l3.6001"></a><span id="l3.6001">     gAttachmentNotifier.timer.cancel();</span>
<a href="#l3.6002"></a><span id="l3.6002"> </span>
<a href="#l3.6003"></a><span id="l3.6003">     this._obs = null;</span>
<a href="#l3.6004"></a><span id="l3.6004">   },</span>
<a href="#l3.6005"></a><span id="l3.6005"> </span>
<a href="#l3.6006"></a><span id="l3.6006">   event: {</span>
<a href="#l3.6007"></a><span id="l3.6007" class="difflineminus">-    notify: function(timer)</span>
<a href="#l3.6008"></a><span id="l3.6008" class="difflineminus">-    {</span>
<a href="#l3.6009"></a><span id="l3.6009" class="difflineplus">+    notify(timer) {</span>
<a href="#l3.6010"></a><span id="l3.6010">       // Only run the checker if the compose window is initialized</span>
<a href="#l3.6011"></a><span id="l3.6011">       // and not shutting down.</span>
<a href="#l3.6012"></a><span id="l3.6012">       if (gMsgCompose) {</span>
<a href="#l3.6013"></a><span id="l3.6013">         // This runs the attachmentWorker asynchronously so if keywords are found</span>
<a href="#l3.6014"></a><span id="l3.6014">         // manageAttachmentNotification is run from attachmentWorker.onmessage.</span>
<a href="#l3.6015"></a><span id="l3.6015">         gAttachmentNotifier._checkForAttachmentKeywords(true);</span>
<a href="#l3.6016"></a><span id="l3.6016">       }</span>
<a href="#l3.6017"></a><span id="l3.6017" class="difflineminus">-    }</span>
<a href="#l3.6018"></a><span id="l3.6018" class="difflineplus">+    },</span>
<a href="#l3.6019"></a><span id="l3.6019">   },</span>
<a href="#l3.6020"></a><span id="l3.6020"> </span>
<a href="#l3.6021"></a><span id="l3.6021" class="difflineminus">-  timer: Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l3.6022"></a><span id="l3.6022" class="difflineminus">-           .createInstance(Ci.nsITimer)</span>
<a href="#l3.6023"></a><span id="l3.6023" class="difflineplus">+  timer: Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer),</span>
<a href="#l3.6024"></a><span id="l3.6024"> };</span>
<a href="#l3.6025"></a><span id="l3.6025"> </span>
<a href="#l3.6026"></a><span id="l3.6026"> /**</span>
<a href="#l3.6027"></a><span id="l3.6027">  * Helper function to remove a query part from a URL, so for example:</span>
<a href="#l3.6028"></a><span id="l3.6028">  * ...?remove=xx&amp;other=yy becomes ...?other=yy.</span>
<a href="#l3.6029"></a><span id="l3.6029">  *</span>
<a href="#l3.6030"></a><span id="l3.6030">  * @param aURL    the URL from which to remove the query part</span>
<a href="#l3.6031"></a><span id="l3.6031">  * @param aQuery  the query part to remove</span>
<a href="#l3.6032"></a><span id="l3.6032">  * @return        the URL with the query part removed</span>
<a href="#l3.6033"></a><span id="l3.6033">  */</span>
<a href="#l3.6034"></a><span id="l3.6034" class="difflineminus">-function removeQueryPart(aURL, aQuery)</span>
<a href="#l3.6035"></a><span id="l3.6035" class="difflineminus">-{</span>
<a href="#l3.6036"></a><span id="l3.6036" class="difflineplus">+function removeQueryPart(aURL, aQuery) {</span>
<a href="#l3.6037"></a><span id="l3.6037">   // Quick pre-check.</span>
<a href="#l3.6038"></a><span id="l3.6038" class="difflineminus">-  if (aURL.indexOf(aQuery) &lt; 0)</span>
<a href="#l3.6039"></a><span id="l3.6039" class="difflineplus">+  if (!aURL.includes(aQuery))</span>
<a href="#l3.6040"></a><span id="l3.6040">     return aURL;</span>
<a href="#l3.6041"></a><span id="l3.6041"> </span>
<a href="#l3.6042"></a><span id="l3.6042">   let indexQM = aURL.indexOf(&quot;?&quot;);</span>
<a href="#l3.6043"></a><span id="l3.6043">   if (indexQM &lt; 0)</span>
<a href="#l3.6044"></a><span id="l3.6044">     return aURL;</span>
<a href="#l3.6045"></a><span id="l3.6045"> </span>
<a href="#l3.6046"></a><span id="l3.6046">   let queryParts = aURL.substr(indexQM + 1).split(&quot;&amp;&quot;);</span>
<a href="#l3.6047"></a><span id="l3.6047">   let indexPart = queryParts.indexOf(aQuery);</span>
<a href="#l3.6048"></a><span id="l3.6048">   if (indexPart &lt; 0)</span>
<a href="#l3.6049"></a><span id="l3.6049">     return aURL;</span>
<a href="#l3.6050"></a><span id="l3.6050">   queryParts.splice(indexPart, 1);</span>
<a href="#l3.6051"></a><span id="l3.6051">   return aURL.substr(0, indexQM + 1) + queryParts.join(&quot;&amp;&quot;);</span>
<a href="#l3.6052"></a><span id="l3.6052"> }</span>
<a href="#l3.6053"></a><span id="l3.6053"> </span>
<a href="#l3.6054"></a><span id="l3.6054" class="difflineminus">-function InitEditor()</span>
<a href="#l3.6055"></a><span id="l3.6055" class="difflineminus">-{</span>
<a href="#l3.6056"></a><span id="l3.6056" class="difflineplus">+function InitEditor() {</span>
<a href="#l3.6057"></a><span id="l3.6057">   var editor = GetCurrentEditor();</span>
<a href="#l3.6058"></a><span id="l3.6058"> </span>
<a href="#l3.6059"></a><span id="l3.6059">   // Set eEditorMailMask flag to avoid using content prefs for spell checker,</span>
<a href="#l3.6060"></a><span id="l3.6060">   // otherwise dictionary setting in preferences is ignored and dictionary is</span>
<a href="#l3.6061"></a><span id="l3.6061">   // inconsistent in subject and message body.</span>
<a href="#l3.6062"></a><span id="l3.6062">   let eEditorMailMask = Ci.nsIPlaintextEditor.eEditorMailMask;</span>
<a href="#l3.6063"></a><span id="l3.6063">   editor.flags |= eEditorMailMask;</span>
<a href="#l3.6064"></a><span id="l3.6064">   GetMsgSubjectElement().editor.flags |= eEditorMailMask;</span>
<a href="#l3.6065"></a><span id="l3.6065" class="difflineat">@@ -6852,36 +6552,36 @@ function InitEditor()</span>
<a href="#l3.6066"></a><span id="l3.6066">                                &quot;p&quot; : &quot;br&quot;);</span>
<a href="#l3.6067"></a><span id="l3.6067">   if (gMsgCompose.composeHTML) {</span>
<a href="#l3.6068"></a><span id="l3.6068">     // Re-enable table/image resizers.</span>
<a href="#l3.6069"></a><span id="l3.6069">     editor.QueryInterface(Ci.nsIHTMLAbsPosEditor).absolutePositioningEnabled = true;</span>
<a href="#l3.6070"></a><span id="l3.6070">     editor.QueryInterface(Ci.nsIHTMLInlineTableEditor).inlineTableEditingEnabled = true;</span>
<a href="#l3.6071"></a><span id="l3.6071">     editor.QueryInterface(Ci.nsIHTMLObjectResizer).objectResizingEnabled = true;</span>
<a href="#l3.6072"></a><span id="l3.6072">   }</span>
<a href="#l3.6073"></a><span id="l3.6073"> </span>
<a href="#l3.6074"></a><span id="l3.6074" class="difflineminus">-  editor.QueryInterface(nsIEditorStyleSheets);</span>
<a href="#l3.6075"></a><span id="l3.6075" class="difflineplus">+  editor.QueryInterface(Ci.nsIEditorStyleSheets);</span>
<a href="#l3.6076"></a><span id="l3.6076">   // We use addOverrideStyleSheet rather than addStyleSheet so that we get</span>
<a href="#l3.6077"></a><span id="l3.6077">   // a synchronous load, rather than having a late-finishing async load</span>
<a href="#l3.6078"></a><span id="l3.6078">   // mark our editor as modified when the user hasn't typed anything yet,</span>
<a href="#l3.6079"></a><span id="l3.6079">   // but that means the sheet must not @import slow things, especially</span>
<a href="#l3.6080"></a><span id="l3.6080">   // not over the network.</span>
<a href="#l3.6081"></a><span id="l3.6081">   editor.addOverrideStyleSheet(&quot;chrome://messenger/content/composerOverlay.css&quot;);</span>
<a href="#l3.6082"></a><span id="l3.6082">   gMsgCompose.initEditor(editor, window.content);</span>
<a href="#l3.6083"></a><span id="l3.6083"> </span>
<a href="#l3.6084"></a><span id="l3.6084">   // We always go through this function every time we init an editor.</span>
<a href="#l3.6085"></a><span id="l3.6085">   // First step is making sure we can spell check.</span>
<a href="#l3.6086"></a><span id="l3.6086">   gSpellChecker.init(editor);</span>
<a href="#l3.6087"></a><span id="l3.6087" class="difflineminus">-  document.getElementById('menu_inlineSpellCheck')</span>
<a href="#l3.6088"></a><span id="l3.6088" class="difflineminus">-          .setAttribute('disabled', !gSpellChecker.canSpellCheck);</span>
<a href="#l3.6089"></a><span id="l3.6089" class="difflineminus">-  document.getElementById('spellCheckEnable')</span>
<a href="#l3.6090"></a><span id="l3.6090" class="difflineminus">-          .setAttribute('disabled', !gSpellChecker.canSpellCheck);</span>
<a href="#l3.6091"></a><span id="l3.6091" class="difflineplus">+  document.getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l3.6092"></a><span id="l3.6092" class="difflineplus">+          .setAttribute(&quot;disabled&quot;, !gSpellChecker.canSpellCheck);</span>
<a href="#l3.6093"></a><span id="l3.6093" class="difflineplus">+  document.getElementById(&quot;spellCheckEnable&quot;)</span>
<a href="#l3.6094"></a><span id="l3.6094" class="difflineplus">+          .setAttribute(&quot;disabled&quot;, !gSpellChecker.canSpellCheck);</span>
<a href="#l3.6095"></a><span id="l3.6095">   // If canSpellCheck = false, then hidden = false, i.e. show it so that we can</span>
<a href="#l3.6096"></a><span id="l3.6096">   // still add dictionaries. Else, hide that.</span>
<a href="#l3.6097"></a><span id="l3.6097" class="difflineminus">-  document.getElementById('spellCheckAddDictionariesMain')</span>
<a href="#l3.6098"></a><span id="l3.6098" class="difflineminus">-          .setAttribute('hidden', gSpellChecker.canSpellCheck);</span>
<a href="#l3.6099"></a><span id="l3.6099" class="difflineplus">+  document.getElementById(&quot;spellCheckAddDictionariesMain&quot;)</span>
<a href="#l3.6100"></a><span id="l3.6100" class="difflineplus">+          .setAttribute(&quot;hidden&quot;, gSpellChecker.canSpellCheck);</span>
<a href="#l3.6101"></a><span id="l3.6101">   // Then, we enable related UI entries.</span>
<a href="#l3.6102"></a><span id="l3.6102">   enableInlineSpellCheck(getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l3.6103"></a><span id="l3.6103">   gAttachmentNotifier.init(editor.document);</span>
<a href="#l3.6104"></a><span id="l3.6104"> </span>
<a href="#l3.6105"></a><span id="l3.6105">   // Listen for spellchecker changes, set document language to</span>
<a href="#l3.6106"></a><span id="l3.6106">   // dictionary picked by the user via the right-click menu in the editor.</span>
<a href="#l3.6107"></a><span id="l3.6107">   document.addEventListener(&quot;spellcheck-changed&quot;, updateDocumentLanguage);</span>
<a href="#l3.6108"></a><span id="l3.6108"> </span>
<a href="#l3.6109"></a><span id="l3.6109" class="difflineat">@@ -6926,23 +6626,21 @@ function InitEditor()</span>
<a href="#l3.6110"></a><span id="l3.6110">         // now.</span>
<a href="#l3.6111"></a><span id="l3.6111">         event.target.classList.add(&quot;loading-internal&quot;);</span>
<a href="#l3.6112"></a><span id="l3.6112">         try {</span>
<a href="#l3.6113"></a><span id="l3.6113">           loadBlockedImage(src);</span>
<a href="#l3.6114"></a><span id="l3.6114">         } catch (e) {</span>
<a href="#l3.6115"></a><span id="l3.6115">           // Couldn't load the referenced image.</span>
<a href="#l3.6116"></a><span id="l3.6116">           Cu.reportError(e);</span>
<a href="#l3.6117"></a><span id="l3.6117">         }</span>
<a href="#l3.6118"></a><span id="l3.6118" class="difflineminus">-      }</span>
<a href="#l3.6119"></a><span id="l3.6119" class="difflineminus">-      else {</span>
<a href="#l3.6120"></a><span id="l3.6120" class="difflineplus">+      } else {</span>
<a href="#l3.6121"></a><span id="l3.6121">         // Appears to reference a random message. Notify and keep blocking.</span>
<a href="#l3.6122"></a><span id="l3.6122">         gComposeNotificationBar.setBlockedContent(src);</span>
<a href="#l3.6123"></a><span id="l3.6123">       }</span>
<a href="#l3.6124"></a><span id="l3.6124" class="difflineminus">-    }</span>
<a href="#l3.6125"></a><span id="l3.6125" class="difflineminus">-    else {</span>
<a href="#l3.6126"></a><span id="l3.6126" class="difflineplus">+    } else {</span>
<a href="#l3.6127"></a><span id="l3.6127">       // For file:, and references to parts of random messages, show the</span>
<a href="#l3.6128"></a><span id="l3.6128">       // blocked content notification.</span>
<a href="#l3.6129"></a><span id="l3.6129">       gComposeNotificationBar.setBlockedContent(src);</span>
<a href="#l3.6130"></a><span id="l3.6130">     }</span>
<a href="#l3.6131"></a><span id="l3.6131">   }, true);</span>
<a href="#l3.6132"></a><span id="l3.6132"> </span>
<a href="#l3.6133"></a><span id="l3.6133">   // Convert mailnews URL back to data: URL.</span>
<a href="#l3.6134"></a><span id="l3.6134">   let background = editor.document.body.background;</span>
<a href="#l3.6135"></a><span id="l3.6135" class="difflineat">@@ -6963,43 +6661,40 @@ function InitEditor()</span>
<a href="#l3.6136"></a><span id="l3.6136">         Cu.reportError(e);</span>
<a href="#l3.6137"></a><span id="l3.6137">       }</span>
<a href="#l3.6138"></a><span id="l3.6138">     }</span>
<a href="#l3.6139"></a><span id="l3.6139">   }</span>
<a href="#l3.6140"></a><span id="l3.6140"> }</span>
<a href="#l3.6141"></a><span id="l3.6141"> </span>
<a href="#l3.6142"></a><span id="l3.6142"> // This is used as event listener to spellcheck-changed event to update</span>
<a href="#l3.6143"></a><span id="l3.6143"> // document language.</span>
<a href="#l3.6144"></a><span id="l3.6144" class="difflineminus">-function updateDocumentLanguage(e)</span>
<a href="#l3.6145"></a><span id="l3.6145" class="difflineminus">-{</span>
<a href="#l3.6146"></a><span id="l3.6146" class="difflineplus">+function updateDocumentLanguage(e) {</span>
<a href="#l3.6147"></a><span id="l3.6147">   document.documentElement.setAttribute(&quot;lang&quot;, e.detail.dictionary);</span>
<a href="#l3.6148"></a><span id="l3.6148"> }</span>
<a href="#l3.6149"></a><span id="l3.6149"> </span>
<a href="#l3.6150"></a><span id="l3.6150"> // This function modifies gSpellChecker and updates the UI accordingly. It's</span>
<a href="#l3.6151"></a><span id="l3.6151"> // called either at startup (see InitEditor above), or when the user clicks on</span>
<a href="#l3.6152"></a><span id="l3.6152"> // one of the two menu items that allow them to toggle the spellcheck feature</span>
<a href="#l3.6153"></a><span id="l3.6153"> // (either context menu or Options menu).</span>
<a href="#l3.6154"></a><span id="l3.6154" class="difflineminus">-function enableInlineSpellCheck(aEnableInlineSpellCheck)</span>
<a href="#l3.6155"></a><span id="l3.6155" class="difflineminus">-{</span>
<a href="#l3.6156"></a><span id="l3.6156" class="difflineplus">+function enableInlineSpellCheck(aEnableInlineSpellCheck) {</span>
<a href="#l3.6157"></a><span id="l3.6157">   if (gSpellChecker.enabled != aEnableInlineSpellCheck) {</span>
<a href="#l3.6158"></a><span id="l3.6158">     // If state of spellchecker is about to change, clear any pending observer.</span>
<a href="#l3.6159"></a><span id="l3.6159">     spellCheckReadyObserver.removeObserver();</span>
<a href="#l3.6160"></a><span id="l3.6160">   }</span>
<a href="#l3.6161"></a><span id="l3.6161">   gSpellChecker.enabled = aEnableInlineSpellCheck;</span>
<a href="#l3.6162"></a><span id="l3.6162" class="difflineminus">-  document.getElementById('msgSubject').setAttribute('spellcheck', aEnableInlineSpellCheck);</span>
<a href="#l3.6163"></a><span id="l3.6163" class="difflineplus">+  document.getElementById(&quot;msgSubject&quot;).setAttribute(&quot;spellcheck&quot;, aEnableInlineSpellCheck);</span>
<a href="#l3.6164"></a><span id="l3.6164">   document.getElementById(&quot;menu_inlineSpellCheck&quot;)</span>
<a href="#l3.6165"></a><span id="l3.6165" class="difflineminus">-          .setAttribute('checked', aEnableInlineSpellCheck);</span>
<a href="#l3.6166"></a><span id="l3.6166" class="difflineplus">+          .setAttribute(&quot;checked&quot;, aEnableInlineSpellCheck);</span>
<a href="#l3.6167"></a><span id="l3.6167">   document.getElementById(&quot;spellCheckEnable&quot;)</span>
<a href="#l3.6168"></a><span id="l3.6168" class="difflineminus">-          .setAttribute('checked', aEnableInlineSpellCheck);</span>
<a href="#l3.6169"></a><span id="l3.6169" class="difflineminus">-  document.getElementById('spellCheckDictionaries')</span>
<a href="#l3.6170"></a><span id="l3.6170" class="difflineminus">-          .setAttribute('hidden', !aEnableInlineSpellCheck);</span>
<a href="#l3.6171"></a><span id="l3.6171" class="difflineminus">-}</span>
<a href="#l3.6172"></a><span id="l3.6172" class="difflineminus">-</span>
<a href="#l3.6173"></a><span id="l3.6173" class="difflineminus">-function getMailToolbox()</span>
<a href="#l3.6174"></a><span id="l3.6174" class="difflineminus">-{</span>
<a href="#l3.6175"></a><span id="l3.6175" class="difflineplus">+          .setAttribute(&quot;checked&quot;, aEnableInlineSpellCheck);</span>
<a href="#l3.6176"></a><span id="l3.6176" class="difflineplus">+  document.getElementById(&quot;spellCheckDictionaries&quot;)</span>
<a href="#l3.6177"></a><span id="l3.6177" class="difflineplus">+          .setAttribute(&quot;hidden&quot;, !aEnableInlineSpellCheck);</span>
<a href="#l3.6178"></a><span id="l3.6178" class="difflineplus">+}</span>
<a href="#l3.6179"></a><span id="l3.6179" class="difflineplus">+</span>
<a href="#l3.6180"></a><span id="l3.6180" class="difflineplus">+function getMailToolbox() {</span>
<a href="#l3.6181"></a><span id="l3.6181">   return document.getElementById(&quot;compose-toolbox&quot;);</span>
<a href="#l3.6182"></a><span id="l3.6182"> }</span>
<a href="#l3.6183"></a><span id="l3.6183"> </span>
<a href="#l3.6184"></a><span id="l3.6184"> function getPref(aPrefName, aIsComplex) {</span>
<a href="#l3.6185"></a><span id="l3.6185">   if (aIsComplex) {</span>
<a href="#l3.6186"></a><span id="l3.6186">     return Services.prefs.getStringPref(aPrefName);</span>
<a href="#l3.6187"></a><span id="l3.6187">   }</span>
<a href="#l3.6188"></a><span id="l3.6188">   switch (Services.prefs.getPrefType(aPrefName)) {</span>
<a href="#l3.6189"></a><span id="l3.6189" class="difflineat">@@ -7033,25 +6728,22 @@ function UpdateFullZoomMenu() {</span>
<a href="#l3.6190"></a><span id="l3.6190">   menuItem.setAttribute(&quot;checked&quot;, !ZoomManager.useFullZoom);</span>
<a href="#l3.6191"></a><span id="l3.6191"> }</span>
<a href="#l3.6192"></a><span id="l3.6192"> </span>
<a href="#l3.6193"></a><span id="l3.6193"> /**</span>
<a href="#l3.6194"></a><span id="l3.6194">  * Return the &lt;editor&gt; element of the mail compose window. The name is somewhat</span>
<a href="#l3.6195"></a><span id="l3.6195">  * unfortunate; we need to maintain it since the zoom manager, view source and</span>
<a href="#l3.6196"></a><span id="l3.6196">  * other functions still rely on it.</span>
<a href="#l3.6197"></a><span id="l3.6197">  */</span>
<a href="#l3.6198"></a><span id="l3.6198" class="difflineminus">-function getBrowser()</span>
<a href="#l3.6199"></a><span id="l3.6199" class="difflineminus">-{</span>
<a href="#l3.6200"></a><span id="l3.6200" class="difflineplus">+function getBrowser() {</span>
<a href="#l3.6201"></a><span id="l3.6201">   return document.getElementById(&quot;content-frame&quot;);</span>
<a href="#l3.6202"></a><span id="l3.6202"> }</span>
<a href="#l3.6203"></a><span id="l3.6203"> </span>
<a href="#l3.6204"></a><span id="l3.6204" class="difflineminus">-function goUpdateMailMenuItems(commandset)</span>
<a href="#l3.6205"></a><span id="l3.6205" class="difflineminus">-{</span>
<a href="#l3.6206"></a><span id="l3.6206" class="difflineminus">-  for (let i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l3.6207"></a><span id="l3.6207" class="difflineminus">-  {</span>
<a href="#l3.6208"></a><span id="l3.6208" class="difflineplus">+function goUpdateMailMenuItems(commandset) {</span>
<a href="#l3.6209"></a><span id="l3.6209" class="difflineplus">+  for (let i = 0; i &lt; commandset.childNodes.length; i++) {</span>
<a href="#l3.6210"></a><span id="l3.6210">     let commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l3.6211"></a><span id="l3.6211">     if (commandID)</span>
<a href="#l3.6212"></a><span id="l3.6212">       goUpdateCommand(commandID);</span>
<a href="#l3.6213"></a><span id="l3.6213">   }</span>
<a href="#l3.6214"></a><span id="l3.6214"> }</span>
<a href="#l3.6215"></a><span id="l3.6215"> </span>
<a href="#l3.6216"></a><span id="l3.6216"> /**</span>
<a href="#l3.6217"></a><span id="l3.6217">  * Object to handle message related notifications that are showing in a</span>
<a href="#l3.6218"></a><span id="l3.6218" class="difflineat">@@ -7063,85 +6755,84 @@ var gComposeNotificationBar = {</span>
<a href="#l3.6219"></a><span id="l3.6219">     return this.brandBundle = document.getElementById(&quot;brandBundle&quot;);</span>
<a href="#l3.6220"></a><span id="l3.6220">   },</span>
<a href="#l3.6221"></a><span id="l3.6221"> </span>
<a href="#l3.6222"></a><span id="l3.6222">   get notificationBar() {</span>
<a href="#l3.6223"></a><span id="l3.6223">     delete this.notificationBar;</span>
<a href="#l3.6224"></a><span id="l3.6224">     return this.notificationBar = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l3.6225"></a><span id="l3.6225">   },</span>
<a href="#l3.6226"></a><span id="l3.6226"> </span>
<a href="#l3.6227"></a><span id="l3.6227" class="difflineminus">-  setBlockedContent: function(aBlockedURI) {</span>
<a href="#l3.6228"></a><span id="l3.6228" class="difflineplus">+  setBlockedContent(aBlockedURI) {</span>
<a href="#l3.6229"></a><span id="l3.6229">     let brandName = this.brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l3.6230"></a><span id="l3.6230">     let buttonLabel = getComposeBundle().getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l3.6231"></a><span id="l3.6231">       &quot;blockedContentPrefLabel&quot; : &quot;blockedContentPrefLabelUnix&quot;);</span>
<a href="#l3.6232"></a><span id="l3.6232">     let buttonAccesskey = getComposeBundle().getString((AppConstants.platform == &quot;win&quot;) ?</span>
<a href="#l3.6233"></a><span id="l3.6233">       &quot;blockedContentPrefAccesskey&quot; : &quot;blockedContentPrefAccesskeyUnix&quot;);</span>
<a href="#l3.6234"></a><span id="l3.6234"> </span>
<a href="#l3.6235"></a><span id="l3.6235">     let buttons = [{</span>
<a href="#l3.6236"></a><span id="l3.6236">       label: buttonLabel,</span>
<a href="#l3.6237"></a><span id="l3.6237">       accessKey: buttonAccesskey,</span>
<a href="#l3.6238"></a><span id="l3.6238">       popup: &quot;blockedContentOptions&quot;,</span>
<a href="#l3.6239"></a><span id="l3.6239" class="difflineminus">-      callback: function(aNotification, aButton) {</span>
<a href="#l3.6240"></a><span id="l3.6240" class="difflineplus">+      callback(aNotification, aButton) {</span>
<a href="#l3.6241"></a><span id="l3.6241">         return true; // keep notification open</span>
<a href="#l3.6242"></a><span id="l3.6242" class="difflineminus">-      }</span>
<a href="#l3.6243"></a><span id="l3.6243" class="difflineplus">+      },</span>
<a href="#l3.6244"></a><span id="l3.6244">     }];</span>
<a href="#l3.6245"></a><span id="l3.6245"> </span>
<a href="#l3.6246"></a><span id="l3.6246">     // The popup value is a space separated list of all the blocked urls.</span>
<a href="#l3.6247"></a><span id="l3.6247">     let popup = document.getElementById(&quot;blockedContentOptions&quot;);</span>
<a href="#l3.6248"></a><span id="l3.6248">     let urls = popup.value ? popup.value.split(&quot; &quot;) : [];</span>
<a href="#l3.6249"></a><span id="l3.6249">     if (!urls.includes(aBlockedURI))</span>
<a href="#l3.6250"></a><span id="l3.6250">       urls.push(aBlockedURI);</span>
<a href="#l3.6251"></a><span id="l3.6251">     popup.value = urls.join(&quot; &quot;);</span>
<a href="#l3.6252"></a><span id="l3.6252"> </span>
<a href="#l3.6253"></a><span id="l3.6253">     let msg = getComposeBundle().getFormattedString(</span>
<a href="#l3.6254"></a><span id="l3.6254">       &quot;blockedContentMessage&quot;, [brandName, brandName]);</span>
<a href="#l3.6255"></a><span id="l3.6255">     msg = PluralForm.get(urls.length, msg);</span>
<a href="#l3.6256"></a><span id="l3.6256"> </span>
<a href="#l3.6257"></a><span id="l3.6257">     if (!this.isShowingBlockedContentNotification()) {</span>
<a href="#l3.6258"></a><span id="l3.6258">       this.notificationBar.appendNotification(msg, &quot;blockedContent&quot;,</span>
<a href="#l3.6259"></a><span id="l3.6259">         null, this.notificationBar.PRIORITY_WARNING_MEDIUM, buttons);</span>
<a href="#l3.6260"></a><span id="l3.6260" class="difflineminus">-    }</span>
<a href="#l3.6261"></a><span id="l3.6261" class="difflineminus">-    else {</span>
<a href="#l3.6262"></a><span id="l3.6262" class="difflineplus">+    } else {</span>
<a href="#l3.6263"></a><span id="l3.6263">       this.notificationBar.getNotificationWithValue(&quot;blockedContent&quot;)</span>
<a href="#l3.6264"></a><span id="l3.6264">         .setAttribute(&quot;label&quot;, msg);</span>
<a href="#l3.6265"></a><span id="l3.6265">     }</span>
<a href="#l3.6266"></a><span id="l3.6266">   },</span>
<a href="#l3.6267"></a><span id="l3.6267"> </span>
<a href="#l3.6268"></a><span id="l3.6268" class="difflineminus">-  isShowingBlockedContentNotification: function() {</span>
<a href="#l3.6269"></a><span id="l3.6269" class="difflineplus">+  isShowingBlockedContentNotification() {</span>
<a href="#l3.6270"></a><span id="l3.6270">     return !!this.notificationBar.getNotificationWithValue(&quot;blockedContent&quot;);</span>
<a href="#l3.6271"></a><span id="l3.6271">   },</span>
<a href="#l3.6272"></a><span id="l3.6272"> </span>
<a href="#l3.6273"></a><span id="l3.6273" class="difflineminus">-  clearBlockedContentNotification: function() {</span>
<a href="#l3.6274"></a><span id="l3.6274" class="difflineplus">+  clearBlockedContentNotification() {</span>
<a href="#l3.6275"></a><span id="l3.6275">     this.notificationBar.removeNotification(</span>
<a href="#l3.6276"></a><span id="l3.6276">       this.notificationBar.getNotificationWithValue(&quot;blockedContent&quot;));</span>
<a href="#l3.6277"></a><span id="l3.6277">   },</span>
<a href="#l3.6278"></a><span id="l3.6278"> </span>
<a href="#l3.6279"></a><span id="l3.6279" class="difflineminus">-  clearNotifications: function(aValue) {</span>
<a href="#l3.6280"></a><span id="l3.6280" class="difflineplus">+  clearNotifications(aValue) {</span>
<a href="#l3.6281"></a><span id="l3.6281">     this.notificationBar.removeAllNotifications(true);</span>
<a href="#l3.6282"></a><span id="l3.6282">   },</span>
<a href="#l3.6283"></a><span id="l3.6283"> </span>
<a href="#l3.6284"></a><span id="l3.6284" class="difflineminus">-  setIdentityWarning: function(aIdentityName) {</span>
<a href="#l3.6285"></a><span id="l3.6285" class="difflineplus">+  setIdentityWarning(aIdentityName) {</span>
<a href="#l3.6286"></a><span id="l3.6286">     if (!this.notificationBar.getNotificationWithValue(&quot;identityWarning&quot;)) {</span>
<a href="#l3.6287"></a><span id="l3.6287">       let text = getComposeBundle().getString(&quot;identityWarning&quot;)</span>
<a href="#l3.6288"></a><span id="l3.6288">                                    .split(&quot;%S&quot;);</span>
<a href="#l3.6289"></a><span id="l3.6289">       let label = new DocumentFragment();</span>
<a href="#l3.6290"></a><span id="l3.6290">       label.appendChild(document.createTextNode(text[0]));</span>
<a href="#l3.6291"></a><span id="l3.6291">       label.appendChild(document.createElement(&quot;b&quot;));</span>
<a href="#l3.6292"></a><span id="l3.6292">       label.lastChild.appendChild(document.createTextNode(aIdentityName));</span>
<a href="#l3.6293"></a><span id="l3.6293">       label.appendChild(document.createTextNode(text[1]));</span>
<a href="#l3.6294"></a><span id="l3.6294">       this.notificationBar.appendNotification(label, &quot;identityWarning&quot;, null,</span>
<a href="#l3.6295"></a><span id="l3.6295">         this.notificationBar.PRIORITY_WARNING_HIGH, null);</span>
<a href="#l3.6296"></a><span id="l3.6296">     }</span>
<a href="#l3.6297"></a><span id="l3.6297">   },</span>
<a href="#l3.6298"></a><span id="l3.6298"> </span>
<a href="#l3.6299"></a><span id="l3.6299" class="difflineminus">-  clearIdentityWarning: function() {</span>
<a href="#l3.6300"></a><span id="l3.6300" class="difflineplus">+  clearIdentityWarning() {</span>
<a href="#l3.6301"></a><span id="l3.6301">     let idWarning = this.notificationBar.getNotificationWithValue(&quot;identityWarning&quot;);</span>
<a href="#l3.6302"></a><span id="l3.6302">     if (idWarning)</span>
<a href="#l3.6303"></a><span id="l3.6303">       this.notificationBar.removeNotification(idWarning);</span>
<a href="#l3.6304"></a><span id="l3.6304" class="difflineminus">-  }</span>
<a href="#l3.6305"></a><span id="l3.6305" class="difflineplus">+  },</span>
<a href="#l3.6306"></a><span id="l3.6306"> };</span>
<a href="#l3.6307"></a><span id="l3.6307"> </span>
<a href="#l3.6308"></a><span id="l3.6308"> /**</span>
<a href="#l3.6309"></a><span id="l3.6309">  * Populate the menuitems of what blocked content to unblock.</span>
<a href="#l3.6310"></a><span id="l3.6310">  */</span>
<a href="#l3.6311"></a><span id="l3.6311"> function onBlockedContentOptionsShowing(aEvent) {</span>
<a href="#l3.6312"></a><span id="l3.6312">   let urls = aEvent.target.value ? aEvent.target.value.split(&quot; &quot;) : [];</span>
<a href="#l3.6313"></a><span id="l3.6313"> </span>
<a href="#l3.6314"></a><span id="l3.6314" class="difflineat">@@ -7200,18 +6891,17 @@ function onUnblockResource(aURL, aNode) </span>
<a href="#l3.6315"></a><span id="l3.6315">  * @param {Bool}    aReturnDataURL - return data: URL instead of processing image</span>
<a href="#l3.6316"></a><span id="l3.6316">  * @return {String} the image as data: URL.</span>
<a href="#l3.6317"></a><span id="l3.6317">  * @throw Error()   if reading the data failed</span>
<a href="#l3.6318"></a><span id="l3.6318">  */</span>
<a href="#l3.6319"></a><span id="l3.6319"> function loadBlockedImage(aURL, aReturnDataURL = false) {</span>
<a href="#l3.6320"></a><span id="l3.6320">   let filename;</span>
<a href="#l3.6321"></a><span id="l3.6321">   if (/^(file|chrome):/i.test(aURL)) {</span>
<a href="#l3.6322"></a><span id="l3.6322">     filename = aURL.substr(aURL.lastIndexOf(&quot;/&quot;) + 1);</span>
<a href="#l3.6323"></a><span id="l3.6323" class="difflineminus">-  }</span>
<a href="#l3.6324"></a><span id="l3.6324" class="difflineminus">-  else {</span>
<a href="#l3.6325"></a><span id="l3.6325" class="difflineplus">+  } else {</span>
<a href="#l3.6326"></a><span id="l3.6326">     let fnMatch = /[?&amp;;]filename=([^?&amp;]+)/.exec(aURL);</span>
<a href="#l3.6327"></a><span id="l3.6327">     filename = (fnMatch &amp;&amp; fnMatch[1]) || &quot;&quot;;</span>
<a href="#l3.6328"></a><span id="l3.6328">   }</span>
<a href="#l3.6329"></a><span id="l3.6329">   filename = decodeURIComponent(filename);</span>
<a href="#l3.6330"></a><span id="l3.6330">   let uri = Services.io.newURI(aURL);</span>
<a href="#l3.6331"></a><span id="l3.6331">   let contentType;</span>
<a href="#l3.6332"></a><span id="l3.6332">   if (filename) {</span>
<a href="#l3.6333"></a><span id="l3.6333">     try {</span>
<a href="#l3.6334"></a><span id="l3.6334" class="difflineat">@@ -7222,18 +6912,17 @@ function loadBlockedImage(aURL, aReturnD</span>
<a href="#l3.6335"></a><span id="l3.6335">       contentType = &quot;image/png&quot;;</span>
<a href="#l3.6336"></a><span id="l3.6336">     }</span>
<a href="#l3.6337"></a><span id="l3.6337"> </span>
<a href="#l3.6338"></a><span id="l3.6338">     if (!contentType.startsWith(&quot;image/&quot;)) {</span>
<a href="#l3.6339"></a><span id="l3.6339">       // Unsafe to unblock this. It would just be garbage either way.</span>
<a href="#l3.6340"></a><span id="l3.6340">       throw new Error(&quot;Won't unblock; URL=&quot; + aURL +</span>
<a href="#l3.6341"></a><span id="l3.6341">                       &quot;, contentType=&quot; + contentType);</span>
<a href="#l3.6342"></a><span id="l3.6342">     }</span>
<a href="#l3.6343"></a><span id="l3.6343" class="difflineminus">-  }</span>
<a href="#l3.6344"></a><span id="l3.6344" class="difflineminus">-  else {</span>
<a href="#l3.6345"></a><span id="l3.6345" class="difflineplus">+  } else {</span>
<a href="#l3.6346"></a><span id="l3.6346">     // Assuming image/png is the best we can do.</span>
<a href="#l3.6347"></a><span id="l3.6347">     contentType = &quot;image/png&quot;;</span>
<a href="#l3.6348"></a><span id="l3.6348">   }</span>
<a href="#l3.6349"></a><span id="l3.6349">   let channel = Services.io.newChannelFromURI2(uri,</span>
<a href="#l3.6350"></a><span id="l3.6350">     null,</span>
<a href="#l3.6351"></a><span id="l3.6351">     Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l3.6352"></a><span id="l3.6352">     null,</span>
<a href="#l3.6353"></a><span id="l3.6353">     Ci.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l3.6354"></a><span id="l3.6354" class="difflineat">@@ -7242,19 +6931,19 @@ function loadBlockedImage(aURL, aReturnD</span>
<a href="#l3.6355"></a><span id="l3.6355">   let stream = Cc[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l3.6356"></a><span id="l3.6356">     .createInstance(Ci.nsIBinaryInputStream);</span>
<a href="#l3.6357"></a><span id="l3.6357">   stream.setInputStream(inputStream);</span>
<a href="#l3.6358"></a><span id="l3.6358">   let streamData = &quot;&quot;;</span>
<a href="#l3.6359"></a><span id="l3.6359">   try {</span>
<a href="#l3.6360"></a><span id="l3.6360">     while (stream.available() &gt; 0) {</span>
<a href="#l3.6361"></a><span id="l3.6361">       streamData += stream.readBytes(stream.available());</span>
<a href="#l3.6362"></a><span id="l3.6362">     }</span>
<a href="#l3.6363"></a><span id="l3.6363" class="difflineminus">-  } catch(e) {</span>
<a href="#l3.6364"></a><span id="l3.6364" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.6365"></a><span id="l3.6365">     stream.close();</span>
<a href="#l3.6366"></a><span id="l3.6366" class="difflineminus">-    throw new Error(&quot;Couln't read all data from URL=&quot; + aURL + &quot; (&quot; + e +&quot;)&quot;);</span>
<a href="#l3.6367"></a><span id="l3.6367" class="difflineplus">+    throw new Error(&quot;Couln't read all data from URL=&quot; + aURL + &quot; (&quot; + e + &quot;)&quot;);</span>
<a href="#l3.6368"></a><span id="l3.6368">   }</span>
<a href="#l3.6369"></a><span id="l3.6369">   stream.close();</span>
<a href="#l3.6370"></a><span id="l3.6370">   let encoded = btoa(streamData);</span>
<a href="#l3.6371"></a><span id="l3.6371">   let dataURL = &quot;data:&quot; + contentType +</span>
<a href="#l3.6372"></a><span id="l3.6372">     (filename ? &quot;;filename=&quot; + encodeURIComponent(filename) : &quot;&quot;) +</span>
<a href="#l3.6373"></a><span id="l3.6373">     &quot;;base64,&quot; + encoded;</span>
<a href="#l3.6374"></a><span id="l3.6374"> </span>
<a href="#l3.6375"></a><span id="l3.6375">   if (aReturnDataURL)</span>
<a href="#l3.6376"></a><span id="l3.6376" class="difflineat">@@ -7262,9 +6951,11 @@ function loadBlockedImage(aURL, aReturnD</span>
<a href="#l3.6377"></a><span id="l3.6377"> </span>
<a href="#l3.6378"></a><span id="l3.6378">   let editor = GetCurrentEditor();</span>
<a href="#l3.6379"></a><span id="l3.6379">   for (let img of editor.document.images) {</span>
<a href="#l3.6380"></a><span id="l3.6380">     if (img.src == aURL) {</span>
<a href="#l3.6381"></a><span id="l3.6381">       img.src = dataURL; // Swap to data URL.</span>
<a href="#l3.6382"></a><span id="l3.6382">       img.classList.remove(&quot;loading-internal&quot;);</span>
<a href="#l3.6383"></a><span id="l3.6383">     }</span>
<a href="#l3.6384"></a><span id="l3.6384">   }</span>
<a href="#l3.6385"></a><span id="l3.6385" class="difflineminus">-}</span>
<a href="#l3.6386"></a><span id="l3.6386" class="difflineplus">+</span>
<a href="#l3.6387"></a><span id="l3.6387" class="difflineplus">+  return null;</span>
<a href="#l3.6388"></a><span id="l3.6388" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/components/compose/content/addressingWidgetOverlay.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,59 +1,52 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Javascript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+/* import-globals-from MsgComposeCommands.js */</span>
<a href="#l4.12"></a><span id="l4.12"> </span>
<a href="#l4.13"></a><span id="l4.13"> top.MAX_RECIPIENTS = 1; /* for the initial listitem created in the XUL */</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> var inputElementType = &quot;&quot;;</span>
<a href="#l4.16"></a><span id="l4.16"> var selectElementType = &quot;&quot;;</span>
<a href="#l4.17"></a><span id="l4.17"> var selectElementIndexTable = null;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> var gNumberOfCols = 0;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> var gDragService = Cc[&quot;@mozilla.org/widget/dragservice;1&quot;]</span>
<a href="#l4.22"></a><span id="l4.22">                      .getService(Ci.nsIDragService);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> var test_addresses_sequence = false;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26" class="difflineminus">-try {</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-  if (sPrefs)</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineminus">-    test_addresses_sequence = sPrefs.getBoolPref(&quot;mail.debug.test_addresses_sequence&quot;);</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+if (Services.prefs.getPrefType(&quot;mail.debug.test_addresses_sequence&quot;) == Ci.nsIPrefBranch.PREF_BOOL) {</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+  test_addresses_sequence = Services.prefs.getBoolPref(&quot;mail.debug.test_addresses_sequence&quot;);</span>
<a href="#l4.31"></a><span id="l4.31"> }</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-catch (ex) {}</span>
<a href="#l4.33"></a><span id="l4.33"> </span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-function awGetMaxRecipients()</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-{</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+function awGetMaxRecipients() {</span>
<a href="#l4.37"></a><span id="l4.37">   return top.MAX_RECIPIENTS;</span>
<a href="#l4.38"></a><span id="l4.38"> }</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-function awGetNumberOfCols()</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-{</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-  if (gNumberOfCols == 0)</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineminus">-  {</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+function awGetNumberOfCols() {</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+  if (gNumberOfCols == 0) {</span>
<a href="#l4.46"></a><span id="l4.46">     var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.47"></a><span id="l4.47">     var listCols = listbox.getElementsByTagName(&quot;treecol&quot;);</span>
<a href="#l4.48"></a><span id="l4.48">     gNumberOfCols = listCols.length;</span>
<a href="#l4.49"></a><span id="l4.49">     if (!gNumberOfCols)</span>
<a href="#l4.50"></a><span id="l4.50">       gNumberOfCols = 1;  /* if no cols defined, that means we have only one! */</span>
<a href="#l4.51"></a><span id="l4.51">   }</span>
<a href="#l4.52"></a><span id="l4.52"> </span>
<a href="#l4.53"></a><span id="l4.53">   return gNumberOfCols;</span>
<a href="#l4.54"></a><span id="l4.54"> }</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56"> /**</span>
<a href="#l4.57"></a><span id="l4.57">  * Adjust the default and minimum number of visible recipient rows for addressingWidget</span>
<a href="#l4.58"></a><span id="l4.58">  */</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-function awInitializeNumberOfRowsShown()</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-{</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+function awInitializeNumberOfRowsShown() {</span>
<a href="#l4.62"></a><span id="l4.62">   let msgHeadersToolbar = document.getElementById(&quot;MsgHeadersToolbar&quot;);</span>
<a href="#l4.63"></a><span id="l4.63">   let addressingWidget = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.64"></a><span id="l4.64">   let awNumRowsShownDefault =</span>
<a href="#l4.65"></a><span id="l4.65">     Services.prefs.getIntPref(&quot;mail.compose.addresswidget.numRowsShownDefault&quot;);</span>
<a href="#l4.66"></a><span id="l4.66"> </span>
<a href="#l4.67"></a><span id="l4.67">   // Work around bug 966655: extraHeight 2 pixels for msgHeadersToolbar ensures</span>
<a href="#l4.68"></a><span id="l4.68">   // visibility of recipient rows per awNumRowsShownDefault and prevents scrollbar</span>
<a href="#l4.69"></a><span id="l4.69">   // on empty Address Widget, depending on OS screen resolution dpi scaling</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineat">@@ -71,54 +64,48 @@ function awInitializeNumberOfRowsShown()</span>
<a href="#l4.71"></a><span id="l4.71">   msgHeadersToolbar.height = msgHeadersToolbar.boxObject.height +</span>
<a href="#l4.72"></a><span id="l4.72">     addressingWidget.boxObject.height * (awNumRowsShownDefault - 1) +</span>
<a href="#l4.73"></a><span id="l4.73">     extraHeight;</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">   // Update addressingWidget internals.</span>
<a href="#l4.76"></a><span id="l4.76">   awCreateOrRemoveDummyRows();</span>
<a href="#l4.77"></a><span id="l4.77"> }</span>
<a href="#l4.78"></a><span id="l4.78"> </span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-function awInputElementName()</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-{</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+function awInputElementName() {</span>
<a href="#l4.82"></a><span id="l4.82">   if (inputElementType == &quot;&quot;)</span>
<a href="#l4.83"></a><span id="l4.83">     inputElementType = document.getElementById(&quot;addressCol2#1&quot;).localName;</span>
<a href="#l4.84"></a><span id="l4.84">   return inputElementType;</span>
<a href="#l4.85"></a><span id="l4.85"> }</span>
<a href="#l4.86"></a><span id="l4.86"> </span>
<a href="#l4.87"></a><span id="l4.87" class="difflineminus">-function awSelectElementName()</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineminus">-{</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+function awSelectElementName() {</span>
<a href="#l4.90"></a><span id="l4.90">   if (selectElementType == &quot;&quot;)</span>
<a href="#l4.91"></a><span id="l4.91">       selectElementType = document.getElementById(&quot;addressCol1#1&quot;).localName;</span>
<a href="#l4.92"></a><span id="l4.92">   return selectElementType;</span>
<a href="#l4.93"></a><span id="l4.93"> }</span>
<a href="#l4.94"></a><span id="l4.94"> </span>
<a href="#l4.95"></a><span id="l4.95"> // TODO: replace awGetSelectItemIndex with recipient type index constants</span>
<a href="#l4.96"></a><span id="l4.96"> </span>
<a href="#l4.97"></a><span id="l4.97" class="difflineminus">-function awGetSelectItemIndex(itemData)</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineminus">-{</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineminus">-  if (selectElementIndexTable == null)</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineminus">-  {</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineminus">-    selectElementIndexTable = new Object();</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+function awGetSelectItemIndex(itemData) {</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+  if (selectElementIndexTable == null) {</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+    selectElementIndexTable = {};</span>
<a href="#l4.105"></a><span id="l4.105">     var selectElem = document.getElementById(&quot;addressCol1#1&quot;);</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineminus">-    for (var i = 0; i &lt; selectElem.childNodes[0].childNodes.length; i ++)</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineminus">-    {</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+    for (var i = 0; i &lt; selectElem.childNodes[0].childNodes.length; i++) {</span>
<a href="#l4.109"></a><span id="l4.109">       var aData = selectElem.childNodes[0].childNodes[i].getAttribute(&quot;value&quot;);</span>
<a href="#l4.110"></a><span id="l4.110">       selectElementIndexTable[aData] = i;</span>
<a href="#l4.111"></a><span id="l4.111">     }</span>
<a href="#l4.112"></a><span id="l4.112">   }</span>
<a href="#l4.113"></a><span id="l4.113"> </span>
<a href="#l4.114"></a><span id="l4.114">   return selectElementIndexTable[itemData];</span>
<a href="#l4.115"></a><span id="l4.115"> }</span>
<a href="#l4.116"></a><span id="l4.116"> </span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-function Recipients2CompFields(msgCompFields)</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-{</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+function Recipients2CompFields(msgCompFields) {</span>
<a href="#l4.120"></a><span id="l4.120">   if (!msgCompFields) {</span>
<a href="#l4.121"></a><span id="l4.121">     throw new Error(&quot;Message Compose Error: msgCompFields is null (ExtractRecipients)&quot;);</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-    return;</span>
<a href="#l4.123"></a><span id="l4.123">   }</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+</span>
<a href="#l4.125"></a><span id="l4.125">     var i = 1;</span>
<a href="#l4.126"></a><span id="l4.126">     var addrTo = &quot;&quot;;</span>
<a href="#l4.127"></a><span id="l4.127">     var addrCc = &quot;&quot;;</span>
<a href="#l4.128"></a><span id="l4.128">     var addrBcc = &quot;&quot;;</span>
<a href="#l4.129"></a><span id="l4.129">     var addrReply = &quot;&quot;;</span>
<a href="#l4.130"></a><span id="l4.130">     var addrNg = &quot;&quot;;</span>
<a href="#l4.131"></a><span id="l4.131">     var addrFollow = &quot;&quot;;</span>
<a href="#l4.132"></a><span id="l4.132">     var to_Sep = &quot;&quot;;</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineat">@@ -127,71 +114,84 @@ function Recipients2CompFields(msgCompFi</span>
<a href="#l4.134"></a><span id="l4.134">     var reply_Sep = &quot;&quot;;</span>
<a href="#l4.135"></a><span id="l4.135">     var ng_Sep = &quot;&quot;;</span>
<a href="#l4.136"></a><span id="l4.136">     var follow_Sep = &quot;&quot;;</span>
<a href="#l4.137"></a><span id="l4.137"> </span>
<a href="#l4.138"></a><span id="l4.138">     var recipientType;</span>
<a href="#l4.139"></a><span id="l4.139">     var inputField;</span>
<a href="#l4.140"></a><span id="l4.140">     var fieldValue;</span>
<a href="#l4.141"></a><span id="l4.141">     var recipient;</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-    while ((inputField = awGetInputElement(i)))</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    {</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    while ((inputField = awGetInputElement(i))) {</span>
<a href="#l4.145"></a><span id="l4.145">       fieldValue = inputField.value;</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-      if (fieldValue != &quot;&quot;)</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-      {</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+      if (fieldValue != &quot;&quot;) {</span>
<a href="#l4.149"></a><span id="l4.149">         recipientType = awGetPopupElement(i).value;</span>
<a href="#l4.150"></a><span id="l4.150">         recipient = null;</span>
<a href="#l4.151"></a><span id="l4.151"> </span>
<a href="#l4.152"></a><span id="l4.152" class="difflineminus">-        switch (recipientType)</span>
<a href="#l4.153"></a><span id="l4.153" class="difflineminus">-        {</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-          case &quot;addr_to&quot;    :</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineminus">-          case &quot;addr_cc&quot;    :</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-          case &quot;addr_bcc&quot;   :</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineminus">-          case &quot;addr_reply&quot; :</span>
<a href="#l4.158"></a><span id="l4.158" class="difflineplus">+        switch (recipientType) {</span>
<a href="#l4.159"></a><span id="l4.159" class="difflineplus">+          case &quot;addr_to&quot;:</span>
<a href="#l4.160"></a><span id="l4.160" class="difflineplus">+          case &quot;addr_cc&quot;:</span>
<a href="#l4.161"></a><span id="l4.161" class="difflineplus">+          case &quot;addr_bcc&quot;:</span>
<a href="#l4.162"></a><span id="l4.162" class="difflineplus">+          case &quot;addr_reply&quot;:</span>
<a href="#l4.163"></a><span id="l4.163">             try {</span>
<a href="#l4.164"></a><span id="l4.164">               let headerParser = MailServices.headerParser;</span>
<a href="#l4.165"></a><span id="l4.165">               recipient =</span>
<a href="#l4.166"></a><span id="l4.166">                 headerParser.makeFromDisplayAddress(fieldValue, {})</span>
<a href="#l4.167"></a><span id="l4.167">                             .map(fullValue =&gt; headerParser.makeMimeAddress(fullValue.name,</span>
<a href="#l4.168"></a><span id="l4.168">                                                                            fullValue.email))</span>
<a href="#l4.169"></a><span id="l4.169">                             .join(&quot;, &quot;);</span>
<a href="#l4.170"></a><span id="l4.170">             } catch (ex) {</span>
<a href="#l4.171"></a><span id="l4.171">               recipient = fieldValue;</span>
<a href="#l4.172"></a><span id="l4.172">             }</span>
<a href="#l4.173"></a><span id="l4.173">             break;</span>
<a href="#l4.174"></a><span id="l4.174">         }</span>
<a href="#l4.175"></a><span id="l4.175"> </span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-        switch (recipientType)</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-        {</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-          case &quot;addr_to&quot;          : addrTo += to_Sep + recipient; to_Sep = &quot;,&quot;;               break;</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-          case &quot;addr_cc&quot;          : addrCc += cc_Sep + recipient; cc_Sep = &quot;,&quot;;               break;</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-          case &quot;addr_bcc&quot;         : addrBcc += bcc_Sep + recipient; bcc_Sep = &quot;,&quot;;            break;</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineminus">-          case &quot;addr_reply&quot;       : addrReply += reply_Sep + recipient; reply_Sep = &quot;,&quot;;      break;</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineminus">-          case &quot;addr_newsgroups&quot;  : addrNg += ng_Sep + fieldValue; ng_Sep = &quot;,&quot;;              break;</span>
<a href="#l4.183"></a><span id="l4.183" class="difflineminus">-          case &quot;addr_followup&quot;    : addrFollow += follow_Sep + fieldValue; follow_Sep = &quot;,&quot;;  break;</span>
<a href="#l4.184"></a><span id="l4.184" class="difflineplus">+        switch (recipientType) {</span>
<a href="#l4.185"></a><span id="l4.185" class="difflineplus">+          case &quot;addr_to&quot;:</span>
<a href="#l4.186"></a><span id="l4.186" class="difflineplus">+            addrTo += to_Sep + recipient;</span>
<a href="#l4.187"></a><span id="l4.187" class="difflineplus">+            to_Sep = &quot;,&quot;;</span>
<a href="#l4.188"></a><span id="l4.188" class="difflineplus">+            break;</span>
<a href="#l4.189"></a><span id="l4.189" class="difflineplus">+          case &quot;addr_cc&quot;:</span>
<a href="#l4.190"></a><span id="l4.190" class="difflineplus">+            addrCc += cc_Sep + recipient;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineplus">+            cc_Sep = &quot;,&quot;;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineplus">+            break;</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineplus">+          case &quot;addr_bcc&quot;:</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineplus">+            addrBcc += bcc_Sep + recipient;</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineplus">+            bcc_Sep = &quot;,&quot;;</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+            break;</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+          case &quot;addr_reply&quot;:</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+            addrReply += reply_Sep + recipient;</span>
<a href="#l4.199"></a><span id="l4.199" class="difflineplus">+            reply_Sep = &quot;,&quot;;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineplus">+            break;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+          case &quot;addr_newsgroups&quot;:</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+            addrNg += ng_Sep + fieldValue;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineplus">+            ng_Sep = &quot;,&quot;;</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+            break;</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+          case &quot;addr_followup&quot;:</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+            addrFollow += follow_Sep + fieldValue;</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+            follow_Sep = &quot;,&quot;;</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+            break;</span>
<a href="#l4.209"></a><span id="l4.209">           case &quot;addr_other&quot;:</span>
<a href="#l4.210"></a><span id="l4.210">             let headerName = awGetPopupElement(i).label;</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineminus">-            headerName = headerName.substring(0, headerName.indexOf(':'));</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+            headerName = headerName.substring(0, headerName.indexOf(&quot;:&quot;));</span>
<a href="#l4.213"></a><span id="l4.213">             msgCompFields.setRawHeader(headerName, fieldValue, null);</span>
<a href="#l4.214"></a><span id="l4.214">             break;</span>
<a href="#l4.215"></a><span id="l4.215">         }</span>
<a href="#l4.216"></a><span id="l4.216">       }</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineminus">-      i ++;</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+      i++;</span>
<a href="#l4.219"></a><span id="l4.219">     }</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221">     msgCompFields.to = addrTo;</span>
<a href="#l4.222"></a><span id="l4.222">     msgCompFields.cc = addrCc;</span>
<a href="#l4.223"></a><span id="l4.223">     msgCompFields.bcc = addrBcc;</span>
<a href="#l4.224"></a><span id="l4.224">     msgCompFields.replyTo = addrReply;</span>
<a href="#l4.225"></a><span id="l4.225">     msgCompFields.newsgroups = addrNg;</span>
<a href="#l4.226"></a><span id="l4.226">     msgCompFields.followupTo = addrFollow;</span>
<a href="#l4.227"></a><span id="l4.227"> }</span>
<a href="#l4.228"></a><span id="l4.228"> </span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-function CompFields2Recipients(msgCompFields)</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-{</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+function CompFields2Recipients(msgCompFields) {</span>
<a href="#l4.232"></a><span id="l4.232">   if (msgCompFields) {</span>
<a href="#l4.233"></a><span id="l4.233">     let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.234"></a><span id="l4.234">     let newListBoxNode = listbox.cloneNode(false);</span>
<a href="#l4.235"></a><span id="l4.235">     let listBoxColsClone = listbox.firstChild.cloneNode(true);</span>
<a href="#l4.236"></a><span id="l4.236">     newListBoxNode.appendChild(listBoxColsClone);</span>
<a href="#l4.237"></a><span id="l4.237">     let templateNode = listbox.getElementsByTagName(&quot;richlistitem&quot;)[0];</span>
<a href="#l4.238"></a><span id="l4.238">     // dump(&quot;replacing child in comp fields 2 recips \n&quot;);</span>
<a href="#l4.239"></a><span id="l4.239">     listbox.parentNode.replaceChild(newListBoxNode, listbox);</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineat">@@ -202,53 +202,49 @@ function CompFields2Recipients(msgCompFi</span>
<a href="#l4.241"></a><span id="l4.241">     let msgCC = msgCompFields.cc;</span>
<a href="#l4.242"></a><span id="l4.242">     let msgBCC = msgCompFields.bcc;</span>
<a href="#l4.243"></a><span id="l4.243">     let msgNewsgroups = msgCompFields.newsgroups;</span>
<a href="#l4.244"></a><span id="l4.244">     let msgFollowupTo = msgCompFields.followupTo;</span>
<a href="#l4.245"></a><span id="l4.245">     let havePrimaryRecipient = false;</span>
<a href="#l4.246"></a><span id="l4.246">     if (msgReplyTo)</span>
<a href="#l4.247"></a><span id="l4.247">       awSetInputAndPopupFromArray(msgCompFields.splitRecipients(msgReplyTo, false, {}),</span>
<a href="#l4.248"></a><span id="l4.248">                                   &quot;addr_reply&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-    if (msgTo)</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    {</span>
<a href="#l4.251"></a><span id="l4.251" class="difflineplus">+    if (msgTo) {</span>
<a href="#l4.252"></a><span id="l4.252">       let rcp = msgCompFields.splitRecipients(msgTo, false, {});</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-      if (rcp.length)</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-      {</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineplus">+      if (rcp.length) {</span>
<a href="#l4.256"></a><span id="l4.256">         awSetInputAndPopupFromArray(rcp, &quot;addr_to&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.257"></a><span id="l4.257">         havePrimaryRecipient = true;</span>
<a href="#l4.258"></a><span id="l4.258">       }</span>
<a href="#l4.259"></a><span id="l4.259">     }</span>
<a href="#l4.260"></a><span id="l4.260">     if (msgCC)</span>
<a href="#l4.261"></a><span id="l4.261">       awSetInputAndPopupFromArray(msgCompFields.splitRecipients(msgCC, false, {}),</span>
<a href="#l4.262"></a><span id="l4.262">                                   &quot;addr_cc&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.263"></a><span id="l4.263">     if (msgBCC)</span>
<a href="#l4.264"></a><span id="l4.264">       awSetInputAndPopupFromArray(msgCompFields.splitRecipients(msgBCC, false, {}),</span>
<a href="#l4.265"></a><span id="l4.265">                                   &quot;addr_bcc&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineminus">-    if (msgNewsgroups)</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineminus">-    {</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+    if (msgNewsgroups) {</span>
<a href="#l4.269"></a><span id="l4.269">       awSetInputAndPopup(msgNewsgroups, &quot;addr_newsgroups&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.270"></a><span id="l4.270">       havePrimaryRecipient = true;</span>
<a href="#l4.271"></a><span id="l4.271">     }</span>
<a href="#l4.272"></a><span id="l4.272">     if (msgFollowupTo)</span>
<a href="#l4.273"></a><span id="l4.273">       awSetInputAndPopup(msgFollowupTo, &quot;addr_followup&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.274"></a><span id="l4.274"> </span>
<a href="#l4.275"></a><span id="l4.275">     // If it's a new message, we need to add an extra empty recipient.</span>
<a href="#l4.276"></a><span id="l4.276">     if (!havePrimaryRecipient)</span>
<a href="#l4.277"></a><span id="l4.277">       _awSetInputAndPopup(&quot;&quot;, &quot;addr_to&quot;, newListBoxNode, templateNode);</span>
<a href="#l4.278"></a><span id="l4.278">     awFitDummyRows(2);</span>
<a href="#l4.279"></a><span id="l4.279"> </span>
<a href="#l4.280"></a><span id="l4.280">     // CompFields2Recipients is called whenever a user replies or edits an existing message. We want to</span>
<a href="#l4.281"></a><span id="l4.281">     // add all of the non-empty recipients for this message to the ignore list for spell check</span>
<a href="#l4.282"></a><span id="l4.282">     let currentAddress = gCurrentIdentity ? gCurrentIdentity.fullAddress : &quot;&quot;;</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineminus">-    addRecipientsToIgnoreList([currentAddress,msgTo,msgCC,msgBCC].filter(adr =&gt; adr).join(&quot;, &quot;));</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+    addRecipientsToIgnoreList([currentAddress, msgTo, msgCC, msgBCC].filter(adr =&gt; adr).join(&quot;, &quot;));</span>
<a href="#l4.285"></a><span id="l4.285">   }</span>
<a href="#l4.286"></a><span id="l4.286"> }</span>
<a href="#l4.287"></a><span id="l4.287"> </span>
<a href="#l4.288"></a><span id="l4.288" class="difflineminus">-function awSetInputAndPopupId(inputElem, popupElem, rowNumber)</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineminus">-{</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+function awSetInputAndPopupId(inputElem, popupElem, rowNumber) {</span>
<a href="#l4.291"></a><span id="l4.291">   popupElem.id = &quot;addressCol1#&quot; + rowNumber;</span>
<a href="#l4.292"></a><span id="l4.292">   inputElem.id = &quot;addressCol2#&quot; + rowNumber;</span>
<a href="#l4.293"></a><span id="l4.293">   inputElem.setAttribute(&quot;aria-labelledby&quot;, popupElem.id);</span>
<a href="#l4.294"></a><span id="l4.294"> }</span>
<a href="#l4.295"></a><span id="l4.295"> </span>
<a href="#l4.296"></a><span id="l4.296"> /**</span>
<a href="#l4.297"></a><span id="l4.297">  * Set value of the recipient input field at row rowNumber and set up</span>
<a href="#l4.298"></a><span id="l4.298">  * the recipient type menulist.</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineat">@@ -257,143 +253,125 @@ function awSetInputAndPopupId(inputElem,</span>
<a href="#l4.300"></a><span id="l4.300">  * @param inputValue                recipient value (address)</span>
<a href="#l4.301"></a><span id="l4.301">  * @param popupElem                 recipient type menulist element</span>
<a href="#l4.302"></a><span id="l4.302">  * @param popupValue</span>
<a href="#l4.303"></a><span id="l4.303">  * @param aNotifyRecipientsChanged  Notify that the recipients have changed.</span>
<a href="#l4.304"></a><span id="l4.304">  *                                  Generally we notify unless recipients are</span>
<a href="#l4.305"></a><span id="l4.305">  *                                  added in batch when the caller takes care</span>
<a href="#l4.306"></a><span id="l4.306">  *                                  of the notification.</span>
<a href="#l4.307"></a><span id="l4.307">  */</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-function awSetInputAndPopupValue(inputElem, inputValue, popupElem, popupValue, rowNumber, aNotifyRecipientsChanged = true)</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-{</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineplus">+function awSetInputAndPopupValue(inputElem, inputValue, popupElem, popupValue, rowNumber, aNotifyRecipientsChanged = true) {</span>
<a href="#l4.311"></a><span id="l4.311">   inputElem.value = inputValue.trimLeft();</span>
<a href="#l4.312"></a><span id="l4.312"> </span>
<a href="#l4.313"></a><span id="l4.313">   popupElem.selectedItem = popupElem.childNodes[0].childNodes[awGetSelectItemIndex(popupValue)];</span>
<a href="#l4.314"></a><span id="l4.314">   // TODO: can there be a row without ID yet?</span>
<a href="#l4.315"></a><span id="l4.315">   if (rowNumber &gt;= 0)</span>
<a href="#l4.316"></a><span id="l4.316">     awSetInputAndPopupId(inputElem, popupElem, rowNumber);</span>
<a href="#l4.317"></a><span id="l4.317"> </span>
<a href="#l4.318"></a><span id="l4.318">   _awSetAutoComplete(popupElem, inputElem);</span>
<a href="#l4.319"></a><span id="l4.319"> </span>
<a href="#l4.320"></a><span id="l4.320">   if (aNotifyRecipientsChanged)</span>
<a href="#l4.321"></a><span id="l4.321">     onRecipientsChanged(true);</span>
<a href="#l4.322"></a><span id="l4.322"> }</span>
<a href="#l4.323"></a><span id="l4.323"> </span>
<a href="#l4.324"></a><span id="l4.324" class="difflineminus">-function _awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode)</span>
<a href="#l4.325"></a><span id="l4.325" class="difflineminus">-{</span>
<a href="#l4.326"></a><span id="l4.326" class="difflineplus">+function _awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode) {</span>
<a href="#l4.327"></a><span id="l4.327">     top.MAX_RECIPIENTS++;</span>
<a href="#l4.328"></a><span id="l4.328"> </span>
<a href="#l4.329"></a><span id="l4.329">     var newNode = templateNode.cloneNode(true);</span>
<a href="#l4.330"></a><span id="l4.330">     parentNode.appendChild(newNode); // we need to insert the new node before we set the value of the select element!</span>
<a href="#l4.331"></a><span id="l4.331"> </span>
<a href="#l4.332"></a><span id="l4.332">     var input = newNode.getElementsByTagName(awInputElementName());</span>
<a href="#l4.333"></a><span id="l4.333">     var select = newNode.getElementsByTagName(awSelectElementName());</span>
<a href="#l4.334"></a><span id="l4.334"> </span>
<a href="#l4.335"></a><span id="l4.335">     if (input &amp;&amp; input.length == 1 &amp;&amp; select &amp;&amp; select.length == 1)</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-      awSetInputAndPopupValue(input[0], inputValue, select[0], popupValue, top.MAX_RECIPIENTS)</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineplus">+      awSetInputAndPopupValue(input[0], inputValue, select[0], popupValue, top.MAX_RECIPIENTS);</span>
<a href="#l4.338"></a><span id="l4.338"> }</span>
<a href="#l4.339"></a><span id="l4.339"> </span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-function awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode)</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-{</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-  if ( inputValue &amp;&amp; popupValue )</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineminus">-  {</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+function awSetInputAndPopup(inputValue, popupValue, parentNode, templateNode) {</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+  if (inputValue &amp;&amp; popupValue) {</span>
<a href="#l4.346"></a><span id="l4.346">     var addressArray = inputValue.split(&quot;,&quot;);</span>
<a href="#l4.347"></a><span id="l4.347"> </span>
<a href="#l4.348"></a><span id="l4.348" class="difflineminus">-    for ( var index = 0; index &lt; addressArray.length; index++ )</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineminus">-        _awSetInputAndPopup(addressArray[index], popupValue, parentNode, templateNode);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    for (var index = 0; index &lt; addressArray.length; index++)</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+      _awSetInputAndPopup(addressArray[index], popupValue, parentNode, templateNode);</span>
<a href="#l4.352"></a><span id="l4.352">   }</span>
<a href="#l4.353"></a><span id="l4.353"> }</span>
<a href="#l4.354"></a><span id="l4.354"> </span>
<a href="#l4.355"></a><span id="l4.355" class="difflineminus">-function awSetInputAndPopupFromArray(inputArray, popupValue, parentNode, templateNode)</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineminus">-{</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineminus">-  if (popupValue)</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineminus">-  {</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+function awSetInputAndPopupFromArray(inputArray, popupValue, parentNode, templateNode) {</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+  if (popupValue) {</span>
<a href="#l4.361"></a><span id="l4.361">     for (let recipient of inputArray)</span>
<a href="#l4.362"></a><span id="l4.362">       _awSetInputAndPopup(recipient, popupValue, parentNode, templateNode);</span>
<a href="#l4.363"></a><span id="l4.363">   }</span>
<a href="#l4.364"></a><span id="l4.364"> }</span>
<a href="#l4.365"></a><span id="l4.365"> </span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-function awRemoveRecipients(msgCompFields, recipientType, recipientsList)</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-{</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+function awRemoveRecipients(msgCompFields, recipientType, recipientsList) {</span>
<a href="#l4.369"></a><span id="l4.369">   if (!msgCompFields || !recipientsList)</span>
<a href="#l4.370"></a><span id="l4.370">     return;</span>
<a href="#l4.371"></a><span id="l4.371"> </span>
<a href="#l4.372"></a><span id="l4.372">   var recipientArray = msgCompFields.splitRecipients(recipientsList, false, {});</span>
<a href="#l4.373"></a><span id="l4.373"> </span>
<a href="#l4.374"></a><span id="l4.374">   for (var index = 0; index &lt; recipientArray.length; index++)</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineminus">-    for (var row = 1; row &lt;= top.MAX_RECIPIENTS; row ++)</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineminus">-    {</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+    for (var row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l4.378"></a><span id="l4.378">       var popup = awGetPopupElement(row);</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-      if (popup.value == recipientType)</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-      {</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+      if (popup.value == recipientType) {</span>
<a href="#l4.382"></a><span id="l4.382">         var input = awGetInputElement(row);</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineminus">-        if (input.value == recipientArray[index])</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineminus">-        {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+        if (input.value == recipientArray[index]) {</span>
<a href="#l4.386"></a><span id="l4.386">           awSetInputAndPopupValue(input, &quot;&quot;, popup, &quot;addr_to&quot;, -1);</span>
<a href="#l4.387"></a><span id="l4.387">           break;</span>
<a href="#l4.388"></a><span id="l4.388">         }</span>
<a href="#l4.389"></a><span id="l4.389">       }</span>
<a href="#l4.390"></a><span id="l4.390">     }</span>
<a href="#l4.391"></a><span id="l4.391"> }</span>
<a href="#l4.392"></a><span id="l4.392"> </span>
<a href="#l4.393"></a><span id="l4.393"> /**</span>
<a href="#l4.394"></a><span id="l4.394">  * Adds a batch of new rows matching recipientType and drops in the list of addresses.</span>
<a href="#l4.395"></a><span id="l4.395">  *</span>
<a href="#l4.396"></a><span id="l4.396">  * @param msgCompFields  A nsIMsgCompFields object that is only used as a helper,</span>
<a href="#l4.397"></a><span id="l4.397">  *                       it will not get the addresses appended.</span>
<a href="#l4.398"></a><span id="l4.398">  * @param recipientType  Type of recipient, e.g. &quot;addr_to&quot;.</span>
<a href="#l4.399"></a><span id="l4.399">  * @param recipientList  A string of addresses to add.</span>
<a href="#l4.400"></a><span id="l4.400">  */</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineminus">-function awAddRecipients(msgCompFields, recipientType, recipientsList)</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineminus">-{</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+function awAddRecipients(msgCompFields, recipientType, recipientsList) {</span>
<a href="#l4.404"></a><span id="l4.404">   if (!msgCompFields || !recipientsList)</span>
<a href="#l4.405"></a><span id="l4.405">     return;</span>
<a href="#l4.406"></a><span id="l4.406"> </span>
<a href="#l4.407"></a><span id="l4.407">   var recipientArray = msgCompFields.splitRecipients(recipientsList, false, {});</span>
<a href="#l4.408"></a><span id="l4.408">   awAddRecipientsArray(recipientType, recipientArray);</span>
<a href="#l4.409"></a><span id="l4.409"> }</span>
<a href="#l4.410"></a><span id="l4.410"> </span>
<a href="#l4.411"></a><span id="l4.411"> /**</span>
<a href="#l4.412"></a><span id="l4.412">  * Adds a batch of new rows matching recipientType and drops in the array of addresses.</span>
<a href="#l4.413"></a><span id="l4.413">  *</span>
<a href="#l4.414"></a><span id="l4.414">  * @param aRecipientType  Type of recipient, e.g. &quot;addr_to&quot;.</span>
<a href="#l4.415"></a><span id="l4.415">  * @param aAddressArray   An array of recipient addresses (strings) to add.</span>
<a href="#l4.416"></a><span id="l4.416">  */</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-function awAddRecipientsArray(aRecipientType, aAddressArray)</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-{</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineplus">+function awAddRecipientsArray(aRecipientType, aAddressArray) {</span>
<a href="#l4.420"></a><span id="l4.420">   // Find rows that are empty so that we can fill them.</span>
<a href="#l4.421"></a><span id="l4.421">   let emptyRows = [];</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row ++)</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineminus">-  {</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+  for (let row = 1; row &lt;= top.MAX_RECIPIENTS; row++) {</span>
<a href="#l4.425"></a><span id="l4.425">     if (awGetInputElement(row).value == &quot;&quot;)</span>
<a href="#l4.426"></a><span id="l4.426">       emptyRows.push(row);</span>
<a href="#l4.427"></a><span id="l4.427">   }</span>
<a href="#l4.428"></a><span id="l4.428"> </span>
<a href="#l4.429"></a><span id="l4.429">   // Push the new recipients into the found empty rows or append new rows when needed.</span>
<a href="#l4.430"></a><span id="l4.430">   let row = 1;</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-  for (let address of aAddressArray)</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-  {</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-    if (emptyRows.length &gt; 0)</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-    {</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+  for (let address of aAddressArray) {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+    if (emptyRows.length &gt; 0) {</span>
<a href="#l4.437"></a><span id="l4.437">       row = emptyRows.shift();</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-    }</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-    else</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-    {</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+    } else {</span>
<a href="#l4.442"></a><span id="l4.442">       awAppendNewRow(false);</span>
<a href="#l4.443"></a><span id="l4.443">       row = top.MAX_RECIPIENTS;</span>
<a href="#l4.444"></a><span id="l4.444">     }</span>
<a href="#l4.445"></a><span id="l4.445"> </span>
<a href="#l4.446"></a><span id="l4.446">     awSetInputAndPopupValue(awGetInputElement(row), address,</span>
<a href="#l4.447"></a><span id="l4.447">                             awGetPopupElement(row), aRecipientType,</span>
<a href="#l4.448"></a><span id="l4.448">                             row, false);</span>
<a href="#l4.449"></a><span id="l4.449">   }</span>
<a href="#l4.450"></a><span id="l4.450"> </span>
<a href="#l4.451"></a><span id="l4.451">   // Be sure we still have an empty row left.</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-  if ((emptyRows.length == 0) &amp;&amp; (awGetInputElement(top.MAX_RECIPIENTS).value != &quot;&quot;))</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-  {</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineplus">+  if ((emptyRows.length == 0) &amp;&amp; (awGetInputElement(top.MAX_RECIPIENTS).value != &quot;&quot;)) {</span>
<a href="#l4.455"></a><span id="l4.455">     // Insert empty row at the end and focus.</span>
<a href="#l4.456"></a><span id="l4.456">     awAppendNewRow(true);</span>
<a href="#l4.457"></a><span id="l4.457">     awSetInputAndPopupValue(awGetInputElement(top.MAX_RECIPIENTS), &quot;&quot;,</span>
<a href="#l4.458"></a><span id="l4.458">                             awGetPopupElement(top.MAX_RECIPIENTS), &quot;addr_to&quot;,</span>
<a href="#l4.459"></a><span id="l4.459">                             top.MAX_RECIPIENTS, false);</span>
<a href="#l4.460"></a><span id="l4.460">   } else {</span>
<a href="#l4.461"></a><span id="l4.461">     // Focus the next empty row, if any, or the pre-existing empty last row.</span>
<a href="#l4.462"></a><span id="l4.462">     row = (emptyRows.length &gt; 0) ? emptyRows.shift() : top.MAX_RECIPIENTS;</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineat">@@ -409,190 +387,169 @@ function awAddRecipientsArray(aRecipient</span>
<a href="#l4.464"></a><span id="l4.464"> /**</span>
<a href="#l4.465"></a><span id="l4.465">  * Adds a new row matching recipientType and drops in the single address.</span>
<a href="#l4.466"></a><span id="l4.466">  *</span>
<a href="#l4.467"></a><span id="l4.467">  * This is mostly used by addons, even though they should use AddRecipient().</span>
<a href="#l4.468"></a><span id="l4.468">  *</span>
<a href="#l4.469"></a><span id="l4.469">  * @param aRecipientType  Type of recipient, e.g. addr_to.</span>
<a href="#l4.470"></a><span id="l4.470">  * @param aAddress        A string with recipient address.</span>
<a href="#l4.471"></a><span id="l4.471">  */</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-function awAddRecipient(aRecipientType, aAddress)</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-{</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineplus">+function awAddRecipient(aRecipientType, aAddress) {</span>
<a href="#l4.475"></a><span id="l4.475">   awAddRecipientsArray(aRecipientType, [aAddress]);</span>
<a href="#l4.476"></a><span id="l4.476"> }</span>
<a href="#l4.477"></a><span id="l4.477"> </span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-function awTestRowSequence()</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-{</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineplus">+function awTestRowSequence() {</span>
<a href="#l4.481"></a><span id="l4.481">   /*</span>
<a href="#l4.482"></a><span id="l4.482">     This function is for debug and testing purpose only, normal user should not run it!</span>
<a href="#l4.483"></a><span id="l4.483"> </span>
<a href="#l4.484"></a><span id="l4.484">     Every time we insert or delete a row, we must be sure we didn't break the ID sequence of</span>
<a href="#l4.485"></a><span id="l4.485">     the addressing widget rows. This function will run a quick test to see if the sequence still ok</span>
<a href="#l4.486"></a><span id="l4.486"> </span>
<a href="#l4.487"></a><span id="l4.487">     You need to define the pref mail.debug.test_addresses_sequence to true in order to activate it</span>
<a href="#l4.488"></a><span id="l4.488">   */</span>
<a href="#l4.489"></a><span id="l4.489"> </span>
<a href="#l4.490"></a><span id="l4.490">   if (!test_addresses_sequence)</span>
<a href="#l4.491"></a><span id="l4.491">     return true;</span>
<a href="#l4.492"></a><span id="l4.492"> </span>
<a href="#l4.493"></a><span id="l4.493">   /* debug code to verify the sequence still good */</span>
<a href="#l4.494"></a><span id="l4.494"> </span>
<a href="#l4.495"></a><span id="l4.495">   let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.496"></a><span id="l4.496">   let listitems = listbox.getElementsByTagName(&quot;richlistitem&quot;);</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-  if (listitems.length &gt;= top.MAX_RECIPIENTS )</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-  {</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-    for (let i = 1; i &lt;= listitems.length; i ++)</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-    {</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-      let item = listitems [i - 1];</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineplus">+  if (listitems.length &gt;= top.MAX_RECIPIENTS) {</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineplus">+    for (let i = 1; i &lt;= listitems.length; i++) {</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineplus">+      let item = listitems[i - 1];</span>
<a href="#l4.505"></a><span id="l4.505">       let inputID = item.querySelector(awInputElementName()).id.split(&quot;#&quot;)[1];</span>
<a href="#l4.506"></a><span id="l4.506">       let popupID = item.querySelector(awSelectElementName()).id.split(&quot;#&quot;)[1];</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-      if (inputID != i || popupID != i)</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-      {</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+      if (inputID != i || popupID != i) {</span>
<a href="#l4.510"></a><span id="l4.510">         dump(&quot;#ERROR: sequence broken at row &quot; + i + &quot;, inputID=&quot; + inputID + &quot;, popupID=&quot; + popupID + &quot;\n&quot;);</span>
<a href="#l4.511"></a><span id="l4.511">         return false;</span>
<a href="#l4.512"></a><span id="l4.512">       }</span>
<a href="#l4.513"></a><span id="l4.513">       dump(&quot;---SEQUENCE OK---\n&quot;);</span>
<a href="#l4.514"></a><span id="l4.514">       return true;</span>
<a href="#l4.515"></a><span id="l4.515">     }</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+  } else {</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+    dump(&quot;#ERROR: listitems.length(&quot; + listitems.length + &quot;) &lt; top.MAX_RECIPIENTS(&quot; + top.MAX_RECIPIENTS + &quot;)\n&quot;);</span>
<a href="#l4.518"></a><span id="l4.518">   }</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-  else</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-    dump(&quot;#ERROR: listitems.length(&quot; + listitems.length + &quot;) &lt; top.MAX_RECIPIENTS(&quot; + top.MAX_RECIPIENTS + &quot;)\n&quot;);</span>
<a href="#l4.521"></a><span id="l4.521"> </span>
<a href="#l4.522"></a><span id="l4.522">   return false;</span>
<a href="#l4.523"></a><span id="l4.523"> }</span>
<a href="#l4.524"></a><span id="l4.524"> </span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-function awCleanupRows()</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-{</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineplus">+function awCleanupRows() {</span>
<a href="#l4.528"></a><span id="l4.528">   var maxRecipients = top.MAX_RECIPIENTS;</span>
<a href="#l4.529"></a><span id="l4.529">   var rowID = 1;</span>
<a href="#l4.530"></a><span id="l4.530"> </span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-  for (var row = 1; row &lt;= maxRecipients; row ++)</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-  {</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineplus">+  for (var row = 1; row &lt;= maxRecipients; row++) {</span>
<a href="#l4.534"></a><span id="l4.534">     var inputElem = awGetInputElement(row);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineminus">-    if (inputElem.value == &quot;&quot; &amp;&amp; row &lt; maxRecipients)</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+    if (inputElem.value == &quot;&quot; &amp;&amp; row &lt; maxRecipients) {</span>
<a href="#l4.537"></a><span id="l4.537">       awRemoveRow(awGetRowByInputElement(inputElem));</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineminus">-    else</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineminus">-    {</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+    } else {</span>
<a href="#l4.541"></a><span id="l4.541">       awSetInputAndPopupId(inputElem, awGetPopupElement(row), rowID);</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineminus">-      rowID ++;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+      rowID++;</span>
<a href="#l4.544"></a><span id="l4.544">     }</span>
<a href="#l4.545"></a><span id="l4.545">   }</span>
<a href="#l4.546"></a><span id="l4.546"> </span>
<a href="#l4.547"></a><span id="l4.547">   awTestRowSequence();</span>
<a href="#l4.548"></a><span id="l4.548"> }</span>
<a href="#l4.549"></a><span id="l4.549"> </span>
<a href="#l4.550"></a><span id="l4.550" class="difflineminus">-function awDeleteRow(rowToDelete)</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineminus">-{</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+function awDeleteRow(rowToDelete) {</span>
<a href="#l4.553"></a><span id="l4.553">   // When we delete a row, we must reset the id of other rows in order to not break the sequence.</span>
<a href="#l4.554"></a><span id="l4.554">   var maxRecipients = top.MAX_RECIPIENTS;</span>
<a href="#l4.555"></a><span id="l4.555">   awRemoveRow(rowToDelete);</span>
<a href="#l4.556"></a><span id="l4.556"> </span>
<a href="#l4.557"></a><span id="l4.557">   // assume 2 column update (input and popup)</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-  for (var row = rowToDelete + 1; row &lt;= maxRecipients; row ++)</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-    awSetInputAndPopupId(awGetInputElement(row), awGetPopupElement(row), (row-1));</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+  for (var row = rowToDelete + 1; row &lt;= maxRecipients; row++)</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineplus">+    awSetInputAndPopupId(awGetInputElement(row), awGetPopupElement(row), (row - 1));</span>
<a href="#l4.562"></a><span id="l4.562"> </span>
<a href="#l4.563"></a><span id="l4.563">   awTestRowSequence();</span>
<a href="#l4.564"></a><span id="l4.564"> }</span>
<a href="#l4.565"></a><span id="l4.565"> </span>
<a href="#l4.566"></a><span id="l4.566" class="difflineminus">-function awClickEmptySpace(target, setFocus)</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineminus">-{</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+function awClickEmptySpace(target, setFocus) {</span>
<a href="#l4.569"></a><span id="l4.569">   if (document.getElementById(&quot;addressCol2#1&quot;).disabled ||</span>
<a href="#l4.570"></a><span id="l4.570">       target == null ||</span>
<a href="#l4.571"></a><span id="l4.571">       target.localName != &quot;hbox&quot;)</span>
<a href="#l4.572"></a><span id="l4.572">     return;</span>
<a href="#l4.573"></a><span id="l4.573"> </span>
<a href="#l4.574"></a><span id="l4.574">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.575"></a><span id="l4.575"> </span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-  if ( lastInput &amp;&amp; lastInput.value )</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineplus">+  if (lastInput &amp;&amp; lastInput.value)</span>
<a href="#l4.578"></a><span id="l4.578">     awAppendNewRow(setFocus);</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-  else</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-    if (setFocus)</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-      awSetFocus(top.MAX_RECIPIENTS, lastInput);</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineplus">+  else if (setFocus)</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineplus">+    awSetFocus(top.MAX_RECIPIENTS, lastInput);</span>
<a href="#l4.584"></a><span id="l4.584"> }</span>
<a href="#l4.585"></a><span id="l4.585"> </span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-function awReturnHit(inputElement)</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineminus">-{</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+function awReturnHit(inputElement) {</span>
<a href="#l4.589"></a><span id="l4.589">   var row = awGetRowByInputElement(inputElement);</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-  var nextInput = awGetInputElement(row+1);</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+  var nextInput = awGetInputElement(row + 1);</span>
<a href="#l4.592"></a><span id="l4.592"> </span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-  if ( !nextInput )</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-  {</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-    if ( inputElement.value )</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+  if (!nextInput) {</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+    if (inputElement.value) {</span>
<a href="#l4.598"></a><span id="l4.598">       awAppendNewRow(true);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-    else // No address entered, switch to Subject field</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-    {</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-      var subjectField = document.getElementById( 'msgSubject' );</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+    } else {</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+      // No address entered, switch to Subject field</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+      var subjectField = document.getElementById(&quot;msgSubject&quot;);</span>
<a href="#l4.605"></a><span id="l4.605">       subjectField.select();</span>
<a href="#l4.606"></a><span id="l4.606">       subjectField.focus();</span>
<a href="#l4.607"></a><span id="l4.607">     }</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineminus">-  }</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineminus">-  else</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineminus">-  {</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+  } else {</span>
<a href="#l4.612"></a><span id="l4.612">     nextInput.select();</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-    awSetFocus(row+1, nextInput);</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+    awSetFocus(row + 1, nextInput);</span>
<a href="#l4.615"></a><span id="l4.615">   }</span>
<a href="#l4.616"></a><span id="l4.616"> </span>
<a href="#l4.617"></a><span id="l4.617">   // be sure to add the user add recipient to our ignore list</span>
<a href="#l4.618"></a><span id="l4.618">   // when the user hits enter in an autocomplete widget...</span>
<a href="#l4.619"></a><span id="l4.619">   addRecipientsToIgnoreList(inputElement.value);</span>
<a href="#l4.620"></a><span id="l4.620"> }</span>
<a href="#l4.621"></a><span id="l4.621"> </span>
<a href="#l4.622"></a><span id="l4.622" class="difflineminus">-function awDeleteHit(inputElement)</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineminus">-{</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+function awDeleteHit(inputElement) {</span>
<a href="#l4.625"></a><span id="l4.625">   var row = awGetRowByInputElement(inputElement);</span>
<a href="#l4.626"></a><span id="l4.626"> </span>
<a href="#l4.627"></a><span id="l4.627">   /* 1. don't delete the row if it's the last one remaining, just reset it! */</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineminus">-  if (top.MAX_RECIPIENTS &lt;= 1)</span>
<a href="#l4.629"></a><span id="l4.629" class="difflineminus">-  {</span>
<a href="#l4.630"></a><span id="l4.630" class="difflineplus">+  if (top.MAX_RECIPIENTS &lt;= 1) {</span>
<a href="#l4.631"></a><span id="l4.631">     inputElement.value = &quot;&quot;;</span>
<a href="#l4.632"></a><span id="l4.632">     return;</span>
<a href="#l4.633"></a><span id="l4.633">   }</span>
<a href="#l4.634"></a><span id="l4.634"> </span>
<a href="#l4.635"></a><span id="l4.635">   /* 2. Set the focus to the previous field if possible */</span>
<a href="#l4.636"></a><span id="l4.636">   if (row &gt; 1)</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineminus">-    awSetFocus(row - 1, awGetInputElement(row - 1))</span>
<a href="#l4.638"></a><span id="l4.638" class="difflineplus">+    awSetFocus(row - 1, awGetInputElement(row - 1));</span>
<a href="#l4.639"></a><span id="l4.639">   else</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-    awSetFocus(1, awGetInputElement(2))   /* We have to cheat a little bit because the focus will */</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineplus">+    awSetFocus(1, awGetInputElement(2));  /* We have to cheat a little bit because the focus will */</span>
<a href="#l4.642"></a><span id="l4.642">                                           /* be set asynchronusly after we delete the current row, */</span>
<a href="#l4.643"></a><span id="l4.643">                                           /* therefore the row number still the same! */</span>
<a href="#l4.644"></a><span id="l4.644"> </span>
<a href="#l4.645"></a><span id="l4.645">   /* 3. Delete the row */</span>
<a href="#l4.646"></a><span id="l4.646">   awDeleteRow(row);</span>
<a href="#l4.647"></a><span id="l4.647"> }</span>
<a href="#l4.648"></a><span id="l4.648"> </span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-function awInputChanged(inputElement)</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-{</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-  //Do we need to add a new row?</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+function awInputChanged(inputElement) {</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+  // Do we need to add a new row?</span>
<a href="#l4.654"></a><span id="l4.654">   var lastInput = awGetInputElement(top.MAX_RECIPIENTS);</span>
<a href="#l4.655"></a><span id="l4.655" class="difflineminus">-  if ( lastInput &amp;&amp; lastInput.value &amp;&amp; !top.doNotCreateANewRow)</span>
<a href="#l4.656"></a><span id="l4.656" class="difflineplus">+  if (lastInput &amp;&amp; lastInput.value &amp;&amp; !top.doNotCreateANewRow)</span>
<a href="#l4.657"></a><span id="l4.657">     awAppendNewRow(false);</span>
<a href="#l4.658"></a><span id="l4.658">   top.doNotCreateANewRow = false;</span>
<a href="#l4.659"></a><span id="l4.659"> }</span>
<a href="#l4.660"></a><span id="l4.660"> </span>
<a href="#l4.661"></a><span id="l4.661" class="difflineminus">-function awAppendNewRow(setFocus)</span>
<a href="#l4.662"></a><span id="l4.662" class="difflineminus">-{</span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-  var listbox = document.getElementById('addressingWidget');</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineplus">+function awAppendNewRow(setFocus) {</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.666"></a><span id="l4.666">   var listitem1 = awGetListItem(1);</span>
<a href="#l4.667"></a><span id="l4.667"> </span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-  if ( listbox &amp;&amp; listitem1 )</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-  {</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineplus">+  if (listbox &amp;&amp; listitem1) {</span>
<a href="#l4.671"></a><span id="l4.671">     var lastRecipientType = awGetPopupElement(top.MAX_RECIPIENTS).value;</span>
<a href="#l4.672"></a><span id="l4.672"> </span>
<a href="#l4.673"></a><span id="l4.673">     var nextDummy = awGetNextDummyRow();</span>
<a href="#l4.674"></a><span id="l4.674">     var newNode = listitem1.cloneNode(true);</span>
<a href="#l4.675"></a><span id="l4.675">     if (nextDummy)</span>
<a href="#l4.676"></a><span id="l4.676">       listbox.replaceChild(newNode, nextDummy);</span>
<a href="#l4.677"></a><span id="l4.677">     else</span>
<a href="#l4.678"></a><span id="l4.678">       listbox.appendChild(newNode);</span>
<a href="#l4.679"></a><span id="l4.679"> </span>
<a href="#l4.680"></a><span id="l4.680">     top.MAX_RECIPIENTS++;</span>
<a href="#l4.681"></a><span id="l4.681"> </span>
<a href="#l4.682"></a><span id="l4.682">     var input = newNode.getElementsByTagName(awInputElementName());</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineminus">-    if ( input &amp;&amp; input.length == 1 )</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineminus">-    {</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+    if (input &amp;&amp; input.length == 1) {</span>
<a href="#l4.686"></a><span id="l4.686">       input[0].value = &quot;&quot;;</span>
<a href="#l4.687"></a><span id="l4.687"> </span>
<a href="#l4.688"></a><span id="l4.688">       // We always clone the first row.  The problem is that the first row</span>
<a href="#l4.689"></a><span id="l4.689">       // could be focused.  When we clone that row, we end up with a cloned</span>
<a href="#l4.690"></a><span id="l4.690">       // XUL textbox that has a focused attribute set.  Therefore we think</span>
<a href="#l4.691"></a><span id="l4.691">       // we're focused and don't properly refocus.  The best solution to this</span>
<a href="#l4.692"></a><span id="l4.692">       // would be to clone a template row that didn't really have any presentation,</span>
<a href="#l4.693"></a><span id="l4.693">       // rather than using the real visible first row of the listbox.</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineat">@@ -601,28 +558,26 @@ function awAppendNewRow(setFocus)</span>
<a href="#l4.695"></a><span id="l4.695">       // is never copied when the node is cloned.</span>
<a href="#l4.696"></a><span id="l4.696">       input[0].removeAttribute(&quot;focused&quot;);</span>
<a href="#l4.697"></a><span id="l4.697"> </span>
<a href="#l4.698"></a><span id="l4.698">       // Reset autocomplete attribute &quot;nomatch&quot; so we don't cause red addresses</span>
<a href="#l4.699"></a><span id="l4.699">       // on a cloned row.</span>
<a href="#l4.700"></a><span id="l4.700">       input[0].removeAttribute(&quot;nomatch&quot;);</span>
<a href="#l4.701"></a><span id="l4.701">     }</span>
<a href="#l4.702"></a><span id="l4.702">     var select = newNode.getElementsByTagName(awSelectElementName());</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-    if ( select &amp;&amp; select.length == 1 )</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-    {</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+    if (select &amp;&amp; select.length == 1) {</span>
<a href="#l4.706"></a><span id="l4.706">       // It only makes sense to clone some field types; others</span>
<a href="#l4.707"></a><span id="l4.707">       // should not be cloned, since it just makes the user have</span>
<a href="#l4.708"></a><span id="l4.708">       // to go to the trouble of selecting something else. In such</span>
<a href="#l4.709"></a><span id="l4.709">       // cases let's default to 'To' (a reasonable default since</span>
<a href="#l4.710"></a><span id="l4.710">       // we already default to 'To' on the first dummy field of</span>
<a href="#l4.711"></a><span id="l4.711">       // a new message).</span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-      switch (lastRecipientType)</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineminus">-      {</span>
<a href="#l4.714"></a><span id="l4.714" class="difflineminus">-        case  &quot;addr_reply&quot;:</span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-        case  &quot;addr_other&quot;:</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineplus">+      switch (lastRecipientType) {</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineplus">+        case &quot;addr_reply&quot;:</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineplus">+        case &quot;addr_other&quot;:</span>
<a href="#l4.719"></a><span id="l4.719">           select[0].selectedIndex = awGetSelectItemIndex(&quot;addr_to&quot;);</span>
<a href="#l4.720"></a><span id="l4.720">           break;</span>
<a href="#l4.721"></a><span id="l4.721">         case &quot;addr_followup&quot;:</span>
<a href="#l4.722"></a><span id="l4.722">           select[0].selectedIndex = awGetSelectItemIndex(&quot;addr_newsgroups&quot;);</span>
<a href="#l4.723"></a><span id="l4.723">           break;</span>
<a href="#l4.724"></a><span id="l4.724">         default:</span>
<a href="#l4.725"></a><span id="l4.725">         // e.g. &quot;addr_to&quot;,&quot;addr_cc&quot;,&quot;addr_bcc&quot;,&quot;addr_newsgroups&quot;:</span>
<a href="#l4.726"></a><span id="l4.726">           select[0].selectedIndex = awGetSelectItemIndex(lastRecipientType);</span>
<a href="#l4.727"></a><span id="l4.727" class="difflineat">@@ -630,332 +585,299 @@ function awAppendNewRow(setFocus)</span>
<a href="#l4.728"></a><span id="l4.728"> </span>
<a href="#l4.729"></a><span id="l4.729">       awSetInputAndPopupId(input[0], select[0], top.MAX_RECIPIENTS);</span>
<a href="#l4.730"></a><span id="l4.730"> </span>
<a href="#l4.731"></a><span id="l4.731">       if (input)</span>
<a href="#l4.732"></a><span id="l4.732">         _awSetAutoComplete(select[0], input[0]);</span>
<a href="#l4.733"></a><span id="l4.733">     }</span>
<a href="#l4.734"></a><span id="l4.734"> </span>
<a href="#l4.735"></a><span id="l4.735">     // focus on new input widget</span>
<a href="#l4.736"></a><span id="l4.736" class="difflineminus">-    if (setFocus &amp;&amp; input[0] )</span>
<a href="#l4.737"></a><span id="l4.737" class="difflineplus">+    if (setFocus &amp;&amp; input[0])</span>
<a href="#l4.738"></a><span id="l4.738">       awSetFocus(top.MAX_RECIPIENTS, input[0]);</span>
<a href="#l4.739"></a><span id="l4.739">   }</span>
<a href="#l4.740"></a><span id="l4.740"> }</span>
<a href="#l4.741"></a><span id="l4.741"> </span>
<a href="#l4.742"></a><span id="l4.742"> // functions for accessing the elements in the addressing widget</span>
<a href="#l4.743"></a><span id="l4.743"> </span>
<a href="#l4.744"></a><span id="l4.744"> /**</span>
<a href="#l4.745"></a><span id="l4.745">  * Returns the recipient type popup for a row.</span>
<a href="#l4.746"></a><span id="l4.746">  *</span>
<a href="#l4.747"></a><span id="l4.747">  * @param row  Index of the recipient row to return. Starts at 1.</span>
<a href="#l4.748"></a><span id="l4.748">  * @return     This returns the menulist (not its child menupopup), despite the function name.</span>
<a href="#l4.749"></a><span id="l4.749">  */</span>
<a href="#l4.750"></a><span id="l4.750" class="difflineminus">-function awGetPopupElement(row)</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-{</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+function awGetPopupElement(row) {</span>
<a href="#l4.753"></a><span id="l4.753"> </span>
<a href="#l4.754"></a><span id="l4.754">     return document.getElementById(&quot;addressCol1#&quot; + row);</span>
<a href="#l4.755"></a><span id="l4.755"> }</span>
<a href="#l4.756"></a><span id="l4.756"> </span>
<a href="#l4.757"></a><span id="l4.757"> /**</span>
<a href="#l4.758"></a><span id="l4.758">  * Returns the recipient inputbox for a row.</span>
<a href="#l4.759"></a><span id="l4.759">  *</span>
<a href="#l4.760"></a><span id="l4.760">  * @param row  Index of the recipient row to return. Starts at 1.</span>
<a href="#l4.761"></a><span id="l4.761">  * @return     This returns the textbox element.</span>
<a href="#l4.762"></a><span id="l4.762">  */</span>
<a href="#l4.763"></a><span id="l4.763" class="difflineminus">-function awGetInputElement(row)</span>
<a href="#l4.764"></a><span id="l4.764" class="difflineminus">-{</span>
<a href="#l4.765"></a><span id="l4.765" class="difflineplus">+function awGetInputElement(row) {</span>
<a href="#l4.766"></a><span id="l4.766">     return document.getElementById(&quot;addressCol2#&quot; + row);</span>
<a href="#l4.767"></a><span id="l4.767"> }</span>
<a href="#l4.768"></a><span id="l4.768"> </span>
<a href="#l4.769"></a><span id="l4.769" class="difflineminus">-function awGetElementByCol(row, col)</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineminus">-{</span>
<a href="#l4.771"></a><span id="l4.771" class="difflineplus">+function awGetElementByCol(row, col) {</span>
<a href="#l4.772"></a><span id="l4.772">   var colID = &quot;addressCol&quot; + col + &quot;#&quot; + row;</span>
<a href="#l4.773"></a><span id="l4.773">   return document.getElementById(colID);</span>
<a href="#l4.774"></a><span id="l4.774"> }</span>
<a href="#l4.775"></a><span id="l4.775"> </span>
<a href="#l4.776"></a><span id="l4.776" class="difflineminus">-function awGetListItem(row)</span>
<a href="#l4.777"></a><span id="l4.777" class="difflineminus">-{</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineplus">+function awGetListItem(row) {</span>
<a href="#l4.779"></a><span id="l4.779">   var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.780"></a><span id="l4.780"> </span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-  if ( listbox &amp;&amp; row &gt; 0)</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-  {</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineplus">+  if (listbox &amp;&amp; row &gt; 0) {</span>
<a href="#l4.784"></a><span id="l4.784">     var listitems = listbox.getElementsByTagName(&quot;richlistitem&quot;);</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineminus">-    if ( listitems &amp;&amp; listitems.length &gt;= row )</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineminus">-      return listitems[row-1];</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+    if (listitems &amp;&amp; listitems.length &gt;= row)</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+      return listitems[row - 1];</span>
<a href="#l4.789"></a><span id="l4.789">   }</span>
<a href="#l4.790"></a><span id="l4.790">   return 0;</span>
<a href="#l4.791"></a><span id="l4.791"> }</span>
<a href="#l4.792"></a><span id="l4.792"> </span>
<a href="#l4.793"></a><span id="l4.793" class="difflineminus">-function awGetRowByInputElement(inputElement)</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineminus">-{</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+function awGetRowByInputElement(inputElement) {</span>
<a href="#l4.796"></a><span id="l4.796">   var row = 0;</span>
<a href="#l4.797"></a><span id="l4.797">   if (inputElement) {</span>
<a href="#l4.798"></a><span id="l4.798">     var listitem = inputElement.parentNode.parentNode;</span>
<a href="#l4.799"></a><span id="l4.799">     while (listitem) {</span>
<a href="#l4.800"></a><span id="l4.800">       if (listitem.localName == &quot;richlistitem&quot;) {</span>
<a href="#l4.801"></a><span id="l4.801">         ++row;</span>
<a href="#l4.802"></a><span id="l4.802">       }</span>
<a href="#l4.803"></a><span id="l4.803">       listitem = listitem.previousSibling;</span>
<a href="#l4.804"></a><span id="l4.804">     }</span>
<a href="#l4.805"></a><span id="l4.805">   }</span>
<a href="#l4.806"></a><span id="l4.806">   return row;</span>
<a href="#l4.807"></a><span id="l4.807"> }</span>
<a href="#l4.808"></a><span id="l4.808"> </span>
<a href="#l4.809"></a><span id="l4.809" class="difflineminus">-</span>
<a href="#l4.810"></a><span id="l4.810"> // Copy Node - copy this node and insert ahead of the (before) node.  Append to end if before=0</span>
<a href="#l4.811"></a><span id="l4.811" class="difflineminus">-function awCopyNode(node, parentNode, beforeNode)</span>
<a href="#l4.812"></a><span id="l4.812" class="difflineminus">-{</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineplus">+function awCopyNode(node, parentNode, beforeNode) {</span>
<a href="#l4.814"></a><span id="l4.814">   var newNode = node.cloneNode(true);</span>
<a href="#l4.815"></a><span id="l4.815"> </span>
<a href="#l4.816"></a><span id="l4.816" class="difflineminus">-  if ( beforeNode )</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineplus">+  if (beforeNode)</span>
<a href="#l4.818"></a><span id="l4.818">     parentNode.insertBefore(newNode, beforeNode);</span>
<a href="#l4.819"></a><span id="l4.819">   else</span>
<a href="#l4.820"></a><span id="l4.820">     parentNode.appendChild(newNode);</span>
<a href="#l4.821"></a><span id="l4.821"> </span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-    return newNode;</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineplus">+  return newNode;</span>
<a href="#l4.824"></a><span id="l4.824"> }</span>
<a href="#l4.825"></a><span id="l4.825"> </span>
<a href="#l4.826"></a><span id="l4.826" class="difflineminus">-// remove row</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineminus">-</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineminus">-function awRemoveRow(row)</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineminus">-{</span>
<a href="#l4.830"></a><span id="l4.830" class="difflineplus">+function awRemoveRow(row) {</span>
<a href="#l4.831"></a><span id="l4.831">   awGetListItem(row).remove();</span>
<a href="#l4.832"></a><span id="l4.832">   awFitDummyRows();</span>
<a href="#l4.833"></a><span id="l4.833"> </span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-  top.MAX_RECIPIENTS --;</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineplus">+  top.MAX_RECIPIENTS--;</span>
<a href="#l4.836"></a><span id="l4.836"> }</span>
<a href="#l4.837"></a><span id="l4.837"> </span>
<a href="#l4.838"></a><span id="l4.838" class="difflineminus">-</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineminus">-function awSetFocus(row, inputElement)</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineminus">-{</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+function awSetFocus(row, inputElement) {</span>
<a href="#l4.842"></a><span id="l4.842">   top.awRow = row;</span>
<a href="#l4.843"></a><span id="l4.843">   top.awInputElement = inputElement;</span>
<a href="#l4.844"></a><span id="l4.844">   setTimeout(_awSetFocus, 0);</span>
<a href="#l4.845"></a><span id="l4.845"> }</span>
<a href="#l4.846"></a><span id="l4.846"> </span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-function _awSetFocus()</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-{</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineminus">-  var listbox = document.getElementById('addressingWidget');</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+function _awSetFocus() {</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineplus">+  var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.852"></a><span id="l4.852">   var theNewRow = awGetListItem(top.awRow);</span>
<a href="#l4.853"></a><span id="l4.853">   listbox.ensureElementIsVisible(theNewRow);</span>
<a href="#l4.854"></a><span id="l4.854">   top.awInputElement.focus();</span>
<a href="#l4.855"></a><span id="l4.855"> }</span>
<a href="#l4.856"></a><span id="l4.856"> </span>
<a href="#l4.857"></a><span id="l4.857" class="difflineminus">-function awTabFromRecipient(element, event)</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-{</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+function awTabFromRecipient(element, event) {</span>
<a href="#l4.860"></a><span id="l4.860">   // If we are the last element in the listbox, we don't want to create a new row.</span>
<a href="#l4.861"></a><span id="l4.861">   if (element == awGetInputElement(top.MAX_RECIPIENTS))</span>
<a href="#l4.862"></a><span id="l4.862">     top.doNotCreateANewRow = true;</span>
<a href="#l4.863"></a><span id="l4.863"> </span>
<a href="#l4.864"></a><span id="l4.864">   var row = awGetRowByInputElement(element);</span>
<a href="#l4.865"></a><span id="l4.865">   if (!event.shiftKey &amp;&amp; row &lt; top.MAX_RECIPIENTS) {</span>
<a href="#l4.866"></a><span id="l4.866">     var listBoxRow = row - 1; // listbox row indices are 0-based, ours are 1-based.</span>
<a href="#l4.867"></a><span id="l4.867">     var listBox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.868"></a><span id="l4.868">     listBox.listBoxObject.ensureIndexIsVisible(listBoxRow + 1);</span>
<a href="#l4.869"></a><span id="l4.869">   }</span>
<a href="#l4.870"></a><span id="l4.870"> </span>
<a href="#l4.871"></a><span id="l4.871">   // be sure to add the user add recipient to our ignore list</span>
<a href="#l4.872"></a><span id="l4.872">   // when the user tabs out of an autocomplete line...</span>
<a href="#l4.873"></a><span id="l4.873">   addRecipientsToIgnoreList(element.value);</span>
<a href="#l4.874"></a><span id="l4.874"> }</span>
<a href="#l4.875"></a><span id="l4.875"> </span>
<a href="#l4.876"></a><span id="l4.876" class="difflineminus">-function awTabFromMenulist(element, event)</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineminus">-{</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineplus">+function awTabFromMenulist(element, event) {</span>
<a href="#l4.879"></a><span id="l4.879">   var row = awGetRowByInputElement(element);</span>
<a href="#l4.880"></a><span id="l4.880">   if (event.shiftKey &amp;&amp; row &gt; 1) {</span>
<a href="#l4.881"></a><span id="l4.881">     var listBoxRow = row - 1; // listbox row indices are 0-based, ours are 1-based.</span>
<a href="#l4.882"></a><span id="l4.882">     var listBox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.883"></a><span id="l4.883">     listBox.listBoxObject.ensureIndexIsVisible(listBoxRow - 1);</span>
<a href="#l4.884"></a><span id="l4.884">   }</span>
<a href="#l4.885"></a><span id="l4.885"> }</span>
<a href="#l4.886"></a><span id="l4.886"> </span>
<a href="#l4.887"></a><span id="l4.887" class="difflineminus">-function awGetNumberOfRecipients()</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineminus">-{</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineminus">-    return top.MAX_RECIPIENTS;</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineplus">+function awGetNumberOfRecipients() {</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+  return top.MAX_RECIPIENTS;</span>
<a href="#l4.892"></a><span id="l4.892"> }</span>
<a href="#l4.893"></a><span id="l4.893"> </span>
<a href="#l4.894"></a><span id="l4.894" class="difflineminus">-function DragOverAddressingWidget(event)</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-{</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineplus">+function DragOverAddressingWidget(event) {</span>
<a href="#l4.897"></a><span id="l4.897">   var validFlavor = false;</span>
<a href="#l4.898"></a><span id="l4.898">   var dragSession = dragSession = gDragService.getCurrentSession();</span>
<a href="#l4.899"></a><span id="l4.899"> </span>
<a href="#l4.900"></a><span id="l4.900">   if (dragSession.isDataFlavorSupported(&quot;text/x-moz-address&quot;))</span>
<a href="#l4.901"></a><span id="l4.901">     validFlavor = true;</span>
<a href="#l4.902"></a><span id="l4.902"> </span>
<a href="#l4.903"></a><span id="l4.903">   if (validFlavor)</span>
<a href="#l4.904"></a><span id="l4.904">     dragSession.canDrop = true;</span>
<a href="#l4.905"></a><span id="l4.905"> }</span>
<a href="#l4.906"></a><span id="l4.906"> </span>
<a href="#l4.907"></a><span id="l4.907" class="difflineminus">-function DropOnAddressingWidget(event)</span>
<a href="#l4.908"></a><span id="l4.908" class="difflineminus">-{</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineplus">+function DropOnAddressingWidget(event) {</span>
<a href="#l4.910"></a><span id="l4.910">   var dragSession = gDragService.getCurrentSession();</span>
<a href="#l4.911"></a><span id="l4.911"> </span>
<a href="#l4.912"></a><span id="l4.912">   var trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(Ci.nsITransferable);</span>
<a href="#l4.913"></a><span id="l4.913">   trans.init(getLoadContext());</span>
<a href="#l4.914"></a><span id="l4.914">   trans.addDataFlavor(&quot;text/x-moz-address&quot;);</span>
<a href="#l4.915"></a><span id="l4.915"> </span>
<a href="#l4.916"></a><span id="l4.916" class="difflineminus">-  for ( var i = 0; i &lt; dragSession.numDropItems; ++i )</span>
<a href="#l4.917"></a><span id="l4.917" class="difflineminus">-  {</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineminus">-    dragSession.getData ( trans, i );</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineminus">-    var dataObj = new Object();</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineminus">-    var bestFlavor = new Object();</span>
<a href="#l4.921"></a><span id="l4.921" class="difflineminus">-    var len = new Object();</span>
<a href="#l4.922"></a><span id="l4.922" class="difflineminus">-    trans.getAnyTransferData ( bestFlavor, dataObj, len );</span>
<a href="#l4.923"></a><span id="l4.923" class="difflineminus">-    if ( dataObj )</span>
<a href="#l4.924"></a><span id="l4.924" class="difflineplus">+  for (var i = 0; i &lt; dragSession.numDropItems; ++i) {</span>
<a href="#l4.925"></a><span id="l4.925" class="difflineplus">+    dragSession.getData(trans, i);</span>
<a href="#l4.926"></a><span id="l4.926" class="difflineplus">+    var dataObj = {};</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineplus">+    var bestFlavor = {};</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+    var len = {};</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineplus">+    trans.getAnyTransferData(bestFlavor, dataObj, len);</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineplus">+    if (dataObj)</span>
<a href="#l4.931"></a><span id="l4.931">       dataObj = dataObj.value.QueryInterface(Ci.nsISupportsString);</span>
<a href="#l4.932"></a><span id="l4.932" class="difflineminus">-    if ( !dataObj )</span>
<a href="#l4.933"></a><span id="l4.933" class="difflineplus">+    if (!dataObj)</span>
<a href="#l4.934"></a><span id="l4.934">       continue;</span>
<a href="#l4.935"></a><span id="l4.935"> </span>
<a href="#l4.936"></a><span id="l4.936">     // pull the address out of the data object</span>
<a href="#l4.937"></a><span id="l4.937">     var address = dataObj.data.substring(0, len.value);</span>
<a href="#l4.938"></a><span id="l4.938">     if (!address)</span>
<a href="#l4.939"></a><span id="l4.939">       continue;</span>
<a href="#l4.940"></a><span id="l4.940"> </span>
<a href="#l4.941"></a><span id="l4.941">     DropRecipient(event.target, address);</span>
<a href="#l4.942"></a><span id="l4.942">   }</span>
<a href="#l4.943"></a><span id="l4.943"> }</span>
<a href="#l4.944"></a><span id="l4.944"> </span>
<a href="#l4.945"></a><span id="l4.945" class="difflineminus">-function DropRecipient(target, recipient)</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineminus">-{</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+function DropRecipient(target, recipient) {</span>
<a href="#l4.948"></a><span id="l4.948">   // break down and add each address</span>
<a href="#l4.949"></a><span id="l4.949">   return parseAndAddAddresses(recipient, awGetPopupElement(top.MAX_RECIPIENTS).value);</span>
<a href="#l4.950"></a><span id="l4.950"> }</span>
<a href="#l4.951"></a><span id="l4.951"> </span>
<a href="#l4.952"></a><span id="l4.952" class="difflineminus">-function _awSetAutoComplete(selectElem, inputElem)</span>
<a href="#l4.953"></a><span id="l4.953" class="difflineminus">-{</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineminus">-  let params = JSON.parse(inputElem.getAttribute('autocompletesearchparam'));</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineplus">+function _awSetAutoComplete(selectElem, inputElem) {</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+  let params = JSON.parse(inputElem.getAttribute(&quot;autocompletesearchparam&quot;));</span>
<a href="#l4.957"></a><span id="l4.957">   params.type = selectElem.value;</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineminus">-  inputElem.setAttribute('autocompletesearchparam', JSON.stringify(params));</span>
<a href="#l4.959"></a><span id="l4.959" class="difflineplus">+  inputElem.setAttribute(&quot;autocompletesearchparam&quot;, JSON.stringify(params));</span>
<a href="#l4.960"></a><span id="l4.960"> }</span>
<a href="#l4.961"></a><span id="l4.961"> </span>
<a href="#l4.962"></a><span id="l4.962" class="difflineminus">-function awSetAutoComplete(rowNumber)</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineminus">-{</span>
<a href="#l4.964"></a><span id="l4.964" class="difflineminus">-    var inputElem = awGetInputElement(rowNumber);</span>
<a href="#l4.965"></a><span id="l4.965" class="difflineminus">-    var selectElem = awGetPopupElement(rowNumber);</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">-    _awSetAutoComplete(selectElem, inputElem)</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+function awSetAutoComplete(rowNumber) {</span>
<a href="#l4.968"></a><span id="l4.968" class="difflineplus">+  var inputElem = awGetInputElement(rowNumber);</span>
<a href="#l4.969"></a><span id="l4.969" class="difflineplus">+  var selectElem = awGetPopupElement(rowNumber);</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineplus">+  _awSetAutoComplete(selectElem, inputElem);</span>
<a href="#l4.971"></a><span id="l4.971"> }</span>
<a href="#l4.972"></a><span id="l4.972"> </span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-function awRecipientTextCommand(enterEvent, element)</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineminus">-{</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineplus">+function awRecipientTextCommand(enterEvent, element) {</span>
<a href="#l4.976"></a><span id="l4.976">   // Only add new row when enter was hit (not for tab/autocomplete select).</span>
<a href="#l4.977"></a><span id="l4.977">   if (enterEvent)</span>
<a href="#l4.978"></a><span id="l4.978">     awReturnHit(element);</span>
<a href="#l4.979"></a><span id="l4.979"> }</span>
<a href="#l4.980"></a><span id="l4.980"> </span>
<a href="#l4.981"></a><span id="l4.981" class="difflineminus">-function awRecipientKeyPress(event, element)</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineminus">-{</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineminus">-  switch(event.keyCode) {</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+function awRecipientKeyPress(event, element) {</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+  switch (event.keyCode) {</span>
<a href="#l4.986"></a><span id="l4.986">   case KeyEvent.DOM_VK_RETURN:</span>
<a href="#l4.987"></a><span id="l4.987">   case KeyEvent.DOM_VK_TAB:</span>
<a href="#l4.988"></a><span id="l4.988">     // if the user text contains a comma or a line return, ignore</span>
<a href="#l4.989"></a><span id="l4.989" class="difflineminus">-    if (element.value.includes(','))</span>
<a href="#l4.990"></a><span id="l4.990" class="difflineminus">-    {</span>
<a href="#l4.991"></a><span id="l4.991" class="difflineplus">+    if (element.value.includes(&quot;,&quot;)) {</span>
<a href="#l4.992"></a><span id="l4.992">       var addresses = element.value;</span>
<a href="#l4.993"></a><span id="l4.993">       element.value = &quot;&quot;; // clear out the current line so we don't try to autocomplete it..</span>
<a href="#l4.994"></a><span id="l4.994">       parseAndAddAddresses(addresses, awGetPopupElement(awGetRowByInputElement(element)).value);</span>
<a href="#l4.995"></a><span id="l4.995" class="difflineplus">+    } else if (event.keyCode == KeyEvent.DOM_VK_TAB) {</span>
<a href="#l4.996"></a><span id="l4.996" class="difflineplus">+      awTabFromRecipient(element, event);</span>
<a href="#l4.997"></a><span id="l4.997">     }</span>
<a href="#l4.998"></a><span id="l4.998" class="difflineminus">-    else if (event.keyCode == KeyEvent.DOM_VK_TAB)</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineminus">-      awTabFromRecipient(element, event);</span>
<a href="#l4.1000"></a><span id="l4.1000"> </span>
<a href="#l4.1001"></a><span id="l4.1001">     break;</span>
<a href="#l4.1002"></a><span id="l4.1002">   }</span>
<a href="#l4.1003"></a><span id="l4.1003"> }</span>
<a href="#l4.1004"></a><span id="l4.1004"> </span>
<a href="#l4.1005"></a><span id="l4.1005" class="difflineminus">-function awRecipientKeyDown(event, element)</span>
<a href="#l4.1006"></a><span id="l4.1006" class="difflineminus">-{</span>
<a href="#l4.1007"></a><span id="l4.1007" class="difflineminus">-  switch(event.keyCode) {</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineplus">+function awRecipientKeyDown(event, element) {</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+  switch (event.keyCode) {</span>
<a href="#l4.1010"></a><span id="l4.1010">   case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l4.1011"></a><span id="l4.1011">   case KeyEvent.DOM_VK_BACK_SPACE:</span>
<a href="#l4.1012"></a><span id="l4.1012">     if (!element.value)</span>
<a href="#l4.1013"></a><span id="l4.1013">       awDeleteHit(element);</span>
<a href="#l4.1014"></a><span id="l4.1014"> </span>
<a href="#l4.1015"></a><span id="l4.1015">     // We need to stop the event else the listbox will receive it and the</span>
<a href="#l4.1016"></a><span id="l4.1016">     // function awKeyDown will be executed!</span>
<a href="#l4.1017"></a><span id="l4.1017">     event.stopPropagation();</span>
<a href="#l4.1018"></a><span id="l4.1018">     break;</span>
<a href="#l4.1019"></a><span id="l4.1019">   }</span>
<a href="#l4.1020"></a><span id="l4.1020"> }</span>
<a href="#l4.1021"></a><span id="l4.1021"> </span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineminus">-function awKeyDown(event, listboxElement)</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineminus">-{</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineminus">-  switch(event.keyCode) {</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+function awKeyDown(event, listboxElement) {</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+  switch (event.keyCode) {</span>
<a href="#l4.1027"></a><span id="l4.1027">   case KeyEvent.DOM_VK_DELETE:</span>
<a href="#l4.1028"></a><span id="l4.1028">   case KeyEvent.DOM_VK_BACK_SPACE:</span>
<a href="#l4.1029"></a><span id="l4.1029">     /* Warning, the listboxElement.selectedItems will change every time we delete a row */</span>
<a href="#l4.1030"></a><span id="l4.1030">     var length = listboxElement.selectedCount;</span>
<a href="#l4.1031"></a><span id="l4.1031">     for (var i = 1; i &lt;= length; i++) {</span>
<a href="#l4.1032"></a><span id="l4.1032">       var inputs = listboxElement.selectedItem.getElementsByTagName(awInputElementName());</span>
<a href="#l4.1033"></a><span id="l4.1033">       if (inputs &amp;&amp; inputs.length == 1)</span>
<a href="#l4.1034"></a><span id="l4.1034">         awDeleteHit(inputs[0]);</span>
<a href="#l4.1035"></a><span id="l4.1035">     }</span>
<a href="#l4.1036"></a><span id="l4.1036">     break;</span>
<a href="#l4.1037"></a><span id="l4.1037">   }</span>
<a href="#l4.1038"></a><span id="l4.1038"> }</span>
<a href="#l4.1039"></a><span id="l4.1039"> </span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineminus">-function awMenulistKeyPress(event, element)</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineminus">-{</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineminus">-  switch(event.keyCode) {</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+function awMenulistKeyPress(event, element) {</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+  switch (event.keyCode) {</span>
<a href="#l4.1045"></a><span id="l4.1045">   case KeyEvent.DOM_VK_TAB:</span>
<a href="#l4.1046"></a><span id="l4.1046">     awTabFromMenulist(element, event);</span>
<a href="#l4.1047"></a><span id="l4.1047">     break;</span>
<a href="#l4.1048"></a><span id="l4.1048">   }</span>
<a href="#l4.1049"></a><span id="l4.1049"> }</span>
<a href="#l4.1050"></a><span id="l4.1050"> </span>
<a href="#l4.1051"></a><span id="l4.1051"> /* ::::::::::: addressing widget dummy rows ::::::::::::::::: */</span>
<a href="#l4.1052"></a><span id="l4.1052"> </span>
<a href="#l4.1053"></a><span id="l4.1053"> var gAWContentHeight = 0;</span>
<a href="#l4.1054"></a><span id="l4.1054"> var gAWRowHeight = 0;</span>
<a href="#l4.1055"></a><span id="l4.1055"> </span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineminus">-function awFitDummyRows()</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineminus">-{</span>
<a href="#l4.1058"></a><span id="l4.1058" class="difflineplus">+function awFitDummyRows() {</span>
<a href="#l4.1059"></a><span id="l4.1059">   awCalcContentHeight();</span>
<a href="#l4.1060"></a><span id="l4.1060">   awCreateOrRemoveDummyRows();</span>
<a href="#l4.1061"></a><span id="l4.1061"> }</span>
<a href="#l4.1062"></a><span id="l4.1062"> </span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineminus">-function awCreateOrRemoveDummyRows()</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineminus">-{</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineplus">+function awCreateOrRemoveDummyRows() {</span>
<a href="#l4.1066"></a><span id="l4.1066">   let listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.1067"></a><span id="l4.1067">   let listboxHeight = listbox.boxObject.height;</span>
<a href="#l4.1068"></a><span id="l4.1068"> </span>
<a href="#l4.1069"></a><span id="l4.1069">   // remove rows to remove scrollbar</span>
<a href="#l4.1070"></a><span id="l4.1070" class="difflineminus">-  let kids = listbox.querySelectorAll('[_isDummyRow]');</span>
<a href="#l4.1071"></a><span id="l4.1071" class="difflineplus">+  let kids = listbox.querySelectorAll(&quot;[_isDummyRow]&quot;);</span>
<a href="#l4.1072"></a><span id="l4.1072">   for (let i = kids.length - 1; gAWContentHeight &gt; listboxHeight &amp;&amp; i &gt;= 0; --i) {</span>
<a href="#l4.1073"></a><span id="l4.1073">     gAWContentHeight -= gAWRowHeight;</span>
<a href="#l4.1074"></a><span id="l4.1074">     kids[i].remove();</span>
<a href="#l4.1075"></a><span id="l4.1075">   }</span>
<a href="#l4.1076"></a><span id="l4.1076"> </span>
<a href="#l4.1077"></a><span id="l4.1077">   // add rows to fill space</span>
<a href="#l4.1078"></a><span id="l4.1078">   if (gAWRowHeight) {</span>
<a href="#l4.1079"></a><span id="l4.1079">     while (gAWContentHeight + gAWRowHeight &lt; listboxHeight) {</span>
<a href="#l4.1080"></a><span id="l4.1080">       awCreateDummyItem(listbox);</span>
<a href="#l4.1081"></a><span id="l4.1081">       gAWContentHeight += gAWRowHeight;</span>
<a href="#l4.1082"></a><span id="l4.1082">     }</span>
<a href="#l4.1083"></a><span id="l4.1083">   }</span>
<a href="#l4.1084"></a><span id="l4.1084"> }</span>
<a href="#l4.1085"></a><span id="l4.1085"> </span>
<a href="#l4.1086"></a><span id="l4.1086" class="difflineminus">-function awCalcContentHeight()</span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineminus">-{</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineplus">+function awCalcContentHeight() {</span>
<a href="#l4.1089"></a><span id="l4.1089">   var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.1090"></a><span id="l4.1090">   var items = listbox.getElementsByTagName(&quot;richlistitem&quot;);</span>
<a href="#l4.1091"></a><span id="l4.1091"> </span>
<a href="#l4.1092"></a><span id="l4.1092">   gAWContentHeight = 0;</span>
<a href="#l4.1093"></a><span id="l4.1093">   if (items.length &gt; 0) {</span>
<a href="#l4.1094"></a><span id="l4.1094">     // all rows are forced to a uniform height in xul listboxes, so</span>
<a href="#l4.1095"></a><span id="l4.1095">     // find the first listitem with a boxObject and use it as precedent</span>
<a href="#l4.1096"></a><span id="l4.1096">     var i = 0;</span>
<a href="#l4.1097"></a><span id="l4.1097">     do {</span>
<a href="#l4.1098"></a><span id="l4.1098">       gAWRowHeight = items[i].boxObject.height;</span>
<a href="#l4.1099"></a><span id="l4.1099">       ++i;</span>
<a href="#l4.1100"></a><span id="l4.1100">     } while (i &lt; items.length &amp;&amp; !gAWRowHeight);</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineminus">-    gAWContentHeight = gAWRowHeight*items.length;</span>
<a href="#l4.1102"></a><span id="l4.1102" class="difflineplus">+    gAWContentHeight = gAWRowHeight * items.length;</span>
<a href="#l4.1103"></a><span id="l4.1103">   }</span>
<a href="#l4.1104"></a><span id="l4.1104"> }</span>
<a href="#l4.1105"></a><span id="l4.1105"> </span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineminus">-function awCreateDummyItem(aParent)</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineminus">-{</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+function awCreateDummyItem(aParent) {</span>
<a href="#l4.1109"></a><span id="l4.1109">   var listbox = document.getElementById(&quot;addressingWidget&quot;);</span>
<a href="#l4.1110"></a><span id="l4.1110">   var item = listbox.getElementsByTagName(&quot;richlistitem&quot;)[0];</span>
<a href="#l4.1111"></a><span id="l4.1111"> </span>
<a href="#l4.1112"></a><span id="l4.1112">   var titem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l4.1113"></a><span id="l4.1113">   titem.setAttribute(&quot;_isDummyRow&quot;, &quot;true&quot;);</span>
<a href="#l4.1114"></a><span id="l4.1114">   titem.setAttribute(&quot;class&quot;, &quot;dummy-row&quot;);</span>
<a href="#l4.1115"></a><span id="l4.1115">   titem.style.height = item.boxObject.height + &quot;px&quot;;</span>
<a href="#l4.1116"></a><span id="l4.1116"> </span>
<a href="#l4.1117"></a><span id="l4.1117" class="difflineat">@@ -971,86 +893,77 @@ function awCreateDummyItem(aParent)</span>
<a href="#l4.1118"></a><span id="l4.1118"> </span>
<a href="#l4.1119"></a><span id="l4.1119">   if (aParent) {</span>
<a href="#l4.1120"></a><span id="l4.1120">     aParent.appendChild(titem);</span>
<a href="#l4.1121"></a><span id="l4.1121">   }</span>
<a href="#l4.1122"></a><span id="l4.1122"> </span>
<a href="#l4.1123"></a><span id="l4.1123">   return titem;</span>
<a href="#l4.1124"></a><span id="l4.1124"> }</span>
<a href="#l4.1125"></a><span id="l4.1125"> </span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineminus">-function awCreateDummyCell(aParent)</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineminus">-{</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineplus">+function awCreateDummyCell(aParent) {</span>
<a href="#l4.1129"></a><span id="l4.1129">   var cell = document.createElement(&quot;hbox&quot;);</span>
<a href="#l4.1130"></a><span id="l4.1130">   cell.setAttribute(&quot;class&quot;, &quot;addressingWidgetCell dummy-row-cell&quot;);</span>
<a href="#l4.1131"></a><span id="l4.1131">   if (aParent)</span>
<a href="#l4.1132"></a><span id="l4.1132">     aParent.appendChild(cell);</span>
<a href="#l4.1133"></a><span id="l4.1133"> </span>
<a href="#l4.1134"></a><span id="l4.1134">   return cell;</span>
<a href="#l4.1135"></a><span id="l4.1135"> }</span>
<a href="#l4.1136"></a><span id="l4.1136"> </span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineminus">-function awGetNextDummyRow()</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineminus">-{</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineplus">+function awGetNextDummyRow() {</span>
<a href="#l4.1140"></a><span id="l4.1140">   // gets the next row from the top down</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineminus">-  return document.querySelector('#addressingWidget &gt; [_isDummyRow]');</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineplus">+  return document.querySelector(&quot;#addressingWidget &gt; [_isDummyRow]&quot;);</span>
<a href="#l4.1143"></a><span id="l4.1143"> }</span>
<a href="#l4.1144"></a><span id="l4.1144"> </span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineminus">-function awSizerListen()</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineminus">-{</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineplus">+function awSizerListen() {</span>
<a href="#l4.1148"></a><span id="l4.1148">   // when splitter is clicked, fill in necessary dummy rows each time the mouse is moved</span>
<a href="#l4.1149"></a><span id="l4.1149">   awCalcContentHeight(); // precalculate</span>
<a href="#l4.1150"></a><span id="l4.1150">   document.addEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l4.1151"></a><span id="l4.1151">   document.addEventListener(&quot;mouseup&quot;, awSizerMouseUp, {capture: false, once: true});</span>
<a href="#l4.1152"></a><span id="l4.1152"> }</span>
<a href="#l4.1153"></a><span id="l4.1153"> </span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineminus">-function awSizerMouseMove()</span>
<a href="#l4.1155"></a><span id="l4.1155" class="difflineminus">-{</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineplus">+function awSizerMouseMove() {</span>
<a href="#l4.1157"></a><span id="l4.1157">   awCreateOrRemoveDummyRows(2);</span>
<a href="#l4.1158"></a><span id="l4.1158"> }</span>
<a href="#l4.1159"></a><span id="l4.1159"> </span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineminus">-function awSizerMouseUp()</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineminus">-{</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineplus">+function awSizerMouseUp() {</span>
<a href="#l4.1163"></a><span id="l4.1163">   document.removeEventListener(&quot;mousemove&quot;, awSizerMouseMove, true);</span>
<a href="#l4.1164"></a><span id="l4.1164"> }</span>
<a href="#l4.1165"></a><span id="l4.1165"> </span>
<a href="#l4.1166"></a><span id="l4.1166" class="difflineminus">-function awDocumentKeyPress(event)</span>
<a href="#l4.1167"></a><span id="l4.1167" class="difflineminus">-{</span>
<a href="#l4.1168"></a><span id="l4.1168" class="difflineplus">+function awDocumentKeyPress(event) {</span>
<a href="#l4.1169"></a><span id="l4.1169">   try {</span>
<a href="#l4.1170"></a><span id="l4.1170">     var id = event.target.id;</span>
<a href="#l4.1171"></a><span id="l4.1171" class="difflineminus">-    if (id.startsWith('addressCol1'))</span>
<a href="#l4.1172"></a><span id="l4.1172" class="difflineplus">+    if (id.startsWith(&quot;addressCol1&quot;))</span>
<a href="#l4.1173"></a><span id="l4.1173">       awMenulistKeyPress(event, event.target);</span>
<a href="#l4.1174"></a><span id="l4.1174">   } catch (e) { }</span>
<a href="#l4.1175"></a><span id="l4.1175"> }</span>
<a href="#l4.1176"></a><span id="l4.1176"> </span>
<a href="#l4.1177"></a><span id="l4.1177"> // Given an arbitrary block of text like a comma delimited list of names or a names separated by spaces,</span>
<a href="#l4.1178"></a><span id="l4.1178"> // we will try to autocomplete each of the names and then take the FIRST match for each name, adding it the</span>
<a href="#l4.1179"></a><span id="l4.1179"> // addressing widget on the compose window.</span>
<a href="#l4.1180"></a><span id="l4.1180"> </span>
<a href="#l4.1181"></a><span id="l4.1181"> var gAutomatedAutoCompleteListener = null;</span>
<a href="#l4.1182"></a><span id="l4.1182"> </span>
<a href="#l4.1183"></a><span id="l4.1183" class="difflineminus">-function parseAndAddAddresses(addressText, recipientType)</span>
<a href="#l4.1184"></a><span id="l4.1184" class="difflineminus">-{</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineplus">+function parseAndAddAddresses(addressText, recipientType) {</span>
<a href="#l4.1186"></a><span id="l4.1186">   // strip any leading &gt;&gt; characters inserted by the autocomplete widget</span>
<a href="#l4.1187"></a><span id="l4.1187">   var strippedAddresses = addressText.replace(/.* &gt;&gt; /, &quot;&quot;);</span>
<a href="#l4.1188"></a><span id="l4.1188"> </span>
<a href="#l4.1189"></a><span id="l4.1189">   let addresses = MailServices.headerParser</span>
<a href="#l4.1190"></a><span id="l4.1190">                               .makeFromDisplayAddress(strippedAddresses);</span>
<a href="#l4.1191"></a><span id="l4.1191"> </span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineminus">-  if (addresses.length &gt; 0)</span>
<a href="#l4.1193"></a><span id="l4.1193" class="difflineminus">-  {</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineplus">+  if (addresses.length &gt; 0) {</span>
<a href="#l4.1195"></a><span id="l4.1195">     // we need to set up our own autocomplete session and search for results</span>
<a href="#l4.1196"></a><span id="l4.1196">     if (!gAutomatedAutoCompleteListener)</span>
<a href="#l4.1197"></a><span id="l4.1197">       gAutomatedAutoCompleteListener = new AutomatedAutoCompleteHandler();</span>
<a href="#l4.1198"></a><span id="l4.1198"> </span>
<a href="#l4.1199"></a><span id="l4.1199">     gAutomatedAutoCompleteListener.init(addresses.map(addr =&gt; addr.toString()),</span>
<a href="#l4.1200"></a><span id="l4.1200">                                         recipientType);</span>
<a href="#l4.1201"></a><span id="l4.1201">   }</span>
<a href="#l4.1202"></a><span id="l4.1202"> }</span>
<a href="#l4.1203"></a><span id="l4.1203"> </span>
<a href="#l4.1204"></a><span id="l4.1204" class="difflineminus">-function AutomatedAutoCompleteHandler()</span>
<a href="#l4.1205"></a><span id="l4.1205" class="difflineminus">-{</span>
<a href="#l4.1206"></a><span id="l4.1206" class="difflineplus">+function AutomatedAutoCompleteHandler() {</span>
<a href="#l4.1207"></a><span id="l4.1207"> }</span>
<a href="#l4.1208"></a><span id="l4.1208"> </span>
<a href="#l4.1209"></a><span id="l4.1209"> // state driven self contained object which will autocomplete a block of addresses without any UI.</span>
<a href="#l4.1210"></a><span id="l4.1210"> // force picks the first match and adds it to the addressing widget, then goes on to the next</span>
<a href="#l4.1211"></a><span id="l4.1211"> // name to complete.</span>
<a href="#l4.1212"></a><span id="l4.1212"> </span>
<a href="#l4.1213"></a><span id="l4.1213"> AutomatedAutoCompleteHandler.prototype =</span>
<a href="#l4.1214"></a><span id="l4.1214"> {</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineat">@@ -1061,39 +974,35 @@ AutomatedAutoCompleteHandler.prototype =</span>
<a href="#l4.1216"></a><span id="l4.1216">   indexIntoNames: 0,</span>
<a href="#l4.1217"></a><span id="l4.1217">   finalAddresses: null,</span>
<a href="#l4.1218"></a><span id="l4.1218"> </span>
<a href="#l4.1219"></a><span id="l4.1219">   numSessionsToSearch: 0,</span>
<a href="#l4.1220"></a><span id="l4.1220">   numSessionsSearched: 0,</span>
<a href="#l4.1221"></a><span id="l4.1221">   recipientType: null,</span>
<a href="#l4.1222"></a><span id="l4.1222">   searchResults: null,</span>
<a href="#l4.1223"></a><span id="l4.1223"> </span>
<a href="#l4.1224"></a><span id="l4.1224" class="difflineminus">-  init:function(namesToComplete, recipientType)</span>
<a href="#l4.1225"></a><span id="l4.1225" class="difflineminus">-  {</span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineplus">+  init(namesToComplete, recipientType) {</span>
<a href="#l4.1227"></a><span id="l4.1227">     this.indexIntoNames = 0;</span>
<a href="#l4.1228"></a><span id="l4.1228">     this.numNamesToComplete = namesToComplete.length;</span>
<a href="#l4.1229"></a><span id="l4.1229">     this.namesToComplete = namesToComplete;</span>
<a href="#l4.1230"></a><span id="l4.1230">     this.finalAddresses = [];</span>
<a href="#l4.1231"></a><span id="l4.1231"> </span>
<a href="#l4.1232"></a><span id="l4.1232">     this.recipientType = recipientType ? recipientType : &quot;addr_to&quot;;</span>
<a href="#l4.1233"></a><span id="l4.1233"> </span>
<a href="#l4.1234"></a><span id="l4.1234">     // set up the auto complete sessions to use</span>
<a href="#l4.1235"></a><span id="l4.1235">     this.autoCompleteNextAddress();</span>
<a href="#l4.1236"></a><span id="l4.1236">   },</span>
<a href="#l4.1237"></a><span id="l4.1237"> </span>
<a href="#l4.1238"></a><span id="l4.1238" class="difflineminus">-  autoCompleteNextAddress:function()</span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineminus">-  {</span>
<a href="#l4.1240"></a><span id="l4.1240" class="difflineplus">+  autoCompleteNextAddress() {</span>
<a href="#l4.1241"></a><span id="l4.1241">     this.numSessionsToSearch = 0;</span>
<a href="#l4.1242"></a><span id="l4.1242">     this.numSessionsSearched = 0;</span>
<a href="#l4.1243"></a><span id="l4.1243">     this.searchResults = [];</span>
<a href="#l4.1244"></a><span id="l4.1244"> </span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineminus">-    if (this.indexIntoNames &lt; this.numNamesToComplete)</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineminus">-    {</span>
<a href="#l4.1247"></a><span id="l4.1247" class="difflineminus">-      if (this.namesToComplete[this.indexIntoNames])</span>
<a href="#l4.1248"></a><span id="l4.1248" class="difflineminus">-      {</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineplus">+    if (this.indexIntoNames &lt; this.numNamesToComplete) {</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineplus">+      if (this.namesToComplete[this.indexIntoNames]) {</span>
<a href="#l4.1251"></a><span id="l4.1251">       /* XXX This is used to work, until switching to the new toolkit broke it</span>
<a href="#l4.1252"></a><span id="l4.1252">          We should fix it see bug 456550.</span>
<a href="#l4.1253"></a><span id="l4.1253">       if (!this.namesToComplete[this.indexIntoNames].includes('@')) // don't autocomplete if address has an @ sign in it</span>
<a href="#l4.1254"></a><span id="l4.1254">       {</span>
<a href="#l4.1255"></a><span id="l4.1255">         // make sure total session count is updated before we kick off ANY actual searches</span>
<a href="#l4.1256"></a><span id="l4.1256">         if (gAutocompleteSession)</span>
<a href="#l4.1257"></a><span id="l4.1257">           this.numSessionsToSearch++;</span>
<a href="#l4.1258"></a><span id="l4.1258"> </span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineat">@@ -1118,70 +1027,59 @@ AutomatedAutoCompleteHandler.prototype =</span>
<a href="#l4.1260"></a><span id="l4.1260">         if (gLDAPSession &amp;&amp; gCurrentAutocompleteDirectory)</span>
<a href="#l4.1261"></a><span id="l4.1261">           gLDAPSession.onStartLookup(this.namesToComplete[this.indexIntoNames], null, this);</span>
<a href="#l4.1262"></a><span id="l4.1262">       }</span>
<a href="#l4.1263"></a><span id="l4.1263">       */</span>
<a href="#l4.1264"></a><span id="l4.1264"> </span>
<a href="#l4.1265"></a><span id="l4.1265">         if (!this.numSessionsToSearch)</span>
<a href="#l4.1266"></a><span id="l4.1266">           this.processAllResults(); // ldap and ab are turned off, so leave text alone.</span>
<a href="#l4.1267"></a><span id="l4.1267">       }</span>
<a href="#l4.1268"></a><span id="l4.1268" class="difflineminus">-    }</span>
<a href="#l4.1269"></a><span id="l4.1269" class="difflineminus">-    else</span>
<a href="#l4.1270"></a><span id="l4.1270" class="difflineminus">-    {</span>
<a href="#l4.1271"></a><span id="l4.1271" class="difflineplus">+    } else {</span>
<a href="#l4.1272"></a><span id="l4.1272">       this.finish();</span>
<a href="#l4.1273"></a><span id="l4.1273">     }</span>
<a href="#l4.1274"></a><span id="l4.1274">   },</span>
<a href="#l4.1275"></a><span id="l4.1275"> </span>
<a href="#l4.1276"></a><span id="l4.1276" class="difflineminus">-  onStatus:function(aStatus)</span>
<a href="#l4.1277"></a><span id="l4.1277" class="difflineminus">-  {</span>
<a href="#l4.1278"></a><span id="l4.1278" class="difflineminus">-    return;</span>
<a href="#l4.1279"></a><span id="l4.1279" class="difflineplus">+  onStatus(aStatus) {</span>
<a href="#l4.1280"></a><span id="l4.1280">   },</span>
<a href="#l4.1281"></a><span id="l4.1281"> </span>
<a href="#l4.1282"></a><span id="l4.1282" class="difflineminus">-  onAutoComplete: function(aResults, aStatus)</span>
<a href="#l4.1283"></a><span id="l4.1283" class="difflineminus">-  {</span>
<a href="#l4.1284"></a><span id="l4.1284" class="difflineplus">+  onAutoComplete(aResults, aStatus) {</span>
<a href="#l4.1285"></a><span id="l4.1285">     // store the results until all sessions are done and have reported in</span>
<a href="#l4.1286"></a><span id="l4.1286">     if (aResults)</span>
<a href="#l4.1287"></a><span id="l4.1287">       this.searchResults[this.numSessionsSearched] = aResults;</span>
<a href="#l4.1288"></a><span id="l4.1288"> </span>
<a href="#l4.1289"></a><span id="l4.1289">     this.numSessionsSearched++; // bump our counter</span>
<a href="#l4.1290"></a><span id="l4.1290"> </span>
<a href="#l4.1291"></a><span id="l4.1291">     if (this.numSessionsToSearch &lt;= this.numSessionsSearched)</span>
<a href="#l4.1292"></a><span id="l4.1292">       setTimeout(gAutomatedAutoCompleteListener.processAllResults, 0); // we are all done</span>
<a href="#l4.1293"></a><span id="l4.1293">   },</span>
<a href="#l4.1294"></a><span id="l4.1294"> </span>
<a href="#l4.1295"></a><span id="l4.1295" class="difflineminus">-  processAllResults: function()</span>
<a href="#l4.1296"></a><span id="l4.1296" class="difflineminus">-  {</span>
<a href="#l4.1297"></a><span id="l4.1297" class="difflineplus">+  processAllResults() {</span>
<a href="#l4.1298"></a><span id="l4.1298">     // Take the first result and add it to the compose window</span>
<a href="#l4.1299"></a><span id="l4.1299">     var addressToAdd;</span>
<a href="#l4.1300"></a><span id="l4.1300"> </span>
<a href="#l4.1301"></a><span id="l4.1301">     // loop through the results looking for the non default case (default case is the address book with only one match, the default domain)</span>
<a href="#l4.1302"></a><span id="l4.1302">     var sessionIndex;</span>
<a href="#l4.1303"></a><span id="l4.1303"> </span>
<a href="#l4.1304"></a><span id="l4.1304">     var searchResultsForSession;</span>
<a href="#l4.1305"></a><span id="l4.1305"> </span>
<a href="#l4.1306"></a><span id="l4.1306" class="difflineminus">-    for (sessionIndex in this.searchResults)</span>
<a href="#l4.1307"></a><span id="l4.1307" class="difflineminus">-    {</span>
<a href="#l4.1308"></a><span id="l4.1308" class="difflineplus">+    for (sessionIndex in this.searchResults) {</span>
<a href="#l4.1309"></a><span id="l4.1309">       searchResultsForSession = this.searchResults[sessionIndex];</span>
<a href="#l4.1310"></a><span id="l4.1310" class="difflineminus">-      if (searchResultsForSession &amp;&amp; searchResultsForSession.defaultItemIndex &gt; -1)</span>
<a href="#l4.1311"></a><span id="l4.1311" class="difflineminus">-      {</span>
<a href="#l4.1312"></a><span id="l4.1312" class="difflineplus">+      if (searchResultsForSession &amp;&amp; searchResultsForSession.defaultItemIndex &gt; -1) {</span>
<a href="#l4.1313"></a><span id="l4.1313">         addressToAdd = searchResultsForSession.items</span>
<a href="#l4.1314"></a><span id="l4.1314">           .queryElementAt(searchResultsForSession.defaultItemIndex,</span>
<a href="#l4.1315"></a><span id="l4.1315">                           Ci.nsIAutoCompleteItem).value;</span>
<a href="#l4.1316"></a><span id="l4.1316">         break;</span>
<a href="#l4.1317"></a><span id="l4.1317">       }</span>
<a href="#l4.1318"></a><span id="l4.1318">     }</span>
<a href="#l4.1319"></a><span id="l4.1319"> </span>
<a href="#l4.1320"></a><span id="l4.1320">     // still no match? loop through looking for the -1 default index</span>
<a href="#l4.1321"></a><span id="l4.1321" class="difflineminus">-    if (!addressToAdd)</span>
<a href="#l4.1322"></a><span id="l4.1322" class="difflineminus">-    {</span>
<a href="#l4.1323"></a><span id="l4.1323" class="difflineminus">-      for (sessionIndex in this.searchResults)</span>
<a href="#l4.1324"></a><span id="l4.1324" class="difflineminus">-      {</span>
<a href="#l4.1325"></a><span id="l4.1325" class="difflineplus">+    if (!addressToAdd) {</span>
<a href="#l4.1326"></a><span id="l4.1326" class="difflineplus">+      for (sessionIndex in this.searchResults) {</span>
<a href="#l4.1327"></a><span id="l4.1327">         searchResultsForSession = this.searchResults[sessionIndex];</span>
<a href="#l4.1328"></a><span id="l4.1328" class="difflineminus">-        if (searchResultsForSession &amp;&amp; searchResultsForSession.defaultItemIndex == -1)</span>
<a href="#l4.1329"></a><span id="l4.1329" class="difflineminus">-        {</span>
<a href="#l4.1330"></a><span id="l4.1330" class="difflineplus">+        if (searchResultsForSession &amp;&amp; searchResultsForSession.defaultItemIndex == -1) {</span>
<a href="#l4.1331"></a><span id="l4.1331">           addressToAdd = searchResultsForSession.items</span>
<a href="#l4.1332"></a><span id="l4.1332">             .queryElementAt(0, Ci.nsIAutoCompleteItem).value;</span>
<a href="#l4.1333"></a><span id="l4.1333">           break;</span>
<a href="#l4.1334"></a><span id="l4.1334">         }</span>
<a href="#l4.1335"></a><span id="l4.1335">       }</span>
<a href="#l4.1336"></a><span id="l4.1336">     }</span>
<a href="#l4.1337"></a><span id="l4.1337"> </span>
<a href="#l4.1338"></a><span id="l4.1338">     // no matches anywhere...just use what we were given</span>
<a href="#l4.1339"></a><span id="l4.1339" class="difflineat">@@ -1189,22 +1087,21 @@ AutomatedAutoCompleteHandler.prototype =</span>
<a href="#l4.1340"></a><span id="l4.1340">       addressToAdd = this.namesToComplete[this.indexIntoNames];</span>
<a href="#l4.1341"></a><span id="l4.1341"> </span>
<a href="#l4.1342"></a><span id="l4.1342">     this.finalAddresses.push(addressToAdd);</span>
<a href="#l4.1343"></a><span id="l4.1343"> </span>
<a href="#l4.1344"></a><span id="l4.1344">     this.indexIntoNames++;</span>
<a href="#l4.1345"></a><span id="l4.1345">     this.autoCompleteNextAddress();</span>
<a href="#l4.1346"></a><span id="l4.1346">   },</span>
<a href="#l4.1347"></a><span id="l4.1347"> </span>
<a href="#l4.1348"></a><span id="l4.1348" class="difflineminus">-  finish: function()</span>
<a href="#l4.1349"></a><span id="l4.1349" class="difflineminus">-  {</span>
<a href="#l4.1350"></a><span id="l4.1350" class="difflineplus">+  finish() {</span>
<a href="#l4.1351"></a><span id="l4.1351">     // This will now append all the recipients, set the focus on a new</span>
<a href="#l4.1352"></a><span id="l4.1352">     // available row, and make sure it is visible.</span>
<a href="#l4.1353"></a><span id="l4.1353">     awAddRecipientsArray(this.recipientType, this.finalAddresses);</span>
<a href="#l4.1354"></a><span id="l4.1354">   },</span>
<a href="#l4.1355"></a><span id="l4.1355"> </span>
<a href="#l4.1356"></a><span id="l4.1356">   QueryInterface: ChromeUtils.generateQI([&quot;nsIAutoCompleteListener&quot;]),</span>
<a href="#l4.1357"></a><span id="l4.1357" class="difflineminus">-}</span>
<a href="#l4.1358"></a><span id="l4.1358" class="difflineplus">+};</span>
<a href="#l4.1359"></a><span id="l4.1359"> </span>
<a href="#l4.1360"></a><span id="l4.1360"> // Returns the load context for the current window</span>
<a href="#l4.1361"></a><span id="l4.1361"> function getLoadContext() {</span>
<a href="#l4.1362"></a><span id="l4.1362">   return window.docShell.QueryInterface(Ci.nsILoadContext);</span>
<a href="#l4.1363"></a><span id="l4.1363"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,11 +1,13 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.5"></a><span id="l5.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineminus">-  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+/* import-globals-from MsgComposeCommands.js */</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12"> ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> var kUploadNotificationValue = &quot;bigAttachmentUploading&quot;;</span>
<a href="#l5.15"></a><span id="l5.15"> var kPrivacyWarningNotificationValue = &quot;bigAttachmentPrivacyWarning&quot;;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> var gBigFileObserver = {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineat">@@ -15,221 +17,216 @@ var gBigFileObserver = {</span>
<a href="#l5.19"></a><span id="l5.19"> </span>
<a href="#l5.20"></a><span id="l5.20">   get hidden() {</span>
<a href="#l5.21"></a><span id="l5.21">     return this.sessionHidden ||</span>
<a href="#l5.22"></a><span id="l5.22">            !Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l5.23"></a><span id="l5.23">            !Services.prefs.getBoolPref(&quot;mail.compose.big_attachments.notify&quot;) ||</span>
<a href="#l5.24"></a><span id="l5.24">            Services.io.offline;</span>
<a href="#l5.25"></a><span id="l5.25">   },</span>
<a href="#l5.26"></a><span id="l5.26"> </span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-  hide: function(aPermanent) {</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  hide(aPermanent) {</span>
<a href="#l5.29"></a><span id="l5.29">     if (aPermanent)</span>
<a href="#l5.30"></a><span id="l5.30">       Services.prefs.setBoolPref(&quot;mail.compose.big_attachments.notify&quot;, false);</span>
<a href="#l5.31"></a><span id="l5.31">     else</span>
<a href="#l5.32"></a><span id="l5.32">       this.sessionHidden = true;</span>
<a href="#l5.33"></a><span id="l5.33">   },</span>
<a href="#l5.34"></a><span id="l5.34"> </span>
<a href="#l5.35"></a><span id="l5.35" class="difflineminus">-  init: function() {</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  init() {</span>
<a href="#l5.37"></a><span id="l5.37">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l5.38"></a><span id="l5.38">     bucket.addEventListener(&quot;attachments-added&quot;, this);</span>
<a href="#l5.39"></a><span id="l5.39">     bucket.addEventListener(&quot;attachments-removed&quot;, this);</span>
<a href="#l5.40"></a><span id="l5.40">     bucket.addEventListener(&quot;attachments-uploading&quot;, this);</span>
<a href="#l5.41"></a><span id="l5.41">     bucket.addEventListener(&quot;attachment-uploaded&quot;, this);</span>
<a href="#l5.42"></a><span id="l5.42">     bucket.addEventListener(&quot;attachment-upload-failed&quot;, this);</span>
<a href="#l5.43"></a><span id="l5.43">     bucket.addEventListener(&quot;attachments-converted&quot;, this);</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">     this.sessionHidden = false;</span>
<a href="#l5.46"></a><span id="l5.46">     this.privacyWarned = false;</span>
<a href="#l5.47"></a><span id="l5.47">     this.bigFiles = [];</span>
<a href="#l5.48"></a><span id="l5.48">   },</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineminus">-  handleEvent: function(event) {</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l5.52"></a><span id="l5.52">     if (this.hidden)</span>
<a href="#l5.53"></a><span id="l5.53">       return;</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55">     const bucketCallbacks = {</span>
<a href="#l5.56"></a><span id="l5.56">       &quot;attachments-added&quot;: this.attachmentsAdded,</span>
<a href="#l5.57"></a><span id="l5.57">       &quot;attachments-removed&quot;: this.attachmentsRemoved,</span>
<a href="#l5.58"></a><span id="l5.58">       &quot;attachments-converted&quot;: this.attachmentsConverted,</span>
<a href="#l5.59"></a><span id="l5.59">       &quot;attachments-uploading&quot;: this.attachmentsUploading,</span>
<a href="#l5.60"></a><span id="l5.60">     };</span>
<a href="#l5.61"></a><span id="l5.61"> </span>
<a href="#l5.62"></a><span id="l5.62">     const itemCallbacks = {</span>
<a href="#l5.63"></a><span id="l5.63">       &quot;attachment-uploaded&quot;: this.attachmentUploaded,</span>
<a href="#l5.64"></a><span id="l5.64">       &quot;attachment-upload-failed&quot;: this.attachmentUploadFailed,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-    }</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+    };</span>
<a href="#l5.67"></a><span id="l5.67"> </span>
<a href="#l5.68"></a><span id="l5.68">     if (event.type in bucketCallbacks)</span>
<a href="#l5.69"></a><span id="l5.69">       bucketCallbacks[event.type].call(this, event.detail);</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71">     if (event.type in itemCallbacks)</span>
<a href="#l5.72"></a><span id="l5.72">       itemCallbacks[event.type].call(this, event.target,</span>
<a href="#l5.73"></a><span id="l5.73">                                      (&quot;detail&quot; in event) ? event.detail : null);</span>
<a href="#l5.74"></a><span id="l5.74"> </span>
<a href="#l5.75"></a><span id="l5.75">     this.updateNotification();</span>
<a href="#l5.76"></a><span id="l5.76">   },</span>
<a href="#l5.77"></a><span id="l5.77"> </span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-  formatString: function (key, replacements, plural) {</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineplus">+  formatString(key, replacements, plural) {</span>
<a href="#l5.80"></a><span id="l5.80">     let str = getComposeBundle().getString(key);</span>
<a href="#l5.81"></a><span id="l5.81">     if (plural !== undefined)</span>
<a href="#l5.82"></a><span id="l5.82">       str = PluralForm.get(plural, str);</span>
<a href="#l5.83"></a><span id="l5.83">     if (replacements !== undefined) {</span>
<a href="#l5.84"></a><span id="l5.84">       for (let i = 0; i &lt; replacements.length; i++)</span>
<a href="#l5.85"></a><span id="l5.85">         str = str.replace(&quot;#&quot; + (i + 1), replacements[i]);</span>
<a href="#l5.86"></a><span id="l5.86">     }</span>
<a href="#l5.87"></a><span id="l5.87">     return str;</span>
<a href="#l5.88"></a><span id="l5.88">   },</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90" class="difflineminus">-  attachmentsAdded: function(aAttachments) {</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+  attachmentsAdded(aAttachments) {</span>
<a href="#l5.92"></a><span id="l5.92">     let threshold = Services.prefs.getIntPref(</span>
<a href="#l5.93"></a><span id="l5.93">                     &quot;mail.compose.big_attachments.threshold_kb&quot;) * 1024;</span>
<a href="#l5.94"></a><span id="l5.94"> </span>
<a href="#l5.95"></a><span id="l5.95">     for (let attachment of fixIterator(</span>
<a href="#l5.96"></a><span id="l5.96">          aAttachments, Ci.nsIMsgAttachment)) {</span>
<a href="#l5.97"></a><span id="l5.97">       if (attachment.size &gt;= threshold &amp;&amp; !attachment.sendViaCloud)</span>
<a href="#l5.98"></a><span id="l5.98">         this.bigFiles.push(attachment);</span>
<a href="#l5.99"></a><span id="l5.99">     }</span>
<a href="#l5.100"></a><span id="l5.100">   },</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-  attachmentsRemoved: function(aAttachments) {</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  attachmentsRemoved(aAttachments) {</span>
<a href="#l5.104"></a><span id="l5.104">     for (let attachment of fixIterator(</span>
<a href="#l5.105"></a><span id="l5.105">          aAttachments, Ci.nsIMsgAttachment)) {</span>
<a href="#l5.106"></a><span id="l5.106">       let index = this.bigFiles.indexOf(attachment);</span>
<a href="#l5.107"></a><span id="l5.107">       if (index != -1)</span>
<a href="#l5.108"></a><span id="l5.108">         this.bigFiles.splice(index, 1);</span>
<a href="#l5.109"></a><span id="l5.109">     }</span>
<a href="#l5.110"></a><span id="l5.110">   },</span>
<a href="#l5.111"></a><span id="l5.111"> </span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-  attachmentsConverted: function(aAttachments) {</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  attachmentsConverted(aAttachments) {</span>
<a href="#l5.114"></a><span id="l5.114">     let uploaded = [];</span>
<a href="#l5.115"></a><span id="l5.115"> </span>
<a href="#l5.116"></a><span id="l5.116">     for (let attachment of fixIterator(</span>
<a href="#l5.117"></a><span id="l5.117">          aAttachments, Ci.nsIMsgAttachment)) {</span>
<a href="#l5.118"></a><span id="l5.118">       if (attachment.sendViaCloud) {</span>
<a href="#l5.119"></a><span id="l5.119">         this.attachmentsRemoved([attachment]);</span>
<a href="#l5.120"></a><span id="l5.120">         uploaded.push(attachment);</span>
<a href="#l5.121"></a><span id="l5.121">       }</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">     if (uploaded.length)</span>
<a href="#l5.125"></a><span id="l5.125">       this.showUploadingNotification(uploaded);</span>
<a href="#l5.126"></a><span id="l5.126">   },</span>
<a href="#l5.127"></a><span id="l5.127"> </span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-  attachmentsUploading: function(aAttachments) {</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+  attachmentsUploading(aAttachments) {</span>
<a href="#l5.130"></a><span id="l5.130">     this.showUploadingNotification(aAttachments);</span>
<a href="#l5.131"></a><span id="l5.131">   },</span>
<a href="#l5.132"></a><span id="l5.132"> </span>
<a href="#l5.133"></a><span id="l5.133" class="difflineminus">-  attachmentUploaded: function(aAttachment) {</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  attachmentUploaded(aAttachment) {</span>
<a href="#l5.135"></a><span id="l5.135">     if (!this._anyUploadsInProgress()) {</span>
<a href="#l5.136"></a><span id="l5.136">       this.hideUploadingNotification();</span>
<a href="#l5.137"></a><span id="l5.137"> </span>
<a href="#l5.138"></a><span id="l5.138">       if (!this.privacyWarned) {</span>
<a href="#l5.139"></a><span id="l5.139">         this.showPrivacyNotification();</span>
<a href="#l5.140"></a><span id="l5.140">         this.privacyWarned = true;</span>
<a href="#l5.141"></a><span id="l5.141">       }</span>
<a href="#l5.142"></a><span id="l5.142">     }</span>
<a href="#l5.143"></a><span id="l5.143">   },</span>
<a href="#l5.144"></a><span id="l5.144"> </span>
<a href="#l5.145"></a><span id="l5.145" class="difflineminus">-  attachmentUploadFailed: function(aAttachment, aStatusCode) {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+  attachmentUploadFailed(aAttachment, aStatusCode) {</span>
<a href="#l5.147"></a><span id="l5.147">     if (!this._anyUploadsInProgress())</span>
<a href="#l5.148"></a><span id="l5.148">       this.hideUploadingNotification();</span>
<a href="#l5.149"></a><span id="l5.149">   },</span>
<a href="#l5.150"></a><span id="l5.150"> </span>
<a href="#l5.151"></a><span id="l5.151" class="difflineminus">-  updateNotification: function() {</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+  updateNotification() {</span>
<a href="#l5.153"></a><span id="l5.153">     let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l5.154"></a><span id="l5.154">     let notification = nb.getNotificationWithValue(&quot;bigAttachment&quot;);</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-    let numAccounts = cloudFileAccounts.accounts.length;</span>
<a href="#l5.156"></a><span id="l5.156"> </span>
<a href="#l5.157"></a><span id="l5.157">     if (this.bigFiles.length) {</span>
<a href="#l5.158"></a><span id="l5.158">       if (notification) {</span>
<a href="#l5.159"></a><span id="l5.159">         notification.label = this.formatString(&quot;bigFileDescription&quot;,</span>
<a href="#l5.160"></a><span id="l5.160">                                                [this.bigFiles.length],</span>
<a href="#l5.161"></a><span id="l5.161">                                                this.bigFiles.length);</span>
<a href="#l5.162"></a><span id="l5.162">         return;</span>
<a href="#l5.163"></a><span id="l5.163">       }</span>
<a href="#l5.164"></a><span id="l5.164"> </span>
<a href="#l5.165"></a><span id="l5.165">       let buttons = [</span>
<a href="#l5.166"></a><span id="l5.166">         {</span>
<a href="#l5.167"></a><span id="l5.167">           label: getComposeBundle().getString(&quot;learnMore.label&quot;),</span>
<a href="#l5.168"></a><span id="l5.168">           accessKey: getComposeBundle().getString(&quot;learnMore.accesskey&quot;),</span>
<a href="#l5.169"></a><span id="l5.169">           callback: this.openLearnMore.bind(this),</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-        },</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-        { label: this.formatString(&quot;bigFileShare.label&quot;,</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-                                   []),</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+        }, {</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+          label: this.formatString(&quot;bigFileShare.label&quot;, []),</span>
<a href="#l5.175"></a><span id="l5.175">           accessKey: this.formatString(&quot;bigFileShare.accesskey&quot;),</span>
<a href="#l5.176"></a><span id="l5.176">           callback: this.convertAttachments.bind(this),</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-        },</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineminus">-        { label: this.formatString(&quot;bigFileAttach.label&quot;,</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-                                   []),</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+        }, {</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+          label: this.formatString(&quot;bigFileAttach.label&quot;, []),</span>
<a href="#l5.183"></a><span id="l5.183">           accessKey: this.formatString(&quot;bigFileAttach.accesskey&quot;),</span>
<a href="#l5.184"></a><span id="l5.184">           callback: this.hideNotification.bind(this),</span>
<a href="#l5.185"></a><span id="l5.185">         },</span>
<a href="#l5.186"></a><span id="l5.186">       ];</span>
<a href="#l5.187"></a><span id="l5.187"> </span>
<a href="#l5.188"></a><span id="l5.188">       let msg = this.formatString(&quot;bigFileDescription&quot;, [this.bigFiles.length],</span>
<a href="#l5.189"></a><span id="l5.189">                                   this.bigFiles.length);</span>
<a href="#l5.190"></a><span id="l5.190"> </span>
<a href="#l5.191"></a><span id="l5.191">       notification = nb.appendNotification(msg, &quot;bigAttachment&quot;, &quot;null&quot;,</span>
<a href="#l5.192"></a><span id="l5.192">                                            nb.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l5.193"></a><span id="l5.193">                                            buttons);</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineminus">-    }</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-    else {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-      if (notification)</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-        nb.removeNotification(notification);</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+    } else if (notification) {</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+      nb.removeNotification(notification);</span>
<a href="#l5.200"></a><span id="l5.200">     }</span>
<a href="#l5.201"></a><span id="l5.201">   },</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-  openLearnMore: function() {</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+  openLearnMore() {</span>
<a href="#l5.205"></a><span id="l5.205">     let url = Services.prefs.getCharPref(&quot;mail.cloud_files.learn_more_url&quot;);</span>
<a href="#l5.206"></a><span id="l5.206">     openContentTab(url);</span>
<a href="#l5.207"></a><span id="l5.207">     return true;</span>
<a href="#l5.208"></a><span id="l5.208">   },</span>
<a href="#l5.209"></a><span id="l5.209"> </span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-  convertAttachments: function() {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+  convertAttachments() {</span>
<a href="#l5.212"></a><span id="l5.212">     let cloudProvider;</span>
<a href="#l5.213"></a><span id="l5.213">     let accounts = cloudFileAccounts.accounts;</span>
<a href="#l5.214"></a><span id="l5.214"> </span>
<a href="#l5.215"></a><span id="l5.215">     if (accounts.length == 1) {</span>
<a href="#l5.216"></a><span id="l5.216">       cloudProvider = accounts[0];</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-    }</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-    else if(accounts.length &gt; 1) {</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineplus">+    } else if (accounts.length &gt; 1) {</span>
<a href="#l5.220"></a><span id="l5.220">       let selection = {};</span>
<a href="#l5.221"></a><span id="l5.221">       let names = accounts.map(i =&gt; cloudFileAccounts.getDisplayName(i));</span>
<a href="#l5.222"></a><span id="l5.222">       if (Services.prompt.select(window,</span>
<a href="#l5.223"></a><span id="l5.223">                                  this.formatString(&quot;bigFileChooseAccount.title&quot;),</span>
<a href="#l5.224"></a><span id="l5.224">                                  this.formatString(&quot;bigFileChooseAccount.text&quot;),</span>
<a href="#l5.225"></a><span id="l5.225">                                  names.length, names, selection))</span>
<a href="#l5.226"></a><span id="l5.226">         cloudProvider = accounts[selection.value];</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-    }</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-    else {</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+    } else {</span>
<a href="#l5.230"></a><span id="l5.230">       let accountKey = cloudFileAccounts.addAccountDialog();</span>
<a href="#l5.231"></a><span id="l5.231">       if (accountKey)</span>
<a href="#l5.232"></a><span id="l5.232">         cloudProvider = cloudFileAccounts.getAccount(accountKey);</span>
<a href="#l5.233"></a><span id="l5.233">       else</span>
<a href="#l5.234"></a><span id="l5.234">         return true;</span>
<a href="#l5.235"></a><span id="l5.235">     }</span>
<a href="#l5.236"></a><span id="l5.236"> </span>
<a href="#l5.237"></a><span id="l5.237">     if (cloudProvider)</span>
<a href="#l5.238"></a><span id="l5.238">       convertToCloudAttachment(this.bigFiles, cloudProvider);</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineplus">+</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineplus">+    return false;</span>
<a href="#l5.241"></a><span id="l5.241">   },</span>
<a href="#l5.242"></a><span id="l5.242"> </span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-  hideNotification: function() {</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+  hideNotification() {</span>
<a href="#l5.245"></a><span id="l5.245">     let never = {};</span>
<a href="#l5.246"></a><span id="l5.246">     if (Services.prompt.confirmCheck(window,</span>
<a href="#l5.247"></a><span id="l5.247">                                      this.formatString(&quot;bigFileHideNotification.title&quot;),</span>
<a href="#l5.248"></a><span id="l5.248">                                      this.formatString(&quot;bigFileHideNotification.text&quot;),</span>
<a href="#l5.249"></a><span id="l5.249">                                      this.formatString(&quot;bigFileHideNotification.check&quot;),</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-                                     never))</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineplus">+                                     never)) {</span>
<a href="#l5.252"></a><span id="l5.252">       this.hide(never.value);</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineminus">-    else</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-      return true;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+      return false;</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+    }</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+    return true;</span>
<a href="#l5.258"></a><span id="l5.258">   },</span>
<a href="#l5.259"></a><span id="l5.259"> </span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-  showUploadingNotification: function(aAttachments) {</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineplus">+  showUploadingNotification(aAttachments) {</span>
<a href="#l5.262"></a><span id="l5.262">     // We will show the uploading notification for a minimum of 2.5 seconds</span>
<a href="#l5.263"></a><span id="l5.263">     // seconds.</span>
<a href="#l5.264"></a><span id="l5.264">     const kThreshold = 2500; // milliseconds</span>
<a href="#l5.265"></a><span id="l5.265"> </span>
<a href="#l5.266"></a><span id="l5.266">     if (!aAttachments.length ||</span>
<a href="#l5.267"></a><span id="l5.267">         !Services.prefs</span>
<a href="#l5.268"></a><span id="l5.268">                  .getBoolPref(&quot;mail.compose.big_attachments.insert_notification&quot;))</span>
<a href="#l5.269"></a><span id="l5.269">       return;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineat">@@ -240,28 +237,27 @@ var gBigFileObserver = {</span>
<a href="#l5.271"></a><span id="l5.271">     if (notification)</span>
<a href="#l5.272"></a><span id="l5.272">       return;</span>
<a href="#l5.273"></a><span id="l5.273"> </span>
<a href="#l5.274"></a><span id="l5.274">     let message = this.formatString(&quot;cloudFileUploadingNotification&quot;);</span>
<a href="#l5.275"></a><span id="l5.275">     message = PluralForm.get(aAttachments.length, message);</span>
<a href="#l5.276"></a><span id="l5.276">     let showUploadButton = {</span>
<a href="#l5.277"></a><span id="l5.277">       accessKey: this.formatString(&quot;stopShowingUploadingNotification.accesskey&quot;),</span>
<a href="#l5.278"></a><span id="l5.278">       label: this.formatString(&quot;stopShowingUploadingNotification.label&quot;),</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-      callback: function (aNotificationBar, aButton)</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineminus">-      {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+      callback(aNotificationBar, aButton) {</span>
<a href="#l5.282"></a><span id="l5.282">         Services.prefs.setBoolPref(&quot;mail.compose.big_attachments.insert_notification&quot;, false);</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-      }</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+      },</span>
<a href="#l5.285"></a><span id="l5.285">     };</span>
<a href="#l5.286"></a><span id="l5.286">     notification = nb.appendNotification(message, kUploadNotificationValue,</span>
<a href="#l5.287"></a><span id="l5.287">                                          &quot;null&quot;, nb.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l5.288"></a><span id="l5.288">                                          [showUploadButton]);</span>
<a href="#l5.289"></a><span id="l5.289">     notification.timeout = Date.now() + kThreshold;</span>
<a href="#l5.290"></a><span id="l5.290">   },</span>
<a href="#l5.291"></a><span id="l5.291"> </span>
<a href="#l5.292"></a><span id="l5.292" class="difflineminus">-  hideUploadingNotification: function() {</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+  hideUploadingNotification() {</span>
<a href="#l5.294"></a><span id="l5.294">     let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l5.295"></a><span id="l5.295">     let notification = nb.getNotificationWithValue(kUploadNotificationValue);</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297">     if (notification) {</span>
<a href="#l5.298"></a><span id="l5.298">       // Check the timestamp that we stashed in the timeout field of the</span>
<a href="#l5.299"></a><span id="l5.299">       // notification...</span>
<a href="#l5.300"></a><span id="l5.300">       let now = Date.now();</span>
<a href="#l5.301"></a><span id="l5.301">       if (now &gt;= notification.timeout) {</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineat">@@ -269,35 +265,34 @@ var gBigFileObserver = {</span>
<a href="#l5.303"></a><span id="l5.303">       } else {</span>
<a href="#l5.304"></a><span id="l5.304">         setTimeout(function() {</span>
<a href="#l5.305"></a><span id="l5.305">           nb.removeNotification(notification);</span>
<a href="#l5.306"></a><span id="l5.306">         }, notification.timeout - now);</span>
<a href="#l5.307"></a><span id="l5.307">       }</span>
<a href="#l5.308"></a><span id="l5.308">     }</span>
<a href="#l5.309"></a><span id="l5.309">   },</span>
<a href="#l5.310"></a><span id="l5.310"> </span>
<a href="#l5.311"></a><span id="l5.311" class="difflineminus">-  showPrivacyNotification: function() {</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+  showPrivacyNotification() {</span>
<a href="#l5.313"></a><span id="l5.313">     const kPrivacyNotificationValue = &quot;bigAttachmentPrivacyWarning&quot;;</span>
<a href="#l5.314"></a><span id="l5.314"> </span>
<a href="#l5.315"></a><span id="l5.315">     let nb = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l5.316"></a><span id="l5.316">     let notification = nb.getNotificationWithValue(kPrivacyNotificationValue);</span>
<a href="#l5.317"></a><span id="l5.317"> </span>
<a href="#l5.318"></a><span id="l5.318">     if (notification)</span>
<a href="#l5.319"></a><span id="l5.319">       return;</span>
<a href="#l5.320"></a><span id="l5.320"> </span>
<a href="#l5.321"></a><span id="l5.321">     let message = this.formatString(&quot;cloudFilePrivacyNotification&quot;);</span>
<a href="#l5.322"></a><span id="l5.322">     nb.appendNotification(message, kPrivacyNotificationValue, &quot;null&quot;,</span>
<a href="#l5.323"></a><span id="l5.323">                           nb.PRIORITY_WARNING_MEDIUM, null);</span>
<a href="#l5.324"></a><span id="l5.324"> </span>
<a href="#l5.325"></a><span id="l5.325">   },</span>
<a href="#l5.326"></a><span id="l5.326"> </span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-  _anyUploadsInProgress: function() {</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+  _anyUploadsInProgress() {</span>
<a href="#l5.329"></a><span id="l5.329">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineminus">-    let rowCount = bucket.getRowCount();</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-    for (let i = 0; i &lt; bucket.getRowCount(); ++i) {</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+    for (let i = 0, rowCount = bucket.getRowCount(); i &lt; rowCount; ++i) {</span>
<a href="#l5.333"></a><span id="l5.333">       let item = bucket.getItemAtIndex(i);</span>
<a href="#l5.334"></a><span id="l5.334">       if (item &amp;&amp; item.uploading)</span>
<a href="#l5.335"></a><span id="l5.335">         return true;</span>
<a href="#l5.336"></a><span id="l5.336">     }</span>
<a href="#l5.337"></a><span id="l5.337">     return false;</span>
<a href="#l5.338"></a><span id="l5.338">   },</span>
<a href="#l5.339"></a><span id="l5.339"> </span>
<a href="#l5.340"></a><span id="l5.340"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,14 +1,16 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l6.6"></a><span id="l6.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8" class="difflineplus">+/* import-globals-from MsgComposeCommands.js */</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineplus">+</span>
<a href="#l6.10"></a><span id="l6.10"> var gCloudAttachmentLinkManager = {</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-  init: function() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  init() {</span>
<a href="#l6.13"></a><span id="l6.13">     this.cloudAttachments = [];</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">     let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l6.16"></a><span id="l6.16">     bucket.addEventListener(&quot;attachment-uploaded&quot;, this);</span>
<a href="#l6.17"></a><span id="l6.17">     bucket.addEventListener(&quot;attachments-removed&quot;, this);</span>
<a href="#l6.18"></a><span id="l6.18">     bucket.addEventListener(&quot;attachments-converted&quot;, this);</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">     // If we're restoring a draft that has some attachments,</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -18,35 +20,34 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.22"></a><span id="l6.22">       let attachment = bucket.getItemAtIndex(i).attachment;</span>
<a href="#l6.23"></a><span id="l6.23">       if (attachment &amp;&amp; attachment.sendViaCloud)</span>
<a href="#l6.24"></a><span id="l6.24">         this.cloudAttachments.push(attachment);</span>
<a href="#l6.25"></a><span id="l6.25">     }</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27">     gMsgCompose.RegisterStateListener(this);</span>
<a href="#l6.28"></a><span id="l6.28">   },</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-  NotifyComposeFieldsReady: function() {},</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  NotifyComposeBodyReady: function() {},</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  ComposeProcessDone: function() {},</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-  SaveInFolderDone: function() {},</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+  NotifyComposeFieldsReady() {},</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+  NotifyComposeBodyReady() {},</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineplus">+  ComposeProcessDone() {},</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineplus">+  SaveInFolderDone() {},</span>
<a href="#l6.38"></a><span id="l6.38"> </span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-  handleEvent: function(event) {</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+  handleEvent(event) {</span>
<a href="#l6.41"></a><span id="l6.41">     let mailDoc = document.getElementById(&quot;content-frame&quot;).contentDocument;</span>
<a href="#l6.42"></a><span id="l6.42"> </span>
<a href="#l6.43"></a><span id="l6.43">     if (event.type == &quot;attachment-uploaded&quot;) {</span>
<a href="#l6.44"></a><span id="l6.44">       if (this.cloudAttachments.length == 0)</span>
<a href="#l6.45"></a><span id="l6.45">         this._insertHeader(mailDoc);</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">       let attachment = event.target.attachment;</span>
<a href="#l6.48"></a><span id="l6.48">       let provider = event.target.cloudProvider;</span>
<a href="#l6.49"></a><span id="l6.49">       this.cloudAttachments.push(attachment);</span>
<a href="#l6.50"></a><span id="l6.50">       this._insertItem(mailDoc, attachment, provider);</span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-    }</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineminus">-    else if (event.type == &quot;attachments-removed&quot; ||</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineminus">-             event.type == &quot;attachments-converted&quot;) {</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+    } else if (event.type == &quot;attachments-removed&quot; ||</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+               event.type == &quot;attachments-converted&quot;) {</span>
<a href="#l6.56"></a><span id="l6.56">       let items = [];</span>
<a href="#l6.57"></a><span id="l6.57">       let list = mailDoc.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l6.58"></a><span id="l6.58">       if (list)</span>
<a href="#l6.59"></a><span id="l6.59">         items = list.getElementsByClassName(&quot;cloudAttachmentItem&quot;);</span>
<a href="#l6.60"></a><span id="l6.60"> </span>
<a href="#l6.61"></a><span id="l6.61">       for (let attachment of fixIterator(</span>
<a href="#l6.62"></a><span id="l6.62">            event.detail, Ci.nsIMsgAttachment)) {</span>
<a href="#l6.63"></a><span id="l6.63">         // Remove the attachment from the message body.</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineat">@@ -71,53 +72,53 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.65"></a><span id="l6.65">     }</span>
<a href="#l6.66"></a><span id="l6.66">   },</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   /**</span>
<a href="#l6.69"></a><span id="l6.69">    * Removes the root node for an attachment list in an HTML email.</span>
<a href="#l6.70"></a><span id="l6.70">    *</span>
<a href="#l6.71"></a><span id="l6.71">    * @param aDocument the document to remove the root node from.</span>
<a href="#l6.72"></a><span id="l6.72">    */</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-  _removeRoot: function(aDocument) {</span>
<a href="#l6.74"></a><span id="l6.74" class="difflineplus">+  _removeRoot(aDocument) {</span>
<a href="#l6.75"></a><span id="l6.75">     let header = aDocument.getElementById(&quot;cloudAttachmentListRoot&quot;);</span>
<a href="#l6.76"></a><span id="l6.76">     if (header)</span>
<a href="#l6.77"></a><span id="l6.77">       header.remove();</span>
<a href="#l6.78"></a><span id="l6.78">   },</span>
<a href="#l6.79"></a><span id="l6.79"> </span>
<a href="#l6.80"></a><span id="l6.80">   /**</span>
<a href="#l6.81"></a><span id="l6.81">    * Given some node, returns the textual HTML representation for the node</span>
<a href="#l6.82"></a><span id="l6.82">    * and its children.</span>
<a href="#l6.83"></a><span id="l6.83">    *</span>
<a href="#l6.84"></a><span id="l6.84">    * @param aDocument the document that the node is embedded in</span>
<a href="#l6.85"></a><span id="l6.85">    * @param aNode the node to get the textual representation from</span>
<a href="#l6.86"></a><span id="l6.86">    */</span>
<a href="#l6.87"></a><span id="l6.87" class="difflineminus">-  _getHTMLRepresentation: function(aDocument, aNode) {</span>
<a href="#l6.88"></a><span id="l6.88" class="difflineplus">+  _getHTMLRepresentation(aDocument, aNode) {</span>
<a href="#l6.89"></a><span id="l6.89">     let tmp = aDocument.createElement(&quot;p&quot;);</span>
<a href="#l6.90"></a><span id="l6.90">     tmp.appendChild(aNode);</span>
<a href="#l6.91"></a><span id="l6.91">     return tmp.innerHTML;</span>
<a href="#l6.92"></a><span id="l6.92">   },</span>
<a href="#l6.93"></a><span id="l6.93"> </span>
<a href="#l6.94"></a><span id="l6.94">   /**</span>
<a href="#l6.95"></a><span id="l6.95">    * Generates an appropriately styled link.</span>
<a href="#l6.96"></a><span id="l6.96">    *</span>
<a href="#l6.97"></a><span id="l6.97">    * @param aDocument the document to append the link to - doesn't actually</span>
<a href="#l6.98"></a><span id="l6.98">    *                  get appended, but is used to generate the anchor node.</span>
<a href="#l6.99"></a><span id="l6.99">    * @param aContent the textual content of the link</span>
<a href="#l6.100"></a><span id="l6.100">    * @param aHref the HREF attribute for the generated link</span>
<a href="#l6.101"></a><span id="l6.101">    */</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineminus">-  _generateLink: function(aDocument, aContent, aHref) {</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+  _generateLink(aDocument, aContent, aHref) {</span>
<a href="#l6.104"></a><span id="l6.104">     const LINK_COLOR = &quot;#0F7EDB&quot;;</span>
<a href="#l6.105"></a><span id="l6.105">     let link = aDocument.createElement(&quot;a&quot;);</span>
<a href="#l6.106"></a><span id="l6.106">     link.href = aHref;</span>
<a href="#l6.107"></a><span id="l6.107">     link.textContent = aContent;</span>
<a href="#l6.108"></a><span id="l6.108">     link.style.cssText = &quot;color: &quot; + LINK_COLOR + &quot; !important&quot;;</span>
<a href="#l6.109"></a><span id="l6.109">     return link;</span>
<a href="#l6.110"></a><span id="l6.110">   },</span>
<a href="#l6.111"></a><span id="l6.111"> </span>
<a href="#l6.112"></a><span id="l6.112" class="difflineminus">-  _findInsertionPoint: function(aDocument) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+  _findInsertionPoint(aDocument) {</span>
<a href="#l6.114"></a><span id="l6.114">     let mailBody = aDocument.querySelector(&quot;body&quot;);</span>
<a href="#l6.115"></a><span id="l6.115">     let editor = GetCurrentEditor();</span>
<a href="#l6.116"></a><span id="l6.116">     let selection = editor.selection;</span>
<a href="#l6.117"></a><span id="l6.117"> </span>
<a href="#l6.118"></a><span id="l6.118">     let childNodes = mailBody.childNodes;</span>
<a href="#l6.119"></a><span id="l6.119">     let childToInsertAfter, childIndex;</span>
<a href="#l6.120"></a><span id="l6.120"> </span>
<a href="#l6.121"></a><span id="l6.121">     // First, search for any text nodes that are immediate children of</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineat">@@ -158,29 +159,27 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.123"></a><span id="l6.123">           selection.collapse(mailBody, childNodes.length - 1);</span>
<a href="#l6.124"></a><span id="l6.124">           editor.insertLineBreak();</span>
<a href="#l6.125"></a><span id="l6.125"> </span>
<a href="#l6.126"></a><span id="l6.126">           if (!gMsgCompose.composeHTML)</span>
<a href="#l6.127"></a><span id="l6.127">             editor.insertLineBreak();</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129">           selection.collapse(mailBody, childNodes.length - 2);</span>
<a href="#l6.130"></a><span id="l6.130">         }</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineminus">-      } else {</span>
<a href="#l6.132"></a><span id="l6.132" class="difflineplus">+      } else if (replyCitation.previousSibling) {</span>
<a href="#l6.133"></a><span id="l6.133">         // Replying above quote</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-        if (replyCitation.previousSibling) {</span>
<a href="#l6.135"></a><span id="l6.135" class="difflineminus">-          let nodeIndex = Array.from(childNodes).indexOf(replyCitation.previousSibling);</span>
<a href="#l6.136"></a><span id="l6.136" class="difflineminus">-          if (nodeIndex &lt;= 0) {</span>
<a href="#l6.137"></a><span id="l6.137" class="difflineminus">-            editor.insertLineBreak();</span>
<a href="#l6.138"></a><span id="l6.138" class="difflineminus">-            nodeIndex = 1;</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-          }</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-          selection.collapse(mailBody, nodeIndex);</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-        } else {</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineminus">-          editor.beginningOfDocument();</span>
<a href="#l6.143"></a><span id="l6.143" class="difflineplus">+        let nodeIndex = Array.from(childNodes).indexOf(replyCitation.previousSibling);</span>
<a href="#l6.144"></a><span id="l6.144" class="difflineplus">+        if (nodeIndex &lt;= 0) {</span>
<a href="#l6.145"></a><span id="l6.145">           editor.insertLineBreak();</span>
<a href="#l6.146"></a><span id="l6.146" class="difflineplus">+          nodeIndex = 1;</span>
<a href="#l6.147"></a><span id="l6.147">         }</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineplus">+        selection.collapse(mailBody, nodeIndex);</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineplus">+      } else {</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+        editor.beginningOfDocument();</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+        editor.insertLineBreak();</span>
<a href="#l6.152"></a><span id="l6.152">       }</span>
<a href="#l6.153"></a><span id="l6.153">       return;</span>
<a href="#l6.154"></a><span id="l6.154">     }</span>
<a href="#l6.155"></a><span id="l6.155"> </span>
<a href="#l6.156"></a><span id="l6.156">     // Are we forwarding?</span>
<a href="#l6.157"></a><span id="l6.157">     let forwardBody = mailBody.querySelector(&quot;.moz-forward-container&quot;);</span>
<a href="#l6.158"></a><span id="l6.158">     if (forwardBody) {</span>
<a href="#l6.159"></a><span id="l6.159">       if (forwardBody.previousSibling) {</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineat">@@ -226,31 +225,31 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">   /**</span>
<a href="#l6.163"></a><span id="l6.163">    * Attempts to find any elements with an id in aIDs, and sets those elements</span>
<a href="#l6.164"></a><span id="l6.164">    * id attribute to the empty string, freeing up the ids for later use.</span>
<a href="#l6.165"></a><span id="l6.165">    *</span>
<a href="#l6.166"></a><span id="l6.166">    * @param aDocument the document to search for the elements.</span>
<a href="#l6.167"></a><span id="l6.167">    * @param aIDs an array of id strings.</span>
<a href="#l6.168"></a><span id="l6.168">    */</span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  _resetNodeIDs: function(aDocument, aIDs) {</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  _resetNodeIDs(aDocument, aIDs) {</span>
<a href="#l6.171"></a><span id="l6.171">     for (let id of aIDs) {</span>
<a href="#l6.172"></a><span id="l6.172">       let node = aDocument.getElementById(id);</span>
<a href="#l6.173"></a><span id="l6.173">       if (node)</span>
<a href="#l6.174"></a><span id="l6.174">         node.id = &quot;&quot;;</span>
<a href="#l6.175"></a><span id="l6.175">     }</span>
<a href="#l6.176"></a><span id="l6.176">   },</span>
<a href="#l6.177"></a><span id="l6.177"> </span>
<a href="#l6.178"></a><span id="l6.178">   /**</span>
<a href="#l6.179"></a><span id="l6.179">    * Insert the header for the cloud attachment list, which we'll use to</span>
<a href="#l6.180"></a><span id="l6.180">    * as an insertion point for the individual cloud attachments.</span>
<a href="#l6.181"></a><span id="l6.181">    *</span>
<a href="#l6.182"></a><span id="l6.182">    * @param aDocument the document to insert the header into.</span>
<a href="#l6.183"></a><span id="l6.183">    */</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  _insertHeader: function(aDocument) {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineplus">+  _insertHeader(aDocument) {</span>
<a href="#l6.186"></a><span id="l6.186">     // If there already exists a cloudAttachmentListRoot,</span>
<a href="#l6.187"></a><span id="l6.187">     // cloudAttachmentListHeader or cloudAttachmentList in the document,</span>
<a href="#l6.188"></a><span id="l6.188">     // strip them of their IDs so that we don't conflict with them.</span>
<a href="#l6.189"></a><span id="l6.189">     this._resetNodeIDs(aDocument, [&quot;cloudAttachmentListRoot&quot;,</span>
<a href="#l6.190"></a><span id="l6.190">                                     &quot;cloudAttachmentListHeader&quot;,</span>
<a href="#l6.191"></a><span id="l6.191">                                     &quot;cloudAttachmentList&quot;]);</span>
<a href="#l6.192"></a><span id="l6.192"> </span>
<a href="#l6.193"></a><span id="l6.193">     let brandBundle = Services.strings.createBundle(&quot;chrome://branding/locale/brand.properties&quot;);</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineat">@@ -295,25 +294,24 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.195"></a><span id="l6.195">                                .getCharPref(&quot;mail.cloud_files.inserted_urls.footer.link&quot;);</span>
<a href="#l6.196"></a><span id="l6.196">       let appname = this._generateLink(aDocument,</span>
<a href="#l6.197"></a><span id="l6.197">                                        brandBundle.GetStringFromName(&quot;brandFullName&quot;),</span>
<a href="#l6.198"></a><span id="l6.198">                                        appLinkUrl);</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200">       let applink = this._getHTMLRepresentation(aDocument, appname);</span>
<a href="#l6.201"></a><span id="l6.201">       let footerMessage = getComposeBundle().getFormattedString(&quot;cloudAttachmentListFooter&quot;, [applink], 1);</span>
<a href="#l6.202"></a><span id="l6.202"> </span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-      footer.innerHTML = footerMessage;</span>
<a href="#l6.204"></a><span id="l6.204" class="difflineplus">+      footer.innerHTML = footerMessage; // eslint-disable-line no-unsanitized/property</span>
<a href="#l6.205"></a><span id="l6.205">       footer.style.color = &quot;#444444&quot;;</span>
<a href="#l6.206"></a><span id="l6.206">       footer.style.fontSize = &quot;small&quot;;</span>
<a href="#l6.207"></a><span id="l6.207">       footer.style.marginTop = &quot;15px&quot;;</span>
<a href="#l6.208"></a><span id="l6.208">       root.appendChild(footer);</span>
<a href="#l6.209"></a><span id="l6.209"> </span>
<a href="#l6.210"></a><span id="l6.210">       editor.insertElementAtSelection(root, false);</span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-    }</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineminus">-    else {</span>
<a href="#l6.213"></a><span id="l6.213" class="difflineplus">+    } else {</span>
<a href="#l6.214"></a><span id="l6.214">       let root = editor.createElementWithDefaults(&quot;div&quot;);</span>
<a href="#l6.215"></a><span id="l6.215">       root.id = &quot;cloudAttachmentListRoot&quot;;</span>
<a href="#l6.216"></a><span id="l6.216"> </span>
<a href="#l6.217"></a><span id="l6.217">       let header = editor.createElementWithDefaults(&quot;div&quot;);</span>
<a href="#l6.218"></a><span id="l6.218">       header.id = &quot;cloudAttachmentListHeader&quot;;</span>
<a href="#l6.219"></a><span id="l6.219">       header.innerHTML = &quot; &quot;;</span>
<a href="#l6.220"></a><span id="l6.220">       root.appendChild(header);</span>
<a href="#l6.221"></a><span id="l6.221"> </span>
<a href="#l6.222"></a><span id="l6.222" class="difflineat">@@ -332,17 +330,17 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.223"></a><span id="l6.223">   },</span>
<a href="#l6.224"></a><span id="l6.224"> </span>
<a href="#l6.225"></a><span id="l6.225">   /**</span>
<a href="#l6.226"></a><span id="l6.226">    * Updates the count of how many attachments have been added</span>
<a href="#l6.227"></a><span id="l6.227">    * in HTML emails.</span>
<a href="#l6.228"></a><span id="l6.228">    *</span>
<a href="#l6.229"></a><span id="l6.229">    * @aDocument the document that contains the cloudAttachmentListHeader node.</span>
<a href="#l6.230"></a><span id="l6.230">    */</span>
<a href="#l6.231"></a><span id="l6.231" class="difflineminus">-  _updateAttachmentCount: function(aDocument) {</span>
<a href="#l6.232"></a><span id="l6.232" class="difflineplus">+  _updateAttachmentCount(aDocument) {</span>
<a href="#l6.233"></a><span id="l6.233">     let header = aDocument.getElementById(&quot;cloudAttachmentListHeader&quot;);</span>
<a href="#l6.234"></a><span id="l6.234">     if (!header)</span>
<a href="#l6.235"></a><span id="l6.235">       return;</span>
<a href="#l6.236"></a><span id="l6.236"> </span>
<a href="#l6.237"></a><span id="l6.237">     let count = PluralForm.get(this.cloudAttachments.length,</span>
<a href="#l6.238"></a><span id="l6.238">                                getComposeBundle().getString(&quot;cloudAttachmentCountHeader&quot;));</span>
<a href="#l6.239"></a><span id="l6.239"> </span>
<a href="#l6.240"></a><span id="l6.240">     header.textContent = count.replace(&quot;#1&quot;, this.cloudAttachments.length);</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineat">@@ -350,17 +348,17 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.242"></a><span id="l6.242"> </span>
<a href="#l6.243"></a><span id="l6.243">   /**</span>
<a href="#l6.244"></a><span id="l6.244">    * Insert the information for a cloud attachment.</span>
<a href="#l6.245"></a><span id="l6.245">    *</span>
<a href="#l6.246"></a><span id="l6.246">    * @param aDocument the document to insert the item into</span>
<a href="#l6.247"></a><span id="l6.247">    * @param aAttachment the nsIMsgAttachment to insert</span>
<a href="#l6.248"></a><span id="l6.248">    * @param aProviderType the cloud storage provider</span>
<a href="#l6.249"></a><span id="l6.249">    */</span>
<a href="#l6.250"></a><span id="l6.250" class="difflineminus">-  _insertItem: function(aDocument, aAttachment, aProvider) {</span>
<a href="#l6.251"></a><span id="l6.251" class="difflineplus">+  _insertItem(aDocument, aAttachment, aProvider) {</span>
<a href="#l6.252"></a><span id="l6.252">     let list = aDocument.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l6.253"></a><span id="l6.253"> </span>
<a href="#l6.254"></a><span id="l6.254">     if (!list) {</span>
<a href="#l6.255"></a><span id="l6.255">       this._insertHeader(aDocument);</span>
<a href="#l6.256"></a><span id="l6.256">       list = aDocument.getElementById(&quot;cloudAttachmentList&quot;);</span>
<a href="#l6.257"></a><span id="l6.257">     }</span>
<a href="#l6.258"></a><span id="l6.258"> </span>
<a href="#l6.259"></a><span id="l6.259">     let node = aDocument.createElement(&quot;div&quot;);</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineat">@@ -431,18 +429,17 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.261"></a><span id="l6.261"> </span>
<a href="#l6.262"></a><span id="l6.262">       let downloadUrl = this._generateLink(aDocument,</span>
<a href="#l6.263"></a><span id="l6.263">                                            aAttachment.contentLocation,</span>
<a href="#l6.264"></a><span id="l6.264">                                            aAttachment.contentLocation);</span>
<a href="#l6.265"></a><span id="l6.265">       downloadUrl.style.fontSize = &quot;small&quot;;</span>
<a href="#l6.266"></a><span id="l6.266">       downloadUrl.style.display = &quot;block&quot;;</span>
<a href="#l6.267"></a><span id="l6.267"> </span>
<a href="#l6.268"></a><span id="l6.268">       node.appendChild(downloadUrl);</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-    }</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineminus">-    else {</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+    } else {</span>
<a href="#l6.272"></a><span id="l6.272">       node.textContent = getComposeBundle().getFormattedString(</span>
<a href="#l6.273"></a><span id="l6.273">         &quot;cloudAttachmentListItem&quot;,</span>
<a href="#l6.274"></a><span id="l6.274">         [aAttachment.name, gMessenger.formatFileSize(aAttachment.size),</span>
<a href="#l6.275"></a><span id="l6.275">          aProvider.displayName,</span>
<a href="#l6.276"></a><span id="l6.276">          aAttachment.contentLocation]);</span>
<a href="#l6.277"></a><span id="l6.277">     }</span>
<a href="#l6.278"></a><span id="l6.278"> </span>
<a href="#l6.279"></a><span id="l6.279">     this._updateAttachmentCount(aDocument);</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineat">@@ -450,17 +447,17 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l6.281"></a><span id="l6.281">   },</span>
<a href="#l6.282"></a><span id="l6.282"> </span>
<a href="#l6.283"></a><span id="l6.283">   /**</span>
<a href="#l6.284"></a><span id="l6.284">    * Event handler for when mail is sent.  For mail that is being sent</span>
<a href="#l6.285"></a><span id="l6.285">    * (and not saved!), find any cloudAttachmentList* nodes that we've created,</span>
<a href="#l6.286"></a><span id="l6.286">    * and strip their IDs out.  That way, if the receiving user replies by</span>
<a href="#l6.287"></a><span id="l6.287">    * sending some BigFiles, we don't run into ID conflicts.</span>
<a href="#l6.288"></a><span id="l6.288">    */</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-  send: function(aEvent) {</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineplus">+  send(aEvent) {</span>
<a href="#l6.291"></a><span id="l6.291">     let msgType = parseInt(aEvent.target.getAttribute(&quot;msgtype&quot;));</span>
<a href="#l6.292"></a><span id="l6.292"> </span>
<a href="#l6.293"></a><span id="l6.293">     if (msgType == Ci.nsIMsgCompDeliverMode.Now ||</span>
<a href="#l6.294"></a><span id="l6.294">         msgType == Ci.nsIMsgCompDeliverMode.Later ||</span>
<a href="#l6.295"></a><span id="l6.295">         msgType == Ci.nsIMsgCompDeliverMode.Background) {</span>
<a href="#l6.296"></a><span id="l6.296"> </span>
<a href="#l6.297"></a><span id="l6.297">       const kIDs = [&quot;cloudAttachmentList&quot;, &quot;cloudAttachmentListRoot&quot;,</span>
<a href="#l6.298"></a><span id="l6.298">                     &quot;cloudAttachmentListHeader&quot;];</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

