<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 24893:f77c18acceafaa7e9fed65ab27e293cf117850a4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f77c18acceafaa7e9fed65ab27e293cf117850a4" />
<meta property="og:url" content="/comm-central/rev/f77c18acceafaa7e9fed65ab27e293cf117850a4" />
<meta property="og:description" content="Bug 1496598 - Port bug 1493226: fix 'don't use do_QueryInterface for compile-time-determinable casts' errors. rs=bustage-fix" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f77c18acceafaa7e9fed65ab27e293cf117850a4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f77c18acceafaa7e9fed65ab27e293cf117850a4">shortlog</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f77c18acceafaa7e9fed65ab27e293cf117850a4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4">files</a> |
changeset |
<a href="/comm-central/raw-rev/f77c18acceafaa7e9fed65ab27e293cf117850a4">raw</a>  | <a href="/comm-central/archive/f77c18acceafaa7e9fed65ab27e293cf117850a4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1496598">Bug 1496598</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1493226">bug 1493226</a>: fix 'don't use do_QueryInterface for compile-time-determinable casts' errors. rs=bustage-fix
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Oct 2018 14:22:33 +0200</td></tr>

<tr>
 <td>changeset 24893</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f77c18acceafaa7e9fed65ab27e293cf117850a4">f77c18acceafaa7e9fed65ab27e293cf117850a4</a></td>
</tr>



<tr>
<td>parent 24892</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8a607b0960af73bb04908e4a035e700654b60bfb">8a607b0960af73bb04908e4a035e700654b60bfb</a>
</td>
</tr>

<tr>
<td>child 24894</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/93daa9a87d526f51aa749070a5c33e54142ec49a">93daa9a87d526f51aa749070a5c33e54142ec49a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f77c18acceafaa7e9fed65ab27e293cf117850a4">14974</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Fri, 05 Oct 2018 12:24:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@93daa9a87d52 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93daa9a87d526f51aa749070a5c33e54142ec49a">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=93daa9a87d526f51aa749070a5c33e54142ec49a&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93daa9a87d526f51aa749070a5c33e54142ec49a&newProject=comm-central&newRevision=9766dccdd8b8e23e7ac26f3bfa94449e8b5bf40d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93daa9a87d526f51aa749070a5c33e54142ec49a&newProject=comm-central&newRevision=9766dccdd8b8e23e7ac26f3bfa94449e8b5bf40d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=93daa9a87d526f51aa749070a5c33e54142ec49a&newProject=comm-central&newRevision=9766dccdd8b8e23e7ac26f3bfa94449e8b5bf40d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bustage-fix%29&revcount=50">bustage-fix</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1496598">1496598</a>, <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1493226">1493226</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1496598">Bug 1496598</a> - Port <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1493226">bug 1493226</a>: fix 'don't use do_QueryInterface for compile-time-determinable casts' errors. rs=bustage-fix</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">mailnews/base/search/src/nsMsgFilter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilter.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">mailnews/base/search/src/nsMsgSearchSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/search/src/nsMsgSearchSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">mailnews/base/src/nsMsgFolderCache.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgFolderCache.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">mailnews/base/src/nsMsgGroupView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgGroupView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">mailnews/base/src/nsMsgPrintEngine.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgPrintEngine.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">mailnews/base/src/nsMsgSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">mailnews/base/src/nsMsgWindow.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/src/nsMsgWindow.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">mailnews/base/util/nsImapMoveCoalescer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsImapMoveCoalescer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">mailnews/base/util/nsMsgMailNewsUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgMailNewsUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">mailnews/base/util/nsMsgUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/base/util/nsMsgUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">mailnews/compose/src/nsSmtpProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsSmtpProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">mailnews/imap/src/nsAutoSyncState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsAutoSyncState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">mailnews/import/src/nsImportEncodeScan.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/src/nsImportEncodeScan.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">mailnews/import/text/src/nsTextImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/text/src/nsTextImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">mailnews/import/vcard/src/nsVCardImport.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/import/vcard/src/nsVCardImport.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">mailnews/local/src/nsMailboxUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsMailboxUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">mailnews/local/src/nsPop3Protocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Protocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">mailnews/mapi/mapihook/src/msgMapiImp.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mapi/mapihook/src/msgMapiImp.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">mailnews/mime/emitters/nsMimeBaseEmitter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/emitters/nsMimeBaseEmitter.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">mailnews/mime/src/mimedrft.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimedrft.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">mailnews/mime/src/mimemrel.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimemrel.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">mailnews/mime/src/mimepbuf.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/mime/src/mimepbuf.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">rdf/base/nsInMemoryDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">file</a> |
<a href="/comm-central/annotate/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">comparison</a> |
<a href="/comm-central/log/f77c18acceafaa7e9fed65ab27e293cf117850a4/rdf/base/nsInMemoryDataSource.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAbLDAPReplicationData.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -380,21 +380,17 @@ nsresult nsAbLDAPProcessReplicationData:</span>
<a href="#l1.4"></a><span id="l1.4">         // And also important in case if replication fails we donot lose user's existing</span>
<a href="#l1.5"></a><span id="l1.5">         // replicated data for both Download all and Changelog.</span>
<a href="#l1.6"></a><span id="l1.6">         nsCOMPtr&lt;nsIFile&gt; clone;</span>
<a href="#l1.7"></a><span id="l1.7">         rv = mReplicationFile-&gt;Clone(getter_AddRefs(clone));</span>
<a href="#l1.8"></a><span id="l1.8">         if(NS_FAILED(rv))  {</span>
<a href="#l1.9"></a><span id="l1.9">             Done(false);</span>
<a href="#l1.10"></a><span id="l1.10">             return rv;</span>
<a href="#l1.11"></a><span id="l1.11">         }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        mBackupReplicationFile = do_QueryInterface(clone, &amp;rv);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-        if(NS_FAILED(rv))  {</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-            Done(false);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-            return rv;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-        }</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+        mBackupReplicationFile = clone;</span>
<a href="#l1.18"></a><span id="l1.18">         rv = mBackupReplicationFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0777);</span>
<a href="#l1.19"></a><span id="l1.19">         if(NS_FAILED(rv))  {</span>
<a href="#l1.20"></a><span id="l1.20">             Done(false);</span>
<a href="#l1.21"></a><span id="l1.21">             return rv;</span>
<a href="#l1.22"></a><span id="l1.22">         }</span>
<a href="#l1.23"></a><span id="l1.23">         nsAutoString backupFileLeafName;</span>
<a href="#l1.24"></a><span id="l1.24">         rv = mBackupReplicationFile-&gt;GetLeafName(backupFileLeafName);</span>
<a href="#l1.25"></a><span id="l1.25">         if(NS_FAILED(rv))  {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/addrbook/src/nsAddbookProtocolHandler.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -89,35 +89,34 @@ nsAddbookProtocolHandler::GenerateXMLOut</span>
<a href="#l2.4"></a><span id="l2.4">   nsCOMPtr&lt;nsIStringInputStream&gt; inStr(do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv));</span>
<a href="#l2.5"></a><span id="l2.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">   NS_ConvertUTF16toUTF8 utf8String(aOutput.get());</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9">   rv = inStr-&gt;SetData(utf8String.get(), utf8String.Length());</span>
<a href="#l2.10"></a><span id="l2.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; stream(do_QueryInterface(inStr));</span>
<a href="#l2.13"></a><span id="l2.13">   if (aLoadInfo) {</span>
<a href="#l2.14"></a><span id="l2.14">     return NS_NewInputStreamChannelInternal(_retval,</span>
<a href="#l2.15"></a><span id="l2.15">                                             aURI,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-                                            stream.forget(),</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+                                            inStr.forget(),</span>
<a href="#l2.18"></a><span id="l2.18">                                             NS_LITERAL_CSTRING(&quot;text/xml&quot;),</span>
<a href="#l2.19"></a><span id="l2.19">                                             EmptyCString(),</span>
<a href="#l2.20"></a><span id="l2.20">                                             aLoadInfo);</span>
<a href="#l2.21"></a><span id="l2.21">   }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23">   nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l2.24"></a><span id="l2.24">     do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l2.25"></a><span id="l2.25">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;CreateInstance of nullprincipalfailed.&quot;);</span>
<a href="#l2.26"></a><span id="l2.26">   if (NS_FAILED(rv))</span>
<a href="#l2.27"></a><span id="l2.27">       return rv;</span>
<a href="#l2.28"></a><span id="l2.28"> </span>
<a href="#l2.29"></a><span id="l2.29">   return NS_NewInputStreamChannel(_retval,</span>
<a href="#l2.30"></a><span id="l2.30">                                   aURI,</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-                                  stream.forget(),</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+                                  inStr.forget(),</span>
<a href="#l2.33"></a><span id="l2.33">                                   nullPrincipal,</span>
<a href="#l2.34"></a><span id="l2.34">                                   nsILoadInfo::SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l2.35"></a><span id="l2.35">                                   nsIContentPolicy::TYPE_OTHER,</span>
<a href="#l2.36"></a><span id="l2.36">                                   NS_LITERAL_CSTRING(&quot;text/xml&quot;));</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> NS_IMETHODIMP</span>
<a href="#l2.40"></a><span id="l2.40"> nsAddbookProtocolHandler::NewChannel(nsIURI *aURI, nsIChannel **_retval)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilter.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -788,17 +788,16 @@ nsresult nsMsgFilter::ConvertMoveOrCopyT</span>
<a href="#l3.4"></a><span id="l3.4">         rv = accountManager-&gt;GetLocalFoldersServer(getter_AddRefs(server));</span>
<a href="#l3.5"></a><span id="l3.5">         if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l3.6"></a><span id="l3.6">           rv = server-&gt;GetRootFolder(getter_AddRefs(localMailRoot));</span>
<a href="#l3.7"></a><span id="l3.7">       }</span>
<a href="#l3.8"></a><span id="l3.8">       if (NS_SUCCEEDED(rv) &amp;&amp; localMailRoot)</span>
<a href="#l3.9"></a><span id="l3.9">       {</span>
<a href="#l3.10"></a><span id="l3.10">         nsCString localRootURI;</span>
<a href="#l3.11"></a><span id="l3.11">         nsCOMPtr &lt;nsIMsgFolder&gt; destIMsgFolder;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        nsCOMPtr &lt;nsIMsgFolder&gt; localMailRootMsgFolder = do_QueryInterface(localMailRoot);</span>
<a href="#l3.13"></a><span id="l3.13">         localMailRoot-&gt;GetURI(localRootURI);</span>
<a href="#l3.14"></a><span id="l3.14">         nsCString destFolderUri;</span>
<a href="#l3.15"></a><span id="l3.15">         destFolderUri.Assign(localRootURI);</span>
<a href="#l3.16"></a><span id="l3.16">         // need to remove &quot;.sbd&quot; from moveValue, and perhaps escape it.</span>
<a href="#l3.17"></a><span id="l3.17">         int32_t offset = moveValue.Find(FOLDER_SUFFIX8 &quot;/&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">         if (offset != -1)</span>
<a href="#l3.19"></a><span id="l3.19">           moveValue.Cut(offset, FOLDER_SUFFIX_LENGTH);</span>
<a href="#l3.20"></a><span id="l3.20"> </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineat">@@ -812,17 +811,17 @@ nsresult nsMsgFilter::ConvertMoveOrCopyT</span>
<a href="#l3.22"></a><span id="l3.22">         {</span>
<a href="#l3.23"></a><span id="l3.23">           nsAutoString unicodeStr;</span>
<a href="#l3.24"></a><span id="l3.24">           rv = nsMsgI18NConvertToUnicode(nsMsgI18NFileSystemCharset(),</span>
<a href="#l3.25"></a><span id="l3.25">                                          moveValue, unicodeStr);</span>
<a href="#l3.26"></a><span id="l3.26">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.27"></a><span id="l3.27">           rv = NS_MsgEscapeEncodeURLPath(unicodeStr, moveValue);</span>
<a href="#l3.28"></a><span id="l3.28">         }</span>
<a href="#l3.29"></a><span id="l3.29">         destFolderUri.Append(moveValue);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineminus">-        localMailRootMsgFolder-&gt;GetChildWithURI (destFolderUri, true, false /*caseInsensitive*/, getter_AddRefs(destIMsgFolder));</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        localMailRoot-&gt;GetChildWithURI(destFolderUri, true, false /*caseInsensitive*/, getter_AddRefs(destIMsgFolder));</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33">         if (destIMsgFolder)</span>
<a href="#l3.34"></a><span id="l3.34">         {</span>
<a href="#l3.35"></a><span id="l3.35">           destIMsgFolder-&gt;GetURI(folderUri);</span>
<a href="#l3.36"></a><span id="l3.36">           filterAction-&gt;SetTargetFolderUri(folderUri);</span>
<a href="#l3.37"></a><span id="l3.37">           moveValue.Assign(folderUri);</span>
<a href="#l3.38"></a><span id="l3.38">         }</span>
<a href="#l3.39"></a><span id="l3.39">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -231,17 +231,17 @@ nsMsgFilterService::GetFilterStringBundl</span>
<a href="#l4.4"></a><span id="l4.4">   return NS_OK;</span>
<a href="#l4.5"></a><span id="l4.5"> }</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> nsresult</span>
<a href="#l4.8"></a><span id="l4.8"> nsMsgFilterService::ThrowAlertMsg(const char*aMsgName, nsIMsgWindow *aMsgWindow)</span>
<a href="#l4.9"></a><span id="l4.9"> {</span>
<a href="#l4.10"></a><span id="l4.10">   nsString alertString;</span>
<a href="#l4.11"></a><span id="l4.11">   nsresult rv = GetStringFromBundle(aMsgName, alertString);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryInterface(aMsgWindow));</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow = aMsgWindow;</span>
<a href="#l4.14"></a><span id="l4.14">   if (!msgWindow) {</span>
<a href="#l4.15"></a><span id="l4.15">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession ( do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv));</span>
<a href="#l4.16"></a><span id="l4.16">     if (NS_SUCCEEDED(rv))</span>
<a href="#l4.17"></a><span id="l4.17">       rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l4.18"></a><span id="l4.18">   }</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">   if (NS_SUCCEEDED(rv) &amp;&amp; !alertString.IsEmpty() &amp;&amp; msgWindow)</span>
<a href="#l4.21"></a><span id="l4.21">   {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchSession.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -395,21 +395,20 @@ nsresult nsMsgSearchSession::BeginSearch</span>
<a href="#l5.4"></a><span id="l5.4"> }</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> nsresult nsMsgSearchSession::DoNextSearch()</span>
<a href="#l5.7"></a><span id="l5.7"> {</span>
<a href="#l5.8"></a><span id="l5.8">   nsMsgSearchScopeTerm *scope = m_scopeList.ElementAt(m_idxRunningScope);</span>
<a href="#l5.9"></a><span id="l5.9">   if (scope-&gt;m_attribute == nsMsgSearchScope::onlineMail ||</span>
<a href="#l5.10"></a><span id="l5.10">     (scope-&gt;m_attribute == nsMsgSearchScope::news &amp;&amp; scope-&gt;m_searchServer))</span>
<a href="#l5.11"></a><span id="l5.11">   {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-    nsCOMPtr&lt;nsIMsgSearchAdapter&gt; adapter = do_QueryInterface(scope-&gt;m_adapter);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-    if (adapter)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+    if (scope-&gt;m_adapter)</span>
<a href="#l5.15"></a><span id="l5.15">     {</span>
<a href="#l5.16"></a><span id="l5.16">       m_runningUrl.Truncate();</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-      adapter-&gt;GetEncoding(getter_Copies(m_runningUrl));</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+      scope-&gt;m_adapter-&gt;GetEncoding(getter_Copies(m_runningUrl));</span>
<a href="#l5.19"></a><span id="l5.19">     }</span>
<a href="#l5.20"></a><span id="l5.20">     NS_ENSURE_STATE(!m_runningUrl.IsEmpty());</span>
<a href="#l5.21"></a><span id="l5.21">     return GetNextUrl();</span>
<a href="#l5.22"></a><span id="l5.22">   }</span>
<a href="#l5.23"></a><span id="l5.23">   else</span>
<a href="#l5.24"></a><span id="l5.24">   {</span>
<a href="#l5.25"></a><span id="l5.25">     return SearchWOUrls();</span>
<a href="#l5.26"></a><span id="l5.26">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -242,17 +242,17 @@ NS_IMETHODIMP nsMessenger::SetWindow(moz</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">     rv = mailSession-&gt;AddFolderListener(this, nsIFolderListener::removed);</span>
<a href="#l6.6"></a><span id="l6.6">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">     NS_ENSURE_TRUE(aWin, NS_ERROR_FAILURE);</span>
<a href="#l6.9"></a><span id="l6.9">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = nsPIDOMWindowOuter::From(aWin);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">     nsIDocShell *docShell = win-&gt;GetDocShell();</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(do_QueryInterface(docShell));</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(docShell);</span>
<a href="#l6.14"></a><span id="l6.14">     NS_ENSURE_TRUE(docShellAsItem, NS_ERROR_FAILURE);</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootDocShellAsItem;</span>
<a href="#l6.17"></a><span id="l6.17">     docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootDocShellAsItem));</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; childAsItem;</span>
<a href="#l6.20"></a><span id="l6.20">     rv = rootDocShellAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;messagepane&quot;), true, false,</span>
<a href="#l6.21"></a><span id="l6.21">                                                nullptr, nullptr, getter_AddRefs(childAsItem));</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -1611,17 +1611,17 @@ NS_IMETHODIMP</span>
<a href="#l6.23"></a><span id="l6.23"> nsMessenger::GetLastDisplayedMessageUri(nsACString&amp; aLastDisplayedMessageUri)</span>
<a href="#l6.24"></a><span id="l6.24"> {</span>
<a href="#l6.25"></a><span id="l6.25">   aLastDisplayedMessageUri = mLastDisplayURI;</span>
<a href="#l6.26"></a><span id="l6.26">   return NS_OK;</span>
<a href="#l6.27"></a><span id="l6.27"> }</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29"> nsSaveMsgListener::nsSaveMsgListener(nsIFile* aFile, nsMessenger *aMessenger, nsIUrlListener *aListener)</span>
<a href="#l6.30"></a><span id="l6.30"> {</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-  m_file = do_QueryInterface(aFile);</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  m_file = aFile;</span>
<a href="#l6.33"></a><span id="l6.33">   m_messenger = aMessenger;</span>
<a href="#l6.34"></a><span id="l6.34">   mListener = aListener;</span>
<a href="#l6.35"></a><span id="l6.35">   mUrlHasStopped = false;</span>
<a href="#l6.36"></a><span id="l6.36">   mRequestHasStopped = false;</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     // rhp: for charset handling</span>
<a href="#l6.39"></a><span id="l6.39">   m_doCharsetConversion = false;</span>
<a href="#l6.40"></a><span id="l6.40">   m_saveAllAttachmentsState = nullptr;</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineat">@@ -2095,36 +2095,34 @@ nsMessenger::GetLastSaveDirectory(nsIFil</span>
<a href="#l6.42"></a><span id="l6.42">   if (NS_SUCCEEDED(rv))</span>
<a href="#l6.43"></a><span id="l6.43">     localFile.forget(aLastSaveDir);</span>
<a href="#l6.44"></a><span id="l6.44">   return rv;</span>
<a href="#l6.45"></a><span id="l6.45"> }</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47"> nsresult</span>
<a href="#l6.48"></a><span id="l6.48"> nsMessenger::SetLastSaveDirectory(nsIFile *aLocalFile)</span>
<a href="#l6.49"></a><span id="l6.49"> {</span>
<a href="#l6.50"></a><span id="l6.50" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aLocalFile);</span>
<a href="#l6.51"></a><span id="l6.51">   nsresult rv;</span>
<a href="#l6.52"></a><span id="l6.52">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l6.53"></a><span id="l6.53">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.54"></a><span id="l6.54"> </span>
<a href="#l6.55"></a><span id="l6.55" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; file = do_QueryInterface(aLocalFile, &amp;rv);</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-</span>
<a href="#l6.58"></a><span id="l6.58">   // if the file is a directory, just use it for the last dir chosen</span>
<a href="#l6.59"></a><span id="l6.59">   // otherwise, use the parent of the file as the last dir chosen.</span>
<a href="#l6.60"></a><span id="l6.60">   // IsDirectory() will return error on saving a file, as the</span>
<a href="#l6.61"></a><span id="l6.61">   // file doesn't exist yet.</span>
<a href="#l6.62"></a><span id="l6.62">   bool isDirectory;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  rv = file-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  rv = aLocalFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l6.65"></a><span id="l6.65">   if (NS_SUCCEEDED(rv) &amp;&amp; isDirectory) {</span>
<a href="#l6.66"></a><span id="l6.66">     rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME, NS_GET_IID(nsIFile), aLocalFile);</span>
<a href="#l6.67"></a><span id="l6.67">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.68"></a><span id="l6.68">   }</span>
<a href="#l6.69"></a><span id="l6.69">   else {</span>
<a href="#l6.70"></a><span id="l6.70">     nsCOMPtr &lt;nsIFile&gt; parent;</span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-    rv = file-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+    rv = aLocalFile-&gt;GetParent(getter_AddRefs(parent));</span>
<a href="#l6.73"></a><span id="l6.73">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75">     rv = prefBranch-&gt;SetComplexValue(MESSENGER_SAVE_DIR_PREF_NAME, NS_GET_IID(nsIFile), parent);</span>
<a href="#l6.76"></a><span id="l6.76">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l6.77"></a><span id="l6.77">   }</span>
<a href="#l6.78"></a><span id="l6.78">   return NS_OK;</span>
<a href="#l6.79"></a><span id="l6.79"> }</span>
<a href="#l6.80"></a><span id="l6.80"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -1595,106 +1595,101 @@ nsMsgAccountManager::CleanupOnExit()</span>
<a href="#l7.4"></a><span id="l7.4">     if (emptyTrashOnExit || cleanupInboxOnExit)</span>
<a href="#l7.5"></a><span id="l7.5">     {</span>
<a href="#l7.6"></a><span id="l7.6">       nsCOMPtr&lt;nsIMsgFolder&gt; root;</span>
<a href="#l7.7"></a><span id="l7.7">       server-&gt;GetRootFolder(getter_AddRefs(root));</span>
<a href="#l7.8"></a><span id="l7.8">       nsCString type;</span>
<a href="#l7.9"></a><span id="l7.9">       server-&gt;GetType(type);</span>
<a href="#l7.10"></a><span id="l7.10">       if (root)</span>
<a href="#l7.11"></a><span id="l7.11">       {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-        folder = do_QueryInterface(root);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-        if (folder)</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+        nsString passwd;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+        bool serverRequiresPasswordForAuthentication = true;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+        bool isImap = type.EqualsLiteral(&quot;imap&quot;);</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+        if (isImap)</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+        {</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+          server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPasswordForAuthentication);</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+          server-&gt;GetPassword(passwd);</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineplus">+        }</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+        if (!isImap || (isImap &amp;&amp; (!serverRequiresPasswordForAuthentication || !passwd.IsEmpty())))</span>
<a href="#l7.24"></a><span id="l7.24">         {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-          nsString passwd;</span>
<a href="#l7.26"></a><span id="l7.26" class="difflineminus">-          bool serverRequiresPasswordForAuthentication = true;</span>
<a href="#l7.27"></a><span id="l7.27" class="difflineminus">-          bool isImap = type.EqualsLiteral(&quot;imap&quot;);</span>
<a href="#l7.28"></a><span id="l7.28" class="difflineplus">+          nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineplus">+          nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+                   do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+          if (NS_FAILED(rv))</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+            continue;</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+</span>
<a href="#l7.34"></a><span id="l7.34">           if (isImap)</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+            urlListener = do_QueryInterface(accountManager, &amp;rv);</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+          if (isImap &amp;&amp; cleanupInboxOnExit)</span>
<a href="#l7.38"></a><span id="l7.38">           {</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-            server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPasswordForAuthentication);</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-            server-&gt;GetPassword(passwd);</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-          }</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-          if (!isImap || (isImap &amp;&amp; (!serverRequiresPasswordForAuthentication || !passwd.IsEmpty())))</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-          {</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineminus">-            nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineminus">-            nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineminus">-                     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-              continue;</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineminus">-</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-            if (isImap)</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-              urlListener = do_QueryInterface(accountManager, &amp;rv);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-            if (isImap &amp;&amp; cleanupInboxOnExit)</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+            nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+            rv = root-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+            if (NS_SUCCEEDED(rv))</span>
<a href="#l7.57"></a><span id="l7.57">             {</span>
<a href="#l7.58"></a><span id="l7.58" class="difflineminus">-              nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-              rv = folder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-              if (NS_SUCCEEDED(rv))</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+              bool hasMore;</span>
<a href="#l7.62"></a><span id="l7.62" class="difflineplus">+              while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineplus">+                     hasMore)</span>
<a href="#l7.64"></a><span id="l7.64">               {</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineminus">-                bool hasMore;</span>
<a href="#l7.66"></a><span id="l7.66" class="difflineminus">-                while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l7.67"></a><span id="l7.67" class="difflineminus">-                       hasMore)</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineplus">+                nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+                enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineplus">+</span>
<a href="#l7.71"></a><span id="l7.71" class="difflineplus">+                nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder(do_QueryInterface(item));</span>
<a href="#l7.72"></a><span id="l7.72" class="difflineplus">+                if (!inboxFolder)</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+                  continue;</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+                uint32_t flags;</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+                inboxFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+                if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l7.78"></a><span id="l7.78">                 {</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-                  nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-                  enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineminus">-                  nsCOMPtr&lt;nsIMsgFolder&gt; inboxFolder(do_QueryInterface(item));</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineminus">-                  if (!inboxFolder)</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineminus">-                    continue;</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineminus">-                  uint32_t flags;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineminus">-                  inboxFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                  if (flags &amp; nsMsgFolderFlags::Inbox)</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineminus">-                  {</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-                    rv = inboxFolder-&gt;Compact(urlListener, nullptr /* msgwindow */);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineminus">-                    if (NS_SUCCEEDED(rv))</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineminus">-                      accountManager-&gt;SetFolderDoingCleanupInbox(inboxFolder);</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineminus">-                    break;</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineminus">-                  }</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+                  rv = inboxFolder-&gt;Compact(urlListener, nullptr /* msgwindow */);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+                  if (NS_SUCCEEDED(rv))</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+                    accountManager-&gt;SetFolderDoingCleanupInbox(inboxFolder);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+                  break;</span>
<a href="#l7.99"></a><span id="l7.99">                 }</span>
<a href="#l7.100"></a><span id="l7.100">               }</span>
<a href="#l7.101"></a><span id="l7.101">             }</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+          }</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105" class="difflineplus">+          if (emptyTrashOnExit)</span>
<a href="#l7.106"></a><span id="l7.106" class="difflineplus">+          {</span>
<a href="#l7.107"></a><span id="l7.107" class="difflineplus">+            rv = root-&gt;EmptyTrash(nullptr, urlListener);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineplus">+            if (isImap &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+              accountManager-&gt;SetFolderDoingEmptyTrash(root);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineplus">+          }</span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+          if (isImap &amp;&amp; urlListener)</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+          {</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+            nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+</span>
<a href="#l7.116"></a><span id="l7.116" class="difflineplus">+            bool inProgress = false;</span>
<a href="#l7.117"></a><span id="l7.117" class="difflineplus">+            if (cleanupInboxOnExit)</span>
<a href="#l7.118"></a><span id="l7.118" class="difflineplus">+            {</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineplus">+              int32_t loopCount = 0; // used to break out after 5 seconds</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineplus">+              accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+              while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l7.122"></a><span id="l7.122" class="difflineplus">+              {</span>
<a href="#l7.123"></a><span id="l7.123" class="difflineplus">+                accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineplus">+                PR_CEnterMonitor(root);</span>
<a href="#l7.125"></a><span id="l7.125" class="difflineplus">+                PR_CWait(root, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.126"></a><span id="l7.126" class="difflineplus">+                PR_CExitMonitor(root);</span>
<a href="#l7.127"></a><span id="l7.127" class="difflineplus">+                NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.128"></a><span id="l7.128" class="difflineplus">+              }</span>
<a href="#l7.129"></a><span id="l7.129" class="difflineplus">+            }</span>
<a href="#l7.130"></a><span id="l7.130">             if (emptyTrashOnExit)</span>
<a href="#l7.131"></a><span id="l7.131">             {</span>
<a href="#l7.132"></a><span id="l7.132" class="difflineminus">-              rv = folder-&gt;EmptyTrash(nullptr, urlListener);</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-              if (isImap &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineminus">-                accountManager-&gt;SetFolderDoingEmptyTrash(folder);</span>
<a href="#l7.135"></a><span id="l7.135" class="difflineminus">-            }</span>
<a href="#l7.136"></a><span id="l7.136" class="difflineminus">-</span>
<a href="#l7.137"></a><span id="l7.137" class="difflineminus">-            if (isImap &amp;&amp; urlListener)</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-            {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-              nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-              bool inProgress = false;</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-              if (cleanupInboxOnExit)</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-              {</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-                int32_t loopCount = 0; // used to break out after 5 seconds</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineminus">-                accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineminus">-                while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineminus">-                {</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineminus">-                  accountManager-&gt;GetCleanupInboxInProgress(&amp;inProgress);</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineminus">-                  PR_CEnterMonitor(folder);</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineminus">-                  PR_CWait(folder, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineminus">-                  PR_CExitMonitor(folder);</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineminus">-                  NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineminus">-                }</span>
<a href="#l7.154"></a><span id="l7.154" class="difflineminus">-              }</span>
<a href="#l7.155"></a><span id="l7.155" class="difflineminus">-              if (emptyTrashOnExit)</span>
<a href="#l7.156"></a><span id="l7.156" class="difflineplus">+              accountManager-&gt;GetEmptyTrashInProgress(&amp;inProgress);</span>
<a href="#l7.157"></a><span id="l7.157" class="difflineplus">+              int32_t loopCount = 0;</span>
<a href="#l7.158"></a><span id="l7.158" class="difflineplus">+              while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l7.159"></a><span id="l7.159">               {</span>
<a href="#l7.160"></a><span id="l7.160">                 accountManager-&gt;GetEmptyTrashInProgress(&amp;inProgress);</span>
<a href="#l7.161"></a><span id="l7.161" class="difflineminus">-                int32_t loopCount = 0;</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineminus">-                while (inProgress &amp;&amp; loopCount++ &lt; 5000)</span>
<a href="#l7.163"></a><span id="l7.163" class="difflineminus">-                {</span>
<a href="#l7.164"></a><span id="l7.164" class="difflineminus">-                  accountManager-&gt;GetEmptyTrashInProgress(&amp;inProgress);</span>
<a href="#l7.165"></a><span id="l7.165" class="difflineminus">-                  PR_CEnterMonitor(folder);</span>
<a href="#l7.166"></a><span id="l7.166" class="difflineminus">-                  PR_CWait(folder, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.167"></a><span id="l7.167" class="difflineminus">-                  PR_CExitMonitor(folder);</span>
<a href="#l7.168"></a><span id="l7.168" class="difflineminus">-                  NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.169"></a><span id="l7.169" class="difflineminus">-                }</span>
<a href="#l7.170"></a><span id="l7.170" class="difflineplus">+                PR_CEnterMonitor(root);</span>
<a href="#l7.171"></a><span id="l7.171" class="difflineplus">+                PR_CWait(root, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineplus">+                PR_CExitMonitor(root);</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineplus">+                NS_ProcessPendingEvents(thread, PR_MicrosecondsToInterval(1000UL));</span>
<a href="#l7.174"></a><span id="l7.174">               }</span>
<a href="#l7.175"></a><span id="l7.175">             }</span>
<a href="#l7.176"></a><span id="l7.176">           }</span>
<a href="#l7.177"></a><span id="l7.177">         }</span>
<a href="#l7.178"></a><span id="l7.178">       }</span>
<a href="#l7.179"></a><span id="l7.179">     }</span>
<a href="#l7.180"></a><span id="l7.180">   }</span>
<a href="#l7.181"></a><span id="l7.181"> </span>
<a href="#l7.182"></a><span id="l7.182" class="difflineat">@@ -2316,31 +2311,29 @@ nsMsgAccountManager::CreateLocalMailAcco</span>
<a href="#l7.183"></a><span id="l7.183">   nsCOMPtr&lt;nsINoIncomingServer&gt; noServer;</span>
<a href="#l7.184"></a><span id="l7.184">   noServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l7.185"></a><span id="l7.185">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.186"></a><span id="l7.186"> </span>
<a href="#l7.187"></a><span id="l7.187">   // create the directory structure for old 4.x &quot;Local Mail&quot;</span>
<a href="#l7.188"></a><span id="l7.188">   // under &lt;profile dir&gt;/Mail/Local Folders or</span>
<a href="#l7.189"></a><span id="l7.189">   // &lt;&quot;mail.directory&quot; pref&gt;/Local Folders</span>
<a href="#l7.190"></a><span id="l7.190">   nsCOMPtr &lt;nsIFile&gt; mailDir;</span>
<a href="#l7.191"></a><span id="l7.191" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; localFile;</span>
<a href="#l7.192"></a><span id="l7.192">   bool dirExists;</span>
<a href="#l7.193"></a><span id="l7.193"> </span>
<a href="#l7.194"></a><span id="l7.194">   // we want &lt;profile&gt;/Mail</span>
<a href="#l7.195"></a><span id="l7.195">   rv = NS_GetSpecialDirectory(NS_APP_MAIL_50_DIR, getter_AddRefs(mailDir));</span>
<a href="#l7.196"></a><span id="l7.196">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.197"></a><span id="l7.197" class="difflineminus">-  localFile = do_QueryInterface(mailDir);</span>
<a href="#l7.198"></a><span id="l7.198"> </span>
<a href="#l7.199"></a><span id="l7.199">   rv = mailDir-&gt;Exists(&amp;dirExists);</span>
<a href="#l7.200"></a><span id="l7.200">   if (NS_SUCCEEDED(rv) &amp;&amp; !dirExists)</span>
<a href="#l7.201"></a><span id="l7.201">     rv = mailDir-&gt;Create(nsIFile::DIRECTORY_TYPE, 0775);</span>
<a href="#l7.202"></a><span id="l7.202">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.203"></a><span id="l7.203"> </span>
<a href="#l7.204"></a><span id="l7.204">   // set the default local path for &quot;none&quot;</span>
<a href="#l7.205"></a><span id="l7.205" class="difflineminus">-  rv = server-&gt;SetDefaultLocalPath(localFile);</span>
<a href="#l7.206"></a><span id="l7.206" class="difflineplus">+  rv = server-&gt;SetDefaultLocalPath(mailDir);</span>
<a href="#l7.207"></a><span id="l7.207">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.208"></a><span id="l7.208"> </span>
<a href="#l7.209"></a><span id="l7.209">   // Create an account when valid server values are established.</span>
<a href="#l7.210"></a><span id="l7.210">   // This will keep the status of accounts sane by avoiding the addition of incomplete accounts.</span>
<a href="#l7.211"></a><span id="l7.211">   nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l7.212"></a><span id="l7.212">   rv = CreateAccount(getter_AddRefs(account));</span>
<a href="#l7.213"></a><span id="l7.213">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l7.214"></a><span id="l7.214"> </span>
<a href="#l7.215"></a><span id="l7.215" class="difflineat">@@ -2888,25 +2881,25 @@ nsresult VirtualFolderChangeListener::Po</span>
<a href="#l7.216"></a><span id="l7.216"> void VirtualFolderChangeListener::ProcessUpdateEvent(nsIMsgFolder *virtFolder,</span>
<a href="#l7.217"></a><span id="l7.217">                                                      nsIMsgDatabase *virtDB)</span>
<a href="#l7.218"></a><span id="l7.218"> {</span>
<a href="#l7.219"></a><span id="l7.219">   m_batchingEvents = false;</span>
<a href="#l7.220"></a><span id="l7.220">   virtFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l7.221"></a><span id="l7.221">   virtDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l7.222"></a><span id="l7.222"> }</span>
<a href="#l7.223"></a><span id="l7.223"> </span>
<a href="#l7.224"></a><span id="l7.224" class="difflineminus">-nsresult nsMsgAccountManager::GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt;&amp; file)</span>
<a href="#l7.225"></a><span id="l7.225" class="difflineplus">+nsresult nsMsgAccountManager::GetVirtualFoldersFile(nsCOMPtr&lt;nsIFile&gt;&amp; aFile)</span>
<a href="#l7.226"></a><span id="l7.226"> {</span>
<a href="#l7.227"></a><span id="l7.227">   nsCOMPtr&lt;nsIFile&gt; profileDir;</span>
<a href="#l7.228"></a><span id="l7.228">   nsresult rv = NS_GetSpecialDirectory(NS_APP_USER_PROFILE_50_DIR, getter_AddRefs(profileDir));</span>
<a href="#l7.229"></a><span id="l7.229">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.230"></a><span id="l7.230"> </span>
<a href="#l7.231"></a><span id="l7.231">   rv = profileDir-&gt;AppendNative(nsDependentCString(&quot;virtualFolders.dat&quot;));</span>
<a href="#l7.232"></a><span id="l7.232">   if (NS_SUCCEEDED(rv))</span>
<a href="#l7.233"></a><span id="l7.233" class="difflineminus">-    file = do_QueryInterface(profileDir, &amp;rv);</span>
<a href="#l7.234"></a><span id="l7.234" class="difflineplus">+    aFile = profileDir;</span>
<a href="#l7.235"></a><span id="l7.235">   return rv;</span>
<a href="#l7.236"></a><span id="l7.236"> }</span>
<a href="#l7.237"></a><span id="l7.237"> </span>
<a href="#l7.238"></a><span id="l7.238"> NS_IMETHODIMP nsMsgAccountManager::LoadVirtualFolders()</span>
<a href="#l7.239"></a><span id="l7.239"> {</span>
<a href="#l7.240"></a><span id="l7.240">   nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l7.241"></a><span id="l7.241">   GetVirtualFoldersFile(file);</span>
<a href="#l7.242"></a><span id="l7.242">   if (!file)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -781,18 +781,17 @@ void nsMsgContentPolicy::ComposeShouldLo</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> already_AddRefed&lt;nsIMsgCompose&gt; nsMsgContentPolicy::GetMsgComposeForContext(nsISupports *aRequestingContext)</span>
<a href="#l8.6"></a><span id="l8.6"> {</span>
<a href="#l8.7"></a><span id="l8.7">   nsresult rv;</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l8.10"></a><span id="l8.10">   if (!shell)</span>
<a href="#l8.11"></a><span id="l8.11">     return nullptr;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem(do_QueryInterface(shell, &amp;rv));</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellTreeItem(shell);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l8.17"></a><span id="l8.17">   rv = docShellTreeItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootItem));</span>
<a href="#l8.18"></a><span id="l8.18">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l8.19"></a><span id="l8.19"> </span>
<a href="#l8.20"></a><span id="l8.20">   nsCOMPtr&lt;nsIDocShell&gt; docShell(do_QueryInterface(rootItem, &amp;rv));</span>
<a href="#l8.21"></a><span id="l8.21">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23" class="difflineat">@@ -838,18 +837,17 @@ nsresult nsMsgContentPolicy::SetDisableI</span>
<a href="#l8.24"></a><span id="l8.24">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26">   RefPtr&lt;nsFrameLoader&gt; frameLoader = flOwner-&gt;GetFrameLoader();</span>
<a href="#l8.27"></a><span id="l8.27">   NS_ENSURE_TRUE(frameLoader, NS_ERROR_INVALID_POINTER);</span>
<a href="#l8.28"></a><span id="l8.28"> </span>
<a href="#l8.29"></a><span id="l8.29">   nsCOMPtr&lt;nsIDocShell&gt; docShell = frameLoader-&gt;GetDocShell(mozilla::IgnoreErrors());</span>
<a href="#l8.30"></a><span id="l8.30">   NS_ENSURE_TRUE(docShell, NS_ERROR_INVALID_POINTER);</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(do_QueryInterface(docShell, &amp;rv));</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(docShell);</span>
<a href="#l8.35"></a><span id="l8.35"> </span>
<a href="#l8.36"></a><span id="l8.36">   // what sort of docshell is this?</span>
<a href="#l8.37"></a><span id="l8.37">   int32_t itemType;</span>
<a href="#l8.38"></a><span id="l8.38">   rv = docshellTreeItem-&gt;GetItemType(&amp;itemType);</span>
<a href="#l8.39"></a><span id="l8.39">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41">   // we're only worried about policy settings in content docshells</span>
<a href="#l8.42"></a><span id="l8.42">   if (itemType != nsIDocShellTreeItem::typeContent) {</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineat">@@ -891,18 +889,18 @@ nsresult nsMsgContentPolicy::SetDisableI</span>
<a href="#l8.44"></a><span id="l8.44"> nsresult</span>
<a href="#l8.45"></a><span id="l8.45"> nsMsgContentPolicy::GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l8.46"></a><span id="l8.46">                                               nsIDocShell **aDocShell)</span>
<a href="#l8.47"></a><span id="l8.47"> {</span>
<a href="#l8.48"></a><span id="l8.48">   NS_ENSURE_ARG_POINTER(aRequestingContext);</span>
<a href="#l8.49"></a><span id="l8.49">   nsresult rv;</span>
<a href="#l8.50"></a><span id="l8.50"> </span>
<a href="#l8.51"></a><span id="l8.51">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(do_QueryInterface(shell, &amp;rv));</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+  NS_ENSURE_TRUE(shell, NS_ERROR_NULL_POINTER);</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(shell);</span>
<a href="#l8.56"></a><span id="l8.56"> </span>
<a href="#l8.57"></a><span id="l8.57">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l8.58"></a><span id="l8.58">   rv = docshellTreeItem-&gt;GetRootTreeItem(getter_AddRefs(rootItem));</span>
<a href="#l8.59"></a><span id="l8.59">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61">   return CallQueryInterface(rootItem, aDocShell);</span>
<a href="#l8.62"></a><span id="l8.62"> }</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64" class="difflineat">@@ -921,18 +919,17 @@ nsMsgContentPolicy::GetOriginatingURIFor</span>
<a href="#l8.65"></a><span id="l8.65">   NS_ENSURE_ARG_POINTER(aRequestingContext);</span>
<a href="#l8.66"></a><span id="l8.66">   nsresult rv;</span>
<a href="#l8.67"></a><span id="l8.67"> </span>
<a href="#l8.68"></a><span id="l8.68">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l8.69"></a><span id="l8.69">   if (!shell) {</span>
<a href="#l8.70"></a><span id="l8.70">     *aURI = nullptr;</span>
<a href="#l8.71"></a><span id="l8.71">     return NS_OK;</span>
<a href="#l8.72"></a><span id="l8.72">   }</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(do_QueryInterface(shell, &amp;rv));</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(shell);</span>
<a href="#l8.76"></a><span id="l8.76"> </span>
<a href="#l8.77"></a><span id="l8.77">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootItem;</span>
<a href="#l8.78"></a><span id="l8.78">   rv = docshellTreeItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootItem));</span>
<a href="#l8.79"></a><span id="l8.79">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81">   nsCOMPtr&lt;nsIWebNavigation&gt; webNavigation(do_QueryInterface(rootItem, &amp;rv));</span>
<a href="#l8.82"></a><span id="l8.82">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.83"></a><span id="l8.83"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCache.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCache.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -335,17 +335,17 @@ NS_IMETHODIMP nsMsgFolderCache::Commit(b</span>
<a href="#l9.4"></a><span id="l9.4">     GetEnv()-&gt;ClearErrors();</span>
<a href="#l9.5"></a><span id="l9.5">   return ret;</span>
<a href="#l9.6"></a><span id="l9.6"> }</span>
<a href="#l9.7"></a><span id="l9.7"> </span>
<a href="#l9.8"></a><span id="l9.8"> nsresult nsMsgFolderCache::AddCacheElement(const nsACString&amp; key, nsIMdbRow *row, nsIMsgFolderCacheElement **result)</span>
<a href="#l9.9"></a><span id="l9.9"> {</span>
<a href="#l9.10"></a><span id="l9.10">   nsMsgFolderCacheElement *cacheElement = new nsMsgFolderCacheElement;</span>
<a href="#l9.11"></a><span id="l9.11">   NS_ENSURE_TRUE(cacheElement, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; folderCacheEl(do_QueryInterface(cacheElement));</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCacheElement&gt; folderCacheEl = cacheElement;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   cacheElement-&gt;SetMDBRow(row);</span>
<a href="#l9.16"></a><span id="l9.16">   cacheElement-&gt;SetOwningCache(this);</span>
<a href="#l9.17"></a><span id="l9.17">   nsCString hashStrKey(key);</span>
<a href="#l9.18"></a><span id="l9.18">   // if caller didn't pass in key, try to get it from row.</span>
<a href="#l9.19"></a><span id="l9.19">   if (key.IsEmpty())</span>
<a href="#l9.20"></a><span id="l9.20">     folderCacheEl-&gt;GetStringProperty(&quot;key&quot;, hashStrKey);</span>
<a href="#l9.21"></a><span id="l9.21">   folderCacheEl-&gt;SetKey(hashStrKey);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -329,17 +329,17 @@ nsMsgGroupThread *nsMsgGroupView::AddHdr</span>
<a href="#l10.4"></a><span id="l10.4">       *pNewThread = newThread = true;</span>
<a href="#l10.5"></a><span id="l10.5">     }</span>
<a href="#l10.6"></a><span id="l10.6">   }</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   // If the thread does not already exist, create one</span>
<a href="#l10.9"></a><span id="l10.9">   if (!foundThread)</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11">     foundThread = CreateGroupThread(m_db);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    msgThread = do_QueryInterface(foundThread);</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    msgThread = foundThread;</span>
<a href="#l10.14"></a><span id="l10.14">     m_groupsTable.Put(hashKey, msgThread);</span>
<a href="#l10.15"></a><span id="l10.15">     if (GroupViewUsesDummyRow())</span>
<a href="#l10.16"></a><span id="l10.16">     {</span>
<a href="#l10.17"></a><span id="l10.17">       foundThread-&gt;m_dummy = true;</span>
<a href="#l10.18"></a><span id="l10.18">       msgFlags |=  MSG_VIEW_FLAG_DUMMY | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l10.19"></a><span id="l10.19">     }</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21">     viewIndexOfThread = GetInsertIndex(msgHdr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -226,18 +226,17 @@ nsMsgPrintEngine::SetWindow(mozIDOMWindo</span>
<a href="#l11.4"></a><span id="l11.4"> </span>
<a href="#l11.5"></a><span id="l11.5">   mWindow = aWin;</span>
<a href="#l11.6"></a><span id="l11.6"> </span>
<a href="#l11.7"></a><span id="l11.7">   NS_ENSURE_TRUE(mWindow, NS_ERROR_FAILURE);</span>
<a href="#l11.8"></a><span id="l11.8">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_MAIL);</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem =</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-    do_QueryInterface(window-&gt;GetDocShell());</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem =  window-&gt;GetDocShell();</span>
<a href="#l11.15"></a><span id="l11.15">   NS_ENSURE_TRUE(docShellAsItem, NS_ERROR_FAILURE);</span>
<a href="#l11.16"></a><span id="l11.16"> </span>
<a href="#l11.17"></a><span id="l11.17">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootAsItem;</span>
<a href="#l11.18"></a><span id="l11.18">   docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootAsItem));</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; childItem;</span>
<a href="#l11.21"></a><span id="l11.21">   rootAsItem-&gt;FindChildWithName(NS_LITERAL_STRING(&quot;content&quot;), true,</span>
<a href="#l11.22"></a><span id="l11.22">         false, nullptr, nullptr,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineat">@@ -262,19 +261,18 @@ NS_IMETHODIMP nsMsgPrintEngine::SetParen</span>
<a href="#l11.24"></a><span id="l11.24"> NS_IMETHODIMP</span>
<a href="#l11.25"></a><span id="l11.25"> nsMsgPrintEngine::ShowWindow(bool aShow)</span>
<a href="#l11.26"></a><span id="l11.26"> {</span>
<a href="#l11.27"></a><span id="l11.27">   nsresult rv;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">   NS_ENSURE_TRUE(mWindow, NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-  nsCOMPtr &lt;nsIDocShellTreeItem&gt; treeItem =</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-    do_QueryInterface(window-&gt;GetDocShell(), &amp;rv);</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem = window-&gt;GetDocShell();</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+  NS_ENSURE_TRUE(treeItem, NS_ERROR_NULL_POINTER);</span>
<a href="#l11.37"></a><span id="l11.37"> </span>
<a href="#l11.38"></a><span id="l11.38">   nsCOMPtr &lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l11.39"></a><span id="l11.39">   rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l11.40"></a><span id="l11.40">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42">   if (treeOwner) {</span>
<a href="#l11.43"></a><span id="l11.43">     // disable (enable) the window</span>
<a href="#l11.44"></a><span id="l11.44">     nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineat">@@ -353,17 +351,17 @@ nsMsgPrintEngine::ShowProgressDialog(boo</span>
<a href="#l11.46"></a><span id="l11.46">   // If we don't get a service, that's ok, then just don't show progress</span>
<a href="#l11.47"></a><span id="l11.47">   if (showProgressDialog) {</span>
<a href="#l11.48"></a><span id="l11.48">     if (!mPrintPromptService)</span>
<a href="#l11.49"></a><span id="l11.49">     {</span>
<a href="#l11.50"></a><span id="l11.50">       mPrintPromptService = do_GetService(kPrintingPromptService);</span>
<a href="#l11.51"></a><span id="l11.51">     }</span>
<a href="#l11.52"></a><span id="l11.52">     if (mPrintPromptService)</span>
<a href="#l11.53"></a><span id="l11.53">     {</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-      nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWin(do_QueryInterface(mParentWindow));</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+      nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWin = mParentWindow;</span>
<a href="#l11.56"></a><span id="l11.56">       if (!domWin)</span>
<a href="#l11.57"></a><span id="l11.57">       {</span>
<a href="#l11.58"></a><span id="l11.58">         domWin = mWindow;</span>
<a href="#l11.59"></a><span id="l11.59">       }</span>
<a href="#l11.60"></a><span id="l11.60"> </span>
<a href="#l11.61"></a><span id="l11.61">       rv = mPrintPromptService-&gt;ShowProgress(domWin, mWebBrowserPrint, mPrintSettings, this, aIsForPrinting,</span>
<a href="#l11.62"></a><span id="l11.62">                                             getter_AddRefs(mPrintProgressListener),</span>
<a href="#l11.63"></a><span id="l11.63">                                             getter_AddRefs(mPrintProgressParams),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -442,17 +442,17 @@ nsMsgSearchDBView::AddHdrFromFolder(nsIM</span>
<a href="#l12.4"></a><span id="l12.4">     bool newThread = !thread;</span>
<a href="#l12.5"></a><span id="l12.5">     nsMsgXFViewThread *viewThread;</span>
<a href="#l12.6"></a><span id="l12.6">     if (!thread)</span>
<a href="#l12.7"></a><span id="l12.7">     {</span>
<a href="#l12.8"></a><span id="l12.8">       viewThread = new nsMsgXFViewThread(this, m_nextThreadId++);</span>
<a href="#l12.9"></a><span id="l12.9">       if (!viewThread)</span>
<a href="#l12.10"></a><span id="l12.10">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l12.11"></a><span id="l12.11"> </span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-      thread = do_QueryInterface(viewThread);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+      thread = viewThread;</span>
<a href="#l12.14"></a><span id="l12.14">     }</span>
<a href="#l12.15"></a><span id="l12.15">     else</span>
<a href="#l12.16"></a><span id="l12.16">     {</span>
<a href="#l12.17"></a><span id="l12.17">       viewThread = static_cast&lt;nsMsgXFViewThread*&gt;(thread.get());</span>
<a href="#l12.18"></a><span id="l12.18">       thread-&gt;GetChildHdrAt(0, getter_AddRefs(threadRoot));</span>
<a href="#l12.19"></a><span id="l12.19">     }</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">     AddMsgToHashTables(msgHdr, thread);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgWindow.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -330,17 +330,17 @@ NS_IMETHODIMP nsMsgWindow::SetDomWindow(</span>
<a href="#l13.4"></a><span id="l13.4">   NS_ENSURE_ARG_POINTER(aWindow);</span>
<a href="#l13.5"></a><span id="l13.5">   mDomWindow = do_GetWeakReference(aWindow);</span>
<a href="#l13.6"></a><span id="l13.6"> </span>
<a href="#l13.7"></a><span id="l13.7">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; win = nsPIDOMWindowOuter::From(aWindow);</span>
<a href="#l13.8"></a><span id="l13.8">   nsIDocShell *docShell = nullptr;</span>
<a href="#l13.9"></a><span id="l13.9">   if (win)</span>
<a href="#l13.10"></a><span id="l13.10">     docShell = win-&gt;GetDocShell();</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(do_QueryInterface(docShell));</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+  nsCOMPtr&lt;nsIDocShellTreeItem&gt; docShellAsItem(docShell);</span>
<a href="#l13.14"></a><span id="l13.14"> </span>
<a href="#l13.15"></a><span id="l13.15">   if(docShellAsItem)</span>
<a href="#l13.16"></a><span id="l13.16">   {</span>
<a href="#l13.17"></a><span id="l13.17">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; rootAsItem;</span>
<a href="#l13.18"></a><span id="l13.18">     docShellAsItem-&gt;GetSameTypeRootTreeItem(getter_AddRefs(rootAsItem));</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20">     nsCOMPtr&lt;nsIDocShell&gt; rootAsShell(do_QueryInterface(rootAsItem));</span>
<a href="#l13.21"></a><span id="l13.21">     SetRootDocShell(rootAsShell);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/util/nsImapMoveCoalescer.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -116,17 +116,17 @@ nsresult nsImapMoveCoalescer::PlaybackMo</span>
<a href="#l14.4"></a><span id="l14.4">     nsCOMPtr&lt;nsIMsgCopyService&gt; copySvc = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l14.5"></a><span id="l14.5">     if (copySvc)</span>
<a href="#l14.6"></a><span id="l14.6">     {</span>
<a href="#l14.7"></a><span id="l14.7">       nsCOMPtr &lt;nsIMsgCopyServiceListener&gt; listener;</span>
<a href="#l14.8"></a><span id="l14.8">       if (m_doNewMailNotification)</span>
<a href="#l14.9"></a><span id="l14.9">       {</span>
<a href="#l14.10"></a><span id="l14.10">         nsMoveCoalescerCopyListener *copyListener = new nsMoveCoalescerCopyListener(this, destFolder);</span>
<a href="#l14.11"></a><span id="l14.11">         if (copyListener)</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-          listener = do_QueryInterface(copyListener);</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+          listener = copyListener;</span>
<a href="#l14.14"></a><span id="l14.14">       }</span>
<a href="#l14.15"></a><span id="l14.15">       rv = copySvc-&gt;CopyMessages(m_sourceFolder, messages, destFolder, true,</span>
<a href="#l14.16"></a><span id="l14.16">                                  listener, m_msgWindow, false /*allowUndo*/);</span>
<a href="#l14.17"></a><span id="l14.17">       if (NS_SUCCEEDED(rv))</span>
<a href="#l14.18"></a><span id="l14.18">         m_outstandingMoves++;</span>
<a href="#l14.19"></a><span id="l14.19">     }</span>
<a href="#l14.20"></a><span id="l14.20">   }</span>
<a href="#l14.21"></a><span id="l14.21">   return rv;</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -208,18 +208,17 @@ NS_IMETHODIMP nsMoveCoalescerCopyListene</span>
<a href="#l14.23"></a><span id="l14.23">     {</span>
<a href="#l14.24"></a><span id="l14.24">       uint32_t folderFlags;</span>
<a href="#l14.25"></a><span id="l14.25">       m_destFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l14.26"></a><span id="l14.26">       if (!(folderFlags &amp; (nsMsgFolderFlags::Junk | nsMsgFolderFlags::Trash)))</span>
<a href="#l14.27"></a><span id="l14.27">       {</span>
<a href="#l14.28"></a><span id="l14.28">         nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l14.29"></a><span id="l14.29">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.30"></a><span id="l14.30">         nsCOMPtr &lt;nsIURI&gt; url;</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-        nsCOMPtr &lt;nsIUrlListener&gt; listener = do_QueryInterface(m_coalescer);</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-        rv = imapService-&gt;SelectFolder(m_destFolder, listener, nullptr, getter_AddRefs(url));</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+        rv = imapService-&gt;SelectFolder(m_destFolder, m_coalescer, nullptr, getter_AddRefs(url));</span>
<a href="#l14.34"></a><span id="l14.34">       }</span>
<a href="#l14.35"></a><span id="l14.35">     }</span>
<a href="#l14.36"></a><span id="l14.36">     else // give junk filters a chance to run on new msgs in destination local folder</span>
<a href="#l14.37"></a><span id="l14.37">     {</span>
<a href="#l14.38"></a><span id="l14.38">       bool filtersRun;</span>
<a href="#l14.39"></a><span id="l14.39">       m_destFolder-&gt;CallFilterPlugins(nullptr, &amp;filtersRun);</span>
<a href="#l14.40"></a><span id="l14.40">     }</span>
<a href="#l14.41"></a><span id="l14.41">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -3058,29 +3058,25 @@ NS_IMETHODIMP nsMsgDBFolder::RemoveFolde</span>
<a href="#l15.4"></a><span id="l15.4"> }</span>
<a href="#l15.5"></a><span id="l15.5"> </span>
<a href="#l15.6"></a><span id="l15.6"> NS_IMETHODIMP nsMsgDBFolder::SetParent(nsIMsgFolder *aParent)</span>
<a href="#l15.7"></a><span id="l15.7"> {</span>
<a href="#l15.8"></a><span id="l15.8">   mParent = do_GetWeakReference(aParent);</span>
<a href="#l15.9"></a><span id="l15.9">   if (aParent)</span>
<a href="#l15.10"></a><span id="l15.10">   {</span>
<a href="#l15.11"></a><span id="l15.11">     nsresult rv;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; parentMsgFolder = do_QueryInterface(aParent, &amp;rv);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineminus">-    {</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineminus">-      // servers do not have parents, so we must not be a server</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-      mIsServer = false;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-      mIsServerIsValid = true;</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineminus">-      // also set the server itself while we're here.</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineminus">-      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineminus">-      rv = parentMsgFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineminus">-        mServer = do_GetWeakReference(server);</span>
<a href="#l15.24"></a><span id="l15.24" class="difflineminus">-    }</span>
<a href="#l15.25"></a><span id="l15.25" class="difflineplus">+    // servers do not have parents, so we must not be a server</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineplus">+    mIsServer = false;</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineplus">+    mIsServerIsValid = true;</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+    // also set the server itself while we're here.</span>
<a href="#l15.30"></a><span id="l15.30" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineplus">+    rv = aParent-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+      mServer = do_GetWeakReference(server);</span>
<a href="#l15.34"></a><span id="l15.34">   }</span>
<a href="#l15.35"></a><span id="l15.35">   return NS_OK;</span>
<a href="#l15.36"></a><span id="l15.36"> }</span>
<a href="#l15.37"></a><span id="l15.37"> </span>
<a href="#l15.38"></a><span id="l15.38"> NS_IMETHODIMP nsMsgDBFolder::GetParent(nsIMsgFolder **aParent)</span>
<a href="#l15.39"></a><span id="l15.39"> {</span>
<a href="#l15.40"></a><span id="l15.40">   NS_ENSURE_ARG_POINTER(aParent);</span>
<a href="#l15.41"></a><span id="l15.41">   nsCOMPtr&lt;nsIMsgFolder&gt; parent = do_QueryReferent(mParent);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -235,19 +235,17 @@ NS_IMETHODIMP nsMsgIncomingServer::SetPe</span>
<a href="#l16.4"></a><span id="l16.4"> </span>
<a href="#l16.5"></a><span id="l16.5"> NS_IMPL_GETSET(nsMsgIncomingServer, BiffState, uint32_t, m_biffState)</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7"> NS_IMETHODIMP nsMsgIncomingServer::WriteToFolderCache(nsIMsgFolderCache *folderCache)</span>
<a href="#l16.8"></a><span id="l16.8"> {</span>
<a href="#l16.9"></a><span id="l16.9">   nsresult rv = NS_OK;</span>
<a href="#l16.10"></a><span id="l16.10">   if (m_rootFolder)</span>
<a href="#l16.11"></a><span id="l16.11">   {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(m_rootFolder, &amp;rv);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; msgFolder)</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-      rv = msgFolder-&gt;WriteToFolderCache(folderCache, true /* deep */);</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+    rv = m_rootFolder-&gt;WriteToFolderCache(folderCache, true /* deep */);</span>
<a href="#l16.16"></a><span id="l16.16">   }</span>
<a href="#l16.17"></a><span id="l16.17">   return rv;</span>
<a href="#l16.18"></a><span id="l16.18"> }</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20"> NS_IMETHODIMP</span>
<a href="#l16.21"></a><span id="l16.21"> nsMsgIncomingServer::Shutdown()</span>
<a href="#l16.22"></a><span id="l16.22"> {</span>
<a href="#l16.23"></a><span id="l16.23">   nsresult rv = CloseCachedConnections();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgMailNewsUrl.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -346,17 +346,17 @@ NS_IMETHODIMP nsMsgMailNewsUrl::IsUrlTyp</span>
<a href="#l17.4"></a><span id="l17.4">   *isType = false;</span>
<a href="#l17.5"></a><span id="l17.5">   return NS_OK;</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> }</span>
<a href="#l17.8"></a><span id="l17.8"> </span>
<a href="#l17.9"></a><span id="l17.9"> NS_IMETHODIMP nsMsgMailNewsUrl::SetSearchSession(nsIMsgSearchSession *aSearchSession)</span>
<a href="#l17.10"></a><span id="l17.10"> {</span>
<a href="#l17.11"></a><span id="l17.11">   if (aSearchSession)</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    m_searchSession = do_QueryInterface(aSearchSession);</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+    m_searchSession = aSearchSession;</span>
<a href="#l17.14"></a><span id="l17.14">   return NS_OK;</span>
<a href="#l17.15"></a><span id="l17.15"> }</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17"> NS_IMETHODIMP nsMsgMailNewsUrl::GetSearchSession(nsIMsgSearchSession **aSearchSession)</span>
<a href="#l17.18"></a><span id="l17.18"> {</span>
<a href="#l17.19"></a><span id="l17.19">   NS_ENSURE_ARG(aSearchSession);</span>
<a href="#l17.20"></a><span id="l17.20">   NS_IF_ADDREF(*aSearchSession = m_searchSession);</span>
<a href="#l17.21"></a><span id="l17.21">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgUtils.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1861,20 +1861,19 @@ MsgStreamMsgHeaders(nsIInputStream *aInp</span>
<a href="#l18.4"></a><span id="l18.4">     msgHeaders.Append(curLine);</span>
<a href="#l18.5"></a><span id="l18.5">     msgHeaders.AppendLiteral(&quot;\r\n&quot;);</span>
<a href="#l18.6"></a><span id="l18.6">   }</span>
<a href="#l18.7"></a><span id="l18.7">   lineBuffer = nullptr;</span>
<a href="#l18.8"></a><span id="l18.8">   nsCOMPtr&lt;nsIStringInputStream&gt; hdrsStream =</span>
<a href="#l18.9"></a><span id="l18.9">         do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<a href="#l18.10"></a><span id="l18.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.11"></a><span id="l18.11">   hdrsStream-&gt;SetData(msgHeaders.get(), msgHeaders.Length());</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  nsCOMPtr&lt;nsIInputStream&gt; stream(do_QueryInterface(hdrsStream));</span>
<a href="#l18.13"></a><span id="l18.13"> </span>
<a href="#l18.14"></a><span id="l18.14">   nsCOMPtr&lt;nsIInputStreamPump&gt; pump;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-  rv = NS_NewInputStreamPump(getter_AddRefs(pump), stream.forget());</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+  rv = NS_NewInputStreamPump(getter_AddRefs(pump), hdrsStream.forget());</span>
<a href="#l18.17"></a><span id="l18.17">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.18"></a><span id="l18.18"> </span>
<a href="#l18.19"></a><span id="l18.19">   return pump-&gt;AsyncRead(aConsumer, nullptr);</span>
<a href="#l18.20"></a><span id="l18.20"> }</span>
<a href="#l18.21"></a><span id="l18.21"> </span>
<a href="#l18.22"></a><span id="l18.22"> class CharsetDetectionObserver : public nsICharsetDetectionObserver</span>
<a href="#l18.23"></a><span id="l18.23"> {</span>
<a href="#l18.24"></a><span id="l18.24"> public:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -519,22 +519,20 @@ DONE:</span>
<a href="#l19.4"></a><span id="l19.4"> }</span>
<a href="#l19.5"></a><span id="l19.5"> </span>
<a href="#l19.6"></a><span id="l19.6"> nsresult</span>
<a href="#l19.7"></a><span id="l19.7"> nsMsgAttachmentHandler::PickCharset()</span>
<a href="#l19.8"></a><span id="l19.8"> {</span>
<a href="#l19.9"></a><span id="l19.9">   if (!m_charset.IsEmpty() || !m_type.LowerCaseEqualsLiteral(TEXT_PLAIN))</span>
<a href="#l19.10"></a><span id="l19.10">     return NS_OK;</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; tmpFile =</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-    do_QueryInterface(mTmpFile);</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-  if (!tmpFile)</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  if (!mTmpFile)</span>
<a href="#l19.16"></a><span id="l19.16">     return NS_OK;</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-  return MsgDetectCharsetFromFile(tmpFile, m_charset);</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+  return MsgDetectCharsetFromFile(mTmpFile, m_charset);</span>
<a href="#l19.20"></a><span id="l19.20"> }</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> static nsresult</span>
<a href="#l19.23"></a><span id="l19.23"> FetcherURLDoneCallback(nsresult aStatus,</span>
<a href="#l19.24"></a><span id="l19.24">                        const nsACString &amp;aContentType,</span>
<a href="#l19.25"></a><span id="l19.25">                        const nsACString &amp;aCharset,</span>
<a href="#l19.26"></a><span id="l19.26">                        int32_t totalSize,</span>
<a href="#l19.27"></a><span id="l19.27">                        const char16_t* aMsg, void *tagData)</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineat">@@ -572,17 +570,17 @@ nsMsgAttachmentHandler::SnarfMsgAttachme</span>
<a href="#l19.29"></a><span id="l19.29">   nsresult rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l19.30"></a><span id="l19.30">   nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32">   if (m_uri.Find(&quot;-message:&quot;, /* ignoreCase = */ true) != -1)</span>
<a href="#l19.33"></a><span id="l19.33">   {</span>
<a href="#l19.34"></a><span id="l19.34">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.35"></a><span id="l19.35">     rv = nsMsgCreateTempFile(&quot;nsmail.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l19.36"></a><span id="l19.36">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineminus">-    mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    mTmpFile = tmpFile;</span>
<a href="#l19.39"></a><span id="l19.39">     mDeleteFile = true;</span>
<a href="#l19.40"></a><span id="l19.40">     mCompFields = compFields;</span>
<a href="#l19.41"></a><span id="l19.41">     m_type = MESSAGE_RFC822;</span>
<a href="#l19.42"></a><span id="l19.42">     m_overrideType = MESSAGE_RFC822;</span>
<a href="#l19.43"></a><span id="l19.43">     if (!mTmpFile)</span>
<a href="#l19.44"></a><span id="l19.44">     {</span>
<a href="#l19.45"></a><span id="l19.45">       rv = NS_ERROR_FAILURE;</span>
<a href="#l19.46"></a><span id="l19.46">       goto done;</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineat">@@ -636,20 +634,16 @@ nsMsgAttachmentHandler::SnarfMsgAttachme</span>
<a href="#l19.48"></a><span id="l19.48">       if (mimeConverter)</span>
<a href="#l19.49"></a><span id="l19.49">       {</span>
<a href="#l19.50"></a><span id="l19.50">         mimeConverter-&gt;SetMimeOutputType(nsMimeOutput::nsMimeMessageDecrypt);</span>
<a href="#l19.51"></a><span id="l19.51">         mimeConverter-&gt;SetForwardInline(false);</span>
<a href="#l19.52"></a><span id="l19.52">         mimeConverter-&gt;SetIdentity(nullptr);</span>
<a href="#l19.53"></a><span id="l19.53">         mimeConverter-&gt;SetOriginalMsgURI(nullptr);</span>
<a href="#l19.54"></a><span id="l19.54">       }</span>
<a href="#l19.55"></a><span id="l19.55"> </span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-      nsCOMPtr&lt;nsIStreamListener&gt; convertedListener = do_QueryInterface(m_mime_parser, &amp;rv);</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineminus">-        goto done;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineminus">-</span>
<a href="#l19.60"></a><span id="l19.60">       nsCOMPtr&lt;nsIURI&gt; aURL;</span>
<a href="#l19.61"></a><span id="l19.61">       rv = messageService-&gt;GetUrlForUri(uri.get(), getter_AddRefs(aURL), nullptr);</span>
<a href="#l19.62"></a><span id="l19.62">       if (NS_FAILED(rv))</span>
<a href="#l19.63"></a><span id="l19.63">         goto done;</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65"> </span>
<a href="#l19.66"></a><span id="l19.66">       nsCOMPtr&lt;nsIPrincipal&gt; nullPrincipal =</span>
<a href="#l19.67"></a><span id="l19.67">         do_CreateInstance(&quot;@mozilla.org/nullprincipal;1&quot;, &amp;rv);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineat">@@ -667,17 +661,17 @@ nsMsgAttachmentHandler::SnarfMsgAttachme</span>
<a href="#l19.69"></a><span id="l19.69">         goto done;</span>
<a href="#l19.70"></a><span id="l19.70"> </span>
<a href="#l19.71"></a><span id="l19.71">       rv = m_mime_parser-&gt;AsyncConvertData(&quot;message/rfc822&quot;, &quot;message/rfc822&quot;,</span>
<a href="#l19.72"></a><span id="l19.72">                                            strListener, m_converter_channel);</span>
<a href="#l19.73"></a><span id="l19.73">       if (NS_FAILED(rv))</span>
<a href="#l19.74"></a><span id="l19.74">         goto done;</span>
<a href="#l19.75"></a><span id="l19.75"> </span>
<a href="#l19.76"></a><span id="l19.76">       nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-      rv = messageService-&gt;DisplayMessage(uri.get(), convertedListener, nullptr, nullptr, nullptr,</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+      rv = messageService-&gt;DisplayMessage(uri.get(), m_mime_parser, nullptr, nullptr, nullptr,</span>
<a href="#l19.79"></a><span id="l19.79">                                           getter_AddRefs(dummyNull));</span>
<a href="#l19.80"></a><span id="l19.80">     }</span>
<a href="#l19.81"></a><span id="l19.81">   }</span>
<a href="#l19.82"></a><span id="l19.82"> done:</span>
<a href="#l19.83"></a><span id="l19.83">   if (NS_FAILED(rv))</span>
<a href="#l19.84"></a><span id="l19.84">   {</span>
<a href="#l19.85"></a><span id="l19.85">       if (mOutFile)</span>
<a href="#l19.86"></a><span id="l19.86">       {</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineat">@@ -714,17 +708,17 @@ nsMsgAttachmentHandler::SnarfAttachment(</span>
<a href="#l19.88"></a><span id="l19.88"> </span>
<a href="#l19.89"></a><span id="l19.89">   mCompFields = compFields;</span>
<a href="#l19.90"></a><span id="l19.90"> </span>
<a href="#l19.91"></a><span id="l19.91">   // First, get as file spec and create the stream for the</span>
<a href="#l19.92"></a><span id="l19.92">   // temp file where we will save this data</span>
<a href="#l19.93"></a><span id="l19.93">   nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.94"></a><span id="l19.94">   nsresult rv = nsMsgCreateTempFile(&quot;nsmail.tmp&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l19.95"></a><span id="l19.95">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-  mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+  mTmpFile = tmpFile;</span>
<a href="#l19.98"></a><span id="l19.98">   mDeleteFile = true;</span>
<a href="#l19.99"></a><span id="l19.99"> </span>
<a href="#l19.100"></a><span id="l19.100">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mOutFile), mTmpFile, -1, 00600);</span>
<a href="#l19.101"></a><span id="l19.101">   if (NS_FAILED(rv) || !mOutFile)</span>
<a href="#l19.102"></a><span id="l19.102">   {</span>
<a href="#l19.103"></a><span id="l19.103">     if (m_mime_delivery_state)</span>
<a href="#l19.104"></a><span id="l19.104">     {</span>
<a href="#l19.105"></a><span id="l19.105">       nsCOMPtr&lt;nsIMsgSendReport&gt; sendReport;</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineat">@@ -799,17 +793,17 @@ nsMsgAttachmentHandler::ConvertToZipFile</span>
<a href="#l19.107"></a><span id="l19.107">   nsresult rv = aSourceFile-&gt;GetNativeLeafName(zippedName);</span>
<a href="#l19.108"></a><span id="l19.108">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.109"></a><span id="l19.109">   zippedName.AppendLiteral(&quot;.zip&quot;);</span>
<a href="#l19.110"></a><span id="l19.110"> </span>
<a href="#l19.111"></a><span id="l19.111">   // create a temporary file that we'll work on</span>
<a href="#l19.112"></a><span id="l19.112">   nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.113"></a><span id="l19.113">   rv = nsMsgCreateTempFile(zippedName.get(), getter_AddRefs(tmpFile));</span>
<a href="#l19.114"></a><span id="l19.114">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-  mEncodedWorkingFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+  mEncodedWorkingFile = tmpFile;</span>
<a href="#l19.117"></a><span id="l19.117"> </span>
<a href="#l19.118"></a><span id="l19.118">   // point our URL at the zipped temp file</span>
<a href="#l19.119"></a><span id="l19.119">   NS_NewFileURI(getter_AddRefs(mURL), mEncodedWorkingFile);</span>
<a href="#l19.120"></a><span id="l19.120"> </span>
<a href="#l19.121"></a><span id="l19.121">   // zip it!</span>
<a href="#l19.122"></a><span id="l19.122">   rv = nsSimpleZipper::Zip(aSourceFile, mEncodedWorkingFile);</span>
<a href="#l19.123"></a><span id="l19.123">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l19.124"></a><span id="l19.124"> </span>
<a href="#l19.125"></a><span id="l19.125" class="difflineat">@@ -883,17 +877,17 @@ nsMsgAttachmentHandler::ConvertToAppleEn</span>
<a href="#l19.126"></a><span id="l19.126"> </span>
<a href="#l19.127"></a><span id="l19.127">     separator = mime_make_separator(&quot;ad&quot;);</span>
<a href="#l19.128"></a><span id="l19.128">     if (!separator)</span>
<a href="#l19.129"></a><span id="l19.129">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.130"></a><span id="l19.130"> </span>
<a href="#l19.131"></a><span id="l19.131">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.132"></a><span id="l19.132">     nsresult rv = nsMsgCreateTempFile(&quot;appledouble&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l19.133"></a><span id="l19.133">     if (NS_SUCCEEDED(rv))</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-      mEncodedWorkingFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+      mEncodedWorkingFile = tmpFile;</span>
<a href="#l19.136"></a><span id="l19.136">     if (!mEncodedWorkingFile)</span>
<a href="#l19.137"></a><span id="l19.137">     {</span>
<a href="#l19.138"></a><span id="l19.138">       PR_FREEIF(separator);</span>
<a href="#l19.139"></a><span id="l19.139">       return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l19.140"></a><span id="l19.140">     }</span>
<a href="#l19.141"></a><span id="l19.141"> </span>
<a href="#l19.142"></a><span id="l19.142">     //</span>
<a href="#l19.143"></a><span id="l19.143">     // RICHIE_MAC - ok, here's the deal, we have a file that we need</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineat">@@ -1097,17 +1091,17 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l19.145"></a><span id="l19.145">   }</span>
<a href="#l19.146"></a><span id="l19.146">   // this silliness is because Windows nsIFile caches its file size</span>
<a href="#l19.147"></a><span id="l19.147">   // so if an output stream writes to it, it will still return the original</span>
<a href="#l19.148"></a><span id="l19.148">   // cached size.</span>
<a href="#l19.149"></a><span id="l19.149">   if (mTmpFile)</span>
<a href="#l19.150"></a><span id="l19.150">   {</span>
<a href="#l19.151"></a><span id="l19.151">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.152"></a><span id="l19.152">     mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-    mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+    mTmpFile = tmpFile;</span>
<a href="#l19.155"></a><span id="l19.155">   }</span>
<a href="#l19.156"></a><span id="l19.156">   mRequest = nullptr;</span>
<a href="#l19.157"></a><span id="l19.157"> </span>
<a href="#l19.158"></a><span id="l19.158">   // First things first, we are now going to see if this is an HTML</span>
<a href="#l19.159"></a><span id="l19.159">   // Doc and if it is, we need to see if we can determine the charset</span>
<a href="#l19.160"></a><span id="l19.160">   // for this part by sniffing the HTML file.</span>
<a href="#l19.161"></a><span id="l19.161">   // This is needed only when the charset is not set already.</span>
<a href="#l19.162"></a><span id="l19.162">   // (e.g. a charset may be specified in HTTP header)</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineat">@@ -1233,17 +1227,17 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l19.164"></a><span id="l19.164">           outputStream-&gt;Close();</span>
<a href="#l19.165"></a><span id="l19.165">           // this silliness is because Windows nsIFile caches its file size</span>
<a href="#l19.166"></a><span id="l19.166">           // so if an output stream writes to it, it will still return the original</span>
<a href="#l19.167"></a><span id="l19.167">           // cached size.</span>
<a href="#l19.168"></a><span id="l19.168">           if (mTmpFile)</span>
<a href="#l19.169"></a><span id="l19.169">           {</span>
<a href="#l19.170"></a><span id="l19.170">             nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l19.171"></a><span id="l19.171">             mTmpFile-&gt;Clone(getter_AddRefs(tmpFile));</span>
<a href="#l19.172"></a><span id="l19.172" class="difflineminus">-            mTmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l19.173"></a><span id="l19.173" class="difflineplus">+            mTmpFile = tmpFile;</span>
<a href="#l19.174"></a><span id="l19.174">           }</span>
<a href="#l19.175"></a><span id="l19.175"> </span>
<a href="#l19.176"></a><span id="l19.176">         }</span>
<a href="#l19.177"></a><span id="l19.177">       }</span>
<a href="#l19.178"></a><span id="l19.178">     }</span>
<a href="#l19.179"></a><span id="l19.179"> </span>
<a href="#l19.180"></a><span id="l19.180">     m_type = m_desiredType;</span>
<a href="#l19.181"></a><span id="l19.181">     m_desiredType.Truncate();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -222,17 +222,17 @@ GetChildOffset(nsINode *aChild, nsINode </span>
<a href="#l20.4"></a><span id="l20.4"> </span>
<a href="#l20.5"></a><span id="l20.5"> nsresult</span>
<a href="#l20.6"></a><span id="l20.6"> GetNodeLocation(nsINode *inChild, nsCOMPtr&lt;nsINode&gt; *outParent, int32_t *outOffset)</span>
<a href="#l20.7"></a><span id="l20.7"> {</span>
<a href="#l20.8"></a><span id="l20.8">   NS_ASSERTION((outParent &amp;&amp; outOffset), &quot;bad args&quot;);</span>
<a href="#l20.9"></a><span id="l20.9">   nsresult result = NS_ERROR_NULL_POINTER;</span>
<a href="#l20.10"></a><span id="l20.10">   if (inChild &amp;&amp; outParent &amp;&amp; outOffset)</span>
<a href="#l20.11"></a><span id="l20.11">   {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    nsCOMPtr&lt;nsINode&gt; inChild2 = do_QueryInterface(inChild);</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+    nsCOMPtr&lt;nsINode&gt; inChild2 = inChild;</span>
<a href="#l20.14"></a><span id="l20.14">     *outParent = inChild2-&gt;GetParentNode();</span>
<a href="#l20.15"></a><span id="l20.15">     if (*outParent)</span>
<a href="#l20.16"></a><span id="l20.16">     {</span>
<a href="#l20.17"></a><span id="l20.17">       result = GetChildOffset(inChild2, *outParent, *outOffset);</span>
<a href="#l20.18"></a><span id="l20.18">     }</span>
<a href="#l20.19"></a><span id="l20.19">   }</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21">   return result;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -580,17 +580,17 @@ nsMsgCompose::InsertDivWrappedTextAtSele</span>
<a href="#l20.23"></a><span id="l20.23">   {</span>
<a href="#l20.24"></a><span id="l20.24">     RefPtr&lt;Selection&gt; selection;</span>
<a href="#l20.25"></a><span id="l20.25">     m_editor-&gt;GetSelection(getter_AddRefs(selection));</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27">     if (selection)</span>
<a href="#l20.28"></a><span id="l20.28">       selection-&gt;Collapse(parent, offset + 1);</span>
<a href="#l20.29"></a><span id="l20.29">   }</span>
<a href="#l20.30"></a><span id="l20.30">   if (divElem) {</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    nsCOMPtr&lt;Element&gt; divElem2 = do_QueryInterface(divElem);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    RefPtr&lt;Element&gt; divElem2 = divElem;</span>
<a href="#l20.33"></a><span id="l20.33">     IgnoredErrorResult rv2;</span>
<a href="#l20.34"></a><span id="l20.34">     divElem2-&gt;SetAttribute(NS_LITERAL_STRING(&quot;class&quot;), classStr, rv2);</span>
<a href="#l20.35"></a><span id="l20.35">   }</span>
<a href="#l20.36"></a><span id="l20.36"> }</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38"> /*</span>
<a href="#l20.39"></a><span id="l20.39">  * The following function replaces &lt;plaintext&gt; tags with &lt;x-plaintext&gt;.</span>
<a href="#l20.40"></a><span id="l20.40">  * &lt;plaintext&gt; is a funny beast: It leads to everything following it</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineat">@@ -1011,18 +1011,17 @@ nsMsgCompose::Initialize(nsIMsgComposePa</span>
<a href="#l20.42"></a><span id="l20.42">   aParams-&gt;GetIdentity(getter_AddRefs(m_identity));</span>
<a href="#l20.43"></a><span id="l20.43"> </span>
<a href="#l20.44"></a><span id="l20.44">   if (aWindow)</span>
<a href="#l20.45"></a><span id="l20.45">   {</span>
<a href="#l20.46"></a><span id="l20.46">     m_window = aWindow;</span>
<a href="#l20.47"></a><span id="l20.47">     nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(aWindow);</span>
<a href="#l20.48"></a><span id="l20.48">     NS_ENSURE_TRUE(window, NS_ERROR_FAILURE);</span>
<a href="#l20.49"></a><span id="l20.49"> </span>
<a href="#l20.50"></a><span id="l20.50" class="difflineminus">-    nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem =</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">-      do_QueryInterface(window-&gt;GetDocShell());</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+    nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem = window-&gt;GetDocShell();</span>
<a href="#l20.53"></a><span id="l20.53">     nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l20.54"></a><span id="l20.54">     rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l20.55"></a><span id="l20.55">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l20.56"></a><span id="l20.56"> </span>
<a href="#l20.57"></a><span id="l20.57">     m_baseWindow = do_QueryInterface(treeOwner);</span>
<a href="#l20.58"></a><span id="l20.58">   }</span>
<a href="#l20.59"></a><span id="l20.59"> </span>
<a href="#l20.60"></a><span id="l20.60">   MSG_ComposeFormat format;</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineat">@@ -5628,17 +5627,17 @@ nsMsgCompose::MoveToAboveQuote(void)</span>
<a href="#l20.62"></a><span id="l20.62">   }</span>
<a href="#l20.63"></a><span id="l20.63"> </span>
<a href="#l20.64"></a><span id="l20.64">   nsCOMPtr&lt;nsINode&gt; node;</span>
<a href="#l20.65"></a><span id="l20.65">   nsAutoString attributeName;</span>
<a href="#l20.66"></a><span id="l20.66">   nsAutoString attributeValue;</span>
<a href="#l20.67"></a><span id="l20.67">   nsAutoString tagLocalName;</span>
<a href="#l20.68"></a><span id="l20.68">   attributeName.AssignLiteral(&quot;class&quot;);</span>
<a href="#l20.69"></a><span id="l20.69"> </span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-  nsCOMPtr&lt;nsINode&gt; rootElement2 = do_QueryInterface(rootElement);</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+  RefPtr&lt;nsINode&gt; rootElement2 = rootElement;</span>
<a href="#l20.72"></a><span id="l20.72">   node = rootElement2-&gt;GetFirstChild();</span>
<a href="#l20.73"></a><span id="l20.73">   while (node) {</span>
<a href="#l20.74"></a><span id="l20.74">     nsCOMPtr&lt;Element&gt; element = do_QueryInterface(node);</span>
<a href="#l20.75"></a><span id="l20.75">     if (element) {</span>
<a href="#l20.76"></a><span id="l20.76">       // First check for &lt;blockquote&gt;. This will most likely not trigger</span>
<a href="#l20.77"></a><span id="l20.77">       // since well-behaved quotes are preceded by a cite prefix.</span>
<a href="#l20.78"></a><span id="l20.78">       tagLocalName = node-&gt;LocalName();</span>
<a href="#l20.79"></a><span id="l20.79">       if (tagLocalName.EqualsLiteral(&quot;blockquote&quot;)) {</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineat">@@ -5720,17 +5719,17 @@ nsMsgCompose::MoveToEndOfDocument(void)</span>
<a href="#l20.81"></a><span id="l20.81">   int32_t offset;</span>
<a href="#l20.82"></a><span id="l20.82">   RefPtr&lt;Element&gt; rootElement;</span>
<a href="#l20.83"></a><span id="l20.83">   nsCOMPtr&lt;nsINode&gt; lastNode;</span>
<a href="#l20.84"></a><span id="l20.84">   nsresult rv = m_editor-&gt;GetRootElement(getter_AddRefs(rootElement));</span>
<a href="#l20.85"></a><span id="l20.85">   if (NS_FAILED(rv) || !rootElement) {</span>
<a href="#l20.86"></a><span id="l20.86">     return rv;</span>
<a href="#l20.87"></a><span id="l20.87">   }</span>
<a href="#l20.88"></a><span id="l20.88"> </span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-  nsCOMPtr&lt;nsINode&gt; rootElement2 = do_QueryInterface(rootElement);</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+  RefPtr&lt;nsINode&gt; rootElement2 = rootElement;</span>
<a href="#l20.91"></a><span id="l20.91">   lastNode = rootElement2-&gt;GetLastChild();</span>
<a href="#l20.92"></a><span id="l20.92">   if (!lastNode) {</span>
<a href="#l20.93"></a><span id="l20.93">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l20.94"></a><span id="l20.94">   }</span>
<a href="#l20.95"></a><span id="l20.95"> </span>
<a href="#l20.96"></a><span id="l20.96">   rv = GetChildOffset(lastNode, rootElement2, offset);</span>
<a href="#l20.97"></a><span id="l20.97">   if (NS_FAILED(rv)) {</span>
<a href="#l20.98"></a><span id="l20.98">     return rv;</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineat">@@ -5762,17 +5761,17 @@ nsMsgCompose::SetIdentity(nsIMsgIdentity</span>
<a href="#l20.100"></a><span id="l20.100">     return rv;</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">   //First look for the current signature, if we have one</span>
<a href="#l20.103"></a><span id="l20.103">   nsCOMPtr&lt;nsINode&gt; lastNode;</span>
<a href="#l20.104"></a><span id="l20.104">   nsCOMPtr&lt;nsINode&gt; node;</span>
<a href="#l20.105"></a><span id="l20.105">   nsCOMPtr&lt;nsINode&gt; tempNode;</span>
<a href="#l20.106"></a><span id="l20.106">   nsAutoString tagLocalName;</span>
<a href="#l20.107"></a><span id="l20.107"> </span>
<a href="#l20.108"></a><span id="l20.108" class="difflineminus">-  nsCOMPtr&lt;nsINode&gt; rootElement2 = do_QueryInterface(rootElement);</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+  RefPtr&lt;nsINode&gt; rootElement2 = rootElement;</span>
<a href="#l20.110"></a><span id="l20.110">   lastNode = rootElement2-&gt;GetLastChild();</span>
<a href="#l20.111"></a><span id="l20.111">   if (lastNode)</span>
<a href="#l20.112"></a><span id="l20.112">   {</span>
<a href="#l20.113"></a><span id="l20.113">     node = lastNode;</span>
<a href="#l20.114"></a><span id="l20.114">     // In html, the signature is inside an element with</span>
<a href="#l20.115"></a><span id="l20.115">     // class=&quot;moz-signature&quot;</span>
<a href="#l20.116"></a><span id="l20.116">     bool signatureFound = false;</span>
<a href="#l20.117"></a><span id="l20.117">     nsAutoString attributeName;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1992,17 +1992,17 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l21.4"></a><span id="l21.4">           NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l21.5"></a><span id="l21.5">           nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l21.6"></a><span id="l21.6">           rv = ioService-&gt;NewURI(url, nullptr, nullptr, getter_AddRefs(uri));</span>
<a href="#l21.7"></a><span id="l21.7">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.8"></a><span id="l21.8">           nsCOMPtr &lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l21.9"></a><span id="l21.9">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l21.10"></a><span id="l21.10">           nsCOMPtr &lt;nsIFile&gt; fileURLFile;</span>
<a href="#l21.11"></a><span id="l21.11">           fileURL-&gt;GetFile(getter_AddRefs(fileURLFile));</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-          m_attachments[newLoc]-&gt;mTmpFile = do_QueryInterface(fileURLFile);</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+          m_attachments[newLoc]-&gt;mTmpFile = fileURLFile;</span>
<a href="#l21.14"></a><span id="l21.14">           m_attachments[newLoc]-&gt;mDeleteFile = false;</span>
<a href="#l21.15"></a><span id="l21.15">           if (m_attachments[newLoc]-&gt;mURL)</span>
<a href="#l21.16"></a><span id="l21.16">           {</span>
<a href="#l21.17"></a><span id="l21.17">             nsAutoString proposedName;</span>
<a href="#l21.18"></a><span id="l21.18">             attachment-&gt;GetName(proposedName);</span>
<a href="#l21.19"></a><span id="l21.19">             msg_pick_real_name(m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l21.20"></a><span id="l21.20">           }</span>
<a href="#l21.21"></a><span id="l21.21"> </span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -3352,17 +3352,17 @@ nsMsgComposeAndSend::DeliverFileAsMail()</span>
<a href="#l21.23"></a><span id="l21.23"> </span>
<a href="#l21.24"></a><span id="l21.24">     // Tell the user we are sending the message!</span>
<a href="#l21.25"></a><span id="l21.25">     nsString msg;</span>
<a href="#l21.26"></a><span id="l21.26">     mComposeBundle-&gt;GetStringFromName(&quot;sendingMessage&quot;, msg);</span>
<a href="#l21.27"></a><span id="l21.27">     SetStatusMessage(msg);</span>
<a href="#l21.28"></a><span id="l21.28">     nsCOMPtr&lt;nsIMsgStatusFeedback&gt; msgStatus (do_QueryInterface(mSendProgress));</span>
<a href="#l21.29"></a><span id="l21.29">     // if the sendProgress isn't set, let's use the member variable.</span>
<a href="#l21.30"></a><span id="l21.30">     if (!msgStatus)</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-      msgStatus = do_QueryInterface(mStatusFeedback);</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+      msgStatus = mStatusFeedback;</span>
<a href="#l21.33"></a><span id="l21.33"> </span>
<a href="#l21.34"></a><span id="l21.34">     nsCOMPtr&lt;nsIURI&gt; runningUrl;</span>
<a href="#l21.35"></a><span id="l21.35">     rv = smtpService-&gt;SendMailMessage(mTempFile, buf, mUserIdentity, mCompFields-&gt;GetFrom(),</span>
<a href="#l21.36"></a><span id="l21.36">                                       mSmtpPassword, deliveryListener, msgStatus,</span>
<a href="#l21.37"></a><span id="l21.37">                                       callbacks, mCompFields-&gt;GetDSN(),</span>
<a href="#l21.38"></a><span id="l21.38">                                       getter_AddRefs(runningUrl),</span>
<a href="#l21.39"></a><span id="l21.39">                                       getter_AddRefs(mRunningRequest));</span>
<a href="#l21.40"></a><span id="l21.40">     // set envid on the returned URL</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/compose/src/nsSmtpProtocol.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -710,18 +710,17 @@ nsresult nsSmtpProtocol::SendHeloRespons</span>
<a href="#l22.4"></a><span id="l22.4">                           m_responseText.get(), nullptr);</span>
<a href="#l22.5"></a><span id="l22.5">     NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to explain SMTP error&quot;);</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">     m_urlErrorState = NS_ERROR_BUT_DONT_SHOW_ALERT;</span>
<a href="#l22.8"></a><span id="l22.8">     return NS_ERROR_SMTP_AUTH_FAILURE;</span>
<a href="#l22.9"></a><span id="l22.9">   }</span>
<a href="#l22.10"></a><span id="l22.10"> </span>
<a href="#l22.11"></a><span id="l22.11">   // check if we're just verifying the ability to logon</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-  nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+  nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l22.15"></a><span id="l22.15">   bool verifyingLogon = false;</span>
<a href="#l22.16"></a><span id="l22.16">   smtpUrl-&gt;GetVerifyLogon(&amp;verifyingLogon);</span>
<a href="#l22.17"></a><span id="l22.17">   if (verifyingLogon)</span>
<a href="#l22.18"></a><span id="l22.18">     return SendQuit();</span>
<a href="#l22.19"></a><span id="l22.19"> </span>
<a href="#l22.20"></a><span id="l22.20">   nsCOMPtr&lt;nsIPrefService&gt; prefs = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l22.21"></a><span id="l22.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l22.22"></a><span id="l22.22">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineat">@@ -2183,18 +2182,17 @@ nsresult nsSmtpProtocol::ProcessProtocol</span>
<a href="#l22.24"></a><span id="l22.24"> </span>
<a href="#l22.25"></a><span id="l22.25">   return NS_OK;</span>
<a href="#l22.26"></a><span id="l22.26"> }</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28"> nsresult</span>
<a href="#l22.29"></a><span id="l22.29"> nsSmtpProtocol::GetPassword(nsString &amp;aPassword)</span>
<a href="#l22.30"></a><span id="l22.30"> {</span>
<a href="#l22.31"></a><span id="l22.31">     nsresult rv;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l22.37"></a><span id="l22.37">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l22.38"></a><span id="l22.38">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40">     rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l22.41"></a><span id="l22.41">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43" class="difflineat">@@ -2276,18 +2274,17 @@ nsSmtpProtocol::PromptForPassword(nsISmt</span>
<a href="#l22.44"></a><span id="l22.44">   return rv;</span>
<a href="#l22.45"></a><span id="l22.45"> }</span>
<a href="#l22.46"></a><span id="l22.46"> </span>
<a href="#l22.47"></a><span id="l22.47"> nsresult</span>
<a href="#l22.48"></a><span id="l22.48"> nsSmtpProtocol::GetUsernamePassword(nsACString &amp;aUsername,</span>
<a href="#l22.49"></a><span id="l22.49">                                     nsAString &amp;aPassword)</span>
<a href="#l22.50"></a><span id="l22.50"> {</span>
<a href="#l22.51"></a><span id="l22.51">     nsresult rv;</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = do_QueryInterface(m_runningURL, &amp;rv);</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    nsCOMPtr&lt;nsISmtpUrl&gt; smtpUrl = m_runningURL;</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">     nsCOMPtr&lt;nsISmtpServer&gt; smtpServer;</span>
<a href="#l22.57"></a><span id="l22.57">     rv = smtpUrl-&gt;GetSmtpServer(getter_AddRefs(smtpServer));</span>
<a href="#l22.58"></a><span id="l22.58">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.59"></a><span id="l22.59"> </span>
<a href="#l22.60"></a><span id="l22.60">     rv = smtpServer-&gt;GetPassword(aPassword);</span>
<a href="#l22.61"></a><span id="l22.61">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l22.62"></a><span id="l22.62"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -48,17 +48,17 @@ nsURLFetcher::nsURLFetcher()</span>
<a href="#l23.4"></a><span id="l23.4">   mTotalWritten = 0;</span>
<a href="#l23.5"></a><span id="l23.5">   mBuffer = nullptr;</span>
<a href="#l23.6"></a><span id="l23.6">   mBufferSize = 0;</span>
<a href="#l23.7"></a><span id="l23.7">   mStillRunning = true;</span>
<a href="#l23.8"></a><span id="l23.8">   mCallback = nullptr;</span>
<a href="#l23.9"></a><span id="l23.9">   mOnStopRequestProcessed = false;</span>
<a href="#l23.10"></a><span id="l23.10">   mIsFile=false;</span>
<a href="#l23.11"></a><span id="l23.11">   nsURLFetcherStreamConsumer *consumer = new nsURLFetcherStreamConsumer(this);</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  mConverter = do_QueryInterface(consumer);</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  mConverter = consumer;</span>
<a href="#l23.14"></a><span id="l23.14"> }</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16"> nsURLFetcher::~nsURLFetcher()</span>
<a href="#l23.17"></a><span id="l23.17"> {</span>
<a href="#l23.18"></a><span id="l23.18">   mStillRunning = false;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20">   PR_FREEIF(mBuffer);</span>
<a href="#l23.21"></a><span id="l23.21">   // Remove the DocShell as a listener of the old WebProgress...</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -2023,18 +2023,17 @@ nsresult nsMsgDatabase::RemoveHeaderFrom</span>
<a href="#l24.4"></a><span id="l24.4"> {</span>
<a href="#l24.5"></a><span id="l24.5">   if (!msgHdr)</span>
<a href="#l24.6"></a><span id="l24.6">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l24.7"></a><span id="l24.7">   nsresult ret = NS_OK;</span>
<a href="#l24.8"></a><span id="l24.8">   nsCOMPtr &lt;nsIMsgThread&gt; thread ;</span>
<a href="#l24.9"></a><span id="l24.9">   ret = GetThreadContainingMsgHdr(msgHdr, getter_AddRefs(thread));</span>
<a href="#l24.10"></a><span id="l24.10">   if (NS_SUCCEEDED(ret) &amp;&amp; thread)</span>
<a href="#l24.11"></a><span id="l24.11">   {</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-    nsCOMPtr &lt;nsIDBChangeAnnouncer&gt; announcer = do_QueryInterface(this);</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineminus">-    ret = thread-&gt;RemoveChildHdr(msgHdr, announcer);</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+    ret = thread-&gt;RemoveChildHdr(msgHdr, this);</span>
<a href="#l24.15"></a><span id="l24.15">   }</span>
<a href="#l24.16"></a><span id="l24.16">   return ret;</span>
<a href="#l24.17"></a><span id="l24.17"> }</span>
<a href="#l24.18"></a><span id="l24.18"> </span>
<a href="#l24.19"></a><span id="l24.19"> NS_IMETHODIMP nsMsgDatabase::RemoveHeaderMdbRow(nsIMsgDBHdr *msg)</span>
<a href="#l24.20"></a><span id="l24.20"> {</span>
<a href="#l24.21"></a><span id="l24.21">   NS_ENSURE_ARG_POINTER(msg);</span>
<a href="#l24.22"></a><span id="l24.22">   nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(msg);  // closed system, so this is ok</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineat">@@ -4557,19 +4556,17 @@ nsresult nsMsgDatabase::ThreadNewHdr(nsM</span>
<a href="#l24.24"></a><span id="l24.24">     newThread = false;</span>
<a href="#l24.25"></a><span id="l24.25">   }</span>
<a href="#l24.26"></a><span id="l24.26">   return result;</span>
<a href="#l24.27"></a><span id="l24.27"> }</span>
<a href="#l24.28"></a><span id="l24.28"> </span>
<a href="#l24.29"></a><span id="l24.29"> nsresult nsMsgDatabase::AddToThread(nsMsgHdr *newHdr, nsIMsgThread *thread, nsIMsgDBHdr *inReplyTo, bool threadInThread)</span>
<a href="#l24.30"></a><span id="l24.30"> {</span>
<a href="#l24.31"></a><span id="l24.31">   // don't worry about real threading yet.</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineminus">-  nsCOMPtr &lt;nsIDBChangeAnnouncer&gt; announcer = do_QueryInterface(this);</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineminus">-</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineminus">-  return thread-&gt;AddChild(newHdr, inReplyTo, threadInThread, announcer);</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+  return thread-&gt;AddChild(newHdr, inReplyTo, threadInThread, this);</span>
<a href="#l24.36"></a><span id="l24.36"> }</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38"> nsMsgHdr * nsMsgDatabase::GetMsgHdrForReference(nsCString &amp;reference)</span>
<a href="#l24.39"></a><span id="l24.39"> {</span>
<a href="#l24.40"></a><span id="l24.40">   NS_ASSERTION(false, &quot;not implemented yet.&quot;);</span>
<a href="#l24.41"></a><span id="l24.41">   return nullptr;</span>
<a href="#l24.42"></a><span id="l24.42"> }</span>
<a href="#l24.43"></a><span id="l24.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -37,19 +37,18 @@ bool MsgStrategyComparatorAdaptor::Equal</span>
<a href="#l25.4"></a><span id="l25.4">   mDatabase-&gt;GetMsgHdrForKey(a, getter_AddRefs(hdrA));</span>
<a href="#l25.5"></a><span id="l25.5">   mDatabase-&gt;GetMsgHdrForKey(b, getter_AddRefs(hdrB));</span>
<a href="#l25.6"></a><span id="l25.6"> </span>
<a href="#l25.7"></a><span id="l25.7">   if (hdrA &amp;&amp; hdrB)</span>
<a href="#l25.8"></a><span id="l25.8">   {</span>
<a href="#l25.9"></a><span id="l25.9">     nsresult rv = NS_OK;</span>
<a href="#l25.10"></a><span id="l25.10">     nsAutoSyncStrategyDecisionType decision = nsAutoSyncStrategyDecisions::Same;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(mFolder);</span>
<a href="#l25.13"></a><span id="l25.13">     if (mStrategy)</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineminus">-      rv = mStrategy-&gt;Sort(folder, hdrA, hdrB, &amp;decision);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+      rv = mStrategy-&gt;Sort(mFolder, hdrA, hdrB, &amp;decision);</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17">     if (NS_SUCCEEDED(rv))</span>
<a href="#l25.18"></a><span id="l25.18">       return (decision == nsAutoSyncStrategyDecisions::Same);</span>
<a href="#l25.19"></a><span id="l25.19">   }</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21">   return false;</span>
<a href="#l25.22"></a><span id="l25.22"> }</span>
<a href="#l25.23"></a><span id="l25.23"> </span>
<a href="#l25.24"></a><span id="l25.24" class="difflineat">@@ -62,19 +61,18 @@ bool MsgStrategyComparatorAdaptor::LessT</span>
<a href="#l25.25"></a><span id="l25.25">   mDatabase-&gt;GetMsgHdrForKey(a, getter_AddRefs(hdrA));</span>
<a href="#l25.26"></a><span id="l25.26">   mDatabase-&gt;GetMsgHdrForKey(b, getter_AddRefs(hdrB));</span>
<a href="#l25.27"></a><span id="l25.27"> </span>
<a href="#l25.28"></a><span id="l25.28">   if (hdrA &amp;&amp; hdrB)</span>
<a href="#l25.29"></a><span id="l25.29">   {</span>
<a href="#l25.30"></a><span id="l25.30">     nsresult rv = NS_OK;</span>
<a href="#l25.31"></a><span id="l25.31">     nsAutoSyncStrategyDecisionType decision = nsAutoSyncStrategyDecisions::Same;</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(mFolder);</span>
<a href="#l25.34"></a><span id="l25.34">     if (mStrategy)</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-      rv = mStrategy-&gt;Sort(folder, hdrA, hdrB, &amp;decision);</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+      rv = mStrategy-&gt;Sort(mFolder, hdrA, hdrB, &amp;decision);</span>
<a href="#l25.37"></a><span id="l25.37"> </span>
<a href="#l25.38"></a><span id="l25.38">     if (NS_SUCCEEDED(rv))</span>
<a href="#l25.39"></a><span id="l25.39">       return (decision == nsAutoSyncStrategyDecisions::Lower);</span>
<a href="#l25.40"></a><span id="l25.40">   }</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42">   return false;</span>
<a href="#l25.43"></a><span id="l25.43"> }</span>
<a href="#l25.44"></a><span id="l25.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -629,20 +629,17 @@ nsresult nsImapIncomingServer::DoomUrlIf</span>
<a href="#l26.4"></a><span id="l26.4"> </span>
<a href="#l26.5"></a><span id="l26.5">   if (aMailNewsUrl &amp;&amp; aImapUrl)</span>
<a href="#l26.6"></a><span id="l26.6">   {</span>
<a href="#l26.7"></a><span id="l26.7">     nsCOMPtr &lt;nsIImapMockChannel&gt; mockChannel;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9">     if (NS_SUCCEEDED(aImapUrl-&gt;GetMockChannel(getter_AddRefs(mockChannel))) &amp;&amp; mockChannel)</span>
<a href="#l26.10"></a><span id="l26.10">     {</span>
<a href="#l26.11"></a><span id="l26.11">       nsresult requestStatus;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-      nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mockChannel);</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineminus">-      if (!request)</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-        return NS_ERROR_FAILURE;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-      request-&gt;GetStatus(&amp;requestStatus);</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+      mockChannel-&gt;GetStatus(&amp;requestStatus);</span>
<a href="#l26.17"></a><span id="l26.17">       if (NS_FAILED(requestStatus))</span>
<a href="#l26.18"></a><span id="l26.18">       {</span>
<a href="#l26.19"></a><span id="l26.19">         nsresult res;</span>
<a href="#l26.20"></a><span id="l26.20">         *urlDoomed = true;</span>
<a href="#l26.21"></a><span id="l26.21">         nsImapProtocol::LogImapUrl(&quot;dooming url&quot;, aImapUrl);</span>
<a href="#l26.22"></a><span id="l26.22"> </span>
<a href="#l26.23"></a><span id="l26.23">         mockChannel-&gt;Close(); // try closing it to get channel listener nulled out.</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25" class="difflineat">@@ -688,24 +685,19 @@ nsImapIncomingServer::ConnectionTimeOut(</span>
<a href="#l26.26"></a><span id="l26.26">   }</span>
<a href="#l26.27"></a><span id="l26.27"> </span>
<a href="#l26.28"></a><span id="l26.28">   PRTime cacheTimeoutLimits = timeoutInMinutes * 60 * PR_USEC_PER_SEC;</span>
<a href="#l26.29"></a><span id="l26.29">   PRTime lastActiveTimeStamp;</span>
<a href="#l26.30"></a><span id="l26.30">   rv = aConnection-&gt;GetLastActiveTimeStamp(&amp;lastActiveTimeStamp);</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32">   if (PR_Now() - lastActiveTimeStamp &gt;= cacheTimeoutLimits)</span>
<a href="#l26.33"></a><span id="l26.33">   {</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineminus">-      nsCOMPtr&lt;nsIImapProtocol&gt; aProtocol(do_QueryInterface(aConnection,</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineminus">-                                                            &amp;rv));</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; aProtocol)</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-      {</span>
<a href="#l26.38"></a><span id="l26.38" class="difflineminus">-        RemoveConnection(aConnection);</span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-        aProtocol-&gt;TellThreadToDie(false);</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineminus">-        retVal = true;</span>
<a href="#l26.41"></a><span id="l26.41" class="difflineminus">-      }</span>
<a href="#l26.42"></a><span id="l26.42" class="difflineplus">+    RemoveConnection(aConnection);</span>
<a href="#l26.43"></a><span id="l26.43" class="difflineplus">+    aConnection-&gt;TellThreadToDie(false);</span>
<a href="#l26.44"></a><span id="l26.44" class="difflineplus">+    retVal = true;</span>
<a href="#l26.45"></a><span id="l26.45">   }</span>
<a href="#l26.46"></a><span id="l26.46">   return retVal;</span>
<a href="#l26.47"></a><span id="l26.47"> }</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49"> nsresult</span>
<a href="#l26.50"></a><span id="l26.50"> nsImapIncomingServer::GetImapConnection(nsIImapUrl * aImapUrl,</span>
<a href="#l26.51"></a><span id="l26.51">                                         nsIImapProtocol ** aImapConnection)</span>
<a href="#l26.52"></a><span id="l26.52"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -425,29 +425,28 @@ nsresult nsImapMailFolder::CreateSubFold</span>
<a href="#l27.4"></a><span id="l27.4">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l27.5"></a><span id="l27.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.6"></a><span id="l27.6"> </span>
<a href="#l27.7"></a><span id="l27.7">   nsCOMPtr&lt;nsIDirectoryEnumerator&gt; children;</span>
<a href="#l27.8"></a><span id="l27.8">   rv = path-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l27.9"></a><span id="l27.9">   bool more = false;</span>
<a href="#l27.10"></a><span id="l27.10">   if (children)</span>
<a href="#l27.11"></a><span id="l27.11">     children-&gt;HasMoreElements(&amp;more);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; dirEntry;</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; currentFolderPath;</span>
<a href="#l27.14"></a><span id="l27.14"> </span>
<a href="#l27.15"></a><span id="l27.15">   while (more)</span>
<a href="#l27.16"></a><span id="l27.16">   {</span>
<a href="#l27.17"></a><span id="l27.17">     nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l27.18"></a><span id="l27.18">     rv = children-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-    dirEntry = do_QueryInterface(supports);</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-    if (NS_FAILED(rv) || !dirEntry)</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+    currentFolderPath = do_QueryInterface(supports);</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+    if (NS_FAILED(rv) || !currentFolderPath)</span>
<a href="#l27.23"></a><span id="l27.23">       break;</span>
<a href="#l27.24"></a><span id="l27.24">     rv = children-&gt;HasMoreElements(&amp;more);</span>
<a href="#l27.25"></a><span id="l27.25">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.26"></a><span id="l27.26"> </span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-    nsCOMPtr &lt;nsIFile&gt; currentFolderPath = do_QueryInterface(dirEntry);</span>
<a href="#l27.28"></a><span id="l27.28">     currentFolderPath-&gt;GetLeafName(currentFolderNameStr);</span>
<a href="#l27.29"></a><span id="l27.29">     if (nsShouldIgnoreFile(currentFolderNameStr))</span>
<a href="#l27.30"></a><span id="l27.30">       continue;</span>
<a href="#l27.31"></a><span id="l27.31"> </span>
<a href="#l27.32"></a><span id="l27.32">     // OK, here we need to get the online name from the folder cache if we can.</span>
<a href="#l27.33"></a><span id="l27.33">     // If we can, use that to create the sub-folder</span>
<a href="#l27.34"></a><span id="l27.34">     nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l27.35"></a><span id="l27.35">     nsCOMPtr &lt;nsIFile&gt; curFolder = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineat">@@ -2936,18 +2935,17 @@ NS_IMETHODIMP nsImapMailFolder::ParseMsg</span>
<a href="#l27.37"></a><span id="l27.37">       headerInfo-&gt;GetMsgHdrs(&amp;msgHdrs);</span>
<a href="#l27.38"></a><span id="l27.38">       // create an input stream based on the hdr string.</span>
<a href="#l27.39"></a><span id="l27.39">       nsCOMPtr&lt;nsIStringInputStream&gt; inputStream =</span>
<a href="#l27.40"></a><span id="l27.40">             do_CreateInstance(&quot;@mozilla.org/io/string-input-stream;1&quot;, &amp;rv);</span>
<a href="#l27.41"></a><span id="l27.41">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.42"></a><span id="l27.42">       inputStream-&gt;ShareData(msgHdrs, strlen(msgHdrs));</span>
<a href="#l27.43"></a><span id="l27.43">       GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span>
<a href="#l27.44"></a><span id="l27.44">       if (msgHdr) {</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-        nsCOMPtr&lt;nsIInputStream&gt; stream(do_QueryInterface(inputStream));</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-        GetMsgPreviewTextFromStream(msgHdr, stream);</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+        GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l27.48"></a><span id="l27.48">       }</span>
<a href="#l27.49"></a><span id="l27.49">       continue;</span>
<a href="#l27.50"></a><span id="l27.50">     }</span>
<a href="#l27.51"></a><span id="l27.51">     if (mDatabase &amp;&amp; NS_SUCCEEDED(mDatabase-&gt;ContainsKey(msgKey, &amp;containsKey)) &amp;&amp; containsKey)</span>
<a href="#l27.52"></a><span id="l27.52">     {</span>
<a href="#l27.53"></a><span id="l27.53">       NS_ERROR(&quot;downloading hdrs for hdr we already have&quot;);</span>
<a href="#l27.54"></a><span id="l27.54">       continue;</span>
<a href="#l27.55"></a><span id="l27.55">     }</span>
<a href="#l27.56"></a><span id="l27.56" class="difflineat">@@ -3225,17 +3223,17 @@ NS_IMETHODIMP nsImapMailFolder::BeginCop</span>
<a href="#l27.57"></a><span id="l27.57">     if (NS_FAILED(rv))</span>
<a href="#l27.58"></a><span id="l27.58">     {</span>
<a href="#l27.59"></a><span id="l27.59">       nsCString nativePath = m_copyState-&gt;m_tmpFile-&gt;HumanReadablePath();</span>
<a href="#l27.60"></a><span id="l27.60">       MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't remove prev temp file %s: %&quot; PRIx32 &quot;\n&quot;, nativePath.get(), static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l27.61"></a><span id="l27.61">     }</span>
<a href="#l27.62"></a><span id="l27.62">     m_copyState-&gt;m_tmpFile = nullptr;</span>
<a href="#l27.63"></a><span id="l27.63">   }</span>
<a href="#l27.64"></a><span id="l27.64">   if (message)</span>
<a href="#l27.65"></a><span id="l27.65" class="difflineminus">-    m_copyState-&gt;m_message = do_QueryInterface(message, &amp;rv);</span>
<a href="#l27.66"></a><span id="l27.66" class="difflineplus">+    m_copyState-&gt;m_message = message;</span>
<a href="#l27.67"></a><span id="l27.67"> </span>
<a href="#l27.68"></a><span id="l27.68">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l27.69"></a><span id="l27.69">                                        &quot;nscpmsg.txt&quot;,</span>
<a href="#l27.70"></a><span id="l27.70">                                         getter_AddRefs(m_copyState-&gt;m_tmpFile));</span>
<a href="#l27.71"></a><span id="l27.71">   if (NS_FAILED(rv))</span>
<a href="#l27.72"></a><span id="l27.72">     MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;couldn't find nscpmsg.txt:%&quot; PRIx32 &quot;\n&quot;, static_cast&lt;uint32_t&gt;(rv)));</span>
<a href="#l27.73"></a><span id="l27.73">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.74"></a><span id="l27.74"> </span>
<a href="#l27.75"></a><span id="l27.75" class="difflineat">@@ -6627,19 +6625,17 @@ nsresult nsImapMailFolder::DisplayStatus</span>
<a href="#l27.76"></a><span id="l27.76">   nsCOMPtr&lt;nsIImapMockChannel&gt; mockChannel;</span>
<a href="#l27.77"></a><span id="l27.77">   aImapUrl-&gt;GetMockChannel(getter_AddRefs(mockChannel));</span>
<a href="#l27.78"></a><span id="l27.78">   if (mockChannel)</span>
<a href="#l27.79"></a><span id="l27.79">   {</span>
<a href="#l27.80"></a><span id="l27.80">     nsCOMPtr&lt;nsIProgressEventSink&gt; progressSink;</span>
<a href="#l27.81"></a><span id="l27.81">     mockChannel-&gt;GetProgressEventSink(getter_AddRefs(progressSink));</span>
<a href="#l27.82"></a><span id="l27.82">     if (progressSink)</span>
<a href="#l27.83"></a><span id="l27.83">     {</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineminus">-        nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mockChannel);</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineminus">-        if (!request) return NS_ERROR_FAILURE;</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineminus">-      progressSink-&gt;OnStatus(request, nullptr, NS_OK, PromiseFlatString(msg).get());      // XXX i18n message</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+      progressSink-&gt;OnStatus(mockChannel, nullptr, NS_OK, PromiseFlatString(msg).get());      // XXX i18n message</span>
<a href="#l27.88"></a><span id="l27.88">     }</span>
<a href="#l27.89"></a><span id="l27.89">   }</span>
<a href="#l27.90"></a><span id="l27.90">   return NS_OK;</span>
<a href="#l27.91"></a><span id="l27.91"> }</span>
<a href="#l27.92"></a><span id="l27.92"> </span>
<a href="#l27.93"></a><span id="l27.93"> NS_IMETHODIMP</span>
<a href="#l27.94"></a><span id="l27.94"> nsImapMailFolder::ProgressStatusString(nsIImapProtocol* aProtocol,</span>
<a href="#l27.95"></a><span id="l27.95">                                        const char* aMsgName,</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineat">@@ -6691,23 +6687,21 @@ nsImapMailFolder::PercentProgress(nsIIma</span>
<a href="#l27.97"></a><span id="l27.97">       nsCOMPtr&lt;nsIImapMockChannel&gt; mockChannel;</span>
<a href="#l27.98"></a><span id="l27.98">       imapUrl-&gt;GetMockChannel(getter_AddRefs(mockChannel));</span>
<a href="#l27.99"></a><span id="l27.99">       if (mockChannel)</span>
<a href="#l27.100"></a><span id="l27.100">       {</span>
<a href="#l27.101"></a><span id="l27.101">         nsCOMPtr&lt;nsIProgressEventSink&gt; progressSink;</span>
<a href="#l27.102"></a><span id="l27.102">         mockChannel-&gt;GetProgressEventSink(getter_AddRefs(progressSink));</span>
<a href="#l27.103"></a><span id="l27.103">         if (progressSink)</span>
<a href="#l27.104"></a><span id="l27.104">         {</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-            nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mockChannel);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-            if (!request) return NS_ERROR_FAILURE;</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-            progressSink-&gt;OnProgress(request, nullptr,</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+            progressSink-&gt;OnProgress(mockChannel, nullptr,</span>
<a href="#l27.109"></a><span id="l27.109">                                      aCurrentProgress,</span>
<a href="#l27.110"></a><span id="l27.110">                                      aMaxProgress);</span>
<a href="#l27.111"></a><span id="l27.111">             if (aMessage)</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-              progressSink-&gt;OnStatus(request, nullptr, NS_OK, aMessage); // XXX i18n message</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+              progressSink-&gt;OnStatus(mockChannel, nullptr, NS_OK, aMessage); // XXX i18n message</span>
<a href="#l27.114"></a><span id="l27.114">         }</span>
<a href="#l27.115"></a><span id="l27.115">       }</span>
<a href="#l27.116"></a><span id="l27.116">     }</span>
<a href="#l27.117"></a><span id="l27.117">   }</span>
<a href="#l27.118"></a><span id="l27.118">   return NS_OK;</span>
<a href="#l27.119"></a><span id="l27.119"> }</span>
<a href="#l27.120"></a><span id="l27.120"> </span>
<a href="#l27.121"></a><span id="l27.121"> NS_IMETHODIMP</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineat">@@ -8095,16 +8089,17 @@ nsImapMailFolder::CopyFileMessage(nsIFil</span>
<a href="#l27.123"></a><span id="l27.123"> }</span>
<a href="#l27.124"></a><span id="l27.124"> </span>
<a href="#l27.125"></a><span id="l27.125"> nsresult</span>
<a href="#l27.126"></a><span id="l27.126"> nsImapMailFolder::CopyStreamMessage(nsIMsgDBHdr* message,</span>
<a href="#l27.127"></a><span id="l27.127">                                     nsIMsgFolder* dstFolder, // should be this</span>
<a href="#l27.128"></a><span id="l27.128">                                     nsIMsgWindow *aMsgWindow,</span>
<a href="#l27.129"></a><span id="l27.129">                                     bool isMove)</span>
<a href="#l27.130"></a><span id="l27.130"> {</span>
<a href="#l27.131"></a><span id="l27.131" class="difflineplus">+  NS_ENSURE_ARG_POINTER(message);</span>
<a href="#l27.132"></a><span id="l27.132">   if (!m_copyState)</span>
<a href="#l27.133"></a><span id="l27.133">     MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreamMessage failed with null m_copyState&quot;));</span>
<a href="#l27.134"></a><span id="l27.134">   NS_ENSURE_TRUE(m_copyState, NS_ERROR_NULL_POINTER);</span>
<a href="#l27.135"></a><span id="l27.135">   nsresult rv;</span>
<a href="#l27.136"></a><span id="l27.136">   nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener = do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l27.137"></a><span id="l27.137">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l27.138"></a><span id="l27.138"> </span>
<a href="#l27.139"></a><span id="l27.139">   nsCOMPtr&lt;nsICopyMessageListener&gt; copyListener(do_QueryInterface(dstFolder, &amp;rv));</span>
<a href="#l27.140"></a><span id="l27.140" class="difflineat">@@ -8114,21 +8109,18 @@ nsImapMailFolder::CopyStreamMessage(nsIM</span>
<a href="#l27.141"></a><span id="l27.141">   if (NS_FAILED(rv))</span>
<a href="#l27.142"></a><span id="l27.142">     MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreaMessage failed with null m_copyState-&gt;m_srcSupport&quot;));</span>
<a href="#l27.143"></a><span id="l27.143">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.144"></a><span id="l27.144">   rv = copyStreamListener-&gt;Init(srcFolder, copyListener, nullptr);</span>
<a href="#l27.145"></a><span id="l27.145">   if (NS_FAILED(rv))</span>
<a href="#l27.146"></a><span id="l27.146">     MOZ_LOG(IMAP, mozilla::LogLevel::Info, (&quot;CopyStreaMessage failed in copyStreamListener-&gt;Init&quot;));</span>
<a href="#l27.147"></a><span id="l27.147">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.148"></a><span id="l27.148"> </span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-</span>
<a href="#l27.152"></a><span id="l27.152">   nsCString uri;</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-  srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineplus">+  srcFolder-&gt;GetUriForMsg(message, uri);</span>
<a href="#l27.155"></a><span id="l27.155"> </span>
<a href="#l27.156"></a><span id="l27.156">   if (!m_copyState-&gt;m_msgService)</span>
<a href="#l27.157"></a><span id="l27.157">     rv = GetMessageServiceFromURI(uri, getter_AddRefs(m_copyState-&gt;m_msgService));</span>
<a href="#l27.158"></a><span id="l27.158"> </span>
<a href="#l27.159"></a><span id="l27.159">   if (NS_SUCCEEDED(rv) &amp;&amp; m_copyState-&gt;m_msgService)</span>
<a href="#l27.160"></a><span id="l27.160">   {</span>
<a href="#l27.161"></a><span id="l27.161">     nsCOMPtr&lt;nsIStreamListener&gt; streamListener(do_QueryInterface(copyStreamListener, &amp;rv));</span>
<a href="#l27.162"></a><span id="l27.162">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineat">@@ -8269,18 +8261,18 @@ nsImapMailFolder::InitCopyState(nsISuppo</span>
<a href="#l27.164"></a><span id="l27.164"> </span>
<a href="#l27.165"></a><span id="l27.165">   m_copyState-&gt;m_isMove = isMove;</span>
<a href="#l27.166"></a><span id="l27.166">   m_copyState-&gt;m_newMsgFlags = newMsgFlags;</span>
<a href="#l27.167"></a><span id="l27.167">   m_copyState-&gt;m_newMsgKeywords = newMsgKeywords;</span>
<a href="#l27.168"></a><span id="l27.168">   m_copyState-&gt;m_allowUndo = allowUndo;</span>
<a href="#l27.169"></a><span id="l27.169">   m_copyState-&gt;m_selectedState = selectedState;</span>
<a href="#l27.170"></a><span id="l27.170">   m_copyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l27.171"></a><span id="l27.171">   if (listener)</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineminus">-    m_copyState-&gt;m_listener = do_QueryInterface(listener, &amp;rv);</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineminus">-  return rv;</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+    m_copyState-&gt;m_listener = listener;</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+  return NS_OK;</span>
<a href="#l27.176"></a><span id="l27.176"> }</span>
<a href="#l27.177"></a><span id="l27.177"> </span>
<a href="#l27.178"></a><span id="l27.178"> nsresult</span>
<a href="#l27.179"></a><span id="l27.179"> nsImapMailFolder::CopyFileToOfflineStore(nsIFile *srcFile, nsMsgKey msgKey)</span>
<a href="#l27.180"></a><span id="l27.180"> {</span>
<a href="#l27.181"></a><span id="l27.181">   nsresult rv = GetDatabase();</span>
<a href="#l27.182"></a><span id="l27.182">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.183"></a><span id="l27.183"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -474,17 +474,17 @@ nsImapOfflineSync::ProcessAppendMsgOpera</span>
<a href="#l28.4"></a><span id="l28.4">       // fails to close above.</span>
<a href="#l28.5"></a><span id="l28.5">       mozilla::Unused &lt;&lt; NS_WARN_IF(NS_FAILED(tmpFile-&gt;Remove(false)));</span>
<a href="#l28.6"></a><span id="l28.6">       break;</span>
<a href="#l28.7"></a><span id="l28.7">     }</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9">     nsCOMPtr&lt;nsIFile&gt; cloneTmpFile;</span>
<a href="#l28.10"></a><span id="l28.10">     // clone the tmp file to defeat nsIFile's stat/size caching.</span>
<a href="#l28.11"></a><span id="l28.11">     tmpFile-&gt;Clone(getter_AddRefs(cloneTmpFile));</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    m_curTempFile = do_QueryInterface(cloneTmpFile);</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    m_curTempFile = cloneTmpFile;</span>
<a href="#l28.14"></a><span id="l28.14">     nsCOMPtr&lt;nsIMsgCopyService&gt; copyService = do_GetService(NS_MSGCOPYSERVICE_CONTRACTID);</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16">     // CopyFileMessage returns error async to this-&gt;OnStopCopy</span>
<a href="#l28.17"></a><span id="l28.17">     // if copyService is null, let's crash here and now.</span>
<a href="#l28.18"></a><span id="l28.18">     rv = copyService-&gt;CopyFileMessage(cloneTmpFile, destFolder,</span>
<a href="#l28.19"></a><span id="l28.19">                                       nullptr, // nsIMsgDBHdr* msgToReplace</span>
<a href="#l28.20"></a><span id="l28.20">                                       true,    // isDraftOrTemplate</span>
<a href="#l28.21"></a><span id="l28.21">                                       0,       // new msg flags</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -738,19 +738,18 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l29.4"></a><span id="l29.4">                          nsIContentPolicy::TYPE_OTHER);</span>
<a href="#l29.5"></a><span id="l29.5">       m_mockChannel = do_QueryInterface(channel);</span>
<a href="#l29.6"></a><span id="l29.6"> </span>
<a href="#l29.7"></a><span id="l29.7">       // Certain imap operations (not initiated by the IO Service via AsyncOpen) can be interrupted by  the stop button on the toolbar.</span>
<a href="#l29.8"></a><span id="l29.8">       // We do this by using the loadgroup of the docshell for the message pane. We really shouldn't be doing this..</span>
<a href="#l29.9"></a><span id="l29.9">       // See the comment in nsMsgMailNewsUrl::GetLoadGroup.</span>
<a href="#l29.10"></a><span id="l29.10">       nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l29.11"></a><span id="l29.11">       mailnewsUrl-&gt;GetLoadGroup(getter_AddRefs(loadGroup)); // get the message pane load group</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-      nsCOMPtr&lt;nsIRequest&gt; ourRequest = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.13"></a><span id="l29.13">       if (loadGroup)</span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-        loadGroup-&gt;AddRequest(ourRequest, nullptr /* context isupports */);</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineplus">+        loadGroup-&gt;AddRequest(m_mockChannel, nullptr /* context isupports */);</span>
<a href="#l29.16"></a><span id="l29.16">     }</span>
<a href="#l29.17"></a><span id="l29.17"> </span>
<a href="#l29.18"></a><span id="l29.18">     if (m_mockChannel)</span>
<a href="#l29.19"></a><span id="l29.19">     {</span>
<a href="#l29.20"></a><span id="l29.20">       m_mockChannel-&gt;SetImapProtocol(this);</span>
<a href="#l29.21"></a><span id="l29.21">       // if we have a listener from a mock channel, over-ride the consumer that was passed in</span>
<a href="#l29.22"></a><span id="l29.22">       nsCOMPtr&lt;nsIStreamListener&gt; channelListener;</span>
<a href="#l29.23"></a><span id="l29.23">       m_mockChannel-&gt;GetChannelListener(getter_AddRefs(channelListener));</span>
<a href="#l29.24"></a><span id="l29.24" class="difflineat">@@ -1603,18 +1602,17 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l29.25"></a><span id="l29.25">     if (m_imapAction == nsIImapUrl::nsImapSelectFolder)</span>
<a href="#l29.26"></a><span id="l29.26">     {</span>
<a href="#l29.27"></a><span id="l29.27">       // we need to send a start request so that the doc loader</span>
<a href="#l29.28"></a><span id="l29.28">       // will call HandleContent on the imap service so we</span>
<a href="#l29.29"></a><span id="l29.29">       // can abort this url, and run a new url in a new msg window</span>
<a href="#l29.30"></a><span id="l29.30">       // to run the folder load url and get off this crazy merry-go-round.</span>
<a href="#l29.31"></a><span id="l29.31">       if (m_channelListener)</span>
<a href="#l29.32"></a><span id="l29.32">       {</span>
<a href="#l29.33"></a><span id="l29.33" class="difflineminus">-        nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-        m_channelListener-&gt;OnStartRequest(request, m_channelContext);</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+        m_channelListener-&gt;OnStartRequest(m_mockChannel, m_channelContext);</span>
<a href="#l29.36"></a><span id="l29.36">       }</span>
<a href="#l29.37"></a><span id="l29.37">       return false;</span>
<a href="#l29.38"></a><span id="l29.38">     }</span>
<a href="#l29.39"></a><span id="l29.39">   }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41">   if (!m_imapMailFolderSink &amp;&amp; m_imapProtocolSink)</span>
<a href="#l29.42"></a><span id="l29.42">   {</span>
<a href="#l29.43"></a><span id="l29.43">     // This occurs when running another URL in the main thread loop</span>
<a href="#l29.44"></a><span id="l29.44" class="difflineat">@@ -1639,18 +1637,17 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l29.45"></a><span id="l29.45">     m_imapMailFolderSink-&gt;SetUrlState(this, mailnewsurl, true, false,</span>
<a href="#l29.46"></a><span id="l29.46">                                       NS_OK);</span>
<a href="#l29.47"></a><span id="l29.47"> </span>
<a href="#l29.48"></a><span id="l29.48">   // if we are set up as a channel, we should notify our channel listener that we are starting...</span>
<a href="#l29.49"></a><span id="l29.49">   // so pass in ourself as the channel and not the underlying socket or file channel the protocol</span>
<a href="#l29.50"></a><span id="l29.50">   // happens to be using</span>
<a href="#l29.51"></a><span id="l29.51">   if (m_channelListener) // ### not sure we want to do this if rerunning url...</span>
<a href="#l29.52"></a><span id="l29.52">   {</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-    nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-    m_channelListener-&gt;OnStartRequest(request, m_channelContext);</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+    m_channelListener-&gt;OnStartRequest(m_mockChannel, m_channelContext);</span>
<a href="#l29.56"></a><span id="l29.56">   }</span>
<a href="#l29.57"></a><span id="l29.57">   // If we haven't received the greeting yet, we need to make sure we strip</span>
<a href="#l29.58"></a><span id="l29.58">   // it out of the input before we start to do useful things...</span>
<a href="#l29.59"></a><span id="l29.59">   if (!TestFlag(IMAP_RECEIVED_GREETING))</span>
<a href="#l29.60"></a><span id="l29.60">     EstablishServerConnection();</span>
<a href="#l29.61"></a><span id="l29.61"> </span>
<a href="#l29.62"></a><span id="l29.62">   // Step 1: If we have not moved into the authenticated state yet then do so</span>
<a href="#l29.63"></a><span id="l29.63">   // by attempting to logon.</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineat">@@ -1676,21 +1673,19 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l29.65"></a><span id="l29.65">              &amp;&amp; (m_socketType == nsMsgSocketType::trySTARTTLS</span>
<a href="#l29.66"></a><span id="l29.66">              &amp;&amp; (GetServerStateParser().GetCapabilityFlag() &amp; kHasStartTLSCapability)))</span>
<a href="#l29.67"></a><span id="l29.67">             || m_socketType == nsMsgSocketType::alwaysSTARTTLS)</span>
<a href="#l29.68"></a><span id="l29.68">         {</span>
<a href="#l29.69"></a><span id="l29.69">           StartTLS();</span>
<a href="#l29.70"></a><span id="l29.70">           if (GetServerStateParser().LastCommandSuccessful())</span>
<a href="#l29.71"></a><span id="l29.71">           {</span>
<a href="#l29.72"></a><span id="l29.72">             nsCOMPtr&lt;nsISupports&gt; secInfo;</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-            nsCOMPtr&lt;nsISocketTransport&gt; strans = do_QueryInterface(m_transport, &amp;rv);</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineminus">-            if (NS_FAILED(rv))</span>
<a href="#l29.75"></a><span id="l29.75" class="difflineminus">-              return false;</span>
<a href="#l29.76"></a><span id="l29.76" class="difflineminus">-</span>
<a href="#l29.77"></a><span id="l29.77" class="difflineminus">-            rv = strans-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineplus">+</span>
<a href="#l29.79"></a><span id="l29.79" class="difflineplus">+            NS_ENSURE_TRUE(m_transport, false);</span>
<a href="#l29.80"></a><span id="l29.80" class="difflineplus">+            rv = m_transport-&gt;GetSecurityInfo(getter_AddRefs(secInfo));</span>
<a href="#l29.81"></a><span id="l29.81"> </span>
<a href="#l29.82"></a><span id="l29.82">             if (NS_SUCCEEDED(rv) &amp;&amp; secInfo)</span>
<a href="#l29.83"></a><span id="l29.83">             {</span>
<a href="#l29.84"></a><span id="l29.84">               nsCOMPtr&lt;nsISSLSocketControl&gt; sslControl = do_QueryInterface(secInfo, &amp;rv);</span>
<a href="#l29.85"></a><span id="l29.85"> </span>
<a href="#l29.86"></a><span id="l29.86">               if (NS_SUCCEEDED(rv) &amp;&amp; sslControl)</span>
<a href="#l29.87"></a><span id="l29.87">               {</span>
<a href="#l29.88"></a><span id="l29.88">                 rv = sslControl-&gt;StartTLS();</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineat">@@ -1794,24 +1789,23 @@ bool nsImapProtocol::ProcessCurrentURL()</span>
<a href="#l29.90"></a><span id="l29.90">   else if (!logonFailed)</span>
<a href="#l29.91"></a><span id="l29.91">       HandleCurrentUrlError();</span>
<a href="#l29.92"></a><span id="l29.92"> </span>
<a href="#l29.93"></a><span id="l29.93"> // if we are set up as a channel, we should notify our channel listener that we are stopping...</span>
<a href="#l29.94"></a><span id="l29.94"> // so pass in ourself as the channel and not the underlying socket or file channel the protocol</span>
<a href="#l29.95"></a><span id="l29.95"> // happens to be using</span>
<a href="#l29.96"></a><span id="l29.96">   if (m_channelListener)</span>
<a href="#l29.97"></a><span id="l29.97">   {</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineminus">-      nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineminus">-      NS_ASSERTION(request, &quot;no request&quot;);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineminus">-      if (request) {</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+      NS_ASSERTION(m_mockChannel, &quot;no request&quot;);</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+      if (m_mockChannel) {</span>
<a href="#l29.103"></a><span id="l29.103">         nsresult status;</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineminus">-        request-&gt;GetStatus(&amp;status);</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+        m_mockChannel-&gt;GetStatus(&amp;status);</span>
<a href="#l29.106"></a><span id="l29.106">         if (!GetServerStateParser().LastCommandSuccessful() &amp;&amp; NS_SUCCEEDED(status))</span>
<a href="#l29.107"></a><span id="l29.107">           status = NS_MSG_ERROR_IMAP_COMMAND_FAILED;</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineminus">-        rv = m_channelListener-&gt;OnStopRequest(request, m_channelContext, status);</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+        rv = m_channelListener-&gt;OnStopRequest(m_mockChannel, m_channelContext, status);</span>
<a href="#l29.110"></a><span id="l29.110">       }</span>
<a href="#l29.111"></a><span id="l29.111">   }</span>
<a href="#l29.112"></a><span id="l29.112">   bool suspendUrl = false;</span>
<a href="#l29.113"></a><span id="l29.113">   m_runningUrl-&gt;GetMoreHeadersToDownload(&amp;suspendUrl);</span>
<a href="#l29.114"></a><span id="l29.114">   if (mailnewsurl &amp;&amp; m_imapMailFolderSink)</span>
<a href="#l29.115"></a><span id="l29.115">   {</span>
<a href="#l29.116"></a><span id="l29.116">     if (logonFailed)</span>
<a href="#l29.117"></a><span id="l29.117">       rv = NS_ERROR_FAILURE;</span>
<a href="#l29.118"></a><span id="l29.118" class="difflineat">@@ -3813,18 +3807,17 @@ nsImapProtocol::PostLineDownLoadEvent(co</span>
<a href="#l29.119"></a><span id="l29.119">     {</span>
<a href="#l29.120"></a><span id="l29.120">       uint32_t count = 0;</span>
<a href="#l29.121"></a><span id="l29.121">       if (m_channelOutputStream)</span>
<a href="#l29.122"></a><span id="l29.122">       {</span>
<a href="#l29.123"></a><span id="l29.123">         nsresult rv = m_channelOutputStream-&gt;Write(line, byteCount, &amp;count);</span>
<a href="#l29.124"></a><span id="l29.124">         NS_ASSERTION(count == byteCount, &quot;IMAP channel pipe couldn't buffer entire write&quot;);</span>
<a href="#l29.125"></a><span id="l29.125">         if (NS_SUCCEEDED(rv))</span>
<a href="#l29.126"></a><span id="l29.126">         {</span>
<a href="#l29.127"></a><span id="l29.127" class="difflineminus">-          nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.128"></a><span id="l29.128" class="difflineminus">-          m_channelListener-&gt;OnDataAvailable(request, m_channelContext, m_channelInputStream, 0, count);</span>
<a href="#l29.129"></a><span id="l29.129" class="difflineplus">+          m_channelListener-&gt;OnDataAvailable(m_mockChannel, m_channelContext, m_channelInputStream, 0, count);</span>
<a href="#l29.130"></a><span id="l29.130">         }</span>
<a href="#l29.131"></a><span id="l29.131">         // else some sort of explosion?</span>
<a href="#l29.132"></a><span id="l29.132">       }</span>
<a href="#l29.133"></a><span id="l29.133">     }</span>
<a href="#l29.134"></a><span id="l29.134">     if (m_runningUrl)</span>
<a href="#l29.135"></a><span id="l29.135">       m_runningUrl-&gt;GetStoreResultsOffline(&amp;echoLineToMessageSink);</span>
<a href="#l29.136"></a><span id="l29.136"> </span>
<a href="#l29.137"></a><span id="l29.137">     m_bytesToChannel += byteCount;</span>
<a href="#l29.138"></a><span id="l29.138" class="difflineat">@@ -4758,24 +4751,20 @@ uint32_t nsImapProtocol::CountMessagesIn</span>
<a href="#l29.139"></a><span id="l29.139"> // It would be really nice not to have to use this method nearly as much as we did</span>
<a href="#l29.140"></a><span id="l29.140"> // in 4.5 - we need to think about this some. Some of it may just go away in the new world order</span>
<a href="#l29.141"></a><span id="l29.141"> bool nsImapProtocol::DeathSignalReceived()</span>
<a href="#l29.142"></a><span id="l29.142"> {</span>
<a href="#l29.143"></a><span id="l29.143">   // ignore mock channel status if we've been pseudo interrupted</span>
<a href="#l29.144"></a><span id="l29.144">   // ### need to make sure we clear pseudo interrupted status appropriately.</span>
<a href="#l29.145"></a><span id="l29.145">   if (!GetPseudoInterrupted() &amp;&amp; m_mockChannel)</span>
<a href="#l29.146"></a><span id="l29.146">   {</span>
<a href="#l29.147"></a><span id="l29.147" class="difflineminus">-    nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(m_mockChannel);</span>
<a href="#l29.148"></a><span id="l29.148" class="difflineminus">-    if (request)</span>
<a href="#l29.149"></a><span id="l29.149" class="difflineminus">-    {</span>
<a href="#l29.150"></a><span id="l29.150" class="difflineminus">-      nsresult returnValue;</span>
<a href="#l29.151"></a><span id="l29.151" class="difflineminus">-      request-&gt;GetStatus(&amp;returnValue);</span>
<a href="#l29.152"></a><span id="l29.152" class="difflineminus">-      if (NS_FAILED(returnValue))</span>
<a href="#l29.153"></a><span id="l29.153" class="difflineminus">-        return false;</span>
<a href="#l29.154"></a><span id="l29.154" class="difflineminus">-    }</span>
<a href="#l29.155"></a><span id="l29.155" class="difflineplus">+    nsresult returnValue;</span>
<a href="#l29.156"></a><span id="l29.156" class="difflineplus">+    m_mockChannel-&gt;GetStatus(&amp;returnValue);</span>
<a href="#l29.157"></a><span id="l29.157" class="difflineplus">+    if (NS_FAILED(returnValue))</span>
<a href="#l29.158"></a><span id="l29.158" class="difflineplus">+      return false;</span>
<a href="#l29.159"></a><span id="l29.159">   }</span>
<a href="#l29.160"></a><span id="l29.160"> </span>
<a href="#l29.161"></a><span id="l29.161">   // Check the other way of cancelling.</span>
<a href="#l29.162"></a><span id="l29.162">   ReentrantMonitorAutoEnter threadDeathMon(m_threadDeathMonitor);</span>
<a href="#l29.163"></a><span id="l29.163">   return m_threadShouldDie;</span>
<a href="#l29.164"></a><span id="l29.164"> }</span>
<a href="#l29.165"></a><span id="l29.165"> </span>
<a href="#l29.166"></a><span id="l29.166"> NS_IMETHODIMP nsImapProtocol::ResetToAuthenticatedState()</span>
<a href="#l29.167"></a><span id="l29.167" class="difflineat">@@ -9004,20 +8993,19 @@ nsImapCacheStreamListener::OnStartReques</span>
<a href="#l29.168"></a><span id="l29.168"> {</span>
<a href="#l29.169"></a><span id="l29.169">   if (!mChannelToUse)</span>
<a href="#l29.170"></a><span id="l29.170">   {</span>
<a href="#l29.171"></a><span id="l29.171">     NS_ERROR(&quot;OnStartRequest called after OnStopRequest&quot;);</span>
<a href="#l29.172"></a><span id="l29.172">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l29.173"></a><span id="l29.173">   }</span>
<a href="#l29.174"></a><span id="l29.174">   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l29.175"></a><span id="l29.175">   mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l29.176"></a><span id="l29.176" class="difflineminus">-  nsCOMPtr&lt;nsIRequest&gt; ourRequest = do_QueryInterface(mChannelToUse);</span>
<a href="#l29.177"></a><span id="l29.177">   if (loadGroup)</span>
<a href="#l29.178"></a><span id="l29.178" class="difflineminus">-    loadGroup-&gt;AddRequest(ourRequest, nullptr /* context isupports */);</span>
<a href="#l29.179"></a><span id="l29.179" class="difflineminus">-  return mListener-&gt;OnStartRequest(ourRequest, aCtxt);</span>
<a href="#l29.180"></a><span id="l29.180" class="difflineplus">+    loadGroup-&gt;AddRequest(mChannelToUse, nullptr /* context isupports */);</span>
<a href="#l29.181"></a><span id="l29.181" class="difflineplus">+  return mListener-&gt;OnStartRequest(mChannelToUse, aCtxt);</span>
<a href="#l29.182"></a><span id="l29.182"> }</span>
<a href="#l29.183"></a><span id="l29.183"> </span>
<a href="#l29.184"></a><span id="l29.184"> NS_IMETHODIMP</span>
<a href="#l29.185"></a><span id="l29.185"> nsImapCacheStreamListener::OnStopRequest(nsIRequest *request, nsISupports * aCtxt, nsresult aStatus)</span>
<a href="#l29.186"></a><span id="l29.186"> {</span>
<a href="#l29.187"></a><span id="l29.187">   if (!mListener)</span>
<a href="#l29.188"></a><span id="l29.188">   {</span>
<a href="#l29.189"></a><span id="l29.189">     NS_ERROR(&quot;OnStopRequest called twice&quot;);</span>
<a href="#l29.190"></a><span id="l29.190" class="difflineat">@@ -9350,17 +9338,17 @@ nsImapMockChannel::OnCacheEntryAvailable</span>
<a href="#l29.191"></a><span id="l29.191">       {</span>
<a href="#l29.192"></a><span id="l29.192">         nsCOMPtr&lt;nsIOutputStream&gt; out;</span>
<a href="#l29.193"></a><span id="l29.193">         // This will fail with the cache turned off, so we need to fall through</span>
<a href="#l29.194"></a><span id="l29.194">         // to ReadFromImapConnection instead of aborting with NS_ENSURE_SUCCESS(rv,rv).</span>
<a href="#l29.195"></a><span id="l29.195">         rv = entry-&gt;OpenOutputStream(0, -1, getter_AddRefs(out));</span>
<a href="#l29.196"></a><span id="l29.196">         if (NS_SUCCEEDED(rv))</span>
<a href="#l29.197"></a><span id="l29.197">         {</span>
<a href="#l29.198"></a><span id="l29.198">           rv = tee-&gt;Init(m_channelListener, out, nullptr);</span>
<a href="#l29.199"></a><span id="l29.199" class="difflineminus">-          m_channelListener = do_QueryInterface(tee);</span>
<a href="#l29.200"></a><span id="l29.200" class="difflineplus">+          m_channelListener = tee;</span>
<a href="#l29.201"></a><span id="l29.201">         }</span>
<a href="#l29.202"></a><span id="l29.202">         else</span>
<a href="#l29.203"></a><span id="l29.203">           NS_WARNING(&quot;IMAP Protocol failed to open output stream to Necko cache&quot;);</span>
<a href="#l29.204"></a><span id="l29.204">       }</span>
<a href="#l29.205"></a><span id="l29.205">     }</span>
<a href="#l29.206"></a><span id="l29.206">     else</span>
<a href="#l29.207"></a><span id="l29.207">     {</span>
<a href="#l29.208"></a><span id="l29.208">       rv = ReadFromMemCache(entry);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -2199,18 +2199,17 @@ nsresult nsImapService::GetImapConnectio</span>
<a href="#l30.4"></a><span id="l30.4">   }</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; aMsgIncomingServer;</span>
<a href="#l30.7"></a><span id="l30.7">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; msgUrl = do_QueryInterface(aImapUrl);</span>
<a href="#l30.8"></a><span id="l30.8">   nsresult rv = msgUrl-&gt;GetServer(getter_AddRefs(aMsgIncomingServer));</span>
<a href="#l30.9"></a><span id="l30.9"> </span>
<a href="#l30.10"></a><span id="l30.10">   if (aURL)</span>
<a href="#l30.11"></a><span id="l30.11">   {</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-    nsCOMPtr&lt;nsIURI&gt; msgUrlUri = do_QueryInterface(msgUrl);</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineminus">-    msgUrlUri.forget(aURL);</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+    msgUrl.forget(aURL);</span>
<a href="#l30.15"></a><span id="l30.15">   }</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17">   if (NS_SUCCEEDED(rv) &amp;&amp; aMsgIncomingServer)</span>
<a href="#l30.18"></a><span id="l30.18">   {</span>
<a href="#l30.19"></a><span id="l30.19">     nsCOMPtr&lt;nsIImapIncomingServer&gt; aImapServer(do_QueryInterface(aMsgIncomingServer, &amp;rv));</span>
<a href="#l30.20"></a><span id="l30.20">     if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l30.21"></a><span id="l30.21">       rv = aImapServer-&gt;GetImapConnectionAndLoadUrl(aImapUrl, aConsumer);</span>
<a href="#l30.22"></a><span id="l30.22">   }</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineat">@@ -2590,26 +2589,25 @@ NS_IMETHODIMP nsImapService::NewURI(cons</span>
<a href="#l30.24"></a><span id="l30.24">     // in this low-level service. Cloning URIs where the folder</span>
<a href="#l30.25"></a><span id="l30.25">     // isn't found is common when folders are renamed or moved.</span>
<a href="#l30.26"></a><span id="l30.26">     // We also ignore return statuses here.</span>
<a href="#l30.27"></a><span id="l30.27">     if (folder)</span>
<a href="#l30.28"></a><span id="l30.28">     {</span>
<a href="#l30.29"></a><span id="l30.29">       nsCOMPtr&lt;nsIImapMessageSink&gt; msgSink = do_QueryInterface(folder);</span>
<a href="#l30.30"></a><span id="l30.30">       (void) aImapUrl-&gt;SetImapMessageSink(msgSink);</span>
<a href="#l30.31"></a><span id="l30.31"> </span>
<a href="#l30.32"></a><span id="l30.32" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder = do_QueryInterface(folder);</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-      (void) SetImapUrlSink(msgFolder, aImapUrl);</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+      (void) SetImapUrlSink(folder, aImapUrl);</span>
<a href="#l30.35"></a><span id="l30.35"> </span>
<a href="#l30.36"></a><span id="l30.36">       nsCString messageIdString;</span>
<a href="#l30.37"></a><span id="l30.37">       aImapUrl-&gt;GetListOfMessageIds(messageIdString);</span>
<a href="#l30.38"></a><span id="l30.38">       if (!messageIdString.IsEmpty())</span>
<a href="#l30.39"></a><span id="l30.39">       {</span>
<a href="#l30.40"></a><span id="l30.40">         bool useLocalCache = false;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-        msgFolder-&gt;HasMsgOffline(strtoul(messageIdString.get(), nullptr, 10),</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineminus">-                                 &amp;useLocalCache);</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+        folder-&gt;HasMsgOffline(strtoul(messageIdString.get(), nullptr, 10),</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+                              &amp;useLocalCache);</span>
<a href="#l30.45"></a><span id="l30.45">         mailnewsUrl-&gt;SetMsgIsInLocalCache(useLocalCache);</span>
<a href="#l30.46"></a><span id="l30.46">       }</span>
<a href="#l30.47"></a><span id="l30.47">     }</span>
<a href="#l30.48"></a><span id="l30.48">   }</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50">   // if we are fetching a part, be sure to enable fetch parts on demand</span>
<a href="#l30.51"></a><span id="l30.51">   bool mimePartSelectorDetected = false;</span>
<a href="#l30.52"></a><span id="l30.52">   aImapUrl-&gt;GetMimePartSelectorDetected(&amp;mimePartSelectorDetected);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/import/src/nsImportEncodeScan.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -68,17 +68,17 @@ nsImportEncodeScan::~nsImportEncodeScan(</span>
<a href="#l31.4"></a><span id="l31.4"> {</span>
<a href="#l31.5"></a><span id="l31.5"> }</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> bool nsImportEncodeScan::InitEncodeScan(bool appleSingleEncode, nsIFile *fileLoc, const char *pName, uint8_t * pBuf, uint32_t sz)</span>
<a href="#l31.8"></a><span id="l31.8"> {</span>
<a href="#l31.9"></a><span id="l31.9">   CleanUpEncodeScan();</span>
<a href="#l31.10"></a><span id="l31.10">   m_isAppleSingle = appleSingleEncode;</span>
<a href="#l31.11"></a><span id="l31.11">   m_encodeScanState = kBeginAppleSingle;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-  m_pInputFile = do_QueryInterface(fileLoc);</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+  m_pInputFile = fileLoc;</span>
<a href="#l31.14"></a><span id="l31.14">   m_useFileName = pName;</span>
<a href="#l31.15"></a><span id="l31.15">   m_pBuf = pBuf;</span>
<a href="#l31.16"></a><span id="l31.16">   m_bufSz = sz;</span>
<a href="#l31.17"></a><span id="l31.17">   if (!m_isAppleSingle)</span>
<a href="#l31.18"></a><span id="l31.18">         {</span>
<a href="#l31.19"></a><span id="l31.19">     if (!m_inputStream)</span>
<a href="#l31.20"></a><span id="l31.20">                 {</span>
<a href="#l31.21"></a><span id="l31.21">                   nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(m_inputStream), m_pInputFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/import/text/src/nsTextImport.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -260,17 +260,17 @@ NS_IMETHODIMP ImportAddressImpl::FindAdd</span>
<a href="#l32.4"></a><span id="l32.4"> </span>
<a href="#l32.5"></a><span id="l32.5">   if (NS_FAILED(rv)) {</span>
<a href="#l32.6"></a><span id="l32.6">     IMPORT_LOG0(&quot;*** Error determining delimitter\n&quot;);</span>
<a href="#l32.7"></a><span id="l32.7">     return rv;</span>
<a href="#l32.8"></a><span id="l32.8">   }</span>
<a href="#l32.9"></a><span id="l32.9">   m_haveDelim = true;</span>
<a href="#l32.10"></a><span id="l32.10">   m_delim = m_text.GetDelim();</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  m_fileLoc = do_QueryInterface(pLoc);</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  m_fileLoc = pLoc;</span>
<a href="#l32.14"></a><span id="l32.14"> </span>
<a href="#l32.15"></a><span id="l32.15">   /* Build an address book descriptor based on the file passed in! */</span>
<a href="#l32.16"></a><span id="l32.16">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l32.17"></a><span id="l32.17">   if (NS_FAILED(rv)) {</span>
<a href="#l32.18"></a><span id="l32.18">     IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray\n&quot;);</span>
<a href="#l32.19"></a><span id="l32.19">     return rv;</span>
<a href="#l32.20"></a><span id="l32.20">   }</span>
<a href="#l32.21"></a><span id="l32.21"> </span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -572,17 +572,17 @@ NS_IMETHODIMP ImportAddressImpl::GetSamp</span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24">   return NS_OK;</span>
<a href="#l32.25"></a><span id="l32.25"> }</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> NS_IMETHODIMP ImportAddressImpl::SetSampleLocation(nsIFile *pLocation)</span>
<a href="#l32.28"></a><span id="l32.28"> {</span>
<a href="#l32.29"></a><span id="l32.29">   NS_ENSURE_ARG_POINTER(pLocation);</span>
<a href="#l32.30"></a><span id="l32.30"> </span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  m_fileLoc = do_QueryInterface(pLocation);</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineplus">+  m_fileLoc = pLocation;</span>
<a href="#l32.33"></a><span id="l32.33">   m_haveDelim = false;</span>
<a href="#l32.34"></a><span id="l32.34">   return NS_OK;</span>
<a href="#l32.35"></a><span id="l32.35"> }</span>
<a href="#l32.36"></a><span id="l32.36"> </span>
<a href="#l32.37"></a><span id="l32.37"> void ImportAddressImpl::ClearSampleFile(void)</span>
<a href="#l32.38"></a><span id="l32.38"> {</span>
<a href="#l32.39"></a><span id="l32.39">   m_fileLoc = nullptr;</span>
<a href="#l32.40"></a><span id="l32.40">   m_haveDelim = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/import/vcard/src/nsVCardImport.cpp</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -224,17 +224,17 @@ NS_IMETHODIMP ImportVCardAddressImpl::Fi</span>
<a href="#l33.4"></a><span id="l33.4">   if (NS_FAILED(rv) || !exists)</span>
<a href="#l33.5"></a><span id="l33.5">     return NS_ERROR_FAILURE;</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7">   bool isFile = false;</span>
<a href="#l33.8"></a><span id="l33.8">   rv = pLoc-&gt;IsFile(&amp;isFile);</span>
<a href="#l33.9"></a><span id="l33.9">   if (NS_FAILED(rv) || !isFile)</span>
<a href="#l33.10"></a><span id="l33.10">     return NS_ERROR_FAILURE;</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  m_fileLoc = do_QueryInterface(pLoc);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+  m_fileLoc = pLoc;</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15">   /* Build an address book descriptor based on the file passed in! */</span>
<a href="#l33.16"></a><span id="l33.16">   nsCOMPtr&lt;nsIMutableArray&gt; array(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l33.17"></a><span id="l33.17">   if (NS_FAILED(rv)) {</span>
<a href="#l33.18"></a><span id="l33.18">     IMPORT_LOG0(&quot;FAILED to allocate the nsIMutableArray\n&quot;);</span>
<a href="#l33.19"></a><span id="l33.19">     return rv;</span>
<a href="#l33.20"></a><span id="l33.20">   }</span>
<a href="#l33.21"></a><span id="l33.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1415,17 +1415,17 @@ nsMsgLocalMailFolder::InitCopyState(nsIS</span>
<a href="#l34.4"></a><span id="l34.4">   mCopyState-&gt;m_messages = messages;</span>
<a href="#l34.5"></a><span id="l34.5">   mCopyState-&gt;m_curCopyIndex = 0;</span>
<a href="#l34.6"></a><span id="l34.6">   mCopyState-&gt;m_isMove = isMove;</span>
<a href="#l34.7"></a><span id="l34.7">   mCopyState-&gt;m_isFolder = isFolder;</span>
<a href="#l34.8"></a><span id="l34.8">   mCopyState-&gt;m_allowUndo = allowUndo;</span>
<a href="#l34.9"></a><span id="l34.9">   mCopyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l34.10"></a><span id="l34.10">   rv = messages-&gt;GetLength(&amp;mCopyState-&gt;m_totalMsgCount);</span>
<a href="#l34.11"></a><span id="l34.11">   if (listener)</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-    mCopyState-&gt;m_listener = do_QueryInterface(listener, &amp;rv);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+    mCopyState-&gt;m_listener = listener;</span>
<a href="#l34.14"></a><span id="l34.14">   mCopyState-&gt;m_copyingMultipleMessages = false;</span>
<a href="#l34.15"></a><span id="l34.15">   mCopyState-&gt;m_wholeMsgInStream = false;</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17">   // If we have source messages then we need destination messages too.</span>
<a href="#l34.18"></a><span id="l34.18">   if (messages)</span>
<a href="#l34.19"></a><span id="l34.19">     mCopyState-&gt;m_destMessages = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21">   return rv;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -2814,17 +2814,17 @@ nsresult nsMsgLocalMailFolder::CopyMessa</span>
<a href="#l34.23"></a><span id="l34.23"> {</span>
<a href="#l34.24"></a><span id="l34.24">   if (!mCopyState)</span>
<a href="#l34.25"></a><span id="l34.25">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l34.26"></a><span id="l34.26"> </span>
<a href="#l34.27"></a><span id="l34.27">   nsresult rv;</span>
<a href="#l34.28"></a><span id="l34.28">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(message, &amp;rv));</span>
<a href="#l34.29"></a><span id="l34.29">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-  mCopyState-&gt;m_message = do_QueryInterface(msgHdr, &amp;rv);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+  mCopyState-&gt;m_message = msgHdr;</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder(do_QueryInterface(mCopyState-&gt;m_srcSupport, &amp;rv));</span>
<a href="#l34.35"></a><span id="l34.35">   NS_ENSURE_SUCCESS(rv, NS_ERROR_NO_INTERFACE);</span>
<a href="#l34.36"></a><span id="l34.36">   nsCString uri;</span>
<a href="#l34.37"></a><span id="l34.37">   srcFolder-&gt;GetUriForMsg(msgHdr, uri);</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39">   nsCOMPtr&lt;nsICopyMessageStreamListener&gt; copyStreamListener = do_CreateInstance(NS_COPYMESSAGESTREAMLISTENER_CONTRACTID, &amp;rv);</span>
<a href="#l34.40"></a><span id="l34.40">   NS_ENSURE_SUCCESS(rv,rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -400,18 +400,18 @@ nsresult nsMailboxUrl::ParseUrl()</span>
<a href="#l35.4"></a><span id="l35.4">     NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l35.5"></a><span id="l35.5">     nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l35.6"></a><span id="l35.6">     rv = ioService-&gt;NewURI(fileUri, nullptr, nullptr, getter_AddRefs(uri));</span>
<a href="#l35.7"></a><span id="l35.7">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.8"></a><span id="l35.8">     nsCOMPtr &lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l35.9"></a><span id="l35.9">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.10"></a><span id="l35.10">     nsCOMPtr &lt;nsIFile&gt; fileURLFile;</span>
<a href="#l35.11"></a><span id="l35.11">     fileURL-&gt;GetFile(getter_AddRefs(fileURLFile));</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-    m_filePath = do_QueryInterface(fileURLFile, &amp;rv);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+    NS_ENSURE_TRUE(fileURLFile, NS_ERROR_NULL_POINTER);</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+    m_filePath = fileURLFile;</span>
<a href="#l35.16"></a><span id="l35.16">   }</span>
<a href="#l35.17"></a><span id="l35.17"> </span>
<a href="#l35.18"></a><span id="l35.18">   GetPathQueryRef(m_file);</span>
<a href="#l35.19"></a><span id="l35.19">   return NS_OK;</span>
<a href="#l35.20"></a><span id="l35.20"> }</span>
<a href="#l35.21"></a><span id="l35.21"> </span>
<a href="#l35.22"></a><span id="l35.22"> nsresult nsMailboxUrl::SetSpecInternal(const nsACString &amp;aSpec)</span>
<a href="#l35.23"></a><span id="l35.23"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1675,47 +1675,46 @@ nsParseNewMailState::nsParseNewMailState</span>
<a href="#l36.4"></a><span id="l36.4"> </span>
<a href="#l36.5"></a><span id="l36.5"> NS_IMPL_ISUPPORTS_INHERITED(nsParseNewMailState, nsMsgMailboxParser, nsIMsgFilterHitNotify)</span>
<a href="#l36.6"></a><span id="l36.6"> </span>
<a href="#l36.7"></a><span id="l36.7"> nsresult</span>
<a href="#l36.8"></a><span id="l36.8"> nsParseNewMailState::Init(nsIMsgFolder *serverFolder, nsIMsgFolder *downloadFolder,</span>
<a href="#l36.9"></a><span id="l36.9">                           nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l36.10"></a><span id="l36.10">                           nsIOutputStream *aOutputStream)</span>
<a href="#l36.11"></a><span id="l36.11"> {</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+  NS_ENSURE_ARG_POINTER(serverFolder);</span>
<a href="#l36.13"></a><span id="l36.13">   nsresult rv;</span>
<a href="#l36.14"></a><span id="l36.14">   Clear();</span>
<a href="#l36.15"></a><span id="l36.15">   m_rootFolder = serverFolder;</span>
<a href="#l36.16"></a><span id="l36.16">   m_msgWindow = aMsgWindow;</span>
<a href="#l36.17"></a><span id="l36.17">   m_downloadFolder = downloadFolder;</span>
<a href="#l36.18"></a><span id="l36.18"> </span>
<a href="#l36.19"></a><span id="l36.19">   m_newMsgHdr = aHdr;</span>
<a href="#l36.20"></a><span id="l36.20">   m_outputStream = aOutputStream;</span>
<a href="#l36.21"></a><span id="l36.21">   // the new mail parser isn't going to get the stream input, it seems, so we can't use</span>
<a href="#l36.22"></a><span id="l36.22">   // the OnStartRequest mechanism the mailbox parser uses. So, let's open the db right now.</span>
<a href="#l36.23"></a><span id="l36.23">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l36.24"></a><span id="l36.24">   if (msgDBService &amp;&amp; !m_mailDB)</span>
<a href="#l36.25"></a><span id="l36.25">     rv = msgDBService-&gt;OpenFolderDB(downloadFolder, false,</span>
<a href="#l36.26"></a><span id="l36.26">                                     getter_AddRefs(m_mailDB));</span>
<a href="#l36.27"></a><span id="l36.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.28"></a><span id="l36.28" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; rootMsgFolder = do_QueryInterface(serverFolder, &amp;rv);</span>
<a href="#l36.29"></a><span id="l36.29" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l36.30"></a><span id="l36.30"> </span>
<a href="#l36.31"></a><span id="l36.31">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l36.32"></a><span id="l36.32" class="difflineminus">-  rv = rootMsgFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineplus">+  rv = serverFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l36.34"></a><span id="l36.34">   if (NS_SUCCEEDED(rv))</span>
<a href="#l36.35"></a><span id="l36.35">   {</span>
<a href="#l36.36"></a><span id="l36.36">     rv = server-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l36.37"></a><span id="l36.37"> </span>
<a href="#l36.38"></a><span id="l36.38">     if (m_filterList)</span>
<a href="#l36.39"></a><span id="l36.39">       rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l36.40"></a><span id="l36.40">     // check if this server defers to another server, in which case</span>
<a href="#l36.41"></a><span id="l36.41">     // we'll use that server's filters as well.</span>
<a href="#l36.42"></a><span id="l36.42">     nsCOMPtr &lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l36.43"></a><span id="l36.43">     server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-    if (rootMsgFolder != deferredToRootFolder)</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineplus">+    if (serverFolder != deferredToRootFolder)</span>
<a href="#l36.46"></a><span id="l36.46">     {</span>
<a href="#l36.47"></a><span id="l36.47">       nsCOMPtr &lt;nsIMsgIncomingServer&gt; deferredToServer;</span>
<a href="#l36.48"></a><span id="l36.48">       deferredToRootFolder-&gt;GetServer(getter_AddRefs(deferredToServer));</span>
<a href="#l36.49"></a><span id="l36.49">       if (deferredToServer)</span>
<a href="#l36.50"></a><span id="l36.50">         deferredToServer-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_deferredToServerFilterList));</span>
<a href="#l36.51"></a><span id="l36.51">     }</span>
<a href="#l36.52"></a><span id="l36.52">   }</span>
<a href="#l36.53"></a><span id="l36.53">   m_disableFilters = false;</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineat">@@ -1913,21 +1912,20 @@ void nsParseNewMailState::ApplyFilters(b</span>
<a href="#l36.55"></a><span id="l36.55"> {</span>
<a href="#l36.56"></a><span id="l36.56">   m_msgMovedByFilter = m_msgCopiedByFilter = false;</span>
<a href="#l36.57"></a><span id="l36.57">   m_curHdrOffset = msgOffset;</span>
<a href="#l36.58"></a><span id="l36.58"> </span>
<a href="#l36.59"></a><span id="l36.59">   if (!m_disableFilters)</span>
<a href="#l36.60"></a><span id="l36.60">   {</span>
<a href="#l36.61"></a><span id="l36.61">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_newMsgHdr;</span>
<a href="#l36.62"></a><span id="l36.62">     nsCOMPtr&lt;nsIMsgFolder&gt; downloadFolder = m_downloadFolder;</span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-    nsCOMPtr &lt;nsIMsgFolder&gt; rootMsgFolder = do_QueryInterface(m_rootFolder);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineminus">-    if (rootMsgFolder)</span>
<a href="#l36.65"></a><span id="l36.65" class="difflineplus">+    if (m_rootFolder)</span>
<a href="#l36.66"></a><span id="l36.66">     {</span>
<a href="#l36.67"></a><span id="l36.67">       if (!downloadFolder)</span>
<a href="#l36.68"></a><span id="l36.68" class="difflineminus">-        rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l36.69"></a><span id="l36.69" class="difflineplus">+        m_rootFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l36.70"></a><span id="l36.70">                                           getter_AddRefs(downloadFolder));</span>
<a href="#l36.71"></a><span id="l36.71">       if (downloadFolder)</span>
<a href="#l36.72"></a><span id="l36.72">         downloadFolder-&gt;GetURI(m_inboxUri);</span>
<a href="#l36.73"></a><span id="l36.73">       char * headers = m_headers.GetBuffer();</span>
<a href="#l36.74"></a><span id="l36.74">       uint32_t headersSize = m_headers.GetBufferPos();</span>
<a href="#l36.75"></a><span id="l36.75">       if (m_filterList)</span>
<a href="#l36.76"></a><span id="l36.76">         (void) m_filterList-&gt;</span>
<a href="#l36.77"></a><span id="l36.77">           ApplyFiltersToHdr(nsMsgFilterType::InboxRule, msgHdr, downloadFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Protocol.cpp</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -479,17 +479,17 @@ nsresult nsPop3Protocol::Initialize(nsIU</span>
<a href="#l37.4"></a><span id="l37.4">   m_tlsEnabled = false;</span>
<a href="#l37.5"></a><span id="l37.5">   m_socketType = nsMsgSocketType::trySTARTTLS;</span>
<a href="#l37.6"></a><span id="l37.6">   m_prefAuthMethods = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l37.7"></a><span id="l37.7">   m_failedAuthMethods = 0;</span>
<a href="#l37.8"></a><span id="l37.8">   m_password_already_sent = false;</span>
<a href="#l37.9"></a><span id="l37.9">   m_currentAuthMethod = POP3_AUTH_MECH_UNDEFINED;</span>
<a href="#l37.10"></a><span id="l37.10">   m_needToRerunUrl = false;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-  m_url = do_QueryInterface(aURL);</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+  m_url = aURL;</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, true);</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17">   nsCOMPtr&lt;nsIStringBundleService&gt; bundleService =</span>
<a href="#l37.18"></a><span id="l37.18">     mozilla::services::GetStringBundleService();</span>
<a href="#l37.19"></a><span id="l37.19">   NS_ENSURE_TRUE(bundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l37.20"></a><span id="l37.20">   return bundleService-&gt;CreateBundle(&quot;chrome://messenger/locale/localMsgs.properties&quot;, getter_AddRefs(mLocalBundle));</span>
<a href="#l37.21"></a><span id="l37.21"> }</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineat">@@ -695,21 +695,20 @@ void nsPop3Protocol::SetUsername(const c</span>
<a href="#l37.23"></a><span id="l37.23"> {</span>
<a href="#l37.24"></a><span id="l37.24">   NS_ASSERTION(name, &quot;no name specified!&quot;);</span>
<a href="#l37.25"></a><span id="l37.25">     if (name)</span>
<a href="#l37.26"></a><span id="l37.26">       m_username = name;</span>
<a href="#l37.27"></a><span id="l37.27"> }</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> nsresult nsPop3Protocol::RerunUrl()</span>
<a href="#l37.30"></a><span id="l37.30"> {</span>
<a href="#l37.31"></a><span id="l37.31" class="difflineminus">-  nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(m_url);</span>
<a href="#l37.32"></a><span id="l37.32">   ClearFlag(POP3_PASSWORD_FAILED);</span>
<a href="#l37.33"></a><span id="l37.33">   m_pop3Server-&gt;SetRunningProtocol(nullptr);</span>
<a href="#l37.34"></a><span id="l37.34">   Cleanup();</span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-  return LoadUrl(url, nullptr);</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+  return LoadUrl(m_url, nullptr);</span>
<a href="#l37.37"></a><span id="l37.37"> }</span>
<a href="#l37.38"></a><span id="l37.38"> </span>
<a href="#l37.39"></a><span id="l37.39"> Pop3StatesEnum nsPop3Protocol::GetNextPasswordObtainState()</span>
<a href="#l37.40"></a><span id="l37.40"> {</span>
<a href="#l37.41"></a><span id="l37.41">   switch (m_pop3ConData-&gt;next_state)</span>
<a href="#l37.42"></a><span id="l37.42">   {</span>
<a href="#l37.43"></a><span id="l37.43">   case POP3_OBTAIN_PASSWORD_EARLY:</span>
<a href="#l37.44"></a><span id="l37.44">     return POP3_FINISH_OBTAIN_PASSWORD_EARLY;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -475,23 +475,20 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l38.4"></a><span id="l38.4">       return rv;</span>
<a href="#l38.5"></a><span id="l38.5"> </span>
<a href="#l38.6"></a><span id="l38.6">     if (!m_tmpDownloadFile)</span>
<a href="#l38.7"></a><span id="l38.7">     {</span>
<a href="#l38.8"></a><span id="l38.8">       //need a unique tmp file to prevent dataloss in multiuser environment</span>
<a href="#l38.9"></a><span id="l38.9">       rv = tmpDownloadFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l38.10"></a><span id="l38.10">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-      m_tmpDownloadFile = do_QueryInterface(tmpDownloadFile, &amp;rv);</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+      m_tmpDownloadFile = tmpDownloadFile;</span>
<a href="#l38.14"></a><span id="l38.14">     }</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l38.16"></a><span id="l38.16" class="difflineminus">-    {</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineminus">-      rv = MsgGetFileStream(m_tmpDownloadFile, getter_AddRefs(m_outFileStream));</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineminus">-    }</span>
<a href="#l38.20"></a><span id="l38.20" class="difflineplus">+    rv = MsgGetFileStream(m_tmpDownloadFile, getter_AddRefs(m_outFileStream));</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.22"></a><span id="l38.22">   }</span>
<a href="#l38.23"></a><span id="l38.23">   else</span>
<a href="#l38.24"></a><span id="l38.24">   {</span>
<a href="#l38.25"></a><span id="l38.25">     rv = server-&gt;GetMsgStore(getter_AddRefs(m_msgStore));</span>
<a href="#l38.26"></a><span id="l38.26">     bool reusable;</span>
<a href="#l38.27"></a><span id="l38.27">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.28"></a><span id="l38.28">     m_msgStore-&gt;GetNewMsgOutputStream(m_folder, getter_AddRefs(newHdr),</span>
<a href="#l38.29"></a><span id="l38.29">                                       &amp;reusable, getter_AddRefs(m_outFileStream));</span>
<a href="#l38.30"></a><span id="l38.30" class="difflineat">@@ -539,20 +536,19 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l38.31"></a><span id="l38.31">     seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l38.32"></a><span id="l38.32"> </span>
<a href="#l38.33"></a><span id="l38.33"> #ifdef DEBUG</span>
<a href="#l38.34"></a><span id="l38.34">     // Debugging, see bug 1116055.</span>
<a href="#l38.35"></a><span id="l38.35">     int64_t first_post_seek_pos;</span>
<a href="#l38.36"></a><span id="l38.36">     nsresult rv4 = seekableOutStream-&gt;Tell(&amp;first_post_seek_pos);</span>
<a href="#l38.37"></a><span id="l38.37">     if (NS_SUCCEEDED(rv3) &amp;&amp; NS_SUCCEEDED(rv4)) {</span>
<a href="#l38.38"></a><span id="l38.38">       if (first_pre_seek_pos != first_post_seek_pos) {</span>
<a href="#l38.39"></a><span id="l38.39" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.40"></a><span id="l38.40">         nsString folderName;</span>
<a href="#l38.41"></a><span id="l38.41" class="difflineminus">-        if (localFolder)</span>
<a href="#l38.42"></a><span id="l38.42" class="difflineminus">-          localFolder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineplus">+        if (m_folder)</span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+          m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.45"></a><span id="l38.45">         if (!folderName.IsEmpty()) {</span>
<a href="#l38.46"></a><span id="l38.46">           fprintf(stderr,&quot;(seekdebug) Seek was necessary in IncorporateBegin() for folder %s.\n&quot;,</span>
<a href="#l38.47"></a><span id="l38.47">                   NS_ConvertUTF16toUTF8(folderName).get());</span>
<a href="#l38.48"></a><span id="l38.48">         } else {</span>
<a href="#l38.49"></a><span id="l38.49">           fprintf(stderr,&quot;(seekdebug) Seek was necessary in IncorporateBegin().\n&quot;);</span>
<a href="#l38.50"></a><span id="l38.50">         }</span>
<a href="#l38.51"></a><span id="l38.51">         fprintf(stderr,&quot;(seekdebug) first_pre_seek_pos = 0x%016llx, first_post_seek_pos=0x%016llx\n&quot;,</span>
<a href="#l38.52"></a><span id="l38.52">                 (unsigned long long) first_pre_seek_pos, (unsigned long long) first_post_seek_pos);</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineat">@@ -709,20 +705,19 @@ nsresult nsPop3Sink::WriteLineToMailbox(</span>
<a href="#l38.54"></a><span id="l38.54">     seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l38.55"></a><span id="l38.55"> </span>
<a href="#l38.56"></a><span id="l38.56">     int64_t after_seek_pos;</span>
<a href="#l38.57"></a><span id="l38.57">     nsresult rv3 = seekableOutStream-&gt;Tell(&amp;after_seek_pos);</span>
<a href="#l38.58"></a><span id="l38.58">     MOZ_ASSERT(NS_SUCCEEDED(rv3), &quot;seekableOutStream-&gt;Tell(&amp;after_seek_pos) failed&quot;);</span>
<a href="#l38.59"></a><span id="l38.59"> </span>
<a href="#l38.60"></a><span id="l38.60">     if (NS_SUCCEEDED(rv2) &amp;&amp; NS_SUCCEEDED(rv3)) {</span>
<a href="#l38.61"></a><span id="l38.61">       if (before_seek_pos != after_seek_pos) {</span>
<a href="#l38.62"></a><span id="l38.62" class="difflineminus">-        nsCOMPtr&lt;nsIMsgFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.63"></a><span id="l38.63">         nsString folderName;</span>
<a href="#l38.64"></a><span id="l38.64" class="difflineminus">-        if (localFolder)</span>
<a href="#l38.65"></a><span id="l38.65" class="difflineminus">-          localFolder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.66"></a><span id="l38.66" class="difflineplus">+        if (m_folder)</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineplus">+          m_folder-&gt;GetPrettyName(folderName);</span>
<a href="#l38.68"></a><span id="l38.68">         // This merits a console message, it's poor man's telemetry.</span>
<a href="#l38.69"></a><span id="l38.69">         MsgLogToConsole4(</span>
<a href="#l38.70"></a><span id="l38.70">           NS_LITERAL_STRING(&quot;Unexpected file position change detected&quot;) +</span>
<a href="#l38.71"></a><span id="l38.71">           (folderName.IsEmpty() ? EmptyString() : NS_LITERAL_STRING(&quot; in folder &quot;)) +</span>
<a href="#l38.72"></a><span id="l38.72">           (folderName.IsEmpty() ? EmptyString() : folderName) + NS_LITERAL_STRING(&quot;. &quot;</span>
<a href="#l38.73"></a><span id="l38.73">           &quot;If you can reliably reproduce this, please report the steps &quot;</span>
<a href="#l38.74"></a><span id="l38.74">           &quot;you used to dev-apps-thunderbird@lists.mozilla.org or to bug 1308335 at bugzilla.mozilla.org. &quot;</span>
<a href="#l38.75"></a><span id="l38.75">           &quot;Resolving this problem will allow speeding up message downloads.&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/mapi/mapihook/src/msgMapiImp.cpp</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -686,77 +686,73 @@ char *MsgMapiListContext::ConvertBodyToM</span>
<a href="#l39.4"></a><span id="l39.4">   const int kBufLen = 64000; // I guess we only return the first 64K of a message.</span>
<a href="#l39.5"></a><span id="l39.5"> #define EMPTY_MESSAGE_LINE(buf) (buf[0] == '\r' || buf[0] == '\n' || buf[0] == '\0')</span>
<a href="#l39.6"></a><span id="l39.6"> </span>
<a href="#l39.7"></a><span id="l39.7">   nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l39.8"></a><span id="l39.8">   hdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l39.9"></a><span id="l39.9">   if (!folder)</span>
<a href="#l39.10"></a><span id="l39.10">     return nullptr;</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l39.13"></a><span id="l39.13">   nsCOMPtr &lt;nsIFile&gt; localFile;</span>
<a href="#l39.14"></a><span id="l39.14">   folder-&gt;GetFilePath(getter_AddRefs(localFile));</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16">   nsresult rv;</span>
<a href="#l39.17"></a><span id="l39.17">   nsCOMPtr&lt;nsIFileInputStream&gt; fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l39.18"></a><span id="l39.18">   NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20">   rv = fileStream-&gt;Init(localFile,  PR_RDONLY, 0664, false);  //just have to read the messages</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-  inputStream = do_QueryInterface(fileStream);</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, nullptr);</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+  nsCOMPtr &lt;nsILineInputStream&gt; fileLineStream = do_QueryInterface(fileStream);</span>
<a href="#l39.25"></a><span id="l39.25" class="difflineplus">+  if (!fileLineStream)</span>
<a href="#l39.26"></a><span id="l39.26" class="difflineplus">+    return nullptr;</span>
<a href="#l39.27"></a><span id="l39.27"> </span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-  if (inputStream)</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+  // ### really want to skip past headers...</span>
<a href="#l39.30"></a><span id="l39.30" class="difflineplus">+  uint64_t messageOffset;</span>
<a href="#l39.31"></a><span id="l39.31" class="difflineplus">+  uint32_t lineCount;</span>
<a href="#l39.32"></a><span id="l39.32" class="difflineplus">+  hdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l39.33"></a><span id="l39.33" class="difflineplus">+  hdr-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l39.34"></a><span id="l39.34" class="difflineplus">+  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l39.35"></a><span id="l39.35" class="difflineplus">+  seekableStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l39.36"></a><span id="l39.36" class="difflineplus">+  bool hasMore = true;</span>
<a href="#l39.37"></a><span id="l39.37" class="difflineplus">+  nsAutoCString curLine;</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineplus">+</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+  while (hasMore) // advance past message headers</span>
<a href="#l39.40"></a><span id="l39.40">   {</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-    nsCOMPtr &lt;nsILineInputStream&gt; fileLineStream = do_QueryInterface(inputStream);</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-    if (!fileLineStream)</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-      return nullptr;</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineminus">-    // ### really want to skip past headers...</span>
<a href="#l39.45"></a><span id="l39.45" class="difflineminus">-    uint64_t messageOffset;</span>
<a href="#l39.46"></a><span id="l39.46" class="difflineminus">-    uint32_t lineCount;</span>
<a href="#l39.47"></a><span id="l39.47" class="difflineminus">-    hdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l39.48"></a><span id="l39.48" class="difflineminus">-    hdr-&gt;GetLineCount(&amp;lineCount);</span>
<a href="#l39.49"></a><span id="l39.49" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream);</span>
<a href="#l39.50"></a><span id="l39.50" class="difflineminus">-    seekableStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l39.51"></a><span id="l39.51" class="difflineminus">-    bool hasMore = true;</span>
<a href="#l39.52"></a><span id="l39.52" class="difflineminus">-    nsAutoCString curLine;</span>
<a href="#l39.53"></a><span id="l39.53" class="difflineminus">-    nsresult rv = NS_OK;</span>
<a href="#l39.54"></a><span id="l39.54" class="difflineminus">-    while (hasMore) // advance past message headers</span>
<a href="#l39.55"></a><span id="l39.55" class="difflineplus">+    nsresult rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l39.56"></a><span id="l39.56" class="difflineplus">+    if (NS_FAILED(rv) || EMPTY_MESSAGE_LINE(curLine))</span>
<a href="#l39.57"></a><span id="l39.57" class="difflineplus">+      break;</span>
<a href="#l39.58"></a><span id="l39.58" class="difflineplus">+  }</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineplus">+  uint32_t msgSize;</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+  hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l39.61"></a><span id="l39.61" class="difflineplus">+  if (msgSize &gt; kBufLen)</span>
<a href="#l39.62"></a><span id="l39.62" class="difflineplus">+    msgSize = kBufLen - 1;</span>
<a href="#l39.63"></a><span id="l39.63" class="difflineplus">+  // this is too big, since it includes the msg hdr size...oh well</span>
<a href="#l39.64"></a><span id="l39.64" class="difflineplus">+  char *body = (char*) CoTaskMemAlloc (msgSize + 1);</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineplus">+</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineplus">+  if (!body)</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineplus">+    return nullptr;</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+  int32_t bytesCopied = 0;</span>
<a href="#l39.69"></a><span id="l39.69" class="difflineplus">+  for (hasMore = TRUE; lineCount &gt; 0 &amp;&amp; hasMore &amp;&amp; NS_SUCCEEDED(rv); lineCount--)</span>
<a href="#l39.70"></a><span id="l39.70" class="difflineplus">+  {</span>
<a href="#l39.71"></a><span id="l39.71" class="difflineplus">+    rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l39.72"></a><span id="l39.72" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l39.73"></a><span id="l39.73" class="difflineplus">+      break;</span>
<a href="#l39.74"></a><span id="l39.74" class="difflineplus">+    curLine.Append(CRLF);</span>
<a href="#l39.75"></a><span id="l39.75" class="difflineplus">+    // make sure we have room left</span>
<a href="#l39.76"></a><span id="l39.76" class="difflineplus">+    if (bytesCopied + curLine.Length() &lt; msgSize)</span>
<a href="#l39.77"></a><span id="l39.77">     {</span>
<a href="#l39.78"></a><span id="l39.78" class="difflineminus">-      nsresult rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l39.79"></a><span id="l39.79" class="difflineminus">-      if (NS_FAILED(rv) || EMPTY_MESSAGE_LINE(curLine))</span>
<a href="#l39.80"></a><span id="l39.80" class="difflineminus">-        break;</span>
<a href="#l39.81"></a><span id="l39.81" class="difflineplus">+      strcpy(body + bytesCopied, curLine.get());</span>
<a href="#l39.82"></a><span id="l39.82" class="difflineplus">+      bytesCopied += curLine.Length();</span>
<a href="#l39.83"></a><span id="l39.83">     }</span>
<a href="#l39.84"></a><span id="l39.84" class="difflineminus">-    uint32_t msgSize;</span>
<a href="#l39.85"></a><span id="l39.85" class="difflineminus">-    hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-    if (msgSize &gt; kBufLen)</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-      msgSize = kBufLen - 1;</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineminus">-    // this is too big, since it includes the msg hdr size...oh well</span>
<a href="#l39.89"></a><span id="l39.89" class="difflineminus">-    char *body = (char*) CoTaskMemAlloc (msgSize + 1);</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-    if (!body)</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineminus">-      return nullptr;</span>
<a href="#l39.93"></a><span id="l39.93" class="difflineminus">-    int32_t bytesCopied = 0;</span>
<a href="#l39.94"></a><span id="l39.94" class="difflineminus">-    for (hasMore = TRUE; lineCount &gt; 0 &amp;&amp; hasMore &amp;&amp; NS_SUCCEEDED(rv); lineCount--)</span>
<a href="#l39.95"></a><span id="l39.95" class="difflineminus">-    {</span>
<a href="#l39.96"></a><span id="l39.96" class="difflineminus">-      rv = fileLineStream-&gt;ReadLine(curLine, &amp;hasMore);</span>
<a href="#l39.97"></a><span id="l39.97" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l39.98"></a><span id="l39.98" class="difflineminus">-        break;</span>
<a href="#l39.99"></a><span id="l39.99" class="difflineminus">-      curLine.Append(CRLF);</span>
<a href="#l39.100"></a><span id="l39.100" class="difflineminus">-      // make sure we have room left</span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-      if (bytesCopied + curLine.Length() &lt; msgSize)</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-      {</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineminus">-        strcpy(body + bytesCopied, curLine.get());</span>
<a href="#l39.104"></a><span id="l39.104" class="difflineminus">-        bytesCopied += curLine.Length();</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-      }</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-    }</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineminus">-    MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;,</span>
<a href="#l39.108"></a><span id="l39.108" class="difflineminus">-        bytesCopied, msgSize + 1, (char *) body) );</span>
<a href="#l39.109"></a><span id="l39.109" class="difflineminus">-    body[bytesCopied] = '\0';   // rhp - fix last line garbage...</span>
<a href="#l39.110"></a><span id="l39.110" class="difflineminus">-    return body;</span>
<a href="#l39.111"></a><span id="l39.111">   }</span>
<a href="#l39.112"></a><span id="l39.112" class="difflineminus">-  return nullptr;</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineplus">+  MOZ_LOG(MAPI, mozilla::LogLevel::Debug, (&quot;ConvertBodyToMapiFormat size=%x allocated size %x body = %100.100s\n&quot;,</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineplus">+      bytesCopied, msgSize + 1, (char *) body) );</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+  body[bytesCopied] = '\0';   // rhp - fix last line garbage...</span>
<a href="#l39.116"></a><span id="l39.116" class="difflineplus">+  return body;</span>
<a href="#l39.117"></a><span id="l39.117"> }</span>
<a href="#l39.118"></a><span id="l39.118"> </span>
<a href="#l39.119"></a><span id="l39.119"> </span>
<a href="#l39.120"></a><span id="l39.120"> //*****************************************************************************</span>
<a href="#l39.121"></a><span id="l39.121"> // MSGMAPI API implementation</span>
<a href="#l39.122"></a><span id="l39.122"> </span>
<a href="#l39.123"></a><span id="l39.123"> </span>
<a href="#l39.124"></a><span id="l39.124"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/mime/emitters/nsMimeBaseEmitter.cpp</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1027,18 +1027,17 @@ nsMimeBaseEmitter::Complete()</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5">   if (mOutListener)</span>
<a href="#l40.6"></a><span id="l40.6">   {</span>
<a href="#l40.7"></a><span id="l40.7">     uint64_t bytesInStream = 0;</span>
<a href="#l40.8"></a><span id="l40.8">     mozilla::DebugOnly&lt;nsresult&gt; rv2 = mInputStream-&gt;Available(&amp;bytesInStream);</span>
<a href="#l40.9"></a><span id="l40.9">     NS_ASSERTION(NS_SUCCEEDED(rv2), &quot;Available failed&quot;);</span>
<a href="#l40.10"></a><span id="l40.10">     if (bytesInStream)</span>
<a href="#l40.11"></a><span id="l40.11">     {</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-      nsCOMPtr&lt;nsIRequest&gt; request = do_QueryInterface(mChannel);</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineminus">-      mOutListener-&gt;OnDataAvailable(request, mURL, mInputStream, 0, std::min(bytesInStream, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+      mOutListener-&gt;OnDataAvailable(mChannel, mURL, mInputStream, 0, std::min(bytesInStream, uint64_t(PR_UINT32_MAX)));</span>
<a href="#l40.15"></a><span id="l40.15">     }</span>
<a href="#l40.16"></a><span id="l40.16">   }</span>
<a href="#l40.17"></a><span id="l40.17"> </span>
<a href="#l40.18"></a><span id="l40.18">   return NS_OK;</span>
<a href="#l40.19"></a><span id="l40.19"> }</span>
<a href="#l40.20"></a><span id="l40.20"> </span>
<a href="#l40.21"></a><span id="l40.21"> //</span>
<a href="#l40.22"></a><span id="l40.22"> // This needs to do the right thing with the stored information. It only</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/mime/src/mimedrft.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1504,17 +1504,17 @@ mime_parse_stream_complete(nsMIMESession</span>
<a href="#l41.4"></a><span id="l41.4"> </span>
<a href="#l41.5"></a><span id="l41.5">       char *body = nullptr;</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7">       if (!bodyAsAttachment &amp;&amp; mdd-&gt;messageBody-&gt;m_tmpFile)</span>
<a href="#l41.8"></a><span id="l41.8">       {</span>
<a href="#l41.9"></a><span id="l41.9">         int64_t fileSize;</span>
<a href="#l41.10"></a><span id="l41.10">         nsCOMPtr&lt;nsIFile&gt; tempFileCopy;</span>
<a href="#l41.11"></a><span id="l41.11">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;Clone(getter_AddRefs(tempFileCopy));</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-        mdd-&gt;messageBody-&gt;m_tmpFile = do_QueryInterface(tempFileCopy);</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+        mdd-&gt;messageBody-&gt;m_tmpFile = tempFileCopy;</span>
<a href="#l41.14"></a><span id="l41.14">         tempFileCopy = nullptr;</span>
<a href="#l41.15"></a><span id="l41.15">         mdd-&gt;messageBody-&gt;m_tmpFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l41.16"></a><span id="l41.16">         uint32_t bodyLen = 0;</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18">         // The stream interface can only read up to 4GB (32bit uint).</span>
<a href="#l41.19"></a><span id="l41.19">         // It is highly unlikely to encounter a body lager than that limit,</span>
<a href="#l41.20"></a><span id="l41.20">         // so we just skip it instead of reading it in chunks.</span>
<a href="#l41.21"></a><span id="l41.21">         if (fileSize &lt; UINT32_MAX)</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -2058,17 +2058,17 @@ mime_decompose_file_init_fn(void *stream</span>
<a href="#l41.23"></a><span id="l41.23">       if (NS_SUCCEEDED(rv))</span>
<a href="#l41.24"></a><span id="l41.24">         nsMimeNewURI(getter_AddRefs(newAttachment-&gt;m_origUrl),</span>
<a href="#l41.25"></a><span id="l41.25">                      fileURL.get(), nullptr);</span>
<a href="#l41.26"></a><span id="l41.26">   }</span>
<a href="#l41.27"></a><span id="l41.27"> </span>
<a href="#l41.28"></a><span id="l41.28">   if (!tmpFile)</span>
<a href="#l41.29"></a><span id="l41.29">     return MIME_OUT_OF_MEMORY;</span>
<a href="#l41.30"></a><span id="l41.30"> </span>
<a href="#l41.31"></a><span id="l41.31" class="difflineminus">-  mdd-&gt;tmpFile = do_QueryInterface(tmpFile);</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+  mdd-&gt;tmpFile = tmpFile;</span>
<a href="#l41.33"></a><span id="l41.33"> </span>
<a href="#l41.34"></a><span id="l41.34">   newAttachment-&gt;m_tmpFile = mdd-&gt;tmpFile;</span>
<a href="#l41.35"></a><span id="l41.35"> </span>
<a href="#l41.36"></a><span id="l41.36">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mdd-&gt;tmpFileStream), tmpFile,PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l41.37"></a><span id="l41.37">   if (NS_FAILED(rv))</span>
<a href="#l41.38"></a><span id="l41.38">     return MIME_UNABLE_TO_OPEN_TMP_FILE;</span>
<a href="#l41.39"></a><span id="l41.39"> </span>
<a href="#l41.40"></a><span id="l41.40">   // For now, we are always going to decode all of the attachments</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/mime/src/mimemrel.cpp</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -667,17 +667,17 @@ MimeMultipartRelated_parse_child_line (M</span>
<a href="#l42.4"></a><span id="l42.4">   nsresult rv;</span>
<a href="#l42.5"></a><span id="l42.5">   /* Ok, if at this point we still don't have either kind of buffer, try and</span>
<a href="#l42.6"></a><span id="l42.6">      make a file buffer. */</span>
<a href="#l42.7"></a><span id="l42.7">   if (!relobj-&gt;head_buffer &amp;&amp; !relobj-&gt;file_buffer)</span>
<a href="#l42.8"></a><span id="l42.8">   {</span>
<a href="#l42.9"></a><span id="l42.9">     nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l42.10"></a><span id="l42.10">     rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(file));</span>
<a href="#l42.11"></a><span id="l42.11">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-    relobj-&gt;file_buffer = do_QueryInterface(file);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+    relobj-&gt;file_buffer = file;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15">     rv = MsgNewBufferedFileOutputStream(getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l42.16"></a><span id="l42.16">     NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l42.17"></a><span id="l42.17">   }</span>
<a href="#l42.18"></a><span id="l42.18"> </span>
<a href="#l42.19"></a><span id="l42.19">   PR_ASSERT(relobj-&gt;head_buffer || relobj-&gt;output_file_stream);</span>
<a href="#l42.20"></a><span id="l42.20"> </span>
<a href="#l42.21"></a><span id="l42.21"> </span>
<a href="#l42.22"></a><span id="l42.22" class="difflineat">@@ -694,17 +694,17 @@ MimeMultipartRelated_parse_child_line (M</span>
<a href="#l42.23"></a><span id="l42.23">        to it. */</span>
<a href="#l42.24"></a><span id="l42.24">     if (!relobj-&gt;output_file_stream)</span>
<a href="#l42.25"></a><span id="l42.25">     {</span>
<a href="#l42.26"></a><span id="l42.26">       if (!relobj-&gt;file_buffer)</span>
<a href="#l42.27"></a><span id="l42.27">       {</span>
<a href="#l42.28"></a><span id="l42.28">         nsCOMPtr &lt;nsIFile&gt; file;</span>
<a href="#l42.29"></a><span id="l42.29">         rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(file));</span>
<a href="#l42.30"></a><span id="l42.30">         NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l42.31"></a><span id="l42.31" class="difflineminus">-        relobj-&gt;file_buffer = do_QueryInterface(file);</span>
<a href="#l42.32"></a><span id="l42.32" class="difflineplus">+        relobj-&gt;file_buffer = file;</span>
<a href="#l42.33"></a><span id="l42.33">       }</span>
<a href="#l42.34"></a><span id="l42.34"> </span>
<a href="#l42.35"></a><span id="l42.35">       nsresult rv = MsgNewBufferedFileOutputStream(getter_AddRefs(relobj-&gt;output_file_stream), relobj-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l42.36"></a><span id="l42.36">       NS_ENSURE_SUCCESS(rv, -1);</span>
<a href="#l42.37"></a><span id="l42.37"> </span>
<a href="#l42.38"></a><span id="l42.38">       if (relobj-&gt;head_buffer &amp;&amp; relobj-&gt;head_buffer_fp)</span>
<a href="#l42.39"></a><span id="l42.39">       {</span>
<a href="#l42.40"></a><span id="l42.40">         uint32_t bytesWritten;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/mime/src/mimepbuf.cpp</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/mime/src/mimepbuf.cpp</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -165,17 +165,17 @@ MimePartBufferWrite (MimePartBufferData </span>
<a href="#l43.4"></a><span id="l43.4"> </span>
<a href="#l43.5"></a><span id="l43.5">   /* Ok, if at this point we still don't have either kind of buffer, try and</span>
<a href="#l43.6"></a><span id="l43.6">     make a file buffer. */</span>
<a href="#l43.7"></a><span id="l43.7">   if (!data-&gt;part_buffer &amp;&amp; !data-&gt;file_buffer)</span>
<a href="#l43.8"></a><span id="l43.8">   {</span>
<a href="#l43.9"></a><span id="l43.9">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l43.10"></a><span id="l43.10">     nsresult rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l43.11"></a><span id="l43.11">     NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-    data-&gt;file_buffer = do_QueryInterface(tmpFile);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+    data-&gt;file_buffer = tmpFile;</span>
<a href="#l43.14"></a><span id="l43.14"> </span>
<a href="#l43.15"></a><span id="l43.15">     rv = MsgNewBufferedFileOutputStream(getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l43.16"></a><span id="l43.16">     NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l43.17"></a><span id="l43.17">   }</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19">   NS_ASSERTION(data-&gt;part_buffer || data-&gt;output_file_stream, &quot;no part_buffer or file_stream&quot;);</span>
<a href="#l43.20"></a><span id="l43.20"> </span>
<a href="#l43.21"></a><span id="l43.21">   /* If this buf will fit in the memory buffer, put it there.</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineat">@@ -196,17 +196,17 @@ MimePartBufferWrite (MimePartBufferData </span>
<a href="#l43.23"></a><span id="l43.23">     if (!data-&gt;output_file_stream)</span>
<a href="#l43.24"></a><span id="l43.24">     {</span>
<a href="#l43.25"></a><span id="l43.25">       nsresult rv;</span>
<a href="#l43.26"></a><span id="l43.26">       if (!data-&gt;file_buffer)</span>
<a href="#l43.27"></a><span id="l43.27">       {</span>
<a href="#l43.28"></a><span id="l43.28">         nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l43.29"></a><span id="l43.29">         rv = nsMsgCreateTempFile(&quot;nsma&quot;, getter_AddRefs(tmpFile));</span>
<a href="#l43.30"></a><span id="l43.30">         NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l43.31"></a><span id="l43.31" class="difflineminus">-        data-&gt;file_buffer = do_QueryInterface(tmpFile);</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineplus">+        data-&gt;file_buffer = tmpFile;</span>
<a href="#l43.33"></a><span id="l43.33"> </span>
<a href="#l43.34"></a><span id="l43.34">       }</span>
<a href="#l43.35"></a><span id="l43.35"> </span>
<a href="#l43.36"></a><span id="l43.36">       rv = MsgNewBufferedFileOutputStream(getter_AddRefs(data-&gt;output_file_stream), data-&gt;file_buffer, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l43.37"></a><span id="l43.37">       NS_ENSURE_SUCCESS(rv, MIME_UNABLE_TO_OPEN_TMP_FILE);</span>
<a href="#l43.38"></a><span id="l43.38"> </span>
<a href="#l43.39"></a><span id="l43.39">       if (data-&gt;part_buffer &amp;&amp; data-&gt;part_buffer_fp)</span>
<a href="#l43.40"></a><span id="l43.40">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -541,40 +541,38 @@ nsresult nsNntpCacheStreamListener::Init</span>
<a href="#l44.4"></a><span id="l44.4">   mRunningUrl = aRunningUrl;</span>
<a href="#l44.5"></a><span id="l44.5">   return NS_OK;</span>
<a href="#l44.6"></a><span id="l44.6"> }</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> NS_IMETHODIMP</span>
<a href="#l44.9"></a><span id="l44.9"> nsNntpCacheStreamListener::OnStartRequest(nsIRequest *request, nsISupports * aCtxt)</span>
<a href="#l44.10"></a><span id="l44.10"> {</span>
<a href="#l44.11"></a><span id="l44.11">   nsCOMPtr &lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  nsCOMPtr &lt;nsIRequest&gt; ourRequest = do_QueryInterface(mChannelToUse);</span>
<a href="#l44.13"></a><span id="l44.13"> </span>
<a href="#l44.14"></a><span id="l44.14">   NS_ASSERTION(mChannelToUse, &quot;null channel in OnStartRequest&quot;);</span>
<a href="#l44.15"></a><span id="l44.15">   if (mChannelToUse)</span>
<a href="#l44.16"></a><span id="l44.16">     mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l44.17"></a><span id="l44.17">   if (loadGroup)</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineminus">-    loadGroup-&gt;AddRequest(ourRequest, nullptr /* context isupports */);</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineminus">-  return (mListener) ? mListener-&gt;OnStartRequest(ourRequest, aCtxt) : NS_OK;</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+    loadGroup-&gt;AddRequest(mChannelToUse, nullptr /* context isupports */);</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+  return (mListener) ? mListener-&gt;OnStartRequest(mChannelToUse, aCtxt) : NS_OK;</span>
<a href="#l44.22"></a><span id="l44.22"> }</span>
<a href="#l44.23"></a><span id="l44.23"> </span>
<a href="#l44.24"></a><span id="l44.24"> NS_IMETHODIMP</span>
<a href="#l44.25"></a><span id="l44.25"> nsNntpCacheStreamListener::OnStopRequest(nsIRequest *request, nsISupports * aCtxt, nsresult aStatus)</span>
<a href="#l44.26"></a><span id="l44.26"> {</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-  nsCOMPtr &lt;nsIRequest&gt; ourRequest = do_QueryInterface(mChannelToUse);</span>
<a href="#l44.28"></a><span id="l44.28">   nsresult rv = NS_OK;</span>
<a href="#l44.29"></a><span id="l44.29">   NS_ASSERTION(mListener, &quot;this assertion is for Bug 531794 comment 7&quot;);</span>
<a href="#l44.30"></a><span id="l44.30">   if (mListener)</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-    mListener-&gt;OnStopRequest(ourRequest, aCtxt, aStatus);</span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+    mListener-&gt;OnStopRequest(mChannelToUse, aCtxt, aStatus);</span>
<a href="#l44.33"></a><span id="l44.33">   nsCOMPtr &lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l44.34"></a><span id="l44.34">   NS_ASSERTION(mChannelToUse, &quot;null channel in OnStopRequest&quot;);</span>
<a href="#l44.35"></a><span id="l44.35">   if (mChannelToUse)</span>
<a href="#l44.36"></a><span id="l44.36">     mChannelToUse-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l44.37"></a><span id="l44.37">   if (loadGroup)</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineminus">-    loadGroup-&gt;RemoveRequest(ourRequest, nullptr, aStatus);</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineplus">+    loadGroup-&gt;RemoveRequest(mChannelToUse, nullptr, aStatus);</span>
<a href="#l44.40"></a><span id="l44.40"> </span>
<a href="#l44.41"></a><span id="l44.41">   // clear out mem cache entry so we're not holding onto it.</span>
<a href="#l44.42"></a><span id="l44.42">   if (mRunningUrl)</span>
<a href="#l44.43"></a><span id="l44.43">     mRunningUrl-&gt;SetMemCacheEntry(nullptr);</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45">   mListener = nullptr;</span>
<a href="#l44.46"></a><span id="l44.46">   nsCOMPtr &lt;nsINNTPProtocol&gt; nntpProtocol = do_QueryInterface(mChannelToUse);</span>
<a href="#l44.47"></a><span id="l44.47">   if (nntpProtocol) {</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineat">@@ -584,18 +582,17 @@ nsNntpCacheStreamListener::OnStopRequest</span>
<a href="#l44.49"></a><span id="l44.49">   mChannelToUse = nullptr;</span>
<a href="#l44.50"></a><span id="l44.50">   return rv;</span>
<a href="#l44.51"></a><span id="l44.51"> }</span>
<a href="#l44.52"></a><span id="l44.52"> </span>
<a href="#l44.53"></a><span id="l44.53"> NS_IMETHODIMP</span>
<a href="#l44.54"></a><span id="l44.54"> nsNntpCacheStreamListener::OnDataAvailable(nsIRequest *request, nsISupports * aCtxt, nsIInputStream * aInStream, uint64_t aSourceOffset, uint32_t aCount)</span>
<a href="#l44.55"></a><span id="l44.55"> {</span>
<a href="#l44.56"></a><span id="l44.56">     NS_ENSURE_STATE(mListener);</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineminus">-    nsCOMPtr &lt;nsIRequest&gt; ourRequest = do_QueryInterface(mChannelToUse);</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineminus">-    return mListener-&gt;OnDataAvailable(ourRequest, aCtxt, aInStream, aSourceOffset, aCount);</span>
<a href="#l44.59"></a><span id="l44.59" class="difflineplus">+    return mListener-&gt;OnDataAvailable(mChannelToUse, aCtxt, aInStream, aSourceOffset, aCount);</span>
<a href="#l44.60"></a><span id="l44.60"> }</span>
<a href="#l44.61"></a><span id="l44.61"> </span>
<a href="#l44.62"></a><span id="l44.62"> NS_IMETHODIMP nsNNTPProtocol::GetOriginalURI(nsIURI* *aURI)</span>
<a href="#l44.63"></a><span id="l44.63"> {</span>
<a href="#l44.64"></a><span id="l44.64">     // News does not seem to have the notion of an original URI (See Bug #193317)</span>
<a href="#l44.65"></a><span id="l44.65">     NS_IF_ADDREF(*aURI = m_url);</span>
<a href="#l44.66"></a><span id="l44.66">     return NS_OK;</span>
<a href="#l44.67"></a><span id="l44.67"> }</span>
<a href="#l44.68"></a><span id="l44.68" class="difflineat">@@ -779,18 +776,18 @@ nsNNTPProtocol::OnCacheEntryAvailable(ns</span>
<a href="#l44.69"></a><span id="l44.69">       nsCOMPtr&lt;nsIStreamListenerTee&gt; tee = do_CreateInstance(NS_STREAMLISTENERTEE_CONTRACTID, &amp;rv);</span>
<a href="#l44.70"></a><span id="l44.70">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.71"></a><span id="l44.71"> </span>
<a href="#l44.72"></a><span id="l44.72">       nsCOMPtr&lt;nsIOutputStream&gt; outStream;</span>
<a href="#l44.73"></a><span id="l44.73">       rv = entry-&gt;OpenOutputStream(0, -1, getter_AddRefs(outStream));</span>
<a href="#l44.74"></a><span id="l44.74">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.75"></a><span id="l44.75"> </span>
<a href="#l44.76"></a><span id="l44.76">       rv = tee-&gt;Init(m_channelListener, outStream, nullptr);</span>
<a href="#l44.77"></a><span id="l44.77" class="difflineminus">-      m_channelListener = do_QueryInterface(tee);</span>
<a href="#l44.78"></a><span id="l44.78">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.79"></a><span id="l44.79" class="difflineplus">+      m_channelListener = tee;</span>
<a href="#l44.80"></a><span id="l44.80">     }</span>
<a href="#l44.81"></a><span id="l44.81">     else</span>
<a href="#l44.82"></a><span id="l44.82">     {</span>
<a href="#l44.83"></a><span id="l44.83">       rv = ReadFromMemCache(entry);</span>
<a href="#l44.84"></a><span id="l44.84">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l44.85"></a><span id="l44.85">         entry-&gt;MarkValid();</span>
<a href="#l44.86"></a><span id="l44.86">         return NS_OK; // kick out if reading from the cache succeeded...</span>
<a href="#l44.87"></a><span id="l44.87">       }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/rdf/base/nsInMemoryDataSource.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/rdf/base/nsInMemoryDataSource.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1846,23 +1846,17 @@ InMemoryDataSource::VisitAllSubjects(rdf</span>
<a href="#l45.4"></a><span id="l45.4"> {</span>
<a href="#l45.5"></a><span id="l45.5">     // Lock datasource against writes</span>
<a href="#l45.6"></a><span id="l45.6">     ++mReadCount;</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8">     // Enumerate all of our entries.</span>
<a href="#l45.9"></a><span id="l45.9">     nsresult rv = NS_OK;</span>
<a href="#l45.10"></a><span id="l45.10">     for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l45.11"></a><span id="l45.11">         auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-        nsresult rv2;</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; subject = do_QueryInterface(entry-&gt;mNode, &amp;rv2);</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-        if (NS_FAILED(rv2)) {</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineminus">-            NS_WARNING(&quot;QI to nsIRDFNode failed&quot;);</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineminus">-            continue;</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineminus">-        }</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineminus">-        rv = aVisitor-&gt;Visit(subject, nullptr, nullptr, true);</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineplus">+        rv = aVisitor-&gt;Visit(entry-&gt;mNode, nullptr, nullptr, true);</span>
<a href="#l45.20"></a><span id="l45.20">         if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l45.21"></a><span id="l45.21">             break;</span>
<a href="#l45.22"></a><span id="l45.22">         }</span>
<a href="#l45.23"></a><span id="l45.23">     }</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25">     // Unlock datasource</span>
<a href="#l45.26"></a><span id="l45.26">     --mReadCount;</span>
<a href="#l45.27"></a><span id="l45.27"> </span>
<a href="#l45.28"></a><span id="l45.28" class="difflineat">@@ -1875,49 +1869,44 @@ InMemoryDataSource::VisitAllTriples(rdfI</span>
<a href="#l45.29"></a><span id="l45.29">     // Lock datasource against writes</span>
<a href="#l45.30"></a><span id="l45.30">     ++mReadCount;</span>
<a href="#l45.31"></a><span id="l45.31"> </span>
<a href="#l45.32"></a><span id="l45.32">     // Enumerate all of our entries.</span>
<a href="#l45.33"></a><span id="l45.33">     nsresult rv = NS_OK;</span>
<a href="#l45.34"></a><span id="l45.34">     for (auto iter = mForwardArcs.Iter(); !iter.Done(); iter.Next()) {</span>
<a href="#l45.35"></a><span id="l45.35">         auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37" class="difflineminus">-        nsresult rv2;</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineminus">-        nsCOMPtr&lt;nsIRDFNode&gt; subject = do_QueryInterface(entry-&gt;mNode, &amp;rv2);</span>
<a href="#l45.39"></a><span id="l45.39" class="difflineminus">-        if (NS_FAILED(rv2)) {</span>
<a href="#l45.40"></a><span id="l45.40" class="difflineminus">-            NS_WARNING(&quot;QI to nsIRDFNode failed&quot;);</span>
<a href="#l45.41"></a><span id="l45.41" class="difflineminus">-</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-        } else if (entry-&gt;mAssertions-&gt;mHashEntry) {</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+        if (entry-&gt;mAssertions-&gt;mHashEntry) {</span>
<a href="#l45.44"></a><span id="l45.44">             for (auto iter = entry-&gt;mAssertions-&gt;u.hash.mPropertyHash-&gt;Iter();</span>
<a href="#l45.45"></a><span id="l45.45">                  !iter.Done();</span>
<a href="#l45.46"></a><span id="l45.46">                  iter.Next()) {</span>
<a href="#l45.47"></a><span id="l45.47">                 auto entry = static_cast&lt;Entry*&gt;(iter.Get());</span>
<a href="#l45.48"></a><span id="l45.48">                 Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l45.49"></a><span id="l45.49">                 while (assertion) {</span>
<a href="#l45.50"></a><span id="l45.50">                     NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l45.51"></a><span id="l45.51" class="difflineminus">-                    rv = aVisitor-&gt;Visit(subject, assertion-&gt;u.as.mProperty,</span>
<a href="#l45.52"></a><span id="l45.52" class="difflineminus">-                                                  assertion-&gt;u.as.mTarget,</span>
<a href="#l45.53"></a><span id="l45.53" class="difflineminus">-                                                  assertion-&gt;u.as.mTruthValue);</span>
<a href="#l45.54"></a><span id="l45.54" class="difflineplus">+                    rv = aVisitor-&gt;Visit(entry-&gt;mNode, assertion-&gt;u.as.mProperty,</span>
<a href="#l45.55"></a><span id="l45.55" class="difflineplus">+                                                       assertion-&gt;u.as.mTarget,</span>
<a href="#l45.56"></a><span id="l45.56" class="difflineplus">+                                                       assertion-&gt;u.as.mTruthValue);</span>
<a href="#l45.57"></a><span id="l45.57">                     if (NS_FAILED(rv)) {</span>
<a href="#l45.58"></a><span id="l45.58">                         goto end;</span>
<a href="#l45.59"></a><span id="l45.59">                     }</span>
<a href="#l45.60"></a><span id="l45.60">                     if (rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l45.61"></a><span id="l45.61">                         goto inner_end;</span>
<a href="#l45.62"></a><span id="l45.62">                     }</span>
<a href="#l45.63"></a><span id="l45.63">                     assertion = assertion-&gt;mNext;</span>
<a href="#l45.64"></a><span id="l45.64">                 }</span>
<a href="#l45.65"></a><span id="l45.65">             }</span>
<a href="#l45.66"></a><span id="l45.66"> </span>
<a href="#l45.67"></a><span id="l45.67">         } else {</span>
<a href="#l45.68"></a><span id="l45.68">             Assertion* assertion = entry-&gt;mAssertions;</span>
<a href="#l45.69"></a><span id="l45.69">             while (assertion) {</span>
<a href="#l45.70"></a><span id="l45.70">                 NS_ASSERTION(!assertion-&gt;mHashEntry, &quot;shouldn't have to hashes&quot;);</span>
<a href="#l45.71"></a><span id="l45.71" class="difflineminus">-                rv = aVisitor-&gt;Visit(subject, assertion-&gt;u.as.mProperty,</span>
<a href="#l45.72"></a><span id="l45.72" class="difflineminus">-                                              assertion-&gt;u.as.mTarget,</span>
<a href="#l45.73"></a><span id="l45.73" class="difflineminus">-                                              assertion-&gt;u.as.mTruthValue);</span>
<a href="#l45.74"></a><span id="l45.74" class="difflineplus">+                rv = aVisitor-&gt;Visit(entry-&gt;mNode, assertion-&gt;u.as.mProperty,</span>
<a href="#l45.75"></a><span id="l45.75" class="difflineplus">+                                                   assertion-&gt;u.as.mTarget,</span>
<a href="#l45.76"></a><span id="l45.76" class="difflineplus">+                                                   assertion-&gt;u.as.mTruthValue);</span>
<a href="#l45.77"></a><span id="l45.77">                 if (NS_FAILED(rv) || rv == NS_RDF_STOP_VISIT) {</span>
<a href="#l45.78"></a><span id="l45.78">                     goto end;</span>
<a href="#l45.79"></a><span id="l45.79">                 }</span>
<a href="#l45.80"></a><span id="l45.80">                 assertion = assertion-&gt;mNext;</span>
<a href="#l45.81"></a><span id="l45.81">             }</span>
<a href="#l45.82"></a><span id="l45.82">         }</span>
<a href="#l45.83"></a><span id="l45.83"> </span>
<a href="#l45.84"></a><span id="l45.84">       inner_end:</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

