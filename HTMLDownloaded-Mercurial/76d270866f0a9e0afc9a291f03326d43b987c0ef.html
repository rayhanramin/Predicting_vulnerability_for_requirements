<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 7378:76d270866f0a9e0afc9a291f03326d43b987c0ef</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 76d270866f0a9e0afc9a291f03326d43b987c0ef" />
<meta property="og:url" content="/comm-central/rev/76d270866f0a9e0afc9a291f03326d43b987c0ef" />
<meta property="og:description" content="Logging to help analyze intermittent orange bug Bug 640877. rs=Standard8" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 76d270866f0a9e0afc9a291f03326d43b987c0ef 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/76d270866f0a9e0afc9a291f03326d43b987c0ef">shortlog</a> |
<a href="/comm-central/log/76d270866f0a9e0afc9a291f03326d43b987c0ef">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/76d270866f0a9e0afc9a291f03326d43b987c0ef">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/76d270866f0a9e0afc9a291f03326d43b987c0ef">files</a> |
changeset |
<a href="/comm-central/raw-rev/76d270866f0a9e0afc9a291f03326d43b987c0ef">raw</a>  | <a href="/comm-central/archive/76d270866f0a9e0afc9a291f03326d43b987c0ef.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Logging to help analyze intermittent orange bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=640877">Bug 640877</a>. rs=Standard8
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 19 Mar 2011 19:37:19 -0700</td></tr>

<tr>
 <td>changeset 7378</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/76d270866f0a9e0afc9a291f03326d43b987c0ef">76d270866f0a9e0afc9a291f03326d43b987c0ef</a></td>
</tr>



<tr>
<td>parent 7377</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d1bf277c6957334298bce9292339bd00e985663c">d1bf277c6957334298bce9292339bd00e985663c</a>
</td>
</tr>

<tr>
<td>child 7379</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a0aca3c04ef35665a82ea727988f83d89b930003">a0aca3c04ef35665a82ea727988f83d89b930003</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=76d270866f0a9e0afc9a291f03326d43b987c0ef">5657</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Sun, 20 Mar 2011 02:37:28 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@76d270866f0a [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=76d270866f0a9e0afc9a291f03326d43b987c0ef">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=76d270866f0a9e0afc9a291f03326d43b987c0ef&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&newProject=comm-central&newRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&newProject=comm-central&newRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&newProject=comm-central&newRevision=76d270866f0a9e0afc9a291f03326d43b987c0ef&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Standard8%29&revcount=50">Standard8</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=640877">640877</a></td></tr>




</table></div>

<div class="page_body description">Logging to help analyze intermittent orange bug <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=640877">Bug 640877</a>. rs=Standard8

This patch provides additional
detail in press_delete/archive_selected_messages/press_enter about what is
focused when we do these things.  It's implemented as a helper in
test-window-helpers so we can use it elsewhere.  Specifically, it might make
sense to wrap the keypress event on the controller so we always are doing
something like this.

The logging looks like so:
&quot;in window: mail:3pane (1) focused kid: DomNode: browser#multimessage: null
focused kid: DomNode: button#trash: null&quot;

It is created by having getFocusedElementForWindow take baby steps through the
window hierarchy rather than use the flag that pierces nested windows in one
step.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">mail/test/mozmill/runtest.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">file</a> |
<a href="/comm-central/annotate/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">annotate</a> |
<a href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">diff</a> |
<a href="/comm-central/comparison/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">comparison</a> |
<a href="/comm-central/log/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/runtest.py">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/76d270866f0a9e0afc9a291f03326d43b987c0ef/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/test/mozmill/runtest.py</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/test/mozmill/runtest.py</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -357,22 +357,19 @@ mozmill.LoggerListener.cases['mozmill.en</span>
<a href="#l1.4"></a><span id="l1.4"> ORIGINAL_FAILURE_LOGGER = mozmill.LoggerListener.cases['mozmill.fail']</span>
<a href="#l1.5"></a><span id="l1.5"> def logFailure(obj):</span>
<a href="#l1.6"></a><span id="l1.6">     if isinstance(obj, basestring):</span>
<a href="#l1.7"></a><span id="l1.7">         obj = json.loads(obj)</span>
<a href="#l1.8"></a><span id="l1.8">     ORIGINAL_FAILURE_LOGGER(obj[&quot;exception&quot;][&quot;message&quot;])</span>
<a href="#l1.9"></a><span id="l1.9"> mozmill.LoggerListener.cases['mozmill.fail'] = logFailure</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-def prettifyFilename(path):</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    lslash = path.rfind('/')</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-    if lslash != -1:</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-        return path[lslash+1:]</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-    else:</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineminus">-        return path</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+def prettifyFilename(path, tail_segs_desired=1):</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+    parts = path.split('/')</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+    return '/'.join(parts[-tail_segs_desired:])</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22"> def prettyPrintException(e):</span>
<a href="#l1.23"></a><span id="l1.23">     print '  EXCEPTION:', e.get('message', 'no message!')</span>
<a href="#l1.24"></a><span id="l1.24">     print '    at:', prettifyFilename(e.get('fileName', 'nonesuch')), 'line', e.get('lineNumber', 0)</span>
<a href="#l1.25"></a><span id="l1.25">     if 'stack' in e:</span>
<a href="#l1.26"></a><span id="l1.26">         for line in e['stack'].splitlines():</span>
<a href="#l1.27"></a><span id="l1.27">             if not line:</span>
<a href="#l1.28"></a><span id="l1.28">                 continue</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineat">@@ -418,17 +415,17 @@ def prettyPrintResults():</span>
<a href="#l1.30"></a><span id="l1.30">                 prettyPrintException(failure['exception'])</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> @atexit.register</span>
<a href="#l1.33"></a><span id="l1.33"> def dumpRichResults():</span>
<a href="#l1.34"></a><span id="l1.34">     print '##### MOZMILL-RICH-FAILURES-BEGIN #####'</span>
<a href="#l1.35"></a><span id="l1.35">     for result in TEST_RESULTS:</span>
<a href="#l1.36"></a><span id="l1.36">         if len(result['fails']) &gt; 0:</span>
<a href="#l1.37"></a><span id="l1.37">             for failure in result['fails']:</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineminus">-                failure['fileName'] = prettifyFilename(result['filename'])</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+                failure['fileName'] = prettifyFilename(result['filename'], 2)</span>
<a href="#l1.40"></a><span id="l1.40">                 failure['testName'] = result['name']</span>
<a href="#l1.41"></a><span id="l1.41">                 print json.dumps(failure)</span>
<a href="#l1.42"></a><span id="l1.42">     print '##### MOZMILL-RICH-FAILURES-END #####'</span>
<a href="#l1.43"></a><span id="l1.43"> </span>
<a href="#l1.44"></a><span id="l1.44"> def checkCrashesAtExit():</span>
<a href="#l1.45"></a><span id="l1.45">     if checkForCrashes(os.path.join(PROFILE_DIR, 'minidumps'), SYMBOLS_PATH,</span>
<a href="#l1.46"></a><span id="l1.46">                        TEST_NAME):</span>
<a href="#l1.47"></a><span id="l1.47">         print &gt;&gt; sys.stderr, 'TinderboxPrint: ' + TEST_NAME + '&lt;br/&gt;&lt;em class=&quot;testfail&quot;&gt;CRASH&lt;/em&gt;'</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1315,19 +1315,18 @@ function press_delete(aController) {</span>
<a href="#l2.4"></a><span id="l2.4">   if (aController == null)</span>
<a href="#l2.5"></a><span id="l2.5">     aController = mc;</span>
<a href="#l2.6"></a><span id="l2.6">   // if something is loading, make sure it finishes loading...</span>
<a href="#l2.7"></a><span id="l2.7">   wait_for_message_display_completion(aController);</span>
<a href="#l2.8"></a><span id="l2.8">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l2.9"></a><span id="l2.9">                                  &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l2.10"></a><span id="l2.10">   mark_action(&quot;fdh&quot;, &quot;press_delete&quot;,</span>
<a href="#l2.11"></a><span id="l2.11">               [&quot;selected messages:&quot;,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-               aController.folderDisplay.selectedMessages,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-               &quot;currently focused element:&quot;,</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-               aController.focusedElement]);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+               aController.folderDisplay.selectedMessages].concat(</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+                 aController.describeFocus()));</span>
<a href="#l2.17"></a><span id="l2.17">   aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l2.18"></a><span id="l2.18">                        &quot;VK_DELETE&quot;, {});</span>
<a href="#l2.19"></a><span id="l2.19">   wait_for_folder_events();</span>
<a href="#l2.20"></a><span id="l2.20"> }</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22"> /**</span>
<a href="#l2.23"></a><span id="l2.23">  * Archive the selected messages, and wait for it to complete.</span>
<a href="#l2.24"></a><span id="l2.24">  *</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineat">@@ -1338,19 +1337,18 @@ function archive_selected_messages(aCont</span>
<a href="#l2.26"></a><span id="l2.26">   if (aController == null)</span>
<a href="#l2.27"></a><span id="l2.27">     aController = mc;</span>
<a href="#l2.28"></a><span id="l2.28">   let expectedCount = aController.dbView.rowCount - aController.dbView.numSelected;</span>
<a href="#l2.29"></a><span id="l2.29">   // XXX We seem to sometimes have focus issues on trunk; this works around it.</span>
<a href="#l2.30"></a><span id="l2.30">   focus_thread_tree();</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32">   mark_action(&quot;fdh&quot;, &quot;archive_selected_messages&quot;,</span>
<a href="#l2.33"></a><span id="l2.33">               [&quot;selected messages:&quot;,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-               aController.folderDisplay.selectedMessages,</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-               &quot;currently focused element:&quot;,</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-               aController.focusedElement]);</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+               aController.folderDisplay.selectedMessages].concat(</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+                 aController.describeFocus()));</span>
<a href="#l2.39"></a><span id="l2.39">   aController.keypress(null, &quot;a&quot;, {});</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41">   // Wait for the view rowCount to decrease by the number of selected messages.</span>
<a href="#l2.42"></a><span id="l2.42">   let messagesDeletedFromView = function() {</span>
<a href="#l2.43"></a><span id="l2.43">     return aController.dbView.rowCount == expectedCount;</span>
<a href="#l2.44"></a><span id="l2.44">   };</span>
<a href="#l2.45"></a><span id="l2.45">   controller.waitForEval('subject()',</span>
<a href="#l2.46"></a><span id="l2.46">                          NORMAL_TIMEOUT,</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineat">@@ -1371,19 +1369,18 @@ function archive_selected_messages(aCont</span>
<a href="#l2.48"></a><span id="l2.48"> function press_enter(aController) {</span>
<a href="#l2.49"></a><span id="l2.49">   if (aController == null)</span>
<a href="#l2.50"></a><span id="l2.50">     aController = mc;</span>
<a href="#l2.51"></a><span id="l2.51">   // if something is loading, make sure it finishes loading...</span>
<a href="#l2.52"></a><span id="l2.52">   if (&quot;messageDisplay&quot; in aController)</span>
<a href="#l2.53"></a><span id="l2.53">     wait_for_message_display_completion(aController);</span>
<a href="#l2.54"></a><span id="l2.54">   mark_action(&quot;fdh&quot;, &quot;press_enter&quot;,</span>
<a href="#l2.55"></a><span id="l2.55">               [&quot;selected messages:&quot;,</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-               aController.folderDisplay.selectedMessages,</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-               &quot;currently focused element:&quot;,</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-               aController.focusedElement]);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+               aController.folderDisplay.selectedMessages].concat(</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+                 aController.describeFocus()));</span>
<a href="#l2.61"></a><span id="l2.61">   aController.keypress(aController == mc ? mc.eThreadTree : null,</span>
<a href="#l2.62"></a><span id="l2.62">                        &quot;VK_RETURN&quot;, {});</span>
<a href="#l2.63"></a><span id="l2.63">   // The caller's going to have to wait for message display completion</span>
<a href="#l2.64"></a><span id="l2.64"> }</span>
<a href="#l2.65"></a><span id="l2.65"> </span>
<a href="#l2.66"></a><span id="l2.66"> /**</span>
<a href="#l2.67"></a><span id="l2.67">  * Wait for the |folderDisplay| on aController (defaults to mc if omitted) to</span>
<a href="#l2.68"></a><span id="l2.68">  *  finish loading.  This generally only matters for folders that have an active</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -898,17 +898,49 @@ var AugmentEverybodyWith = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">       while (closeStack.length) {</span>
<a href="#l3.6"></a><span id="l3.6">         curPopup = closeStack.pop();</span>
<a href="#l3.7"></a><span id="l3.7">         this.keypress(new elib.Elem(curPopup), &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l3.8"></a><span id="l3.8">         if (!controller.waitForEval(&quot;subject.state == 'closed'&quot;, 1000, 50,</span>
<a href="#l3.9"></a><span id="l3.9">                                     curPopup))</span>
<a href="#l3.10"></a><span id="l3.10">           throw new Error(&quot;Popup did not close!&quot;);</span>
<a href="#l3.11"></a><span id="l3.11">       }</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    }</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    },</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    /**</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+     * mark_action helper method that produces something that can be concat()ed</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+     *  onto a list being passed to mark_action in order to describe the focus</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+     *  state of the window.  For now this will be a variable-length list but</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+     *  could be changed to a single object in the future.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+     */</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+    describeFocus: function() {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+      let arr = [</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+        &quot;in window:&quot;,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+        getWindowTypeForXulWindow(this.window) + &quot; (&quot; +</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+          getUniqueIdForXulWindow(this.window) + &quot;)&quot;];</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+      let focusedWinOut = {}, focusedElement, curWindow = this.window;</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+      // Use the focus manager to walk down through focused sub-frames so</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+      //  in the event that there is no focused element but there is a focused</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+      //  sub-frame, we can know that.</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+      for (;;) {</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+        focusedElement = focusManager.getFocusedElementForWindow(curWindow,</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+                                                                 false,</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+                                                                 focusedWinOut);</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+        arr.push(&quot;focused kid:&quot;);</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+        arr.push(focusedElement);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+        if (focusedElement &amp;&amp; (&quot;contentWindow&quot; in focusedElement)) {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+          curWindow = focusedElement.contentWindow;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+          continue;</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+        }</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+        break;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      }</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+      return arr;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+    },</span>
<a href="#l3.46"></a><span id="l3.46">   },</span>
<a href="#l3.47"></a><span id="l3.47">   getters: {</span>
<a href="#l3.48"></a><span id="l3.48">     focusedElement: function() {</span>
<a href="#l3.49"></a><span id="l3.49">       let ignoredFocusedWindow = {};</span>
<a href="#l3.50"></a><span id="l3.50">       return focusManager.getFocusedElementForWindow(this.window, true,</span>
<a href="#l3.51"></a><span id="l3.51">                                                      ignoredFocusedWindow);</span>
<a href="#l3.52"></a><span id="l3.52">     },</span>
<a href="#l3.53"></a><span id="l3.53">   },</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

