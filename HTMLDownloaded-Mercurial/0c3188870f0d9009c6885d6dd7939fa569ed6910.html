<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 4982:0c3188870f0d9009c6885d6dd7939fa569ed6910</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0c3188870f0d9009c6885d6dd7939fa569ed6910" />
<meta property="og:url" content="/comm-central/rev/0c3188870f0d9009c6885d6dd7939fa569ed6910" />
<meta property="og:description" content="Tests: Implement AUTH CRAM-MD5, PLAIN and LOGIN properly in fakeserver. Other test improvements. Bug 525238, r=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0c3188870f0d9009c6885d6dd7939fa569ed6910 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0c3188870f0d9009c6885d6dd7939fa569ed6910">shortlog</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0c3188870f0d9009c6885d6dd7939fa569ed6910">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910">files</a> |
changeset |
<a href="/comm-central/raw-rev/0c3188870f0d9009c6885d6dd7939fa569ed6910">raw</a>  | <a href="/comm-central/archive/0c3188870f0d9009c6885d6dd7939fa569ed6910.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Tests: Implement AUTH CRAM-MD5, PLAIN and LOGIN properly in fakeserver. Other test improvements. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">Bug 525238</a>, r=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#66;&#117;&#99;&#107;&#115;&#99;&#104;&#32;&#60;&#98;&#101;&#110;&#46;&#98;&#117;&#99;&#107;&#115;&#99;&#104;&#64;&#98;&#101;&#111;&#110;&#101;&#120;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 22 Feb 2010 20:46:17 +0100</td></tr>

<tr>
 <td>changeset 4982</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0c3188870f0d9009c6885d6dd7939fa569ed6910">0c3188870f0d9009c6885d6dd7939fa569ed6910</a></td>
</tr>



<tr>
<td>parent 4981</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/bb36fc49a06f8adea2ca10b988a10dc6a3f638e9">bb36fc49a06f8adea2ca10b988a10dc6a3f638e9</a>
</td>
</tr>

<tr>
<td>child 4983</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e6c5631dce79e5001419cfa9be9e3b7f59e12283">e6c5631dce79e5001419cfa9be9e3b7f59e12283</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0c3188870f0d9009c6885d6dd7939fa569ed6910">3878</a></td></tr>
<tr><td>push user</td><td>mozilla.BenB@bucksch.org</td></tr>
<tr><td>push date</td><td class="date age">Mon, 22 Feb 2010 19:46:22 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@0c3188870f0d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c3188870f0d9009c6885d6dd7939fa569ed6910">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=0c3188870f0d9009c6885d6dd7939fa569ed6910&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&newProject=comm-central&newRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&newProject=comm-central&newRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&newProject=comm-central&newRevision=0c3188870f0d9009c6885d6dd7939fa569ed6910&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">525238</a></td></tr>




</table></div>

<div class="page_body description">Tests: Implement AUTH CRAM-MD5, PLAIN and LOGIN properly in fakeserver. Other test improvements. <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=525238">Bug 525238</a>, r=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">mailnews/base/test/unit/test_testsuite_fakeserverAuth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">mailnews/compose/test/unit/head_compose.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/head_compose.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">mailnews/compose/test/unit/test_bug155172.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug155172.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">mailnews/compose/test/unit/test_sendMailMessage.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_sendMailMessage.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">mailnews/compose/test/unit/test_smtpPassword.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPassword.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">mailnews/compose/test/unit/test_smtpPasswordFailure1.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure1.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">mailnews/compose/test/unit/test_smtpPasswordFailure2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/compose/test/unit/test_smtpPasswordFailure2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">mailnews/imap/test/unit/head_server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/head_server.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">mailnews/imap/test/unit/test_imapPasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_imapPasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">mailnews/local/test/unit/head_maillocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/head_maillocal.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">mailnews/local/test/unit/test_bug457168.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_bug457168.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">mailnews/local/test/unit/test_pop3GetNewMail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3GetNewMail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">mailnews/local/test/unit/test_pop3Password.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">mailnews/local/test/unit/test_pop3Password2.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3Password2.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">mailnews/local/test/unit/test_pop3PasswordFailure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/local/test/unit/test_pop3PasswordFailure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">mailnews/test/fakeserver/auth.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/auth.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">mailnews/test/fakeserver/maild.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/maild.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">mailnews/test/fakeserver/nntpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/nntpd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">mailnews/test/fakeserver/pop3d.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/pop3d.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">mailnews/test/fakeserver/smtpd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/fakeserver/smtpd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">mailnews/test/resources/POP3pump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">file</a> |
<a href="/comm-central/annotate/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">annotate</a> |
<a href="/comm-central/diff/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">diff</a> |
<a href="/comm-central/comparison/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">comparison</a> |
<a href="/comm-central/log/0c3188870f0d9009c6885d6dd7939fa569ed6910/mailnews/test/resources/POP3pump.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_testsuite_fakeserverAuth.js</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,58 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+/**</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+ * Tests functions in mailnews/test/fakeserver/auth.js</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+ * which are responsible for the authentication in the</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+ * fakeserver.</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+ *</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+ * Do NOT essentially re-code the auth schemes here,</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+ * just check roundtrips, against static values etc..</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+ */</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+load(&quot;../../mailnews/fakeserver/auth.js&quot;)</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+const kUsername = &quot;fred1&quot;;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+const kPassword = &quot;wilma2&quot;;</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+function run_test()</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+{</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+  authPLAIN();</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineplus">+  authCRAMMD5();</span>
<a href="#l1.23"></a><span id="l1.23" class="difflineplus">+  return true;</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineplus">+};</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineplus">+</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineplus">+/**</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+ * Test AUTH PLAIN</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+ */</span>
<a href="#l1.29"></a><span id="l1.29" class="difflineplus">+function authPLAIN()</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineplus">+{</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+  // roundtrip works</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+  var line = AuthPLAIN.encodeLine(kUsername, kPassword);</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+  var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l1.34"></a><span id="l1.34" class="difflineplus">+  do_check_eq(req.username, kUsername);</span>
<a href="#l1.35"></a><span id="l1.35" class="difflineplus">+  do_check_eq(req.password, kPassword);</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineplus">+</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+  // correct encoding</span>
<a href="#l1.38"></a><span id="l1.38" class="difflineplus">+  do_check_eq(line, &quot;AGZyZWQxAHdpbG1hMg==&quot;);</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineplus">+};</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineplus">+/**</span>
<a href="#l1.42"></a><span id="l1.42" class="difflineplus">+ * Test AUTH CRAM-MD5</span>
<a href="#l1.43"></a><span id="l1.43" class="difflineplus">+ */</span>
<a href="#l1.44"></a><span id="l1.44" class="difflineplus">+function authCRAMMD5()</span>
<a href="#l1.45"></a><span id="l1.45" class="difflineplus">+{</span>
<a href="#l1.46"></a><span id="l1.46" class="difflineplus">+  // AuthCRAM.createChallenge() creates a different challenge each time</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  var hardcodedChallenge = btoa(&quot;&lt;123@fake.invalid&gt;&quot;);</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+  var hardcodedResponse = &quot;ZnJlZDEgOTA5YjgwMmM3NTI5NTJlYzI2NjgyMTNmYTdjNWU0ZjQ=&quot;;</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  // correct encoding</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+  var req = AuthCRAM.decodeLine(hardcodedResponse);</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+  do_check_eq(req.username, kUsername);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  var expectedDigest = AuthCRAM.encodeCRAMMD5(hardcodedChallenge, kPassword);</span>
<a href="#l1.54"></a><span id="l1.54" class="difflineplus">+  do_check_eq(req.digest, expectedDigest);</span>
<a href="#l1.55"></a><span id="l1.55" class="difflineplus">+</span>
<a href="#l1.56"></a><span id="l1.56" class="difflineplus">+  var challenge = AuthCRAM.createChallenge(&quot;fake.invalid&quot;);</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineplus">+  challenge = atob(challenge); // decode. function currently returns it already encoded</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+  var challengeSplit = challenge.split(&quot;@&quot;);</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+  do_check_eq(challengeSplit.length, 2);</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+  do_check_eq(challengeSplit[1], &quot;fake.invalid&gt;&quot;);</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+  do_check_eq(challengeSplit[0][0], &quot;&lt;&quot;);</span>
<a href="#l1.62"></a><span id="l1.62" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/test/unit/head_compose.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1,22 +1,23 @@</span>
<a href="#l2.4"></a><span id="l2.4"> // Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l2.5"></a><span id="l2.5"> load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l2.6"></a><span id="l2.6"> load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> // Import the smtp server scripts</span>
<a href="#l2.9"></a><span id="l2.9"> load(&quot;../../mailnews/fakeserver/maild.js&quot;)</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+load(&quot;../../mailnews/fakeserver/auth.js&quot;)</span>
<a href="#l2.11"></a><span id="l2.11"> load(&quot;../../mailnews/fakeserver/smtpd.js&quot;)</span>
<a href="#l2.12"></a><span id="l2.12"> </span>
<a href="#l2.13"></a><span id="l2.13"> const SMTP_PORT = 1024+120;</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> // Setup the daemon and server</span>
<a href="#l2.16"></a><span id="l2.16"> function setupServerDaemon(handler) {</span>
<a href="#l2.17"></a><span id="l2.17">   if (!handler)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-    handler = new SMTP_RFC2822_handler(new smtpDaemon());</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+    handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l2.20"></a><span id="l2.20">   var server = new nsMailServer(handler);</span>
<a href="#l2.21"></a><span id="l2.21">   return server;</span>
<a href="#l2.22"></a><span id="l2.22"> }</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> function getBasicSmtpServer() {</span>
<a href="#l2.25"></a><span id="l2.25">   var smtpService = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l2.26"></a><span id="l2.26">                       .getService(Ci.nsISmtpService);</span>
<a href="#l2.27"></a><span id="l2.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug155172.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -27,20 +27,22 @@ const kUsername = &quot;test.smtp@fakeserver&quot;</span>
<a href="#l3.4"></a><span id="l3.4"> // kPassword 2 is the one defined in signons-mailnews1.8.txt, the other one</span>
<a href="#l3.5"></a><span id="l3.5"> // is intentionally wrong.</span>
<a href="#l3.6"></a><span id="l3.6"> const kPassword1 = &quot;wrong&quot;;</span>
<a href="#l3.7"></a><span id="l3.7"> const kPassword2 = &quot;smtptest&quot;;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> function run_test() {</span>
<a href="#l3.10"></a><span id="l3.10">   registerAlertTestUtils();</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  var handler = new SMTP_RFC2822_handler(new smtpDaemon());</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  handler._username = kUsername;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-  handler._password = kPassword1;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  // Username needs to match signons.txt</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  handler.kUsername = kUsername;</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  handler.kPassword = kPassword1;</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  handler.kAuthRequired = true;</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23">   server = setupServerDaemon(handler);</span>
<a href="#l3.24"></a><span id="l3.24">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l3.25"></a><span id="l3.25"> </span>
<a href="#l3.26"></a><span id="l3.26">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l3.27"></a><span id="l3.27">   var signons = do_get_file(&quot;data/signons-smtp.txt&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> </span>
<a href="#l3.29"></a><span id="l3.29">   // Copy the file to the profile directory for a PAB</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineat">@@ -79,24 +81,19 @@ function run_test() {</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">     // Set the new password for when we get a prompt</span>
<a href="#l3.33"></a><span id="l3.33">     gNewPassword = kPassword1;</span>
<a href="#l3.34"></a><span id="l3.34"> </span>
<a href="#l3.35"></a><span id="l3.35">     server.performTest();</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">     var transaction = server.playTransaction();</span>
<a href="#l3.38"></a><span id="l3.38">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa('\u0000' +</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineminus">-                                                            kUsername +</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineminus">-                                                            '\u0000' +</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-                                                            kPassword2),</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa('\u0000' +</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                                                            kUsername +</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                                                            '\u0000' +</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                                                            kPassword1),</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword2),</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+                                       &quot;AUTH LOGIN&quot;,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword1),</span>
<a href="#l3.50"></a><span id="l3.50">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l3.51"></a><span id="l3.51">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l3.52"></a><span id="l3.52">                                        &quot;DATA&quot;]);</span>
<a href="#l3.53"></a><span id="l3.53"> </span>
<a href="#l3.54"></a><span id="l3.54">   } catch (e) {</span>
<a href="#l3.55"></a><span id="l3.55">     do_throw(e);</span>
<a href="#l3.56"></a><span id="l3.56">   } finally {</span>
<a href="#l3.57"></a><span id="l3.57">     server.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -38,22 +38,21 @@ msll.prototype = {</span>
<a href="#l4.4"></a><span id="l4.4">                                    aMessageSendPercent, aMessageCopyPercent) {</span>
<a href="#l4.5"></a><span id="l4.5">     // XXX Enable this function</span>
<a href="#l4.6"></a><span id="l4.6">   },</span>
<a href="#l4.7"></a><span id="l4.7">   onMessageSendError: function (aCurrentMessage, aMessageHeader, aStatus,</span>
<a href="#l4.8"></a><span id="l4.8">                                 aMsg) {</span>
<a href="#l4.9"></a><span id="l4.9">     do_throw(&quot;onMessageSendError should not have been called, status: &quot; + aStatus);</span>
<a href="#l4.10"></a><span id="l4.10">   },</span>
<a href="#l4.11"></a><span id="l4.11">   onStopSending: function (aStatus, aMsg, aTotalTried, aSuccessful) {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    do_test_finished();</span>
<a href="#l4.13"></a><span id="l4.13">     print(&quot;msll onStopSending\n&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">     try {</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+      do_check_eq(aSuccessful, 1);</span>
<a href="#l4.16"></a><span id="l4.16">       do_check_eq(aStatus, 0);</span>
<a href="#l4.17"></a><span id="l4.17">       do_check_eq(aTotalTried, 1);</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-      do_check_eq(aSuccessful, 1);</span>
<a href="#l4.19"></a><span id="l4.19">       do_check_eq(this._initialTotal, 1);</span>
<a href="#l4.20"></a><span id="l4.20">       do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22">       do_check_transaction(server.playTransaction(),</span>
<a href="#l4.23"></a><span id="l4.23">                            [&quot;EHLO test&quot;,</span>
<a href="#l4.24"></a><span id="l4.24">                             &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=&quot; + originalData.length,</span>
<a href="#l4.25"></a><span id="l4.25">                             &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l4.26"></a><span id="l4.26">                             &quot;DATA&quot;]);</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineat">@@ -67,16 +66,17 @@ msll.prototype = {</span>
<a href="#l4.28"></a><span id="l4.28">       do_throw(e);</span>
<a href="#l4.29"></a><span id="l4.29">     } finally {</span>
<a href="#l4.30"></a><span id="l4.30">       server.stop();</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">       var thread = gThreadManager.currentThread;</span>
<a href="#l4.33"></a><span id="l4.33">       while (thread.hasPendingEvents())</span>
<a href="#l4.34"></a><span id="l4.34">         thread.processNextEvent(true);</span>
<a href="#l4.35"></a><span id="l4.35">     }</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    do_test_finished();</span>
<a href="#l4.37"></a><span id="l4.37">   }</span>
<a href="#l4.38"></a><span id="l4.38"> };</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40"> function OnStopCopy(aStatus)</span>
<a href="#l4.41"></a><span id="l4.41"> {</span>
<a href="#l4.42"></a><span id="l4.42">   do_test_finished();</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMailMessage.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,27 +1,25 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /**</span>
<a href="#l5.6"></a><span id="l5.6">  * Protocol tests for SMTP.</span>
<a href="#l5.7"></a><span id="l5.7">  *</span>
<a href="#l5.8"></a><span id="l5.8">  * This test currently consists of verifying the correct protocol sequence</span>
<a href="#l5.9"></a><span id="l5.9">  * between mailnews and SMTP server. It does not check the data of the message</span>
<a href="#l5.10"></a><span id="l5.10">  * either side of the link, it will be extended later to do that.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var type = null;</span>
<a href="#l5.13"></a><span id="l5.13"> var test = null;</span>
<a href="#l5.14"></a><span id="l5.14"> var server;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l5.17"></a><span id="l5.17"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l5.18"></a><span id="l5.18"> const kUsername = &quot;testsmtp&quot;;</span>
<a href="#l5.19"></a><span id="l5.19"> const kPassword = &quot;smtptest&quot;;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineminus">-function test_RFC2822() {</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  type = &quot;RFC 2822&quot;;</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+function test_RFC2821() {</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   // Test file</span>
<a href="#l5.26"></a><span id="l5.26">   var testFile = do_get_file(&quot;data/message1.eml&quot;);</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28">   // Ensure we have at least one mail account</span>
<a href="#l5.29"></a><span id="l5.29">   loadLocalMailAccount();</span>
<a href="#l5.30"></a><span id="l5.30"> </span>
<a href="#l5.31"></a><span id="l5.31">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineat">@@ -66,20 +64,17 @@ function test_RFC2822() {</span>
<a href="#l5.33"></a><span id="l5.33">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l5.34"></a><span id="l5.34">                                 null, null, null, null,</span>
<a href="#l5.35"></a><span id="l5.35">                                 false, {}, {});</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">     server.performTest();</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">     var transaction = server.playTransaction();</span>
<a href="#l5.40"></a><span id="l5.40">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa(&quot;\u0000&quot; +</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-                                                            kUsername +</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-                                                            &quot;\u0000&quot; +</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-                                                            kPassword),</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l5.46"></a><span id="l5.46">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l5.47"></a><span id="l5.47">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l5.48"></a><span id="l5.48">                                        &quot;DATA&quot;]);</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   } catch (e) {</span>
<a href="#l5.52"></a><span id="l5.52">     do_throw(e);</span>
<a href="#l5.53"></a><span id="l5.53">   } finally {</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineat">@@ -89,10 +84,10 @@ function test_RFC2822() {</span>
<a href="#l5.55"></a><span id="l5.55">     while (thread.hasPendingEvents())</span>
<a href="#l5.56"></a><span id="l5.56">       thread.processNextEvent(true);</span>
<a href="#l5.57"></a><span id="l5.57">   }</span>
<a href="#l5.58"></a><span id="l5.58"> }</span>
<a href="#l5.59"></a><span id="l5.59"> </span>
<a href="#l5.60"></a><span id="l5.60"> function run_test() {</span>
<a href="#l5.61"></a><span id="l5.61">   server = setupServerDaemon();</span>
<a href="#l5.62"></a><span id="l5.62"> </span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-  test_RFC2822();</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+  test_RFC2821();</span>
<a href="#l5.65"></a><span id="l5.65"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPassword.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -7,17 +7,22 @@ var server;</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5"> const kSender = &quot;from@invalid.com&quot;;</span>
<a href="#l6.6"></a><span id="l6.6"> const kTo = &quot;to@invalid.com&quot;;</span>
<a href="#l6.7"></a><span id="l6.7"> const kUsername = &quot;testsmtp&quot;;</span>
<a href="#l6.8"></a><span id="l6.8"> // This is the same as in the signons file.</span>
<a href="#l6.9"></a><span id="l6.9"> const kPassword = &quot;smtptest&quot;;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> function run_test() {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  server = setupServerDaemon();</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  server = new nsMailServer(handler);</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  // Username and password need to match signons.txt</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineplus">+  handler.kUsername = kUsername;</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineplus">+  handler.kPassword = kPassword;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  handler.kAuthRequired = true;</span>
<a href="#l6.19"></a><span id="l6.19"> </span>
<a href="#l6.20"></a><span id="l6.20">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l6.21"></a><span id="l6.21">   var signons = do_get_file(&quot;../../mailnews/data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   // Copy the file to the profile directory for a PAB</span>
<a href="#l6.24"></a><span id="l6.24">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l6.25"></a><span id="l6.25"> </span>
<a href="#l6.26"></a><span id="l6.26">   // Test file</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineat">@@ -50,20 +55,17 @@ function run_test() {</span>
<a href="#l6.28"></a><span id="l6.28">     smtpService.sendMailMessage(testFile, kTo, identity,</span>
<a href="#l6.29"></a><span id="l6.29">                                 null, null, null, null,</span>
<a href="#l6.30"></a><span id="l6.30">                                 false, {}, {});</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">     server.performTest();</span>
<a href="#l6.33"></a><span id="l6.33"> </span>
<a href="#l6.34"></a><span id="l6.34">     var transaction = server.playTransaction();</span>
<a href="#l6.35"></a><span id="l6.35">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l6.36"></a><span id="l6.36" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa(&quot;\u0000&quot; +</span>
<a href="#l6.37"></a><span id="l6.37" class="difflineminus">-                                                            kUsername +</span>
<a href="#l6.38"></a><span id="l6.38" class="difflineminus">-                                                            &quot;\u0000&quot; +</span>
<a href="#l6.39"></a><span id="l6.39" class="difflineminus">-                                                            kPassword),</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kPassword),</span>
<a href="#l6.41"></a><span id="l6.41">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l6.42"></a><span id="l6.42">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l6.43"></a><span id="l6.43">                                        &quot;DATA&quot;]);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45">   } catch (e) {</span>
<a href="#l6.46"></a><span id="l6.46">     do_throw(e);</span>
<a href="#l6.47"></a><span id="l6.47">   } finally {</span>
<a href="#l6.48"></a><span id="l6.48">     server.stop();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure1.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -72,19 +72,22 @@ function confirmEx(aDialogTitle, aText, </span>
<a href="#l7.4"></a><span id="l7.4">       return 1;</span>
<a href="#l7.5"></a><span id="l7.5">     default:</span>
<a href="#l7.6"></a><span id="l7.6">       do_throw(&quot;unexpected attempt number &quot; + attempt);</span>
<a href="#l7.7"></a><span id="l7.7">       return 1;</span>
<a href="#l7.8"></a><span id="l7.8">   }</span>
<a href="#l7.9"></a><span id="l7.9"> }</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> function run_test() {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  var handler = new SMTP_RFC2822_handler(new smtpDaemon(), &quot;PLAIN&quot;, kUsername,</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-                                         kValidPassword);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l7.15"></a><span id="l7.15">   server = new nsMailServer(handler);</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineplus">+  // Username needs to match signons.txt</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineplus">+  handler.kUsername = kUsername;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+  handler.kPassword = kValidPassword;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineplus">+  handler.kAuthRequired = true;</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l7.22"></a><span id="l7.22">   var signons = do_get_file(&quot;../../mailnews/data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24">   // Copy the file to the profile directory for a PAB</span>
<a href="#l7.25"></a><span id="l7.25">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27">   registerAlertTestUtils();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_smtpPasswordFailure2.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -82,19 +82,23 @@ function promptPasswordPS(aParent, aDial</span>
<a href="#l8.4"></a><span id="l8.4">     aPassword.value = kValidPassword;</span>
<a href="#l8.5"></a><span id="l8.5">     aCheckState.value = true;</span>
<a href="#l8.6"></a><span id="l8.6">     return true;</span>
<a href="#l8.7"></a><span id="l8.7">   }</span>
<a href="#l8.8"></a><span id="l8.8">   return false;</span>
<a href="#l8.9"></a><span id="l8.9"> }</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> function run_test() {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  var handler = new SMTP_RFC2822_handler(new smtpDaemon(), &quot;PLAIN&quot;, kUsername,</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-                                         kValidPassword);</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+  var handler = new SMTP_RFC2821_handler(new smtpDaemon());</span>
<a href="#l8.15"></a><span id="l8.15">   server = new nsMailServer(handler);</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+  // Username needs to match signons.txt</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  handler.kUsername = kUsername;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  handler.kPassword = kValidPassword;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+  handler.kAuthRequired = true;</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+  handler.kAuthSchemes = [ &quot;PLAIN&quot;, &quot;LOGIN&quot; ]; // make match expected transaction below</span>
<a href="#l8.21"></a><span id="l8.21"> </span>
<a href="#l8.22"></a><span id="l8.22">   // Passwords File (generated from Mozilla 1.8 branch).</span>
<a href="#l8.23"></a><span id="l8.23">   var signons = do_get_file(&quot;../../mailnews/data/signons-mailnews1.8.txt&quot;);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   // Copy the file to the profile directory for a PAB</span>
<a href="#l8.26"></a><span id="l8.26">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l8.27"></a><span id="l8.27"> </span>
<a href="#l8.28"></a><span id="l8.28">   registerAlertTestUtils();</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineat">@@ -136,30 +140,23 @@ function run_test() {</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">     dump(&quot;End Send\n&quot;);</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33">     do_check_eq(attempt, 2);</span>
<a href="#l8.34"></a><span id="l8.34"> </span>
<a href="#l8.35"></a><span id="l8.35">     var transaction = server.playTransaction();</span>
<a href="#l8.36"></a><span id="l8.36">     do_check_transaction(transaction, [&quot;EHLO test&quot;,</span>
<a href="#l8.37"></a><span id="l8.37">                                        // attempt 3 invalid password</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa(&quot;\u0000&quot; +</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-                                                            kUsername +</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-                                                            &quot;\u0000&quot; +</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-                                                            kInvalidPassword),</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kInvalidPassword),</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+                                       &quot;AUTH LOGIN&quot;,</span>
<a href="#l8.44"></a><span id="l8.44">                                        // attempt 4 which retries</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa(&quot;\u0000&quot; +</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-                                                            kUsername +</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-                                                            &quot;\u0000&quot; +</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-                                                            kInvalidPassword),</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kInvalidPassword),</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+                                       &quot;AUTH LOGIN&quot;,</span>
<a href="#l8.51"></a><span id="l8.51">                                        // then we enter the correct password</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-                                       &quot;AUTH PLAIN &quot; + btoa(&quot;\u0000&quot; +</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineminus">-                                                            kUsername +</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineminus">-                                                            &quot;\u0000&quot; +</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineminus">-                                                            kValidPassword),</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+                                       &quot;AUTH PLAIN &quot; + AuthPLAIN.encodeLine(kUsername, kValidPassword),</span>
<a href="#l8.57"></a><span id="l8.57">                                        &quot;MAIL FROM:&lt;&quot; + kSender + &quot;&gt; SIZE=155&quot;,</span>
<a href="#l8.58"></a><span id="l8.58">                                        &quot;RCPT TO:&lt;&quot; + kTo + &quot;&gt;&quot;,</span>
<a href="#l8.59"></a><span id="l8.59">                                        &quot;DATA&quot;]);</span>
<a href="#l8.60"></a><span id="l8.60"> </span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62">       // Now check the new one has been saved.</span>
<a href="#l8.63"></a><span id="l8.63">       let loginMgr = Cc[&quot;@mozilla.org/login-manager;1&quot;].getService(Ci.nsILoginManager);</span>
<a href="#l8.64"></a><span id="l8.64"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/test/unit/head_server.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/test/unit/head_server.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,25 +1,26 @@</span>
<a href="#l9.4"></a><span id="l9.4"> // Import fakeserver</span>
<a href="#l9.5"></a><span id="l9.5"> load(&quot;../../mailnews/fakeserver/maild.js&quot;);</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineplus">+load(&quot;../../mailnews/fakeserver/auth.js&quot;);</span>
<a href="#l9.7"></a><span id="l9.7"> load(&quot;../../mailnews/fakeserver/imapd.js&quot;);</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> // And mailnews scripts</span>
<a href="#l9.10"></a><span id="l9.10"> load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l9.11"></a><span id="l9.11"> load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l9.12"></a><span id="l9.12"> </span>
<a href="#l9.13"></a><span id="l9.13"> const IMAP_PORT = 1024 + 143;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> function makeServer(daemon, infoString) {</span>
<a href="#l9.16"></a><span id="l9.16">   if (infoString in configurations)</span>
<a href="#l9.17"></a><span id="l9.17">     return makeServer(daemon, configurations[infoString].join(&quot;,&quot;));</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   var handler = new IMAP_RFC3501_handler(daemon);</span>
<a href="#l9.20"></a><span id="l9.20">   if (!infoString)</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-    infoString = &quot;&quot;;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+    infoString = &quot;RFC2195&quot;;</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24">   var parts = infoString.split(/ *, */);</span>
<a href="#l9.25"></a><span id="l9.25">   for each (var part in parts) {</span>
<a href="#l9.26"></a><span id="l9.26">     if (part.substring(0, 3) == &quot;RFC&quot;)</span>
<a href="#l9.27"></a><span id="l9.27">       mixinExtension(handler, eval(&quot;IMAP_&quot; + part + &quot;_extension&quot;));</span>
<a href="#l9.28"></a><span id="l9.28">   }</span>
<a href="#l9.29"></a><span id="l9.29">   var server = new nsMailServer(handler);</span>
<a href="#l9.30"></a><span id="l9.30">   server.start(IMAP_PORT);</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineat">@@ -38,8 +39,42 @@ function createLocalIMAPServer() {</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33">   var account = acctmgr.createAccount();</span>
<a href="#l9.34"></a><span id="l9.34">   account.incomingServer = server;</span>
<a href="#l9.35"></a><span id="l9.35">   server.valid = true;</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37">   server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l9.38"></a><span id="l9.38">   return server;</span>
<a href="#l9.39"></a><span id="l9.39"> }</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+// &lt;copied from=&quot;head_maillocal.js&quot;&gt;</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+/**</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+ * @param fromServer server.playTransaction</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+ * @param expected [&quot;command&quot;, &quot;command&quot;, ...]</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+ * @param withParams if false,</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+ *    everything apart from the IMAP command will the stripped.</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ *    E.g. 'lsub &quot;&quot; &quot;*&quot;' will be compared as 'lsub'.</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ *    Exception is &quot;authenticate&quot;, which also get its first parameter in upper case,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+ *    e.g. &quot;authenticate CRAM-MD5&quot;.</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+ */</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+function do_check_transaction(fromServer, expected, withParams) {</span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+  // If we don't spin the event loop before starting the next test, the readers</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+  // aren't expired. In this case, the &quot;real&quot; real transaction is the last one.</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+  if (fromServer instanceof Array)</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+    fromServer = fromServer[fromServer.length - 1];</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+  var realTransaction = new Array();</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  for (var i = 0; i &lt; fromServer.them.length; i++)</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  {</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    var line = fromServer.them[i]; // e.g. '1 login &quot;user&quot; &quot;password&quot;'</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    var components = line.split(&quot; &quot;);</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+    if (components.length &lt; 2)</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+      throw &quot;IMAP command in transaction log missing: &quot; + line;</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+    if (withParams)</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+      realTransaction.push(line.substr(components[0].length + 1));</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+    else if (components[1] == &quot;authenticate&quot;)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+      realTransaction.push(components[1] + &quot; &quot; + components[2].toUpperCase());</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+    else</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+      realTransaction.push(components[1]);</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+  }</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+  do_check_eq(realTransaction.join(&quot;, &quot;), expected.join(&quot;, &quot;));</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapPasswordFailure.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -90,16 +90,20 @@ function run_test() {</span>
<a href="#l10.4"></a><span id="l10.4"> </span>
<a href="#l10.5"></a><span id="l10.5">   registerAlertTestUtils();</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7">   let daemon = new imapDaemon();</span>
<a href="#l10.8"></a><span id="l10.8">   daemon.createMailbox(&quot;Subscribed&quot;, {subscribed : true});</span>
<a href="#l10.9"></a><span id="l10.9">   server = makeServer(daemon, &quot;&quot;);</span>
<a href="#l10.10"></a><span id="l10.10">   server.setDebugLevel(fsDebugAll);</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+  // Make username of server match the singons.txt file (pw there is intentionally invalid)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+  server._handler.kUsername = kUserName;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  server._handler.kPassword = kValidPassword;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+</span>
<a href="#l10.16"></a><span id="l10.16">   incomingServer = createLocalIMAPServer();</span>
<a href="#l10.17"></a><span id="l10.17"> </span>
<a href="#l10.18"></a><span id="l10.18">   // PerformExpand expects us to already have a password loaded into the</span>
<a href="#l10.19"></a><span id="l10.19">   // incomingServer when we call it, so force a get password call to get it</span>
<a href="#l10.20"></a><span id="l10.20">   // out of the signons file (first removing the value that</span>
<a href="#l10.21"></a><span id="l10.21">   // createLocalIMAPServer puts in there).</span>
<a href="#l10.22"></a><span id="l10.22">   incomingServer.password = &quot;&quot;;</span>
<a href="#l10.23"></a><span id="l10.23">   let password = incomingServer.getPasswordWithUI(&quot;Prompt Message&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_nsIMsgFolderListenerIMAP.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -31,30 +31,28 @@ const gMsgFile5 = do_get_file(&quot;../../mai</span>
<a href="#l11.4"></a><span id="l11.4"> const gMsgId1 = &quot;200806061706.m56H6RWT004933@mrapp54.mozilla.org&quot;;</span>
<a href="#l11.5"></a><span id="l11.5"> const gMsgId2 = &quot;200804111417.m3BEHTk4030129@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.6"></a><span id="l11.6"> const gMsgId3 = &quot;4849BF7B.2030800@example.com&quot;;</span>
<a href="#l11.7"></a><span id="l11.7"> const gMsgId4 = &quot;bugmail7.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.8"></a><span id="l11.8"> const gMsgId5 = &quot;bugmail6.m47LtAEf007542@mrapp51.mozilla.org&quot;;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10"> function addFolder(parent, folderName, storeIn)</span>
<a href="#l11.11"></a><span id="l11.11"> {</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l11.13"></a><span id="l11.13">   gExpectedEvents = [[gMFNService.folderAdded, parent, folderName, storeIn]];</span>
<a href="#l11.14"></a><span id="l11.14">   // No copy listener notification for this</span>
<a href="#l11.15"></a><span id="l11.15">   gCurrStatus |= kStatus.onStopCopyDone;</span>
<a href="#l11.16"></a><span id="l11.16">   parent.createSubfolder(folderName, null);</span>
<a href="#l11.17"></a><span id="l11.17">   gCurrStatus |= kStatus.functionCallDone;</span>
<a href="#l11.18"></a><span id="l11.18">   gServer.performTest(&quot;LIST&quot;);</span>
<a href="#l11.19"></a><span id="l11.19">   if (gCurrStatus == kStatus.everythingDone)</span>
<a href="#l11.20"></a><span id="l11.20">     resetStatusAndProceed();</span>
<a href="#l11.21"></a><span id="l11.21"> }</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> function copyFileMessage(file, messageId, destFolder)</span>
<a href="#l11.24"></a><span id="l11.24"> {</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l11.26"></a><span id="l11.26">   copyListener.mFolderStoredIn = destFolder;</span>
<a href="#l11.27"></a><span id="l11.27"> </span>
<a href="#l11.28"></a><span id="l11.28">   // This *needs* to be a draft (fourth parameter), as for non-UIDPLUS servers,</span>
<a href="#l11.29"></a><span id="l11.29">   // nsImapProtocol::UploadMessageFromFile is hardcoded not to send a copy</span>
<a href="#l11.30"></a><span id="l11.30">   // listener notification. The same function also asks for the message id from</span>
<a href="#l11.31"></a><span id="l11.31">   // the copy listener, without which it will *not* send the notification.</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   // ...but wait, nsImapProtocol.cpp requires SEARCH afterwards to retrieve the</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineat">@@ -277,17 +275,16 @@ function doTest(test)</span>
<a href="#l11.35"></a><span id="l11.35">     gIMAPFolder3 = null;</span>
<a href="#l11.36"></a><span id="l11.36">     gIMAPTrashFolder = null;</span>
<a href="#l11.37"></a><span id="l11.37">     do_timeout(1000, endTest);</span>
<a href="#l11.38"></a><span id="l11.38">   }</span>
<a href="#l11.39"></a><span id="l11.39"> }</span>
<a href="#l11.40"></a><span id="l11.40"> </span>
<a href="#l11.41"></a><span id="l11.41"> function endTest()</span>
<a href="#l11.42"></a><span id="l11.42"> {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  gServer.resetTest();</span>
<a href="#l11.44"></a><span id="l11.44">   gIMAPIncomingServer.closeCachedConnections();</span>
<a href="#l11.45"></a><span id="l11.45">   gServer.performTest();</span>
<a href="#l11.46"></a><span id="l11.46">   gServer.stop();</span>
<a href="#l11.47"></a><span id="l11.47">   let thread = gThreadManager.currentThread;</span>
<a href="#l11.48"></a><span id="l11.48">   while (thread.hasPendingEvents())</span>
<a href="#l11.49"></a><span id="l11.49">     thread.processNextEvent(true);</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51">   do_test_finished(); // for the one in run_test()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/local/test/unit/head_maillocal.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,39 +1,40 @@</span>
<a href="#l12.4"></a><span id="l12.4"> // Import the main scripts that mailnews tests need to set up and tear down</span>
<a href="#l12.5"></a><span id="l12.5"> load(&quot;../../mailnews/resources/mailDirService.js&quot;);</span>
<a href="#l12.6"></a><span id="l12.6"> load(&quot;../../mailnews/resources/mailTestUtils.js&quot;);</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // Import the pop3 server scripts</span>
<a href="#l12.9"></a><span id="l12.9"> load(&quot;../../mailnews/fakeserver/maild.js&quot;)</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+load(&quot;../../mailnews/fakeserver/auth.js&quot;)</span>
<a href="#l12.11"></a><span id="l12.11"> load(&quot;../../mailnews/fakeserver/pop3d.js&quot;)</span>
<a href="#l12.12"></a><span id="l12.12"> </span>
<a href="#l12.13"></a><span id="l12.13"> const POP3_PORT = 1024+110;</span>
<a href="#l12.14"></a><span id="l12.14"> </span>
<a href="#l12.15"></a><span id="l12.15"> // Setup the daemon and server</span>
<a href="#l12.16"></a><span id="l12.16"> // If the debugOption is set, then it will be applied to the server.</span>
<a href="#l12.17"></a><span id="l12.17"> function setupServerDaemon(debugOption) {</span>
<a href="#l12.18"></a><span id="l12.18">   var daemon = new pop3Daemon();</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-  var handler = new POP3_RFC1939_handler(daemon);</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+  var handler = new POP3_RFC5034_handler(daemon);</span>
<a href="#l12.21"></a><span id="l12.21">   var server = new nsMailServer(handler);</span>
<a href="#l12.22"></a><span id="l12.22">   if (debugOption)</span>
<a href="#l12.23"></a><span id="l12.23">     server.setDebugLevel(debugOption);</span>
<a href="#l12.24"></a><span id="l12.24">   return [daemon, server, handler];</span>
<a href="#l12.25"></a><span id="l12.25"> }</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> function createPop3ServerAndLocalFolders() {</span>
<a href="#l12.28"></a><span id="l12.28">   loadLocalMailAccount();</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l12.31"></a><span id="l12.31">                   .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  var incoming = acctMgr.createIncomingServer(&quot;fake&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  var incoming = acctMgr.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36">   incoming.port = POP3_PORT;</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-  incoming.password = &quot;server&quot;;</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+  incoming.password = &quot;wilma&quot;;</span>
<a href="#l12.39"></a><span id="l12.39"> </span>
<a href="#l12.40"></a><span id="l12.40">   return incoming;</span>
<a href="#l12.41"></a><span id="l12.41"> }</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43"> function do_check_transaction(real, expected) {</span>
<a href="#l12.44"></a><span id="l12.44">   // If we don't spin the event loop before starting the next test, the readers</span>
<a href="#l12.45"></a><span id="l12.45">   // aren't expired. In this case, the &quot;real&quot; real transaction is the last one.</span>
<a href="#l12.46"></a><span id="l12.46">   if (real instanceof Array)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/local/test/unit/test_bug457168.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_bug457168.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -6,22 +6,20 @@ var type = null;</span>
<a href="#l13.4"></a><span id="l13.4"> var test = null;</span>
<a href="#l13.5"></a><span id="l13.5"> var server;</span>
<a href="#l13.6"></a><span id="l13.6"> var daemon;</span>
<a href="#l13.7"></a><span id="l13.7"> var incomingServer;</span>
<a href="#l13.8"></a><span id="l13.8"> var pop3Service;</span>
<a href="#l13.9"></a><span id="l13.9"> var firstTest = true;</span>
<a href="#l13.10"></a><span id="l13.10"> var thisTest;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-// The fake server doesn't support AUTH and CAPA (not part of RFC 1939),</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-// but mailnews correctly tries anyway.</span>
<a href="#l13.14"></a><span id="l13.14"> var tests = [</span>
<a href="#l13.15"></a><span id="l13.15">   { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l13.16"></a><span id="l13.16">     messages: [ &quot;message2.eml&quot;, &quot;message2.eml&quot;, &quot;message3.eml&quot; ],</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fake&quot;, &quot;PASS server&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l13.19"></a><span id="l13.19">                    &quot;UIDL&quot;, &quot;XTND XLST Message-Id&quot;,</span>
<a href="#l13.20"></a><span id="l13.20">                    &quot;RETR 1&quot;, &quot;DELE 1&quot;, &quot;RETR 2&quot;, &quot;DELE 2&quot;, &quot;RETR 3&quot;, &quot;DELE 3&quot; ] }</span>
<a href="#l13.21"></a><span id="l13.21"> ];</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> var urlListener =</span>
<a href="#l13.24"></a><span id="l13.24"> {</span>
<a href="#l13.25"></a><span id="l13.25">   OnStartRunningUrl: function (url) {</span>
<a href="#l13.26"></a><span id="l13.26">   },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3GetNewMail.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3GetNewMail.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -1,33 +1,30 @@</span>
<a href="#l14.4"></a><span id="l14.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l14.5"></a><span id="l14.5"> /**</span>
<a href="#l14.6"></a><span id="l14.6">  * Protocol tests for POP3.</span>
<a href="#l14.7"></a><span id="l14.7">  */</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineminus">-var type = null;</span>
<a href="#l14.9"></a><span id="l14.9"> var test = null;</span>
<a href="#l14.10"></a><span id="l14.10"> var server;</span>
<a href="#l14.11"></a><span id="l14.11"> var daemon;</span>
<a href="#l14.12"></a><span id="l14.12"> var incomingServer;</span>
<a href="#l14.13"></a><span id="l14.13"> var pop3Service;</span>
<a href="#l14.14"></a><span id="l14.14"> var firstTest = true;</span>
<a href="#l14.15"></a><span id="l14.15"> var thisTest;</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-// The fake server doesn't support AUTH and CAPA (not part of RFC 1939),</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-// but mailnews correctly tries anyway.</span>
<a href="#l14.19"></a><span id="l14.19"> var tests = [</span>
<a href="#l14.20"></a><span id="l14.20">   { title: &quot;Get New Mail, No Messages&quot;,</span>
<a href="#l14.21"></a><span id="l14.21">     messages: [],</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER fake&quot;, &quot;PASS server&quot;, &quot;STAT&quot; ] },</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l14.24"></a><span id="l14.24">   { title: &quot;Get New Mail, No Messages 2&quot;,</span>
<a href="#l14.25"></a><span id="l14.25">     messages: [],</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-    transaction: [ &quot;CAPA&quot;, &quot;USER fake&quot;, &quot;PASS server&quot;, &quot;STAT&quot; ] },</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+    transaction: [ &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot; ] },</span>
<a href="#l14.28"></a><span id="l14.28">   { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l14.29"></a><span id="l14.29">     messages: [&quot;message1.eml&quot;],</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-    transaction: [ &quot;CAPA&quot;, &quot;USER fake&quot;, &quot;PASS server&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+    transaction: [ &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l14.32"></a><span id="l14.32">                    &quot;UIDL&quot;, &quot;XTND XLST Message-Id&quot;,</span>
<a href="#l14.33"></a><span id="l14.33">                    &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l14.34"></a><span id="l14.34"> ];</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36"> var urlListener =</span>
<a href="#l14.37"></a><span id="l14.37"> {</span>
<a href="#l14.38"></a><span id="l14.38">   OnStartRunningUrl: function (url) {</span>
<a href="#l14.39"></a><span id="l14.39">   },</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineat">@@ -127,18 +124,16 @@ function run_test() {</span>
<a href="#l14.41"></a><span id="l14.41">   prefSvc.setBoolPref(&quot;mail.biff.show_alert&quot;, false);</span>
<a href="#l14.42"></a><span id="l14.42">   prefSvc.setBoolPref(&quot;mail.biff.show_tray_icon&quot;, false);</span>
<a href="#l14.43"></a><span id="l14.43">   prefSvc.setBoolPref(&quot;mail.biff.animate_dock_icon&quot;, false);</span>
<a href="#l14.44"></a><span id="l14.44"> </span>
<a href="#l14.45"></a><span id="l14.45">   server = setupServerDaemon();</span>
<a href="#l14.46"></a><span id="l14.46">   daemon = server[0];</span>
<a href="#l14.47"></a><span id="l14.47">   server = server[1];</span>
<a href="#l14.48"></a><span id="l14.48"> </span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-  type = &quot;RFC 1939&quot;;</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-</span>
<a href="#l14.51"></a><span id="l14.51">   // Set up the basic accounts and folders</span>
<a href="#l14.52"></a><span id="l14.52">   incomingServer = createPop3ServerAndLocalFolders();</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">   // Check that we haven't got any messages in the folder, if we have its a test</span>
<a href="#l14.55"></a><span id="l14.55">   // setup issue.</span>
<a href="#l14.56"></a><span id="l14.56">   do_check_eq(gLocalInboxFolder.getTotalMessages(false), 0);</span>
<a href="#l14.57"></a><span id="l14.57"> </span>
<a href="#l14.58"></a><span id="l14.58">   pop3Service = Cc[&quot;@mozilla.org/messenger/popservice;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,27 +1,24 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l15.5"></a><span id="l15.5"> /**</span>
<a href="#l15.6"></a><span id="l15.6">  * Authentication tests for POP3.</span>
<a href="#l15.7"></a><span id="l15.7">  */</span>
<a href="#l15.8"></a><span id="l15.8" class="difflineminus">-var type = null;</span>
<a href="#l15.9"></a><span id="l15.9"> var test = null;</span>
<a href="#l15.10"></a><span id="l15.10"> var server;</span>
<a href="#l15.11"></a><span id="l15.11"> var daemon;</span>
<a href="#l15.12"></a><span id="l15.12"> var incomingServer;</span>
<a href="#l15.13"></a><span id="l15.13"> var pop3Service;</span>
<a href="#l15.14"></a><span id="l15.14"> var firstTest = true;</span>
<a href="#l15.15"></a><span id="l15.15"> var thisTest;</span>
<a href="#l15.16"></a><span id="l15.16"> </span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-// The fake server doesn't support AUTH and CAPA (not part of RFC 1939),</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-// but mailnews correctly tries anyway.</span>
<a href="#l15.19"></a><span id="l15.19"> var tests = [</span>
<a href="#l15.20"></a><span id="l15.20">   { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l15.21"></a><span id="l15.21">     messages: [&quot;message1.eml&quot;],</span>
<a href="#l15.22"></a><span id="l15.22" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER testpop3&quot;, &quot;PASS pop3test&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l15.24"></a><span id="l15.24">                    &quot;UIDL&quot;, &quot;XTND XLST Message-Id&quot;,</span>
<a href="#l15.25"></a><span id="l15.25">                    &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l15.26"></a><span id="l15.26"> ];</span>
<a href="#l15.27"></a><span id="l15.27"> </span>
<a href="#l15.28"></a><span id="l15.28"> var urlListener =</span>
<a href="#l15.29"></a><span id="l15.29"> {</span>
<a href="#l15.30"></a><span id="l15.30">   OnStartRunningUrl: function (url) {</span>
<a href="#l15.31"></a><span id="l15.31">   },</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineat">@@ -127,22 +124,21 @@ function run_test() {</span>
<a href="#l15.33"></a><span id="l15.33"> </span>
<a href="#l15.34"></a><span id="l15.34">   // Copy the file to the profile directory for a PAB</span>
<a href="#l15.35"></a><span id="l15.35">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l15.36"></a><span id="l15.36"> </span>
<a href="#l15.37"></a><span id="l15.37">   // Set up the Server</span>
<a href="#l15.38"></a><span id="l15.38">   var serverArray = setupServerDaemon();</span>
<a href="#l15.39"></a><span id="l15.39">   daemon = serverArray[0];</span>
<a href="#l15.40"></a><span id="l15.40">   server = serverArray[1];</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+  var handler = serverArray[2]</span>
<a href="#l15.42"></a><span id="l15.42"> </span>
<a href="#l15.43"></a><span id="l15.43">   // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  serverArray[2].expectedUsername = &quot;testpop3&quot;;</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineminus">-  serverArray[2].expectedPassword = &quot;pop3test&quot;;</span>
<a href="#l15.46"></a><span id="l15.46" class="difflineminus">-</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  type = &quot;RFC 1939&quot;;</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  handler.kUsername = &quot;testpop3&quot;;</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  handler.kPassword = &quot;pop3test&quot;;</span>
<a href="#l15.50"></a><span id="l15.50"> </span>
<a href="#l15.51"></a><span id="l15.51">   // Set up the basic accounts and folders.</span>
<a href="#l15.52"></a><span id="l15.52">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l15.53"></a><span id="l15.53">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l15.54"></a><span id="l15.54">   // it from signons.txt).</span>
<a href="#l15.55"></a><span id="l15.55">   loadLocalMailAccount();</span>
<a href="#l15.56"></a><span id="l15.56"> </span>
<a href="#l15.57"></a><span id="l15.57">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3Password2.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -1,29 +1,26 @@</span>
<a href="#l16.4"></a><span id="l16.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l16.5"></a><span id="l16.5"> /**</span>
<a href="#l16.6"></a><span id="l16.6">  * Authentication tests for POP3 - checks for servers whose details have</span>
<a href="#l16.7"></a><span id="l16.7">  * changed (e.g. realusername and realhostname are different from username and</span>
<a href="#l16.8"></a><span id="l16.8">  * hostname).</span>
<a href="#l16.9"></a><span id="l16.9">  */</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineminus">-var type = null;</span>
<a href="#l16.11"></a><span id="l16.11"> var test = null;</span>
<a href="#l16.12"></a><span id="l16.12"> var server;</span>
<a href="#l16.13"></a><span id="l16.13"> var daemon;</span>
<a href="#l16.14"></a><span id="l16.14"> var incomingServer;</span>
<a href="#l16.15"></a><span id="l16.15"> var pop3Service;</span>
<a href="#l16.16"></a><span id="l16.16"> var firstTest = true;</span>
<a href="#l16.17"></a><span id="l16.17"> var thisTest;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-// The fake server doesn't support AUTH and CAPA (not part of RFC 1939),</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-// but mailnews correctly tries anyway.</span>
<a href="#l16.21"></a><span id="l16.21"> var tests = [</span>
<a href="#l16.22"></a><span id="l16.22">   { title: &quot;Get New Mail, One Message&quot;,</span>
<a href="#l16.23"></a><span id="l16.23">     messages: [&quot;message1.eml&quot;],</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;USER testpop3&quot;, &quot;PASS pop3test&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+    transaction: [ &quot;AUTH&quot;, &quot;CAPA&quot;, &quot;AUTH PLAIN&quot;, &quot;STAT&quot;, &quot;LIST&quot;,</span>
<a href="#l16.26"></a><span id="l16.26">                    &quot;UIDL&quot;, &quot;XTND XLST Message-Id&quot;,</span>
<a href="#l16.27"></a><span id="l16.27">                    &quot;RETR 1&quot;, &quot;DELE 1&quot; ] }</span>
<a href="#l16.28"></a><span id="l16.28"> ];</span>
<a href="#l16.29"></a><span id="l16.29"> </span>
<a href="#l16.30"></a><span id="l16.30"> var urlListener =</span>
<a href="#l16.31"></a><span id="l16.31"> {</span>
<a href="#l16.32"></a><span id="l16.32">   OnStartRunningUrl: function (url) {</span>
<a href="#l16.33"></a><span id="l16.33">   },</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineat">@@ -156,22 +153,21 @@ function run_test() {</span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   // Copy the file to the profile directory</span>
<a href="#l16.37"></a><span id="l16.37">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l16.38"></a><span id="l16.38"> </span>
<a href="#l16.39"></a><span id="l16.39">   // Set up the Server</span>
<a href="#l16.40"></a><span id="l16.40">   var serverArray = setupServerDaemon();</span>
<a href="#l16.41"></a><span id="l16.41">   daemon = serverArray[0];</span>
<a href="#l16.42"></a><span id="l16.42">   server = serverArray[1];</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+  var handler = serverArray[2];</span>
<a href="#l16.44"></a><span id="l16.44"> </span>
<a href="#l16.45"></a><span id="l16.45">   // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineminus">-  serverArray[2].expectedUsername = &quot;testpop3&quot;;</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineminus">-  serverArray[2].expectedPassword = &quot;pop3test&quot;;</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineminus">-  type = &quot;RFC 1939&quot;;</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+  handler.kUsername = &quot;testpop3&quot;;</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+  handler.kPassword = &quot;pop3test&quot;;</span>
<a href="#l16.52"></a><span id="l16.52"> </span>
<a href="#l16.53"></a><span id="l16.53">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l16.54"></a><span id="l16.54">                   .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l16.55"></a><span id="l16.55"> </span>
<a href="#l16.56"></a><span id="l16.56">   acctMgr.LoadAccounts();</span>
<a href="#l16.57"></a><span id="l16.57"> </span>
<a href="#l16.58"></a><span id="l16.58">   gLocalIncomingServer = acctMgr.localFoldersServer;</span>
<a href="#l16.59"></a><span id="l16.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_pop3PasswordFailure.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -8,17 +8,16 @@</span>
<a href="#l17.4"></a><span id="l17.4">  *   - Re-initiate connection, this time select enter new password, check that</span>
<a href="#l17.5"></a><span id="l17.5">  *     we get a new password prompt and can enter the password.</span>
<a href="#l17.6"></a><span id="l17.6">  */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> load(&quot;../../mailnews/resources/alertTestUtils.js&quot;);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-var type = null;</span>
<a href="#l17.13"></a><span id="l17.13"> var test = null;</span>
<a href="#l17.14"></a><span id="l17.14"> var server;</span>
<a href="#l17.15"></a><span id="l17.15"> var daemon;</span>
<a href="#l17.16"></a><span id="l17.16"> var incomingServer;</span>
<a href="#l17.17"></a><span id="l17.17"> var pop3Service;</span>
<a href="#l17.18"></a><span id="l17.18"> var attempt = 0;</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> const kUserName = &quot;testpop3&quot;;</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -194,22 +193,21 @@ function run_test()</span>
<a href="#l17.22"></a><span id="l17.22">   signons.copyTo(gProfileDir, &quot;signons.txt&quot;);</span>
<a href="#l17.23"></a><span id="l17.23"> </span>
<a href="#l17.24"></a><span id="l17.24">   registerAlertTestUtils();</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">   // Set up the Server</span>
<a href="#l17.27"></a><span id="l17.27">   var serverArray = setupServerDaemon();</span>
<a href="#l17.28"></a><span id="l17.28">   daemon = serverArray[0];</span>
<a href="#l17.29"></a><span id="l17.29">   server = serverArray[1];</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+  var handler = serverArray[2];</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32">   // Set the server expected username &amp; password to what we have in signons.txt</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-  serverArray[2].expectedUsername = kUserName;</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineminus">-  serverArray[2].expectedPassword = kValidPassword;</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineminus">-</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineminus">-  type = &quot;RFC 1939&quot;;</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+  handler.kUsername = kUserName;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+  handler.kPassword = kValidPassword;</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40">   // Set up the basic accounts and folders.</span>
<a href="#l17.41"></a><span id="l17.41">   // We would use createPop3ServerAndLocalFolders() however we want to have</span>
<a href="#l17.42"></a><span id="l17.42">   // a different username and NO password for this test (as we expect to load</span>
<a href="#l17.43"></a><span id="l17.43">   // it from signons.txt).</span>
<a href="#l17.44"></a><span id="l17.44">   loadLocalMailAccount();</span>
<a href="#l17.45"></a><span id="l17.45"> </span>
<a href="#l17.46"></a><span id="l17.46">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mailnews/test/fakeserver/auth.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,218 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ *</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ *</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ * License.</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ *</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ * The Original Code is the fakeserver.</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ *</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ *  Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ *</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ *</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ *</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+/**</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+ * This file implements the authentication mechanisms</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+ * - AUTH PLAIN</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+ * - AUTH CRAM-MD5</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+ * for all the server implementations, i.e. in a generic way.</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+ * In fact, you could use this to implement a real server in JS :-) .</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+ *</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+ * @author Ben Bucksch &lt;ben.bucksch beonex.com&gt;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+ */</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+/**</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+ * Implements AUTH PLAIN</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+ * @see RFC 4616</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+ */</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+var AuthPLAIN = {</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  /**</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+   * Takes full PLAIN auth line, and decodes it.</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+   *</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+   * @param line {String}</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+   * @returns {Object { username : value, password : value } }</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+   * @throws {String}   error to return to client</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+   */</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+  decodeLine: function(line) {</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+    dump(&quot;AUTH PLAIN line -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+    line = atob(line); // base64 decode</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    aap = line.split(&quot;\u0000&quot;); // 0-charater is delimiter</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+    if (aap.length != 3)</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+      throw &quot;Expected three parts&quot;;</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+    /* aap is: authorize-id, authenticate-id, password.</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+       Generally, authorize-id = authenticate-id = username.</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+       authorize-id may thus be empty and then defaults to authenticate-id. */</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+    var result = {};</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+    var authzid = aap[0];</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+    result.username = aap[1];</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    result.password = aap[2];</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+    dump(&quot;authorize-id: -&quot; + authzid + &quot;-, username: -&quot; + result.username + &quot;-, password: -&quot; + result.password + &quot;-\n&quot;);</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+    if (authzid &amp;&amp; authzid != result.username)</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+      throw &quot;Expecting a authorize-id that's either the same as authenticate-id or empty&quot;;</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+    return result;</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+  },</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  /**</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+   * Create an AUTH PLAIN line, to allow a client to authenticate to a server.</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+   * Useful for tests.</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+   */</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  encodeLine : function(username, password)</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+  {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+    return btoa(&quot;\u0000&quot; + username + &quot;\u0000&quot; + password); // base64 encode</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+  },</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+};</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+var AuthLOGIN = {</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+  /**</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+   * Takes full LOGIN auth line, and decodes it.</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+   * It may contain either username or password,</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+   * depending on state/step (first username, then pw).</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+   *</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+   * @param line {String}</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+   * @returns {String}   username or password</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+   * @throws {String}   error to return to client</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+   */</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+  decodeLine: function (line) {</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+    dump(&quot;AUTH LOGIN -&quot; + atob(line) + &quot;-\n&quot;);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+    return atob(line); // base64 decode</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+  },</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+};</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+/**</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  * Implements AUTH CRAM-MD5</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+  * @see RFC 2195, RFC 2104</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+  */</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+var AuthCRAM = {</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+  /**</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+   * First part of CRAM exchange is that the server sends</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+   * a challenge to the client. The client response depends on</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+   * the challenge. (This prevents replay attacks, I think.)</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+   * This function generates the challenge.</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+   *</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+   * You need to store it, you'll need it to check the client response.</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+   *</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+   * @param domain {String}   Your hostname or domain,</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+   *    e.g. &quot;example.com&quot;, &quot;mx.example.com&quot; or just &quot;localhost&quot;.</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+   * @returns {String}   The challenge.</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+   *   It's already base64-encoded. Send it as-is to the client.</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+   */</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+  createChallenge : function(domain)</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  {</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+    var timestamp = new Date().getTime(); // unixtime</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+    var challenge = &quot;&lt;&quot; + timestamp + &quot;@&quot; + domain + &quot;&gt;&quot;;</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+    dump(&quot;CRAM challenge unencoded: &quot; + challenge + &quot;\n&quot;);</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+    return btoa(challenge);</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+  },</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+  /**</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+   * Takes full CRAM-MD5 auth line, and decodes it.</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+   *</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+   * Compare the returned |digest| to the result of</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+   * encodeCRAMMD5(). If they match, the |username|</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+   * returned here is authenticated.</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+   *</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+   * @param line {String}</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+   * @returns {Object { username : value, digest : value } }</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+   * @throws {String}   error to return to client</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+   */</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+  decodeLine : function(line)</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+  {</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+    dump(&quot;AUTH CRAM-MD5 line -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    line = atob(line);</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+    dump(&quot;base64 decoded -&quot; + line + &quot;-\n&quot;);</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+    sp = line.split(&quot; &quot;);</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+    if (sp.length != 2)</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+      throw &quot;Expected one space&quot;;</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+    var result = {};</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+    result.username = sp[0];</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+    result.digest = sp[1];</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+    return result;</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+  },</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+  /**</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+   * @param text {String}   server challenge (base64-encoded)</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+   * @param key {String}   user's password</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+   * @return {String}   digest as hex string</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+   */</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+  encodeCRAMMD5 : function(text, key)</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  {</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+    text = atob(text); // createChallenge() returns it already encoded</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+    dump(&quot;encodeCRAMMD5(text: -&quot; + text + &quot;-, key: -&quot; + key + &quot;-)\n&quot;);</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+    const kInputLen = 64;</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+    //const kHashLen = 16;</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+    const kInnerPad = 0x36; // per spec</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+    const kOuterPad = 0x5C;</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+    key = this.textToNumberArray(key);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+    text = this.textToNumberArray(text);</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+    // Make sure key is exactly kDigestLen bytes long. Algo per spec.</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+    if (key.length &gt; kInputLen)</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+      key = this.md5(key); // (results in kHashLen)</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+    while (key.length &lt; kInputLen)</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+      key.push(0); // fill up with zeros</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+    // MD5((key XOR outerpad) + MD5((key XOR innerpad) + text)) , per spec</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+    var digest = this.md5(this.xor(key, kOuterPad)</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+         .concat(this.md5(this.xor(key, kInnerPad)</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineplus">+         .concat(text))));</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+    return this.arrayToHexString(digest);</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  },</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+  // Utils</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+  xor : function(binary, value)</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+  {</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+    var result = [];</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+    for (var i = 0; i &lt; binary.length; i++)</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+      result.push(binary[i] ^ value);</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+    return result;</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+  },</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+  md5 : function(binary)</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+  {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+    var md5 = Cc[&quot;@mozilla.org/security/hash;1&quot;]</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+        .createInstance(Ci.nsICryptoHash);</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+    md5.init(Ci.nsICryptoHash.MD5);</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+    md5.update(binary, binary.length);</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+    return this.textToNumberArray(md5.finish(false));</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+  },</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+  textToNumberArray : function(text)</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+  {</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+    var array = [];</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+    for (var i = 0; i &lt; text.length; i++)</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+      array.push(text.charCodeAt(i) &amp; 0xFF); // convert string (only lower byte) to array</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+    return array;</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+  },</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+  arrayToHexString : function(binary)</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+  {</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+    var result = &quot;&quot;;</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+    for (var i = 0; i &lt; binary.length; i++)</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+    {</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+      if (binary[i] &gt; 255)</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+        throw &quot;unexpected that value &gt; 255&quot;;</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+      let hex = binary[i].toString(16);</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+      if (hex.length &lt; 2)</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+        hex = &quot;0&quot; + hex;</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+      result += hex;</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+    }</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+    return result;</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+  },</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -634,20 +634,33 @@ function formatArg(argument, spec) {</span>
<a href="#l19.4"></a><span id="l19.4">  * onError, which parses the message into components. Like other fakeserver</span>
<a href="#l19.5"></a><span id="l19.5">  * implementations, the command property will be called, but this time with an</span>
<a href="#l19.6"></a><span id="l19.6">  * argument that is an array of data items instead of a string representing the</span>
<a href="#l19.7"></a><span id="l19.7">  * rest of the line.</span>
<a href="#l19.8"></a><span id="l19.8">  */</span>
<a href="#l19.9"></a><span id="l19.9"> function IMAP_RFC3501_handler(daemon) {</span>
<a href="#l19.10"></a><span id="l19.10">   this._daemon = daemon;</span>
<a href="#l19.11"></a><span id="l19.11">   this.closing = false;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-  this._authenticating = undefined;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+  // map: property = auth scheme {String}, value = start function on this obj</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+  this._kAuthSchemeStartFunction = {};</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+  this.resetTest();</span>
<a href="#l19.18"></a><span id="l19.18"> }</span>
<a href="#l19.19"></a><span id="l19.19"> IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+  kUsername : &quot;user&quot;,</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+  kPassword : &quot;password&quot;,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+  kAuthSchemes : [], // Added by RFC2195 extension. Test may modify as needed.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+  kCapabilities : [/*&quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;,*/], // Test may modify as needed.</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+  resetTest : function() {</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+    this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+    this._multiline = false;</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+    this._nextAuthFunction = undefined; // should be in RFC2195_ext, but too lazy</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+  },</span>
<a href="#l19.31"></a><span id="l19.31">   onStartup : function () {</span>
<a href="#l19.32"></a><span id="l19.32">     return &quot;* OK IMAP4rev1 Fakeserver started up&quot;;</span>
<a href="#l19.33"></a><span id="l19.33">   },</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35">   ////////////////////////////////////</span>
<a href="#l19.36"></a><span id="l19.36">   // CENTRALIZED DISPATCH FUNCTIONS //</span>
<a href="#l19.37"></a><span id="l19.37">   ////////////////////////////////////</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39" class="difflineat">@@ -671,16 +684,19 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.40"></a><span id="l19.40">       return &quot;+ More!&quot;;</span>
<a href="#l19.41"></a><span id="l19.41">     } catch (ex) {</span>
<a href="#l19.42"></a><span id="l19.42">       return this._tag + &quot; BAD &quot; + ex;</span>
<a href="#l19.43"></a><span id="l19.43">     }</span>
<a href="#l19.44"></a><span id="l19.44"> </span>
<a href="#l19.45"></a><span id="l19.45">     // If we're here, we have a command with arguments. Dispatch!</span>
<a href="#l19.46"></a><span id="l19.46">     return this._dispatchCommand(command, args);</span>
<a href="#l19.47"></a><span id="l19.47">   },</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+  onServerFault: function (e) {</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+    return this._tag + &quot; BAD internal server error: &quot; + e;</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+  },</span>
<a href="#l19.51"></a><span id="l19.51">   onMultiline : function (line) {</span>
<a href="#l19.52"></a><span id="l19.52">     // A multiline arising form a literal being passed</span>
<a href="#l19.53"></a><span id="l19.53">     if (this._partial) {</span>
<a href="#l19.54"></a><span id="l19.54">       // There are two cases to be concerned with:</span>
<a href="#l19.55"></a><span id="l19.55">       // 1. The CRLF is internal or end (we want more)</span>
<a href="#l19.56"></a><span id="l19.56">       // 1a. The next line is the actual command stuff!</span>
<a href="#l19.57"></a><span id="l19.57">       // 2. The CRLF is in the middle (rest of the line is args)</span>
<a href="#l19.58"></a><span id="l19.58">       if (this._partial.length &gt;= line.length + 2) { // Case 1</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineat">@@ -704,35 +720,30 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.60"></a><span id="l19.60">         this._multiline = false;</span>
<a href="#l19.61"></a><span id="l19.61">         return this.tag + &quot; BAD parse error: &quot; + ex;</span>
<a href="#l19.62"></a><span id="l19.62">       }</span>
<a href="#l19.63"></a><span id="l19.63"> </span>
<a href="#l19.64"></a><span id="l19.64">       this._partial = undefined;</span>
<a href="#l19.65"></a><span id="l19.65">       this._multiline = false;</span>
<a href="#l19.66"></a><span id="l19.66">       return this._dispatchCommand(command, args);</span>
<a href="#l19.67"></a><span id="l19.67">     }</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-    if (this._authenticating) {</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineminus">-      line = atob(line);</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+    if (this._nextAuthFunction) {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+      var func = this._nextAuthFunction;</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+      this._multiline = false;</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+      this._nextAuthFunction = undefined;</span>
<a href="#l19.75"></a><span id="l19.75">       if (line == &quot;*&quot;) {</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-        this._authenticating = undefined;</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-        this._multiline = false;</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-        return this._tag + &quot; BAD okay, I won't authenticate you.&quot;;</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+        return this._tag + &quot; BAD Okay, as you wish. Chicken&quot;;</span>
<a href="#l19.80"></a><span id="l19.80">       }</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineminus">-      // base64 encoded &lt;nul&gt;user&lt;nul&gt;password</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-      if (line == atob(&quot;AHVzZXIAcGFzc3dvcmQ=&quot;)) {</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-        this._authenticating = undefined;</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineminus">-        this._state = IMAP_STATE_AUTHED;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-        this._multiline = false;</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineminus">-        return this._tag + &quot; OK I just authenticated you. Happy now?&quot;;</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+      if (!func || typeof(func) != &quot;function&quot;) {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+        return this._tag + &quot; BAD I'm lost. Internal server error during auth&quot;;</span>
<a href="#l19.89"></a><span id="l19.89">       }</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-      else {</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-        this._authenticating = undefined;</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineminus">-        this._multiline = false;</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineminus">-        return this._tag + &quot; BAD invalid password, I won't authenticate you.&quot;;</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineminus">-      }</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+      try {</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+        return this._tag + &quot; &quot; + func.call(this, line);</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+      } catch (e) { return this._tag + &quot; BAD &quot; + e; }</span>
<a href="#l19.98"></a><span id="l19.98">     }</span>
<a href="#l19.99"></a><span id="l19.99">     return undefined;</span>
<a href="#l19.100"></a><span id="l19.100">   },</span>
<a href="#l19.101"></a><span id="l19.101">   _dispatchCommand : function (command, args) {</span>
<a href="#l19.102"></a><span id="l19.102">     command = command.toUpperCase();</span>
<a href="#l19.103"></a><span id="l19.103">     if (command in this) {</span>
<a href="#l19.104"></a><span id="l19.104">       this._lastCommand = command;</span>
<a href="#l19.105"></a><span id="l19.105">       // Are we allowed to execute this command?</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineat">@@ -744,17 +755,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.107"></a><span id="l19.107">         args = this._treatArgs(args, command);</span>
<a href="#l19.108"></a><span id="l19.108"> </span>
<a href="#l19.109"></a><span id="l19.109">         // Finally, run the thing</span>
<a href="#l19.110"></a><span id="l19.110">         var response = this[command](args);</span>
<a href="#l19.111"></a><span id="l19.111">       } catch (e if typeof e == &quot;string&quot;) {</span>
<a href="#l19.112"></a><span id="l19.112">         var response = e;</span>
<a href="#l19.113"></a><span id="l19.113">       }</span>
<a href="#l19.114"></a><span id="l19.114">     } else {</span>
<a href="#l19.115"></a><span id="l19.115" class="difflineminus">-      var response = &quot;BAD parse error: command not implemented&quot;;</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineplus">+      var response = &quot;BAD &quot; + command  + &quot; not implemented&quot;;</span>
<a href="#l19.117"></a><span id="l19.117">     }</span>
<a href="#l19.118"></a><span id="l19.118"> </span>
<a href="#l19.119"></a><span id="l19.119">     // Add status updates</span>
<a href="#l19.120"></a><span id="l19.120">     if (this._selectedMailbox) {</span>
<a href="#l19.121"></a><span id="l19.121">       for each (var update in this._selectedMailbox._updates) {</span>
<a href="#l19.122"></a><span id="l19.122">         var line;</span>
<a href="#l19.123"></a><span id="l19.123">         switch (update) {</span>
<a href="#l19.124"></a><span id="l19.124">         case &quot;EXISTS&quot;:</span>
<a href="#l19.125"></a><span id="l19.125" class="difflineat">@@ -839,17 +850,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.126"></a><span id="l19.126">   // [ ] -&gt; optional argument.</span>
<a href="#l19.127"></a><span id="l19.127">   // x|y -&gt; either x or y format.</span>
<a href="#l19.128"></a><span id="l19.128">   // ... -&gt; variable args, don't parse</span>
<a href="#l19.129"></a><span id="l19.129">   _argFormat : {</span>
<a href="#l19.130"></a><span id="l19.130">     CAPABILITY : [],</span>
<a href="#l19.131"></a><span id="l19.131">     NOOP : [],</span>
<a href="#l19.132"></a><span id="l19.132">     LOGOUT : [],</span>
<a href="#l19.133"></a><span id="l19.133">     STARTTLS : [],</span>
<a href="#l19.134"></a><span id="l19.134" class="difflineminus">-    AUTHENTICATE : [&quot;atom&quot;],</span>
<a href="#l19.135"></a><span id="l19.135" class="difflineplus">+    AUTHENTICATE : [&quot;atom&quot;, &quot;...&quot;],</span>
<a href="#l19.136"></a><span id="l19.136">     LOGIN : [&quot;string&quot;, &quot;string&quot;],</span>
<a href="#l19.137"></a><span id="l19.137">     SELECT : [&quot;mailbox&quot;],</span>
<a href="#l19.138"></a><span id="l19.138">     EXAMINE : [&quot;mailbox&quot;],</span>
<a href="#l19.139"></a><span id="l19.139">     CREATE : [&quot;mailbox&quot;],</span>
<a href="#l19.140"></a><span id="l19.140">     DELETE : [&quot;mailbox&quot;],</span>
<a href="#l19.141"></a><span id="l19.141">     RENAME : [&quot;mailbox&quot;, &quot;mailbox&quot;],</span>
<a href="#l19.142"></a><span id="l19.142">     SUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l19.143"></a><span id="l19.143">     UNSUBSCRIBE : [&quot;mailbox&quot;],</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineat">@@ -867,40 +878,52 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.145"></a><span id="l19.145">     UID : [&quot;atom&quot;, &quot;...&quot;]</span>
<a href="#l19.146"></a><span id="l19.146">   },</span>
<a href="#l19.147"></a><span id="l19.147"> </span>
<a href="#l19.148"></a><span id="l19.148">   //////////////////////////</span>
<a href="#l19.149"></a><span id="l19.149">   //  PROTOCOL COMMANDS   //</span>
<a href="#l19.150"></a><span id="l19.150">   // (ordered as in spec) //</span>
<a href="#l19.151"></a><span id="l19.151">   //////////////////////////</span>
<a href="#l19.152"></a><span id="l19.152">   CAPABILITY : function (args) {</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineminus">-    return &quot;* CAPABILITY IMAP4rev1 &quot; + this._capabilities.join(&quot; &quot;) + &quot;\0&quot; +</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineminus">-           &quot;OK CAPABILITY completed&quot;;</span>
<a href="#l19.155"></a><span id="l19.155" class="difflineplus">+    var capa = &quot;* CAPABILITY IMAP4rev1 &quot; + this.kCapabilities.join(&quot; &quot;);</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineplus">+    if (this.kAuthSchemes.length &gt; 0)</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+      capa += &quot; AUTH=&quot; + this.kAuthSchemes.join(&quot; AUTH=&quot;);</span>
<a href="#l19.158"></a><span id="l19.158" class="difflineplus">+    capa += &quot;\0&quot; + &quot;OK CAPABILITY completed&quot;;</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineplus">+    return capa;</span>
<a href="#l19.160"></a><span id="l19.160">   },</span>
<a href="#l19.161"></a><span id="l19.161" class="difflineminus">-  _capabilities : [/*&quot;LOGINDISABLED&quot;, &quot;STARTTLS&quot;,*/ &quot;AUTH=PLAIN&quot;],</span>
<a href="#l19.162"></a><span id="l19.162">   LOGOUT : function (args) {</span>
<a href="#l19.163"></a><span id="l19.163">     this.closing = true;</span>
<a href="#l19.164"></a><span id="l19.164">     if (this._selectedMailbox)</span>
<a href="#l19.165"></a><span id="l19.165">       this._daemon.synchronize(this._selectedMailbox, !this._readOnly);</span>
<a href="#l19.166"></a><span id="l19.166">     return &quot;* BYE IMAP4rev1 Logging out\0OK LOGOUT completed&quot;;</span>
<a href="#l19.167"></a><span id="l19.167">   },</span>
<a href="#l19.168"></a><span id="l19.168">   NOOP : function (args) {</span>
<a href="#l19.169"></a><span id="l19.169">     return &quot;OK NOOP completed&quot;;</span>
<a href="#l19.170"></a><span id="l19.170">   },</span>
<a href="#l19.171"></a><span id="l19.171">   STARTTLS : function (args) {</span>
<a href="#l19.172"></a><span id="l19.172">     return &quot;BAD maild doesn't support TLS ATM&quot;;</span>
<a href="#l19.173"></a><span id="l19.173">   },</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineplus">+  _nextAuthFunction : undefined,</span>
<a href="#l19.175"></a><span id="l19.175">   AUTHENTICATE : function (args) {</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineminus">-    // TODO: check the args</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineminus">-    this._authenticating = args;</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-    this._multiline = true;</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineminus">-    return &quot;+&quot;;</span>
<a href="#l19.180"></a><span id="l19.180" class="difflineplus">+    var scheme = args[0]; // already uppercased by type &quot;atom&quot;</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineplus">+    // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l19.183"></a><span id="l19.183" class="difflineplus">+      return &quot;-ERR AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineplus">+</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+    var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineplus">+    if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+      return &quot;BAD I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+    dump(&quot;Starting AUTH &quot; + scheme + &quot;\n&quot;);</span>
<a href="#l19.189"></a><span id="l19.189" class="difflineplus">+    return func.call(this, args[1]);</span>
<a href="#l19.190"></a><span id="l19.190">   },</span>
<a href="#l19.191"></a><span id="l19.191">   LOGIN : function (args) {</span>
<a href="#l19.192"></a><span id="l19.192" class="difflineminus">-    if (args == &quot;\&quot;user\&quot; \&quot;password\&quot;&quot;) {</span>
<a href="#l19.193"></a><span id="l19.193" class="difflineplus">+    if (this.kCapabilities.some(function(c) { return c == &quot;LOGINDISABLED&quot;; } ))</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineplus">+      return &quot;BAD old-style LOGIN is disabled, use AUTHENTICATE&quot;;</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+    if (args[0] == this.kUsername &amp;&amp;</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineplus">+        args[1] == this.kPassword) {</span>
<a href="#l19.197"></a><span id="l19.197">       this._state = IMAP_STATE_AUTHED;</span>
<a href="#l19.198"></a><span id="l19.198">       return &quot;OK authenticated&quot;;</span>
<a href="#l19.199"></a><span id="l19.199">     }</span>
<a href="#l19.200"></a><span id="l19.200">     else</span>
<a href="#l19.201"></a><span id="l19.201">       return &quot;BAD invalid password, I won't authenticate you&quot;;</span>
<a href="#l19.202"></a><span id="l19.202">   },</span>
<a href="#l19.203"></a><span id="l19.203"> </span>
<a href="#l19.204"></a><span id="l19.204">   SELECT : function (args) {</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineat">@@ -1239,24 +1262,24 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.206"></a><span id="l19.206">   UID : function (args) {</span>
<a href="#l19.207"></a><span id="l19.207">     var name = args.shift();</span>
<a href="#l19.208"></a><span id="l19.208">     if ([&quot;FETCH&quot;, &quot;STORE&quot;, &quot;SEARCH&quot;, &quot;COPY&quot;].indexOf(name) == -1)</span>
<a href="#l19.209"></a><span id="l19.209">       return &quot;BAD illegal command &quot; + name;</span>
<a href="#l19.210"></a><span id="l19.210">     args = this._treatArgs(args, name);</span>
<a href="#l19.211"></a><span id="l19.211">     return this[name](args, true);</span>
<a href="#l19.212"></a><span id="l19.212">   },</span>
<a href="#l19.213"></a><span id="l19.213"> </span>
<a href="#l19.214"></a><span id="l19.214" class="difflineminus">-  postCommand : function (obj) {</span>
<a href="#l19.215"></a><span id="l19.215" class="difflineplus">+  postCommand : function (reader) {</span>
<a href="#l19.216"></a><span id="l19.216">     if (this.closing)</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-      obj.closeSocket();</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+      reader.closeSocket();</span>
<a href="#l19.219"></a><span id="l19.219">     if (this.sendingLiteral)</span>
<a href="#l19.220"></a><span id="l19.220" class="difflineminus">-      obj.preventLFMunge();</span>
<a href="#l19.221"></a><span id="l19.221" class="difflineminus">-    obj.setMultiline(this._multiline);</span>
<a href="#l19.222"></a><span id="l19.222" class="difflineminus">-    if (this._lastCommand == obj.watchWord)</span>
<a href="#l19.223"></a><span id="l19.223" class="difflineminus">-      obj.stopTest();</span>
<a href="#l19.224"></a><span id="l19.224" class="difflineplus">+      reader.preventLFMunge();</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineplus">+    reader.setMultiline(this._multiline);</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineplus">+    if (this._lastCommand == reader.watchWord)</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+      reader.stopTest();</span>
<a href="#l19.228"></a><span id="l19.228">   },</span>
<a href="#l19.229"></a><span id="l19.229">   onServerFault : function () {</span>
<a href="#l19.230"></a><span id="l19.230">     return (&quot;_tag&quot; in this ? this._tag : '*') + ' BAD Internal server fault.';</span>
<a href="#l19.231"></a><span id="l19.231">   },</span>
<a href="#l19.232"></a><span id="l19.232"> </span>
<a href="#l19.233"></a><span id="l19.233">   ////////////////////////////////////</span>
<a href="#l19.234"></a><span id="l19.234">   // FETCH sub commands and helpers //</span>
<a href="#l19.235"></a><span id="l19.235">   ////////////////////////////////////</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineat">@@ -1504,22 +1527,22 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l19.237"></a><span id="l19.237"> // prototype pair!). This object is &quot;mixed&quot; into the handler via the helper   //</span>
<a href="#l19.238"></a><span id="l19.238"> // function mixinExtension, which applies appropriate magic to make the       //</span>
<a href="#l19.239"></a><span id="l19.239"> // handler compliant to the extension. Functions are added untransformed, but //</span>
<a href="#l19.240"></a><span id="l19.240"> // both arrays and objects are handled by appending the values onto the       //</span>
<a href="#l19.241"></a><span id="l19.241"> // original state of the handler. Semantics apply as for the base itself.     //</span>
<a href="#l19.242"></a><span id="l19.242"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l19.243"></a><span id="l19.243"> </span>
<a href="#l19.244"></a><span id="l19.244"> var configurations = {</span>
<a href="#l19.245"></a><span id="l19.245" class="difflineminus">-  Cyrus: [&quot;RFC2342&quot;],</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-  UW: [&quot;RFC2342&quot;],</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineminus">-  Dovecot: [],</span>
<a href="#l19.248"></a><span id="l19.248" class="difflineminus">-  Zimbra: [&quot;RFC2342&quot;],</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-  Exchange: [&quot;RFC2342&quot;],</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-  LEMONADE: [&quot;RFC2342&quot;]</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+  Cyrus: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+  UW: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l19.253"></a><span id="l19.253" class="difflineplus">+  Dovecot: [&quot;RFC2195&quot;],</span>
<a href="#l19.254"></a><span id="l19.254" class="difflineplus">+  Zimbra: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l19.255"></a><span id="l19.255" class="difflineplus">+  Exchange: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l19.256"></a><span id="l19.256" class="difflineplus">+  LEMONADE: [&quot;RFC2342&quot;, &quot;RFC2195&quot;],</span>
<a href="#l19.257"></a><span id="l19.257"> };</span>
<a href="#l19.258"></a><span id="l19.258"> </span>
<a href="#l19.259"></a><span id="l19.259"> function mixinExtension(handler, extension) {</span>
<a href="#l19.260"></a><span id="l19.260">   if (extension.preload)</span>
<a href="#l19.261"></a><span id="l19.261">     extension.preload(handler);</span>
<a href="#l19.262"></a><span id="l19.262"> </span>
<a href="#l19.263"></a><span id="l19.263">   for (var property in extension) {</span>
<a href="#l19.264"></a><span id="l19.264">     if (property == 'preload')</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineat">@@ -1563,17 +1586,17 @@ var IMAP_RFC2342_extension = {</span>
<a href="#l19.266"></a><span id="l19.266">         response += &quot;\&quot; \&quot;&quot;;</span>
<a href="#l19.267"></a><span id="l19.267">         response += namespace.delimiter;</span>
<a href="#l19.268"></a><span id="l19.268">         response += &quot;\&quot;)&quot;;</span>
<a href="#l19.269"></a><span id="l19.269">       }</span>
<a href="#l19.270"></a><span id="l19.270">       response += &quot;)&quot;;</span>
<a href="#l19.271"></a><span id="l19.271">     }</span>
<a href="#l19.272"></a><span id="l19.272">     return response;</span>
<a href="#l19.273"></a><span id="l19.273">   },</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-  _capabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+  kCapabilities : [&quot;NAMESPACE&quot;],</span>
<a href="#l19.276"></a><span id="l19.276">   _argFormat : { NAMESPACE : [] },</span>
<a href="#l19.277"></a><span id="l19.277">   // Enabled in AUTHED and SELECTED states</span>
<a href="#l19.278"></a><span id="l19.278">   _enabledCommands : { 1 : [&quot;NAMESPACE&quot;], 2 : [&quot;NAMESPACE&quot;] }</span>
<a href="#l19.279"></a><span id="l19.279"> };</span>
<a href="#l19.280"></a><span id="l19.280"> </span>
<a href="#l19.281"></a><span id="l19.281"> // RFC 4315: UIDPLUS</span>
<a href="#l19.282"></a><span id="l19.282"> var IMAP_RFC4315_extension = {</span>
<a href="#l19.283"></a><span id="l19.283">   preload: function (toBeThis) {</span>
<a href="#l19.284"></a><span id="l19.284" class="difflineat">@@ -1601,10 +1624,101 @@ var IMAP_RFC4315_extension = {</span>
<a href="#l19.285"></a><span id="l19.285">     let response = this._preRFC4315COPY(args);</span>
<a href="#l19.286"></a><span id="l19.286">     if (response.indexOf(&quot;OK&quot;) == 0) {</span>
<a href="#l19.287"></a><span id="l19.287">       let last = mailbox.uidnext - 1;</span>
<a href="#l19.288"></a><span id="l19.288">       response = &quot;OK [COPYUID &quot; + first + &quot;:&quot; + last + &quot;]&quot; +</span>
<a href="#l19.289"></a><span id="l19.289">                   response.substring(2);</span>
<a href="#l19.290"></a><span id="l19.290">     }</span>
<a href="#l19.291"></a><span id="l19.291">     return response;</span>
<a href="#l19.292"></a><span id="l19.292">   },</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineminus">-  _capabilities: [&quot;UIDPLUS&quot;]</span>
<a href="#l19.294"></a><span id="l19.294" class="difflineplus">+  kCapabilities: [&quot;UIDPLUS&quot;]</span>
<a href="#l19.295"></a><span id="l19.295"> };</span>
<a href="#l19.296"></a><span id="l19.296" class="difflineplus">+</span>
<a href="#l19.297"></a><span id="l19.297" class="difflineplus">+</span>
<a href="#l19.298"></a><span id="l19.298" class="difflineplus">+/**</span>
<a href="#l19.299"></a><span id="l19.299" class="difflineplus">+ * This implements AUTH schemes. Could be moved into RFC3501 actually.</span>
<a href="#l19.300"></a><span id="l19.300" class="difflineplus">+ * The test can en-/disable auth schemes by modifying kAuthSchemes.</span>
<a href="#l19.301"></a><span id="l19.301" class="difflineplus">+ */</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineplus">+var IMAP_RFC2195_extension = {</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+  kAuthSchemes : [ &quot;CRAM-MD5&quot; , &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l19.304"></a><span id="l19.304" class="difflineplus">+</span>
<a href="#l19.305"></a><span id="l19.305" class="difflineplus">+  preload: function (handler) {</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineplus">+    handler._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineplus">+    handler._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l19.308"></a><span id="l19.308" class="difflineplus">+    handler._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l19.309"></a><span id="l19.309" class="difflineplus">+  },</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineplus">+</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+  authPLAINStart : function (lineRest)</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+  {</span>
<a href="#l19.313"></a><span id="l19.313" class="difflineplus">+    this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l19.314"></a><span id="l19.314" class="difflineplus">+    this._multiline = true;</span>
<a href="#l19.315"></a><span id="l19.315" class="difflineplus">+</span>
<a href="#l19.316"></a><span id="l19.316" class="difflineplus">+    return &quot;+&quot;;</span>
<a href="#l19.317"></a><span id="l19.317" class="difflineplus">+  },</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineplus">+  authPLAINCred : function (line)</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineplus">+  {</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineplus">+        req.password == this.kPassword) {</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+      this._state = IMAP_STATE_AUTHED;</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+      return &quot;OK Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineplus">+    }</span>
<a href="#l19.326"></a><span id="l19.326" class="difflineplus">+    else {</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineplus">+      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineplus">+    }</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineplus">+  },</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+  authCRAMStart : function (lineRest)</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineplus">+  {</span>
<a href="#l19.333"></a><span id="l19.333" class="difflineplus">+    this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l19.334"></a><span id="l19.334" class="difflineplus">+    this._multiline = true;</span>
<a href="#l19.335"></a><span id="l19.335" class="difflineplus">+</span>
<a href="#l19.336"></a><span id="l19.336" class="difflineplus">+    this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineplus">+    return &quot;+ &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+  },</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineplus">+  authCRAMDigest : function (line)</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+  {</span>
<a href="#l19.341"></a><span id="l19.341" class="difflineplus">+    var req = AuthCRAM.decodeLine(line);</span>
<a href="#l19.342"></a><span id="l19.342" class="difflineplus">+    var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l19.343"></a><span id="l19.343" class="difflineplus">+        this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineplus">+        req.digest == expectedDigest) {</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+      this._state = IMAP_STATE_AUTHED;</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+      return &quot;OK Hello friend!&quot;;</span>
<a href="#l19.348"></a><span id="l19.348" class="difflineplus">+    }</span>
<a href="#l19.349"></a><span id="l19.349" class="difflineplus">+    else {</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineplus">+      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineplus">+    }</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineplus">+  },</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineplus">+</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+  authLOGINStart : function (lineRest)</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+  {</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+    this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+    this._multiline = true;</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+    return &quot;+ &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l19.360"></a><span id="l19.360" class="difflineplus">+  },</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineplus">+  authLOGINUsername : function (line)</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineplus">+  {</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineplus">+    if (req == this.kUsername)</span>
<a href="#l19.365"></a><span id="l19.365" class="difflineplus">+      this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l19.366"></a><span id="l19.366" class="difflineplus">+    else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineplus">+      this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineplus">+    this._multiline = true;</span>
<a href="#l19.369"></a><span id="l19.369" class="difflineplus">+    return &quot;+ &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineplus">+  },</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineplus">+  authLOGINBadUsername : function (line)</span>
<a href="#l19.372"></a><span id="l19.372" class="difflineplus">+  {</span>
<a href="#l19.373"></a><span id="l19.373" class="difflineplus">+    return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineplus">+  },</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+  authLOGINPassword : function (line)</span>
<a href="#l19.376"></a><span id="l19.376" class="difflineplus">+  {</span>
<a href="#l19.377"></a><span id="l19.377" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l19.378"></a><span id="l19.378" class="difflineplus">+    if (req == this.kPassword) {</span>
<a href="#l19.379"></a><span id="l19.379" class="difflineplus">+      this._state = IMAP_STATE_AUTHED;</span>
<a href="#l19.380"></a><span id="l19.380" class="difflineplus">+      return &quot;OK Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l19.381"></a><span id="l19.381" class="difflineplus">+    }</span>
<a href="#l19.382"></a><span id="l19.382" class="difflineplus">+    else {</span>
<a href="#l19.383"></a><span id="l19.383" class="difflineplus">+      return &quot;BAD Wrong username or password, crook!&quot;;</span>
<a href="#l19.384"></a><span id="l19.384" class="difflineplus">+    }</span>
<a href="#l19.385"></a><span id="l19.385" class="difflineplus">+  },</span>
<a href="#l19.386"></a><span id="l19.386" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/test/fakeserver/maild.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/test/fakeserver/maild.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -165,18 +165,18 @@ nsMailServer.prototype = {</span>
<a href="#l20.4"></a><span id="l20.4">     if (this._debug != fsDebugNone)</span>
<a href="#l20.5"></a><span id="l20.5">       print(&quot;Connection Lost &quot; + status);</span>
<a href="#l20.6"></a><span id="l20.6"> </span>
<a href="#l20.7"></a><span id="l20.7">     this._socketClosed = true;</span>
<a href="#l20.8"></a><span id="l20.8">   },</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10">   setDebugLevel : function (debug) {</span>
<a href="#l20.11"></a><span id="l20.11">     this._debug = debug;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    if (this._reader)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-      this._reader.setDebugLevel(debug);</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+    for (var i = 0; i &lt; this._readers.length; i++)</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+      this._readers[i].setDebugLevel(debug);</span>
<a href="#l20.16"></a><span id="l20.16">   },</span>
<a href="#l20.17"></a><span id="l20.17"> </span>
<a href="#l20.18"></a><span id="l20.18">   start : function (port) {</span>
<a href="#l20.19"></a><span id="l20.19">     if (this._socket)</span>
<a href="#l20.20"></a><span id="l20.20">       throw Cr.NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l20.21"></a><span id="l20.21"> </span>
<a href="#l20.22"></a><span id="l20.22">     this._port = port;</span>
<a href="#l20.23"></a><span id="l20.23">     this._socketClosed = false;</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineat">@@ -271,16 +271,17 @@ nsMailServer.prototype = {</span>
<a href="#l20.25"></a><span id="l20.25">   /**</span>
<a href="#l20.26"></a><span id="l20.26">    * Prepares for the next test.</span>
<a href="#l20.27"></a><span id="l20.27">    */</span>
<a href="#l20.28"></a><span id="l20.28">   resetTest : function() {</span>
<a href="#l20.29"></a><span id="l20.29">     this._readers = this._readers.filter(function (reader) {</span>
<a href="#l20.30"></a><span id="l20.30">       return reader._isRunning;</span>
<a href="#l20.31"></a><span id="l20.31">     });</span>
<a href="#l20.32"></a><span id="l20.32">     this._test = true;</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+    this._handler.resetTest();</span>
<a href="#l20.34"></a><span id="l20.34">   }</span>
<a href="#l20.35"></a><span id="l20.35"> };</span>
<a href="#l20.36"></a><span id="l20.36"> </span>
<a href="#l20.37"></a><span id="l20.37"> function readTo(input, count, arr) {</span>
<a href="#l20.38"></a><span id="l20.38">   var old = new BinaryInputStream(input).readByteArray(count);</span>
<a href="#l20.39"></a><span id="l20.39">   Array.prototype.push.apply(arr, old);</span>
<a href="#l20.40"></a><span id="l20.40"> }</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42" class="difflineat">@@ -288,22 +289,21 @@ function readTo(input, count, arr) {</span>
<a href="#l20.43"></a><span id="l20.43">  * The nsMailReader service, which reads and handles the lines.</span>
<a href="#l20.44"></a><span id="l20.44">  * All specific handling is passed off to the handler, which is responsible</span>
<a href="#l20.45"></a><span id="l20.45">  * for maintaining its own state. The following commands are required for the</span>
<a href="#l20.46"></a><span id="l20.46">  * handler object:</span>
<a href="#l20.47"></a><span id="l20.47">  * onError       Called when handler[command] does not exist with both the</span>
<a href="#l20.48"></a><span id="l20.48">  *               command and rest-of-line as arguments</span>
<a href="#l20.49"></a><span id="l20.49">  * onStartup     Called on initialization with no arguments</span>
<a href="#l20.50"></a><span id="l20.50">  * onMultiline   Called when in multiline with the entire line as an argument</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineminus">- * onPassword    Called when a password line is expected as the entire argument</span>
<a href="#l20.52"></a><span id="l20.52">  * postCommand   Called after every command with this reader as the argument</span>
<a href="#l20.53"></a><span id="l20.53">  * [command]     An untranslated command with the rest of the line as the</span>
<a href="#l20.54"></a><span id="l20.54">  *               argument. Defined as everything to the first space</span>
<a href="#l20.55"></a><span id="l20.55">  *</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">- * All functions, except onMultiline, onPassword and postCommand, treat the</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+ * All functions, except onMultiline and postCommand, treat the</span>
<a href="#l20.58"></a><span id="l20.58">  * returned value as the text to be sent to the client; a newline at the end</span>
<a href="#l20.59"></a><span id="l20.59">  * may be added if it does not exist, and all lone newlines are converted to</span>
<a href="#l20.60"></a><span id="l20.60">  * CRLF sequences.</span>
<a href="#l20.61"></a><span id="l20.61">  *</span>
<a href="#l20.62"></a><span id="l20.62">  * The return of postCommand is ignored. The return of onMultiline is a bit</span>
<a href="#l20.63"></a><span id="l20.63">  * complicated: it may or may not return a response string (returning one is</span>
<a href="#l20.64"></a><span id="l20.64">  * necessary to trigger the postCommand handler).</span>
<a href="#l20.65"></a><span id="l20.65">  *</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineat">@@ -391,58 +391,52 @@ nsMailReader.prototype = {</span>
<a href="#l20.67"></a><span id="l20.67">       return;</span>
<a href="#l20.68"></a><span id="l20.68">     }</span>
<a href="#l20.69"></a><span id="l20.69">     readTo(stream, bytes, this._buffer);</span>
<a href="#l20.70"></a><span id="l20.70">     this._findLines();</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72">     while (this._lines.length &gt; 0) {</span>
<a href="#l20.73"></a><span id="l20.73">       var line = this._lines.shift();</span>
<a href="#l20.74"></a><span id="l20.74"> </span>
<a href="#l20.75"></a><span id="l20.75" class="difflineminus">-      if (this._debug == fsDebugAll)</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+      if (this._debug != fsDebugNone)</span>
<a href="#l20.77"></a><span id="l20.77">         print(&quot;RECV: &quot; + line);</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79">       var response;</span>
<a href="#l20.80"></a><span id="l20.80">       try {</span>
<a href="#l20.81"></a><span id="l20.81">         if (this._multiline) {</span>
<a href="#l20.82"></a><span id="l20.82">           response = this._handler.onMultiline(line);</span>
<a href="#l20.83"></a><span id="l20.83"> </span>
<a href="#l20.84"></a><span id="l20.84">           if (response === undefined)</span>
<a href="#l20.85"></a><span id="l20.85">             continue;</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-        } else if (this._expectPassword) {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-          dump(&quot;expecting password\n&quot;);</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineminus">-          response = this._handler.onPassword(line);</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineminus">-</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineminus">-          if (response == undefined)</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-            continue;</span>
<a href="#l20.92"></a><span id="l20.92">         } else {</span>
<a href="#l20.93"></a><span id="l20.93">           // Record the transaction</span>
<a href="#l20.94"></a><span id="l20.94">           if (this.transaction)</span>
<a href="#l20.95"></a><span id="l20.95">             this.transaction.them.push(line);</span>
<a href="#l20.96"></a><span id="l20.96"> </span>
<a href="#l20.97"></a><span id="l20.97">           // Find the command and splice it out...</span>
<a href="#l20.98"></a><span id="l20.98">           var splitter = line.indexOf(&quot; &quot;);</span>
<a href="#l20.99"></a><span id="l20.99">           var command = splitter == -1 ? line : line.substring(0,splitter);</span>
<a href="#l20.100"></a><span id="l20.100">           var args = splitter == -1 ? &quot;&quot; : line.substring(splitter+1);</span>
<a href="#l20.101"></a><span id="l20.101"> </span>
<a href="#l20.102"></a><span id="l20.102">           // By convention, commands are uppercase</span>
<a href="#l20.103"></a><span id="l20.103">           command = command.toUpperCase();</span>
<a href="#l20.104"></a><span id="l20.104"> </span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-          if (this._debug == fsDebugRecv || this._debug == fsDebugRecvSend)</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-            print(&quot;RECV: &quot; + command);</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+          if (this._debug == fsDebugAll)</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+            print(&quot;Received command &quot; + command);</span>
<a href="#l20.109"></a><span id="l20.109"> </span>
<a href="#l20.110"></a><span id="l20.110">           if (command in this._handler)</span>
<a href="#l20.111"></a><span id="l20.111">             response = this._handler[command](args);</span>
<a href="#l20.112"></a><span id="l20.112">           else</span>
<a href="#l20.113"></a><span id="l20.113">             response = this._handler.onError(command, args);</span>
<a href="#l20.114"></a><span id="l20.114">         }</span>
<a href="#l20.115"></a><span id="l20.115"> </span>
<a href="#l20.116"></a><span id="l20.116">         this._preventLFMunge = false;</span>
<a href="#l20.117"></a><span id="l20.117">         this._handler.postCommand(this);</span>
<a href="#l20.118"></a><span id="l20.118">       } catch (e) {</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-        response = this._handler.onServerFault();</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+        response = this._handler.onServerFault(e);</span>
<a href="#l20.121"></a><span id="l20.121">         if (e instanceof Error) {</span>
<a href="#l20.122"></a><span id="l20.122">           dump(e.name + &quot;: &quot; + e.message + '\n');</span>
<a href="#l20.123"></a><span id="l20.123">           dump(&quot;File: &quot; + e.fileName + &quot; Line: &quot; + e.lineNumber + '\n');</span>
<a href="#l20.124"></a><span id="l20.124">           dump('Stack trace:\n' + e.stack);</span>
<a href="#l20.125"></a><span id="l20.125">         } else {</span>
<a href="#l20.126"></a><span id="l20.126">           dump(&quot;Exception caught: &quot; + e + '\n');</span>
<a href="#l20.127"></a><span id="l20.127">         }</span>
<a href="#l20.128"></a><span id="l20.128">       }</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineat">@@ -486,20 +480,16 @@ nsMailReader.prototype = {</span>
<a href="#l20.130"></a><span id="l20.130">     this._transport.close(Cr.NS_OK);</span>
<a href="#l20.131"></a><span id="l20.131">     this._server.stopTest();</span>
<a href="#l20.132"></a><span id="l20.132">   },</span>
<a href="#l20.133"></a><span id="l20.133"> </span>
<a href="#l20.134"></a><span id="l20.134">   setMultiline : function (multi) {</span>
<a href="#l20.135"></a><span id="l20.135">     this._multiline = multi;</span>
<a href="#l20.136"></a><span id="l20.136">   },</span>
<a href="#l20.137"></a><span id="l20.137"> </span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-  setExpectPassword : function (expectPassword) {</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-    this._expectPassword = expectPassword;</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-  },</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-</span>
<a href="#l20.142"></a><span id="l20.142">   setDebugLevel : function (debug) {</span>
<a href="#l20.143"></a><span id="l20.143">     this._debug = debug;</span>
<a href="#l20.144"></a><span id="l20.144">   },</span>
<a href="#l20.145"></a><span id="l20.145"> </span>
<a href="#l20.146"></a><span id="l20.146">   preventLFMunge : function () {</span>
<a href="#l20.147"></a><span id="l20.147">     this._preventLFMunge = true;</span>
<a href="#l20.148"></a><span id="l20.148">   },</span>
<a href="#l20.149"></a><span id="l20.149"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/test/fakeserver/nntpd.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -134,21 +134,24 @@ function hasFlag(flags, flag) {</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> // This handler implements the bare minimum required by RFC 977. Actually, not</span>
<a href="#l21.7"></a><span id="l21.7"> // even that much: IHAVE and SLAVE are not implemented, as those two are</span>
<a href="#l21.8"></a><span id="l21.8"> // explicitly server implementations.</span>
<a href="#l21.9"></a><span id="l21.9"> function NNTP_RFC977_handler(daemon) {</span>
<a href="#l21.10"></a><span id="l21.10">   this._daemon = daemon;</span>
<a href="#l21.11"></a><span id="l21.11">   this.closing = false;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-  this.group = null;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-  this.articleKey = null;</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-  this.extraCommands = &quot;&quot;;</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+  this.resetTest();</span>
<a href="#l21.16"></a><span id="l21.16"> }</span>
<a href="#l21.17"></a><span id="l21.17"> NNTP_RFC977_handler.prototype = {</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+  resetTest : function() {</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+    this.extraCommands = &quot;&quot;;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+    this.articleKey = null;</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+    this.group = null;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+  },</span>
<a href="#l21.23"></a><span id="l21.23">   ARTICLE : function (args) {</span>
<a href="#l21.24"></a><span id="l21.24">      var info = this._selectArticle(args, 220);</span>
<a href="#l21.25"></a><span id="l21.25">      if (info[0] == null)</span>
<a href="#l21.26"></a><span id="l21.26">        return info[1];</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">      var response = info[1]+'\n';</span>
<a href="#l21.29"></a><span id="l21.29">      response += info[0].fullText.replace(&quot;(?=\n).&quot;, &quot;..&quot;);</span>
<a href="#l21.30"></a><span id="l21.30">      response += &quot;.&quot;;</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineat">@@ -264,16 +267,19 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l21.32"></a><span id="l21.32">     response += &quot;.\n&quot;;</span>
<a href="#l21.33"></a><span id="l21.33">     return response;</span>
<a href="#l21.34"></a><span id="l21.34">   },</span>
<a href="#l21.35"></a><span id="l21.35"> </span>
<a href="#l21.36"></a><span id="l21.36"> </span>
<a href="#l21.37"></a><span id="l21.37">   onError : function (command, args) {</span>
<a href="#l21.38"></a><span id="l21.38">     return &quot;500 command not recognized&quot;;</span>
<a href="#l21.39"></a><span id="l21.39">   },</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+  onServerFault: function (e) {</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+    return &quot;500 internal server error: &quot; + e;</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+  },</span>
<a href="#l21.43"></a><span id="l21.43">   onStartup : function () {</span>
<a href="#l21.44"></a><span id="l21.44">     this.closing = false;</span>
<a href="#l21.45"></a><span id="l21.45">     this.group = null;</span>
<a href="#l21.46"></a><span id="l21.46">     this.article = null;</span>
<a href="#l21.47"></a><span id="l21.47">     this.posting = false;</span>
<a href="#l21.48"></a><span id="l21.48">     return &quot;200 posting allowed&quot;;</span>
<a href="#l21.49"></a><span id="l21.49">   },</span>
<a href="#l21.50"></a><span id="l21.50">   onMultiline : function (line) {</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineat">@@ -290,20 +296,20 @@ NNTP_RFC977_handler.prototype = {</span>
<a href="#l21.52"></a><span id="l21.52">       if (line.charAt(0) == '.')</span>
<a href="#l21.53"></a><span id="l21.53">         line = line.substring(1);</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">       this.post += line+'\n';</span>
<a href="#l21.56"></a><span id="l21.56">     }</span>
<a href="#l21.57"></a><span id="l21.57"> </span>
<a href="#l21.58"></a><span id="l21.58">     return undefined;</span>
<a href="#l21.59"></a><span id="l21.59">   },</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-  postCommand : function (obj) {</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+  postCommand : function (reader) {</span>
<a href="#l21.62"></a><span id="l21.62">     if (this.closing)</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineminus">-      obj.closeSocket();</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-    obj.setMultiline(this.posting);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+      reader.closeSocket();</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+    reader.setMultiline(this.posting);</span>
<a href="#l21.67"></a><span id="l21.67">   },</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   /**</span>
<a href="#l21.70"></a><span id="l21.70">    * Selects an article based on args.</span>
<a href="#l21.71"></a><span id="l21.71">    *</span>
<a href="#l21.72"></a><span id="l21.72">    * Returns an array of objects consisting of:</span>
<a href="#l21.73"></a><span id="l21.73">    * # The selected article (or null if non was selected</span>
<a href="#l21.74"></a><span id="l21.74">    * # The first line response</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/test/fakeserver/pop3d.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/test/fakeserver/pop3d.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,10 +1,15 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-// This file implements test POP3 servers</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+/**</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ * Contributors:</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+ *   Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt; (RFC 5034 Authentication)</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+ */</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+/* This file implements test POP3 servers</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+ */</span>
<a href="#l22.12"></a><span id="l22.12"> </span>
<a href="#l22.13"></a><span id="l22.13"> function readFile(fileName) {</span>
<a href="#l22.14"></a><span id="l22.14">   var file = do_get_file(&quot;data/&quot; + fileName, true); // allow nonexistent</span>
<a href="#l22.15"></a><span id="l22.15">   // also allow files from general locations</span>
<a href="#l22.16"></a><span id="l22.16">   if (!file || !file.exists())</span>
<a href="#l22.17"></a><span id="l22.17">     file = do_get_file(fileName);</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19">   // If these fail, there is a problem with the test</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineat">@@ -75,51 +80,57 @@ pop3Daemon.prototype = {</span>
<a href="#l22.21"></a><span id="l22.21"> };</span>
<a href="#l22.22"></a><span id="l22.22"> </span>
<a href="#l22.23"></a><span id="l22.23"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.24"></a><span id="l22.24"> //                              POP3 TEST SERVERS                            //</span>
<a href="#l22.25"></a><span id="l22.25"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.26"></a><span id="l22.26"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28"> </span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-const kStateAuthAwaitingUser = 1;</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-const kStateAuthAwaitingPassword = 2;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-const kStateTransaction = 3;</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+const kStateAuthNeeded = 1; // Not authenticated yet, need username and password</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+const kStateAuthPASS = 2; // got command USER, expecting command PASS</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+const kStateTransaction = 3; // Authenticated, can fetch and delete mail</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-// This handler implements the bare minimum required by RFC 1939.</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+/**</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+ * This handler implements the bare minimum required by RFC 1939.</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+ */</span>
<a href="#l22.40"></a><span id="l22.40"> function POP3_RFC1939_handler(daemon) {</span>
<a href="#l22.41"></a><span id="l22.41">   this._daemon = daemon;</span>
<a href="#l22.42"></a><span id="l22.42">   this.closing = false;</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+  this.resetTest();</span>
<a href="#l22.44"></a><span id="l22.44"> }</span>
<a href="#l22.45"></a><span id="l22.45"> POP3_RFC1939_handler.prototype = {</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-  expectedUsername: &quot;fake&quot;,</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-  expectedPassword: &quot;server&quot;,</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-  _state: kStateAuthAwaitingUser,</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+  kUsername: &quot;fred&quot;,</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+  kPassword: &quot;wilma&quot;,</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+  resetTest : function() {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+    this._state = kStateAuthNeeded;</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+  },</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   USER: function (args) {</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-    if (this._state != kStateAuthAwaitingUser)</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+    if (this._state != kStateAuthNeeded)</span>
<a href="#l22.59"></a><span id="l22.59">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-    if (args == this.expectedUsername) {</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-      this._state = kStateAuthAwaitingPassword;</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+    if (args == this.kUsername) {</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+      this._state = kStateAuthPASS;</span>
<a href="#l22.65"></a><span id="l22.65">       return &quot;+OK user recognized&quot;;</span>
<a href="#l22.66"></a><span id="l22.66">     }</span>
<a href="#l22.67"></a><span id="l22.67"> </span>
<a href="#l22.68"></a><span id="l22.68">     return &quot;-ERR sorry, no such mailbox&quot;;</span>
<a href="#l22.69"></a><span id="l22.69">   },</span>
<a href="#l22.70"></a><span id="l22.70">   PASS: function (args) {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-    if (this._state != kStateAuthAwaitingPassword)</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+    if (this._state != kStateAuthPASS)</span>
<a href="#l22.73"></a><span id="l22.73">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.74"></a><span id="l22.74"> </span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-    if (args == this.expectedPassword) {</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+    if (args == this.kPassword) {</span>
<a href="#l22.77"></a><span id="l22.77">       this._state = kStateTransaction;</span>
<a href="#l22.78"></a><span id="l22.78">       return &quot;+OK maildrop locked and ready&quot;;</span>
<a href="#l22.79"></a><span id="l22.79">     }</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-    this._state = kStateAuthAwaitingUser;</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+    this._state = kStateAuthNeeded;</span>
<a href="#l22.83"></a><span id="l22.83">     return &quot;-ERR invalid password&quot;;</span>
<a href="#l22.84"></a><span id="l22.84">   },</span>
<a href="#l22.85"></a><span id="l22.85">   STAT: function (args) {</span>
<a href="#l22.86"></a><span id="l22.86">     if (this._state != kStateTransaction)</span>
<a href="#l22.87"></a><span id="l22.87">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.88"></a><span id="l22.88"> </span>
<a href="#l22.89"></a><span id="l22.89">     return &quot;+OK &quot; + this._daemon.getTotalMessages() + &quot; &quot; +</span>
<a href="#l22.90"></a><span id="l22.90">            this._daemon.getTotalMessageSize();</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineat">@@ -152,45 +163,216 @@ POP3_RFC1939_handler.prototype = {</span>
<a href="#l22.92"></a><span id="l22.92">   NOOP: function (args) {</span>
<a href="#l22.93"></a><span id="l22.93">     if (this._state != kStateTransaction)</span>
<a href="#l22.94"></a><span id="l22.94">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.95"></a><span id="l22.95">     return &quot;+OK&quot;;</span>
<a href="#l22.96"></a><span id="l22.96">   },</span>
<a href="#l22.97"></a><span id="l22.97">   RSET: function (args) {</span>
<a href="#l22.98"></a><span id="l22.98">     if (this._state != kStateTransaction)</span>
<a href="#l22.99"></a><span id="l22.99">       return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-    this._state = kStateAuthAwaitingUser;</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+    this._state = kStateAuthNeeded;</span>
<a href="#l22.102"></a><span id="l22.102">     return &quot;+OK&quot;;</span>
<a href="#l22.103"></a><span id="l22.103">   },</span>
<a href="#l22.104"></a><span id="l22.104">   QUIT: function (args) {</span>
<a href="#l22.105"></a><span id="l22.105">     // Let the client close the socket</span>
<a href="#l22.106"></a><span id="l22.106">     //this.closing = true;</span>
<a href="#l22.107"></a><span id="l22.107">     return &quot;+OK fakeserver signing off&quot;;</span>
<a href="#l22.108"></a><span id="l22.108">   },</span>
<a href="#l22.109"></a><span id="l22.109">   onStartup: function () {</span>
<a href="#l22.110"></a><span id="l22.110">     this.closing = false;</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-    this._state = kStateAuthAwaitingUser;</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+    this._state = kStateAuthNeeded;</span>
<a href="#l22.113"></a><span id="l22.113">     return &quot;+OK Fake POP3 server ready&quot;;</span>
<a href="#l22.114"></a><span id="l22.114">   },</span>
<a href="#l22.115"></a><span id="l22.115">   onError: function (command, args) {</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-    return &quot;-ERR&quot;;</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+    return &quot;-ERR command &quot; + command + &quot; not implemented&quot;;</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+  },</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+  onServerFault: function (e) {</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+    return &quot;-ERR internal server error: &quot; + e;</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+  },</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+  postCommand: function(reader) {</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+    reader.setMultiline(this._multiline);</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+    if (this.closing)</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+      reader.closeSocket();</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+  }</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+};</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+/**</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+ * This implements CAPA</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+ * @see RFC 2449</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+ *</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+ * Not yet implemented, but desired are: TOP, UIDL, ...</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+ */</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+function POP3_RFC2449_handler(daemon) {</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+  POP3_RFC1939_handler.call(this, daemon);</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+}</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+POP3_RFC2449_handler.prototype = {</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+  __proto__ : POP3_RFC1939_handler.prototype, // inherit</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+  kCapabilities: [], // the test may adapt this as necessary</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+  CAPA: function (args) {</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+    var capa = &quot;+OK List of our wanna-be capabilities follows:\r\n&quot;;</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+    for (var i = 0; i &lt; this.kCapabilities.length; i++)</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+      capa += this.kCapabilities[i] + &quot;\r\n&quot;;</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+    if (this.capaAdditions)</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+      capa += this.capaAdditions();</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+    capa += &quot;IMPLEMENTATION fakeserver\r\n&quot; + &quot;.&quot;;</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+    return capa;</span>
<a href="#l22.152"></a><span id="l22.152">   },</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineminus">-  onMultiline: function(line) {</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-    if (line == &quot;.&quot;) {</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineminus">-      if (this.expectingData) {</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineminus">-        this.expectingData = false;</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineminus">-        return &quot;250 Wonderful article, your style is gorgeous!&quot;;</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineminus">-      }</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+};</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+/**</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+ * This implements the AUTH command, i.e. authentication using CRAM-MD5 etc.</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+ * @see RFC 5034</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+ * @author Ben Bucksch &lt;ben.bucksch beonex.com&gt; &lt;http://business.beonex.com&gt;</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+ */</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+function POP3_RFC5034_handler(daemon) {</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+  POP3_RFC2449_handler.call(this, daemon);</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+  this._kAuthSchemeStartFunction = {};</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+}</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+POP3_RFC5034_handler.prototype = {</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+  __proto__ : POP3_RFC2449_handler.prototype, // inherit</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+  kAuthSchemes: [ &quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot; ], // the test may adapt this as necessary</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+  _usedCRAMMD5Challenge : null, // not base64-encoded</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+  // called by this.CAPA()</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+  capaAdditions : function() {</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+    var capa = &quot;&quot;;</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+    if (this.kAuthSchemes.length &gt; 0) {</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+      capa += &quot;SASL&quot;;</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+      for (var i = 0; i &lt; this.kAuthSchemes.length; i++)</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+        capa += &quot; &quot; + this.kAuthSchemes[i];</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+      capa += &quot;\r\n&quot;;</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+    }</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+    return capa;</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+  },</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+  AUTH: function (lineRest) {</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+    // |lineRest| is a string containing the rest of line after &quot;AUTH &quot;</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+    if (this._state != kStateAuthNeeded)</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+      return &quot;-ERR invalid state&quot;;</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+    // AUTH without arguments returns a list of supported schemes</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+    if (!lineRest) {</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+      var capa = &quot;+OK I like:\r\n&quot;;</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+      for (var i = 0; i &lt; this.kAuthSchemes.length; i++)</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+        capa += this.kAuthSchemes[i] + &quot;\r\n&quot;;</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+      capa += &quot;.\r\n&quot;;</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+      return capa;</span>
<a href="#l22.205"></a><span id="l22.205">     }</span>
<a href="#l22.206"></a><span id="l22.206"> </span>
<a href="#l22.207"></a><span id="l22.207" class="difflineminus">-    if (this.data) {</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineminus">-      if (line[0] == '.')</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineminus">-        line = line.substring(1);</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineminus">-      this.post += line+'\n';</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+    var args = lineRest.split(&quot; &quot;);</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+    var scheme = args[0].toUpperCase();</span>
<a href="#l22.213"></a><span id="l22.213" class="difflineplus">+    // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l22.214"></a><span id="l22.214" class="difflineplus">+    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineplus">+      return &quot;-ERR AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l22.216"></a><span id="l22.216" class="difflineplus">+</span>
<a href="#l22.217"></a><span id="l22.217" class="difflineplus">+    var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineplus">+    if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineplus">+      return &quot;-ERR I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+    return func.call(this, args[1]);</span>
<a href="#l22.221"></a><span id="l22.221" class="difflineplus">+  },</span>
<a href="#l22.222"></a><span id="l22.222" class="difflineplus">+</span>
<a href="#l22.223"></a><span id="l22.223" class="difflineplus">+  onMultiline: function(line) {</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineplus">+    if (this._nextAuthFunction) {</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+      var func = this._nextAuthFunction;</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineplus">+      this._multiline = false;</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineplus">+      this._nextAuthFunction = undefined;</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+      if (line == &quot;*&quot;) {</span>
<a href="#l22.229"></a><span id="l22.229" class="difflineplus">+        return &quot;-ERR Okay, as you wish. Chicken&quot;;</span>
<a href="#l22.230"></a><span id="l22.230" class="difflineplus">+      }</span>
<a href="#l22.231"></a><span id="l22.231" class="difflineplus">+      if (!func || typeof(func) != &quot;function&quot;) {</span>
<a href="#l22.232"></a><span id="l22.232" class="difflineplus">+        return &quot;-ERR I'm lost. Internal server error during auth&quot;;</span>
<a href="#l22.233"></a><span id="l22.233" class="difflineplus">+      }</span>
<a href="#l22.234"></a><span id="l22.234" class="difflineplus">+      try {</span>
<a href="#l22.235"></a><span id="l22.235" class="difflineplus">+        return func.call(this, line);</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineplus">+      } catch (e) { return &quot;-ERR &quot; + e; }</span>
<a href="#l22.237"></a><span id="l22.237">     }</span>
<a href="#l22.238"></a><span id="l22.238" class="difflineplus">+</span>
<a href="#l22.239"></a><span id="l22.239" class="difflineplus">+    if (POP3_RFC2449_handler.prototype.onMultiline)</span>
<a href="#l22.240"></a><span id="l22.240" class="difflineplus">+      return POP3_RFC2449_handler.prototype.onMultiline.call(this, line); // call parent</span>
<a href="#l22.241"></a><span id="l22.241">     return undefined;</span>
<a href="#l22.242"></a><span id="l22.242">   },</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-  postCommand: function(obj) {</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineminus">-    if (this.closing)</span>
<a href="#l22.245"></a><span id="l22.245" class="difflineminus">-      obj.closeSocket();</span>
<a href="#l22.246"></a><span id="l22.246" class="difflineminus">-    obj.setMultiline(this.expectingData);</span>
<a href="#l22.247"></a><span id="l22.247" class="difflineminus">-  }</span>
<a href="#l22.248"></a><span id="l22.248" class="difflineplus">+</span>
<a href="#l22.249"></a><span id="l22.249" class="difflineplus">+</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineplus">+  authPLAINStart : function (lineRest)</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+  {</span>
<a href="#l22.252"></a><span id="l22.252" class="difflineplus">+    this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l22.253"></a><span id="l22.253" class="difflineplus">+    this._multiline = true;</span>
<a href="#l22.254"></a><span id="l22.254" class="difflineplus">+</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineplus">+    return &quot;+&quot;;</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+  },</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineplus">+  authPLAINCred : function (line)</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineplus">+  {</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+    var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+        req.password == this.kPassword) {</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+      this._state = kStateTransaction;</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+      return &quot;+OK Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+    }</span>
<a href="#l22.265"></a><span id="l22.265" class="difflineplus">+    else {</span>
<a href="#l22.266"></a><span id="l22.266" class="difflineplus">+      return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l22.267"></a><span id="l22.267" class="difflineplus">+    }</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineplus">+  },</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineplus">+</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+  authCRAMStart : function (lineRest)</span>
<a href="#l22.271"></a><span id="l22.271" class="difflineplus">+  {</span>
<a href="#l22.272"></a><span id="l22.272" class="difflineplus">+    this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineplus">+    this._multiline = true;</span>
<a href="#l22.274"></a><span id="l22.274" class="difflineplus">+</span>
<a href="#l22.275"></a><span id="l22.275" class="difflineplus">+    this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l22.276"></a><span id="l22.276" class="difflineplus">+    return &quot;+ &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineplus">+  },</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineplus">+  authCRAMDigest : function (line)</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+  {</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+    var req = AuthCRAM.decodeLine(line);</span>
<a href="#l22.281"></a><span id="l22.281" class="difflineplus">+    var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l22.282"></a><span id="l22.282" class="difflineplus">+        this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l22.284"></a><span id="l22.284" class="difflineplus">+        req.digest == expectedDigest) {</span>
<a href="#l22.285"></a><span id="l22.285" class="difflineplus">+      this._state = kStateTransaction;</span>
<a href="#l22.286"></a><span id="l22.286" class="difflineplus">+      return &quot;+OK Hello friend!&quot;;</span>
<a href="#l22.287"></a><span id="l22.287" class="difflineplus">+    }</span>
<a href="#l22.288"></a><span id="l22.288" class="difflineplus">+    else {</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineplus">+      return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l22.290"></a><span id="l22.290" class="difflineplus">+    }</span>
<a href="#l22.291"></a><span id="l22.291" class="difflineplus">+  },</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineplus">+</span>
<a href="#l22.293"></a><span id="l22.293" class="difflineplus">+  authLOGINStart : function (lineRest)</span>
<a href="#l22.294"></a><span id="l22.294" class="difflineplus">+  {</span>
<a href="#l22.295"></a><span id="l22.295" class="difflineplus">+    this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l22.296"></a><span id="l22.296" class="difflineplus">+    this._multiline = true;</span>
<a href="#l22.297"></a><span id="l22.297" class="difflineplus">+</span>
<a href="#l22.298"></a><span id="l22.298" class="difflineplus">+    return &quot;+ &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineplus">+  },</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+  authLOGINUsername : function (line)</span>
<a href="#l22.301"></a><span id="l22.301" class="difflineplus">+  {</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l22.303"></a><span id="l22.303" class="difflineplus">+    if (req == this.kUsername)</span>
<a href="#l22.304"></a><span id="l22.304" class="difflineplus">+      this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l22.305"></a><span id="l22.305" class="difflineplus">+    else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l22.306"></a><span id="l22.306" class="difflineplus">+      this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l22.307"></a><span id="l22.307" class="difflineplus">+    this._multiline = true;</span>
<a href="#l22.308"></a><span id="l22.308" class="difflineplus">+    return &quot;+ &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineplus">+  },</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+  authLOGINBadUsername : function (line)</span>
<a href="#l22.311"></a><span id="l22.311" class="difflineplus">+  {</span>
<a href="#l22.312"></a><span id="l22.312" class="difflineplus">+    return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l22.313"></a><span id="l22.313" class="difflineplus">+  },</span>
<a href="#l22.314"></a><span id="l22.314" class="difflineplus">+  authLOGINPassword : function (line)</span>
<a href="#l22.315"></a><span id="l22.315" class="difflineplus">+  {</span>
<a href="#l22.316"></a><span id="l22.316" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l22.317"></a><span id="l22.317" class="difflineplus">+    if (req == this.kPassword) {</span>
<a href="#l22.318"></a><span id="l22.318" class="difflineplus">+      this._state = kStateTransaction;</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineplus">+      return &quot;+OK Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l22.320"></a><span id="l22.320" class="difflineplus">+    }</span>
<a href="#l22.321"></a><span id="l22.321" class="difflineplus">+    else {</span>
<a href="#l22.322"></a><span id="l22.322" class="difflineplus">+      return &quot;-ERR Wrong username or password, crook!&quot;;</span>
<a href="#l22.323"></a><span id="l22.323" class="difflineplus">+    }</span>
<a href="#l22.324"></a><span id="l22.324" class="difflineplus">+  },</span>
<a href="#l22.325"></a><span id="l22.325"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/test/fakeserver/smtpd.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -7,72 +7,95 @@ function smtpDaemon(flags) {</span>
<a href="#l23.4"></a><span id="l23.4"> smtpDaemon.prototype = {</span>
<a href="#l23.5"></a><span id="l23.5"> }</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.8"></a><span id="l23.8"> //                              SMTP TEST SERVERS                            //</span>
<a href="#l23.9"></a><span id="l23.9"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.10"></a><span id="l23.10"> ///////////////////////////////////////////////////////////////////////////////</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+const kStateAuthNeeded = 0;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+const kStateAuthOptional = 2;</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+const kStateAuthenticated = 3;</span>
<a href="#l23.15"></a><span id="l23.15"> </span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-// This handler implements the bare minimum required by RFC 2822.</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-  function SMTP_RFC2822_handler(daemon, authMechanisms, username, password) {</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+/**</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+ * This handler implements the bare minimum required by RFC 2821.</span>
<a href="#l23.20"></a><span id="l23.20" class="difflineplus">+ * @see RFC 2821</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineplus">+ */</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineplus">+function SMTP_RFC2821_handler(daemon) {</span>
<a href="#l23.23"></a><span id="l23.23">   this._daemon = daemon;</span>
<a href="#l23.24"></a><span id="l23.24">   this.closing = false;</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-  this._authMechanisms = authMechanisms ? authMechanisms : &quot;PLAIN&quot;;</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineminus">-  this._username = username ? username : &quot;testsmtp&quot;;</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineminus">-  this._password = password ? password : &quot;smtptest&quot;;</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-  // 0 = not logged in, 1 = waiting username, 2 = waiting password,</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineminus">-  // 3 = logged in</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineminus">-  this._authState = 0;</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  this._expectPassword = false;</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineplus">+  this._kAuthSchemeStartFunction = {};</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;CRAM-MD5&quot;] = this.authCRAMStart;</span>
<a href="#l23.35"></a><span id="l23.35" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;PLAIN&quot;] = this.authPLAINStart;</span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+  this._kAuthSchemeStartFunction[&quot;LOGIN&quot;] = this.authLOGINStart;</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+</span>
<a href="#l23.38"></a><span id="l23.38" class="difflineplus">+  this.resetTest();</span>
<a href="#l23.39"></a><span id="l23.39"> }</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineminus">-SMTP_RFC2822_handler.prototype = {</span>
<a href="#l23.41"></a><span id="l23.41" class="difflineminus">-  EHLO: function (args) {</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-    return &quot;250-foo.com greets bar.com\n250-8BITMIME\n250-SIZE\n250-AUTH &quot; +</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-           this._authMechanisms + &quot;\n250 HELP&quot;;</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  },</span>
<a href="#l23.45"></a><span id="l23.45" class="difflineminus">-  AUTH: function (args) {</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-    var splitArgs = args.split(&quot; &quot;);</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineminus">-    dump(args + &quot; &quot; + splitArgs[0] + &quot;\n&quot;);</span>
<a href="#l23.48"></a><span id="l23.48" class="difflineplus">+SMTP_RFC2821_handler.prototype = {</span>
<a href="#l23.49"></a><span id="l23.49" class="difflineplus">+  kAuthRequired : false,</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+  kUsername : &quot;testsmtp&quot;,</span>
<a href="#l23.51"></a><span id="l23.51" class="difflineplus">+  kPassword : &quot;smtptest&quot;,</span>
<a href="#l23.52"></a><span id="l23.52" class="difflineplus">+  kAuthSchemes : [ &quot;CRAM-MD5&quot;, &quot;PLAIN&quot;, &quot;LOGIN&quot; ],</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineplus">+  kCapabilities : [ &quot;8BITMIME&quot;, &quot;SIZE&quot; ],</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+  _nextAuthFunction : undefined,</span>
<a href="#l23.55"></a><span id="l23.55"> </span>
<a href="#l23.56"></a><span id="l23.56" class="difflineminus">-    switch (splitArgs[0]) {</span>
<a href="#l23.57"></a><span id="l23.57" class="difflineminus">-    case &quot;PLAIN&quot;: {</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-      if (splitArgs[1] != btoa(&quot;\u0000&quot; + this._username + &quot;\u0000&quot; + this._password))</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineminus">-        return &quot;535 authentication failed&quot;;</span>
<a href="#l23.60"></a><span id="l23.60" class="difflineminus">-</span>
<a href="#l23.61"></a><span id="l23.61" class="difflineminus">-      this._authState = 3;</span>
<a href="#l23.62"></a><span id="l23.62" class="difflineminus">-</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-      return &quot;235 authentication successful&quot;;</span>
<a href="#l23.64"></a><span id="l23.64" class="difflineminus">-    }</span>
<a href="#l23.65"></a><span id="l23.65" class="difflineminus">-    case &quot;LOGIN&quot;: {</span>
<a href="#l23.66"></a><span id="l23.66" class="difflineminus">-      this._authState = 1;</span>
<a href="#l23.67"></a><span id="l23.67" class="difflineminus">-      this._expectPassword = true;</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-      return &quot;334 &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineminus">-    }</span>
<a href="#l23.70"></a><span id="l23.70" class="difflineminus">-    default:</span>
<a href="#l23.71"></a><span id="l23.71" class="difflineminus">-      return &quot;504 Invalid authentication mechanism&quot;</span>
<a href="#l23.72"></a><span id="l23.72" class="difflineminus">-    }</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineminus">-</span>
<a href="#l23.74"></a><span id="l23.74" class="difflineplus">+  resetTest : function() {</span>
<a href="#l23.75"></a><span id="l23.75" class="difflineplus">+    this._state = this.kAuthRequired ? kStateAuthNeeded : kStateAuthOptional;</span>
<a href="#l23.76"></a><span id="l23.76" class="difflineplus">+    this._nextAuthFunction = undefined;</span>
<a href="#l23.77"></a><span id="l23.77" class="difflineplus">+    this._multiline = false;</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineplus">+    this.expectingData = false;</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+  },</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+  EHLO: function (args) {</span>
<a href="#l23.81"></a><span id="l23.81" class="difflineplus">+    var capa = &quot;250-fakeserver greets you&quot;;</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineplus">+    if (this.kCapabilities.length &gt; 0)</span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+      capa += &quot;\n250-&quot; + this.kCapabilities.join(&quot;\n250-&quot;);</span>
<a href="#l23.84"></a><span id="l23.84" class="difflineplus">+    if (this.kAuthSchemes.length &gt; 0)</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+      capa += &quot;\n250-AUTH &quot; + this.kAuthSchemes.join(&quot; &quot;);</span>
<a href="#l23.86"></a><span id="l23.86" class="difflineplus">+    capa += &quot;\n250 HELP&quot;; // the odd one: no &quot;-&quot;, per RFC 2821</span>
<a href="#l23.87"></a><span id="l23.87" class="difflineplus">+    return capa;</span>
<a href="#l23.88"></a><span id="l23.88" class="difflineplus">+  },</span>
<a href="#l23.89"></a><span id="l23.89" class="difflineplus">+  AUTH: function (lineRest) {</span>
<a href="#l23.90"></a><span id="l23.90" class="difflineplus">+    if (this._state == kStateAuthenticated)</span>
<a href="#l23.91"></a><span id="l23.91" class="difflineplus">+      return &quot;503 You're already authenticated&quot;;</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineplus">+    var args = lineRest.split(&quot; &quot;);</span>
<a href="#l23.93"></a><span id="l23.93" class="difflineplus">+    var scheme = args[0].toUpperCase();</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineplus">+    // |scheme| contained in |kAuthSchemes|?</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+    if (!this.kAuthSchemes.some(function (s) { return s == scheme; }))</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineplus">+      return &quot;504 AUTH &quot; + scheme + &quot; not supported&quot;;</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+    var func = this._kAuthSchemeStartFunction[scheme];</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+    if (!func || typeof(func) != &quot;function&quot;)</span>
<a href="#l23.99"></a><span id="l23.99" class="difflineplus">+      return &quot;504 I just pretended to implement AUTH &quot; + scheme + &quot;, but I don't&quot;;</span>
<a href="#l23.100"></a><span id="l23.100" class="difflineplus">+    dump(&quot;Starting AUTH &quot; + scheme + &quot;\n&quot;);</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineplus">+    return func.call(this, args[1]);</span>
<a href="#l23.102"></a><span id="l23.102">   },</span>
<a href="#l23.103"></a><span id="l23.103">   MAIL: function (args) {</span>
<a href="#l23.104"></a><span id="l23.104" class="difflineplus">+    if (this._state == kStateAuthNeeded)</span>
<a href="#l23.105"></a><span id="l23.105" class="difflineplus">+      return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l23.106"></a><span id="l23.106">     return &quot;250 ok&quot;;</span>
<a href="#l23.107"></a><span id="l23.107">   },</span>
<a href="#l23.108"></a><span id="l23.108">   RCPT: function(args) {</span>
<a href="#l23.109"></a><span id="l23.109" class="difflineplus">+    if (this._state == kStateAuthNeeded)</span>
<a href="#l23.110"></a><span id="l23.110" class="difflineplus">+      return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l23.111"></a><span id="l23.111">     return &quot;250 ok&quot;;</span>
<a href="#l23.112"></a><span id="l23.112">   },</span>
<a href="#l23.113"></a><span id="l23.113">   DATA: function(args) {</span>
<a href="#l23.114"></a><span id="l23.114" class="difflineplus">+    if (this._state == kStateAuthNeeded)</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+      return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l23.116"></a><span id="l23.116">     this.expectingData = true;</span>
<a href="#l23.117"></a><span id="l23.117">     this.post = &quot;&quot;;</span>
<a href="#l23.118"></a><span id="l23.118">     return &quot;354 ok\n&quot;;</span>
<a href="#l23.119"></a><span id="l23.119">   },</span>
<a href="#l23.120"></a><span id="l23.120">   RSET: function (args) {</span>
<a href="#l23.121"></a><span id="l23.121">     return &quot;250 ok\n&quot;;</span>
<a href="#l23.122"></a><span id="l23.122">   },</span>
<a href="#l23.123"></a><span id="l23.123">   VRFY: function (args) {</span>
<a href="#l23.124"></a><span id="l23.124" class="difflineplus">+    if (this._state == kStateAuthNeeded)</span>
<a href="#l23.125"></a><span id="l23.125" class="difflineplus">+      return &quot;530 5.7.0 Authentication required&quot;;</span>
<a href="#l23.126"></a><span id="l23.126">     return &quot;250 ok\n&quot;;</span>
<a href="#l23.127"></a><span id="l23.127">   },</span>
<a href="#l23.128"></a><span id="l23.128">   EXPN: function (args) {</span>
<a href="#l23.129"></a><span id="l23.129">     return &quot;250 ok\n&quot;;</span>
<a href="#l23.130"></a><span id="l23.130">   },</span>
<a href="#l23.131"></a><span id="l23.131">   HELP: function (args) {</span>
<a href="#l23.132"></a><span id="l23.132">     return &quot;211 ok\n&quot;;</span>
<a href="#l23.133"></a><span id="l23.133">   },</span>
<a href="#l23.134"></a><span id="l23.134" class="difflineat">@@ -82,58 +105,135 @@ SMTP_RFC2822_handler.prototype = {</span>
<a href="#l23.135"></a><span id="l23.135">   QUIT: function (args) {</span>
<a href="#l23.136"></a><span id="l23.136">     this.closing = true;</span>
<a href="#l23.137"></a><span id="l23.137">     return &quot;221 done&quot;;</span>
<a href="#l23.138"></a><span id="l23.138">   },</span>
<a href="#l23.139"></a><span id="l23.139">   onStartup: function () {</span>
<a href="#l23.140"></a><span id="l23.140">     this.closing = false;</span>
<a href="#l23.141"></a><span id="l23.141">     return &quot;220 ok&quot;;</span>
<a href="#l23.142"></a><span id="l23.142">   },</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-  onPassword: function (line) {</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineminus">-    this._expectPassword = false;</span>
<a href="#l23.145"></a><span id="l23.145" class="difflineplus">+</span>
<a href="#l23.146"></a><span id="l23.146" class="difflineplus">+  /**</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineplus">+   * AUTH implementations</span>
<a href="#l23.148"></a><span id="l23.148" class="difflineplus">+   * @see RFC 4954</span>
<a href="#l23.149"></a><span id="l23.149" class="difflineplus">+   */</span>
<a href="#l23.150"></a><span id="l23.150" class="difflineplus">+  authPLAINStart : function (lineRest)</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineplus">+  {</span>
<a href="#l23.152"></a><span id="l23.152" class="difflineplus">+    if (lineRest) // all in one command, called initial client response, see RFC 4954</span>
<a href="#l23.153"></a><span id="l23.153" class="difflineplus">+      return this.authPLAINCred(lineRest);</span>
<a href="#l23.154"></a><span id="l23.154" class="difflineplus">+</span>
<a href="#l23.155"></a><span id="l23.155" class="difflineplus">+    this._nextAuthFunction = this.authPLAINCred;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineplus">+    this._multiline = true;</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+    return &quot;334 &quot;;</span>
<a href="#l23.159"></a><span id="l23.159" class="difflineplus">+  },</span>
<a href="#l23.160"></a><span id="l23.160" class="difflineplus">+  authPLAINCred : function (line)</span>
<a href="#l23.161"></a><span id="l23.161" class="difflineplus">+  {</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineplus">+    var req = AuthPLAIN.decodeLine(line);</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l23.164"></a><span id="l23.164" class="difflineplus">+        req.password == this.kPassword) {</span>
<a href="#l23.165"></a><span id="l23.165" class="difflineplus">+      this._state = kStateAuthenticated;</span>
<a href="#l23.166"></a><span id="l23.166" class="difflineplus">+      return &quot;235 2.7.0 Hello friend! Friends give friends good advice: Next time, use CRAM-MD5&quot;;</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineplus">+    }</span>
<a href="#l23.168"></a><span id="l23.168" class="difflineplus">+    else {</span>
<a href="#l23.169"></a><span id="l23.169" class="difflineplus">+      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineplus">+    }</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+  },</span>
<a href="#l23.172"></a><span id="l23.172" class="difflineplus">+</span>
<a href="#l23.173"></a><span id="l23.173" class="difflineplus">+  authCRAMStart : function (lineRest)</span>
<a href="#l23.174"></a><span id="l23.174" class="difflineplus">+  {</span>
<a href="#l23.175"></a><span id="l23.175" class="difflineplus">+    this._nextAuthFunction = this.authCRAMDigest;</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineplus">+    this._multiline = true;</span>
<a href="#l23.177"></a><span id="l23.177"> </span>
<a href="#l23.178"></a><span id="l23.178" class="difflineminus">-    switch (this._authState) {</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-      case 1: {</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineminus">-        if (line != btoa(this._username)) {</span>
<a href="#l23.181"></a><span id="l23.181" class="difflineminus">-          this._authState = 0;</span>
<a href="#l23.182"></a><span id="l23.182" class="difflineminus">-          return &quot;535 authentication failed&quot;;</span>
<a href="#l23.183"></a><span id="l23.183" class="difflineminus">-        }</span>
<a href="#l23.184"></a><span id="l23.184" class="difflineminus">-        this._authState = 2;</span>
<a href="#l23.185"></a><span id="l23.185" class="difflineminus">-        this._expectPassword = true;</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineminus">-        return &quot;334 &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l23.187"></a><span id="l23.187" class="difflineminus">-      }</span>
<a href="#l23.188"></a><span id="l23.188" class="difflineminus">-      case 2: {</span>
<a href="#l23.189"></a><span id="l23.189" class="difflineminus">-        if (line != btoa(this._password)) {</span>
<a href="#l23.190"></a><span id="l23.190" class="difflineminus">-          this._authState = 0;</span>
<a href="#l23.191"></a><span id="l23.191" class="difflineminus">-          return &quot;535 authentication failed&quot;;</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-        }</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineminus">-        this._authState = 3;</span>
<a href="#l23.194"></a><span id="l23.194" class="difflineminus">-        return &quot;235 authentication successful&quot;;</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-      }</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineplus">+    this._usedCRAMMD5Challenge = AuthCRAM.createChallenge(&quot;localhost&quot;);</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+    return &quot;334 &quot; + this._usedCRAMMD5Challenge;</span>
<a href="#l23.198"></a><span id="l23.198" class="difflineplus">+  },</span>
<a href="#l23.199"></a><span id="l23.199" class="difflineplus">+  authCRAMDigest : function (line)</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineplus">+  {</span>
<a href="#l23.201"></a><span id="l23.201" class="difflineplus">+    var req = AuthCRAM.decodeLine(line);</span>
<a href="#l23.202"></a><span id="l23.202" class="difflineplus">+    var expectedDigest = AuthCRAM.encodeCRAMMD5(</span>
<a href="#l23.203"></a><span id="l23.203" class="difflineplus">+        this._usedCRAMMD5Challenge, this.kPassword);</span>
<a href="#l23.204"></a><span id="l23.204" class="difflineplus">+    if (req.username == this.kUsername &amp;&amp;</span>
<a href="#l23.205"></a><span id="l23.205" class="difflineplus">+        req.digest == expectedDigest) {</span>
<a href="#l23.206"></a><span id="l23.206" class="difflineplus">+      this._state = kStateAuthenticated;</span>
<a href="#l23.207"></a><span id="l23.207" class="difflineplus">+      return &quot;235 2.7.0 Hello friend!&quot;;</span>
<a href="#l23.208"></a><span id="l23.208" class="difflineplus">+    }</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+    else {</span>
<a href="#l23.210"></a><span id="l23.210" class="difflineplus">+      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l23.211"></a><span id="l23.211">     }</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-    return &quot;500 not recognized\n&quot;;</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+  },</span>
<a href="#l23.214"></a><span id="l23.214" class="difflineplus">+</span>
<a href="#l23.215"></a><span id="l23.215" class="difflineplus">+  authLOGINStart : function (lineRest)</span>
<a href="#l23.216"></a><span id="l23.216" class="difflineplus">+  {</span>
<a href="#l23.217"></a><span id="l23.217" class="difflineplus">+    this._nextAuthFunction = this.authLOGINUsername;</span>
<a href="#l23.218"></a><span id="l23.218" class="difflineplus">+    this._multiline = true;</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineplus">+</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+    return &quot;334 &quot; + btoa(&quot;Username:&quot;);</span>
<a href="#l23.221"></a><span id="l23.221" class="difflineplus">+  },</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineplus">+  authLOGINUsername : function (line)</span>
<a href="#l23.223"></a><span id="l23.223" class="difflineplus">+  {</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineplus">+    if (req == this.kUsername)</span>
<a href="#l23.226"></a><span id="l23.226" class="difflineplus">+      this._nextAuthFunction = this.authLOGINPassword;</span>
<a href="#l23.227"></a><span id="l23.227" class="difflineplus">+    else // Don't return error yet, to not reveal valid usernames</span>
<a href="#l23.228"></a><span id="l23.228" class="difflineplus">+      this._nextAuthFunction = this.authLOGINBadUsername;</span>
<a href="#l23.229"></a><span id="l23.229" class="difflineplus">+    this._multiline = true;</span>
<a href="#l23.230"></a><span id="l23.230" class="difflineplus">+    return &quot;334 &quot; + btoa(&quot;Password:&quot;);</span>
<a href="#l23.231"></a><span id="l23.231">   },</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+  authLOGINBadUsername : function (line)</span>
<a href="#l23.233"></a><span id="l23.233" class="difflineplus">+  {</span>
<a href="#l23.234"></a><span id="l23.234" class="difflineplus">+    return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l23.235"></a><span id="l23.235" class="difflineplus">+  },</span>
<a href="#l23.236"></a><span id="l23.236" class="difflineplus">+  authLOGINPassword : function (line)</span>
<a href="#l23.237"></a><span id="l23.237" class="difflineplus">+  {</span>
<a href="#l23.238"></a><span id="l23.238" class="difflineplus">+    var req = AuthLOGIN.decodeLine(line);</span>
<a href="#l23.239"></a><span id="l23.239" class="difflineplus">+    if (req == this.kPassword) {</span>
<a href="#l23.240"></a><span id="l23.240" class="difflineplus">+      this._state = kStateAuthenticated;</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+      return &quot;235 2.7.0 Hello friend! Where did you pull out this old auth scheme?&quot;;</span>
<a href="#l23.242"></a><span id="l23.242" class="difflineplus">+    }</span>
<a href="#l23.243"></a><span id="l23.243" class="difflineplus">+    else {</span>
<a href="#l23.244"></a><span id="l23.244" class="difflineplus">+      return &quot;535 5.7.8 Wrong username or password, crook!&quot;;</span>
<a href="#l23.245"></a><span id="l23.245" class="difflineplus">+    }</span>
<a href="#l23.246"></a><span id="l23.246" class="difflineplus">+  },</span>
<a href="#l23.247"></a><span id="l23.247" class="difflineplus">+</span>
<a href="#l23.248"></a><span id="l23.248">   onError: function (command, args) {</span>
<a href="#l23.249"></a><span id="l23.249" class="difflineminus">-    return &quot;500 not recognized\n&quot;;</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineplus">+    return &quot;500 Command &quot; + command + &quot; not recognized\n&quot;;</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineplus">+  },</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+  onServerFault: function (e) {</span>
<a href="#l23.253"></a><span id="l23.253" class="difflineplus">+    return &quot;451 Internal server error: &quot; + e;</span>
<a href="#l23.254"></a><span id="l23.254">   },</span>
<a href="#l23.255"></a><span id="l23.255">   onMultiline: function(line) {</span>
<a href="#l23.256"></a><span id="l23.256" class="difflineplus">+    if (this._nextAuthFunction) {</span>
<a href="#l23.257"></a><span id="l23.257" class="difflineplus">+      var func = this._nextAuthFunction;</span>
<a href="#l23.258"></a><span id="l23.258" class="difflineplus">+      this._multiline = false;</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineplus">+      this._nextAuthFunction = undefined;</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+      if (line == &quot;*&quot;) { // abort, per RFC 4954 and others</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineplus">+        return &quot;501 Okay, as you wish. Chicken&quot;;</span>
<a href="#l23.262"></a><span id="l23.262" class="difflineplus">+      }</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+      if (!func || typeof(func) != &quot;function&quot;) {</span>
<a href="#l23.264"></a><span id="l23.264" class="difflineplus">+        return &quot;451 I'm lost. Internal server error during auth&quot;;</span>
<a href="#l23.265"></a><span id="l23.265" class="difflineplus">+      }</span>
<a href="#l23.266"></a><span id="l23.266" class="difflineplus">+      try {</span>
<a href="#l23.267"></a><span id="l23.267" class="difflineplus">+        return func.call(this, line);</span>
<a href="#l23.268"></a><span id="l23.268" class="difflineplus">+      } catch (e) { return &quot;451 &quot; + e; }</span>
<a href="#l23.269"></a><span id="l23.269" class="difflineplus">+    }</span>
<a href="#l23.270"></a><span id="l23.270">     if (line == &quot;.&quot;) {</span>
<a href="#l23.271"></a><span id="l23.271">       if (this.expectingData) {</span>
<a href="#l23.272"></a><span id="l23.272">         this.expectingData = false;</span>
<a href="#l23.273"></a><span id="l23.273">         return &quot;250 Wonderful article, your style is gorgeous!&quot;;</span>
<a href="#l23.274"></a><span id="l23.274" class="difflineminus">-	    }</span>
<a href="#l23.275"></a><span id="l23.275" class="difflineplus">+      }</span>
<a href="#l23.276"></a><span id="l23.276" class="difflineplus">+      return &quot;503 Huch? How did you get here?&quot;;</span>
<a href="#l23.277"></a><span id="l23.277">     }</span>
<a href="#l23.278"></a><span id="l23.278"> </span>
<a href="#l23.279"></a><span id="l23.279">     if (this.expectingData) {</span>
<a href="#l23.280"></a><span id="l23.280"> 	    if (line.charAt(0) == '.')</span>
<a href="#l23.281"></a><span id="l23.281">         line = line.substring(1);</span>
<a href="#l23.282"></a><span id="l23.282">       // This uses CR LF to match with the specification</span>
<a href="#l23.283"></a><span id="l23.283"> 	    this.post += line + '\r\n';</span>
<a href="#l23.284"></a><span id="l23.284">     }</span>
<a href="#l23.285"></a><span id="l23.285">     return undefined;</span>
<a href="#l23.286"></a><span id="l23.286">   },</span>
<a href="#l23.287"></a><span id="l23.287" class="difflineminus">-  postCommand: function(obj) {</span>
<a href="#l23.288"></a><span id="l23.288" class="difflineplus">+  postCommand: function(reader) {</span>
<a href="#l23.289"></a><span id="l23.289">     if (this.closing)</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-      obj.closeSocket();</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineminus">-    obj.setMultiline(this.expectingData);</span>
<a href="#l23.292"></a><span id="l23.292" class="difflineminus">-    obj.setExpectPassword(this._expectPassword);</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineplus">+      reader.closeSocket();</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineplus">+    reader.setMultiline(this._multiline || this.expectingData);</span>
<a href="#l23.295"></a><span id="l23.295">   }</span>
<a href="#l23.296"></a><span id="l23.296"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/test/resources/POP3pump.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/test/resources/POP3pump.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -13,16 +13,18 @@</span>
<a href="#l24.4"></a><span id="l24.4">  *</span>
<a href="#l24.5"></a><span id="l24.5">  * Original Author: Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l24.6"></a><span id="l24.6">  *</span>
<a href="#l24.7"></a><span id="l24.7">  */</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> // Import the pop3 server scripts</span>
<a href="#l24.10"></a><span id="l24.10"> if (typeof nsMailServer == 'undefined')</span>
<a href="#l24.11"></a><span id="l24.11">   load(&quot;../../mailnews/fakeserver/maild.js&quot;);</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+if (typeof AuthPLAIN == 'undefined')</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  load(&quot;../../mailnews/fakeserver/auth.js&quot;)</span>
<a href="#l24.14"></a><span id="l24.14"> if (typeof pop3Daemon == 'undefined')</span>
<a href="#l24.15"></a><span id="l24.15">   load(&quot;../../mailnews/fakeserver/pop3d.js&quot;);</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17"> function POP3Pump()</span>
<a href="#l24.18"></a><span id="l24.18"> {</span>
<a href="#l24.19"></a><span id="l24.19">   // public attributes</span>
<a href="#l24.20"></a><span id="l24.20">   this.fakeServer = null;</span>
<a href="#l24.21"></a><span id="l24.21">   this.onDone = null;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -84,20 +86,20 @@ POP3Pump.prototype._createPop3ServerAndL</span>
<a href="#l24.23"></a><span id="l24.23">   if (typeof gLocalInboxFolder == 'undefined')</span>
<a href="#l24.24"></a><span id="l24.24">     loadLocalMailAccount();</span>
<a href="#l24.25"></a><span id="l24.25"> </span>
<a href="#l24.26"></a><span id="l24.26">   if (!this.fakeServer)</span>
<a href="#l24.27"></a><span id="l24.27">   {</span>
<a href="#l24.28"></a><span id="l24.28">     let acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l24.29"></a><span id="l24.29">                     .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l24.30"></a><span id="l24.30"> </span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">-    let incoming = acctMgr.createIncomingServer(&quot;fake&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+    let incoming = acctMgr.createIncomingServer(&quot;fred&quot;, &quot;localhost&quot;, &quot;pop3&quot;);</span>
<a href="#l24.33"></a><span id="l24.33"> </span>
<a href="#l24.34"></a><span id="l24.34">     incoming.port = this.kPOP3_PORT;</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineminus">-    incoming.password = &quot;server&quot;;</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+    incoming.password = &quot;wilma&quot;;</span>
<a href="#l24.37"></a><span id="l24.37">     this.fakeServer = incoming;</span>
<a href="#l24.38"></a><span id="l24.38">   }</span>
<a href="#l24.39"></a><span id="l24.39">   return this.fakeServer;</span>
<a href="#l24.40"></a><span id="l24.40"> };</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42"> POP3Pump.prototype._checkBusy = function _checkBusy()</span>
<a href="#l24.43"></a><span id="l24.43"> {</span>
<a href="#l24.44"></a><span id="l24.44">   if (this._tests.length == 0 &amp;&amp; !this._finalCleanup)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

