<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 15777:9cbd527a1075de83f0da0e3557a14b678eeff6b4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 9cbd527a1075de83f0da0e3557a14b678eeff6b4" />
<meta property="og:url" content="/comm-central/rev/9cbd527a1075de83f0da0e3557a14b678eeff6b4" />
<meta property="og:description" content="Fix bug 932217 - Update ical.js to latest version." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 9cbd527a1075de83f0da0e3557a14b678eeff6b4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/9cbd527a1075de83f0da0e3557a14b678eeff6b4">shortlog</a> |
<a href="/comm-central/log/9cbd527a1075de83f0da0e3557a14b678eeff6b4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/9cbd527a1075de83f0da0e3557a14b678eeff6b4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/9cbd527a1075de83f0da0e3557a14b678eeff6b4">files</a> |
changeset |
<a href="/comm-central/raw-rev/9cbd527a1075de83f0da0e3557a14b678eeff6b4">raw</a>  | <a href="/comm-central/archive/9cbd527a1075de83f0da0e3557a14b678eeff6b4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=932217">bug 932217</a> - Update ical.js to latest version.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#114;&#107;&#117;&#115;&#32;&#65;&#100;&#114;&#97;&#114;&#105;&#111;&#32;&#60;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#64;&#97;&#100;&#114;&#97;&#114;&#105;&#111;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 21 Feb 2014 16:26:48 +0100</td></tr>

<tr>
 <td>changeset 15777</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/9cbd527a1075de83f0da0e3557a14b678eeff6b4">9cbd527a1075de83f0da0e3557a14b678eeff6b4</a></td>
</tr>



<tr>
<td>parent 15776</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e2b29f224ade93d5cff8f10e86bb36621fe71bd4">e2b29f224ade93d5cff8f10e86bb36621fe71bd4</a>
</td>
</tr>

<tr>
<td>child 15778</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/0e575a37a7f50ea8885b8fe44989ef564c4ec6cb">0e575a37a7f50ea8885b8fe44989ef564c4ec6cb</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=9cbd527a1075de83f0da0e3557a14b678eeff6b4">9884</a></td></tr>
<tr><td>push user</td><td>Mozilla@Adrario.de</td></tr>
<tr><td>push date</td><td class="date age">Fri, 21 Feb 2014 15:44:03 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@9cbd527a1075 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9cbd527a1075de83f0da0e3557a14b678eeff6b4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&newProject=comm-central&newRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&newProject=comm-central&newRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&newProject=comm-central&newRevision=9cbd527a1075de83f0da0e3557a14b678eeff6b4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=932217">932217</a></td></tr>




</table></div>

<div class="page_body description">Fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=932217">bug 932217</a> - Update ical.js to latest version.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">calendar/base/modules/ical.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">file</a> |
<a href="/comm-central/annotate/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">annotate</a> |
<a href="/comm-central/diff/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">diff</a> |
<a href="/comm-central/comparison/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">comparison</a> |
<a href="/comm-central/log/9cbd527a1075de83f0da0e3557a14b678eeff6b4/calendar/base/modules/ical.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/base/modules/ical.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/base/modules/ical.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l1.4"></a><span id="l1.4">  * Portions Copyright (C) Philipp Kewisch, 2011-2012 */</span>
<a href="#l1.5"></a><span id="l1.5"> </span>
<a href="#l1.6"></a><span id="l1.6"> /**</span>
<a href="#l1.7"></a><span id="l1.7">  * This is ical.js from &lt;https://github.com/mozilla-comm/ical.js&gt;.</span>
<a href="#l1.8"></a><span id="l1.8">  *</span>
<a href="#l1.9"></a><span id="l1.9">  * If you would like to change anything in ical.js, it is required to do so</span>
<a href="#l1.10"></a><span id="l1.10">  * upstream first.</span>
<a href="#l1.11"></a><span id="l1.11">  *</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * Current ical.js git revision: b2112a5eb6fe2c311ee945150b2a267213c1f18c</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ * Current ical.js git revision: 9d3ee67d1ce9e0bb960e73a45e2dd434360cbd8d</span>
<a href="#l1.14"></a><span id="l1.14">  */</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> var EXPORTED_SYMBOLS = [&quot;ICAL&quot;, &quot;unwrap&quot;, &quot;unwrapSetter&quot;, &quot;unwrapSingle&quot;, &quot;wrapGetter&quot;];</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18"> function wrapGetter(type, val) {</span>
<a href="#l1.19"></a><span id="l1.19">     return val ? new type(val) : null;</span>
<a href="#l1.20"></a><span id="l1.20"> }</span>
<a href="#l1.21"></a><span id="l1.21"> </span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -38,17 +38,17 @@ function unwrapSingle(type, val) {</span>
<a href="#l1.23"></a><span id="l1.23">     }</span>
<a href="#l1.24"></a><span id="l1.24"> }</span>
<a href="#l1.25"></a><span id="l1.25"> </span>
<a href="#l1.26"></a><span id="l1.26"> // -- start ical.js --</span>
<a href="#l1.27"></a><span id="l1.27"> </span>
<a href="#l1.28"></a><span id="l1.28"> if (typeof(ICAL) === 'undefined')</span>
<a href="#l1.29"></a><span id="l1.29">   (typeof(window) !== 'undefined') ? this.ICAL = {} : ICAL = {};</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-ICAL.foldLength = 74;</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+ICAL.foldLength = 75;</span>
<a href="#l1.33"></a><span id="l1.33"> ICAL.newLineChar = '\r\n';</span>
<a href="#l1.34"></a><span id="l1.34"> ICAL.debug = false;</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36"> /**</span>
<a href="#l1.37"></a><span id="l1.37">  * Helper functions used in various places within ical.js</span>
<a href="#l1.38"></a><span id="l1.38">  */</span>
<a href="#l1.39"></a><span id="l1.39"> ICAL.helpers = {</span>
<a href="#l1.40"></a><span id="l1.40">   initState: function initState(aLine, aLineNr) {</span>
<a href="#l1.41"></a><span id="l1.41" class="difflineat">@@ -1231,66 +1231,74 @@ ICAL.parse = (function() {</span>
<a href="#l1.42"></a><span id="l1.42">     return name.toLowerCase();</span>
<a href="#l1.43"></a><span id="l1.43">   }</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">   parser._handleContentLine = function(line, state) {</span>
<a href="#l1.46"></a><span id="l1.46">     // break up the parts of the line</span>
<a href="#l1.47"></a><span id="l1.47">     var valuePos = line.indexOf(VALUE_DELIMITER);</span>
<a href="#l1.48"></a><span id="l1.48">     var paramPos = line.indexOf(PARAM_DELIMITER);</span>
<a href="#l1.49"></a><span id="l1.49"> </span>
<a href="#l1.50"></a><span id="l1.50" class="difflineminus">-    var nextPos = 0;</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+    var lastParamIndex;</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    var lastValuePos;</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+</span>
<a href="#l1.54"></a><span id="l1.54">     // name of property or begin/end</span>
<a href="#l1.55"></a><span id="l1.55">     var name;</span>
<a href="#l1.56"></a><span id="l1.56">     var value;</span>
<a href="#l1.57"></a><span id="l1.57" class="difflineminus">-    var params;</span>
<a href="#l1.58"></a><span id="l1.58" class="difflineplus">+    // params is only overridden if paramPos !== -1.</span>
<a href="#l1.59"></a><span id="l1.59" class="difflineplus">+    // we can't do params = params || {} later on</span>
<a href="#l1.60"></a><span id="l1.60" class="difflineplus">+    // because it sacrifices ops.</span>
<a href="#l1.61"></a><span id="l1.61" class="difflineplus">+    var params = {};</span>
<a href="#l1.62"></a><span id="l1.62"> </span>
<a href="#l1.63"></a><span id="l1.63">     /**</span>
<a href="#l1.64"></a><span id="l1.64">      * Different property cases</span>
<a href="#l1.65"></a><span id="l1.65">      *</span>
<a href="#l1.66"></a><span id="l1.66">      *</span>
<a href="#l1.67"></a><span id="l1.67">      * 1. RRULE:FREQ=foo</span>
<a href="#l1.68"></a><span id="l1.68">      *    // FREQ= is not a param but the value</span>
<a href="#l1.69"></a><span id="l1.69">      *</span>
<a href="#l1.70"></a><span id="l1.70">      * 2. ATTENDEE;ROLE=REQ-PARTICIPANT;</span>
<a href="#l1.71"></a><span id="l1.71">      *    // ROLE= is a param because : has not happened yet</span>
<a href="#l1.72"></a><span id="l1.72">      */</span>
<a href="#l1.73"></a><span id="l1.73" class="difflineplus">+      // when the parameter delimiter is after the</span>
<a href="#l1.74"></a><span id="l1.74" class="difflineplus">+      // value delimiter then its not a parameter.</span>
<a href="#l1.75"></a><span id="l1.75"> </span>
<a href="#l1.76"></a><span id="l1.76">     if ((paramPos !== -1 &amp;&amp; valuePos !== -1)) {</span>
<a href="#l1.77"></a><span id="l1.77">       // when the parameter delimiter is after the</span>
<a href="#l1.78"></a><span id="l1.78">       // value delimiter then its not a parameter.</span>
<a href="#l1.79"></a><span id="l1.79">       if (paramPos &gt; valuePos) {</span>
<a href="#l1.80"></a><span id="l1.80">         paramPos = -1;</span>
<a href="#l1.81"></a><span id="l1.81">       }</span>
<a href="#l1.82"></a><span id="l1.82">     }</span>
<a href="#l1.83"></a><span id="l1.83"> </span>
<a href="#l1.84"></a><span id="l1.84" class="difflineplus">+    var parsedParams;</span>
<a href="#l1.85"></a><span id="l1.85">     if (paramPos !== -1) {</span>
<a href="#l1.86"></a><span id="l1.86" class="difflineminus">-      // when there are parameters (ATTENDEE;RSVP=TRUE;)</span>
<a href="#l1.87"></a><span id="l1.87" class="difflineminus">-      name = parser._formatName(line.substr(0, paramPos));</span>
<a href="#l1.88"></a><span id="l1.88" class="difflineminus">-      params = parser._parseParameters(line, paramPos);</span>
<a href="#l1.89"></a><span id="l1.89" class="difflineminus">-      if (valuePos !== -1) {</span>
<a href="#l1.90"></a><span id="l1.90" class="difflineminus">-        value = line.substr(valuePos + 1);</span>
<a href="#l1.91"></a><span id="l1.91" class="difflineplus">+      name = line.substring(0, paramPos).toLowerCase();</span>
<a href="#l1.92"></a><span id="l1.92" class="difflineplus">+      parsedParams = parser._parseParameters(line.substring(paramPos), 0);</span>
<a href="#l1.93"></a><span id="l1.93" class="difflineplus">+      params = parsedParams[0];</span>
<a href="#l1.94"></a><span id="l1.94" class="difflineplus">+      lastParamIndex = parsedParams[1].length + parsedParams[2] + paramPos;</span>
<a href="#l1.95"></a><span id="l1.95" class="difflineplus">+      if ((lastValuePos =</span>
<a href="#l1.96"></a><span id="l1.96" class="difflineplus">+        line.substring(lastParamIndex).indexOf(VALUE_DELIMITER)) !== -1) {</span>
<a href="#l1.97"></a><span id="l1.97" class="difflineplus">+        value = line.substring(lastParamIndex + lastValuePos + 1);</span>
<a href="#l1.98"></a><span id="l1.98">       }</span>
<a href="#l1.99"></a><span id="l1.99">     } else if (valuePos !== -1) {</span>
<a href="#l1.100"></a><span id="l1.100">       // without parmeters (BEGIN:VCAENDAR, CLASS:PUBLIC)</span>
<a href="#l1.101"></a><span id="l1.101" class="difflineminus">-      name = parser._formatName(line.substr(0, valuePos));</span>
<a href="#l1.102"></a><span id="l1.102" class="difflineminus">-      value = line.substr(valuePos + 1);</span>
<a href="#l1.103"></a><span id="l1.103" class="difflineplus">+      name = line.substring(0, valuePos).toLowerCase();</span>
<a href="#l1.104"></a><span id="l1.104" class="difflineplus">+      value = line.substring(valuePos + 1);</span>
<a href="#l1.105"></a><span id="l1.105"> </span>
<a href="#l1.106"></a><span id="l1.106">       if (name === 'begin') {</span>
<a href="#l1.107"></a><span id="l1.107" class="difflineminus">-        var newComponent = [parser._formatName(value), [], []];</span>
<a href="#l1.108"></a><span id="l1.108" class="difflineplus">+        var newComponent = [value.toLowerCase(), [], []];</span>
<a href="#l1.109"></a><span id="l1.109">         if (state.stack.length === 1) {</span>
<a href="#l1.110"></a><span id="l1.110">           state.component.push(newComponent);</span>
<a href="#l1.111"></a><span id="l1.111">         } else {</span>
<a href="#l1.112"></a><span id="l1.112">           state.component[2].push(newComponent);</span>
<a href="#l1.113"></a><span id="l1.113">         }</span>
<a href="#l1.114"></a><span id="l1.114">         state.stack.push(state.component);</span>
<a href="#l1.115"></a><span id="l1.115">         state.component = newComponent;</span>
<a href="#l1.116"></a><span id="l1.116">         return;</span>
<a href="#l1.117"></a><span id="l1.117" class="difflineminus">-      }</span>
<a href="#l1.118"></a><span id="l1.118" class="difflineminus">-</span>
<a href="#l1.119"></a><span id="l1.119" class="difflineminus">-      if (name === 'end') {</span>
<a href="#l1.120"></a><span id="l1.120" class="difflineplus">+      } else if (name === 'end') {</span>
<a href="#l1.121"></a><span id="l1.121">         state.component = state.stack.pop();</span>
<a href="#l1.122"></a><span id="l1.122">         return;</span>
<a href="#l1.123"></a><span id="l1.123">       }</span>
<a href="#l1.124"></a><span id="l1.124">     } else {</span>
<a href="#l1.125"></a><span id="l1.125">       /**</span>
<a href="#l1.126"></a><span id="l1.126">        * Invalid line.</span>
<a href="#l1.127"></a><span id="l1.127">        * The rational to throw an error is we will</span>
<a href="#l1.128"></a><span id="l1.128">        * never be certain that the rest of the file</span>
<a href="#l1.129"></a><span id="l1.129" class="difflineat">@@ -1313,19 +1321,16 @@ ICAL.parse = (function() {</span>
<a href="#l1.130"></a><span id="l1.130">         multiValue = propertyDetails.multiValue;</span>
<a href="#l1.131"></a><span id="l1.131">       }</span>
<a href="#l1.132"></a><span id="l1.132"> </span>
<a href="#l1.133"></a><span id="l1.133">       if (value &amp;&amp; 'detectType' in propertyDetails) {</span>
<a href="#l1.134"></a><span id="l1.134">         valueType = propertyDetails.detectType(value);</span>
<a href="#l1.135"></a><span id="l1.135">       }</span>
<a href="#l1.136"></a><span id="l1.136">     }</span>
<a href="#l1.137"></a><span id="l1.137"> </span>
<a href="#l1.138"></a><span id="l1.138" class="difflineminus">-    // at this point params is mandatory per jcal spec</span>
<a href="#l1.139"></a><span id="l1.139" class="difflineminus">-    params = params || {};</span>
<a href="#l1.140"></a><span id="l1.140" class="difflineminus">-</span>
<a href="#l1.141"></a><span id="l1.141">     // attempt to determine value</span>
<a href="#l1.142"></a><span id="l1.142">     if (!valueType) {</span>
<a href="#l1.143"></a><span id="l1.143">       if (!('value' in params)) {</span>
<a href="#l1.144"></a><span id="l1.144">         if (propertyDetails) {</span>
<a href="#l1.145"></a><span id="l1.145">           valueType = propertyDetails.defaultType;</span>
<a href="#l1.146"></a><span id="l1.146">         } else {</span>
<a href="#l1.147"></a><span id="l1.147">           valueType = DEFAULT_TYPE;</span>
<a href="#l1.148"></a><span id="l1.148">         }</span>
<a href="#l1.149"></a><span id="l1.149" class="difflineat">@@ -1380,73 +1385,65 @@ ICAL.parse = (function() {</span>
<a href="#l1.150"></a><span id="l1.150">    * @param {Numeric} maxPos position at which values start.</span>
<a href="#l1.151"></a><span id="l1.151">    * @return {Object} key/value pairs.</span>
<a href="#l1.152"></a><span id="l1.152">    */</span>
<a href="#l1.153"></a><span id="l1.153">   parser._parseParameters = function(line, start) {</span>
<a href="#l1.154"></a><span id="l1.154">     var lastParam = start;</span>
<a href="#l1.155"></a><span id="l1.155">     var pos = 0;</span>
<a href="#l1.156"></a><span id="l1.156">     var delim = PARAM_NAME_DELIMITER;</span>
<a href="#l1.157"></a><span id="l1.157">     var result = {};</span>
<a href="#l1.158"></a><span id="l1.158" class="difflineplus">+    var name;</span>
<a href="#l1.159"></a><span id="l1.159" class="difflineplus">+    var value;</span>
<a href="#l1.160"></a><span id="l1.160" class="difflineplus">+    var type;</span>
<a href="#l1.161"></a><span id="l1.161"> </span>
<a href="#l1.162"></a><span id="l1.162">     // find the next '=' sign</span>
<a href="#l1.163"></a><span id="l1.163">     // use lastParam and pos to find name</span>
<a href="#l1.164"></a><span id="l1.164">     // check if &quot; is used if so get value from &quot;-&gt;&quot;</span>
<a href="#l1.165"></a><span id="l1.165">     // then increment pos to find next ;</span>
<a href="#l1.166"></a><span id="l1.166"> </span>
<a href="#l1.167"></a><span id="l1.167">     while ((pos !== false) &amp;&amp;</span>
<a href="#l1.168"></a><span id="l1.168">            (pos = helpers.unescapedIndexOf(line, delim, pos + 1)) !== -1) {</span>
<a href="#l1.169"></a><span id="l1.169"> </span>
<a href="#l1.170"></a><span id="l1.170" class="difflineminus">-      var name = line.substr(lastParam + 1, pos - lastParam - 1);</span>
<a href="#l1.171"></a><span id="l1.171" class="difflineplus">+      name = line.substr(lastParam + 1, pos - lastParam - 1);</span>
<a href="#l1.172"></a><span id="l1.172"> </span>
<a href="#l1.173"></a><span id="l1.173">       var nextChar = line[pos + 1];</span>
<a href="#l1.174"></a><span id="l1.174" class="difflineminus">-      var substrOffset = -2;</span>
<a href="#l1.175"></a><span id="l1.175" class="difflineminus">-</span>
<a href="#l1.176"></a><span id="l1.176">       if (nextChar === '&quot;') {</span>
<a href="#l1.177"></a><span id="l1.177">         var valuePos = pos + 2;</span>
<a href="#l1.178"></a><span id="l1.178">         pos = helpers.unescapedIndexOf(line, '&quot;', valuePos);</span>
<a href="#l1.179"></a><span id="l1.179" class="difflineminus">-        var value = line.substr(valuePos, pos - valuePos);</span>
<a href="#l1.180"></a><span id="l1.180" class="difflineplus">+        value = line.substr(valuePos, pos - valuePos);</span>
<a href="#l1.181"></a><span id="l1.181">         lastParam = helpers.unescapedIndexOf(line, PARAM_DELIMITER, pos);</span>
<a href="#l1.182"></a><span id="l1.182">       } else {</span>
<a href="#l1.183"></a><span id="l1.183">         var valuePos = pos + 1;</span>
<a href="#l1.184"></a><span id="l1.184" class="difflineminus">-        substrOffset = -1;</span>
<a href="#l1.185"></a><span id="l1.185"> </span>
<a href="#l1.186"></a><span id="l1.186">         // move to next &quot;;&quot;</span>
<a href="#l1.187"></a><span id="l1.187">         var nextPos = helpers.unescapedIndexOf(line, PARAM_DELIMITER, valuePos);</span>
<a href="#l1.188"></a><span id="l1.188" class="difflineminus">-</span>
<a href="#l1.189"></a><span id="l1.189">         if (nextPos === -1) {</span>
<a href="#l1.190"></a><span id="l1.190">           // when there is no &quot;;&quot; attempt to locate &quot;:&quot;</span>
<a href="#l1.191"></a><span id="l1.191">           nextPos = helpers.unescapedIndexOf(line, VALUE_DELIMITER, valuePos);</span>
<a href="#l1.192"></a><span id="l1.192" class="difflineminus">-          // no more tokens end of the line use .length</span>
<a href="#l1.193"></a><span id="l1.193" class="difflineplus">+</span>
<a href="#l1.194"></a><span id="l1.194">           if (nextPos === -1) {</span>
<a href="#l1.195"></a><span id="l1.195">             nextPos = line.length;</span>
<a href="#l1.196"></a><span id="l1.196" class="difflineminus">-            // because we are at the end we don't need to trim</span>
<a href="#l1.197"></a><span id="l1.197" class="difflineminus">-            // the found value of substr offset is zero</span>
<a href="#l1.198"></a><span id="l1.198" class="difflineminus">-            substrOffset = 0;</span>
<a href="#l1.199"></a><span id="l1.199" class="difflineminus">-          } else {</span>
<a href="#l1.200"></a><span id="l1.200" class="difflineminus">-            // next token is the beginning of the value</span>
<a href="#l1.201"></a><span id="l1.201" class="difflineminus">-            // so we must stop looking for the '=' token.</span>
<a href="#l1.202"></a><span id="l1.202" class="difflineminus">-            pos = false;</span>
<a href="#l1.203"></a><span id="l1.203">           }</span>
<a href="#l1.204"></a><span id="l1.204" class="difflineplus">+          pos = false;</span>
<a href="#l1.205"></a><span id="l1.205">         } else {</span>
<a href="#l1.206"></a><span id="l1.206">           lastParam = nextPos;</span>
<a href="#l1.207"></a><span id="l1.207">         }</span>
<a href="#l1.208"></a><span id="l1.208"> </span>
<a href="#l1.209"></a><span id="l1.209" class="difflineminus">-        var value = line.substr(valuePos, nextPos - valuePos);</span>
<a href="#l1.210"></a><span id="l1.210" class="difflineminus">-      }</span>
<a href="#l1.211"></a><span id="l1.211" class="difflineminus">-</span>
<a href="#l1.212"></a><span id="l1.212" class="difflineminus">-      var type = DEFAULT_TYPE;</span>
<a href="#l1.213"></a><span id="l1.213" class="difflineplus">+        value = line.substr(valuePos, nextPos - valuePos);</span>
<a href="#l1.214"></a><span id="l1.214" class="difflineplus">+      }</span>
<a href="#l1.215"></a><span id="l1.215"> </span>
<a href="#l1.216"></a><span id="l1.216">       if (name in design.param &amp;&amp; design.param[name].valueType) {</span>
<a href="#l1.217"></a><span id="l1.217">         type = design.param[name].valueType;</span>
<a href="#l1.218"></a><span id="l1.218" class="difflineminus">-      }</span>
<a href="#l1.219"></a><span id="l1.219" class="difflineminus">-</span>
<a href="#l1.220"></a><span id="l1.220" class="difflineminus">-      result[parser._formatName(name)] = parser._parseValue(value, type);</span>
<a href="#l1.221"></a><span id="l1.221" class="difflineplus">+      } else {</span>
<a href="#l1.222"></a><span id="l1.222" class="difflineplus">+        type = DEFAULT_TYPE;</span>
<a href="#l1.223"></a><span id="l1.223" class="difflineplus">+      }</span>
<a href="#l1.224"></a><span id="l1.224" class="difflineplus">+</span>
<a href="#l1.225"></a><span id="l1.225" class="difflineplus">+      result[name.toLowerCase()] = parser._parseValue(value, type);</span>
<a href="#l1.226"></a><span id="l1.226">     }</span>
<a href="#l1.227"></a><span id="l1.227" class="difflineminus">-</span>
<a href="#l1.228"></a><span id="l1.228" class="difflineminus">-    return result;</span>
<a href="#l1.229"></a><span id="l1.229" class="difflineplus">+    return [result, value, valuePos];</span>
<a href="#l1.230"></a><span id="l1.230">   }</span>
<a href="#l1.231"></a><span id="l1.231"> </span>
<a href="#l1.232"></a><span id="l1.232">   /**</span>
<a href="#l1.233"></a><span id="l1.233">    * Parse a multi value string</span>
<a href="#l1.234"></a><span id="l1.234">    */</span>
<a href="#l1.235"></a><span id="l1.235">   parser._parseMultiValue = function(buffer, delim, type, result) {</span>
<a href="#l1.236"></a><span id="l1.236">     var pos = 0;</span>
<a href="#l1.237"></a><span id="l1.237">     var lastPos = 0;</span>
<a href="#l1.238"></a><span id="l1.238" class="difflineat">@@ -1538,19 +1535,17 @@ ICAL.Component = (function() {</span>
<a href="#l1.239"></a><span id="l1.239">     if (typeof(jCal) === 'string') {</span>
<a href="#l1.240"></a><span id="l1.240">       // jCal spec (name, properties, components)</span>
<a href="#l1.241"></a><span id="l1.241">       jCal = [jCal, [], []];</span>
<a href="#l1.242"></a><span id="l1.242">     }</span>
<a href="#l1.243"></a><span id="l1.243"> </span>
<a href="#l1.244"></a><span id="l1.244">     // mostly for legacy reasons.</span>
<a href="#l1.245"></a><span id="l1.245">     this.jCal = jCal;</span>
<a href="#l1.246"></a><span id="l1.246"> </span>
<a href="#l1.247"></a><span id="l1.247" class="difflineminus">-    if (parent) {</span>
<a href="#l1.248"></a><span id="l1.248" class="difflineminus">-      this.parent = parent;</span>
<a href="#l1.249"></a><span id="l1.249" class="difflineminus">-    }</span>
<a href="#l1.250"></a><span id="l1.250" class="difflineplus">+    this.parent = parent || null;</span>
<a href="#l1.251"></a><span id="l1.251">   }</span>
<a href="#l1.252"></a><span id="l1.252"> </span>
<a href="#l1.253"></a><span id="l1.253">   Component.prototype = {</span>
<a href="#l1.254"></a><span id="l1.254">     /**</span>
<a href="#l1.255"></a><span id="l1.255">      * Hydrated properties are inserted into the _properties array at the same</span>
<a href="#l1.256"></a><span id="l1.256">      * position as in the jCal array, so its possible the array contains</span>
<a href="#l1.257"></a><span id="l1.257">      * undefined values for unhydrdated properties. To avoid iterating the</span>
<a href="#l1.258"></a><span id="l1.258">      * array when checking if all properties have been hydrated, we save the</span>
<a href="#l1.259"></a><span id="l1.259" class="difflineat">@@ -1766,16 +1761,20 @@ ICAL.Component = (function() {</span>
<a href="#l1.260"></a><span id="l1.260">       }</span>
<a href="#l1.261"></a><span id="l1.261"> </span>
<a href="#l1.262"></a><span id="l1.262">       return null;</span>
<a href="#l1.263"></a><span id="l1.263">     },</span>
<a href="#l1.264"></a><span id="l1.264"> </span>
<a href="#l1.265"></a><span id="l1.265">     _removeObjectByIndex: function(jCalIndex, cache, index) {</span>
<a href="#l1.266"></a><span id="l1.266">       // remove cached version</span>
<a href="#l1.267"></a><span id="l1.267">       if (cache &amp;&amp; cache[index]) {</span>
<a href="#l1.268"></a><span id="l1.268" class="difflineplus">+        var obj = cache[index];</span>
<a href="#l1.269"></a><span id="l1.269" class="difflineplus">+        if (&quot;parent&quot; in obj) {</span>
<a href="#l1.270"></a><span id="l1.270" class="difflineplus">+            obj.parent = null;</span>
<a href="#l1.271"></a><span id="l1.271" class="difflineplus">+        }</span>
<a href="#l1.272"></a><span id="l1.272">         cache.splice(index, 1);</span>
<a href="#l1.273"></a><span id="l1.273">       }</span>
<a href="#l1.274"></a><span id="l1.274"> </span>
<a href="#l1.275"></a><span id="l1.275">       // remove it from the jCal</span>
<a href="#l1.276"></a><span id="l1.276">       this.jCal[jCalIndex].splice(index, 1);</span>
<a href="#l1.277"></a><span id="l1.277">     },</span>
<a href="#l1.278"></a><span id="l1.278"> </span>
<a href="#l1.279"></a><span id="l1.279">     _removeObject: function(jCalIndex, cache, nameOrObject) {</span>
<a href="#l1.280"></a><span id="l1.280" class="difflineat">@@ -1801,50 +1800,45 @@ ICAL.Component = (function() {</span>
<a href="#l1.281"></a><span id="l1.281">       }</span>
<a href="#l1.282"></a><span id="l1.282"> </span>
<a href="#l1.283"></a><span id="l1.283">       return false;</span>
<a href="#l1.284"></a><span id="l1.284">     },</span>
<a href="#l1.285"></a><span id="l1.285"> </span>
<a href="#l1.286"></a><span id="l1.286">     _removeAllObjects: function(jCalIndex, cache, name) {</span>
<a href="#l1.287"></a><span id="l1.287">       var cached = this[cache];</span>
<a href="#l1.288"></a><span id="l1.288"> </span>
<a href="#l1.289"></a><span id="l1.289" class="difflineminus">-      if (name) {</span>
<a href="#l1.290"></a><span id="l1.290" class="difflineminus">-        var objects = this.jCal[jCalIndex];</span>
<a href="#l1.291"></a><span id="l1.291" class="difflineminus">-        var i = objects.length - 1;</span>
<a href="#l1.292"></a><span id="l1.292" class="difflineminus">-</span>
<a href="#l1.293"></a><span id="l1.293" class="difflineminus">-        // descending search required because splice</span>
<a href="#l1.294"></a><span id="l1.294" class="difflineminus">-        // is used and will effect the indices.</span>
<a href="#l1.295"></a><span id="l1.295" class="difflineminus">-        for (; i &gt;= 0; i--) {</span>
<a href="#l1.296"></a><span id="l1.296" class="difflineminus">-          if (objects[i][NAME_INDEX] === name) {</span>
<a href="#l1.297"></a><span id="l1.297" class="difflineminus">-            this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l1.298"></a><span id="l1.298" class="difflineminus">-          }</span>
<a href="#l1.299"></a><span id="l1.299" class="difflineplus">+      // Unfortunately we have to run through all children to reset their</span>
<a href="#l1.300"></a><span id="l1.300" class="difflineplus">+      // parent property.</span>
<a href="#l1.301"></a><span id="l1.301" class="difflineplus">+      var objects = this.jCal[jCalIndex];</span>
<a href="#l1.302"></a><span id="l1.302" class="difflineplus">+      var i = objects.length - 1;</span>
<a href="#l1.303"></a><span id="l1.303" class="difflineplus">+</span>
<a href="#l1.304"></a><span id="l1.304" class="difflineplus">+      // descending search required because splice</span>
<a href="#l1.305"></a><span id="l1.305" class="difflineplus">+      // is used and will effect the indices.</span>
<a href="#l1.306"></a><span id="l1.306" class="difflineplus">+      for (; i &gt;= 0; i--) {</span>
<a href="#l1.307"></a><span id="l1.307" class="difflineplus">+        if (!name || objects[i][NAME_INDEX] === name) {</span>
<a href="#l1.308"></a><span id="l1.308" class="difflineplus">+          this._removeObjectByIndex(jCalIndex, cached, i);</span>
<a href="#l1.309"></a><span id="l1.309">         }</span>
<a href="#l1.310"></a><span id="l1.310" class="difflineminus">-      } else {</span>
<a href="#l1.311"></a><span id="l1.311" class="difflineminus">-        if (cache in this) {</span>
<a href="#l1.312"></a><span id="l1.312" class="difflineminus">-          // I think its probable that when we remove all</span>
<a href="#l1.313"></a><span id="l1.313" class="difflineminus">-          // of a type we may want to add to it again so it</span>
<a href="#l1.314"></a><span id="l1.314" class="difflineminus">-          // makes sense to reuse the object in that case.</span>
<a href="#l1.315"></a><span id="l1.315" class="difflineminus">-          // For now we remove the contents of the array.</span>
<a href="#l1.316"></a><span id="l1.316" class="difflineminus">-          this[cache].length = 0;</span>
<a href="#l1.317"></a><span id="l1.317" class="difflineminus">-        }</span>
<a href="#l1.318"></a><span id="l1.318" class="difflineminus">-        this.jCal[jCalIndex].length = 0;</span>
<a href="#l1.319"></a><span id="l1.319">       }</span>
<a href="#l1.320"></a><span id="l1.320">     },</span>
<a href="#l1.321"></a><span id="l1.321"> </span>
<a href="#l1.322"></a><span id="l1.322">     /**</span>
<a href="#l1.323"></a><span id="l1.323">      * Adds a single sub component.</span>
<a href="#l1.324"></a><span id="l1.324">      *</span>
<a href="#l1.325"></a><span id="l1.325">      * @param {ICAL.Component} component to add.</span>
<a href="#l1.326"></a><span id="l1.326">      */</span>
<a href="#l1.327"></a><span id="l1.327">     addSubcomponent: function(component) {</span>
<a href="#l1.328"></a><span id="l1.328">       if (!this._components) {</span>
<a href="#l1.329"></a><span id="l1.329">         this._components = [];</span>
<a href="#l1.330"></a><span id="l1.330">         this._hydratedComponentCount = 0;</span>
<a href="#l1.331"></a><span id="l1.331">       }</span>
<a href="#l1.332"></a><span id="l1.332"> </span>
<a href="#l1.333"></a><span id="l1.333" class="difflineplus">+      if (component.parent) {</span>
<a href="#l1.334"></a><span id="l1.334" class="difflineplus">+        component.parent.removeSubcomponent(component);</span>
<a href="#l1.335"></a><span id="l1.335" class="difflineplus">+      }</span>
<a href="#l1.336"></a><span id="l1.336" class="difflineplus">+</span>
<a href="#l1.337"></a><span id="l1.337">       var idx = this.jCal[COMPONENT_INDEX].push(component.jCal);</span>
<a href="#l1.338"></a><span id="l1.338">       this._components[idx - 1] = component;</span>
<a href="#l1.339"></a><span id="l1.339">       this._hydratedComponentCount++;</span>
<a href="#l1.340"></a><span id="l1.340">       component.parent = this;</span>
<a href="#l1.341"></a><span id="l1.341">     },</span>
<a href="#l1.342"></a><span id="l1.342"> </span>
<a href="#l1.343"></a><span id="l1.343">     /**</span>
<a href="#l1.344"></a><span id="l1.344">      * Removes a single component by name or</span>
<a href="#l1.345"></a><span id="l1.345" class="difflineat">@@ -1878,39 +1872,43 @@ ICAL.Component = (function() {</span>
<a href="#l1.346"></a><span id="l1.346">      *</span>
<a href="#l1.347"></a><span id="l1.347">      * @param {ICAL.Property} property object.</span>
<a href="#l1.348"></a><span id="l1.348">      */</span>
<a href="#l1.349"></a><span id="l1.349">     addProperty: function(property) {</span>
<a href="#l1.350"></a><span id="l1.350">       if (!(property instanceof ICAL.Property)) {</span>
<a href="#l1.351"></a><span id="l1.351">         throw new TypeError('must instance of ICAL.Property');</span>
<a href="#l1.352"></a><span id="l1.352">       }</span>
<a href="#l1.353"></a><span id="l1.353"> </span>
<a href="#l1.354"></a><span id="l1.354" class="difflineminus">-      var idx = this.jCal[PROPERTY_INDEX].push(property.jCal);</span>
<a href="#l1.355"></a><span id="l1.355" class="difflineminus">-      property.component = this;</span>
<a href="#l1.356"></a><span id="l1.356" class="difflineminus">-</span>
<a href="#l1.357"></a><span id="l1.357">       if (!this._properties) {</span>
<a href="#l1.358"></a><span id="l1.358">         this._properties = [];</span>
<a href="#l1.359"></a><span id="l1.359">         this._hydratedPropertyCount = 0;</span>
<a href="#l1.360"></a><span id="l1.360">       }</span>
<a href="#l1.361"></a><span id="l1.361"> </span>
<a href="#l1.362"></a><span id="l1.362" class="difflineplus">+</span>
<a href="#l1.363"></a><span id="l1.363" class="difflineplus">+      if (property.parent) {</span>
<a href="#l1.364"></a><span id="l1.364" class="difflineplus">+        property.parent.removeProperty(property);</span>
<a href="#l1.365"></a><span id="l1.365" class="difflineplus">+      }</span>
<a href="#l1.366"></a><span id="l1.366" class="difflineplus">+</span>
<a href="#l1.367"></a><span id="l1.367" class="difflineplus">+      var idx = this.jCal[PROPERTY_INDEX].push(property.jCal);</span>
<a href="#l1.368"></a><span id="l1.368">       this._properties[idx - 1] = property;</span>
<a href="#l1.369"></a><span id="l1.369">       this._hydratedPropertyCount++;</span>
<a href="#l1.370"></a><span id="l1.370" class="difflineplus">+      property.parent = this;</span>
<a href="#l1.371"></a><span id="l1.371">     },</span>
<a href="#l1.372"></a><span id="l1.372"> </span>
<a href="#l1.373"></a><span id="l1.373">     /**</span>
<a href="#l1.374"></a><span id="l1.374">      * Helper method to add a property with a value to the component.</span>
<a href="#l1.375"></a><span id="l1.375">      *</span>
<a href="#l1.376"></a><span id="l1.376">      * @param {String} name property name to add.</span>
<a href="#l1.377"></a><span id="l1.377">      * @param {Object} value property value.</span>
<a href="#l1.378"></a><span id="l1.378">      */</span>
<a href="#l1.379"></a><span id="l1.379">     addPropertyWithValue: function(name, value) {</span>
<a href="#l1.380"></a><span id="l1.380" class="difflineminus">-      var prop = new ICAL.Property(name, this);</span>
<a href="#l1.381"></a><span id="l1.381" class="difflineplus">+      var prop = new ICAL.Property(name);</span>
<a href="#l1.382"></a><span id="l1.382">       prop.setValue(value);</span>
<a href="#l1.383"></a><span id="l1.383"> </span>
<a href="#l1.384"></a><span id="l1.384" class="difflineminus">-      this.addProperty(prop, this);</span>
<a href="#l1.385"></a><span id="l1.385" class="difflineplus">+      this.addProperty(prop);</span>
<a href="#l1.386"></a><span id="l1.386"> </span>
<a href="#l1.387"></a><span id="l1.387">       return prop;</span>
<a href="#l1.388"></a><span id="l1.388">     },</span>
<a href="#l1.389"></a><span id="l1.389"> </span>
<a href="#l1.390"></a><span id="l1.390">     /**</span>
<a href="#l1.391"></a><span id="l1.391">      * Helper method that will update or create a property</span>
<a href="#l1.392"></a><span id="l1.392">      * of the given name and sets its value.</span>
<a href="#l1.393"></a><span id="l1.393">      *</span>
<a href="#l1.394"></a><span id="l1.394" class="difflineat">@@ -1988,19 +1986,19 @@ ICAL.Property = (function() {</span>
<a href="#l1.395"></a><span id="l1.395">    *</span>
<a href="#l1.396"></a><span id="l1.396">    * Can also be used to create new properties by passing</span>
<a href="#l1.397"></a><span id="l1.397">    * the name of the property (as a String).</span>
<a href="#l1.398"></a><span id="l1.398">    *</span>
<a href="#l1.399"></a><span id="l1.399">    *</span>
<a href="#l1.400"></a><span id="l1.400">    * @param {Array|String} jCal raw jCal representation OR</span>
<a href="#l1.401"></a><span id="l1.401">    *  the new name of the property (when creating).</span>
<a href="#l1.402"></a><span id="l1.402">    *</span>
<a href="#l1.403"></a><span id="l1.403" class="difflineminus">-   * @param {ICAL.Component} [component] parent component.</span>
<a href="#l1.404"></a><span id="l1.404" class="difflineplus">+   * @param {ICAL.Component} [parent] parent component.</span>
<a href="#l1.405"></a><span id="l1.405">    */</span>
<a href="#l1.406"></a><span id="l1.406" class="difflineminus">-  function Property(jCal, component) {</span>
<a href="#l1.407"></a><span id="l1.407" class="difflineplus">+  function Property(jCal, parent) {</span>
<a href="#l1.408"></a><span id="l1.408">     if (typeof(jCal) === 'string') {</span>
<a href="#l1.409"></a><span id="l1.409">       // because we a creating by name we need</span>
<a href="#l1.410"></a><span id="l1.410">       // to find the type when creating the property.</span>
<a href="#l1.411"></a><span id="l1.411">       var name = jCal;</span>
<a href="#l1.412"></a><span id="l1.412"> </span>
<a href="#l1.413"></a><span id="l1.413">       if (name in design.property) {</span>
<a href="#l1.414"></a><span id="l1.414">         var prop = design.property[name];</span>
<a href="#l1.415"></a><span id="l1.415">         if ('defaultType' in prop) {</span>
<a href="#l1.416"></a><span id="l1.416" class="difflineat">@@ -2011,17 +2009,17 @@ ICAL.Property = (function() {</span>
<a href="#l1.417"></a><span id="l1.417">       } else {</span>
<a href="#l1.418"></a><span id="l1.418">         var type = design.defaultType;</span>
<a href="#l1.419"></a><span id="l1.419">       }</span>
<a href="#l1.420"></a><span id="l1.420"> </span>
<a href="#l1.421"></a><span id="l1.421">       jCal = [name, {}, type];</span>
<a href="#l1.422"></a><span id="l1.422">     }</span>
<a href="#l1.423"></a><span id="l1.423"> </span>
<a href="#l1.424"></a><span id="l1.424">     this.jCal = jCal;</span>
<a href="#l1.425"></a><span id="l1.425" class="difflineminus">-    this.component = component;</span>
<a href="#l1.426"></a><span id="l1.426" class="difflineplus">+    this.parent = parent || null;</span>
<a href="#l1.427"></a><span id="l1.427">     this._updateType();</span>
<a href="#l1.428"></a><span id="l1.428">   }</span>
<a href="#l1.429"></a><span id="l1.429"> </span>
<a href="#l1.430"></a><span id="l1.430">   Property.prototype = {</span>
<a href="#l1.431"></a><span id="l1.431">     get type() {</span>
<a href="#l1.432"></a><span id="l1.432">       return this.jCal[TYPE_INDEX];</span>
<a href="#l1.433"></a><span id="l1.433">     },</span>
<a href="#l1.434"></a><span id="l1.434"> </span>
<a href="#l1.435"></a><span id="l1.435" class="difflineat">@@ -2226,17 +2224,18 @@ ICAL.Property = (function() {</span>
<a href="#l1.436"></a><span id="l1.436">       } else {</span>
<a href="#l1.437"></a><span id="l1.437">         for (; i &lt; len; i++) {</span>
<a href="#l1.438"></a><span id="l1.438">           this.jCal[VALUE_INDEX + i] = values[i];</span>
<a href="#l1.439"></a><span id="l1.439">         }</span>
<a href="#l1.440"></a><span id="l1.440">       }</span>
<a href="#l1.441"></a><span id="l1.441">     },</span>
<a href="#l1.442"></a><span id="l1.442"> </span>
<a href="#l1.443"></a><span id="l1.443">     /**</span>
<a href="#l1.444"></a><span id="l1.444" class="difflineminus">-     * Sets the current value of the property.</span>
<a href="#l1.445"></a><span id="l1.445" class="difflineplus">+     * Sets the current value of the property. If this is a multi-value</span>
<a href="#l1.446"></a><span id="l1.446" class="difflineplus">+     * property, all other values will be removed.</span>
<a href="#l1.447"></a><span id="l1.447">      *</span>
<a href="#l1.448"></a><span id="l1.448">      * @param {String|Object} value new prop value.</span>
<a href="#l1.449"></a><span id="l1.449">      */</span>
<a href="#l1.450"></a><span id="l1.450">     setValue: function(value) {</span>
<a href="#l1.451"></a><span id="l1.451">       this.removeAllValues();</span>
<a href="#l1.452"></a><span id="l1.452">       if (typeof(value) === 'object' &amp;&amp; 'icaltype' in value) {</span>
<a href="#l1.453"></a><span id="l1.453">         this.resetType(value.icaltype);</span>
<a href="#l1.454"></a><span id="l1.454">       }</span>
<a href="#l1.455"></a><span id="l1.455" class="difflineat">@@ -2457,17 +2456,17 @@ ICAL.Binary = (function() {</span>
<a href="#l1.456"></a><span id="l1.456"> </span>
<a href="#l1.457"></a><span id="l1.457">     if (aData &amp;&amp; 'start' in aData) {</span>
<a href="#l1.458"></a><span id="l1.458">       if (aData.start &amp;&amp; !(aData.start instanceof ICAL.Time)) {</span>
<a href="#l1.459"></a><span id="l1.459">         throw new TypeError('.start must be an instance of ICAL.Time');</span>
<a href="#l1.460"></a><span id="l1.460">       }</span>
<a href="#l1.461"></a><span id="l1.461">       this.start = aData.start;</span>
<a href="#l1.462"></a><span id="l1.462">     }</span>
<a href="#l1.463"></a><span id="l1.463"> </span>
<a href="#l1.464"></a><span id="l1.464" class="difflineminus">-    if (aData &amp;&amp; ('end' in aData) &amp;&amp; ('duration' in aData)) {</span>
<a href="#l1.465"></a><span id="l1.465" class="difflineplus">+    if (aData &amp;&amp; aData.end &amp;&amp; aData.duration) {</span>
<a href="#l1.466"></a><span id="l1.466">       throw new Error('cannot accept both end and duration');</span>
<a href="#l1.467"></a><span id="l1.467">     }</span>
<a href="#l1.468"></a><span id="l1.468"> </span>
<a href="#l1.469"></a><span id="l1.469">     if (aData &amp;&amp; 'end' in aData) {</span>
<a href="#l1.470"></a><span id="l1.470">       if (aData.end &amp;&amp; !(aData.end instanceof ICAL.Time)) {</span>
<a href="#l1.471"></a><span id="l1.471">         throw new TypeError('.end must be an instance of ICAL.Time');</span>
<a href="#l1.472"></a><span id="l1.472">       }</span>
<a href="#l1.473"></a><span id="l1.473">       this.end = aData.end;</span>
<a href="#l1.474"></a><span id="l1.474" class="difflineat">@@ -2484,16 +2483,24 @@ ICAL.Binary = (function() {</span>
<a href="#l1.475"></a><span id="l1.475">   ICAL.Period.prototype = {</span>
<a href="#l1.476"></a><span id="l1.476"> </span>
<a href="#l1.477"></a><span id="l1.477">     start: null,</span>
<a href="#l1.478"></a><span id="l1.478">     end: null,</span>
<a href="#l1.479"></a><span id="l1.479">     duration: null,</span>
<a href="#l1.480"></a><span id="l1.480">     icalclass: &quot;icalperiod&quot;,</span>
<a href="#l1.481"></a><span id="l1.481">     icaltype: &quot;period&quot;,</span>
<a href="#l1.482"></a><span id="l1.482"> </span>
<a href="#l1.483"></a><span id="l1.483" class="difflineplus">+    clone: function() {</span>
<a href="#l1.484"></a><span id="l1.484" class="difflineplus">+      return ICAL.Period.fromData({</span>
<a href="#l1.485"></a><span id="l1.485" class="difflineplus">+        start: this.start ? this.start.clone() : null,</span>
<a href="#l1.486"></a><span id="l1.486" class="difflineplus">+        end: this.end ? this.end.clone() : null,</span>
<a href="#l1.487"></a><span id="l1.487" class="difflineplus">+        duration: this.duration ? this.duration.clone() : null</span>
<a href="#l1.488"></a><span id="l1.488" class="difflineplus">+      });</span>
<a href="#l1.489"></a><span id="l1.489" class="difflineplus">+    },</span>
<a href="#l1.490"></a><span id="l1.490" class="difflineplus">+</span>
<a href="#l1.491"></a><span id="l1.491">     getDuration: function duration() {</span>
<a href="#l1.492"></a><span id="l1.492">       if (this.duration) {</span>
<a href="#l1.493"></a><span id="l1.493">         return this.duration;</span>
<a href="#l1.494"></a><span id="l1.494">       } else {</span>
<a href="#l1.495"></a><span id="l1.495">         return this.end.subtractDate(this.start);</span>
<a href="#l1.496"></a><span id="l1.496">       }</span>
<a href="#l1.497"></a><span id="l1.497">     },</span>
<a href="#l1.498"></a><span id="l1.498"> </span>
<a href="#l1.499"></a><span id="l1.499" class="difflineat">@@ -3288,17 +3295,21 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.500"></a><span id="l1.500">     time.isDate = false;</span>
<a href="#l1.501"></a><span id="l1.501"> </span>
<a href="#l1.502"></a><span id="l1.502">     this.fromData(data, zone);</span>
<a href="#l1.503"></a><span id="l1.503">   };</span>
<a href="#l1.504"></a><span id="l1.504"> </span>
<a href="#l1.505"></a><span id="l1.505">   ICAL.Time.prototype = {</span>
<a href="#l1.506"></a><span id="l1.506"> </span>
<a href="#l1.507"></a><span id="l1.507">     icalclass: &quot;icaltime&quot;,</span>
<a href="#l1.508"></a><span id="l1.508" class="difflineminus">-    icaltype: &quot;date-time&quot;,</span>
<a href="#l1.509"></a><span id="l1.509" class="difflineplus">+</span>
<a href="#l1.510"></a><span id="l1.510" class="difflineplus">+    // is read only strictly defined by isDate</span>
<a href="#l1.511"></a><span id="l1.511" class="difflineplus">+    get icaltype() {</span>
<a href="#l1.512"></a><span id="l1.512" class="difflineplus">+      return this.isDate ? 'date' : 'date-time';</span>
<a href="#l1.513"></a><span id="l1.513" class="difflineplus">+    },</span>
<a href="#l1.514"></a><span id="l1.514"> </span>
<a href="#l1.515"></a><span id="l1.515">     /**</span>
<a href="#l1.516"></a><span id="l1.516">      * @type ICAL.Timezone</span>
<a href="#l1.517"></a><span id="l1.517">      */</span>
<a href="#l1.518"></a><span id="l1.518">     zone: null,</span>
<a href="#l1.519"></a><span id="l1.519"> </span>
<a href="#l1.520"></a><span id="l1.520">     /**</span>
<a href="#l1.521"></a><span id="l1.521">      * Internal uses to indicate that a change has been</span>
<a href="#l1.522"></a><span id="l1.522" class="difflineat">@@ -3366,31 +3377,31 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.523"></a><span id="l1.523">           this.second = aDate.getSeconds();</span>
<a href="#l1.524"></a><span id="l1.524">         }</span>
<a href="#l1.525"></a><span id="l1.525">       }</span>
<a href="#l1.526"></a><span id="l1.526">       return this;</span>
<a href="#l1.527"></a><span id="l1.527">     },</span>
<a href="#l1.528"></a><span id="l1.528"> </span>
<a href="#l1.529"></a><span id="l1.529">     fromData: function fromData(aData, aZone) {</span>
<a href="#l1.530"></a><span id="l1.530">       for (var key in aData) {</span>
<a href="#l1.531"></a><span id="l1.531" class="difflineplus">+        // ical type cannot be set</span>
<a href="#l1.532"></a><span id="l1.532" class="difflineplus">+        if (key === 'icaltype') continue;</span>
<a href="#l1.533"></a><span id="l1.533">         this[key] = aData[key];</span>
<a href="#l1.534"></a><span id="l1.534">       }</span>
<a href="#l1.535"></a><span id="l1.535"> </span>
<a href="#l1.536"></a><span id="l1.536">       if (aZone) {</span>
<a href="#l1.537"></a><span id="l1.537">         this.zone = aZone;</span>
<a href="#l1.538"></a><span id="l1.538">       }</span>
<a href="#l1.539"></a><span id="l1.539"> </span>
<a href="#l1.540"></a><span id="l1.540">       if (aData &amp;&amp; !(&quot;isDate&quot; in aData)) {</span>
<a href="#l1.541"></a><span id="l1.541">         this.isDate = !(&quot;hour&quot; in aData);</span>
<a href="#l1.542"></a><span id="l1.542">       } else if (aData &amp;&amp; (&quot;isDate&quot; in aData)) {</span>
<a href="#l1.543"></a><span id="l1.543">         this.isDate = aData.isDate;</span>
<a href="#l1.544"></a><span id="l1.544">       }</span>
<a href="#l1.545"></a><span id="l1.545"> </span>
<a href="#l1.546"></a><span id="l1.546" class="difflineminus">-      this.icaltype = (this.isDate ? &quot;date&quot; : &quot;date-time&quot;);</span>
<a href="#l1.547"></a><span id="l1.547" class="difflineminus">-</span>
<a href="#l1.548"></a><span id="l1.548">       if (aData &amp;&amp; &quot;timezone&quot; in aData) {</span>
<a href="#l1.549"></a><span id="l1.549">         var zone = ICAL.TimezoneService.get(</span>
<a href="#l1.550"></a><span id="l1.550">           aData.timezone</span>
<a href="#l1.551"></a><span id="l1.551">         );</span>
<a href="#l1.552"></a><span id="l1.552"> </span>
<a href="#l1.553"></a><span id="l1.553">         this.zone = zone || ICAL.Timezone.localTimezone;</span>
<a href="#l1.554"></a><span id="l1.554">       }</span>
<a href="#l1.555"></a><span id="l1.555"> </span>
<a href="#l1.556"></a><span id="l1.556" class="difflineat">@@ -3779,17 +3790,16 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.557"></a><span id="l1.557"> </span>
<a href="#l1.558"></a><span id="l1.558">     _normalize: function icaltime_normalize() {</span>
<a href="#l1.559"></a><span id="l1.559">       var isDate = this._time.isDate;</span>
<a href="#l1.560"></a><span id="l1.560">       if (this._time.isDate) {</span>
<a href="#l1.561"></a><span id="l1.561">         this._time.hour = 0;</span>
<a href="#l1.562"></a><span id="l1.562">         this._time.minute = 0;</span>
<a href="#l1.563"></a><span id="l1.563">         this._time.second = 0;</span>
<a href="#l1.564"></a><span id="l1.564">       }</span>
<a href="#l1.565"></a><span id="l1.565" class="difflineminus">-      this.icaltype = (isDate ? &quot;date&quot; : &quot;date-time&quot;);</span>
<a href="#l1.566"></a><span id="l1.566">       this.adjust(0, 0, 0, 0);</span>
<a href="#l1.567"></a><span id="l1.567"> </span>
<a href="#l1.568"></a><span id="l1.568">       return this;</span>
<a href="#l1.569"></a><span id="l1.569">     },</span>
<a href="#l1.570"></a><span id="l1.570"> </span>
<a href="#l1.571"></a><span id="l1.571">     adjust: function icaltime_adjust(aExtraDays, aExtraHours,</span>
<a href="#l1.572"></a><span id="l1.572">                                      aExtraMinutes, aExtraSeconds, aTime) {</span>
<a href="#l1.573"></a><span id="l1.573"> </span>
<a href="#l1.574"></a><span id="l1.574" class="difflineat">@@ -4437,17 +4447,17 @@ ICAL.TimezoneService = (function() {</span>
<a href="#l1.575"></a><span id="l1.575">     BYYEARDAY: parseNumericValue.bind(this, 'BYYEARDAY', -366, 366),</span>
<a href="#l1.576"></a><span id="l1.576">     BYWEEKNO: parseNumericValue.bind(this, 'BYWEEKNO', -53, 53),</span>
<a href="#l1.577"></a><span id="l1.577">     BYMONTH: parseNumericValue.bind(this, 'BYMONTH', 0, 12),</span>
<a href="#l1.578"></a><span id="l1.578">     BYSETPOS: parseNumericValue.bind(this, 'BYSETPOS', -366, 366)</span>
<a href="#l1.579"></a><span id="l1.579">   };</span>
<a href="#l1.580"></a><span id="l1.580"> </span>
<a href="#l1.581"></a><span id="l1.581">   ICAL.Recur.fromString = function(string) {</span>
<a href="#l1.582"></a><span id="l1.582">     var dict = Object.create(null);</span>
<a href="#l1.583"></a><span id="l1.583" class="difflineminus">-    var dictParts = dict.parts = {};</span>
<a href="#l1.584"></a><span id="l1.584" class="difflineplus">+    var dictParts = dict.parts = Object.create(null);</span>
<a href="#l1.585"></a><span id="l1.585"> </span>
<a href="#l1.586"></a><span id="l1.586">     // split is slower in FF but fast enough.</span>
<a href="#l1.587"></a><span id="l1.587">     // v8 however this is faster then manual split?</span>
<a href="#l1.588"></a><span id="l1.588">     var values = string.split(';');</span>
<a href="#l1.589"></a><span id="l1.589">     var len = values.length;</span>
<a href="#l1.590"></a><span id="l1.590"> </span>
<a href="#l1.591"></a><span id="l1.591">     for (var i = 0; i &lt; len; i++) {</span>
<a href="#l1.592"></a><span id="l1.592">       var parts = values[i].split('=');</span>
<a href="#l1.593"></a><span id="l1.593" class="difflineat">@@ -4877,129 +4887,137 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.594"></a><span id="l1.594">         // only add unique items...</span>
<a href="#l1.595"></a><span id="l1.595">         if (newRules.indexOf(rule) === -1) {</span>
<a href="#l1.596"></a><span id="l1.596">           newRules.push(rule);</span>
<a href="#l1.597"></a><span id="l1.597">         }</span>
<a href="#l1.598"></a><span id="l1.598"> </span>
<a href="#l1.599"></a><span id="l1.599">       }</span>
<a href="#l1.600"></a><span id="l1.600"> </span>
<a href="#l1.601"></a><span id="l1.601">       // unique and sort</span>
<a href="#l1.602"></a><span id="l1.602" class="difflineminus">-      return newRules.sort();</span>
<a href="#l1.603"></a><span id="l1.603" class="difflineplus">+      return newRules.sort(function(a,b){return a - b});</span>
<a href="#l1.604"></a><span id="l1.604">     },</span>
<a href="#l1.605"></a><span id="l1.605"> </span>
<a href="#l1.606"></a><span id="l1.606">     /**</span>
<a href="#l1.607"></a><span id="l1.607">      * NOTES:</span>
<a href="#l1.608"></a><span id="l1.608">      * We are given a list of dates in the month (BYMONTHDAY) (23, etc..)</span>
<a href="#l1.609"></a><span id="l1.609">      * Also we are given a list of days (BYDAY) (MO, 2SU, etc..) when</span>
<a href="#l1.610"></a><span id="l1.610">      * both conditions match a given date (this.last.day) iteration stops.</span>
<a href="#l1.611"></a><span id="l1.611">      *</span>
<a href="#l1.612"></a><span id="l1.612">      * @param {Boolean} [isInit] when given true will not</span>
<a href="#l1.613"></a><span id="l1.613">      *                           increment the current day (this.last).</span>
<a href="#l1.614"></a><span id="l1.614">      */</span>
<a href="#l1.615"></a><span id="l1.615">     _byDayAndMonthDay: function(isInit) {</span>
<a href="#l1.616"></a><span id="l1.616" class="difflineminus">-     var byMonthDay; // setup in initMonth</span>
<a href="#l1.617"></a><span id="l1.617" class="difflineplus">+      var byMonthDay; // setup in initMonth</span>
<a href="#l1.618"></a><span id="l1.618">       var byDay = this.by_data.BYDAY;</span>
<a href="#l1.619"></a><span id="l1.619"> </span>
<a href="#l1.620"></a><span id="l1.620">       var date;</span>
<a href="#l1.621"></a><span id="l1.621">       var dateIdx = 0;</span>
<a href="#l1.622"></a><span id="l1.622">       var dateLen; // setup in initMonth</span>
<a href="#l1.623"></a><span id="l1.623" class="difflineminus">-      var dayIdx = 0;</span>
<a href="#l1.624"></a><span id="l1.624">       var dayLen = byDay.length;</span>
<a href="#l1.625"></a><span id="l1.625"> </span>
<a href="#l1.626"></a><span id="l1.626">       // we are not valid by default</span>
<a href="#l1.627"></a><span id="l1.627">       var dataIsValid = 0;</span>
<a href="#l1.628"></a><span id="l1.628"> </span>
<a href="#l1.629"></a><span id="l1.629">       var daysInMonth;</span>
<a href="#l1.630"></a><span id="l1.630">       var self = this;</span>
<a href="#l1.631"></a><span id="l1.631" class="difflineplus">+      // we need a copy of this, because a DateTime gets normalized</span>
<a href="#l1.632"></a><span id="l1.632" class="difflineplus">+      // automatically if the day is out of range. At some points we </span>
<a href="#l1.633"></a><span id="l1.633" class="difflineplus">+      // set the last day to 0 to start counting.</span>
<a href="#l1.634"></a><span id="l1.634" class="difflineplus">+      var lastDay = this.last.day;</span>
<a href="#l1.635"></a><span id="l1.635"> </span>
<a href="#l1.636"></a><span id="l1.636">       function initMonth() {</span>
<a href="#l1.637"></a><span id="l1.637">         daysInMonth = ICAL.Time.daysInMonth(</span>
<a href="#l1.638"></a><span id="l1.638">           self.last.month, self.last.year</span>
<a href="#l1.639"></a><span id="l1.639">         );</span>
<a href="#l1.640"></a><span id="l1.640"> </span>
<a href="#l1.641"></a><span id="l1.641">         byMonthDay = self.normalizeByMonthDayRules(</span>
<a href="#l1.642"></a><span id="l1.642">           self.last.year,</span>
<a href="#l1.643"></a><span id="l1.643">           self.last.month,</span>
<a href="#l1.644"></a><span id="l1.644">           self.by_data.BYMONTHDAY</span>
<a href="#l1.645"></a><span id="l1.645">         );</span>
<a href="#l1.646"></a><span id="l1.646"> </span>
<a href="#l1.647"></a><span id="l1.647">         dateLen = byMonthDay.length;</span>
<a href="#l1.648"></a><span id="l1.648" class="difflineplus">+</span>
<a href="#l1.649"></a><span id="l1.649" class="difflineplus">+        // For the case of more than one occurrence in one month</span>
<a href="#l1.650"></a><span id="l1.650" class="difflineplus">+        // we have to be sure to start searching after the last</span>
<a href="#l1.651"></a><span id="l1.651" class="difflineplus">+        // found date or at the last BYMONTHDAY.</span>
<a href="#l1.652"></a><span id="l1.652" class="difflineplus">+        while (byMonthDay[dateIdx] &lt;= lastDay &amp;&amp; dateIdx &lt; dateLen - 1) {</span>
<a href="#l1.653"></a><span id="l1.653" class="difflineplus">+          dateIdx++;</span>
<a href="#l1.654"></a><span id="l1.654" class="difflineplus">+        }</span>
<a href="#l1.655"></a><span id="l1.655">       }</span>
<a href="#l1.656"></a><span id="l1.656"> </span>
<a href="#l1.657"></a><span id="l1.657">       function nextMonth() {</span>
<a href="#l1.658"></a><span id="l1.658" class="difflineminus">-        self.last.day = 1;</span>
<a href="#l1.659"></a><span id="l1.659" class="difflineplus">+        // since the day is incremented at the start</span>
<a href="#l1.660"></a><span id="l1.660" class="difflineplus">+        // of the loop below, we need to start at 0</span>
<a href="#l1.661"></a><span id="l1.661" class="difflineplus">+        lastDay = 0;</span>
<a href="#l1.662"></a><span id="l1.662">         self.increment_month();</span>
<a href="#l1.663"></a><span id="l1.663" class="difflineplus">+        dateIdx = 0;</span>
<a href="#l1.664"></a><span id="l1.664">         initMonth();</span>
<a href="#l1.665"></a><span id="l1.665" class="difflineminus">-</span>
<a href="#l1.666"></a><span id="l1.666" class="difflineminus">-        dateIdx = 0;</span>
<a href="#l1.667"></a><span id="l1.667" class="difflineminus">-        dayIdx = 0;</span>
<a href="#l1.668"></a><span id="l1.668">       }</span>
<a href="#l1.669"></a><span id="l1.669"> </span>
<a href="#l1.670"></a><span id="l1.670">       initMonth();</span>
<a href="#l1.671"></a><span id="l1.671"> </span>
<a href="#l1.672"></a><span id="l1.672">       // should come after initMonth</span>
<a href="#l1.673"></a><span id="l1.673">       if (isInit) {</span>
<a href="#l1.674"></a><span id="l1.674" class="difflineminus">-        this.last.day -= 1;</span>
<a href="#l1.675"></a><span id="l1.675" class="difflineplus">+        lastDay -= 1;</span>
<a href="#l1.676"></a><span id="l1.676">       }</span>
<a href="#l1.677"></a><span id="l1.677"> </span>
<a href="#l1.678"></a><span id="l1.678">       while (!dataIsValid) {</span>
<a href="#l1.679"></a><span id="l1.679" class="difflineminus">-        // find next date</span>
<a href="#l1.680"></a><span id="l1.680" class="difflineminus">-        var next = byMonthDay[dateIdx++];</span>
<a href="#l1.681"></a><span id="l1.681" class="difflineminus">-</span>
<a href="#l1.682"></a><span id="l1.682">         // increment the current date. This is really</span>
<a href="#l1.683"></a><span id="l1.683">         // important otherwise we may fall into the infinite</span>
<a href="#l1.684"></a><span id="l1.684">         // loop trap. The initial date takes care of the case</span>
<a href="#l1.685"></a><span id="l1.685">         // where the current date is the date we are looking</span>
<a href="#l1.686"></a><span id="l1.686">         // for.</span>
<a href="#l1.687"></a><span id="l1.687" class="difflineminus">-        date = this.last.day + 1;</span>
<a href="#l1.688"></a><span id="l1.688" class="difflineplus">+        date = lastDay + 1;</span>
<a href="#l1.689"></a><span id="l1.689"> </span>
<a href="#l1.690"></a><span id="l1.690">         if (date &gt; daysInMonth) {</span>
<a href="#l1.691"></a><span id="l1.691">           nextMonth();</span>
<a href="#l1.692"></a><span id="l1.692">           continue;</span>
<a href="#l1.693"></a><span id="l1.693">         }</span>
<a href="#l1.694"></a><span id="l1.694"> </span>
<a href="#l1.695"></a><span id="l1.695" class="difflineminus">-        // after verify that the next date</span>
<a href="#l1.696"></a><span id="l1.696" class="difflineminus">-        // is in the current month we can increment</span>
<a href="#l1.697"></a><span id="l1.697" class="difflineminus">-        // it permanently.</span>
<a href="#l1.698"></a><span id="l1.698" class="difflineminus">-        this.last.day = date;</span>
<a href="#l1.699"></a><span id="l1.699" class="difflineplus">+        // find next date</span>
<a href="#l1.700"></a><span id="l1.700" class="difflineplus">+        var next = byMonthDay[dateIdx++];</span>
<a href="#l1.701"></a><span id="l1.701"> </span>
<a href="#l1.702"></a><span id="l1.702">         // this logic is dependant on the BYMONTHDAYS</span>
<a href="#l1.703"></a><span id="l1.703">         // being in order (which is done by #normalizeByMonthDayRules)</span>
<a href="#l1.704"></a><span id="l1.704" class="difflineminus">-        if (next &gt;= this.last.day) {</span>
<a href="#l1.705"></a><span id="l1.705" class="difflineplus">+        if (next &gt;= date) {</span>
<a href="#l1.706"></a><span id="l1.706">           // if the next month day is in the future jump to it.</span>
<a href="#l1.707"></a><span id="l1.707" class="difflineminus">-          this.last.day = next;</span>
<a href="#l1.708"></a><span id="l1.708" class="difflineplus">+          lastDay = next;</span>
<a href="#l1.709"></a><span id="l1.709">         } else {</span>
<a href="#l1.710"></a><span id="l1.710">           // in this case the 'next' monthday has past</span>
<a href="#l1.711"></a><span id="l1.711">           // we must move to the month.</span>
<a href="#l1.712"></a><span id="l1.712">           nextMonth();</span>
<a href="#l1.713"></a><span id="l1.713">           continue;</span>
<a href="#l1.714"></a><span id="l1.714">         }</span>
<a href="#l1.715"></a><span id="l1.715"> </span>
<a href="#l1.716"></a><span id="l1.716">         // Now we can loop through the day rules to see</span>
<a href="#l1.717"></a><span id="l1.717">         // if one matches the current month date.</span>
<a href="#l1.718"></a><span id="l1.718" class="difflineminus">-        for (dayIdx = 0; dayIdx &lt; dayLen; dayIdx++) {</span>
<a href="#l1.719"></a><span id="l1.719" class="difflineplus">+        for (var dayIdx = 0; dayIdx &lt; dayLen; dayIdx++) {</span>
<a href="#l1.720"></a><span id="l1.720">           var parts = this.ruleDayOfWeek(byDay[dayIdx]);</span>
<a href="#l1.721"></a><span id="l1.721">           var pos = parts[0];</span>
<a href="#l1.722"></a><span id="l1.722">           var dow = parts[1];</span>
<a href="#l1.723"></a><span id="l1.723"> </span>
<a href="#l1.724"></a><span id="l1.724" class="difflineplus">+          this.last.day = lastDay;</span>
<a href="#l1.725"></a><span id="l1.725">           if (this.last.isNthWeekDay(dow, pos)) {</span>
<a href="#l1.726"></a><span id="l1.726">             // when we find the valid one we can mark</span>
<a href="#l1.727"></a><span id="l1.727">             // the conditions as met and break the loop.</span>
<a href="#l1.728"></a><span id="l1.728">             // (Because we have this condition above</span>
<a href="#l1.729"></a><span id="l1.729">             //  it will also break the parent loop).</span>
<a href="#l1.730"></a><span id="l1.730">             dataIsValid = 1;</span>
<a href="#l1.731"></a><span id="l1.731">             break;</span>
<a href="#l1.732"></a><span id="l1.732">           }</span>
<a href="#l1.733"></a><span id="l1.733">         }</span>
<a href="#l1.734"></a><span id="l1.734"> </span>
<a href="#l1.735"></a><span id="l1.735">         // Its completely possible that the combination</span>
<a href="#l1.736"></a><span id="l1.736">         // cannot be matched in the current month.</span>
<a href="#l1.737"></a><span id="l1.737">         // When we reach the end of possible combinations</span>
<a href="#l1.738"></a><span id="l1.738">         // in the current month we iterate to the next one.</span>
<a href="#l1.739"></a><span id="l1.739" class="difflineminus">-        if (!dataIsValid &amp;&amp; dateIdx === (dateLen - 1)) {</span>
<a href="#l1.740"></a><span id="l1.740" class="difflineplus">+        // since dateIdx is incremented right after getting</span>
<a href="#l1.741"></a><span id="l1.741" class="difflineplus">+        // &quot;next&quot;, we don't need dateLen -1 here.</span>
<a href="#l1.742"></a><span id="l1.742" class="difflineplus">+        if (!dataIsValid &amp;&amp; dateIdx === dateLen) {</span>
<a href="#l1.743"></a><span id="l1.743">           nextMonth();</span>
<a href="#l1.744"></a><span id="l1.744">           continue;</span>
<a href="#l1.745"></a><span id="l1.745">         }</span>
<a href="#l1.746"></a><span id="l1.746">       }</span>
<a href="#l1.747"></a><span id="l1.747"> </span>
<a href="#l1.748"></a><span id="l1.748">       return dataIsValid;</span>
<a href="#l1.749"></a><span id="l1.749">     },</span>
<a href="#l1.750"></a><span id="l1.750"> </span>
<a href="#l1.751"></a><span id="l1.751" class="difflineat">@@ -5068,19 +5086,20 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.752"></a><span id="l1.752"> </span>
<a href="#l1.753"></a><span id="l1.753">         if (day &lt; 0) {</span>
<a href="#l1.754"></a><span id="l1.754">           day = daysInMonth + day + 1;</span>
<a href="#l1.755"></a><span id="l1.755">         }</span>
<a href="#l1.756"></a><span id="l1.756"> </span>
<a href="#l1.757"></a><span id="l1.757">         if (day &gt; daysInMonth) {</span>
<a href="#l1.758"></a><span id="l1.758">           this.last.day = 1;</span>
<a href="#l1.759"></a><span id="l1.759">           data_valid = this.is_day_in_byday(this.last);</span>
<a href="#l1.760"></a><span id="l1.760" class="difflineplus">+        } else {</span>
<a href="#l1.761"></a><span id="l1.761" class="difflineplus">+          this.last.day = day;</span>
<a href="#l1.762"></a><span id="l1.762">         }</span>
<a href="#l1.763"></a><span id="l1.763"> </span>
<a href="#l1.764"></a><span id="l1.764" class="difflineminus">-        this.last.day = day;</span>
<a href="#l1.765"></a><span id="l1.765">       } else {</span>
<a href="#l1.766"></a><span id="l1.766">         this.last.day = this.by_data.BYMONTHDAY[0];</span>
<a href="#l1.767"></a><span id="l1.767">         this.increment_month();</span>
<a href="#l1.768"></a><span id="l1.768">         var daysInMonth = ICAL.Time.daysInMonth(this.last.month, this.last.year);</span>
<a href="#l1.769"></a><span id="l1.769">         this.last.day = Math.min(this.last.day, daysInMonth);</span>
<a href="#l1.770"></a><span id="l1.770">       }</span>
<a href="#l1.771"></a><span id="l1.771"> </span>
<a href="#l1.772"></a><span id="l1.772">       return data_valid;</span>
<a href="#l1.773"></a><span id="l1.773" class="difflineat">@@ -5096,17 +5115,17 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.774"></a><span id="l1.774">       if (!this.has_by_data(&quot;BYDAY&quot;)) {</span>
<a href="#l1.775"></a><span id="l1.775">         return 1;</span>
<a href="#l1.776"></a><span id="l1.776">       }</span>
<a href="#l1.777"></a><span id="l1.777"> </span>
<a href="#l1.778"></a><span id="l1.778">       for (;;) {</span>
<a href="#l1.779"></a><span id="l1.779">         var tt = new ICAL.Time();</span>
<a href="#l1.780"></a><span id="l1.780">         this.by_indices.BYDAY++;</span>
<a href="#l1.781"></a><span id="l1.781"> </span>
<a href="#l1.782"></a><span id="l1.782" class="difflineminus">-        if (this.by_indices.BYDAY == this.by_data.BYDAY.length) {</span>
<a href="#l1.783"></a><span id="l1.783" class="difflineplus">+        if (this.by_indices.BYDAY == Object.keys(this.by_data.BYDAY).length) {</span>
<a href="#l1.784"></a><span id="l1.784">           this.by_indices.BYDAY = 0;</span>
<a href="#l1.785"></a><span id="l1.785">           end_of_data = 1;</span>
<a href="#l1.786"></a><span id="l1.786">         }</span>
<a href="#l1.787"></a><span id="l1.787"> </span>
<a href="#l1.788"></a><span id="l1.788">         var coded_day = this.by_data.BYDAY[this.by_indices.BYDAY];</span>
<a href="#l1.789"></a><span id="l1.789">         var parts = this.ruleDayOfWeek(coded_day);</span>
<a href="#l1.790"></a><span id="l1.790">         var dow = parts[1];</span>
<a href="#l1.791"></a><span id="l1.791"> </span>
<a href="#l1.792"></a><span id="l1.792" class="difflineat">@@ -5218,27 +5237,27 @@ ICAL.RecurIterator = (function() {</span>
<a href="#l1.793"></a><span id="l1.793">         if (this.last.day &gt; daysInMonth) {</span>
<a href="#l1.794"></a><span id="l1.794">           this.last.day -= daysInMonth;</span>
<a href="#l1.795"></a><span id="l1.795">           this.increment_month();</span>
<a href="#l1.796"></a><span id="l1.796">         }</span>
<a href="#l1.797"></a><span id="l1.797">       }</span>
<a href="#l1.798"></a><span id="l1.798">     },</span>
<a href="#l1.799"></a><span id="l1.799"> </span>
<a href="#l1.800"></a><span id="l1.800">     increment_month: function increment_month() {</span>
<a href="#l1.801"></a><span id="l1.801" class="difflineplus">+      this.last.day = 1;</span>
<a href="#l1.802"></a><span id="l1.802">       if (this.has_by_data(&quot;BYMONTH&quot;)) {</span>
<a href="#l1.803"></a><span id="l1.803">         this.by_indices.BYMONTH++;</span>
<a href="#l1.804"></a><span id="l1.804"> </span>
<a href="#l1.805"></a><span id="l1.805">         if (this.by_indices.BYMONTH == this.by_data.BYMONTH.length) {</span>
<a href="#l1.806"></a><span id="l1.806">           this.by_indices.BYMONTH = 0;</span>
<a href="#l1.807"></a><span id="l1.807">           this.increment_year(1);</span>
<a href="#l1.808"></a><span id="l1.808">         }</span>
<a href="#l1.809"></a><span id="l1.809"> </span>
<a href="#l1.810"></a><span id="l1.810">         this.last.month = this.by_data.BYMONTH[this.by_indices.BYMONTH];</span>
<a href="#l1.811"></a><span id="l1.811">       } else {</span>
<a href="#l1.812"></a><span id="l1.812" class="difflineminus">-        var inc;</span>
<a href="#l1.813"></a><span id="l1.813">         if (this.rule.freq == &quot;MONTHLY&quot;) {</span>
<a href="#l1.814"></a><span id="l1.814">           this.last.month += this.rule.interval;</span>
<a href="#l1.815"></a><span id="l1.815">         } else {</span>
<a href="#l1.816"></a><span id="l1.816">           this.last.month++;</span>
<a href="#l1.817"></a><span id="l1.817">         }</span>
<a href="#l1.818"></a><span id="l1.818"> </span>
<a href="#l1.819"></a><span id="l1.819">         this.last.month--;</span>
<a href="#l1.820"></a><span id="l1.820">         var years = ICAL.helpers.trunc(this.last.month / 12);</span>
<a href="#l1.821"></a><span id="l1.821" class="difflineat">@@ -6277,26 +6296,32 @@ ICAL.Event = (function() {</span>
<a href="#l1.822"></a><span id="l1.822">      *</span>
<a href="#l1.823"></a><span id="l1.823">      * NOTE: this method is intend to be used in conjunction</span>
<a href="#l1.824"></a><span id="l1.824">      *       with the #iterator method.</span>
<a href="#l1.825"></a><span id="l1.825">      *</span>
<a href="#l1.826"></a><span id="l1.826">      * @param {ICAL.Time} occurrence time occurrence.</span>
<a href="#l1.827"></a><span id="l1.827">      */</span>
<a href="#l1.828"></a><span id="l1.828">     getOccurrenceDetails: function(occurrence) {</span>
<a href="#l1.829"></a><span id="l1.829">       var id = occurrence.toString();</span>
<a href="#l1.830"></a><span id="l1.830" class="difflineplus">+      var utcId = occurrence.convertToZone(ICAL.Timezone.utcTimezone).toString();</span>
<a href="#l1.831"></a><span id="l1.831">       var result = {</span>
<a href="#l1.832"></a><span id="l1.832">         //XXX: Clone?</span>
<a href="#l1.833"></a><span id="l1.833">         recurrenceId: occurrence</span>
<a href="#l1.834"></a><span id="l1.834">       };</span>
<a href="#l1.835"></a><span id="l1.835"> </span>
<a href="#l1.836"></a><span id="l1.836">       if (id in this.exceptions) {</span>
<a href="#l1.837"></a><span id="l1.837">         var item = result.item = this.exceptions[id];</span>
<a href="#l1.838"></a><span id="l1.838">         result.startDate = item.startDate;</span>
<a href="#l1.839"></a><span id="l1.839">         result.endDate = item.endDate;</span>
<a href="#l1.840"></a><span id="l1.840">         result.item = item;</span>
<a href="#l1.841"></a><span id="l1.841" class="difflineplus">+      } else if (utcId in this.exceptions) {</span>
<a href="#l1.842"></a><span id="l1.842" class="difflineplus">+        var item = this.exceptions[utcId];</span>
<a href="#l1.843"></a><span id="l1.843" class="difflineplus">+        result.startDate = item.startDate;</span>
<a href="#l1.844"></a><span id="l1.844" class="difflineplus">+        result.endDate = item.endDate;</span>
<a href="#l1.845"></a><span id="l1.845" class="difflineplus">+        result.item = item;</span>
<a href="#l1.846"></a><span id="l1.846">       } else {</span>
<a href="#l1.847"></a><span id="l1.847">         // range exceptions (RANGE=THISANDFUTURE) have a</span>
<a href="#l1.848"></a><span id="l1.848">         // lower priority then direct exceptions but</span>
<a href="#l1.849"></a><span id="l1.849">         // must be accounted for first. Their item is</span>
<a href="#l1.850"></a><span id="l1.850">         // always the first exception with the range prop.</span>
<a href="#l1.851"></a><span id="l1.851">         var rangeExceptionId = this.findRangeException(</span>
<a href="#l1.852"></a><span id="l1.852">           occurrence</span>
<a href="#l1.853"></a><span id="l1.853">         );</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

