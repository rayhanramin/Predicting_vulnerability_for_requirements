<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 19104:b0835f56f7b3d20b8e0641388287b535a318b2ad</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ b0835f56f7b3d20b8e0641388287b535a318b2ad" />
<meta property="og:url" content="/comm-central/rev/b0835f56f7b3d20b8e0641388287b535a318b2ad" />
<meta property="og:description" content="Bug 1255071 - Don't use base64 encoding for message/rfc822 attachments. r=mkmelin a=jorgk CLOSED TREE" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / b0835f56f7b3d20b8e0641388287b535a318b2ad 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/b0835f56f7b3d20b8e0641388287b535a318b2ad">shortlog</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/b0835f56f7b3d20b8e0641388287b535a318b2ad">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad">files</a> |
changeset |
<a href="/comm-central/raw-rev/b0835f56f7b3d20b8e0641388287b535a318b2ad">raw</a>  | <a href="/comm-central/archive/b0835f56f7b3d20b8e0641388287b535a318b2ad.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1255071">Bug 1255071</a> - Don't use base64 encoding for message/rfc822 attachments. r=mkmelin a=jorgk CLOSED TREE
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;</td></tr>
<tr><td></td><td class="date age">Mon, 14 Mar 2016 11:37:24 +0100</td></tr>

<tr>
 <td>changeset 19104</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/b0835f56f7b3d20b8e0641388287b535a318b2ad">b0835f56f7b3d20b8e0641388287b535a318b2ad</a></td>
</tr>



<tr>
<td>parent 19103</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/601b90ee6cc7183dc78086bcd46cc6e379d71498">601b90ee6cc7183dc78086bcd46cc6e379d71498</a>
</td>
</tr>

<tr>
<td>child 19105</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d9cc74deecf621f5e20b701080dc69e7d8564dc2">d9cc74deecf621f5e20b701080dc69e7d8564dc2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=b0835f56f7b3d20b8e0641388287b535a318b2ad">11735</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Sat, 26 Mar 2016 21:52:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@b0835f56f7b3 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b0835f56f7b3d20b8e0641388287b535a318b2ad">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=b0835f56f7b3d20b8e0641388287b535a318b2ad&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0835f56f7b3d20b8e0641388287b535a318b2ad&newProject=comm-central&newRevision=601b90ee6cc7183dc78086bcd46cc6e379d71498&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0835f56f7b3d20b8e0641388287b535a318b2ad&newProject=comm-central&newRevision=601b90ee6cc7183dc78086bcd46cc6e379d71498&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=b0835f56f7b3d20b8e0641388287b535a318b2ad&newProject=comm-central&newRevision=601b90ee6cc7183dc78086bcd46cc6e379d71498&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a>, <a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1255071">1255071</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1255071">Bug 1255071</a> - Don't use base64 encoding for message/rfc822 attachments. r=mkmelin a=jorgk CLOSED TREE</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">mail/test/mozmill/composition/long-html-line.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/long-html-line.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">mail/test/mozmill/composition/test-forward-rfc822-attach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mail/test/mozmill/composition/test-forward-rfc822-attach.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">mailnews/compose/test/unit/test_longLines.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">file</a> |
<a href="/comm-central/annotate/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">annotate</a> |
<a href="/comm-central/diff/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">diff</a> |
<a href="/comm-central/comparison/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">comparison</a> |
<a href="/comm-central/log/b0835f56f7b3d20b8e0641388287b535a318b2ad/mailnews/compose/test/unit/test_longLines.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1">new file mode 100644</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineminus">--- /dev/null</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineplus">+++ b/mail/test/mozmill/composition/long-html-line.eml</span>
<a href="#l1.4"></a><span id="l1.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l1.5"></a><span id="l1.5" class="difflineplus">+From: &quot;Long line writer&quot; &lt;email@longline.invalid&gt;</span>
<a href="#l1.6"></a><span id="l1.6" class="difflineplus">+To: &lt;user@example.com&gt;</span>
<a href="#l1.7"></a><span id="l1.7" class="difflineplus">+Subject: Long HTML line</span>
<a href="#l1.8"></a><span id="l1.8" class="difflineplus">+Date: Wed, 10 Feb 2016 16:45:36 -0600</span>
<a href="#l1.9"></a><span id="l1.9" class="difflineplus">+MIME-Version: 1.0</span>
<a href="#l1.10"></a><span id="l1.10" class="difflineplus">+Content-Type: text/html;</span>
<a href="#l1.11"></a><span id="l1.11" class="difflineplus">+	charset=&quot;us-ascii&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+Content-Transfer-Encoding: 7bit</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+&lt;!DOCTYPE html&gt;</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+&lt;html&gt;</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+&lt;body&gt;</span>
<a href="#l1.17"></a><span id="l1.17" class="difflineplus">+</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. We like writing long lines. This is 998 long.</span>
<a href="#l1.19"></a><span id="l1.19" class="difflineplus">+</span>
<a href="#l1.20"></a><span id="l1.20" class="difflineplus">+ &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,101 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+/**</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+ * Tests that attached messages (message/rfc822) are correctly sent.</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+ * It's easiest to test the forward case.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+ */</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+// mozmake SOLO_TEST=composition/test-forward-rfc822-attach.js mozmill-one</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+var MODULE_NAME = &quot;test-forward-rfc822-attach&quot;;</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+Cu.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+var os = {};</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+Cu.import('resource://mozmill/stdlib/os.js', os);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+var draftsFolder;</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+function setupModule(module) {</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+    collector.getModule(lib).installInto(module);</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  }</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  if (!MailServices.accounts</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+                   .localFoldersServer</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+                   .rootFolder</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+                   .containsChildNamed(&quot;Drafts&quot;)) {</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+    create_folder(&quot;Drafts&quot;, [Ci.nsMsgFolderFlags.Drafts]);</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  }</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  draftsFolder = MailServices.accounts</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+                             .localFoldersServer</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+                             .rootFolder</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+                             .getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+}</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+/**</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+ * Helper to get the full message content.</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+ *</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineplus">+ * @param aMsgHdr: nsIMsgDBHdr object whose text body will be read</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineplus">+ * @return string with full message source</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+ */</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+function getMsgSource(aMsgHdr) {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  let msgFolder = aMsgHdr.folder;</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineplus">+  let streamListener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+                         .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineplus">+  messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineplus">+                                                        streamListener,</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineplus">+                                                        null,</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineplus">+                                                        null,</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineplus">+                                                        false,</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+                                                        &quot;&quot;,</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineplus">+                                                        false);</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+              .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+  sis.init(streamListener.inputStream);</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineplus">+  const MAX_MESSAGE_LENGTH = 65536;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+  let content = sis.read(MAX_MESSAGE_LENGTH);</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineplus">+  sis.close();</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  return content;</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+}</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+function forwardDirect(aFilePath) {</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+  let file = os.getFileForPath(os.abspath(aFilePath,</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineplus">+                               os.getFileForPath(__file__)));</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineplus">+  let msgc = open_message_from_file(file);</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineplus">+</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+  let cwc = open_compose_with_forward_as_attachments(msgc);</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+  // Ctrl+S saves as draft.</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+  cwc.keypress(null, &quot;s&quot;, {shiftKey: false, accelKey: true});</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+  close_compose_window(cwc);</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+  close_window(msgc);</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  be_in_folder(draftsFolder);</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+  let draftMsg = select_click_row(0);</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+  let draftMsgContent = getMsgSource(draftMsg);</span>
<a href="#l2.92"></a><span id="l2.92" class="difflineplus">+</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineplus">+  if (!draftMsgContent.includes(&quot;We like writing long lines.&quot;)) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+    assert_true(false, &quot;Failed to find expected text&quot;);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+  }</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+  press_delete(mc); // clean up the created draft</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+}</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+</span>
<a href="#l2.100"></a><span id="l2.100" class="difflineplus">+function test_forwarding_long_html_line_as_attachment() {</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineplus">+  forwardDirect(&quot;./long-html-line.eml&quot;);</span>
<a href="#l2.102"></a><span id="l2.102" class="difflineplus">+}</span>
<a href="#l2.103"></a><span id="l2.103" class="difflineplus">+</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineplus">+function teardownModule() {</span>
<a href="#l2.105"></a><span id="l2.105" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -389,17 +389,17 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l3.4"></a><span id="l3.4">       if (mCompFields-&gt;GetForceMsgEncoding())</span>
<a href="#l3.5"></a><span id="l3.5">         force_p = true;</span>
<a href="#l3.6"></a><span id="l3.6">     } else if (mime_delivery_state) {</span>
<a href="#l3.7"></a><span id="l3.7">       if (((nsMsgComposeAndSend *)mime_delivery_state)-&gt;mCompFields-&gt;GetForceMsgEncoding()) {</span>
<a href="#l3.8"></a><span id="l3.8">         force_p = true;</span>
<a href="#l3.9"></a><span id="l3.9">       }</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    if (force_p || (m_max_column &gt; 900)) {</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    if (force_p || (m_max_column &gt; LINELENGTH_ENCODING_THRESHOLD)) {</span>
<a href="#l3.14"></a><span id="l3.14">       encode_p = true;</span>
<a href="#l3.15"></a><span id="l3.15">     } else if (UseQuotedPrintable() &amp;&amp; m_unprintable_count) {</span>
<a href="#l3.16"></a><span id="l3.16">       encode_p = true;</span>
<a href="#l3.17"></a><span id="l3.17">     } else if (m_null_count) {</span>
<a href="#l3.18"></a><span id="l3.18">       // If there are nulls, we must always encode, because sendmail will</span>
<a href="#l3.19"></a><span id="l3.19">       // blow up.</span>
<a href="#l3.20"></a><span id="l3.20">       encode_p = true;</span>
<a href="#l3.21"></a><span id="l3.21">     } else {</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineat">@@ -449,17 +449,23 @@ nsMsgAttachmentHandler::PickEncoding(con</span>
<a href="#l3.23"></a><span id="l3.23"> </span>
<a href="#l3.24"></a><span id="l3.24">   // Always base64 binary data.</span>
<a href="#l3.25"></a><span id="l3.25">   if (needsB64)</span>
<a href="#l3.26"></a><span id="l3.26">     m_encoding = ENCODING_BASE64;</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">   // According to RFC 821 we must always have lines shorter than 998 bytes.</span>
<a href="#l3.29"></a><span id="l3.29">   // To encode &quot;long lines&quot; use a CTE that will transmit shorter lines.</span>
<a href="#l3.30"></a><span id="l3.30">   // Switch to base64 if we are not already using &quot;quoted printable&quot;.</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineminus">-  if (m_max_column &gt; 900 &amp;&amp; !isUsingQP)</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  // We don't do this for message/rfc822 attachments, since we can't</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  // change the original Content-Transfer-Encoding of the message we're</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  // attaching. We rely on the original message complying with RFC 821,</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  // if it doesn't we won't either. Not ideal.</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  if (!m_type.LowerCaseEqualsLiteral(MESSAGE_RFC822) &amp;&amp;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+      m_max_column &gt; LINELENGTH_ENCODING_THRESHOLD &amp;&amp; !isUsingQP)</span>
<a href="#l3.39"></a><span id="l3.39">     m_encoding = ENCODING_BASE64;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">   // Now that we've picked an encoding, initialize the filter.</span>
<a href="#l3.42"></a><span id="l3.42">   NS_ASSERTION(!m_encoder, &quot;not-null m_encoder&quot;);</span>
<a href="#l3.43"></a><span id="l3.43">   if (m_encoding.LowerCaseEqualsLiteral(ENCODING_BASE64))</span>
<a href="#l3.44"></a><span id="l3.44">   {</span>
<a href="#l3.45"></a><span id="l3.45">     m_encoder = MimeEncoder::GetBase64Encoder(mime_encoder_output_fn,</span>
<a href="#l3.46"></a><span id="l3.46">       mime_delivery_state);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -624,17 +624,17 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l4.4"></a><span id="l4.4">         cur_column = 0;</span>
<a href="#l4.5"></a><span id="l4.5">       } else if (*c != '\r') {</span>
<a href="#l4.6"></a><span id="l4.6">         cur_column++;</span>
<a href="#l4.7"></a><span id="l4.7">       }</span>
<a href="#l4.8"></a><span id="l4.8">     }</span>
<a href="#l4.9"></a><span id="l4.9">     // Check one last time for the last line.</span>
<a href="#l4.10"></a><span id="l4.10">     if (cur_column &gt; max_column)</span>
<a href="#l4.11"></a><span id="l4.11">       max_column = cur_column;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-    if (max_column &gt; 900 &amp;&amp; !isUsingQP) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+    if (max_column &gt; LINELENGTH_ENCODING_THRESHOLD &amp;&amp; !isUsingQP) {</span>
<a href="#l4.14"></a><span id="l4.14">       // To encode &quot;long lines&quot; use a CTE that will transmit shorter lines.</span>
<a href="#l4.15"></a><span id="l4.15">       // Switch to base64 if we are not already using &quot;quoted printable&quot;.</span>
<a href="#l4.16"></a><span id="l4.16">       PR_FREEIF(m_attachment1_encoding);</span>
<a href="#l4.17"></a><span id="l4.17">       m_attachment1_encoding = PL_strdup (ENCODING_BASE64);</span>
<a href="#l4.18"></a><span id="l4.18">     }</span>
<a href="#l4.19"></a><span id="l4.19">   }</span>
<a href="#l4.20"></a><span id="l4.20">   PR_FREEIF (m_attachment1_body);</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -1041,17 +1041,17 @@ nsMsgComposeAndSend::PreProcessPart(nsMs</span>
<a href="#l4.23"></a><span id="l4.23">   if (ma-&gt;m_bogus_attachment)</span>
<a href="#l4.24"></a><span id="l4.24">     return 0;</span>
<a href="#l4.25"></a><span id="l4.25"> </span>
<a href="#l4.26"></a><span id="l4.26">   // If at this point we *still* don't have a content-type, then</span>
<a href="#l4.27"></a><span id="l4.27">   // we're never going to get one.</span>
<a href="#l4.28"></a><span id="l4.28">   if (ma-&gt;m_type.IsEmpty())</span>
<a href="#l4.29"></a><span id="l4.29">     ma-&gt;m_type = UNKNOWN_CONTENT_TYPE;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  ma-&gt;PickEncoding (mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+  ma-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l4.33"></a><span id="l4.33">   ma-&gt;PickCharset();</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35">   part = new nsMsgSendPart(this);</span>
<a href="#l4.36"></a><span id="l4.36">   if (!part)</span>
<a href="#l4.37"></a><span id="l4.37">     return 0;</span>
<a href="#l4.38"></a><span id="l4.38">   status = toppart-&gt;AddChild(part);</span>
<a href="#l4.39"></a><span id="l4.39">   // Remember the part number if it has a node index.</span>
<a href="#l4.40"></a><span id="l4.40">   if (ma-&gt;mNodeIndex != -1)</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineat">@@ -2369,17 +2369,17 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l4.42"></a><span id="l4.42">       /* If the attachment has an encoding, and it's not one of</span>
<a href="#l4.43"></a><span id="l4.43">       the &quot;null&quot; encodings, then keep it. */</span>
<a href="#l4.44"></a><span id="l4.44">       if (!m_attachments[i]-&gt;m_encoding.IsEmpty() &amp;&amp;</span>
<a href="#l4.45"></a><span id="l4.45">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT) &amp;&amp;</span>
<a href="#l4.46"></a><span id="l4.46">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_8BIT) &amp;&amp;</span>
<a href="#l4.47"></a><span id="l4.47">           !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BINARY))</span>
<a href="#l4.48"></a><span id="l4.48">         m_attachments[i]-&gt;m_already_encoded_p = true;</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50" class="difflineminus">-            if (m_attachments[i]-&gt;mURL)</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l4.52"></a><span id="l4.52">         msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l4.53"></a><span id="l4.53">     }</span>
<a href="#l4.54"></a><span id="l4.54">   }</span>
<a href="#l4.55"></a><span id="l4.55"> </span>
<a href="#l4.56"></a><span id="l4.56">   // First, handle the multipart related attachments if any...</span>
<a href="#l4.57"></a><span id="l4.57">   //</span>
<a href="#l4.58"></a><span id="l4.58">   int32_t mailbox_count = 0, news_count = 0;</span>
<a href="#l4.59"></a><span id="l4.59">   int32_t multipartRelatedCount = GetMultipartRelatedCount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -45,17 +45,18 @@</span>
<a href="#l5.4"></a><span id="l5.4">   as source or postscript, it will be run through the appropriate converter</span>
<a href="#l5.5"></a><span id="l5.5">   (which will result in a document of type text/plain.)</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   An attachment will be encoded if:</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">    - it is of a non-text type (in which case we will use base64); or</span>
<a href="#l5.10"></a><span id="l5.10">    - The &quot;use QP&quot; option has been selected and high-bit characters exist; or</span>
<a href="#l5.11"></a><span id="l5.11">    - any NULLs exist in the document; or</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-   - any line is longer than 900 bytes.</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+   - any line is longer than 990 bytes (see LINELENGTH_ENCODING_THRESHOLD below)</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+     and it is not of type message/rfc822.</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">    - If we are encoding, and more than 10% of the document consists of</span>
<a href="#l5.17"></a><span id="l5.17">      non-ASCII characters, then we always use base64 instead of QP.</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   We eschew quoted-printable in favor of base64 for documents which are likely</span>
<a href="#l5.20"></a><span id="l5.20">   to always be binary (images, sound) because, on the off chance that a GIF</span>
<a href="#l5.21"></a><span id="l5.21">   file (for example) might contain primarily bytes in the ASCII range, using</span>
<a href="#l5.22"></a><span id="l5.22">   the quoted-printable representation might cause corruption due to the</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -135,16 +136,19 @@</span>
<a href="#l5.24"></a><span id="l5.24"> #include &quot;nsIMsgOperationListener.h&quot;</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> //</span>
<a href="#l5.27"></a><span id="l5.27"> // Some necessary defines...</span>
<a href="#l5.28"></a><span id="l5.28"> //</span>
<a href="#l5.29"></a><span id="l5.29"> #define TEN_K                 10240</span>
<a href="#l5.30"></a><span id="l5.30"> #define MIME_BUFFER_SIZE      4096 // must be greater than 1000</span>
<a href="#l5.31"></a><span id="l5.31">                                    // SMTP (RFC821) limit</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+// Maximum number of bytes we allow in a line before we force</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+// encoding to base64 if not already QR-encoded or of type message/rfc822.</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+#define LINELENGTH_ENCODING_THRESHOLD 990</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36"> //</span>
<a href="#l5.37"></a><span id="l5.37"> // Utilities for string handling</span>
<a href="#l5.38"></a><span id="l5.38"> //</span>
<a href="#l5.39"></a><span id="l5.39"> #define PUSH_STRING(S) \</span>
<a href="#l5.40"></a><span id="l5.40">  do { PL_strcpy (buffer_tail, S); buffer_tail += PL_strlen (S); } while(0)</span>
<a href="#l5.41"></a><span id="l5.41"> #define PUSH_STRINGN(S,N) \</span>
<a href="#l5.42"></a><span id="l5.42">  do { memcpy(buffer_tail, (S), (N)); buffer_tail += (N); } while(0)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_longLines.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -77,17 +77,17 @@ function checkMessageHeaders(msgData, ex</span>
<a href="#l6.4"></a><span id="l6.4"> // two bytes c3a1 in UTF-8.</span>
<a href="#l6.5"></a><span id="l6.5"> let longMultibyteLine = &quot;\u00E1&quot;.repeat(600);</span>
<a href="#l6.6"></a><span id="l6.6"> </span>
<a href="#l6.7"></a><span id="l6.7"> // And here a line with a Korean character, encoded as three bytes</span>
<a href="#l6.8"></a><span id="l6.8"> // ec9588 in UTF-8.</span>
<a href="#l6.9"></a><span id="l6.9"> let longMultibyteLineCJK = &quot;안&quot;.repeat(400);</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> // And some Japanese.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-let longMultibyteLineJapanese = &quot;語&quot;.repeat(400);</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+let longMultibyteLineJapanese = &quot;語&quot;.repeat(450);</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15"> function* testBodyWithLongLine() {</span>
<a href="#l6.16"></a><span id="l6.16">   let newline;</span>
<a href="#l6.17"></a><span id="l6.17">   // Windows uses CR+LF, the other platforms just LF.</span>
<a href="#l6.18"></a><span id="l6.18">   // Note: Services.appinfo.OS returns &quot;XPCShell&quot; in the test, so we</span>
<a href="#l6.19"></a><span id="l6.19">   // use this hacky condition to separate Windows from the others.</span>
<a href="#l6.20"></a><span id="l6.20">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Components.classes) {</span>
<a href="#l6.21"></a><span id="l6.21">     newline = &quot;\r\n&quot;;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

