<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 1031:5748fe6d63df4fcd393fc01fa91c14cfc6451fa4</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 5748fe6d63df4fcd393fc01fa91c14cfc6451fa4" />
<meta property="og:url" content="/comm-central/rev/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4" />
<meta property="og:description" content="Bug 462681: mailWindowOverlay.js style/whitespace/indention/comment/linewrap cleanup. And some function simplifications. r=jminta, sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 5748fe6d63df4fcd393fc01fa91c14cfc6451fa4 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">shortlog</a> |
<a href="/comm-central/log/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">files</a> |
changeset |
<a href="/comm-central/raw-rev/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">raw</a>  | <a href="/comm-central/archive/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462681">Bug 462681</a>: mailWindowOverlay.js style/whitespace/indention/comment/linewrap cleanup. And some function simplifications. r=jminta, sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#77;&#97;&#103;&#110;&#117;&#115;&#32;&#77;&#101;&#108;&#105;&#110;&#32;&#60;&#109;&#107;&#109;&#101;&#108;&#105;&#110;&#64;&#105;&#107;&#105;&#46;&#102;&#105;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 06 Nov 2008 23:42:28 +0200</td></tr>

<tr>
 <td>changeset 1031</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">5748fe6d63df4fcd393fc01fa91c14cfc6451fa4</a></td>
</tr>



<tr>
<td>parent 1030</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/020882e3433b905fda85bca60e8b5701bfb4300a">020882e3433b905fda85bca60e8b5701bfb4300a</a>
</td>
</tr>

<tr>
<td>child 1032</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/16dd1037ca4d4c1536103d563744fe6e09fcba44">16dd1037ca4d4c1536103d563744fe6e09fcba44</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">769</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Thu, 06 Nov 2008 21:43:29 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@5748fe6d63df [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&newProject=comm-central&newRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&newProject=comm-central&newRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&newProject=comm-central&newRevision=5748fe6d63df4fcd393fc01fa91c14cfc6451fa4&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jminta%29&revcount=50">jminta</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462681">462681</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=462681">Bug 462681</a>: mailWindowOverlay.js style/whitespace/indention/comment/linewrap cleanup. And some function simplifications. r=jminta, sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">mail/base/content/mail3PaneWindowCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">file</a> |
<a href="/comm-central/annotate/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">annotate</a> |
<a href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">diff</a> |
<a href="/comm-central/comparison/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">comparison</a> |
<a href="/comm-central/log/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mail3PaneWindowCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">mail/base/content/messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">file</a> |
<a href="/comm-central/annotate/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">annotate</a> |
<a href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">diff</a> |
<a href="/comm-central/comparison/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">comparison</a> |
<a href="/comm-central/log/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mail/base/content/messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">mailnews/base/search/resources/content/FilterEditor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">file</a> |
<a href="/comm-central/annotate/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">annotate</a> |
<a href="/comm-central/diff/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">diff</a> |
<a href="/comm-central/comparison/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">comparison</a> |
<a href="/comm-central/log/5748fe6d63df4fcd393fc01fa91c14cfc6451fa4/mailnews/base/search/resources/content/FilterEditor.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mail3PaneWindowCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -397,17 +397,17 @@ var DefaultController =</span>
<a href="#l1.4"></a><span id="l1.4">       case &quot;cmd_selectAll&quot;:</span>
<a href="#l1.5"></a><span id="l1.5">       case &quot;cmd_selectFlagged&quot;:</span>
<a href="#l1.6"></a><span id="l1.6">         return gDBView != null;</span>
<a href="#l1.7"></a><span id="l1.7">       // these are enabled on when we are in threaded mode</span>
<a href="#l1.8"></a><span id="l1.8">       case &quot;cmd_selectThread&quot;:</span>
<a href="#l1.9"></a><span id="l1.9">         if (GetNumSelectedMessages() &lt;= 0) return false;</span>
<a href="#l1.10"></a><span id="l1.10">       case &quot;cmd_expandAllThreads&quot;:</span>
<a href="#l1.11"></a><span id="l1.11">       case &quot;cmd_collapseAllThreads&quot;:</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-        return (gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+        return gDBView &amp;&amp; (gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay);</span>
<a href="#l1.14"></a><span id="l1.14">       case &quot;cmd_nextFlaggedMsg&quot;:</span>
<a href="#l1.15"></a><span id="l1.15">       case &quot;cmd_previousFlaggedMsg&quot;:</span>
<a href="#l1.16"></a><span id="l1.16">         return IsViewNavigationItemEnabled();</span>
<a href="#l1.17"></a><span id="l1.17">       case &quot;cmd_viewAllMsgs&quot;:</span>
<a href="#l1.18"></a><span id="l1.18">       case &quot;cmd_viewUnreadMsgs&quot;:</span>
<a href="#l1.19"></a><span id="l1.19">       case &quot;cmd_viewIgnoredThreads&quot;:</span>
<a href="#l1.20"></a><span id="l1.20">         return gDBView;</span>
<a href="#l1.21"></a><span id="l1.21">       case &quot;cmd_viewThreadsWithUnread&quot;:</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -650,33 +650,33 @@ var DefaultController =</span>
<a href="#l1.23"></a><span id="l1.23">       case &quot;cmd_properties&quot;:</span>
<a href="#l1.24"></a><span id="l1.24">         MsgFolderProperties();</span>
<a href="#l1.25"></a><span id="l1.25">         return;</span>
<a href="#l1.26"></a><span id="l1.26">       case &quot;cmd_search&quot;:</span>
<a href="#l1.27"></a><span id="l1.27">         MsgSearchMessages();</span>
<a href="#l1.28"></a><span id="l1.28">         return;</span>
<a href="#l1.29"></a><span id="l1.29">       case &quot;button_mark&quot;:</span>
<a href="#l1.30"></a><span id="l1.30">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-        MsgMarkMsgAsRead(null);</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+        MsgMarkMsgAsRead();</span>
<a href="#l1.33"></a><span id="l1.33">         return;</span>
<a href="#l1.34"></a><span id="l1.34">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l1.35"></a><span id="l1.35">         ClearPendingReadTimer();</span>
<a href="#l1.36"></a><span id="l1.36">         gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l1.37"></a><span id="l1.37">         return;</span>
<a href="#l1.38"></a><span id="l1.38">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l1.39"></a><span id="l1.39">         gDBView.doCommand(nsMsgViewCommandType.markAllRead);</span>
<a href="#l1.40"></a><span id="l1.40">         return;</span>
<a href="#l1.41"></a><span id="l1.41">       case &quot;button_junk&quot;:</span>
<a href="#l1.42"></a><span id="l1.42">         MsgJunk();</span>
<a href="#l1.43"></a><span id="l1.43">         return;</span>
<a href="#l1.44"></a><span id="l1.44">       case &quot;cmd_stop&quot;:</span>
<a href="#l1.45"></a><span id="l1.45">         msgWindow.StopUrls();</span>
<a href="#l1.46"></a><span id="l1.46">         return;</span>
<a href="#l1.47"></a><span id="l1.47">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineminus">-        MsgMarkAsFlagged(null);</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+        MsgMarkAsFlagged();</span>
<a href="#l1.50"></a><span id="l1.50">         return;</span>
<a href="#l1.51"></a><span id="l1.51">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l1.52"></a><span id="l1.52">         JunkSelectedMessages(true);</span>
<a href="#l1.53"></a><span id="l1.53">         return;</span>
<a href="#l1.54"></a><span id="l1.54">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l1.55"></a><span id="l1.55">         JunkSelectedMessages(false);</span>
<a href="#l1.56"></a><span id="l1.56">         return;</span>
<a href="#l1.57"></a><span id="l1.57">       case &quot;cmd_recalculateJunkScore&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -51,36 +51,40 @@ const MSG_FLAG_HAS_RE            = 0x000</span>
<a href="#l2.4"></a><span id="l2.4"> const MSG_FLAG_IMAP_DELETED      = 0x200000;</span>
<a href="#l2.5"></a><span id="l2.5"> const ADDR_DB_LARGE_COMMIT       = 1;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> const kClassicMailLayout = 0;</span>
<a href="#l2.8"></a><span id="l2.8"> const kWideMailLayout = 1;</span>
<a href="#l2.9"></a><span id="l2.9"> const kVerticalMailLayout = 2;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> // Per message header flags to keep track of whether the user is allowing remote</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// content for a particular message. </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+// content for a particular message.</span>
<a href="#l2.14"></a><span id="l2.14"> // if you change or add more values to these constants, be sure to modify</span>
<a href="#l2.15"></a><span id="l2.15"> // the corresponding definitions in nsMsgContentPolicy.cpp</span>
<a href="#l2.16"></a><span id="l2.16"> const kNoRemoteContentPolicy = 0;</span>
<a href="#l2.17"></a><span id="l2.17"> const kBlockRemoteContent = 1;</span>
<a href="#l2.18"></a><span id="l2.18"> const kAllowRemoteContent = 2;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> const kMsgNotificationPhishingBar = 1;</span>
<a href="#l2.21"></a><span id="l2.21"> const kMsgNotificationJunkBar = 2;</span>
<a href="#l2.22"></a><span id="l2.22"> const kMsgNotificationRemoteImages = 3;</span>
<a href="#l2.23"></a><span id="l2.23"> </span>
<a href="#l2.24"></a><span id="l2.24"> var gMessengerBundle;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService).getBranch(null);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-var gMarkViewedMessageAsReadTimer = null; // if the user has configured the app to mark a message as read if it is viewed for more than n seconds</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+var gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+                            .getService(Components.interfaces.nsIPrefService)</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+                            .getBranch(null);</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+// Timer to mark read, if the user has configured the app to mark a message as</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+// read if it is viewed for more than n seconds.</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+var gMarkViewedMessageAsReadTimer = null;</span>
<a href="#l2.33"></a><span id="l2.33"> </span>
<a href="#l2.34"></a><span id="l2.34"> // the user preference,</span>
<a href="#l2.35"></a><span id="l2.35"> // if HTML is not allowed. I assume, that the user could have set this to a</span>
<a href="#l2.36"></a><span id="l2.36"> // value &gt; 1 in his prefs.js or user.js, but that the value will not</span>
<a href="#l2.37"></a><span id="l2.37"> // change during runtime other than through the MsgBody*() functions below.</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-var gDisallow_classes_no_html = 1; </span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+var gDisallow_classes_no_html = 1;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41"> // Disable the new account menu item if the account preference is locked.</span>
<a href="#l2.42"></a><span id="l2.42"> // Two other affected areas are the account central and the account manager</span>
<a href="#l2.43"></a><span id="l2.43"> // dialog.</span>
<a href="#l2.44"></a><span id="l2.44"> function menu_new_init()</span>
<a href="#l2.45"></a><span id="l2.45"> {</span>
<a href="#l2.46"></a><span id="l2.46">   if (!gMessengerBundle)</span>
<a href="#l2.47"></a><span id="l2.47">     gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -95,37 +99,35 @@ function menu_new_init()</span>
<a href="#l2.49"></a><span id="l2.49">     return;</span>
<a href="#l2.50"></a><span id="l2.50">   var msgFolder = folderArray[0];</span>
<a href="#l2.51"></a><span id="l2.51">   var isServer = msgFolder.isServer;</span>
<a href="#l2.52"></a><span id="l2.52">   var serverType = msgFolder.server.type;</span>
<a href="#l2.53"></a><span id="l2.53">   var canCreateNew = msgFolder.canCreateSubfolders;</span>
<a href="#l2.54"></a><span id="l2.54">   var isInbox = IsSpecialFolder(msgFolder, MSG_FOLDER_FLAG_INBOX, false);</span>
<a href="#l2.55"></a><span id="l2.55">   var isIMAPFolder = serverType == &quot;imap&quot;;</span>
<a href="#l2.56"></a><span id="l2.56">   var ioService = Components.classes[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-                         .getService(Components.interfaces.nsIIOService);</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+                            .getService(Components.interfaces.nsIIOService);</span>
<a href="#l2.59"></a><span id="l2.59">   var showNew = ((serverType != 'nntp') &amp;&amp; canCreateNew) || isInbox;</span>
<a href="#l2.60"></a><span id="l2.60">   ShowMenuItem(&quot;menu_newFolder&quot;, showNew);</span>
<a href="#l2.61"></a><span id="l2.61">   ShowMenuItem(&quot;menu_newVirtualFolder&quot;, showNew);</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63">   EnableMenuItem(&quot;menu_newFolder&quot;, !isIMAPFolder || MailOfflineMgr.isOnline());</span>
<a href="#l2.64"></a><span id="l2.64">   EnableMenuItem(&quot;menu_newVirtualFolder&quot;, true);</span>
<a href="#l2.65"></a><span id="l2.65">   if (showNew)</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-    SetMenuItemLabel(&quot;menu_newFolder&quot;, gMessengerBundle.getString((isServer || isInbox) ? &quot;newFolderMenuItem&quot; : &quot;newSubfolderMenuItem&quot;));</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineplus">+    SetMenuItemLabel(&quot;menu_newFolder&quot;, gMessengerBundle.getString(</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineplus">+      (isServer || isInbox) ? &quot;newFolderMenuItem&quot; : &quot;newSubfolderMenuItem&quot;));</span>
<a href="#l2.69"></a><span id="l2.69"> }</span>
<a href="#l2.70"></a><span id="l2.70"> </span>
<a href="#l2.71"></a><span id="l2.71"> function goUpdateMailMenuItems(commandset)</span>
<a href="#l2.72"></a><span id="l2.72"> {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-//  dump(&quot;Updating commands for &quot; + commandset.id + &quot;\n&quot;);</span>
<a href="#l2.74"></a><span id="l2.74">   for (var i = 0; i &lt; commandset.childNodes.length; i++)</span>
<a href="#l2.75"></a><span id="l2.75">   {</span>
<a href="#l2.76"></a><span id="l2.76">     var commandID = commandset.childNodes[i].getAttribute(&quot;id&quot;);</span>
<a href="#l2.77"></a><span id="l2.77">     if (commandID)</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-    {</span>
<a href="#l2.79"></a><span id="l2.79">       goUpdateCommand(commandID);</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-    }</span>
<a href="#l2.81"></a><span id="l2.81">   }</span>
<a href="#l2.82"></a><span id="l2.82"> }</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84"> function file_init()</span>
<a href="#l2.85"></a><span id="l2.85"> {</span>
<a href="#l2.86"></a><span id="l2.86">   document.commandDispatcher.updateCommands('create-menu-file');</span>
<a href="#l2.87"></a><span id="l2.87"> }</span>
<a href="#l2.88"></a><span id="l2.88"> </span>
<a href="#l2.89"></a><span id="l2.89" class="difflineat">@@ -135,89 +137,77 @@ function InitEditMessagesMenu()</span>
<a href="#l2.90"></a><span id="l2.90">   goSetAccessKey('cmd_delete', 'valueDefaultAccessKey');</span>
<a href="#l2.91"></a><span id="l2.91">   document.commandDispatcher.updateCommands('create-menu-edit');</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">   // initialize the favorite Folder checkbox in the edit menu</span>
<a href="#l2.94"></a><span id="l2.94">   var favoriteFolderMenu = document.getElementById('menu_favoriteFolder');</span>
<a href="#l2.95"></a><span id="l2.95">   if (favoriteFolderMenu &amp;&amp; !favoriteFolderMenu.disabled)</span>
<a href="#l2.96"></a><span id="l2.96">   {</span>
<a href="#l2.97"></a><span id="l2.97">     var folders = GetSelectedMsgFolders();</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineminus">-    if (folders.length) {</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    if (folders.length)</span>
<a href="#l2.100"></a><span id="l2.100">       SetupFavoritesMenuItem(folders[0], folders.length, folders[0].isServer, 'menu_favoriteFolder');</span>
<a href="#l2.101"></a><span id="l2.101" class="difflineminus">-    }</span>
<a href="#l2.102"></a><span id="l2.102">   }</span>
<a href="#l2.103"></a><span id="l2.103"> }</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105"> function InitGoMessagesMenu()</span>
<a href="#l2.106"></a><span id="l2.106"> {</span>
<a href="#l2.107"></a><span id="l2.107">   document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l2.108"></a><span id="l2.108"> }</span>
<a href="#l2.109"></a><span id="l2.109"> </span>
<a href="#l2.110"></a><span id="l2.110"> function view_init()</span>
<a href="#l2.111"></a><span id="l2.111"> {</span>
<a href="#l2.112"></a><span id="l2.112">   if (!gMessengerBundle)</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  var message_menuitem=document.getElementById('menu_showMessage');</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l2.116"></a><span id="l2.116"> </span>
<a href="#l2.117"></a><span id="l2.117" class="difflineminus">-  if (message_menuitem)</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineminus">-  {</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineminus">-      var message_menuitem_hidden = message_menuitem.getAttribute(&quot;hidden&quot;);</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-      if(message_menuitem_hidden != &quot;true&quot;){</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-          message_menuitem.setAttribute('checked', !IsMessagePaneCollapsed());</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineminus">-          message_menuitem.setAttribute('disabled', gAccountCentralLoaded);</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineminus">-      }</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  var messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+    messagePaneMenuItem.setAttribute(&quot;checked&quot;, !IsMessagePaneCollapsed());</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+    messagePaneMenuItem.disabled = gAccountCentralLoaded;</span>
<a href="#l2.128"></a><span id="l2.128">   }</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">   // Disable some menus if account manager is showing</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-  var sort_menuitem = document.getElementById('viewSortMenu');</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-  if (sort_menuitem) {</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-    sort_menuitem.setAttribute(&quot;disabled&quot;, gAccountCentralLoaded);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineminus">-  }</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-  var view_menuitem = document.getElementById('viewMessageViewMenu');</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineminus">-  if (view_menuitem) {</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineminus">-    view_menuitem.setAttribute(&quot;disabled&quot;, gAccountCentralLoaded);</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineminus">-  }</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineminus">-  var threads_menuitem = document.getElementById('viewMessagesMenu');</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineminus">-  if (threads_menuitem) {</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-    threads_menuitem.setAttribute(&quot;disabled&quot;, gAccountCentralLoaded);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-  }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+  document.getElementById(&quot;viewSortMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  document.getElementById(&quot;viewMessageViewMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  document.getElementById(&quot;viewMessagesMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l2.146"></a><span id="l2.146"> </span>
<a href="#l2.147"></a><span id="l2.147" class="difflineminus">-  // hide the views menu item if the user doesn't have the views toolbar button visible</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  // Hide the views menu item if the user doesn't have the views toolbar button</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+  // visible.</span>
<a href="#l2.150"></a><span id="l2.150">   var viewsToolbarButton = document.getElementById(&quot;mailviews-container&quot;);</span>
<a href="#l2.151"></a><span id="l2.151">   document.getElementById('viewMessageViewMenu').hidden = !viewsToolbarButton;</span>
<a href="#l2.152"></a><span id="l2.152"> </span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-  // ... and also the separator</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  // ... and also the separator.</span>
<a href="#l2.155"></a><span id="l2.155">   document.getElementById(&quot;viewMenuAfterTaskbarSeparator&quot;).hidden = !viewsToolbarButton;</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157">   // Initialize the View Attachment Inline menu</span>
<a href="#l2.158"></a><span id="l2.158">   var viewAttachmentInline = pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineminus">-  document.getElementById(&quot;viewAttachmentsInlineMenuitem&quot;).setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  document.getElementById(&quot;viewAttachmentsInlineMenuitem&quot;)</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+          .setAttribute(&quot;checked&quot;, viewAttachmentInline);</span>
<a href="#l2.162"></a><span id="l2.162"> </span>
<a href="#l2.163"></a><span id="l2.163">   document.commandDispatcher.updateCommands('create-menu-view');</span>
<a href="#l2.164"></a><span id="l2.164"> }</span>
<a href="#l2.165"></a><span id="l2.165"> </span>
<a href="#l2.166"></a><span id="l2.166"> function InitViewLayoutStyleMenu(event)</span>
<a href="#l2.167"></a><span id="l2.167"> {</span>
<a href="#l2.168"></a><span id="l2.168">   var paneConfig = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l2.169"></a><span id="l2.169">   var layoutStyleMenuitem = event.target.childNodes[paneConfig];</span>
<a href="#l2.170"></a><span id="l2.170">   if (layoutStyleMenuitem)</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineminus">-    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;); </span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l2.173"></a><span id="l2.173"> }</span>
<a href="#l2.174"></a><span id="l2.174"> </span>
<a href="#l2.175"></a><span id="l2.175"> function InitViewFolderViewsMenu(event)</span>
<a href="#l2.176"></a><span id="l2.176"> {</span>
<a href="#l2.177"></a><span id="l2.177">   var layoutStyleMenuitem = event.target.childNodes[gCurrentFolderView];</span>
<a href="#l2.178"></a><span id="l2.178">   if (layoutStyleMenuitem)</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;); </span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+    layoutStyleMenuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l2.181"></a><span id="l2.181"> }</span>
<a href="#l2.182"></a><span id="l2.182"> </span>
<a href="#l2.183"></a><span id="l2.183"> function setSortByMenuItemCheckState(id, value)</span>
<a href="#l2.184"></a><span id="l2.184"> {</span>
<a href="#l2.185"></a><span id="l2.185">   var menuitem = document.getElementById(id);</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-  if (menuitem) </span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+  if (menuitem)</span>
<a href="#l2.188"></a><span id="l2.188">     menuitem.setAttribute(&quot;checked&quot;, value);</span>
<a href="#l2.189"></a><span id="l2.189"> }</span>
<a href="#l2.190"></a><span id="l2.190"> </span>
<a href="#l2.191"></a><span id="l2.191"> function InitViewSortByMenu()</span>
<a href="#l2.192"></a><span id="l2.192"> {</span>
<a href="#l2.193"></a><span id="l2.193">   var sortType = gDBView.sortType;</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">   setSortByMenuItemCheckState(&quot;sortByDateMenuitem&quot;, (sortType == nsMsgViewSortType.byDate));</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineat">@@ -227,26 +217,27 @@ function InitViewSortByMenu()</span>
<a href="#l2.197"></a><span id="l2.197">   setSortByMenuItemCheckState(&quot;sortByPriorityMenuitem&quot;, (sortType == nsMsgViewSortType.byPriority));</span>
<a href="#l2.198"></a><span id="l2.198">   setSortByMenuItemCheckState(&quot;sortBySizeMenuitem&quot;, (sortType == nsMsgViewSortType.bySize));</span>
<a href="#l2.199"></a><span id="l2.199">   setSortByMenuItemCheckState(&quot;sortByStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byStatus));</span>
<a href="#l2.200"></a><span id="l2.200">   setSortByMenuItemCheckState(&quot;sortBySubjectMenuitem&quot;, (sortType == nsMsgViewSortType.bySubject));</span>
<a href="#l2.201"></a><span id="l2.201">   setSortByMenuItemCheckState(&quot;sortByUnreadMenuitem&quot;, (sortType == nsMsgViewSortType.byUnread));</span>
<a href="#l2.202"></a><span id="l2.202">   setSortByMenuItemCheckState(&quot;sortByTagsMenuitem&quot;, (sortType == nsMsgViewSortType.byTags));</span>
<a href="#l2.203"></a><span id="l2.203">   setSortByMenuItemCheckState(&quot;sortByJunkStatusMenuitem&quot;, (sortType == nsMsgViewSortType.byJunkStatus));</span>
<a href="#l2.204"></a><span id="l2.204">   setSortByMenuItemCheckState(&quot;sortByFromMenuitem&quot;, (sortType == nsMsgViewSortType.byAuthor));</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByRecipientMenuitem&quot;, (sortType == nsMsgViewSortType.byRecipient)); </span>
<a href="#l2.206"></a><span id="l2.206" class="difflineminus">-  setSortByMenuItemCheckState(&quot;sortByAttachmentsMenuitem&quot;, (sortType == nsMsgViewSortType.byAttachments));   </span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  setSortByMenuItemCheckState(&quot;sortByRecipientMenuitem&quot;, (sortType == nsMsgViewSortType.byRecipient));</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+  setSortByMenuItemCheckState(&quot;sortByAttachmentsMenuitem&quot;, (sortType == nsMsgViewSortType.byAttachments));</span>
<a href="#l2.209"></a><span id="l2.209"> </span>
<a href="#l2.210"></a><span id="l2.210">   var sortOrder = gDBView.sortOrder;</span>
<a href="#l2.211"></a><span id="l2.211" class="difflineminus">-  var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor </span>
<a href="#l2.212"></a><span id="l2.212" class="difflineminus">-      || sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived || sortType == nsMsgViewSortType.byPriority</span>
<a href="#l2.213"></a><span id="l2.213" class="difflineminus">-      || sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags</span>
<a href="#l2.214"></a><span id="l2.214" class="difflineminus">-      || sortType == nsMsgViewSortType.byRecipient || sortType == nsMsgViewSortType.byAccount</span>
<a href="#l2.215"></a><span id="l2.215" class="difflineminus">-      || sortType == nsMsgViewSortType.byStatus || sortType == nsMsgViewSortType.byFlagged</span>
<a href="#l2.216"></a><span id="l2.216" class="difflineminus">-      || sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineplus">+  var sortTypeSupportsGrouping = (sortType == nsMsgViewSortType.byAuthor ||</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+      sortType == nsMsgViewSortType.byDate || sortType == nsMsgViewSortType.byReceived ||</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineplus">+      sortType == nsMsgViewSortType.byPriority ||</span>
<a href="#l2.220"></a><span id="l2.220" class="difflineplus">+      sortType == nsMsgViewSortType.bySubject || sortType == nsMsgViewSortType.byTags ||</span>
<a href="#l2.221"></a><span id="l2.221" class="difflineplus">+      sortType == nsMsgViewSortType.byRecipient || sortType == nsMsgViewSortType.byAccount ||</span>
<a href="#l2.222"></a><span id="l2.222" class="difflineplus">+      sortType == nsMsgViewSortType.byStatus || sortType == nsMsgViewSortType.byFlagged ||</span>
<a href="#l2.223"></a><span id="l2.223" class="difflineplus">+      sortType == nsMsgViewSortType.byAttachments);</span>
<a href="#l2.224"></a><span id="l2.224"> </span>
<a href="#l2.225"></a><span id="l2.225">   setSortByMenuItemCheckState(&quot;sortAscending&quot;, (sortOrder == nsMsgViewSortOrder.ascending));</span>
<a href="#l2.226"></a><span id="l2.226">   setSortByMenuItemCheckState(&quot;sortDescending&quot;, (sortOrder == nsMsgViewSortOrder.descending));</span>
<a href="#l2.227"></a><span id="l2.227"> </span>
<a href="#l2.228"></a><span id="l2.228">   var grouped = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kGroupBySort) != 0);</span>
<a href="#l2.229"></a><span id="l2.229">   var threaded = ((gDBView.viewFlags &amp; nsMsgViewFlagsType.kThreadedDisplay) != 0 &amp;&amp; !grouped);</span>
<a href="#l2.230"></a><span id="l2.230">   var sortThreadedMenuItem = document.getElementById(&quot;sortThreaded&quot;);</span>
<a href="#l2.231"></a><span id="l2.231">   var sortUnthreadedMenuItem = document.getElementById(&quot;sortUnthreaded&quot;);</span>
<a href="#l2.232"></a><span id="l2.232" class="difflineat">@@ -260,151 +251,121 @@ function InitViewSortByMenu()</span>
<a href="#l2.233"></a><span id="l2.233">   groupBySortOrderMenuItem.setAttribute(&quot;checked&quot;, grouped);</span>
<a href="#l2.234"></a><span id="l2.234"> }</span>
<a href="#l2.235"></a><span id="l2.235"> </span>
<a href="#l2.236"></a><span id="l2.236"> function InitViewMessagesMenu()</span>
<a href="#l2.237"></a><span id="l2.237"> {</span>
<a href="#l2.238"></a><span id="l2.238">   var viewFlags = (gDBView) ? gDBView.viewFlags : 0;</span>
<a href="#l2.239"></a><span id="l2.239">   var viewType = (gDBView) ? gDBView.viewType : 0;</span>
<a href="#l2.240"></a><span id="l2.240"> </span>
<a href="#l2.241"></a><span id="l2.241" class="difflineminus">-  var allMenuItem = document.getElementById(&quot;viewAllMessagesMenuItem&quot;);</span>
<a href="#l2.242"></a><span id="l2.242" class="difflineminus">-  if(allMenuItem)</span>
<a href="#l2.243"></a><span id="l2.243" class="difflineminus">-      allMenuItem.setAttribute(&quot;checked&quot;,  (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) == 0 &amp;&amp; (viewType == nsMsgViewType.eShowAllThreads));</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+  document.getElementById(&quot;viewAllMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) == 0 &amp;&amp;</span>
<a href="#l2.246"></a><span id="l2.246" class="difflineplus">+    (viewType == nsMsgViewType.eShowAllThreads));</span>
<a href="#l2.247"></a><span id="l2.247"> </span>
<a href="#l2.248"></a><span id="l2.248" class="difflineminus">-  var unreadMenuItem = document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;);</span>
<a href="#l2.249"></a><span id="l2.249" class="difflineminus">-  if(unreadMenuItem)</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineminus">-      unreadMenuItem.setAttribute(&quot;checked&quot;, (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) != 0);</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+  document.getElementById(&quot;viewUnreadMessagesMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+    (viewFlags &amp; nsMsgViewFlagsType.kUnreadOnly) != 0);</span>
<a href="#l2.253"></a><span id="l2.253"> </span>
<a href="#l2.254"></a><span id="l2.254" class="difflineminus">-  var theadsWithUnreadMenuItem = document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;);</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineminus">-  if(theadsWithUnreadMenuItem)</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineminus">-      theadsWithUnreadMenuItem.setAttribute(&quot;checked&quot;, viewType == nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+  document.getElementById(&quot;viewThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+    viewType == nsMsgViewType.eShowThreadsWithUnread);</span>
<a href="#l2.259"></a><span id="l2.259"> </span>
<a href="#l2.260"></a><span id="l2.260" class="difflineminus">-  var watchedTheadsWithUnreadMenuItem = document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;);</span>
<a href="#l2.261"></a><span id="l2.261" class="difflineminus">-  if(watchedTheadsWithUnreadMenuItem)</span>
<a href="#l2.262"></a><span id="l2.262" class="difflineminus">-      watchedTheadsWithUnreadMenuItem.setAttribute(&quot;checked&quot;, viewType == nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-  </span>
<a href="#l2.264"></a><span id="l2.264" class="difflineminus">-  var ignoredTheadsMenuItem = document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;);</span>
<a href="#l2.265"></a><span id="l2.265" class="difflineminus">-  if(ignoredTheadsMenuItem)</span>
<a href="#l2.266"></a><span id="l2.266" class="difflineminus">-      ignoredTheadsMenuItem.setAttribute(&quot;checked&quot;, (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored) != 0);</span>
<a href="#l2.267"></a><span id="l2.267" class="difflineplus">+  document.getElementById(&quot;viewWatchedThreadsWithUnreadMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineplus">+    viewType == nsMsgViewType.eShowWatchedThreadsWithUnread);</span>
<a href="#l2.269"></a><span id="l2.269" class="difflineplus">+</span>
<a href="#l2.270"></a><span id="l2.270" class="difflineplus">+  document.getElementById(&quot;viewIgnoredThreadsMenuItem&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l2.271"></a><span id="l2.271" class="difflineplus">+    (viewFlags &amp; nsMsgViewFlagsType.kShowIgnored) != 0);</span>
<a href="#l2.272"></a><span id="l2.272"> }</span>
<a href="#l2.273"></a><span id="l2.273"> </span>
<a href="#l2.274"></a><span id="l2.274"> function InitMessageMenu()</span>
<a href="#l2.275"></a><span id="l2.275"> {</span>
<a href="#l2.276"></a><span id="l2.276" class="difflineminus">-  var aMessage = GetFirstSelectedMessage();</span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-  var isNews = false;</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-  if(aMessage)</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineminus">-    isNews = IsNewsMessage(aMessage);</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+  var selectedMsg = GetFirstSelectedMessage();</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+  var isNews = IsNewsMessage(selectedMsg);</span>
<a href="#l2.282"></a><span id="l2.282"> </span>
<a href="#l2.283"></a><span id="l2.283" class="difflineminus">-  //We show reply to Newsgroups only for news messages.</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineminus">-  var replyNewsgroupMenuItem = document.getElementById(&quot;replyNewsgroupMainMenu&quot;);</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineminus">-  if(replyNewsgroupMenuItem)</span>
<a href="#l2.286"></a><span id="l2.286" class="difflineminus">-    replyNewsgroupMenuItem.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.287"></a><span id="l2.287" class="difflineplus">+  // We show reply to Newsgroups only for news messages.</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineplus">+  document.getElementById(&quot;replyNewsgroupMainMenu&quot;).hidden = !isNews;</span>
<a href="#l2.289"></a><span id="l2.289"> </span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-  //For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineminus">-  var replyMenuItem = document.getElementById(&quot;replyMainMenu&quot;);</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineminus">-  if(replyMenuItem)</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineminus">-    replyMenuItem.setAttribute(&quot;hidden&quot;, !isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineminus">-</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineminus">-  var replySenderMenuItem = document.getElementById(&quot;replySenderMainMenu&quot;);</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineminus">-  if(replySenderMenuItem)</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineminus">-    replySenderMenuItem.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+  // For mail messages we say reply. For news we say ReplyToSender.</span>
<a href="#l2.299"></a><span id="l2.299" class="difflineplus">+  document.getElementById(&quot;replyMainMenu&quot;).hidden = isNews;</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineplus">+  document.getElementById(&quot;replySenderMainMenu&quot;).hidden = !isNews;</span>
<a href="#l2.301"></a><span id="l2.301"> </span>
<a href="#l2.302"></a><span id="l2.302" class="difflineminus">-  // we only kill and watch threads for news</span>
<a href="#l2.303"></a><span id="l2.303" class="difflineminus">-  var threadMenuSeparator = document.getElementById(&quot;threadItemsSeparator&quot;);</span>
<a href="#l2.304"></a><span id="l2.304" class="difflineminus">-  if (threadMenuSeparator)</span>
<a href="#l2.305"></a><span id="l2.305" class="difflineminus">-    threadMenuSeparator.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.306"></a><span id="l2.306" class="difflineminus">-  var killThreadMenuItem = document.getElementById(&quot;killThread&quot;);</span>
<a href="#l2.307"></a><span id="l2.307" class="difflineminus">-  if (killThreadMenuItem)</span>
<a href="#l2.308"></a><span id="l2.308" class="difflineminus">-    killThreadMenuItem.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.309"></a><span id="l2.309" class="difflineminus">-  var killSubthreadMenuItem = document.getElementById(&quot;killSubthread&quot;);</span>
<a href="#l2.310"></a><span id="l2.310" class="difflineminus">-  if (killSubthreadMenuItem)</span>
<a href="#l2.311"></a><span id="l2.311" class="difflineminus">-    killSubthreadMenuItem.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.312"></a><span id="l2.312" class="difflineminus">-  var watchThreadMenuItem = document.getElementById(&quot;watchThread&quot;);</span>
<a href="#l2.313"></a><span id="l2.313" class="difflineminus">-  if (watchThreadMenuItem)</span>
<a href="#l2.314"></a><span id="l2.314" class="difflineminus">-    watchThreadMenuItem.setAttribute(&quot;hidden&quot;, isNews ? &quot;&quot; : &quot;true&quot;);</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineplus">+  // We only kill and watch threads for news.</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+  document.getElementById(&quot;threadItemsSeparator&quot;).hidden = !isNews;</span>
<a href="#l2.317"></a><span id="l2.317" class="difflineplus">+  document.getElementById(&quot;killThread&quot;).hidden = !isNews;</span>
<a href="#l2.318"></a><span id="l2.318" class="difflineplus">+  document.getElementById(&quot;killSubthread&quot;).hidden = !isNews;</span>
<a href="#l2.319"></a><span id="l2.319" class="difflineplus">+  document.getElementById(&quot;watchThread&quot;).hidden = !isNews;</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321" class="difflineminus">-  // disable the move and copy menus if there are no messages selected.</span>
<a href="#l2.322"></a><span id="l2.322" class="difflineminus">-  // disable the move menu if we can't delete msgs from the folder</span>
<a href="#l2.323"></a><span id="l2.323" class="difflineminus">-  var moveMenu = document.getElementById(&quot;moveMenu&quot;);</span>
<a href="#l2.324"></a><span id="l2.324" class="difflineplus">+  // Disable the move and copy menus if there are no messages selected.</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineplus">+  // Disable the move menu if we can't delete msgs from the folder.</span>
<a href="#l2.326"></a><span id="l2.326">   var msgFolder = GetLoadedMsgFolder();</span>
<a href="#l2.327"></a><span id="l2.327" class="difflineminus">-  if(moveMenu)</span>
<a href="#l2.328"></a><span id="l2.328" class="difflineminus">-  {</span>
<a href="#l2.329"></a><span id="l2.329" class="difflineminus">-    var enableMenuItem = aMessage &amp;&amp; msgFolder &amp;&amp; msgFolder.canDeleteMessages;</span>
<a href="#l2.330"></a><span id="l2.330" class="difflineminus">-    moveMenu.setAttribute(&quot;disabled&quot;, !enableMenuItem);</span>
<a href="#l2.331"></a><span id="l2.331" class="difflineminus">-  }</span>
<a href="#l2.332"></a><span id="l2.332" class="difflineplus">+  var enableMenuItem = selectedMsg &amp;&amp; msgFolder &amp;&amp; msgFolder.canDeleteMessages;</span>
<a href="#l2.333"></a><span id="l2.333" class="difflineplus">+  document.getElementById(&quot;moveMenu&quot;).disabled = !enableMenuItem;</span>
<a href="#l2.334"></a><span id="l2.334"> </span>
<a href="#l2.335"></a><span id="l2.335" class="difflineminus">-  var copyMenu = document.getElementById(&quot;copyMenu&quot;);</span>
<a href="#l2.336"></a><span id="l2.336" class="difflineminus">-  if(copyMenu)</span>
<a href="#l2.337"></a><span id="l2.337" class="difflineminus">-    copyMenu.setAttribute(&quot;disabled&quot;, !aMessage);</span>
<a href="#l2.338"></a><span id="l2.338" class="difflineminus">-  </span>
<a href="#l2.339"></a><span id="l2.339" class="difflineplus">+  // Also disable copy when no folder is loaded (like for .eml files).</span>
<a href="#l2.340"></a><span id="l2.340" class="difflineplus">+  document.getElementById(&quot;copyMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l2.341"></a><span id="l2.341" class="difflineplus">+</span>
<a href="#l2.342"></a><span id="l2.342">   initMoveToFolderAgainMenu(document.getElementById(&quot;moveToFolderAgain&quot;));</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344" class="difflineminus">-  // Disable Forward as/Label menu items if no message is selected</span>
<a href="#l2.345"></a><span id="l2.345" class="difflineminus">-  var forwardAsMenu = document.getElementById(&quot;forwardAsMenu&quot;);</span>
<a href="#l2.346"></a><span id="l2.346" class="difflineminus">-  if(forwardAsMenu)</span>
<a href="#l2.347"></a><span id="l2.347" class="difflineminus">-    forwardAsMenu.setAttribute(&quot;disabled&quot;, !aMessage);</span>
<a href="#l2.348"></a><span id="l2.348" class="difflineplus">+  // Disable the Forward As menu item if no message is selected.</span>
<a href="#l2.349"></a><span id="l2.349" class="difflineplus">+  document.getElementById(&quot;forwardAsMenu&quot;).disabled = !selectedMsg;</span>
<a href="#l2.350"></a><span id="l2.350"> </span>
<a href="#l2.351"></a><span id="l2.351" class="difflineminus">-  var labelMenu = document.getElementById(&quot;labelMenu&quot;);</span>
<a href="#l2.352"></a><span id="l2.352" class="difflineminus">-  if(labelMenu)</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-    labelMenu.setAttribute(&quot;disabled&quot;, !aMessage);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+  // Disable the Tag menu item if no message is selected or when we're</span>
<a href="#l2.355"></a><span id="l2.355" class="difflineplus">+  // not in a folder.</span>
<a href="#l2.356"></a><span id="l2.356" class="difflineplus">+  document.getElementById(&quot;tagMenu&quot;).disabled = !(selectedMsg &amp;&amp; msgFolder);</span>
<a href="#l2.357"></a><span id="l2.357"> </span>
<a href="#l2.358"></a><span id="l2.358" class="difflineminus">-  // Disable mark menu when we're not in a folder</span>
<a href="#l2.359"></a><span id="l2.359" class="difflineminus">-  var markMenu = document.getElementById(&quot;markMenu&quot;);</span>
<a href="#l2.360"></a><span id="l2.360" class="difflineminus">-  if(markMenu)</span>
<a href="#l2.361"></a><span id="l2.361" class="difflineminus">-    markMenu.setAttribute(&quot;disabled&quot;, !msgFolder);</span>
<a href="#l2.362"></a><span id="l2.362" class="difflineplus">+  // Disable mark menu when we're not in a folder.</span>
<a href="#l2.363"></a><span id="l2.363" class="difflineplus">+  document.getElementById(&quot;markMenu&quot;).disabled = !msgFolder;</span>
<a href="#l2.364"></a><span id="l2.364"> </span>
<a href="#l2.365"></a><span id="l2.365">   document.commandDispatcher.updateCommands('create-menu-message');</span>
<a href="#l2.366"></a><span id="l2.366"> }</span>
<a href="#l2.367"></a><span id="l2.367"> </span>
<a href="#l2.368"></a><span id="l2.368" class="difflineminus">-// initMoveToFolderAgainMenu</span>
<a href="#l2.369"></a><span id="l2.369" class="difflineminus">-// enables / disables aMenuItem based on the value of mail.last_msg_movecopy_target_uri</span>
<a href="#l2.370"></a><span id="l2.370" class="difflineminus">-// Adjusts the label and accesskey for aMenuItem to include the folder name</span>
<a href="#l2.371"></a><span id="l2.371" class="difflineplus">+/**</span>
<a href="#l2.372"></a><span id="l2.372" class="difflineplus">+ * Enables / disables aMenuItem based on the value of</span>
<a href="#l2.373"></a><span id="l2.373" class="difflineplus">+ * mail.last_msg_movecopy_target_uri and  adjusts the label and accesskey</span>
<a href="#l2.374"></a><span id="l2.374" class="difflineplus">+ * for aMenuItem to include the folder name.</span>
<a href="#l2.375"></a><span id="l2.375" class="difflineplus">+ */</span>
<a href="#l2.376"></a><span id="l2.376"> function initMoveToFolderAgainMenu(aMenuItem)</span>
<a href="#l2.377"></a><span id="l2.377"> {</span>
<a href="#l2.378"></a><span id="l2.378">   var lastFolderURI = pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l2.379"></a><span id="l2.379" class="difflineminus">-  var isMove = pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);  </span>
<a href="#l2.380"></a><span id="l2.380" class="difflineplus">+  var isMove = pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;);</span>
<a href="#l2.381"></a><span id="l2.381">   if (lastFolderURI)</span>
<a href="#l2.382"></a><span id="l2.382">   {</span>
<a href="#l2.383"></a><span id="l2.383">     var destMsgFolder = GetMsgFolderFromUri(lastFolderURI);</span>
<a href="#l2.384"></a><span id="l2.384" class="difflineminus">-    aMenuItem.label = gMessengerBundle.getFormattedString(isMove ? </span>
<a href="#l2.385"></a><span id="l2.385" class="difflineminus">-                                                          &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;,</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-                                                          [destMsgFolder.prettyName], 1);</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineminus">-    aMenuItem.setAttribute('accesskey', </span>
<a href="#l2.388"></a><span id="l2.388" class="difflineminus">-                           gMessengerBundle.getString(isMove ? </span>
<a href="#l2.389"></a><span id="l2.389" class="difflineminus">-                                                      &quot;moveToFolderAgainAccessKey&quot; : &quot;copyToFolderAgainAccessKey&quot;));</span>
<a href="#l2.390"></a><span id="l2.390" class="difflineplus">+    aMenuItem.label = gMessengerBundle.getFormattedString(isMove ?</span>
<a href="#l2.391"></a><span id="l2.391" class="difflineplus">+      &quot;moveToFolderAgain&quot; : &quot;copyToFolderAgain&quot;, [destMsgFolder.prettyName], 1);</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineplus">+    aMenuItem.accesskey = gMessengerBundle.getString(isMove ?</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+      &quot;moveToFolderAgainAccessKey&quot; : &quot;copyToFolderAgainAccessKey&quot;);</span>
<a href="#l2.394"></a><span id="l2.394">   }</span>
<a href="#l2.395"></a><span id="l2.395"> }</span>
<a href="#l2.396"></a><span id="l2.396"> </span>
<a href="#l2.397"></a><span id="l2.397"> function InitViewHeadersMenu()</span>
<a href="#l2.398"></a><span id="l2.398"> {</span>
<a href="#l2.399"></a><span id="l2.399" class="difflineminus">-  var id = null;</span>
<a href="#l2.400"></a><span id="l2.400">   var headerchoice = 1;</span>
<a href="#l2.401"></a><span id="l2.401" class="difflineminus">-  try </span>
<a href="#l2.402"></a><span id="l2.402" class="difflineplus">+  try</span>
<a href="#l2.403"></a><span id="l2.403">   {</span>
<a href="#l2.404"></a><span id="l2.404">     headerchoice = pref.getIntPref(&quot;mail.show_headers&quot;);</span>
<a href="#l2.405"></a><span id="l2.405">   }</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineminus">-  catch (ex) </span>
<a href="#l2.407"></a><span id="l2.407" class="difflineplus">+  catch (ex)</span>
<a href="#l2.408"></a><span id="l2.408">   {</span>
<a href="#l2.409"></a><span id="l2.409">     dump(&quot;failed to get the header pref\n&quot;);</span>
<a href="#l2.410"></a><span id="l2.410">   }</span>
<a href="#l2.411"></a><span id="l2.411"> </span>
<a href="#l2.412"></a><span id="l2.412" class="difflineminus">-  switch (headerchoice) </span>
<a href="#l2.413"></a><span id="l2.413" class="difflineplus">+  var id = null;</span>
<a href="#l2.414"></a><span id="l2.414" class="difflineplus">+  switch (headerchoice)</span>
<a href="#l2.415"></a><span id="l2.415">   {</span>
<a href="#l2.416"></a><span id="l2.416" class="difflineminus">-  case 2:  </span>
<a href="#l2.417"></a><span id="l2.417" class="difflineminus">-    id = &quot;viewallheaders&quot;;</span>
<a href="#l2.418"></a><span id="l2.418" class="difflineminus">-    break;</span>
<a href="#l2.419"></a><span id="l2.419" class="difflineminus">-  case 1:  </span>
<a href="#l2.420"></a><span id="l2.420" class="difflineminus">-  default:</span>
<a href="#l2.421"></a><span id="l2.421" class="difflineminus">-    id = &quot;viewnormalheaders&quot;;</span>
<a href="#l2.422"></a><span id="l2.422" class="difflineminus">-    break;</span>
<a href="#l2.423"></a><span id="l2.423" class="difflineplus">+    case 2:</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineplus">+      id = &quot;viewallheaders&quot;;</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+      break;</span>
<a href="#l2.426"></a><span id="l2.426" class="difflineplus">+    case 1:</span>
<a href="#l2.427"></a><span id="l2.427" class="difflineplus">+    default:</span>
<a href="#l2.428"></a><span id="l2.428" class="difflineplus">+      id = &quot;viewnormalheaders&quot;;</span>
<a href="#l2.429"></a><span id="l2.429" class="difflineplus">+      break;</span>
<a href="#l2.430"></a><span id="l2.430">   }</span>
<a href="#l2.431"></a><span id="l2.431"> </span>
<a href="#l2.432"></a><span id="l2.432">   var menuitem = document.getElementById(id);</span>
<a href="#l2.433"></a><span id="l2.433">   if (menuitem)</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineminus">-    menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;); </span>
<a href="#l2.435"></a><span id="l2.435" class="difflineplus">+    menuitem.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l2.436"></a><span id="l2.436"> }</span>
<a href="#l2.437"></a><span id="l2.437"> </span>
<a href="#l2.438"></a><span id="l2.438"> function InitViewBodyMenu()</span>
<a href="#l2.439"></a><span id="l2.439"> {</span>
<a href="#l2.440"></a><span id="l2.440">   var html_as = 0;</span>
<a href="#l2.441"></a><span id="l2.441">   var prefer_plaintext = false;</span>
<a href="#l2.442"></a><span id="l2.442">   var disallow_classes = 0;</span>
<a href="#l2.443"></a><span id="l2.443">   try</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineat">@@ -470,31 +431,31 @@ function RemoveAllMessageTags()</span>
<a href="#l2.445"></a><span id="l2.445"> </span>
<a href="#l2.446"></a><span id="l2.446">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.447"></a><span id="l2.447">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.448"></a><span id="l2.448">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l2.449"></a><span id="l2.449">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l2.450"></a><span id="l2.450">   var tagArray = tagService.getAllTags({});</span>
<a href="#l2.451"></a><span id="l2.451"> </span>
<a href="#l2.452"></a><span id="l2.452">   var allKeys = &quot;&quot;;</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineminus">-  for (j = 0; j &lt; tagArray.length; ++j)</span>
<a href="#l2.454"></a><span id="l2.454" class="difflineplus">+  for (var j = 0; j &lt; tagArray.length; ++j)</span>
<a href="#l2.455"></a><span id="l2.455">   {</span>
<a href="#l2.456"></a><span id="l2.456">     if (j)</span>
<a href="#l2.457"></a><span id="l2.457">       allKeys += &quot; &quot;;</span>
<a href="#l2.458"></a><span id="l2.458">     allKeys += tagArray[j].key;</span>
<a href="#l2.459"></a><span id="l2.459">   }</span>
<a href="#l2.460"></a><span id="l2.460"> </span>
<a href="#l2.461"></a><span id="l2.461">   var prevHdrFolder = null;</span>
<a href="#l2.462"></a><span id="l2.462">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l2.463"></a><span id="l2.463">   // that spans folders, by coalescing consecutive messages in the selection</span>
<a href="#l2.464"></a><span id="l2.464">   // that happen to be in the same folder. nsMsgSearchDBView does this better,</span>
<a href="#l2.465"></a><span id="l2.465">   // but nsIMsgDBView doesn't handle commands with arguments, and untag takes a</span>
<a href="#l2.466"></a><span id="l2.466">   // key argument. Furthermore, we only delete legacy labels and known tags,</span>
<a href="#l2.467"></a><span id="l2.467">   // keeping other keywords like (non)junk intact.</span>
<a href="#l2.468"></a><span id="l2.468" class="difflineminus">-  var j;</span>
<a href="#l2.469"></a><span id="l2.469" class="difflineplus">+</span>
<a href="#l2.470"></a><span id="l2.470">   for (var i = 0; i &lt; selectedMsgUris.length; ++i)</span>
<a href="#l2.471"></a><span id="l2.471">   {</span>
<a href="#l2.472"></a><span id="l2.472">     var msgHdr = messenger.msgHdrFromURI(selectedMsgUris[i]);</span>
<a href="#l2.473"></a><span id="l2.473">     msgHdr.label = 0; // remove legacy label</span>
<a href="#l2.474"></a><span id="l2.474">     if (prevHdrFolder != msgHdr.folder)</span>
<a href="#l2.475"></a><span id="l2.475">     {</span>
<a href="#l2.476"></a><span id="l2.476">       if (prevHdrFolder)</span>
<a href="#l2.477"></a><span id="l2.477">         prevHdrFolder.removeKeywordsFromMessages(messages, allKeys);</span>
<a href="#l2.478"></a><span id="l2.478" class="difflineat">@@ -516,17 +477,17 @@ function ToggleMessageTagKey(index)</span>
<a href="#l2.479"></a><span id="l2.479">   // just like we do for markAsRead etc.</span>
<a href="#l2.480"></a><span id="l2.480">   var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.481"></a><span id="l2.481">   var tagService = Components.classes[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l2.482"></a><span id="l2.482">                              .getService(Components.interfaces.nsIMsgTagService);</span>
<a href="#l2.483"></a><span id="l2.483">   var tagArray = tagService.getAllTags({});</span>
<a href="#l2.484"></a><span id="l2.484">   for (var i = 0; i &lt; tagArray.length; ++i)</span>
<a href="#l2.485"></a><span id="l2.485">   {</span>
<a href="#l2.486"></a><span id="l2.486">     var key = tagArray[i].key;</span>
<a href="#l2.487"></a><span id="l2.487" class="difflineminus">-    if (!--index) </span>
<a href="#l2.488"></a><span id="l2.488" class="difflineplus">+    if (!--index)</span>
<a href="#l2.489"></a><span id="l2.489">     {</span>
<a href="#l2.490"></a><span id="l2.490">       // found the key, now toggle its state</span>
<a href="#l2.491"></a><span id="l2.491">       var curKeys = msgHdr.getStringProperty(&quot;keywords&quot;);</span>
<a href="#l2.492"></a><span id="l2.492">       if (msgHdr.label)</span>
<a href="#l2.493"></a><span id="l2.493">         curKeys += &quot; $label&quot; + msgHdr.label;</span>
<a href="#l2.494"></a><span id="l2.494">       var addKey  = (&quot; &quot; + curKeys + &quot; &quot;).indexOf(&quot; &quot; + key + &quot; &quot;) &lt; 0;</span>
<a href="#l2.495"></a><span id="l2.495">       ToggleMessageTag(key, addKey);</span>
<a href="#l2.496"></a><span id="l2.496">       return;</span>
<a href="#l2.497"></a><span id="l2.497" class="difflineat">@@ -541,17 +502,17 @@ function ToggleMessageTagMenu(target)</span>
<a href="#l2.498"></a><span id="l2.498">   ToggleMessageTag(key, addKey);</span>
<a href="#l2.499"></a><span id="l2.499"> }</span>
<a href="#l2.500"></a><span id="l2.500"> </span>
<a href="#l2.501"></a><span id="l2.501"> function ToggleMessageTag(key, addKey)</span>
<a href="#l2.502"></a><span id="l2.502"> {</span>
<a href="#l2.503"></a><span id="l2.503">   var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.504"></a><span id="l2.504">                            .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.505"></a><span id="l2.505">   var msg = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.506"></a><span id="l2.506" class="difflineminus">-                          .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.507"></a><span id="l2.507" class="difflineplus">+                      .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.508"></a><span id="l2.508">   var selectedMsgUris = GetSelectedMessages();</span>
<a href="#l2.509"></a><span id="l2.509">   var toggler = addKey ? &quot;addKeywordsToMessages&quot; : &quot;removeKeywordsFromMessages&quot;;</span>
<a href="#l2.510"></a><span id="l2.510">   var prevHdrFolder = null;</span>
<a href="#l2.511"></a><span id="l2.511">   // this crudely handles cross-folder virtual folders with selected messages</span>
<a href="#l2.512"></a><span id="l2.512">   // that spans folders, by coalescing consecutive msgs in the selection</span>
<a href="#l2.513"></a><span id="l2.513">   // that happen to be in the same folder. nsMsgSearchDBView does this</span>
<a href="#l2.514"></a><span id="l2.514">   // better, but nsIMsgDBView doesn't handle commands with arguments,</span>
<a href="#l2.515"></a><span id="l2.515">   // and (un)tag takes a key argument.</span>
<a href="#l2.516"></a><span id="l2.516" class="difflineat">@@ -696,29 +657,28 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l2.517"></a><span id="l2.517">   var newMenuItem;</span>
<a href="#l2.518"></a><span id="l2.518">   if (GetLoadedMessage())</span>
<a href="#l2.519"></a><span id="l2.519">   {</span>
<a href="#l2.520"></a><span id="l2.520">     if (!isBackMenu)</span>
<a href="#l2.521"></a><span id="l2.521">       curPos.value += 2;</span>
<a href="#l2.522"></a><span id="l2.522">     else</span>
<a href="#l2.523"></a><span id="l2.523">       curPos.value -= 2;</span>
<a href="#l2.524"></a><span id="l2.524">   }</span>
<a href="#l2.525"></a><span id="l2.525" class="difflineminus">-  // for populating the back menu, we want the most recently visited</span>
<a href="#l2.526"></a><span id="l2.526" class="difflineplus">+  // For populating the back menu, we want the most recently visited</span>
<a href="#l2.527"></a><span id="l2.527">   // messages first in the menu. So we go backward from curPos to 0.</span>
<a href="#l2.528"></a><span id="l2.528">   // For the forward menu, we want to go forward from curPos to the end.</span>
<a href="#l2.529"></a><span id="l2.529" class="difflineminus">-  </span>
<a href="#l2.530"></a><span id="l2.530">   var relPos = 0;</span>
<a href="#l2.531"></a><span id="l2.531">   for (var i = curPos.value; (isBackMenu) ? i &gt;= 0 : i &lt; historyArray.length; i += ((isBackMenu) ? -2 : 2))</span>
<a href="#l2.532"></a><span id="l2.532">   {</span>
<a href="#l2.533"></a><span id="l2.533">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i] + &quot;\n&quot;);</span>
<a href="#l2.534"></a><span id="l2.534">     navDebug(&quot;history[&quot; + i + &quot;] = &quot; + historyArray[i + 1] + &quot;\n&quot;);</span>
<a href="#l2.535"></a><span id="l2.535">     folder = GetMsgFolderFromUri(historyArray[i + 1])</span>
<a href="#l2.536"></a><span id="l2.536">     navDebug(&quot;folder URI = &quot; + folder.URI + &quot;pretty name &quot; + folder.prettyName + &quot;\n&quot;);</span>
<a href="#l2.537"></a><span id="l2.537">     var menuText = &quot;&quot;;</span>
<a href="#l2.538"></a><span id="l2.538" class="difflineminus">-    </span>
<a href="#l2.539"></a><span id="l2.539" class="difflineplus">+</span>
<a href="#l2.540"></a><span id="l2.540">     var msgHdr = messenger.msgHdrFromURI(historyArray[i]);</span>
<a href="#l2.541"></a><span id="l2.541">     if (!IsCurrentLoadedFolder(folder))</span>
<a href="#l2.542"></a><span id="l2.542">       menuText = folder.prettyName + &quot; - &quot;;</span>
<a href="#l2.543"></a><span id="l2.543"> </span>
<a href="#l2.544"></a><span id="l2.544">     var subject = &quot;&quot;;</span>
<a href="#l2.545"></a><span id="l2.545">     if(msgHdr.flags &amp; MSG_FLAG_HAS_RE)</span>
<a href="#l2.546"></a><span id="l2.546">       subject = &quot;Re: &quot;;</span>
<a href="#l2.547"></a><span id="l2.547">     if (msgHdr.mime2DecodedSubject)</span>
<a href="#l2.548"></a><span id="l2.548" class="difflineat">@@ -732,17 +692,16 @@ function populateHistoryMenu(menuPopup, </span>
<a href="#l2.549"></a><span id="l2.549">     relPos += isBackMenu ? -1 : 1;</span>
<a href="#l2.550"></a><span id="l2.550">     newMenuItem.setAttribute('value',  relPos);</span>
<a href="#l2.551"></a><span id="l2.551">     newMenuItem.folder = folder;</span>
<a href="#l2.552"></a><span id="l2.552">     newMenuItem.setAttribute('oncommand', 'NavigateToUri(event.target); event.stopPropagation();');</span>
<a href="#l2.553"></a><span id="l2.553">     menuPopup.appendChild(newMenuItem);</span>
<a href="#l2.554"></a><span id="l2.554">     if (! (relPos % 20))</span>
<a href="#l2.555"></a><span id="l2.555">       break;</span>
<a href="#l2.556"></a><span id="l2.556">   }</span>
<a href="#l2.557"></a><span id="l2.557" class="difflineminus">-  </span>
<a href="#l2.558"></a><span id="l2.558"> }</span>
<a href="#l2.559"></a><span id="l2.559"> </span>
<a href="#l2.560"></a><span id="l2.560"> function NavigateToUri(target)</span>
<a href="#l2.561"></a><span id="l2.561"> {</span>
<a href="#l2.562"></a><span id="l2.562">   var historyIndex = target.getAttribute('value');</span>
<a href="#l2.563"></a><span id="l2.563">   var msgUri = messenger.getMsgUriAtNavigatePos(historyIndex);</span>
<a href="#l2.564"></a><span id="l2.564">   var folder = target.folder;</span>
<a href="#l2.565"></a><span id="l2.565">   var msgHdr = messenger.msgHdrFromURI(msgUri);</span>
<a href="#l2.566"></a><span id="l2.566" class="difflineat">@@ -755,25 +714,21 @@ function NavigateToUri(target)</span>
<a href="#l2.567"></a><span id="l2.567"> </span>
<a href="#l2.568"></a><span id="l2.568"> function forwardToolbarMenu_init(menuPopup)</span>
<a href="#l2.569"></a><span id="l2.569"> {</span>
<a href="#l2.570"></a><span id="l2.570">   populateHistoryMenu(menuPopup, false);</span>
<a href="#l2.571"></a><span id="l2.571"> }</span>
<a href="#l2.572"></a><span id="l2.572"> </span>
<a href="#l2.573"></a><span id="l2.573"> function InitMessageMark()</span>
<a href="#l2.574"></a><span id="l2.574"> {</span>
<a href="#l2.575"></a><span id="l2.575" class="difflineminus">-  var areMessagesRead = SelectedMessagesAreRead();</span>
<a href="#l2.576"></a><span id="l2.576" class="difflineminus">-  var readItem = document.getElementById(&quot;cmd_markAsRead&quot;);</span>
<a href="#l2.577"></a><span id="l2.577" class="difflineminus">-  if(readItem)</span>
<a href="#l2.578"></a><span id="l2.578" class="difflineminus">-     readItem.setAttribute(&quot;checked&quot;, areMessagesRead);</span>
<a href="#l2.579"></a><span id="l2.579" class="difflineplus">+  document.getElementById(&quot;cmd_markAsRead&quot;)</span>
<a href="#l2.580"></a><span id="l2.580" class="difflineplus">+          .setAttribute(&quot;checked&quot;, SelectedMessagesAreRead());</span>
<a href="#l2.581"></a><span id="l2.581"> </span>
<a href="#l2.582"></a><span id="l2.582" class="difflineminus">-  var areMessagesFlagged = SelectedMessagesAreFlagged();</span>
<a href="#l2.583"></a><span id="l2.583" class="difflineminus">-  var flaggedItem = document.getElementById(&quot;cmd_markAsFlagged&quot;);</span>
<a href="#l2.584"></a><span id="l2.584" class="difflineminus">-  if(flaggedItem)</span>
<a href="#l2.585"></a><span id="l2.585" class="difflineminus">-     flaggedItem.setAttribute(&quot;checked&quot;, areMessagesFlagged);</span>
<a href="#l2.586"></a><span id="l2.586" class="difflineplus">+  document.getElementById(&quot;cmd_markAsFlagged&quot;)</span>
<a href="#l2.587"></a><span id="l2.587" class="difflineplus">+          .setAttribute(&quot;checked&quot;, SelectedMessagesAreFlagged());</span>
<a href="#l2.588"></a><span id="l2.588"> </span>
<a href="#l2.589"></a><span id="l2.589">   document.commandDispatcher.updateCommands('create-menu-mark');</span>
<a href="#l2.590"></a><span id="l2.590"> }</span>
<a href="#l2.591"></a><span id="l2.591"> </span>
<a href="#l2.592"></a><span id="l2.592"> function UpdateJunkToolbarButton()</span>
<a href="#l2.593"></a><span id="l2.593"> {</span>
<a href="#l2.594"></a><span id="l2.594">   var junkButtonDeck = document.getElementById(&quot;junk-deck&quot;);</span>
<a href="#l2.595"></a><span id="l2.595">   if (junkButtonDeck)</span>
<a href="#l2.596"></a><span id="l2.596" class="difflineat">@@ -807,152 +762,133 @@ function UpdateDeleteCommand()</span>
<a href="#l2.597"></a><span id="l2.597">   else</span>
<a href="#l2.598"></a><span id="l2.598">     value += &quot;Messages&quot;;</span>
<a href="#l2.599"></a><span id="l2.599">   goSetMenuValue(&quot;cmd_delete&quot;, value);</span>
<a href="#l2.600"></a><span id="l2.600">   goSetAccessKey(&quot;cmd_delete&quot;, value + &quot;AccessKey&quot;);</span>
<a href="#l2.601"></a><span id="l2.601"> }</span>
<a href="#l2.602"></a><span id="l2.602"> </span>
<a href="#l2.603"></a><span id="l2.603"> function SelectedMessagesAreDeleted()</span>
<a href="#l2.604"></a><span id="l2.604"> {</span>
<a href="#l2.605"></a><span id="l2.605" class="difflineminus">-    try {</span>
<a href="#l2.606"></a><span id="l2.606" class="difflineminus">-        return gDBView.hdrForFirstSelectedMessage.flags &amp; MSG_FLAG_IMAP_DELETED;</span>
<a href="#l2.607"></a><span id="l2.607" class="difflineminus">-    }</span>
<a href="#l2.608"></a><span id="l2.608" class="difflineminus">-    catch (ex) {</span>
<a href="#l2.609"></a><span id="l2.609" class="difflineminus">-        return 0;</span>
<a href="#l2.610"></a><span id="l2.610" class="difflineminus">-    }</span>
<a href="#l2.611"></a><span id="l2.611" class="difflineplus">+  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l2.612"></a><span id="l2.612" class="difflineplus">+         (gDBView.hdrForFirstSelectedMessage.flags &amp; MSG_FLAG_IMAP_DELETED);</span>
<a href="#l2.613"></a><span id="l2.613"> }</span>
<a href="#l2.614"></a><span id="l2.614"> </span>
<a href="#l2.615"></a><span id="l2.615"> function SelectedMessagesAreJunk()</span>
<a href="#l2.616"></a><span id="l2.616"> {</span>
<a href="#l2.617"></a><span id="l2.617" class="difflineminus">-    var isJunk;</span>
<a href="#l2.618"></a><span id="l2.618" class="difflineminus">-    try {</span>
<a href="#l2.619"></a><span id="l2.619" class="difflineminus">-        var junkScore = gDBView.hdrForFirstSelectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l2.620"></a><span id="l2.620" class="difflineminus">-        isJunk =  ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l2.621"></a><span id="l2.621" class="difflineminus">-    }</span>
<a href="#l2.622"></a><span id="l2.622" class="difflineminus">-    catch (ex) {</span>
<a href="#l2.623"></a><span id="l2.623" class="difflineminus">-        isJunk = false;</span>
<a href="#l2.624"></a><span id="l2.624" class="difflineminus">-    }</span>
<a href="#l2.625"></a><span id="l2.625" class="difflineminus">-    return isJunk;</span>
<a href="#l2.626"></a><span id="l2.626" class="difflineplus">+  try {</span>
<a href="#l2.627"></a><span id="l2.627" class="difflineplus">+    var junkScore = gDBView.hdrForFirstSelectedMessage.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l2.628"></a><span id="l2.628" class="difflineplus">+    return (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l2.629"></a><span id="l2.629" class="difflineplus">+  }</span>
<a href="#l2.630"></a><span id="l2.630" class="difflineplus">+  catch (ex) {</span>
<a href="#l2.631"></a><span id="l2.631" class="difflineplus">+    return false;</span>
<a href="#l2.632"></a><span id="l2.632" class="difflineplus">+  }</span>
<a href="#l2.633"></a><span id="l2.633"> }</span>
<a href="#l2.634"></a><span id="l2.634"> </span>
<a href="#l2.635"></a><span id="l2.635"> function SelectedMessagesAreRead()</span>
<a href="#l2.636"></a><span id="l2.636"> {</span>
<a href="#l2.637"></a><span id="l2.637" class="difflineminus">-    var isRead;</span>
<a href="#l2.638"></a><span id="l2.638" class="difflineminus">-    try {</span>
<a href="#l2.639"></a><span id="l2.639" class="difflineminus">-        isRead = gDBView.hdrForFirstSelectedMessage.isRead;</span>
<a href="#l2.640"></a><span id="l2.640" class="difflineminus">-    }</span>
<a href="#l2.641"></a><span id="l2.641" class="difflineminus">-    catch (ex) {</span>
<a href="#l2.642"></a><span id="l2.642" class="difflineminus">-        isRead = false;</span>
<a href="#l2.643"></a><span id="l2.643" class="difflineminus">-    }</span>
<a href="#l2.644"></a><span id="l2.644" class="difflineminus">-    return isRead;</span>
<a href="#l2.645"></a><span id="l2.645" class="difflineplus">+  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l2.646"></a><span id="l2.646" class="difflineplus">+         gDBView.hdrForFirstSelectedMessage.isRead;</span>
<a href="#l2.647"></a><span id="l2.647"> }</span>
<a href="#l2.648"></a><span id="l2.648"> </span>
<a href="#l2.649"></a><span id="l2.649"> function SelectedMessagesAreFlagged()</span>
<a href="#l2.650"></a><span id="l2.650"> {</span>
<a href="#l2.651"></a><span id="l2.651" class="difflineminus">-    var isFlagged;</span>
<a href="#l2.652"></a><span id="l2.652" class="difflineminus">-    try {</span>
<a href="#l2.653"></a><span id="l2.653" class="difflineminus">-        isFlagged = gDBView.hdrForFirstSelectedMessage.isFlagged;</span>
<a href="#l2.654"></a><span id="l2.654" class="difflineminus">-    }</span>
<a href="#l2.655"></a><span id="l2.655" class="difflineminus">-    catch (ex) {</span>
<a href="#l2.656"></a><span id="l2.656" class="difflineminus">-        isFlagged = false;</span>
<a href="#l2.657"></a><span id="l2.657" class="difflineminus">-    }</span>
<a href="#l2.658"></a><span id="l2.658" class="difflineminus">-    return isFlagged;</span>
<a href="#l2.659"></a><span id="l2.659" class="difflineplus">+  return gDBView &amp;&amp; gDBView.numSelected &amp;&amp;</span>
<a href="#l2.660"></a><span id="l2.660" class="difflineplus">+         gDBView.hdrForFirstSelectedMessage.isFlagged;</span>
<a href="#l2.661"></a><span id="l2.661"> }</span>
<a href="#l2.662"></a><span id="l2.662"> </span>
<a href="#l2.663"></a><span id="l2.663"> function GetFirstSelectedMsgFolder()</span>
<a href="#l2.664"></a><span id="l2.664"> {</span>
<a href="#l2.665"></a><span id="l2.665" class="difflineminus">-    var result = null;</span>
<a href="#l2.666"></a><span id="l2.666" class="difflineminus">-    var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.667"></a><span id="l2.667" class="difflineminus">-    if (selectedFolders.length &gt; 0) {</span>
<a href="#l2.668"></a><span id="l2.668" class="difflineminus">-        result = selectedFolders[0];</span>
<a href="#l2.669"></a><span id="l2.669" class="difflineminus">-    }</span>
<a href="#l2.670"></a><span id="l2.670" class="difflineminus">-</span>
<a href="#l2.671"></a><span id="l2.671" class="difflineminus">-    return result;</span>
<a href="#l2.672"></a><span id="l2.672" class="difflineplus">+  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.673"></a><span id="l2.673" class="difflineplus">+  return (selectedFolders.length &gt; 0) ? selectedFolders[0] : null;</span>
<a href="#l2.674"></a><span id="l2.674"> }</span>
<a href="#l2.675"></a><span id="l2.675"> </span>
<a href="#l2.676"></a><span id="l2.676"> function GetInboxFolder(server)</span>
<a href="#l2.677"></a><span id="l2.677"> {</span>
<a href="#l2.678"></a><span id="l2.678" class="difflineminus">-    try {</span>
<a href="#l2.679"></a><span id="l2.679" class="difflineminus">-        var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l2.680"></a><span id="l2.680" class="difflineplus">+  try {</span>
<a href="#l2.681"></a><span id="l2.681" class="difflineplus">+    var rootMsgFolder = server.rootMsgFolder;</span>
<a href="#l2.682"></a><span id="l2.682"> </span>
<a href="#l2.683"></a><span id="l2.683" class="difflineminus">-        //now find Inbox</span>
<a href="#l2.684"></a><span id="l2.684" class="difflineminus">-        return rootMsgFolder.getFolderWithFlags(0x1000);</span>
<a href="#l2.685"></a><span id="l2.685" class="difflineminus">-    }</span>
<a href="#l2.686"></a><span id="l2.686" class="difflineminus">-    catch (ex) {</span>
<a href="#l2.687"></a><span id="l2.687" class="difflineminus">-        dump(ex + &quot;\n&quot;);</span>
<a href="#l2.688"></a><span id="l2.688" class="difflineminus">-    }</span>
<a href="#l2.689"></a><span id="l2.689" class="difflineminus">-    return null;</span>
<a href="#l2.690"></a><span id="l2.690" class="difflineplus">+    // Now find the Inbox.</span>
<a href="#l2.691"></a><span id="l2.691" class="difflineplus">+    return rootMsgFolder.getFolderWithFlags(0x1000);</span>
<a href="#l2.692"></a><span id="l2.692" class="difflineplus">+  }</span>
<a href="#l2.693"></a><span id="l2.693" class="difflineplus">+  catch (ex) {</span>
<a href="#l2.694"></a><span id="l2.694" class="difflineplus">+    dump(ex + &quot;\n&quot;);</span>
<a href="#l2.695"></a><span id="l2.695" class="difflineplus">+  }</span>
<a href="#l2.696"></a><span id="l2.696" class="difflineplus">+  return null;</span>
<a href="#l2.697"></a><span id="l2.697"> }</span>
<a href="#l2.698"></a><span id="l2.698"> </span>
<a href="#l2.699"></a><span id="l2.699"> function GetMessagesForInboxOnServer(server)</span>
<a href="#l2.700"></a><span id="l2.700"> {</span>
<a href="#l2.701"></a><span id="l2.701">   var inboxFolder = GetInboxFolder(server);</span>
<a href="#l2.702"></a><span id="l2.702"> </span>
<a href="#l2.703"></a><span id="l2.703" class="difflineminus">-  // if the server doesn't support an inbox it could be an RSS server or some other server type..</span>
<a href="#l2.704"></a><span id="l2.704" class="difflineminus">-  // just use the root folder and the server implementation can figure out what to do.</span>
<a href="#l2.705"></a><span id="l2.705" class="difflineplus">+  // If the server doesn't support an inbox it could be an RSS server or some</span>
<a href="#l2.706"></a><span id="l2.706" class="difflineplus">+  // other server type. Just use the root folder and the server implementation</span>
<a href="#l2.707"></a><span id="l2.707" class="difflineplus">+  // can figure out what to do.</span>
<a href="#l2.708"></a><span id="l2.708">   if (!inboxFolder)</span>
<a href="#l2.709"></a><span id="l2.709">     inboxFolder = server.rootFolder;</span>
<a href="#l2.710"></a><span id="l2.710"> </span>
<a href="#l2.711"></a><span id="l2.711">   GetNewMessages([inboxFolder], server);</span>
<a href="#l2.712"></a><span id="l2.712"> }</span>
<a href="#l2.713"></a><span id="l2.713"> </span>
<a href="#l2.714"></a><span id="l2.714"> function MsgGetMessage()</span>
<a href="#l2.715"></a><span id="l2.715"> {</span>
<a href="#l2.716"></a><span id="l2.716">   // if offline, prompt for getting messages</span>
<a href="#l2.717"></a><span id="l2.717">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l2.718"></a><span id="l2.718">     GetFolderMessages();</span>
<a href="#l2.719"></a><span id="l2.719"> }</span>
<a href="#l2.720"></a><span id="l2.720"> </span>
<a href="#l2.721"></a><span id="l2.721"> function MsgGetMessagesForAllServers(defaultServer)</span>
<a href="#l2.722"></a><span id="l2.722"> {</span>
<a href="#l2.723"></a><span id="l2.723" class="difflineminus">-    // now log into any server</span>
<a href="#l2.724"></a><span id="l2.724" class="difflineminus">-    try</span>
<a href="#l2.725"></a><span id="l2.725" class="difflineplus">+  // now log into any server</span>
<a href="#l2.726"></a><span id="l2.726" class="difflineplus">+  try</span>
<a href="#l2.727"></a><span id="l2.727" class="difflineplus">+  {</span>
<a href="#l2.728"></a><span id="l2.728" class="difflineplus">+    var allServers = accountManager.allServers;</span>
<a href="#l2.729"></a><span id="l2.729" class="difflineplus">+    // Array of isupportsarrays of servers for a particular folder.</span>
<a href="#l2.730"></a><span id="l2.730" class="difflineplus">+    var pop3DownloadServersArray = new Array();</span>
<a href="#l2.731"></a><span id="l2.731" class="difflineplus">+    // Parallel isupports array of folders to download to...</span>
<a href="#l2.732"></a><span id="l2.732" class="difflineplus">+    var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l2.733"></a><span id="l2.733" class="difflineplus">+                                             .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.734"></a><span id="l2.734" class="difflineplus">+    var pop3Server;</span>
<a href="#l2.735"></a><span id="l2.735" class="difflineplus">+    for (var i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l2.736"></a><span id="l2.736">     {</span>
<a href="#l2.737"></a><span id="l2.737" class="difflineminus">-        var allServers = accountManager.allServers;</span>
<a href="#l2.738"></a><span id="l2.738" class="difflineminus">-        var i;</span>
<a href="#l2.739"></a><span id="l2.739" class="difflineminus">-        // array of isupportsarrays of servers for a particular folder</span>
<a href="#l2.740"></a><span id="l2.740" class="difflineminus">-        var pop3DownloadServersArray = new Array();</span>
<a href="#l2.741"></a><span id="l2.741" class="difflineminus">-        // parallel isupports array of folders to download to...</span>
<a href="#l2.742"></a><span id="l2.742" class="difflineminus">-        var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.743"></a><span id="l2.743" class="difflineminus">-        var pop3Server;</span>
<a href="#l2.744"></a><span id="l2.744" class="difflineminus">-</span>
<a href="#l2.745"></a><span id="l2.745" class="difflineminus">-        for (i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l2.746"></a><span id="l2.746" class="difflineplus">+      var currentServer = allServers.QueryElementAt(i, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l2.747"></a><span id="l2.747" class="difflineplus">+      var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type]</span>
<a href="#l2.748"></a><span id="l2.748" class="difflineplus">+                                   .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l2.749"></a><span id="l2.749" class="difflineplus">+      if (protocolinfo.canLoginAtStartUp &amp;&amp; currentServer.loginAtStartUp)</span>
<a href="#l2.750"></a><span id="l2.750" class="difflineplus">+      {</span>
<a href="#l2.751"></a><span id="l2.751" class="difflineplus">+        if (defaultServer &amp;&amp; defaultServer.equals(currentServer) &amp;&amp;</span>
<a href="#l2.752"></a><span id="l2.752" class="difflineplus">+            !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l2.753"></a><span id="l2.753" class="difflineplus">+            defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l2.754"></a><span id="l2.754">         {</span>
<a href="#l2.755"></a><span id="l2.755" class="difflineminus">-            var currentServer = allServers.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l2.756"></a><span id="l2.756" class="difflineminus">-            var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type].getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l2.757"></a><span id="l2.757" class="difflineminus">-            if (protocolinfo.canLoginAtStartUp &amp;&amp; currentServer.loginAtStartUp)</span>
<a href="#l2.758"></a><span id="l2.758" class="difflineminus">-            {</span>
<a href="#l2.759"></a><span id="l2.759" class="difflineminus">-                if (defaultServer &amp;&amp; defaultServer.equals(currentServer) &amp;&amp; </span>
<a href="#l2.760"></a><span id="l2.760" class="difflineminus">-                  !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l2.761"></a><span id="l2.761" class="difflineminus">-                  defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l2.762"></a><span id="l2.762" class="difflineminus">-                {</span>
<a href="#l2.763"></a><span id="l2.763" class="difflineminus">-                    dump(currentServer.serverURI + &quot;...skipping, already opened\n&quot;);</span>
<a href="#l2.764"></a><span id="l2.764" class="difflineminus">-                }</span>
<a href="#l2.765"></a><span id="l2.765" class="difflineminus">-                else if (currentServer.type == &quot;pop3&quot; &amp;&amp; currentServer.downloadOnBiff)</span>
<a href="#l2.766"></a><span id="l2.766" class="difflineminus">-                {</span>
<a href="#l2.767"></a><span id="l2.767" class="difflineminus">-                    CoalesceGetMsgsForPop3ServersByDestFolder(currentServer, pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l2.768"></a><span id="l2.768" class="difflineminus">-                    pop3Server = currentServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l2.769"></a><span id="l2.769" class="difflineminus">-                }</span>
<a href="#l2.770"></a><span id="l2.770" class="difflineminus">-                else</span>
<a href="#l2.771"></a><span id="l2.771" class="difflineminus">-                {</span>
<a href="#l2.772"></a><span id="l2.772" class="difflineminus">-                    // Check to see if there are new messages on the server</span>
<a href="#l2.773"></a><span id="l2.773" class="difflineminus">-                    currentServer.performBiff(msgWindow);</span>
<a href="#l2.774"></a><span id="l2.774" class="difflineminus">-                }</span>
<a href="#l2.775"></a><span id="l2.775" class="difflineminus">-            }</span>
<a href="#l2.776"></a><span id="l2.776" class="difflineplus">+          // skip, already opened</span>
<a href="#l2.777"></a><span id="l2.777" class="difflineplus">+        }</span>
<a href="#l2.778"></a><span id="l2.778" class="difflineplus">+        else if (currentServer.type == &quot;pop3&quot; &amp;&amp; currentServer.downloadOnBiff)</span>
<a href="#l2.779"></a><span id="l2.779" class="difflineplus">+        {</span>
<a href="#l2.780"></a><span id="l2.780" class="difflineplus">+          CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l2.781"></a><span id="l2.781" class="difflineplus">+            pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l2.782"></a><span id="l2.782" class="difflineplus">+          pop3Server = currentServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l2.783"></a><span id="l2.783" class="difflineplus">+        }</span>
<a href="#l2.784"></a><span id="l2.784" class="difflineplus">+        else</span>
<a href="#l2.785"></a><span id="l2.785" class="difflineplus">+        {</span>
<a href="#l2.786"></a><span id="l2.786" class="difflineplus">+          // Check to see if there are new messages on the server</span>
<a href="#l2.787"></a><span id="l2.787" class="difflineplus">+          currentServer.performBiff(msgWindow);</span>
<a href="#l2.788"></a><span id="l2.788">         }</span>
<a href="#l2.789"></a><span id="l2.789" class="difflineminus">-        for (i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l2.790"></a><span id="l2.790" class="difflineminus">-        {</span>
<a href="#l2.791"></a><span id="l2.791" class="difflineminus">-          // any ol' pop3Server will do - the serversArray specifies which servers to download from</span>
<a href="#l2.792"></a><span id="l2.792" class="difflineminus">-          pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow, localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l2.793"></a><span id="l2.793" class="difflineminus">-        }</span>
<a href="#l2.794"></a><span id="l2.794" class="difflineplus">+      }</span>
<a href="#l2.795"></a><span id="l2.795">     }</span>
<a href="#l2.796"></a><span id="l2.796" class="difflineminus">-    catch(ex)</span>
<a href="#l2.797"></a><span id="l2.797" class="difflineplus">+    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l2.798"></a><span id="l2.798">     {</span>
<a href="#l2.799"></a><span id="l2.799" class="difflineminus">-        dump(ex + &quot;\n&quot;);</span>
<a href="#l2.800"></a><span id="l2.800" class="difflineplus">+      // Any ol' pop3Server will do - the serversArray specifies which servers</span>
<a href="#l2.801"></a><span id="l2.801" class="difflineplus">+      // to download from.</span>
<a href="#l2.802"></a><span id="l2.802" class="difflineplus">+      pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow,</span>
<a href="#l2.803"></a><span id="l2.803" class="difflineplus">+                                         localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l2.804"></a><span id="l2.804">     }</span>
<a href="#l2.805"></a><span id="l2.805" class="difflineplus">+  }</span>
<a href="#l2.806"></a><span id="l2.806" class="difflineplus">+  catch(ex)</span>
<a href="#l2.807"></a><span id="l2.807" class="difflineplus">+  {</span>
<a href="#l2.808"></a><span id="l2.808" class="difflineplus">+    dump(ex + &quot;\n&quot;);</span>
<a href="#l2.809"></a><span id="l2.809" class="difflineplus">+  }</span>
<a href="#l2.810"></a><span id="l2.810"> }</span>
<a href="#l2.811"></a><span id="l2.811"> </span>
<a href="#l2.812"></a><span id="l2.812"> /**</span>
<a href="#l2.813"></a><span id="l2.813">   * Get messages for all those accounts which have the capability</span>
<a href="#l2.814"></a><span id="l2.814">   * of getting messages and have session password available i.e.,</span>
<a href="#l2.815"></a><span id="l2.815">   * curretnly logged in accounts.</span>
<a href="#l2.816"></a><span id="l2.816">   * if offline, prompt for getting messages.</span>
<a href="#l2.817"></a><span id="l2.817">   */</span>
<a href="#l2.818"></a><span id="l2.818" class="difflineat">@@ -980,106 +916,93 @@ function MsgGetMessagesForAccount(aFolde</span>
<a href="#l2.819"></a><span id="l2.819">     var server = aFolder.server;</span>
<a href="#l2.820"></a><span id="l2.820">     GetMessagesForInboxOnServer(server);</span>
<a href="#l2.821"></a><span id="l2.821">   }</span>
<a href="#l2.822"></a><span id="l2.822"> }</span>
<a href="#l2.823"></a><span id="l2.823"> </span>
<a href="#l2.824"></a><span id="l2.824"> // if offline, prompt for getNextNMessages</span>
<a href="#l2.825"></a><span id="l2.825"> function MsgGetNextNMessages()</span>
<a href="#l2.826"></a><span id="l2.826"> {</span>
<a href="#l2.827"></a><span id="l2.827" class="difflineminus">-  var folder;</span>
<a href="#l2.828"></a><span id="l2.828" class="difflineminus">-  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) </span>
<a href="#l2.829"></a><span id="l2.829" class="difflineminus">-  {</span>
<a href="#l2.830"></a><span id="l2.830" class="difflineminus">-    folder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.831"></a><span id="l2.831" class="difflineminus">-    if (folder) </span>
<a href="#l2.832"></a><span id="l2.832" class="difflineminus">-      GetNextNMessages(folder);</span>
<a href="#l2.833"></a><span id="l2.833" class="difflineminus">-  }</span>
<a href="#l2.834"></a><span id="l2.834" class="difflineminus">-}   </span>
<a href="#l2.835"></a><span id="l2.835" class="difflineplus">+  if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail())</span>
<a href="#l2.836"></a><span id="l2.836" class="difflineplus">+    GetNextNMessages(GetFirstSelectedMsgFolder());</span>
<a href="#l2.837"></a><span id="l2.837" class="difflineplus">+}</span>
<a href="#l2.838"></a><span id="l2.838"> </span>
<a href="#l2.839"></a><span id="l2.839"> function MsgDeleteMessage(reallyDelete, fromToolbar)</span>
<a href="#l2.840"></a><span id="l2.840"> {</span>
<a href="#l2.841"></a><span id="l2.841" class="difflineminus">-    // if from the toolbar, return right away if this is a news message</span>
<a href="#l2.842"></a><span id="l2.842" class="difflineminus">-    // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;</span>
<a href="#l2.843"></a><span id="l2.843" class="difflineminus">-    if (fromToolbar)</span>
<a href="#l2.844"></a><span id="l2.844" class="difflineminus">-    {</span>
<a href="#l2.845"></a><span id="l2.845" class="difflineminus">-        var srcFolder = GetLoadedMsgFolder();</span>
<a href="#l2.846"></a><span id="l2.846" class="difflineminus">-        if (isNewsURI(srcFolder.URI)) {</span>
<a href="#l2.847"></a><span id="l2.847" class="difflineminus">-            // if news, don't delete</span>
<a href="#l2.848"></a><span id="l2.848" class="difflineminus">-            return;</span>
<a href="#l2.849"></a><span id="l2.849" class="difflineminus">-        }</span>
<a href="#l2.850"></a><span id="l2.850" class="difflineminus">-    }</span>
<a href="#l2.851"></a><span id="l2.851" class="difflineplus">+  // If from the toolbar, return right away if this is a news message</span>
<a href="#l2.852"></a><span id="l2.852" class="difflineplus">+  // only allow cancel from the menu:  &quot;Edit | Cancel / Delete Message&quot;.</span>
<a href="#l2.853"></a><span id="l2.853" class="difflineplus">+  if (fromToolbar &amp;&amp; isNewsURI(GetLoadedMsgFolder().URI))</span>
<a href="#l2.854"></a><span id="l2.854" class="difflineplus">+    return;</span>
<a href="#l2.855"></a><span id="l2.855"> </span>
<a href="#l2.856"></a><span id="l2.856" class="difflineminus">-    SetNextMessageAfterDelete();</span>
<a href="#l2.857"></a><span id="l2.857" class="difflineminus">-    if (reallyDelete) {</span>
<a href="#l2.858"></a><span id="l2.858" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l2.859"></a><span id="l2.859" class="difflineminus">-    }</span>
<a href="#l2.860"></a><span id="l2.860" class="difflineminus">-    else {</span>
<a href="#l2.861"></a><span id="l2.861" class="difflineminus">-        gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l2.862"></a><span id="l2.862" class="difflineminus">-    }</span>
<a href="#l2.863"></a><span id="l2.863" class="difflineplus">+  SetNextMessageAfterDelete();</span>
<a href="#l2.864"></a><span id="l2.864" class="difflineplus">+  if (reallyDelete)</span>
<a href="#l2.865"></a><span id="l2.865" class="difflineplus">+    gDBView.doCommand(nsMsgViewCommandType.deleteNoTrash);</span>
<a href="#l2.866"></a><span id="l2.866" class="difflineplus">+  else</span>
<a href="#l2.867"></a><span id="l2.867" class="difflineplus">+    gDBView.doCommand(nsMsgViewCommandType.deleteMsg);</span>
<a href="#l2.868"></a><span id="l2.868"> }</span>
<a href="#l2.869"></a><span id="l2.869"> </span>
<a href="#l2.870"></a><span id="l2.870"> /**</span>
<a href="#l2.871"></a><span id="l2.871">  * Copies the selected messages to the destination folder</span>
<a href="#l2.872"></a><span id="l2.872">  * @param aDestFolder  the destination folder</span>
<a href="#l2.873"></a><span id="l2.873">  */</span>
<a href="#l2.874"></a><span id="l2.874"> function MsgCopyMessage(aDestFolder)</span>
<a href="#l2.875"></a><span id="l2.875"> {</span>
<a href="#l2.876"></a><span id="l2.876">   gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l2.877"></a><span id="l2.877">   pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l2.878"></a><span id="l2.878" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);  </span>
<a href="#l2.879"></a><span id="l2.879" class="difflineplus">+  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, false);</span>
<a href="#l2.880"></a><span id="l2.880"> }</span>
<a href="#l2.881"></a><span id="l2.881"> </span>
<a href="#l2.882"></a><span id="l2.882"> /**</span>
<a href="#l2.883"></a><span id="l2.883">  * Moves the selected messages to the destination folder</span>
<a href="#l2.884"></a><span id="l2.884">  * @param aDestFolder  the destination folder</span>
<a href="#l2.885"></a><span id="l2.885">  */</span>
<a href="#l2.886"></a><span id="l2.886"> function MsgMoveMessage(aDestFolder)</span>
<a href="#l2.887"></a><span id="l2.887"> {</span>
<a href="#l2.888"></a><span id="l2.888" class="difflineminus">-  // we don't move news messages, we copy them</span>
<a href="#l2.889"></a><span id="l2.889" class="difflineplus">+  // We don't move news messages, we copy them.</span>
<a href="#l2.890"></a><span id="l2.890">   if (isNewsURI(gDBView.msgFolder.URI))</span>
<a href="#l2.891"></a><span id="l2.891">     gDBView.doCommandWithFolder(nsMsgViewCommandType.copyMessages, aDestFolder);</span>
<a href="#l2.892"></a><span id="l2.892" class="difflineminus">-  else </span>
<a href="#l2.893"></a><span id="l2.893" class="difflineplus">+  else</span>
<a href="#l2.894"></a><span id="l2.894">   {</span>
<a href="#l2.895"></a><span id="l2.895">     SetNextMessageAfterDelete();</span>
<a href="#l2.896"></a><span id="l2.896">     gDBView.doCommandWithFolder(nsMsgViewCommandType.moveMessages, aDestFolder);</span>
<a href="#l2.897"></a><span id="l2.897" class="difflineminus">-  }    </span>
<a href="#l2.898"></a><span id="l2.898" class="difflineplus">+  }</span>
<a href="#l2.899"></a><span id="l2.899">   pref.setCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;, aDestFolder.URI);</span>
<a href="#l2.900"></a><span id="l2.900" class="difflineminus">-  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);  </span>
<a href="#l2.901"></a><span id="l2.901" class="difflineplus">+  pref.setBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;, true);</span>
<a href="#l2.902"></a><span id="l2.902"> }</span>
<a href="#l2.903"></a><span id="l2.903"> </span>
<a href="#l2.904"></a><span id="l2.904"> /**</span>
<a href="#l2.905"></a><span id="l2.905">  * Calls the ComposeMessage function with the desired type, and proper default</span>
<a href="#l2.906"></a><span id="l2.906">  * based on the event that fired it.</span>
<a href="#l2.907"></a><span id="l2.907">  *</span>
<a href="#l2.908"></a><span id="l2.908">  * @param aCompType  the nsIMsgCompType to pass to the function</span>
<a href="#l2.909"></a><span id="l2.909">  * @param aEvent (optional) the event that triggered the call</span>
<a href="#l2.910"></a><span id="l2.910">  */</span>
<a href="#l2.911"></a><span id="l2.911"> function composeMsgByType(aCompType, aEvent) {</span>
<a href="#l2.912"></a><span id="l2.912">   if (aEvent &amp;&amp; aEvent.shiftKey) {</span>
<a href="#l2.913"></a><span id="l2.913">     ComposeMessage(aCompType,</span>
<a href="#l2.914"></a><span id="l2.914">                    Components.interfaces.nsIMsgCompFormat.OppositeOfDefault,</span>
<a href="#l2.915"></a><span id="l2.915">                    GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l2.916"></a><span id="l2.916" class="difflineminus">-  } else {</span>
<a href="#l2.917"></a><span id="l2.917" class="difflineplus">+  }</span>
<a href="#l2.918"></a><span id="l2.918" class="difflineplus">+  else {</span>
<a href="#l2.919"></a><span id="l2.919">     ComposeMessage(aCompType, Components.interfaces.nsIMsgCompFormat.Default,</span>
<a href="#l2.920"></a><span id="l2.920">                    GetFirstSelectedMsgFolder(), GetSelectedMessages());</span>
<a href="#l2.921"></a><span id="l2.921">   }</span>
<a href="#l2.922"></a><span id="l2.922"> }</span>
<a href="#l2.923"></a><span id="l2.923"> </span>
<a href="#l2.924"></a><span id="l2.924"> function MsgNewMessage(event)</span>
<a href="#l2.925"></a><span id="l2.925"> {</span>
<a href="#l2.926"></a><span id="l2.926">   composeMsgByType(Components.interfaces.nsIMsgCompType.New, event);</span>
<a href="#l2.927"></a><span id="l2.927"> }</span>
<a href="#l2.928"></a><span id="l2.928"> </span>
<a href="#l2.929"></a><span id="l2.929"> function MsgReplyMessage(event)</span>
<a href="#l2.930"></a><span id="l2.930"> {</span>
<a href="#l2.931"></a><span id="l2.931">   var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l2.932"></a><span id="l2.932">   if (loadedFolder)</span>
<a href="#l2.933"></a><span id="l2.933">   {</span>
<a href="#l2.934"></a><span id="l2.934">     var server = loadedFolder.server;</span>
<a href="#l2.935"></a><span id="l2.935" class="difflineminus">-</span>
<a href="#l2.936"></a><span id="l2.936">     if(server &amp;&amp; server.type == &quot;nntp&quot;)</span>
<a href="#l2.937"></a><span id="l2.937">     {</span>
<a href="#l2.938"></a><span id="l2.938">       MsgReplyGroup(event);</span>
<a href="#l2.939"></a><span id="l2.939">       return;</span>
<a href="#l2.940"></a><span id="l2.940">     }</span>
<a href="#l2.941"></a><span id="l2.941">   }</span>
<a href="#l2.942"></a><span id="l2.942">   MsgReplySender(event);</span>
<a href="#l2.943"></a><span id="l2.943"> }</span>
<a href="#l2.944"></a><span id="l2.944" class="difflineat">@@ -1108,113 +1031,111 @@ function MsgForwardMessage(event)</span>
<a href="#l2.945"></a><span id="l2.945">   catch (ex) {</span>
<a href="#l2.946"></a><span id="l2.946">     dump(&quot;failed to retrieve pref mail.forward_message_mode&quot;);</span>
<a href="#l2.947"></a><span id="l2.947">   }</span>
<a href="#l2.948"></a><span id="l2.948"> </span>
<a href="#l2.949"></a><span id="l2.949">   // mail.forward_message_mode could be 1, if the user migrated from 4.x</span>
<a href="#l2.950"></a><span id="l2.950">   // 1 (forward as quoted) is obsolete, so we treat is as forward inline</span>
<a href="#l2.951"></a><span id="l2.951">   // since that is more like forward as quoted then forward as attachment</span>
<a href="#l2.952"></a><span id="l2.952">   if (forwardType == 0)</span>
<a href="#l2.953"></a><span id="l2.953" class="difflineminus">-      MsgForwardAsAttachment(event);</span>
<a href="#l2.954"></a><span id="l2.954" class="difflineplus">+    MsgForwardAsAttachment(event);</span>
<a href="#l2.955"></a><span id="l2.955">   else</span>
<a href="#l2.956"></a><span id="l2.956" class="difflineminus">-      MsgForwardAsInline(event);</span>
<a href="#l2.957"></a><span id="l2.957" class="difflineplus">+    MsgForwardAsInline(event);</span>
<a href="#l2.958"></a><span id="l2.958"> }</span>
<a href="#l2.959"></a><span id="l2.959"> </span>
<a href="#l2.960"></a><span id="l2.960"> function MsgForwardAsAttachment(event)</span>
<a href="#l2.961"></a><span id="l2.961"> {</span>
<a href="#l2.962"></a><span id="l2.962">   composeMsgByType(Components.interfaces.nsIMsgCompType.ForwardAsAttachment, event);</span>
<a href="#l2.963"></a><span id="l2.963"> }</span>
<a href="#l2.964"></a><span id="l2.964"> </span>
<a href="#l2.965"></a><span id="l2.965"> function MsgForwardAsInline(event)</span>
<a href="#l2.966"></a><span id="l2.966"> {</span>
<a href="#l2.967"></a><span id="l2.967">   composeMsgByType(Components.interfaces.nsIMsgCompType.ForwardInline, event);</span>
<a href="#l2.968"></a><span id="l2.968"> }</span>
<a href="#l2.969"></a><span id="l2.969"> </span>
<a href="#l2.970"></a><span id="l2.970" class="difflineminus">-</span>
<a href="#l2.971"></a><span id="l2.971"> function MsgEditMessageAsNew()</span>
<a href="#l2.972"></a><span id="l2.972"> {</span>
<a href="#l2.973"></a><span id="l2.973">   composeMsgByType(Components.interfaces.nsIMsgCompType.Template);</span>
<a href="#l2.974"></a><span id="l2.974"> }</span>
<a href="#l2.975"></a><span id="l2.975"> </span>
<a href="#l2.976"></a><span id="l2.976"> function MsgCreateFilter()</span>
<a href="#l2.977"></a><span id="l2.977"> {</span>
<a href="#l2.978"></a><span id="l2.978">   // retrieve Sender direct from selected message's headers</span>
<a href="#l2.979"></a><span id="l2.979">   var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.980"></a><span id="l2.980" class="difflineminus">-  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.981"></a><span id="l2.981" class="difflineplus">+  var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l2.982"></a><span id="l2.982" class="difflineplus">+                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.983"></a><span id="l2.983">   var emailAddress = headerParser.extractHeaderAddressMailboxes(msgHdr.author);</span>
<a href="#l2.984"></a><span id="l2.984">   if (emailAddress)</span>
<a href="#l2.985"></a><span id="l2.985">     top.MsgFilters(emailAddress, null);</span>
<a href="#l2.986"></a><span id="l2.986"> }</span>
<a href="#l2.987"></a><span id="l2.987"> </span>
<a href="#l2.988"></a><span id="l2.988"> function MsgNewFolder(callBackFunctionName)</span>
<a href="#l2.989"></a><span id="l2.989"> {</span>
<a href="#l2.990"></a><span id="l2.990" class="difflineminus">-    var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.991"></a><span id="l2.991" class="difflineminus">-    var dualUseFolders = true;</span>
<a href="#l2.992"></a><span id="l2.992" class="difflineminus">-    var server = null;</span>
<a href="#l2.993"></a><span id="l2.993" class="difflineminus">-    var destinationFolder = null;</span>
<a href="#l2.994"></a><span id="l2.994" class="difflineplus">+  var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.995"></a><span id="l2.995" class="difflineplus">+  var dualUseFolders = true;</span>
<a href="#l2.996"></a><span id="l2.996" class="difflineplus">+  var server = null;</span>
<a href="#l2.997"></a><span id="l2.997" class="difflineplus">+  var destinationFolder = null;</span>
<a href="#l2.998"></a><span id="l2.998"> </span>
<a href="#l2.999"></a><span id="l2.999" class="difflineminus">-    if (preselectedFolder)</span>
<a href="#l2.1000"></a><span id="l2.1000" class="difflineminus">-    {</span>
<a href="#l2.1001"></a><span id="l2.1001" class="difflineminus">-        try {</span>
<a href="#l2.1002"></a><span id="l2.1002" class="difflineminus">-            server = preselectedFolder.server;</span>
<a href="#l2.1003"></a><span id="l2.1003" class="difflineminus">-            if (server)</span>
<a href="#l2.1004"></a><span id="l2.1004" class="difflineminus">-            {</span>
<a href="#l2.1005"></a><span id="l2.1005" class="difflineminus">-                destinationFolder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l2.1006"></a><span id="l2.1006" class="difflineplus">+  if (preselectedFolder)</span>
<a href="#l2.1007"></a><span id="l2.1007" class="difflineplus">+  {</span>
<a href="#l2.1008"></a><span id="l2.1008" class="difflineplus">+    try {</span>
<a href="#l2.1009"></a><span id="l2.1009" class="difflineplus">+      server = preselectedFolder.server;</span>
<a href="#l2.1010"></a><span id="l2.1010" class="difflineplus">+      if (server)</span>
<a href="#l2.1011"></a><span id="l2.1011" class="difflineplus">+      {</span>
<a href="#l2.1012"></a><span id="l2.1012" class="difflineplus">+        destinationFolder = getDestinationFolder(preselectedFolder, server);</span>
<a href="#l2.1013"></a><span id="l2.1013"> </span>
<a href="#l2.1014"></a><span id="l2.1014" class="difflineminus">-                var imapServer =</span>
<a href="#l2.1015"></a><span id="l2.1015" class="difflineminus">-                    server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l2.1016"></a><span id="l2.1016" class="difflineminus">-                if (imapServer)</span>
<a href="#l2.1017"></a><span id="l2.1017" class="difflineminus">-                    dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l2.1018"></a><span id="l2.1018" class="difflineminus">-            }</span>
<a href="#l2.1019"></a><span id="l2.1019" class="difflineminus">-        } catch (e) {</span>
<a href="#l2.1020"></a><span id="l2.1020" class="difflineminus">-            dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l2.1021"></a><span id="l2.1021" class="difflineminus">-        }</span>
<a href="#l2.1022"></a><span id="l2.1022" class="difflineplus">+        var imapServer =</span>
<a href="#l2.1023"></a><span id="l2.1023" class="difflineplus">+            server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l2.1024"></a><span id="l2.1024" class="difflineplus">+        if (imapServer)</span>
<a href="#l2.1025"></a><span id="l2.1025" class="difflineplus">+          dualUseFolders = imapServer.dualUseFolders;</span>
<a href="#l2.1026"></a><span id="l2.1026" class="difflineplus">+      }</span>
<a href="#l2.1027"></a><span id="l2.1027" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.1028"></a><span id="l2.1028" class="difflineplus">+        dump (&quot;Exception: dualUseFolders = true\n&quot;);</span>
<a href="#l2.1029"></a><span id="l2.1029">     }</span>
<a href="#l2.1030"></a><span id="l2.1030" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;,</span>
<a href="#l2.1031"></a><span id="l2.1031" class="difflineminus">-                      &quot;&quot;, &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l2.1032"></a><span id="l2.1032" class="difflineminus">-                      {folder: destinationFolder,</span>
<a href="#l2.1033"></a><span id="l2.1033" class="difflineminus">-                       dualUseFolders: dualUseFolders,</span>
<a href="#l2.1034"></a><span id="l2.1034" class="difflineminus">-                       okCallback:callBackFunctionName});</span>
<a href="#l2.1035"></a><span id="l2.1035" class="difflineplus">+  }</span>
<a href="#l2.1036"></a><span id="l2.1036" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/newFolderDialog.xul&quot;, &quot;&quot;,</span>
<a href="#l2.1037"></a><span id="l2.1037" class="difflineplus">+                    &quot;chrome,titlebar,modal&quot;,</span>
<a href="#l2.1038"></a><span id="l2.1038" class="difflineplus">+                    {folder: destinationFolder, dualUseFolders: dualUseFolders,</span>
<a href="#l2.1039"></a><span id="l2.1039" class="difflineplus">+                     okCallback:callBackFunctionName});</span>
<a href="#l2.1040"></a><span id="l2.1040"> }</span>
<a href="#l2.1041"></a><span id="l2.1041"> </span>
<a href="#l2.1042"></a><span id="l2.1042"> function getDestinationFolder(preselectedFolder, server)</span>
<a href="#l2.1043"></a><span id="l2.1043"> {</span>
<a href="#l2.1044"></a><span id="l2.1044" class="difflineminus">-    var destinationFolder = null;</span>
<a href="#l2.1045"></a><span id="l2.1045" class="difflineplus">+  var destinationFolder = null;</span>
<a href="#l2.1046"></a><span id="l2.1046"> </span>
<a href="#l2.1047"></a><span id="l2.1047" class="difflineminus">-    var isCreateSubfolders = preselectedFolder.canCreateSubfolders;</span>
<a href="#l2.1048"></a><span id="l2.1048" class="difflineminus">-    if (!isCreateSubfolders)</span>
<a href="#l2.1049"></a><span id="l2.1049" class="difflineminus">-    {</span>
<a href="#l2.1050"></a><span id="l2.1050" class="difflineminus">-        destinationFolder = server.rootMsgFolder;</span>
<a href="#l2.1051"></a><span id="l2.1051" class="difflineplus">+  if (!preselectedFolder.canCreateSubfolders)</span>
<a href="#l2.1052"></a><span id="l2.1052" class="difflineplus">+  {</span>
<a href="#l2.1053"></a><span id="l2.1053" class="difflineplus">+    destinationFolder = server.rootMsgFolder;</span>
<a href="#l2.1054"></a><span id="l2.1054"> </span>
<a href="#l2.1055"></a><span id="l2.1055" class="difflineminus">-        var verifyCreateSubfolders = null;</span>
<a href="#l2.1056"></a><span id="l2.1056" class="difflineminus">-        if (destinationFolder)</span>
<a href="#l2.1057"></a><span id="l2.1057" class="difflineminus">-            verifyCreateSubfolders = destinationFolder.canCreateSubfolders;</span>
<a href="#l2.1058"></a><span id="l2.1058" class="difflineplus">+    var verifyCreateSubfolders = null;</span>
<a href="#l2.1059"></a><span id="l2.1059" class="difflineplus">+    if (destinationFolder)</span>
<a href="#l2.1060"></a><span id="l2.1060" class="difflineplus">+      verifyCreateSubfolders = destinationFolder.canCreateSubfolders;</span>
<a href="#l2.1061"></a><span id="l2.1061"> </span>
<a href="#l2.1062"></a><span id="l2.1062" class="difflineminus">-        // in case the server cannot have subfolders,</span>
<a href="#l2.1063"></a><span id="l2.1063" class="difflineminus">-        // get default account and set its incoming server as parent folder</span>
<a href="#l2.1064"></a><span id="l2.1064" class="difflineminus">-        if (!verifyCreateSubfolders)</span>
<a href="#l2.1065"></a><span id="l2.1065" class="difflineminus">-        {</span>
<a href="#l2.1066"></a><span id="l2.1066" class="difflineminus">-            try {</span>
<a href="#l2.1067"></a><span id="l2.1067" class="difflineminus">-                var defaultFolder = GetDefaultAccountRootFolder();</span>
<a href="#l2.1068"></a><span id="l2.1068" class="difflineminus">-                var checkCreateSubfolders = null;</span>
<a href="#l2.1069"></a><span id="l2.1069" class="difflineminus">-                if (defaultFolder)</span>
<a href="#l2.1070"></a><span id="l2.1070" class="difflineminus">-                    checkCreateSubfolders = defaultFolder.canCreateSubfolders;</span>
<a href="#l2.1071"></a><span id="l2.1071" class="difflineplus">+    // In case the server cannot have subfolders, get default account and set</span>
<a href="#l2.1072"></a><span id="l2.1072" class="difflineplus">+    // its incoming server as parent folder.</span>
<a href="#l2.1073"></a><span id="l2.1073" class="difflineplus">+    if (!verifyCreateSubfolders)</span>
<a href="#l2.1074"></a><span id="l2.1074" class="difflineplus">+    {</span>
<a href="#l2.1075"></a><span id="l2.1075" class="difflineplus">+      try {</span>
<a href="#l2.1076"></a><span id="l2.1076" class="difflineplus">+        var defaultFolder = GetDefaultAccountRootFolder();</span>
<a href="#l2.1077"></a><span id="l2.1077" class="difflineplus">+        var checkCreateSubfolders = null;</span>
<a href="#l2.1078"></a><span id="l2.1078" class="difflineplus">+        if (defaultFolder)</span>
<a href="#l2.1079"></a><span id="l2.1079" class="difflineplus">+          checkCreateSubfolders = defaultFolder.canCreateSubfolders;</span>
<a href="#l2.1080"></a><span id="l2.1080"> </span>
<a href="#l2.1081"></a><span id="l2.1081" class="difflineminus">-                if (checkCreateSubfolders)</span>
<a href="#l2.1082"></a><span id="l2.1082" class="difflineminus">-                    destinationFolder = defaultFolder;</span>
<a href="#l2.1083"></a><span id="l2.1083" class="difflineplus">+        if (checkCreateSubfolders)</span>
<a href="#l2.1084"></a><span id="l2.1084" class="difflineplus">+          destinationFolder = defaultFolder;</span>
<a href="#l2.1085"></a><span id="l2.1085"> </span>
<a href="#l2.1086"></a><span id="l2.1086" class="difflineminus">-            } catch (e) {</span>
<a href="#l2.1087"></a><span id="l2.1087" class="difflineminus">-                dump (&quot;Exception: defaultAccount Not Available\n&quot;);</span>
<a href="#l2.1088"></a><span id="l2.1088" class="difflineminus">-            }</span>
<a href="#l2.1089"></a><span id="l2.1089" class="difflineminus">-        }</span>
<a href="#l2.1090"></a><span id="l2.1090" class="difflineplus">+      } catch (e) {</span>
<a href="#l2.1091"></a><span id="l2.1091" class="difflineplus">+          dump (&quot;Exception: defaultAccount Not Available\n&quot;);</span>
<a href="#l2.1092"></a><span id="l2.1092" class="difflineplus">+      }</span>
<a href="#l2.1093"></a><span id="l2.1093">     }</span>
<a href="#l2.1094"></a><span id="l2.1094" class="difflineminus">-    else</span>
<a href="#l2.1095"></a><span id="l2.1095" class="difflineminus">-        destinationFolder = preselectedFolder;</span>
<a href="#l2.1096"></a><span id="l2.1096" class="difflineplus">+  }</span>
<a href="#l2.1097"></a><span id="l2.1097" class="difflineplus">+  else</span>
<a href="#l2.1098"></a><span id="l2.1098" class="difflineplus">+    destinationFolder = preselectedFolder;</span>
<a href="#l2.1099"></a><span id="l2.1099"> </span>
<a href="#l2.1100"></a><span id="l2.1100" class="difflineminus">-    return destinationFolder;</span>
<a href="#l2.1101"></a><span id="l2.1101" class="difflineplus">+  return destinationFolder;</span>
<a href="#l2.1102"></a><span id="l2.1102"> }</span>
<a href="#l2.1103"></a><span id="l2.1103"> </span>
<a href="#l2.1104"></a><span id="l2.1104"> /** Open subscribe window. */</span>
<a href="#l2.1105"></a><span id="l2.1105"> function MsgSubscribe()</span>
<a href="#l2.1106"></a><span id="l2.1106"> {</span>
<a href="#l2.1107"></a><span id="l2.1107">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1108"></a><span id="l2.1108"> </span>
<a href="#l2.1109"></a><span id="l2.1109">   if (preselectedFolder &amp;&amp; preselectedFolder.server.type == &quot;rss&quot;)</span>
<a href="#l2.1110"></a><span id="l2.1110" class="difflineat">@@ -1227,26 +1148,26 @@ function ConfirmUnsubscribe(folder)</span>
<a href="#l2.1111"></a><span id="l2.1111"> {</span>
<a href="#l2.1112"></a><span id="l2.1112">   if (!gMessengerBundle)</span>
<a href="#l2.1113"></a><span id="l2.1113">     gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l2.1114"></a><span id="l2.1114"> </span>
<a href="#l2.1115"></a><span id="l2.1115">   var titleMsg = gMessengerBundle.getString(&quot;confirmUnsubscribeTitle&quot;);</span>
<a href="#l2.1116"></a><span id="l2.1116">   var dialogMsg = gMessengerBundle.getFormattedString(&quot;confirmUnsubscribeText&quot;,</span>
<a href="#l2.1117"></a><span id="l2.1117">                                       [folder.name], 1);</span>
<a href="#l2.1118"></a><span id="l2.1118"> </span>
<a href="#l2.1119"></a><span id="l2.1119" class="difflineminus">-  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService(Components.interfaces.nsIPromptService);</span>
<a href="#l2.1120"></a><span id="l2.1120" class="difflineplus">+  var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l2.1121"></a><span id="l2.1121" class="difflineplus">+                                .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l2.1122"></a><span id="l2.1122">   return promptService.confirm(window, titleMsg, dialogMsg);</span>
<a href="#l2.1123"></a><span id="l2.1123"> }</span>
<a href="#l2.1124"></a><span id="l2.1124"> </span>
<a href="#l2.1125"></a><span id="l2.1125"> function MsgUnsubscribe()</span>
<a href="#l2.1126"></a><span id="l2.1126"> {</span>
<a href="#l2.1127"></a><span id="l2.1127">   var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1128"></a><span id="l2.1128" class="difflineminus">-  if (ConfirmUnsubscribe(folder)) {</span>
<a href="#l2.1129"></a><span id="l2.1129" class="difflineplus">+  if (ConfirmUnsubscribe(folder))</span>
<a href="#l2.1130"></a><span id="l2.1130">     UnSubscribe(folder);</span>
<a href="#l2.1131"></a><span id="l2.1131" class="difflineminus">-  }</span>
<a href="#l2.1132"></a><span id="l2.1132"> }</span>
<a href="#l2.1133"></a><span id="l2.1133"> </span>
<a href="#l2.1134"></a><span id="l2.1134"> function ToggleFavoriteFolderFlag()</span>
<a href="#l2.1135"></a><span id="l2.1135"> {</span>
<a href="#l2.1136"></a><span id="l2.1136">   var folder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1137"></a><span id="l2.1137">   folder.toggleFlag(MSG_FOLDER_FLAG_FAVORITE);</span>
<a href="#l2.1138"></a><span id="l2.1138"> }</span>
<a href="#l2.1139"></a><span id="l2.1139"> </span>
<a href="#l2.1140"></a><span id="l2.1140" class="difflineat">@@ -1280,17 +1201,17 @@ function MsgOpenNewWindowForFolder(uri, </span>
<a href="#l2.1141"></a><span id="l2.1141">     window.openDialog(&quot;chrome://messenger/content/&quot;, &quot;_blank&quot;, &quot;chrome,all,dialog=no&quot;, uriToOpen, keyToSelect);</span>
<a href="#l2.1142"></a><span id="l2.1142"> }</span>
<a href="#l2.1143"></a><span id="l2.1143"> </span>
<a href="#l2.1144"></a><span id="l2.1144"> function CreateToolbarTooltip(document, event)</span>
<a href="#l2.1145"></a><span id="l2.1145"> {</span>
<a href="#l2.1146"></a><span id="l2.1146">   event.stopPropagation();</span>
<a href="#l2.1147"></a><span id="l2.1147">   var tn = document.tooltipNode;</span>
<a href="#l2.1148"></a><span id="l2.1148">   if (tn.localName != &quot;tab&quot;)</span>
<a href="#l2.1149"></a><span id="l2.1149" class="difflineminus">-    return false; // Not a tab, so cancel the tooltip</span>
<a href="#l2.1150"></a><span id="l2.1150" class="difflineplus">+    return false; // Not a tab, so cancel the tooltip.</span>
<a href="#l2.1151"></a><span id="l2.1151">   if (&quot;mOverCloseButton&quot; in tn &amp;&amp; tn.mOverCloseButton) {</span>
<a href="#l2.1152"></a><span id="l2.1152">      event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;closetabtext&quot;));</span>
<a href="#l2.1153"></a><span id="l2.1153">      return true;</span>
<a href="#l2.1154"></a><span id="l2.1154">   }</span>
<a href="#l2.1155"></a><span id="l2.1155">   if (tn.hasAttribute(&quot;label&quot;)) {</span>
<a href="#l2.1156"></a><span id="l2.1156">     event.target.setAttribute(&quot;label&quot;, tn.getAttribute(&quot;label&quot;));</span>
<a href="#l2.1157"></a><span id="l2.1157">     return true;</span>
<a href="#l2.1158"></a><span id="l2.1158">   }</span>
<a href="#l2.1159"></a><span id="l2.1159" class="difflineat">@@ -1299,17 +1220,17 @@ function CreateToolbarTooltip(document, </span>
<a href="#l2.1160"></a><span id="l2.1160"> </span>
<a href="#l2.1161"></a><span id="l2.1161"> function DisplayFolderAndThreadPane(show)</span>
<a href="#l2.1162"></a><span id="l2.1162"> {</span>
<a href="#l2.1163"></a><span id="l2.1163">   var collapse = !show;</span>
<a href="#l2.1164"></a><span id="l2.1164">   var layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l2.1165"></a><span id="l2.1165">   if (layout == kWidePaneConfig)</span>
<a href="#l2.1166"></a><span id="l2.1166">   {</span>
<a href="#l2.1167"></a><span id="l2.1167">     document.getElementById(&quot;messengerBox&quot;).collapsed = collapse;</span>
<a href="#l2.1168"></a><span id="l2.1168" class="difflineminus">-    // if opening a standalone message, need to give the messagepanebox flex.</span>
<a href="#l2.1169"></a><span id="l2.1169" class="difflineplus">+    // If opening a standalone message, need to give the messagepanebox flex.</span>
<a href="#l2.1170"></a><span id="l2.1170">     if (collapse)</span>
<a href="#l2.1171"></a><span id="l2.1171">       document.getElementById(&quot;messagepanebox&quot;).flex = 1;</span>
<a href="#l2.1172"></a><span id="l2.1172">   }</span>
<a href="#l2.1173"></a><span id="l2.1173"> </span>
<a href="#l2.1174"></a><span id="l2.1174">   if (layout == kVerticalPaneConfig)</span>
<a href="#l2.1175"></a><span id="l2.1175">     document.getElementById(&quot;threadTree&quot;).collapsed = collapse;</span>
<a href="#l2.1176"></a><span id="l2.1176">   else</span>
<a href="#l2.1177"></a><span id="l2.1177">     document.getElementById(&quot;displayDeck&quot;).collapsed = collapse;</span>
<a href="#l2.1178"></a><span id="l2.1178" class="difflineat">@@ -1324,20 +1245,20 @@ function DisplayFolderAndThreadPane(show</span>
<a href="#l2.1179"></a><span id="l2.1179">     document.getElementById(&quot;folder-location-container&quot;).collapsed = collapse;</span>
<a href="#l2.1180"></a><span id="l2.1180">   } catch (ex) {}</span>
<a href="#l2.1181"></a><span id="l2.1181">   try {</span>
<a href="#l2.1182"></a><span id="l2.1182">     document.getElementById(&quot;mailviews-container&quot;).collapsed = collapse;</span>
<a href="#l2.1183"></a><span id="l2.1183">   } catch (ex) {}</span>
<a href="#l2.1184"></a><span id="l2.1184"> }</span>
<a href="#l2.1185"></a><span id="l2.1185"> </span>
<a href="#l2.1186"></a><span id="l2.1186"> /**</span>
<a href="#l2.1187"></a><span id="l2.1187" class="difflineminus">- * mailTabType provides both &quot;folder&quot; and &quot;message&quot; tab modes.  Under the</span>
<a href="#l2.1188"></a><span id="l2.1188" class="difflineminus">- *  previous TabOwner framework, their logic was separated into two 'classes'</span>
<a href="#l2.1189"></a><span id="l2.1189" class="difflineminus">- *  which called common helper methods and had similar boilerplate logic.</span>
<a href="#l2.1190"></a><span id="l2.1190" class="difflineminus">-  */</span>
<a href="#l2.1191"></a><span id="l2.1191" class="difflineplus">+ * mailTabType provides both &quot;folder&quot; and &quot;message&quot; tab modes. Under the</span>
<a href="#l2.1192"></a><span id="l2.1192" class="difflineplus">+ * previous TabOwner framework, their logic was separated into two 'classes'</span>
<a href="#l2.1193"></a><span id="l2.1193" class="difflineplus">+ * which called common helper methods and had similar boilerplate logic.</span>
<a href="#l2.1194"></a><span id="l2.1194" class="difflineplus">+ */</span>
<a href="#l2.1195"></a><span id="l2.1195"> let mailTabType = {</span>
<a href="#l2.1196"></a><span id="l2.1196">   name: &quot;mail&quot;,</span>
<a href="#l2.1197"></a><span id="l2.1197">   panelId: &quot;mailContent&quot;,</span>
<a href="#l2.1198"></a><span id="l2.1198">   modes: {</span>
<a href="#l2.1199"></a><span id="l2.1199">     folder: {</span>
<a href="#l2.1200"></a><span id="l2.1200">       isDefault: true,</span>
<a href="#l2.1201"></a><span id="l2.1201">       type: &quot;folder&quot;,</span>
<a href="#l2.1202"></a><span id="l2.1202">       openTab: function(aTab, aFolderUri) {</span>
<a href="#l2.1203"></a><span id="l2.1203" class="difflineat">@@ -1367,93 +1288,91 @@ let mailTabType = {</span>
<a href="#l2.1204"></a><span id="l2.1204">         aTab.uriToOpen = aFolderUri;</span>
<a href="#l2.1205"></a><span id="l2.1205">         aTab.hdr = aMsgHdr;</span>
<a href="#l2.1206"></a><span id="l2.1206"> </span>
<a href="#l2.1207"></a><span id="l2.1207">         aTab.title = aTab.hdr.mime2DecodedSubject;</span>
<a href="#l2.1208"></a><span id="l2.1208"> </span>
<a href="#l2.1209"></a><span id="l2.1209">         this.openTab(aTab); // call superclass logic</span>
<a href="#l2.1210"></a><span id="l2.1210"> </span>
<a href="#l2.1211"></a><span id="l2.1211">         gCurrentlyDisplayedMessage = nsMsgViewIndex_None;</span>
<a href="#l2.1212"></a><span id="l2.1212" class="difflineminus">-  ClearThreadPaneSelection(); </span>
<a href="#l2.1213"></a><span id="l2.1213" class="difflineplus">+        ClearThreadPaneSelection();</span>
<a href="#l2.1214"></a><span id="l2.1214">         setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.hdr.folder,</span>
<a href="#l2.1215"></a><span id="l2.1215">                    aTab.hdr.messageKey);</span>
<a href="#l2.1216"></a><span id="l2.1216"> </span>
<a href="#l2.1217"></a><span id="l2.1217">         // let's try hiding the thread pane and folder pane</span>
<a href="#l2.1218"></a><span id="l2.1218">         this.folderAndThreadPaneVisible = false;</span>
<a href="#l2.1219"></a><span id="l2.1219">       },</span>
<a href="#l2.1220"></a><span id="l2.1220">       showTab: function(aTab) {</span>
<a href="#l2.1221"></a><span id="l2.1221">         this.folderAndThreadPaneVisible = false;</span>
<a href="#l2.1222"></a><span id="l2.1222" class="difflineminus">-        // ClearMessagePane();</span>
<a href="#l2.1223"></a><span id="l2.1223" class="difflineminus">-</span>
<a href="#l2.1224"></a><span id="l2.1224">         this.showTab(aTab);</span>
<a href="#l2.1225"></a><span id="l2.1225">       }</span>
<a href="#l2.1226"></a><span id="l2.1226">     }</span>
<a href="#l2.1227"></a><span id="l2.1227">   },</span>
<a href="#l2.1228"></a><span id="l2.1228">   /**</span>
<a href="#l2.1229"></a><span id="l2.1229">    * Create the new tab's state, which engenders some side effects.  Part of our</span>
<a href="#l2.1230"></a><span id="l2.1230">    *  contract is that we leave the tab in the selected state.</span>
<a href="#l2.1231"></a><span id="l2.1231">    */</span>
<a href="#l2.1232"></a><span id="l2.1232">   openTab: function(aTab) {</span>
<a href="#l2.1233"></a><span id="l2.1233">     ClearThreadPaneSelection();</span>
<a href="#l2.1234"></a><span id="l2.1234"> </span>
<a href="#l2.1235"></a><span id="l2.1235" class="difflineminus">-    // each tab gets its own messenger instance; I assume this is so each one</span>
<a href="#l2.1236"></a><span id="l2.1236" class="difflineminus">-    //  gets its own undo/redo stack?</span>
<a href="#l2.1237"></a><span id="l2.1237" class="difflineminus">-  messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l2.1238"></a><span id="l2.1238" class="difflineminus">-                        .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l2.1239"></a><span id="l2.1239" class="difflineminus">-  messenger.setWindow(window, msgWindow);</span>
<a href="#l2.1240"></a><span id="l2.1240" class="difflineplus">+    // Each tab gets its own messenger instance; I assume this is so each one</span>
<a href="#l2.1241"></a><span id="l2.1241" class="difflineplus">+    // gets its own undo/redo stack?</span>
<a href="#l2.1242"></a><span id="l2.1242" class="difflineplus">+    messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l2.1243"></a><span id="l2.1243" class="difflineplus">+                          .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l2.1244"></a><span id="l2.1244" class="difflineplus">+    messenger.setWindow(window, msgWindow);</span>
<a href="#l2.1245"></a><span id="l2.1245">     aTab.messenger = messenger;</span>
<a href="#l2.1246"></a><span id="l2.1246"> </span>
<a href="#l2.1247"></a><span id="l2.1247">     aTab.msgSelectedFolder = gMsgFolderSelected;</span>
<a href="#l2.1248"></a><span id="l2.1248"> </span>
<a href="#l2.1249"></a><span id="l2.1249" class="difflineminus">-  // clear selection, because context clicking on a folder and opening in a new</span>
<a href="#l2.1250"></a><span id="l2.1250" class="difflineminus">-  // tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l2.1251"></a><span id="l2.1251" class="difflineminus">-  // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l2.1252"></a><span id="l2.1252" class="difflineminus">-  // folder loads when things haven't changed.</span>
<a href="#l2.1253"></a><span id="l2.1253" class="difflineminus">-  GetFolderTree().view.selection.clearSelection();</span>
<a href="#l2.1254"></a><span id="l2.1254" class="difflineminus">-  GetFolderTree().view.selection.currentIndex = -1;</span>
<a href="#l2.1255"></a><span id="l2.1255" class="difflineminus">-  gMsgFolderSelected = null;</span>
<a href="#l2.1256"></a><span id="l2.1256" class="difflineminus">-  msgWindow.openFolder = null;</span>
<a href="#l2.1257"></a><span id="l2.1257" class="difflineplus">+    // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l2.1258"></a><span id="l2.1258" class="difflineplus">+    // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l2.1259"></a><span id="l2.1259" class="difflineplus">+    // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l2.1260"></a><span id="l2.1260" class="difflineplus">+    // folder loads when things haven't changed.</span>
<a href="#l2.1261"></a><span id="l2.1261" class="difflineplus">+    GetFolderTree().view.selection.clearSelection();</span>
<a href="#l2.1262"></a><span id="l2.1262" class="difflineplus">+    GetFolderTree().view.selection.currentIndex = -1;</span>
<a href="#l2.1263"></a><span id="l2.1263" class="difflineplus">+    gMsgFolderSelected = null;</span>
<a href="#l2.1264"></a><span id="l2.1264" class="difflineplus">+    msgWindow.openFolder = null;</span>
<a href="#l2.1265"></a><span id="l2.1265"> </span>
<a href="#l2.1266"></a><span id="l2.1266" class="difflineminus">-  // clear thread pane selection - otherwise, the tree tries to impose </span>
<a href="#l2.1267"></a><span id="l2.1267" class="difflineminus">-  // the current selection on the new view.</span>
<a href="#l2.1268"></a><span id="l2.1268" class="difflineminus">-  gDBView = null; // clear gDBView so we won't try to close it.</span>
<a href="#l2.1269"></a><span id="l2.1269" class="difflineplus">+    // Clear thread pane selection - otherwise, the tree tries to impose the</span>
<a href="#l2.1270"></a><span id="l2.1270" class="difflineplus">+    // current selection on the new view.</span>
<a href="#l2.1271"></a><span id="l2.1271" class="difflineplus">+    gDBView = null; // Clear gDBView so we won't try to close it.</span>
<a href="#l2.1272"></a><span id="l2.1272">     SelectFolder(aTab.uriToOpen);</span>
<a href="#l2.1273"></a><span id="l2.1273">     aTab.dbView = gDBView;</span>
<a href="#l2.1274"></a><span id="l2.1274">   },</span>
<a href="#l2.1275"></a><span id="l2.1275" class="difflineminus">-  </span>
<a href="#l2.1276"></a><span id="l2.1276" class="difflineplus">+</span>
<a href="#l2.1277"></a><span id="l2.1277">   closeTab: function(aTab) {</span>
<a href="#l2.1278"></a><span id="l2.1278">     if (aTab.dbView)</span>
<a href="#l2.1279"></a><span id="l2.1279">       aTab.dbView.close();</span>
<a href="#l2.1280"></a><span id="l2.1280">     if (aTab.messenger)</span>
<a href="#l2.1281"></a><span id="l2.1281">       aTab.messenger.setWindow(null, null);</span>
<a href="#l2.1282"></a><span id="l2.1282">   },</span>
<a href="#l2.1283"></a><span id="l2.1283"> </span>
<a href="#l2.1284"></a><span id="l2.1284">   saveTabState: function(aTab) {</span>
<a href="#l2.1285"></a><span id="l2.1285">     aTab.messenger = messenger;</span>
<a href="#l2.1286"></a><span id="l2.1286">     aTab.dbView = gDBView;</span>
<a href="#l2.1287"></a><span id="l2.1287">     aTab.searchSession = gSearchSession;</span>
<a href="#l2.1288"></a><span id="l2.1288"> </span>
<a href="#l2.1289"></a><span id="l2.1289">     if (!gDBView)</span>
<a href="#l2.1290"></a><span id="l2.1290">       return;</span>
<a href="#l2.1291"></a><span id="l2.1291" class="difflineminus">-      </span>
<a href="#l2.1292"></a><span id="l2.1292" class="difflineplus">+</span>
<a href="#l2.1293"></a><span id="l2.1293">     if (gDBView.currentlyDisplayedMessage != nsMsgViewIndex_None)</span>
<a href="#l2.1294"></a><span id="l2.1294">     {</span>
<a href="#l2.1295"></a><span id="l2.1295">       try // there may not be a selected message.</span>
<a href="#l2.1296"></a><span id="l2.1296">       {</span>
<a href="#l2.1297"></a><span id="l2.1297">         var curMsgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.1298"></a><span id="l2.1298">         aTab.selectedMsgId = curMsgHdr.messageId;</span>
<a href="#l2.1299"></a><span id="l2.1299">         aTab.msgSelectedFolder = curMsgHdr.folder;</span>
<a href="#l2.1300"></a><span id="l2.1300">       }</span>
<a href="#l2.1301"></a><span id="l2.1301">       catch (ex)</span>
<a href="#l2.1302"></a><span id="l2.1302">       {</span>
<a href="#l2.1303"></a><span id="l2.1303">         aTab.msgSelectedFolder = gMsgFolderSelected</span>
<a href="#l2.1304"></a><span id="l2.1304">       }</span>
<a href="#l2.1305"></a><span id="l2.1305">     }</span>
<a href="#l2.1306"></a><span id="l2.1306">     else</span>
<a href="#l2.1307"></a><span id="l2.1307" class="difflineminus">-  {</span>
<a href="#l2.1308"></a><span id="l2.1308" class="difflineplus">+    {</span>
<a href="#l2.1309"></a><span id="l2.1309">       aTab.selectedMsgId = null;</span>
<a href="#l2.1310"></a><span id="l2.1310">       aTab.msgSelectedFolder = null;</span>
<a href="#l2.1311"></a><span id="l2.1311">     }</span>
<a href="#l2.1312"></a><span id="l2.1312">   },</span>
<a href="#l2.1313"></a><span id="l2.1313"> </span>
<a href="#l2.1314"></a><span id="l2.1314">   _folderAndThreadPaneVisible: true,</span>
<a href="#l2.1315"></a><span id="l2.1315">   get folderAndThreadPaneVisible() { return this._folderAndThreadPaneVisible; },</span>
<a href="#l2.1316"></a><span id="l2.1316">   set folderAndThreadPaneVisible(aDesiredVisible) {</span>
<a href="#l2.1317"></a><span id="l2.1317" class="difflineat">@@ -1466,121 +1385,121 @@ let mailTabType = {</span>
<a href="#l2.1318"></a><span id="l2.1318">   showTab: function(aTab) {</span>
<a href="#l2.1319"></a><span id="l2.1319">     // restore globals</span>
<a href="#l2.1320"></a><span id="l2.1320">     messenger = aTab.messenger;</span>
<a href="#l2.1321"></a><span id="l2.1321">     gDBView = aTab.dbView;</span>
<a href="#l2.1322"></a><span id="l2.1322">     gSearchSession = aTab.searchSession;</span>
<a href="#l2.1323"></a><span id="l2.1323"> </span>
<a href="#l2.1324"></a><span id="l2.1324">     // restore view state if we had one</span>
<a href="#l2.1325"></a><span id="l2.1325">     if (gDBView)</span>
<a href="#l2.1326"></a><span id="l2.1326" class="difflineminus">-  {</span>
<a href="#l2.1327"></a><span id="l2.1327" class="difflineplus">+    {</span>
<a href="#l2.1328"></a><span id="l2.1328">       var folderTree = GetFolderTree();</span>
<a href="#l2.1329"></a><span id="l2.1329">       var row = EnsureFolderIndex(folderTree.builderView, gDBView.msgFolder);</span>
<a href="#l2.1330"></a><span id="l2.1330"> </span>
<a href="#l2.1331"></a><span id="l2.1331">       var folderTreeBoxObj = folderTree.treeBoxObject;</span>
<a href="#l2.1332"></a><span id="l2.1332">       var folderTreeSelection = folderTreeBoxObj.view.selection;</span>
<a href="#l2.1333"></a><span id="l2.1333">       // make sure that row.value is valid so that it doesn't mess up</span>
<a href="#l2.1334"></a><span id="l2.1334">       // the call to ensureRowIsVisible().</span>
<a href="#l2.1335"></a><span id="l2.1335">       if ((row &gt;= 0) &amp;&amp; !folderTreeSelection.isSelected(row))</span>
<a href="#l2.1336"></a><span id="l2.1336" class="difflineminus">-    {</span>
<a href="#l2.1337"></a><span id="l2.1337" class="difflineplus">+      {</span>
<a href="#l2.1338"></a><span id="l2.1338">         gMsgFolderSelected = gDBView.msgFolder;</span>
<a href="#l2.1339"></a><span id="l2.1339">         folderTreeSelection.selectEventsSuppressed = true;</span>
<a href="#l2.1340"></a><span id="l2.1340">         folderTreeSelection.select(row);</span>
<a href="#l2.1341"></a><span id="l2.1341">         folderTreeBoxObj.ensureRowIsVisible(row);</span>
<a href="#l2.1342"></a><span id="l2.1342">         folderTreeSelection.selectEventsSuppressed = false;</span>
<a href="#l2.1343"></a><span id="l2.1343" class="difflineminus">-    }</span>
<a href="#l2.1344"></a><span id="l2.1344" class="difflineminus">-      // this sets the thread pane tree's view to the gDBView view.</span>
<a href="#l2.1345"></a><span id="l2.1345" class="difflineplus">+      }</span>
<a href="#l2.1346"></a><span id="l2.1346" class="difflineplus">+      // This sets the thread pane tree's view to the gDBView view.</span>
<a href="#l2.1347"></a><span id="l2.1347">       UpdateSortIndicators(gDBView.sortType, gDBView.sortOrder);</span>
<a href="#l2.1348"></a><span id="l2.1348">       RerootThreadPane();</span>
<a href="#l2.1349"></a><span id="l2.1349" class="difflineminus">-      // we need to restore the selection to what it was when we switched away</span>
<a href="#l2.1350"></a><span id="l2.1350" class="difflineminus">-      // from this tab. we need to remember the selected keys, instead of the</span>
<a href="#l2.1351"></a><span id="l2.1351" class="difflineplus">+      // We need to restore the selection to what it was when we switched away</span>
<a href="#l2.1352"></a><span id="l2.1352" class="difflineplus">+      // from this tab. We need to remember the selected keys, instead of the</span>
<a href="#l2.1353"></a><span id="l2.1353">       // selected indices, since the view might have changed. But maybe the</span>
<a href="#l2.1354"></a><span id="l2.1354">       // selectedIndices adjust as items are added/removed from the (hidden)</span>
<a href="#l2.1355"></a><span id="l2.1355">       // view.</span>
<a href="#l2.1356"></a><span id="l2.1356">       try</span>
<a href="#l2.1357"></a><span id="l2.1357" class="difflineminus">-  {</span>
<a href="#l2.1358"></a><span id="l2.1358" class="difflineplus">+      {</span>
<a href="#l2.1359"></a><span id="l2.1359">         if (aTab.selectedMsgId &amp;&amp; aTab.msgSelectedFolder)</span>
<a href="#l2.1360"></a><span id="l2.1360" class="difflineminus">-  {</span>
<a href="#l2.1361"></a><span id="l2.1361" class="difflineminus">-          // we clear the selection in order to generate an event when we</span>
<a href="#l2.1362"></a><span id="l2.1362" class="difflineminus">-          //  re-select our message.</span>
<a href="#l2.1363"></a><span id="l2.1363" class="difflineplus">+        {</span>
<a href="#l2.1364"></a><span id="l2.1364" class="difflineplus">+          // We clear the selection in order to generate an event when we</span>
<a href="#l2.1365"></a><span id="l2.1365" class="difflineplus">+          // re-select our message.</span>
<a href="#l2.1366"></a><span id="l2.1366">           ClearThreadPaneSelection();</span>
<a href="#l2.1367"></a><span id="l2.1367"> </span>
<a href="#l2.1368"></a><span id="l2.1368">           var msgDB = aTab.msgSelectedFolder.getMsgDatabase(msgWindow);</span>
<a href="#l2.1369"></a><span id="l2.1369">           var msgHdr = msgDB.getMsgHdrForMessageID(aTab.selectedMsgId);</span>
<a href="#l2.1370"></a><span id="l2.1370">           setTimeout(gDBView.selectFolderMsgByKey, 0, aTab.msgSelectedFolder,</span>
<a href="#l2.1371"></a><span id="l2.1371">                      msgHdr.messageKey);</span>
<a href="#l2.1372"></a><span id="l2.1372">         }</span>
<a href="#l2.1373"></a><span id="l2.1373" class="difflineminus">-        // (we do not clear the selection if there was more than one message</span>
<a href="#l2.1374"></a><span id="l2.1374" class="difflineminus">-        //  displayed.  this leaves our selection intact. there was originally</span>
<a href="#l2.1375"></a><span id="l2.1375" class="difflineminus">-        //  some claim that the selection might lose synchronization with the</span>
<a href="#l2.1376"></a><span id="l2.1376" class="difflineminus">-        //  view, but this is unsubstantiated.  said comment came from the</span>
<a href="#l2.1377"></a><span id="l2.1377" class="difflineminus">-        //  original code that stored information on the selected rows, but</span>
<a href="#l2.1378"></a><span id="l2.1378" class="difflineminus">-        //  then failed to do anything with it, probably because there is no</span>
<a href="#l2.1379"></a><span id="l2.1379" class="difflineminus">-        //  existing API call that accomplishes it.)</span>
<a href="#l2.1380"></a><span id="l2.1380" class="difflineplus">+        // We do not clear the selection if there was more than one message</span>
<a href="#l2.1381"></a><span id="l2.1381" class="difflineplus">+        // displayed.  this leaves our selection intact. there was originally</span>
<a href="#l2.1382"></a><span id="l2.1382" class="difflineplus">+        // some claim that the selection might lose synchronization with the</span>
<a href="#l2.1383"></a><span id="l2.1383" class="difflineplus">+        // view, but this is unsubstantiated.  said comment came from the</span>
<a href="#l2.1384"></a><span id="l2.1384" class="difflineplus">+        // original code that stored information on the selected rows, but</span>
<a href="#l2.1385"></a><span id="l2.1385" class="difflineplus">+        // then failed to do anything with it, probably because there is no</span>
<a href="#l2.1386"></a><span id="l2.1386" class="difflineplus">+        // existing API call that accomplishes it.</span>
<a href="#l2.1387"></a><span id="l2.1387">       }</span>
<a href="#l2.1388"></a><span id="l2.1388">       catch (ex) {dump(ex);}</span>
<a href="#l2.1389"></a><span id="l2.1389">     }</span>
<a href="#l2.1390"></a><span id="l2.1390">     // make sure the folder tree knows that we don't have a view</span>
<a href="#l2.1391"></a><span id="l2.1391">     else</span>
<a href="#l2.1392"></a><span id="l2.1392">     {</span>
<a href="#l2.1393"></a><span id="l2.1393">       var tree = GetThreadTree();</span>
<a href="#l2.1394"></a><span id="l2.1394">       tree.boxObject.QueryInterface(Components.interfaces.nsITreeBoxObject)</span>
<a href="#l2.1395"></a><span id="l2.1395" class="difflineminus">-        .view = null;</span>
<a href="#l2.1396"></a><span id="l2.1396" class="difflineplus">+          .view = null;</span>
<a href="#l2.1397"></a><span id="l2.1397">       ClearMessagePane();</span>
<a href="#l2.1398"></a><span id="l2.1398">     }</span>
<a href="#l2.1399"></a><span id="l2.1399">   }</span>
<a href="#l2.1400"></a><span id="l2.1400"> };</span>
<a href="#l2.1401"></a><span id="l2.1401"> window.addEventListener(&quot;load&quot;, function(e) {</span>
<a href="#l2.1402"></a><span id="l2.1402">     let tabmail = document.getElementById('tabmail');</span>
<a href="#l2.1403"></a><span id="l2.1403">     if (tabmail) {</span>
<a href="#l2.1404"></a><span id="l2.1404">       tabmail.registerTabType(mailTabType);</span>
<a href="#l2.1405"></a><span id="l2.1405">       tabmail.openFirstTab();</span>
<a href="#l2.1406"></a><span id="l2.1406">     }</span>
<a href="#l2.1407"></a><span id="l2.1407" class="difflineminus">-  }, false);</span>
<a href="#l2.1408"></a><span id="l2.1408" class="difflineplus">+  }, false</span>
<a href="#l2.1409"></a><span id="l2.1409" class="difflineplus">+);</span>
<a href="#l2.1410"></a><span id="l2.1410"> </span>
<a href="#l2.1411"></a><span id="l2.1411"> function MsgOpenNewTabForFolder(uri, key)</span>
<a href="#l2.1412"></a><span id="l2.1412"> {</span>
<a href="#l2.1413"></a><span id="l2.1413">   var uriToOpen = uri;</span>
<a href="#l2.1414"></a><span id="l2.1414">   var keyToSelect = key;</span>
<a href="#l2.1415"></a><span id="l2.1415" class="difflineminus">-  </span>
<a href="#l2.1416"></a><span id="l2.1416" class="difflineplus">+</span>
<a href="#l2.1417"></a><span id="l2.1417">   if (!uriToOpen)</span>
<a href="#l2.1418"></a><span id="l2.1418" class="difflineminus">-    // use GetSelectedFolderURI() to find out which message to open instead of</span>
<a href="#l2.1419"></a><span id="l2.1419" class="difflineplus">+    // Use GetSelectedFolderURI() to find out which message to open instead of</span>
<a href="#l2.1420"></a><span id="l2.1420">     // GetLoadedMsgFolder().URI. This is required because on a right-click, the</span>
<a href="#l2.1421"></a><span id="l2.1421">     // currentIndex value will be different from the actual row that is</span>
<a href="#l2.1422"></a><span id="l2.1422">     // highlighted. GetSelectedFolderURI() will return the message that is</span>
<a href="#l2.1423"></a><span id="l2.1423">     // highlighted.</span>
<a href="#l2.1424"></a><span id="l2.1424">     uriToOpen = GetSelectedFolderURI();</span>
<a href="#l2.1425"></a><span id="l2.1425" class="difflineminus">-  </span>
<a href="#l2.1426"></a><span id="l2.1426" class="difflineminus">-  // set up the first tab, which was previously invisible.</span>
<a href="#l2.1427"></a><span id="l2.1427" class="difflineplus">+</span>
<a href="#l2.1428"></a><span id="l2.1428" class="difflineplus">+  // Set up the first tab, which was previously invisible.</span>
<a href="#l2.1429"></a><span id="l2.1429">   // This assumes the first tab is always a 3-pane ui, which</span>
<a href="#l2.1430"></a><span id="l2.1430">   // may not be right, especially if we have the ability</span>
<a href="#l2.1431"></a><span id="l2.1431">   // to persist your tab setup.</span>
<a href="#l2.1432"></a><span id="l2.1432">   document.getElementById('tabmail').openTab(&quot;folder&quot;, uriToOpen);</span>
<a href="#l2.1433"></a><span id="l2.1433"> }</span>
<a href="#l2.1434"></a><span id="l2.1434"> </span>
<a href="#l2.1435"></a><span id="l2.1435"> function MsgOpenNewTabForMessage(messageKey, folderUri)</span>
<a href="#l2.1436"></a><span id="l2.1436"> {</span>
<a href="#l2.1437"></a><span id="l2.1437">   if (!messageKey)</span>
<a href="#l2.1438"></a><span id="l2.1438">     messageKey = gDBView.keyForFirstSelectedMessage;</span>
<a href="#l2.1439"></a><span id="l2.1439"> </span>
<a href="#l2.1440"></a><span id="l2.1440">   var hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.1441"></a><span id="l2.1441">   if (!folderUri)</span>
<a href="#l2.1442"></a><span id="l2.1442" class="difflineminus">-    // use the header's folder - this will open a msg in a virtual folder view</span>
<a href="#l2.1443"></a><span id="l2.1443" class="difflineplus">+    // Use the header's folder - this will open a msg in a virtual folder view</span>
<a href="#l2.1444"></a><span id="l2.1444">     // in its real folder, which is needed if the msg wouldn't be in a new</span>
<a href="#l2.1445"></a><span id="l2.1445">     // view with the same terms - e.g., it's read and the view is unread only.</span>
<a href="#l2.1446"></a><span id="l2.1446">     // If we cloned the view, we wouldn't have to do this.</span>
<a href="#l2.1447"></a><span id="l2.1447">     folderUri = hdr.folder.URI;</span>
<a href="#l2.1448"></a><span id="l2.1448" class="difflineminus">-  </span>
<a href="#l2.1449"></a><span id="l2.1449" class="difflineminus">-  // fix it so we won't try to load the previously loaded message.</span>
<a href="#l2.1450"></a><span id="l2.1450" class="difflineplus">+</span>
<a href="#l2.1451"></a><span id="l2.1451" class="difflineplus">+  // Fix it so we won't try to load the previously loaded message.</span>
<a href="#l2.1452"></a><span id="l2.1452">   hdr.folder.lastMessageLoaded = nsMsgKey_None;</span>
<a href="#l2.1453"></a><span id="l2.1453" class="difflineminus">-  </span>
<a href="#l2.1454"></a><span id="l2.1454" class="difflineplus">+</span>
<a href="#l2.1455"></a><span id="l2.1455">   document.getElementById('tabmail').openTab(&quot;message&quot;, folderUri, hdr);</span>
<a href="#l2.1456"></a><span id="l2.1456"> }</span>
<a href="#l2.1457"></a><span id="l2.1457"> </span>
<a href="#l2.1458"></a><span id="l2.1458" class="difflineminus">-// passing in the view, so this will work for search and the thread pane</span>
<a href="#l2.1459"></a><span id="l2.1459"> function MsgOpenSelectedMessages()</span>
<a href="#l2.1460"></a><span id="l2.1460"> {</span>
<a href="#l2.1461"></a><span id="l2.1461">   var dbView = GetDBView();</span>
<a href="#l2.1462"></a><span id="l2.1462"> </span>
<a href="#l2.1463"></a><span id="l2.1463">   var indices = GetSelectedIndices(dbView);</span>
<a href="#l2.1464"></a><span id="l2.1464">   var numMessages = indices.length;</span>
<a href="#l2.1465"></a><span id="l2.1465"> </span>
<a href="#l2.1466"></a><span id="l2.1466">   var windowReuse = gPrefBranch.getBoolPref(&quot;mailnews.reuse_message_window&quot;);</span>
<a href="#l2.1467"></a><span id="l2.1467" class="difflineat">@@ -1590,31 +1509,32 @@ function MsgOpenSelectedMessages()</span>
<a href="#l2.1468"></a><span id="l2.1468">   // pref (either 'bool' or 'int' type) to describe it.</span>
<a href="#l2.1469"></a><span id="l2.1469">   //</span>
<a href="#l2.1470"></a><span id="l2.1470">   // windowReuse values: false, true</span>
<a href="#l2.1471"></a><span id="l2.1471">   //    false: open new standalone message window for each message</span>
<a href="#l2.1472"></a><span id="l2.1472">   //    true : reuse existing standalone message window for each message</span>
<a href="#l2.1473"></a><span id="l2.1473">   if (windowReuse &amp;&amp; numMessages == 1 &amp;&amp;</span>
<a href="#l2.1474"></a><span id="l2.1474">       MsgOpenSelectedMessageInExistingWindow())</span>
<a href="#l2.1475"></a><span id="l2.1475">     return;</span>
<a href="#l2.1476"></a><span id="l2.1476" class="difflineminus">-    </span>
<a href="#l2.1477"></a><span id="l2.1477" class="difflineplus">+</span>
<a href="#l2.1478"></a><span id="l2.1478">   var openWindowWarning = gPrefBranch.getIntPref(&quot;mailnews.open_window_warning&quot;);</span>
<a href="#l2.1479"></a><span id="l2.1479">   if ((openWindowWarning &gt; 1) &amp;&amp; (numMessages &gt;= openWindowWarning)) {</span>
<a href="#l2.1480"></a><span id="l2.1480">     if (!gMessengerBundle)</span>
<a href="#l2.1481"></a><span id="l2.1481">         gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l2.1482"></a><span id="l2.1482">     var title = gMessengerBundle.getString(&quot;openWindowWarningTitle&quot;);</span>
<a href="#l2.1483"></a><span id="l2.1483">     var text = gMessengerBundle.getFormattedString(&quot;openWindowWarningText&quot;, [numMessages]);</span>
<a href="#l2.1484"></a><span id="l2.1484">     var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l2.1485"></a><span id="l2.1485" class="difflineminus">-                          .getService(Components.interfaces.nsIPromptService);    </span>
<a href="#l2.1486"></a><span id="l2.1486" class="difflineplus">+                                  .getService(Components.interfaces.nsIPromptService);</span>
<a href="#l2.1487"></a><span id="l2.1487">     if (!promptService.confirm(window, title, text))</span>
<a href="#l2.1488"></a><span id="l2.1488">       return;</span>
<a href="#l2.1489"></a><span id="l2.1489">   }</span>
<a href="#l2.1490"></a><span id="l2.1490"> </span>
<a href="#l2.1491"></a><span id="l2.1491">   for (var i = 0; i &lt; numMessages; i++) {</span>
<a href="#l2.1492"></a><span id="l2.1492" class="difflineminus">-    MsgOpenNewWindowForMessage(dbView.getURIForViewIndex(indices[i]), dbView.getFolderForViewIndex(indices[i]).URI);</span>
<a href="#l2.1493"></a><span id="l2.1493" class="difflineplus">+    MsgOpenNewWindowForMessage(dbView.getURIForViewIndex(indices[i]),</span>
<a href="#l2.1494"></a><span id="l2.1494" class="difflineplus">+                               dbView.getFolderForViewIndex(indices[i]).URI);</span>
<a href="#l2.1495"></a><span id="l2.1495">   }</span>
<a href="#l2.1496"></a><span id="l2.1496"> }</span>
<a href="#l2.1497"></a><span id="l2.1497"> </span>
<a href="#l2.1498"></a><span id="l2.1498"> function MsgOpenSelectedMessageInExistingWindow()</span>
<a href="#l2.1499"></a><span id="l2.1499"> {</span>
<a href="#l2.1500"></a><span id="l2.1500">   var windowID = GetWindowByWindowType(&quot;mail:messageWindow&quot;);</span>
<a href="#l2.1501"></a><span id="l2.1501">   if (!windowID)</span>
<a href="#l2.1502"></a><span id="l2.1502">     return false;</span>
<a href="#l2.1503"></a><span id="l2.1503" class="difflineat">@@ -1625,221 +1545,214 @@ function MsgOpenSelectedMessageInExistin</span>
<a href="#l2.1504"></a><span id="l2.1504"> </span>
<a href="#l2.1505"></a><span id="l2.1505">     // Reset the window's message uri and folder uri vars, and</span>
<a href="#l2.1506"></a><span id="l2.1506">     // update the command handlers to what's going to be used.</span>
<a href="#l2.1507"></a><span id="l2.1507">     // This has to be done before the call to CreateView().</span>
<a href="#l2.1508"></a><span id="l2.1508">     windowID.gCurrentMessageUri = messageURI;</span>
<a href="#l2.1509"></a><span id="l2.1509">     windowID.gCurrentFolderUri = msgHdr.folder.URI;</span>
<a href="#l2.1510"></a><span id="l2.1510">     windowID.UpdateMailToolbar('MsgOpenExistingWindowForMessage');</span>
<a href="#l2.1511"></a><span id="l2.1511"> </span>
<a href="#l2.1512"></a><span id="l2.1512" class="difflineminus">-    // even if the folder uri's match, we can't use the existing view</span>
<a href="#l2.1513"></a><span id="l2.1513" class="difflineplus">+    // Even if the folder uri's match, we can't use the existing view</span>
<a href="#l2.1514"></a><span id="l2.1514">     // (msgHdr.folder.URI == windowID.gCurrentFolderUri)</span>
<a href="#l2.1515"></a><span id="l2.1515" class="difflineminus">-    // the reason is quick search and mail views.</span>
<a href="#l2.1516"></a><span id="l2.1516" class="difflineminus">-    // see bug #187673</span>
<a href="#l2.1517"></a><span id="l2.1517" class="difflineplus">+    // - the reason is quick search and mail views. See bug #187673.</span>
<a href="#l2.1518"></a><span id="l2.1518">     //</span>
<a href="#l2.1519"></a><span id="l2.1519" class="difflineminus">-    // for the sake of simplicity,</span>
<a href="#l2.1520"></a><span id="l2.1520" class="difflineminus">-    // let's always call CreateView(gDBView)</span>
<a href="#l2.1521"></a><span id="l2.1521" class="difflineminus">-    // which will clone gDBView</span>
<a href="#l2.1522"></a><span id="l2.1522" class="difflineplus">+    // For the sake of simplicity, let's always call CreateView(gDBView);</span>
<a href="#l2.1523"></a><span id="l2.1523" class="difflineplus">+    // which will clone gDBView.</span>
<a href="#l2.1524"></a><span id="l2.1524">     windowID.CreateView(gDBView);</span>
<a href="#l2.1525"></a><span id="l2.1525">     windowID.LoadMessageByMsgKey(msgHdr.messageKey);</span>
<a href="#l2.1526"></a><span id="l2.1526"> </span>
<a href="#l2.1527"></a><span id="l2.1527">     // bring existing window to front</span>
<a href="#l2.1528"></a><span id="l2.1528">     windowID.focus();</span>
<a href="#l2.1529"></a><span id="l2.1529">     return true;</span>
<a href="#l2.1530"></a><span id="l2.1530">   }</span>
<a href="#l2.1531"></a><span id="l2.1531">   catch (ex) {</span>
<a href="#l2.1532"></a><span id="l2.1532">     dump(&quot;reusing existing standalone message window failed: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l2.1533"></a><span id="l2.1533">   }</span>
<a href="#l2.1534"></a><span id="l2.1534">   return false;</span>
<a href="#l2.1535"></a><span id="l2.1535"> }</span>
<a href="#l2.1536"></a><span id="l2.1536"> </span>
<a href="#l2.1537"></a><span id="l2.1537" class="difflineminus">-const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l2.1538"></a><span id="l2.1538" class="difflineminus">-</span>
<a href="#l2.1539"></a><span id="l2.1539"> function MsgOpenFromFile()</span>
<a href="#l2.1540"></a><span id="l2.1540"> {</span>
<a href="#l2.1541"></a><span id="l2.1541" class="difflineminus">-  var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l2.1542"></a><span id="l2.1542" class="difflineplus">+  const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l2.1543"></a><span id="l2.1543" class="difflineplus">+  var fp = Components.classes[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l2.1544"></a><span id="l2.1544" class="difflineplus">+                     .createInstance(nsIFilePicker);</span>
<a href="#l2.1545"></a><span id="l2.1545"> </span>
<a href="#l2.1546"></a><span id="l2.1546">   var strBundleService = Components.classes[&quot;@mozilla.org/intl/stringbundle;1&quot;].getService();</span>
<a href="#l2.1547"></a><span id="l2.1547">   strBundleService = strBundleService.QueryInterface(Components.interfaces.nsIStringBundleService);</span>
<a href="#l2.1548"></a><span id="l2.1548">   var extbundle = strBundleService.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;);</span>
<a href="#l2.1549"></a><span id="l2.1549">   var filterLabel = extbundle.GetStringFromName(&quot;EMLFiles&quot;);</span>
<a href="#l2.1550"></a><span id="l2.1550">   var windowTitle = extbundle.GetStringFromName(&quot;OpenEMLFiles&quot;);</span>
<a href="#l2.1551"></a><span id="l2.1551"> </span>
<a href="#l2.1552"></a><span id="l2.1552">   fp.init(window, windowTitle, nsIFilePicker.modeOpen);</span>
<a href="#l2.1553"></a><span id="l2.1553">   fp.appendFilter(filterLabel, &quot;*.eml&quot;);</span>
<a href="#l2.1554"></a><span id="l2.1554"> </span>
<a href="#l2.1555"></a><span id="l2.1555" class="difflineminus">-  // Default or last filter is &quot;All Files&quot;</span>
<a href="#l2.1556"></a><span id="l2.1556" class="difflineplus">+  // Default or last filter is &quot;All Files&quot;.</span>
<a href="#l2.1557"></a><span id="l2.1557">   fp.appendFilters(nsIFilePicker.filterAll);</span>
<a href="#l2.1558"></a><span id="l2.1558"> </span>
<a href="#l2.1559"></a><span id="l2.1559" class="difflineminus">- try {</span>
<a href="#l2.1560"></a><span id="l2.1560" class="difflineplus">+  try {</span>
<a href="#l2.1561"></a><span id="l2.1561">     var ret = fp.show();</span>
<a href="#l2.1562"></a><span id="l2.1562">     if (ret == nsIFilePicker.returnCancel)</span>
<a href="#l2.1563"></a><span id="l2.1563">       return;</span>
<a href="#l2.1564"></a><span id="l2.1564">   }</span>
<a href="#l2.1565"></a><span id="l2.1565">   catch (ex) {</span>
<a href="#l2.1566"></a><span id="l2.1566">     dump(&quot;filePicker.chooseInputFile threw an exception\n&quot;);</span>
<a href="#l2.1567"></a><span id="l2.1567">     return;</span>
<a href="#l2.1568"></a><span id="l2.1568">   }</span>
<a href="#l2.1569"></a><span id="l2.1569"> </span>
<a href="#l2.1570"></a><span id="l2.1570">   var uri = fp.fileURL.QueryInterface(Components.interfaces.nsIURL);</span>
<a href="#l2.1571"></a><span id="l2.1571">   uri.query = &quot;type=application/x-message-display&quot;;</span>
<a href="#l2.1572"></a><span id="l2.1572"> </span>
<a href="#l2.1573"></a><span id="l2.1573" class="difflineminus">- window.openDialog( &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, uri, null, null );</span>
<a href="#l2.1574"></a><span id="l2.1574" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1575"></a><span id="l2.1575" class="difflineplus">+                    &quot;all,chrome,dialog=no,status,toolbar&quot;, uri, null, null);</span>
<a href="#l2.1576"></a><span id="l2.1576"> }</span>
<a href="#l2.1577"></a><span id="l2.1577"> </span>
<a href="#l2.1578"></a><span id="l2.1578"> function MsgOpenNewWindowForMessage(messageUri, folderUri)</span>
<a href="#l2.1579"></a><span id="l2.1579"> {</span>
<a href="#l2.1580"></a><span id="l2.1580" class="difflineminus">-    if (!messageUri)</span>
<a href="#l2.1581"></a><span id="l2.1581" class="difflineminus">-        // use GetFirstSelectedMessage() to find out which message to open</span>
<a href="#l2.1582"></a><span id="l2.1582" class="difflineminus">-        // instead of gDBView.getURIForViewIndex(currentIndex).  This is</span>
<a href="#l2.1583"></a><span id="l2.1583" class="difflineminus">-        // required because on a right-click, the currentIndex value will be</span>
<a href="#l2.1584"></a><span id="l2.1584" class="difflineminus">-        // different from the actual row that is highlighted.</span>
<a href="#l2.1585"></a><span id="l2.1585" class="difflineminus">-        // GetFirstSelectedMessage() will return the message that is</span>
<a href="#l2.1586"></a><span id="l2.1586" class="difflineminus">-        // highlighted.</span>
<a href="#l2.1587"></a><span id="l2.1587" class="difflineminus">-        messageUri = GetFirstSelectedMessage();</span>
<a href="#l2.1588"></a><span id="l2.1588" class="difflineplus">+  if (!messageUri)</span>
<a href="#l2.1589"></a><span id="l2.1589" class="difflineplus">+    // Use GetFirstSelectedMessage() to find out which message to open</span>
<a href="#l2.1590"></a><span id="l2.1590" class="difflineplus">+    // instead of gDBView.getURIForViewIndex(currentIndex). This is</span>
<a href="#l2.1591"></a><span id="l2.1591" class="difflineplus">+    // required because on a right-click, the currentIndex value will be</span>
<a href="#l2.1592"></a><span id="l2.1592" class="difflineplus">+    // different from the actual row that is highlighted.</span>
<a href="#l2.1593"></a><span id="l2.1593" class="difflineplus">+    // GetFirstSelectedMessage() will return the message that is</span>
<a href="#l2.1594"></a><span id="l2.1594" class="difflineplus">+    // highlighted.</span>
<a href="#l2.1595"></a><span id="l2.1595" class="difflineplus">+    messageUri = GetFirstSelectedMessage();</span>
<a href="#l2.1596"></a><span id="l2.1596"> </span>
<a href="#l2.1597"></a><span id="l2.1597" class="difflineminus">-    if (!folderUri)</span>
<a href="#l2.1598"></a><span id="l2.1598" class="difflineminus">-        // use GetSelectedFolderURI() to find out which message to open</span>
<a href="#l2.1599"></a><span id="l2.1599" class="difflineminus">-        // instead of gDBView.getURIForViewIndex(currentIndex).  This is</span>
<a href="#l2.1600"></a><span id="l2.1600" class="difflineminus">-        // required because on a right-click, the currentIndex value will be</span>
<a href="#l2.1601"></a><span id="l2.1601" class="difflineminus">-        // different from the actual row that is highlighted.</span>
<a href="#l2.1602"></a><span id="l2.1602" class="difflineminus">-        // GetSelectedFolderURI() will return the message that is</span>
<a href="#l2.1603"></a><span id="l2.1603" class="difflineminus">-        // highlighted.</span>
<a href="#l2.1604"></a><span id="l2.1604" class="difflineminus">-        folderUri = GetSelectedFolderURI();</span>
<a href="#l2.1605"></a><span id="l2.1605" class="difflineplus">+  if (!folderUri)</span>
<a href="#l2.1606"></a><span id="l2.1606" class="difflineplus">+    // Use GetSelectedFolderURI() to find out which message to open</span>
<a href="#l2.1607"></a><span id="l2.1607" class="difflineplus">+    // instead of gDBView.getURIForViewIndex(currentIndex). This is</span>
<a href="#l2.1608"></a><span id="l2.1608" class="difflineplus">+    // required because on a right-click, the currentIndex value will be</span>
<a href="#l2.1609"></a><span id="l2.1609" class="difflineplus">+    // different from the actual row that is highlighted.</span>
<a href="#l2.1610"></a><span id="l2.1610" class="difflineplus">+    // GetSelectedFolderURI() will return the message that is</span>
<a href="#l2.1611"></a><span id="l2.1611" class="difflineplus">+    // highlighted.</span>
<a href="#l2.1612"></a><span id="l2.1612" class="difflineplus">+    folderUri = GetSelectedFolderURI();</span>
<a href="#l2.1613"></a><span id="l2.1613"> </span>
<a href="#l2.1614"></a><span id="l2.1614" class="difflineminus">-    // be sure to pass in the current view....</span>
<a href="#l2.1615"></a><span id="l2.1615" class="difflineminus">-    if (messageUri &amp;&amp; folderUri) {</span>
<a href="#l2.1616"></a><span id="l2.1616" class="difflineminus">-        window.openDialog( &quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, messageUri, folderUri, gDBView );</span>
<a href="#l2.1617"></a><span id="l2.1617" class="difflineminus">-    }</span>
<a href="#l2.1618"></a><span id="l2.1618" class="difflineplus">+  // be sure to pass in the current view....</span>
<a href="#l2.1619"></a><span id="l2.1619" class="difflineplus">+  if (messageUri &amp;&amp; folderUri) {</span>
<a href="#l2.1620"></a><span id="l2.1620" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/messageWindow.xul&quot;, &quot;_blank&quot;,</span>
<a href="#l2.1621"></a><span id="l2.1621" class="difflineplus">+                      &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l2.1622"></a><span id="l2.1622" class="difflineplus">+                      messageUri, folderUri, gDBView);</span>
<a href="#l2.1623"></a><span id="l2.1623" class="difflineplus">+  }</span>
<a href="#l2.1624"></a><span id="l2.1624"> }</span>
<a href="#l2.1625"></a><span id="l2.1625"> </span>
<a href="#l2.1626"></a><span id="l2.1626"> function MsgJunk()</span>
<a href="#l2.1627"></a><span id="l2.1627"> {</span>
<a href="#l2.1628"></a><span id="l2.1628">   MsgJunkMailInfo(true);</span>
<a href="#l2.1629"></a><span id="l2.1629">   JunkSelectedMessages(!SelectedMessagesAreJunk());</span>
<a href="#l2.1630"></a><span id="l2.1630"> }</span>
<a href="#l2.1631"></a><span id="l2.1631"> </span>
<a href="#l2.1632"></a><span id="l2.1632"> </span>
<a href="#l2.1633"></a><span id="l2.1633"> function UpdateJunkButton()</span>
<a href="#l2.1634"></a><span id="l2.1634"> {</span>
<a href="#l2.1635"></a><span id="l2.1635">   var hdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.1636"></a><span id="l2.1636" class="difflineplus">+</span>
<a href="#l2.1637"></a><span id="l2.1637">   var junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l2.1638"></a><span id="l2.1638" class="difflineminus">-  var isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l2.1639"></a><span id="l2.1639" class="difflineplus">+  var isJunk = (junkScore == &quot;&quot;) || (junkScore == &quot;0&quot;);</span>
<a href="#l2.1640"></a><span id="l2.1640">   if (isNewsURI(hdr.folder.URI))</span>
<a href="#l2.1641"></a><span id="l2.1641">     isJunk = true;</span>
<a href="#l2.1642"></a><span id="l2.1642">   document.getElementById('junkButton').disabled = isJunk;</span>
<a href="#l2.1643"></a><span id="l2.1643"> }</span>
<a href="#l2.1644"></a><span id="l2.1644"> </span>
<a href="#l2.1645"></a><span id="l2.1645" class="difflineminus">-function MsgMarkMsgAsRead(markRead)</span>
<a href="#l2.1646"></a><span id="l2.1646" class="difflineplus">+function MsgMarkMsgAsRead()</span>
<a href="#l2.1647"></a><span id="l2.1647"> {</span>
<a href="#l2.1648"></a><span id="l2.1648" class="difflineminus">-    if (!markRead) {</span>
<a href="#l2.1649"></a><span id="l2.1649" class="difflineminus">-        markRead = !SelectedMessagesAreRead();</span>
<a href="#l2.1650"></a><span id="l2.1650" class="difflineminus">-    }</span>
<a href="#l2.1651"></a><span id="l2.1651" class="difflineminus">-    MarkSelectedMessagesRead(markRead);</span>
<a href="#l2.1652"></a><span id="l2.1652" class="difflineplus">+  MarkSelectedMessagesRead(!SelectedMessagesAreRead());</span>
<a href="#l2.1653"></a><span id="l2.1653"> }</span>
<a href="#l2.1654"></a><span id="l2.1654"> </span>
<a href="#l2.1655"></a><span id="l2.1655" class="difflineminus">-function MsgMarkAsFlagged(markFlagged)</span>
<a href="#l2.1656"></a><span id="l2.1656" class="difflineplus">+function MsgMarkAsFlagged()</span>
<a href="#l2.1657"></a><span id="l2.1657"> {</span>
<a href="#l2.1658"></a><span id="l2.1658" class="difflineminus">-    if (!markFlagged) {</span>
<a href="#l2.1659"></a><span id="l2.1659" class="difflineminus">-        markFlagged = !SelectedMessagesAreFlagged();</span>
<a href="#l2.1660"></a><span id="l2.1660" class="difflineminus">-    }</span>
<a href="#l2.1661"></a><span id="l2.1661" class="difflineminus">-    MarkSelectedMessagesFlagged(markFlagged);</span>
<a href="#l2.1662"></a><span id="l2.1662" class="difflineplus">+  MarkSelectedMessagesFlagged(!SelectedMessagesAreFlagged());</span>
<a href="#l2.1663"></a><span id="l2.1663"> }</span>
<a href="#l2.1664"></a><span id="l2.1664"> </span>
<a href="#l2.1665"></a><span id="l2.1665"> function MsgMarkReadByDate()</span>
<a href="#l2.1666"></a><span id="l2.1666"> {</span>
<a href="#l2.1667"></a><span id="l2.1667" class="difflineminus">-  window.openDialog( &quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l2.1668"></a><span id="l2.1668" class="difflineminus">-                     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l2.1669"></a><span id="l2.1669" class="difflineminus">-                     GetLoadedMsgFolder() );</span>
<a href="#l2.1670"></a><span id="l2.1670" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/markByDate.xul&quot;,&quot;&quot;,</span>
<a href="#l2.1671"></a><span id="l2.1671" class="difflineplus">+                    &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l2.1672"></a><span id="l2.1672" class="difflineplus">+                    GetLoadedMsgFolder());</span>
<a href="#l2.1673"></a><span id="l2.1673"> }</span>
<a href="#l2.1674"></a><span id="l2.1674"> </span>
<a href="#l2.1675"></a><span id="l2.1675"> function MsgMarkAllRead()</span>
<a href="#l2.1676"></a><span id="l2.1676"> {</span>
<a href="#l2.1677"></a><span id="l2.1677" class="difflineminus">-    var folder = GetMsgFolderFromUri(GetSelectedFolderURI(), true);</span>
<a href="#l2.1678"></a><span id="l2.1678" class="difflineplus">+  var folder = GetMsgFolderFromUri(GetSelectedFolderURI(), true);</span>
<a href="#l2.1679"></a><span id="l2.1679"> </span>
<a href="#l2.1680"></a><span id="l2.1680" class="difflineminus">-    if (folder)</span>
<a href="#l2.1681"></a><span id="l2.1681" class="difflineminus">-      folder.markAllMessagesRead();</span>
<a href="#l2.1682"></a><span id="l2.1682" class="difflineplus">+  if (folder)</span>
<a href="#l2.1683"></a><span id="l2.1683" class="difflineplus">+    folder.markAllMessagesRead();</span>
<a href="#l2.1684"></a><span id="l2.1684"> }</span>
<a href="#l2.1685"></a><span id="l2.1685"> </span>
<a href="#l2.1686"></a><span id="l2.1686"> function MsgFilters(emailAddress, folder)</span>
<a href="#l2.1687"></a><span id="l2.1687"> {</span>
<a href="#l2.1688"></a><span id="l2.1688" class="difflineminus">-    if (!folder)</span>
<a href="#l2.1689"></a><span id="l2.1689" class="difflineplus">+  if (!folder)</span>
<a href="#l2.1690"></a><span id="l2.1690" class="difflineplus">+  {</span>
<a href="#l2.1691"></a><span id="l2.1691" class="difflineplus">+    // Try to determine the folder from the selected message.</span>
<a href="#l2.1692"></a><span id="l2.1692" class="difflineplus">+    if (gDBView)</span>
<a href="#l2.1693"></a><span id="l2.1693">     {</span>
<a href="#l2.1694"></a><span id="l2.1694" class="difflineminus">-      // try to determine the folder from the selected message. </span>
<a href="#l2.1695"></a><span id="l2.1695" class="difflineminus">-      if (gDBView)</span>
<a href="#l2.1696"></a><span id="l2.1696" class="difflineplus">+      try</span>
<a href="#l2.1697"></a><span id="l2.1697">       {</span>
<a href="#l2.1698"></a><span id="l2.1698" class="difflineminus">-        try</span>
<a href="#l2.1699"></a><span id="l2.1699" class="difflineplus">+        var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.1700"></a><span id="l2.1700" class="difflineplus">+        var accountKey = msgHdr.accountKey;</span>
<a href="#l2.1701"></a><span id="l2.1701" class="difflineplus">+        if (accountKey.length &gt; 0)</span>
<a href="#l2.1702"></a><span id="l2.1702">         {</span>
<a href="#l2.1703"></a><span id="l2.1703" class="difflineminus">-          var msgHdr = gDBView.hdrForFirstSelectedMessage;</span>
<a href="#l2.1704"></a><span id="l2.1704" class="difflineminus">-          var accountKey = msgHdr.accountKey;</span>
<a href="#l2.1705"></a><span id="l2.1705" class="difflineminus">-          if (accountKey.length &gt; 0)</span>
<a href="#l2.1706"></a><span id="l2.1706" class="difflineplus">+          var account = accountManager.getAccount(accountKey);</span>
<a href="#l2.1707"></a><span id="l2.1707" class="difflineplus">+          if (account)</span>
<a href="#l2.1708"></a><span id="l2.1708">           {</span>
<a href="#l2.1709"></a><span id="l2.1709" class="difflineminus">-            var account = accountManager.getAccount(accountKey);</span>
<a href="#l2.1710"></a><span id="l2.1710" class="difflineminus">-            if (account)</span>
<a href="#l2.1711"></a><span id="l2.1711" class="difflineminus">-            {</span>
<a href="#l2.1712"></a><span id="l2.1712" class="difflineminus">-              var server = account.incomingServer;</span>
<a href="#l2.1713"></a><span id="l2.1713" class="difflineminus">-              if (server)</span>
<a href="#l2.1714"></a><span id="l2.1714" class="difflineminus">-                folder = server.rootFolder;</span>
<a href="#l2.1715"></a><span id="l2.1715" class="difflineminus">-            }</span>
<a href="#l2.1716"></a><span id="l2.1716" class="difflineplus">+            var server = account.incomingServer;</span>
<a href="#l2.1717"></a><span id="l2.1717" class="difflineplus">+            if (server)</span>
<a href="#l2.1718"></a><span id="l2.1718" class="difflineplus">+              folder = server.rootFolder;</span>
<a href="#l2.1719"></a><span id="l2.1719">           }</span>
<a href="#l2.1720"></a><span id="l2.1720">         }</span>
<a href="#l2.1721"></a><span id="l2.1721" class="difflineminus">-        catch (ex) {}</span>
<a href="#l2.1722"></a><span id="l2.1722">       }</span>
<a href="#l2.1723"></a><span id="l2.1723" class="difflineminus">-      if (!folder)</span>
<a href="#l2.1724"></a><span id="l2.1724" class="difflineminus">-      {</span>
<a href="#l2.1725"></a><span id="l2.1725" class="difflineminus">-        folder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1726"></a><span id="l2.1726" class="difflineminus">-        // if this is the local folders account, check if the default account</span>
<a href="#l2.1727"></a><span id="l2.1727" class="difflineminus">-        // defers to it; if so, we'll use the default account so the simple case</span>
<a href="#l2.1728"></a><span id="l2.1728" class="difflineminus">-        // of one pop3 account with the global inbox creates filters for the right server.</span>
<a href="#l2.1729"></a><span id="l2.1729" class="difflineminus">-        if (folder &amp;&amp; folder.server.type == &quot;none&quot; &amp;&amp; folder.server.isDeferredTo)</span>
<a href="#l2.1730"></a><span id="l2.1730" class="difflineminus">-        {</span>
<a href="#l2.1731"></a><span id="l2.1731" class="difflineminus">-          var defaultServer = accountManager.defaultAccount.incomingServer;</span>
<a href="#l2.1732"></a><span id="l2.1732" class="difflineminus">-          if (defaultServer.rootMsgFolder == folder.server.rootFolder)</span>
<a href="#l2.1733"></a><span id="l2.1733" class="difflineminus">-            folder = defaultServer.rootFolder;</span>
<a href="#l2.1734"></a><span id="l2.1734" class="difflineminus">-        }</span>
<a href="#l2.1735"></a><span id="l2.1735" class="difflineminus">-      }</span>
<a href="#l2.1736"></a><span id="l2.1736" class="difflineminus">-</span>
<a href="#l2.1737"></a><span id="l2.1737" class="difflineplus">+      catch (ex) {}</span>
<a href="#l2.1738"></a><span id="l2.1738">     }</span>
<a href="#l2.1739"></a><span id="l2.1739" class="difflineminus">-    var args;</span>
<a href="#l2.1740"></a><span id="l2.1740" class="difflineminus">-    if (emailAddress)</span>
<a href="#l2.1741"></a><span id="l2.1741" class="difflineplus">+    if (!folder)</span>
<a href="#l2.1742"></a><span id="l2.1742">     {</span>
<a href="#l2.1743"></a><span id="l2.1743" class="difflineminus">-      /* we have to do prefill filter so we are going to </span>
<a href="#l2.1744"></a><span id="l2.1744" class="difflineminus">-         launch the filterEditor dialog</span>
<a href="#l2.1745"></a><span id="l2.1745" class="difflineminus">-         and prefill that with the emailAddress */</span>
<a href="#l2.1746"></a><span id="l2.1746" class="difflineminus">-         </span>
<a href="#l2.1747"></a><span id="l2.1747" class="difflineminus">-      var curFilterList = folder.getFilterList(msgWindow);</span>
<a href="#l2.1748"></a><span id="l2.1748" class="difflineminus">-      args = {filterList: curFilterList};</span>
<a href="#l2.1749"></a><span id="l2.1749" class="difflineminus">-      args.filterName = emailAddress;</span>
<a href="#l2.1750"></a><span id="l2.1750" class="difflineminus">-      window.openDialog(&quot;chrome://messenger/content/FilterEditor.xul&quot;, &quot;&quot;, </span>
<a href="#l2.1751"></a><span id="l2.1751" class="difflineminus">-                        &quot;chrome, modal, resizable,centerscreen,dialog=yes&quot;, args);</span>
<a href="#l2.1752"></a><span id="l2.1752" class="difflineminus">-</span>
<a href="#l2.1753"></a><span id="l2.1753" class="difflineminus">-      /* if the user hits ok in the filterEditor dialog we set </span>
<a href="#l2.1754"></a><span id="l2.1754" class="difflineminus">-         args.refresh=true there</span>
<a href="#l2.1755"></a><span id="l2.1755" class="difflineminus">-         we check this here in args to show filterList dialog */</span>
<a href="#l2.1756"></a><span id="l2.1756" class="difflineminus">-      if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l2.1757"></a><span id="l2.1757" class="difflineplus">+      folder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1758"></a><span id="l2.1758" class="difflineplus">+      // If this is the local folders account, check if the default account</span>
<a href="#l2.1759"></a><span id="l2.1759" class="difflineplus">+      // defers to it; if so, we'll use the default account so the simple case</span>
<a href="#l2.1760"></a><span id="l2.1760" class="difflineplus">+      // of one pop3 account with the global inbox creates filters for the right server.</span>
<a href="#l2.1761"></a><span id="l2.1761" class="difflineplus">+      if (folder &amp;&amp; folder.server.type == &quot;none&quot; &amp;&amp; folder.server.isDeferredTo)</span>
<a href="#l2.1762"></a><span id="l2.1762">       {</span>
<a href="#l2.1763"></a><span id="l2.1763" class="difflineminus">-         args = { refresh: true, folder: folder };</span>
<a href="#l2.1764"></a><span id="l2.1764" class="difflineminus">-         MsgFilterList(args);</span>
<a href="#l2.1765"></a><span id="l2.1765" class="difflineplus">+        var defaultServer = accountManager.defaultAccount.incomingServer;</span>
<a href="#l2.1766"></a><span id="l2.1766" class="difflineplus">+        if (defaultServer.rootMsgFolder == folder.server.rootFolder)</span>
<a href="#l2.1767"></a><span id="l2.1767" class="difflineplus">+          folder = defaultServer.rootFolder;</span>
<a href="#l2.1768"></a><span id="l2.1768">       }</span>
<a href="#l2.1769"></a><span id="l2.1769">     }</span>
<a href="#l2.1770"></a><span id="l2.1770" class="difflineminus">-    else  // just launch filterList dialog</span>
<a href="#l2.1771"></a><span id="l2.1771" class="difflineplus">+  }</span>
<a href="#l2.1772"></a><span id="l2.1772" class="difflineplus">+  var args;</span>
<a href="#l2.1773"></a><span id="l2.1773" class="difflineplus">+  if (emailAddress)</span>
<a href="#l2.1774"></a><span id="l2.1774" class="difflineplus">+  {</span>
<a href="#l2.1775"></a><span id="l2.1775" class="difflineplus">+    // We have to do prefill filter so we are going to launch the</span>
<a href="#l2.1776"></a><span id="l2.1776" class="difflineplus">+    // filterEditor dialog and prefill that with the emailAddress.</span>
<a href="#l2.1777"></a><span id="l2.1777" class="difflineplus">+    args = { filterList: folder.getFilterList(msgWindow) };</span>
<a href="#l2.1778"></a><span id="l2.1778" class="difflineplus">+    args.filterName = emailAddress;</span>
<a href="#l2.1779"></a><span id="l2.1779" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/FilterEditor.xul&quot;, &quot;&quot;,</span>
<a href="#l2.1780"></a><span id="l2.1780" class="difflineplus">+                      &quot;chrome, modal, resizable,centerscreen,dialog=yes&quot;, args);</span>
<a href="#l2.1781"></a><span id="l2.1781" class="difflineplus">+</span>
<a href="#l2.1782"></a><span id="l2.1782" class="difflineplus">+    // If the user hits ok in the filterEditor dialog we set args.refresh=true</span>
<a href="#l2.1783"></a><span id="l2.1783" class="difflineplus">+    // there we check this here in args to show filterList dialog.</span>
<a href="#l2.1784"></a><span id="l2.1784" class="difflineplus">+    if (&quot;refresh&quot; in args &amp;&amp; args.refresh)</span>
<a href="#l2.1785"></a><span id="l2.1785">     {</span>
<a href="#l2.1786"></a><span id="l2.1786" class="difflineminus">-      args = { refresh: false, folder: folder };</span>
<a href="#l2.1787"></a><span id="l2.1787" class="difflineplus">+      args = { refresh: true, folder: folder };</span>
<a href="#l2.1788"></a><span id="l2.1788">       MsgFilterList(args);</span>
<a href="#l2.1789"></a><span id="l2.1789">     }</span>
<a href="#l2.1790"></a><span id="l2.1790" class="difflineplus">+  }</span>
<a href="#l2.1791"></a><span id="l2.1791" class="difflineplus">+  else  // just launch filterList dialog</span>
<a href="#l2.1792"></a><span id="l2.1792" class="difflineplus">+  {</span>
<a href="#l2.1793"></a><span id="l2.1793" class="difflineplus">+    args = { refresh: false, folder: folder };</span>
<a href="#l2.1794"></a><span id="l2.1794" class="difflineplus">+    MsgFilterList(args);</span>
<a href="#l2.1795"></a><span id="l2.1795" class="difflineplus">+  }</span>
<a href="#l2.1796"></a><span id="l2.1796"> }</span>
<a href="#l2.1797"></a><span id="l2.1797"> </span>
<a href="#l2.1798"></a><span id="l2.1798"> function MsgApplyFilters()</span>
<a href="#l2.1799"></a><span id="l2.1799"> {</span>
<a href="#l2.1800"></a><span id="l2.1800" class="difflineminus">-  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;].getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l2.1801"></a><span id="l2.1801" class="difflineplus">+  var filterService = Components.classes[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l2.1802"></a><span id="l2.1802" class="difflineplus">+                                .getService(Components.interfaces.nsIMsgFilterService);</span>
<a href="#l2.1803"></a><span id="l2.1803"> </span>
<a href="#l2.1804"></a><span id="l2.1804">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.1805"></a><span id="l2.1805" class="difflineminus">-  var selectedFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.1806"></a><span id="l2.1806" class="difflineplus">+  var selectedFolders = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l2.1807"></a><span id="l2.1807" class="difflineplus">+                                  .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.1808"></a><span id="l2.1808">   selectedFolders.AppendElement(preselectedFolder);</span>
<a href="#l2.1809"></a><span id="l2.1809" class="difflineminus">-         </span>
<a href="#l2.1810"></a><span id="l2.1810" class="difflineplus">+</span>
<a href="#l2.1811"></a><span id="l2.1811">   var curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l2.1812"></a><span id="l2.1812">   // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l2.1813"></a><span id="l2.1813">   // We do this instead of having the filter after the fact code ignore</span>
<a href="#l2.1814"></a><span id="l2.1814">   // disabled filters because the Filter Dialog filter after the fact</span>
<a href="#l2.1815"></a><span id="l2.1815">   // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l2.1816"></a><span id="l2.1816">   // and we don't support cloning filters currently.</span>
<a href="#l2.1817"></a><span id="l2.1817">   var tempFilterList = filterService.getTempFilterList(preselectedFolder);</span>
<a href="#l2.1818"></a><span id="l2.1818">   var numFilters = curFilterList.filterCount;</span>
<a href="#l2.1819"></a><span id="l2.1819" class="difflineat">@@ -1896,209 +1809,171 @@ function MsgApplyFiltersToSelection()</span>
<a href="#l2.1820"></a><span id="l2.1820"> </span>
<a href="#l2.1821"></a><span id="l2.1821"> function ChangeMailLayout(newLayout)</span>
<a href="#l2.1822"></a><span id="l2.1822"> {</span>
<a href="#l2.1823"></a><span id="l2.1823">   gPrefBranch.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span>
<a href="#l2.1824"></a><span id="l2.1824"> }</span>
<a href="#l2.1825"></a><span id="l2.1825"> </span>
<a href="#l2.1826"></a><span id="l2.1826"> function MsgViewAllHeaders()</span>
<a href="#l2.1827"></a><span id="l2.1827"> {</span>
<a href="#l2.1828"></a><span id="l2.1828" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.show_headers&quot;,2);</span>
<a href="#l2.1829"></a><span id="l2.1829" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1830"></a><span id="l2.1830" class="difflineminus">-    return true;</span>
<a href="#l2.1831"></a><span id="l2.1831" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, 2);</span>
<a href="#l2.1832"></a><span id="l2.1832" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1833"></a><span id="l2.1833"> }</span>
<a href="#l2.1834"></a><span id="l2.1834"> </span>
<a href="#l2.1835"></a><span id="l2.1835"> function MsgViewNormalHeaders()</span>
<a href="#l2.1836"></a><span id="l2.1836"> {</span>
<a href="#l2.1837"></a><span id="l2.1837" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.show_headers&quot;,1);</span>
<a href="#l2.1838"></a><span id="l2.1838" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1839"></a><span id="l2.1839" class="difflineminus">-    return true;</span>
<a href="#l2.1840"></a><span id="l2.1840" class="difflineminus">-}</span>
<a href="#l2.1841"></a><span id="l2.1841" class="difflineminus">-</span>
<a href="#l2.1842"></a><span id="l2.1842" class="difflineminus">-function MsgViewBriefHeaders()</span>
<a href="#l2.1843"></a><span id="l2.1843" class="difflineminus">-{</span>
<a href="#l2.1844"></a><span id="l2.1844" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mail.show_headers&quot;,0);</span>
<a href="#l2.1845"></a><span id="l2.1845" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1846"></a><span id="l2.1846" class="difflineminus">-    return true;</span>
<a href="#l2.1847"></a><span id="l2.1847" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mail.show_headers&quot;, 1);</span>
<a href="#l2.1848"></a><span id="l2.1848" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1849"></a><span id="l2.1849"> }</span>
<a href="#l2.1850"></a><span id="l2.1850"> </span>
<a href="#l2.1851"></a><span id="l2.1851"> function MsgBodyAllowHTML()</span>
<a href="#l2.1852"></a><span id="l2.1852"> {</span>
<a href="#l2.1853"></a><span id="l2.1853" class="difflineminus">-    gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l2.1854"></a><span id="l2.1854" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l2.1855"></a><span id="l2.1855" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l2.1856"></a><span id="l2.1856" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1857"></a><span id="l2.1857" class="difflineminus">-    return true;</span>
<a href="#l2.1858"></a><span id="l2.1858" class="difflineplus">+  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l2.1859"></a><span id="l2.1859" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 0);</span>
<a href="#l2.1860"></a><span id="l2.1860" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, 0);</span>
<a href="#l2.1861"></a><span id="l2.1861" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1862"></a><span id="l2.1862"> }</span>
<a href="#l2.1863"></a><span id="l2.1863"> </span>
<a href="#l2.1864"></a><span id="l2.1864"> function MsgBodySanitized()</span>
<a href="#l2.1865"></a><span id="l2.1865"> {</span>
<a href="#l2.1866"></a><span id="l2.1866" class="difflineminus">-    gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l2.1867"></a><span id="l2.1867" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l2.1868"></a><span id="l2.1868" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l2.1869"></a><span id="l2.1869" class="difflineminus">-                      gDisallow_classes_no_html);</span>
<a href="#l2.1870"></a><span id="l2.1870" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1871"></a><span id="l2.1871" class="difflineminus">-    return true;</span>
<a href="#l2.1872"></a><span id="l2.1872" class="difflineplus">+  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, false);</span>
<a href="#l2.1873"></a><span id="l2.1873" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l2.1874"></a><span id="l2.1874" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l2.1875"></a><span id="l2.1875" class="difflineplus">+                         gDisallow_classes_no_html);</span>
<a href="#l2.1876"></a><span id="l2.1876" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1877"></a><span id="l2.1877"> }</span>
<a href="#l2.1878"></a><span id="l2.1878"> </span>
<a href="#l2.1879"></a><span id="l2.1879"> function MsgBodyAsPlaintext()</span>
<a href="#l2.1880"></a><span id="l2.1880"> {</span>
<a href="#l2.1881"></a><span id="l2.1881" class="difflineminus">-    gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l2.1882"></a><span id="l2.1882" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l2.1883"></a><span id="l2.1883" class="difflineminus">-    gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;, gDisallow_classes_no_html);</span>
<a href="#l2.1884"></a><span id="l2.1884" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1885"></a><span id="l2.1885" class="difflineminus">-    return true;</span>
<a href="#l2.1886"></a><span id="l2.1886" class="difflineplus">+  gPrefBranch.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l2.1887"></a><span id="l2.1887" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l2.1888"></a><span id="l2.1888" class="difflineplus">+  gPrefBranch.setIntPref(&quot;mailnews.display.disallow_mime_handlers&quot;,</span>
<a href="#l2.1889"></a><span id="l2.1889" class="difflineplus">+                         gDisallow_classes_no_html);</span>
<a href="#l2.1890"></a><span id="l2.1890" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1891"></a><span id="l2.1891"> }</span>
<a href="#l2.1892"></a><span id="l2.1892"> </span>
<a href="#l2.1893"></a><span id="l2.1893"> function ToggleInlineAttachment(target)</span>
<a href="#l2.1894"></a><span id="l2.1894"> {</span>
<a href="#l2.1895"></a><span id="l2.1895" class="difflineminus">-    var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l2.1896"></a><span id="l2.1896" class="difflineminus">-    pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l2.1897"></a><span id="l2.1897" class="difflineminus">-    target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l2.1898"></a><span id="l2.1898" class="difflineminus">-    ReloadMessage();</span>
<a href="#l2.1899"></a><span id="l2.1899" class="difflineplus">+  var viewAttachmentInline = !pref.getBoolPref(&quot;mail.inline_attachments&quot;);</span>
<a href="#l2.1900"></a><span id="l2.1900" class="difflineplus">+  pref.setBoolPref(&quot;mail.inline_attachments&quot;, viewAttachmentInline)</span>
<a href="#l2.1901"></a><span id="l2.1901" class="difflineplus">+  target.setAttribute(&quot;checked&quot;, viewAttachmentInline ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l2.1902"></a><span id="l2.1902" class="difflineplus">+  ReloadMessage();</span>
<a href="#l2.1903"></a><span id="l2.1903"> }</span>
<a href="#l2.1904"></a><span id="l2.1904"> </span>
<a href="#l2.1905"></a><span id="l2.1905" class="difflineminus">-function PrintEnginePrintInternal(messageList, numMessages, doPrintPreview, msgType)</span>
<a href="#l2.1906"></a><span id="l2.1906" class="difflineplus">+function PrintEnginePrintInternal(doPrintPreview, msgType)</span>
<a href="#l2.1907"></a><span id="l2.1907"> {</span>
<a href="#l2.1908"></a><span id="l2.1908" class="difflineminus">-    if (numMessages == 0) {</span>
<a href="#l2.1909"></a><span id="l2.1909" class="difflineminus">-        dump(&quot;PrintEnginePrint(): No messages selected.\n&quot;);</span>
<a href="#l2.1910"></a><span id="l2.1910" class="difflineminus">-        return false;</span>
<a href="#l2.1911"></a><span id="l2.1911" class="difflineminus">-    }</span>
<a href="#l2.1912"></a><span id="l2.1912" class="difflineplus">+  var messageList = GetSelectedMessages();</span>
<a href="#l2.1913"></a><span id="l2.1913" class="difflineplus">+  if (messageList.length == 0) {</span>
<a href="#l2.1914"></a><span id="l2.1914" class="difflineplus">+    dump(&quot;PrintEnginePrintInternal(): No messages selected.\n&quot;);</span>
<a href="#l2.1915"></a><span id="l2.1915" class="difflineplus">+    return;</span>
<a href="#l2.1916"></a><span id="l2.1916" class="difflineplus">+  }</span>
<a href="#l2.1917"></a><span id="l2.1917"> </span>
<a href="#l2.1918"></a><span id="l2.1918" class="difflineminus">-    printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;,</span>
<a href="#l2.1919"></a><span id="l2.1919" class="difflineminus">-                                          &quot;&quot;,</span>
<a href="#l2.1920"></a><span id="l2.1920" class="difflineminus">-                                          &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l2.1921"></a><span id="l2.1921" class="difflineminus">-                                          numMessages, messageList, statusFeedback, doPrintPreview, msgType, window);</span>
<a href="#l2.1922"></a><span id="l2.1922" class="difflineminus">-    return true;</span>
<a href="#l2.1923"></a><span id="l2.1923" class="difflineminus">-</span>
<a href="#l2.1924"></a><span id="l2.1924" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;,</span>
<a href="#l2.1925"></a><span id="l2.1925" class="difflineplus">+                    &quot;chrome,dialog=no,all,centerscreen&quot;,</span>
<a href="#l2.1926"></a><span id="l2.1926" class="difflineplus">+                    messageList.length, messageList, statusFeedback,</span>
<a href="#l2.1927"></a><span id="l2.1927" class="difflineplus">+                    doPrintPreview, msgType, window);</span>
<a href="#l2.1928"></a><span id="l2.1928"> }</span>
<a href="#l2.1929"></a><span id="l2.1929"> </span>
<a href="#l2.1930"></a><span id="l2.1930"> function PrintEnginePrint()</span>
<a href="#l2.1931"></a><span id="l2.1931"> {</span>
<a href="#l2.1932"></a><span id="l2.1932" class="difflineminus">-    var messageList = GetSelectedMessages();</span>
<a href="#l2.1933"></a><span id="l2.1933" class="difflineminus">-    return PrintEnginePrintInternal(messageList, messageList.length, false, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINT_MSG);</span>
<a href="#l2.1934"></a><span id="l2.1934" class="difflineplus">+  return PrintEnginePrintInternal(false,</span>
<a href="#l2.1935"></a><span id="l2.1935" class="difflineplus">+    Components.interfaces.nsIMsgPrintEngine.MNAB_PRINT_MSG);</span>
<a href="#l2.1936"></a><span id="l2.1936"> }</span>
<a href="#l2.1937"></a><span id="l2.1937"> </span>
<a href="#l2.1938"></a><span id="l2.1938"> function PrintEnginePrintPreview()</span>
<a href="#l2.1939"></a><span id="l2.1939"> {</span>
<a href="#l2.1940"></a><span id="l2.1940" class="difflineminus">-    var messageList = GetSelectedMessages();</span>
<a href="#l2.1941"></a><span id="l2.1941" class="difflineminus">-    return PrintEnginePrintInternal(messageList, 1, true, Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_MSG);</span>
<a href="#l2.1942"></a><span id="l2.1942" class="difflineplus">+  return PrintEnginePrintInternal(true,</span>
<a href="#l2.1943"></a><span id="l2.1943" class="difflineplus">+    Components.interfaces.nsIMsgPrintEngine.MNAB_PRINTPREVIEW_MSG);</span>
<a href="#l2.1944"></a><span id="l2.1944"> }</span>
<a href="#l2.1945"></a><span id="l2.1945"> </span>
<a href="#l2.1946"></a><span id="l2.1946"> function IsMailFolderSelected()</span>
<a href="#l2.1947"></a><span id="l2.1947"> {</span>
<a href="#l2.1948"></a><span id="l2.1948" class="difflineminus">-    var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.1949"></a><span id="l2.1949" class="difflineminus">-    var numFolders = selectedFolders.length;</span>
<a href="#l2.1950"></a><span id="l2.1950" class="difflineminus">-    if(numFolders !=1)</span>
<a href="#l2.1951"></a><span id="l2.1951" class="difflineminus">-        return false;</span>
<a href="#l2.1952"></a><span id="l2.1952" class="difflineminus">-</span>
<a href="#l2.1953"></a><span id="l2.1953" class="difflineminus">-    var folder = selectedFolders[0];</span>
<a href="#l2.1954"></a><span id="l2.1954" class="difflineminus">-    if (!folder)</span>
<a href="#l2.1955"></a><span id="l2.1955" class="difflineminus">-        return false;</span>
<a href="#l2.1956"></a><span id="l2.1956" class="difflineminus">-</span>
<a href="#l2.1957"></a><span id="l2.1957" class="difflineminus">-    var server = folder.server;</span>
<a href="#l2.1958"></a><span id="l2.1958" class="difflineminus">-    var serverType = server.type;</span>
<a href="#l2.1959"></a><span id="l2.1959" class="difflineminus">-</span>
<a href="#l2.1960"></a><span id="l2.1960" class="difflineminus">-    if((serverType == &quot;nntp&quot;))</span>
<a href="#l2.1961"></a><span id="l2.1961" class="difflineminus">-        return false;</span>
<a href="#l2.1962"></a><span id="l2.1962" class="difflineminus">-    else return true;</span>
<a href="#l2.1963"></a><span id="l2.1963" class="difflineplus">+  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.1964"></a><span id="l2.1964" class="difflineplus">+  var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l2.1965"></a><span id="l2.1965" class="difflineplus">+  return folder &amp;&amp; folder.server.type != &quot;nntp&quot;;</span>
<a href="#l2.1966"></a><span id="l2.1966"> }</span>
<a href="#l2.1967"></a><span id="l2.1967"> </span>
<a href="#l2.1968"></a><span id="l2.1968"> function IsGetNextNMessagesEnabled()</span>
<a href="#l2.1969"></a><span id="l2.1969"> {</span>
<a href="#l2.1970"></a><span id="l2.1970" class="difflineminus">-    var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.1971"></a><span id="l2.1971" class="difflineminus">-    var numFolders = selectedFolders.length;</span>
<a href="#l2.1972"></a><span id="l2.1972" class="difflineminus">-    if(numFolders !=1)</span>
<a href="#l2.1973"></a><span id="l2.1973" class="difflineminus">-        return false;</span>
<a href="#l2.1974"></a><span id="l2.1974" class="difflineminus">-</span>
<a href="#l2.1975"></a><span id="l2.1975" class="difflineminus">-    var folder = selectedFolders[0];</span>
<a href="#l2.1976"></a><span id="l2.1976" class="difflineminus">-    if (!folder)</span>
<a href="#l2.1977"></a><span id="l2.1977" class="difflineminus">-        return false;</span>
<a href="#l2.1978"></a><span id="l2.1978" class="difflineminus">-</span>
<a href="#l2.1979"></a><span id="l2.1979" class="difflineminus">-    var server = folder.server;</span>
<a href="#l2.1980"></a><span id="l2.1980" class="difflineminus">-    var serverType = server.type;</span>
<a href="#l2.1981"></a><span id="l2.1981" class="difflineplus">+  var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.1982"></a><span id="l2.1982" class="difflineplus">+  var folder = selectedFolders.length ? selectedFolders[0] : null;</span>
<a href="#l2.1983"></a><span id="l2.1983"> </span>
<a href="#l2.1984"></a><span id="l2.1984" class="difflineminus">-    var menuItem = document.getElementById(&quot;menu_getnextnmsg&quot;);</span>
<a href="#l2.1985"></a><span id="l2.1985" class="difflineminus">-    if ((serverType == &quot;nntp&quot;) &amp;&amp; !folder.isServer) {</span>
<a href="#l2.1986"></a><span id="l2.1986" class="difflineminus">-        var newsServer = server.QueryInterface(Components.interfaces.nsINntpIncomingServer);</span>
<a href="#l2.1987"></a><span id="l2.1987" class="difflineminus">-        var menuLabel = gMessengerBundle.getFormattedString(&quot;getNextNMessages&quot;,</span>
<a href="#l2.1988"></a><span id="l2.1988" class="difflineminus">-                                                            [ newsServer.maxArticles ]);</span>
<a href="#l2.1989"></a><span id="l2.1989" class="difflineminus">-        menuItem.setAttribute(&quot;label&quot;,menuLabel);</span>
<a href="#l2.1990"></a><span id="l2.1990" class="difflineminus">-        menuItem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.1991"></a><span id="l2.1991" class="difflineminus">-        return true;</span>
<a href="#l2.1992"></a><span id="l2.1992" class="difflineminus">-    }</span>
<a href="#l2.1993"></a><span id="l2.1993" class="difflineplus">+  var menuItem = document.getElementById(&quot;menu_getnextnmsg&quot;);</span>
<a href="#l2.1994"></a><span id="l2.1994" class="difflineplus">+  if (folder &amp;&amp; (folder.server.type == &quot;nntp&quot;) &amp;&amp; !folder.isServer) {</span>
<a href="#l2.1995"></a><span id="l2.1995" class="difflineplus">+    var newsServer = server.QueryInterface(Components.interfaces.nsINntpIncomingServer);</span>
<a href="#l2.1996"></a><span id="l2.1996" class="difflineplus">+    var menuLabel = gMessengerBundle.getFormattedString(&quot;getNextNMessages&quot;,</span>
<a href="#l2.1997"></a><span id="l2.1997" class="difflineplus">+                                                        [newsServer.maxArticles]);</span>
<a href="#l2.1998"></a><span id="l2.1998" class="difflineplus">+    menuItem.setAttribute(&quot;label&quot;, menuLabel);</span>
<a href="#l2.1999"></a><span id="l2.1999" class="difflineplus">+    menuItem.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l2.2000"></a><span id="l2.2000" class="difflineplus">+    return true;</span>
<a href="#l2.2001"></a><span id="l2.2001" class="difflineplus">+  }</span>
<a href="#l2.2002"></a><span id="l2.2002"> </span>
<a href="#l2.2003"></a><span id="l2.2003" class="difflineminus">-    menuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l2.2004"></a><span id="l2.2004" class="difflineminus">-    return false;</span>
<a href="#l2.2005"></a><span id="l2.2005" class="difflineplus">+  menuItem.setAttribute(&quot;hidden&quot;,&quot;true&quot;);</span>
<a href="#l2.2006"></a><span id="l2.2006" class="difflineplus">+  return false;</span>
<a href="#l2.2007"></a><span id="l2.2007"> }</span>
<a href="#l2.2008"></a><span id="l2.2008"> </span>
<a href="#l2.2009"></a><span id="l2.2009"> function IsCompactFolderEnabled()</span>
<a href="#l2.2010"></a><span id="l2.2010"> {</span>
<a href="#l2.2011"></a><span id="l2.2011">   var server = GetServer(GetSelectedFolderURI());</span>
<a href="#l2.2012"></a><span id="l2.2012">   return (server &amp;&amp;</span>
<a href="#l2.2013"></a><span id="l2.2013">       (server.type != 'nntp') &amp;&amp; // compact news folder is not supported</span>
<a href="#l2.2014"></a><span id="l2.2014">       ((server.type != 'imap') || server.canCompactFoldersOnServer) &amp;&amp;</span>
<a href="#l2.2015"></a><span id="l2.2015" class="difflineminus">-      isCommandEnabled(&quot;cmd_compactFolder&quot;));   // checks e.g. if IMAP is offline</span>
<a href="#l2.2016"></a><span id="l2.2016" class="difflineplus">+      isCommandEnabled(&quot;cmd_compactFolder&quot;)); // checks e.g. if IMAP is offline</span>
<a href="#l2.2017"></a><span id="l2.2017"> }</span>
<a href="#l2.2018"></a><span id="l2.2018"> </span>
<a href="#l2.2019"></a><span id="l2.2019"> function SetUpToolbarButtons(uri)</span>
<a href="#l2.2020"></a><span id="l2.2020"> {</span>
<a href="#l2.2021"></a><span id="l2.2021">   var deleteButton = document.getElementById(&quot;button-delete&quot;);</span>
<a href="#l2.2022"></a><span id="l2.2022"> </span>
<a href="#l2.2023"></a><span id="l2.2023" class="difflineminus">-  // eventually, we might want to set up the toolbar differently for imap,</span>
<a href="#l2.2024"></a><span id="l2.2024" class="difflineminus">-  // pop, and news.  for now, just tweak it based on if it is news or not.</span>
<a href="#l2.2025"></a><span id="l2.2025" class="difflineminus">-  if (isNewsURI(uri)) {</span>
<a href="#l2.2026"></a><span id="l2.2026" class="difflineplus">+  // Eventually, we might want to set up the toolbar differently for imap,</span>
<a href="#l2.2027"></a><span id="l2.2027" class="difflineplus">+  // pop, and news.  For now, just tweak it based on if it is news or not.</span>
<a href="#l2.2028"></a><span id="l2.2028" class="difflineplus">+  if (isNewsURI(uri))</span>
<a href="#l2.2029"></a><span id="l2.2029">     deleteButton.setAttribute('hidden', true);</span>
<a href="#l2.2030"></a><span id="l2.2030" class="difflineminus">-  } else {</span>
<a href="#l2.2031"></a><span id="l2.2031" class="difflineplus">+  else</span>
<a href="#l2.2032"></a><span id="l2.2032">     deleteButton.removeAttribute('hidden');</span>
<a href="#l2.2033"></a><span id="l2.2033" class="difflineminus">-  }</span>
<a href="#l2.2034"></a><span id="l2.2034"> }</span>
<a href="#l2.2035"></a><span id="l2.2035"> </span>
<a href="#l2.2036"></a><span id="l2.2036"> function MsgSynchronizeOffline()</span>
<a href="#l2.2037"></a><span id="l2.2037"> {</span>
<a href="#l2.2038"></a><span id="l2.2038" class="difflineminus">-  window.openDialog(&quot;chrome://messenger/content/msgSynchronize.xul&quot;,</span>
<a href="#l2.2039"></a><span id="l2.2039" class="difflineminus">-        &quot;&quot;, &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,{msgWindow:msgWindow});          </span>
<a href="#l2.2040"></a><span id="l2.2040" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/msgSynchronize.xul&quot;, &quot;&quot;,</span>
<a href="#l2.2041"></a><span id="l2.2041" class="difflineplus">+                    &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l2.2042"></a><span id="l2.2042" class="difflineplus">+                    {msgWindow:msgWindow});</span>
<a href="#l2.2043"></a><span id="l2.2043"> }</span>
<a href="#l2.2044"></a><span id="l2.2044"> </span>
<a href="#l2.2045"></a><span id="l2.2045"> function SpaceHit(event)</span>
<a href="#l2.2046"></a><span id="l2.2046"> {</span>
<a href="#l2.2047"></a><span id="l2.2047">   var contentWindow = window.top._content;</span>
<a href="#l2.2048"></a><span id="l2.2048">   var rssiframe = contentWindow.document.getElementById('_mailrssiframe');</span>
<a href="#l2.2049"></a><span id="l2.2049"> </span>
<a href="#l2.2050"></a><span id="l2.2050">   // if we are displaying an RSS article, we really want to scroll the nested iframe</span>
<a href="#l2.2051"></a><span id="l2.2051">   if (rssiframe)</span>
<a href="#l2.2052"></a><span id="l2.2052">     contentWindow = rssiframe.contentWindow;</span>
<a href="#l2.2053"></a><span id="l2.2053"> </span>
<a href="#l2.2054"></a><span id="l2.2054">   if (event &amp;&amp; event.shiftKey) {</span>
<a href="#l2.2055"></a><span id="l2.2055">     // if at the start of the message, go to the previous one</span>
<a href="#l2.2056"></a><span id="l2.2056" class="difflineminus">-    if (contentWindow.scrollY &gt; 0) {</span>
<a href="#l2.2057"></a><span id="l2.2057" class="difflineplus">+    if (contentWindow.scrollY &gt; 0)</span>
<a href="#l2.2058"></a><span id="l2.2058">       contentWindow.scrollByPages(-1);</span>
<a href="#l2.2059"></a><span id="l2.2059" class="difflineminus">-    }</span>
<a href="#l2.2060"></a><span id="l2.2060" class="difflineminus">-    else {</span>
<a href="#l2.2061"></a><span id="l2.2061" class="difflineplus">+    else</span>
<a href="#l2.2062"></a><span id="l2.2062">       goDoCommand(&quot;cmd_previousUnreadMsg&quot;);</span>
<a href="#l2.2063"></a><span id="l2.2063" class="difflineminus">-    }</span>
<a href="#l2.2064"></a><span id="l2.2064">   }</span>
<a href="#l2.2065"></a><span id="l2.2065">   else {</span>
<a href="#l2.2066"></a><span id="l2.2066">     // if at the end of the message, go to the next one</span>
<a href="#l2.2067"></a><span id="l2.2067" class="difflineminus">-    if (contentWindow.scrollY &lt; contentWindow.scrollMaxY) {</span>
<a href="#l2.2068"></a><span id="l2.2068" class="difflineplus">+    if (contentWindow.scrollY &lt; contentWindow.scrollMaxY)</span>
<a href="#l2.2069"></a><span id="l2.2069">       contentWindow.scrollByPages(1);</span>
<a href="#l2.2070"></a><span id="l2.2070" class="difflineminus">-    }</span>
<a href="#l2.2071"></a><span id="l2.2071" class="difflineminus">-    else {</span>
<a href="#l2.2072"></a><span id="l2.2072" class="difflineplus">+    else</span>
<a href="#l2.2073"></a><span id="l2.2073">       goDoCommand(&quot;cmd_nextUnreadMsg&quot;);</span>
<a href="#l2.2074"></a><span id="l2.2074" class="difflineminus">-    }</span>
<a href="#l2.2075"></a><span id="l2.2075">   }</span>
<a href="#l2.2076"></a><span id="l2.2076"> }</span>
<a href="#l2.2077"></a><span id="l2.2077"> </span>
<a href="#l2.2078"></a><span id="l2.2078"> function IsAccountOfflineEnabled()</span>
<a href="#l2.2079"></a><span id="l2.2079"> {</span>
<a href="#l2.2080"></a><span id="l2.2080">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.2081"></a><span id="l2.2081"> </span>
<a href="#l2.2082"></a><span id="l2.2082">   if (selectedFolders &amp;&amp; (selectedFolders.length == 1))</span>
<a href="#l2.2083"></a><span id="l2.2083">       return selectedFolders[0].supportsOffline;</span>
<a href="#l2.2084"></a><span id="l2.2084" class="difflineminus">-     </span>
<a href="#l2.2085"></a><span id="l2.2085">   return false;</span>
<a href="#l2.2086"></a><span id="l2.2086"> }</span>
<a href="#l2.2087"></a><span id="l2.2087"> </span>
<a href="#l2.2088"></a><span id="l2.2088"> function GetDefaultAccountRootFolder()</span>
<a href="#l2.2089"></a><span id="l2.2089"> {</span>
<a href="#l2.2090"></a><span id="l2.2090">   try {</span>
<a href="#l2.2091"></a><span id="l2.2091">     var account = accountManager.defaultAccount;</span>
<a href="#l2.2092"></a><span id="l2.2092">     var defaultServer = account.incomingServer;</span>
<a href="#l2.2093"></a><span id="l2.2093" class="difflineat">@@ -2109,17 +1984,17 @@ function GetDefaultAccountRootFolder()</span>
<a href="#l2.2094"></a><span id="l2.2094">   }</span>
<a href="#l2.2095"></a><span id="l2.2095">   return null;</span>
<a href="#l2.2096"></a><span id="l2.2096"> }</span>
<a href="#l2.2097"></a><span id="l2.2097"> </span>
<a href="#l2.2098"></a><span id="l2.2098"> function GetFolderMessages()</span>
<a href="#l2.2099"></a><span id="l2.2099"> {</span>
<a href="#l2.2100"></a><span id="l2.2100">   var selectedFolders = GetSelectedMsgFolders();</span>
<a href="#l2.2101"></a><span id="l2.2101">   var defaultAccountRootFolder = GetDefaultAccountRootFolder();</span>
<a href="#l2.2102"></a><span id="l2.2102" class="difflineminus">-  </span>
<a href="#l2.2103"></a><span id="l2.2103" class="difflineplus">+</span>
<a href="#l2.2104"></a><span id="l2.2104">   // if no default account, get msg isn't going do anything anyways</span>
<a href="#l2.2105"></a><span id="l2.2105">   // so bail out</span>
<a href="#l2.2106"></a><span id="l2.2106">   if (!defaultAccountRootFolder)</span>
<a href="#l2.2107"></a><span id="l2.2107">     return;</span>
<a href="#l2.2108"></a><span id="l2.2108"> </span>
<a href="#l2.2109"></a><span id="l2.2109">   // if nothing selected, use the default</span>
<a href="#l2.2110"></a><span id="l2.2110">   var folder = selectedFolders.length ? selectedFolders[0] : defaultAccountRootFolder;</span>
<a href="#l2.2111"></a><span id="l2.2111"> </span>
<a href="#l2.2112"></a><span id="l2.2112" class="difflineat">@@ -2127,259 +2002,246 @@ function GetFolderMessages()</span>
<a href="#l2.2113"></a><span id="l2.2113"> </span>
<a href="#l2.2114"></a><span id="l2.2114">   if (folder.isServer &amp;&amp; (serverType == &quot;nntp&quot;)) {</span>
<a href="#l2.2115"></a><span id="l2.2115">     // if we're doing &quot;get msgs&quot; on a news server</span>
<a href="#l2.2116"></a><span id="l2.2116">     // update unread counts on this server</span>
<a href="#l2.2117"></a><span id="l2.2117">     folder.server.performExpand(msgWindow);</span>
<a href="#l2.2118"></a><span id="l2.2118">     return;</span>
<a href="#l2.2119"></a><span id="l2.2119">   }</span>
<a href="#l2.2120"></a><span id="l2.2120">   else if (serverType == &quot;none&quot;) {</span>
<a href="#l2.2121"></a><span id="l2.2121" class="difflineminus">-    // if &quot;Local Folders&quot; is selected</span>
<a href="#l2.2122"></a><span id="l2.2122" class="difflineminus">-    // and the user does &quot;Get Msgs&quot;</span>
<a href="#l2.2123"></a><span id="l2.2123" class="difflineminus">-    // and LocalFolders is not deferred to,</span>
<a href="#l2.2124"></a><span id="l2.2124" class="difflineminus">-    // get new mail for the default account</span>
<a href="#l2.2125"></a><span id="l2.2125" class="difflineplus">+    // If &quot;Local Folders&quot; is selected and the user does &quot;Get Msgs&quot; and</span>
<a href="#l2.2126"></a><span id="l2.2126" class="difflineplus">+    // LocalFolders is not deferred to, get new mail for the default account</span>
<a href="#l2.2127"></a><span id="l2.2127">     //</span>
<a href="#l2.2128"></a><span id="l2.2128">     // XXX TODO</span>
<a href="#l2.2129"></a><span id="l2.2129" class="difflineminus">-    // should shift click get mail for all (authenticated) accounts?</span>
<a href="#l2.2130"></a><span id="l2.2130" class="difflineminus">-    // see bug #125885</span>
<a href="#l2.2131"></a><span id="l2.2131" class="difflineplus">+    // Should shift click get mail for all (authenticated) accounts?</span>
<a href="#l2.2132"></a><span id="l2.2132" class="difflineplus">+    // see bug #125885.</span>
<a href="#l2.2133"></a><span id="l2.2133">     if (!folder.server.isDeferredTo)</span>
<a href="#l2.2134"></a><span id="l2.2134">       folder = defaultAccountRootFolder;</span>
<a href="#l2.2135"></a><span id="l2.2135">   }</span>
<a href="#l2.2136"></a><span id="l2.2136"> </span>
<a href="#l2.2137"></a><span id="l2.2137">   var folders = new Array(1);</span>
<a href="#l2.2138"></a><span id="l2.2138">   folders[0] = folder;</span>
<a href="#l2.2139"></a><span id="l2.2139"> </span>
<a href="#l2.2140"></a><span id="l2.2140">   GetNewMessages(folders, folder.server);</span>
<a href="#l2.2141"></a><span id="l2.2141"> }</span>
<a href="#l2.2142"></a><span id="l2.2142"> </span>
<a href="#l2.2143"></a><span id="l2.2143"> function SendUnsentMessages()</span>
<a href="#l2.2144"></a><span id="l2.2144"> {</span>
<a href="#l2.2145"></a><span id="l2.2145">   var msgSendlater = Components.classes[&quot;@mozilla.org/messengercompose/sendlater;1&quot;]</span>
<a href="#l2.2146"></a><span id="l2.2146" class="difflineminus">-               .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l2.2147"></a><span id="l2.2147" class="difflineminus">-  var identitiesCount, allIdentities, currentIdentity, numMessages, msgFolder;</span>
<a href="#l2.2148"></a><span id="l2.2148" class="difflineplus">+                               .getService(Components.interfaces.nsIMsgSendLater);</span>
<a href="#l2.2149"></a><span id="l2.2149"> </span>
<a href="#l2.2150"></a><span id="l2.2150" class="difflineminus">-  if (accountManager) { </span>
<a href="#l2.2151"></a><span id="l2.2151" class="difflineminus">-    allIdentities = accountManager.allIdentities;</span>
<a href="#l2.2152"></a><span id="l2.2152" class="difflineminus">-    identitiesCount = allIdentities.Count();</span>
<a href="#l2.2153"></a><span id="l2.2153" class="difflineminus">-    for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l2.2154"></a><span id="l2.2154" class="difflineminus">-      currentIdentity = allIdentities.QueryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l2.2155"></a><span id="l2.2155" class="difflineminus">-      msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l2.2156"></a><span id="l2.2156" class="difflineminus">-      if(msgFolder) {</span>
<a href="#l2.2157"></a><span id="l2.2157" class="difflineminus">-        numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l2.2158"></a><span id="l2.2158" class="difflineminus">-        if(numMessages &gt; 0) {</span>
<a href="#l2.2159"></a><span id="l2.2159" class="difflineminus">-          messenger.sendUnsentMessages(currentIdentity, msgWindow);</span>
<a href="#l2.2160"></a><span id="l2.2160" class="difflineminus">-          // right now, all identities point to the same unsent messages</span>
<a href="#l2.2161"></a><span id="l2.2161" class="difflineminus">-          // folder, so to avoid sending multiple copies of the</span>
<a href="#l2.2162"></a><span id="l2.2162" class="difflineminus">-          // unsent messages, we only call messenger.SendUnsentMessages() once</span>
<a href="#l2.2163"></a><span id="l2.2163" class="difflineminus">-          // see bug #89150 for details</span>
<a href="#l2.2164"></a><span id="l2.2164" class="difflineminus">-          break;</span>
<a href="#l2.2165"></a><span id="l2.2165" class="difflineminus">-        }</span>
<a href="#l2.2166"></a><span id="l2.2166" class="difflineplus">+  var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l2.2167"></a><span id="l2.2167" class="difflineplus">+                                 .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l2.2168"></a><span id="l2.2168" class="difflineplus">+  var allIdentities = accountManager.allIdentities;</span>
<a href="#l2.2169"></a><span id="l2.2169" class="difflineplus">+  var identitiesCount = allIdentities.Count();</span>
<a href="#l2.2170"></a><span id="l2.2170" class="difflineplus">+  for (var i = 0; i &lt; identitiesCount; i++) {</span>
<a href="#l2.2171"></a><span id="l2.2171" class="difflineplus">+    var currentIdentity = allIdentities.QueryElementAt(i, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l2.2172"></a><span id="l2.2172" class="difflineplus">+    var msgFolder = msgSendlater.getUnsentMessagesFolder(currentIdentity);</span>
<a href="#l2.2173"></a><span id="l2.2173" class="difflineplus">+    if (msgFolder) {</span>
<a href="#l2.2174"></a><span id="l2.2174" class="difflineplus">+      var numMessages = msgFolder.getTotalMessages(false /* include subfolders */);</span>
<a href="#l2.2175"></a><span id="l2.2175" class="difflineplus">+      if(numMessages &gt; 0) {</span>
<a href="#l2.2176"></a><span id="l2.2176" class="difflineplus">+        messenger.sendUnsentMessages(currentIdentity, msgWindow);</span>
<a href="#l2.2177"></a><span id="l2.2177" class="difflineplus">+        // Right now, all identities point to the same unsent messages</span>
<a href="#l2.2178"></a><span id="l2.2178" class="difflineplus">+        // folder, so to avoid sending multiple copies of the</span>
<a href="#l2.2179"></a><span id="l2.2179" class="difflineplus">+        // unsent messages, we only call messenger.SendUnsentMessages() once.</span>
<a href="#l2.2180"></a><span id="l2.2180" class="difflineplus">+        // See bug #89150 for details.</span>
<a href="#l2.2181"></a><span id="l2.2181" class="difflineplus">+        break;</span>
<a href="#l2.2182"></a><span id="l2.2182">       }</span>
<a href="#l2.2183"></a><span id="l2.2183" class="difflineminus">-    } </span>
<a href="#l2.2184"></a><span id="l2.2184" class="difflineplus">+    }</span>
<a href="#l2.2185"></a><span id="l2.2185">   }</span>
<a href="#l2.2186"></a><span id="l2.2186"> }</span>
<a href="#l2.2187"></a><span id="l2.2187"> </span>
<a href="#l2.2188"></a><span id="l2.2188" class="difflineminus">-function CoalesceGetMsgsForPop3ServersByDestFolder(currentServer, pop3DownloadServersArray, localFoldersToDownloadTo)</span>
<a href="#l2.2189"></a><span id="l2.2189" class="difflineplus">+function CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l2.2190"></a><span id="l2.2190" class="difflineplus">+                                                   pop3DownloadServersArray,</span>
<a href="#l2.2191"></a><span id="l2.2191" class="difflineplus">+                                                   localFoldersToDownloadTo)</span>
<a href="#l2.2192"></a><span id="l2.2192"> {</span>
<a href="#l2.2193"></a><span id="l2.2193">   var outNumFolders = new Object();</span>
<a href="#l2.2194"></a><span id="l2.2194" class="difflineminus">-  var inboxFolder = currentServer.rootMsgFolder.getFolderWithFlags(0x1000); </span>
<a href="#l2.2195"></a><span id="l2.2195" class="difflineplus">+  var inboxFolder = currentServer.rootMsgFolder.getFolderWithFlags(0x1000);</span>
<a href="#l2.2196"></a><span id="l2.2196">   // coalesce the servers that download into the same folder...</span>
<a href="#l2.2197"></a><span id="l2.2197">   var index = localFoldersToDownloadTo.GetIndexOf(inboxFolder);</span>
<a href="#l2.2198"></a><span id="l2.2198">   if (index == -1)</span>
<a href="#l2.2199"></a><span id="l2.2199">   {</span>
<a href="#l2.2200"></a><span id="l2.2200">     if (inboxFolder)</span>
<a href="#l2.2201"></a><span id="l2.2201">     {</span>
<a href="#l2.2202"></a><span id="l2.2202">       inboxFolder.biffState =  Components.interfaces.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l2.2203"></a><span id="l2.2203">       inboxFolder.clearNewMessages();</span>
<a href="#l2.2204"></a><span id="l2.2204">     }</span>
<a href="#l2.2205"></a><span id="l2.2205">     localFoldersToDownloadTo.AppendElement(inboxFolder);</span>
<a href="#l2.2206"></a><span id="l2.2206">     index = pop3DownloadServersArray.length</span>
<a href="#l2.2207"></a><span id="l2.2207" class="difflineminus">-    pop3DownloadServersArray[index] = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.2208"></a><span id="l2.2208" class="difflineplus">+    pop3DownloadServersArray[index] = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l2.2209"></a><span id="l2.2209" class="difflineplus">+                                                .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.2210"></a><span id="l2.2210">   }</span>
<a href="#l2.2211"></a><span id="l2.2211">   pop3DownloadServersArray[index].AppendElement(currentServer);</span>
<a href="#l2.2212"></a><span id="l2.2212"> }</span>
<a href="#l2.2213"></a><span id="l2.2213"> </span>
<a href="#l2.2214"></a><span id="l2.2214"> function GetMessagesForAllAuthenticatedAccounts()</span>
<a href="#l2.2215"></a><span id="l2.2215"> {</span>
<a href="#l2.2216"></a><span id="l2.2216">   // now log into any server</span>
<a href="#l2.2217"></a><span id="l2.2217">   try</span>
<a href="#l2.2218"></a><span id="l2.2218">   {</span>
<a href="#l2.2219"></a><span id="l2.2219">     var allServers = accountManager.allServers;</span>
<a href="#l2.2220"></a><span id="l2.2220" class="difflineminus">-    var i;</span>
<a href="#l2.2221"></a><span id="l2.2221">     // array of isupportsarrays of servers for a particular folder</span>
<a href="#l2.2222"></a><span id="l2.2222">     var pop3DownloadServersArray = new Array();</span>
<a href="#l2.2223"></a><span id="l2.2223">     // parallel isupports array of folders to download to...</span>
<a href="#l2.2224"></a><span id="l2.2224" class="difflineminus">-    var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;].createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.2225"></a><span id="l2.2225" class="difflineplus">+    var localFoldersToDownloadTo = Components.classes[&quot;@mozilla.org/supports-array;1&quot;]</span>
<a href="#l2.2226"></a><span id="l2.2226" class="difflineplus">+                                             .createInstance(Components.interfaces.nsISupportsArray);</span>
<a href="#l2.2227"></a><span id="l2.2227">     var pop3Server;</span>
<a href="#l2.2228"></a><span id="l2.2228"> </span>
<a href="#l2.2229"></a><span id="l2.2229" class="difflineminus">-    for (i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l2.2230"></a><span id="l2.2230" class="difflineplus">+    for (var i = 0; i &lt; allServers.Count(); ++i)</span>
<a href="#l2.2231"></a><span id="l2.2231">     {</span>
<a href="#l2.2232"></a><span id="l2.2232">       var currentServer = allServers.GetElementAt(i).QueryInterface(Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l2.2233"></a><span id="l2.2233" class="difflineminus">-      var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type].getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l2.2234"></a><span id="l2.2234" class="difflineplus">+      var protocolinfo = Components.classes[&quot;@mozilla.org/messenger/protocol/info;1?type=&quot; + currentServer.type]</span>
<a href="#l2.2235"></a><span id="l2.2235" class="difflineplus">+                                   .getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l2.2236"></a><span id="l2.2236">       if (protocolinfo.canGetMessages &amp;&amp; !currentServer.passwordPromptRequired)</span>
<a href="#l2.2237"></a><span id="l2.2237">       {</span>
<a href="#l2.2238"></a><span id="l2.2238">         if (currentServer.type == &quot;pop3&quot;)</span>
<a href="#l2.2239"></a><span id="l2.2239">         {</span>
<a href="#l2.2240"></a><span id="l2.2240" class="difflineminus">-          CoalesceGetMsgsForPop3ServersByDestFolder(currentServer, pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l2.2241"></a><span id="l2.2241" class="difflineplus">+          CoalesceGetMsgsForPop3ServersByDestFolder(currentServer,</span>
<a href="#l2.2242"></a><span id="l2.2242" class="difflineplus">+            pop3DownloadServersArray, localFoldersToDownloadTo);</span>
<a href="#l2.2243"></a><span id="l2.2243">           pop3Server = currentServer.QueryInterface(Components.interfaces.nsIPop3IncomingServer);</span>
<a href="#l2.2244"></a><span id="l2.2244">         }</span>
<a href="#l2.2245"></a><span id="l2.2245">         else</span>
<a href="#l2.2246"></a><span id="l2.2246">         // get new messages on the server for imap or rss</span>
<a href="#l2.2247"></a><span id="l2.2247">           GetMessagesForInboxOnServer(currentServer);</span>
<a href="#l2.2248"></a><span id="l2.2248">       }</span>
<a href="#l2.2249"></a><span id="l2.2249">     }</span>
<a href="#l2.2250"></a><span id="l2.2250" class="difflineminus">-    for (i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l2.2251"></a><span id="l2.2251" class="difflineplus">+    for (var i = 0; i &lt; pop3DownloadServersArray.length; ++i)</span>
<a href="#l2.2252"></a><span id="l2.2252">     {</span>
<a href="#l2.2253"></a><span id="l2.2253">       // any ol' pop3Server will do - the serversArray specifies which servers to download from</span>
<a href="#l2.2254"></a><span id="l2.2254" class="difflineminus">-      pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow, localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l2.2255"></a><span id="l2.2255" class="difflineplus">+      pop3Server.downloadMailFromServers(pop3DownloadServersArray[i], msgWindow,</span>
<a href="#l2.2256"></a><span id="l2.2256" class="difflineplus">+                                         localFoldersToDownloadTo.GetElementAt(i), null);</span>
<a href="#l2.2257"></a><span id="l2.2257">     }</span>
<a href="#l2.2258"></a><span id="l2.2258">   }</span>
<a href="#l2.2259"></a><span id="l2.2259">   catch(ex)</span>
<a href="#l2.2260"></a><span id="l2.2260">   {</span>
<a href="#l2.2261"></a><span id="l2.2261">       dump(ex + &quot;\n&quot;);</span>
<a href="#l2.2262"></a><span id="l2.2262">   }</span>
<a href="#l2.2263"></a><span id="l2.2263"> }</span>
<a href="#l2.2264"></a><span id="l2.2264"> </span>
<a href="#l2.2265"></a><span id="l2.2265"> function CommandUpdate_UndoRedo()</span>
<a href="#l2.2266"></a><span id="l2.2266"> {</span>
<a href="#l2.2267"></a><span id="l2.2267" class="difflineminus">-    ShowMenuItem(&quot;menu_undo&quot;, true);</span>
<a href="#l2.2268"></a><span id="l2.2268" class="difflineminus">-    EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l2.2269"></a><span id="l2.2269" class="difflineminus">-    ShowMenuItem(&quot;menu_redo&quot;, true);</span>
<a href="#l2.2270"></a><span id="l2.2270" class="difflineminus">-    EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l2.2271"></a><span id="l2.2271" class="difflineplus">+  EnableMenuItem(&quot;menu_undo&quot;, SetupUndoRedoCommand(&quot;cmd_undo&quot;));</span>
<a href="#l2.2272"></a><span id="l2.2272" class="difflineplus">+  EnableMenuItem(&quot;menu_redo&quot;, SetupUndoRedoCommand(&quot;cmd_redo&quot;));</span>
<a href="#l2.2273"></a><span id="l2.2273"> }</span>
<a href="#l2.2274"></a><span id="l2.2274"> </span>
<a href="#l2.2275"></a><span id="l2.2275"> function SetupUndoRedoCommand(command)</span>
<a href="#l2.2276"></a><span id="l2.2276"> {</span>
<a href="#l2.2277"></a><span id="l2.2277" class="difflineminus">-    var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l2.2278"></a><span id="l2.2278" class="difflineminus">-</span>
<a href="#l2.2279"></a><span id="l2.2279" class="difflineminus">-    // if we have selected a server, and are viewing account central</span>
<a href="#l2.2280"></a><span id="l2.2280" class="difflineminus">-    // there is no loaded folder</span>
<a href="#l2.2281"></a><span id="l2.2281" class="difflineminus">-    if (!loadedFolder)</span>
<a href="#l2.2282"></a><span id="l2.2282" class="difflineminus">-      return false;</span>
<a href="#l2.2283"></a><span id="l2.2283" class="difflineminus">-</span>
<a href="#l2.2284"></a><span id="l2.2284" class="difflineminus">-    var server = loadedFolder.server;</span>
<a href="#l2.2285"></a><span id="l2.2285" class="difflineminus">-    if (!(server.canUndoDeleteOnServer))</span>
<a href="#l2.2286"></a><span id="l2.2286" class="difflineminus">-      return false;</span>
<a href="#l2.2287"></a><span id="l2.2287" class="difflineminus">-</span>
<a href="#l2.2288"></a><span id="l2.2288" class="difflineminus">-    var canUndoOrRedo = false;</span>
<a href="#l2.2289"></a><span id="l2.2289" class="difflineminus">-    var txnType = 0;</span>
<a href="#l2.2290"></a><span id="l2.2290" class="difflineminus">-</span>
<a href="#l2.2291"></a><span id="l2.2291" class="difflineminus">-    if (command == &quot;cmd_undo&quot;)</span>
<a href="#l2.2292"></a><span id="l2.2292" class="difflineminus">-    {</span>
<a href="#l2.2293"></a><span id="l2.2293" class="difflineminus">-        canUndoOrRedo = messenger.canUndo();</span>
<a href="#l2.2294"></a><span id="l2.2294" class="difflineminus">-        txnType = messenger.getUndoTransactionType();</span>
<a href="#l2.2295"></a><span id="l2.2295" class="difflineminus">-    }</span>
<a href="#l2.2296"></a><span id="l2.2296" class="difflineminus">-    else</span>
<a href="#l2.2297"></a><span id="l2.2297" class="difflineminus">-    {</span>
<a href="#l2.2298"></a><span id="l2.2298" class="difflineminus">-        canUndoOrRedo = messenger.canRedo();</span>
<a href="#l2.2299"></a><span id="l2.2299" class="difflineminus">-        txnType = messenger.getRedoTransactionType();</span>
<a href="#l2.2300"></a><span id="l2.2300" class="difflineminus">-    }</span>
<a href="#l2.2301"></a><span id="l2.2301" class="difflineplus">+  // If we have selected a server, and are viewing account central</span>
<a href="#l2.2302"></a><span id="l2.2302" class="difflineplus">+  // there is no loaded folder.</span>
<a href="#l2.2303"></a><span id="l2.2303" class="difflineplus">+  var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l2.2304"></a><span id="l2.2304" class="difflineplus">+  if (!loadedFolder || !loadedFolder.server.canUndoDeleteOnServer)</span>
<a href="#l2.2305"></a><span id="l2.2305" class="difflineplus">+    return false;</span>
<a href="#l2.2306"></a><span id="l2.2306"> </span>
<a href="#l2.2307"></a><span id="l2.2307" class="difflineminus">-    if (canUndoOrRedo)</span>
<a href="#l2.2308"></a><span id="l2.2308" class="difflineminus">-    {</span>
<a href="#l2.2309"></a><span id="l2.2309" class="difflineminus">-        switch (txnType)</span>
<a href="#l2.2310"></a><span id="l2.2310" class="difflineminus">-        {</span>
<a href="#l2.2311"></a><span id="l2.2311" class="difflineminus">-        default:</span>
<a href="#l2.2312"></a><span id="l2.2312" class="difflineminus">-        case 0:</span>
<a href="#l2.2313"></a><span id="l2.2313" class="difflineminus">-            goSetMenuValue(command, 'valueDefault');</span>
<a href="#l2.2314"></a><span id="l2.2314" class="difflineminus">-            break;</span>
<a href="#l2.2315"></a><span id="l2.2315" class="difflineminus">-        case 1:</span>
<a href="#l2.2316"></a><span id="l2.2316" class="difflineminus">-            goSetMenuValue(command, 'valueDeleteMsg');</span>
<a href="#l2.2317"></a><span id="l2.2317" class="difflineminus">-            break;</span>
<a href="#l2.2318"></a><span id="l2.2318" class="difflineminus">-        case 2:</span>
<a href="#l2.2319"></a><span id="l2.2319" class="difflineminus">-            goSetMenuValue(command, 'valueMoveMsg');</span>
<a href="#l2.2320"></a><span id="l2.2320" class="difflineminus">-            break;</span>
<a href="#l2.2321"></a><span id="l2.2321" class="difflineminus">-        case 3:</span>
<a href="#l2.2322"></a><span id="l2.2322" class="difflineminus">-            goSetMenuValue(command, 'valueCopyMsg');</span>
<a href="#l2.2323"></a><span id="l2.2323" class="difflineminus">-            break;</span>
<a href="#l2.2324"></a><span id="l2.2324" class="difflineminus">-        }</span>
<a href="#l2.2325"></a><span id="l2.2325" class="difflineminus">-    }</span>
<a href="#l2.2326"></a><span id="l2.2326" class="difflineminus">-    else</span>
<a href="#l2.2327"></a><span id="l2.2327" class="difflineminus">-    {</span>
<a href="#l2.2328"></a><span id="l2.2328" class="difflineminus">-        goSetMenuValue(command, 'valueDefault');</span>
<a href="#l2.2329"></a><span id="l2.2329" class="difflineminus">-    }</span>
<a href="#l2.2330"></a><span id="l2.2330" class="difflineminus">-    return canUndoOrRedo;</span>
<a href="#l2.2331"></a><span id="l2.2331" class="difflineplus">+  var canUndoOrRedo;</span>
<a href="#l2.2332"></a><span id="l2.2332" class="difflineplus">+  var txnType;</span>
<a href="#l2.2333"></a><span id="l2.2333" class="difflineplus">+  if (command == &quot;cmd_undo&quot;)</span>
<a href="#l2.2334"></a><span id="l2.2334" class="difflineplus">+  {</span>
<a href="#l2.2335"></a><span id="l2.2335" class="difflineplus">+    canUndoOrRedo = messenger.canUndo();</span>
<a href="#l2.2336"></a><span id="l2.2336" class="difflineplus">+    txnType = messenger.getUndoTransactionType();</span>
<a href="#l2.2337"></a><span id="l2.2337" class="difflineplus">+  }</span>
<a href="#l2.2338"></a><span id="l2.2338" class="difflineplus">+  else</span>
<a href="#l2.2339"></a><span id="l2.2339" class="difflineplus">+  {</span>
<a href="#l2.2340"></a><span id="l2.2340" class="difflineplus">+    canUndoOrRedo = messenger.canRedo();</span>
<a href="#l2.2341"></a><span id="l2.2341" class="difflineplus">+    txnType = messenger.getRedoTransactionType();</span>
<a href="#l2.2342"></a><span id="l2.2342" class="difflineplus">+  }</span>
<a href="#l2.2343"></a><span id="l2.2343" class="difflineplus">+</span>
<a href="#l2.2344"></a><span id="l2.2344" class="difflineplus">+  if (canUndoOrRedo)</span>
<a href="#l2.2345"></a><span id="l2.2345" class="difflineplus">+  {</span>
<a href="#l2.2346"></a><span id="l2.2346" class="difflineplus">+    var commands = ['valueDefault', 'valueDeleteMsg', 'valueMoveMsg', 'valueCopyMsg'];</span>
<a href="#l2.2347"></a><span id="l2.2347" class="difflineplus">+    goSetMenuValue(command, commands[txnType]);</span>
<a href="#l2.2348"></a><span id="l2.2348" class="difflineplus">+  }</span>
<a href="#l2.2349"></a><span id="l2.2349" class="difflineplus">+  else</span>
<a href="#l2.2350"></a><span id="l2.2350" class="difflineplus">+  {</span>
<a href="#l2.2351"></a><span id="l2.2351" class="difflineplus">+    goSetMenuValue(command, 'valueDefault');</span>
<a href="#l2.2352"></a><span id="l2.2352" class="difflineplus">+  }</span>
<a href="#l2.2353"></a><span id="l2.2353" class="difflineplus">+  return canUndoOrRedo;</span>
<a href="#l2.2354"></a><span id="l2.2354"> }</span>
<a href="#l2.2355"></a><span id="l2.2355"> </span>
<a href="#l2.2356"></a><span id="l2.2356"> function HandleJunkStatusChanged(folder)</span>
<a href="#l2.2357"></a><span id="l2.2357"> {</span>
<a href="#l2.2358"></a><span id="l2.2358" class="difflineminus">-  // this might be the stand alone window, open to a message that was</span>
<a href="#l2.2359"></a><span id="l2.2359" class="difflineplus">+  // This might be the stand alone window, open to a message that was</span>
<a href="#l2.2360"></a><span id="l2.2360">   // and attachment (or on disk), in which case, we want to ignore it.</span>
<a href="#l2.2361"></a><span id="l2.2361">   var loadedMessage = GetLoadedMessage();</span>
<a href="#l2.2362"></a><span id="l2.2362" class="difflineminus">-  if (loadedMessage &amp;&amp; (!(/type=application\/x-message-display/.test(loadedMessage))) &amp;&amp; IsCurrentLoadedFolder(folder))</span>
<a href="#l2.2363"></a><span id="l2.2363" class="difflineplus">+  if (!loadedMessage || (/type=application\/x-message-display/.test(loadedMessage)) ||</span>
<a href="#l2.2364"></a><span id="l2.2364" class="difflineplus">+      !IsCurrentLoadedFolder(folder))</span>
<a href="#l2.2365"></a><span id="l2.2365" class="difflineplus">+    return;</span>
<a href="#l2.2366"></a><span id="l2.2366" class="difflineplus">+</span>
<a href="#l2.2367"></a><span id="l2.2367" class="difflineplus">+  // If multiple message are selected and we change the junk status</span>
<a href="#l2.2368"></a><span id="l2.2368" class="difflineplus">+  // we don't want to show the junk bar (since the message pane is blank).</span>
<a href="#l2.2369"></a><span id="l2.2369" class="difflineplus">+  var msgHdr = null;</span>
<a href="#l2.2370"></a><span id="l2.2370" class="difflineplus">+  if (GetNumSelectedMessages() == 1)</span>
<a href="#l2.2371"></a><span id="l2.2371" class="difflineplus">+    msgHdr = messenger.msgHdrFromURI(loadedMessage);</span>
<a href="#l2.2372"></a><span id="l2.2372" class="difflineplus">+  var junkBarWasDisplayed = gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar);</span>
<a href="#l2.2373"></a><span id="l2.2373" class="difflineplus">+  gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l2.2374"></a><span id="l2.2374" class="difflineplus">+</span>
<a href="#l2.2375"></a><span id="l2.2375" class="difflineplus">+  // Only reload message if junk bar display state has changed.</span>
<a href="#l2.2376"></a><span id="l2.2376" class="difflineplus">+  if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l2.2377"></a><span id="l2.2377">   {</span>
<a href="#l2.2378"></a><span id="l2.2378" class="difflineminus">-    // if multiple message are selected and we change the junk status</span>
<a href="#l2.2379"></a><span id="l2.2379" class="difflineminus">-    // we don't want to show the junk bar (since the message pane is blank)</span>
<a href="#l2.2380"></a><span id="l2.2380" class="difflineminus">-    var msgHdr = null;</span>
<a href="#l2.2381"></a><span id="l2.2381" class="difflineminus">-    if (GetNumSelectedMessages() == 1)</span>
<a href="#l2.2382"></a><span id="l2.2382" class="difflineminus">-      msgHdr = messenger.msgHdrFromURI(loadedMessage);</span>
<a href="#l2.2383"></a><span id="l2.2383" class="difflineminus">-    var junkBarWasDisplayed = gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar);</span>
<a href="#l2.2384"></a><span id="l2.2384" class="difflineminus">-    gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l2.2385"></a><span id="l2.2385" class="difflineplus">+    // We may be forcing junk mail to be rendered with sanitized html.</span>
<a href="#l2.2386"></a><span id="l2.2386" class="difflineplus">+    // In that scenario, we want to reload the message if the status has just</span>
<a href="#l2.2387"></a><span id="l2.2387" class="difflineplus">+    // changed to not junk.</span>
<a href="#l2.2388"></a><span id="l2.2388" class="difflineplus">+    var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l2.2389"></a><span id="l2.2389"> </span>
<a href="#l2.2390"></a><span id="l2.2390" class="difflineminus">-    // only reload message if junk bar display state has changed.    </span>
<a href="#l2.2391"></a><span id="l2.2391" class="difflineminus">-    if (msgHdr &amp;&amp; junkBarWasDisplayed != gMessageNotificationBar.isFlagSet(kMsgNotificationJunkBar))</span>
<a href="#l2.2392"></a><span id="l2.2392" class="difflineplus">+    // Only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l2.2393"></a><span id="l2.2393" class="difflineplus">+    if (sanitizeJunkMail)</span>
<a href="#l2.2394"></a><span id="l2.2394">     {</span>
<a href="#l2.2395"></a><span id="l2.2395" class="difflineminus">-      // we may be forcing junk mail to be rendered with sanitized html. In that scenario, we want to </span>
<a href="#l2.2396"></a><span id="l2.2396" class="difflineminus">-      // reload the message if the status has just changed to not junk. </span>
<a href="#l2.2397"></a><span id="l2.2397" class="difflineminus">-      var sanitizeJunkMail = gPrefBranch.getBoolPref(&quot;mail.spam.display.sanitize&quot;);</span>
<a href="#l2.2398"></a><span id="l2.2398" class="difflineminus">-      if (sanitizeJunkMail) // only bother doing this if we are modifying the html for junk mail....</span>
<a href="#l2.2399"></a><span id="l2.2399" class="difflineminus">-      {</span>
<a href="#l2.2400"></a><span id="l2.2400" class="difflineminus">-        var moveJunkMail = (folder &amp;&amp; folder.server &amp;&amp; folder.server.spamSettings) ?</span>
<a href="#l2.2401"></a><span id="l2.2401" class="difflineminus">-                            folder.server.spamSettings.manualMark : false;</span>
<a href="#l2.2402"></a><span id="l2.2402" class="difflineplus">+      var moveJunkMail = (folder &amp;&amp; folder.server &amp;&amp; folder.server.spamSettings) ?</span>
<a href="#l2.2403"></a><span id="l2.2403" class="difflineplus">+                          folder.server.spamSettings.manualMark : false;</span>
<a href="#l2.2404"></a><span id="l2.2404" class="difflineplus">+</span>
<a href="#l2.2405"></a><span id="l2.2405" class="difflineplus">+      var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l2.2406"></a><span id="l2.2406" class="difflineplus">+      var isJunk = (junkScore == &quot;&quot;) || (junkScore == &quot;0&quot;);</span>
<a href="#l2.2407"></a><span id="l2.2407"> </span>
<a href="#l2.2408"></a><span id="l2.2408" class="difflineminus">-        var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;); </span>
<a href="#l2.2409"></a><span id="l2.2409" class="difflineminus">-        var isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l2.2410"></a><span id="l2.2410" class="difflineminus">-</span>
<a href="#l2.2411"></a><span id="l2.2411" class="difflineminus">-        // we used to only reload the message if we were toggling the message to NOT JUNK from junk</span>
<a href="#l2.2412"></a><span id="l2.2412" class="difflineminus">-        // but it can be useful to see the HTML in the message get converted to sanitized form when a message</span>
<a href="#l2.2413"></a><span id="l2.2413" class="difflineminus">-        // is marked as junk.</span>
<a href="#l2.2414"></a><span id="l2.2414" class="difflineminus">-        // Furthermore, if we are about to move the message that was just marked as junk, </span>
<a href="#l2.2415"></a><span id="l2.2415" class="difflineminus">-        // then don't bother reloading it.</span>
<a href="#l2.2416"></a><span id="l2.2416" class="difflineminus">-        if (!(isJunk &amp;&amp; moveJunkMail)) </span>
<a href="#l2.2417"></a><span id="l2.2417" class="difflineminus">-          ReloadMessage();</span>
<a href="#l2.2418"></a><span id="l2.2418" class="difflineminus">-      }</span>
<a href="#l2.2419"></a><span id="l2.2419" class="difflineplus">+      // We used to only reload the message if we were toggling the message</span>
<a href="#l2.2420"></a><span id="l2.2420" class="difflineplus">+      // to NOT JUNK from junk but it can be useful to see the HTML in the</span>
<a href="#l2.2421"></a><span id="l2.2421" class="difflineplus">+      // message get converted to sanitized form when a message is marked as</span>
<a href="#l2.2422"></a><span id="l2.2422" class="difflineplus">+      // junk. Furthermore, if we are about to move the message that was just</span>
<a href="#l2.2423"></a><span id="l2.2423" class="difflineplus">+      // marked as junk then don't bother reloading it.</span>
<a href="#l2.2424"></a><span id="l2.2424" class="difflineplus">+      if (!(isJunk &amp;&amp; moveJunkMail))</span>
<a href="#l2.2425"></a><span id="l2.2425" class="difflineplus">+        ReloadMessage();</span>
<a href="#l2.2426"></a><span id="l2.2426">     }</span>
<a href="#l2.2427"></a><span id="l2.2427">   }</span>
<a href="#l2.2428"></a><span id="l2.2428"> }</span>
<a href="#l2.2429"></a><span id="l2.2429"> </span>
<a href="#l2.2430"></a><span id="l2.2430" class="difflineminus">-var gMessageNotificationBar = </span>
<a href="#l2.2431"></a><span id="l2.2431" class="difflineplus">+var gMessageNotificationBar =</span>
<a href="#l2.2432"></a><span id="l2.2432"> {</span>
<a href="#l2.2433"></a><span id="l2.2433">   mBarStatus: 0,</span>
<a href="#l2.2434"></a><span id="l2.2434">   // flag bit values for mBarStatus, indexed by kMsgNotificationXXX</span>
<a href="#l2.2435"></a><span id="l2.2435">   mBarFlagValues: [</span>
<a href="#l2.2436"></a><span id="l2.2436">                     0, // for no msgNotificationBar</span>
<a href="#l2.2437"></a><span id="l2.2437">                     1, // 1 &lt;&lt; (kMsgNotificationPhishingBar - 1)</span>
<a href="#l2.2438"></a><span id="l2.2438">                     2, // 1 &lt;&lt; (kMsgNotificationJunkBar - 1)</span>
<a href="#l2.2439"></a><span id="l2.2439">                     4  // 1 &lt;&lt; (kMsgNotificationRemoteImages - 1)</span>
<a href="#l2.2440"></a><span id="l2.2440">                   ],</span>
<a href="#l2.2441"></a><span id="l2.2441"> </span>
<a href="#l2.2442"></a><span id="l2.2442">   mMsgNotificationBar: document.getElementById('msgNotificationBar'),</span>
<a href="#l2.2443"></a><span id="l2.2443"> </span>
<a href="#l2.2444"></a><span id="l2.2444">   setJunkMsg: function(aMsgHdr)</span>
<a href="#l2.2445"></a><span id="l2.2445">   {</span>
<a href="#l2.2446"></a><span id="l2.2446">     var isJunk = false;</span>
<a href="#l2.2447"></a><span id="l2.2447" class="difflineminus">-  </span>
<a href="#l2.2448"></a><span id="l2.2448" class="difflineminus">-    if (aMsgHdr) </span>
<a href="#l2.2449"></a><span id="l2.2449" class="difflineplus">+</span>
<a href="#l2.2450"></a><span id="l2.2450" class="difflineplus">+    if (aMsgHdr)</span>
<a href="#l2.2451"></a><span id="l2.2451">     {</span>
<a href="#l2.2452"></a><span id="l2.2452">       var junkScore = aMsgHdr.getStringProperty(&quot;junkscore&quot;); </span>
<a href="#l2.2453"></a><span id="l2.2453">       isJunk = ((junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;));</span>
<a href="#l2.2454"></a><span id="l2.2454">     }</span>
<a href="#l2.2455"></a><span id="l2.2455"> </span>
<a href="#l2.2456"></a><span id="l2.2456">     this.updateMsgNotificationBar(kMsgNotificationJunkBar, isJunk);</span>
<a href="#l2.2457"></a><span id="l2.2457"> </span>
<a href="#l2.2458"></a><span id="l2.2458">     goUpdateCommand('button_junk');</span>
<a href="#l2.2459"></a><span id="l2.2459">   },</span>
<a href="#l2.2460"></a><span id="l2.2460"> </span>
<a href="#l2.2461"></a><span id="l2.2461">   setRemoteContentMsg: function(aMsgHdr)</span>
<a href="#l2.2462"></a><span id="l2.2462" class="difflineminus">-  {  </span>
<a href="#l2.2463"></a><span id="l2.2463" class="difflineplus">+  {</span>
<a href="#l2.2464"></a><span id="l2.2464">     // update the allow remote content for sender string</span>
<a href="#l2.2465"></a><span id="l2.2465" class="difflineminus">-    var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;].getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.2466"></a><span id="l2.2466" class="difflineplus">+    var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l2.2467"></a><span id="l2.2467" class="difflineplus">+                                 .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.2468"></a><span id="l2.2468">     var emailAddress = headerParser.extractHeaderAddressMailboxes(aMsgHdr.author);</span>
<a href="#l2.2469"></a><span id="l2.2469" class="difflineminus">-    document.getElementById('allowRemoteContentForAuthorDesc').value = </span>
<a href="#l2.2470"></a><span id="l2.2470" class="difflineminus">-      gMessengerBundle.getFormattedString('alwaysLoadRemoteContentForSender1', [emailAddress ? emailAddress : aMsgHdr.author]);</span>
<a href="#l2.2471"></a><span id="l2.2471" class="difflineplus">+    document.getElementById('allowRemoteContentForAuthorDesc').value =</span>
<a href="#l2.2472"></a><span id="l2.2472" class="difflineplus">+      gMessengerBundle.getFormattedString('alwaysLoadRemoteContentForSender1',</span>
<a href="#l2.2473"></a><span id="l2.2473" class="difflineplus">+                         [emailAddress ? emailAddress : aMsgHdr.author]);</span>
<a href="#l2.2474"></a><span id="l2.2474">     this.updateMsgNotificationBar(kMsgNotificationRemoteImages, true);</span>
<a href="#l2.2475"></a><span id="l2.2475">   },</span>
<a href="#l2.2476"></a><span id="l2.2476"> </span>
<a href="#l2.2477"></a><span id="l2.2477">   setPhishingMsg: function()</span>
<a href="#l2.2478"></a><span id="l2.2478">   {</span>
<a href="#l2.2479"></a><span id="l2.2479">     this.updateMsgNotificationBar(kMsgNotificationPhishingBar, true);</span>
<a href="#l2.2480"></a><span id="l2.2480">   },</span>
<a href="#l2.2481"></a><span id="l2.2481"> </span>
<a href="#l2.2482"></a><span id="l2.2482" class="difflineat">@@ -2396,17 +2258,17 @@ var gMessageNotificationBar =</span>
<a href="#l2.2483"></a><span id="l2.2483">     var status = aSet ? this.mBarStatus | chunk : this.mBarStatus &amp; ~chunk;</span>
<a href="#l2.2484"></a><span id="l2.2484">     this.mBarStatus = status;</span>
<a href="#l2.2485"></a><span id="l2.2485"> </span>
<a href="#l2.2486"></a><span id="l2.2486">     // the phishing message takes precedence over the junk message</span>
<a href="#l2.2487"></a><span id="l2.2487">     // which takes precedence over the remote content message</span>
<a href="#l2.2488"></a><span id="l2.2488">     this.mMsgNotificationBar.selectedIndex = this.mBarFlagValues.indexOf(status &amp; -status);</span>
<a href="#l2.2489"></a><span id="l2.2489">     this.mMsgNotificationBar.collapsed = !status;</span>
<a href="#l2.2490"></a><span id="l2.2490">   },</span>
<a href="#l2.2491"></a><span id="l2.2491" class="difflineminus">-  </span>
<a href="#l2.2492"></a><span id="l2.2492" class="difflineplus">+</span>
<a href="#l2.2493"></a><span id="l2.2493">   /**</span>
<a href="#l2.2494"></a><span id="l2.2494">    * @param aFlag (kMsgNotificationPhishingBar, kMsgNotificationJunkBar, kMsgNotificationRemoteImages</span>
<a href="#l2.2495"></a><span id="l2.2495">    * @return true if aFlag is currently set for the loaded message</span>
<a href="#l2.2496"></a><span id="l2.2496">    */</span>
<a href="#l2.2497"></a><span id="l2.2497">   isFlagSet: function(aFlag)</span>
<a href="#l2.2498"></a><span id="l2.2498">   {</span>
<a href="#l2.2499"></a><span id="l2.2499">     var chunk = this.mBarFlagValues[aFlag];</span>
<a href="#l2.2500"></a><span id="l2.2500">     return this.mBarStatus &amp; chunk;</span>
<a href="#l2.2501"></a><span id="l2.2501" class="difflineat">@@ -2422,18 +2284,17 @@ function LoadMsgWithRemoteContent()</span>
<a href="#l2.2502"></a><span id="l2.2502">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l2.2503"></a><span id="l2.2503">   // change the &quot;remoteContentBar&quot; property on it</span>
<a href="#l2.2504"></a><span id="l2.2504">   // then reload the message</span>
<a href="#l2.2505"></a><span id="l2.2505"> </span>
<a href="#l2.2506"></a><span id="l2.2506">   setMsgHdrPropertyAndReload(&quot;remoteContentPolicy&quot;, kAllowRemoteContent);</span>
<a href="#l2.2507"></a><span id="l2.2507"> }</span>
<a href="#l2.2508"></a><span id="l2.2508"> </span>
<a href="#l2.2509"></a><span id="l2.2509"> /**</span>
<a href="#l2.2510"></a><span id="l2.2510" class="difflineminus">- *  msgHdrForCurrentMessage</span>
<a href="#l2.2511"></a><span id="l2.2511" class="difflineminus">- *   Returns the msg hdr associated with the current loaded message.</span>
<a href="#l2.2512"></a><span id="l2.2512" class="difflineplus">+ * Returns the msg hdr associated with the current loaded message.</span>
<a href="#l2.2513"></a><span id="l2.2513">  */</span>
<a href="#l2.2514"></a><span id="l2.2514"> function msgHdrForCurrentMessage()</span>
<a href="#l2.2515"></a><span id="l2.2515"> {</span>
<a href="#l2.2516"></a><span id="l2.2516">   var msgURI = GetLoadedMessage();</span>
<a href="#l2.2517"></a><span id="l2.2517">   return (msgURI &amp;&amp; !(/type=application\/x-message-display/.test(msgURI))) ? messenger.msgHdrFromURI(msgURI) : null;</span>
<a href="#l2.2518"></a><span id="l2.2518"> }</span>
<a href="#l2.2519"></a><span id="l2.2519"> </span>
<a href="#l2.2520"></a><span id="l2.2520"> /**</span>
<a href="#l2.2521"></a><span id="l2.2521" class="difflineat">@@ -2443,29 +2304,29 @@ function msgHdrForCurrentMessage()</span>
<a href="#l2.2522"></a><span id="l2.2522">  *  If we can't find a card, prompt the user with a new AB card dialog, pre-selecting the remote content field.</span>
<a href="#l2.2523"></a><span id="l2.2523">  */</span>
<a href="#l2.2524"></a><span id="l2.2524"> function allowRemoteContentForSender()</span>
<a href="#l2.2525"></a><span id="l2.2525"> {</span>
<a href="#l2.2526"></a><span id="l2.2526">   // get the sender of the msg hdr</span>
<a href="#l2.2527"></a><span id="l2.2527">   var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l2.2528"></a><span id="l2.2528">   if (!msgHdr)</span>
<a href="#l2.2529"></a><span id="l2.2529">     return;</span>
<a href="#l2.2530"></a><span id="l2.2530" class="difflineminus">-  </span>
<a href="#l2.2531"></a><span id="l2.2531" class="difflineplus">+</span>
<a href="#l2.2532"></a><span id="l2.2532">   var headerParser = Components.classes[&quot;@mozilla.org/messenger/headerparser;1&quot;]</span>
<a href="#l2.2533"></a><span id="l2.2533" class="difflineminus">-                      .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.2534"></a><span id="l2.2534" class="difflineplus">+                               .getService(Components.interfaces.nsIMsgHeaderParser);</span>
<a href="#l2.2535"></a><span id="l2.2535">   var names = {};</span>
<a href="#l2.2536"></a><span id="l2.2536">   var addresses = {};</span>
<a href="#l2.2537"></a><span id="l2.2537">   var fullNames = {};</span>
<a href="#l2.2538"></a><span id="l2.2538">   var numAddresses;</span>
<a href="#l2.2539"></a><span id="l2.2539" class="difflineminus">-  </span>
<a href="#l2.2540"></a><span id="l2.2540" class="difflineplus">+</span>
<a href="#l2.2541"></a><span id="l2.2541">   numAddresses = headerParser.parseHeadersWithArray(msgHdr.author, addresses, names, fullNames);</span>
<a href="#l2.2542"></a><span id="l2.2542">   var authorEmailAddress = addresses.value[0];</span>
<a href="#l2.2543"></a><span id="l2.2543">   if (!authorEmailAddress)</span>
<a href="#l2.2544"></a><span id="l2.2544">     return;</span>
<a href="#l2.2545"></a><span id="l2.2545" class="difflineminus">-  </span>
<a href="#l2.2546"></a><span id="l2.2546" class="difflineplus">+</span>
<a href="#l2.2547"></a><span id="l2.2547">   // search through all of our local address books looking for a match.</span>
<a href="#l2.2548"></a><span id="l2.2548">   var enumerator = Components.classes[&quot;@mozilla.org/abmanager;1&quot;]</span>
<a href="#l2.2549"></a><span id="l2.2549">                              .getService(Components.interfaces.nsIAbManager)</span>
<a href="#l2.2550"></a><span id="l2.2550">                              .directories;</span>
<a href="#l2.2551"></a><span id="l2.2551">   var cardForEmailAddress;</span>
<a href="#l2.2552"></a><span id="l2.2552">   var addrbook;</span>
<a href="#l2.2553"></a><span id="l2.2553">   while (!cardForEmailAddress &amp;&amp; enumerator.hasMoreElements())</span>
<a href="#l2.2554"></a><span id="l2.2554">   {</span>
<a href="#l2.2555"></a><span id="l2.2555" class="difflineat">@@ -2487,31 +2348,31 @@ function allowRemoteContentForSender()</span>
<a href="#l2.2556"></a><span id="l2.2556">   else</span>
<a href="#l2.2557"></a><span id="l2.2557">   {</span>
<a href="#l2.2558"></a><span id="l2.2558">     var args = {primaryEmail:authorEmailAddress, displayName:names.value[0],</span>
<a href="#l2.2559"></a><span id="l2.2559">                 allowRemoteContent:true};</span>
<a href="#l2.2560"></a><span id="l2.2560">     // create a new card and set the property</span>
<a href="#l2.2561"></a><span id="l2.2561">     window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l2.2562"></a><span id="l2.2562">                       &quot;&quot;, &quot;chrome,resizable=no,titlebar,modal,centerscreen&quot;, args);</span>
<a href="#l2.2563"></a><span id="l2.2563">     allowRemoteContent = args.allowRemoteContent;</span>
<a href="#l2.2564"></a><span id="l2.2564" class="difflineminus">-  } </span>
<a href="#l2.2565"></a><span id="l2.2565" class="difflineminus">-  </span>
<a href="#l2.2566"></a><span id="l2.2566" class="difflineminus">-  // reload the message if we've updated the remote content policy for the sender  </span>
<a href="#l2.2567"></a><span id="l2.2567" class="difflineplus">+  }</span>
<a href="#l2.2568"></a><span id="l2.2568" class="difflineplus">+</span>
<a href="#l2.2569"></a><span id="l2.2569" class="difflineplus">+  // Reload the message if we've updated the remote content policy for the sender.</span>
<a href="#l2.2570"></a><span id="l2.2570">   if (allowRemoteContent)</span>
<a href="#l2.2571"></a><span id="l2.2571">     ReloadMessage();</span>
<a href="#l2.2572"></a><span id="l2.2572"> }</span>
<a href="#l2.2573"></a><span id="l2.2573"> </span>
<a href="#l2.2574"></a><span id="l2.2574" class="difflineminus">-/** </span>
<a href="#l2.2575"></a><span id="l2.2575" class="difflineminus">- *  IgnorePhishingWarning - set the msg hdr flag to ignore the phishing warning </span>
<a href="#l2.2576"></a><span id="l2.2576" class="difflineminus">- *  and reload the message.</span>
<a href="#l2.2577"></a><span id="l2.2577" class="difflineplus">+/**</span>
<a href="#l2.2578"></a><span id="l2.2578" class="difflineplus">+ *  Set the msg hdr flag to ignore the phishing warning and reload the message.</span>
<a href="#l2.2579"></a><span id="l2.2579">  */</span>
<a href="#l2.2580"></a><span id="l2.2580"> function IgnorePhishingWarning()</span>
<a href="#l2.2581"></a><span id="l2.2581"> {</span>
<a href="#l2.2582"></a><span id="l2.2582" class="difflineminus">-  // this property should really be called skipPhishingWarning or something like that, but it's too late to change that now. This property is used to supress the phishing </span>
<a href="#l2.2583"></a><span id="l2.2583" class="difflineminus">-  // bar for the message.</span>
<a href="#l2.2584"></a><span id="l2.2584" class="difflineplus">+  // This property should really be called skipPhishingWarning or something</span>
<a href="#l2.2585"></a><span id="l2.2585" class="difflineplus">+  // like that, but it's too late to change that now.</span>
<a href="#l2.2586"></a><span id="l2.2586" class="difflineplus">+  // This property is used to supress the phishing bar for the message.</span>
<a href="#l2.2587"></a><span id="l2.2587">   setMsgHdrPropertyAndReload(&quot;notAPhishMessage&quot;, 1);</span>
<a href="#l2.2588"></a><span id="l2.2588"> }</span>
<a href="#l2.2589"></a><span id="l2.2589"> </span>
<a href="#l2.2590"></a><span id="l2.2590"> function setMsgHdrPropertyAndReload(aProperty, aValue)</span>
<a href="#l2.2591"></a><span id="l2.2591"> {</span>
<a href="#l2.2592"></a><span id="l2.2592">   // we want to get the msg hdr for the currently selected message</span>
<a href="#l2.2593"></a><span id="l2.2593">   // change the appropiate property on it then reload the message</span>
<a href="#l2.2594"></a><span id="l2.2594">   var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l2.2595"></a><span id="l2.2595" class="difflineat">@@ -2552,17 +2413,18 @@ function OnMsgParsed(aUrl)</span>
<a href="#l2.2596"></a><span id="l2.2596">   // Run the phishing detector on the message if it hasn't been marked as not</span>
<a href="#l2.2597"></a><span id="l2.2597">   // a scam already.</span>
<a href="#l2.2598"></a><span id="l2.2598">   var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l2.2599"></a><span id="l2.2599">   if (msgHdr &amp;&amp; !msgHdr.getUint32Property(&quot;notAPhishMessage&quot;))</span>
<a href="#l2.2600"></a><span id="l2.2600">     gPhishingDetector.analyzeMsgForPhishingURLs(aUrl);</span>
<a href="#l2.2601"></a><span id="l2.2601"> </span>
<a href="#l2.2602"></a><span id="l2.2602">   // notify anyone (e.g., extensions) who's interested in when a message is loaded.</span>
<a href="#l2.2603"></a><span id="l2.2603">   var msgURI = GetLoadedMessage();</span>
<a href="#l2.2604"></a><span id="l2.2604" class="difflineminus">-  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;].getService(Components.interfaces.nsIObserverService);</span>
<a href="#l2.2605"></a><span id="l2.2605" class="difflineplus">+  var observerService = Components.classes[&quot;@mozilla.org/observer-service;1&quot;]</span>
<a href="#l2.2606"></a><span id="l2.2606" class="difflineplus">+                                  .getService(Components.interfaces.nsIObserverService);</span>
<a href="#l2.2607"></a><span id="l2.2607">   observerService.notifyObservers(msgWindow.msgHeaderSink, &quot;MsgMsgDisplayed&quot;, msgURI);</span>
<a href="#l2.2608"></a><span id="l2.2608"> </span>
<a href="#l2.2609"></a><span id="l2.2609">   // scale any overflowing images</span>
<a href="#l2.2610"></a><span id="l2.2610">   var doc = document.getElementById(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l2.2611"></a><span id="l2.2611">   var imgs = doc.getElementsByTagName(&quot;img&quot;);</span>
<a href="#l2.2612"></a><span id="l2.2612">   for each (var img in imgs)</span>
<a href="#l2.2613"></a><span id="l2.2613">   {</span>
<a href="#l2.2614"></a><span id="l2.2614">     if (img.className == &quot;moz-attached-image&quot; &amp;&amp; img.naturalWidth &gt; doc.width)</span>
<a href="#l2.2615"></a><span id="l2.2615" class="difflineat">@@ -2572,120 +2434,107 @@ function OnMsgParsed(aUrl)</span>
<a href="#l2.2616"></a><span id="l2.2616">       else</span>
<a href="#l2.2617"></a><span id="l2.2617">         img.setAttribute(&quot;overflowing&quot;, &quot;true&quot;);</span>
<a href="#l2.2618"></a><span id="l2.2618">     }</span>
<a href="#l2.2619"></a><span id="l2.2619">   }</span>
<a href="#l2.2620"></a><span id="l2.2620"> }</span>
<a href="#l2.2621"></a><span id="l2.2621"> </span>
<a href="#l2.2622"></a><span id="l2.2622"> function OnMsgLoaded(aUrl)</span>
<a href="#l2.2623"></a><span id="l2.2623"> {</span>
<a href="#l2.2624"></a><span id="l2.2624" class="difflineminus">-    if (!aUrl)</span>
<a href="#l2.2625"></a><span id="l2.2625" class="difflineminus">-      return;</span>
<a href="#l2.2626"></a><span id="l2.2626" class="difflineplus">+  if (!aUrl)</span>
<a href="#l2.2627"></a><span id="l2.2627" class="difflineplus">+    return;</span>
<a href="#l2.2628"></a><span id="l2.2628"> </span>
<a href="#l2.2629"></a><span id="l2.2629" class="difflineminus">-    // nsIMsgMailNewsUrl.folder throws an error when opening .eml files.</span>
<a href="#l2.2630"></a><span id="l2.2630" class="difflineminus">-    var folder;</span>
<a href="#l2.2631"></a><span id="l2.2631" class="difflineminus">-    try {</span>
<a href="#l2.2632"></a><span id="l2.2632" class="difflineminus">-      folder = aUrl.folder;</span>
<a href="#l2.2633"></a><span id="l2.2633" class="difflineminus">-    }</span>
<a href="#l2.2634"></a><span id="l2.2634" class="difflineminus">-    catch (ex) {}</span>
<a href="#l2.2635"></a><span id="l2.2635" class="difflineplus">+  // nsIMsgMailNewsUrl.folder throws an error when opening .eml files.</span>
<a href="#l2.2636"></a><span id="l2.2636" class="difflineplus">+  var folder;</span>
<a href="#l2.2637"></a><span id="l2.2637" class="difflineplus">+  try {</span>
<a href="#l2.2638"></a><span id="l2.2638" class="difflineplus">+    folder = aUrl.folder;</span>
<a href="#l2.2639"></a><span id="l2.2639" class="difflineplus">+  }</span>
<a href="#l2.2640"></a><span id="l2.2640" class="difflineplus">+  catch (ex) {}</span>
<a href="#l2.2641"></a><span id="l2.2641"> </span>
<a href="#l2.2642"></a><span id="l2.2642" class="difflineminus">-    var msgURI = GetLoadedMessage();</span>
<a href="#l2.2643"></a><span id="l2.2643" class="difflineplus">+  var msgURI = GetLoadedMessage();</span>
<a href="#l2.2644"></a><span id="l2.2644" class="difflineplus">+</span>
<a href="#l2.2645"></a><span id="l2.2645" class="difflineplus">+  if (!folder || !msgURI)</span>
<a href="#l2.2646"></a><span id="l2.2646" class="difflineplus">+    return;</span>
<a href="#l2.2647"></a><span id="l2.2647"> </span>
<a href="#l2.2648"></a><span id="l2.2648" class="difflineminus">-    if (!folder || !msgURI)</span>
<a href="#l2.2649"></a><span id="l2.2649" class="difflineminus">-      return;</span>
<a href="#l2.2650"></a><span id="l2.2650" class="difflineplus">+  // If we are in the middle of a delete or move operation, make sure that</span>
<a href="#l2.2651"></a><span id="l2.2651" class="difflineplus">+  // if the user clicks on another message then that message stays selected</span>
<a href="#l2.2652"></a><span id="l2.2652" class="difflineplus">+  // and the selection does not &quot;snap back&quot; to the message chosen by</span>
<a href="#l2.2653"></a><span id="l2.2653" class="difflineplus">+  // SetNextMessageAfterDelete() when the operation completes (bug 243532).</span>
<a href="#l2.2654"></a><span id="l2.2654" class="difflineplus">+  // But the just loaded message might be getting deleted, if the user</span>
<a href="#l2.2655"></a><span id="l2.2655" class="difflineplus">+  // deletes it before the message is loaded (bug 183394).</span>
<a href="#l2.2656"></a><span id="l2.2656" class="difflineplus">+  var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l2.2657"></a><span id="l2.2657" class="difflineplus">+  if (wintype == &quot;mail:messageWindow&quot; ||</span>
<a href="#l2.2658"></a><span id="l2.2658" class="difflineplus">+      GetThreadTree().view.selection.currentIndex != gSelectedIndexWhenDeleting)</span>
<a href="#l2.2659"></a><span id="l2.2659" class="difflineplus">+    gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l2.2660"></a><span id="l2.2660"> </span>
<a href="#l2.2661"></a><span id="l2.2661" class="difflineminus">-    // If we are in the middle of a delete or move operation, make sure that</span>
<a href="#l2.2662"></a><span id="l2.2662" class="difflineminus">-    // if the user clicks on another message then that message stays selected</span>
<a href="#l2.2663"></a><span id="l2.2663" class="difflineminus">-    // and the selection does not &quot;snap back&quot; to the message chosen by</span>
<a href="#l2.2664"></a><span id="l2.2664" class="difflineminus">-    // SetNextMessageAfterDelete() when the operation completes (bug 243532).</span>
<a href="#l2.2665"></a><span id="l2.2665" class="difflineminus">-    // But the just loaded message might be getting deleted, if the user</span>
<a href="#l2.2666"></a><span id="l2.2666" class="difflineminus">-    // deletes it before the message is loaded (bug 183394)</span>
<a href="#l2.2667"></a><span id="l2.2667" class="difflineminus">-    var wintype = document.documentElement.getAttribute('windowtype');</span>
<a href="#l2.2668"></a><span id="l2.2668" class="difflineminus">-    if (wintype == &quot;mail:messageWindow&quot; || GetThreadTree().view.selection.currentIndex != gSelectedIndexWhenDeleting)</span>
<a href="#l2.2669"></a><span id="l2.2669" class="difflineminus">-      gNextMessageViewIndexAfterDelete = -2;</span>
<a href="#l2.2670"></a><span id="l2.2670" class="difflineplus">+  var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l2.2671"></a><span id="l2.2671" class="difflineplus">+  gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l2.2672"></a><span id="l2.2672" class="difflineplus">+</span>
<a href="#l2.2673"></a><span id="l2.2673" class="difflineplus">+  goUpdateCommand('button_delete');</span>
<a href="#l2.2674"></a><span id="l2.2674" class="difflineplus">+</span>
<a href="#l2.2675"></a><span id="l2.2675" class="difflineplus">+  var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l2.2676"></a><span id="l2.2676"> </span>
<a href="#l2.2677"></a><span id="l2.2677" class="difflineminus">-    var msgHdr = msgHdrForCurrentMessage();</span>
<a href="#l2.2678"></a><span id="l2.2678" class="difflineminus">-    gMessageNotificationBar.setJunkMsg(msgHdr);</span>
<a href="#l2.2679"></a><span id="l2.2679" class="difflineminus">-</span>
<a href="#l2.2680"></a><span id="l2.2680" class="difflineminus">-    goUpdateCommand('button_delete');</span>
<a href="#l2.2681"></a><span id="l2.2681" class="difflineminus">-</span>
<a href="#l2.2682"></a><span id="l2.2682" class="difflineminus">-    var markReadAutoMode = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l2.2683"></a><span id="l2.2683" class="difflineminus">-</span>
<a href="#l2.2684"></a><span id="l2.2684" class="difflineminus">-    // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l2.2685"></a><span id="l2.2685" class="difflineminus">-    // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l2.2686"></a><span id="l2.2686" class="difflineminus">-    // where n can be configured by the user.</span>
<a href="#l2.2687"></a><span id="l2.2687" class="difflineminus">-    if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode)</span>
<a href="#l2.2688"></a><span id="l2.2688" class="difflineminus">-    {</span>
<a href="#l2.2689"></a><span id="l2.2689" class="difflineminus">-      let markReadOnADelay = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l2.2690"></a><span id="l2.2690" class="difflineplus">+  // We just finished loading a message. If messages are to be marked as read</span>
<a href="#l2.2691"></a><span id="l2.2691" class="difflineplus">+  // automatically, set a timer to mark the message is read after n seconds</span>
<a href="#l2.2692"></a><span id="l2.2692" class="difflineplus">+  // where n can be configured by the user.</span>
<a href="#l2.2693"></a><span id="l2.2693" class="difflineplus">+  if (msgHdr &amp;&amp; !msgHdr.isRead &amp;&amp; markReadAutoMode)</span>
<a href="#l2.2694"></a><span id="l2.2694" class="difflineplus">+  {</span>
<a href="#l2.2695"></a><span id="l2.2695" class="difflineplus">+    let markReadOnADelay = gPrefBranch.getBoolPref(&quot;mailnews.mark_message_read.delay&quot;);</span>
<a href="#l2.2696"></a><span id="l2.2696"> </span>
<a href="#l2.2697"></a><span id="l2.2697" class="difflineminus">-      // Only use the timer if viewing using the 3-pane preview pane and the</span>
<a href="#l2.2698"></a><span id="l2.2698" class="difflineminus">-      // user has set the pref.</span>
<a href="#l2.2699"></a><span id="l2.2699" class="difflineminus">-      if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) // 3-pane window</span>
<a href="#l2.2700"></a><span id="l2.2700" class="difflineminus">-      {</span>
<a href="#l2.2701"></a><span id="l2.2701" class="difflineminus">-        ClearPendingReadTimer();</span>
<a href="#l2.2702"></a><span id="l2.2702" class="difflineminus">-        let markReadDelayTime = gPrefBranch.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l2.2703"></a><span id="l2.2703" class="difflineminus">-        if (markReadDelayTime == 0)</span>
<a href="#l2.2704"></a><span id="l2.2704" class="difflineminus">-          MarkCurrentMessageAsRead();</span>
<a href="#l2.2705"></a><span id="l2.2705" class="difflineminus">-        else</span>
<a href="#l2.2706"></a><span id="l2.2706" class="difflineminus">-          gMarkViewedMessageAsReadTimer = setTimeout(MarkCurrentMessageAsRead,</span>
<a href="#l2.2707"></a><span id="l2.2707" class="difflineminus">-                                                     markReadDelayTime * 1000);</span>
<a href="#l2.2708"></a><span id="l2.2708" class="difflineminus">-      }</span>
<a href="#l2.2709"></a><span id="l2.2709" class="difflineminus">-      else // standalone msg window</span>
<a href="#l2.2710"></a><span id="l2.2710" class="difflineplus">+    // Only use the timer if viewing using the 3-pane preview pane and the</span>
<a href="#l2.2711"></a><span id="l2.2711" class="difflineplus">+    // user has set the pref.</span>
<a href="#l2.2712"></a><span id="l2.2712" class="difflineplus">+    if (markReadOnADelay &amp;&amp; wintype == &quot;mail:3pane&quot;) // 3-pane window</span>
<a href="#l2.2713"></a><span id="l2.2713" class="difflineplus">+    {</span>
<a href="#l2.2714"></a><span id="l2.2714" class="difflineplus">+      ClearPendingReadTimer();</span>
<a href="#l2.2715"></a><span id="l2.2715" class="difflineplus">+      let markReadDelayTime = gPrefBranch.getIntPref(&quot;mailnews.mark_message_read.delay.interval&quot;);</span>
<a href="#l2.2716"></a><span id="l2.2716" class="difflineplus">+      if (markReadDelayTime == 0)</span>
<a href="#l2.2717"></a><span id="l2.2717">         MarkCurrentMessageAsRead();</span>
<a href="#l2.2718"></a><span id="l2.2718" class="difflineplus">+      else</span>
<a href="#l2.2719"></a><span id="l2.2719" class="difflineplus">+        gMarkViewedMessageAsReadTimer = setTimeout(MarkCurrentMessageAsRead,</span>
<a href="#l2.2720"></a><span id="l2.2720" class="difflineplus">+                                                   markReadDelayTime * 1000);</span>
<a href="#l2.2721"></a><span id="l2.2721" class="difflineplus">+    }</span>
<a href="#l2.2722"></a><span id="l2.2722" class="difflineplus">+    else // standalone msg window</span>
<a href="#l2.2723"></a><span id="l2.2723" class="difflineplus">+      MarkCurrentMessageAsRead();</span>
<a href="#l2.2724"></a><span id="l2.2724" class="difflineplus">+  }</span>
<a href="#l2.2725"></a><span id="l2.2725" class="difflineplus">+</span>
<a href="#l2.2726"></a><span id="l2.2726" class="difflineplus">+  // See if MDN was requested but has not been sent.</span>
<a href="#l2.2727"></a><span id="l2.2727" class="difflineplus">+  HandleMDNResponse(aUrl);</span>
<a href="#l2.2728"></a><span id="l2.2728" class="difflineplus">+</span>
<a href="#l2.2729"></a><span id="l2.2729" class="difflineplus">+  if (!IsImapMessage(msgURI))</span>
<a href="#l2.2730"></a><span id="l2.2730" class="difflineplus">+    return;</span>
<a href="#l2.2731"></a><span id="l2.2731" class="difflineplus">+</span>
<a href="#l2.2732"></a><span id="l2.2732" class="difflineplus">+  var imapServer = folder.server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l2.2733"></a><span id="l2.2733" class="difflineplus">+  if (imapServer.storeReadMailInPFC)</span>
<a href="#l2.2734"></a><span id="l2.2734" class="difflineplus">+  {</span>
<a href="#l2.2735"></a><span id="l2.2735" class="difflineplus">+    // Look in read mail PFC for msg with same msg id - if we find one,</span>
<a href="#l2.2736"></a><span id="l2.2736" class="difflineplus">+    // don't put this message in the read mail pfc.</span>
<a href="#l2.2737"></a><span id="l2.2737" class="difflineplus">+    var outputPFC = imapServer.GetReadMailPFC(true);</span>
<a href="#l2.2738"></a><span id="l2.2738" class="difflineplus">+</span>
<a href="#l2.2739"></a><span id="l2.2739" class="difflineplus">+    if (msgHdr &amp;&amp; msgHdr.messageId.length &gt; 0)</span>
<a href="#l2.2740"></a><span id="l2.2740" class="difflineplus">+    {</span>
<a href="#l2.2741"></a><span id="l2.2741" class="difflineplus">+      var readMailDB = outputPFC.getMsgDatabase(msgWindow);</span>
<a href="#l2.2742"></a><span id="l2.2742" class="difflineplus">+      if (readMailDB &amp;&amp; readMailDB.getMsgHdrForMessageID(msgHdr.messageId))</span>
<a href="#l2.2743"></a><span id="l2.2743" class="difflineplus">+        return; // Don't copy to offline folder.</span>
<a href="#l2.2744"></a><span id="l2.2744">     }</span>
<a href="#l2.2745"></a><span id="l2.2745"> </span>
<a href="#l2.2746"></a><span id="l2.2746" class="difflineminus">-    // See if MDN was requested but has not been sent.</span>
<a href="#l2.2747"></a><span id="l2.2747" class="difflineminus">-    HandleMDNResponse(aUrl);</span>
<a href="#l2.2748"></a><span id="l2.2748" class="difflineminus">-</span>
<a href="#l2.2749"></a><span id="l2.2749" class="difflineminus">-    var currentMsgFolder = folder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l2.2750"></a><span id="l2.2750" class="difflineminus">-    if (!IsImapMessage(msgURI))</span>
<a href="#l2.2751"></a><span id="l2.2751" class="difflineminus">-      return;</span>
<a href="#l2.2752"></a><span id="l2.2752" class="difflineminus">-</span>
<a href="#l2.2753"></a><span id="l2.2753" class="difflineminus">-    var imapServer = currentMsgFolder.server.QueryInterface(Components.interfaces.nsIImapIncomingServer);</span>
<a href="#l2.2754"></a><span id="l2.2754" class="difflineminus">-    var storeReadMailInPFC = imapServer.storeReadMailInPFC;</span>
<a href="#l2.2755"></a><span id="l2.2755" class="difflineminus">-    if (storeReadMailInPFC)</span>
<a href="#l2.2756"></a><span id="l2.2756" class="difflineminus">-    {</span>
<a href="#l2.2757"></a><span id="l2.2757" class="difflineminus">-      var messageID;</span>
<a href="#l2.2758"></a><span id="l2.2758" class="difflineminus">-</span>
<a href="#l2.2759"></a><span id="l2.2759" class="difflineminus">-      var copyToOfflineFolder = true;</span>
<a href="#l2.2760"></a><span id="l2.2760" class="difflineminus">-</span>
<a href="#l2.2761"></a><span id="l2.2761" class="difflineminus">-      // look in read mail PFC for msg with same msg id - if we find one,</span>
<a href="#l2.2762"></a><span id="l2.2762" class="difflineminus">-      // don't put this message in the read mail pfc.</span>
<a href="#l2.2763"></a><span id="l2.2763" class="difflineminus">-      var outputPFC = imapServer.GetReadMailPFC(true);</span>
<a href="#l2.2764"></a><span id="l2.2764" class="difflineminus">-</span>
<a href="#l2.2765"></a><span id="l2.2765" class="difflineminus">-      if (msgHdr)</span>
<a href="#l2.2766"></a><span id="l2.2766" class="difflineminus">-      {</span>
<a href="#l2.2767"></a><span id="l2.2767" class="difflineminus">-        messageID = msgHdr.messageId;</span>
<a href="#l2.2768"></a><span id="l2.2768" class="difflineminus">-        if (messageID.length &gt; 0)</span>
<a href="#l2.2769"></a><span id="l2.2769" class="difflineminus">-        {</span>
<a href="#l2.2770"></a><span id="l2.2770" class="difflineminus">-          var readMailDB = outputPFC.getMsgDatabase(msgWindow);</span>
<a href="#l2.2771"></a><span id="l2.2771" class="difflineminus">-          if (readMailDB)</span>
<a href="#l2.2772"></a><span id="l2.2772" class="difflineminus">-          {</span>
<a href="#l2.2773"></a><span id="l2.2773" class="difflineminus">-            var hdrInDestDB = readMailDB.getMsgHdrForMessageID(messageID);</span>
<a href="#l2.2774"></a><span id="l2.2774" class="difflineminus">-            if (hdrInDestDB)</span>
<a href="#l2.2775"></a><span id="l2.2775" class="difflineminus">-              copyToOfflineFolder = false;</span>
<a href="#l2.2776"></a><span id="l2.2776" class="difflineminus">-          }</span>
<a href="#l2.2777"></a><span id="l2.2777" class="difflineminus">-        }</span>
<a href="#l2.2778"></a><span id="l2.2778" class="difflineminus">-      }</span>
<a href="#l2.2779"></a><span id="l2.2779" class="difflineminus">-      if (copyToOfflineFolder)</span>
<a href="#l2.2780"></a><span id="l2.2780" class="difflineminus">-      {</span>
<a href="#l2.2781"></a><span id="l2.2781" class="difflineminus">-        var messages = Components.classes[&quot;@mozilla.org/array;1&quot;].createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.2782"></a><span id="l2.2782" class="difflineminus">-        messages.appendElement(msgHdr, false);</span>
<a href="#l2.2783"></a><span id="l2.2783" class="difflineminus">-</span>
<a href="#l2.2784"></a><span id="l2.2784" class="difflineminus">-        res = outputPFC.copyMessages(currentMsgFolder, messages, false /*isMove*/, msgWindow /* nsIMsgWindow */, null /* listener */, false /* isFolder */, false /*allowUndo*/ );</span>
<a href="#l2.2785"></a><span id="l2.2785" class="difflineminus">-      }</span>
<a href="#l2.2786"></a><span id="l2.2786" class="difflineminus">-    }</span>
<a href="#l2.2787"></a><span id="l2.2787" class="difflineplus">+    var messages = Components.classes[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l2.2788"></a><span id="l2.2788" class="difflineplus">+                              .createInstance(Components.interfaces.nsIMutableArray);</span>
<a href="#l2.2789"></a><span id="l2.2789" class="difflineplus">+    messages.appendElement(msgHdr, false);</span>
<a href="#l2.2790"></a><span id="l2.2790" class="difflineplus">+    outputPFC.copyMessages(folder, messages, false /*isMove*/,</span>
<a href="#l2.2791"></a><span id="l2.2791" class="difflineplus">+                            msgWindow /*nsIMsgWindow*/, null /*listener*/,</span>
<a href="#l2.2792"></a><span id="l2.2792" class="difflineplus">+                            false /*isFolder*/, false /*allowUndo*/);</span>
<a href="#l2.2793"></a><span id="l2.2793" class="difflineplus">+  }</span>
<a href="#l2.2794"></a><span id="l2.2794"> }</span>
<a href="#l2.2795"></a><span id="l2.2795"> </span>
<a href="#l2.2796"></a><span id="l2.2796" class="difflineminus">-//</span>
<a href="#l2.2797"></a><span id="l2.2797" class="difflineminus">-// This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l2.2798"></a><span id="l2.2798" class="difflineminus">-// For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l2.2799"></a><span id="l2.2799" class="difflineminus">-// need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l2.2800"></a><span id="l2.2800" class="difflineminus">-// no need to check it either.</span>
<a href="#l2.2801"></a><span id="l2.2801" class="difflineminus">-//</span>
<a href="#l2.2802"></a><span id="l2.2802" class="difflineplus">+/**</span>
<a href="#l2.2803"></a><span id="l2.2803" class="difflineplus">+ * This function handles all mdn response generation (ie, imap and pop).</span>
<a href="#l2.2804"></a><span id="l2.2804" class="difflineplus">+ * For pop the msg uid can be 0 (ie, 1st msg in a local folder) so no</span>
<a href="#l2.2805"></a><span id="l2.2805" class="difflineplus">+ * need to check uid here. No one seems to set mimeHeaders to null so</span>
<a href="#l2.2806"></a><span id="l2.2806" class="difflineplus">+ * no need to check it either.</span>
<a href="#l2.2807"></a><span id="l2.2807" class="difflineplus">+ */</span>
<a href="#l2.2808"></a><span id="l2.2808"> function HandleMDNResponse(aUrl)</span>
<a href="#l2.2809"></a><span id="l2.2809"> {</span>
<a href="#l2.2810"></a><span id="l2.2810">   if (!aUrl)</span>
<a href="#l2.2811"></a><span id="l2.2811">     return;</span>
<a href="#l2.2812"></a><span id="l2.2812"> </span>
<a href="#l2.2813"></a><span id="l2.2813">   var msgFolder = aUrl.folder;</span>
<a href="#l2.2814"></a><span id="l2.2814">   var msgURI = GetLoadedMessage();</span>
<a href="#l2.2815"></a><span id="l2.2815">   if (!msgFolder || !msgURI || IsNewsMessage(msgURI))</span>
<a href="#l2.2816"></a><span id="l2.2816" class="difflineat">@@ -2724,20 +2573,21 @@ function HandleMDNResponse(aUrl)</span>
<a href="#l2.2817"></a><span id="l2.2817">     return;</span>
<a href="#l2.2818"></a><span id="l2.2818"> </span>
<a href="#l2.2819"></a><span id="l2.2819">   var DNTHeader = mimeHdr.extractHeader(&quot;Disposition-Notification-To&quot;, false);</span>
<a href="#l2.2820"></a><span id="l2.2820">   var oldDNTHeader = mimeHdr.extractHeader(&quot;Return-Receipt-To&quot;, false);</span>
<a href="#l2.2821"></a><span id="l2.2821">   if (!DNTHeader &amp;&amp; !oldDNTHeader)</span>
<a href="#l2.2822"></a><span id="l2.2822">     return;</span>
<a href="#l2.2823"></a><span id="l2.2823"> </span>
<a href="#l2.2824"></a><span id="l2.2824">   // Everything looks good so far, let's generate the MDN response.</span>
<a href="#l2.2825"></a><span id="l2.2825" class="difflineminus">-  var mdnGenerator = Components.classes[&quot;@mozilla.org/messenger-mdn/generator;1&quot;].</span>
<a href="#l2.2826"></a><span id="l2.2826" class="difflineminus">-                                  createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l2.2827"></a><span id="l2.2827" class="difflineplus">+  var mdnGenerator = Components.classes[&quot;@mozilla.org/messenger-mdn/generator;1&quot;]</span>
<a href="#l2.2828"></a><span id="l2.2828" class="difflineplus">+                               .createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l2.2829"></a><span id="l2.2829">   const MDN_DISPOSE_TYPE_DISPLAYED = 0;</span>
<a href="#l2.2830"></a><span id="l2.2830" class="difflineminus">-  mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder, msgHdr.messageKey, mimeHdr, false);</span>
<a href="#l2.2831"></a><span id="l2.2831" class="difflineplus">+  mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder,</span>
<a href="#l2.2832"></a><span id="l2.2832" class="difflineplus">+                       msgHdr.messageKey, mimeHdr, false);</span>
<a href="#l2.2833"></a><span id="l2.2833"> </span>
<a href="#l2.2834"></a><span id="l2.2834">   // Reset mark msg MDN &quot;Sent&quot; and &quot;Not Needed&quot;.</span>
<a href="#l2.2835"></a><span id="l2.2835">   const MSG_FLAG_MDN_REPORT_NEEDED = 0x400000;</span>
<a href="#l2.2836"></a><span id="l2.2836">   msgHdr.flags = (msgFlags &amp; ~MSG_FLAG_MDN_REPORT_NEEDED);</span>
<a href="#l2.2837"></a><span id="l2.2837">   msgHdr.OrFlags(MSG_FLAG_MDN_REPORT_SENT);</span>
<a href="#l2.2838"></a><span id="l2.2838"> </span>
<a href="#l2.2839"></a><span id="l2.2839">   // Commit db changes.</span>
<a href="#l2.2840"></a><span id="l2.2840">   var msgdb = msgFolder.getMsgDatabase(msgWindow);</span>
<a href="#l2.2841"></a><span id="l2.2841" class="difflineat">@@ -2777,33 +2627,36 @@ function MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l2.2842"></a><span id="l2.2842">       return;</span>
<a href="#l2.2843"></a><span id="l2.2843">   }</span>
<a href="#l2.2844"></a><span id="l2.2844"> </span>
<a href="#l2.2845"></a><span id="l2.2845">   var desiredWindow = GetWindowByWindowType(&quot;mailnews:junkmailinfo&quot;);</span>
<a href="#l2.2846"></a><span id="l2.2846"> </span>
<a href="#l2.2847"></a><span id="l2.2847">   if (desiredWindow)</span>
<a href="#l2.2848"></a><span id="l2.2848">     desiredWindow.focus();</span>
<a href="#l2.2849"></a><span id="l2.2849">   else</span>
<a href="#l2.2850"></a><span id="l2.2850" class="difflineminus">-    window.openDialog(&quot;chrome://messenger/content/junkMailInfo.xul&quot;, &quot;mailnews:junkmailinfo&quot;, &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l2.2851"></a><span id="l2.2851" class="difflineplus">+    window.openDialog(&quot;chrome://messenger/content/junkMailInfo.xul&quot;,</span>
<a href="#l2.2852"></a><span id="l2.2852" class="difflineplus">+                      &quot;mailnews:junkmailinfo&quot;,</span>
<a href="#l2.2853"></a><span id="l2.2853" class="difflineplus">+                      &quot;centerscreen,resizeable=no,titlebar,chrome,modal&quot;, null);</span>
<a href="#l2.2854"></a><span id="l2.2854"> }</span>
<a href="#l2.2855"></a><span id="l2.2855"> </span>
<a href="#l2.2856"></a><span id="l2.2856"> function MsgSearchAddresses()</span>
<a href="#l2.2857"></a><span id="l2.2857"> {</span>
<a href="#l2.2858"></a><span id="l2.2858">   var args = { directory: null };</span>
<a href="#l2.2859"></a><span id="l2.2859">   OpenOrFocusWindow(args, &quot;mailnews:absearch&quot;, &quot;chrome://messenger/content/ABSearchDialog.xul&quot;);</span>
<a href="#l2.2860"></a><span id="l2.2860"> }</span>
<a href="#l2.2861"></a><span id="l2.2861">  </span>
<a href="#l2.2862"></a><span id="l2.2862"> function MsgFilterList(args)</span>
<a href="#l2.2863"></a><span id="l2.2863"> {</span>
<a href="#l2.2864"></a><span id="l2.2864">   OpenOrFocusWindow(args, &quot;mailnews:filterlist&quot;, &quot;chrome://messenger/content/FilterListDialog.xul&quot;);</span>
<a href="#l2.2865"></a><span id="l2.2865"> }</span>
<a href="#l2.2866"></a><span id="l2.2866"> </span>
<a href="#l2.2867"></a><span id="l2.2867"> function GetWindowByWindowType(windowType)</span>
<a href="#l2.2868"></a><span id="l2.2868"> {</span>
<a href="#l2.2869"></a><span id="l2.2869" class="difflineminus">-  var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1'].getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l2.2870"></a><span id="l2.2870" class="difflineplus">+  var windowManager = Components.classes['@mozilla.org/appshell/window-mediator;1']</span>
<a href="#l2.2871"></a><span id="l2.2871" class="difflineplus">+                                .getService(Components.interfaces.nsIWindowMediator);</span>
<a href="#l2.2872"></a><span id="l2.2872">   return windowManager.getMostRecentWindow(windowType);</span>
<a href="#l2.2873"></a><span id="l2.2873"> }</span>
<a href="#l2.2874"></a><span id="l2.2874"> </span>
<a href="#l2.2875"></a><span id="l2.2875"> function OpenOrFocusWindow(args, windowType, chromeURL)</span>
<a href="#l2.2876"></a><span id="l2.2876"> {</span>
<a href="#l2.2877"></a><span id="l2.2877">   var desiredWindow = GetWindowByWindowType(windowType);</span>
<a href="#l2.2878"></a><span id="l2.2878"> </span>
<a href="#l2.2879"></a><span id="l2.2879">   if (desiredWindow) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/messageWindow.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/messageWindow.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -933,17 +933,21 @@ var MessageWindowController =</span>
<a href="#l3.4"></a><span id="l3.4">         var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l3.5"></a><span id="l3.5">         if (!loadedFolder)</span>
<a href="#l3.6"></a><span id="l3.6">           return false;</span>
<a href="#l3.7"></a><span id="l3.7">         return loadedFolder.server.canSearchMessages;</span>
<a href="#l3.8"></a><span id="l3.8">       case &quot;cmd_undo&quot;:</span>
<a href="#l3.9"></a><span id="l3.9">       case &quot;cmd_redo&quot;:</span>
<a href="#l3.10"></a><span id="l3.10">         return SetupUndoRedoCommand(command);</span>
<a href="#l3.11"></a><span id="l3.11">       case &quot;cmd_moveToFolderAgain&quot;:</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        return (pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;));</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        var loadedFolder = GetLoadedMsgFolder();</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+        if (!loadedFolder || (pref.getBoolPref(&quot;mail.last_msg_movecopy_was_move&quot;) &amp;&amp;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+            !loadedFolder.canDeleteMessages))</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+          return false;</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+        return pref.getCharPref(&quot;mail.last_msg_movecopy_target_uri&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">       case &quot;cmd_applyFilters&quot;:</span>
<a href="#l3.19"></a><span id="l3.19">       case &quot;cmd_runJunkControls&quot;:</span>
<a href="#l3.20"></a><span id="l3.20">       case &quot;cmd_deleteJunk&quot;:</span>
<a href="#l3.21"></a><span id="l3.21">         return false;</span>
<a href="#l3.22"></a><span id="l3.22">       default:</span>
<a href="#l3.23"></a><span id="l3.23">         return false;</span>
<a href="#l3.24"></a><span id="l3.24">     }</span>
<a href="#l3.25"></a><span id="l3.25">   },</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -1054,30 +1058,30 @@ var MessageWindowController =</span>
<a href="#l3.27"></a><span id="l3.27">       case &quot;cmd_findPrevious&quot;:</span>
<a href="#l3.28"></a><span id="l3.28">         document.getElementById(&quot;FindToolbar&quot;).onFindAgainCommand(true)</span>
<a href="#l3.29"></a><span id="l3.29">         break;</span>
<a href="#l3.30"></a><span id="l3.30">       case &quot;cmd_search&quot;:</span>
<a href="#l3.31"></a><span id="l3.31">         MsgSearchMessages();</span>
<a href="#l3.32"></a><span id="l3.32">         break;</span>
<a href="#l3.33"></a><span id="l3.33">       case &quot;button_mark&quot;:</span>
<a href="#l3.34"></a><span id="l3.34">       case &quot;cmd_markAsRead&quot;:</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-        MsgMarkMsgAsRead(null);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+        MsgMarkMsgAsRead();</span>
<a href="#l3.37"></a><span id="l3.37">         return;</span>
<a href="#l3.38"></a><span id="l3.38">       case &quot;cmd_markThreadAsRead&quot;:</span>
<a href="#l3.39"></a><span id="l3.39">         ClearPendingReadTimer();</span>
<a href="#l3.40"></a><span id="l3.40">         gDBView.doCommand(nsMsgViewCommandType.markThreadRead);</span>
<a href="#l3.41"></a><span id="l3.41">         return;</span>
<a href="#l3.42"></a><span id="l3.42">       case &quot;cmd_markAllRead&quot;:</span>
<a href="#l3.43"></a><span id="l3.43">         MsgMarkAllRead();</span>
<a href="#l3.44"></a><span id="l3.44">         return;</span>
<a href="#l3.45"></a><span id="l3.45">       case &quot;cmd_markReadByDate&quot;:</span>
<a href="#l3.46"></a><span id="l3.46">         MsgMarkReadByDate();</span>
<a href="#l3.47"></a><span id="l3.47">         return;</span>
<a href="#l3.48"></a><span id="l3.48">       case &quot;cmd_markAsFlagged&quot;:</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineminus">-        MsgMarkAsFlagged(null);</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+        MsgMarkAsFlagged();</span>
<a href="#l3.51"></a><span id="l3.51">         return;</span>
<a href="#l3.52"></a><span id="l3.52">       case &quot;cmd_markAsJunk&quot;:</span>
<a href="#l3.53"></a><span id="l3.53">         JunkSelectedMessages(true);</span>
<a href="#l3.54"></a><span id="l3.54">         return;</span>
<a href="#l3.55"></a><span id="l3.55">       case &quot;cmd_markAsNotJunk&quot;:</span>
<a href="#l3.56"></a><span id="l3.56">         JunkSelectedMessages(false);</span>
<a href="#l3.57"></a><span id="l3.57">         return;</span>
<a href="#l3.58"></a><span id="l3.58">       case &quot;cmd_recalculateJunkScore&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/resources/content/FilterEditor.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/resources/content/FilterEditor.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,17 +16,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">  *</span>
<a href="#l4.5"></a><span id="l4.5">  * The Initial Developer of the Original Code is</span>
<a href="#l4.6"></a><span id="l4.6">  * Netscape Communications Corporation.</span>
<a href="#l4.7"></a><span id="l4.7">  * Portions created by the Initial Developer are Copyright (C) 1998</span>
<a href="#l4.8"></a><span id="l4.8">  * the Initial Developer. All Rights Reserved.</span>
<a href="#l4.9"></a><span id="l4.9">  *</span>
<a href="#l4.10"></a><span id="l4.10">  * Contributor(s):</span>
<a href="#l4.11"></a><span id="l4.11">  *   Alec Flett &lt;alecf@netscape.com&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">- *   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+ *   Hkan Waara &lt;hwaara@chello.se&gt;</span>
<a href="#l4.14"></a><span id="l4.14">  *   Seth Spitzer &lt;sspitzer@netscape.com&gt;</span>
<a href="#l4.15"></a><span id="l4.15">  *   Mark Banner &lt;mark@standard8.demon.co.uk&gt;</span>
<a href="#l4.16"></a><span id="l4.16">  *   Kent James &lt;kent@caspia.com&gt;</span>
<a href="#l4.17"></a><span id="l4.17">  *</span>
<a href="#l4.18"></a><span id="l4.18">  * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l4.19"></a><span id="l4.19">  * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l4.20"></a><span id="l4.20">  * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l4.21"></a><span id="l4.21">  * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineat">@@ -73,17 +73,17 @@ var gFilterEditorMsgWindow = null;</span>
<a href="#l4.23"></a><span id="l4.23"> function filterEditorOnLoad()</span>
<a href="#l4.24"></a><span id="l4.24"> {</span>
<a href="#l4.25"></a><span id="l4.25">   getCustomActions();</span>
<a href="#l4.26"></a><span id="l4.26">   initializeSearchWidgets();</span>
<a href="#l4.27"></a><span id="l4.27">   initializeFilterWidgets();</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29">   gPrefBranch = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefService).getBranch(null);</span>
<a href="#l4.30"></a><span id="l4.30">   gFilterBundle = document.getElementById(&quot;bundle_filter&quot;);</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineminus">-  InitMessageMark();</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+</span>
<a href="#l4.33"></a><span id="l4.33">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) </span>
<a href="#l4.34"></a><span id="l4.34">   {</span>
<a href="#l4.35"></a><span id="l4.35">     var args = window.arguments[0];</span>
<a href="#l4.36"></a><span id="l4.36"> </span>
<a href="#l4.37"></a><span id="l4.37">     if (&quot;filterList&quot; in args) </span>
<a href="#l4.38"></a><span id="l4.38">       gFilterList = args.filterList;</span>
<a href="#l4.39"></a><span id="l4.39"> </span>
<a href="#l4.40"></a><span id="l4.40">     if (&quot;filter&quot; in args) </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

