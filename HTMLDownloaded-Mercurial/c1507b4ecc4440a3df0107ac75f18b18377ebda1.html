<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 22185:c1507b4ecc4440a3df0107ac75f18b18377ebda1</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c1507b4ecc4440a3df0107ac75f18b18377ebda1" />
<meta property="og:url" content="/comm-central/rev/c1507b4ecc4440a3df0107ac75f18b18377ebda1" />
<meta property="og:description" content="Bug 1399756 - remove trailing spaces in mailnews/base. rs=white-space-only" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c1507b4ecc4440a3df0107ac75f18b18377ebda1 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c1507b4ecc4440a3df0107ac75f18b18377ebda1">shortlog</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c1507b4ecc4440a3df0107ac75f18b18377ebda1">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1">files</a> |
changeset |
<a href="/comm-central/raw-rev/c1507b4ecc4440a3df0107ac75f18b18377ebda1">raw</a>  | <a href="/comm-central/archive/c1507b4ecc4440a3df0107ac75f18b18377ebda1.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/base. rs=white-space-only
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#111;&#114;&#103;&#32;&#75;&#32;&#60;&#106;&#111;&#114;&#103;&#107;&#64;&#106;&#111;&#114;&#103;&#107;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 21 Sep 2017 16:43:22 +0200</td></tr>

<tr>
 <td>changeset 22185</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c1507b4ecc4440a3df0107ac75f18b18377ebda1">c1507b4ecc4440a3df0107ac75f18b18377ebda1</a></td>
</tr>



<tr>
<td>parent 22184</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b0580e39dcb50170b8ef04f7d4cc3b0d2de72d82">b0580e39dcb50170b8ef04f7d4cc3b0d2de72d82</a>
</td>
</tr>

<tr>
<td>child 22186</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/153b971fbc2120fe61da0fe75181a69ba51dabc7">153b971fbc2120fe61da0fe75181a69ba51dabc7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c1507b4ecc4440a3df0107ac75f18b18377ebda1">13539</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 21 Sep 2017 14:43:59 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c1507b4ecc44 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c1507b4ecc4440a3df0107ac75f18b18377ebda1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&newProject=comm-central&newRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&newProject=comm-central&newRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&newProject=comm-central&newRevision=c1507b4ecc4440a3df0107ac75f18b18377ebda1&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28white-space-only%29&revcount=50">white-space-only</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">1399756</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1399756">Bug 1399756</a> - remove trailing spaces in mailnews/base. rs=white-space-only</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">mailnews/base/public/msgCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/msgCore.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">mailnews/base/public/nsMsgBaseCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgBaseCID.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">mailnews/base/public/nsMsgGroupnameFlags.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/public/nsMsgGroupnameFlags.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">mailnews/base/search/public/nsMsgSearchScopeTerm.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/search/public/nsMsgSearchScopeTerm.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">mailnews/base/src/nsCopyMessageStreamListener.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsCopyMessageStreamListener.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">mailnews/base/src/nsMailDirProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">mailnews/base/src/nsMailDirServiceDefs.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMailDirServiceDefs.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">mailnews/base/src/nsMessenger.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessenger.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">mailnews/base/src/nsMessengerBootstrap.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">mailnews/base/src/nsMessengerBootstrap.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerBootstrap.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">mailnews/base/src/nsMessengerContentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">mailnews/base/src/nsMessengerContentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerContentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">mailnews/base/src/nsMessengerWinIntegration.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMessengerWinIntegration.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">mailnews/base/src/nsMsgAccountManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">mailnews/base/src/nsMsgAccountManagerDS.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">mailnews/base/src/nsMsgAccountManagerDS.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgAccountManagerDS.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">mailnews/base/src/nsMsgBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">mailnews/base/src/nsMsgBiffManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgBiffManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">mailnews/base/src/nsMsgContentPolicy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgContentPolicy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">mailnews/base/src/nsMsgCopyService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">mailnews/base/src/nsMsgCopyService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgCopyService.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">mailnews/base/src/nsMsgDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">mailnews/base/src/nsMsgFolderCompactor.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderCompactor.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">mailnews/base/src/nsMsgFolderDataSource.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">mailnews/base/src/nsMsgFolderNotificationService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgFolderNotificationService.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">mailnews/base/src/nsMsgGroupThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupThread.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">mailnews/base/src/nsMsgGroupView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgGroupView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">mailnews/base/src/nsMsgMailSession.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">mailnews/base/src/nsMsgMailSession.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgMailSession.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">mailnews/base/src/nsMsgOfflineManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">mailnews/base/src/nsMsgOfflineManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgOfflineManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">mailnews/base/src/nsMsgPrintEngine.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">mailnews/base/src/nsMsgPrintEngine.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPrintEngine.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">mailnews/base/src/nsMsgProgress.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgProgress.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">mailnews/base/src/nsMsgPurgeService.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgPurgeService.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">mailnews/base/src/nsMsgQuickSearchDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">mailnews/base/src/nsMsgQuickSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgQuickSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">mailnews/base/src/nsMsgRDFDataSource.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">mailnews/base/src/nsMsgRDFUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">mailnews/base/src/nsMsgRDFUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgRDFUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">mailnews/base/src/nsMsgSearchDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSearchDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">mailnews/base/src/nsMsgServiceProvider.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">mailnews/base/src/nsMsgServiceProvider.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgServiceProvider.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">mailnews/base/src/nsMsgSpecialViews.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgSpecialViews.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">mailnews/base/src/nsMsgStatusFeedback.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgStatusFeedback.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">mailnews/base/src/nsMsgTagService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgTagService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">mailnews/base/src/nsMsgThreadedDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">mailnews/base/src/nsMsgThreadedDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgThreadedDBView.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">mailnews/base/src/nsMsgWindow.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgWindow.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">mailnews/base/src/nsMsgXFViewThread.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">mailnews/base/src/nsMsgXFViewThread.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFViewThread.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">mailnews/base/src/nsMsgXFVirtualFolderDBView.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsMsgXFVirtualFolderDBView.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">mailnews/base/src/nsSpamSettings.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">mailnews/base/src/nsSpamSettings.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSpamSettings.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">mailnews/base/src/nsStatusBarBiffManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">mailnews/base/src/nsStatusBarBiffManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsStatusBarBiffManager.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">mailnews/base/src/nsSubscribableServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">mailnews/base/src/nsSubscribableServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribableServer.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">mailnews/base/src/nsSubscribeDataSource.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">mailnews/base/src/nsSubscribeDataSource.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/src/nsSubscribeDataSource.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">mailnews/base/test/TestMsgStripRE.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">file</a> |
<a href="/comm-central/annotate/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">annotate</a> |
<a href="/comm-central/diff/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">diff</a> |
<a href="/comm-central/comparison/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">comparison</a> |
<a href="/comm-central/log/c1507b4ecc4440a3df0107ac75f18b18377ebda1/mailnews/base/test/TestMsgStripRE.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/msgCore.h</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/msgCore.h</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -45,17 +45,17 @@ class nsIMsgFolder;</span>
<a href="#l1.4"></a><span id="l1.4"> /*</span>
<a href="#l1.5"></a><span id="l1.5">  * NS_ERROR macros - use these macros to generate error constants</span>
<a href="#l1.6"></a><span id="l1.6">  * to be used by XPCOM interfaces and possibly other useful things</span>
<a href="#l1.7"></a><span id="l1.7">  * do not use these macros in your code - declare error macros for</span>
<a href="#l1.8"></a><span id="l1.8">  * each specific error you need.</span>
<a href="#l1.9"></a><span id="l1.9">  *</span>
<a href="#l1.10"></a><span id="l1.10">  * for example:</span>
<a href="#l1.11"></a><span id="l1.11">  * #define NS_MSG_ERROR_NO_SUCH_FOLDER NS_MSG_GENERATE_FAILURE(4)</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">- * </span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+ *</span>
<a href="#l1.14"></a><span id="l1.14">  */</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> /* use these routines to generate error values */</span>
<a href="#l1.17"></a><span id="l1.17"> #define NS_MSG_GENERATE_RESULT(severity, value) \</span>
<a href="#l1.18"></a><span id="l1.18"> NS_ERROR_GENERATE(severity, NS_ERROR_MODULE_MAILNEWS, value)</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20"> #define NS_MSG_GENERATE_SUCCESS(value) \</span>
<a href="#l1.21"></a><span id="l1.21"> NS_ERROR_GENERATE_SUCCESS(NS_ERROR_MODULE_MAILNEWS, value)</span>
<a href="#l1.22"></a><span id="l1.22" class="difflineat">@@ -136,21 +136,21 @@ NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODUL</span>
<a href="#l1.23"></a><span id="l1.23"> #define NS_MSG_SERVER_USERNAME_MISSING NS_MSG_GENERATE_FAILURE(23)</span>
<a href="#l1.24"></a><span id="l1.24"> </span>
<a href="#l1.25"></a><span id="l1.25"> #define NS_MSG_INVALID_DBVIEW_INDEX NS_MSG_GENERATE_FAILURE(24)</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> #define NS_MSG_NEWS_ARTICLE_NOT_FOUND NS_MSG_GENERATE_FAILURE(25)</span>
<a href="#l1.28"></a><span id="l1.28"> </span>
<a href="#l1.29"></a><span id="l1.29"> #define NS_MSG_ERROR_COPY_FOLDER_ABORTED NS_MSG_GENERATE_FAILURE(26)</span>
<a href="#l1.30"></a><span id="l1.30"> // this error means a url was queued but never run because one of the urls</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineminus">-// it was queued after failed. We send an OnStopRunningUrl with this error code </span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+// it was queued after failed. We send an OnStopRunningUrl with this error code</span>
<a href="#l1.33"></a><span id="l1.33"> // so the listeners can know that we didn't run the url.</span>
<a href="#l1.34"></a><span id="l1.34"> #define NS_MSG_ERROR_URL_ABORTED NS_MSG_GENERATE_FAILURE(27)</span>
<a href="#l1.35"></a><span id="l1.35"> #define NS_MSG_CUSTOM_HEADERS_OVERFLOW NS_MSG_GENERATE_FAILURE(28) //when num of custom headers exceeds 50</span>
<a href="#l1.36"></a><span id="l1.36" class="difflineminus">-#define NS_MSG_INVALID_CUSTOM_HEADER NS_MSG_GENERATE_FAILURE(29) //when custom header has invalid characters (as per rfc 2822) </span>
<a href="#l1.37"></a><span id="l1.37" class="difflineplus">+#define NS_MSG_INVALID_CUSTOM_HEADER NS_MSG_GENERATE_FAILURE(29) //when custom header has invalid characters (as per rfc 2822)</span>
<a href="#l1.38"></a><span id="l1.38"> </span>
<a href="#l1.39"></a><span id="l1.39"> #define NS_MSG_USER_NOT_AUTHENTICATED NS_MSG_GENERATE_FAILURE(30) // when local caches are password protect and user isn't auth</span>
<a href="#l1.40"></a><span id="l1.40"> </span>
<a href="#l1.41"></a><span id="l1.41"> #define NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD NS_MSG_GENERATE_FAILURE(31) // pop3 downloaded to tmp file, and failed.</span>
<a href="#l1.42"></a><span id="l1.42"> </span>
<a href="#l1.43"></a><span id="l1.43"> // The code tried to stream a message using the aLocalOnly argument, but</span>
<a href="#l1.44"></a><span id="l1.44"> // the message was not cached locally.</span>
<a href="#l1.45"></a><span id="l1.45"> #define NS_MSG_ERROR_MSG_NOT_OFFLINE NS_MSG_GENERATE_FAILURE(32)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgBaseCID.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -54,17 +54,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">   0x64921b82, \</span>
<a href="#l2.5"></a><span id="l2.5">   0x24bb, \</span>
<a href="#l2.6"></a><span id="l2.6">   0x4473, \</span>
<a href="#l2.7"></a><span id="l2.7">   {0xad, 0xa9, 0xdc, 0x89, 0x42, 0x61, 0x29, 0xa6} \</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> //</span>
<a href="#l2.11"></a><span id="l2.11"> // nsMsgAccountManager</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-// </span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+//</span>
<a href="#l2.14"></a><span id="l2.14"> #define NS_MSGACCOUNTMANAGER_CONTRACTID \</span>
<a href="#l2.15"></a><span id="l2.15">   &quot;@mozilla.org/messenger/account-manager;1&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17"> #define NS_MSGACCOUNTMANAGER_CID									\</span>
<a href="#l2.18"></a><span id="l2.18"> { /* D2876E50-E62C-11d2-B7FC-00805F05FFA5 */			\</span>
<a href="#l2.19"></a><span id="l2.19">  0xd2876e50, 0xe62c, 0x11d2,											\</span>
<a href="#l2.20"></a><span id="l2.20">  {0xb7, 0xfc, 0x0, 0x80, 0x5f, 0x5, 0xff, 0xa5 }}</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -283,17 +283,17 @@</span>
<a href="#l2.23"></a><span id="l2.23">     0x91fd6b19, 0xe0bc, 0x11d3,			\</span>
<a href="#l2.24"></a><span id="l2.24">   { 0x8f, 0x97, 0x0, 0x0, 0x64, 0x65, 0x73, 0x74 } }</span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> //</span>
<a href="#l2.27"></a><span id="l2.27"> // nsMsgServiceProviderService</span>
<a href="#l2.28"></a><span id="l2.28"> //</span>
<a href="#l2.29"></a><span id="l2.29"> #define NS_MSGSERVICEPROVIDERSERVICE_CONTRACTID \</span>
<a href="#l2.30"></a><span id="l2.30">   NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;ispdefaults&quot;</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-  </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33"> /* 10998cef-d7f2-4772-b7db-bd097454984c */</span>
<a href="#l2.34"></a><span id="l2.34"> #define NS_MSGSERVICEPROVIDERSERVICE_CID \</span>
<a href="#l2.35"></a><span id="l2.35"> { 0x10998cef, 0xd7f2, 0x4772, \</span>
<a href="#l2.36"></a><span id="l2.36">   { 0xb7, 0xdb, 0xbd, 0x09, 0x74, 0x54, 0x98, 0x4c}}</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38"> #define NS_MSGLOGONREDIRECTORSERVICE_CONTRACTID \</span>
<a href="#l2.39"></a><span id="l2.39"> 	&quot;@mozilla.org/messenger/msglogonredirector;1&quot;</span>
<a href="#l2.40"></a><span id="l2.40"> </span>
<a href="#l2.41"></a><span id="l2.41" class="difflineat">@@ -315,17 +315,17 @@</span>
<a href="#l2.42"></a><span id="l2.42"> // nsSubscribeDataSource</span>
<a href="#l2.43"></a><span id="l2.43"> //</span>
<a href="#l2.44"></a><span id="l2.44"> #define NS_SUBSCRIBEDATASOURCE_CONTRACTID \</span>
<a href="#l2.45"></a><span id="l2.45">   NS_RDF_DATASOURCE_CONTRACTID_PREFIX &quot;subscribe&quot;</span>
<a href="#l2.46"></a><span id="l2.46"> </span>
<a href="#l2.47"></a><span id="l2.47"> /* 00e89c82-1dd2-11b2-9a1c-e75995d7d595 */</span>
<a href="#l2.48"></a><span id="l2.48"> #define NS_SUBSCRIBEDATASOURCE_CID \</span>
<a href="#l2.49"></a><span id="l2.49"> { 0x00e89c82, 0x1dd2, 0x11b2, \</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  { 0x9a, 0x1c, 0xe7, 0x59, 0x95, 0xd7, 0xd5, 0x95}} </span>
<a href="#l2.51"></a><span id="l2.51" class="difflineplus">+  { 0x9a, 0x1c, 0xe7, 0x59, 0x95, 0xd7, 0xd5, 0x95}}</span>
<a href="#l2.52"></a><span id="l2.52"> </span>
<a href="#l2.53"></a><span id="l2.53"> #define NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID \</span>
<a href="#l2.54"></a><span id="l2.54">   &quot;@mozilla.org/messenger/localfoldercompactor;1&quot;</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> /* 7d1d315c-e5c6-11d4-a5b7-0060b0fc04b7 */</span>
<a href="#l2.57"></a><span id="l2.57"> #define NS_MSGLOCALFOLDERCOMPACTOR_CID \</span>
<a href="#l2.58"></a><span id="l2.58">   {0x7d1d315c, 0xe5c6, 0x11d4, \</span>
<a href="#l2.59"></a><span id="l2.59">     {0xa5, 0xb7, 0x00,0x60, 0xb0, 0xfc, 0x04, 0xb7 }}</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineat">@@ -396,40 +396,40 @@</span>
<a href="#l2.61"></a><span id="l2.61">     {0x83, 0x87, 0x86, 0xb0, 0xae, 0xb1, 0x86, 0x3c}}</span>
<a href="#l2.62"></a><span id="l2.62"> </span>
<a href="#l2.63"></a><span id="l2.63"> /* e4603d6c-0a74-47c5-b69e-2f8876990304 */</span>
<a href="#l2.64"></a><span id="l2.64"> #define NS_MSG_GROUPDBVIEW_CID \</span>
<a href="#l2.65"></a><span id="l2.65">   {0xe4603d6c, 0x0a74, 0x47c5, \</span>
<a href="#l2.66"></a><span id="l2.66">     {0xb6, 0x9e, 0x2f, 0x88, 0x76, 0x99, 0x03, 0x04}}</span>
<a href="#l2.67"></a><span id="l2.67"> //</span>
<a href="#l2.68"></a><span id="l2.68"> // nsMsgAccountManager</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-// </span>
<a href="#l2.70"></a><span id="l2.70" class="difflineplus">+//</span>
<a href="#l2.71"></a><span id="l2.71"> #define NS_MSGOFFLINEMANAGER_CONTRACTID \</span>
<a href="#l2.72"></a><span id="l2.72">   &quot;@mozilla.org/messenger/offline-manager;1&quot;</span>
<a href="#l2.73"></a><span id="l2.73"> </span>
<a href="#l2.74"></a><span id="l2.74"> #define NS_MSGOFFLINEMANAGER_CID									\</span>
<a href="#l2.75"></a><span id="l2.75"> { /* ac6c518a-09b2-11d5-a5bf-0060b0fc04b7 */			\</span>
<a href="#l2.76"></a><span id="l2.76">  0xac6c518a, 0x09b2, 0x11d5,											\</span>
<a href="#l2.77"></a><span id="l2.77">  {0xa5, 0xbf, 0x0, 0x60, 0xb0, 0xfc, 0x04, 0xb7 }}</span>
<a href="#l2.78"></a><span id="l2.78"> </span>
<a href="#l2.79"></a><span id="l2.79"> </span>
<a href="#l2.80"></a><span id="l2.80"> //</span>
<a href="#l2.81"></a><span id="l2.81"> // nsMsgProgress</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-// </span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+//</span>
<a href="#l2.84"></a><span id="l2.84"> #define NS_MSGPROGRESS_CONTRACTID \</span>
<a href="#l2.85"></a><span id="l2.85">   &quot;@mozilla.org/messenger/progress;1&quot;</span>
<a href="#l2.86"></a><span id="l2.86"> </span>
<a href="#l2.87"></a><span id="l2.87"> #define NS_MSGPROGRESS_CID									      \</span>
<a href="#l2.88"></a><span id="l2.88"> { /* 9f4dd201-3b1f-11d5-9daa-c345c9453d3c */			\</span>
<a href="#l2.89"></a><span id="l2.89">  0x9f4dd201, 0x3b1f, 0x11d5,											\</span>
<a href="#l2.90"></a><span id="l2.90">  {0x9d, 0xaa, 0xc3, 0x45, 0xc9, 0x45, 0x3d, 0x3c }}</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92"> //</span>
<a href="#l2.93"></a><span id="l2.93"> // nsSpamSettings</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-// </span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+//</span>
<a href="#l2.96"></a><span id="l2.96"> #define NS_SPAMSETTINGS_CONTRACTID \</span>
<a href="#l2.97"></a><span id="l2.97">   &quot;@mozilla.org/messenger/spamsettings;1&quot;</span>
<a href="#l2.98"></a><span id="l2.98"> </span>
<a href="#l2.99"></a><span id="l2.99"> #define NS_SPAMSETTINGS_CID									      \</span>
<a href="#l2.100"></a><span id="l2.100"> { /* ce6038ae-e5e0-4372-9cff-2a6633333b2b */			\</span>
<a href="#l2.101"></a><span id="l2.101">  0xce6038ae, 0xe5e0, 0x4372,											\</span>
<a href="#l2.102"></a><span id="l2.102">  {0x9c, 0xff, 0x2a, 0x66, 0x33, 0x33, 0x3b, 0x2b }}</span>
<a href="#l2.103"></a><span id="l2.103"> </span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -450,36 +450,36 @@</span>
<a href="#l2.105"></a><span id="l2.105"> #define NS_MSGNOTIFICATIONSERVICE_CONTRACTID \</span>
<a href="#l2.106"></a><span id="l2.106"> &quot;@mozilla.org/messenger/msgnotificationservice;1&quot;</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108"> #define NS_MSGNOTIFICATIONSERVICE_CID \</span>
<a href="#l2.109"></a><span id="l2.109"> { /* F1F7CBCD-D5E3-45A0-AA2D-CECF1A95AB03 */ \</span>
<a href="#l2.110"></a><span id="l2.110">   0xf1f7cbcd, 0xd5e3, 0x45a0, \</span>
<a href="#l2.111"></a><span id="l2.111">   {0xaa, 0x2d, 0xce, 0xcf, 0x1a, 0x95, 0xab, 0x03}}</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-// </span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-// nsMessengerOSIntegration </span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+//</span>
<a href="#l2.116"></a><span id="l2.116" class="difflineplus">+// nsMessengerOSIntegration</span>
<a href="#l2.117"></a><span id="l2.117"> //</span>
<a href="#l2.118"></a><span id="l2.118"> #define NS_MESSENGEROSINTEGRATION_CONTRACTID \</span>
<a href="#l2.119"></a><span id="l2.119">   &quot;@mozilla.org/messenger/osintegration;1&quot;</span>
<a href="#l2.120"></a><span id="l2.120"> </span>
<a href="#l2.121"></a><span id="l2.121"> //</span>
<a href="#l2.122"></a><span id="l2.122"> // cid protocol handler</span>
<a href="#l2.123"></a><span id="l2.123"> //</span>
<a href="#l2.124"></a><span id="l2.124"> #define NS_CIDPROTOCOLHANDLER_CONTRACTID \</span>
<a href="#l2.125"></a><span id="l2.125">  NS_NETWORK_PROTOCOL_CONTRACTID_PREFIX &quot;cid&quot;</span>
<a href="#l2.126"></a><span id="l2.126"> </span>
<a href="#l2.127"></a><span id="l2.127"> #define NS_CIDPROTOCOL_CID \</span>
<a href="#l2.128"></a><span id="l2.128"> { /* b3db9392-1b15-48ba-a136-0cc3db13d87b */ \</span>
<a href="#l2.129"></a><span id="l2.129">  0xb3db9392, 0x1b15, 0x48ba,      \</span>
<a href="#l2.130"></a><span id="l2.130">  {0xa1, 0x36, 0x0c, 0xc3, 0xdb, 0x13, 0xd8, 0x7b }}</span>
<a href="#l2.131"></a><span id="l2.131"> </span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-// </span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+//</span>
<a href="#l2.134"></a><span id="l2.134"> // Mail Directory Provider</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineminus">-// </span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+//</span>
<a href="#l2.137"></a><span id="l2.137"> #define NS_MAILDIRPROVIDER_CONTRACTID \</span>
<a href="#l2.138"></a><span id="l2.138">   &quot;@mozilla.org/mail/dir-provider;1&quot;</span>
<a href="#l2.139"></a><span id="l2.139"> </span>
<a href="#l2.140"></a><span id="l2.140"> #define MAILDIRPROVIDER_CID \</span>
<a href="#l2.141"></a><span id="l2.141"> { 0x3f9bb53, 0xa680, 0x4349, \</span>
<a href="#l2.142"></a><span id="l2.142">   { 0x8d, 0xe9, 0xd2, 0x68, 0x64, 0xd9, 0xff, 0xd9 } }</span>
<a href="#l2.143"></a><span id="l2.143"> </span>
<a href="#l2.144"></a><span id="l2.144"> //</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsMsgGroupnameFlags.h</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsMsgGroupnameFlags.h</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -25,17 +25,17 @@</span>
<a href="#l3.4"></a><span id="l3.4"> 												   newsgroup. */</span>
<a href="#l3.5"></a><span id="l3.5"> #define MSG_GROUPNAME_FLAG_NEW_GROUP	0x0080  /* A newsgroup which has just</span>
<a href="#l3.6"></a><span id="l3.6"> 												   been added by the `Check</span>
<a href="#l3.7"></a><span id="l3.7"> 												   New Groups' command. */</span>
<a href="#l3.8"></a><span id="l3.8"> #define MSG_GROUPNAME_FLAG_HASCHILDREN	0x40000 /* Whether there are children</span>
<a href="#l3.9"></a><span id="l3.9"> 												  of this group.  Whether those</span>
<a href="#l3.10"></a><span id="l3.10"> 												  chilren are visible in this</span>
<a href="#l3.11"></a><span id="l3.11"> 												  list is determined by the</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-												  above &quot;ELIDED&quot; flag. </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+												  above &quot;ELIDED&quot; flag.</span>
<a href="#l3.14"></a><span id="l3.14"> 												  Setting this to the same value</span>
<a href="#l3.15"></a><span id="l3.15"> 												  as an nsMsgFolderFlags IMAP server,</span>
<a href="#l3.16"></a><span id="l3.16"> 												  since an IMAP _server_ will never</span>
<a href="#l3.17"></a><span id="l3.17"> 												  appear in the subscribe pane.  */</span>
<a href="#l3.18"></a><span id="l3.18"> #define MSG_GROUPNAME_FLAG_IMAP_PERSONAL	0x80000		/* folder is an IMAP personal folder */</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> #define MSG_GROUPNAME_FLAG_IMAP_PUBLIC		0x100000		/* folder is an IMAP public folder */</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/nsMsgSearchScopeTerm.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/nsMsgSearchScopeTerm.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -16,25 +16,25 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> class nsMsgSearchScopeTerm : public nsIMsgSearchScopeTerm</span>
<a href="#l4.8"></a><span id="l4.8"> {</span>
<a href="#l4.9"></a><span id="l4.9"> public:</span>
<a href="#l4.10"></a><span id="l4.10">   nsMsgSearchScopeTerm (nsIMsgSearchSession *, nsMsgSearchScopeValue, nsIMsgFolder *);</span>
<a href="#l4.11"></a><span id="l4.11">   nsMsgSearchScopeTerm ();</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  </span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14">   NS_DECL_ISUPPORTS</span>
<a href="#l4.15"></a><span id="l4.15">   NS_DECL_NSIMSGSEARCHSCOPETERM</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-    </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+</span>
<a href="#l4.18"></a><span id="l4.18">   nsresult TimeSlice (bool *aDone);</span>
<a href="#l4.19"></a><span id="l4.19">   nsresult InitializeAdapter (nsIArray *termList);</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  </span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+</span>
<a href="#l4.22"></a><span id="l4.22">   char *GetStatusBarName ();</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-  </span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+</span>
<a href="#l4.25"></a><span id="l4.25">   nsMsgSearchScopeValue m_attribute;</span>
<a href="#l4.26"></a><span id="l4.26">   char *m_name;</span>
<a href="#l4.27"></a><span id="l4.27">   nsCOMPtr &lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l4.28"></a><span id="l4.28">   nsCOMPtr &lt;nsIMsgSearchAdapter&gt; m_adapter;</span>
<a href="#l4.29"></a><span id="l4.29">   nsCOMPtr &lt;nsIInputStream&gt; m_inputStream; // for message bodies</span>
<a href="#l4.30"></a><span id="l4.30">   nsWeakPtr m_searchSession;</span>
<a href="#l4.31"></a><span id="l4.31">   bool m_searchServer;</span>
<a href="#l4.32"></a><span id="l4.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -34,21 +34,21 @@ static nsresult GetMessage(nsIURI *aURL,</span>
<a href="#l5.4"></a><span id="l5.4">   if (NS_FAILED(rv) || uri.IsEmpty()) {</span>
<a href="#l5.5"></a><span id="l5.5">     rv = uriURL-&gt;GetUri(getter_Copies(uri));</span>
<a href="#l5.6"></a><span id="l5.6">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.7"></a><span id="l5.7">   }</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9">   nsCOMPtr &lt;nsIMsgMessageService&gt; msgMessageService;</span>
<a href="#l5.10"></a><span id="l5.10">   rv = GetMessageServiceFromURI(uri, getter_AddRefs(msgMessageService));</span>
<a href="#l5.11"></a><span id="l5.11">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  if (!msgMessageService) </span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  if (!msgMessageService)</span>
<a href="#l5.14"></a><span id="l5.14">     return NS_ERROR_FAILURE;</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   rv = msgMessageService-&gt;MessageURIToMsgHdr(uri.get(), message);</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-  return rv; </span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  return rv;</span>
<a href="#l5.19"></a><span id="l5.19"> }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> nsCopyMessageStreamListener::nsCopyMessageStreamListener()</span>
<a href="#l5.22"></a><span id="l5.22"> {</span>
<a href="#l5.23"></a><span id="l5.23"> }</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> nsCopyMessageStreamListener::~nsCopyMessageStreamListener()</span>
<a href="#l5.26"></a><span id="l5.26"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirProvider.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -92,18 +92,18 @@ nsMailDirProvider::GetFile(const char *a</span>
<a href="#l6.4"></a><span id="l6.4"> NS_IMETHODIMP</span>
<a href="#l6.5"></a><span id="l6.5"> nsMailDirProvider::GetFiles(const char *aKey,</span>
<a href="#l6.6"></a><span id="l6.6">                             nsISimpleEnumerator **aResult)</span>
<a href="#l6.7"></a><span id="l6.7"> {</span>
<a href="#l6.8"></a><span id="l6.8">   if (strcmp(aKey, ISP_DIRECTORY_LIST) != 0)</span>
<a href="#l6.9"></a><span id="l6.9">     return NS_ERROR_FAILURE;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // The list of isp directories includes the isp directory</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  // in the current process dir (i.e. &lt;path to thunderbird.exe&gt;\isp and </span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  // &lt;path to thunderbird.exe&gt;\isp\locale </span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  // in the current process dir (i.e. &lt;path to thunderbird.exe&gt;\isp and</span>
<a href="#l6.15"></a><span id="l6.15" class="difflineplus">+  // &lt;path to thunderbird.exe&gt;\isp\locale</span>
<a href="#l6.16"></a><span id="l6.16">   // and isp and isp\locale for each active extension</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18">   nsCOMPtr&lt;nsIProperties&gt; dirSvc =</span>
<a href="#l6.19"></a><span id="l6.19">     do_GetService(NS_DIRECTORY_SERVICE_CONTRACTID);</span>
<a href="#l6.20"></a><span id="l6.20">   if (!dirSvc)</span>
<a href="#l6.21"></a><span id="l6.21">     return NS_ERROR_FAILURE;</span>
<a href="#l6.22"></a><span id="l6.22"> </span>
<a href="#l6.23"></a><span id="l6.23">   nsCOMPtr&lt;nsIFile&gt; currentProcessDir;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineat">@@ -178,17 +178,17 @@ nsMailDirProvider::AppendingEnumerator::</span>
<a href="#l6.25"></a><span id="l6.25">     {</span>
<a href="#l6.26"></a><span id="l6.26">       if (!mLocale.IsEmpty())</span>
<a href="#l6.27"></a><span id="l6.27">       {</span>
<a href="#l6.28"></a><span id="l6.28">         mNext-&gt;Clone(getter_AddRefs(mNextWithLocale));</span>
<a href="#l6.29"></a><span id="l6.29">         mNextWithLocale-&gt;AppendNative(mLocale);</span>
<a href="#l6.30"></a><span id="l6.30">         rv = mNextWithLocale-&gt;Exists(&amp;exists);</span>
<a href="#l6.31"></a><span id="l6.31">         if (NS_FAILED(rv) || !exists)</span>
<a href="#l6.32"></a><span id="l6.32">           mNextWithLocale = nullptr; // clear out mNextWithLocale, so we don't try to iterate over it</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineminus">-      } </span>
<a href="#l6.34"></a><span id="l6.34" class="difflineplus">+      }</span>
<a href="#l6.35"></a><span id="l6.35">       break;</span>
<a href="#l6.36"></a><span id="l6.36">     }</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38">     mNext = nullptr;</span>
<a href="#l6.39"></a><span id="l6.39">   }</span>
<a href="#l6.40"></a><span id="l6.40"> </span>
<a href="#l6.41"></a><span id="l6.41">   return NS_OK;</span>
<a href="#l6.42"></a><span id="l6.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/src/nsMailDirServiceDefs.h</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/src/nsMailDirServiceDefs.h</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -22,10 +22,10 @@</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5"> #define NS_APP_MAIL_50_DIR                      &quot;MailD&quot;</span>
<a href="#l7.6"></a><span id="l7.6"> #define NS_APP_IMAP_MAIL_50_DIR                 &quot;IMapMD&quot;</span>
<a href="#l7.7"></a><span id="l7.7"> #define NS_APP_NEWS_50_DIR                      &quot;NewsD&quot;</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #define NS_APP_MESSENGER_FOLDER_CACHE_50_FILE   &quot;MFCaF&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> #define ISP_DIRECTORY_LIST                 &quot;ISPDL&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-      </span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+</span>
<a href="#l7.14"></a><span id="l7.14"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -664,17 +664,17 @@ nsresult nsMessenger::SaveAttachment(nsI</span>
<a href="#l8.4"></a><span id="l8.4"> {</span>
<a href="#l8.5"></a><span id="l8.5">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l8.6"></a><span id="l8.6">   nsSaveAllAttachmentsState *saveState= (nsSaveAllAttachmentsState*) closure;</span>
<a href="#l8.7"></a><span id="l8.7">   nsCOMPtr&lt;nsIMsgMessageFetchPartService&gt; fetchService;</span>
<a href="#l8.8"></a><span id="l8.8">   nsAutoCString urlString;</span>
<a href="#l8.9"></a><span id="l8.9">   nsCOMPtr&lt;nsIURI&gt; URL;</span>
<a href="#l8.10"></a><span id="l8.10">   nsAutoCString fullMessageUri(aMessageUri);</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-  // This instance will be held onto by the listeners, and will be released once </span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+  // This instance will be held onto by the listeners, and will be released once</span>
<a href="#l8.14"></a><span id="l8.14">   // the transfer has been completed.</span>
<a href="#l8.15"></a><span id="l8.15">   RefPtr&lt;nsSaveMsgListener&gt; saveListener(new nsSaveMsgListener(aFile, this, aListener));</span>
<a href="#l8.16"></a><span id="l8.16"> </span>
<a href="#l8.17"></a><span id="l8.17">   saveListener-&gt;m_contentType = aContentType;</span>
<a href="#l8.18"></a><span id="l8.18">   if (saveState)</span>
<a href="#l8.19"></a><span id="l8.19">   {</span>
<a href="#l8.20"></a><span id="l8.20">     saveListener-&gt;m_saveAllAttachmentsState = saveState;</span>
<a href="#l8.21"></a><span id="l8.21">     if (saveState-&gt;m_detachingAttachments)</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -889,17 +889,17 @@ nsMessenger::SaveOneAttachment(const cha</span>
<a href="#l8.23"></a><span id="l8.23">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25">   SetLastSaveDirectory(localFile);</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27">   nsCString dirName;</span>
<a href="#l8.28"></a><span id="l8.28">   rv = localFile-&gt;GetNativePath(dirName);</span>
<a href="#l8.29"></a><span id="l8.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-  nsSaveAllAttachmentsState *saveState = </span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+  nsSaveAllAttachmentsState *saveState =</span>
<a href="#l8.33"></a><span id="l8.33">     new nsSaveAllAttachmentsState(1,</span>
<a href="#l8.34"></a><span id="l8.34">                                   &amp;aContentType,</span>
<a href="#l8.35"></a><span id="l8.35">                                   &amp;aURL,</span>
<a href="#l8.36"></a><span id="l8.36">                                   &amp;aDisplayName,</span>
<a href="#l8.37"></a><span id="l8.37">                                   &amp;aMessageUri,</span>
<a href="#l8.38"></a><span id="l8.38">                                   dirName.get(),</span>
<a href="#l8.39"></a><span id="l8.39">                                   detaching);</span>
<a href="#l8.40"></a><span id="l8.40"> </span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -1058,17 +1058,17 @@ nsMessenger::SaveAs(const nsACString&amp; aU</span>
<a href="#l8.42"></a><span id="l8.42">       // A null saveAsFile means that the user canceled the save as</span>
<a href="#l8.43"></a><span id="l8.43">       if (NS_FAILED(rv) || !saveAsFile)</span>
<a href="#l8.44"></a><span id="l8.44">         goto done;</span>
<a href="#l8.45"></a><span id="l8.45">     }</span>
<a href="#l8.46"></a><span id="l8.46">     else {</span>
<a href="#l8.47"></a><span id="l8.47">       saveAsFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.48"></a><span id="l8.48">       rv = saveAsFile-&gt;InitWithPath(aMsgFilename);</span>
<a href="#l8.49"></a><span id="l8.49">       if (NS_FAILED(rv))</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-        goto done;      </span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+        goto done;</span>
<a href="#l8.52"></a><span id="l8.52">       if (StringEndsWith(aMsgFilename, NS_LITERAL_STRING(TEXT_FILE_EXTENSION),</span>
<a href="#l8.53"></a><span id="l8.53">                          nsCaseInsensitiveStringComparator()))</span>
<a href="#l8.54"></a><span id="l8.54">         saveAsFileType = TEXT_FILE_TYPE;</span>
<a href="#l8.55"></a><span id="l8.55">       else if ((StringEndsWith(aMsgFilename,</span>
<a href="#l8.56"></a><span id="l8.56">                                NS_LITERAL_STRING(HTML_FILE_EXTENSION),</span>
<a href="#l8.57"></a><span id="l8.57">                                nsCaseInsensitiveStringComparator())) ||</span>
<a href="#l8.58"></a><span id="l8.58">                (StringEndsWith(aMsgFilename,</span>
<a href="#l8.59"></a><span id="l8.59">                                NS_LITERAL_STRING(HTML_FILE_EXTENSION2),</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineat">@@ -1171,17 +1171,17 @@ nsMessenger::SaveAs(const nsACString&amp; aU</span>
<a href="#l8.61"></a><span id="l8.61">     // ** save as Template</span>
<a href="#l8.62"></a><span id="l8.62">     nsCOMPtr &lt;nsIFile&gt; tmpFile;</span>
<a href="#l8.63"></a><span id="l8.63">     nsresult rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l8.64"></a><span id="l8.64">                                                   &quot;nsmail.tmp&quot;,</span>
<a href="#l8.65"></a><span id="l8.65">                                                   getter_AddRefs(tmpFile));</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.68"></a><span id="l8.68"> </span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-    // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION </span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+    // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION</span>
<a href="#l8.71"></a><span id="l8.71">     rv = tmpFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l8.72"></a><span id="l8.72">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74">     // The saveListener is owned by whoever we ultimately register the</span>
<a href="#l8.75"></a><span id="l8.75">     // listener with, generally a URL.</span>
<a href="#l8.76"></a><span id="l8.76">     saveListener = new nsSaveMsgListener(tmpFile, this, nullptr);</span>
<a href="#l8.77"></a><span id="l8.77"> </span>
<a href="#l8.78"></a><span id="l8.78">     if (aIdentity)</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineat">@@ -1640,17 +1640,17 @@ nsMessenger::GetLastDisplayedMessageUri(</span>
<a href="#l8.80"></a><span id="l8.80"> </span>
<a href="#l8.81"></a><span id="l8.81"> nsSaveMsgListener::nsSaveMsgListener(nsIFile* aFile, nsMessenger *aMessenger, nsIUrlListener *aListener)</span>
<a href="#l8.82"></a><span id="l8.82"> {</span>
<a href="#l8.83"></a><span id="l8.83">   m_file = do_QueryInterface(aFile);</span>
<a href="#l8.84"></a><span id="l8.84">   m_messenger = aMessenger;</span>
<a href="#l8.85"></a><span id="l8.85">   mListener = aListener;</span>
<a href="#l8.86"></a><span id="l8.86">   mUrlHasStopped = false;</span>
<a href="#l8.87"></a><span id="l8.87">   mRequestHasStopped = false;</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineminus">-  </span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+</span>
<a href="#l8.90"></a><span id="l8.90">     // rhp: for charset handling</span>
<a href="#l8.91"></a><span id="l8.91">   m_doCharsetConversion = false;</span>
<a href="#l8.92"></a><span id="l8.92">   m_saveAllAttachmentsState = nullptr;</span>
<a href="#l8.93"></a><span id="l8.93">   mProgress = 0;</span>
<a href="#l8.94"></a><span id="l8.94">   mMaxProgress = -1;</span>
<a href="#l8.95"></a><span id="l8.95">   mCanceled = false;</span>
<a href="#l8.96"></a><span id="l8.96">   m_outputFormat = eUnknown;</span>
<a href="#l8.97"></a><span id="l8.97">   mInitialized = false;</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -1690,17 +1690,17 @@ nsSaveMsgListener::OnStartRunningUrl(nsI</span>
<a href="#l8.99"></a><span id="l8.99"> </span>
<a href="#l8.100"></a><span id="l8.100"> NS_IMETHODIMP</span>
<a href="#l8.101"></a><span id="l8.101"> nsSaveMsgListener::OnStopRunningUrl(nsIURI *url, nsresult exitCode)</span>
<a href="#l8.102"></a><span id="l8.102"> {</span>
<a href="#l8.103"></a><span id="l8.103">   nsresult rv = exitCode;</span>
<a href="#l8.104"></a><span id="l8.104">   mUrlHasStopped = true;</span>
<a href="#l8.105"></a><span id="l8.105"> </span>
<a href="#l8.106"></a><span id="l8.106">   // ** save as template goes here</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineminus">-  if (!m_templateUri.IsEmpty()) </span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+  if (!m_templateUri.IsEmpty())</span>
<a href="#l8.109"></a><span id="l8.109">   {</span>
<a href="#l8.110"></a><span id="l8.110">     nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l8.111"></a><span id="l8.111">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.112"></a><span id="l8.112">     nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l8.113"></a><span id="l8.113">     rv = rdf-&gt;GetResource(m_templateUri, getter_AddRefs(res));</span>
<a href="#l8.114"></a><span id="l8.114">     if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.115"></a><span id="l8.115">     nsCOMPtr&lt;nsIMsgFolder&gt; templateFolder;</span>
<a href="#l8.116"></a><span id="l8.116">     templateFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineat">@@ -1727,22 +1727,22 @@ nsSaveMsgListener::OnStopRunningUrl(nsIU</span>
<a href="#l8.118"></a><span id="l8.118"> done:</span>
<a href="#l8.119"></a><span id="l8.119">   if (NS_FAILED(rv))</span>
<a href="#l8.120"></a><span id="l8.120">   {</span>
<a href="#l8.121"></a><span id="l8.121">     if (m_file)</span>
<a href="#l8.122"></a><span id="l8.122">       m_file-&gt;Remove(false);</span>
<a href="#l8.123"></a><span id="l8.123">     if (m_messenger)</span>
<a href="#l8.124"></a><span id="l8.124">         m_messenger-&gt;Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l8.125"></a><span id="l8.125">   }</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  </span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+</span>
<a href="#l8.128"></a><span id="l8.128">   if (mRequestHasStopped &amp;&amp; mListener)</span>
<a href="#l8.129"></a><span id="l8.129">     mListener-&gt;OnStopRunningUrl(url, exitCode);</span>
<a href="#l8.130"></a><span id="l8.130">   else</span>
<a href="#l8.131"></a><span id="l8.131">     mListenerUri = url;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  </span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+</span>
<a href="#l8.134"></a><span id="l8.134">   return rv;</span>
<a href="#l8.135"></a><span id="l8.135"> }</span>
<a href="#l8.136"></a><span id="l8.136"> </span>
<a href="#l8.137"></a><span id="l8.137"> NS_IMETHODIMP</span>
<a href="#l8.138"></a><span id="l8.138"> nsSaveMsgListener::OnStartCopy(void)</span>
<a href="#l8.139"></a><span id="l8.139"> {</span>
<a href="#l8.140"></a><span id="l8.140">   return NS_OK;</span>
<a href="#l8.141"></a><span id="l8.141"> }</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineat">@@ -1773,40 +1773,40 @@ nsSaveMsgListener::OnStopCopy(nsresult a</span>
<a href="#l8.143"></a><span id="l8.143">   return aStatus;</span>
<a href="#l8.144"></a><span id="l8.144"> }</span>
<a href="#l8.145"></a><span id="l8.145"> </span>
<a href="#l8.146"></a><span id="l8.146"> // initializes the progress window if we are going to show one</span>
<a href="#l8.147"></a><span id="l8.147"> // and for OSX, sets creator flags on the output file</span>
<a href="#l8.148"></a><span id="l8.148"> nsresult nsSaveMsgListener::InitializeDownload(nsIRequest * aRequest)</span>
<a href="#l8.149"></a><span id="l8.149"> {</span>
<a href="#l8.150"></a><span id="l8.150">   nsresult rv = NS_OK;</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineminus">-  </span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+</span>
<a href="#l8.153"></a><span id="l8.153">   mInitialized = true;</span>
<a href="#l8.154"></a><span id="l8.154">   nsCOMPtr&lt;nsIChannel&gt; channel (do_QueryInterface(aRequest));</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineminus">-  </span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+</span>
<a href="#l8.157"></a><span id="l8.157">   if (!channel)</span>
<a href="#l8.158"></a><span id="l8.158">     return rv;</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-  </span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+</span>
<a href="#l8.161"></a><span id="l8.161">   // Get the max progress from the URL if we haven't already got it.</span>
<a href="#l8.162"></a><span id="l8.162">   if (mMaxProgress == -1)</span>
<a href="#l8.163"></a><span id="l8.163">   {</span>
<a href="#l8.164"></a><span id="l8.164">     nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l8.165"></a><span id="l8.165">     channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l8.166"></a><span id="l8.166">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl(do_QueryInterface(uri));</span>
<a href="#l8.167"></a><span id="l8.167">     if (mailnewsUrl)</span>
<a href="#l8.168"></a><span id="l8.168">       mailnewsUrl-&gt;GetMaxProgress(&amp;mMaxProgress);</span>
<a href="#l8.169"></a><span id="l8.169">   }</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineminus">-  </span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+</span>
<a href="#l8.172"></a><span id="l8.172">   if (!m_contentType.IsEmpty())</span>
<a href="#l8.173"></a><span id="l8.173">   {</span>
<a href="#l8.174"></a><span id="l8.174">     nsCOMPtr&lt;nsIMIMEService&gt; mimeService (do_GetService(NS_MIMESERVICE_CONTRACTID));</span>
<a href="#l8.175"></a><span id="l8.175">     nsCOMPtr&lt;nsIMIMEInfo&gt; mimeinfo;</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-    </span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+</span>
<a href="#l8.178"></a><span id="l8.178">     mimeService-&gt;GetFromTypeAndExtension(m_contentType, EmptyCString(), getter_AddRefs(mimeinfo));</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineminus">-    </span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+</span>
<a href="#l8.181"></a><span id="l8.181">     // create a download progress window</span>
<a href="#l8.182"></a><span id="l8.182"> </span>
<a href="#l8.183"></a><span id="l8.183">     // Set saveToDisk explicitly to avoid launching the saved file.</span>
<a href="#l8.184"></a><span id="l8.184">     // See https://hg.mozilla.org/mozilla-central/file/814a6f071472/toolkit/components/jsdownloads/src/DownloadLegacy.js#l164</span>
<a href="#l8.185"></a><span id="l8.185">     mimeinfo-&gt;SetPreferredAction(nsIHandlerInfo::saveToDisk);</span>
<a href="#l8.186"></a><span id="l8.186"> </span>
<a href="#l8.187"></a><span id="l8.187">     // When we don't allow warnings, also don't show progress, as this</span>
<a href="#l8.188"></a><span id="l8.188">     //  is an environment (typically filters) where we don't want</span>
<a href="#l8.189"></a><span id="l8.189" class="difflineat">@@ -1815,25 +1815,25 @@ nsresult nsSaveMsgListener::InitializeDo</span>
<a href="#l8.190"></a><span id="l8.190">     if (m_saveAllAttachmentsState)</span>
<a href="#l8.191"></a><span id="l8.191">       allowProgress = !m_saveAllAttachmentsState-&gt;m_withoutWarning;</span>
<a href="#l8.192"></a><span id="l8.192">     if (allowProgress)</span>
<a href="#l8.193"></a><span id="l8.193">     {</span>
<a href="#l8.194"></a><span id="l8.194">       nsCOMPtr&lt;nsITransfer&gt; tr = do_CreateInstance(NS_TRANSFER_CONTRACTID, &amp;rv);</span>
<a href="#l8.195"></a><span id="l8.195">       if (tr &amp;&amp; m_file)</span>
<a href="#l8.196"></a><span id="l8.196">       {</span>
<a href="#l8.197"></a><span id="l8.197">         PRTime timeDownloadStarted = PR_Now();</span>
<a href="#l8.198"></a><span id="l8.198" class="difflineminus">-        </span>
<a href="#l8.199"></a><span id="l8.199" class="difflineplus">+</span>
<a href="#l8.200"></a><span id="l8.200">         nsCOMPtr&lt;nsIURI&gt; outputURI;</span>
<a href="#l8.201"></a><span id="l8.201">         NS_NewFileURI(getter_AddRefs(outputURI), m_file);</span>
<a href="#l8.202"></a><span id="l8.202" class="difflineminus">-        </span>
<a href="#l8.203"></a><span id="l8.203" class="difflineplus">+</span>
<a href="#l8.204"></a><span id="l8.204">         nsCOMPtr&lt;nsIURI&gt; url;</span>
<a href="#l8.205"></a><span id="l8.205">         channel-&gt;GetURI(getter_AddRefs(url));</span>
<a href="#l8.206"></a><span id="l8.206">         rv = tr-&gt;Init(url, outputURI, EmptyString(), mimeinfo,</span>
<a href="#l8.207"></a><span id="l8.207">                       timeDownloadStarted, nullptr, this, false);</span>
<a href="#l8.208"></a><span id="l8.208" class="difflineminus">-        </span>
<a href="#l8.209"></a><span id="l8.209" class="difflineplus">+</span>
<a href="#l8.210"></a><span id="l8.210">           // now store the web progresslistener</span>
<a href="#l8.211"></a><span id="l8.211">         mTransfer = tr;</span>
<a href="#l8.212"></a><span id="l8.212">       }</span>
<a href="#l8.213"></a><span id="l8.213">     }</span>
<a href="#l8.214"></a><span id="l8.214">   }</span>
<a href="#l8.215"></a><span id="l8.215">   return rv;</span>
<a href="#l8.216"></a><span id="l8.216"> }</span>
<a href="#l8.217"></a><span id="l8.217"> </span>
<a href="#l8.218"></a><span id="l8.218" class="difflineat">@@ -1852,17 +1852,17 @@ nsSaveMsgListener::OnStartRequest(nsIReq</span>
<a href="#l8.219"></a><span id="l8.219"> }</span>
<a href="#l8.220"></a><span id="l8.220"> </span>
<a href="#l8.221"></a><span id="l8.221"> NS_IMETHODIMP</span>
<a href="#l8.222"></a><span id="l8.222"> nsSaveMsgListener::OnStopRequest(nsIRequest* request, nsISupports* aSupport,</span>
<a href="#l8.223"></a><span id="l8.223">                                  nsresult status)</span>
<a href="#l8.224"></a><span id="l8.224"> {</span>
<a href="#l8.225"></a><span id="l8.225">   nsresult rv = NS_OK;</span>
<a href="#l8.226"></a><span id="l8.226">   mRequestHasStopped = true;</span>
<a href="#l8.227"></a><span id="l8.227" class="difflineminus">-  </span>
<a href="#l8.228"></a><span id="l8.228" class="difflineplus">+</span>
<a href="#l8.229"></a><span id="l8.229">   // rhp: If we are doing the charset conversion magic, this is different</span>
<a href="#l8.230"></a><span id="l8.230">   // processing, otherwise, its just business as usual.</span>
<a href="#l8.231"></a><span id="l8.231">   // If we need text/plain, then we need to convert the HTML and then convert</span>
<a href="#l8.232"></a><span id="l8.232">   // to the systems charset.</span>
<a href="#l8.233"></a><span id="l8.233">   if (m_doCharsetConversion &amp;&amp; m_outputStream)</span>
<a href="#l8.234"></a><span id="l8.234">   {</span>
<a href="#l8.235"></a><span id="l8.235">     // For HTML, code is emitted immediately in OnDataAvailable.</span>
<a href="#l8.236"></a><span id="l8.236">     MOZ_ASSERT(m_outputFormat == ePlainText,</span>
<a href="#l8.237"></a><span id="l8.237" class="difflineat">@@ -1881,37 +1881,37 @@ nsSaveMsgListener::OnStopRequest(nsIRequ</span>
<a href="#l8.238"></a><span id="l8.238">     if (NS_SUCCEEDED(rv))</span>
<a href="#l8.239"></a><span id="l8.239">     {</span>
<a href="#l8.240"></a><span id="l8.240">       uint32_t writeCount;</span>
<a href="#l8.241"></a><span id="l8.241">       rv = m_outputStream-&gt;Write(outCString.get(), outCString.Length(), &amp;writeCount);</span>
<a href="#l8.242"></a><span id="l8.242">       if (outCString.Length() != writeCount)</span>
<a href="#l8.243"></a><span id="l8.243">         rv = NS_ERROR_FAILURE;</span>
<a href="#l8.244"></a><span id="l8.244">     }</span>
<a href="#l8.245"></a><span id="l8.245">   }</span>
<a href="#l8.246"></a><span id="l8.246" class="difflineminus">- </span>
<a href="#l8.247"></a><span id="l8.247" class="difflineplus">+</span>
<a href="#l8.248"></a><span id="l8.248">   if (m_outputStream)</span>
<a href="#l8.249"></a><span id="l8.249">   {</span>
<a href="#l8.250"></a><span id="l8.250">     m_outputStream-&gt;Close();</span>
<a href="#l8.251"></a><span id="l8.251">     m_outputStream = nullptr;</span>
<a href="#l8.252"></a><span id="l8.252">   }</span>
<a href="#l8.253"></a><span id="l8.253" class="difflineminus">-  </span>
<a href="#l8.254"></a><span id="l8.254" class="difflineplus">+</span>
<a href="#l8.255"></a><span id="l8.255">   if (m_saveAllAttachmentsState)</span>
<a href="#l8.256"></a><span id="l8.256">   {</span>
<a href="#l8.257"></a><span id="l8.257">     m_saveAllAttachmentsState-&gt;m_curIndex++;</span>
<a href="#l8.258"></a><span id="l8.258">     if (!mCanceled &amp;&amp; m_saveAllAttachmentsState-&gt;m_curIndex &lt; m_saveAllAttachmentsState-&gt;m_count)</span>
<a href="#l8.259"></a><span id="l8.259">     {</span>
<a href="#l8.260"></a><span id="l8.260">       nsSaveAllAttachmentsState *state = m_saveAllAttachmentsState;</span>
<a href="#l8.261"></a><span id="l8.261">       uint32_t i = state-&gt;m_curIndex;</span>
<a href="#l8.262"></a><span id="l8.262">       nsString unescapedName;</span>
<a href="#l8.263"></a><span id="l8.263">       nsCOMPtr&lt;nsIFile&gt; localFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l8.264"></a><span id="l8.264">       if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.265"></a><span id="l8.265">       rv = localFile-&gt;InitWithNativePath(nsDependentCString(state-&gt;m_directoryName));</span>
<a href="#l8.266"></a><span id="l8.266" class="difflineminus">-      </span>
<a href="#l8.267"></a><span id="l8.267" class="difflineplus">+</span>
<a href="#l8.268"></a><span id="l8.268">       if (NS_FAILED(rv)) goto done;</span>
<a href="#l8.269"></a><span id="l8.269" class="difflineminus">-      </span>
<a href="#l8.270"></a><span id="l8.270" class="difflineplus">+</span>
<a href="#l8.271"></a><span id="l8.271">       ConvertAndSanitizeFileName(state-&gt;m_displayNameArray[i], unescapedName);</span>
<a href="#l8.272"></a><span id="l8.272">       rv = localFile-&gt;Append(unescapedName);</span>
<a href="#l8.273"></a><span id="l8.273">       if (NS_FAILED(rv))</span>
<a href="#l8.274"></a><span id="l8.274">         goto done;</span>
<a href="#l8.275"></a><span id="l8.275"> </span>
<a href="#l8.276"></a><span id="l8.276">       // When we are running with no warnings (typically filters and other automatic</span>
<a href="#l8.277"></a><span id="l8.277">       //  uses), then don't prompt for duplicates, but create a unique file</span>
<a href="#l8.278"></a><span id="l8.278">       //  instead.</span>
<a href="#l8.279"></a><span id="l8.279" class="difflineat">@@ -1977,17 +1977,17 @@ nsSaveMsgListener::OnDataAvailable(nsIRe</span>
<a href="#l8.280"></a><span id="l8.280">                                   nsIInputStream* inStream,</span>
<a href="#l8.281"></a><span id="l8.281">                                   uint64_t srcOffset,</span>
<a href="#l8.282"></a><span id="l8.282">                                   uint32_t count)</span>
<a href="#l8.283"></a><span id="l8.283"> {</span>
<a href="#l8.284"></a><span id="l8.284">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l8.285"></a><span id="l8.285">   // first, check to see if we've been canceled....</span>
<a href="#l8.286"></a><span id="l8.286">   if (mCanceled) // then go cancel our underlying channel too</span>
<a href="#l8.287"></a><span id="l8.287">     return request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l8.288"></a><span id="l8.288" class="difflineminus">-  </span>
<a href="#l8.289"></a><span id="l8.289" class="difflineplus">+</span>
<a href="#l8.290"></a><span id="l8.290">   if (!mInitialized)</span>
<a href="#l8.291"></a><span id="l8.291">     InitializeDownload(request);</span>
<a href="#l8.292"></a><span id="l8.292"> </span>
<a href="#l8.293"></a><span id="l8.293">   if (m_outputStream)</span>
<a href="#l8.294"></a><span id="l8.294">   {</span>
<a href="#l8.295"></a><span id="l8.295">     mProgress += count;</span>
<a href="#l8.296"></a><span id="l8.296">     uint64_t available;</span>
<a href="#l8.297"></a><span id="l8.297">     uint32_t readCount, maxReadCount = sizeof(m_dataBuffer);</span>
<a href="#l8.298"></a><span id="l8.298" class="difflineat">@@ -2868,17 +2868,17 @@ nsDelAttachListener::StartProcessing(nsM</span>
<a href="#l8.299"></a><span id="l8.299"> </span>
<a href="#l8.300"></a><span id="l8.300">   // create an output stream on a temporary file. This stream will save the modified</span>
<a href="#l8.301"></a><span id="l8.301">   // message data to a file which we will later use to replace the existing message.</span>
<a href="#l8.302"></a><span id="l8.302">   // The file is removed in the destructor.</span>
<a href="#l8.303"></a><span id="l8.303">   rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR, &quot;nsmail.tmp&quot;,</span>
<a href="#l8.304"></a><span id="l8.304">                                        getter_AddRefs(mMsgFile));</span>
<a href="#l8.305"></a><span id="l8.305">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.306"></a><span id="l8.306"> </span>
<a href="#l8.307"></a><span id="l8.307" class="difflineminus">-  // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION </span>
<a href="#l8.308"></a><span id="l8.308" class="difflineplus">+  // For temp file, we should use restrictive 00600 instead of ATTACHMENT_PERMISSION</span>
<a href="#l8.309"></a><span id="l8.309">   rv = mMsgFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l8.310"></a><span id="l8.310">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l8.311"></a><span id="l8.311"> </span>
<a href="#l8.312"></a><span id="l8.312">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mMsgFileStream), mMsgFile, -1, ATTACHMENT_PERMISSION);</span>
<a href="#l8.313"></a><span id="l8.313"> </span>
<a href="#l8.314"></a><span id="l8.314">   // create the additional header for data conversion. This will tell the stream converter</span>
<a href="#l8.315"></a><span id="l8.315">   // which MIME emitter we want to use, and it will tell the MIME emitter which attachments</span>
<a href="#l8.316"></a><span id="l8.316">   // should be deleted.</span>
<a href="#l8.317"></a><span id="l8.317" class="difflineat">@@ -2965,17 +2965,17 @@ nsMessenger::DetachAttachments(uint32_t </span>
<a href="#l8.318"></a><span id="l8.318">                                const char ** aDisplayNameArray,</span>
<a href="#l8.319"></a><span id="l8.319">                                const char ** aMessageUriArray,</span>
<a href="#l8.320"></a><span id="l8.320">                                nsTArray&lt;nsCString&gt; *saveFileUris,</span>
<a href="#l8.321"></a><span id="l8.321">                                bool withoutWarning)</span>
<a href="#l8.322"></a><span id="l8.322"> {</span>
<a href="#l8.323"></a><span id="l8.323">   // if withoutWarning no dialog for user</span>
<a href="#l8.324"></a><span id="l8.324">   if (!withoutWarning &amp;&amp; NS_FAILED(PromptIfDeleteAttachments(saveFileUris != nullptr, aCount, aDisplayNameArray)))</span>
<a href="#l8.325"></a><span id="l8.325">       return NS_OK;</span>
<a href="#l8.326"></a><span id="l8.326" class="difflineminus">-  </span>
<a href="#l8.327"></a><span id="l8.327" class="difflineplus">+</span>
<a href="#l8.328"></a><span id="l8.328">   nsresult rv = NS_OK;</span>
<a href="#l8.329"></a><span id="l8.329"> </span>
<a href="#l8.330"></a><span id="l8.330">   // ensure that our arguments are valid</span>
<a href="#l8.331"></a><span id="l8.331"> //  char * partId;</span>
<a href="#l8.332"></a><span id="l8.332">   for (uint32_t u = 0; u &lt; aCount; ++u)</span>
<a href="#l8.333"></a><span id="l8.333">   {</span>
<a href="#l8.334"></a><span id="l8.334">     // ensure all of the message URI are the same, we cannot process</span>
<a href="#l8.335"></a><span id="l8.335">     // attachments from different messages</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -22,24 +22,24 @@</span>
<a href="#l9.4"></a><span id="l9.4"> #include &quot;nsIFolderListener.h&quot;</span>
<a href="#l9.5"></a><span id="l9.5"> </span>
<a href="#l9.6"></a><span id="l9.6"> class nsMessenger : public nsIMessenger, public nsSupportsWeakReference, public nsIFolderListener</span>
<a href="#l9.7"></a><span id="l9.7"> {</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9"> public:</span>
<a href="#l9.10"></a><span id="l9.10">   nsMessenger();</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  NS_DECL_ISUPPORTS  </span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l9.14"></a><span id="l9.14">   NS_DECL_NSIMESSENGER</span>
<a href="#l9.15"></a><span id="l9.15">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17">   nsresult Alert(const char * stringName);</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   nsresult SaveAttachment(nsIFile *file, const nsACString&amp; unescapedUrl,</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-                          const nsACString&amp; messageUri, const nsACString&amp; contentType, </span>
<a href="#l9.21"></a><span id="l9.21" class="difflineplus">+                          const nsACString&amp; messageUri, const nsACString&amp; contentType,</span>
<a href="#l9.22"></a><span id="l9.22">                           void *closure, nsIUrlListener *aListener);</span>
<a href="#l9.23"></a><span id="l9.23">   nsresult PromptIfFileExists(nsIFile *file);</span>
<a href="#l9.24"></a><span id="l9.24">   nsresult DetachAttachments(uint32_t aCount,</span>
<a href="#l9.25"></a><span id="l9.25">                              const char ** aContentTypeArray,</span>
<a href="#l9.26"></a><span id="l9.26">                              const char ** aUrlArray,</span>
<a href="#l9.27"></a><span id="l9.27">                              const char ** aDisplayNameArray,</span>
<a href="#l9.28"></a><span id="l9.28">                              const char ** aMessageUriArray,</span>
<a href="#l9.29"></a><span id="l9.29">                              nsTArray&lt;nsCString&gt; *saveFileUris,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -65,17 +65,17 @@ NS_IMETHODIMP nsMessengerBootstrap::Open</span>
<a href="#l10.4"></a><span id="l10.4">     if (!standAloneMsgWindow)</span>
<a href="#l10.5"></a><span id="l10.5">     {</span>
<a href="#l10.6"></a><span id="l10.6">       nsCOMPtr&lt;nsISupportsPRUint32&gt; scriptableMessageKey (do_CreateInstance(NS_SUPPORTS_PRUINT32_CONTRACTID));</span>
<a href="#l10.7"></a><span id="l10.7">       NS_ENSURE_TRUE(scriptableMessageKey, NS_ERROR_FAILURE);</span>
<a href="#l10.8"></a><span id="l10.8">       scriptableMessageKey-&gt;SetData(aMessageKey);</span>
<a href="#l10.9"></a><span id="l10.9">       argsArray-&gt;AppendElement(scriptableMessageKey, false);</span>
<a href="#l10.10"></a><span id="l10.10">     }</span>
<a href="#l10.11"></a><span id="l10.11">   }</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  </span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14">   nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID, &amp;rv));</span>
<a href="#l10.15"></a><span id="l10.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17">   // we need to use the &quot;mailnews.reuse_thread_window2&quot; pref</span>
<a href="#l10.18"></a><span id="l10.18">   // to determine if we should open a new window, or use an existing one.</span>
<a href="#l10.19"></a><span id="l10.19">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l10.20"></a><span id="l10.20">   return wwatch-&gt;OpenWindow(0, chromeUrl.get(), &quot;_blank&quot;,</span>
<a href="#l10.21"></a><span id="l10.21">                             &quot;chrome,all,dialog=no&quot;, argsArray,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerBootstrap.h</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -16,16 +16,16 @@</span>
<a href="#l11.4"></a><span id="l11.4">   {0xb7, 0xf6, 0x00, 0x80, 0x5f, 0x05, 0xff, 0xa5}}</span>
<a href="#l11.5"></a><span id="l11.5"> </span>
<a href="#l11.6"></a><span id="l11.6"> class nsMessengerBootstrap :</span>
<a href="#l11.7"></a><span id="l11.7">     public nsIMessengerWindowService</span>
<a href="#l11.8"></a><span id="l11.8"> {</span>
<a href="#l11.9"></a><span id="l11.9"> public:</span>
<a href="#l11.10"></a><span id="l11.10">   nsMessengerBootstrap();</span>
<a href="#l11.11"></a><span id="l11.11"> </span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS  </span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l11.14"></a><span id="l11.14">   NS_DECL_NSIMESSENGERWINDOWSERVICE</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16"> private:</span>
<a href="#l11.17"></a><span id="l11.17">   virtual ~nsMessengerBootstrap();</span>
<a href="#l11.18"></a><span id="l11.18"> };</span>
<a href="#l11.19"></a><span id="l11.19"> </span>
<a href="#l11.20"></a><span id="l11.20"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerContentHandler.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -64,17 +64,17 @@ NS_IMETHODIMP nsMessengerContentHandler:</span>
<a href="#l12.4"></a><span id="l12.4"> </span>
<a href="#l12.5"></a><span id="l12.5">   return rv;</span>
<a href="#l12.6"></a><span id="l12.6"> }</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> // Utility function to open a message display window and and load the message in it.</span>
<a href="#l12.9"></a><span id="l12.9"> nsresult nsMessengerContentHandler::OpenWindow(nsIURI* aURI)</span>
<a href="#l12.10"></a><span id="l12.10"> {</span>
<a href="#l12.11"></a><span id="l12.11">   NS_ENSURE_ARG_POINTER(aURI);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  </span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+</span>
<a href="#l12.14"></a><span id="l12.14">   nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch = do_GetService(&quot;@mozilla.org/embedcomp/window-watcher;1&quot;);</span>
<a href="#l12.15"></a><span id="l12.15">   if (!wwatch)</span>
<a href="#l12.16"></a><span id="l12.16">     return NS_ERROR_FAILURE;</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; newWindow;</span>
<a href="#l12.19"></a><span id="l12.19">   return wwatch-&gt;OpenWindow(0, &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l12.20"></a><span id="l12.20">                  &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;, aURI,</span>
<a href="#l12.21"></a><span id="l12.21">                  getter_AddRefs(newWindow));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerContentHandler.h</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerContentHandler.h</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -5,16 +5,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsIContentHandler.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsIURI.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> class nsMessengerContentHandler : public nsIContentHandler</span>
<a href="#l13.9"></a><span id="l13.9"> {</span>
<a href="#l13.10"></a><span id="l13.10"> public:</span>
<a href="#l13.11"></a><span id="l13.11">   nsMessengerContentHandler();</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-  </span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14">   NS_DECL_ISUPPORTS</span>
<a href="#l13.15"></a><span id="l13.15">   NS_DECL_NSICONTENTHANDLER</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-    </span>
<a href="#l13.17"></a><span id="l13.17" class="difflineplus">+</span>
<a href="#l13.18"></a><span id="l13.18"> private:</span>
<a href="#l13.19"></a><span id="l13.19">   virtual ~nsMessengerContentHandler();</span>
<a href="#l13.20"></a><span id="l13.20">   nsresult OpenWindow(nsIURI* aURI);</span>
<a href="#l13.21"></a><span id="l13.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsMessengerWinIntegration.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsMessengerWinIntegration.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -18,17 +18,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsString.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> </span>
<a href="#l14.8"></a><span id="l14.8"> #define NS_MESSENGERWININTEGRATION_CID \</span>
<a href="#l14.9"></a><span id="l14.9">   {0xf62f3d3a, 0x1dd1, 0x11b2, \</span>
<a href="#l14.10"></a><span id="l14.10">     {0xa5, 0x16, 0xef, 0xad, 0xb1, 0x31, 0x61, 0x5c}}</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-class nsIStringBundle; </span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+class nsIStringBundle;</span>
<a href="#l14.14"></a><span id="l14.14"> </span>
<a href="#l14.15"></a><span id="l14.15"> class nsMessengerWinIntegration : public nsIMessengerOSIntegration,</span>
<a href="#l14.16"></a><span id="l14.16">                                   public nsIFolderListener,</span>
<a href="#l14.17"></a><span id="l14.17">                                   public nsIObserver</span>
<a href="#l14.18"></a><span id="l14.18"> {</span>
<a href="#l14.19"></a><span id="l14.19"> public:</span>
<a href="#l14.20"></a><span id="l14.20">   nsMessengerWinIntegration();</span>
<a href="#l14.21"></a><span id="l14.21">   virtual nsresult Init();</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineat">@@ -46,33 +46,33 @@ public:</span>
<a href="#l14.23"></a><span id="l14.23"> private:</span>
<a href="#l14.24"></a><span id="l14.24">   virtual ~nsMessengerWinIntegration();</span>
<a href="#l14.25"></a><span id="l14.25">   nsresult AlertFinished();</span>
<a href="#l14.26"></a><span id="l14.26">   nsresult AlertClicked();</span>
<a href="#l14.27"></a><span id="l14.27"> #ifdef MOZ_SUITE</span>
<a href="#l14.28"></a><span id="l14.28">   nsresult AlertClickedSimple();</span>
<a href="#l14.29"></a><span id="l14.29"> #endif</span>
<a href="#l14.30"></a><span id="l14.30"> </span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-  void InitializeBiffStatusIcon(); </span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+  void InitializeBiffStatusIcon();</span>
<a href="#l14.33"></a><span id="l14.33">   void FillToolTipInfo();</span>
<a href="#l14.34"></a><span id="l14.34">   void GenericShellNotify(DWORD aMessage);</span>
<a href="#l14.35"></a><span id="l14.35">   void DestroyBiffIcon();</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37">   nsresult GetFirstFolderWithNewMail(nsACString&amp; aFolderURI);</span>
<a href="#l14.38"></a><span id="l14.38"> </span>
<a href="#l14.39"></a><span id="l14.39">   nsresult GetStringBundle(nsIStringBundle **aBundle);</span>
<a href="#l14.40"></a><span id="l14.40">   nsCOMPtr&lt;nsIMutableArray&gt; mFoldersWithNewMail;  // keep track of all the root folders with pending new mail</span>
<a href="#l14.41"></a><span id="l14.41">   uint32_t mCurrentBiffState;</span>
<a href="#l14.42"></a><span id="l14.42"> </span>
<a href="#l14.43"></a><span id="l14.43">   bool mBiffIconVisible;</span>
<a href="#l14.44"></a><span id="l14.44">   bool mBiffIconInitialized;</span>
<a href="#l14.45"></a><span id="l14.45">   bool mSuppressBiffIcon;</span>
<a href="#l14.46"></a><span id="l14.46">   bool mAlertInProgress;</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-  </span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-  // &quot;might&quot; because we don't know until we check </span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+  // &quot;might&quot; because we don't know until we check</span>
<a href="#l14.51"></a><span id="l14.51">   // what type of server is associated with the default account</span>
<a href="#l14.52"></a><span id="l14.52">   bool            mDefaultAccountMightHaveAnInbox;</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">   // True if the timer is running</span>
<a href="#l14.55"></a><span id="l14.55">   bool mUnreadTimerActive;</span>
<a href="#l14.56"></a><span id="l14.56"> </span>
<a href="#l14.57"></a><span id="l14.57">   nsresult ResetCurrent();</span>
<a href="#l14.58"></a><span id="l14.58">   nsresult RemoveCurrentFromRegistry();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.h</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -1,14 +1,14 @@</span>
<a href="#l15.4"></a><span id="l15.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l15.5"></a><span id="l15.5">  *</span>
<a href="#l15.6"></a><span id="l15.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l15.7"></a><span id="l15.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l15.8"></a><span id="l15.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l15.9"></a><span id="l15.9" class="difflineminus">- * This Original Code has been modified by IBM Corporation. Modifications made by IBM </span>
<a href="#l15.10"></a><span id="l15.10" class="difflineplus">+ * This Original Code has been modified by IBM Corporation. Modifications made by IBM</span>
<a href="#l15.11"></a><span id="l15.11">  * described herein are Copyright (c) International Business Machines Corporation, 2000.</span>
<a href="#l15.12"></a><span id="l15.12">  * Modifications to Mozilla code or documentation identified per MPL Section 3.3</span>
<a href="#l15.13"></a><span id="l15.13">  *</span>
<a href="#l15.14"></a><span id="l15.14">  * Date             Modified by     Description of modification</span>
<a href="#l15.15"></a><span id="l15.15">  * 04/20/2000       IBM Corp.      OS/2 VisualAge build.</span>
<a href="#l15.16"></a><span id="l15.16">  */</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> #include &quot;nscore.h&quot;</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineat">@@ -66,23 +66,23 @@ class nsMsgAccountManager: public nsIMsg</span>
<a href="#l15.20"></a><span id="l15.20">     public nsIObserver,</span>
<a href="#l15.21"></a><span id="l15.21">     public nsSupportsWeakReference,</span>
<a href="#l15.22"></a><span id="l15.22">     public nsIUrlListener,</span>
<a href="#l15.23"></a><span id="l15.23">     public nsIFolderListener</span>
<a href="#l15.24"></a><span id="l15.24"> {</span>
<a href="#l15.25"></a><span id="l15.25"> public:</span>
<a href="#l15.26"></a><span id="l15.26"> </span>
<a href="#l15.27"></a><span id="l15.27">   nsMsgAccountManager();</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineminus">-  </span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+</span>
<a href="#l15.30"></a><span id="l15.30">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l15.31"></a><span id="l15.31" class="difflineminus">- </span>
<a href="#l15.32"></a><span id="l15.32" class="difflineplus">+</span>
<a href="#l15.33"></a><span id="l15.33">   /* nsIMsgAccountManager methods */</span>
<a href="#l15.34"></a><span id="l15.34" class="difflineminus">-  </span>
<a href="#l15.35"></a><span id="l15.35" class="difflineplus">+</span>
<a href="#l15.36"></a><span id="l15.36">   NS_DECL_NSIMSGACCOUNTMANAGER</span>
<a href="#l15.37"></a><span id="l15.37" class="difflineminus">-  NS_DECL_NSIOBSERVER  </span>
<a href="#l15.38"></a><span id="l15.38" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l15.39"></a><span id="l15.39">   NS_DECL_NSIURLLISTENER</span>
<a href="#l15.40"></a><span id="l15.40">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">   nsresult Init();</span>
<a href="#l15.43"></a><span id="l15.43">   nsresult Shutdown();</span>
<a href="#l15.44"></a><span id="l15.44">   void LogoutOfServer(nsIMsgIncomingServer *aServer);</span>
<a href="#l15.45"></a><span id="l15.45"> </span>
<a href="#l15.46"></a><span id="l15.46"> private:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManagerDS.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManagerDS.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -219,25 +219,25 @@ nsMsgAccountManagerDataSource::Init()</span>
<a href="#l16.4"></a><span id="l16.4">   nsresult rv;</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6">   rv = nsMsgRDFDataSource::Init();</span>
<a href="#l16.7"></a><span id="l16.7">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9">   nsCOMPtr&lt;nsIMsgAccountManager&gt; am;</span>
<a href="#l16.10"></a><span id="l16.10"> </span>
<a href="#l16.11"></a><span id="l16.11">   // get a weak ref to the account manager</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-  if (!mAccountManager) </span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+  if (!mAccountManager)</span>
<a href="#l16.14"></a><span id="l16.14">   {</span>
<a href="#l16.15"></a><span id="l16.15">     am = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l16.16"></a><span id="l16.16">     mAccountManager = do_GetWeakReference(am);</span>
<a href="#l16.17"></a><span id="l16.17">   }</span>
<a href="#l16.18"></a><span id="l16.18">   else</span>
<a href="#l16.19"></a><span id="l16.19">     am = do_QueryReferent(mAccountManager);</span>
<a href="#l16.20"></a><span id="l16.20"> </span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-  if (am) </span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+  if (am)</span>
<a href="#l16.23"></a><span id="l16.23">   {</span>
<a href="#l16.24"></a><span id="l16.24">     am-&gt;AddIncomingServerListener(this);</span>
<a href="#l16.25"></a><span id="l16.25">     am-&gt;AddRootFolderListener(this);</span>
<a href="#l16.26"></a><span id="l16.26">   }</span>
<a href="#l16.27"></a><span id="l16.27"> </span>
<a href="#l16.28"></a><span id="l16.28"> </span>
<a href="#l16.29"></a><span id="l16.29">   return NS_OK;</span>
<a href="#l16.30"></a><span id="l16.30"> }</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineat">@@ -264,17 +264,17 @@ nsMsgAccountManagerDataSource::GetTarget</span>
<a href="#l16.32"></a><span id="l16.32"> {</span>
<a href="#l16.33"></a><span id="l16.33">   nsresult rv;</span>
<a href="#l16.34"></a><span id="l16.34"> </span>
<a href="#l16.35"></a><span id="l16.35"> </span>
<a href="#l16.36"></a><span id="l16.36">   rv = NS_RDF_NO_VALUE;</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38">   nsAutoString str;</span>
<a href="#l16.39"></a><span id="l16.39">   if (property == kNC_Name || property == kNC_FolderTreeName ||</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-      property == kNC_FolderTreeSimpleName) </span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+      property == kNC_FolderTreeSimpleName)</span>
<a href="#l16.42"></a><span id="l16.42">   {</span>
<a href="#l16.43"></a><span id="l16.43">     rv = getStringBundle();</span>
<a href="#l16.44"></a><span id="l16.44">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.45"></a><span id="l16.45"> </span>
<a href="#l16.46"></a><span id="l16.46">     nsString pageTitle;</span>
<a href="#l16.47"></a><span id="l16.47">     if (source == kNC_PageTitleServer)</span>
<a href="#l16.48"></a><span id="l16.48">       mStringBundle-&gt;GetStringFromName(&quot;prefPanel-server&quot;, pageTitle);</span>
<a href="#l16.49"></a><span id="l16.49"> </span>
<a href="#l16.50"></a><span id="l16.50" class="difflineat">@@ -360,17 +360,17 @@ nsMsgAccountManagerDataSource::GetTarget</span>
<a href="#l16.51"></a><span id="l16.51">     else {</span>
<a href="#l16.52"></a><span id="l16.52">       nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(source, &amp;rv);</span>
<a href="#l16.53"></a><span id="l16.53">       if (NS_SUCCEEDED(rv) &amp;&amp; folder) {</span>
<a href="#l16.54"></a><span id="l16.54">         /* if this is a server, with no identities, then we show a special panel */</span>
<a href="#l16.55"></a><span id="l16.55">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l16.56"></a><span id="l16.56">         rv = getServerForFolderNode(source, getter_AddRefs(server));</span>
<a href="#l16.57"></a><span id="l16.57">         if (server)</span>
<a href="#l16.58"></a><span id="l16.58">           server-&gt;GetAccountManagerChrome(str);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-        else </span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+        else</span>
<a href="#l16.61"></a><span id="l16.61">           str.AssignLiteral(&quot;am-main.xul&quot;);</span>
<a href="#l16.62"></a><span id="l16.62">       }</span>
<a href="#l16.63"></a><span id="l16.63">       else {</span>
<a href="#l16.64"></a><span id="l16.64">         // allow for the accountmanager to be dynamically extended</span>
<a href="#l16.65"></a><span id="l16.65">         const char *sourceValue;</span>
<a href="#l16.66"></a><span id="l16.66">         rv = source-&gt;GetValueConst(&amp;sourceValue);</span>
<a href="#l16.67"></a><span id="l16.67">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.68"></a><span id="l16.68"> </span>
<a href="#l16.69"></a><span id="l16.69" class="difflineat">@@ -703,17 +703,17 @@ nsMsgAccountManagerDataSource::createSet</span>
<a href="#l16.70"></a><span id="l16.70">     rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l16.71"></a><span id="l16.71">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73">     bool supportsDiskSpace;</span>
<a href="#l16.74"></a><span id="l16.74">     rv = server-&gt;GetSupportsDiskSpace(&amp;supportsDiskSpace);</span>
<a href="#l16.75"></a><span id="l16.75">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l16.76"></a><span id="l16.76"> </span>
<a href="#l16.77"></a><span id="l16.77">     // currently there is no offline without diskspace</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineminus">-    if (offlineSupportLevel &gt;= OFFLINE_SUPPORT_LEVEL_REGULAR) </span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+    if (offlineSupportLevel &gt;= OFFLINE_SUPPORT_LEVEL_REGULAR)</span>
<a href="#l16.80"></a><span id="l16.80">       aNodeArray-&gt;AppendObject(kNC_PageTitleSynchronization);</span>
<a href="#l16.81"></a><span id="l16.81">     else if (supportsDiskSpace)</span>
<a href="#l16.82"></a><span id="l16.82">       aNodeArray-&gt;AppendObject(kNC_PageTitleDiskSpace);</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84">     if (hasIdentities) {</span>
<a href="#l16.85"></a><span id="l16.85">       // extensions come after the default panels</span>
<a href="#l16.86"></a><span id="l16.86">       rv = appendGenericSettingsResources(server, aNodeArray);</span>
<a href="#l16.87"></a><span id="l16.87">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed to add generic panels&quot;);</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineat">@@ -1037,21 +1037,21 @@ nsMsgAccountManagerDataSource::isContain</span>
<a href="#l16.89"></a><span id="l16.89"> </span>
<a href="#l16.90"></a><span id="l16.90"> // returns failure if the object is not a root server</span>
<a href="#l16.91"></a><span id="l16.91"> nsresult</span>
<a href="#l16.92"></a><span id="l16.92"> nsMsgAccountManagerDataSource::getServerForFolderNode(nsIRDFNode *aResource,</span>
<a href="#l16.93"></a><span id="l16.93">                                                       nsIMsgIncomingServer **aResult)</span>
<a href="#l16.94"></a><span id="l16.94"> {</span>
<a href="#l16.95"></a><span id="l16.95">   nsresult rv;</span>
<a href="#l16.96"></a><span id="l16.96">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(aResource, &amp;rv);</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineminus">-  if (NS_SUCCEEDED(rv)) </span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l16.99"></a><span id="l16.99">   {</span>
<a href="#l16.100"></a><span id="l16.100">     bool isServer;</span>
<a href="#l16.101"></a><span id="l16.101">     rv = folder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; isServer) </span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; isServer)</span>
<a href="#l16.104"></a><span id="l16.104">       return folder-&gt;GetServer(aResult);</span>
<a href="#l16.105"></a><span id="l16.105">   }</span>
<a href="#l16.106"></a><span id="l16.106">   return NS_ERROR_FAILURE;</span>
<a href="#l16.107"></a><span id="l16.107"> }</span>
<a href="#l16.108"></a><span id="l16.108"> </span>
<a href="#l16.109"></a><span id="l16.109"> nsresult</span>
<a href="#l16.110"></a><span id="l16.110"> nsMsgAccountManagerDataSource::getStringBundle()</span>
<a href="#l16.111"></a><span id="l16.111"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManagerDS.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManagerDS.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -27,23 +27,23 @@</span>
<a href="#l17.4"></a><span id="l17.4">     {0x96, 0x9d, 0x00, 0x60, 0x08, 0x94, 0x80, 0x10}}</span>
<a href="#l17.5"></a><span id="l17.5"> </span>
<a href="#l17.6"></a><span id="l17.6"> class nsMsgAccountManagerDataSource : public nsMsgRDFDataSource,</span>
<a href="#l17.7"></a><span id="l17.7">                                       public nsIFolderListener,</span>
<a href="#l17.8"></a><span id="l17.8">                                       public nsIIncomingServerListener</span>
<a href="#l17.9"></a><span id="l17.9"> {</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11"> public:</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-    </span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+</span>
<a href="#l17.14"></a><span id="l17.14">   nsMsgAccountManagerDataSource();</span>
<a href="#l17.15"></a><span id="l17.15">   virtual nsresult Init() override;</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17">   virtual void Cleanup() override;</span>
<a href="#l17.18"></a><span id="l17.18">   // service manager shutdown method</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-  </span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+</span>
<a href="#l17.21"></a><span id="l17.21">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l17.22"></a><span id="l17.22">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l17.23"></a><span id="l17.23">   NS_DECL_NSIINCOMINGSERVERLISTENER</span>
<a href="#l17.24"></a><span id="l17.24">   NS_DECL_NSIOBSERVER</span>
<a href="#l17.25"></a><span id="l17.25">   // RDF datasource methods</span>
<a href="#l17.26"></a><span id="l17.26">   NS_IMETHOD GetTarget(nsIRDFResource *source,</span>
<a href="#l17.27"></a><span id="l17.27">                        nsIRDFResource *property,</span>
<a href="#l17.28"></a><span id="l17.28">                        bool aTruthValue,</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineat">@@ -55,38 +55,38 @@ public:</span>
<a href="#l17.30"></a><span id="l17.30">   NS_IMETHOD ArcLabelsOut(nsIRDFResource *source,</span>
<a href="#l17.31"></a><span id="l17.31">                           nsISimpleEnumerator **_retval) override;</span>
<a href="#l17.32"></a><span id="l17.32"> </span>
<a href="#l17.33"></a><span id="l17.33">   NS_IMETHOD HasAssertion(nsIRDFResource *aSource, nsIRDFResource *aProperty,</span>
<a href="#l17.34"></a><span id="l17.34">                           nsIRDFNode *aTarget, bool aTruthValue,</span>
<a href="#l17.35"></a><span id="l17.35">                           bool *_retval) override;</span>
<a href="#l17.36"></a><span id="l17.36">   NS_IMETHOD HasArcOut(nsIRDFResource *source, nsIRDFResource *aArc,</span>
<a href="#l17.37"></a><span id="l17.37">                        bool *result) override;</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-    </span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+</span>
<a href="#l17.40"></a><span id="l17.40"> protected:</span>
<a href="#l17.41"></a><span id="l17.41">   virtual ~nsMsgAccountManagerDataSource();</span>
<a href="#l17.42"></a><span id="l17.42"> </span>
<a href="#l17.43"></a><span id="l17.43">   nsresult HasAssertionServer(nsIMsgIncomingServer *aServer,</span>
<a href="#l17.44"></a><span id="l17.44">                               nsIRDFResource *aProperty,</span>
<a href="#l17.45"></a><span id="l17.45">                               nsIRDFNode *aTarget,</span>
<a href="#l17.46"></a><span id="l17.46">                               bool aTruthValue, bool *_retval);</span>
<a href="#l17.47"></a><span id="l17.47"> </span>
<a href="#l17.48"></a><span id="l17.48">   nsresult HasAssertionAccountRoot(nsIRDFResource *aProperty,</span>
<a href="#l17.49"></a><span id="l17.49">                                    nsIRDFNode *aTarget,</span>
<a href="#l17.50"></a><span id="l17.50">                                    bool aTruthValue, bool *_retval);</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  </span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+</span>
<a href="#l17.53"></a><span id="l17.53">   bool isDefaultServer(nsIMsgIncomingServer *aServer);</span>
<a href="#l17.54"></a><span id="l17.54">   bool supportsFilters(nsIMsgIncomingServer *aServer);</span>
<a href="#l17.55"></a><span id="l17.55">   bool canGetMessages(nsIMsgIncomingServer *aServer);</span>
<a href="#l17.56"></a><span id="l17.56">   bool canGetIncomingMessages(nsIMsgIncomingServer *aServer);</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineminus">-  </span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+</span>
<a href="#l17.59"></a><span id="l17.59">   static bool isContainment(nsIRDFResource *aProperty);</span>
<a href="#l17.60"></a><span id="l17.60">   nsresult getServerForFolderNode(nsIRDFNode *aResource,</span>
<a href="#l17.61"></a><span id="l17.61">                                   nsIMsgIncomingServer **aResult);</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineminus">-  </span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+</span>
<a href="#l17.64"></a><span id="l17.64">   nsresult createRootResources(nsIRDFResource *aProperty,</span>
<a href="#l17.65"></a><span id="l17.65">                                nsCOMArray&lt;nsIRDFResource&gt; *aNodeArray);</span>
<a href="#l17.66"></a><span id="l17.66">   nsresult createSettingsResources(nsIRDFResource *aSource,</span>
<a href="#l17.67"></a><span id="l17.67">                                    nsCOMArray&lt;nsIRDFResource&gt; *aNodeArray);</span>
<a href="#l17.68"></a><span id="l17.68">   nsresult appendGenericSettingsResources(nsIMsgIncomingServer *server,\</span>
<a href="#l17.69"></a><span id="l17.69">                                           nsCOMArray&lt;nsIRDFResource&gt; *aNodeArray);</span>
<a href="#l17.70"></a><span id="l17.70">   nsresult appendGenericSetting(const char *name,</span>
<a href="#l17.71"></a><span id="l17.71">                                 nsCOMArray&lt;nsIRDFResource&gt; *aNodeArray);</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineat">@@ -96,20 +96,20 @@ protected:</span>
<a href="#l17.73"></a><span id="l17.73">   static nsIRDFResource* kNC_FolderTreeSimpleName;</span>
<a href="#l17.74"></a><span id="l17.74">   static nsIRDFResource* kNC_NameSort;</span>
<a href="#l17.75"></a><span id="l17.75">   static nsIRDFResource* kNC_FolderTreeNameSort;</span>
<a href="#l17.76"></a><span id="l17.76">   static nsIRDFResource* kNC_PageTag;</span>
<a href="#l17.77"></a><span id="l17.77">   static nsIRDFResource* kNC_IsDefaultServer;</span>
<a href="#l17.78"></a><span id="l17.78">   static nsIRDFResource* kNC_SupportsFilters;</span>
<a href="#l17.79"></a><span id="l17.79">   static nsIRDFResource* kNC_CanGetMessages;</span>
<a href="#l17.80"></a><span id="l17.80">   static nsIRDFResource* kNC_CanGetIncomingMessages;</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineminus">-  </span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+</span>
<a href="#l17.83"></a><span id="l17.83">   static nsIRDFResource* kNC_Child;</span>
<a href="#l17.84"></a><span id="l17.84">   static nsIRDFResource* kNC_AccountRoot;</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineminus">-  </span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+</span>
<a href="#l17.87"></a><span id="l17.87">   static nsIRDFResource* kNC_Account;</span>
<a href="#l17.88"></a><span id="l17.88">   static nsIRDFResource* kNC_Server;</span>
<a href="#l17.89"></a><span id="l17.89">   static nsIRDFResource* kNC_Identity;</span>
<a href="#l17.90"></a><span id="l17.90">   static nsIRDFResource* kNC_Settings;</span>
<a href="#l17.91"></a><span id="l17.91">   static nsIRDFResource* kNC_Junk;</span>
<a href="#l17.92"></a><span id="l17.92"> </span>
<a href="#l17.93"></a><span id="l17.93">   static nsIRDFResource* kNC_PageTitleMain;</span>
<a href="#l17.94"></a><span id="l17.94">   static nsIRDFResource* kNC_PageTitleServer;</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineat">@@ -121,17 +121,17 @@ protected:</span>
<a href="#l17.96"></a><span id="l17.96">   static nsIRDFResource* kNC_PageTitleJunk;</span>
<a href="#l17.97"></a><span id="l17.97"> </span>
<a href="#l17.98"></a><span id="l17.98">   static nsIRDFLiteral* kTrueLiteral;</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100">   static nsrefcnt gAccountManagerResourceRefCnt;</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">   static nsresult getAccountArcs(nsIMutableArray **aResult);</span>
<a href="#l17.103"></a><span id="l17.103">   static nsresult getAccountRootArcs(nsIMutableArray **aResult);</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineminus">-  </span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+</span>
<a href="#l17.106"></a><span id="l17.106"> private:</span>
<a href="#l17.107"></a><span id="l17.107">   nsresult serverHasIdentities(nsIMsgIncomingServer *aServer, bool *aResult);</span>
<a href="#l17.108"></a><span id="l17.108">   nsresult getStringBundle();</span>
<a href="#l17.109"></a><span id="l17.109"> </span>
<a href="#l17.110"></a><span id="l17.110">   static nsCOMPtr&lt;nsIMutableArray&gt; mAccountArcsOut;</span>
<a href="#l17.111"></a><span id="l17.111">   static nsCOMPtr&lt;nsIMutableArray&gt; mAccountRootArcsOut;</span>
<a href="#l17.112"></a><span id="l17.112">   nsWeakPtr mAccountManager;</span>
<a href="#l17.113"></a><span id="l17.113">   nsCOMPtr&lt;nsIStringBundle&gt; mStringBundle;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -61,45 +61,45 @@ nsMsgBiffManager::~nsMsgBiffManager()</span>
<a href="#l18.4"></a><span id="l18.4"> NS_IMETHODIMP nsMsgBiffManager::Init()</span>
<a href="#l18.5"></a><span id="l18.5"> {</span>
<a href="#l18.6"></a><span id="l18.6">   if (mInited)</span>
<a href="#l18.7"></a><span id="l18.7">     return NS_OK;</span>
<a href="#l18.8"></a><span id="l18.8"> </span>
<a href="#l18.9"></a><span id="l18.9">   mInited = true;</span>
<a href="#l18.10"></a><span id="l18.10">   nsresult rv;</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.14"></a><span id="l18.14">   do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.15"></a><span id="l18.15">   if (NS_SUCCEEDED(rv))</span>
<a href="#l18.16"></a><span id="l18.16">     accountManager-&gt;AddIncomingServerListener(this);</span>
<a href="#l18.17"></a><span id="l18.17"> </span>
<a href="#l18.18"></a><span id="l18.18">   // in turbo mode on profile change we don't need to do anything below this</span>
<a href="#l18.19"></a><span id="l18.19">   if (mHaveShutdown)</span>
<a href="#l18.20"></a><span id="l18.20">   {</span>
<a href="#l18.21"></a><span id="l18.21">     mHaveShutdown = false;</span>
<a href="#l18.22"></a><span id="l18.22">     return NS_OK;</span>
<a href="#l18.23"></a><span id="l18.23">   }</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25">   // Ensure status bar biff service has started</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-  nsCOMPtr&lt;nsIFolderListener&gt; statusBarBiffService = </span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+  nsCOMPtr&lt;nsIFolderListener&gt; statusBarBiffService =</span>
<a href="#l18.28"></a><span id="l18.28">     do_GetService(kStatusBarBiffManagerCID, &amp;rv);</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l18.31"></a><span id="l18.31">     mozilla::services::GetObserverService();</span>
<a href="#l18.32"></a><span id="l18.32">   if (observerService)</span>
<a href="#l18.33"></a><span id="l18.33">   {</span>
<a href="#l18.34"></a><span id="l18.34">     observerService-&gt;AddObserver(this, &quot;sleep_notification&quot;, true);</span>
<a href="#l18.35"></a><span id="l18.35">     observerService-&gt;AddObserver(this, &quot;wake_notification&quot;, true);</span>
<a href="#l18.36"></a><span id="l18.36">   }</span>
<a href="#l18.37"></a><span id="l18.37">   return NS_OK;</span>
<a href="#l18.38"></a><span id="l18.38"> }</span>
<a href="#l18.39"></a><span id="l18.39"> </span>
<a href="#l18.40"></a><span id="l18.40"> NS_IMETHODIMP nsMsgBiffManager::Shutdown()</span>
<a href="#l18.41"></a><span id="l18.41"> {</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineminus">-  if (mBiffTimer) </span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+  if (mBiffTimer)</span>
<a href="#l18.44"></a><span id="l18.44">   {</span>
<a href="#l18.45"></a><span id="l18.45">     mBiffTimer-&gt;Cancel();</span>
<a href="#l18.46"></a><span id="l18.46">     mBiffTimer = nullptr;</span>
<a href="#l18.47"></a><span id="l18.47">   }</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">   nsresult rv;</span>
<a href="#l18.50"></a><span id="l18.50">   nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l18.51"></a><span id="l18.51">     do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineat">@@ -314,17 +314,17 @@ nsresult nsMsgBiffManager::PerformBiff()</span>
<a href="#l18.53"></a><span id="l18.53">   {</span>
<a href="#l18.54"></a><span id="l18.54">     // Take a copy of the entry rather than the a reference so that we can</span>
<a href="#l18.55"></a><span id="l18.55">     // remove and add if necessary, but keep the references and memory alive.</span>
<a href="#l18.56"></a><span id="l18.56">     nsBiffEntry current = mBiffArray[i];</span>
<a href="#l18.57"></a><span id="l18.57">     if (current.nextBiffTime &lt; currentTime)</span>
<a href="#l18.58"></a><span id="l18.58">     {</span>
<a href="#l18.59"></a><span id="l18.59">       bool serverBusy = false;</span>
<a href="#l18.60"></a><span id="l18.60">       bool serverRequiresPassword = true;</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-      bool passwordPromptRequired; </span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+      bool passwordPromptRequired;</span>
<a href="#l18.63"></a><span id="l18.63"> </span>
<a href="#l18.64"></a><span id="l18.64">       current.server-&gt;GetPasswordPromptRequired(&amp;passwordPromptRequired);</span>
<a href="#l18.65"></a><span id="l18.65">       current.server-&gt;GetServerBusy(&amp;serverBusy);</span>
<a href="#l18.66"></a><span id="l18.66">       current.server-&gt;GetServerRequiresPasswordForBiff(&amp;serverRequiresPassword);</span>
<a href="#l18.67"></a><span id="l18.67">       // find the dest folder we're actually downloading to...</span>
<a href="#l18.68"></a><span id="l18.68">       nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l18.69"></a><span id="l18.69">       current.server-&gt;GetRootMsgFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l18.70"></a><span id="l18.70">       int32_t targetFolderIndex = targetFolders.IndexOfObject(rootMsgFolder);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/src/nsMsgBiffManager.h</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgBiffManager.h</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -23,17 +23,17 @@ typedef struct {</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> class nsMsgBiffManager</span>
<a href="#l19.6"></a><span id="l19.6">   : public nsIMsgBiffManager,</span>
<a href="#l19.7"></a><span id="l19.7">     public nsIIncomingServerListener,</span>
<a href="#l19.8"></a><span id="l19.8">     public nsIObserver,</span>
<a href="#l19.9"></a><span id="l19.9">     public nsSupportsWeakReference</span>
<a href="#l19.10"></a><span id="l19.10"> {</span>
<a href="#l19.11"></a><span id="l19.11"> public:</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-  nsMsgBiffManager(); </span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+  nsMsgBiffManager();</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15">   NS_DECL_ISUPPORTS</span>
<a href="#l19.16"></a><span id="l19.16">   NS_DECL_NSIMSGBIFFMANAGER</span>
<a href="#l19.17"></a><span id="l19.17">   NS_DECL_NSIINCOMINGSERVERLISTENER</span>
<a href="#l19.18"></a><span id="l19.18">   NS_DECL_NSIOBSERVER</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">   nsresult PerformBiff();</span>
<a href="#l19.21"></a><span id="l19.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> /**********************************************************************************</span>
<a href="#l20.9"></a><span id="l20.9">  * nsMsgContentPolicy enforces the specified content policy on images, js, plugins, etc.</span>
<a href="#l20.10"></a><span id="l20.10">  * This is the class used to determine what elements in a message should be loaded.</span>
<a href="#l20.11"></a><span id="l20.11">  *</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">- * nsMsgCookiePolicy enforces our cookie policy for mail and RSS messages. </span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ * nsMsgCookiePolicy enforces our cookie policy for mail and RSS messages.</span>
<a href="#l20.14"></a><span id="l20.14">  ***********************************************************************************/</span>
<a href="#l20.15"></a><span id="l20.15"> </span>
<a href="#l20.16"></a><span id="l20.16"> #ifndef _nsMsgContentPolicy_H_</span>
<a href="#l20.17"></a><span id="l20.17"> #define _nsMsgContentPolicy_H_</span>
<a href="#l20.18"></a><span id="l20.18"> </span>
<a href="#l20.19"></a><span id="l20.19"> #include &quot;nsIContentPolicy.h&quot;</span>
<a href="#l20.20"></a><span id="l20.20"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l20.21"></a><span id="l20.21"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -39,23 +39,23 @@ class nsMsgContentPolicy : public nsICon</span>
<a href="#l20.23"></a><span id="l20.23">                            public nsIWebProgressListener,</span>
<a href="#l20.24"></a><span id="l20.24">                            public nsIMsgContentPolicy,</span>
<a href="#l20.25"></a><span id="l20.25">                            public nsSupportsWeakReference</span>
<a href="#l20.26"></a><span id="l20.26"> {</span>
<a href="#l20.27"></a><span id="l20.27"> public:</span>
<a href="#l20.28"></a><span id="l20.28">   nsMsgContentPolicy();</span>
<a href="#l20.29"></a><span id="l20.29"> </span>
<a href="#l20.30"></a><span id="l20.30">   nsresult Init();</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-    </span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+</span>
<a href="#l20.33"></a><span id="l20.33">   NS_DECL_ISUPPORTS</span>
<a href="#l20.34"></a><span id="l20.34">   NS_DECL_NSICONTENTPOLICY</span>
<a href="#l20.35"></a><span id="l20.35">   NS_DECL_NSIOBSERVER</span>
<a href="#l20.36"></a><span id="l20.36">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l20.37"></a><span id="l20.37">   NS_DECL_NSIMSGCONTENTPOLICY</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineminus">-  </span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+</span>
<a href="#l20.40"></a><span id="l20.40"> protected:</span>
<a href="#l20.41"></a><span id="l20.41">   virtual ~nsMsgContentPolicy();</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43">   bool     mBlockRemoteImages;</span>
<a href="#l20.44"></a><span id="l20.44">   nsCString mTrustedMailDomains;</span>
<a href="#l20.45"></a><span id="l20.45">   nsCOMPtr&lt;nsIPermissionManager&gt; mPermissionManager;</span>
<a href="#l20.46"></a><span id="l20.46"> </span>
<a href="#l20.47"></a><span id="l20.47">   bool IsTrustedDomain(nsIURI * aContentLocation);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineat">@@ -67,17 +67,17 @@ protected:</span>
<a href="#l20.49"></a><span id="l20.49">   bool ShouldAcceptRemoteContentForSender(nsIMsgDBHdr *aMsgHdr);</span>
<a href="#l20.50"></a><span id="l20.50">   int16_t ShouldAcceptRemoteContentForMsgHdr(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l20.51"></a><span id="l20.51">                                              nsIURI *aRequestingLocation,</span>
<a href="#l20.52"></a><span id="l20.52">                                              nsIURI *aContentLocation);</span>
<a href="#l20.53"></a><span id="l20.53">   void ShouldAcceptContentForPotentialMsg(nsIURI *aOriginatorLocation,</span>
<a href="#l20.54"></a><span id="l20.54">                                           nsIURI *aContentLocation,</span>
<a href="#l20.55"></a><span id="l20.55">                                           int16_t *aDecision);</span>
<a href="#l20.56"></a><span id="l20.56">   void ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-                         nsISupports *aRequestingContext, </span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+                         nsISupports *aRequestingContext,</span>
<a href="#l20.59"></a><span id="l20.59">                          nsIURI *aContentLocation, int16_t *aDecision);</span>
<a href="#l20.60"></a><span id="l20.60">   already_AddRefed&lt;nsIMsgCompose&gt; GetMsgComposeForContext(nsISupports *aRequestingContext);</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">   nsresult GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l20.63"></a><span id="l20.63">                                      nsIDocShell **aDocShell);</span>
<a href="#l20.64"></a><span id="l20.64">   nsresult GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l20.65"></a><span id="l20.65">                                        nsIURI **aURI);</span>
<a href="#l20.66"></a><span id="l20.66">   nsresult SetDisableItemsOnMailNewsUrlDocshells(nsIURI *aContentLocation,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -64,17 +64,17 @@ nsCopyRequest::~nsCopyRequest()</span>
<a href="#l21.4"></a><span id="l21.4">   int32_t j = m_copySourceArray.Length();</span>
<a href="#l21.5"></a><span id="l21.5">   while(j-- &gt; 0)</span>
<a href="#l21.6"></a><span id="l21.6">     delete m_copySourceArray.ElementAt(j);</span>
<a href="#l21.7"></a><span id="l21.7"> }</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9"> nsresult</span>
<a href="#l21.10"></a><span id="l21.10"> nsCopyRequest::Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l21.11"></a><span id="l21.11">                     nsIMsgFolder* dstFolder,</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-                    bool bVal, uint32_t newMsgFlags, </span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+                    bool bVal, uint32_t newMsgFlags,</span>
<a href="#l21.14"></a><span id="l21.14">                     const nsACString &amp;newMsgKeywords,</span>
<a href="#l21.15"></a><span id="l21.15">                     nsIMsgCopyServiceListener* listener,</span>
<a href="#l21.16"></a><span id="l21.16">                     nsIMsgWindow* msgWindow, bool allowUndo)</span>
<a href="#l21.17"></a><span id="l21.17"> {</span>
<a href="#l21.18"></a><span id="l21.18">   nsresult rv = NS_OK;</span>
<a href="#l21.19"></a><span id="l21.19">   m_requestType = type;</span>
<a href="#l21.20"></a><span id="l21.20">   m_srcSupport = aSupport;</span>
<a href="#l21.21"></a><span id="l21.21">   m_dstFolder = dstFolder;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineat">@@ -167,17 +167,17 @@ void nsMsgCopyService::LogCopyRequest(co</span>
<a href="#l21.23"></a><span id="l21.23"> }</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25"> nsresult</span>
<a href="#l21.26"></a><span id="l21.26"> nsMsgCopyService::ClearRequest(nsCopyRequest* aRequest, nsresult rv)</span>
<a href="#l21.27"></a><span id="l21.27"> {</span>
<a href="#l21.28"></a><span id="l21.28">   if (aRequest)</span>
<a href="#l21.29"></a><span id="l21.29">   {</span>
<a href="#l21.30"></a><span id="l21.30">     if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineminus">-      LogCopyRequest(NS_SUCCEEDED(rv) ? &quot;Clearing OK request&quot; </span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+      LogCopyRequest(NS_SUCCEEDED(rv) ? &quot;Clearing OK request&quot;</span>
<a href="#l21.33"></a><span id="l21.33">                                       : &quot;Clearing failed request&quot;, aRequest);</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">     // Send notifications to nsIMsgFolderListeners</span>
<a href="#l21.36"></a><span id="l21.36">     if (NS_SUCCEEDED(rv) &amp;&amp; aRequest-&gt;m_requestType == nsCopyFoldersType)</span>
<a href="#l21.37"></a><span id="l21.37">     {</span>
<a href="#l21.38"></a><span id="l21.38">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l21.39"></a><span id="l21.39">       if (notifier)</span>
<a href="#l21.40"></a><span id="l21.40">       {</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineat">@@ -360,17 +360,17 @@ nsMsgCopyService::DoNextCopy()</span>
<a href="#l21.42"></a><span id="l21.42">             }</span>
<a href="#l21.43"></a><span id="l21.43">           }</span>
<a href="#l21.44"></a><span id="l21.44">       }</span>
<a href="#l21.45"></a><span id="l21.45">     }</span>
<a href="#l21.46"></a><span id="l21.46">     return rv;</span>
<a href="#l21.47"></a><span id="l21.47"> }</span>
<a href="#l21.48"></a><span id="l21.48"> </span>
<a href="#l21.49"></a><span id="l21.49"> /**</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">- * Find a request in m_copyRequests which matches the passed in source </span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+ * Find a request in m_copyRequests which matches the passed in source</span>
<a href="#l21.52"></a><span id="l21.52">  * and destination folders.</span>
<a href="#l21.53"></a><span id="l21.53">  *</span>
<a href="#l21.54"></a><span id="l21.54">  * @param aSupport the iSupports of the source folder.</span>
<a href="#l21.55"></a><span id="l21.55">  * @param dstFolder the destination folder of the copy request.</span>
<a href="#l21.56"></a><span id="l21.56">  */</span>
<a href="#l21.57"></a><span id="l21.57"> nsCopyRequest*</span>
<a href="#l21.58"></a><span id="l21.58"> nsMsgCopyService::FindRequest(nsISupports* aSupport,</span>
<a href="#l21.59"></a><span id="l21.59">                               nsIMsgFolder* dstFolder)</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineat">@@ -475,17 +475,17 @@ nsMsgCopyService::CopyMessages(nsIMsgFol</span>
<a href="#l21.61"></a><span id="l21.61"> </span>
<a href="#l21.62"></a><span id="l21.62">   copyRequest = new nsCopyRequest();</span>
<a href="#l21.63"></a><span id="l21.63">   if (!copyRequest)</span>
<a href="#l21.64"></a><span id="l21.64">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l21.65"></a><span id="l21.65"> </span>
<a href="#l21.66"></a><span id="l21.66">   aSupport = do_QueryInterface(srcFolder, &amp;rv);</span>
<a href="#l21.67"></a><span id="l21.67"> </span>
<a href="#l21.68"></a><span id="l21.68">   rv = copyRequest-&gt;Init(nsCopyMessagesType, aSupport, dstFolder, isMove,</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineminus">-                        0 /* new msg flags, not used */, EmptyCString(), </span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+                        0 /* new msg flags, not used */, EmptyCString(),</span>
<a href="#l21.71"></a><span id="l21.71">                         listener, window, allowUndo);</span>
<a href="#l21.72"></a><span id="l21.72">   if (NS_FAILED(rv))</span>
<a href="#l21.73"></a><span id="l21.73">     goto done;</span>
<a href="#l21.74"></a><span id="l21.74"> </span>
<a href="#l21.75"></a><span id="l21.75">   if (MOZ_LOG_TEST(gCopyServiceLog, mozilla::LogLevel::Info))</span>
<a href="#l21.76"></a><span id="l21.76">     LogCopyRequest(&quot;CopyMessages request&quot;, copyRequest);</span>
<a href="#l21.77"></a><span id="l21.77"> </span>
<a href="#l21.78"></a><span id="l21.78">   // duplicate the message array so we could sort the messages by it's</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgCopyService.h</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -33,25 +33,25 @@ public:</span>
<a href="#l22.4"></a><span id="l22.4">     ~nsCopySource();</span>
<a href="#l22.5"></a><span id="l22.5">     void AddMessage(nsIMsgDBHdr* aMsg);</span>
<a href="#l22.6"></a><span id="l22.6"> </span>
<a href="#l22.7"></a><span id="l22.7">     nsCOMPtr&lt;nsIMsgFolder&gt; m_msgFolder;</span>
<a href="#l22.8"></a><span id="l22.8">     nsCOMPtr&lt;nsIMutableArray&gt; m_messageArray;</span>
<a href="#l22.9"></a><span id="l22.9">     bool m_processed;</span>
<a href="#l22.10"></a><span id="l22.10"> };</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-class nsCopyRequest </span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+class nsCopyRequest</span>
<a href="#l22.14"></a><span id="l22.14"> {</span>
<a href="#l22.15"></a><span id="l22.15"> public:</span>
<a href="#l22.16"></a><span id="l22.16">     nsCopyRequest();</span>
<a href="#l22.17"></a><span id="l22.17">     ~nsCopyRequest();</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19">     nsresult Init(nsCopyRequestType type, nsISupports* aSupport,</span>
<a href="#l22.20"></a><span id="l22.20">                   nsIMsgFolder* dstFolder,</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-                  bool bVal, uint32_t newMsgFlags, </span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+                  bool bVal, uint32_t newMsgFlags,</span>
<a href="#l22.23"></a><span id="l22.23">                   const nsACString &amp;newMsgKeywords,</span>
<a href="#l22.24"></a><span id="l22.24">                   nsIMsgCopyServiceListener* listener,</span>
<a href="#l22.25"></a><span id="l22.25">                   nsIMsgWindow *msgWindow, bool allowUndo);</span>
<a href="#l22.26"></a><span id="l22.26">     nsCopySource* AddNewCopySource(nsIMsgFolder* srcFolder);</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28">     nsCOMPtr&lt;nsISupports&gt; m_srcSupport; // ui source folder or file spec</span>
<a href="#l22.29"></a><span id="l22.29">     nsCOMPtr&lt;nsIMsgFolder&gt; m_dstFolder;</span>
<a href="#l22.30"></a><span id="l22.30">     nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineat">@@ -67,17 +67,17 @@ public:</span>
<a href="#l22.32"></a><span id="l22.32">     nsTArray&lt;nsCopySource*&gt; m_copySourceArray; // array of nsCopySource</span>
<a href="#l22.33"></a><span id="l22.33"> };</span>
<a href="#l22.34"></a><span id="l22.34"> </span>
<a href="#l22.35"></a><span id="l22.35"> class nsMsgCopyService : public nsIMsgCopyService</span>
<a href="#l22.36"></a><span id="l22.36"> {</span>
<a href="#l22.37"></a><span id="l22.37"> public:</span>
<a href="#l22.38"></a><span id="l22.38">   nsMsgCopyService();</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-  NS_DECL_THREADSAFE_ISUPPORTS </span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+  NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l22.42"></a><span id="l22.42"> </span>
<a href="#l22.43"></a><span id="l22.43">   NS_DECL_NSIMSGCOPYSERVICE</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45"> private:</span>
<a href="#l22.46"></a><span id="l22.46">   virtual ~nsMsgCopyService();</span>
<a href="#l22.47"></a><span id="l22.47"> </span>
<a href="#l22.48"></a><span id="l22.48">   nsresult ClearRequest(nsCopyRequest* aRequest, nsresult rv);</span>
<a href="#l22.49"></a><span id="l22.49">   nsresult DoCopy(nsCopyRequest* aRequest);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineat">@@ -86,9 +86,9 @@ private:</span>
<a href="#l22.51"></a><span id="l22.51">   nsresult QueueRequest(nsCopyRequest* aRequest, bool *aCopyImmediately);</span>
<a href="#l22.52"></a><span id="l22.52">   void LogCopyCompletion(nsISupports *aSrc, nsIMsgFolder *aDest);</span>
<a href="#l22.53"></a><span id="l22.53">   void LogCopyRequest(const char *logMsg, nsCopyRequest* aRequest);</span>
<a href="#l22.54"></a><span id="l22.54"> </span>
<a href="#l22.55"></a><span id="l22.55">   nsTArray&lt;nsCopyRequest*&gt; m_copyRequests;</span>
<a href="#l22.56"></a><span id="l22.56"> };</span>
<a href="#l22.57"></a><span id="l22.57"> </span>
<a href="#l22.58"></a><span id="l22.58"> </span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-#endif </span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -137,17 +137,17 @@ protected:</span>
<a href="#l23.4"></a><span id="l23.4">   bool           mSuppressMsgDisplay; // set when the message pane is collapsed</span>
<a href="#l23.5"></a><span id="l23.5">   bool           mSuppressCommandUpdating;</span>
<a href="#l23.6"></a><span id="l23.6">   bool           mRemovingRow; // set when we're telling the outline a row is being removed. used to suppress msg loading.</span>
<a href="#l23.7"></a><span id="l23.7">                         // during delete/move operations.</span>
<a href="#l23.8"></a><span id="l23.8">   bool          mCommandsNeedDisablingBecauseOfSelection;</span>
<a href="#l23.9"></a><span id="l23.9">   bool          mSuppressChangeNotification;</span>
<a href="#l23.10"></a><span id="l23.10">   bool          mGoForwardEnabled;</span>
<a href="#l23.11"></a><span id="l23.11">   bool          mGoBackEnabled;</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-  </span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+</span>
<a href="#l23.14"></a><span id="l23.14">   virtual const char * GetViewName(void) {return &quot;MsgDBView&quot;; }</span>
<a href="#l23.15"></a><span id="l23.15">   nsresult FetchAuthor(nsIMsgDBHdr * aHdr, nsAString &amp;aAuthorString);</span>
<a href="#l23.16"></a><span id="l23.16">   nsresult FetchRecipients(nsIMsgDBHdr * aHdr, nsAString &amp;aRecipientsString);</span>
<a href="#l23.17"></a><span id="l23.17">   nsresult FetchSubject(nsIMsgDBHdr * aMsgHdr, uint32_t aFlags, nsAString &amp;aValue);</span>
<a href="#l23.18"></a><span id="l23.18">   nsresult FetchDate(nsIMsgDBHdr * aHdr, nsAString &amp; aDateString, bool rcvDate = false);</span>
<a href="#l23.19"></a><span id="l23.19">   nsresult FetchStatus(uint32_t aFlags, nsAString &amp;aStatusString);</span>
<a href="#l23.20"></a><span id="l23.20">   nsresult FetchSize(nsIMsgDBHdr * aHdr, nsAString &amp; aSizeString);</span>
<a href="#l23.21"></a><span id="l23.21">   nsresult FetchPriority(nsIMsgDBHdr *aHdr, nsAString &amp; aPriorityString);</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineat">@@ -163,27 +163,27 @@ protected:</span>
<a href="#l23.23"></a><span id="l23.23">   // The default enumerator is over the db, but things like</span>
<a href="#l23.24"></a><span id="l23.24">   // quick search views will enumerate just the displayed messages.</span>
<a href="#l23.25"></a><span id="l23.25">   virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator);</span>
<a href="#l23.26"></a><span id="l23.26">   // this is a message enumerator that enumerates based on the view contents</span>
<a href="#l23.27"></a><span id="l23.27">   virtual nsresult GetViewEnumerator(nsISimpleEnumerator **enumerator);</span>
<a href="#l23.28"></a><span id="l23.28"> </span>
<a href="#l23.29"></a><span id="l23.29">   // Save and Restore Selection are a pair of routines you should</span>
<a href="#l23.30"></a><span id="l23.30">   // use when performing an operation which is going to change the view</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  // and you want to remember the selection. (i.e. for sorting). </span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+  // and you want to remember the selection. (i.e. for sorting).</span>
<a href="#l23.33"></a><span id="l23.33">   // Call SaveAndClearSelection and we'll give you an array of msg keys for</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineminus">-  // the current selection. We also freeze and clear the selection. </span>
<a href="#l23.35"></a><span id="l23.35" class="difflineminus">-  // When you are done changing the view, </span>
<a href="#l23.36"></a><span id="l23.36" class="difflineplus">+  // the current selection. We also freeze and clear the selection.</span>
<a href="#l23.37"></a><span id="l23.37" class="difflineplus">+  // When you are done changing the view,</span>
<a href="#l23.38"></a><span id="l23.38">   // call RestoreSelection passing in the same array</span>
<a href="#l23.39"></a><span id="l23.39">   // and we'll restore the selection AND unfreeze selection in the UI.</span>
<a href="#l23.40"></a><span id="l23.40">   nsresult SaveAndClearSelection(nsMsgKey *aCurrentMsgKey, nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray);</span>
<a href="#l23.41"></a><span id="l23.41">   nsresult RestoreSelection(nsMsgKey aCurrentmsgKey, nsTArray&lt;nsMsgKey&gt; &amp;aMsgKeyArray);</span>
<a href="#l23.42"></a><span id="l23.42"> </span>
<a href="#l23.43"></a><span id="l23.43">   // this is not safe to use when you have a selection</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineminus">-  // RowCountChanged() will call AdjustSelection() </span>
<a href="#l23.45"></a><span id="l23.45" class="difflineplus">+  // RowCountChanged() will call AdjustSelection()</span>
<a href="#l23.46"></a><span id="l23.46">   // it should be called after SaveAndClearSelection() and before</span>
<a href="#l23.47"></a><span id="l23.47">   // RestoreSelection()</span>
<a href="#l23.48"></a><span id="l23.48">   nsresult AdjustRowCount(int32_t rowCountBeforeSort, int32_t rowCountAfterSort);</span>
<a href="#l23.49"></a><span id="l23.49"> </span>
<a href="#l23.50"></a><span id="l23.50">   nsresult GetSelectedIndices(nsMsgViewIndexArray&amp; selection);</span>
<a href="#l23.51"></a><span id="l23.51">   nsresult GenerateURIForMsgKey(nsMsgKey aMsgKey, nsIMsgFolder *folder, nsACString &amp;aURI);</span>
<a href="#l23.52"></a><span id="l23.52"> // routines used in building up view</span>
<a href="#l23.53"></a><span id="l23.53">   virtual bool WantsThisThread(nsIMsgThread * thread);</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineat">@@ -196,17 +196,17 @@ protected:</span>
<a href="#l23.55"></a><span id="l23.55">   nsMsgViewIndex GetIndexForThread(nsIMsgDBHdr *hdr);</span>
<a href="#l23.56"></a><span id="l23.56">   nsMsgViewIndex GetThreadRootIndex(nsIMsgDBHdr *msgHdr);</span>
<a href="#l23.57"></a><span id="l23.57">   virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr);</span>
<a href="#l23.58"></a><span id="l23.58">   // given a view index, return the index of the top-level msg in the thread.</span>
<a href="#l23.59"></a><span id="l23.59">   nsMsgViewIndex GetThreadIndex(nsMsgViewIndex msgIndex);</span>
<a href="#l23.60"></a><span id="l23.60"> </span>
<a href="#l23.61"></a><span id="l23.61">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l23.62"></a><span id="l23.62">                               nsMsgKey msgKey, uint32_t flags, uint32_t level);</span>
<a href="#l23.63"></a><span id="l23.63" class="difflineminus">-  virtual void SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index, </span>
<a href="#l23.64"></a><span id="l23.64" class="difflineplus">+  virtual void SetMsgHdrAt(nsIMsgDBHdr *hdr, nsMsgViewIndex index,</span>
<a href="#l23.65"></a><span id="l23.65">                               nsMsgKey msgKey, uint32_t flags, uint32_t level);</span>
<a href="#l23.66"></a><span id="l23.66">   virtual bool InsertEmptyRows(nsMsgViewIndex viewIndex, int32_t numRows);</span>
<a href="#l23.67"></a><span id="l23.67">   virtual void RemoveRows(nsMsgViewIndex viewIndex, int32_t numRows);</span>
<a href="#l23.68"></a><span id="l23.68">   nsresult ToggleExpansion(nsMsgViewIndex index, uint32_t *numChanged);</span>
<a href="#l23.69"></a><span id="l23.69">   nsresult ExpandByIndex(nsMsgViewIndex index, uint32_t *pNumExpanded);</span>
<a href="#l23.70"></a><span id="l23.70">   nsresult CollapseByIndex(nsMsgViewIndex index, uint32_t *pNumCollapsed);</span>
<a href="#l23.71"></a><span id="l23.71">   nsresult ExpandAll();</span>
<a href="#l23.72"></a><span id="l23.72">   nsresult CollapseAll();</span>
<a href="#l23.73"></a><span id="l23.73" class="difflineat">@@ -337,17 +337,17 @@ protected:</span>
<a href="#l23.74"></a><span id="l23.74">   static int FnSortIdUint32(const void *pItem1, const void *pItem2, void *privateData);</span>
<a href="#l23.75"></a><span id="l23.75"> </span>
<a href="#l23.76"></a><span id="l23.76">   nsresult GetStatusSortValue(nsIMsgDBHdr *msgHdr, uint32_t *result);</span>
<a href="#l23.77"></a><span id="l23.77">   nsresult GetLocationCollationKey(nsIMsgDBHdr *msgHdr, uint8_t **result, uint32_t *len);</span>
<a href="#l23.78"></a><span id="l23.78">   void PushSort(const MsgViewSortColumnInfo &amp;newSort);</span>
<a href="#l23.79"></a><span id="l23.79">   nsresult EncodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l23.80"></a><span id="l23.80">   nsresult DecodeColumnSort(nsString &amp;columnSortString);</span>
<a href="#l23.81"></a><span id="l23.81">   // for view navigation</span>
<a href="#l23.82"></a><span id="l23.82" class="difflineminus">-  nsresult NavigateFromPos(nsMsgNavigationTypeValue motion, nsMsgViewIndex startIndex, nsMsgKey *pResultKey, </span>
<a href="#l23.83"></a><span id="l23.83" class="difflineplus">+  nsresult NavigateFromPos(nsMsgNavigationTypeValue motion, nsMsgViewIndex startIndex, nsMsgKey *pResultKey,</span>
<a href="#l23.84"></a><span id="l23.84">               nsMsgViewIndex *pResultIndex, nsMsgViewIndex *pThreadIndex, bool wrap);</span>
<a href="#l23.85"></a><span id="l23.85">   nsresult FindNextFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex);</span>
<a href="#l23.86"></a><span id="l23.86">   nsresult FindFirstNew(nsMsgViewIndex *pResultIndex);</span>
<a href="#l23.87"></a><span id="l23.87">   nsresult FindPrevUnread(nsMsgKey startKey, nsMsgKey *pResultKey, nsMsgKey *resultThreadId);</span>
<a href="#l23.88"></a><span id="l23.88">   nsresult FindFirstFlagged(nsMsgViewIndex *pResultIndex);</span>
<a href="#l23.89"></a><span id="l23.89">   nsresult FindPrevFlagged(nsMsgViewIndex startIndex, nsMsgViewIndex *pResultIndex);</span>
<a href="#l23.90"></a><span id="l23.90">   nsresult MarkThreadOfMsgRead(nsMsgKey msgId, nsMsgViewIndex msgIndex, nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead);</span>
<a href="#l23.91"></a><span id="l23.91">   nsresult MarkThreadRead(nsIMsgThread *threadHdr, nsMsgViewIndex threadIndex, nsTArray&lt;nsMsgKey&gt; &amp;idsMarkedRead, bool bRead);</span>
<a href="#l23.92"></a><span id="l23.92" class="difflineat">@@ -382,17 +382,17 @@ protected:</span>
<a href="#l23.93"></a><span id="l23.93">   // we need to store the message key for the message we are currenty displaying to ensure we</span>
<a href="#l23.94"></a><span id="l23.94">   // don't try to redisplay the same message just because the selection changed (i.e. after a sort)</span>
<a href="#l23.95"></a><span id="l23.95">   nsMsgKey                m_currentlyDisplayedMsgKey;</span>
<a href="#l23.96"></a><span id="l23.96">   nsCString               m_currentlyDisplayedMsgUri;</span>
<a href="#l23.97"></a><span id="l23.97">   nsMsgViewIndex          m_currentlyDisplayedViewIndex;</span>
<a href="#l23.98"></a><span id="l23.98">   // if we're deleting messages, we want to hold off loading messages on selection changed until the delete is done</span>
<a href="#l23.99"></a><span id="l23.99">   // and we want to batch notifications.</span>
<a href="#l23.100"></a><span id="l23.100">   bool m_deletingRows;</span>
<a href="#l23.101"></a><span id="l23.101" class="difflineminus">-  // for certain special folders </span>
<a href="#l23.102"></a><span id="l23.102" class="difflineplus">+  // for certain special folders</span>
<a href="#l23.103"></a><span id="l23.103">   // and decendents of those folders</span>
<a href="#l23.104"></a><span id="l23.104">   // (like the &quot;Sent&quot; folder, &quot;Sent/Old Sent&quot;)</span>
<a href="#l23.105"></a><span id="l23.105">   // the Sender column really shows recipients.</span>
<a href="#l23.106"></a><span id="l23.106"> </span>
<a href="#l23.107"></a><span id="l23.107">   // Server types for this view's folder</span>
<a href="#l23.108"></a><span id="l23.108">   bool mIsNews;             // we have special icons for news</span>
<a href="#l23.109"></a><span id="l23.109">   bool mIsRss;              // rss affects enabling of junk commands</span>
<a href="#l23.110"></a><span id="l23.110">   bool mIsXFVirtual;        // a virtual folder with multiple folders</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineat">@@ -419,49 +419,49 @@ protected:</span>
<a href="#l23.112"></a><span id="l23.112">   nsString m_secondaryCustomColumn;</span>
<a href="#l23.113"></a><span id="l23.113">   nsMsgViewFlagsTypeValue m_viewFlags;</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115">   // I18N date formatter service which we'll want to cache locally.</span>
<a href="#l23.116"></a><span id="l23.116">   nsCOMPtr&lt;nsIMsgTagService&gt; mTagService;</span>
<a href="#l23.117"></a><span id="l23.117">   nsWeakPtr mMessengerWeak;</span>
<a href="#l23.118"></a><span id="l23.118">   nsWeakPtr mMsgWindowWeak;</span>
<a href="#l23.119"></a><span id="l23.119">   nsCOMPtr&lt;nsIMsgDBViewCommandUpdater&gt; mCommandUpdater; // we push command update notifications to the UI from this.</span>
<a href="#l23.120"></a><span id="l23.120" class="difflineminus">-  nsCOMPtr&lt;nsIStringBundle&gt; mMessengerStringBundle;  </span>
<a href="#l23.121"></a><span id="l23.121" class="difflineplus">+  nsCOMPtr&lt;nsIStringBundle&gt; mMessengerStringBundle;</span>
<a href="#l23.122"></a><span id="l23.122"> </span>
<a href="#l23.123"></a><span id="l23.123">   // used for the preference labels</span>
<a href="#l23.124"></a><span id="l23.124">   nsString mLabelPrefDescriptions[PREF_LABELS_MAX];</span>
<a href="#l23.125"></a><span id="l23.125">   nsString mLabelPrefColors[PREF_LABELS_MAX];</span>
<a href="#l23.126"></a><span id="l23.126"> </span>
<a href="#l23.127"></a><span id="l23.127">   // used to determine when to start and end</span>
<a href="#l23.128"></a><span id="l23.128">   // junk plugin batches</span>
<a href="#l23.129"></a><span id="l23.129">   uint32_t mNumMessagesRemainingInBatch;</span>
<a href="#l23.130"></a><span id="l23.130"> </span>
<a href="#l23.131"></a><span id="l23.131">   // these are the headers of the messages in the current</span>
<a href="#l23.132"></a><span id="l23.132">   // batch/series of batches of messages manually marked</span>
<a href="#l23.133"></a><span id="l23.133">   // as junk</span>
<a href="#l23.134"></a><span id="l23.134">   nsCOMPtr&lt;nsIMutableArray&gt; mJunkHdrs;</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-  </span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+</span>
<a href="#l23.137"></a><span id="l23.137">   nsTArray&lt;uint32_t&gt; mIndicesToNoteChange;</span>
<a href="#l23.138"></a><span id="l23.138"> </span>
<a href="#l23.139"></a><span id="l23.139">   nsTHashtable&lt;nsCStringHashKey&gt; mEmails;</span>
<a href="#l23.140"></a><span id="l23.140"> </span>
<a href="#l23.141"></a><span id="l23.141" class="difflineminus">-  // the saved search views keep track of the XX most recently deleted msg ids, so that if the </span>
<a href="#l23.142"></a><span id="l23.142" class="difflineplus">+  // the saved search views keep track of the XX most recently deleted msg ids, so that if the</span>
<a href="#l23.143"></a><span id="l23.143">   // delete is undone, we can add the msg back to the search results, even if it no longer</span>
<a href="#l23.144"></a><span id="l23.144">   // matches the search criteria (e.g., a saved search over unread messages).</span>
<a href="#l23.145"></a><span id="l23.145">   // We use mRecentlyDeletedArrayIndex to treat the array as a list of the XX</span>
<a href="#l23.146"></a><span id="l23.146">   // most recently deleted msgs.</span>
<a href="#l23.147"></a><span id="l23.147">   nsTArray&lt;nsCString&gt; mRecentlyDeletedMsgIds;</span>
<a href="#l23.148"></a><span id="l23.148">   uint32_t mRecentlyDeletedArrayIndex;</span>
<a href="#l23.149"></a><span id="l23.149">   void RememberDeletedMsgHdr(nsIMsgDBHdr *msgHdr);</span>
<a href="#l23.150"></a><span id="l23.150">   bool WasHdrRecentlyDeleted(nsIMsgDBHdr *msgHdr);</span>
<a href="#l23.151"></a><span id="l23.151" class="difflineminus">-  </span>
<a href="#l23.152"></a><span id="l23.152" class="difflineplus">+</span>
<a href="#l23.153"></a><span id="l23.153">   //these hold pointers (and IDs) for the nsIMsgCustomColumnHandler object that constitutes the custom column handler</span>
<a href="#l23.154"></a><span id="l23.154">   nsCOMArray &lt;nsIMsgCustomColumnHandler&gt; m_customColumnHandlers;</span>
<a href="#l23.155"></a><span id="l23.155">   nsTArray&lt;nsString&gt; m_customColumnHandlerIDs;</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-  </span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+</span>
<a href="#l23.158"></a><span id="l23.158">   nsIMsgCustomColumnHandler* GetColumnHandler(const char16_t*);</span>
<a href="#l23.159"></a><span id="l23.159">   nsIMsgCustomColumnHandler* GetCurColumnHandler();</span>
<a href="#l23.160"></a><span id="l23.160">   bool CustomColumnsInSortAndNotRegistered();</span>
<a href="#l23.161"></a><span id="l23.161">   void EnsureCustomColumnsValid();</span>
<a href="#l23.162"></a><span id="l23.162"> </span>
<a href="#l23.163"></a><span id="l23.163"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l23.164"></a><span id="l23.164"> void InitEntryInfoForIndex(nsMsgViewIndex i, IdKeyPtr &amp;EntryInfo);</span>
<a href="#l23.165"></a><span id="l23.165"> void ValidateSort();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -95,17 +95,17 @@ void nsFolderCompactState::CloseOutputSt</span>
<a href="#l24.4"></a><span id="l24.4"> }</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> void nsFolderCompactState::CleanupTempFilesAfterError()</span>
<a href="#l24.7"></a><span id="l24.7"> {</span>
<a href="#l24.8"></a><span id="l24.8">   CloseOutputStream();</span>
<a href="#l24.9"></a><span id="l24.9">   if (m_db)</span>
<a href="#l24.10"></a><span id="l24.10">     m_db-&gt;ForceClosed();</span>
<a href="#l24.11"></a><span id="l24.11">   nsCOMPtr &lt;nsIFile&gt; summaryFile;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineminus">-  GetSummaryFileLocation(m_file, getter_AddRefs(summaryFile)); </span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  GetSummaryFileLocation(m_file, getter_AddRefs(summaryFile));</span>
<a href="#l24.14"></a><span id="l24.14">   m_file-&gt;Remove(false);</span>
<a href="#l24.15"></a><span id="l24.15">   summaryFile-&gt;Remove(false);</span>
<a href="#l24.16"></a><span id="l24.16"> }</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> nsresult nsFolderCompactState::BuildMessageURI(const char *baseURI, nsMsgKey key, nsCString&amp; uri)</span>
<a href="#l24.19"></a><span id="l24.19"> {</span>
<a href="#l24.20"></a><span id="l24.20">   uri.Append(baseURI);</span>
<a href="#l24.21"></a><span id="l24.21">   uri.Append('#');</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineat">@@ -149,31 +149,31 @@ NS_IMETHODIMP nsFolderCompactState::Comp</span>
<a href="#l24.23"></a><span id="l24.23">   else if (aOfflineFolderArray)</span>
<a href="#l24.24"></a><span id="l24.24">   {</span>
<a href="#l24.25"></a><span id="l24.25">     m_folderArray = aOfflineFolderArray;</span>
<a href="#l24.26"></a><span id="l24.26">     m_compactingOfflineFolders = true;</span>
<a href="#l24.27"></a><span id="l24.27">     aOfflineFolderArray = nullptr;</span>
<a href="#l24.28"></a><span id="l24.28">   }</span>
<a href="#l24.29"></a><span id="l24.29">   if (!m_folderArray)</span>
<a href="#l24.30"></a><span id="l24.30">     return NS_OK;</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineminus">- </span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+</span>
<a href="#l24.33"></a><span id="l24.33">   m_compactAll = true;</span>
<a href="#l24.34"></a><span id="l24.34">   m_compactOfflineAlso = aOfflineFolderArray != nullptr;</span>
<a href="#l24.35"></a><span id="l24.35">   if (m_compactOfflineAlso)</span>
<a href="#l24.36"></a><span id="l24.36">     m_offlineFolderArray = aOfflineFolderArray;</span>
<a href="#l24.37"></a><span id="l24.37"> </span>
<a href="#l24.38"></a><span id="l24.38">   m_folderIndex = 0;</span>
<a href="#l24.39"></a><span id="l24.39">   nsresult rv = NS_OK;</span>
<a href="#l24.40"></a><span id="l24.40">   nsCOMPtr&lt;nsIMsgFolder&gt; firstFolder = do_QueryElementAt(m_folderArray,</span>
<a href="#l24.41"></a><span id="l24.41">                                                          m_folderIndex, &amp;rv);</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43">   if (NS_SUCCEEDED(rv) &amp;&amp; firstFolder)</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-    Compact(firstFolder, m_compactingOfflineFolders, aUrlListener, </span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    Compact(firstFolder, m_compactingOfflineFolders, aUrlListener,</span>
<a href="#l24.46"></a><span id="l24.46">             aMsgWindow);   //start with first folder from here.</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-  </span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+</span>
<a href="#l24.49"></a><span id="l24.49">   return rv;</span>
<a href="#l24.50"></a><span id="l24.50"> }</span>
<a href="#l24.51"></a><span id="l24.51"> </span>
<a href="#l24.52"></a><span id="l24.52"> NS_IMETHODIMP</span>
<a href="#l24.53"></a><span id="l24.53"> nsFolderCompactState::Compact(nsIMsgFolder *folder, bool aOfflineStore,</span>
<a href="#l24.54"></a><span id="l24.54">                               nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l24.55"></a><span id="l24.55"> {</span>
<a href="#l24.56"></a><span id="l24.56">   NS_ENSURE_ARG_POINTER(folder);</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineat">@@ -381,17 +381,17 @@ nsFolderCompactState::Init(nsIMsgFolder </span>
<a href="#l24.58"></a><span id="l24.58">   {</span>
<a href="#l24.59"></a><span id="l24.59">     CleanupTempFilesAfterError();</span>
<a href="#l24.60"></a><span id="l24.60">     return rv;</span>
<a href="#l24.61"></a><span id="l24.61">   }</span>
<a href="#l24.62"></a><span id="l24.62"> </span>
<a href="#l24.63"></a><span id="l24.63">   m_curIndex = 0;</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65">   rv = MsgNewBufferedFileOutputStream(getter_AddRefs(m_fileStream), m_file, -1, 00600);</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineminus">-  if (NS_FAILED(rv)) </span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l24.68"></a><span id="l24.68">     m_folder-&gt;ThrowAlertMsg(&quot;compactFolderWriteFailed&quot;, m_window);</span>
<a href="#l24.69"></a><span id="l24.69">   else</span>
<a href="#l24.70"></a><span id="l24.70">     rv = GetMessageServiceFromURI(nsDependentCString(baseMsgUri),</span>
<a href="#l24.71"></a><span id="l24.71">                                 getter_AddRefs(m_messageService));</span>
<a href="#l24.72"></a><span id="l24.72">   if (NS_FAILED(rv))</span>
<a href="#l24.73"></a><span id="l24.73">   {</span>
<a href="#l24.74"></a><span id="l24.74">     m_status = rv;</span>
<a href="#l24.75"></a><span id="l24.75">   }</span>
<a href="#l24.76"></a><span id="l24.76" class="difflineat">@@ -435,22 +435,22 @@ NS_IMETHODIMP nsFolderCompactState::OnSt</span>
<a href="#l24.77"></a><span id="l24.77">   }</span>
<a href="#l24.78"></a><span id="l24.78">   return NS_OK;</span>
<a href="#l24.79"></a><span id="l24.79"> }</span>
<a href="#l24.80"></a><span id="l24.80"> </span>
<a href="#l24.81"></a><span id="l24.81"> nsresult nsFolderCompactState::StartCompacting()</span>
<a href="#l24.82"></a><span id="l24.82"> {</span>
<a href="#l24.83"></a><span id="l24.83">   nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l24.84"></a><span id="l24.84">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l24.85"></a><span id="l24.85" class="difflineminus">-  </span>
<a href="#l24.86"></a><span id="l24.86" class="difflineplus">+</span>
<a href="#l24.87"></a><span id="l24.87">   nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l24.88"></a><span id="l24.88">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.89"></a><span id="l24.89">   rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l24.90"></a><span id="l24.90">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.91"></a><span id="l24.91" class="difflineminus">-  </span>
<a href="#l24.92"></a><span id="l24.92" class="difflineplus">+</span>
<a href="#l24.93"></a><span id="l24.93">   // Notify that compaction is beginning.  We do this even if there are no</span>
<a href="#l24.94"></a><span id="l24.94">   // messages to be copied because the summary database still gets blown away</span>
<a href="#l24.95"></a><span id="l24.95">   // which is still pretty interesting.  (And we like consistency.)</span>
<a href="#l24.96"></a><span id="l24.96">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l24.97"></a><span id="l24.97">     notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l24.98"></a><span id="l24.98">   if (notifier)</span>
<a href="#l24.99"></a><span id="l24.99">     notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l24.100"></a><span id="l24.100">                               NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;),</span>
<a href="#l24.101"></a><span id="l24.101" class="difflineat">@@ -645,17 +645,17 @@ nsFolderCompactState::FinishCompact()</span>
<a href="#l24.102"></a><span id="l24.102">                               nullptr,</span>
<a href="#l24.103"></a><span id="l24.103">                               EmptyCString());</span>
<a href="#l24.104"></a><span id="l24.104">   m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106">   if (m_compactAll)</span>
<a href="#l24.107"></a><span id="l24.107">     rv = CompactNextFolder();</span>
<a href="#l24.108"></a><span id="l24.108">   else</span>
<a href="#l24.109"></a><span id="l24.109">     CompactCompleted(rv);</span>
<a href="#l24.110"></a><span id="l24.110" class="difflineminus">-      </span>
<a href="#l24.111"></a><span id="l24.111" class="difflineplus">+</span>
<a href="#l24.112"></a><span id="l24.112">   return rv;</span>
<a href="#l24.113"></a><span id="l24.113"> }</span>
<a href="#l24.114"></a><span id="l24.114"> </span>
<a href="#l24.115"></a><span id="l24.115"> </span>
<a href="#l24.116"></a><span id="l24.116"> void nsFolderCompactState::CompactCompleted(nsresult exitCode)</span>
<a href="#l24.117"></a><span id="l24.117"> {</span>
<a href="#l24.118"></a><span id="l24.118">   NS_WARNING_ASSERTION(NS_SUCCEEDED(exitCode),</span>
<a href="#l24.119"></a><span id="l24.119">                        &quot;nsFolderCompactState::CompactCompleted failed&quot;);</span>
<a href="#l24.120"></a><span id="l24.120" class="difflineat">@@ -780,17 +780,17 @@ nsFolderCompactState::OnStopRequest(nsIR</span>
<a href="#l24.121"></a><span id="l24.121">   return status;</span>
<a href="#l24.122"></a><span id="l24.122"> }</span>
<a href="#l24.123"></a><span id="l24.123"> </span>
<a href="#l24.124"></a><span id="l24.124"> NS_IMETHODIMP</span>
<a href="#l24.125"></a><span id="l24.125"> nsFolderCompactState::OnDataAvailable(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l24.126"></a><span id="l24.126">                                       nsIInputStream *inStr,</span>
<a href="#l24.127"></a><span id="l24.127">                                       uint64_t sourceOffset, uint32_t count)</span>
<a href="#l24.128"></a><span id="l24.128"> {</span>
<a href="#l24.129"></a><span id="l24.129" class="difflineminus">-  if (!m_fileStream || !inStr) </span>
<a href="#l24.130"></a><span id="l24.130" class="difflineplus">+  if (!m_fileStream || !inStr)</span>
<a href="#l24.131"></a><span id="l24.131">     return NS_ERROR_FAILURE;</span>
<a href="#l24.132"></a><span id="l24.132"> </span>
<a href="#l24.133"></a><span id="l24.133">   nsresult rv = NS_OK;</span>
<a href="#l24.134"></a><span id="l24.134">   uint32_t msgFlags;</span>
<a href="#l24.135"></a><span id="l24.135">   bool checkForKeyword = m_startOfMsg;</span>
<a href="#l24.136"></a><span id="l24.136">   bool addKeywordHdr = false;</span>
<a href="#l24.137"></a><span id="l24.137">   uint32_t needToGrowKeywords = 0;</span>
<a href="#l24.138"></a><span id="l24.138">   uint32_t statusOffset;</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineat">@@ -805,46 +805,46 @@ nsFolderCompactState::OnDataAvailable(ns</span>
<a href="#l24.140"></a><span id="l24.140">                                 m_messageUri)))</span>
<a href="#l24.141"></a><span id="l24.141">     {</span>
<a href="#l24.142"></a><span id="l24.142">       rv = GetMessage(getter_AddRefs(m_curSrcHdr));</span>
<a href="#l24.143"></a><span id="l24.143">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l24.144"></a><span id="l24.144">       if (m_curSrcHdr)</span>
<a href="#l24.145"></a><span id="l24.145">       {</span>
<a href="#l24.146"></a><span id="l24.146">         (void) m_curSrcHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l24.147"></a><span id="l24.147">         (void) m_curSrcHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l24.148"></a><span id="l24.148" class="difflineminus">-        </span>
<a href="#l24.149"></a><span id="l24.149" class="difflineplus">+</span>
<a href="#l24.150"></a><span id="l24.150">         if (statusOffset == 0)</span>
<a href="#l24.151"></a><span id="l24.151">           m_needStatusLine = true;</span>
<a href="#l24.152"></a><span id="l24.152">         // x-mozilla-status lines should be at the start of the headers, and the code</span>
<a href="#l24.153"></a><span id="l24.153">         // below assumes everything will fit in m_dataBuffer - if there's not</span>
<a href="#l24.154"></a><span id="l24.154">         // room, skip the keyword stuff.</span>
<a href="#l24.155"></a><span id="l24.155">         if (statusOffset &gt; sizeof(m_dataBuffer) - 1024)</span>
<a href="#l24.156"></a><span id="l24.156">         {</span>
<a href="#l24.157"></a><span id="l24.157">           checkForKeyword = false;</span>
<a href="#l24.158"></a><span id="l24.158">           NS_ASSERTION(false, &quot;status offset past end of read buffer size&quot;);</span>
<a href="#l24.159"></a><span id="l24.159" class="difflineminus">-          </span>
<a href="#l24.160"></a><span id="l24.160" class="difflineplus">+</span>
<a href="#l24.161"></a><span id="l24.161">         }</span>
<a href="#l24.162"></a><span id="l24.162">       }</span>
<a href="#l24.163"></a><span id="l24.163">     }</span>
<a href="#l24.164"></a><span id="l24.164">     m_startOfMsg = false;</span>
<a href="#l24.165"></a><span id="l24.165">   }</span>
<a href="#l24.166"></a><span id="l24.166">   uint32_t maxReadCount, readCount, writeCount;</span>
<a href="#l24.167"></a><span id="l24.167">   uint32_t bytesWritten;</span>
<a href="#l24.168"></a><span id="l24.168" class="difflineminus">-  </span>
<a href="#l24.169"></a><span id="l24.169" class="difflineplus">+</span>
<a href="#l24.170"></a><span id="l24.170">   while (NS_SUCCEEDED(rv) &amp;&amp; (int32_t) count &gt; 0)</span>
<a href="#l24.171"></a><span id="l24.171">   {</span>
<a href="#l24.172"></a><span id="l24.172">     maxReadCount = count &gt; sizeof(m_dataBuffer) - 1 ? sizeof(m_dataBuffer) - 1 : count;</span>
<a href="#l24.173"></a><span id="l24.173">     writeCount = 0;</span>
<a href="#l24.174"></a><span id="l24.174">     rv = inStr-&gt;Read(m_dataBuffer, maxReadCount, &amp;readCount);</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-    </span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+</span>
<a href="#l24.177"></a><span id="l24.177">     // if status offset is past the number of bytes we read, it's probably bogus,</span>
<a href="#l24.178"></a><span id="l24.178">     // and we shouldn't do any of the keyword stuff.</span>
<a href="#l24.179"></a><span id="l24.179">     if (statusOffset + X_MOZILLA_STATUS_LEN &gt; readCount)</span>
<a href="#l24.180"></a><span id="l24.180">       checkForKeyword = false;</span>
<a href="#l24.181"></a><span id="l24.181" class="difflineminus">-    </span>
<a href="#l24.182"></a><span id="l24.182" class="difflineplus">+</span>
<a href="#l24.183"></a><span id="l24.183">     if (NS_SUCCEEDED(rv))</span>
<a href="#l24.184"></a><span id="l24.184">     {</span>
<a href="#l24.185"></a><span id="l24.185">       if (checkForKeyword)</span>
<a href="#l24.186"></a><span id="l24.186">       {</span>
<a href="#l24.187"></a><span id="l24.187">         // make sure that status offset really points to x-mozilla-status line</span>
<a href="#l24.188"></a><span id="l24.188">         if  (!strncmp(m_dataBuffer + statusOffset, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN))</span>
<a href="#l24.189"></a><span id="l24.189">         {</span>
<a href="#l24.190"></a><span id="l24.190">           const char *keywordHdr = PL_strnrstr(m_dataBuffer, HEADER_X_MOZILLA_KEYWORDS, readCount);</span>
<a href="#l24.191"></a><span id="l24.191" class="difflineat">@@ -855,19 +855,19 @@ nsFolderCompactState::OnDataAvailable(ns</span>
<a href="#l24.192"></a><span id="l24.192">           m_curSrcHdr-&gt;GetStringProperty(&quot;keywords&quot;, getter_Copies(msgHdrKeywords));</span>
<a href="#l24.193"></a><span id="l24.193">         }</span>
<a href="#l24.194"></a><span id="l24.194">         checkForKeyword = false;</span>
<a href="#l24.195"></a><span id="l24.195">       }</span>
<a href="#l24.196"></a><span id="l24.196">       uint32_t blockOffset = 0;</span>
<a href="#l24.197"></a><span id="l24.197">       if (m_needStatusLine)</span>
<a href="#l24.198"></a><span id="l24.198">       {</span>
<a href="#l24.199"></a><span id="l24.199">         m_needStatusLine = false;</span>
<a href="#l24.200"></a><span id="l24.200" class="difflineminus">-        // we need to parse out the &quot;From &quot; header, write it out, then </span>
<a href="#l24.201"></a><span id="l24.201" class="difflineminus">-        // write out the x-mozilla-status headers, and set the </span>
<a href="#l24.202"></a><span id="l24.202" class="difflineminus">-        // status offset of the dest hdr for later use </span>
<a href="#l24.203"></a><span id="l24.203" class="difflineplus">+        // we need to parse out the &quot;From &quot; header, write it out, then</span>
<a href="#l24.204"></a><span id="l24.204" class="difflineplus">+        // write out the x-mozilla-status headers, and set the</span>
<a href="#l24.205"></a><span id="l24.205" class="difflineplus">+        // status offset of the dest hdr for later use</span>
<a href="#l24.206"></a><span id="l24.206">         // in OnEndCopy).</span>
<a href="#l24.207"></a><span id="l24.207">         if (!strncmp(m_dataBuffer, &quot;From &quot;, 5))</span>
<a href="#l24.208"></a><span id="l24.208">         {</span>
<a href="#l24.209"></a><span id="l24.209">           blockOffset = 5;</span>
<a href="#l24.210"></a><span id="l24.210">           // skip from line</span>
<a href="#l24.211"></a><span id="l24.211">           MsgAdvanceToNextLine(m_dataBuffer, blockOffset, readCount);</span>
<a href="#l24.212"></a><span id="l24.212">           char statusLine[50];</span>
<a href="#l24.213"></a><span id="l24.213">           m_fileStream-&gt;Write(m_dataBuffer, blockOffset, &amp;writeCount);</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineat">@@ -988,17 +988,17 @@ nsFolderCompactState::OnDataAvailable(ns</span>
<a href="#l24.215"></a><span id="l24.215">         needToGrowKeywords = false;</span>
<a href="#l24.216"></a><span id="l24.216">         writeCount += blockOffset - preKeywordBlockOffset; // fudge writeCount</span>
<a href="#l24.217"></a><span id="l24.217"> </span>
<a href="#l24.218"></a><span id="l24.218">       }</span>
<a href="#l24.219"></a><span id="l24.219">       if (readCount &lt;= blockOffset)</span>
<a href="#l24.220"></a><span id="l24.220">       {</span>
<a href="#l24.221"></a><span id="l24.221">         NS_ASSERTION(false, &quot;bad block offset&quot;);</span>
<a href="#l24.222"></a><span id="l24.222">         // not sure what to do to handle this.</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineminus">-      </span>
<a href="#l24.224"></a><span id="l24.224" class="difflineplus">+</span>
<a href="#l24.225"></a><span id="l24.225">       }</span>
<a href="#l24.226"></a><span id="l24.226">       m_fileStream-&gt;Write(m_dataBuffer + blockOffset, readCount - blockOffset, &amp;bytesWritten);</span>
<a href="#l24.227"></a><span id="l24.227">       writeCount += bytesWritten;</span>
<a href="#l24.228"></a><span id="l24.228">       count -= readCount;</span>
<a href="#l24.229"></a><span id="l24.229">       if (writeCount != readCount)</span>
<a href="#l24.230"></a><span id="l24.230">         return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l24.231"></a><span id="l24.231">     }</span>
<a href="#l24.232"></a><span id="l24.232">   }</span>
<a href="#l24.233"></a><span id="l24.233" class="difflineat">@@ -1152,17 +1152,17 @@ done:</span>
<a href="#l24.234"></a><span id="l24.234">     m_status = rv; // set the status to rv so the destructor can remove the</span>
<a href="#l24.235"></a><span id="l24.235">                    // temp folder and database</span>
<a href="#l24.236"></a><span id="l24.236">     ReleaseFolderLock();</span>
<a href="#l24.237"></a><span id="l24.237">     NS_RELEASE_THIS(); // kill self</span>
<a href="#l24.238"></a><span id="l24.238">     return rv;</span>
<a href="#l24.239"></a><span id="l24.239">   }</span>
<a href="#l24.240"></a><span id="l24.240">   return rv;</span>
<a href="#l24.241"></a><span id="l24.241"> }</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineminus">- </span>
<a href="#l24.243"></a><span id="l24.243" class="difflineplus">+</span>
<a href="#l24.244"></a><span id="l24.244"> </span>
<a href="#l24.245"></a><span id="l24.245"> nsresult</span>
<a href="#l24.246"></a><span id="l24.246"> nsOfflineStoreCompactState::FinishCompact()</span>
<a href="#l24.247"></a><span id="l24.247"> {</span>
<a href="#l24.248"></a><span id="l24.248">   // All okay time to finish up the compact process</span>
<a href="#l24.249"></a><span id="l24.249">   nsCOMPtr&lt;nsIFile&gt; path;</span>
<a href="#l24.250"></a><span id="l24.250">   uint32_t flags;</span>
<a href="#l24.251"></a><span id="l24.251"> </span>
<a href="#l24.252"></a><span id="l24.252" class="difflineat">@@ -1188,20 +1188,20 @@ nsOfflineStoreCompactState::FinishCompac</span>
<a href="#l24.253"></a><span id="l24.253">   if (dbFolderInfo)</span>
<a href="#l24.254"></a><span id="l24.254">     dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l24.255"></a><span id="l24.255">   // this forces the m_folder to update mExpungedBytes from the db folder info.</span>
<a href="#l24.256"></a><span id="l24.256">   int64_t expungedBytes;</span>
<a href="#l24.257"></a><span id="l24.257">   m_folder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l24.258"></a><span id="l24.258">   m_folder-&gt;UpdateSummaryTotals(true);</span>
<a href="#l24.259"></a><span id="l24.259">   m_db-&gt;SetSummaryValid(true);</span>
<a href="#l24.260"></a><span id="l24.260"> </span>
<a href="#l24.261"></a><span id="l24.261" class="difflineminus">-    // remove the old folder </span>
<a href="#l24.262"></a><span id="l24.262" class="difflineplus">+    // remove the old folder</span>
<a href="#l24.263"></a><span id="l24.263">   path-&gt;Remove(false);</span>
<a href="#l24.264"></a><span id="l24.264"> </span>
<a href="#l24.265"></a><span id="l24.265" class="difflineminus">-    // rename the copied folder to be the original folder </span>
<a href="#l24.266"></a><span id="l24.266" class="difflineplus">+    // rename the copied folder to be the original folder</span>
<a href="#l24.267"></a><span id="l24.267">   m_file-&gt;MoveToNative((nsIFile *) nullptr, leafName);</span>
<a href="#l24.268"></a><span id="l24.268"> </span>
<a href="#l24.269"></a><span id="l24.269">   ShowStatusMsg(EmptyString());</span>
<a href="#l24.270"></a><span id="l24.270">   m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l24.271"></a><span id="l24.271">   if (m_compactAll)</span>
<a href="#l24.272"></a><span id="l24.272">     rv = CompactNextFolder();</span>
<a href="#l24.273"></a><span id="l24.273">   return rv;</span>
<a href="#l24.274"></a><span id="l24.274"> }</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineat">@@ -1315,17 +1315,17 @@ nsresult nsOfflineStoreCompactState::Sta</span>
<a href="#l24.276"></a><span id="l24.276">   return rv;</span>
<a href="#l24.277"></a><span id="l24.277"> }</span>
<a href="#l24.278"></a><span id="l24.278"> </span>
<a href="#l24.279"></a><span id="l24.279"> NS_IMETHODIMP</span>
<a href="#l24.280"></a><span id="l24.280"> nsOfflineStoreCompactState::OnDataAvailable(nsIRequest *request, nsISupports *ctxt,</span>
<a href="#l24.281"></a><span id="l24.281">                                             nsIInputStream *inStr,</span>
<a href="#l24.282"></a><span id="l24.282">                                             uint64_t sourceOffset, uint32_t count)</span>
<a href="#l24.283"></a><span id="l24.283"> {</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineminus">-  if (!m_fileStream || !inStr) </span>
<a href="#l24.285"></a><span id="l24.285" class="difflineplus">+  if (!m_fileStream || !inStr)</span>
<a href="#l24.286"></a><span id="l24.286">     return NS_ERROR_FAILURE;</span>
<a href="#l24.287"></a><span id="l24.287"> </span>
<a href="#l24.288"></a><span id="l24.288">   nsresult rv = NS_OK;</span>
<a href="#l24.289"></a><span id="l24.289"> </span>
<a href="#l24.290"></a><span id="l24.290">   if (m_startOfMsg)</span>
<a href="#l24.291"></a><span id="l24.291">   {</span>
<a href="#l24.292"></a><span id="l24.292">     m_statusOffset = 0;</span>
<a href="#l24.293"></a><span id="l24.293">     m_offlineMsgSize = 0;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.h</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -67,17 +67,17 @@ protected:</span>
<a href="#l25.4"></a><span id="l25.4">   uint64_t m_totalMsgSize;</span>
<a href="#l25.5"></a><span id="l25.5">   // number of bytes that can be expunged while compacting.</span>
<a href="#l25.6"></a><span id="l25.6">   uint64_t m_totalExpungedBytes;</span>
<a href="#l25.7"></a><span id="l25.7"> </span>
<a href="#l25.8"></a><span id="l25.8">   uint32_t m_curIndex; // index of the current copied message key in key array</span>
<a href="#l25.9"></a><span id="l25.9">   uint64_t m_startOfNewMsg; // offset in mailbox of new message</span>
<a href="#l25.10"></a><span id="l25.10">   char m_dataBuffer[COMPACTOR_READ_BUFF_SIZE + 1]; // temp data buffer for copying message</span>
<a href="#l25.11"></a><span id="l25.11">   nsresult m_status; // the status of the copying operation</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-  nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService; // message service for copying </span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  nsCOMPtr &lt;nsIMsgMessageService&gt; m_messageService; // message service for copying</span>
<a href="#l25.14"></a><span id="l25.14">   nsCOMPtr&lt;nsIArray&gt; m_folderArray; // folders we are compacting, if compacting multiple.</span>
<a href="#l25.15"></a><span id="l25.15">   nsCOMPtr &lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l25.16"></a><span id="l25.16">   nsCOMPtr &lt;nsIMsgDBHdr&gt; m_curSrcHdr;</span>
<a href="#l25.17"></a><span id="l25.17">   uint32_t m_folderIndex; // tells which folder to compact in case of compact all</span>
<a href="#l25.18"></a><span id="l25.18">   bool m_compactAll;  //flag for compact all</span>
<a href="#l25.19"></a><span id="l25.19">   bool m_compactOfflineAlso; //whether to compact offline also</span>
<a href="#l25.20"></a><span id="l25.20">   bool m_compactingOfflineFolders; // are we in the offline folder compact phase</span>
<a href="#l25.21"></a><span id="l25.21">   bool m_parsingFolder; //flag for parsing local folders;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderDataSource.h</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderDataSource.h</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -27,17 +27,17 @@</span>
<a href="#l26.4"></a><span id="l26.4"> #endif</span>
<a href="#l26.5"></a><span id="l26.5"> /**</span>
<a href="#l26.6"></a><span id="l26.6">  * The mail data source.</span>
<a href="#l26.7"></a><span id="l26.7">  */</span>
<a href="#l26.8"></a><span id="l26.8"> class nsMsgFolderDataSource : public nsMsgRDFDataSource,</span>
<a href="#l26.9"></a><span id="l26.9">                               public nsIFolderListener</span>
<a href="#l26.10"></a><span id="l26.10"> {</span>
<a href="#l26.11"></a><span id="l26.11"> public:</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  </span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+</span>
<a href="#l26.14"></a><span id="l26.14">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l26.15"></a><span id="l26.15">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l26.16"></a><span id="l26.16"> </span>
<a href="#l26.17"></a><span id="l26.17">   nsMsgFolderDataSource(void);</span>
<a href="#l26.18"></a><span id="l26.18">   virtual nsresult Init() override;</span>
<a href="#l26.19"></a><span id="l26.19">   virtual void Cleanup() override;</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21">   // nsIRDFDataSource methods</span>
<a href="#l26.22"></a><span id="l26.22" class="difflineat">@@ -54,22 +54,22 @@ public:</span>
<a href="#l26.23"></a><span id="l26.23">                        nsIRDFNode** target) override;</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">   NS_IMETHOD GetSources(nsIRDFResource* property,</span>
<a href="#l26.26"></a><span id="l26.26">                         nsIRDFNode* target,</span>
<a href="#l26.27"></a><span id="l26.27">                         bool tv,</span>
<a href="#l26.28"></a><span id="l26.28">                         nsISimpleEnumerator** sources) override;</span>
<a href="#l26.29"></a><span id="l26.29"> </span>
<a href="#l26.30"></a><span id="l26.30">   NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineminus">-                        nsIRDFResource* property,    </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+                        nsIRDFResource* property,</span>
<a href="#l26.33"></a><span id="l26.33">                         bool tv,</span>
<a href="#l26.34"></a><span id="l26.34">                         nsISimpleEnumerator** targets) override;</span>
<a href="#l26.35"></a><span id="l26.35"> </span>
<a href="#l26.36"></a><span id="l26.36">   NS_IMETHOD Assert(nsIRDFResource* source,</span>
<a href="#l26.37"></a><span id="l26.37" class="difflineminus">-                    nsIRDFResource* property, </span>
<a href="#l26.38"></a><span id="l26.38" class="difflineplus">+                    nsIRDFResource* property,</span>
<a href="#l26.39"></a><span id="l26.39">                     nsIRDFNode* target,</span>
<a href="#l26.40"></a><span id="l26.40">                     bool tv) override;</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">   NS_IMETHOD Unassert(nsIRDFResource* source,</span>
<a href="#l26.43"></a><span id="l26.43">                       nsIRDFResource* property,</span>
<a href="#l26.44"></a><span id="l26.44">                       nsIRDFNode* target) override;</span>
<a href="#l26.45"></a><span id="l26.45"> </span>
<a href="#l26.46"></a><span id="l26.46">   NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l26.47"></a><span id="l26.47" class="difflineat">@@ -80,17 +80,17 @@ public:</span>
<a href="#l26.48"></a><span id="l26.48"> </span>
<a href="#l26.49"></a><span id="l26.49">   NS_IMETHOD HasArcOut(nsIRDFResource *aSource, nsIRDFResource *aArc,</span>
<a href="#l26.50"></a><span id="l26.50">                        bool *result) override;</span>
<a href="#l26.51"></a><span id="l26.51"> </span>
<a href="#l26.52"></a><span id="l26.52">   NS_IMETHOD ArcLabelsIn(nsIRDFNode* node,</span>
<a href="#l26.53"></a><span id="l26.53">                          nsISimpleEnumerator** labels) override;</span>
<a href="#l26.54"></a><span id="l26.54"> </span>
<a href="#l26.55"></a><span id="l26.55">   NS_IMETHOD ArcLabelsOut(nsIRDFResource* source,</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineminus">-                          nsISimpleEnumerator** labels) override; </span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+                          nsISimpleEnumerator** labels) override;</span>
<a href="#l26.58"></a><span id="l26.58"> </span>
<a href="#l26.59"></a><span id="l26.59">   NS_IMETHOD GetAllResources(nsISimpleEnumerator** aResult) override;</span>
<a href="#l26.60"></a><span id="l26.60"> </span>
<a href="#l26.61"></a><span id="l26.61">   NS_IMETHOD GetAllCmds(nsIRDFResource* source,</span>
<a href="#l26.62"></a><span id="l26.62">                             nsISimpleEnumerator/*&lt;nsIRDFResource&gt;*/** commands</span>
<a href="#l26.63"></a><span id="l26.63">                         ) override;</span>
<a href="#l26.64"></a><span id="l26.64"> </span>
<a href="#l26.65"></a><span id="l26.65">   NS_IMETHOD IsCommandEnabled(nsISupports/*nsISupportsArray&lt;nsIRDFResource&gt;*/* aSources,</span>
<a href="#l26.66"></a><span id="l26.66" class="difflineat">@@ -155,28 +155,28 @@ protected:</span>
<a href="#l26.67"></a><span id="l26.67">                                     nsIRDFNode **target);</span>
<a href="#l26.68"></a><span id="l26.68">   nsresult createFolderSynchronizeNode(nsIMsgFolder *folder, nsIRDFNode **target);</span>
<a href="#l26.69"></a><span id="l26.69">   nsresult createFolderSyncDisabledNode(nsIMsgFolder *folder, nsIRDFNode **target);</span>
<a href="#l26.70"></a><span id="l26.70">   nsresult createCanSearchMessages(nsIMsgFolder *folder,</span>
<a href="#l26.71"></a><span id="l26.71">                                       nsIRDFNode **target);</span>
<a href="#l26.72"></a><span id="l26.72">   nsresult createFolderChildNode(nsIMsgFolder *folder, nsIRDFNode **target);</span>
<a href="#l26.73"></a><span id="l26.73"> </span>
<a href="#l26.74"></a><span id="l26.74">   nsresult getFolderArcLabelsOut(nsCOMArray&lt;nsIRDFResource&gt; &amp;aArcs);</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineminus">-  </span>
<a href="#l26.76"></a><span id="l26.76" class="difflineplus">+</span>
<a href="#l26.77"></a><span id="l26.77"> #if 0</span>
<a href="#l26.78"></a><span id="l26.78">   nsresult DoDeleteFromFolder(nsIMsgFolder *folder,</span>
<a href="#l26.79"></a><span id="l26.79">                 nsISupportsArray *arguments, nsIMsgWindow *msgWindow, bool reallyDelete);</span>
<a href="#l26.80"></a><span id="l26.80"> </span>
<a href="#l26.81"></a><span id="l26.81">   nsresult DoCopyToFolder(nsIMsgFolder *dstFolder, nsISupportsArray *arguments,</span>
<a href="#l26.82"></a><span id="l26.82">               nsIMsgWindow *msgWindow, bool isMove);</span>
<a href="#l26.83"></a><span id="l26.83"> </span>
<a href="#l26.84"></a><span id="l26.84">   nsresult DoFolderCopyToFolder(nsIMsgFolder *dstFolder, nsISupportsArray *arguments,</span>
<a href="#l26.85"></a><span id="l26.85">               nsIMsgWindow *msgWindow, bool isMoveFolder);</span>
<a href="#l26.86"></a><span id="l26.86"> </span>
<a href="#l26.87"></a><span id="l26.87" class="difflineminus">-  nsresult DoNewFolder(nsIMsgFolder *folder, nsISupportsArray *arguments, </span>
<a href="#l26.88"></a><span id="l26.88" class="difflineplus">+  nsresult DoNewFolder(nsIMsgFolder *folder, nsISupportsArray *arguments,</span>
<a href="#l26.89"></a><span id="l26.89">                         nsIMsgWindow *window);</span>
<a href="#l26.90"></a><span id="l26.90"> #endif</span>
<a href="#l26.91"></a><span id="l26.91"> </span>
<a href="#l26.92"></a><span id="l26.92">   nsresult DoFolderAssert(nsIMsgFolder *folder, nsIRDFResource *property, nsIRDFNode *target);</span>
<a href="#l26.93"></a><span id="l26.93">   nsresult DoFolderUnassert(nsIMsgFolder *folder, nsIRDFResource *property, nsIRDFNode *target);</span>
<a href="#l26.94"></a><span id="l26.94"> </span>
<a href="#l26.95"></a><span id="l26.95">   nsresult DoFolderHasAssertion(nsIMsgFolder *folder, nsIRDFResource *property, nsIRDFNode *target,</span>
<a href="#l26.96"></a><span id="l26.96">                                 bool tv, bool *hasAssertion);</span>
<a href="#l26.97"></a><span id="l26.97" class="difflineat">@@ -275,17 +275,17 @@ public:</span>
<a href="#l26.98"></a><span id="l26.98">   // constructor could take a filter to filter out folders.</span>
<a href="#l26.99"></a><span id="l26.99">   nsMsgFlatFolderDataSource();</span>
<a href="#l26.100"></a><span id="l26.100">   virtual ~nsMsgFlatFolderDataSource();</span>
<a href="#l26.101"></a><span id="l26.101">   virtual nsresult Init() override;</span>
<a href="#l26.102"></a><span id="l26.102">   virtual void Cleanup() override;</span>
<a href="#l26.103"></a><span id="l26.103"> </span>
<a href="#l26.104"></a><span id="l26.104">   NS_IMETHOD GetURI(char* *uri) override;</span>
<a href="#l26.105"></a><span id="l26.105">   NS_IMETHOD GetTargets(nsIRDFResource* source,</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineminus">-                        nsIRDFResource* property,    </span>
<a href="#l26.107"></a><span id="l26.107" class="difflineplus">+                        nsIRDFResource* property,</span>
<a href="#l26.108"></a><span id="l26.108">                         bool tv,</span>
<a href="#l26.109"></a><span id="l26.109">                         nsISimpleEnumerator** targets) override;</span>
<a href="#l26.110"></a><span id="l26.110">   NS_IMETHOD GetTarget(nsIRDFResource* source,</span>
<a href="#l26.111"></a><span id="l26.111">                        nsIRDFResource* property,</span>
<a href="#l26.112"></a><span id="l26.112">                        bool tv,</span>
<a href="#l26.113"></a><span id="l26.113">                        nsIRDFNode** target) override;</span>
<a href="#l26.114"></a><span id="l26.114"> </span>
<a href="#l26.115"></a><span id="l26.115">   NS_IMETHOD HasAssertion(nsIRDFResource* source,</span>
<a href="#l26.116"></a><span id="l26.116" class="difflineat">@@ -309,18 +309,18 @@ protected:</span>
<a href="#l26.117"></a><span id="l26.117"> };</span>
<a href="#l26.118"></a><span id="l26.118"> </span>
<a href="#l26.119"></a><span id="l26.119"> </span>
<a href="#l26.120"></a><span id="l26.120"> class nsMsgUnreadFoldersDataSource : public nsMsgFlatFolderDataSource</span>
<a href="#l26.121"></a><span id="l26.121"> {</span>
<a href="#l26.122"></a><span id="l26.122"> public:</span>
<a href="#l26.123"></a><span id="l26.123">   nsMsgUnreadFoldersDataSource() {m_dsName = &quot;mailnewsunreadfolders&quot;;}</span>
<a href="#l26.124"></a><span id="l26.124">   virtual ~nsMsgUnreadFoldersDataSource() {}</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineminus">-  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource, </span>
<a href="#l26.126"></a><span id="l26.126" class="difflineminus">-                    nsIRDFResource *propertyResource, nsIRDFNode *newNode, </span>
<a href="#l26.127"></a><span id="l26.127" class="difflineplus">+  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource,</span>
<a href="#l26.128"></a><span id="l26.128" class="difflineplus">+                    nsIRDFResource *propertyResource, nsIRDFNode *newNode,</span>
<a href="#l26.129"></a><span id="l26.129">                     nsIRDFNode *oldNode = nullptr) override;</span>
<a href="#l26.130"></a><span id="l26.130"> protected:</span>
<a href="#l26.131"></a><span id="l26.131">   virtual bool WantsThisFolder(nsIMsgFolder *folder) override;</span>
<a href="#l26.132"></a><span id="l26.132"> };</span>
<a href="#l26.133"></a><span id="l26.133"> </span>
<a href="#l26.134"></a><span id="l26.134"> class nsMsgFavoriteFoldersDataSource : public nsMsgFlatFolderDataSource</span>
<a href="#l26.135"></a><span id="l26.135"> {</span>
<a href="#l26.136"></a><span id="l26.136"> public:</span>
<a href="#l26.137"></a><span id="l26.137" class="difflineat">@@ -331,18 +331,18 @@ protected:</span>
<a href="#l26.138"></a><span id="l26.138"> };</span>
<a href="#l26.139"></a><span id="l26.139"> </span>
<a href="#l26.140"></a><span id="l26.140"> class nsMsgRecentFoldersDataSource : public nsMsgFlatFolderDataSource</span>
<a href="#l26.141"></a><span id="l26.141"> {</span>
<a href="#l26.142"></a><span id="l26.142"> public:</span>
<a href="#l26.143"></a><span id="l26.143">   nsMsgRecentFoldersDataSource() {m_dsName = &quot;mailnewsrecentfolders&quot;;</span>
<a href="#l26.144"></a><span id="l26.144">                                   m_cutOffDate = 0; m_maxNumFolders = 15;}</span>
<a href="#l26.145"></a><span id="l26.145">   virtual ~nsMsgRecentFoldersDataSource() {}</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource, </span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-                    nsIRDFResource *property, nsIRDFNode *newNode, </span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource,</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+                    nsIRDFResource *property, nsIRDFNode *newNode,</span>
<a href="#l26.150"></a><span id="l26.150">                     nsIRDFNode *oldNode) override;</span>
<a href="#l26.151"></a><span id="l26.151">   NS_IMETHOD OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item) override;</span>
<a href="#l26.152"></a><span id="l26.152">   virtual void Cleanup() override;</span>
<a href="#l26.153"></a><span id="l26.153"> protected:</span>
<a href="#l26.154"></a><span id="l26.154">   virtual void EnsureFolders() override;</span>
<a href="#l26.155"></a><span id="l26.155">   uint32_t m_cutOffDate;</span>
<a href="#l26.156"></a><span id="l26.156">   uint32_t m_maxNumFolders;</span>
<a href="#l26.157"></a><span id="l26.157"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderNotificationService.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -87,31 +87,31 @@ NS_IMETHODIMP nsMsgFolderNotificationSer</span>
<a href="#l27.4"></a><span id="l27.4"> </span>
<a href="#l27.5"></a><span id="l27.5"> /* void notifyMsgsMoveCopyCompleted (in boolean aMove, in nsIArray aSrcMsgs,</span>
<a href="#l27.6"></a><span id="l27.6">                                      in nsIMsgFolder aDestFolder); */</span>
<a href="#l27.7"></a><span id="l27.7"> NS_IMETHODIMP nsMsgFolderNotificationService::NotifyMsgsMoveCopyCompleted(</span>
<a href="#l27.8"></a><span id="l27.8">   bool aMove, nsIArray *aSrcMsgs, nsIMsgFolder *aDestFolder,</span>
<a href="#l27.9"></a><span id="l27.9">   nsIArray *aDestMsgs)</span>
<a href="#l27.10"></a><span id="l27.10"> {</span>
<a href="#l27.11"></a><span id="l27.11">   uint32_t count = mListeners.Length();</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-  </span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+</span>
<a href="#l27.14"></a><span id="l27.14">   // IMAP delete model means that a &quot;move&quot; isn't really a move, it is a copy,</span>
<a href="#l27.15"></a><span id="l27.15">   // followed by storing the IMAP deleted flag on the message.</span>
<a href="#l27.16"></a><span id="l27.16">   bool isReallyMove = aMove;</span>
<a href="#l27.17"></a><span id="l27.17">   if (count &gt; 0 &amp;&amp; aMove)</span>
<a href="#l27.18"></a><span id="l27.18">   {</span>
<a href="#l27.19"></a><span id="l27.19">     nsresult rv;</span>
<a href="#l27.20"></a><span id="l27.20">     // Assume that all the source messages are from the same server.</span>
<a href="#l27.21"></a><span id="l27.21">     nsCOMPtr&lt;nsIMsgDBHdr&gt; message(do_QueryElementAt(aSrcMsgs, 0, &amp;rv));</span>
<a href="#l27.22"></a><span id="l27.22">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.23"></a><span id="l27.23"> </span>
<a href="#l27.24"></a><span id="l27.24">     nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l27.25"></a><span id="l27.25">     rv = message-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l27.26"></a><span id="l27.26">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineminus">-    </span>
<a href="#l27.28"></a><span id="l27.28" class="difflineplus">+</span>
<a href="#l27.29"></a><span id="l27.29">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder(do_QueryInterface(msgFolder));</span>
<a href="#l27.30"></a><span id="l27.30">     if (imapFolder)</span>
<a href="#l27.31"></a><span id="l27.31">     {</span>
<a href="#l27.32"></a><span id="l27.32">       nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer;</span>
<a href="#l27.33"></a><span id="l27.33">       imapFolder-&gt;GetImapIncomingServer(getter_AddRefs(imapServer));</span>
<a href="#l27.34"></a><span id="l27.34">       if (imapServer)</span>
<a href="#l27.35"></a><span id="l27.35">       {</span>
<a href="#l27.36"></a><span id="l27.36">         nsMsgImapDeleteModel deleteModel;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupThread.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupThread.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -30,31 +30,31 @@ protected:</span>
<a href="#l28.4"></a><span id="l28.4">   virtual ~nsMsgGroupThread();</span>
<a href="#l28.5"></a><span id="l28.5"> </span>
<a href="#l28.6"></a><span id="l28.6">   void      Init();</span>
<a href="#l28.7"></a><span id="l28.7">   nsMsgViewIndex AddChildFromGroupView(nsIMsgDBHdr *child, nsMsgDBView *view);</span>
<a href="#l28.8"></a><span id="l28.8">   nsresult  RemoveChild(nsMsgKey msgKey);</span>
<a href="#l28.9"></a><span id="l28.9">   nsresult  RerootThread(nsIMsgDBHdr *newParentOfOldRoot, nsIMsgDBHdr *oldRoot, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">   virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child, nsMsgDBView *view);</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view, </span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-                                          nsIMsgDBHdr *child, </span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+                                          nsIMsgDBHdr *child,</span>
<a href="#l28.16"></a><span id="l28.16">                                           nsMsgViewSortOrderValue threadSortOrder);</span>
<a href="#l28.17"></a><span id="l28.17">   nsresult ReparentNonReferenceChildrenOf(nsIMsgDBHdr *topLevelHdr, nsMsgKey newParentKey,</span>
<a href="#l28.18"></a><span id="l28.18">                                                             nsIDBChangeAnnouncer *announcer);</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20">   nsresult ReparentChildrenOf(nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeAnnouncer *announcer);</span>
<a href="#l28.21"></a><span id="l28.21">   nsresult ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l28.22"></a><span id="l28.22">   nsresult GetChildHdrForKey(nsMsgKey desiredKey, nsIMsgDBHdr **result, int32_t *resultIndex);</span>
<a href="#l28.23"></a><span id="l28.23">   uint32_t NumRealChildren();</span>
<a href="#l28.24"></a><span id="l28.24">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr);</span>
<a href="#l28.25"></a><span id="l28.25">   virtual void SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr);</span>
<a href="#l28.26"></a><span id="l28.26">   virtual nsMsgViewIndex FindMsgHdr(nsIMsgDBHdr *hdr);</span>
<a href="#l28.27"></a><span id="l28.27"> </span>
<a href="#l28.28"></a><span id="l28.28" class="difflineminus">-  nsMsgKey        m_threadKey; </span>
<a href="#l28.29"></a><span id="l28.29" class="difflineplus">+  nsMsgKey        m_threadKey;</span>
<a href="#l28.30"></a><span id="l28.30">   uint32_t        m_numUnreadChildren;	</span>
<a href="#l28.31"></a><span id="l28.31">   uint32_t        m_flags;</span>
<a href="#l28.32"></a><span id="l28.32">   nsMsgKey        m_threadRootKey;</span>
<a href="#l28.33"></a><span id="l28.33">   uint32_t        m_newestMsgDate;</span>
<a href="#l28.34"></a><span id="l28.34">   nsTArray&lt;nsMsgKey&gt; m_keys;</span>
<a href="#l28.35"></a><span id="l28.35">   bool            m_dummy; // top level msg is a dummy, e.g., grouped by age.</span>
<a href="#l28.36"></a><span id="l28.36">   nsCOMPtr &lt;nsIMsgDatabase&gt; m_db; // should we make a weak ref or just a ptr?</span>
<a href="#l28.37"></a><span id="l28.37"> };</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineat">@@ -70,18 +70,18 @@ public:</span>
<a href="#l28.39"></a><span id="l28.39">   NS_IMETHOD RemoveChildAt(uint32_t aIndex) override;</span>
<a href="#l28.40"></a><span id="l28.40"> protected:</span>
<a href="#l28.41"></a><span id="l28.41">   virtual ~nsMsgXFGroupThread();</span>
<a href="#l28.42"></a><span id="l28.42"> </span>
<a href="#l28.43"></a><span id="l28.43">   virtual void InsertMsgHdrAt(nsMsgViewIndex index,</span>
<a href="#l28.44"></a><span id="l28.44">                               nsIMsgDBHdr *hdr) override;</span>
<a href="#l28.45"></a><span id="l28.45">   virtual void SetMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr) override;</span>
<a href="#l28.46"></a><span id="l28.46">   virtual nsMsgViewIndex FindMsgHdr(nsIMsgDBHdr *hdr) override;</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-  virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child, </span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+  virtual nsMsgViewIndex AddMsgHdrInDateOrder(nsIMsgDBHdr *child,</span>
<a href="#l28.49"></a><span id="l28.49">                                               nsMsgDBView *view) override;</span>
<a href="#l28.50"></a><span id="l28.50" class="difflineminus">-  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view, </span>
<a href="#l28.51"></a><span id="l28.51" class="difflineminus">-                                          nsIMsgDBHdr *child, </span>
<a href="#l28.52"></a><span id="l28.52" class="difflineplus">+  virtual nsMsgViewIndex GetInsertIndexFromView(nsMsgDBView *view,</span>
<a href="#l28.53"></a><span id="l28.53" class="difflineplus">+                                          nsIMsgDBHdr *child,</span>
<a href="#l28.54"></a><span id="l28.54">                                           nsMsgViewSortOrderValue threadSortOrder</span>
<a href="#l28.55"></a><span id="l28.55">                                                 ) override;</span>
<a href="#l28.56"></a><span id="l28.56"> </span>
<a href="#l28.57"></a><span id="l28.57">   nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l28.58"></a><span id="l28.58"> };</span>
<a href="#l28.59"></a><span id="l28.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgGroupView.h</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -27,19 +27,19 @@ public:</span>
<a href="#l29.4"></a><span id="l29.4">                   int32_t *pCount) override;</span>
<a href="#l29.5"></a><span id="l29.5">   NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, nsMsgViewSortTypeValue aSortType,</span>
<a href="#l29.6"></a><span id="l29.6">                                         nsMsgViewSortOrderValue aSortOrder, nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l29.7"></a><span id="l29.7">                                         int32_t *aCount) override;</span>
<a href="#l29.8"></a><span id="l29.8">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l29.9"></a><span id="l29.9">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l29.10"></a><span id="l29.10">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater);</span>
<a href="#l29.11"></a><span id="l29.11">   NS_IMETHOD Close() override;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags, </span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, int32_t aFlags,</span>
<a href="#l29.14"></a><span id="l29.14">                           nsIDBChangeListener *aInstigator) override;</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-  NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, </span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+  NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l29.17"></a><span id="l29.17">                                uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l29.18"></a><span id="l29.18"> </span>
<a href="#l29.19"></a><span id="l29.19">   NS_IMETHOD LoadMessageByViewIndex(nsMsgViewIndex aViewIndex) override;</span>
<a href="#l29.20"></a><span id="l29.20">   NS_IMETHOD GetCellProperties(int32_t aRow, nsITreeColumn *aCol, nsAString&amp; aProperties) override;</span>
<a href="#l29.21"></a><span id="l29.21">   NS_IMETHOD GetRowProperties(int32_t aRow, nsAString&amp; aProperties) override;</span>
<a href="#l29.22"></a><span id="l29.22">   NS_IMETHOD CellTextForColumn(int32_t aRow, const char16_t *aColumnName,</span>
<a href="#l29.23"></a><span id="l29.23">                                nsAString &amp;aValue) override;</span>
<a href="#l29.24"></a><span id="l29.24">   NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread) override;</span>
<a href="#l29.25"></a><span id="l29.25" class="difflineat">@@ -47,17 +47,17 @@ public:</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27"> protected:</span>
<a href="#l29.28"></a><span id="l29.28">   virtual void InternalClose();</span>
<a href="#l29.29"></a><span id="l29.29">   nsMsgGroupThread *AddHdrToThread(nsIMsgDBHdr *msgHdr, bool *pNewThread);</span>
<a href="#l29.30"></a><span id="l29.30">   virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString&amp; aHashKey);</span>
<a href="#l29.31"></a><span id="l29.31">   nsresult GetAgeBucketValue(nsIMsgDBHdr *aMsgHdr, uint32_t * aAgeBucket, bool rcvDate = false); // helper function to get the age bucket for a hdr, useful when grouped by date</span>
<a href="#l29.32"></a><span id="l29.32">   nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool /*ensureListed*/) override;</span>
<a href="#l29.33"></a><span id="l29.33">   virtual int32_t FindLevelInThread(nsIMsgDBHdr *msgHdr, nsMsgViewIndex startOfThread, nsMsgViewIndex viewIndex) override;</span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-  nsMsgViewIndex ThreadIndexOfMsg(nsMsgKey msgKey, </span>
<a href="#l29.35"></a><span id="l29.35" class="difflineplus">+  nsMsgViewIndex ThreadIndexOfMsg(nsMsgKey msgKey,</span>
<a href="#l29.36"></a><span id="l29.36">                                   nsMsgViewIndex msgIndex = nsMsgViewIndex_None,</span>
<a href="#l29.37"></a><span id="l29.37">                                   int32_t *pThreadCount = NULL,</span>
<a href="#l29.38"></a><span id="l29.38">                                   uint32_t *pFlags = NULL) override;</span>
<a href="#l29.39"></a><span id="l29.39"> </span>
<a href="#l29.40"></a><span id="l29.40">   // Returns true if we are grouped by a sort attribute that uses a dummy row.</span>
<a href="#l29.41"></a><span id="l29.41">   bool GroupViewUsesDummyRow();</span>
<a href="#l29.42"></a><span id="l29.42">   nsresult RebuildView(nsMsgViewFlagsTypeValue viewFlags);</span>
<a href="#l29.43"></a><span id="l29.43">   virtual nsMsgGroupThread *CreateGroupThread(nsIMsgDatabase *db);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.cpp</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -356,17 +356,17 @@ NS_IMETHODIMP nsMsgMailSession::RemoveMs</span>
<a href="#l30.4"></a><span id="l30.4">   // Mac keeps a hidden window open so the app doesn't shut down when</span>
<a href="#l30.5"></a><span id="l30.5">   // the last window is closed. So don't shutdown the account manager in that</span>
<a href="#l30.6"></a><span id="l30.6">   // case. Similarly, for suite, we don't want to disable mailnews when the</span>
<a href="#l30.7"></a><span id="l30.7">   // last mail window is closed.</span>
<a href="#l30.8"></a><span id="l30.8"> #if !defined(XP_MACOSX) &amp;&amp; !defined(MOZ_SUITE)</span>
<a href="#l30.9"></a><span id="l30.9">   if (!mWindows.Count())</span>
<a href="#l30.10"></a><span id="l30.10">   {</span>
<a href="#l30.11"></a><span id="l30.11">     nsresult rv;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+    nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l30.14"></a><span id="l30.14">       do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l30.15"></a><span id="l30.15">     if (NS_FAILED(rv))</span>
<a href="#l30.16"></a><span id="l30.16">       return rv;</span>
<a href="#l30.17"></a><span id="l30.17">     accountManager-&gt;CleanupOnExit();</span>
<a href="#l30.18"></a><span id="l30.18">   }</span>
<a href="#l30.19"></a><span id="l30.19"> #endif</span>
<a href="#l30.20"></a><span id="l30.20">   return NS_OK;</span>
<a href="#l30.21"></a><span id="l30.21"> }</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -513,17 +513,17 @@ nsMsgShutdownService::nsMsgShutdownServi</span>
<a href="#l30.23"></a><span id="l30.23">   }</span>
<a href="#l30.24"></a><span id="l30.24"> }</span>
<a href="#l30.25"></a><span id="l30.25"> </span>
<a href="#l30.26"></a><span id="l30.26"> nsMsgShutdownService::~nsMsgShutdownService()</span>
<a href="#l30.27"></a><span id="l30.27"> {</span>
<a href="#l30.28"></a><span id="l30.28">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l30.29"></a><span id="l30.29">     mozilla::services::GetObserverService();</span>
<a href="#l30.30"></a><span id="l30.30">   if (observerService)</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-  {  </span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  {</span>
<a href="#l30.33"></a><span id="l30.33">     observerService-&gt;RemoveObserver(this, &quot;quit-application-requested&quot;);</span>
<a href="#l30.34"></a><span id="l30.34">     observerService-&gt;RemoveObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l30.35"></a><span id="l30.35">     observerService-&gt;RemoveObserver(this, &quot;quit-application&quot;);</span>
<a href="#l30.36"></a><span id="l30.36">   }</span>
<a href="#l30.37"></a><span id="l30.37"> }</span>
<a href="#l30.38"></a><span id="l30.38"> </span>
<a href="#l30.39"></a><span id="l30.39"> nsresult nsMsgShutdownService::ProcessNextTask()</span>
<a href="#l30.40"></a><span id="l30.40"> {</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineat">@@ -531,17 +531,17 @@ nsresult nsMsgShutdownService::ProcessNe</span>
<a href="#l30.42"></a><span id="l30.42"> </span>
<a href="#l30.43"></a><span id="l30.43">   uint32_t count = mShutdownTasks.Length();</span>
<a href="#l30.44"></a><span id="l30.44">   if (mTaskIndex &lt; count)</span>
<a href="#l30.45"></a><span id="l30.45">   {</span>
<a href="#l30.46"></a><span id="l30.46">     shutdownTasksDone = false;</span>
<a href="#l30.47"></a><span id="l30.47"> </span>
<a href="#l30.48"></a><span id="l30.48">     nsCOMPtr&lt;nsIMsgShutdownTask&gt; curTask = mShutdownTasks[mTaskIndex];</span>
<a href="#l30.49"></a><span id="l30.49">     nsString taskName;</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-    curTask-&gt;GetCurrentTaskName(taskName); </span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+    curTask-&gt;GetCurrentTaskName(taskName);</span>
<a href="#l30.52"></a><span id="l30.52">     SetStatusText(taskName);</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l30.55"></a><span id="l30.55">     NS_ENSURE_TRUE(mailSession, NS_ERROR_FAILURE);</span>
<a href="#l30.56"></a><span id="l30.56"> </span>
<a href="#l30.57"></a><span id="l30.57">     nsCOMPtr&lt;nsIMsgWindow&gt; topMsgWindow;</span>
<a href="#l30.58"></a><span id="l30.58">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMsgWindow));</span>
<a href="#l30.59"></a><span id="l30.59"> </span>
<a href="#l30.60"></a><span id="l30.60" class="difflineat">@@ -597,84 +597,84 @@ NS_IMETHODIMP nsMsgShutdownService::Obse</span>
<a href="#l30.61"></a><span id="l30.61"> {</span>
<a href="#l30.62"></a><span id="l30.62">   // Due to bug 459376 we don't always get quit-application-requested and</span>
<a href="#l30.63"></a><span id="l30.63">   // quit-application-granted. quit-application-requested is preferred, but if</span>
<a href="#l30.64"></a><span id="l30.64">   // we don't then we have to hook onto quit-application, but we don't want</span>
<a href="#l30.65"></a><span id="l30.65">   // to do the checking twice so we set some flags to prevent that.</span>
<a href="#l30.66"></a><span id="l30.66">   if (!strcmp(aTopic, &quot;quit-application-granted&quot;))</span>
<a href="#l30.67"></a><span id="l30.67">   {</span>
<a href="#l30.68"></a><span id="l30.68">     // Quit application has been requested and granted, therefore we will shut</span>
<a href="#l30.69"></a><span id="l30.69" class="difflineminus">-    // down. </span>
<a href="#l30.70"></a><span id="l30.70" class="difflineplus">+    // down.</span>
<a href="#l30.71"></a><span id="l30.71">     mProcessedShutdown = true;</span>
<a href="#l30.72"></a><span id="l30.72">     return NS_OK;</span>
<a href="#l30.73"></a><span id="l30.73">   }</span>
<a href="#l30.74"></a><span id="l30.74"> </span>
<a href="#l30.75"></a><span id="l30.75">   // If we've already processed a shutdown notification, no need to do it again.</span>
<a href="#l30.76"></a><span id="l30.76">   if (!strcmp(aTopic, &quot;quit-application&quot;))</span>
<a href="#l30.77"></a><span id="l30.77">   {</span>
<a href="#l30.78"></a><span id="l30.78">     if (mProcessedShutdown)</span>
<a href="#l30.79"></a><span id="l30.79">       return NS_OK;</span>
<a href="#l30.80"></a><span id="l30.80">     else</span>
<a href="#l30.81"></a><span id="l30.81">       mQuitForced = true;</span>
<a href="#l30.82"></a><span id="l30.82">   }</span>
<a href="#l30.83"></a><span id="l30.83"> </span>
<a href="#l30.84"></a><span id="l30.84">   nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l30.85"></a><span id="l30.85">     mozilla::services::GetObserverService();</span>
<a href="#l30.86"></a><span id="l30.86">   NS_ENSURE_STATE(observerService);</span>
<a href="#l30.87"></a><span id="l30.87" class="difflineminus">-  </span>
<a href="#l30.88"></a><span id="l30.88" class="difflineplus">+</span>
<a href="#l30.89"></a><span id="l30.89">   nsCOMPtr&lt;nsISimpleEnumerator&gt; listenerEnum;</span>
<a href="#l30.90"></a><span id="l30.90">   nsresult rv = observerService-&gt;EnumerateObservers(&quot;msg-shutdown&quot;, getter_AddRefs(listenerEnum));</span>
<a href="#l30.91"></a><span id="l30.91">   if (NS_SUCCEEDED(rv) &amp;&amp; listenerEnum)</span>
<a href="#l30.92"></a><span id="l30.92">   {</span>
<a href="#l30.93"></a><span id="l30.93">     bool hasMore;</span>
<a href="#l30.94"></a><span id="l30.94">     listenerEnum-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.95"></a><span id="l30.95">     if (!hasMore)</span>
<a href="#l30.96"></a><span id="l30.96">       return NS_OK;</span>
<a href="#l30.97"></a><span id="l30.97"> </span>
<a href="#l30.98"></a><span id="l30.98">     while (hasMore)</span>
<a href="#l30.99"></a><span id="l30.99">     {</span>
<a href="#l30.100"></a><span id="l30.100">       nsCOMPtr&lt;nsISupports&gt; curObject;</span>
<a href="#l30.101"></a><span id="l30.101">       listenerEnum-&gt;GetNext(getter_AddRefs(curObject));</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineminus">-      </span>
<a href="#l30.103"></a><span id="l30.103" class="difflineplus">+</span>
<a href="#l30.104"></a><span id="l30.104">       nsCOMPtr&lt;nsIMsgShutdownTask&gt; curTask = do_QueryInterface(curObject);</span>
<a href="#l30.105"></a><span id="l30.105">       if (curTask)</span>
<a href="#l30.106"></a><span id="l30.106">       {</span>
<a href="#l30.107"></a><span id="l30.107">         bool shouldRunTask;</span>
<a href="#l30.108"></a><span id="l30.108">         curTask-&gt;GetNeedsToRunTask(&amp;shouldRunTask);</span>
<a href="#l30.109"></a><span id="l30.109">         if (shouldRunTask)</span>
<a href="#l30.110"></a><span id="l30.110">           mShutdownTasks.AppendObject(curTask);</span>
<a href="#l30.111"></a><span id="l30.111">       }</span>
<a href="#l30.112"></a><span id="l30.112" class="difflineminus">-      </span>
<a href="#l30.113"></a><span id="l30.113" class="difflineplus">+</span>
<a href="#l30.114"></a><span id="l30.114">       listenerEnum-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l30.115"></a><span id="l30.115">     }</span>
<a href="#l30.116"></a><span id="l30.116"> </span>
<a href="#l30.117"></a><span id="l30.117">     if (mShutdownTasks.Count() &lt; 1)</span>
<a href="#l30.118"></a><span id="l30.118">       return NS_ERROR_FAILURE;</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineminus">-    </span>
<a href="#l30.120"></a><span id="l30.120" class="difflineplus">+</span>
<a href="#l30.121"></a><span id="l30.121">     mTaskIndex = 0;</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-    </span>
<a href="#l30.123"></a><span id="l30.123" class="difflineplus">+</span>
<a href="#l30.124"></a><span id="l30.124">     mMsgProgress = do_CreateInstance(NS_MSGPROGRESS_CONTRACTID);</span>
<a href="#l30.125"></a><span id="l30.125">     NS_ENSURE_TRUE(mMsgProgress, NS_ERROR_FAILURE);</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineminus">-    </span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+</span>
<a href="#l30.128"></a><span id="l30.128">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID);</span>
<a href="#l30.129"></a><span id="l30.129">     NS_ENSURE_TRUE(mailSession, NS_ERROR_FAILURE);</span>
<a href="#l30.130"></a><span id="l30.130"> </span>
<a href="#l30.131"></a><span id="l30.131">     nsCOMPtr&lt;nsIMsgWindow&gt; topMsgWindow;</span>
<a href="#l30.132"></a><span id="l30.132">     mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(topMsgWindow));</span>
<a href="#l30.133"></a><span id="l30.133" class="difflineminus">-    </span>
<a href="#l30.134"></a><span id="l30.134" class="difflineplus">+</span>
<a href="#l30.135"></a><span id="l30.135">     nsCOMPtr&lt;mozIDOMWindowProxy&gt; internalDomWin;</span>
<a href="#l30.136"></a><span id="l30.136">     if (topMsgWindow)</span>
<a href="#l30.137"></a><span id="l30.137">       topMsgWindow-&gt;GetDomWindow(getter_AddRefs(internalDomWin));</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineminus">-    </span>
<a href="#l30.139"></a><span id="l30.139" class="difflineplus">+</span>
<a href="#l30.140"></a><span id="l30.140">     if (!internalDomWin)</span>
<a href="#l30.141"></a><span id="l30.141">     {</span>
<a href="#l30.142"></a><span id="l30.142" class="difflineminus">-      // First see if there is a window open. </span>
<a href="#l30.143"></a><span id="l30.143" class="difflineplus">+      // First see if there is a window open.</span>
<a href="#l30.144"></a><span id="l30.144">       nsCOMPtr&lt;nsIWindowMediator&gt; winMed = do_GetService(NS_WINDOWMEDIATOR_CONTRACTID);</span>
<a href="#l30.145"></a><span id="l30.145">       winMed-&gt;GetMostRecentWindow(nullptr, getter_AddRefs(internalDomWin));</span>
<a href="#l30.146"></a><span id="l30.146" class="difflineminus">-      </span>
<a href="#l30.147"></a><span id="l30.147" class="difflineplus">+</span>
<a href="#l30.148"></a><span id="l30.148">       //If not use the hidden window.</span>
<a href="#l30.149"></a><span id="l30.149">       if (!internalDomWin)</span>
<a href="#l30.150"></a><span id="l30.150">       {</span>
<a href="#l30.151"></a><span id="l30.151">         nsCOMPtr&lt;nsIAppShellService&gt; appShell(do_GetService(NS_APPSHELLSERVICE_CONTRACTID));</span>
<a href="#l30.152"></a><span id="l30.152">         appShell-&gt;GetHiddenDOMWindow(getter_AddRefs(internalDomWin));</span>
<a href="#l30.153"></a><span id="l30.153">         NS_ENSURE_TRUE(internalDomWin, NS_ERROR_FAILURE);  // bail if we don't get a window.</span>
<a href="#l30.154"></a><span id="l30.154">       }</span>
<a href="#l30.155"></a><span id="l30.155">     }</span>
<a href="#l30.156"></a><span id="l30.156" class="difflineat">@@ -686,18 +686,18 @@ NS_IMETHODIMP nsMsgShutdownService::Obse</span>
<a href="#l30.157"></a><span id="l30.157"> </span>
<a href="#l30.158"></a><span id="l30.158">       // If the attempted quit was a restart, be sure to restart the app once</span>
<a href="#l30.159"></a><span id="l30.159">       // the tasks have been run. This is usually the case when addons or</span>
<a href="#l30.160"></a><span id="l30.160">       // updates are going to be installed.</span>
<a href="#l30.161"></a><span id="l30.161">       if (aData &amp;&amp; nsDependentString(aData).EqualsLiteral(&quot;restart&quot;))</span>
<a href="#l30.162"></a><span id="l30.162">         mQuitMode |= nsIAppStartup::eRestart;</span>
<a href="#l30.163"></a><span id="l30.163">     }</span>
<a href="#l30.164"></a><span id="l30.164"> </span>
<a href="#l30.165"></a><span id="l30.165" class="difflineminus">-    mMsgProgress-&gt;OpenProgressDialog(internalDomWin, topMsgWindow, </span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-                                     &quot;chrome://messenger/content/shutdownWindow.xul&quot;, </span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+    mMsgProgress-&gt;OpenProgressDialog(internalDomWin, topMsgWindow,</span>
<a href="#l30.168"></a><span id="l30.168" class="difflineplus">+                                     &quot;chrome://messenger/content/shutdownWindow.xul&quot;,</span>
<a href="#l30.169"></a><span id="l30.169">                                      false, nullptr);</span>
<a href="#l30.170"></a><span id="l30.170"> </span>
<a href="#l30.171"></a><span id="l30.171">     if (mQuitForced)</span>
<a href="#l30.172"></a><span id="l30.172">     {</span>
<a href="#l30.173"></a><span id="l30.173">       nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l30.174"></a><span id="l30.174"> </span>
<a href="#l30.175"></a><span id="l30.175">       mReadyToQuit = false;</span>
<a href="#l30.176"></a><span id="l30.176">       while (!mReadyToQuit)</span>
<a href="#l30.177"></a><span id="l30.177" class="difflineat">@@ -705,17 +705,17 @@ NS_IMETHODIMP nsMsgShutdownService::Obse</span>
<a href="#l30.178"></a><span id="l30.178">         PR_CEnterMonitor(this);</span>
<a href="#l30.179"></a><span id="l30.179">         // Waiting for 50 milliseconds</span>
<a href="#l30.180"></a><span id="l30.180">         PR_CWait(this, PR_MicrosecondsToInterval(50000UL));</span>
<a href="#l30.181"></a><span id="l30.181">         PR_CExitMonitor(this);</span>
<a href="#l30.182"></a><span id="l30.182">         NS_ProcessPendingEvents(thread);</span>
<a href="#l30.183"></a><span id="l30.183">       }</span>
<a href="#l30.184"></a><span id="l30.184">     }</span>
<a href="#l30.185"></a><span id="l30.185">   }</span>
<a href="#l30.186"></a><span id="l30.186" class="difflineminus">-  </span>
<a href="#l30.187"></a><span id="l30.187" class="difflineplus">+</span>
<a href="#l30.188"></a><span id="l30.188">   return NS_OK;</span>
<a href="#l30.189"></a><span id="l30.189"> }</span>
<a href="#l30.190"></a><span id="l30.190"> </span>
<a href="#l30.191"></a><span id="l30.191"> // nsIUrlListener</span>
<a href="#l30.192"></a><span id="l30.192"> NS_IMETHODIMP nsMsgShutdownService::OnStartRunningUrl(nsIURI *url)</span>
<a href="#l30.193"></a><span id="l30.193"> {</span>
<a href="#l30.194"></a><span id="l30.194">   return NS_OK;</span>
<a href="#l30.195"></a><span id="l30.195"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgMailSession.h</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -20,18 +20,18 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;nsIMsgUserFeedbackListener.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> ///////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.9"></a><span id="l31.9"> // The mail session is a replacement for the old 4.x MSG_Master object. It contains</span>
<a href="#l31.10"></a><span id="l31.10"> // mail session generic information such as the user's current mail identity, ....</span>
<a href="#l31.11"></a><span id="l31.11"> // I'm starting this off as an empty interface and as people feel they need to</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-// add more information to it, they can. I think this is a better approach than </span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-// trying to port over the old MSG_Master in its entirety as that had a lot of </span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+// add more information to it, they can. I think this is a better approach than</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+// trying to port over the old MSG_Master in its entirety as that had a lot of</span>
<a href="#l31.16"></a><span id="l31.16"> // cruft in it....</span>
<a href="#l31.17"></a><span id="l31.17"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.18"></a><span id="l31.18"> </span>
<a href="#l31.19"></a><span id="l31.19"> class nsMsgMailSession : public nsIMsgMailSession,</span>
<a href="#l31.20"></a><span id="l31.20">                          public nsIFolderListener</span>
<a href="#l31.21"></a><span id="l31.21"> {</span>
<a href="#l31.22"></a><span id="l31.22"> public:</span>
<a href="#l31.23"></a><span id="l31.23">   nsMsgMailSession();</span>
<a href="#l31.24"></a><span id="l31.24" class="difflineat">@@ -76,26 +76,26 @@ protected:</span>
<a href="#l31.25"></a><span id="l31.25"> /********************************************************************************/</span>
<a href="#l31.26"></a><span id="l31.26"> </span>
<a href="#l31.27"></a><span id="l31.27"> class nsMsgShutdownService : public nsIMsgShutdownService,</span>
<a href="#l31.28"></a><span id="l31.28">                              public nsIUrlListener,</span>
<a href="#l31.29"></a><span id="l31.29">                              public nsIObserver</span>
<a href="#l31.30"></a><span id="l31.30"> {</span>
<a href="#l31.31"></a><span id="l31.31"> public:</span>
<a href="#l31.32"></a><span id="l31.32">   nsMsgShutdownService();</span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-  </span>
<a href="#l31.34"></a><span id="l31.34" class="difflineplus">+</span>
<a href="#l31.35"></a><span id="l31.35">   NS_DECL_ISUPPORTS</span>
<a href="#l31.36"></a><span id="l31.36">   NS_DECL_NSIMSGSHUTDOWNSERVICE</span>
<a href="#l31.37"></a><span id="l31.37">   NS_DECL_NSIURLLISTENER</span>
<a href="#l31.38"></a><span id="l31.38">   NS_DECL_NSIOBSERVER</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-    </span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+</span>
<a href="#l31.41"></a><span id="l31.41"> protected:</span>
<a href="#l31.42"></a><span id="l31.42">   nsresult ProcessNextTask();</span>
<a href="#l31.43"></a><span id="l31.43">   void AttemptShutdown();</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-  </span>
<a href="#l31.45"></a><span id="l31.45" class="difflineplus">+</span>
<a href="#l31.46"></a><span id="l31.46"> private:</span>
<a href="#l31.47"></a><span id="l31.47">   virtual ~nsMsgShutdownService();</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49">   nsCOMArray&lt;nsIMsgShutdownTask&gt; mShutdownTasks;</span>
<a href="#l31.50"></a><span id="l31.50">   nsCOMPtr&lt;nsIMsgProgress&gt;       mMsgProgress;</span>
<a href="#l31.51"></a><span id="l31.51">   uint32_t                       mTaskIndex;</span>
<a href="#l31.52"></a><span id="l31.52">   uint32_t                       mQuitMode;</span>
<a href="#l31.53"></a><span id="l31.53">   bool mProcessedShutdown;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgOfflineManager.cpp</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -173,17 +173,17 @@ nsresult nsMsgOfflineManager::Synchroniz</span>
<a href="#l32.4"></a><span id="l32.4">   return imapService-&gt;PlaybackAllOfflineOperations(m_window, this, getter_AddRefs(mOfflineImapSync));</span>
<a href="#l32.5"></a><span id="l32.5"> }</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> nsresult nsMsgOfflineManager::SendUnsentMessages()</span>
<a href="#l32.8"></a><span id="l32.8"> {</span>
<a href="#l32.9"></a><span id="l32.9">   nsresult rv;</span>
<a href="#l32.10"></a><span id="l32.10">   nsCOMPtr&lt;nsIMsgSendLater&gt; pMsgSendLater(do_GetService(kMsgSendLaterCID, &amp;rv));</span>
<a href="#l32.11"></a><span id="l32.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager = </span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+  nsCOMPtr&lt;nsIMsgAccountManager&gt; accountManager =</span>
<a href="#l32.14"></a><span id="l32.14">            do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l32.15"></a><span id="l32.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l32.16"></a><span id="l32.16">   // now we have to iterate over the identities, finding the *unique* unsent messages folder</span>
<a href="#l32.17"></a><span id="l32.17">   // for each one, determine if they have unsent messages, and if so, add them to the list</span>
<a href="#l32.18"></a><span id="l32.18">   // of identities to send unsent messages from.</span>
<a href="#l32.19"></a><span id="l32.19">   // However, I think there's only ever one unsent messages folder at the moment,</span>
<a href="#l32.20"></a><span id="l32.20">   // so I think we'll go with that for now.</span>
<a href="#l32.21"></a><span id="l32.21">   nsCOMPtr&lt;nsIArray&gt; identities;</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineat">@@ -210,42 +210,42 @@ nsresult nsMsgOfflineManager::SendUnsent</span>
<a href="#l32.23"></a><span id="l32.23">         if (numMessages &gt; 0)</span>
<a href="#l32.24"></a><span id="l32.24">         {</span>
<a href="#l32.25"></a><span id="l32.25">           identityToUse = thisIdentity;</span>
<a href="#l32.26"></a><span id="l32.26">           break;</span>
<a href="#l32.27"></a><span id="l32.27">         }</span>
<a href="#l32.28"></a><span id="l32.28">       }</span>
<a href="#l32.29"></a><span id="l32.29">     }</span>
<a href="#l32.30"></a><span id="l32.30">   }</span>
<a href="#l32.31"></a><span id="l32.31" class="difflineminus">-  if (identityToUse) </span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-  { </span>
<a href="#l32.33"></a><span id="l32.33" class="difflineplus">+  if (identityToUse)</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+  {</span>
<a href="#l32.35"></a><span id="l32.35"> #ifdef MOZ_SUITE</span>
<a href="#l32.36"></a><span id="l32.36">     if (m_statusFeedback)</span>
<a href="#l32.37"></a><span id="l32.37">       pMsgSendLater-&gt;SetStatusFeedback(m_statusFeedback);</span>
<a href="#l32.38"></a><span id="l32.38"> #endif</span>
<a href="#l32.39"></a><span id="l32.39"> </span>
<a href="#l32.40"></a><span id="l32.40">     pMsgSendLater-&gt;AddListener(this);</span>
<a href="#l32.41"></a><span id="l32.41">     rv = pMsgSendLater-&gt;SendUnsentMessages(identityToUse);</span>
<a href="#l32.42"></a><span id="l32.42">     ShowStatus(&quot;sendingUnsent&quot;);</span>
<a href="#l32.43"></a><span id="l32.43">     // if we succeeded, return - we'll run the next operation when the</span>
<a href="#l32.44"></a><span id="l32.44">     // send finishes. Otherwise, advance to the next state.</span>
<a href="#l32.45"></a><span id="l32.45">     if (NS_SUCCEEDED(rv))</span>
<a href="#l32.46"></a><span id="l32.46">       return rv;</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineminus">-  } </span>
<a href="#l32.48"></a><span id="l32.48" class="difflineplus">+  }</span>
<a href="#l32.49"></a><span id="l32.49">   return AdvanceToNextState(rv);</span>
<a href="#l32.50"></a><span id="l32.50"> </span>
<a href="#l32.51"></a><span id="l32.51"> }</span>
<a href="#l32.52"></a><span id="l32.52"> </span>
<a href="#l32.53"></a><span id="l32.53"> #define MESSENGER_STRING_URL       &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l32.54"></a><span id="l32.54"> </span>
<a href="#l32.55"></a><span id="l32.55"> nsresult nsMsgOfflineManager::ShowStatus(const char *statusMsgName)</span>
<a href="#l32.56"></a><span id="l32.56"> {</span>
<a href="#l32.57"></a><span id="l32.57">   if (!mStringBundle)</span>
<a href="#l32.58"></a><span id="l32.58">   {</span>
<a href="#l32.59"></a><span id="l32.59" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService = </span>
<a href="#l32.60"></a><span id="l32.60" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l32.61"></a><span id="l32.61">       mozilla::services::GetStringBundleService();</span>
<a href="#l32.62"></a><span id="l32.62">     NS_ENSURE_TRUE(sBundleService, NS_ERROR_UNEXPECTED);</span>
<a href="#l32.63"></a><span id="l32.63">     sBundleService-&gt;CreateBundle(MESSENGER_STRING_URL, getter_AddRefs(mStringBundle));</span>
<a href="#l32.64"></a><span id="l32.64">     return NS_OK;</span>
<a href="#l32.65"></a><span id="l32.65">   }</span>
<a href="#l32.66"></a><span id="l32.66"> </span>
<a href="#l32.67"></a><span id="l32.67">   nsString statusString;</span>
<a href="#l32.68"></a><span id="l32.68">   nsresult res = mStringBundle-&gt;GetStringFromName(statusMsgName, statusString);</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineat">@@ -340,17 +340,17 @@ nsMsgOfflineManager::OnStopRunningUrl(ns</span>
<a href="#l32.70"></a><span id="l32.70">   return NS_OK;</span>
<a href="#l32.71"></a><span id="l32.71"> }</span>
<a href="#l32.72"></a><span id="l32.72"> </span>
<a href="#l32.73"></a><span id="l32.73"> NS_IMETHODIMP nsMsgOfflineManager::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *someData)</span>
<a href="#l32.74"></a><span id="l32.74"> {</span>
<a href="#l32.75"></a><span id="l32.75">   return NS_OK;</span>
<a href="#l32.76"></a><span id="l32.76"> }</span>
<a href="#l32.77"></a><span id="l32.77"> </span>
<a href="#l32.78"></a><span id="l32.78" class="difflineminus">-// nsIMsgSendLaterListener implementation </span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+// nsIMsgSendLaterListener implementation</span>
<a href="#l32.80"></a><span id="l32.80"> NS_IMETHODIMP</span>
<a href="#l32.81"></a><span id="l32.81"> nsMsgOfflineManager::OnStartSending(uint32_t aTotalMessageCount)</span>
<a href="#l32.82"></a><span id="l32.82"> {</span>
<a href="#l32.83"></a><span id="l32.83">   return NS_OK;</span>
<a href="#l32.84"></a><span id="l32.84"> }</span>
<a href="#l32.85"></a><span id="l32.85"> </span>
<a href="#l32.86"></a><span id="l32.86"> NS_IMETHODIMP</span>
<a href="#l32.87"></a><span id="l32.87"> nsMsgOfflineManager::OnMessageStartSending(uint32_t aCurrentMessage,</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineat">@@ -380,17 +380,17 @@ nsMsgOfflineManager::OnMessageSendError(</span>
<a href="#l32.89"></a><span id="l32.89">                                         nsresult aStatus,</span>
<a href="#l32.90"></a><span id="l32.90">                                         const char16_t *aMsg)</span>
<a href="#l32.91"></a><span id="l32.91"> {</span>
<a href="#l32.92"></a><span id="l32.92">   return NS_OK;</span>
<a href="#l32.93"></a><span id="l32.93"> }</span>
<a href="#l32.94"></a><span id="l32.94"> </span>
<a href="#l32.95"></a><span id="l32.95"> NS_IMETHODIMP</span>
<a href="#l32.96"></a><span id="l32.96"> nsMsgOfflineManager::OnStopSending(nsresult aStatus,</span>
<a href="#l32.97"></a><span id="l32.97" class="difflineminus">-                                   const char16_t *aMsg, uint32_t aTotalTried, </span>
<a href="#l32.98"></a><span id="l32.98" class="difflineplus">+                                   const char16_t *aMsg, uint32_t aTotalTried,</span>
<a href="#l32.99"></a><span id="l32.99">                                    uint32_t aSuccessful)</span>
<a href="#l32.100"></a><span id="l32.100"> {</span>
<a href="#l32.101"></a><span id="l32.101"> #ifdef NS_DEBUG</span>
<a href="#l32.102"></a><span id="l32.102">   if (NS_SUCCEEDED(aStatus))</span>
<a href="#l32.103"></a><span id="l32.103">     printf(&quot;SendLaterListener::OnStopSending: Tried to send %d messages. %d successful.\n&quot;,</span>
<a href="#l32.104"></a><span id="l32.104">             aTotalTried, aSuccessful);</span>
<a href="#l32.105"></a><span id="l32.105"> #endif</span>
<a href="#l32.106"></a><span id="l32.106">   return AdvanceToNextState(aStatus);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/src/nsMsgOfflineManager.h</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgOfflineManager.h</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -21,38 +21,38 @@ class nsMsgOfflineManager</span>
<a href="#l33.4"></a><span id="l33.4">       public nsIObserver,</span>
<a href="#l33.5"></a><span id="l33.5">       public nsSupportsWeakReference,</span>
<a href="#l33.6"></a><span id="l33.6">       public nsIMsgSendLaterListener,</span>
<a href="#l33.7"></a><span id="l33.7">     public nsIUrlListener</span>
<a href="#l33.8"></a><span id="l33.8"> {</span>
<a href="#l33.9"></a><span id="l33.9"> public:</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11">   nsMsgOfflineManager();</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-  </span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+</span>
<a href="#l33.14"></a><span id="l33.14">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">- </span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+</span>
<a href="#l33.17"></a><span id="l33.17">   /* nsIMsgOfflineManager methods */</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineminus">-  </span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+</span>
<a href="#l33.20"></a><span id="l33.20">   NS_DECL_NSIMSGOFFLINEMANAGER</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-  NS_DECL_NSIOBSERVER  </span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+  NS_DECL_NSIOBSERVER</span>
<a href="#l33.23"></a><span id="l33.23">   NS_DECL_NSIURLLISTENER</span>
<a href="#l33.24"></a><span id="l33.24">   NS_DECL_NSIMSGSENDLATERLISTENER</span>
<a href="#l33.25"></a><span id="l33.25"> </span>
<a href="#l33.26"></a><span id="l33.26" class="difflineminus">-  typedef enum </span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+  typedef enum</span>
<a href="#l33.28"></a><span id="l33.28">   {</span>
<a href="#l33.29"></a><span id="l33.29">     eStarting = 0,</span>
<a href="#l33.30"></a><span id="l33.30"> 	  eSynchronizingOfflineImapChanges = 1,</span>
<a href="#l33.31"></a><span id="l33.31">     eDownloadingNews = 2,</span>
<a href="#l33.32"></a><span id="l33.32">     eDownloadingMail = 3,</span>
<a href="#l33.33"></a><span id="l33.33"> 	  eSendingUnsent = 4,</span>
<a href="#l33.34"></a><span id="l33.34">     eDone = 5,</span>
<a href="#l33.35"></a><span id="l33.35">     eNoState = 6  // we're not doing anything</span>
<a href="#l33.36"></a><span id="l33.36">   } offlineManagerState;</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38" class="difflineminus">-  typedef enum </span>
<a href="#l33.39"></a><span id="l33.39" class="difflineplus">+  typedef enum</span>
<a href="#l33.40"></a><span id="l33.40">   {</span>
<a href="#l33.41"></a><span id="l33.41">     eGoingOnline = 0,</span>
<a href="#l33.42"></a><span id="l33.42">     eDownloadingForOffline = 1,</span>
<a href="#l33.43"></a><span id="l33.43">     eNoOp = 2 // no operation in progress</span>
<a href="#l33.44"></a><span id="l33.44">   } offlineManagerOperation;</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46"> private:</span>
<a href="#l33.47"></a><span id="l33.47">   virtual ~nsMsgOfflineManager();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.cpp</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -55,42 +55,42 @@ nsMsgPrintEngine::nsMsgPrintEngine() :</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5"> </span>
<a href="#l34.6"></a><span id="l34.6"> nsMsgPrintEngine::~nsMsgPrintEngine()</span>
<a href="#l34.7"></a><span id="l34.7"> {</span>
<a href="#l34.8"></a><span id="l34.8"> }</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10"> // Implement AddRef and Release</span>
<a href="#l34.11"></a><span id="l34.11"> NS_IMPL_ISUPPORTS(nsMsgPrintEngine,</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-                         nsIMsgPrintEngine, </span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-                         nsIWebProgressListener, </span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+                         nsIMsgPrintEngine,</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+                         nsIWebProgressListener,</span>
<a href="#l34.16"></a><span id="l34.16">                          nsIObserver,</span>
<a href="#l34.17"></a><span id="l34.17">                          nsISupportsWeakReference)</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19"> // nsIWebProgressListener implementation</span>
<a href="#l34.20"></a><span id="l34.20"> NS_IMETHODIMP</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineminus">-nsMsgPrintEngine::OnStateChange(nsIWebProgress* aWebProgress, </span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-                   nsIRequest *aRequest, </span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-                   uint32_t progressStateFlags, </span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+nsMsgPrintEngine::OnStateChange(nsIWebProgress* aWebProgress,</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+                   nsIRequest *aRequest,</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+                   uint32_t progressStateFlags,</span>
<a href="#l34.27"></a><span id="l34.27">                    nsresult aStatus)</span>
<a href="#l34.28"></a><span id="l34.28"> {</span>
<a href="#l34.29"></a><span id="l34.29">   nsresult rv = NS_OK;</span>
<a href="#l34.30"></a><span id="l34.30"> </span>
<a href="#l34.31"></a><span id="l34.31">   // top-level document load data</span>
<a href="#l34.32"></a><span id="l34.32">   if (progressStateFlags &amp; nsIWebProgressListener::STATE_IS_DOCUMENT) {</span>
<a href="#l34.33"></a><span id="l34.33">     if (progressStateFlags &amp; nsIWebProgressListener::STATE_START) {</span>
<a href="#l34.34"></a><span id="l34.34">       // Tell the user we are loading...</span>
<a href="#l34.35"></a><span id="l34.35">       nsString msg;</span>
<a href="#l34.36"></a><span id="l34.36">       GetString(u&quot;LoadingMessageToPrint&quot;, msg);</span>
<a href="#l34.37"></a><span id="l34.37">       SetStatusMessage(msg);</span>
<a href="#l34.38"></a><span id="l34.38">     }</span>
<a href="#l34.39"></a><span id="l34.39"> </span>
<a href="#l34.40"></a><span id="l34.40">     if (progressStateFlags &amp; nsIWebProgressListener::STATE_STOP) {</span>
<a href="#l34.41"></a><span id="l34.41">       nsCOMPtr&lt;nsIDocumentLoader&gt; docLoader(do_QueryInterface(aWebProgress));</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineminus">-      if (docLoader) </span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+      if (docLoader)</span>
<a href="#l34.44"></a><span id="l34.44">       {</span>
<a href="#l34.45"></a><span id="l34.45">         // Check to see if the document DOMWin that is finished loading is the same</span>
<a href="#l34.46"></a><span id="l34.46">         // one as the mail msg that we started to load.</span>
<a href="#l34.47"></a><span id="l34.47">         // We only want to print when the entire msg and all of its attachments</span>
<a href="#l34.48"></a><span id="l34.48">         // have finished loading.</span>
<a href="#l34.49"></a><span id="l34.49">         // The mail msg doc is the last one to receive the STATE_STOP notification</span>
<a href="#l34.50"></a><span id="l34.50">         nsCOMPtr&lt;nsISupports&gt; container;</span>
<a href="#l34.51"></a><span id="l34.51">         docLoader-&gt;GetContainer(getter_AddRefs(container));</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineat">@@ -109,63 +109,63 @@ nsMsgPrintEngine::OnStateChange(nsIWebPr</span>
<a href="#l34.53"></a><span id="l34.53"> </span>
<a href="#l34.54"></a><span id="l34.54">       bool isPrintingCancelled = false;</span>
<a href="#l34.55"></a><span id="l34.55">       if (mPrintSettings)</span>
<a href="#l34.56"></a><span id="l34.56">       {</span>
<a href="#l34.57"></a><span id="l34.57">         mPrintSettings-&gt;GetIsCancelled(&amp;isPrintingCancelled);</span>
<a href="#l34.58"></a><span id="l34.58">       }</span>
<a href="#l34.59"></a><span id="l34.59">       if (!isPrintingCancelled) {</span>
<a href="#l34.60"></a><span id="l34.60">         // if aWebProgress is a documentloader than the notification from</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-        // loading the documents. If it is NULL (or not a DocLoader) then it </span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+        // loading the documents. If it is NULL (or not a DocLoader) then it</span>
<a href="#l34.63"></a><span id="l34.63">         // it coming from Printing</span>
<a href="#l34.64"></a><span id="l34.64">         if (docLoader) {</span>
<a href="#l34.65"></a><span id="l34.65">           // Now, fire off the print operation!</span>
<a href="#l34.66"></a><span id="l34.66">           rv = NS_ERROR_FAILURE;</span>
<a href="#l34.67"></a><span id="l34.67"> </span>
<a href="#l34.68"></a><span id="l34.68">           // Tell the user the message is loaded...</span>
<a href="#l34.69"></a><span id="l34.69">           nsString msg;</span>
<a href="#l34.70"></a><span id="l34.70">           GetString(u&quot;MessageLoaded&quot;, msg);</span>
<a href="#l34.71"></a><span id="l34.71">           SetStatusMessage(msg);</span>
<a href="#l34.72"></a><span id="l34.72"> </span>
<a href="#l34.73"></a><span id="l34.73">           NS_ASSERTION(mDocShell,&quot;can't print, there is no docshell&quot;);</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-          if ( (!mDocShell) || (!aRequest) ) </span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+          if ( (!mDocShell) || (!aRequest) )</span>
<a href="#l34.76"></a><span id="l34.76">           {</span>
<a href="#l34.77"></a><span id="l34.77">             return StartNextPrintOperation();</span>
<a href="#l34.78"></a><span id="l34.78">           }</span>
<a href="#l34.79"></a><span id="l34.79">           nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(aRequest);</span>
<a href="#l34.80"></a><span id="l34.80">           if (!aChannel) return NS_ERROR_FAILURE;</span>
<a href="#l34.81"></a><span id="l34.81"> </span>
<a href="#l34.82"></a><span id="l34.82">           // Make sure this isn't just &quot;about:blank&quot; finishing....</span>
<a href="#l34.83"></a><span id="l34.83">           nsCOMPtr&lt;nsIURI&gt; originalURI = nullptr;</span>
<a href="#l34.84"></a><span id="l34.84">           if (NS_SUCCEEDED(aChannel-&gt;GetOriginalURI(getter_AddRefs(originalURI))) &amp;&amp; originalURI)</span>
<a href="#l34.85"></a><span id="l34.85">           {</span>
<a href="#l34.86"></a><span id="l34.86">             nsAutoCString spec;</span>
<a href="#l34.87"></a><span id="l34.87"> </span>
<a href="#l34.88"></a><span id="l34.88">             if (NS_SUCCEEDED(originalURI-&gt;GetSpec(spec)))</span>
<a href="#l34.89"></a><span id="l34.89" class="difflineminus">-            {      </span>
<a href="#l34.90"></a><span id="l34.90" class="difflineplus">+            {</span>
<a href="#l34.91"></a><span id="l34.91">               if (spec.Equals(&quot;about:blank&quot;))</span>
<a href="#l34.92"></a><span id="l34.92">               {</span>
<a href="#l34.93"></a><span id="l34.93">                 return StartNextPrintOperation();</span>
<a href="#l34.94"></a><span id="l34.94">               }</span>
<a href="#l34.95"></a><span id="l34.95">             }</span>
<a href="#l34.96"></a><span id="l34.96">           }</span>
<a href="#l34.97"></a><span id="l34.97"> </span>
<a href="#l34.98"></a><span id="l34.98">           // If something bad happens here (menaing we can fire the PLEvent, highly unlikely)</span>
<a href="#l34.99"></a><span id="l34.99" class="difflineminus">-          // we will still ask the msg to print, but if the user &quot;cancels&quot; out of the </span>
<a href="#l34.100"></a><span id="l34.100" class="difflineplus">+          // we will still ask the msg to print, but if the user &quot;cancels&quot; out of the</span>
<a href="#l34.101"></a><span id="l34.101">           // print dialog the hidden print window will not be &quot;closed&quot;</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineminus">-          if (!FirePrintEvent()) </span>
<a href="#l34.103"></a><span id="l34.103" class="difflineplus">+          if (!FirePrintEvent())</span>
<a href="#l34.104"></a><span id="l34.104">           {</span>
<a href="#l34.105"></a><span id="l34.105">             PrintMsgWindow();</span>
<a href="#l34.106"></a><span id="l34.106">           }</span>
<a href="#l34.107"></a><span id="l34.107">         } else {</span>
<a href="#l34.108"></a><span id="l34.108">           FireStartNextEvent();</span>
<a href="#l34.109"></a><span id="l34.109">           rv = NS_OK;</span>
<a href="#l34.110"></a><span id="l34.110">         }</span>
<a href="#l34.111"></a><span id="l34.111" class="difflineminus">-      } </span>
<a href="#l34.112"></a><span id="l34.112" class="difflineminus">-      else </span>
<a href="#l34.113"></a><span id="l34.113" class="difflineplus">+      }</span>
<a href="#l34.114"></a><span id="l34.114" class="difflineplus">+      else</span>
<a href="#l34.115"></a><span id="l34.115">       {</span>
<a href="#l34.116"></a><span id="l34.116">         if (mWindow) {</span>
<a href="#l34.117"></a><span id="l34.117">           nsPIDOMWindowOuter::From(mWindow)-&gt;Close();</span>
<a href="#l34.118"></a><span id="l34.118">         }</span>
<a href="#l34.119"></a><span id="l34.119">       }</span>
<a href="#l34.120"></a><span id="l34.120">     }</span>
<a href="#l34.121"></a><span id="l34.121">   }</span>
<a href="#l34.122"></a><span id="l34.122"> </span>
<a href="#l34.123"></a><span id="l34.123" class="difflineat">@@ -200,25 +200,25 @@ nsMsgPrintEngine::OnStatusChange(nsIWebP</span>
<a href="#l34.124"></a><span id="l34.124">                     nsresult aStatus,</span>
<a href="#l34.125"></a><span id="l34.125">                     const char16_t* aMessage)</span>
<a href="#l34.126"></a><span id="l34.126"> {</span>
<a href="#l34.127"></a><span id="l34.127">     return NS_OK;</span>
<a href="#l34.128"></a><span id="l34.128"> }</span>
<a href="#l34.129"></a><span id="l34.129"> </span>
<a href="#l34.130"></a><span id="l34.130"> </span>
<a href="#l34.131"></a><span id="l34.131"> NS_IMETHODIMP</span>
<a href="#l34.132"></a><span id="l34.132" class="difflineminus">-nsMsgPrintEngine::OnSecurityChange(nsIWebProgress *aWebProgress, </span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-                      nsIRequest *aRequest, </span>
<a href="#l34.134"></a><span id="l34.134" class="difflineplus">+nsMsgPrintEngine::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineplus">+                      nsIRequest *aRequest,</span>
<a href="#l34.136"></a><span id="l34.136">                       uint32_t state)</span>
<a href="#l34.137"></a><span id="l34.137"> {</span>
<a href="#l34.138"></a><span id="l34.138">     NS_NOTREACHED(&quot;notification excluded in AddProgressListener(...)&quot;);</span>
<a href="#l34.139"></a><span id="l34.139">     return NS_OK;</span>
<a href="#l34.140"></a><span id="l34.140"> }</span>
<a href="#l34.141"></a><span id="l34.141"> </span>
<a href="#l34.142"></a><span id="l34.142" class="difflineminus">-NS_IMETHODIMP    </span>
<a href="#l34.143"></a><span id="l34.143" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l34.144"></a><span id="l34.144"> nsMsgPrintEngine::SetWindow(mozIDOMWindowProxy *aWin)</span>
<a href="#l34.145"></a><span id="l34.145"> {</span>
<a href="#l34.146"></a><span id="l34.146">   if (!aWin)</span>
<a href="#l34.147"></a><span id="l34.147">   {</span>
<a href="#l34.148"></a><span id="l34.148">     // It isn't an error to pass in null for aWin, in fact it means we are shutting</span>
<a href="#l34.149"></a><span id="l34.149">     // down and we should start cleaning things up...</span>
<a href="#l34.150"></a><span id="l34.150">     return NS_OK;</span>
<a href="#l34.151"></a><span id="l34.151">   }</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineat">@@ -268,17 +268,17 @@ nsMsgPrintEngine::ShowWindow(bool aShow)</span>
<a href="#l34.153"></a><span id="l34.153">   nsCOMPtr&lt;nsPIDOMWindowOuter&gt; window = nsPIDOMWindowOuter::From(mWindow);</span>
<a href="#l34.154"></a><span id="l34.154">   nsCOMPtr &lt;nsIDocShellTreeItem&gt; treeItem =</span>
<a href="#l34.155"></a><span id="l34.155">     do_QueryInterface(window-&gt;GetDocShell(), &amp;rv);</span>
<a href="#l34.156"></a><span id="l34.156">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.157"></a><span id="l34.157"> </span>
<a href="#l34.158"></a><span id="l34.158">   nsCOMPtr &lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l34.159"></a><span id="l34.159">   rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l34.160"></a><span id="l34.160">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.161"></a><span id="l34.161" class="difflineminus">-  </span>
<a href="#l34.162"></a><span id="l34.162" class="difflineplus">+</span>
<a href="#l34.163"></a><span id="l34.163">   if (treeOwner) {</span>
<a href="#l34.164"></a><span id="l34.164">     // disable (enable) the window</span>
<a href="#l34.165"></a><span id="l34.165">     nsCOMPtr&lt;nsIBaseWindow&gt; baseWindow;</span>
<a href="#l34.166"></a><span id="l34.166">     baseWindow = do_QueryInterface(treeOwner, &amp;rv);</span>
<a href="#l34.167"></a><span id="l34.167">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.168"></a><span id="l34.168"> </span>
<a href="#l34.169"></a><span id="l34.169">     rv = baseWindow-&gt;SetEnabled(aShow);</span>
<a href="#l34.170"></a><span id="l34.170">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l34.171"></a><span id="l34.171" class="difflineat">@@ -307,84 +307,84 @@ nsMsgPrintEngine::SetPrintURICount(int32</span>
<a href="#l34.172"></a><span id="l34.172"> </span>
<a href="#l34.173"></a><span id="l34.173"> NS_IMETHODIMP</span>
<a href="#l34.174"></a><span id="l34.174"> nsMsgPrintEngine::StartPrintOperation(nsIPrintSettings* aPS)</span>
<a href="#l34.175"></a><span id="l34.175"> {</span>
<a href="#l34.176"></a><span id="l34.176">   NS_ENSURE_ARG_POINTER(aPS);</span>
<a href="#l34.177"></a><span id="l34.177">   mPrintSettings = aPS;</span>
<a href="#l34.178"></a><span id="l34.178"> </span>
<a href="#l34.179"></a><span id="l34.179">   // Load the about:blank on the tail end...</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-  nsresult rv = AddPrintURI(u&quot;about:blank&quot;); </span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-  if (NS_FAILED(rv)) return rv; </span>
<a href="#l34.182"></a><span id="l34.182" class="difflineplus">+  nsresult rv = AddPrintURI(u&quot;about:blank&quot;);</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l34.184"></a><span id="l34.184">   return StartNextPrintOperation();</span>
<a href="#l34.185"></a><span id="l34.185"> }</span>
<a href="#l34.186"></a><span id="l34.186"> </span>
<a href="#l34.187"></a><span id="l34.187"> //----------------------------------------------------------------------</span>
<a href="#l34.188"></a><span id="l34.188"> // Set up to use the &quot;pluggable&quot; Print Progress Dialog</span>
<a href="#l34.189"></a><span id="l34.189"> nsresult</span>
<a href="#l34.190"></a><span id="l34.190"> nsMsgPrintEngine::ShowProgressDialog(bool aIsForPrinting, bool&amp; aDoNotify)</span>
<a href="#l34.191"></a><span id="l34.191"> {</span>
<a href="#l34.192"></a><span id="l34.192">   nsresult rv;</span>
<a href="#l34.193"></a><span id="l34.193"> </span>
<a href="#l34.194"></a><span id="l34.194">   // default to not notifying, that if something here goes wrong</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-  // or we aren't going to show the progress dialog we can straight into </span>
<a href="#l34.196"></a><span id="l34.196" class="difflineplus">+  // or we aren't going to show the progress dialog we can straight into</span>
<a href="#l34.197"></a><span id="l34.197">   // reflowing the doc for printing.</span>
<a href="#l34.198"></a><span id="l34.198">   aDoNotify = false;</span>
<a href="#l34.199"></a><span id="l34.199"> </span>
<a href="#l34.200"></a><span id="l34.200">   // Assume we can't do progress and then see if we can</span>
<a href="#l34.201"></a><span id="l34.201">   bool showProgressDialog = false;</span>
<a href="#l34.202"></a><span id="l34.202"> </span>
<a href="#l34.203"></a><span id="l34.203">   // if it is already being shown then don't bother to find out if it should be</span>
<a href="#l34.204"></a><span id="l34.204">   // so skip this and leave mShowProgressDialog set to FALSE</span>
<a href="#l34.205"></a><span id="l34.205">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch = do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l34.206"></a><span id="l34.206" class="difflineminus">-  if (NS_SUCCEEDED(rv)) </span>
<a href="#l34.207"></a><span id="l34.207" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l34.208"></a><span id="l34.208">   {</span>
<a href="#l34.209"></a><span id="l34.209">     prefBranch-&gt;GetBoolPref(&quot;print.show_print_progress&quot;, &amp;showProgressDialog);</span>
<a href="#l34.210"></a><span id="l34.210">   }</span>
<a href="#l34.211"></a><span id="l34.211"> </span>
<a href="#l34.212"></a><span id="l34.212">   // Turning off the showing of Print Progress in Prefs overrides</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">-  // whether the calling PS desire to have it on or off, so only check PS if </span>
<a href="#l34.214"></a><span id="l34.214" class="difflineplus">+  // whether the calling PS desire to have it on or off, so only check PS if</span>
<a href="#l34.215"></a><span id="l34.215">   // prefs says it's ok to be on.</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineminus">-  if (showProgressDialog) </span>
<a href="#l34.217"></a><span id="l34.217" class="difflineplus">+  if (showProgressDialog)</span>
<a href="#l34.218"></a><span id="l34.218">   {</span>
<a href="#l34.219"></a><span id="l34.219">     mPrintSettings-&gt;GetShowPrintProgress(&amp;showProgressDialog);</span>
<a href="#l34.220"></a><span id="l34.220">   }</span>
<a href="#l34.221"></a><span id="l34.221"> </span>
<a href="#l34.222"></a><span id="l34.222">   // Now open the service to get the progress dialog</span>
<a href="#l34.223"></a><span id="l34.223">   // If we don't get a service, that's ok, then just don't show progress</span>
<a href="#l34.224"></a><span id="l34.224">   if (showProgressDialog) {</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-    if (!mPrintPromptService) </span>
<a href="#l34.226"></a><span id="l34.226" class="difflineplus">+    if (!mPrintPromptService)</span>
<a href="#l34.227"></a><span id="l34.227">     {</span>
<a href="#l34.228"></a><span id="l34.228">       mPrintPromptService = do_GetService(kPrintingPromptService);</span>
<a href="#l34.229"></a><span id="l34.229">     }</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineminus">-    if (mPrintPromptService) </span>
<a href="#l34.231"></a><span id="l34.231" class="difflineplus">+    if (mPrintPromptService)</span>
<a href="#l34.232"></a><span id="l34.232">     {</span>
<a href="#l34.233"></a><span id="l34.233">       nsCOMPtr&lt;mozIDOMWindowProxy&gt; domWin(do_QueryInterface(mParentWindow));</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineminus">-      if (!domWin) </span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+      if (!domWin)</span>
<a href="#l34.236"></a><span id="l34.236">       {</span>
<a href="#l34.237"></a><span id="l34.237">         domWin = mWindow;</span>
<a href="#l34.238"></a><span id="l34.238">       }</span>
<a href="#l34.239"></a><span id="l34.239"> </span>
<a href="#l34.240"></a><span id="l34.240">       rv = mPrintPromptService-&gt;ShowProgress(domWin, mWebBrowserPrint, mPrintSettings, this, aIsForPrinting,</span>
<a href="#l34.241"></a><span id="l34.241" class="difflineminus">-                                            getter_AddRefs(mPrintProgressListener), </span>
<a href="#l34.242"></a><span id="l34.242" class="difflineminus">-                                            getter_AddRefs(mPrintProgressParams), </span>
<a href="#l34.243"></a><span id="l34.243" class="difflineplus">+                                            getter_AddRefs(mPrintProgressListener),</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineplus">+                                            getter_AddRefs(mPrintProgressParams),</span>
<a href="#l34.245"></a><span id="l34.245">                                             &amp;aDoNotify);</span>
<a href="#l34.246"></a><span id="l34.246">       if (NS_SUCCEEDED(rv)) {</span>
<a href="#l34.247"></a><span id="l34.247"> </span>
<a href="#l34.248"></a><span id="l34.248">         showProgressDialog = mPrintProgressListener != nullptr &amp;&amp; mPrintProgressParams != nullptr;</span>
<a href="#l34.249"></a><span id="l34.249"> </span>
<a href="#l34.250"></a><span id="l34.250" class="difflineminus">-        if (showProgressDialog) </span>
<a href="#l34.251"></a><span id="l34.251" class="difflineplus">+        if (showProgressDialog)</span>
<a href="#l34.252"></a><span id="l34.252">         {</span>
<a href="#l34.253"></a><span id="l34.253">           nsString msg;</span>
<a href="#l34.254"></a><span id="l34.254">           if (mIsDoingPrintPreview) {</span>
<a href="#l34.255"></a><span id="l34.255">             GetString(u&quot;LoadingMailMsgForPrintPreview&quot;, msg);</span>
<a href="#l34.256"></a><span id="l34.256">           } else {</span>
<a href="#l34.257"></a><span id="l34.257">             GetString(u&quot;LoadingMailMsgForPrint&quot;, msg);</span>
<a href="#l34.258"></a><span id="l34.258">           }</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineminus">-          if (!msg.IsEmpty()) </span>
<a href="#l34.260"></a><span id="l34.260" class="difflineplus">+          if (!msg.IsEmpty())</span>
<a href="#l34.261"></a><span id="l34.261">             mPrintProgressParams-&gt;SetDocTitle(msg.get());</span>
<a href="#l34.262"></a><span id="l34.262">         }</span>
<a href="#l34.263"></a><span id="l34.263">       }</span>
<a href="#l34.264"></a><span id="l34.264">     }</span>
<a href="#l34.265"></a><span id="l34.265">   }</span>
<a href="#l34.266"></a><span id="l34.266">   return rv;</span>
<a href="#l34.267"></a><span id="l34.267"> }</span>
<a href="#l34.268"></a><span id="l34.268"> </span>
<a href="#l34.269"></a><span id="l34.269" class="difflineat">@@ -420,71 +420,71 @@ nsMsgPrintEngine::StartNextPrintOperatio</span>
<a href="#l34.270"></a><span id="l34.270">   const nsString &amp;uri = mURIArray[mCurrentlyPrintingURI];</span>
<a href="#l34.271"></a><span id="l34.271">   rv = FireThatLoadOperationStartup(uri);</span>
<a href="#l34.272"></a><span id="l34.272">   if (NS_FAILED(rv))</span>
<a href="#l34.273"></a><span id="l34.273">     return StartNextPrintOperation();</span>
<a href="#l34.274"></a><span id="l34.274">   else</span>
<a href="#l34.275"></a><span id="l34.275">     return rv;</span>
<a href="#l34.276"></a><span id="l34.276"> }</span>
<a href="#l34.277"></a><span id="l34.277"> </span>
<a href="#l34.278"></a><span id="l34.278" class="difflineminus">-NS_IMETHODIMP    </span>
<a href="#l34.279"></a><span id="l34.279" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l34.280"></a><span id="l34.280"> nsMsgPrintEngine::SetStatusFeedback(nsIMsgStatusFeedback *aFeedback)</span>
<a href="#l34.281"></a><span id="l34.281"> {</span>
<a href="#l34.282"></a><span id="l34.282"> 	mFeedback = aFeedback;</span>
<a href="#l34.283"></a><span id="l34.283"> 	return NS_OK;</span>
<a href="#l34.284"></a><span id="l34.284"> }</span>
<a href="#l34.285"></a><span id="l34.285"> </span>
<a href="#l34.286"></a><span id="l34.286"> #define DATA_URL_PREFIX     &quot;data:&quot;</span>
<a href="#l34.287"></a><span id="l34.287"> #define ADDBOOK_URL_PREFIX     &quot;addbook:&quot;</span>
<a href="#l34.288"></a><span id="l34.288"> </span>
<a href="#l34.289"></a><span id="l34.289"> nsresult</span>
<a href="#l34.290"></a><span id="l34.290"> nsMsgPrintEngine::FireThatLoadOperationStartup(const nsString&amp; uri)</span>
<a href="#l34.291"></a><span id="l34.291"> {</span>
<a href="#l34.292"></a><span id="l34.292" class="difflineminus">-  if (!uri.IsEmpty()) </span>
<a href="#l34.293"></a><span id="l34.293" class="difflineplus">+  if (!uri.IsEmpty())</span>
<a href="#l34.294"></a><span id="l34.294">     mLoadURI = uri;</span>
<a href="#l34.295"></a><span id="l34.295">   else</span>
<a href="#l34.296"></a><span id="l34.296">     mLoadURI.Truncate();</span>
<a href="#l34.297"></a><span id="l34.297"> </span>
<a href="#l34.298"></a><span id="l34.298">   bool     notify = false;</span>
<a href="#l34.299"></a><span id="l34.299">   nsresult rv     = NS_ERROR_FAILURE;</span>
<a href="#l34.300"></a><span id="l34.300">   // Don't show dialog if we are out of URLs</span>
<a href="#l34.301"></a><span id="l34.301">   //if ( mCurrentlyPrintingURI &lt; mURIArray.Length() &amp;&amp; !mIsDoingPrintPreview)</span>
<a href="#l34.302"></a><span id="l34.302">   if ( mCurrentlyPrintingURI &lt; (int32_t)mURIArray.Length())</span>
<a href="#l34.303"></a><span id="l34.303">     rv = ShowProgressDialog(!mIsDoingPrintPreview, notify);</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineminus">-  if (NS_FAILED(rv) || !notify) </span>
<a href="#l34.305"></a><span id="l34.305" class="difflineplus">+  if (NS_FAILED(rv) || !notify)</span>
<a href="#l34.306"></a><span id="l34.306">     return FireThatLoadOperation(uri);</span>
<a href="#l34.307"></a><span id="l34.307">   return NS_OK;</span>
<a href="#l34.308"></a><span id="l34.308"> }</span>
<a href="#l34.309"></a><span id="l34.309"> </span>
<a href="#l34.310"></a><span id="l34.310"> nsresult</span>
<a href="#l34.311"></a><span id="l34.311"> nsMsgPrintEngine::FireThatLoadOperation(const nsString&amp; uri)</span>
<a href="#l34.312"></a><span id="l34.312"> {</span>
<a href="#l34.313"></a><span id="l34.313">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineminus">-  </span>
<a href="#l34.315"></a><span id="l34.315" class="difflineplus">+</span>
<a href="#l34.316"></a><span id="l34.316">   nsCString uriCStr;</span>
<a href="#l34.317"></a><span id="l34.317">   LossyCopyUTF16toASCII(uri, uriCStr);</span>
<a href="#l34.318"></a><span id="l34.318"> </span>
<a href="#l34.319"></a><span id="l34.319">   nsCOMPtr &lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-  // if this is a data: url, skip it, because </span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+  // if this is a data: url, skip it, because</span>
<a href="#l34.322"></a><span id="l34.322">   // we've already got something we can print</span>
<a href="#l34.323"></a><span id="l34.323">   // and we know it is not a message.</span>
<a href="#l34.324"></a><span id="l34.324">   //</span>
<a href="#l34.325"></a><span id="l34.325">   // if this an about:blank url, skip it, because</span>
<a href="#l34.326"></a><span id="l34.326">   // ...</span>
<a href="#l34.327"></a><span id="l34.327">   //</span>
<a href="#l34.328"></a><span id="l34.328">   // if this is an addbook: url, skip it, because</span>
<a href="#l34.329"></a><span id="l34.329">   // we know that isn't a message.</span>
<a href="#l34.330"></a><span id="l34.330">   //</span>
<a href="#l34.331"></a><span id="l34.331">   // if this is a message part (or .eml file on disk)</span>
<a href="#l34.332"></a><span id="l34.332">   // skip it, because we don't want to print the parent message</span>
<a href="#l34.333"></a><span id="l34.333">   // we want to print the part.</span>
<a href="#l34.334"></a><span id="l34.334">   // example:  imap://sspitzer@nsmail-1:143/fetch%3EUID%3E/INBOX%3E180958?part=1.1.2&amp;type=application/x-message-display&amp;filename=test&quot;</span>
<a href="#l34.335"></a><span id="l34.335">   if (!StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(DATA_URL_PREFIX)) &amp;&amp;</span>
<a href="#l34.336"></a><span id="l34.336">       !StringBeginsWith(uriCStr, NS_LITERAL_CSTRING(ADDBOOK_URL_PREFIX)) &amp;&amp;</span>
<a href="#l34.337"></a><span id="l34.337" class="difflineminus">-      !uriCStr.EqualsLiteral(&quot;about:blank&quot;) &amp;&amp; </span>
<a href="#l34.338"></a><span id="l34.338" class="difflineplus">+      !uriCStr.EqualsLiteral(&quot;about:blank&quot;) &amp;&amp;</span>
<a href="#l34.339"></a><span id="l34.339">       uriCStr.Find(NS_LITERAL_CSTRING(&quot;type=application/x-message-display&quot;)) == -1) {</span>
<a href="#l34.340"></a><span id="l34.340">     rv = GetMessageServiceFromURI(uriCStr, getter_AddRefs(messageService));</span>
<a href="#l34.341"></a><span id="l34.341">   }</span>
<a href="#l34.342"></a><span id="l34.342"> </span>
<a href="#l34.343"></a><span id="l34.343">   if (NS_SUCCEEDED(rv) &amp;&amp; messageService) {</span>
<a href="#l34.344"></a><span id="l34.344">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l34.345"></a><span id="l34.345">     rv = messageService-&gt;DisplayMessageForPrinting(uriCStr.get(), mDocShell, nullptr, nullptr,</span>
<a href="#l34.346"></a><span id="l34.346">                                                    getter_AddRefs(dummyNull));</span>
<a href="#l34.347"></a><span id="l34.347" class="difflineat">@@ -503,45 +503,45 @@ nsMsgPrintEngine::FireThatLoadOperation(</span>
<a href="#l34.348"></a><span id="l34.348">   }</span>
<a href="#l34.349"></a><span id="l34.349">   return rv;</span>
<a href="#l34.350"></a><span id="l34.350"> }</span>
<a href="#l34.351"></a><span id="l34.351"> </span>
<a href="#l34.352"></a><span id="l34.352"> void</span>
<a href="#l34.353"></a><span id="l34.353"> nsMsgPrintEngine::InitializeDisplayCharset()</span>
<a href="#l34.354"></a><span id="l34.354"> {</span>
<a href="#l34.355"></a><span id="l34.355">   // libmime always converts to UTF-8 (both HTML and XML)</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineminus">-  if (mDocShell) </span>
<a href="#l34.357"></a><span id="l34.357" class="difflineplus">+  if (mDocShell)</span>
<a href="#l34.358"></a><span id="l34.358">   {</span>
<a href="#l34.359"></a><span id="l34.359">     nsCOMPtr&lt;nsIContentViewer&gt; cv;</span>
<a href="#l34.360"></a><span id="l34.360">     mDocShell-&gt;GetContentViewer(getter_AddRefs(cv));</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineminus">-    if (cv) </span>
<a href="#l34.362"></a><span id="l34.362" class="difflineplus">+    if (cv)</span>
<a href="#l34.363"></a><span id="l34.363">     {</span>
<a href="#l34.364"></a><span id="l34.364">       cv-&gt;SetForceCharacterSet(NS_LITERAL_CSTRING(&quot;UTF-8&quot;));</span>
<a href="#l34.365"></a><span id="l34.365">     }</span>
<a href="#l34.366"></a><span id="l34.366">   }</span>
<a href="#l34.367"></a><span id="l34.367"> }</span>
<a href="#l34.368"></a><span id="l34.368"> </span>
<a href="#l34.369"></a><span id="l34.369"> void</span>
<a href="#l34.370"></a><span id="l34.370"> nsMsgPrintEngine::SetupObserver()</span>
<a href="#l34.371"></a><span id="l34.371"> {</span>
<a href="#l34.372"></a><span id="l34.372">   if (!mDocShell)</span>
<a href="#l34.373"></a><span id="l34.373">     return;</span>
<a href="#l34.374"></a><span id="l34.374"> </span>
<a href="#l34.375"></a><span id="l34.375">   if (mDocShell)</span>
<a href="#l34.376"></a><span id="l34.376">   {</span>
<a href="#l34.377"></a><span id="l34.377">     nsCOMPtr&lt;nsIWebProgress&gt; progress(do_GetInterface(mDocShell));</span>
<a href="#l34.378"></a><span id="l34.378">     NS_ASSERTION(progress, &quot;we were expecting a nsIWebProgress&quot;);</span>
<a href="#l34.379"></a><span id="l34.379" class="difflineminus">-    if (progress) </span>
<a href="#l34.380"></a><span id="l34.380" class="difflineplus">+    if (progress)</span>
<a href="#l34.381"></a><span id="l34.381">     {</span>
<a href="#l34.382"></a><span id="l34.382">       (void) progress-&gt;AddProgressListener((nsIWebProgressListener *)this,</span>
<a href="#l34.383"></a><span id="l34.383">                                         nsIWebProgress::NOTIFY_STATE_DOCUMENT);</span>
<a href="#l34.384"></a><span id="l34.384">     }</span>
<a href="#l34.385"></a><span id="l34.385"> </span>
<a href="#l34.386"></a><span id="l34.386" class="difflineminus">-    // Cache a pointer to the mail message's DOMWindow </span>
<a href="#l34.387"></a><span id="l34.387" class="difflineminus">-    // so later we know when we can print when the </span>
<a href="#l34.388"></a><span id="l34.388" class="difflineplus">+    // Cache a pointer to the mail message's DOMWindow</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineplus">+    // so later we know when we can print when the</span>
<a href="#l34.390"></a><span id="l34.390">     // document &quot;loaded&quot; msgs com thru via the Progress listener</span>
<a href="#l34.391"></a><span id="l34.391">     mMsgDOMWin = do_GetInterface(mDocShell);</span>
<a href="#l34.392"></a><span id="l34.392">   }</span>
<a href="#l34.393"></a><span id="l34.393"> }</span>
<a href="#l34.394"></a><span id="l34.394"> </span>
<a href="#l34.395"></a><span id="l34.395"> nsresult</span>
<a href="#l34.396"></a><span id="l34.396"> nsMsgPrintEngine::SetStatusMessage(const nsString&amp; aMsgString)</span>
<a href="#l34.397"></a><span id="l34.397"> {</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineat">@@ -558,17 +558,17 @@ void</span>
<a href="#l34.399"></a><span id="l34.399"> nsMsgPrintEngine::GetString(const char16_t *aStringName, nsString&amp; outStr)</span>
<a href="#l34.400"></a><span id="l34.400"> {</span>
<a href="#l34.401"></a><span id="l34.401">   outStr.Truncate();</span>
<a href="#l34.402"></a><span id="l34.402"> </span>
<a href="#l34.403"></a><span id="l34.403">   if (!mStringBundle)</span>
<a href="#l34.404"></a><span id="l34.404">   {</span>
<a href="#l34.405"></a><span id="l34.405">     static const char propertyURL[] = MESSENGER_STRING_URL;</span>
<a href="#l34.406"></a><span id="l34.406"> </span>
<a href="#l34.407"></a><span id="l34.407" class="difflineminus">-    nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService = </span>
<a href="#l34.408"></a><span id="l34.408" class="difflineplus">+    nsCOMPtr&lt;nsIStringBundleService&gt; sBundleService =</span>
<a href="#l34.409"></a><span id="l34.409">       mozilla::services::GetStringBundleService();</span>
<a href="#l34.410"></a><span id="l34.410">     if (sBundleService)</span>
<a href="#l34.411"></a><span id="l34.411">       sBundleService-&gt;CreateBundle(propertyURL, getter_AddRefs(mStringBundle));</span>
<a href="#l34.412"></a><span id="l34.412">   }</span>
<a href="#l34.413"></a><span id="l34.413"> </span>
<a href="#l34.414"></a><span id="l34.414">   if (mStringBundle)</span>
<a href="#l34.415"></a><span id="l34.415">     mStringBundle-&gt;GetStringFromName(NS_ConvertUTF16toUTF8(aStringName).get(), outStr);</span>
<a href="#l34.416"></a><span id="l34.416">   return;</span>
<a href="#l34.417"></a><span id="l34.417" class="difflineat">@@ -577,61 +577,61 @@ nsMsgPrintEngine::GetString(const char16</span>
<a href="#l34.418"></a><span id="l34.418"> //-----------------------------------------------------------</span>
<a href="#l34.419"></a><span id="l34.419"> void</span>
<a href="#l34.420"></a><span id="l34.420"> nsMsgPrintEngine::PrintMsgWindow()</span>
<a href="#l34.421"></a><span id="l34.421"> {</span>
<a href="#l34.422"></a><span id="l34.422">   const char* kMsgKeys[] = {&quot;PrintingMessage&quot;,  &quot;PrintPreviewMessage&quot;,</span>
<a href="#l34.423"></a><span id="l34.423">                             &quot;PrintingContact&quot;,  &quot;PrintPreviewContact&quot;,</span>
<a href="#l34.424"></a><span id="l34.424">                             &quot;PrintingAddrBook&quot;, &quot;PrintPreviewAddrBook&quot;};</span>
<a href="#l34.425"></a><span id="l34.425"> </span>
<a href="#l34.426"></a><span id="l34.426" class="difflineminus">-  mDocShell-&gt;GetContentViewer(getter_AddRefs(mContentViewer));  </span>
<a href="#l34.427"></a><span id="l34.427" class="difflineminus">-  if (mContentViewer) </span>
<a href="#l34.428"></a><span id="l34.428" class="difflineplus">+  mDocShell-&gt;GetContentViewer(getter_AddRefs(mContentViewer));</span>
<a href="#l34.429"></a><span id="l34.429" class="difflineplus">+  if (mContentViewer)</span>
<a href="#l34.430"></a><span id="l34.430">   {</span>
<a href="#l34.431"></a><span id="l34.431">     mWebBrowserPrint = do_QueryInterface(mContentViewer);</span>
<a href="#l34.432"></a><span id="l34.432" class="difflineminus">-    if (mWebBrowserPrint) </span>
<a href="#l34.433"></a><span id="l34.433" class="difflineplus">+    if (mWebBrowserPrint)</span>
<a href="#l34.434"></a><span id="l34.434">     {</span>
<a href="#l34.435"></a><span id="l34.435" class="difflineminus">-      if (!mPrintSettings) </span>
<a href="#l34.436"></a><span id="l34.436" class="difflineplus">+      if (!mPrintSettings)</span>
<a href="#l34.437"></a><span id="l34.437">       {</span>
<a href="#l34.438"></a><span id="l34.438">         mWebBrowserPrint-&gt;GetGlobalPrintSettings(getter_AddRefs(mPrintSettings));</span>
<a href="#l34.439"></a><span id="l34.439">       }</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineminus">-      </span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+</span>
<a href="#l34.442"></a><span id="l34.442">       // fix for bug #118887 and bug #176016</span>
<a href="#l34.443"></a><span id="l34.443">       // don't show the actual url when printing mail messages or addressbook cards.</span>
<a href="#l34.444"></a><span id="l34.444">       // for mail, it can review the salt.  for addrbook, it's a data:// url, which</span>
<a href="#l34.445"></a><span id="l34.445">       // means nothing to the end user.</span>
<a href="#l34.446"></a><span id="l34.446">       // needs to be &quot; &quot; and not &quot;&quot; or nullptr, otherwise, we'll still print the url</span>
<a href="#l34.447"></a><span id="l34.447">       mPrintSettings-&gt;SetDocURL(u&quot; &quot;);</span>
<a href="#l34.448"></a><span id="l34.448"> </span>
<a href="#l34.449"></a><span id="l34.449">       nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineminus">-      if (mIsDoingPrintPreview) </span>
<a href="#l34.451"></a><span id="l34.451" class="difflineplus">+      if (mIsDoingPrintPreview)</span>
<a href="#l34.452"></a><span id="l34.452">       {</span>
<a href="#l34.453"></a><span id="l34.453">         if (mStartupPPObs) {</span>
<a href="#l34.454"></a><span id="l34.454">           rv = mStartupPPObs-&gt;Observe(nullptr, nullptr, nullptr);</span>
<a href="#l34.455"></a><span id="l34.455">         }</span>
<a href="#l34.456"></a><span id="l34.456" class="difflineminus">-      } </span>
<a href="#l34.457"></a><span id="l34.457" class="difflineminus">-      else </span>
<a href="#l34.458"></a><span id="l34.458" class="difflineplus">+      }</span>
<a href="#l34.459"></a><span id="l34.459" class="difflineplus">+      else</span>
<a href="#l34.460"></a><span id="l34.460">       {</span>
<a href="#l34.461"></a><span id="l34.461">         mPrintSettings-&gt;SetPrintSilent(mCurrentlyPrintingURI != 0);</span>
<a href="#l34.462"></a><span id="l34.462">         rv = mWebBrowserPrint-&gt;Print(mPrintSettings, (nsIWebProgressListener *)this);</span>
<a href="#l34.463"></a><span id="l34.463">       }</span>
<a href="#l34.464"></a><span id="l34.464"> </span>
<a href="#l34.465"></a><span id="l34.465">       if (NS_FAILED(rv))</span>
<a href="#l34.466"></a><span id="l34.466">       {</span>
<a href="#l34.467"></a><span id="l34.467">         mWebBrowserPrint = nullptr;</span>
<a href="#l34.468"></a><span id="l34.468">         mContentViewer = nullptr;</span>
<a href="#l34.469"></a><span id="l34.469">         bool isPrintingCancelled = false;</span>
<a href="#l34.470"></a><span id="l34.470">         if (mPrintSettings)</span>
<a href="#l34.471"></a><span id="l34.471">         {</span>
<a href="#l34.472"></a><span id="l34.472">           mPrintSettings-&gt;GetIsCancelled(&amp;isPrintingCancelled);</span>
<a href="#l34.473"></a><span id="l34.473">         }</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineminus">-        if (!isPrintingCancelled) </span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+        if (!isPrintingCancelled)</span>
<a href="#l34.476"></a><span id="l34.476">         {</span>
<a href="#l34.477"></a><span id="l34.477">           StartNextPrintOperation();</span>
<a href="#l34.478"></a><span id="l34.478" class="difflineminus">-        } </span>
<a href="#l34.479"></a><span id="l34.479" class="difflineminus">-        else </span>
<a href="#l34.480"></a><span id="l34.480" class="difflineplus">+        }</span>
<a href="#l34.481"></a><span id="l34.481" class="difflineplus">+        else</span>
<a href="#l34.482"></a><span id="l34.482">         {</span>
<a href="#l34.483"></a><span id="l34.483">           if (mWindow) {</span>
<a href="#l34.484"></a><span id="l34.484">             nsPIDOMWindowOuter::From(mWindow)-&gt;Close();</span>
<a href="#l34.485"></a><span id="l34.485">           }</span>
<a href="#l34.486"></a><span id="l34.486">         }</span>
<a href="#l34.487"></a><span id="l34.487">       }</span>
<a href="#l34.488"></a><span id="l34.488">       else</span>
<a href="#l34.489"></a><span id="l34.489">       {</span>
<a href="#l34.490"></a><span id="l34.490" class="difflineat">@@ -653,17 +653,17 @@ class nsPrintMsgWindowEvent : public moz</span>
<a href="#l34.491"></a><span id="l34.491"> {</span>
<a href="#l34.492"></a><span id="l34.492"> public:</span>
<a href="#l34.493"></a><span id="l34.493">   nsPrintMsgWindowEvent(nsMsgPrintEngine *mpe)</span>
<a href="#l34.494"></a><span id="l34.494">     : mozilla::Runnable(&quot;nsPrintMsgWindowEvent&quot;), mMsgPrintEngine(mpe)</span>
<a href="#l34.495"></a><span id="l34.495">   {}</span>
<a href="#l34.496"></a><span id="l34.496"> </span>
<a href="#l34.497"></a><span id="l34.497">   NS_IMETHOD Run()</span>
<a href="#l34.498"></a><span id="l34.498">   {</span>
<a href="#l34.499"></a><span id="l34.499" class="difflineminus">-    if (mMsgPrintEngine) </span>
<a href="#l34.500"></a><span id="l34.500" class="difflineplus">+    if (mMsgPrintEngine)</span>
<a href="#l34.501"></a><span id="l34.501">       mMsgPrintEngine-&gt;PrintMsgWindow();</span>
<a href="#l34.502"></a><span id="l34.502">     return NS_OK;</span>
<a href="#l34.503"></a><span id="l34.503">   }</span>
<a href="#l34.504"></a><span id="l34.504"> </span>
<a href="#l34.505"></a><span id="l34.505"> private:</span>
<a href="#l34.506"></a><span id="l34.506">   RefPtr&lt;nsMsgPrintEngine&gt; mMsgPrintEngine;</span>
<a href="#l34.507"></a><span id="l34.507"> };</span>
<a href="#l34.508"></a><span id="l34.508"> </span>
<a href="#l34.509"></a><span id="l34.509" class="difflineat">@@ -672,17 +672,17 @@ class nsStartNextPrintOpEvent : public m</span>
<a href="#l34.510"></a><span id="l34.510"> {</span>
<a href="#l34.511"></a><span id="l34.511"> public:</span>
<a href="#l34.512"></a><span id="l34.512">   nsStartNextPrintOpEvent(nsMsgPrintEngine *mpe)</span>
<a href="#l34.513"></a><span id="l34.513">     : mozilla::Runnable(&quot;nsStartNextPrintOpEvent&quot;), mMsgPrintEngine(mpe)</span>
<a href="#l34.514"></a><span id="l34.514">   {}</span>
<a href="#l34.515"></a><span id="l34.515"> </span>
<a href="#l34.516"></a><span id="l34.516">   NS_IMETHOD Run()</span>
<a href="#l34.517"></a><span id="l34.517">   {</span>
<a href="#l34.518"></a><span id="l34.518" class="difflineminus">-    if (mMsgPrintEngine) </span>
<a href="#l34.519"></a><span id="l34.519" class="difflineplus">+    if (mMsgPrintEngine)</span>
<a href="#l34.520"></a><span id="l34.520">       mMsgPrintEngine-&gt;StartNextPrintOperation();</span>
<a href="#l34.521"></a><span id="l34.521">     return NS_OK;</span>
<a href="#l34.522"></a><span id="l34.522">   }</span>
<a href="#l34.523"></a><span id="l34.523"> </span>
<a href="#l34.524"></a><span id="l34.524"> private:</span>
<a href="#l34.525"></a><span id="l34.525">   RefPtr&lt;nsMsgPrintEngine&gt; mMsgPrintEngine;</span>
<a href="#l34.526"></a><span id="l34.526"> };</span>
<a href="#l34.527"></a><span id="l34.527"> </span>
<a href="#l34.528"></a><span id="l34.528" class="difflineat">@@ -720,17 +720,17 @@ NS_IMETHODIMP nsMsgPrintEngine::SetDoPri</span>
<a href="#l34.529"></a><span id="l34.529"> {</span>
<a href="#l34.530"></a><span id="l34.530">   mIsDoingPrintPreview = aDoPrintPreview;</span>
<a href="#l34.531"></a><span id="l34.531">   return NS_OK;</span>
<a href="#l34.532"></a><span id="l34.532"> }</span>
<a href="#l34.533"></a><span id="l34.533"> </span>
<a href="#l34.534"></a><span id="l34.534"> /* void setMsgType (in long aMsgType); */</span>
<a href="#l34.535"></a><span id="l34.535"> NS_IMETHODIMP nsMsgPrintEngine::SetMsgType(int32_t aMsgType)</span>
<a href="#l34.536"></a><span id="l34.536"> {</span>
<a href="#l34.537"></a><span id="l34.537" class="difflineminus">-  if (mMsgInx &gt;= nsIMsgPrintEngine::MNAB_START &amp;&amp; mMsgInx &lt; nsIMsgPrintEngine::MNAB_END) </span>
<a href="#l34.538"></a><span id="l34.538" class="difflineplus">+  if (mMsgInx &gt;= nsIMsgPrintEngine::MNAB_START &amp;&amp; mMsgInx &lt; nsIMsgPrintEngine::MNAB_END)</span>
<a href="#l34.539"></a><span id="l34.539">   {</span>
<a href="#l34.540"></a><span id="l34.540">     mMsgInx = aMsgType;</span>
<a href="#l34.541"></a><span id="l34.541">     return NS_OK;</span>
<a href="#l34.542"></a><span id="l34.542">   }</span>
<a href="#l34.543"></a><span id="l34.543">   return NS_ERROR_FAILURE;</span>
<a href="#l34.544"></a><span id="l34.544"> }</span>
<a href="#l34.545"></a><span id="l34.545"> </span>
<a href="#l34.546"></a><span id="l34.546"> /*=============== nsIObserver Interface ======================*/</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPrintEngine.h</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPrintEngine.h</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -77,15 +77,15 @@ protected:</span>
<a href="#l35.4"></a><span id="l35.4">   nsCOMPtr&lt;nsIWebBrowserPrint&gt; mWebBrowserPrint;</span>
<a href="#l35.5"></a><span id="l35.5">   nsCOMPtr&lt;nsIPrintSettings&gt;   mPrintSettings;</span>
<a href="#l35.6"></a><span id="l35.6">   nsCOMPtr&lt;mozIDOMWindowProxy&gt; mMsgDOMWin;</span>
<a href="#l35.7"></a><span id="l35.7">   bool                         mIsDoingPrintPreview;</span>
<a href="#l35.8"></a><span id="l35.8">   nsCOMPtr&lt;nsIObserver&gt;        mStartupPPObs;</span>
<a href="#l35.9"></a><span id="l35.9">   int32_t                      mMsgInx;</span>
<a href="#l35.10"></a><span id="l35.10"> </span>
<a href="#l35.11"></a><span id="l35.11">   // Progress Dialog</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-  </span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+</span>
<a href="#l35.14"></a><span id="l35.14">   nsCOMPtr&lt;nsIPrintingPromptService&gt; mPrintPromptService;</span>
<a href="#l35.15"></a><span id="l35.15">   nsCOMPtr&lt;nsIWebProgressListener&gt; mPrintProgressListener;</span>
<a href="#l35.16"></a><span id="l35.16">   nsCOMPtr&lt;nsIPrintProgress&gt;       mPrintProgress;</span>
<a href="#l35.17"></a><span id="l35.17">   nsCOMPtr&lt;nsIPrintProgressParams&gt; mPrintProgressParams;</span>
<a href="#l35.18"></a><span id="l35.18">   nsString                         mLoadURI;</span>
<a href="#l35.19"></a><span id="l35.19"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgProgress.h</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -12,34 +12,34 @@</span>
<a href="#l36.4"></a><span id="l36.4"> #include &quot;nsIDOMWindow.h&quot;</span>
<a href="#l36.5"></a><span id="l36.5"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l36.6"></a><span id="l36.6"> #include &quot;nsString.h&quot;</span>
<a href="#l36.7"></a><span id="l36.7"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l36.8"></a><span id="l36.8"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l36.9"></a><span id="l36.9"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l36.10"></a><span id="l36.10"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-class nsMsgProgress : public nsIMsgProgress, </span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-                      public nsIMsgStatusFeedback, </span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+class nsMsgProgress : public nsIMsgProgress,</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+                      public nsIMsgStatusFeedback,</span>
<a href="#l36.16"></a><span id="l36.16">                       public nsIProgressEventSink,</span>
<a href="#l36.17"></a><span id="l36.17">                       public nsSupportsWeakReference</span>
<a href="#l36.18"></a><span id="l36.18"> {</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-public: </span>
<a href="#l36.20"></a><span id="l36.20" class="difflineplus">+public:</span>
<a href="#l36.21"></a><span id="l36.21">   nsMsgProgress();</span>
<a href="#l36.22"></a><span id="l36.22" class="difflineminus">-  </span>
<a href="#l36.23"></a><span id="l36.23" class="difflineplus">+</span>
<a href="#l36.24"></a><span id="l36.24">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l36.25"></a><span id="l36.25">   NS_DECL_NSIMSGPROGRESS</span>
<a href="#l36.26"></a><span id="l36.26">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l36.27"></a><span id="l36.27">   NS_DECL_NSIMSGSTATUSFEEDBACK</span>
<a href="#l36.28"></a><span id="l36.28">   NS_DECL_NSIPROGRESSEVENTSINK</span>
<a href="#l36.29"></a><span id="l36.29"> </span>
<a href="#l36.30"></a><span id="l36.30"> private:</span>
<a href="#l36.31"></a><span id="l36.31">   virtual ~nsMsgProgress();</span>
<a href="#l36.32"></a><span id="l36.32">   nsresult ReleaseListeners(void);</span>
<a href="#l36.33"></a><span id="l36.33" class="difflineminus">-  </span>
<a href="#l36.34"></a><span id="l36.34" class="difflineplus">+</span>
<a href="#l36.35"></a><span id="l36.35">   bool                               m_closeProgress;</span>
<a href="#l36.36"></a><span id="l36.36">   bool                               m_processCanceled;</span>
<a href="#l36.37"></a><span id="l36.37">   nsString                           m_pendingStatus;</span>
<a href="#l36.38"></a><span id="l36.38">   int32_t                            m_pendingStateFlags;</span>
<a href="#l36.39"></a><span id="l36.39">   nsresult                           m_pendingStateValue;</span>
<a href="#l36.40"></a><span id="l36.40">   nsWeakPtr                          m_msgWindow;</span>
<a href="#l36.41"></a><span id="l36.41">   nsCOMArray&lt;nsIWebProgressListener&gt; m_listenerList;</span>
<a href="#l36.42"></a><span id="l36.42"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/src/nsMsgPurgeService.h</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgPurgeService.h</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -17,17 +17,17 @@</span>
<a href="#l37.4"></a><span id="l37.4"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l37.5"></a><span id="l37.5"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l37.6"></a><span id="l37.6"> </span>
<a href="#l37.7"></a><span id="l37.7"> class nsMsgPurgeService</span>
<a href="#l37.8"></a><span id="l37.8"> 	: public nsIMsgPurgeService,</span>
<a href="#l37.9"></a><span id="l37.9"> 		public nsIMsgSearchNotify</span>
<a href="#l37.10"></a><span id="l37.10"> {</span>
<a href="#l37.11"></a><span id="l37.11"> public:</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-	nsMsgPurgeService(); </span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+	nsMsgPurgeService();</span>
<a href="#l37.14"></a><span id="l37.14"> </span>
<a href="#l37.15"></a><span id="l37.15"> 	NS_DECL_ISUPPORTS</span>
<a href="#l37.16"></a><span id="l37.16">   NS_DECL_NSIMSGPURGESERVICE</span>
<a href="#l37.17"></a><span id="l37.17"> 	NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l37.18"></a><span id="l37.18"> </span>
<a href="#l37.19"></a><span id="l37.19"> 	nsresult PerformPurge();</span>
<a href="#l37.20"></a><span id="l37.20"> </span>
<a href="#l37.21"></a><span id="l37.21"> protected:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.cpp</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -67,19 +67,19 @@ nsMsgQuickSearchDBView::CopyDBView(nsMsg</span>
<a href="#l38.4"></a><span id="l38.4"> </span>
<a href="#l38.5"></a><span id="l38.5">   // now copy all of our private member data</span>
<a href="#l38.6"></a><span id="l38.6">   newMsgDBView-&gt;m_origKeys = m_origKeys;</span>
<a href="#l38.7"></a><span id="l38.7">   return NS_OK;</span>
<a href="#l38.8"></a><span id="l38.8"> }</span>
<a href="#l38.9"></a><span id="l38.9"> </span>
<a href="#l38.10"></a><span id="l38.10"> nsresult nsMsgQuickSearchDBView::DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool deleteStorage)</span>
<a href="#l38.11"></a><span id="l38.11"> {</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++) </span>
<a href="#l38.13"></a><span id="l38.13" class="difflineplus">+  for (nsMsgViewIndex i = 0; i &lt; (nsMsgViewIndex) numIndices; i++)</span>
<a href="#l38.14"></a><span id="l38.14">   {</span>
<a href="#l38.15"></a><span id="l38.15" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr; </span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l38.17"></a><span id="l38.17">     (void) GetMsgHdrForViewIndex(indices[i],getter_AddRefs(msgHdr));</span>
<a href="#l38.18"></a><span id="l38.18">     if (msgHdr)</span>
<a href="#l38.19"></a><span id="l38.19">       RememberDeletedMsgHdr(msgHdr);</span>
<a href="#l38.20"></a><span id="l38.20">   }</span>
<a href="#l38.21"></a><span id="l38.21"> </span>
<a href="#l38.22"></a><span id="l38.22">   return nsMsgDBView::DeleteMessages(window, indices, numIndices, deleteStorage);</span>
<a href="#l38.23"></a><span id="l38.23"> }</span>
<a href="#l38.24"></a><span id="l38.24"> </span>
<a href="#l38.25"></a><span id="l38.25" class="difflineat">@@ -88,38 +88,38 @@ NS_IMETHODIMP nsMsgQuickSearchDBView::Do</span>
<a href="#l38.26"></a><span id="l38.26">   if (aCommand == nsMsgViewCommandType::markAllRead)</span>
<a href="#l38.27"></a><span id="l38.27">   {</span>
<a href="#l38.28"></a><span id="l38.28">     nsresult rv = NS_OK;</span>
<a href="#l38.29"></a><span id="l38.29">     m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, false);</span>
<a href="#l38.30"></a><span id="l38.30"> </span>
<a href="#l38.31"></a><span id="l38.31">     for (uint32_t i = 0; NS_SUCCEEDED(rv) &amp;&amp; i &lt; GetSize(); i++)</span>
<a href="#l38.32"></a><span id="l38.32">     {</span>
<a href="#l38.33"></a><span id="l38.33">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineminus">-      m_db-&gt;GetMsgHdrForKey(m_keys[i],getter_AddRefs(msgHdr)); </span>
<a href="#l38.35"></a><span id="l38.35" class="difflineplus">+      m_db-&gt;GetMsgHdrForKey(m_keys[i],getter_AddRefs(msgHdr));</span>
<a href="#l38.36"></a><span id="l38.36">       rv = m_db-&gt;MarkHdrRead(msgHdr, true, nullptr);</span>
<a href="#l38.37"></a><span id="l38.37">     }</span>
<a href="#l38.38"></a><span id="l38.38"> </span>
<a href="#l38.39"></a><span id="l38.39">     m_folder-&gt;EnableNotifications(nsIMsgFolder::allMessageCountNotifications, true);</span>
<a href="#l38.40"></a><span id="l38.40"> </span>
<a href="#l38.41"></a><span id="l38.41">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_folder);</span>
<a href="#l38.42"></a><span id="l38.42">     if (NS_SUCCEEDED(rv) &amp;&amp; imapFolder)</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineminus">-      rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys.Elements(), </span>
<a href="#l38.44"></a><span id="l38.44" class="difflineplus">+      rv = imapFolder-&gt;StoreImapFlags(kImapMsgSeenFlag, true, m_keys.Elements(),</span>
<a href="#l38.45"></a><span id="l38.45">                                       m_keys.Length(), nullptr);</span>
<a href="#l38.46"></a><span id="l38.46"> </span>
<a href="#l38.47"></a><span id="l38.47">     m_db-&gt;SetSummaryValid(true);</span>
<a href="#l38.48"></a><span id="l38.48">     return rv;</span>
<a href="#l38.49"></a><span id="l38.49">   }</span>
<a href="#l38.50"></a><span id="l38.50">   else</span>
<a href="#l38.51"></a><span id="l38.51">     return nsMsgDBView::DoCommand(aCommand);</span>
<a href="#l38.52"></a><span id="l38.52"> }</span>
<a href="#l38.53"></a><span id="l38.53"> </span>
<a href="#l38.54"></a><span id="l38.54"> NS_IMETHODIMP nsMsgQuickSearchDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l38.55"></a><span id="l38.55"> {</span>
<a href="#l38.56"></a><span id="l38.56">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l38.57"></a><span id="l38.57" class="difflineminus">-    *aViewType = nsMsgViewType::eShowQuickSearchResults; </span>
<a href="#l38.58"></a><span id="l38.58" class="difflineplus">+    *aViewType = nsMsgViewType::eShowQuickSearchResults;</span>
<a href="#l38.59"></a><span id="l38.59">     return NS_OK;</span>
<a href="#l38.60"></a><span id="l38.60"> }</span>
<a href="#l38.61"></a><span id="l38.61"> </span>
<a href="#l38.62"></a><span id="l38.62"> nsresult nsMsgQuickSearchDBView::AddHdr(nsIMsgDBHdr *msgHdr, nsMsgViewIndex *resultIndex)</span>
<a href="#l38.63"></a><span id="l38.63"> {</span>
<a href="#l38.64"></a><span id="l38.64">   nsMsgKey msgKey;</span>
<a href="#l38.65"></a><span id="l38.65">   msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l38.66"></a><span id="l38.66">   // protect against duplication.</span>
<a href="#l38.67"></a><span id="l38.67" class="difflineat">@@ -158,28 +158,28 @@ nsresult nsMsgQuickSearchDBView::OnNewHe</span>
<a href="#l38.68"></a><span id="l38.68">                       nsMsgViewSortOrder::ascending, nsMsgViewSortType::byId);</span>
<a href="#l38.69"></a><span id="l38.69">       m_origKeys.InsertElementAt(insertIndex, newKey);</span>
<a href="#l38.70"></a><span id="l38.70">       nsMsgThreadedDBView::OnNewHeader(newHdr, aParentKey, ensureListed); // do not add a new message if there isn't a match.</span>
<a href="#l38.71"></a><span id="l38.71">     }</span>
<a href="#l38.72"></a><span id="l38.72">   }</span>
<a href="#l38.73"></a><span id="l38.73">   return NS_OK;</span>
<a href="#l38.74"></a><span id="l38.74"> }</span>
<a href="#l38.75"></a><span id="l38.75"> </span>
<a href="#l38.76"></a><span id="l38.76" class="difflineminus">-NS_IMETHODIMP nsMsgQuickSearchDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, </span>
<a href="#l38.77"></a><span id="l38.77" class="difflineplus">+NS_IMETHODIMP nsMsgQuickSearchDBView::OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l38.78"></a><span id="l38.78">                                        uint32_t aNewFlags, nsIDBChangeListener *aInstigator)</span>
<a href="#l38.79"></a><span id="l38.79"> {</span>
<a href="#l38.80"></a><span id="l38.80">   nsresult rv = nsMsgGroupView::OnHdrFlagsChanged(aHdrChanged, aOldFlags, aNewFlags, aInstigator);</span>
<a href="#l38.81"></a><span id="l38.81"> </span>
<a href="#l38.82"></a><span id="l38.82">   if (m_viewFolder &amp;&amp;</span>
<a href="#l38.83"></a><span id="l38.83">       (m_viewFolder != m_folder) &amp;&amp;</span>
<a href="#l38.84"></a><span id="l38.84">       (aOldFlags &amp; nsMsgMessageFlags::Read) != (aNewFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l38.85"></a><span id="l38.85">   {</span>
<a href="#l38.86"></a><span id="l38.86">     // if we're displaying a single folder virtual folder for an imap folder,</span>
<a href="#l38.87"></a><span id="l38.87">     // the search criteria might be on message body, and we might not have the</span>
<a href="#l38.88"></a><span id="l38.88" class="difflineminus">-    // message body offline, in which case we can't tell if the message </span>
<a href="#l38.89"></a><span id="l38.89" class="difflineplus">+    // message body offline, in which case we can't tell if the message</span>
<a href="#l38.90"></a><span id="l38.90">     // matched or not. But if the unread flag changed, we need to update the</span>
<a href="#l38.91"></a><span id="l38.91">     // unread counts. Normally, VirtualFolderChangeListener::OnHdrFlagsChanged will</span>
<a href="#l38.92"></a><span id="l38.92">     // handle this, but it won't work for body criteria when we don't have the</span>
<a href="#l38.93"></a><span id="l38.93">     // body offline.</span>
<a href="#l38.94"></a><span id="l38.94">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(m_viewFolder);</span>
<a href="#l38.95"></a><span id="l38.95">     if (imapFolder)</span>
<a href="#l38.96"></a><span id="l38.96">     {</span>
<a href="#l38.97"></a><span id="l38.97">       nsMsgViewIndex hdrIndex = FindHdr(aHdrChanged);</span>
<a href="#l38.98"></a><span id="l38.98" class="difflineat">@@ -187,17 +187,17 @@ NS_IMETHODIMP nsMsgQuickSearchDBView::On</span>
<a href="#l38.99"></a><span id="l38.99">       {</span>
<a href="#l38.100"></a><span id="l38.100">         nsCOMPtr &lt;nsIMsgSearchSession&gt; searchSession = do_QueryReferent(m_searchSession);</span>
<a href="#l38.101"></a><span id="l38.101">         if (searchSession)</span>
<a href="#l38.102"></a><span id="l38.102">         {</span>
<a href="#l38.103"></a><span id="l38.103">           bool oldMatch, newMatch;</span>
<a href="#l38.104"></a><span id="l38.104">           rv = searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;newMatch);</span>
<a href="#l38.105"></a><span id="l38.105">           aHdrChanged-&gt;SetFlags(aOldFlags);</span>
<a href="#l38.106"></a><span id="l38.106">           rv = searchSession-&gt;MatchHdr(aHdrChanged, m_db, &amp;oldMatch);</span>
<a href="#l38.107"></a><span id="l38.107" class="difflineminus">-          aHdrChanged-&gt;SetFlags(aNewFlags); </span>
<a href="#l38.108"></a><span id="l38.108" class="difflineplus">+          aHdrChanged-&gt;SetFlags(aNewFlags);</span>
<a href="#l38.109"></a><span id="l38.109">           // if it doesn't match the criteria, VirtualFolderChangeListener::OnHdrFlagsChanged</span>
<a href="#l38.110"></a><span id="l38.110">           // won't tweak the read/unread counts. So do it here:</span>
<a href="#l38.111"></a><span id="l38.111">           if (!oldMatch &amp;&amp; !newMatch)</span>
<a href="#l38.112"></a><span id="l38.112">           {</span>
<a href="#l38.113"></a><span id="l38.113">             nsCOMPtr &lt;nsIMsgDatabase&gt; virtDatabase;</span>
<a href="#l38.114"></a><span id="l38.114">             nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l38.115"></a><span id="l38.115"> </span>
<a href="#l38.116"></a><span id="l38.116">             rv = m_viewFolder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(virtDatabase));</span>
<a href="#l38.117"></a><span id="l38.117" class="difflineat">@@ -283,17 +283,17 @@ nsMsgQuickSearchDBView::OnSearchHit(nsIM</span>
<a href="#l38.118"></a><span id="l38.118">   // remember search hit and when search is done, reconcile cache</span>
<a href="#l38.119"></a><span id="l38.119">   // with new hits;</span>
<a href="#l38.120"></a><span id="l38.120">   m_hdrHits.AppendObject(aMsgHdr);</span>
<a href="#l38.121"></a><span id="l38.121">   nsMsgKey key;</span>
<a href="#l38.122"></a><span id="l38.122">   aMsgHdr-&gt;GetMessageKey(&amp;key);</span>
<a href="#l38.123"></a><span id="l38.123">   // Is FindKey going to be expensive here? A lot of hits could make</span>
<a href="#l38.124"></a><span id="l38.124">   // it a little bit slow to search through the view for every hit.</span>
<a href="#l38.125"></a><span id="l38.125">   if (m_cacheEmpty || FindKey(key, false) == nsMsgViewIndex_None)</span>
<a href="#l38.126"></a><span id="l38.126" class="difflineminus">-    return AddHdr(aMsgHdr); </span>
<a href="#l38.127"></a><span id="l38.127" class="difflineplus">+    return AddHdr(aMsgHdr);</span>
<a href="#l38.128"></a><span id="l38.128">   else</span>
<a href="#l38.129"></a><span id="l38.129">     return NS_OK;</span>
<a href="#l38.130"></a><span id="l38.130"> }</span>
<a href="#l38.131"></a><span id="l38.131"> </span>
<a href="#l38.132"></a><span id="l38.132"> NS_IMETHODIMP</span>
<a href="#l38.133"></a><span id="l38.133"> nsMsgQuickSearchDBView::OnSearchDone(nsresult status)</span>
<a href="#l38.134"></a><span id="l38.134"> {</span>
<a href="#l38.135"></a><span id="l38.135">   // We're a single-folder virtual folder if viewFolder != folder, and that is</span>
<a href="#l38.136"></a><span id="l38.136" class="difflineat">@@ -346,17 +346,17 @@ nsMsgQuickSearchDBView::OnSearchDone(nsr</span>
<a href="#l38.137"></a><span id="l38.137">     }</span>
<a href="#l38.138"></a><span id="l38.138">     dbFolderInfo-&gt;SetNumUnreadMessages(numUnread);</span>
<a href="#l38.139"></a><span id="l38.139">     dbFolderInfo-&gt;SetNumMessages(numTotal);</span>
<a href="#l38.140"></a><span id="l38.140">     m_viewFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l38.141"></a><span id="l38.141">     virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l38.142"></a><span id="l38.142">   }</span>
<a href="#l38.143"></a><span id="l38.143">   if (m_sortType != nsMsgViewSortType::byThread)//we do not find levels for the results.</span>
<a href="#l38.144"></a><span id="l38.144">   {</span>
<a href="#l38.145"></a><span id="l38.145" class="difflineminus">-    m_sortValid = false;       //sort the results </span>
<a href="#l38.146"></a><span id="l38.146" class="difflineplus">+    m_sortValid = false;       //sort the results</span>
<a href="#l38.147"></a><span id="l38.147">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l38.148"></a><span id="l38.148">   }</span>
<a href="#l38.149"></a><span id="l38.149">   if (m_viewFolder &amp;&amp; (m_viewFolder != m_folder))</span>
<a href="#l38.150"></a><span id="l38.150">     SetMRUTimeForFolder(m_viewFolder);</span>
<a href="#l38.151"></a><span id="l38.151"> </span>
<a href="#l38.152"></a><span id="l38.152">   return NS_OK;</span>
<a href="#l38.153"></a><span id="l38.153"> }</span>
<a href="#l38.154"></a><span id="l38.154"> </span>
<a href="#l38.155"></a><span id="l38.155" class="difflineat">@@ -371,17 +371,17 @@ nsMsgQuickSearchDBView::OnNewSearch()</span>
<a href="#l38.156"></a><span id="l38.156">   m_flags.Clear();</span>
<a href="#l38.157"></a><span id="l38.157">   m_hdrHits.Clear();</span>
<a href="#l38.158"></a><span id="l38.158">   // this needs to happen after we remove all the keys, since RowCountChanged() will call our GetRowCount()</span>
<a href="#l38.159"></a><span id="l38.159">   if (mTree)</span>
<a href="#l38.160"></a><span id="l38.160">     mTree-&gt;RowCountChanged(0, -oldSize);</span>
<a href="#l38.161"></a><span id="l38.161">   uint32_t folderFlags = 0;</span>
<a href="#l38.162"></a><span id="l38.162">   if (m_viewFolder)</span>
<a href="#l38.163"></a><span id="l38.163">     m_viewFolder-&gt;GetFlags(&amp;folderFlags);</span>
<a href="#l38.164"></a><span id="l38.164" class="difflineminus">-  // check if it's a virtual folder - if so, we should get the cached hits </span>
<a href="#l38.165"></a><span id="l38.165" class="difflineplus">+  // check if it's a virtual folder - if so, we should get the cached hits</span>
<a href="#l38.166"></a><span id="l38.166">   // from the db, and set a flag saying that we're using cached values.</span>
<a href="#l38.167"></a><span id="l38.167">   if (folderFlags &amp; nsMsgFolderFlags::Virtual)</span>
<a href="#l38.168"></a><span id="l38.168">   {</span>
<a href="#l38.169"></a><span id="l38.169">     nsCOMPtr&lt;nsISimpleEnumerator&gt; cachedHits;</span>
<a href="#l38.170"></a><span id="l38.170">     nsCString searchUri;</span>
<a href="#l38.171"></a><span id="l38.171">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l38.172"></a><span id="l38.172">     m_db-&gt;GetCachedHits(searchUri.get(), getter_AddRefs(cachedHits));</span>
<a href="#l38.173"></a><span id="l38.173">     if (cachedHits)</span>
<a href="#l38.174"></a><span id="l38.174" class="difflineat">@@ -474,26 +474,26 @@ nsresult nsMsgQuickSearchDBView::GetFirs</span>
<a href="#l38.175"></a><span id="l38.175">         {</span>
<a href="#l38.176"></a><span id="l38.176">           minLevel = level;</span>
<a href="#l38.177"></a><span id="l38.177">           retHdr = child;</span>
<a href="#l38.178"></a><span id="l38.178">         }</span>
<a href="#l38.179"></a><span id="l38.179">       }</span>
<a href="#l38.180"></a><span id="l38.180">     }</span>
<a href="#l38.181"></a><span id="l38.181">   }</span>
<a href="#l38.182"></a><span id="l38.182">   retHdr.forget(result);</span>
<a href="#l38.183"></a><span id="l38.183" class="difflineminus">-  return NS_OK; </span>
<a href="#l38.184"></a><span id="l38.184" class="difflineplus">+  return NS_OK;</span>
<a href="#l38.185"></a><span id="l38.185"> }</span>
<a href="#l38.186"></a><span id="l38.186"> </span>
<a href="#l38.187"></a><span id="l38.187"> nsresult nsMsgQuickSearchDBView::SortThreads(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l38.188"></a><span id="l38.188"> {</span>
<a href="#l38.189"></a><span id="l38.189">   // don't need to sort by threads for group view.</span>
<a href="#l38.190"></a><span id="l38.190">   if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l38.191"></a><span id="l38.191">     return NS_OK;</span>
<a href="#l38.192"></a><span id="l38.192">   // iterate over the messages in the view, getting the thread id's</span>
<a href="#l38.193"></a><span id="l38.193" class="difflineminus">-  // sort m_keys so we can quickly find if a key is in the view. </span>
<a href="#l38.194"></a><span id="l38.194" class="difflineplus">+  // sort m_keys so we can quickly find if a key is in the view.</span>
<a href="#l38.195"></a><span id="l38.195">   m_keys.Sort();</span>
<a href="#l38.196"></a><span id="l38.196">   // array of the threads' root hdr keys.</span>
<a href="#l38.197"></a><span id="l38.197">   nsTArray&lt;nsMsgKey&gt; threadRootIds;</span>
<a href="#l38.198"></a><span id="l38.198">   nsCOMPtr &lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l38.199"></a><span id="l38.199">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l38.200"></a><span id="l38.200">   nsCOMPtr &lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l38.201"></a><span id="l38.201">   for (uint32_t i = 0; i &lt; m_keys.Length(); i++)</span>
<a href="#l38.202"></a><span id="l38.202">   {</span>
<a href="#l38.203"></a><span id="l38.203" class="difflineat">@@ -571,17 +571,17 @@ nsresult nsMsgQuickSearchDBView::SortThr</span>
<a href="#l38.204"></a><span id="l38.204"> </span>
<a href="#l38.205"></a><span id="l38.205">   return NS_OK;</span>
<a href="#l38.206"></a><span id="l38.206"> }</span>
<a href="#l38.207"></a><span id="l38.207"> </span>
<a href="#l38.208"></a><span id="l38.208"> nsresult</span>
<a href="#l38.209"></a><span id="l38.209"> nsMsgQuickSearchDBView::ListCollapsedChildren(nsMsgViewIndex viewIndex,</span>
<a href="#l38.210"></a><span id="l38.210">                                               nsIMutableArray *messageArray)</span>
<a href="#l38.211"></a><span id="l38.211"> {</span>
<a href="#l38.212"></a><span id="l38.212" class="difflineminus">-  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr; </span>
<a href="#l38.213"></a><span id="l38.213" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l38.214"></a><span id="l38.214">   nsresult rv = GetThreadContainingIndex(viewIndex, getter_AddRefs(threadHdr));</span>
<a href="#l38.215"></a><span id="l38.215">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.216"></a><span id="l38.216">   uint32_t numChildren;</span>
<a href="#l38.217"></a><span id="l38.217">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l38.218"></a><span id="l38.218">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l38.219"></a><span id="l38.219">   nsMsgKey rootKey;</span>
<a href="#l38.220"></a><span id="l38.220">   GetMsgHdrForViewIndex(viewIndex, getter_AddRefs(rootHdr));</span>
<a href="#l38.221"></a><span id="l38.221">   rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l38.222"></a><span id="l38.222" class="difflineat">@@ -642,17 +642,17 @@ nsresult nsMsgQuickSearchDBView::ListIds</span>
<a href="#l38.223"></a><span id="l38.223">       if (msgKey != rootKey || (GroupViewUsesDummyRow() &amp;&amp; rootKeySkipped))</span>
<a href="#l38.224"></a><span id="l38.224">       {</span>
<a href="#l38.225"></a><span id="l38.225">         nsMsgViewIndex threadRootIndex = m_origKeys.BinaryIndexOf(msgKey);</span>
<a href="#l38.226"></a><span id="l38.226">         // if this hdr is in the original view, add it to new view.</span>
<a href="#l38.227"></a><span id="l38.227">         if (threadRootIndex != nsMsgViewIndex_None)</span>
<a href="#l38.228"></a><span id="l38.228">         {</span>
<a href="#l38.229"></a><span id="l38.229">           uint32_t childFlags;</span>
<a href="#l38.230"></a><span id="l38.230">           msgHdr-&gt;GetFlags(&amp;childFlags);</span>
<a href="#l38.231"></a><span id="l38.231" class="difflineminus">-          InsertMsgHdrAt(viewIndex, msgHdr, msgKey, childFlags, </span>
<a href="#l38.232"></a><span id="l38.232" class="difflineplus">+          InsertMsgHdrAt(viewIndex, msgHdr, msgKey, childFlags,</span>
<a href="#l38.233"></a><span id="l38.233">                         FindLevelInThread(msgHdr, startOfThreadViewIndex, viewIndex));</span>
<a href="#l38.234"></a><span id="l38.234">           if (! (rootFlags &amp; MSG_VIEW_FLAG_HASCHILDREN))</span>
<a href="#l38.235"></a><span id="l38.235">             m_flags[startOfThreadViewIndex] = rootFlags | MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l38.236"></a><span id="l38.236"> </span>
<a href="#l38.237"></a><span id="l38.237">           viewIndex++;</span>
<a href="#l38.238"></a><span id="l38.238">           (*pNumListed)++;</span>
<a href="#l38.239"></a><span id="l38.239">         }</span>
<a href="#l38.240"></a><span id="l38.240">       }</span>
<a href="#l38.241"></a><span id="l38.241" class="difflineat">@@ -671,17 +671,17 @@ nsMsgQuickSearchDBView::ListIdsInThreadO</span>
<a href="#l38.242"></a><span id="l38.242">                                              uint32_t callLevel,</span>
<a href="#l38.243"></a><span id="l38.243">                                              nsMsgKey keyToSkip,</span>
<a href="#l38.244"></a><span id="l38.244">                                              nsMsgViewIndex *viewIndex,</span>
<a href="#l38.245"></a><span id="l38.245">                                              uint32_t *pNumListed)</span>
<a href="#l38.246"></a><span id="l38.246"> {</span>
<a href="#l38.247"></a><span id="l38.247">   nsCOMPtr &lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l38.248"></a><span id="l38.248">   nsresult rv = threadHdr-&gt;EnumerateMessages(parentKey, getter_AddRefs(msgEnumerator));</span>
<a href="#l38.249"></a><span id="l38.249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.250"></a><span id="l38.250" class="difflineminus">-  </span>
<a href="#l38.251"></a><span id="l38.251" class="difflineplus">+</span>
<a href="#l38.252"></a><span id="l38.252">   // We use the numChildren as a sanity check on the thread structure.</span>
<a href="#l38.253"></a><span id="l38.253">   uint32_t numChildren;</span>
<a href="#l38.254"></a><span id="l38.254">   (void) threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l38.255"></a><span id="l38.255">   bool hasMore;</span>
<a href="#l38.256"></a><span id="l38.256">   nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l38.257"></a><span id="l38.257">   nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l38.258"></a><span id="l38.258">   while (NS_SUCCEEDED(rv) &amp;&amp; NS_SUCCEEDED(rv = msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l38.259"></a><span id="l38.259">          hasMore)</span>
<a href="#l38.260"></a><span id="l38.260" class="difflineat">@@ -761,17 +761,17 @@ nsresult nsMsgQuickSearchDBView::Expansi</span>
<a href="#l38.261"></a><span id="l38.261">   if (index &gt;= ((nsMsgViewIndex) m_keys.Length()))</span>
<a href="#l38.262"></a><span id="l38.262">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l38.263"></a><span id="l38.263"> </span>
<a href="#l38.264"></a><span id="l38.264">   char flags = m_flags[index];</span>
<a href="#l38.265"></a><span id="l38.265"> </span>
<a href="#l38.266"></a><span id="l38.266">   if (!(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l38.267"></a><span id="l38.267">     return NS_OK;</span>
<a href="#l38.268"></a><span id="l38.268"> </span>
<a href="#l38.269"></a><span id="l38.269" class="difflineminus">-  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr; </span>
<a href="#l38.270"></a><span id="l38.270" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l38.271"></a><span id="l38.271">   nsresult rv = GetThreadContainingIndex(index, getter_AddRefs(threadHdr));</span>
<a href="#l38.272"></a><span id="l38.272">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l38.273"></a><span id="l38.273">   uint32_t numChildren;</span>
<a href="#l38.274"></a><span id="l38.274">   threadHdr-&gt;GetNumChildren(&amp;numChildren);</span>
<a href="#l38.275"></a><span id="l38.275">   nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l38.276"></a><span id="l38.276">   nsMsgKey rootKey;</span>
<a href="#l38.277"></a><span id="l38.277">   GetMsgHdrForViewIndex(index, getter_AddRefs(rootHdr));</span>
<a href="#l38.278"></a><span id="l38.278">   rootHdr-&gt;GetMessageKey(&amp;rootKey);</span>
<a href="#l38.279"></a><span id="l38.279" class="difflineat">@@ -797,42 +797,42 @@ nsresult nsMsgQuickSearchDBView::Expansi</span>
<a href="#l38.280"></a><span id="l38.280">       }</span>
<a href="#l38.281"></a><span id="l38.281">     }</span>
<a href="#l38.282"></a><span id="l38.282">   }</span>
<a href="#l38.283"></a><span id="l38.283">   if (! (flags &amp; nsMsgMessageFlags::Elided))</span>
<a href="#l38.284"></a><span id="l38.284">     *expansionDelta = - (*expansionDelta);</span>
<a href="#l38.285"></a><span id="l38.285">   return NS_OK;</span>
<a href="#l38.286"></a><span id="l38.286"> }</span>
<a href="#l38.287"></a><span id="l38.287"> </span>
<a href="#l38.288"></a><span id="l38.288" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l38.289"></a><span id="l38.289" class="difflineminus">-nsMsgQuickSearchDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders, </span>
<a href="#l38.290"></a><span id="l38.290" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l38.291"></a><span id="l38.291" class="difflineplus">+nsMsgQuickSearchDBView::OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l38.292"></a><span id="l38.292">                                      nsMsgViewSortTypeValue aSortType,</span>
<a href="#l38.293"></a><span id="l38.293" class="difflineminus">-                                     nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l38.294"></a><span id="l38.294" class="difflineplus">+                                     nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l38.295"></a><span id="l38.295">                                      nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l38.296"></a><span id="l38.296">                                      int32_t *aCount)</span>
<a href="#l38.297"></a><span id="l38.297"> {</span>
<a href="#l38.298"></a><span id="l38.298">   if (aViewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l38.299"></a><span id="l38.299" class="difflineminus">-    return nsMsgGroupView::OpenWithHdrs(aHeaders, aSortType, aSortOrder, </span>
<a href="#l38.300"></a><span id="l38.300" class="difflineplus">+    return nsMsgGroupView::OpenWithHdrs(aHeaders, aSortType, aSortOrder,</span>
<a href="#l38.301"></a><span id="l38.301">                                         aViewFlags, aCount);</span>
<a href="#l38.302"></a><span id="l38.302"> </span>
<a href="#l38.303"></a><span id="l38.303">   m_sortType = aSortType;</span>
<a href="#l38.304"></a><span id="l38.304">   m_sortOrder = aSortOrder;</span>
<a href="#l38.305"></a><span id="l38.305">   m_viewFlags = aViewFlags;</span>
<a href="#l38.306"></a><span id="l38.306"> </span>
<a href="#l38.307"></a><span id="l38.307">   bool hasMore;</span>
<a href="#l38.308"></a><span id="l38.308">   nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l38.309"></a><span id="l38.309">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l38.310"></a><span id="l38.310">   nsresult rv = NS_OK;</span>
<a href="#l38.311"></a><span id="l38.311">   while (NS_SUCCEEDED(rv = aHeaders-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l38.312"></a><span id="l38.312">   {</span>
<a href="#l38.313"></a><span id="l38.313">     rv = aHeaders-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l38.314"></a><span id="l38.314">     if (NS_SUCCEEDED(rv) &amp;&amp; supports)</span>
<a href="#l38.315"></a><span id="l38.315">     {</span>
<a href="#l38.316"></a><span id="l38.316">       msgHdr = do_QueryInterface(supports);</span>
<a href="#l38.317"></a><span id="l38.317" class="difflineminus">-      AddHdr(msgHdr); </span>
<a href="#l38.318"></a><span id="l38.318" class="difflineplus">+      AddHdr(msgHdr);</span>
<a href="#l38.319"></a><span id="l38.319">     }</span>
<a href="#l38.320"></a><span id="l38.320">     else</span>
<a href="#l38.321"></a><span id="l38.321">       break;</span>
<a href="#l38.322"></a><span id="l38.322">   }</span>
<a href="#l38.323"></a><span id="l38.323">   *aCount = m_keys.Length();</span>
<a href="#l38.324"></a><span id="l38.324">   return rv;</span>
<a href="#l38.325"></a><span id="l38.325"> }</span>
<a href="#l38.326"></a><span id="l38.326"> </span>
<a href="#l38.327"></a><span id="l38.327" class="difflineat">@@ -843,17 +843,17 @@ NS_IMETHODIMP nsMsgQuickSearchDBView::Se</span>
<a href="#l38.328"></a><span id="l38.328">   if ((m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort) ^</span>
<a href="#l38.329"></a><span id="l38.329">       (aViewFlags &amp; nsMsgViewFlagsType::kGroupBySort))</span>
<a href="#l38.330"></a><span id="l38.330">     rv = RebuildView(aViewFlags);</span>
<a href="#l38.331"></a><span id="l38.331">   nsMsgDBView::SetViewFlags(aViewFlags);</span>
<a href="#l38.332"></a><span id="l38.332"> </span>
<a href="#l38.333"></a><span id="l38.333">   return rv;</span>
<a href="#l38.334"></a><span id="l38.334"> }</span>
<a href="#l38.335"></a><span id="l38.335"> </span>
<a href="#l38.336"></a><span id="l38.336" class="difflineminus">-nsresult </span>
<a href="#l38.337"></a><span id="l38.337" class="difflineplus">+nsresult</span>
<a href="#l38.338"></a><span id="l38.338"> nsMsgQuickSearchDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l38.339"></a><span id="l38.339"> {</span>
<a href="#l38.340"></a><span id="l38.340">   return GetViewEnumerator(enumerator);</span>
<a href="#l38.341"></a><span id="l38.341"> }</span>
<a href="#l38.342"></a><span id="l38.342"> </span>
<a href="#l38.343"></a><span id="l38.343"> NS_IMETHODIMP</span>
<a href="#l38.344"></a><span id="l38.344"> nsMsgQuickSearchDBView::OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted,</span>
<a href="#l38.345"></a><span id="l38.345">                                      nsMsgKey aParentKey,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgQuickSearchDBView.h</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -18,40 +18,40 @@ class nsMsgQuickSearchDBView : public ns</span>
<a href="#l39.4"></a><span id="l39.4"> {</span>
<a href="#l39.5"></a><span id="l39.5"> public:</span>
<a href="#l39.6"></a><span id="l39.6">   nsMsgQuickSearchDBView();</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l39.9"></a><span id="l39.9">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11">   virtual const char * GetViewName(void) override {return &quot;QuickSearchView&quot;; }</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, </span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-                  nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType,</span>
<a href="#l39.15"></a><span id="l39.15" class="difflineplus">+                  nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l39.16"></a><span id="l39.16">                   nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineminus">-  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, </span>
<a href="#l39.18"></a><span id="l39.18" class="difflineminus">-                          nsMsgViewSortTypeValue aSortType, </span>
<a href="#l39.19"></a><span id="l39.19" class="difflineminus">-                          nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-                          nsMsgViewFlagsTypeValue aViewFlags, </span>
<a href="#l39.21"></a><span id="l39.21" class="difflineplus">+  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+                          nsMsgViewSortTypeValue aSortType,</span>
<a href="#l39.23"></a><span id="l39.23" class="difflineplus">+                          nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l39.24"></a><span id="l39.24" class="difflineplus">+                          nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l39.25"></a><span id="l39.25">                           int32_t *aCount) override;</span>
<a href="#l39.26"></a><span id="l39.26">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance,</span>
<a href="#l39.27"></a><span id="l39.27">                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l39.28"></a><span id="l39.28">                          nsIMsgDBViewCommandUpdater *aCommandUpdater,</span>
<a href="#l39.29"></a><span id="l39.29">                          nsIMsgDBView **_retval) override;</span>
<a href="#l39.30"></a><span id="l39.30">   NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView,</span>
<a href="#l39.31"></a><span id="l39.31">                         nsIMessenger *aMessengerInstance,</span>
<a href="#l39.32"></a><span id="l39.32">                         nsIMsgWindow *aMsgWindow,</span>
<a href="#l39.33"></a><span id="l39.33">                         nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l39.34"></a><span id="l39.34">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue aCommand) override;</span>
<a href="#l39.35"></a><span id="l39.35">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l39.36"></a><span id="l39.36">   NS_IMETHOD SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) override;</span>
<a href="#l39.37"></a><span id="l39.37">   NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession) override;</span>
<a href="#l39.38"></a><span id="l39.38">   NS_IMETHOD GetSearchSession(nsIMsgSearchSession* *aSearchSession) override;</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineminus">-  NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags, </span>
<a href="#l39.40"></a><span id="l39.40" class="difflineplus">+  NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l39.41"></a><span id="l39.41">                                uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus, </span>
<a href="#l39.43"></a><span id="l39.43" class="difflineplus">+  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l39.44"></a><span id="l39.44">                                   nsIDBChangeListener * aInstigator) override;</span>
<a href="#l39.45"></a><span id="l39.45">   NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l39.46"></a><span id="l39.46">                           int32_t aFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l39.47"></a><span id="l39.47">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l39.48"></a><span id="l39.48"> </span>
<a href="#l39.49"></a><span id="l39.49"> protected:</span>
<a href="#l39.50"></a><span id="l39.50">   virtual ~nsMsgQuickSearchDBView();</span>
<a href="#l39.51"></a><span id="l39.51">   nsWeakPtr m_searchSession;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFDataSource.h</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgRDFDataSource.h</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -41,21 +41,21 @@ class nsMsgRDFDataSource : public nsIRDF</span>
<a href="#l40.4"></a><span id="l40.4"> </span>
<a href="#l40.5"></a><span id="l40.5">  protected:</span>
<a href="#l40.6"></a><span id="l40.6">   virtual ~nsMsgRDFDataSource();</span>
<a href="#l40.7"></a><span id="l40.7">   nsIRDFService *getRDFService();</span>
<a href="#l40.8"></a><span id="l40.8">   static bool assertEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l40.9"></a><span id="l40.9">   static bool unassertEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l40.10"></a><span id="l40.10">   static bool changeEnumFunc(nsIRDFObserver *aObserver, void *aData);</span>
<a href="#l40.11"></a><span id="l40.11">   nsresult  NotifyObservers(nsIRDFResource *subject, nsIRDFResource *property,</span>
<a href="#l40.12"></a><span id="l40.12" class="difflineminus">-                            nsIRDFNode *newObject, nsIRDFNode *oldObject, </span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+                            nsIRDFNode *newObject, nsIRDFNode *oldObject,</span>
<a href="#l40.14"></a><span id="l40.14">                             bool assert, bool change);</span>
<a href="#l40.15"></a><span id="l40.15"> </span>
<a href="#l40.16"></a><span id="l40.16" class="difflineminus">-  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource, </span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-                    nsIRDFResource *propertyResource, nsIRDFNode *newNode, </span>
<a href="#l40.18"></a><span id="l40.18" class="difflineplus">+  virtual nsresult NotifyPropertyChanged(nsIRDFResource *resource,</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineplus">+                    nsIRDFResource *propertyResource, nsIRDFNode *newNode,</span>
<a href="#l40.20"></a><span id="l40.20">                     nsIRDFNode *oldNode = nullptr);</span>
<a href="#l40.21"></a><span id="l40.21"> </span>
<a href="#l40.22"></a><span id="l40.22">   nsCOMPtr&lt;nsIMsgWindow&gt; mWindow;</span>
<a href="#l40.23"></a><span id="l40.23"> </span>
<a href="#l40.24"></a><span id="l40.24">   bool m_shuttingDown;</span>
<a href="#l40.25"></a><span id="l40.25">   bool mInitialized;</span>
<a href="#l40.26"></a><span id="l40.26"> </span>
<a href="#l40.27"></a><span id="l40.27">  private:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.cpp</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgRDFUtils.cpp</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -13,68 +13,68 @@ nsresult createNode(const char16_t *str,</span>
<a href="#l41.4"></a><span id="l41.4">   nsresult rv;</span>
<a href="#l41.5"></a><span id="l41.5">   nsCOMPtr&lt;nsIRDFLiteral&gt; value;</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7">   NS_ASSERTION(rdfService, &quot;rdfService is null&quot;);</span>
<a href="#l41.8"></a><span id="l41.8">   if (!rdfService) return NS_OK;</span>
<a href="#l41.9"></a><span id="l41.9"> </span>
<a href="#l41.10"></a><span id="l41.10">   if (str) {</span>
<a href="#l41.11"></a><span id="l41.11">     rv = rdfService-&gt;GetLiteral(str, getter_AddRefs(value));</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-  } </span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  }</span>
<a href="#l41.14"></a><span id="l41.14">   else {</span>
<a href="#l41.15"></a><span id="l41.15">     rv = rdfService-&gt;GetLiteral(EmptyString().get(), getter_AddRefs(value));</span>
<a href="#l41.16"></a><span id="l41.16">   }</span>
<a href="#l41.17"></a><span id="l41.17"> </span>
<a href="#l41.18"></a><span id="l41.18">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l41.19"></a><span id="l41.19">     value.forget(node);</span>
<a href="#l41.20"></a><span id="l41.20">   }</span>
<a href="#l41.21"></a><span id="l41.21">   return rv;</span>
<a href="#l41.22"></a><span id="l41.22"> }</span>
<a href="#l41.23"></a><span id="l41.23"> </span>
<a href="#l41.24"></a><span id="l41.24"> nsresult createIntNode(int32_t value, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l41.25"></a><span id="l41.25"> {</span>
<a href="#l41.26"></a><span id="l41.26">   *node = nullptr;</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-  nsresult rv; </span>
<a href="#l41.28"></a><span id="l41.28" class="difflineminus">-  if (!rdfService) return NS_ERROR_NULL_POINTER;  </span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+  nsresult rv;</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+  if (!rdfService) return NS_ERROR_NULL_POINTER;</span>
<a href="#l41.31"></a><span id="l41.31">   nsCOMPtr&lt;nsIRDFInt&gt; num;</span>
<a href="#l41.32"></a><span id="l41.32">   rv = rdfService-&gt;GetIntLiteral(value, getter_AddRefs(num));</span>
<a href="#l41.33"></a><span id="l41.33">   if(NS_SUCCEEDED(rv)) {</span>
<a href="#l41.34"></a><span id="l41.34">     num.forget(node);</span>
<a href="#l41.35"></a><span id="l41.35">   }</span>
<a href="#l41.36"></a><span id="l41.36">   return rv;</span>
<a href="#l41.37"></a><span id="l41.37"> }</span>
<a href="#l41.38"></a><span id="l41.38"> </span>
<a href="#l41.39"></a><span id="l41.39"> nsresult createBlobNode(uint8_t *value, uint32_t &amp;length, nsIRDFNode **node, nsIRDFService *rdfService)</span>
<a href="#l41.40"></a><span id="l41.40"> {</span>
<a href="#l41.41"></a><span id="l41.41">   NS_ENSURE_ARG_POINTER(node);</span>
<a href="#l41.42"></a><span id="l41.42">   NS_ENSURE_ARG_POINTER(rdfService);</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-  </span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+</span>
<a href="#l41.45"></a><span id="l41.45">   *node = nullptr;</span>
<a href="#l41.46"></a><span id="l41.46">   nsCOMPtr&lt;nsIRDFBlob&gt; blob;</span>
<a href="#l41.47"></a><span id="l41.47">   nsresult rv = rdfService-&gt;GetBlobLiteral(value, length, getter_AddRefs(blob));</span>
<a href="#l41.48"></a><span id="l41.48">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l41.49"></a><span id="l41.49">   blob.forget(node);</span>
<a href="#l41.50"></a><span id="l41.50">   return rv;</span>
<a href="#l41.51"></a><span id="l41.51"> }</span>
<a href="#l41.52"></a><span id="l41.52"> </span>
<a href="#l41.53"></a><span id="l41.53"> nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* folderResource,</span>
<a href="#l41.54"></a><span id="l41.54">                                nsIRDFResource *property,bool tv, nsIRDFNode *target,bool* hasAssertion)</span>
<a href="#l41.55"></a><span id="l41.55"> {</span>
<a href="#l41.56"></a><span id="l41.56">   NS_ENSURE_ARG_POINTER(hasAssertion);</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineminus">-  </span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+</span>
<a href="#l41.59"></a><span id="l41.59">   nsCOMPtr&lt;nsIRDFNode&gt; currentTarget;</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineminus">-  </span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+</span>
<a href="#l41.62"></a><span id="l41.62">   nsresult rv = dataSource-&gt;GetTarget(folderResource, property,tv, getter_AddRefs(currentTarget));</span>
<a href="#l41.63"></a><span id="l41.63">   if(NS_SUCCEEDED(rv))</span>
<a href="#l41.64"></a><span id="l41.64">   {</span>
<a href="#l41.65"></a><span id="l41.65">     nsCOMPtr&lt;nsIRDFLiteral&gt; value1(do_QueryInterface(target));</span>
<a href="#l41.66"></a><span id="l41.66">     nsCOMPtr&lt;nsIRDFLiteral&gt; value2(do_QueryInterface(currentTarget));</span>
<a href="#l41.67"></a><span id="l41.67">     if(value1 &amp;&amp; value2)</span>
<a href="#l41.68"></a><span id="l41.68">       //If the two values are equal then it has this assertion</span>
<a href="#l41.69"></a><span id="l41.69">       *hasAssertion = (value1 == value2);</span>
<a href="#l41.70"></a><span id="l41.70">   }</span>
<a href="#l41.71"></a><span id="l41.71">   else</span>
<a href="#l41.72"></a><span id="l41.72">     rv = NS_NOINTERFACE;</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-  </span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+</span>
<a href="#l41.75"></a><span id="l41.75">   return rv;</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-  </span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+</span>
<a href="#l41.78"></a><span id="l41.78"> }</span>
<a href="#l41.79"></a><span id="l41.79"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/base/src/nsMsgRDFUtils.h</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgRDFUtils.h</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -92,13 +92,13 @@ typedef struct _nsMsgRDFNotification {</span>
<a href="#l42.4"></a><span id="l42.4"> nsresult createNode(const char16_t *str, nsIRDFNode **, nsIRDFService *rdfService);</span>
<a href="#l42.5"></a><span id="l42.5"> </span>
<a href="#l42.6"></a><span id="l42.6"> //Given an int32_t creates an nsIRDFNode that is really an int literal.</span>
<a href="#l42.7"></a><span id="l42.7"> nsresult createIntNode(int32_t value, nsIRDFNode **node, nsIRDFService *rdfService);</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9"> //Given an nsIRDFBlob creates an nsIRDFNode that is really an blob literal.</span>
<a href="#l42.10"></a><span id="l42.10"> nsresult createBlobNode(uint8_t *value, uint32_t &amp;length,  nsIRDFNode **node, nsIRDFService *rdfService);</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-//s Assertion for a datasource that will just call GetTarget on property.  When all of our </span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+//s Assertion for a datasource that will just call GetTarget on property.  When all of our</span>
<a href="#l42.14"></a><span id="l42.14"> //datasource derive from our datasource baseclass, this should be moved there and the first</span>
<a href="#l42.15"></a><span id="l42.15"> //parameter will no longer be needed.</span>
<a href="#l42.16"></a><span id="l42.16"> nsresult GetTargetHasAssertion(nsIRDFDataSource *dataSource, nsIRDFResource* folderResource,</span>
<a href="#l42.17"></a><span id="l42.17"> 							   nsIRDFResource *property,bool tv, nsIRDFNode *target,bool* hasAssertion);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSearchDBView.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -24,38 +24,38 @@ public:</span>
<a href="#l43.4"></a><span id="l43.4"> </span>
<a href="#l43.5"></a><span id="l43.5">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l43.6"></a><span id="l43.6">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l43.7"></a><span id="l43.7">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l43.8"></a><span id="l43.8"> </span>
<a href="#l43.9"></a><span id="l43.9">   NS_IMETHOD SetSearchSession(nsIMsgSearchSession *aSearchSession) override;</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11">   virtual const char *GetViewName(void) override { return &quot;SearchView&quot;; }</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l43.14"></a><span id="l43.14">         nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l43.15"></a><span id="l43.15">   NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l43.16"></a><span id="l43.16">                          nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval) override;</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, </span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l43.19"></a><span id="l43.19">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l43.20"></a><span id="l43.20">   NS_IMETHOD Close() override;</span>
<a href="#l43.21"></a><span id="l43.21">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l43.22"></a><span id="l43.22">   NS_IMETHOD Sort(nsMsgViewSortTypeValue sortType,</span>
<a href="#l43.23"></a><span id="l43.23">                   nsMsgViewSortOrderValue sortOrder) override;</span>
<a href="#l43.24"></a><span id="l43.24">   NS_IMETHOD GetCommandStatus(nsMsgViewCommandTypeValue command,</span>
<a href="#l43.25"></a><span id="l43.25">                               bool *selectable_p,</span>
<a href="#l43.26"></a><span id="l43.26">                               nsMsgViewCommandCheckStateValue *selected_p) override;</span>
<a href="#l43.27"></a><span id="l43.27">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue command) override;</span>
<a href="#l43.28"></a><span id="l43.28">   NS_IMETHOD DoCommandWithFolder(nsMsgViewCommandTypeValue command, nsIMsgFolder *destFolder) override;</span>
<a href="#l43.29"></a><span id="l43.29">   NS_IMETHOD GetHdrForFirstSelectedMessage(nsIMsgDBHdr **hdr) override;</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineminus">-  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders, </span>
<a href="#l43.31"></a><span id="l43.31" class="difflineplus">+  NS_IMETHOD OpenWithHdrs(nsISimpleEnumerator *aHeaders,</span>
<a href="#l43.32"></a><span id="l43.32">                           nsMsgViewSortTypeValue aSortType,</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-                          nsMsgViewSortOrderValue aSortOrder, </span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+                          nsMsgViewSortOrderValue aSortOrder,</span>
<a href="#l43.35"></a><span id="l43.35">                           nsMsgViewFlagsTypeValue aViewFlags,</span>
<a href="#l43.36"></a><span id="l43.36">                           int32_t *aCount) override;</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">-  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey, </span>
<a href="#l43.38"></a><span id="l43.38" class="difflineplus">+  NS_IMETHOD OnHdrDeleted(nsIMsgDBHdr *aHdrDeleted, nsMsgKey aParentKey,</span>
<a href="#l43.39"></a><span id="l43.39">                           int32_t aFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l43.40"></a><span id="l43.40">   NS_IMETHOD OnHdrFlagsChanged(nsIMsgDBHdr *aHdrChanged, uint32_t aOldFlags,</span>
<a href="#l43.41"></a><span id="l43.41">                                uint32_t aNewFlags, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l43.42"></a><span id="l43.42">   NS_IMETHOD GetNumMsgsInView(int32_t *aNumMsgs) override;</span>
<a href="#l43.43"></a><span id="l43.43">   // override to get location</span>
<a href="#l43.44"></a><span id="l43.44">   NS_IMETHOD GetCellText(int32_t aRow, nsITreeColumn* aCol, nsAString&amp; aValue) override;</span>
<a href="#l43.45"></a><span id="l43.45">   virtual nsresult GetMsgHdrForViewIndex(nsMsgViewIndex index, nsIMsgDBHdr **msgHdr) override;</span>
<a href="#l43.46"></a><span id="l43.46">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, bool ensureListed) override;</span>
<a href="#l43.47"></a><span id="l43.47" class="difflineat">@@ -67,18 +67,18 @@ public:</span>
<a href="#l43.48"></a><span id="l43.48">   virtual nsresult GetFolderFromMsgURI(const char *aMsgURI, nsIMsgFolder **aFolder) override;</span>
<a href="#l43.49"></a><span id="l43.49"> </span>
<a href="#l43.50"></a><span id="l43.50">   NS_IMETHOD GetThreadContainingMsgHdr(nsIMsgDBHdr *msgHdr, nsIMsgThread **pThread) override;</span>
<a href="#l43.51"></a><span id="l43.51"> </span>
<a href="#l43.52"></a><span id="l43.52"> protected:</span>
<a href="#l43.53"></a><span id="l43.53">   virtual ~nsMsgSearchDBView();</span>
<a href="#l43.54"></a><span id="l43.54">   virtual void InternalClose() override;</span>
<a href="#l43.55"></a><span id="l43.55">   virtual nsresult HashHdr(nsIMsgDBHdr *msgHdr, nsString&amp; aHashKey) override;</span>
<a href="#l43.56"></a><span id="l43.56" class="difflineminus">-  virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr, </span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-                                   nsMsgViewIndex startOfThreadViewIndex, </span>
<a href="#l43.58"></a><span id="l43.58" class="difflineplus">+  virtual nsresult ListIdsInThread(nsIMsgThread *threadHdr,</span>
<a href="#l43.59"></a><span id="l43.59" class="difflineplus">+                                   nsMsgViewIndex startOfThreadViewIndex,</span>
<a href="#l43.60"></a><span id="l43.60">                                    uint32_t *pNumListed) override;</span>
<a href="#l43.61"></a><span id="l43.61">   nsresult FetchLocation(int32_t aRow, nsAString&amp; aLocationString);</span>
<a href="#l43.62"></a><span id="l43.62">   virtual nsresult AddHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l43.63"></a><span id="l43.63">   virtual nsresult GetDBForViewIndex(nsMsgViewIndex index, nsIMsgDatabase **db) override;</span>
<a href="#l43.64"></a><span id="l43.64">   virtual nsresult RemoveByIndex(nsMsgViewIndex index) override;</span>
<a href="#l43.65"></a><span id="l43.65">   virtual nsresult CopyMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool isMove, nsIMsgFolder *destFolder) override;</span>
<a href="#l43.66"></a><span id="l43.66">   virtual nsresult DeleteMessages(nsIMsgWindow *window, nsMsgViewIndex *indices, int32_t numIndices, bool deleteStorage) override;</span>
<a href="#l43.67"></a><span id="l43.67">   virtual void InsertMsgHdrAt(nsMsgViewIndex index, nsIMsgDBHdr *hdr,</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineat">@@ -94,17 +94,17 @@ protected:</span>
<a href="#l43.69"></a><span id="l43.69">   nsresult PartitionSelectionByFolder(nsMsgViewIndex *indices,</span>
<a href="#l43.70"></a><span id="l43.70">                                       int32_t numIndices,</span>
<a href="#l43.71"></a><span id="l43.71">                                       mozilla::UniquePtr&lt;nsTArray&lt;uint32_t&gt;[]&gt; &amp;indexArrays,</span>
<a href="#l43.72"></a><span id="l43.72">                                       int32_t *numArrays);</span>
<a href="#l43.73"></a><span id="l43.73"> </span>
<a href="#l43.74"></a><span id="l43.74">   virtual nsresult ApplyCommandToIndicesWithFolder(nsMsgViewCommandTypeValue command, nsMsgViewIndex* indices,</span>
<a href="#l43.75"></a><span id="l43.75">                     int32_t numIndices, nsIMsgFolder *destFolder) override;</span>
<a href="#l43.76"></a><span id="l43.76">   void MoveThreadAt(nsMsgViewIndex threadIndex);</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineminus">-  </span>
<a href="#l43.78"></a><span id="l43.78" class="difflineplus">+</span>
<a href="#l43.79"></a><span id="l43.79">   virtual nsresult GetMessageEnumerator(nsISimpleEnumerator **enumerator) override;</span>
<a href="#l43.80"></a><span id="l43.80">   virtual nsresult InsertHdrFromFolder(nsIMsgDBHdr *msgHdr, nsIMsgFolder *folder);</span>
<a href="#l43.81"></a><span id="l43.81"> </span>
<a href="#l43.82"></a><span id="l43.82">   nsCOMArray&lt;nsIMsgFolder&gt; m_folders;</span>
<a href="#l43.83"></a><span id="l43.83">   nsCOMArray&lt;nsIMutableArray&gt; m_hdrsForEachFolder;</span>
<a href="#l43.84"></a><span id="l43.84">   nsCOMArray&lt;nsIMsgFolder&gt; m_uniqueFoldersSelected;</span>
<a href="#l43.85"></a><span id="l43.85">   uint32_t mCurIndex;</span>
<a href="#l43.86"></a><span id="l43.86"> </span>
<a href="#l43.87"></a><span id="l43.87" class="difflineat">@@ -117,17 +117,17 @@ protected:</span>
<a href="#l43.88"></a><span id="l43.88"> </span>
<a href="#l43.89"></a><span id="l43.89">   nsresult ProcessRequestsInOneFolder(nsIMsgWindow *window);</span>
<a href="#l43.90"></a><span id="l43.90">   nsresult ProcessRequestsInAllFolders(nsIMsgWindow *window);</span>
<a href="#l43.91"></a><span id="l43.91">   // these are for doing threading of the search hits</span>
<a href="#l43.92"></a><span id="l43.92"> </span>
<a href="#l43.93"></a><span id="l43.93">   // used for assigning thread id's to xfview threads.</span>
<a href="#l43.94"></a><span id="l43.94">   nsMsgKey m_nextThreadId;</span>
<a href="#l43.95"></a><span id="l43.95">   // this maps message-ids and reference message ids to</span>
<a href="#l43.96"></a><span id="l43.96" class="difflineminus">-  // the corresponding nsMsgXFViewThread object. If we're </span>
<a href="#l43.97"></a><span id="l43.97" class="difflineplus">+  // the corresponding nsMsgXFViewThread object. If we're</span>
<a href="#l43.98"></a><span id="l43.98">   // doing subject threading, we would throw subjects</span>
<a href="#l43.99"></a><span id="l43.99">   // into the same table.</span>
<a href="#l43.100"></a><span id="l43.100">   nsInterfaceHashtable &lt;nsCStringHashKey, nsIMsgThread&gt; m_threadsTable;</span>
<a href="#l43.101"></a><span id="l43.101"> </span>
<a href="#l43.102"></a><span id="l43.102">   // map message-ids to msg hdrs in the view, used for threading.</span>
<a href="#l43.103"></a><span id="l43.103">   nsInterfaceHashtable &lt;nsCStringHashKey, nsIMsgDBHdr&gt; m_hdrsTable;</span>
<a href="#l43.104"></a><span id="l43.104">   uint32_t m_totalMessagesInView;</span>
<a href="#l43.105"></a><span id="l43.105"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/base/src/nsMsgServiceProvider.cpp</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgServiceProvider.cpp</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -33,17 +33,17 @@ nsMsgServiceProviderService::~nsMsgServi</span>
<a href="#l44.4"></a><span id="l44.4"> NS_IMPL_ISUPPORTS(nsMsgServiceProviderService, nsIRDFDataSource)</span>
<a href="#l44.5"></a><span id="l44.5"> </span>
<a href="#l44.6"></a><span id="l44.6"> nsresult</span>
<a href="#l44.7"></a><span id="l44.7"> nsMsgServiceProviderService::Init()</span>
<a href="#l44.8"></a><span id="l44.8"> {</span>
<a href="#l44.9"></a><span id="l44.9">   nsresult rv;</span>
<a href="#l44.10"></a><span id="l44.10">   nsCOMPtr&lt;nsIRDFService&gt; rdf = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l44.11"></a><span id="l44.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-  </span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+</span>
<a href="#l44.14"></a><span id="l44.14">   mInnerDataSource = do_CreateInstance(kRDFCompositeDataSourceCID, &amp;rv);</span>
<a href="#l44.15"></a><span id="l44.15">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.16"></a><span id="l44.16"> </span>
<a href="#l44.17"></a><span id="l44.17">   LoadISPFiles();</span>
<a href="#l44.18"></a><span id="l44.18">   return NS_OK;</span>
<a href="#l44.19"></a><span id="l44.19"> }</span>
<a href="#l44.20"></a><span id="l44.20"> </span>
<a href="#l44.21"></a><span id="l44.21"> /**</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineat">@@ -61,17 +61,17 @@ void nsMsgServiceProviderService::LoadIS</span>
<a href="#l44.23"></a><span id="l44.23">   nsCOMPtr&lt;nsISimpleEnumerator&gt; ispDirectories;</span>
<a href="#l44.24"></a><span id="l44.24">   rv = dirSvc-&gt;Get(ISP_DIRECTORY_LIST,</span>
<a href="#l44.25"></a><span id="l44.25">                    NS_GET_IID(nsISimpleEnumerator), getter_AddRefs(ispDirectories));</span>
<a href="#l44.26"></a><span id="l44.26">   if (NS_FAILED(rv))</span>
<a href="#l44.27"></a><span id="l44.27">     return;</span>
<a href="#l44.28"></a><span id="l44.28"> </span>
<a href="#l44.29"></a><span id="l44.29">   bool hasMore;</span>
<a href="#l44.30"></a><span id="l44.30">   nsCOMPtr&lt;nsIFile&gt; ispDirectory;</span>
<a href="#l44.31"></a><span id="l44.31" class="difflineminus">-  while (NS_SUCCEEDED(ispDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) </span>
<a href="#l44.32"></a><span id="l44.32" class="difflineplus">+  while (NS_SUCCEEDED(ispDirectories-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l44.33"></a><span id="l44.33">   {</span>
<a href="#l44.34"></a><span id="l44.34">     nsCOMPtr&lt;nsISupports&gt; elem;</span>
<a href="#l44.35"></a><span id="l44.35">     ispDirectories-&gt;GetNext(getter_AddRefs(elem));</span>
<a href="#l44.36"></a><span id="l44.36"> </span>
<a href="#l44.37"></a><span id="l44.37">     ispDirectory = do_QueryInterface(elem);</span>
<a href="#l44.38"></a><span id="l44.38">     if (ispDirectory)</span>
<a href="#l44.39"></a><span id="l44.39">       LoadISPFilesFromDir(ispDirectory);</span>
<a href="#l44.40"></a><span id="l44.40">   }</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineat">@@ -121,17 +121,17 @@ nsMsgServiceProviderService::LoadDataSou</span>
<a href="#l44.42"></a><span id="l44.42"> </span>
<a href="#l44.43"></a><span id="l44.43">   nsCOMPtr&lt;nsIRDFDataSource&gt; ds =</span>
<a href="#l44.44"></a><span id="l44.44">       do_CreateInstance(kRDFXMLDataSourceCID, &amp;rv);</span>
<a href="#l44.45"></a><span id="l44.45">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l44.46"></a><span id="l44.46"> </span>
<a href="#l44.47"></a><span id="l44.47">   nsCOMPtr&lt;nsIRDFRemoteDataSource&gt; remote =</span>
<a href="#l44.48"></a><span id="l44.48">       do_QueryInterface(ds, &amp;rv);</span>
<a href="#l44.49"></a><span id="l44.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.50"></a><span id="l44.50" class="difflineminus">-  </span>
<a href="#l44.51"></a><span id="l44.51" class="difflineplus">+</span>
<a href="#l44.52"></a><span id="l44.52">   rv = remote-&gt;Init(aURI);</span>
<a href="#l44.53"></a><span id="l44.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l44.54"></a><span id="l44.54">   // for now load synchronously (async seems to be busted)</span>
<a href="#l44.55"></a><span id="l44.55">   rv = remote-&gt;Refresh(true);</span>
<a href="#l44.56"></a><span id="l44.56">   NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed refresh?\n&quot;);</span>
<a href="#l44.57"></a><span id="l44.57"> </span>
<a href="#l44.58"></a><span id="l44.58">   rv = mInnerDataSource-&gt;AddDataSource(ds);</span>
<a href="#l44.59"></a><span id="l44.59"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/base/src/nsMsgServiceProvider.h</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgServiceProvider.h</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -13,20 +13,20 @@</span>
<a href="#l45.4"></a><span id="l45.4"> </span>
<a href="#l45.5"></a><span id="l45.5"> class nsMsgServiceProviderService : public nsIRDFDataSource</span>
<a href="#l45.6"></a><span id="l45.6"> {</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8">  public:</span>
<a href="#l45.9"></a><span id="l45.9">   nsMsgServiceProviderService();</span>
<a href="#l45.10"></a><span id="l45.10"> </span>
<a href="#l45.11"></a><span id="l45.11">   nsresult Init();</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-  </span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+</span>
<a href="#l45.14"></a><span id="l45.14">   NS_DECL_ISUPPORTS</span>
<a href="#l45.15"></a><span id="l45.15">   NS_FORWARD_NSIRDFDATASOURCE(mInnerDataSource-&gt;)</span>
<a href="#l45.16"></a><span id="l45.16" class="difflineminus">-  </span>
<a href="#l45.17"></a><span id="l45.17" class="difflineplus">+</span>
<a href="#l45.18"></a><span id="l45.18">  private:</span>
<a href="#l45.19"></a><span id="l45.19">   virtual ~nsMsgServiceProviderService();</span>
<a href="#l45.20"></a><span id="l45.20"> </span>
<a href="#l45.21"></a><span id="l45.21">   nsCOMPtr&lt;nsIRDFCompositeDataSource&gt; mInnerDataSource;</span>
<a href="#l45.22"></a><span id="l45.22">   nsresult LoadDataSource(const char *aURL);</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24">   void LoadISPFilesFromDir(nsIFile* aDir);</span>
<a href="#l45.25"></a><span id="l45.25">   void LoadISPFiles();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgSpecialViews.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l46.4"></a><span id="l46.4"> #include &quot;msgCore.h&quot;</span>
<a href="#l46.5"></a><span id="l46.5"> #include &quot;nsMsgSpecialViews.h&quot;</span>
<a href="#l46.6"></a><span id="l46.6"> #include &quot;nsIMsgThread.h&quot;</span>
<a href="#l46.7"></a><span id="l46.7"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9"> nsMsgThreadsWithUnreadDBView::nsMsgThreadsWithUnreadDBView()</span>
<a href="#l46.10"></a><span id="l46.10"> : m_totalUnwantedMessagesInView(0)</span>
<a href="#l46.11"></a><span id="l46.11"> {</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-  </span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+</span>
<a href="#l46.14"></a><span id="l46.14"> }</span>
<a href="#l46.15"></a><span id="l46.15"> </span>
<a href="#l46.16"></a><span id="l46.16"> nsMsgThreadsWithUnreadDBView::~nsMsgThreadsWithUnreadDBView()</span>
<a href="#l46.17"></a><span id="l46.17"> {</span>
<a href="#l46.18"></a><span id="l46.18"> }</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> NS_IMETHODIMP nsMsgThreadsWithUnreadDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l46.21"></a><span id="l46.21"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgStatusFeedback.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -50,31 +50,31 @@ NS_IMPL_ISUPPORTS(nsMsgStatusFeedback, n</span>
<a href="#l47.4"></a><span id="l47.4"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.5"></a><span id="l47.5"> // nsMsgStatusFeedback::nsIWebProgressListener</span>
<a href="#l47.6"></a><span id="l47.6"> //////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8"> NS_IMETHODIMP</span>
<a href="#l47.9"></a><span id="l47.9"> nsMsgStatusFeedback::OnProgressChange(nsIWebProgress* aWebProgress,</span>
<a href="#l47.10"></a><span id="l47.10">                                       nsIRequest* aRequest,</span>
<a href="#l47.11"></a><span id="l47.11">                                       int32_t aCurSelfProgress,</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-                                      int32_t aMaxSelfProgress, </span>
<a href="#l47.13"></a><span id="l47.13" class="difflineplus">+                                      int32_t aMaxSelfProgress,</span>
<a href="#l47.14"></a><span id="l47.14">                                       int32_t aCurTotalProgress,</span>
<a href="#l47.15"></a><span id="l47.15">                                       int32_t aMaxTotalProgress)</span>
<a href="#l47.16"></a><span id="l47.16"> {</span>
<a href="#l47.17"></a><span id="l47.17">   int32_t percentage = 0;</span>
<a href="#l47.18"></a><span id="l47.18">   if (aMaxTotalProgress &gt; 0)</span>
<a href="#l47.19"></a><span id="l47.19">   {</span>
<a href="#l47.20"></a><span id="l47.20">     percentage =  (aCurTotalProgress * 100) / aMaxTotalProgress;</span>
<a href="#l47.21"></a><span id="l47.21">     if (percentage)</span>
<a href="#l47.22"></a><span id="l47.22">       ShowProgress(percentage);</span>
<a href="#l47.23"></a><span id="l47.23">   }</span>
<a href="#l47.24"></a><span id="l47.24"> </span>
<a href="#l47.25"></a><span id="l47.25">    return NS_OK;</span>
<a href="#l47.26"></a><span id="l47.26"> }</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-      </span>
<a href="#l47.28"></a><span id="l47.28" class="difflineplus">+</span>
<a href="#l47.29"></a><span id="l47.29"> NS_IMETHODIMP</span>
<a href="#l47.30"></a><span id="l47.30"> nsMsgStatusFeedback::OnStateChange(nsIWebProgress* aWebProgress,</span>
<a href="#l47.31"></a><span id="l47.31">                                    nsIRequest* aRequest,</span>
<a href="#l47.32"></a><span id="l47.32">                                    uint32_t aProgressStateFlags,</span>
<a href="#l47.33"></a><span id="l47.33">                                    nsresult aStatus)</span>
<a href="#l47.34"></a><span id="l47.34"> {</span>
<a href="#l47.35"></a><span id="l47.35">   nsresult rv;</span>
<a href="#l47.36"></a><span id="l47.36"> </span>
<a href="#l47.37"></a><span id="l47.37" class="difflineat">@@ -87,44 +87,44 @@ nsMsgStatusFeedback::OnStateChange(nsIWe</span>
<a href="#l47.38"></a><span id="l47.38">       StartMeteors();</span>
<a href="#l47.39"></a><span id="l47.39">       nsString loadingDocument;</span>
<a href="#l47.40"></a><span id="l47.40">       rv = mBundle-&gt;GetStringFromName(&quot;documentLoading&quot;, loadingDocument);</span>
<a href="#l47.41"></a><span id="l47.41">       if (NS_SUCCEEDED(rv))</span>
<a href="#l47.42"></a><span id="l47.42">         ShowStatusString(loadingDocument);</span>
<a href="#l47.43"></a><span id="l47.43">     }</span>
<a href="#l47.44"></a><span id="l47.44">     else if (aProgressStateFlags &amp; STATE_STOP)</span>
<a href="#l47.45"></a><span id="l47.45">     {</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-      // if we are loading message for display purposes, this STATE_STOP notification is </span>
<a href="#l47.47"></a><span id="l47.47" class="difflineplus">+      // if we are loading message for display purposes, this STATE_STOP notification is</span>
<a href="#l47.48"></a><span id="l47.48">       // the only notification we get when layout is actually done rendering the message. We need</span>
<a href="#l47.49"></a><span id="l47.49">       // to fire the appropriate msgHdrSink notification in this particular case.</span>
<a href="#l47.50"></a><span id="l47.50">       nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(aRequest);</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-      if (channel) </span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+      if (channel)</span>
<a href="#l47.53"></a><span id="l47.53">       {</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineminus">-        nsCOMPtr&lt;nsIURI&gt; uri; </span>
<a href="#l47.55"></a><span id="l47.55" class="difflineplus">+        nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l47.56"></a><span id="l47.56">         channel-&gt;GetURI(getter_AddRefs(uri));</span>
<a href="#l47.57"></a><span id="l47.57">         nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl (do_QueryInterface(uri));</span>
<a href="#l47.58"></a><span id="l47.58">         if (mailnewsUrl)</span>
<a href="#l47.59"></a><span id="l47.59">         {</span>
<a href="#l47.60"></a><span id="l47.60">           // get the url type</span>
<a href="#l47.61"></a><span id="l47.61">           bool messageDisplayUrl;</span>
<a href="#l47.62"></a><span id="l47.62">           mailnewsUrl-&gt;IsUrlType(nsIMsgMailNewsUrl::eDisplay, &amp;messageDisplayUrl);</span>
<a href="#l47.63"></a><span id="l47.63"> </span>
<a href="#l47.64"></a><span id="l47.64">           if (messageDisplayUrl)</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineminus">-          {              </span>
<a href="#l47.66"></a><span id="l47.66" class="difflineplus">+          {</span>
<a href="#l47.67"></a><span id="l47.67">             // get the header sink</span>
<a href="#l47.68"></a><span id="l47.68">             nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l47.69"></a><span id="l47.69">             mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l47.70"></a><span id="l47.70">             if (msgWindow)</span>
<a href="#l47.71"></a><span id="l47.71">             {</span>
<a href="#l47.72"></a><span id="l47.72">               nsCOMPtr&lt;nsIMsgHeaderSink&gt; hdrSink;</span>
<a href="#l47.73"></a><span id="l47.73">               msgWindow-&gt;GetMsgHeaderSink(getter_AddRefs(hdrSink));</span>
<a href="#l47.74"></a><span id="l47.74">               if (hdrSink)</span>
<a href="#l47.75"></a><span id="l47.75">                 hdrSink-&gt;OnEndMsgDownload(mailnewsUrl);</span>
<a href="#l47.76"></a><span id="l47.76">             }</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-            // get the folder and notify that the msg has been loaded. We're </span>
<a href="#l47.78"></a><span id="l47.78" class="difflineplus">+            // get the folder and notify that the msg has been loaded. We're</span>
<a href="#l47.79"></a><span id="l47.79">             // using NotifyPropertyFlagChanged. To be completely consistent,</span>
<a href="#l47.80"></a><span id="l47.80">             // we'd send a similar notification that the old message was</span>
<a href="#l47.81"></a><span id="l47.81">             // unloaded.</span>
<a href="#l47.82"></a><span id="l47.82">             nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l47.83"></a><span id="l47.83">             nsCOMPtr &lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l47.84"></a><span id="l47.84">             mailnewsUrl-&gt;GetFolder(getter_AddRefs(msgFolder));</span>
<a href="#l47.85"></a><span id="l47.85">             nsCOMPtr &lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(mailnewsUrl);</span>
<a href="#l47.86"></a><span id="l47.86">             if (msgUrl)</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineat">@@ -150,29 +150,29 @@ nsMsgStatusFeedback::OnStateChange(nsIWe</span>
<a href="#l47.88"></a><span id="l47.88"> NS_IMETHODIMP nsMsgStatusFeedback::OnLocationChange(nsIWebProgress* aWebProgress,</span>
<a href="#l47.89"></a><span id="l47.89">                                                     nsIRequest* aRequest,</span>
<a href="#l47.90"></a><span id="l47.90">                                                     nsIURI* aLocation,</span>
<a href="#l47.91"></a><span id="l47.91">                                                     uint32_t aFlags)</span>
<a href="#l47.92"></a><span id="l47.92"> {</span>
<a href="#l47.93"></a><span id="l47.93">    return NS_OK;</span>
<a href="#l47.94"></a><span id="l47.94"> }</span>
<a href="#l47.95"></a><span id="l47.95"> </span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l47.97"></a><span id="l47.97" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l47.98"></a><span id="l47.98"> nsMsgStatusFeedback::OnStatusChange(nsIWebProgress* aWebProgress,</span>
<a href="#l47.99"></a><span id="l47.99">                                     nsIRequest* aRequest,</span>
<a href="#l47.100"></a><span id="l47.100">                                     nsresult aStatus,</span>
<a href="#l47.101"></a><span id="l47.101">                                     const char16_t* aMessage)</span>
<a href="#l47.102"></a><span id="l47.102"> {</span>
<a href="#l47.103"></a><span id="l47.103">     return NS_OK;</span>
<a href="#l47.104"></a><span id="l47.104"> }</span>
<a href="#l47.105"></a><span id="l47.105"> </span>
<a href="#l47.106"></a><span id="l47.106"> </span>
<a href="#l47.107"></a><span id="l47.107" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l47.108"></a><span id="l47.108" class="difflineminus">-nsMsgStatusFeedback::OnSecurityChange(nsIWebProgress *aWebProgress, </span>
<a href="#l47.109"></a><span id="l47.109" class="difflineminus">-                                    nsIRequest *aRequest, </span>
<a href="#l47.110"></a><span id="l47.110" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineplus">+nsMsgStatusFeedback::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineplus">+                                    nsIRequest *aRequest,</span>
<a href="#l47.113"></a><span id="l47.113">                                     uint32_t state)</span>
<a href="#l47.114"></a><span id="l47.114"> {</span>
<a href="#l47.115"></a><span id="l47.115">     return NS_OK;</span>
<a href="#l47.116"></a><span id="l47.116"> }</span>
<a href="#l47.117"></a><span id="l47.117"> </span>
<a href="#l47.118"></a><span id="l47.118"> </span>
<a href="#l47.119"></a><span id="l47.119"> NS_IMETHODIMP</span>
<a href="#l47.120"></a><span id="l47.120"> nsMsgStatusFeedback::ShowStatusString(const nsAString&amp; aStatus)</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineat">@@ -194,17 +194,17 @@ nsMsgStatusFeedback::SetStatusString(con</span>
<a href="#l47.122"></a><span id="l47.122"> </span>
<a href="#l47.123"></a><span id="l47.123"> NS_IMETHODIMP</span>
<a href="#l47.124"></a><span id="l47.124"> nsMsgStatusFeedback::ShowProgress(int32_t aPercentage)</span>
<a href="#l47.125"></a><span id="l47.125"> {</span>
<a href="#l47.126"></a><span id="l47.126">   // if the percentage hasn't changed...OR if we are going from 0 to 100% in one step</span>
<a href="#l47.127"></a><span id="l47.127">   // then don't bother....just fall out....</span>
<a href="#l47.128"></a><span id="l47.128">   if (aPercentage == m_lastPercent || (m_lastPercent == 0 &amp;&amp; aPercentage &gt;= 100))</span>
<a href="#l47.129"></a><span id="l47.129">     return NS_OK;</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineminus">-  </span>
<a href="#l47.131"></a><span id="l47.131" class="difflineplus">+</span>
<a href="#l47.132"></a><span id="l47.132">   m_lastPercent = aPercentage;</span>
<a href="#l47.133"></a><span id="l47.133"> </span>
<a href="#l47.134"></a><span id="l47.134">   int64_t nowMS = 0;</span>
<a href="#l47.135"></a><span id="l47.135">   if (aPercentage &lt; 100)	// always need to do 100%</span>
<a href="#l47.136"></a><span id="l47.136">   {</span>
<a href="#l47.137"></a><span id="l47.137">     nowMS = PR_IntervalToMilliseconds(PR_IntervalNow());</span>
<a href="#l47.138"></a><span id="l47.138">     if (nowMS &lt; m_lastProgressTime + 250)</span>
<a href="#l47.139"></a><span id="l47.139">       return NS_OK;</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineat">@@ -237,26 +237,26 @@ nsMsgStatusFeedback::StopMeteors()</span>
<a href="#l47.141"></a><span id="l47.141"> </span>
<a href="#l47.142"></a><span id="l47.142"> NS_IMETHODIMP nsMsgStatusFeedback::SetWrappedStatusFeedback(nsIMsgStatusFeedback * aJSStatusFeedback)</span>
<a href="#l47.143"></a><span id="l47.143"> {</span>
<a href="#l47.144"></a><span id="l47.144">   NS_ENSURE_ARG_POINTER(aJSStatusFeedback);</span>
<a href="#l47.145"></a><span id="l47.145">   mJSStatusFeedbackWeak = do_GetWeakReference(aJSStatusFeedback);</span>
<a href="#l47.146"></a><span id="l47.146">   return NS_OK;</span>
<a href="#l47.147"></a><span id="l47.147"> }</span>
<a href="#l47.148"></a><span id="l47.148"> </span>
<a href="#l47.149"></a><span id="l47.149" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::OnProgress(nsIRequest *request, nsISupports* ctxt, </span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::OnProgress(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l47.151"></a><span id="l47.151">                                               int64_t aProgress, int64_t aProgressMax)</span>
<a href="#l47.152"></a><span id="l47.152"> {</span>
<a href="#l47.153"></a><span id="l47.153">   // XXX: What should the nsIWebProgress be?</span>
<a href="#l47.154"></a><span id="l47.154">   // XXX: this truncates 64-bit to 32-bit</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineminus">-  return OnProgressChange(nullptr, request, int32_t(aProgress), int32_t(aProgressMax), </span>
<a href="#l47.156"></a><span id="l47.156" class="difflineplus">+  return OnProgressChange(nullptr, request, int32_t(aProgress), int32_t(aProgressMax),</span>
<a href="#l47.157"></a><span id="l47.157">                           int32_t(aProgress) /* current total progress */, int32_t(aProgressMax) /* max total progress */);</span>
<a href="#l47.158"></a><span id="l47.158"> }</span>
<a href="#l47.159"></a><span id="l47.159"> </span>
<a href="#l47.160"></a><span id="l47.160" class="difflineminus">-NS_IMETHODIMP nsMsgStatusFeedback::OnStatus(nsIRequest *request, nsISupports* ctxt, </span>
<a href="#l47.161"></a><span id="l47.161" class="difflineplus">+NS_IMETHODIMP nsMsgStatusFeedback::OnStatus(nsIRequest *request, nsISupports* ctxt,</span>
<a href="#l47.162"></a><span id="l47.162">                                             nsresult aStatus, const char16_t* aStatusArg)</span>
<a href="#l47.163"></a><span id="l47.163"> {</span>
<a href="#l47.164"></a><span id="l47.164">   nsresult rv;</span>
<a href="#l47.165"></a><span id="l47.165">   nsCOMPtr&lt;nsIURI&gt; uri;</span>
<a href="#l47.166"></a><span id="l47.166">   nsString accountName;</span>
<a href="#l47.167"></a><span id="l47.167">   // fetching account name from nsIRequest</span>
<a href="#l47.168"></a><span id="l47.168">   nsCOMPtr&lt;nsIChannel&gt; aChannel = do_QueryInterface(request);</span>
<a href="#l47.169"></a><span id="l47.169">   rv = aChannel-&gt;GetURI(getter_AddRefs(uri));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgTagService.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -489,17 +489,17 @@ nsresult nsMsgTagService::MigrateLabelsT</span>
<a href="#l48.4"></a><span id="l48.4">       tag-&gt;GetColor(color);</span>
<a href="#l48.5"></a><span id="l48.5">       DeleteKey(key);</span>
<a href="#l48.6"></a><span id="l48.6">       ToLowerCase(key);</span>
<a href="#l48.7"></a><span id="l48.7">       AddTagForKey(key, tagStr, color, ordinal);</span>
<a href="#l48.8"></a><span id="l48.8">     }</span>
<a href="#l48.9"></a><span id="l48.9">     NS_FREE_XPCOM_ISUPPORTS_POINTER_ARRAY(numTags, tagArray);</span>
<a href="#l48.10"></a><span id="l48.10">     gMigratingKeys = false;</span>
<a href="#l48.11"></a><span id="l48.11">   }</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-  else </span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+  else</span>
<a href="#l48.14"></a><span id="l48.14">   {</span>
<a href="#l48.15"></a><span id="l48.15">     nsCOMPtr&lt;nsIPrefBranch&gt; prefRoot(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l48.16"></a><span id="l48.16">     nsCOMPtr&lt;nsIPrefLocalizedString&gt; pls;</span>
<a href="#l48.17"></a><span id="l48.17">     nsString ucsval;</span>
<a href="#l48.18"></a><span id="l48.18">     nsAutoCString labelKey(&quot;$label1&quot;);</span>
<a href="#l48.19"></a><span id="l48.19">     for(int32_t i = 0; i &lt; PREF_LABELS_MAX; )</span>
<a href="#l48.20"></a><span id="l48.20">     {</span>
<a href="#l48.21"></a><span id="l48.21">       prefString.Assign(PREF_LABELS_DESCRIPTION);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgThreadedDBView.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -37,32 +37,32 @@ NS_IMETHODIMP nsMsgThreadedDBView::Open(</span>
<a href="#l49.4"></a><span id="l49.4">   int32_t totalMessages, unreadMessages;</span>
<a href="#l49.5"></a><span id="l49.5">   nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l49.6"></a><span id="l49.6">   PersistFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l49.7"></a><span id="l49.7">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.8"></a><span id="l49.8">   // save off sort type and order, view type and flags</span>
<a href="#l49.9"></a><span id="l49.9">   dbFolderInfo-&gt;GetNumUnreadMessages(&amp;unreadMessages);</span>
<a href="#l49.10"></a><span id="l49.10">   dbFolderInfo-&gt;GetNumMessages(&amp;totalMessages);</span>
<a href="#l49.11"></a><span id="l49.11">   if (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly)</span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  { </span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+  {</span>
<a href="#l49.14"></a><span id="l49.14">     // Set unread msg size + extra entries to avoid reallocation on new mail.</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-    totalMessages = (uint32_t)unreadMessages+MSGHDR_CACHE_LOOK_AHEAD_SIZE;  </span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+    totalMessages = (uint32_t)unreadMessages+MSGHDR_CACHE_LOOK_AHEAD_SIZE;</span>
<a href="#l49.17"></a><span id="l49.17">   }</span>
<a href="#l49.18"></a><span id="l49.18">   else</span>
<a href="#l49.19"></a><span id="l49.19">   {</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-    if (totalMessages &gt; MSGHDR_CACHE_MAX_SIZE) </span>
<a href="#l49.21"></a><span id="l49.21" class="difflineplus">+    if (totalMessages &gt; MSGHDR_CACHE_MAX_SIZE)</span>
<a href="#l49.22"></a><span id="l49.22">       totalMessages = MSGHDR_CACHE_MAX_SIZE;        // use max default</span>
<a href="#l49.23"></a><span id="l49.23">     else if (totalMessages &gt; 0)</span>
<a href="#l49.24"></a><span id="l49.24">       totalMessages += MSGHDR_CACHE_LOOK_AHEAD_SIZE;// allocate extra entries to avoid reallocation on new mail.</span>
<a href="#l49.25"></a><span id="l49.25">   }</span>
<a href="#l49.26"></a><span id="l49.26">   // if total messages is 0, then we probably don't have any idea how many headers are in the db</span>
<a href="#l49.27"></a><span id="l49.27">   // so we have no business setting the cache size.</span>
<a href="#l49.28"></a><span id="l49.28">   if (totalMessages &gt; 0)</span>
<a href="#l49.29"></a><span id="l49.29">     m_db-&gt;SetMsgHdrCacheSize((uint32_t)totalMessages);</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineminus">-  </span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+</span>
<a href="#l49.32"></a><span id="l49.32">   if (pCount)</span>
<a href="#l49.33"></a><span id="l49.33">     *pCount = 0;</span>
<a href="#l49.34"></a><span id="l49.34">   rv = InitThreadedView(pCount);</span>
<a href="#l49.35"></a><span id="l49.35"> </span>
<a href="#l49.36"></a><span id="l49.36">   // this is a hack, but we're trying to find a way to correct</span>
<a href="#l49.37"></a><span id="l49.37">   // incorrect total and unread msg counts w/o paying a big</span>
<a href="#l49.38"></a><span id="l49.38">   // performance penalty. So, if we're not threaded, just add</span>
<a href="#l49.39"></a><span id="l49.39">   // up the total and unread messages in the view and see if that</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineat">@@ -89,47 +89,47 @@ NS_IMETHODIMP nsMsgThreadedDBView::Open(</span>
<a href="#l49.41"></a><span id="l49.41"> NS_IMETHODIMP nsMsgThreadedDBView::Close()</span>
<a href="#l49.42"></a><span id="l49.42"> {</span>
<a href="#l49.43"></a><span id="l49.43">   return nsMsgDBView::Close();</span>
<a href="#l49.44"></a><span id="l49.44"> }</span>
<a href="#l49.45"></a><span id="l49.45"> </span>
<a href="#l49.46"></a><span id="l49.46"> nsresult nsMsgThreadedDBView::InitThreadedView(int32_t *pCount)</span>
<a href="#l49.47"></a><span id="l49.47"> {</span>
<a href="#l49.48"></a><span id="l49.48">   nsresult rv;</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-  </span>
<a href="#l49.50"></a><span id="l49.50" class="difflineplus">+</span>
<a href="#l49.51"></a><span id="l49.51">   m_keys.Clear();</span>
<a href="#l49.52"></a><span id="l49.52">   m_flags.Clear();</span>
<a href="#l49.53"></a><span id="l49.53" class="difflineminus">-  m_levels.Clear(); </span>
<a href="#l49.54"></a><span id="l49.54" class="difflineplus">+  m_levels.Clear();</span>
<a href="#l49.55"></a><span id="l49.55">   m_prevKeys.Clear();</span>
<a href="#l49.56"></a><span id="l49.56">   m_prevFlags.Clear();</span>
<a href="#l49.57"></a><span id="l49.57">   m_prevLevels.Clear();</span>
<a href="#l49.58"></a><span id="l49.58">   m_havePrevView = false;</span>
<a href="#l49.59"></a><span id="l49.59">   nsresult getSortrv = NS_OK; // ### TODO m_db-&gt;GetSortInfo(&amp;sortType, &amp;sortOrder);</span>
<a href="#l49.60"></a><span id="l49.60" class="difflineminus">-  </span>
<a href="#l49.61"></a><span id="l49.61" class="difflineplus">+</span>
<a href="#l49.62"></a><span id="l49.62">   // list all the ids into m_keys.</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-  nsMsgKey startMsg = 0; </span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+  nsMsgKey startMsg = 0;</span>
<a href="#l49.65"></a><span id="l49.65">   do</span>
<a href="#l49.66"></a><span id="l49.66">   {</span>
<a href="#l49.67"></a><span id="l49.67">     const int32_t kIdChunkSize = 400;</span>
<a href="#l49.68"></a><span id="l49.68">     int32_t  numListed = 0;</span>
<a href="#l49.69"></a><span id="l49.69">     nsMsgKey idArray[kIdChunkSize];</span>
<a href="#l49.70"></a><span id="l49.70">     int32_t  flagArray[kIdChunkSize];</span>
<a href="#l49.71"></a><span id="l49.71">     char     levelArray[kIdChunkSize];</span>
<a href="#l49.72"></a><span id="l49.72"> </span>
<a href="#l49.73"></a><span id="l49.73" class="difflineminus">-    rv = ListThreadIds(&amp;startMsg, (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) != 0, idArray, flagArray, </span>
<a href="#l49.74"></a><span id="l49.74" class="difflineplus">+    rv = ListThreadIds(&amp;startMsg, (m_viewFlags &amp; nsMsgViewFlagsType::kUnreadOnly) != 0, idArray, flagArray,</span>
<a href="#l49.75"></a><span id="l49.75">       levelArray, kIdChunkSize, &amp;numListed, nullptr);</span>
<a href="#l49.76"></a><span id="l49.76">     if (NS_SUCCEEDED(rv))</span>
<a href="#l49.77"></a><span id="l49.77">     {</span>
<a href="#l49.78"></a><span id="l49.78">       int32_t numAdded = AddKeys(idArray, flagArray, levelArray, m_sortType, numListed);</span>
<a href="#l49.79"></a><span id="l49.79">       if (pCount)</span>
<a href="#l49.80"></a><span id="l49.80">         *pCount += numAdded;</span>
<a href="#l49.81"></a><span id="l49.81">     }</span>
<a href="#l49.82"></a><span id="l49.82" class="difflineminus">-    </span>
<a href="#l49.83"></a><span id="l49.83" class="difflineplus">+</span>
<a href="#l49.84"></a><span id="l49.84">   } while (NS_SUCCEEDED(rv) &amp;&amp; startMsg != nsMsgKey_None);</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineminus">-  </span>
<a href="#l49.86"></a><span id="l49.86" class="difflineplus">+</span>
<a href="#l49.87"></a><span id="l49.87">   if (NS_SUCCEEDED(getSortrv))</span>
<a href="#l49.88"></a><span id="l49.88">   {</span>
<a href="#l49.89"></a><span id="l49.89">     rv = InitSort(m_sortType, m_sortOrder);</span>
<a href="#l49.90"></a><span id="l49.90">     SaveSortInfo(m_sortType, m_sortOrder);</span>
<a href="#l49.91"></a><span id="l49.91"> </span>
<a href="#l49.92"></a><span id="l49.92">   }</span>
<a href="#l49.93"></a><span id="l49.93">   return rv;</span>
<a href="#l49.94"></a><span id="l49.94"> }</span>
<a href="#l49.95"></a><span id="l49.95" class="difflineat">@@ -210,34 +210,34 @@ int32_t nsMsgThreadedDBView::AddKeys(nsM</span>
<a href="#l49.96"></a><span id="l49.96">   // Allocate enough space first to avoid memory allocation/deallocation.</span>
<a href="#l49.97"></a><span id="l49.97">   m_keys.SetCapacity(m_keys.Length() + numKeysToAdd);</span>
<a href="#l49.98"></a><span id="l49.98">   m_flags.SetCapacity(m_flags.Length() + numKeysToAdd);</span>
<a href="#l49.99"></a><span id="l49.99">   m_levels.SetCapacity(m_levels.Length() + numKeysToAdd);</span>
<a href="#l49.100"></a><span id="l49.100">   for (int32_t i = 0; i &lt; numKeysToAdd; i++)</span>
<a href="#l49.101"></a><span id="l49.101">   {</span>
<a href="#l49.102"></a><span id="l49.102">     int32_t threadFlag = pFlags[i];</span>
<a href="#l49.103"></a><span id="l49.103">     int32_t flag = threadFlag;</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineminus">-    </span>
<a href="#l49.105"></a><span id="l49.105" class="difflineplus">+</span>
<a href="#l49.106"></a><span id="l49.106">     // skip ignored threads.</span>
<a href="#l49.107"></a><span id="l49.107">     if ((threadFlag &amp; nsMsgMessageFlags::Ignored) &amp;&amp; !(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l49.108"></a><span id="l49.108">       continue;</span>
<a href="#l49.109"></a><span id="l49.109" class="difflineminus">-    </span>
<a href="#l49.110"></a><span id="l49.110" class="difflineplus">+</span>
<a href="#l49.111"></a><span id="l49.111">     // skip ignored subthreads</span>
<a href="#l49.112"></a><span id="l49.112">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l49.113"></a><span id="l49.113">     m_db-&gt;GetMsgHdrForKey(pKeys[i], getter_AddRefs(msgHdr));</span>
<a href="#l49.114"></a><span id="l49.114">     if (!(m_viewFlags &amp; nsMsgViewFlagsType::kShowIgnored))</span>
<a href="#l49.115"></a><span id="l49.115">     {</span>
<a href="#l49.116"></a><span id="l49.116">       bool killed;</span>
<a href="#l49.117"></a><span id="l49.117">       msgHdr-&gt;GetIsKilled(&amp;killed);</span>
<a href="#l49.118"></a><span id="l49.118">       if (killed)</span>
<a href="#l49.119"></a><span id="l49.119">         continue;</span>
<a href="#l49.120"></a><span id="l49.120">     }</span>
<a href="#l49.121"></a><span id="l49.121"> </span>
<a href="#l49.122"></a><span id="l49.122">     // by default, make threads collapsed, unless we're in only viewing new msgs</span>
<a href="#l49.123"></a><span id="l49.123" class="difflineminus">-    </span>
<a href="#l49.124"></a><span id="l49.124" class="difflineplus">+</span>
<a href="#l49.125"></a><span id="l49.125">     if (flag &amp; MSG_VIEW_FLAG_HASCHILDREN)</span>
<a href="#l49.126"></a><span id="l49.126">       flag |= nsMsgMessageFlags::Elided;</span>
<a href="#l49.127"></a><span id="l49.127">     // should this be persistent? Doesn't seem to need to be.</span>
<a href="#l49.128"></a><span id="l49.128">     flag |= MSG_VIEW_FLAG_ISTHREAD;</span>
<a href="#l49.129"></a><span id="l49.129">     m_keys.AppendElement(pKeys[i]);</span>
<a href="#l49.130"></a><span id="l49.130">     m_flags.AppendElement(flag);</span>
<a href="#l49.131"></a><span id="l49.131">     m_levels.AppendElement(pLevels[i]);</span>
<a href="#l49.132"></a><span id="l49.132">     numAdded++;</span>
<a href="#l49.133"></a><span id="l49.133" class="difflineat">@@ -250,96 +250,96 @@ int32_t nsMsgThreadedDBView::AddKeys(nsM</span>
<a href="#l49.134"></a><span id="l49.134"> }</span>
<a href="#l49.135"></a><span id="l49.135"> </span>
<a href="#l49.136"></a><span id="l49.136"> NS_IMETHODIMP nsMsgThreadedDBView::Sort(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder)</span>
<a href="#l49.137"></a><span id="l49.137"> {</span>
<a href="#l49.138"></a><span id="l49.138">   nsresult rv;</span>
<a href="#l49.139"></a><span id="l49.139"> </span>
<a href="#l49.140"></a><span id="l49.140">   int32_t rowCountBeforeSort = GetSize();</span>
<a href="#l49.141"></a><span id="l49.141"> </span>
<a href="#l49.142"></a><span id="l49.142" class="difflineminus">-  if (!rowCountBeforeSort) </span>
<a href="#l49.143"></a><span id="l49.143" class="difflineplus">+  if (!rowCountBeforeSort)</span>
<a href="#l49.144"></a><span id="l49.144">   {</span>
<a href="#l49.145"></a><span id="l49.145">     // still need to setup our flags even when no articles - bug 98183.</span>
<a href="#l49.146"></a><span id="l49.146">     m_sortType = sortType;</span>
<a href="#l49.147"></a><span id="l49.147">     if (sortType == nsMsgViewSortType::byThread &amp;&amp; ! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l49.148"></a><span id="l49.148">       SetViewFlags(m_viewFlags | nsMsgViewFlagsType::kThreadedDisplay);</span>
<a href="#l49.149"></a><span id="l49.149">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l49.150"></a><span id="l49.150">     return NS_OK;</span>
<a href="#l49.151"></a><span id="l49.151">   }</span>
<a href="#l49.152"></a><span id="l49.152"> </span>
<a href="#l49.153"></a><span id="l49.153">   if (!m_checkedCustomColumns &amp;&amp; CustomColumnsInSortAndNotRegistered())</span>
<a href="#l49.154"></a><span id="l49.154">     return NS_OK;</span>
<a href="#l49.155"></a><span id="l49.155"> </span>
<a href="#l49.156"></a><span id="l49.156">   // sort threads by sort order</span>
<a href="#l49.157"></a><span id="l49.157">   bool sortThreads = m_viewFlags &amp; (nsMsgViewFlagsType::kThreadedDisplay | nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l49.158"></a><span id="l49.158" class="difflineminus">-  </span>
<a href="#l49.159"></a><span id="l49.159" class="difflineplus">+</span>
<a href="#l49.160"></a><span id="l49.160">   // if sort type is by thread, and we're already threaded, change sort type to byId</span>
<a href="#l49.161"></a><span id="l49.161">   if (sortType == nsMsgViewSortType::byThread &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay) != 0)</span>
<a href="#l49.162"></a><span id="l49.162">     sortType = nsMsgViewSortType::byId;</span>
<a href="#l49.163"></a><span id="l49.163"> </span>
<a href="#l49.164"></a><span id="l49.164">   nsMsgKey preservedKey;</span>
<a href="#l49.165"></a><span id="l49.165">   AutoTArray&lt;nsMsgKey, 1&gt; preservedSelection;</span>
<a href="#l49.166"></a><span id="l49.166">   SaveAndClearSelection(&amp;preservedKey, preservedSelection);</span>
<a href="#l49.167"></a><span id="l49.167">   // if the client wants us to forget our cached id arrays, they</span>
<a href="#l49.168"></a><span id="l49.168">   // should build a new view. If this isn't good enough, we</span>
<a href="#l49.169"></a><span id="l49.169">   // need a method to do that.</span>
<a href="#l49.170"></a><span id="l49.170">   if (sortType != m_sortType || !m_sortValid || sortThreads)</span>
<a href="#l49.171"></a><span id="l49.171">   {</span>
<a href="#l49.172"></a><span id="l49.172">     SaveSortInfo(sortType, sortOrder);</span>
<a href="#l49.173"></a><span id="l49.173" class="difflineminus">-    if (sortType == nsMsgViewSortType::byThread)  </span>
<a href="#l49.174"></a><span id="l49.174" class="difflineplus">+    if (sortType == nsMsgViewSortType::byThread)</span>
<a href="#l49.175"></a><span id="l49.175">     {</span>
<a href="#l49.176"></a><span id="l49.176">       m_sortType = sortType;</span>
<a href="#l49.177"></a><span id="l49.177">       m_viewFlags |= nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l49.178"></a><span id="l49.178">       m_viewFlags &amp;= ~nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l49.179"></a><span id="l49.179">       if ( m_havePrevView)</span>
<a href="#l49.180"></a><span id="l49.180">       {</span>
<a href="#l49.181"></a><span id="l49.181">         // restore saved id array and flags array</span>
<a href="#l49.182"></a><span id="l49.182">         m_keys = m_prevKeys;</span>
<a href="#l49.183"></a><span id="l49.183">         m_flags = m_prevFlags;</span>
<a href="#l49.184"></a><span id="l49.184">         m_levels = m_prevLevels;</span>
<a href="#l49.185"></a><span id="l49.185">         m_sortValid = true;</span>
<a href="#l49.186"></a><span id="l49.186" class="difflineminus">-        </span>
<a href="#l49.187"></a><span id="l49.187" class="difflineplus">+</span>
<a href="#l49.188"></a><span id="l49.188">         // the sort may have changed the number of rows</span>
<a href="#l49.189"></a><span id="l49.189">         // before we restore the selection, tell the tree</span>
<a href="#l49.190"></a><span id="l49.190">         // do this before we call restore selection</span>
<a href="#l49.191"></a><span id="l49.191">         // this is safe when there is no selection.</span>
<a href="#l49.192"></a><span id="l49.192">         rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l49.193"></a><span id="l49.193" class="difflineminus">-        </span>
<a href="#l49.194"></a><span id="l49.194" class="difflineplus">+</span>
<a href="#l49.195"></a><span id="l49.195">         RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l49.196"></a><span id="l49.196">         if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l49.197"></a><span id="l49.197">         return NS_OK;</span>
<a href="#l49.198"></a><span id="l49.198">       }</span>
<a href="#l49.199"></a><span id="l49.199">       else</span>
<a href="#l49.200"></a><span id="l49.200">       {</span>
<a href="#l49.201"></a><span id="l49.201">         // set sort info in anticipation of what Init will do.</span>
<a href="#l49.202"></a><span id="l49.202">         InitThreadedView(nullptr);	// build up thread list.</span>
<a href="#l49.203"></a><span id="l49.203">         if (sortOrder != nsMsgViewSortOrder::ascending)</span>
<a href="#l49.204"></a><span id="l49.204">           Sort(sortType, sortOrder);</span>
<a href="#l49.205"></a><span id="l49.205" class="difflineminus">-        </span>
<a href="#l49.206"></a><span id="l49.206" class="difflineplus">+</span>
<a href="#l49.207"></a><span id="l49.207">         // the sort may have changed the number of rows</span>
<a href="#l49.208"></a><span id="l49.208">         // before we update the selection, tell the tree</span>
<a href="#l49.209"></a><span id="l49.209">         // do this before we call restore selection</span>
<a href="#l49.210"></a><span id="l49.210">         // this is safe when there is no selection.</span>
<a href="#l49.211"></a><span id="l49.211">         rv = AdjustRowCount(rowCountBeforeSort, GetSize());</span>
<a href="#l49.212"></a><span id="l49.212" class="difflineminus">-        </span>
<a href="#l49.213"></a><span id="l49.213" class="difflineplus">+</span>
<a href="#l49.214"></a><span id="l49.214">         RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l49.215"></a><span id="l49.215">         if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l49.216"></a><span id="l49.216">         return NS_OK;</span>
<a href="#l49.217"></a><span id="l49.217">       }</span>
<a href="#l49.218"></a><span id="l49.218">     }</span>
<a href="#l49.219"></a><span id="l49.219">     else if (sortType  != nsMsgViewSortType::byThread &amp;&amp; (m_sortType == nsMsgViewSortType::byThread  || sortThreads)/* &amp;&amp; !m_havePrevView*/)</span>
<a href="#l49.220"></a><span id="l49.220">     {</span>
<a href="#l49.221"></a><span id="l49.221">       if (sortThreads)</span>
<a href="#l49.222"></a><span id="l49.222">       {</span>
<a href="#l49.223"></a><span id="l49.223">         SortThreads(sortType, sortOrder);</span>
<a href="#l49.224"></a><span id="l49.224">         sortType = nsMsgViewSortType::byThread; // hack so base class won't do anything</span>
<a href="#l49.225"></a><span id="l49.225">       }</span>
<a href="#l49.226"></a><span id="l49.226">       else</span>
<a href="#l49.227"></a><span id="l49.227">       {</span>
<a href="#l49.228"></a><span id="l49.228" class="difflineminus">-        // going from SortByThread to non-thread sort - must build new key, level,and flags arrays </span>
<a href="#l49.229"></a><span id="l49.229" class="difflineplus">+        // going from SortByThread to non-thread sort - must build new key, level,and flags arrays</span>
<a href="#l49.230"></a><span id="l49.230">         m_prevKeys = m_keys;</span>
<a href="#l49.231"></a><span id="l49.231">         m_prevFlags = m_flags;</span>
<a href="#l49.232"></a><span id="l49.232">         m_prevLevels = m_levels;</span>
<a href="#l49.233"></a><span id="l49.233">         // do this before we sort, so that we'll use the cheap method</span>
<a href="#l49.234"></a><span id="l49.234">         // of expanding.</span>
<a href="#l49.235"></a><span id="l49.235">         m_viewFlags &amp;= ~(nsMsgViewFlagsType::kThreadedDisplay | nsMsgViewFlagsType::kGroupBySort);</span>
<a href="#l49.236"></a><span id="l49.236">         ExpandAll();</span>
<a href="#l49.237"></a><span id="l49.237">         //			m_idArray.RemoveAll();</span>
<a href="#l49.238"></a><span id="l49.238" class="difflineat">@@ -367,38 +367,38 @@ NS_IMETHODIMP nsMsgThreadedDBView::Sort(</span>
<a href="#l49.239"></a><span id="l49.239">   RestoreSelection(preservedKey, preservedSelection);</span>
<a href="#l49.240"></a><span id="l49.240">   if (mTree) mTree-&gt;Invalidate();</span>
<a href="#l49.241"></a><span id="l49.241">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l49.242"></a><span id="l49.242">   return NS_OK;</span>
<a href="#l49.243"></a><span id="l49.243"> }</span>
<a href="#l49.244"></a><span id="l49.244"> </span>
<a href="#l49.245"></a><span id="l49.245"> // list the ids of the top-level thread ids starting at id == startMsg. This actually returns</span>
<a href="#l49.246"></a><span id="l49.246"> // the ids of the first message in each thread.</span>
<a href="#l49.247"></a><span id="l49.247" class="difflineminus">-nsresult nsMsgThreadedDBView::ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput, int32_t *pFlags, char *pLevels, </span>
<a href="#l49.248"></a><span id="l49.248" class="difflineplus">+nsresult nsMsgThreadedDBView::ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput, int32_t *pFlags, char *pLevels,</span>
<a href="#l49.249"></a><span id="l49.249"> 									 int32_t numToList, int32_t *pNumListed, int32_t *pTotalHeaders)</span>
<a href="#l49.250"></a><span id="l49.250"> {</span>
<a href="#l49.251"></a><span id="l49.251">   nsresult rv = NS_OK;</span>
<a href="#l49.252"></a><span id="l49.252">   // N.B..don't ret before assigning numListed to *pNumListed</span>
<a href="#l49.253"></a><span id="l49.253">   int32_t	numListed = 0;</span>
<a href="#l49.254"></a><span id="l49.254" class="difflineminus">-  </span>
<a href="#l49.255"></a><span id="l49.255" class="difflineplus">+</span>
<a href="#l49.256"></a><span id="l49.256">   if (*startMsg &gt; 0)</span>
<a href="#l49.257"></a><span id="l49.257">   {</span>
<a href="#l49.258"></a><span id="l49.258">     NS_ASSERTION(m_threadEnumerator != nullptr, &quot;where's our iterator?&quot;);	// for now, we'll just have to rely on the caller leaving</span>
<a href="#l49.259"></a><span id="l49.259">     // the iterator in the right place.</span>
<a href="#l49.260"></a><span id="l49.260">   }</span>
<a href="#l49.261"></a><span id="l49.261">   else</span>
<a href="#l49.262"></a><span id="l49.262">   {</span>
<a href="#l49.263"></a><span id="l49.263">     NS_ASSERTION(m_db, &quot;no db&quot;);</span>
<a href="#l49.264"></a><span id="l49.264">     if (!m_db) return NS_ERROR_UNEXPECTED;</span>
<a href="#l49.265"></a><span id="l49.265">     rv = m_db-&gt;EnumerateThreads(getter_AddRefs(m_threadEnumerator));</span>
<a href="#l49.266"></a><span id="l49.266">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.267"></a><span id="l49.267">   }</span>
<a href="#l49.268"></a><span id="l49.268" class="difflineminus">-  </span>
<a href="#l49.269"></a><span id="l49.269" class="difflineplus">+</span>
<a href="#l49.270"></a><span id="l49.270">   bool hasMore = false;</span>
<a href="#l49.271"></a><span id="l49.271" class="difflineminus">-  </span>
<a href="#l49.272"></a><span id="l49.272" class="difflineplus">+</span>
<a href="#l49.273"></a><span id="l49.273">   nsCOMPtr &lt;nsIMsgThread&gt; threadHdr ;</span>
<a href="#l49.274"></a><span id="l49.274">   int32_t	threadsRemoved = 0;</span>
<a href="#l49.275"></a><span id="l49.275">   while (numListed &lt; numToList &amp;&amp;</span>
<a href="#l49.276"></a><span id="l49.276">          NS_SUCCEEDED(rv = m_threadEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l49.277"></a><span id="l49.277">          hasMore)</span>
<a href="#l49.278"></a><span id="l49.278">   {</span>
<a href="#l49.279"></a><span id="l49.279">     nsCOMPtr &lt;nsISupports&gt; supports;</span>
<a href="#l49.280"></a><span id="l49.280">     rv = m_threadEnumerator-&gt;GetNext(getter_AddRefs(supports));</span>
<a href="#l49.281"></a><span id="l49.281" class="difflineat">@@ -440,33 +440,33 @@ nsresult nsMsgThreadedDBView::ListThread</span>
<a href="#l49.282"></a><span id="l49.282">         pLevels[numListed] = 0;</span>
<a href="#l49.283"></a><span id="l49.283">         // turn off these flags on msg hdr - they belong in thread</span>
<a href="#l49.284"></a><span id="l49.284">         msgHdr-&gt;AndFlags(~(nsMsgMessageFlags::Watched), &amp;newMsgFlags);</span>
<a href="#l49.285"></a><span id="l49.285">         AdjustReadFlag(msgHdr, &amp;msgFlags);</span>
<a href="#l49.286"></a><span id="l49.286">         // try adding in MSG_VIEW_FLAG_ISTHREAD flag for unreadonly view.</span>
<a href="#l49.287"></a><span id="l49.287">         pFlags[numListed] = msgFlags | MSG_VIEW_FLAG_ISTHREAD | threadFlags;</span>
<a href="#l49.288"></a><span id="l49.288">         if (numChildren &gt; 1)</span>
<a href="#l49.289"></a><span id="l49.289">           pFlags[numListed] |= MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l49.290"></a><span id="l49.290" class="difflineminus">-        </span>
<a href="#l49.291"></a><span id="l49.291" class="difflineplus">+</span>
<a href="#l49.292"></a><span id="l49.292">         numListed++;</span>
<a href="#l49.293"></a><span id="l49.293">       }</span>
<a href="#l49.294"></a><span id="l49.294">       else</span>
<a href="#l49.295"></a><span id="l49.295">         NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; msgHdr, &quot;couldn't get header for some reason&quot;);</span>
<a href="#l49.296"></a><span id="l49.296">     }</span>
<a href="#l49.297"></a><span id="l49.297">     else if (threadsRemoved &lt; 10 &amp;&amp; !(threadFlags &amp; (nsMsgMessageFlags::Watched | nsMsgMessageFlags::Ignored)))</span>
<a href="#l49.298"></a><span id="l49.298">     {</span>
<a href="#l49.299"></a><span id="l49.299">       // ### remove thread.</span>
<a href="#l49.300"></a><span id="l49.300">       threadsRemoved++;	// don't want to remove all empty threads first time</span>
<a href="#l49.301"></a><span id="l49.301">       // around as it will choke preformance for upgrade.</span>
<a href="#l49.302"></a><span id="l49.302"> #ifdef DEBUG_bienvenu</span>
<a href="#l49.303"></a><span id="l49.303">       printf(&quot;removing empty non-ignored non-watched thread\n&quot;);</span>
<a href="#l49.304"></a><span id="l49.304"> #endif</span>
<a href="#l49.305"></a><span id="l49.305">     }</span>
<a href="#l49.306"></a><span id="l49.306">   }</span>
<a href="#l49.307"></a><span id="l49.307" class="difflineminus">-  </span>
<a href="#l49.308"></a><span id="l49.308" class="difflineplus">+</span>
<a href="#l49.309"></a><span id="l49.309">   if (hasMore &amp;&amp; threadHdr)</span>
<a href="#l49.310"></a><span id="l49.310">   {</span>
<a href="#l49.311"></a><span id="l49.311">     threadHdr-&gt;GetThreadKey(startMsg);</span>
<a href="#l49.312"></a><span id="l49.312">   }</span>
<a href="#l49.313"></a><span id="l49.313">   else</span>
<a href="#l49.314"></a><span id="l49.314">   {</span>
<a href="#l49.315"></a><span id="l49.315">     *startMsg = nsMsgKey_None;</span>
<a href="#l49.316"></a><span id="l49.316">     nsCOMPtr &lt;nsIDBChangeListener&gt; dbListener = do_QueryInterface(m_threadEnumerator);</span>
<a href="#l49.317"></a><span id="l49.317" class="difflineat">@@ -504,17 +504,17 @@ void	nsMsgThreadedDBView::OnExtraFlagCha</span>
<a href="#l49.318"></a><span id="l49.318">         else</span>
<a href="#l49.319"></a><span id="l49.319">           extraFlag &amp;= ~MSG_VIEW_FLAG_HASCHILDREN;</span>
<a href="#l49.320"></a><span id="l49.320">         m_prevFlags[prevViewIndex] = extraFlag; // will this be right?</span>
<a href="#l49.321"></a><span id="l49.321">       }</span>
<a href="#l49.322"></a><span id="l49.322">     }</span>
<a href="#l49.323"></a><span id="l49.323">   }</span>
<a href="#l49.324"></a><span id="l49.324">   // we don't really know what's changed, but to be on the safe side, set the sort invalid</span>
<a href="#l49.325"></a><span id="l49.325">   // so that reverse sort will pick it up.</span>
<a href="#l49.326"></a><span id="l49.326" class="difflineminus">-  if (m_sortType == nsMsgViewSortType::byStatus || m_sortType == nsMsgViewSortType::byFlagged || </span>
<a href="#l49.327"></a><span id="l49.327" class="difflineplus">+  if (m_sortType == nsMsgViewSortType::byStatus || m_sortType == nsMsgViewSortType::byFlagged ||</span>
<a href="#l49.328"></a><span id="l49.328">     m_sortType == nsMsgViewSortType::byUnread || m_sortType == nsMsgViewSortType::byPriority)</span>
<a href="#l49.329"></a><span id="l49.329">     m_sortValid = false;</span>
<a href="#l49.330"></a><span id="l49.330"> }</span>
<a href="#l49.331"></a><span id="l49.331"> </span>
<a href="#l49.332"></a><span id="l49.332"> void nsMsgThreadedDBView::OnHeaderAddedOrDeleted()</span>
<a href="#l49.333"></a><span id="l49.333"> {</span>
<a href="#l49.334"></a><span id="l49.334">   ClearPrevIdArray();</span>
<a href="#l49.335"></a><span id="l49.335"> }</span>
<a href="#l49.336"></a><span id="l49.336" class="difflineat">@@ -538,24 +538,24 @@ nsresult nsMsgThreadedDBView::InitSort(n</span>
<a href="#l49.337"></a><span id="l49.337">     m_sortType = nsMsgViewSortType::byThread;</span>
<a href="#l49.338"></a><span id="l49.338">     m_viewFlags |= nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l49.339"></a><span id="l49.339">     m_viewFlags &amp;= ~nsMsgViewFlagsType::kGroupBySort;</span>
<a href="#l49.340"></a><span id="l49.340">     SetViewFlags(m_viewFlags); // persist the view flags.</span>
<a href="#l49.341"></a><span id="l49.341">     //		m_db-&gt;SetSortInfo(m_sortType, sortOrder);</span>
<a href="#l49.342"></a><span id="l49.342">   }</span>
<a href="#l49.343"></a><span id="l49.343"> //  else</span>
<a href="#l49.344"></a><span id="l49.344"> //    m_viewFlags &amp;= ~nsMsgViewFlagsType::kThreadedDisplay;</span>
<a href="#l49.345"></a><span id="l49.345" class="difflineminus">-  </span>
<a href="#l49.346"></a><span id="l49.346" class="difflineplus">+</span>
<a href="#l49.347"></a><span id="l49.347">   // by default, the unread only view should have all threads expanded.</span>
<a href="#l49.348"></a><span id="l49.348" class="difflineminus">-  if ((m_viewFlags &amp; (nsMsgViewFlagsType::kUnreadOnly|nsMsgViewFlagsType::kExpandAll)) </span>
<a href="#l49.349"></a><span id="l49.349" class="difflineplus">+  if ((m_viewFlags &amp; (nsMsgViewFlagsType::kUnreadOnly|nsMsgViewFlagsType::kExpandAll))</span>
<a href="#l49.350"></a><span id="l49.350">       &amp;&amp; (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l49.351"></a><span id="l49.351">     ExpandAll();</span>
<a href="#l49.352"></a><span id="l49.352">   if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l49.353"></a><span id="l49.353">     ExpandAll(); // for now, expand all and do a flat sort.</span>
<a href="#l49.354"></a><span id="l49.354" class="difflineminus">-  </span>
<a href="#l49.355"></a><span id="l49.355" class="difflineplus">+</span>
<a href="#l49.356"></a><span id="l49.356">   Sort(sortType, sortOrder);</span>
<a href="#l49.357"></a><span id="l49.357">   if (sortType != nsMsgViewSortType::byThread)	// forget prev view, since it has everything expanded.</span>
<a href="#l49.358"></a><span id="l49.358">     ClearPrevIdArray();</span>
<a href="#l49.359"></a><span id="l49.359">   return NS_OK;</span>
<a href="#l49.360"></a><span id="l49.360"> }</span>
<a href="#l49.361"></a><span id="l49.361"> </span>
<a href="#l49.362"></a><span id="l49.362"> nsresult nsMsgThreadedDBView::OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool ensureListed)</span>
<a href="#l49.363"></a><span id="l49.363"> {</span>
<a href="#l49.364"></a><span id="l49.364" class="difflineat">@@ -685,17 +685,17 @@ NS_IMETHODIMP nsMsgThreadedDBView::OnPar</span>
<a href="#l49.365"></a><span id="l49.365">   if (false &amp;&amp; m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)</span>
<a href="#l49.366"></a><span id="l49.366">   {</span>
<a href="#l49.367"></a><span id="l49.367">     nsMsgViewIndex childIndex = FindViewIndex(aKeyChanged);</span>
<a href="#l49.368"></a><span id="l49.368">     if (childIndex != nsMsgViewIndex_None)</span>
<a href="#l49.369"></a><span id="l49.369">     {</span>
<a href="#l49.370"></a><span id="l49.370">       nsMsgViewIndex parentIndex = FindViewIndex(newParent);</span>
<a href="#l49.371"></a><span id="l49.371">       int32_t newParentLevel = (parentIndex == nsMsgViewIndex_None) ? -1 : m_levels[parentIndex];</span>
<a href="#l49.372"></a><span id="l49.372">       nsMsgViewIndex oldParentIndex = FindViewIndex(oldParent);</span>
<a href="#l49.373"></a><span id="l49.373" class="difflineminus">-      int32_t oldParentLevel = (oldParentIndex != nsMsgViewIndex_None || newParent == nsMsgKey_None) </span>
<a href="#l49.374"></a><span id="l49.374" class="difflineplus">+      int32_t oldParentLevel = (oldParentIndex != nsMsgViewIndex_None || newParent == nsMsgKey_None)</span>
<a href="#l49.375"></a><span id="l49.375">         ? m_levels[oldParentIndex] : -1 ;</span>
<a href="#l49.376"></a><span id="l49.376">       int32_t levelChanged = m_levels[childIndex];</span>
<a href="#l49.377"></a><span id="l49.377">       int32_t parentDelta = oldParentLevel - newParentLevel;</span>
<a href="#l49.378"></a><span id="l49.378">       m_levels[childIndex] = (newParent == nsMsgKey_None) ? 0 : newParentLevel + 1;</span>
<a href="#l49.379"></a><span id="l49.379">       if (parentDelta &gt; 0)</span>
<a href="#l49.380"></a><span id="l49.380">       {</span>
<a href="#l49.381"></a><span id="l49.381">         for (nsMsgViewIndex viewIndex = childIndex + 1; viewIndex &lt; GetSize() &amp;&amp; m_levels[viewIndex] &gt; levelChanged;  viewIndex++)</span>
<a href="#l49.382"></a><span id="l49.382">         {</span>
<a href="#l49.383"></a><span id="l49.383" class="difflineat">@@ -718,17 +718,17 @@ nsMsgViewIndex nsMsgThreadedDBView::GetI</span>
<a href="#l49.384"></a><span id="l49.384">   {</span>
<a href="#l49.385"></a><span id="l49.385">     // loop until we find a message at a level less than or equal to the parent level</span>
<a href="#l49.386"></a><span id="l49.386">     if (m_levels[parentIndex] &lt; targetLevel)</span>
<a href="#l49.387"></a><span id="l49.387">       break;</span>
<a href="#l49.388"></a><span id="l49.388">   }</span>
<a href="#l49.389"></a><span id="l49.389">   return parentIndex;</span>
<a href="#l49.390"></a><span id="l49.390"> }</span>
<a href="#l49.391"></a><span id="l49.391"> </span>
<a href="#l49.392"></a><span id="l49.392" class="difflineminus">-// This method removes the thread at threadIndex from the view </span>
<a href="#l49.393"></a><span id="l49.393" class="difflineplus">+// This method removes the thread at threadIndex from the view</span>
<a href="#l49.394"></a><span id="l49.394"> // and puts it back in its new position, determined by the sort order.</span>
<a href="#l49.395"></a><span id="l49.395"> // And, if the selection is affected, save and restore the selection.</span>
<a href="#l49.396"></a><span id="l49.396"> void nsMsgThreadedDBView::MoveThreadAt(nsMsgViewIndex threadIndex)</span>
<a href="#l49.397"></a><span id="l49.397"> {</span>
<a href="#l49.398"></a><span id="l49.398">   // we need to check if the thread is collapsed or not...</span>
<a href="#l49.399"></a><span id="l49.399">   // We want to turn off tree notifications so that we don't</span>
<a href="#l49.400"></a><span id="l49.400">   // reload the current message.</span>
<a href="#l49.401"></a><span id="l49.401">   // We also need to invalidate the range between where the thread was</span>
<a href="#l49.402"></a><span id="l49.402" class="difflineat">@@ -765,17 +765,17 @@ void nsMsgThreadedDBView::MoveThreadAt(n</span>
<a href="#l49.403"></a><span id="l49.403">   nsTArray&lt;uint32_t&gt; threadFlags;</span>
<a href="#l49.404"></a><span id="l49.404">   nsTArray&lt;uint8_t&gt; threadLevels;</span>
<a href="#l49.405"></a><span id="l49.405"> </span>
<a href="#l49.406"></a><span id="l49.406">   if (threadIsExpanded)</span>
<a href="#l49.407"></a><span id="l49.407">   {</span>
<a href="#l49.408"></a><span id="l49.408">     threadKeys.SetCapacity(childCount);</span>
<a href="#l49.409"></a><span id="l49.409">     threadFlags.SetCapacity(childCount);</span>
<a href="#l49.410"></a><span id="l49.410">     threadLevels.SetCapacity(childCount);</span>
<a href="#l49.411"></a><span id="l49.411" class="difflineminus">-    for (nsMsgViewIndex index = threadIndex + 1; </span>
<a href="#l49.412"></a><span id="l49.412" class="difflineplus">+    for (nsMsgViewIndex index = threadIndex + 1;</span>
<a href="#l49.413"></a><span id="l49.413">         index &lt; GetSize() &amp;&amp; m_levels[index]; index++)</span>
<a href="#l49.414"></a><span id="l49.414">     {</span>
<a href="#l49.415"></a><span id="l49.415">       threadKeys.AppendElement(m_keys[index]);</span>
<a href="#l49.416"></a><span id="l49.416">       threadFlags.AppendElement(m_flags[index]);</span>
<a href="#l49.417"></a><span id="l49.417">       threadLevels.AppendElement(m_levels[index]);</span>
<a href="#l49.418"></a><span id="l49.418">     }</span>
<a href="#l49.419"></a><span id="l49.419">     uint32_t collapseCount;</span>
<a href="#l49.420"></a><span id="l49.420">     CollapseByIndex(threadIndex, &amp;collapseCount);</span>
<a href="#l49.421"></a><span id="l49.421" class="difflineat">@@ -831,25 +831,25 @@ nsresult nsMsgThreadedDBView::AddMsgToTh</span>
<a href="#l49.422"></a><span id="l49.422"> // NOT delete it from the database.</span>
<a href="#l49.423"></a><span id="l49.423"> nsresult nsMsgThreadedDBView::RemoveByIndex(nsMsgViewIndex index)</span>
<a href="#l49.424"></a><span id="l49.424"> {</span>
<a href="#l49.425"></a><span id="l49.425">   nsresult rv = NS_OK;</span>
<a href="#l49.426"></a><span id="l49.426">   int32_t flags;</span>
<a href="#l49.427"></a><span id="l49.427"> </span>
<a href="#l49.428"></a><span id="l49.428">   if (!IsValidIndex(index))</span>
<a href="#l49.429"></a><span id="l49.429">     return NS_MSG_INVALID_DBVIEW_INDEX;</span>
<a href="#l49.430"></a><span id="l49.430" class="difflineminus">-  </span>
<a href="#l49.431"></a><span id="l49.431" class="difflineplus">+</span>
<a href="#l49.432"></a><span id="l49.432">   OnHeaderAddedOrDeleted();</span>
<a href="#l49.433"></a><span id="l49.433"> </span>
<a href="#l49.434"></a><span id="l49.434">   flags = m_flags[index];</span>
<a href="#l49.435"></a><span id="l49.435"> </span>
<a href="#l49.436"></a><span id="l49.436" class="difflineminus">-  if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay)) </span>
<a href="#l49.437"></a><span id="l49.437" class="difflineplus">+  if (! (m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l49.438"></a><span id="l49.438">     return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l49.439"></a><span id="l49.439"> </span>
<a href="#l49.440"></a><span id="l49.440" class="difflineminus">-  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr; </span>
<a href="#l49.441"></a><span id="l49.441" class="difflineplus">+  nsCOMPtr&lt;nsIMsgThread&gt; threadHdr;</span>
<a href="#l49.442"></a><span id="l49.442">   GetThreadContainingIndex(index, getter_AddRefs(threadHdr));</span>
<a href="#l49.443"></a><span id="l49.443">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l49.444"></a><span id="l49.444">   uint32_t numThreadChildren = 0;</span>
<a href="#l49.445"></a><span id="l49.445">   // If we can't get a thread, it's already deleted and thus has 0 children.</span>
<a href="#l49.446"></a><span id="l49.446">   if (threadHdr)</span>
<a href="#l49.447"></a><span id="l49.447">     threadHdr-&gt;GetNumChildren(&amp;numThreadChildren);</span>
<a href="#l49.448"></a><span id="l49.448"> </span>
<a href="#l49.449"></a><span id="l49.449">   // Check if we're the top level msg in the thread, and we're not collapsed.</span>
<a href="#l49.450"></a><span id="l49.450" class="difflineat">@@ -882,34 +882,34 @@ nsresult nsMsgThreadedDBView::RemoveByIn</span>
<a href="#l49.451"></a><span id="l49.451">       }</span>
<a href="#l49.452"></a><span id="l49.452">     }</span>
<a href="#l49.453"></a><span id="l49.453">     return rv;</span>
<a href="#l49.454"></a><span id="l49.454">   }</span>
<a href="#l49.455"></a><span id="l49.455">   else if (!(flags &amp; MSG_VIEW_FLAG_ISTHREAD))</span>
<a href="#l49.456"></a><span id="l49.456">   {</span>
<a href="#l49.457"></a><span id="l49.457">     // We're not deleting the top level msg, but top level msg might be the</span>
<a href="#l49.458"></a><span id="l49.458">     // only msg in thread now.</span>
<a href="#l49.459"></a><span id="l49.459" class="difflineminus">-    if (threadHdr &amp;&amp; numThreadChildren == 1) </span>
<a href="#l49.460"></a><span id="l49.460" class="difflineplus">+    if (threadHdr &amp;&amp; numThreadChildren == 1)</span>
<a href="#l49.461"></a><span id="l49.461">     {</span>
<a href="#l49.462"></a><span id="l49.462">       nsMsgKey msgKey;</span>
<a href="#l49.463"></a><span id="l49.463">       rv = threadHdr-&gt;GetChildKeyAt(0, &amp;msgKey);</span>
<a href="#l49.464"></a><span id="l49.464">       if (NS_SUCCEEDED(rv))</span>
<a href="#l49.465"></a><span id="l49.465">       {</span>
<a href="#l49.466"></a><span id="l49.466">         nsMsgViewIndex threadIndex = FindViewIndex(msgKey);</span>
<a href="#l49.467"></a><span id="l49.467">         if (IsValidIndex(threadIndex))</span>
<a href="#l49.468"></a><span id="l49.468">         {</span>
<a href="#l49.469"></a><span id="l49.469">           uint32_t flags = m_flags[threadIndex];</span>
<a href="#l49.470"></a><span id="l49.470">           flags &amp;= ~(MSG_VIEW_FLAG_ISTHREAD |</span>
<a href="#l49.471"></a><span id="l49.471">                      nsMsgMessageFlags::Elided |</span>
<a href="#l49.472"></a><span id="l49.472">                      MSG_VIEW_FLAG_HASCHILDREN);</span>
<a href="#l49.473"></a><span id="l49.473">           m_flags[threadIndex] = flags;</span>
<a href="#l49.474"></a><span id="l49.474">           NoteChange(threadIndex, 1, nsMsgViewNotificationCode::changed);</span>
<a href="#l49.475"></a><span id="l49.475">         }</span>
<a href="#l49.476"></a><span id="l49.476">       }</span>
<a href="#l49.477"></a><span id="l49.477" class="difflineminus">-      </span>
<a href="#l49.478"></a><span id="l49.478" class="difflineplus">+</span>
<a href="#l49.479"></a><span id="l49.479">     }</span>
<a href="#l49.480"></a><span id="l49.480">     return nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l49.481"></a><span id="l49.481">   }</span>
<a href="#l49.482"></a><span id="l49.482">   // Deleting collapsed thread header is special case. Child will be promoted,</span>
<a href="#l49.483"></a><span id="l49.483">   // so just tell FE that line changed, not that it was deleted.</span>
<a href="#l49.484"></a><span id="l49.484">   // Header has aleady been deleted from thread.</span>
<a href="#l49.485"></a><span id="l49.485">   if (threadHdr &amp;&amp; numThreadChildren &gt; 0)</span>
<a href="#l49.486"></a><span id="l49.486">   {</span>
<a href="#l49.487"></a><span id="l49.487" class="difflineat">@@ -958,17 +958,17 @@ nsresult nsMsgThreadedDBView::RemoveByIn</span>
<a href="#l49.488"></a><span id="l49.488">     rv = nsMsgDBView::RemoveByIndex(index);</span>
<a href="#l49.489"></a><span id="l49.489">   }</span>
<a href="#l49.490"></a><span id="l49.490">   return rv;</span>
<a href="#l49.491"></a><span id="l49.491"> }</span>
<a href="#l49.492"></a><span id="l49.492"> </span>
<a href="#l49.493"></a><span id="l49.493"> NS_IMETHODIMP nsMsgThreadedDBView::GetViewType(nsMsgViewTypeValue *aViewType)</span>
<a href="#l49.494"></a><span id="l49.494"> {</span>
<a href="#l49.495"></a><span id="l49.495">     NS_ENSURE_ARG_POINTER(aViewType);</span>
<a href="#l49.496"></a><span id="l49.496" class="difflineminus">-    *aViewType = nsMsgViewType::eShowAllThreads; </span>
<a href="#l49.497"></a><span id="l49.497" class="difflineplus">+    *aViewType = nsMsgViewType::eShowAllThreads;</span>
<a href="#l49.498"></a><span id="l49.498">     return NS_OK;</span>
<a href="#l49.499"></a><span id="l49.499"> }</span>
<a href="#l49.500"></a><span id="l49.500"> </span>
<a href="#l49.501"></a><span id="l49.501"> NS_IMETHODIMP</span>
<a href="#l49.502"></a><span id="l49.502"> nsMsgThreadedDBView::CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval)</span>
<a href="#l49.503"></a><span id="l49.503"> {</span>
<a href="#l49.504"></a><span id="l49.504">   nsMsgThreadedDBView* newMsgDBView = new nsMsgThreadedDBView();</span>
<a href="#l49.505"></a><span id="l49.505"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/base/src/nsMsgThreadedDBView.h</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgThreadedDBView.h</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -23,17 +23,17 @@ public:</span>
<a href="#l50.4"></a><span id="l50.4">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l50.5"></a><span id="l50.5">   NS_IMETHOD OnParentChanged (nsMsgKey aKeyChanged, nsMsgKey oldParent, nsMsgKey newParent, nsIDBChangeListener *aInstigator) override;</span>
<a href="#l50.6"></a><span id="l50.6"> </span>
<a href="#l50.7"></a><span id="l50.7"> protected:</span>
<a href="#l50.8"></a><span id="l50.8">   virtual const char *GetViewName(void) override { return &quot;ThreadedDBView&quot;; }</span>
<a href="#l50.9"></a><span id="l50.9">   nsresult InitThreadedView(int32_t *pCount);</span>
<a href="#l50.10"></a><span id="l50.10">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey aParentKey, bool ensureListed) override;</span>
<a href="#l50.11"></a><span id="l50.11">   virtual nsresult AddMsgToThreadNotInView(nsIMsgThread *threadHdr, nsIMsgDBHdr *msgHdr, bool ensureListed);</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  nsresult ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput, int32_t *pFlags, char *pLevels, </span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+  nsresult ListThreadIds(nsMsgKey *startMsg, bool unreadOnly, nsMsgKey *pOutput, int32_t *pFlags, char *pLevels,</span>
<a href="#l50.14"></a><span id="l50.14">                         int32_t numToList, int32_t *pNumListed, int32_t *pTotalHeaders);</span>
<a href="#l50.15"></a><span id="l50.15">   nsresult InitSort(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l50.16"></a><span id="l50.16">   virtual nsresult SortThreads(nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder);</span>
<a href="#l50.17"></a><span id="l50.17">   virtual void  OnExtraFlagChanged(nsMsgViewIndex index, uint32_t extraFlag) override;</span>
<a href="#l50.18"></a><span id="l50.18">   virtual void OnHeaderAddedOrDeleted() override;</span>
<a href="#l50.19"></a><span id="l50.19">   void    ClearPrevIdArray();</span>
<a href="#l50.20"></a><span id="l50.20">   virtual nsresult RemoveByIndex(nsMsgViewIndex index) override;</span>
<a href="#l50.21"></a><span id="l50.21">   nsMsgViewIndex GetInsertInfoForNewHdr(nsIMsgDBHdr *newHdr, nsMsgViewIndex threadIndex, int32_t targetLevel);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/base/src/nsMsgWindow.h</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgWindow.h</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -46,16 +46,16 @@ protected:</span>
<a href="#l51.4"></a><span id="l51.4">   // prompt dialog used during testing only</span>
<a href="#l51.5"></a><span id="l51.5">   nsCOMPtr&lt;nsIPrompt&gt; mPromptDialog;</span>
<a href="#l51.6"></a><span id="l51.6">   // authorization prompt used during testing only</span>
<a href="#l51.7"></a><span id="l51.7">   nsCOMPtr&lt;nsIAuthPrompt&gt; mAuthPrompt;</span>
<a href="#l51.8"></a><span id="l51.8"> </span>
<a href="#l51.9"></a><span id="l51.9">   // let's not make this a strong ref - we don't own it.</span>
<a href="#l51.10"></a><span id="l51.10">   nsWeakPtr mRootDocShellWeak;</span>
<a href="#l51.11"></a><span id="l51.11">   nsWeakPtr mMessageWindowDocShellWeak;</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  nsWeakPtr mDomWindow; </span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  nsWeakPtr mDomWindow;</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15">   nsCString mMailCharacterSet;</span>
<a href="#l51.16"></a><span id="l51.16">   bool      mCharsetOverride;</span>
<a href="#l51.17"></a><span id="l51.17">   bool      m_stopped;</span>
<a href="#l51.18"></a><span id="l51.18"> };</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFViewThread.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -71,18 +71,18 @@ NS_IMETHODIMP nsMsgXFViewThread::GetNumC</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5"> NS_IMETHODIMP nsMsgXFViewThread::GetNumUnreadChildren (uint32_t *aNumUnreadChildren)</span>
<a href="#l52.6"></a><span id="l52.6"> {</span>
<a href="#l52.7"></a><span id="l52.7">   NS_ENSURE_ARG_POINTER(aNumUnreadChildren);</span>
<a href="#l52.8"></a><span id="l52.8">   *aNumUnreadChildren = m_numUnreadChildren;</span>
<a href="#l52.9"></a><span id="l52.9">   return NS_OK;</span>
<a href="#l52.10"></a><span id="l52.10"> }</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-nsMsgXFViewThread::AddChild(nsIMsgDBHdr *aNewHdr, nsIMsgDBHdr *aInReplyTo, </span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+nsMsgXFViewThread::AddChild(nsIMsgDBHdr *aNewHdr, nsIMsgDBHdr *aInReplyTo,</span>
<a href="#l52.16"></a><span id="l52.16">                             bool aThreadInThread, nsIDBChangeAnnouncer *aAnnouncer)</span>
<a href="#l52.17"></a><span id="l52.17"> {</span>
<a href="#l52.18"></a><span id="l52.18">   uint32_t whereInserted;</span>
<a href="#l52.19"></a><span id="l52.19">   return AddHdr(aNewHdr, false, whereInserted, nullptr);</span>
<a href="#l52.20"></a><span id="l52.20"> }</span>
<a href="#l52.21"></a><span id="l52.21"> </span>
<a href="#l52.22"></a><span id="l52.22"> // Returns the parent of the newly added header. If reparentChildren</span>
<a href="#l52.23"></a><span id="l52.23"> // is true, we believe that the new header is a parent of an existing</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineat">@@ -168,17 +168,17 @@ nsresult nsMsgXFViewThread::AddHdr(nsIMs</span>
<a href="#l52.25"></a><span id="l52.25">     // and insert ourselves before it, or as the last child. In other words,</span>
<a href="#l52.26"></a><span id="l52.26">     // insert, sorted by date.</span>
<a href="#l52.27"></a><span id="l52.27">     uint32_t msgDate, childDate;</span>
<a href="#l52.28"></a><span id="l52.28">     newHdr-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l52.29"></a><span id="l52.29">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l52.30"></a><span id="l52.30">     nsMsgViewIndex i;</span>
<a href="#l52.31"></a><span id="l52.31">     nsMsgViewIndex insertIndex = m_keys.Length();</span>
<a href="#l52.32"></a><span id="l52.32">     uint32_t insertLevel = parentLevel + 1;</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-    for (i = parentIndex; </span>
<a href="#l52.34"></a><span id="l52.34" class="difflineplus">+    for (i = parentIndex;</span>
<a href="#l52.35"></a><span id="l52.35">          i &lt; m_keys.Length() &amp;&amp; (i == (nsMsgViewIndex)parentIndex || m_levels[i] &gt;= parentLevel);</span>
<a href="#l52.36"></a><span id="l52.36">          i++)</span>
<a href="#l52.37"></a><span id="l52.37">     {</span>
<a href="#l52.38"></a><span id="l52.38">       GetChildHdrAt(i, getter_AddRefs(child));</span>
<a href="#l52.39"></a><span id="l52.39">       if (child)</span>
<a href="#l52.40"></a><span id="l52.40">       {</span>
<a href="#l52.41"></a><span id="l52.41">         if (reparentChildren &amp;&amp; IsHdrParentOf(newHdr, child))</span>
<a href="#l52.42"></a><span id="l52.42">         {</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineat">@@ -219,17 +219,17 @@ nsresult nsMsgXFViewThread::AddHdr(nsIMs</span>
<a href="#l52.44"></a><span id="l52.44">     whereInserted = insertIndex;</span>
<a href="#l52.45"></a><span id="l52.45">   }</span>
<a href="#l52.46"></a><span id="l52.46">   else</span>
<a href="#l52.47"></a><span id="l52.47">   {</span>
<a href="#l52.48"></a><span id="l52.48">     if (outParent)</span>
<a href="#l52.49"></a><span id="l52.49">       *outParent = nullptr;</span>
<a href="#l52.50"></a><span id="l52.50">     nsCOMPtr&lt;nsIMsgDBHdr&gt; rootHdr;</span>
<a href="#l52.51"></a><span id="l52.51">     GetChildHdrAt(0, getter_AddRefs(rootHdr));</span>
<a href="#l52.52"></a><span id="l52.52" class="difflineminus">-    // If the new header is a parent of the root then it should be promoted. </span>
<a href="#l52.53"></a><span id="l52.53" class="difflineplus">+    // If the new header is a parent of the root then it should be promoted.</span>
<a href="#l52.54"></a><span id="l52.54">     if (rootHdr &amp;&amp; IsHdrParentOf(newHdr, rootHdr))</span>
<a href="#l52.55"></a><span id="l52.55">     {</span>
<a href="#l52.56"></a><span id="l52.56">       m_keys.InsertElementAt(0, newHdrKey);</span>
<a href="#l52.57"></a><span id="l52.57">       m_levels.InsertElementAt(0, 0);</span>
<a href="#l52.58"></a><span id="l52.58">       m_folders.InsertObjectAt(newHdrFolder, 0);</span>
<a href="#l52.59"></a><span id="l52.59">       whereInserted = 0;</span>
<a href="#l52.60"></a><span id="l52.60">       // Adjust level of old root hdr and its children</span>
<a href="#l52.61"></a><span id="l52.61">       for (nsMsgViewIndex i = 1; i &lt; m_keys.Length(); i++)</span>
<a href="#l52.62"></a><span id="l52.62" class="difflineat">@@ -241,34 +241,34 @@ nsresult nsMsgXFViewThread::AddHdr(nsIMs</span>
<a href="#l52.63"></a><span id="l52.63">       m_levels.AppendElement(1);</span>
<a href="#l52.64"></a><span id="l52.64">       m_folders.AppendObject(newHdrFolder);</span>
<a href="#l52.65"></a><span id="l52.65">       if (outParent)</span>
<a href="#l52.66"></a><span id="l52.66">         rootHdr.forget(outParent);</span>
<a href="#l52.67"></a><span id="l52.67">       whereInserted = m_keys.Length() -1;</span>
<a href="#l52.68"></a><span id="l52.68">     }</span>
<a href="#l52.69"></a><span id="l52.69">   }</span>
<a href="#l52.70"></a><span id="l52.70"> </span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-  // ### TODO handle the case where the root header starts </span>
<a href="#l52.72"></a><span id="l52.72" class="difflineplus">+  // ### TODO handle the case where the root header starts</span>
<a href="#l52.73"></a><span id="l52.73">   // with Re, and the new one doesn't, and is earlier. In that</span>
<a href="#l52.74"></a><span id="l52.74">   // case, we want to promote the new header to root.</span>
<a href="#l52.75"></a><span id="l52.75"> </span>
<a href="#l52.76"></a><span id="l52.76"> //  PRTime newHdrDate;</span>
<a href="#l52.77"></a><span id="l52.77"> //  newHdr-&gt;GetDate(&amp;newHdrDate);</span>
<a href="#l52.78"></a><span id="l52.78"> </span>
<a href="#l52.79"></a><span id="l52.79"> //  if (numChildren &gt; 0 &amp;&amp; !(newHdrFlags &amp; nsMsgMessageFlags::HasRe))</span>
<a href="#l52.80"></a><span id="l52.80"> //  {</span>
<a href="#l52.81"></a><span id="l52.81"> //    PRTime topLevelHdrDate;</span>
<a href="#l52.82"></a><span id="l52.82"> </span>
<a href="#l52.83"></a><span id="l52.83"> //    nsCOMPtr&lt;nsIMsgDBHdr&gt; topLevelHdr;</span>
<a href="#l52.84"></a><span id="l52.84"> //    rv = GetRootHdr(nullptr, getter_AddRefs(topLevelHdr));</span>
<a href="#l52.85"></a><span id="l52.85"> //    if (NS_SUCCEEDED(rv) &amp;&amp; topLevelHdr)</span>
<a href="#l52.86"></a><span id="l52.86"> //    {</span>
<a href="#l52.87"></a><span id="l52.87"> //      topLevelHdr-&gt;GetDate(&amp;topLevelHdrDate);</span>
<a href="#l52.88"></a><span id="l52.88"> //      if (newHdrDate &lt; topLevelHdrDate)</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineminus">-      </span>
<a href="#l52.90"></a><span id="l52.90" class="difflineplus">+</span>
<a href="#l52.91"></a><span id="l52.91"> //    }</span>
<a href="#l52.92"></a><span id="l52.92"> //  }</span>
<a href="#l52.93"></a><span id="l52.93">   return NS_OK;</span>
<a href="#l52.94"></a><span id="l52.94"> }</span>
<a href="#l52.95"></a><span id="l52.95"> </span>
<a href="#l52.96"></a><span id="l52.96"> NS_IMETHODIMP nsMsgXFViewThread::GetChildHdrAt(uint32_t aIndex, nsIMsgDBHdr **aResult)</span>
<a href="#l52.97"></a><span id="l52.97"> {</span>
<a href="#l52.98"></a><span id="l52.98">   if (aIndex &gt;= m_keys.Length())</span>
<a href="#l52.99"></a><span id="l52.99" class="difflineat">@@ -304,17 +304,17 @@ NS_IMETHODIMP nsMsgXFViewThread::RemoveC</span>
<a href="#l52.100"></a><span id="l52.100"> </span>
<a href="#l52.101"></a><span id="l52.101">   for (uint32_t childIndex = 0; childIndex &lt; m_keys.Length(); childIndex++)</span>
<a href="#l52.102"></a><span id="l52.102">   {</span>
<a href="#l52.103"></a><span id="l52.103">     if (m_keys[childIndex] == msgKey &amp;&amp; m_folders[childIndex] == msgFolder)</span>
<a href="#l52.104"></a><span id="l52.104">     {</span>
<a href="#l52.105"></a><span id="l52.105">       uint8_t levelRemoved = m_keys[childIndex];</span>
<a href="#l52.106"></a><span id="l52.106">       // Adjust the levels of all the children of this header</span>
<a href="#l52.107"></a><span id="l52.107">       nsMsgViewIndex i;</span>
<a href="#l52.108"></a><span id="l52.108" class="difflineminus">-      for (i = childIndex + 1; </span>
<a href="#l52.109"></a><span id="l52.109" class="difflineplus">+      for (i = childIndex + 1;</span>
<a href="#l52.110"></a><span id="l52.110">                i &lt; m_keys.Length() &amp;&amp; m_levels[i] &gt; levelRemoved; i++)</span>
<a href="#l52.111"></a><span id="l52.111">             m_levels[i] = m_levels[i] - 1;</span>
<a href="#l52.112"></a><span id="l52.112"> </span>
<a href="#l52.113"></a><span id="l52.113">       m_view-&gt;NoteChange(childIndex + 1, i - childIndex + 1,</span>
<a href="#l52.114"></a><span id="l52.114">                          nsMsgViewNotificationCode::changed);</span>
<a href="#l52.115"></a><span id="l52.115">       m_keys.RemoveElementAt(childIndex);</span>
<a href="#l52.116"></a><span id="l52.116">       m_levels.RemoveElementAt(childIndex);</span>
<a href="#l52.117"></a><span id="l52.117">       m_folders.RemoveObjectAt(childIndex);</span>
<a href="#l52.118"></a><span id="l52.118" class="difflineat">@@ -367,17 +367,17 @@ void nsMsgXFViewThread::ChangeUnreadChil</span>
<a href="#l52.119"></a><span id="l52.119">   m_numUnreadChildren += delta;</span>
<a href="#l52.120"></a><span id="l52.120"> }</span>
<a href="#l52.121"></a><span id="l52.121"> </span>
<a href="#l52.122"></a><span id="l52.122"> void nsMsgXFViewThread::ChangeChildCount(int32_t delta)</span>
<a href="#l52.123"></a><span id="l52.123"> {</span>
<a href="#l52.124"></a><span id="l52.124">   m_numChildren += delta;</span>
<a href="#l52.125"></a><span id="l52.125"> }</span>
<a href="#l52.126"></a><span id="l52.126"> </span>
<a href="#l52.127"></a><span id="l52.127" class="difflineminus">-bool nsMsgXFViewThread::IsHdrParentOf(nsIMsgDBHdr *possibleParent, </span>
<a href="#l52.128"></a><span id="l52.128" class="difflineplus">+bool nsMsgXFViewThread::IsHdrParentOf(nsIMsgDBHdr *possibleParent,</span>
<a href="#l52.129"></a><span id="l52.129">                                         nsIMsgDBHdr *possibleChild)</span>
<a href="#l52.130"></a><span id="l52.130"> {</span>
<a href="#l52.131"></a><span id="l52.131">   uint16_t referenceToCheck = 0;</span>
<a href="#l52.132"></a><span id="l52.132">   possibleChild-&gt;GetNumReferences(&amp;referenceToCheck);</span>
<a href="#l52.133"></a><span id="l52.133">   nsAutoCString reference;</span>
<a href="#l52.134"></a><span id="l52.134"> </span>
<a href="#l52.135"></a><span id="l52.135">   nsCString messageId;</span>
<a href="#l52.136"></a><span id="l52.136">   possibleParent-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l52.137"></a><span id="l52.137" class="difflineat">@@ -394,29 +394,29 @@ bool nsMsgXFViewThread::IsHdrParentOf(ns</span>
<a href="#l52.138"></a><span id="l52.138">     m_view-&gt;GetMsgHdrFromHash(reference, getter_AddRefs(refHdr));</span>
<a href="#l52.139"></a><span id="l52.139">     if (refHdr)</span>
<a href="#l52.140"></a><span id="l52.140">       break;</span>
<a href="#l52.141"></a><span id="l52.141">     referenceToCheck--;</span>
<a href="#l52.142"></a><span id="l52.142">   }</span>
<a href="#l52.143"></a><span id="l52.143">   return false;</span>
<a href="#l52.144"></a><span id="l52.144"> }</span>
<a href="#l52.145"></a><span id="l52.145"> </span>
<a href="#l52.146"></a><span id="l52.146" class="difflineminus">-NS_IMETHODIMP nsMsgXFViewThread::GetNewestMsgDate(uint32_t *aResult) </span>
<a href="#l52.147"></a><span id="l52.147" class="difflineplus">+NS_IMETHODIMP nsMsgXFViewThread::GetNewestMsgDate(uint32_t *aResult)</span>
<a href="#l52.148"></a><span id="l52.148"> {</span>
<a href="#l52.149"></a><span id="l52.149">   // if this hasn't been set, figure it out by enumerating the msgs in the thread.</span>
<a href="#l52.150"></a><span id="l52.150">   if (!m_newestMsgDate)</span>
<a href="#l52.151"></a><span id="l52.151">   {</span>
<a href="#l52.152"></a><span id="l52.152">     uint32_t numChildren;</span>
<a href="#l52.153"></a><span id="l52.153">     nsresult rv = NS_OK;</span>
<a href="#l52.154"></a><span id="l52.154" class="difflineminus">-  </span>
<a href="#l52.155"></a><span id="l52.155" class="difflineplus">+</span>
<a href="#l52.156"></a><span id="l52.156">     GetNumChildren(&amp;numChildren);</span>
<a href="#l52.157"></a><span id="l52.157"> </span>
<a href="#l52.158"></a><span id="l52.158">     if ((int32_t) numChildren &lt; 0)</span>
<a href="#l52.159"></a><span id="l52.159">       numChildren = 0;</span>
<a href="#l52.160"></a><span id="l52.160" class="difflineminus">- </span>
<a href="#l52.161"></a><span id="l52.161" class="difflineplus">+</span>
<a href="#l52.162"></a><span id="l52.162">     for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l52.163"></a><span id="l52.163">     {</span>
<a href="#l52.164"></a><span id="l52.164">       nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l52.165"></a><span id="l52.165">       rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l52.166"></a><span id="l52.166">       if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l52.167"></a><span id="l52.167">       {</span>
<a href="#l52.168"></a><span id="l52.168">         uint32_t msgDate;</span>
<a href="#l52.169"></a><span id="l52.169">         child-&gt;GetDateInSeconds(&amp;msgDate);</span>
<a href="#l52.170"></a><span id="l52.170" class="difflineat">@@ -424,48 +424,48 @@ NS_IMETHODIMP nsMsgXFViewThread::GetNewe</span>
<a href="#l52.171"></a><span id="l52.171">           m_newestMsgDate = msgDate;</span>
<a href="#l52.172"></a><span id="l52.172">       }</span>
<a href="#l52.173"></a><span id="l52.173">     }</span>
<a href="#l52.174"></a><span id="l52.174">   }</span>
<a href="#l52.175"></a><span id="l52.175">   *aResult = m_newestMsgDate;</span>
<a href="#l52.176"></a><span id="l52.176">   return NS_OK;</span>
<a href="#l52.177"></a><span id="l52.177"> }</span>
<a href="#l52.178"></a><span id="l52.178"> </span>
<a href="#l52.179"></a><span id="l52.179" class="difflineminus">-NS_IMETHODIMP nsMsgXFViewThread::SetNewestMsgDate(uint32_t aNewestMsgDate) </span>
<a href="#l52.180"></a><span id="l52.180" class="difflineplus">+NS_IMETHODIMP nsMsgXFViewThread::SetNewestMsgDate(uint32_t aNewestMsgDate)</span>
<a href="#l52.181"></a><span id="l52.181"> {</span>
<a href="#l52.182"></a><span id="l52.182">   m_newestMsgDate = aNewestMsgDate;</span>
<a href="#l52.183"></a><span id="l52.183">   return NS_OK;</span>
<a href="#l52.184"></a><span id="l52.184"> }</span>
<a href="#l52.185"></a><span id="l52.185"> </span>
<a href="#l52.186"></a><span id="l52.186"> NS_IMETHODIMP nsMsgXFViewThread::MarkChildRead(bool aRead)</span>
<a href="#l52.187"></a><span id="l52.187"> {</span>
<a href="#l52.188"></a><span id="l52.188">   ChangeUnreadChildCount(aRead ? -1 : 1);</span>
<a href="#l52.189"></a><span id="l52.189">   return NS_OK;</span>
<a href="#l52.190"></a><span id="l52.190"> }</span>
<a href="#l52.191"></a><span id="l52.191"> </span>
<a href="#l52.192"></a><span id="l52.192"> NS_IMETHODIMP nsMsgXFViewThread::GetFirstUnreadChild(nsIMsgDBHdr **aResult)</span>
<a href="#l52.193"></a><span id="l52.193"> {</span>
<a href="#l52.194"></a><span id="l52.194">   NS_ENSURE_ARG(aResult);</span>
<a href="#l52.195"></a><span id="l52.195">   uint32_t numChildren;</span>
<a href="#l52.196"></a><span id="l52.196">   nsresult rv = NS_OK;</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineminus">-  </span>
<a href="#l52.198"></a><span id="l52.198" class="difflineplus">+</span>
<a href="#l52.199"></a><span id="l52.199">   GetNumChildren(&amp;numChildren);</span>
<a href="#l52.200"></a><span id="l52.200"> </span>
<a href="#l52.201"></a><span id="l52.201">   if ((int32_t) numChildren &lt; 0)</span>
<a href="#l52.202"></a><span id="l52.202">     numChildren = 0;</span>
<a href="#l52.203"></a><span id="l52.203" class="difflineminus">-  </span>
<a href="#l52.204"></a><span id="l52.204" class="difflineplus">+</span>
<a href="#l52.205"></a><span id="l52.205">   for (uint32_t childIndex = 0; childIndex &lt; numChildren; childIndex++)</span>
<a href="#l52.206"></a><span id="l52.206">   {</span>
<a href="#l52.207"></a><span id="l52.207">     nsCOMPtr&lt;nsIMsgDBHdr&gt; child;</span>
<a href="#l52.208"></a><span id="l52.208">     rv = GetChildHdrAt(childIndex, getter_AddRefs(child));</span>
<a href="#l52.209"></a><span id="l52.209">     if (NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l52.210"></a><span id="l52.210">     {</span>
<a href="#l52.211"></a><span id="l52.211">       nsMsgKey msgKey;</span>
<a href="#l52.212"></a><span id="l52.212">       child-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l52.213"></a><span id="l52.213" class="difflineminus">-      </span>
<a href="#l52.214"></a><span id="l52.214" class="difflineplus">+</span>
<a href="#l52.215"></a><span id="l52.215">       bool isRead;</span>
<a href="#l52.216"></a><span id="l52.216">       nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l52.217"></a><span id="l52.217">       nsresult rv = m_folders[childIndex]-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l52.218"></a><span id="l52.218">       if (NS_SUCCEEDED(rv))</span>
<a href="#l52.219"></a><span id="l52.219">         rv = db-&gt;IsRead(msgKey, &amp;isRead);</span>
<a href="#l52.220"></a><span id="l52.220">       if (NS_SUCCEEDED(rv) &amp;&amp; !isRead)</span>
<a href="#l52.221"></a><span id="l52.221">       {</span>
<a href="#l52.222"></a><span id="l52.222">         child.forget(aResult);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFViewThread.h</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFViewThread.h</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -26,17 +26,17 @@ public:</span>
<a href="#l53.4"></a><span id="l53.4">   NS_DECL_ISUPPORTS</span>
<a href="#l53.5"></a><span id="l53.5"> </span>
<a href="#l53.6"></a><span id="l53.6">   bool      IsHdrParentOf(nsIMsgDBHdr *possibleParent,</span>
<a href="#l53.7"></a><span id="l53.7">                           nsIMsgDBHdr *possibleChild);</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9">   void      ChangeUnreadChildCount(int32_t delta);</span>
<a href="#l53.10"></a><span id="l53.10">   void      ChangeChildCount(int32_t delta);</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-  nsresult  AddHdr(nsIMsgDBHdr *newHdr, bool reparentChildren, </span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+  nsresult  AddHdr(nsIMsgDBHdr *newHdr, bool reparentChildren,</span>
<a href="#l53.14"></a><span id="l53.14">                    uint32_t &amp;whereInserted, nsIMsgDBHdr **outParent);</span>
<a href="#l53.15"></a><span id="l53.15">   int32_t   HdrIndex(nsIMsgDBHdr *hdr);</span>
<a href="#l53.16"></a><span id="l53.16">   uint32_t  ChildLevelAt(uint32_t msgIndex) {return m_levels[msgIndex];}</span>
<a href="#l53.17"></a><span id="l53.17">   uint32_t  MsgCount() {return m_numChildren;};</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> protected:</span>
<a href="#l53.20"></a><span id="l53.20">   virtual ~nsMsgXFViewThread();</span>
<a href="#l53.21"></a><span id="l53.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -27,20 +27,20 @@ nsMsgXFVirtualFolderDBView::nsMsgXFVirtu</span>
<a href="#l54.4"></a><span id="l54.4">   m_doingQuickSearch = false;</span>
<a href="#l54.5"></a><span id="l54.5">   m_totalMessagesInView = 0;</span>
<a href="#l54.6"></a><span id="l54.6"> }</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> nsMsgXFVirtualFolderDBView::~nsMsgXFVirtualFolderDBView()</span>
<a href="#l54.9"></a><span id="l54.9"> {</span>
<a href="#l54.10"></a><span id="l54.10"> }</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-NS_IMETHODIMP nsMsgXFVirtualFolderDBView::Open(nsIMsgFolder *folder, </span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-                                               nsMsgViewSortTypeValue sortType, </span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-                                               nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-                                               nsMsgViewFlagsTypeValue viewFlags, </span>
<a href="#l54.16"></a><span id="l54.16" class="difflineplus">+NS_IMETHODIMP nsMsgXFVirtualFolderDBView::Open(nsIMsgFolder *folder,</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+                                               nsMsgViewSortTypeValue sortType,</span>
<a href="#l54.18"></a><span id="l54.18" class="difflineplus">+                                               nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l54.19"></a><span id="l54.19" class="difflineplus">+                                               nsMsgViewFlagsTypeValue viewFlags,</span>
<a href="#l54.20"></a><span id="l54.20">                                                int32_t *pCount)</span>
<a href="#l54.21"></a><span id="l54.21"> {</span>
<a href="#l54.22"></a><span id="l54.22">   m_viewFolder = folder;</span>
<a href="#l54.23"></a><span id="l54.23">   return nsMsgSearchDBView::Open(folder, sortType, sortOrder, viewFlags, pCount);</span>
<a href="#l54.24"></a><span id="l54.24"> }</span>
<a href="#l54.25"></a><span id="l54.25"> </span>
<a href="#l54.26"></a><span id="l54.26"> void nsMsgXFVirtualFolderDBView::RemovePendingDBListeners()</span>
<a href="#l54.27"></a><span id="l54.27"> {</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineat">@@ -190,17 +190,17 @@ void nsMsgXFVirtualFolderDBView::UpdateC</span>
<a href="#l54.29"></a><span id="l54.29">     nsMsgKey *badHits;</span>
<a href="#l54.30"></a><span id="l54.30">     rv = db-&gt;RefreshCache(searchUri.get(), numNewHits, newHits,</span>
<a href="#l54.31"></a><span id="l54.31">                      &amp;numBadHits, &amp;badHits);</span>
<a href="#l54.32"></a><span id="l54.32">     if (NS_SUCCEEDED(rv))</span>
<a href="#l54.33"></a><span id="l54.33">     {</span>
<a href="#l54.34"></a><span id="l54.34">       nsCOMPtr&lt;nsIMsgDBHdr&gt; badHdr;</span>
<a href="#l54.35"></a><span id="l54.35">       for (uint32_t badHitIndex = 0; badHitIndex &lt; numBadHits; badHitIndex++)</span>
<a href="#l54.36"></a><span id="l54.36">       {</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineminus">-        // ### of course, this isn't quite right, since we should be </span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+        // ### of course, this isn't quite right, since we should be</span>
<a href="#l54.39"></a><span id="l54.39">         // using FindHdr, and we shouldn't be expanding the threads.</span>
<a href="#l54.40"></a><span id="l54.40">         db-&gt;GetMsgHdrForKey(badHits[badHitIndex], getter_AddRefs(badHdr));</span>
<a href="#l54.41"></a><span id="l54.41">         // let nsMsgSearchDBView decide what to do about this header</span>
<a href="#l54.42"></a><span id="l54.42">         // getting removed.</span>
<a href="#l54.43"></a><span id="l54.43">         if (badHdr)</span>
<a href="#l54.44"></a><span id="l54.44">           OnHdrDeleted(badHdr, nsMsgKey_None, 0, this);</span>
<a href="#l54.45"></a><span id="l54.45">       }</span>
<a href="#l54.46"></a><span id="l54.46">       delete [] badHits;</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineat">@@ -263,17 +263,17 @@ nsMsgXFVirtualFolderDBView::OnSearchHit(</span>
<a href="#l54.48"></a><span id="l54.48">     m_hdrHits.Clear();</span>
<a href="#l54.49"></a><span id="l54.49">     m_curFolderStartKeyIndex = m_keys.Length();</span>
<a href="#l54.50"></a><span id="l54.50">   }</span>
<a href="#l54.51"></a><span id="l54.51">   bool hdrInCache = false;</span>
<a href="#l54.52"></a><span id="l54.52">   nsCString searchUri;</span>
<a href="#l54.53"></a><span id="l54.53">   if (!m_doingQuickSearch)</span>
<a href="#l54.54"></a><span id="l54.54">   {</span>
<a href="#l54.55"></a><span id="l54.55">     m_viewFolder-&gt;GetURI(searchUri);</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineminus">-    dbToUse-&gt;HdrIsInCache(searchUri.get(), aMsgHdr, &amp;hdrInCache);    </span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+    dbToUse-&gt;HdrIsInCache(searchUri.get(), aMsgHdr, &amp;hdrInCache);</span>
<a href="#l54.58"></a><span id="l54.58">   }</span>
<a href="#l54.59"></a><span id="l54.59">   if (!m_doingSearch || !m_curFolderHasCachedHits || !hdrInCache)</span>
<a href="#l54.60"></a><span id="l54.60">   {</span>
<a href="#l54.61"></a><span id="l54.61">     if (m_viewFlags &amp; nsMsgViewFlagsType::kGroupBySort)</span>
<a href="#l54.62"></a><span id="l54.62">       nsMsgGroupView::OnNewHeader(aMsgHdr, nsMsgKey_None, true);</span>
<a href="#l54.63"></a><span id="l54.63">     else if (m_sortValid)</span>
<a href="#l54.64"></a><span id="l54.64">       InsertHdrFromFolder(aMsgHdr, aFolder);</span>
<a href="#l54.65"></a><span id="l54.65">     else</span>
<a href="#l54.66"></a><span id="l54.66" class="difflineat">@@ -327,17 +327,17 @@ nsMsgXFVirtualFolderDBView::OnSearchDone</span>
<a href="#l54.67"></a><span id="l54.67">     {</span>
<a href="#l54.68"></a><span id="l54.68">       if (!(m_flags[i] &amp; nsMsgMessageFlags::Read))</span>
<a href="#l54.69"></a><span id="l54.69">         numUnread++;</span>
<a href="#l54.70"></a><span id="l54.70">     }</span>
<a href="#l54.71"></a><span id="l54.71">   dbFolderInfo-&gt;SetNumUnreadMessages(numUnread);</span>
<a href="#l54.72"></a><span id="l54.72">   dbFolderInfo-&gt;SetNumMessages(m_totalMessagesInView);</span>
<a href="#l54.73"></a><span id="l54.73">   m_viewFolder-&gt;UpdateSummaryTotals(true); // force update from db.</span>
<a href="#l54.74"></a><span id="l54.74">   virtDatabase-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-  if (!m_sortValid &amp;&amp; m_sortType != nsMsgViewSortType::byThread &amp;&amp; </span>
<a href="#l54.76"></a><span id="l54.76" class="difflineplus">+  if (!m_sortValid &amp;&amp; m_sortType != nsMsgViewSortType::byThread &amp;&amp;</span>
<a href="#l54.77"></a><span id="l54.77">       !(m_viewFlags &amp; nsMsgViewFlagsType::kThreadedDisplay))</span>
<a href="#l54.78"></a><span id="l54.78">   {</span>
<a href="#l54.79"></a><span id="l54.79">     m_sortValid = false;       //sort the results</span>
<a href="#l54.80"></a><span id="l54.80">     Sort(m_sortType, m_sortOrder);</span>
<a href="#l54.81"></a><span id="l54.81">   }</span>
<a href="#l54.82"></a><span id="l54.82">   m_foldersSearchingOver.Clear();</span>
<a href="#l54.83"></a><span id="l54.83">   m_curFolderGettingHits = nullptr;</span>
<a href="#l54.84"></a><span id="l54.84">   return rv;</span>
<a href="#l54.85"></a><span id="l54.85" class="difflineat">@@ -499,13 +499,13 @@ NS_IMETHODIMP nsMsgXFVirtualFolderDBView</span>
<a href="#l54.86"></a><span id="l54.86">       (aViewFlags &amp; (nsMsgViewFlagsType::kGroupBySort |</span>
<a href="#l54.87"></a><span id="l54.87">                      nsMsgViewFlagsType::kThreadedDisplay)))</span>
<a href="#l54.88"></a><span id="l54.88">     rv = RebuildView(aViewFlags);</span>
<a href="#l54.89"></a><span id="l54.89">   nsMsgDBView::SetViewFlags(aViewFlags);</span>
<a href="#l54.90"></a><span id="l54.90">   return rv;</span>
<a href="#l54.91"></a><span id="l54.91"> }</span>
<a href="#l54.92"></a><span id="l54.92"> </span>
<a href="#l54.93"></a><span id="l54.93"> </span>
<a href="#l54.94"></a><span id="l54.94" class="difflineminus">-nsresult </span>
<a href="#l54.95"></a><span id="l54.95" class="difflineplus">+nsresult</span>
<a href="#l54.96"></a><span id="l54.96"> nsMsgXFVirtualFolderDBView::GetMessageEnumerator(nsISimpleEnumerator **enumerator)</span>
<a href="#l54.97"></a><span id="l54.97"> {</span>
<a href="#l54.98"></a><span id="l54.98">   return GetViewEnumerator(enumerator);</span>
<a href="#l54.99"></a><span id="l54.99"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgXFVirtualFolderDBView.h</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -19,27 +19,27 @@ class nsMsgXFVirtualFolderDBView : publi</span>
<a href="#l55.4"></a><span id="l55.4"> public:</span>
<a href="#l55.5"></a><span id="l55.5">   nsMsgXFVirtualFolderDBView();</span>
<a href="#l55.6"></a><span id="l55.6">   virtual ~nsMsgXFVirtualFolderDBView();</span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8">   // we override all the methods, currently. Might change...</span>
<a href="#l55.9"></a><span id="l55.9">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l55.10"></a><span id="l55.10"> </span>
<a href="#l55.11"></a><span id="l55.11">   virtual const char * GetViewName(void) override {return &quot;XFVirtualFolderView&quot;; }</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder, </span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+  NS_IMETHOD Open(nsIMsgFolder *folder, nsMsgViewSortTypeValue sortType, nsMsgViewSortOrderValue sortOrder,</span>
<a href="#l55.14"></a><span id="l55.14">         nsMsgViewFlagsTypeValue viewFlags, int32_t *pCount) override;</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow, </span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+  NS_IMETHOD CloneDBView(nsIMessenger *aMessengerInstance, nsIMsgWindow *aMsgWindow,</span>
<a href="#l55.17"></a><span id="l55.17">                          nsIMsgDBViewCommandUpdater *aCmdUpdater, nsIMsgDBView **_retval) override;</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance, </span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+  NS_IMETHOD CopyDBView(nsMsgDBView *aNewMsgDBView, nsIMessenger *aMessengerInstance,</span>
<a href="#l55.20"></a><span id="l55.20">                         nsIMsgWindow *aMsgWindow, nsIMsgDBViewCommandUpdater *aCmdUpdater) override;</span>
<a href="#l55.21"></a><span id="l55.21">   NS_IMETHOD Close() override;</span>
<a href="#l55.22"></a><span id="l55.22">   NS_IMETHOD GetViewType(nsMsgViewTypeValue *aViewType) override;</span>
<a href="#l55.23"></a><span id="l55.23">   NS_IMETHOD DoCommand(nsMsgViewCommandTypeValue command) override;</span>
<a href="#l55.24"></a><span id="l55.24">   NS_IMETHOD SetViewFlags(nsMsgViewFlagsTypeValue aViewFlags) override;</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus, </span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+  NS_IMETHOD OnHdrPropertyChanged(nsIMsgDBHdr *aHdrToChange, bool aPreChange, uint32_t *aStatus,</span>
<a href="#l55.27"></a><span id="l55.27">                                  nsIDBChangeListener * aInstigator) override;</span>
<a href="#l55.28"></a><span id="l55.28">   NS_IMETHOD GetMsgFolder(nsIMsgFolder **aMsgFolder) override;</span>
<a href="#l55.29"></a><span id="l55.29"> </span>
<a href="#l55.30"></a><span id="l55.30">   virtual nsresult OnNewHeader(nsIMsgDBHdr *newHdr, nsMsgKey parentKey, bool ensureListed) override;</span>
<a href="#l55.31"></a><span id="l55.31">   void UpdateCacheAndViewForPrevSearchedFolders(nsIMsgFolder *curSearchFolder);</span>
<a href="#l55.32"></a><span id="l55.32">   void UpdateCacheAndViewForFolder(nsIMsgFolder *folder, nsMsgKey *newHits, uint32_t numNewHits);</span>
<a href="#l55.33"></a><span id="l55.33">   void RemovePendingDBListeners();</span>
<a href="#l55.34"></a><span id="l55.34"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.cpp</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -357,17 +357,17 @@ NS_IMETHODIMP nsSpamSettings::Initialize</span>
<a href="#l56.4"></a><span id="l56.4">       accountManager(do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv));</span>
<a href="#l56.5"></a><span id="l56.5">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l56.6"></a><span id="l56.6"> </span>
<a href="#l56.7"></a><span id="l56.7">     nsCOMPtr&lt;nsIMsgAccount&gt; account;</span>
<a href="#l56.8"></a><span id="l56.8">     rv = accountManager-&gt;FindAccountForServer(aServer, getter_AddRefs(account));</span>
<a href="#l56.9"></a><span id="l56.9">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l56.10"></a><span id="l56.10"> </span>
<a href="#l56.11"></a><span id="l56.11">     nsAutoCString accountKey;</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-    if (account) </span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+    if (account)</span>
<a href="#l56.14"></a><span id="l56.14">       account-&gt;GetKey(accountKey);</span>
<a href="#l56.15"></a><span id="l56.15"> </span>
<a href="#l56.16"></a><span id="l56.16">     // Loop through all accounts, adding emails from this account, as well as</span>
<a href="#l56.17"></a><span id="l56.17">     // from any accounts that defer to this account.</span>
<a href="#l56.18"></a><span id="l56.18">     mEmails.Clear();</span>
<a href="#l56.19"></a><span id="l56.19">     nsCOMPtr&lt;nsIArray&gt; accounts;</span>
<a href="#l56.20"></a><span id="l56.20">     rv = accountManager-&gt;GetAccounts(getter_AddRefs(accounts));</span>
<a href="#l56.21"></a><span id="l56.21">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineat">@@ -526,17 +526,17 @@ NS_IMETHODIMP nsSpamSettings::GetSpamFol</span>
<a href="#l56.23"></a><span id="l56.23">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l56.24"></a><span id="l56.24"> </span>
<a href="#l56.25"></a><span id="l56.25">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l56.26"></a><span id="l56.26">   rv = folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l56.27"></a><span id="l56.27">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l56.28"></a><span id="l56.28"> </span>
<a href="#l56.29"></a><span id="l56.29">   // see nsMsgFolder::SetPrettyName() for where the pretty name is set.</span>
<a href="#l56.30"></a><span id="l56.30"> </span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-  // Check for an existing junk folder - this will do a case-insensitive </span>
<a href="#l56.32"></a><span id="l56.32" class="difflineplus">+  // Check for an existing junk folder - this will do a case-insensitive</span>
<a href="#l56.33"></a><span id="l56.33">   // search by URI - if we find a junk folder, use its URI.</span>
<a href="#l56.34"></a><span id="l56.34">   nsCOMPtr&lt;nsIMsgFolder&gt; junkFolder;</span>
<a href="#l56.35"></a><span id="l56.35">   folderURI.Append(&quot;/Junk&quot;);</span>
<a href="#l56.36"></a><span id="l56.36">   if (NS_SUCCEEDED(server-&gt;GetMsgFolderFromURI(nullptr, folderURI,</span>
<a href="#l56.37"></a><span id="l56.37">                                                getter_AddRefs(junkFolder))) &amp;&amp;</span>
<a href="#l56.38"></a><span id="l56.38">       junkFolder)</span>
<a href="#l56.39"></a><span id="l56.39">     junkFolder-&gt;GetURI(folderURI);</span>
<a href="#l56.40"></a><span id="l56.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/base/src/nsSpamSettings.h</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/base/src/nsSpamSettings.h</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -27,25 +27,25 @@ public:</span>
<a href="#l57.4"></a><span id="l57.4">   NS_DECL_NSIURLLISTENER</span>
<a href="#l57.5"></a><span id="l57.5"> </span>
<a href="#l57.6"></a><span id="l57.6"> private:</span>
<a href="#l57.7"></a><span id="l57.7">   virtual ~nsSpamSettings();</span>
<a href="#l57.8"></a><span id="l57.8"> </span>
<a href="#l57.9"></a><span id="l57.9">   nsCOMPtr &lt;nsIOutputStream&gt; mLogStream;</span>
<a href="#l57.10"></a><span id="l57.10">   nsCOMPtr&lt;nsIFile&gt; mLogFile;</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-  int32_t mLevel; </span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+  int32_t mLevel;</span>
<a href="#l57.14"></a><span id="l57.14">   int32_t mPurgeInterval;</span>
<a href="#l57.15"></a><span id="l57.15">   int32_t mMoveTargetMode;</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17">   bool mPurge;</span>
<a href="#l57.18"></a><span id="l57.18">   bool mUseWhiteList;</span>
<a href="#l57.19"></a><span id="l57.19">   bool mMoveOnSpam;</span>
<a href="#l57.20"></a><span id="l57.20">   bool mUseServerFilter;</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-  </span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+</span>
<a href="#l57.23"></a><span id="l57.23">   nsCString mActionTargetAccount;</span>
<a href="#l57.24"></a><span id="l57.24">   nsCString mActionTargetFolder;</span>
<a href="#l57.25"></a><span id="l57.25">   nsCString mWhiteListAbURI;</span>
<a href="#l57.26"></a><span id="l57.26">   nsCString mCurrentJunkFolderURI; // used to detect changes to the spam folder in ::initialize</span>
<a href="#l57.27"></a><span id="l57.27"> </span>
<a href="#l57.28"></a><span id="l57.28">   nsCString mServerFilterName;</span>
<a href="#l57.29"></a><span id="l57.29">   nsCOMPtr&lt;nsIFile&gt; mServerFilterFile;</span>
<a href="#l57.30"></a><span id="l57.30">   int32_t  mServerFilterTrustFlags;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/src/nsStatusBarBiffManager.cpp</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/src/nsStatusBarBiffManager.cpp</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -50,18 +50,18 @@ nsStatusBarBiffManager::~nsStatusBarBiff</span>
<a href="#l58.4"></a><span id="l58.4"> </span>
<a href="#l58.5"></a><span id="l58.5"> nsresult nsStatusBarBiffManager::Init()</span>
<a href="#l58.6"></a><span id="l58.6"> {</span>
<a href="#l58.7"></a><span id="l58.7">   if (mInitialized)</span>
<a href="#l58.8"></a><span id="l58.8">     return NS_ERROR_ALREADY_INITIALIZED;</span>
<a href="#l58.9"></a><span id="l58.9"> </span>
<a href="#l58.10"></a><span id="l58.10">   nsresult rv;</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = </span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv); </span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession =</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l58.16"></a><span id="l58.16">   if(NS_SUCCEEDED(rv))</span>
<a href="#l58.17"></a><span id="l58.17">     mailSession-&gt;AddFolderListener(this, nsIFolderListener::intPropertyChanged);</span>
<a href="#l58.18"></a><span id="l58.18"> </span>
<a href="#l58.19"></a><span id="l58.19">   nsCOMPtr&lt;nsIPrefBranch&gt; pref(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l58.20"></a><span id="l58.20">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.21"></a><span id="l58.21"> </span>
<a href="#l58.22"></a><span id="l58.22">   bool chatEnabled = false;</span>
<a href="#l58.23"></a><span id="l58.23">   if (NS_SUCCEEDED(rv))</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineat">@@ -151,82 +151,82 @@ nsresult nsStatusBarBiffManager::PlayBif</span>
<a href="#l58.25"></a><span id="l58.25">     rv = mSound-&gt;PlayEventSound(nsISound::EVENT_NEW_MAIL_RECEIVED);</span>
<a href="#l58.26"></a><span id="l58.26">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l58.27"></a><span id="l58.27">   }</span>
<a href="#l58.28"></a><span id="l58.28"> #endif</span>
<a href="#l58.29"></a><span id="l58.29">   return rv;</span>
<a href="#l58.30"></a><span id="l58.30"> }</span>
<a href="#l58.31"></a><span id="l58.31"> </span>
<a href="#l58.32"></a><span id="l58.32"> // nsIFolderListener methods....</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.35"></a><span id="l58.35"> nsStatusBarBiffManager::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l58.36"></a><span id="l58.36"> {</span>
<a href="#l58.37"></a><span id="l58.37">   return NS_OK;</span>
<a href="#l58.38"></a><span id="l58.38"> }</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.41"></a><span id="l58.41" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.42"></a><span id="l58.42"> nsStatusBarBiffManager::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l58.43"></a><span id="l58.43"> {</span>
<a href="#l58.44"></a><span id="l58.44">   return NS_OK;</span>
<a href="#l58.45"></a><span id="l58.45"> }</span>
<a href="#l58.46"></a><span id="l58.46"> </span>
<a href="#l58.47"></a><span id="l58.47" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.48"></a><span id="l58.48" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.49"></a><span id="l58.49"> nsStatusBarBiffManager::OnItemPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char *oldValue, const char *newValue)</span>
<a href="#l58.50"></a><span id="l58.50"> {</span>
<a href="#l58.51"></a><span id="l58.51">   return NS_OK;</span>
<a href="#l58.52"></a><span id="l58.52"> }</span>
<a href="#l58.53"></a><span id="l58.53"> </span>
<a href="#l58.54"></a><span id="l58.54"> NS_IMETHODIMP</span>
<a href="#l58.55"></a><span id="l58.55"> nsStatusBarBiffManager::OnItemIntPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, int64_t oldValue, int64_t newValue)</span>
<a href="#l58.56"></a><span id="l58.56"> {</span>
<a href="#l58.57"></a><span id="l58.57">   if (property.Equals(kBiffState) &amp;&amp; mCurrentBiffState != newValue) {</span>
<a href="#l58.58"></a><span id="l58.58">     // if we got new mail, attempt to play a sound.</span>
<a href="#l58.59"></a><span id="l58.59">     // if we fail along the way, don't return.</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-    // we still need to update the UI.    </span>
<a href="#l58.61"></a><span id="l58.61" class="difflineplus">+    // we still need to update the UI.</span>
<a href="#l58.62"></a><span id="l58.62">     if (newValue == nsIMsgFolder::nsMsgBiffState_NewMail) {</span>
<a href="#l58.63"></a><span id="l58.63">       // Get the folder's server type.</span>
<a href="#l58.64"></a><span id="l58.64">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l58.65"></a><span id="l58.65">       nsresult rv = item-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l58.66"></a><span id="l58.66">       if (NS_SUCCEEDED(rv) &amp;&amp; server)</span>
<a href="#l58.67"></a><span id="l58.67">         server-&gt;GetType(mServerType);</span>
<a href="#l58.68"></a><span id="l58.68"> </span>
<a href="#l58.69"></a><span id="l58.69">       // if we fail to play the biff sound, keep going.</span>
<a href="#l58.70"></a><span id="l58.70">       (void)PlayBiffSound(NEW_MAIL_PREF_BRANCH);</span>
<a href="#l58.71"></a><span id="l58.71">     }</span>
<a href="#l58.72"></a><span id="l58.72">     mCurrentBiffState = newValue;</span>
<a href="#l58.73"></a><span id="l58.73"> </span>
<a href="#l58.74"></a><span id="l58.74">     // don't care if notification fails</span>
<a href="#l58.75"></a><span id="l58.75">     nsCOMPtr&lt;nsIObserverService&gt; observerService =</span>
<a href="#l58.76"></a><span id="l58.76">       mozilla::services::GetObserverService();</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-      </span>
<a href="#l58.78"></a><span id="l58.78" class="difflineplus">+</span>
<a href="#l58.79"></a><span id="l58.79">     if (observerService)</span>
<a href="#l58.80"></a><span id="l58.80">       observerService-&gt;NotifyObservers(static_cast&lt;nsIStatusBarBiffManager*&gt;(this), &quot;mail:biff-state-changed&quot;, nullptr);</span>
<a href="#l58.81"></a><span id="l58.81">   }</span>
<a href="#l58.82"></a><span id="l58.82">   return NS_OK;</span>
<a href="#l58.83"></a><span id="l58.83"> }</span>
<a href="#l58.84"></a><span id="l58.84"> </span>
<a href="#l58.85"></a><span id="l58.85" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.86"></a><span id="l58.86" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.87"></a><span id="l58.87"> nsStatusBarBiffManager::OnItemBoolPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, bool oldValue, bool newValue)</span>
<a href="#l58.88"></a><span id="l58.88"> {</span>
<a href="#l58.89"></a><span id="l58.89">   return NS_OK;</span>
<a href="#l58.90"></a><span id="l58.90"> }</span>
<a href="#l58.91"></a><span id="l58.91"> </span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.93"></a><span id="l58.93" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.94"></a><span id="l58.94"> nsStatusBarBiffManager::OnItemUnicharPropertyChanged(nsIMsgFolder *item, const nsACString &amp;property, const char16_t *oldValue, const char16_t *newValue)</span>
<a href="#l58.95"></a><span id="l58.95"> {</span>
<a href="#l58.96"></a><span id="l58.96">   return NS_OK;</span>
<a href="#l58.97"></a><span id="l58.97"> }</span>
<a href="#l58.98"></a><span id="l58.98"> </span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.100"></a><span id="l58.100" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.101"></a><span id="l58.101"> nsStatusBarBiffManager::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, const nsACString &amp;property, uint32_t oldFlag, uint32_t newFlag)</span>
<a href="#l58.102"></a><span id="l58.102"> {</span>
<a href="#l58.103"></a><span id="l58.103">   return NS_OK;</span>
<a href="#l58.104"></a><span id="l58.104"> }</span>
<a href="#l58.105"></a><span id="l58.105"> </span>
<a href="#l58.106"></a><span id="l58.106" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l58.108"></a><span id="l58.108"> nsStatusBarBiffManager::OnItemEvent(nsIMsgFolder *item, const nsACString &amp;event)</span>
<a href="#l58.109"></a><span id="l58.109"> {</span>
<a href="#l58.110"></a><span id="l58.110">   return NS_OK;</span>
<a href="#l58.111"></a><span id="l58.111"> }</span>
<a href="#l58.112"></a><span id="l58.112"> </span>
<a href="#l58.113"></a><span id="l58.113"> // nsIObserver implementation</span>
<a href="#l58.114"></a><span id="l58.114"> NS_IMETHODIMP</span>
<a href="#l58.115"></a><span id="l58.115"> nsStatusBarBiffManager::Observe(nsISupports *aSubject,</span>
<a href="#l58.116"></a><span id="l58.116" class="difflineat">@@ -239,9 +239,9 @@ nsStatusBarBiffManager::Observe(nsISuppo</span>
<a href="#l58.117"></a><span id="l58.117"> // nsIStatusBarBiffManager method....</span>
<a href="#l58.118"></a><span id="l58.118"> NS_IMETHODIMP</span>
<a href="#l58.119"></a><span id="l58.119"> nsStatusBarBiffManager::GetBiffState(int32_t *aBiffState)</span>
<a href="#l58.120"></a><span id="l58.120"> {</span>
<a href="#l58.121"></a><span id="l58.121">   NS_ENSURE_ARG_POINTER(aBiffState);</span>
<a href="#l58.122"></a><span id="l58.122">   *aBiffState = mCurrentBiffState;</span>
<a href="#l58.123"></a><span id="l58.123">   return NS_OK;</span>
<a href="#l58.124"></a><span id="l58.124"> }</span>
<a href="#l58.125"></a><span id="l58.125" class="difflineminus">- </span>
<a href="#l58.126"></a><span id="l58.126" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/src/nsStatusBarBiffManager.h</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/src/nsStatusBarBiffManager.h</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -17,17 +17,17 @@ class nsStatusBarBiffManager : public ns</span>
<a href="#l59.4"></a><span id="l59.4">                                public nsIObserver</span>
<a href="#l59.5"></a><span id="l59.5"> {</span>
<a href="#l59.6"></a><span id="l59.6"> public:</span>
<a href="#l59.7"></a><span id="l59.7">   NS_DECL_ISUPPORTS</span>
<a href="#l59.8"></a><span id="l59.8">   NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l59.9"></a><span id="l59.9">   NS_DECL_NSISTATUSBARBIFFMANAGER</span>
<a href="#l59.10"></a><span id="l59.10">   NS_DECL_NSIOBSERVER</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-  nsStatusBarBiffManager(); </span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+  nsStatusBarBiffManager();</span>
<a href="#l59.14"></a><span id="l59.14">   nsresult Init();</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16"> private:</span>
<a href="#l59.17"></a><span id="l59.17">   virtual ~nsStatusBarBiffManager();</span>
<a href="#l59.18"></a><span id="l59.18"> </span>
<a href="#l59.19"></a><span id="l59.19">   bool     mInitialized;</span>
<a href="#l59.20"></a><span id="l59.20">   int32_t  mCurrentBiffState;</span>
<a href="#l59.21"></a><span id="l59.21">   nsCString mServerType;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.cpp</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -597,17 +597,17 @@ nsSubscribableServer::FindAndCreateNode(</span>
<a href="#l60.4"></a><span id="l60.4">   delimstr[0] = mDelimiter;</span>
<a href="#l60.5"></a><span id="l60.5">   delimstr[1] = '\0';</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7">   *aResult = nullptr;</span>
<a href="#l60.8"></a><span id="l60.8"> </span>
<a href="#l60.9"></a><span id="l60.9">   SubscribeTreeNode *parent = mTreeRoot;</span>
<a href="#l60.10"></a><span id="l60.10">   SubscribeTreeNode *child = nullptr;</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  token = NS_strtok(delimstr, &amp;rest); </span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  token = NS_strtok(delimstr, &amp;rest);</span>
<a href="#l60.14"></a><span id="l60.14">   // special case paths that start with the hierarchy delimiter.</span>
<a href="#l60.15"></a><span id="l60.15">   // We want to include that delimiter in the first token name.</span>
<a href="#l60.16"></a><span id="l60.16">   if (token &amp;&amp; pathStr[0] == mDelimiter)</span>
<a href="#l60.17"></a><span id="l60.17">     --token;</span>
<a href="#l60.18"></a><span id="l60.18">   while (token &amp;&amp; *token) {</span>
<a href="#l60.19"></a><span id="l60.19">     rv = AddChildNode(parent, token, &amp;child);</span>
<a href="#l60.20"></a><span id="l60.20">     if (NS_FAILED(rv))</span>
<a href="#l60.21"></a><span id="l60.21">       return rv;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribableServer.h</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -39,17 +39,17 @@ class nsSubscribableServer : public nsIS</span>
<a href="#l61.4"></a><span id="l61.4"> {</span>
<a href="#l61.5"></a><span id="l61.5">  public:</span>
<a href="#l61.6"></a><span id="l61.6">   nsSubscribableServer();</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8">   nsresult Init();</span>
<a href="#l61.9"></a><span id="l61.9"> </span>
<a href="#l61.10"></a><span id="l61.10">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l61.11"></a><span id="l61.11">   NS_DECL_NSISUBSCRIBABLESERVER</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  </span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+</span>
<a href="#l61.14"></a><span id="l61.14"> private:</span>
<a href="#l61.15"></a><span id="l61.15">   virtual ~nsSubscribableServer();</span>
<a href="#l61.16"></a><span id="l61.16"> </span>
<a href="#l61.17"></a><span id="l61.17">   nsresult ConvertNameToUnichar(const char *inStr, char16_t **outStr);</span>
<a href="#l61.18"></a><span id="l61.18">   nsCOMPtr &lt;nsISubscribeListener&gt; mSubscribeListener;</span>
<a href="#l61.19"></a><span id="l61.19">   nsCString mIncomingServerUri;</span>
<a href="#l61.20"></a><span id="l61.20">   nsCOMPtr &lt;nsISubscribeDataSource&gt; mSubscribeDS;</span>
<a href="#l61.21"></a><span id="l61.21">   char mDelimiter;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribeDataSource.cpp</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribeDataSource.cpp</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -26,17 +26,17 @@ static NS_DEFINE_CID(kRDFServiceCID, NS_</span>
<a href="#l62.4"></a><span id="l62.4"> nsSubscribeDataSource::nsSubscribeDataSource()</span>
<a href="#l62.5"></a><span id="l62.5"> {</span>
<a href="#l62.6"></a><span id="l62.6"> }</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> nsSubscribeDataSource::~nsSubscribeDataSource()</span>
<a href="#l62.9"></a><span id="l62.9"> {</span>
<a href="#l62.10"></a><span id="l62.10"> }</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-NS_IMPL_ISUPPORTS(nsSubscribeDataSource, nsIRDFDataSource, nsISubscribeDataSource) </span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+NS_IMPL_ISUPPORTS(nsSubscribeDataSource, nsIRDFDataSource, nsISubscribeDataSource)</span>
<a href="#l62.14"></a><span id="l62.14"> </span>
<a href="#l62.15"></a><span id="l62.15"> nsresult</span>
<a href="#l62.16"></a><span id="l62.16"> nsSubscribeDataSource::Init()</span>
<a href="#l62.17"></a><span id="l62.17"> {</span>
<a href="#l62.18"></a><span id="l62.18">     nsresult rv;</span>
<a href="#l62.19"></a><span id="l62.19"> </span>
<a href="#l62.20"></a><span id="l62.20">     mRDFService = do_GetService(kRDFServiceCID, &amp;rv);</span>
<a href="#l62.21"></a><span id="l62.21">     NS_ASSERTION(NS_SUCCEEDED(rv) &amp;&amp; mRDFService, &quot;failed to get rdf service&quot;);</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -70,26 +70,26 @@ nsSubscribeDataSource::Init()</span>
<a href="#l62.23"></a><span id="l62.23">     rv = mRDFService-&gt;GetLiteral(u&quot;true&quot;, getter_AddRefs(kTrueLiteral));</span>
<a href="#l62.24"></a><span id="l62.24">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.25"></a><span id="l62.25"> </span>
<a href="#l62.26"></a><span id="l62.26">     rv = mRDFService-&gt;GetLiteral(u&quot;false&quot;, getter_AddRefs(kFalseLiteral));</span>
<a href="#l62.27"></a><span id="l62.27">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.28"></a><span id="l62.28"> 	return NS_OK;</span>
<a href="#l62.29"></a><span id="l62.29"> }</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l62.32"></a><span id="l62.32" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.33"></a><span id="l62.33"> nsSubscribeDataSource::GetURI(char * *aURI)</span>
<a href="#l62.34"></a><span id="l62.34"> {</span>
<a href="#l62.35"></a><span id="l62.35">   if ((*aURI = strdup(&quot;rdf:subscribe&quot;)) == nullptr)</span>
<a href="#l62.36"></a><span id="l62.36">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l62.37"></a><span id="l62.37">   else</span>
<a href="#l62.38"></a><span id="l62.38">     return NS_OK;</span>
<a href="#l62.39"></a><span id="l62.39"> }</span>
<a href="#l62.40"></a><span id="l62.40"> </span>
<a href="#l62.41"></a><span id="l62.41" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l62.42"></a><span id="l62.42" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.43"></a><span id="l62.43"> nsSubscribeDataSource::GetSource(nsIRDFResource *property, nsIRDFNode *target, bool tv, nsIRDFResource **source)</span>
<a href="#l62.44"></a><span id="l62.44"> {</span>
<a href="#l62.45"></a><span id="l62.45">     NS_PRECONDITION(property != nullptr, &quot;null ptr&quot;);</span>
<a href="#l62.46"></a><span id="l62.46">     if (! property)</span>
<a href="#l62.47"></a><span id="l62.47">         return NS_ERROR_NULL_POINTER;</span>
<a href="#l62.48"></a><span id="l62.48"> </span>
<a href="#l62.49"></a><span id="l62.49">     NS_PRECONDITION(target != nullptr, &quot;null ptr&quot;);</span>
<a href="#l62.50"></a><span id="l62.50">     if (! target)</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineat">@@ -148,24 +148,24 @@ nsSubscribeDataSource::GetTarget(nsIRDFR</span>
<a href="#l62.52"></a><span id="l62.52">         nsCString childUri;</span>
<a href="#l62.53"></a><span id="l62.53">         rv = server-&gt;GetFirstChildURI(relativePath, childUri);</span>
<a href="#l62.54"></a><span id="l62.54">         if (NS_FAILED(rv)) return NS_RDF_NO_VALUE;</span>
<a href="#l62.55"></a><span id="l62.55">         if (childUri.IsEmpty()) return NS_RDF_NO_VALUE;</span>
<a href="#l62.56"></a><span id="l62.56"> </span>
<a href="#l62.57"></a><span id="l62.57">         nsCOMPtr &lt;nsIRDFResource&gt; childResource;</span>
<a href="#l62.58"></a><span id="l62.58">         rv = mRDFService-&gt;GetResource(childUri, getter_AddRefs(childResource));</span>
<a href="#l62.59"></a><span id="l62.59">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineminus">-        </span>
<a href="#l62.61"></a><span id="l62.61" class="difflineplus">+</span>
<a href="#l62.62"></a><span id="l62.62">         return childResource-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l62.63"></a><span id="l62.63">     }</span>
<a href="#l62.64"></a><span id="l62.64">     else if (property == kNC_Subscribed.get()) {</span>
<a href="#l62.65"></a><span id="l62.65">         bool isSubscribed;</span>
<a href="#l62.66"></a><span id="l62.66">         rv = server-&gt;IsSubscribed(relativePath, &amp;isSubscribed);</span>
<a href="#l62.67"></a><span id="l62.67">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineminus">-    </span>
<a href="#l62.69"></a><span id="l62.69" class="difflineplus">+</span>
<a href="#l62.70"></a><span id="l62.70">         NS_IF_ADDREF(*target = isSubscribed ? kTrueLiteral : kFalseLiteral);</span>
<a href="#l62.71"></a><span id="l62.71">         return NS_OK;</span>
<a href="#l62.72"></a><span id="l62.72">     }</span>
<a href="#l62.73"></a><span id="l62.73">     else if (property == kNC_Subscribable.get()) {</span>
<a href="#l62.74"></a><span id="l62.74">         bool isSubscribable;</span>
<a href="#l62.75"></a><span id="l62.75">         rv = server-&gt;IsSubscribable(relativePath, &amp;isSubscribable);</span>
<a href="#l62.76"></a><span id="l62.76">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.77"></a><span id="l62.77"> </span>
<a href="#l62.78"></a><span id="l62.78" class="difflineat">@@ -179,25 +179,25 @@ nsSubscribeDataSource::GetTarget(nsIRDFR</span>
<a href="#l62.79"></a><span id="l62.79"> </span>
<a href="#l62.80"></a><span id="l62.80">         nsCOMPtr&lt;nsIRDFLiteral&gt; serverType;</span>
<a href="#l62.81"></a><span id="l62.81">         rv = mRDFService-&gt;GetLiteral(NS_ConvertASCIItoUTF16(serverTypeStr).get(),</span>
<a href="#l62.82"></a><span id="l62.82">                                      getter_AddRefs(serverType));</span>
<a href="#l62.83"></a><span id="l62.83">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.84"></a><span id="l62.84"> </span>
<a href="#l62.85"></a><span id="l62.85">         if (!serverType)</span>
<a href="#l62.86"></a><span id="l62.86">           rv = NS_RDF_NO_VALUE;</span>
<a href="#l62.87"></a><span id="l62.87" class="difflineminus">-        if (rv == NS_RDF_NO_VALUE) </span>
<a href="#l62.88"></a><span id="l62.88" class="difflineplus">+        if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l62.89"></a><span id="l62.89">           return rv;</span>
<a href="#l62.90"></a><span id="l62.90">         return serverType-&gt;QueryInterface(NS_GET_IID(nsIRDFNode), (void**) target);</span>
<a href="#l62.91"></a><span id="l62.91">     }</span>
<a href="#l62.92"></a><span id="l62.92">     else if (property == kNC_LeafName.get()) {</span>
<a href="#l62.93"></a><span id="l62.93">         nsString leafNameStr;</span>
<a href="#l62.94"></a><span id="l62.94" class="difflineminus">-        rv = server-&gt;GetLeafName(relativePath, leafNameStr); </span>
<a href="#l62.95"></a><span id="l62.95" class="difflineplus">+        rv = server-&gt;GetLeafName(relativePath, leafNameStr);</span>
<a href="#l62.96"></a><span id="l62.96">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineminus">-   </span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+</span>
<a href="#l62.99"></a><span id="l62.99">         nsCOMPtr&lt;nsIRDFLiteral&gt; leafName;</span>
<a href="#l62.100"></a><span id="l62.100">         rv = mRDFService-&gt;GetLiteral(leafNameStr.get(), getter_AddRefs(leafName));</span>
<a href="#l62.101"></a><span id="l62.101">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.102"></a><span id="l62.102"> </span>
<a href="#l62.103"></a><span id="l62.103">         if (!leafName)</span>
<a href="#l62.104"></a><span id="l62.104">           rv = NS_RDF_NO_VALUE;</span>
<a href="#l62.105"></a><span id="l62.105">         if (rv == NS_RDF_NO_VALUE)</span>
<a href="#l62.106"></a><span id="l62.106">           return rv;</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineat">@@ -249,17 +249,17 @@ nsSubscribeDataSource::GetTargets(nsIRDF</span>
<a href="#l62.108"></a><span id="l62.108">             return NS_NewEmptyEnumerator(targets);</span>
<a href="#l62.109"></a><span id="l62.109">         }</span>
<a href="#l62.110"></a><span id="l62.110">         return rv;</span>
<a href="#l62.111"></a><span id="l62.111">     }</span>
<a href="#l62.112"></a><span id="l62.112">     else if (property == kNC_LeafName.get()) {</span>
<a href="#l62.113"></a><span id="l62.113">         nsString leafNameStr;</span>
<a href="#l62.114"></a><span id="l62.114">         rv = server-&gt;GetLeafName(relativePath, leafNameStr);</span>
<a href="#l62.115"></a><span id="l62.115">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineminus">-    </span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+</span>
<a href="#l62.118"></a><span id="l62.118">         nsCOMPtr&lt;nsIRDFLiteral&gt; leafName;</span>
<a href="#l62.119"></a><span id="l62.119">         rv = mRDFService-&gt;GetLiteral(leafNameStr.get(), getter_AddRefs(leafName));</span>
<a href="#l62.120"></a><span id="l62.120">         NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.121"></a><span id="l62.121"> </span>
<a href="#l62.122"></a><span id="l62.122">         return NS_NewSingletonEnumerator(targets, leafName);</span>
<a href="#l62.123"></a><span id="l62.123">     }</span>
<a href="#l62.124"></a><span id="l62.124">     else if (property == kNC_Subscribed.get()) {</span>
<a href="#l62.125"></a><span id="l62.125">         bool isSubscribed;</span>
<a href="#l62.126"></a><span id="l62.126" class="difflineat">@@ -374,22 +374,22 @@ nsSubscribeDataSource::GetServerAndRelat</span>
<a href="#l62.127"></a><span id="l62.127">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.128"></a><span id="l62.128"> </span>
<a href="#l62.129"></a><span id="l62.129">     rv = incomingServer-&gt;QueryInterface(NS_GET_IID(nsISubscribableServer), (void**)server);</span>
<a href="#l62.130"></a><span id="l62.130">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.131"></a><span id="l62.131"> </span>
<a href="#l62.132"></a><span id="l62.132">     nsCString serverURI;</span>
<a href="#l62.133"></a><span id="l62.133">     rv = incomingServer-&gt;GetServerURI(serverURI);</span>
<a href="#l62.134"></a><span id="l62.134">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineminus">- </span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+</span>
<a href="#l62.137"></a><span id="l62.137">     uint32_t serverURILen = serverURI.Length();</span>
<a href="#l62.138"></a><span id="l62.138">     if (serverURILen == strlen(sourceURI))</span>
<a href="#l62.139"></a><span id="l62.139">       *relativePath = nullptr;</span>
<a href="#l62.140"></a><span id="l62.140">     else {</span>
<a href="#l62.141"></a><span id="l62.141" class="difflineminus">-      // XXX : perhaps, have to unescape before returning </span>
<a href="#l62.142"></a><span id="l62.142" class="difflineplus">+      // XXX : perhaps, have to unescape before returning</span>
<a href="#l62.143"></a><span id="l62.143">       *relativePath = strdup(sourceURI + serverURILen + 1);</span>
<a href="#l62.144"></a><span id="l62.144">       if (!*relativePath)</span>
<a href="#l62.145"></a><span id="l62.145">         return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l62.146"></a><span id="l62.146">     }</span>
<a href="#l62.147"></a><span id="l62.147"> </span>
<a href="#l62.148"></a><span id="l62.148">     return NS_OK;</span>
<a href="#l62.149"></a><span id="l62.149"> }</span>
<a href="#l62.150"></a><span id="l62.150"> </span>
<a href="#l62.151"></a><span id="l62.151" class="difflineat">@@ -460,23 +460,23 @@ nsSubscribeDataSource::HasAssertion(nsIR</span>
<a href="#l62.152"></a><span id="l62.152">     else {</span>
<a href="#l62.153"></a><span id="l62.153">         // do nothing</span>
<a href="#l62.154"></a><span id="l62.154">     }</span>
<a href="#l62.155"></a><span id="l62.155"> </span>
<a href="#l62.156"></a><span id="l62.156"> 	return NS_OK;</span>
<a href="#l62.157"></a><span id="l62.157"> }</span>
<a href="#l62.158"></a><span id="l62.158"> </span>
<a href="#l62.159"></a><span id="l62.159"> </span>
<a href="#l62.160"></a><span id="l62.160" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l62.161"></a><span id="l62.161" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.162"></a><span id="l62.162"> nsSubscribeDataSource::HasArcIn(nsIRDFNode *aNode, nsIRDFResource *aArc, bool *result)</span>
<a href="#l62.163"></a><span id="l62.163"> {</span>
<a href="#l62.164"></a><span id="l62.164">     return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l62.165"></a><span id="l62.165"> }</span>
<a href="#l62.166"></a><span id="l62.166"> </span>
<a href="#l62.167"></a><span id="l62.167" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l62.168"></a><span id="l62.168" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.169"></a><span id="l62.169"> nsSubscribeDataSource::HasArcOut(nsIRDFResource *source, nsIRDFResource *aArc, bool *result)</span>
<a href="#l62.170"></a><span id="l62.170"> {</span>
<a href="#l62.171"></a><span id="l62.171">     nsresult rv = NS_OK;</span>
<a href="#l62.172"></a><span id="l62.172"> </span>
<a href="#l62.173"></a><span id="l62.173">     nsCOMPtr&lt;nsISubscribableServer&gt; server;</span>
<a href="#l62.174"></a><span id="l62.174">     nsCString relativePath;</span>
<a href="#l62.175"></a><span id="l62.175"> </span>
<a href="#l62.176"></a><span id="l62.176">     if (aArc == kNC_Child.get()) {</span>
<a href="#l62.177"></a><span id="l62.177" class="difflineat">@@ -631,17 +631,17 @@ nsSubscribeDataSource::BeginUpdateBatch(</span>
<a href="#l62.178"></a><span id="l62.178"> NS_IMETHODIMP</span>
<a href="#l62.179"></a><span id="l62.179"> nsSubscribeDataSource::EndUpdateBatch()</span>
<a href="#l62.180"></a><span id="l62.180"> {</span>
<a href="#l62.181"></a><span id="l62.181">         return NS_OK;</span>
<a href="#l62.182"></a><span id="l62.182"> }</span>
<a href="#l62.183"></a><span id="l62.183"> </span>
<a href="#l62.184"></a><span id="l62.184"> </span>
<a href="#l62.185"></a><span id="l62.185"> </span>
<a href="#l62.186"></a><span id="l62.186" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l62.187"></a><span id="l62.187" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l62.188"></a><span id="l62.188"> nsSubscribeDataSource::GetSources(nsIRDFResource *aProperty, nsIRDFNode *aTarget, bool aTruthValue, nsISimpleEnumerator **_retval)</span>
<a href="#l62.189"></a><span id="l62.189"> {</span>
<a href="#l62.190"></a><span id="l62.190">   NS_ASSERTION(false, &quot;Not implemented&quot;);</span>
<a href="#l62.191"></a><span id="l62.191">   return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l62.192"></a><span id="l62.192"> }</span>
<a href="#l62.193"></a><span id="l62.193"> </span>
<a href="#l62.194"></a><span id="l62.194"> #define NOTIFY_SUBSCRIBE_LISTENERS(propertyfunc_, params_) \</span>
<a href="#l62.195"></a><span id="l62.195">   PR_BEGIN_MACRO \</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/base/src/nsSubscribeDataSource.h</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/base/src/nsSubscribeDataSource.h</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -27,17 +27,17 @@ public:</span>
<a href="#l63.4"></a><span id="l63.4"> </span>
<a href="#l63.5"></a><span id="l63.5">   NS_DECL_THREADSAFE_ISUPPORTS</span>
<a href="#l63.6"></a><span id="l63.6">   NS_DECL_NSIRDFDATASOURCE</span>
<a href="#l63.7"></a><span id="l63.7">   NS_DECL_NSISUBSCRIBEDATASOURCE</span>
<a href="#l63.8"></a><span id="l63.8"> </span>
<a href="#l63.9"></a><span id="l63.9"> private:</span>
<a href="#l63.10"></a><span id="l63.10">   virtual ~nsSubscribeDataSource();</span>
<a href="#l63.11"></a><span id="l63.11">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Child;</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Name;    </span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+  nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Name;</span>
<a href="#l63.14"></a><span id="l63.14">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_LeafName;</span>
<a href="#l63.15"></a><span id="l63.15">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribed;</span>
<a href="#l63.16"></a><span id="l63.16">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_Subscribable;</span>
<a href="#l63.17"></a><span id="l63.17">   nsCOMPtr &lt;nsIRDFResource&gt;      kNC_ServerType;</span>
<a href="#l63.18"></a><span id="l63.18">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kTrueLiteral;</span>
<a href="#l63.19"></a><span id="l63.19">   nsCOMPtr &lt;nsIRDFLiteral&gt;       kFalseLiteral;</span>
<a href="#l63.20"></a><span id="l63.20"> </span>
<a href="#l63.21"></a><span id="l63.21">   nsCOMPtr &lt;nsIRDFService&gt;       mRDFService;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/base/test/TestMsgStripRE.cpp</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/base/test/TestMsgStripRE.cpp</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -24,17 +24,17 @@ testStripRe(const char *encodedInput, ch</span>
<a href="#l64.4"></a><span id="l64.4">             bool expectedDidModify)</span>
<a href="#l64.5"></a><span id="l64.5"> {</span>
<a href="#l64.6"></a><span id="l64.6">   // call NS_StripRE with the appropriate args</span>
<a href="#l64.7"></a><span id="l64.7">   char *modifiedSubject;</span>
<a href="#l64.8"></a><span id="l64.8">   bool didModify;</span>
<a href="#l64.9"></a><span id="l64.9">   const char *encodedInout = encodedInput;</span>
<a href="#l64.10"></a><span id="l64.10">   uint32_t length = strlen(encodedInout);</span>
<a href="#l64.11"></a><span id="l64.11">   didModify = NS_MsgStripRE(&amp;encodedInout, &amp;length, &amp;modifiedSubject);</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-  </span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+</span>
<a href="#l64.14"></a><span id="l64.14">   // make sure we got the right results</span>
<a href="#l64.15"></a><span id="l64.15">   if (didModify != expectedDidModify)</span>
<a href="#l64.16"></a><span id="l64.16">     return 2;</span>
<a href="#l64.17"></a><span id="l64.17"> </span>
<a href="#l64.18"></a><span id="l64.18">   if (didModify) {</span>
<a href="#l64.19"></a><span id="l64.19">     if (strcmp(expectedOutput, modifiedSubject)) {</span>
<a href="#l64.20"></a><span id="l64.20">       return 3;</span>
<a href="#l64.21"></a><span id="l64.21">     }</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineat">@@ -55,42 +55,42 @@ int main(int argc, char** argv)</span>
<a href="#l64.23"></a><span id="l64.23">   if (xpcom.failed())</span>
<a href="#l64.24"></a><span id="l64.24">     return 1;</span>
<a href="#l64.25"></a><span id="l64.25"> </span>
<a href="#l64.26"></a><span id="l64.26">   nsresult rv;</span>
<a href="#l64.27"></a><span id="l64.27">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID,</span>
<a href="#l64.28"></a><span id="l64.28">                                      &amp;rv));</span>
<a href="#l64.29"></a><span id="l64.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.30"></a><span id="l64.30"> </span>
<a href="#l64.31"></a><span id="l64.31" class="difflineminus">-  // create an nsISupportsString and stuff our literal into it   </span>
<a href="#l64.32"></a><span id="l64.32" class="difflineminus">-  nsCOMPtr&lt;nsISupportsString&gt; rePrefixes = </span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  // create an nsISupportsString and stuff our literal into it</span>
<a href="#l64.34"></a><span id="l64.34" class="difflineplus">+  nsCOMPtr&lt;nsISupportsString&gt; rePrefixes =</span>
<a href="#l64.35"></a><span id="l64.35">     do_CreateInstance(&quot;@mozilla.org/supports-string;1&quot;, &amp;rv);</span>
<a href="#l64.36"></a><span id="l64.36">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.37"></a><span id="l64.37"> </span>
<a href="#l64.38"></a><span id="l64.38">   // portable C++ expression of &quot;SV,&quot;</span>
<a href="#l64.39"></a><span id="l64.39">   static const unsigned char utf8Prefixes[] =</span>
<a href="#l64.40"></a><span id="l64.40">     {'S', 'V', ',', 0303, 0206, 0303, 0230, 0303, 0205, '\0'};</span>
<a href="#l64.41"></a><span id="l64.41"> </span>
<a href="#l64.42"></a><span id="l64.42">   rv = rePrefixes-&gt;SetData(NS_ConvertUTF8toUTF16(utf8Prefixes));</span>
<a href="#l64.43"></a><span id="l64.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45">   // set localizedRe pref</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineminus">-  rv = prefBranch-&gt;SetComplexValue(&quot;mailnews.localizedRe&quot;, </span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+  rv = prefBranch-&gt;SetComplexValue(&quot;mailnews.localizedRe&quot;,</span>
<a href="#l64.48"></a><span id="l64.48">                                    NS_GET_IID(nsISupportsString), rePrefixes);</span>
<a href="#l64.49"></a><span id="l64.49">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l64.50"></a><span id="l64.50"> </span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-  // run our tests </span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+  // run our tests</span>
<a href="#l64.53"></a><span id="l64.53">   struct testInfo testInfoStructs[] = {</span>
<a href="#l64.54"></a><span id="l64.54">     {&quot;SV: =?ISO-8859-1?Q?=C6blegr=F8d?=&quot;, &quot;=?ISO-8859-1?Q?=C6blegr=F8d?=&quot;,</span>
<a href="#l64.55"></a><span id="l64.55">      true},</span>
<a href="#l64.56"></a><span id="l64.56">     {&quot;=?ISO-8859-1?Q?SV=3A=C6blegr=F8d?=&quot;, &quot;=?ISO-8859-1?Q?=C6blegr=F8d?=&quot;,</span>
<a href="#l64.57"></a><span id="l64.57">      true},</span>
<a href="#l64.58"></a><span id="l64.58"> </span>
<a href="#l64.59"></a><span id="l64.59">      // Note that in the next two tests, the only ISO-8859-1 chars are in the</span>
<a href="#l64.60"></a><span id="l64.60" class="difflineminus">-     // localizedRe piece, so once they've been stripped, the re-encoding process </span>
<a href="#l64.61"></a><span id="l64.61" class="difflineplus">+     // localizedRe piece, so once they've been stripped, the re-encoding process</span>
<a href="#l64.62"></a><span id="l64.62">      // simply writes out ASCII rather than an ISO-8859-1 encoded string with</span>
<a href="#l64.63"></a><span id="l64.63">      // no actual ISO-8859-1 special characters, which seems reasonable.</span>
<a href="#l64.64"></a><span id="l64.64">     {&quot;=?ISO-8859-1?Q?=C6=D8=C5=3A_Foo_bar?=&quot;, &quot;Foo bar&quot;, true},</span>
<a href="#l64.65"></a><span id="l64.65">     {&quot;=?ISO-8859-1?Q?=C6=D8=C5=3AFoo_bar?=&quot;, &quot;Foo bar&quot;, true}</span>
<a href="#l64.66"></a><span id="l64.66">   };</span>
<a href="#l64.67"></a><span id="l64.67"> </span>
<a href="#l64.68"></a><span id="l64.68">   bool allTestsPassed = true;</span>
<a href="#l64.69"></a><span id="l64.69">   int result;</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineat">@@ -103,11 +103,11 @@ int main(int argc, char** argv)</span>
<a href="#l64.71"></a><span id="l64.71">       fail(&quot;%s, i=%d | result=%d\n&quot;, __FILE__, i, result);</span>
<a href="#l64.72"></a><span id="l64.72">       allTestsPassed = false;</span>
<a href="#l64.73"></a><span id="l64.73">     }</span>
<a href="#l64.74"></a><span id="l64.74">   }</span>
<a href="#l64.75"></a><span id="l64.75"> </span>
<a href="#l64.76"></a><span id="l64.76">   if (allTestsPassed) {</span>
<a href="#l64.77"></a><span id="l64.77">     passed(&quot;all tests passed\n&quot;);</span>
<a href="#l64.78"></a><span id="l64.78">   }</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineminus">-  </span>
<a href="#l64.80"></a><span id="l64.80" class="difflineplus">+</span>
<a href="#l64.81"></a><span id="l64.81">   return allTestsPassed ? 0 : 2;</span>
<a href="#l64.82"></a><span id="l64.82"> }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

