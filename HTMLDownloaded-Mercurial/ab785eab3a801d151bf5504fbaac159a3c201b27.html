<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11060:ab785eab3a801d151bf5504fbaac159a3c201b27</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ab785eab3a801d151bf5504fbaac159a3c201b27" />
<meta property="og:url" content="/comm-central/rev/ab785eab3a801d151bf5504fbaac159a3c201b27" />
<meta property="og:description" content="Bug 577775 - Disallow using invalid filesystem folders as the Local Directory for mail storage. r=IanN, ui-r=bwinton, r=mconley" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ab785eab3a801d151bf5504fbaac159a3c201b27 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ab785eab3a801d151bf5504fbaac159a3c201b27">shortlog</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ab785eab3a801d151bf5504fbaac159a3c201b27">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27">files</a> |
changeset |
<a href="/comm-central/raw-rev/ab785eab3a801d151bf5504fbaac159a3c201b27">raw</a>  | <a href="/comm-central/archive/ab785eab3a801d151bf5504fbaac159a3c201b27.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=577775">Bug 577775</a> - Disallow using invalid filesystem folders as the Local Directory for mail storage. r=IanN, ui-r=bwinton, r=mconley
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#97;&#99;&#101;&#109;&#97;&#110;&#32;&#60;&#97;&#99;&#101;&#108;&#105;&#115;&#116;&#115;&#64;&#97;&#116;&#108;&#97;&#115;&#46;&#115;&#107;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 13 Sep 2012 18:13:27 -0400</td></tr>

<tr>
 <td>changeset 11060</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ab785eab3a801d151bf5504fbaac159a3c201b27">ab785eab3a801d151bf5504fbaac159a3c201b27</a></td>
</tr>



<tr>
<td>parent 11059</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4316b336946c352e7943e6671019ce4b3512ec63">4316b336946c352e7943e6671019ce4b3512ec63</a>
</td>
</tr>

<tr>
<td>child 11061</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/4fac45745a7326a79390c09048214a35ea96b8c5">4fac45745a7326a79390c09048214a35ea96b8c5</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ab785eab3a801d151bf5504fbaac159a3c201b27">8296</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Thu, 13 Sep 2012 22:13:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ab785eab3a80 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ab785eab3a801d151bf5504fbaac159a3c201b27">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ab785eab3a801d151bf5504fbaac159a3c201b27&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&newProject=comm-central&newRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&newProject=comm-central&newRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&newProject=comm-central&newRevision=ab785eab3a801d151bf5504fbaac159a3c201b27&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a>, <a href="/comm-central/log?rev=reviewer%28bwinton%29&revcount=50">bwinton</a>, <a href="/comm-central/log?rev=reviewer%28mconley%29&revcount=50">mconley</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=577775">577775</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=577775">Bug 577775</a> - Disallow using invalid filesystem folders as the Local Directory for mail storage. r=IanN, ui-r=bwinton, r=mconley</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">mail/locales/en-US/chrome/messenger/prefs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/mail/locales/en-US/chrome/messenger/prefs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">mailnews/base/prefs/content/AccountManager.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/AccountManager.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">mailnews/base/prefs/content/am-serverwithnoidentities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/am-serverwithnoidentities.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">mailnews/base/prefs/content/amUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/mailnews/base/prefs/content/amUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">suite/locales/en-US/chrome/mailnews/pref/prefs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">file</a> |
<a href="/comm-central/annotate/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">annotate</a> |
<a href="/comm-central/diff/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">diff</a> |
<a href="/comm-central/comparison/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">comparison</a> |
<a href="/comm-central/log/ab785eab3a801d151bf5504fbaac159a3c201b27/suite/locales/en-US/chrome/mailnews/pref/prefs.properties">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/prefs.properties</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/prefs.properties</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -10,16 +10,17 @@ modifiedAccountExists=An account with th</span>
<a href="#l1.4"></a><span id="l1.4"> userNameChanged=Your User Name has been updated. You may also need to update your Email Address and/or User Name associated with this account.</span>
<a href="#l1.5"></a><span id="l1.5"> serverNameChanged=The server name setting has changed. Please verify that any folders used by filters exist on the new server.</span>
<a href="#l1.6"></a><span id="l1.6"> # LOCALIZATION NOTE (junkSettingsBroken): %1$S is the account name</span>
<a href="#l1.7"></a><span id="l1.7"> junkSettingsBroken=The Junk settings on account &quot;%1$S&quot; have a possible problem. Would you like to review them before saving Account Settings?</span>
<a href="#l1.8"></a><span id="l1.8"> # LOCALIZATION NOTE (localDirectoryChanged): %1$S is program name (&amp;brandShortName;)</span>
<a href="#l1.9"></a><span id="l1.9"> localDirectoryChanged=%1$S needs to restart now to apply the change to the Local directory setting.</span>
<a href="#l1.10"></a><span id="l1.10"> localDirectoryRestart=Restart</span>
<a href="#l1.11"></a><span id="l1.11"> serverNameEmpty=Neither the server name nor the user name can be empty.</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+localDirectoryInvalid=The directory specified in the Local Directory setting is invalid. Please pick a different directory.</span>
<a href="#l1.13"></a><span id="l1.13"> # if the user chooses to cancel the wizard when no accounts are there throw a message</span>
<a href="#l1.14"></a><span id="l1.14"> # LOCALIZATION NOTE (cancelWizard)</span>
<a href="#l1.15"></a><span id="l1.15"> # do not localize &quot;\n\n&quot;</span>
<a href="#l1.16"></a><span id="l1.16"> cancelWizard=Are you sure you want to exit the Account Wizard?\n\nIf you exit, any information you have entered will be lost and the account will not be created.</span>
<a href="#l1.17"></a><span id="l1.17"> accountWizard=Account Wizard</span>
<a href="#l1.18"></a><span id="l1.18"> WizardExit=Exit</span>
<a href="#l1.19"></a><span id="l1.19"> WizardContinue=Cancel</span>
<a href="#l1.20"></a><span id="l1.20"> # when the wizard already has a domain (Should we say something different?)</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineat">@@ -29,17 +30,19 @@ failedRemoveAccount=Failed to remove thi</span>
<a href="#l1.22"></a><span id="l1.22"> confirmRemoveAccount=Are you sure you want to remove the account &quot;%S&quot;?</span>
<a href="#l1.23"></a><span id="l1.23"> confirmRemoveAccountTitle=Remove Account</span>
<a href="#l1.24"></a><span id="l1.24"> #LOCALIZATION NOTE: accountName: %1$S is server name, %2$S is user name</span>
<a href="#l1.25"></a><span id="l1.25"> accountName=%1$S - %2$S</span>
<a href="#l1.26"></a><span id="l1.26"> </span>
<a href="#l1.27"></a><span id="l1.27"> confirmDeferAccount=If you store this account's new mail in a different account's Inbox, you will no longer be able to access already downloaded e-mail for this account. If you have mail in this account, please copy it to another account first. If you have filters that filter mail into this account, you should disable them or change the destination folder. If any accounts have special folders in this account (Sent, Drafts, Templates), you should change them to be in another account. Do you still want to store this account's e-mail in a different account?</span>
<a href="#l1.28"></a><span id="l1.28"> confirmDeferAccountTitle=Defer Account?</span>
<a href="#l1.29"></a><span id="l1.29"> </span>
<a href="#l1.30"></a><span id="l1.30" class="difflineminus">-directoryUsedByOtherAccount=This directory is already used by the %S account. Please pick a different directory.</span>
<a href="#l1.31"></a><span id="l1.31" class="difflineplus">+directoryAlreadyUsedByOtherAccount=The directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l1.32"></a><span id="l1.32" class="difflineplus">+directoryParentUsedByOtherAccount=A parent directory of the directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l1.33"></a><span id="l1.33" class="difflineplus">+directoryChildUsedByOtherAccount=A subdirectory of the directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l1.34"></a><span id="l1.34"> #Provide default example values for sample email address</span>
<a href="#l1.35"></a><span id="l1.35"> exampleEmailUserName=user</span>
<a href="#l1.36"></a><span id="l1.36"> exampleEmailDomain=example.net</span>
<a href="#l1.37"></a><span id="l1.37"> emailFieldText=Email Address:</span>
<a href="#l1.38"></a><span id="l1.38"> #LOCALIZATION NOTE: defaultEmailText: %1$S is user name, %2$S is domain</span>
<a href="#l1.39"></a><span id="l1.39"> defaultEmailText=Enter your email address. This is the address others will use to send email to you (for example, &quot;%1$S@%2$S&quot;). </span>
<a href="#l1.40"></a><span id="l1.40"> #LOCALIZATION NOTE: customizedEmailText: %1$S is provider, %2$S is email username, %3$S is sample email, %4$S is sample username</span>
<a href="#l1.41"></a><span id="l1.41"> customizedEmailText=Enter your %1$S %2$S (for example, if your %1$S email address is &quot;%3$S&quot;, your %2$S is &quot;%4$S&quot;). </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -115,47 +115,53 @@ function onLoad() {</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5">   setTimeout(selectServer, 0, selectedServer, selectPage);</span>
<a href="#l2.6"></a><span id="l2.6"> }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> function onUnload() {</span>
<a href="#l2.9"></a><span id="l2.9">   gAccountTree.unload();</span>
<a href="#l2.10"></a><span id="l2.10"> }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function selectServer(server, selectPage)</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+function selectServer(server, selectPageId)</span>
<a href="#l2.14"></a><span id="l2.14"> {</span>
<a href="#l2.15"></a><span id="l2.15">   let childrenNode = document.getElementById(&quot;account-tree-children&quot;);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   // Default to showing the first account.</span>
<a href="#l2.18"></a><span id="l2.18">   let accountNode = childrenNode.firstChild;</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   // Find the tree-node for the account we want to select</span>
<a href="#l2.21"></a><span id="l2.21">   if (server) {</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineminus">-    for (var i = 0; i &lt; childrenNode.childNodes.length; i++) {</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+    for (let i = 0; i &lt; childrenNode.childNodes.length; i++) {</span>
<a href="#l2.24"></a><span id="l2.24">       let account = childrenNode.childNodes[i]._account;</span>
<a href="#l2.25"></a><span id="l2.25">       if (account &amp;&amp; server == account.incomingServer) {</span>
<a href="#l2.26"></a><span id="l2.26">         accountNode = childrenNode.childNodes[i];</span>
<a href="#l2.27"></a><span id="l2.27">         break;</span>
<a href="#l2.28"></a><span id="l2.28">       }</span>
<a href="#l2.29"></a><span id="l2.29">     }</span>
<a href="#l2.30"></a><span id="l2.30">   }</span>
<a href="#l2.31"></a><span id="l2.31"> </span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-  var pageToSelect = accountNode;</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  if (selectPage) {</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-    // Find the page that also corresponds to this server</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-    var pages = accountNode.getElementsByAttribute(&quot;PageTag&quot;, selectPage);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-    pageToSelect = pages[0];</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+  let pageToSelect = accountNode;</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+  if (selectPageId) {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    // Find the page that also corresponds to this server.</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+    // It either is the accountNode itself...</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineplus">+    let pageId = accountNode.getAttribute(&quot;PageTag&quot;);</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineplus">+    if (pageId != selectPageId) {</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineplus">+      // ... or one of its children.</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+      let pages = accountNode.getElementsByAttribute(&quot;PageTag&quot;, selectPageId);</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineplus">+      pageToSelect = pages[0];</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineplus">+    }</span>
<a href="#l2.48"></a><span id="l2.48">   }</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-  var accountTree = document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-  var index = accountTree.contentView.getIndexOfItem(pageToSelect);</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+  let accountTree = document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineplus">+  let index = accountTree.contentView.getIndexOfItem(pageToSelect);</span>
<a href="#l2.54"></a><span id="l2.54">   accountTree.view.selection.select(index);</span>
<a href="#l2.55"></a><span id="l2.55">   accountTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  var lastItem = accountNode.lastChild.lastChild;</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+  let lastItem = accountNode.lastChild.lastChild;</span>
<a href="#l2.59"></a><span id="l2.59">   if (lastItem.localName == &quot;treeitem&quot;)</span>
<a href="#l2.60"></a><span id="l2.60">     index = accountTree.contentView.getIndexOfItem(lastItem);</span>
<a href="#l2.61"></a><span id="l2.61"> </span>
<a href="#l2.62"></a><span id="l2.62">   accountTree.treeBoxObject.ensureRowIsVisible(index);</span>
<a href="#l2.63"></a><span id="l2.63"> }</span>
<a href="#l2.64"></a><span id="l2.64"> </span>
<a href="#l2.65"></a><span id="l2.65"> function replaceWithDefaultSmtpServer(deletedSmtpServerKey)</span>
<a href="#l2.66"></a><span id="l2.66"> {</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineat">@@ -182,24 +188,33 @@ function replaceWithDefaultSmtpServer(de</span>
<a href="#l2.68"></a><span id="l2.68">       var smtpServerKey = getAccountValue(account, accountValues, &quot;identity&quot;,</span>
<a href="#l2.69"></a><span id="l2.69">                                           &quot;smtpServerKey&quot;, null, false);</span>
<a href="#l2.70"></a><span id="l2.70">       if (smtpServerKey == deletedSmtpServerKey)</span>
<a href="#l2.71"></a><span id="l2.71">         setAccountValue(accountValues, &quot;identity&quot;, &quot;smtpServerKey&quot;, &quot;&quot;);</span>
<a href="#l2.72"></a><span id="l2.72">     }</span>
<a href="#l2.73"></a><span id="l2.73">   }</span>
<a href="#l2.74"></a><span id="l2.74"> }</span>
<a href="#l2.75"></a><span id="l2.75"> </span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-function onAccept() {</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-  // Check if user/host have been modified correctly.</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-  if (!checkUserServerChanges(true))</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    return false;</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+/**</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineplus">+ * Called when OK is clicked on the dialog.</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineplus">+ *</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineplus">+ * @param aDoChecks  If true, execute checks on data, otherwise hope they</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineplus">+ *                   were already done elsewhere and proceed directly to saving</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineplus">+ *                   the data.</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineplus">+ */</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineplus">+function onAccept(aDoChecks) {</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineplus">+  if (aDoChecks) {</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineplus">+    // Check if user/host have been modified correctly.</span>
<a href="#l2.90"></a><span id="l2.90" class="difflineplus">+    if (!checkUserServerChanges(true))</span>
<a href="#l2.91"></a><span id="l2.91" class="difflineplus">+      return false;</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-  if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineminus">-    return false;</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineplus">+      gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+      return false;</span>
<a href="#l2.99"></a><span id="l2.99" class="difflineplus">+    }</span>
<a href="#l2.100"></a><span id="l2.100">   }</span>
<a href="#l2.101"></a><span id="l2.101"> </span>
<a href="#l2.102"></a><span id="l2.102">   if (!onSave())</span>
<a href="#l2.103"></a><span id="l2.103">     return false;</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">   // hack hack - save the prefs file NOW in case we crash</span>
<a href="#l2.106"></a><span id="l2.106">   Services.prefs.savePrefFile(null);</span>
<a href="#l2.107"></a><span id="l2.107"> </span>
<a href="#l2.108"></a><span id="l2.108" class="difflineat">@@ -208,16 +223,110 @@ function onAccept() {</span>
<a href="#l2.109"></a><span id="l2.109">     // returns false so that Account manager is not exited when restart failed</span>
<a href="#l2.110"></a><span id="l2.110">     return !gRestartNeeded;</span>
<a href="#l2.111"></a><span id="l2.111">   }</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">   return true;</span>
<a href="#l2.114"></a><span id="l2.114"> }</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116"> /**</span>
<a href="#l2.117"></a><span id="l2.117" class="difflineplus">+ * See if the given path to a directory is usable on the current OS.</span>
<a href="#l2.118"></a><span id="l2.118" class="difflineplus">+ *</span>
<a href="#l2.119"></a><span id="l2.119" class="difflineplus">+ * aLocalPath  the nsIFile of a directory to check.</span>
<a href="#l2.120"></a><span id="l2.120" class="difflineplus">+ */</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineplus">+function checkDirectoryIsValid(aLocalPath) {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  // Any directory selected in the file picker already exists.</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineplus">+  // Any directory specified in prefs.js will be created at start if it does</span>
<a href="#l2.124"></a><span id="l2.124" class="difflineplus">+  // not exist yet.</span>
<a href="#l2.125"></a><span id="l2.125" class="difflineplus">+  // If at the time of entering Account Manager the directory does not exist,</span>
<a href="#l2.126"></a><span id="l2.126" class="difflineplus">+  // it must be invalid in the current OS or not creatable due to permissions.</span>
<a href="#l2.127"></a><span id="l2.127" class="difflineplus">+  // Even then, the backend sometimes tries to create a new one</span>
<a href="#l2.128"></a><span id="l2.128" class="difflineplus">+  // under the current profile.</span>
<a href="#l2.129"></a><span id="l2.129" class="difflineplus">+  if (!aLocalPath.exists() || !aLocalPath.isDirectory())</span>
<a href="#l2.130"></a><span id="l2.130" class="difflineplus">+    return false;</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineplus">+</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+  if (Services.appinfo.OS == &quot;WINNT&quot;) {</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+    // Do not allow some special filenames on Windows.</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+    // Taken from mozilla/widget/windows/nsDataObj.cpp::MangleTextToValidFilename()</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+    let dirLeafName = aLocalPath.leafName;</span>
<a href="#l2.136"></a><span id="l2.136" class="difflineplus">+    const kForbiddenNames = [</span>
<a href="#l2.137"></a><span id="l2.137" class="difflineplus">+      &quot;COM1&quot;, &quot;COM2&quot;, &quot;COM3&quot;, &quot;COM4&quot;, &quot;COM5&quot;, &quot;COM6&quot;, &quot;COM7&quot;, &quot;COM8&quot;, &quot;COM9&quot;,</span>
<a href="#l2.138"></a><span id="l2.138" class="difflineplus">+      &quot;LPT1&quot;, &quot;LPT2&quot;, &quot;LPT3&quot;, &quot;LPT4&quot;, &quot;LPT5&quot;, &quot;LPT6&quot;, &quot;LPT7&quot;, &quot;LPT8&quot;, &quot;LPT9&quot;,</span>
<a href="#l2.139"></a><span id="l2.139" class="difflineplus">+      &quot;CON&quot;, &quot;PRN&quot;, &quot;AUX&quot;, &quot;NUL&quot;, &quot;CLOCK$&quot; ];</span>
<a href="#l2.140"></a><span id="l2.140" class="difflineplus">+    if (kForbiddenNames.indexOf(dirLeafName) != -1)</span>
<a href="#l2.141"></a><span id="l2.141" class="difflineplus">+      return false;</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineplus">+  }</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineplus">+  // The directory must be readable and writable to work as a mail store.</span>
<a href="#l2.145"></a><span id="l2.145" class="difflineplus">+  if (!(aLocalPath.isReadable() &amp;&amp; aLocalPath.isWritable()))</span>
<a href="#l2.146"></a><span id="l2.146" class="difflineplus">+    return false;</span>
<a href="#l2.147"></a><span id="l2.147" class="difflineplus">+</span>
<a href="#l2.148"></a><span id="l2.148" class="difflineplus">+  return true;</span>
<a href="#l2.149"></a><span id="l2.149" class="difflineplus">+}</span>
<a href="#l2.150"></a><span id="l2.150" class="difflineplus">+</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineplus">+/**</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineplus">+ * Check if the specified directory does meet all the requirements</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+ * for safe mail storage.</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+ *</span>
<a href="#l2.155"></a><span id="l2.155" class="difflineplus">+ * aLocalPath  the nsIFile of a directory to check.</span>
<a href="#l2.156"></a><span id="l2.156" class="difflineplus">+ */</span>
<a href="#l2.157"></a><span id="l2.157" class="difflineplus">+function checkDirectoryIsUsable(aLocalPath) {</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineplus">+  const kAlertTitle = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+                              .getString(&quot;prefPanel-server&quot;);</span>
<a href="#l2.160"></a><span id="l2.160" class="difflineplus">+  let invalidPath = false;</span>
<a href="#l2.161"></a><span id="l2.161" class="difflineplus">+  try{</span>
<a href="#l2.162"></a><span id="l2.162" class="difflineplus">+    aLocalPath.normalize();</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineplus">+  } catch (e) { invalidPath = true; }</span>
<a href="#l2.164"></a><span id="l2.164" class="difflineplus">+</span>
<a href="#l2.165"></a><span id="l2.165" class="difflineplus">+  if (invalidPath || !checkDirectoryIsValid(aLocalPath)) {</span>
<a href="#l2.166"></a><span id="l2.166" class="difflineplus">+    let alertString = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l2.167"></a><span id="l2.167" class="difflineplus">+                              .getString(&quot;localDirectoryInvalid&quot;);</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineplus">+    Services.prompt.alert(window, kAlertTitle, alertString);</span>
<a href="#l2.169"></a><span id="l2.169" class="difflineplus">+    return false;</span>
<a href="#l2.170"></a><span id="l2.170" class="difflineplus">+  }</span>
<a href="#l2.171"></a><span id="l2.171" class="difflineplus">+</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineplus">+  // Check that no other account has this same or dependent local directory.</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+  let allServers = MailServices.accounts.allServers;</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  for each (let server in fixIterator(allServers,</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+                                      Components.interfaces.nsIMsgIncomingServer))</span>
<a href="#l2.177"></a><span id="l2.177" class="difflineplus">+  {</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineplus">+    if (server.key == currentAccount.incomingServer.key)</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+      continue;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+    let serverPath = server.localPath;</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    try {</span>
<a href="#l2.183"></a><span id="l2.183" class="difflineplus">+      serverPath.normalize();</span>
<a href="#l2.184"></a><span id="l2.184" class="difflineplus">+      let alertStringID = null;</span>
<a href="#l2.185"></a><span id="l2.185" class="difflineplus">+      if (serverPath.equals(aLocalPath))</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineplus">+        alertStringID = &quot;directoryAlreadyUsedByOtherAccount&quot;;</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineplus">+      else if (serverPath.contains(aLocalPath, true))</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+        alertStringID = &quot;directoryParentUsedByOtherAccount&quot;;</span>
<a href="#l2.189"></a><span id="l2.189" class="difflineplus">+      else if (aLocalPath.contains(serverPath, true))</span>
<a href="#l2.190"></a><span id="l2.190" class="difflineplus">+        alertStringID = &quot;directoryChildUsedByOtherAccount&quot;;</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineplus">+</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+      if (alertStringID) {</span>
<a href="#l2.193"></a><span id="l2.193" class="difflineplus">+        let alertString = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l2.194"></a><span id="l2.194" class="difflineplus">+                                  .getFormattedString(alertStringID,</span>
<a href="#l2.195"></a><span id="l2.195" class="difflineplus">+                                                      [server.prettyName]);</span>
<a href="#l2.196"></a><span id="l2.196" class="difflineplus">+</span>
<a href="#l2.197"></a><span id="l2.197" class="difflineplus">+        Services.prompt.alert(window, kAlertTitle, alertString);</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineplus">+        return false;</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+      }</span>
<a href="#l2.200"></a><span id="l2.200" class="difflineplus">+    } catch (e) {</span>
<a href="#l2.201"></a><span id="l2.201" class="difflineplus">+      // The other account's path is seriously broken, so we can't compare it.</span>
<a href="#l2.202"></a><span id="l2.202" class="difflineplus">+      Components.utils.reportError(&quot;The Local Directory path of the account &quot; +</span>
<a href="#l2.203"></a><span id="l2.203" class="difflineplus">+        server.prettyName + &quot; seems invalid.&quot;);</span>
<a href="#l2.204"></a><span id="l2.204" class="difflineplus">+    }</span>
<a href="#l2.205"></a><span id="l2.205" class="difflineplus">+  }</span>
<a href="#l2.206"></a><span id="l2.206" class="difflineplus">+</span>
<a href="#l2.207"></a><span id="l2.207" class="difflineplus">+  return true;</span>
<a href="#l2.208"></a><span id="l2.208" class="difflineplus">+}</span>
<a href="#l2.209"></a><span id="l2.209" class="difflineplus">+</span>
<a href="#l2.210"></a><span id="l2.210" class="difflineplus">+/**</span>
<a href="#l2.211"></a><span id="l2.211">  * Check if the user and/or host names have been changed and if so check</span>
<a href="#l2.212"></a><span id="l2.212">  * if the new names already exists for an account or are empty.</span>
<a href="#l2.213"></a><span id="l2.213">  * Also check if the Local Directory path was changed.</span>
<a href="#l2.214"></a><span id="l2.214">  *</span>
<a href="#l2.215"></a><span id="l2.215">  * @param showAlert  show and alert if a problem with the host / user name is found</span>
<a href="#l2.216"></a><span id="l2.216">  */</span>
<a href="#l2.217"></a><span id="l2.217"> function checkUserServerChanges(showAlert) {</span>
<a href="#l2.218"></a><span id="l2.218">   const prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l2.219"></a><span id="l2.219" class="difflineat">@@ -292,17 +401,19 @@ function checkUserServerChanges(showAler</span>
<a href="#l2.220"></a><span id="l2.220">     }</span>
<a href="#l2.221"></a><span id="l2.221">     if (alertText) {</span>
<a href="#l2.222"></a><span id="l2.222">       if (showAlert)</span>
<a href="#l2.223"></a><span id="l2.223">         Services.prompt.alert(window, alertTitle, alertText);</span>
<a href="#l2.224"></a><span id="l2.224">       // Restore the old values before return</span>
<a href="#l2.225"></a><span id="l2.225">       if (checkUser)</span>
<a href="#l2.226"></a><span id="l2.226">         setFormElementValue(pageElements[uIndx], oldUser);</span>
<a href="#l2.227"></a><span id="l2.227">       setFormElementValue(pageElements[hIndx], oldHost);</span>
<a href="#l2.228"></a><span id="l2.228" class="difflineminus">-      return false;</span>
<a href="#l2.229"></a><span id="l2.229" class="difflineplus">+      // If no message is shown to the user, silently revert the values</span>
<a href="#l2.230"></a><span id="l2.230" class="difflineplus">+      // and consider the check a success.</span>
<a href="#l2.231"></a><span id="l2.231" class="difflineplus">+      return !showAlert;</span>
<a href="#l2.232"></a><span id="l2.232">     }</span>
<a href="#l2.233"></a><span id="l2.233"> </span>
<a href="#l2.234"></a><span id="l2.234">     // If username is changed remind users to change Your Name and Email Address.</span>
<a href="#l2.235"></a><span id="l2.235">     // If server name is changed and has defined filters then remind users</span>
<a href="#l2.236"></a><span id="l2.236">     // to edit rules.</span>
<a href="#l2.237"></a><span id="l2.237">     if (showAlert) {</span>
<a href="#l2.238"></a><span id="l2.238">       let filterList;</span>
<a href="#l2.239"></a><span id="l2.239">       if (currentAccount &amp;&amp; checkUser) {</span>
<a href="#l2.240"></a><span id="l2.240" class="difflineat">@@ -317,16 +428,27 @@ function checkUserServerChanges(showAler</span>
<a href="#l2.241"></a><span id="l2.241">       if (oldUser != newUser)</span>
<a href="#l2.242"></a><span id="l2.242">         changeText = changeText + &quot;\n\n&quot; + prefBundle.getString(&quot;userNameChanged&quot;);</span>
<a href="#l2.243"></a><span id="l2.243"> </span>
<a href="#l2.244"></a><span id="l2.244">       if (changeText != &quot;&quot;)</span>
<a href="#l2.245"></a><span id="l2.245">         Services.prompt.alert(window, alertTitle, changeText.trim());</span>
<a href="#l2.246"></a><span id="l2.246">     }</span>
<a href="#l2.247"></a><span id="l2.247">   }</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249" class="difflineplus">+  // Check the new value of the server.localPath field for validity.</span>
<a href="#l2.250"></a><span id="l2.250" class="difflineplus">+  for (let i = 0; i &lt; pageElements.length; i++) {</span>
<a href="#l2.251"></a><span id="l2.251" class="difflineplus">+    if (pageElements[i].id) {</span>
<a href="#l2.252"></a><span id="l2.252" class="difflineplus">+      if (pageElements[i].id == &quot;server.localPath&quot;) {</span>
<a href="#l2.253"></a><span id="l2.253" class="difflineplus">+        if (!checkDirectoryIsUsable(getFormElementValue(pageElements[i])))</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineplus">+          return false;</span>
<a href="#l2.255"></a><span id="l2.255" class="difflineplus">+        break;</span>
<a href="#l2.256"></a><span id="l2.256" class="difflineplus">+      }</span>
<a href="#l2.257"></a><span id="l2.257" class="difflineplus">+    }</span>
<a href="#l2.258"></a><span id="l2.258" class="difflineplus">+  }</span>
<a href="#l2.259"></a><span id="l2.259" class="difflineplus">+</span>
<a href="#l2.260"></a><span id="l2.260">   // Warn if the Local directory path was changed.</span>
<a href="#l2.261"></a><span id="l2.261">   // This can be removed once bug 2654 is fixed.</span>
<a href="#l2.262"></a><span id="l2.262">   let oldLocalDir = null;</span>
<a href="#l2.263"></a><span id="l2.263">   let newLocalDir = null;</span>
<a href="#l2.264"></a><span id="l2.264">   let pIndx;</span>
<a href="#l2.265"></a><span id="l2.265">   for (let i = 0; i &lt; pageElements.length; i++) {</span>
<a href="#l2.266"></a><span id="l2.266">     if (pageElements[i].id) {</span>
<a href="#l2.267"></a><span id="l2.267">       if (pageElements[i].id == &quot;server.localPath&quot;) {</span>
<a href="#l2.268"></a><span id="l2.268" class="difflineat">@@ -720,25 +842,33 @@ function onAccountTreeSelect(pageId, acc</span>
<a href="#l2.269"></a><span id="l2.269">     account = (&quot;_account&quot; in node) ? node._account : null;</span>
<a href="#l2.270"></a><span id="l2.270"> </span>
<a href="#l2.271"></a><span id="l2.271">     pageId = node.getAttribute(&quot;PageTag&quot;)</span>
<a href="#l2.272"></a><span id="l2.272">   }</span>
<a href="#l2.273"></a><span id="l2.273"> </span>
<a href="#l2.274"></a><span id="l2.274">   if (pageId == currentPageId &amp;&amp; account == currentAccount)</span>
<a href="#l2.275"></a><span id="l2.275">     return true;</span>
<a href="#l2.276"></a><span id="l2.276"> </span>
<a href="#l2.277"></a><span id="l2.277" class="difflineminus">-  // check if user/host names have been changed</span>
<a href="#l2.278"></a><span id="l2.278" class="difflineminus">-  checkUserServerChanges(false);</span>
<a href="#l2.279"></a><span id="l2.279" class="difflineplus">+  if (document.getElementById(&quot;contentFrame&quot;).contentDocument.getElementById(&quot;server.localPath&quot;)) {</span>
<a href="#l2.280"></a><span id="l2.280" class="difflineplus">+    // Check if user/host names have been changed or the Local Directory is invalid.</span>
<a href="#l2.281"></a><span id="l2.281" class="difflineplus">+    if (!checkUserServerChanges(false)) {</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineplus">+      changeView = true;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+      account = currentAccount;</span>
<a href="#l2.284"></a><span id="l2.284" class="difflineplus">+      pageId = currentPageId;</span>
<a href="#l2.285"></a><span id="l2.285" class="difflineplus">+    }</span>
<a href="#l2.286"></a><span id="l2.286"> </span>
<a href="#l2.287"></a><span id="l2.287" class="difflineminus">-  if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.288"></a><span id="l2.288" class="difflineminus">-    gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.289"></a><span id="l2.289" class="difflineminus">-    selectServer(currentAccount.incomingServer, currentPageId);</span>
<a href="#l2.290"></a><span id="l2.290" class="difflineminus">-    return true;</span>
<a href="#l2.291"></a><span id="l2.291" class="difflineplus">+    if (gSmtpHostNameIsIllegal) {</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineplus">+      gSmtpHostNameIsIllegal = false;</span>
<a href="#l2.293"></a><span id="l2.293" class="difflineplus">+      selectServer(currentAccount.incomingServer, currentPageId);</span>
<a href="#l2.294"></a><span id="l2.294" class="difflineplus">+      return true;</span>
<a href="#l2.295"></a><span id="l2.295" class="difflineplus">+    }</span>
<a href="#l2.296"></a><span id="l2.296" class="difflineplus">+</span>
<a href="#l2.297"></a><span id="l2.297" class="difflineplus">+    if (gRestartNeeded)</span>
<a href="#l2.298"></a><span id="l2.298" class="difflineplus">+      onAccept(false);</span>
<a href="#l2.299"></a><span id="l2.299">   }</span>
<a href="#l2.300"></a><span id="l2.300" class="difflineminus">-</span>
<a href="#l2.301"></a><span id="l2.301">   // save the previous page</span>
<a href="#l2.302"></a><span id="l2.302">   savePage(currentAccount);</span>
<a href="#l2.303"></a><span id="l2.303"> </span>
<a href="#l2.304"></a><span id="l2.304">   let changeAccount = (account != currentAccount);</span>
<a href="#l2.305"></a><span id="l2.305"> </span>
<a href="#l2.306"></a><span id="l2.306">   if (changeView)</span>
<a href="#l2.307"></a><span id="l2.307">     selectServer(account.incomingServer, pageId);</span>
<a href="#l2.308"></a><span id="l2.308"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.xul</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.xul</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -11,17 +11,17 @@</span>
<a href="#l3.4"></a><span id="l3.4">         windowtype=&quot;mailnews:accountmanager&quot;</span>
<a href="#l3.5"></a><span id="l3.5">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l3.6"></a><span id="l3.6">         title=&quot;&amp;accountManagerTitle.label;&quot;</span>
<a href="#l3.7"></a><span id="l3.7">         style=&quot;&amp;accountManager.size;&quot;</span>
<a href="#l3.8"></a><span id="l3.8">         persist=&quot;screenX screenY&quot;</span>
<a href="#l3.9"></a><span id="l3.9">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l3.10"></a><span id="l3.10">         onload=&quot;onLoad(event);&quot;</span>
<a href="#l3.11"></a><span id="l3.11">         onunload=&quot;onUnload();&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-        ondialogaccept=&quot;return onAccept();&quot;&gt;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+        ondialogaccept=&quot;return onAccept(true);&quot;&gt;</span>
<a href="#l3.14"></a><span id="l3.14"> &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l3.15"></a><span id="l3.15"> &lt;stringbundle id=&quot;bundle_prefs&quot; src=&quot;chrome://messenger/locale/prefs.properties&quot;/&gt;</span>
<a href="#l3.16"></a><span id="l3.16"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/amUtils.js&quot;/&gt;</span>
<a href="#l3.17"></a><span id="l3.17"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l3.18"></a><span id="l3.18"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/am-prefs.js&quot;/&gt;</span>
<a href="#l3.19"></a><span id="l3.19"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/AccountManager.js&quot;/&gt;</span>
<a href="#l3.20"></a><span id="l3.20"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/am-help.js&quot;/&gt;</span>
<a href="#l3.21"></a><span id="l3.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,14 +1,10 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l4.5"></a><span id="l4.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.6"></a><span id="l4.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.7"></a><span id="l4.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9" class="difflineminus">-var gServer;</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineminus">-</span>
<a href="#l4.11"></a><span id="l4.11"> function onInit(aPageId, aServerId) {</span>
<a href="#l4.12"></a><span id="l4.12"> }</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-{</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineminus">-  gServer = account.incomingServer;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l4.18"></a><span id="l4.18"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,15 +1,12 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.5"></a><span id="l5.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineminus">-/* Prerequisites:</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineminus">-   gServer - server.incomingServer defined in the calling page</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineminus">- */</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> </span>
<a href="#l5.15"></a><span id="l5.15"> function BrowseForLocalFolders()</span>
<a href="#l5.16"></a><span id="l5.16"> {</span>
<a href="#l5.17"></a><span id="l5.17">   const nsIFilePicker = Components.interfaces.nsIFilePicker;</span>
<a href="#l5.18"></a><span id="l5.18">   const nsILocalFile = Components.interfaces.nsILocalFile;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineat">@@ -29,32 +26,20 @@ function BrowseForLocalFolders()</span>
<a href="#l5.20"></a><span id="l5.20">   fp.displayDirectory = currentFolder;</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">   if (fp.show() != nsIFilePicker.returnOK)</span>
<a href="#l5.23"></a><span id="l5.23">     return;</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   // Retrieve the selected folder.</span>
<a href="#l5.26"></a><span id="l5.26">   let selectedFolder = fp.file;</span>
<a href="#l5.27"></a><span id="l5.27"> </span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  // check that no other account/server has this same local directory</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineminus">-  let allServers = MailServices.accounts.allServers;</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-  for (let i = allServers.Count(); --i &gt;= 0;) {</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineminus">-    let currentServer = allServers</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-      .QueryElementAt(i, Components.interfaces.nsIMsgIncomingServer);</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-    if (currentServer.key == gServer.key)</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineminus">-      continue;</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+  // Check if the folder can be used for mail storage.</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+  if (!top.checkDirectoryIsUsable(selectedFolder))</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+    return;</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-    if (currentServer.localPath.equals(selectedFolder)) {</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-      let dirAlreadyUsed = top.document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-                              .getFormattedString(&quot;directoryUsedByOtherAccount&quot;,</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineminus">-                                                  [currentServer.prettyName]);</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineminus">-      Services.prompt.alert(window, null, dirAlreadyUsed);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-      return;</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-    }</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  }</span>
<a href="#l5.47"></a><span id="l5.47">   currentFolderTextBox.value = selectedFolder.path;</span>
<a href="#l5.48"></a><span id="l5.48"> }</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50"> function hostnameIsIllegal(hostname)</span>
<a href="#l5.51"></a><span id="l5.51"> {</span>
<a href="#l5.52"></a><span id="l5.52">   // XXX TODO do a complete check.</span>
<a href="#l5.53"></a><span id="l5.53">   // this only checks for illegal characters in the hostname</span>
<a href="#l5.54"></a><span id="l5.54">   // but hostnames like &quot;....&quot; and &quot;_&quot; and &quot;.111&quot; will get by</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/pref/prefs.properties</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/pref/prefs.properties</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -11,16 +11,17 @@ modifiedAccountExists=An account with th</span>
<a href="#l6.4"></a><span id="l6.4"> userNameChanged=Your User Name has been updated. You may also need to update your Email Address and/or User Name associated with this account.</span>
<a href="#l6.5"></a><span id="l6.5"> serverNameChanged=The server name setting has changed. Please verify that any folders used by filters exist on the new server.</span>
<a href="#l6.6"></a><span id="l6.6"> # LOCALIZATION NOTE (junkSettingsBroken): %1$S is the account name</span>
<a href="#l6.7"></a><span id="l6.7"> junkSettingsBroken=The Junk settings on account &quot;%1$S&quot; have a possible problem. Would you like to review them before saving Account Settings?</span>
<a href="#l6.8"></a><span id="l6.8"> # LOCALIZATION NOTE (localDirectoryChanged): %1$S is program name (&amp;brandShortName;)</span>
<a href="#l6.9"></a><span id="l6.9"> localDirectoryChanged=%1$S needs to restart now to apply the change to the Local directory setting.</span>
<a href="#l6.10"></a><span id="l6.10"> localDirectoryRestart=Restart</span>
<a href="#l6.11"></a><span id="l6.11"> serverNameEmpty=Neither the server name nor the user name can be empty.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+localDirectoryInvalid=The directory specified in the Local Directory setting is invalid. Please pick a different directory.</span>
<a href="#l6.13"></a><span id="l6.13"> # if the user chooses to cancel the wizard when no accounts are there throw a message</span>
<a href="#l6.14"></a><span id="l6.14"> # LOCALIZATION NOTE (cancelWizard)</span>
<a href="#l6.15"></a><span id="l6.15"> # do not localize &quot;\n\n&quot;</span>
<a href="#l6.16"></a><span id="l6.16"> cancelWizard=Are you sure you want to exit the Account Wizard?\n\nIf you exit, any information you have entered will be lost and the account will not be created.</span>
<a href="#l6.17"></a><span id="l6.17"> accountWizard=Account Wizard</span>
<a href="#l6.18"></a><span id="l6.18"> WizardExit=Exit</span>
<a href="#l6.19"></a><span id="l6.19"> WizardContinue=Cancel</span>
<a href="#l6.20"></a><span id="l6.20"> # when the wizard already has a domain (Should we say something different?)</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -30,17 +31,19 @@ failedRemoveAccount=Failed to remove thi</span>
<a href="#l6.22"></a><span id="l6.22"> confirmRemoveAccount=Are you sure you want to remove the account &quot;%S&quot;?</span>
<a href="#l6.23"></a><span id="l6.23"> confirmRemoveAccountTitle=Remove Account</span>
<a href="#l6.24"></a><span id="l6.24"> #LOCALIZATION NOTE: accountName: %1$S is server name, %2$S is user name</span>
<a href="#l6.25"></a><span id="l6.25"> accountName=%1$S - %2$S</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> confirmDeferAccount=If you store this account's new mail in a different account's Inbox, you will no longer be able to access already downloaded e-mail for this account. If you have mail in this account, please copy it to another account first. If you have filters that filter mail into this account, you should disable them or change the destination folder. If any accounts have special folders in this account (Sent, Drafts, Templates), you should change them to be in another account. Do you still want to store this account's e-mail in a different account?</span>
<a href="#l6.28"></a><span id="l6.28"> confirmDeferAccountTitle=Defer Account?</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineminus">-directoryUsedByOtherAccount=This directory is already used by the %S account. Please pick a different directory.</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+directoryAlreadyUsedByOtherAccount=The directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+directoryParentUsedByOtherAccount=A parent directory of the directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+directoryChildUsedByOtherAccount=A subdirectory of the directory specified in the Local Directory setting is already used by the &quot;%S&quot; account. Please pick a different directory.</span>
<a href="#l6.34"></a><span id="l6.34"> #Provide default example values for sample email address</span>
<a href="#l6.35"></a><span id="l6.35"> exampleEmailUserName=user</span>
<a href="#l6.36"></a><span id="l6.36"> exampleEmailDomain=example.net</span>
<a href="#l6.37"></a><span id="l6.37"> emailFieldText=Email Address:</span>
<a href="#l6.38"></a><span id="l6.38"> #LOCALIZATION NOTE: defaultEmailText: %1$S is user name, %2$S is domain</span>
<a href="#l6.39"></a><span id="l6.39"> defaultEmailText=Enter your email address. This is the address others will use to send email to you (for example, &quot;%1$S@%2$S&quot;). </span>
<a href="#l6.40"></a><span id="l6.40"> #LOCALIZATION NOTE: customizedEmailText: %1$S is provider, %2$S is email username, %3$S is sample email, %4$S is sample username</span>
<a href="#l6.41"></a><span id="l6.41"> customizedEmailText=Enter your %1$S %2$S (for example, if your %1$S email address is &quot;%3$S&quot;, your %2$S is &quot;%4$S&quot;). </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

