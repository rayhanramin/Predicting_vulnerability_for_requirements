<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 14853:651d73c16c5cf802f7040fc36ff31040de6c3ffb</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 651d73c16c5cf802f7040fc36ff31040de6c3ffb" />
<meta property="og:url" content="/comm-central/rev/651d73c16c5cf802f7040fc36ff31040de6c3ffb" />
<meta property="og:description" content="Bug 953944 - Implement IRC in JavaScript, r=florian." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 651d73c16c5cf802f7040fc36ff31040de6c3ffb 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/651d73c16c5cf802f7040fc36ff31040de6c3ffb">shortlog</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/651d73c16c5cf802f7040fc36ff31040de6c3ffb">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb">files</a> |
changeset |
<a href="/comm-central/raw-rev/651d73c16c5cf802f7040fc36ff31040de6c3ffb">raw</a>  | <a href="/comm-central/archive/651d73c16c5cf802f7040fc36ff31040de6c3ffb.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953944">Bug 953944</a> - Implement IRC in JavaScript, r=florian.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#80;&#97;&#116;&#114;&#105;&#99;&#107;&#32;&#67;&#108;&#111;&#107;&#101;&#32;&#60;&#99;&#108;&#111;&#107;&#101;&#112;&#64;&#103;&#109;&#97;&#105;&#108;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 27 Feb 2012 15:19:30 +0100</td></tr>

<tr>
 <td>changeset 14853</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/651d73c16c5cf802f7040fc36ff31040de6c3ffb">651d73c16c5cf802f7040fc36ff31040de6c3ffb</a></td>
</tr>



<tr>
<td>parent 14852</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/78159a65573df8ce633e5a96334d276ba614d131">78159a65573df8ce633e5a96334d276ba614d131</a>
</td>
</tr>

<tr>
<td>child 14854</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7055e81e06a0536197bcda603c25d14c9a43b6de">7055e81e06a0536197bcda603c25d14c9a43b6de</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=651d73c16c5cf802f7040fc36ff31040de6c3ffb">9778</a></td></tr>
<tr><td>push user</td><td>florian@queze.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 12 Jan 2014 18:25:45 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f81a23bfefcd [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f81a23bfefcd0f6ec6215fbde12f8af2bc7749f1&newProject=comm-central&newRevision=279a7aa9624ffb41326b021ff7d8bc68b9b89551&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28florian%29&revcount=50">florian</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953944">953944</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=953944">Bug 953944</a> - Implement IRC in JavaScript, r=florian.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">chat/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">chat/chat-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/chat-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">chat/components/src/logger.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/components/src/logger.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">chat/locales/en-US/irc.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/en-US/irc.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">chat/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">chat/makefiles.sh</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/makefiles.sh">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">chat/modules/imXPCOMUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/imXPCOMUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">chat/modules/jsProtoHelper.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/jsProtoHelper.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">chat/modules/socket.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/modules/socket.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">chat/protocols/irc/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">chat/protocols/irc/icons/prpl-irc-32.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-32.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">chat/protocols/irc/icons/prpl-irc-48.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc-48.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">chat/protocols/irc/icons/prpl-irc.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/icons/prpl-irc.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">chat/protocols/irc/irc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">chat/protocols/irc/irc.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/irc.manifest">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">chat/protocols/irc/ircBase.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircBase.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">chat/protocols/irc/ircCTCP.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCTCP.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">chat/protocols/irc/ircCommands.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircCommands.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">chat/protocols/irc/ircDCC.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircDCC.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">chat/protocols/irc/ircHandlers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircHandlers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">chat/protocols/irc/ircISUPPORT.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircISUPPORT.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">chat/protocols/irc/ircUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/ircUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">chat/protocols/irc/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">chat/protocols/irc/test/test_ctcpColoring.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpColoring.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">chat/protocols/irc/test/test_ctcpFormatting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/test_ctcpFormatting.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">chat/protocols/irc/test/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/chat/protocols/irc/test/xpcshell.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">im/app/profile/all-instantbird.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/app/profile/all-instantbird.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">im/content/conversation.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/content/conversation.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">im/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">im/test/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/651d73c16c5cf802f7040fc36ff31040de6c3ffb/im/test/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/chat/Makefile.in</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/chat/Makefile.in</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -39,16 +39,17 @@ topsrcdir	= @top_srcdir@</span>
<a href="#l1.4"></a><span id="l1.4"> srcdir		= @srcdir@</span>
<a href="#l1.5"></a><span id="l1.5"> VPATH		= @srcdir@</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7"> include $(DEPTH)/config/autoconf.mk</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> PROTOCOLS = \</span>
<a href="#l1.10"></a><span id="l1.10"> 		facebook \</span>
<a href="#l1.11"></a><span id="l1.11"> 		gtalk \</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+		irc \</span>
<a href="#l1.13"></a><span id="l1.13"> 		twitter \</span>
<a href="#l1.14"></a><span id="l1.14"> 		xmpp \</span>
<a href="#l1.15"></a><span id="l1.15"> 		$(NULL)</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> ifdef MOZ_DEBUG</span>
<a href="#l1.18"></a><span id="l1.18"> PROTOCOLS += jsTest</span>
<a href="#l1.19"></a><span id="l1.19"> endif</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/chat/chat-prefs.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/chat/chat-prefs.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -57,16 +57,19 @@ pref(&quot;messenger.options.messagesStyle.co</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> pref(&quot;messenger.status.reportIdle&quot;, true);</span>
<a href="#l2.6"></a><span id="l2.6"> pref(&quot;messenger.status.timeBeforeIdle&quot;, 300); // 5 minutes</span>
<a href="#l2.7"></a><span id="l2.7"> pref(&quot;messenger.status.awayWhenIdle&quot;, true);</span>
<a href="#l2.8"></a><span id="l2.8"> pref(&quot;messenger.status.defaultIdleAwayMessage&quot;, &quot;chrome://chat/locale/status.properties&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> pref(&quot;messenger.status.userIconFileName&quot;, &quot;&quot;);</span>
<a href="#l2.10"></a><span id="l2.10"> pref(&quot;messenger.status.userDisplayName&quot;, &quot;&quot;);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+// Default message used when quitting IRC. This is overridable per account.</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+pref(&quot;chat.irc.defaultQuitMessage&quot;, &quot;&quot;);</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+</span>
<a href="#l2.15"></a><span id="l2.15"> // loglevel is the minimum severity level that a libpurple message</span>
<a href="#l2.16"></a><span id="l2.16"> // must have to be reported in the Error Console.</span>
<a href="#l2.17"></a><span id="l2.17"> //</span>
<a href="#l2.18"></a><span id="l2.18"> // The possible values are:</span>
<a href="#l2.19"></a><span id="l2.19"> //   0  Show all libpurple messages (PURPLE_DEBUG_ALL)</span>
<a href="#l2.20"></a><span id="l2.20"> //   1  Very verbose (PURPLE_DEBUG_MISC)</span>
<a href="#l2.21"></a><span id="l2.21"> //   2  Verbose (PURPLE_DEBUG_INFO)</span>
<a href="#l2.22"></a><span id="l2.22"> //   3  Show warnings (PURPLE_DEBUG_WARNING)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/chat/components/src/logger.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/chat/components/src/logger.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -97,17 +97,20 @@ function ConversationLog(aConversation)</span>
<a href="#l3.4"></a><span id="l3.4"> {</span>
<a href="#l3.5"></a><span id="l3.5">   this._conv = aConversation;</span>
<a href="#l3.6"></a><span id="l3.6"> }</span>
<a href="#l3.7"></a><span id="l3.7"> ConversationLog.prototype = {</span>
<a href="#l3.8"></a><span id="l3.8">   _log: null,</span>
<a href="#l3.9"></a><span id="l3.9">   format: &quot;txt&quot;,</span>
<a href="#l3.10"></a><span id="l3.10">   _init: function cl_init() {</span>
<a href="#l3.11"></a><span id="l3.11">     let file = getLogFolderForAccount(this._conv.account, true);</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    file.append(this._conv.normalizedName);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    let name = this._conv.normalizedName;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    if (this._conv.isChat &amp;&amp; this._conv.account.protocol.id != &quot;prpl-twitter&quot;)</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+      name += &quot;.chat&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    file.append(name);</span>
<a href="#l3.17"></a><span id="l3.17">     if (!file.exists())</span>
<a href="#l3.18"></a><span id="l3.18">       file.create(Ci.nsIFile.DIRECTORY_TYPE, 0777);</span>
<a href="#l3.19"></a><span id="l3.19">     if (Services.prefs.getCharPref(&quot;purple.logging.format&quot;) == &quot;json&quot;)</span>
<a href="#l3.20"></a><span id="l3.20">       this.format = &quot;json&quot;;</span>
<a href="#l3.21"></a><span id="l3.21">     file.append(getNewLogFileName(this.format));</span>
<a href="#l3.22"></a><span id="l3.22">     let os = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l3.23"></a><span id="l3.23">              createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l3.24"></a><span id="l3.24">     const PR_WRITE_ONLY   = 0x02;</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineat">@@ -438,18 +441,23 @@ Logger.prototype = {</span>
<a href="#l3.26"></a><span id="l3.26">       file.append(aAccountBuddy.normalizedName);</span>
<a href="#l3.27"></a><span id="l3.27">       if (file.exists())</span>
<a href="#l3.28"></a><span id="l3.28">         entries.push(file.directoryEntries);</span>
<a href="#l3.29"></a><span id="l3.29">     });</span>
<a href="#l3.30"></a><span id="l3.30">     return new LogEnumerator(entries);</span>
<a href="#l3.31"></a><span id="l3.31">   },</span>
<a href="#l3.32"></a><span id="l3.32">   getLogsForAccountBuddy: function logger_getLogsForAccountBuddy(aAccountBuddy)</span>
<a href="#l3.33"></a><span id="l3.33">     this._enumerateLogs(aAccountBuddy.account, aAccountBuddy.normalizedName),</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  getLogsForConversation: function logger_getLogsForConversation(aConversation)</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    this._enumerateLogs(aConversation.account, aConversation.normalizedName),</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  getLogsForConversation: function logger_getLogsForConversation(aConversation) {</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+    let name = aConversation.normalizedName;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    if (aConversation.isChat &amp;&amp;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+        aConversation.account.protocol.id != &quot;prpl-twitter&quot;)</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+      name += &quot;.chat&quot;;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+    return this._enumerateLogs(aConversation.account, name);</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  },</span>
<a href="#l3.43"></a><span id="l3.43">   getSystemLogsForAccount: function logger_getSystemLogsForAccount(aAccount)</span>
<a href="#l3.44"></a><span id="l3.44">     this._enumerateLogs(aAccount, &quot;.system&quot;),</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   observe: function logger_observe(aSubject, aTopic, aData) {</span>
<a href="#l3.47"></a><span id="l3.47">     switch (aTopic) {</span>
<a href="#l3.48"></a><span id="l3.48">     case &quot;profile-after-change&quot;:</span>
<a href="#l3.49"></a><span id="l3.49">       Services.obs.addObserver(this, &quot;final-ui-startup&quot;, false);</span>
<a href="#l3.50"></a><span id="l3.50">       break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/chat/locales/en-US/irc.properties</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,148 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+# LOCALIZATION NOTE (connection.*)</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+#   These will be displayed in the account manager in order to show the progress</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+#   of the connection.</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+#   (These will be displayed in account.connection.progress from</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+#    accounts.properties, which adds â€¦ at the end, so do not include</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+#    periods at the end of these messages.)</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+connection.quitting=Sending the QUIT message</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+# LOCALIZATION NOTE (connection.error.*)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#   These will show in the account manager if an error occurs during the</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+#   connection attempt.</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+connection.error.lost=Lost connection with server</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+connection.error.timeOut=Connection timed out</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+connection.error.certError=Certification error when connecting to server</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+# LOCALIZATION NOTE</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+#   These show up on the join chat menu. An underscore is for the access key.</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+joinChat.channel=_Channel</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+joinChat.password=_Password</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+# LOCALIZATION NOTE</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+#   These are the protocol specific options shown in the account manager and</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+#   account wizard windows.</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+options.server=Server</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+options.port=Port</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+options.ssl=Use SSL</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+options.encoding=Character Set</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+options.quitMessage=Quit message</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+options.partMessage=Part message</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+options.showServerTab=Show messages from the server</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+# LOCALIZATION NOTE:</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+#   %1$S is the nickname of the user who was pinged.</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+#   %2$S is the delay (in seconds).</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+ctcp.ping=Ping reply from %1$S in %2$S seconds.</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+#   %1$S is the nickname of the user whose version was requested.</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+#   %2$S is the version response from the client.</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+ctcp.version=%1$S is using &quot;%2$S&quot;</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+#   %1$S is the nickname of the user whose time was requested.</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+#   %2$S is the time response.</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+ctcp.time=The time for %1$S is %2$S.</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+# LOCALZIATION NOTE (command.*):</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+#   These are the help messages for each command, the %S is the command name</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+#   Each command first gives the parameter it accepts and then a description of</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+#   the command.</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+command.action=%S &amp;lt;action to perform&amp;gt;: Perform an action.</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+command.ctcp=%S &amp;lt;nick&amp;gt; &amp;lt;msg&amp;gt;: Sends a CTCP message to the nick.</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+command.chanserv=%S &amp;lt;command&amp;gt;: Send a command to ChanServ.</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+command.deop=%S &amp;lt;nick1&amp;gt;[,&amp;lt;nick2&amp;gt;]*: Remove channel operator status from someone. You must be a channel operator to do this.</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineplus">+command.devoice=%S &amp;lt;nick1&amp;gt;[,&amp;lt;nick2&amp;gt;]*: Remove channel voice status from someone, preventing them from speaking if the channel is moderated (+m). You must be a channel operator to do this.</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineplus">+command.invite=%S &amp;lt;nick&amp;gt; [&amp;lt;room&amp;gt;]: Invite someone to join you in the specified channel, or the current channel.</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineplus">+command.join=%S &amp;lt;room1&amp;gt;[,&amp;lt;room2&amp;gt;]* [&amp;lt;key1&amp;gt;[,&amp;lt;key2&amp;gt;]*]: Enter one or more channels, optionally providing a channel key for each if needed.</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+command.kick=%S &amp;lt;nick&amp;gt; [&amp;lt;message&amp;gt;]: Remove someone from a channel. You must be a channel operator to do this.</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+command.list=%S: Display a list of chat rooms on the network. Warning, some servers may disconnect you upon doing this.</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+command.memoserv=%S &amp;lt;command&amp;gt;: Send a command to MemoServ.</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+command.mode=%S (&amp;lt;nick&amp;gt;|&amp;lt;channel&amp;gt;) (+|-)&amp;lt;new mode&amp;gt;: Set or unset a channel or user mode.</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+command.msg=%S &amp;lt;nick&amp;gt; &amp;lt;message&amp;gt;: Send a private message to a user (as opposed to a channel).</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+command.nick=%S &amp;lt;new nickname&amp;gt;: Change your nickname.</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+command.nickserv=%S &amp;lt;command&amp;gt;: Send a command to NickServ.</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+command.notice=%S &amp;lt;target&amp;gt; &amp;lt;message&amp;gt;: Send a notice to a user or channel.</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+command.op=%S &amp;lt;nick1&amp;gt;[,&amp;lt;nick2&amp;gt;]*: Grant channel operator status to someone. You must be a channel operator to do this.</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+command.operserv=%S &amp;lt;command&amp;gt;: Send a command to OperServ.</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+command.part=%S [message]: Leave the current channel with an optional message.</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+command.ping=%S [&amp;lt;nick&amp;gt;]: Asks how much lag a user (or the server if no user specified) has.</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+command.quit=%S &amp;lt;message&amp;gt;: Disconnect from the server, with an optional message.</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineplus">+command.quote=%S &amp;lt;command&amp;gt;: Send a raw command to the server.</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineplus">+command.time=%S: Displays the current local time at the IRC server.</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+command.topic=%S [&amp;lt;new topic&amp;gt;]: View or change the channel topic.</span>
<a href="#l4.73"></a><span id="l4.73" class="difflineplus">+command.umode=%S (+|-)&amp;lt;new mode&amp;gt;: Set or unset a user mode.</span>
<a href="#l4.74"></a><span id="l4.74" class="difflineplus">+command.version=%S &amp;lt;nick&amp;gt;: Request the version of a user's client.</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineplus">+command.voice=%S &amp;lt;nick1&amp;gt;[,&amp;lt;nick2&amp;gt;]*: Grant channel voice status to someone. You must be a channel operator to do this.</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineplus">+command.wallops=%S &amp;lt;message&amp;gt;: If you don't know what this is, you probably can't use it (sends a command to all connected with the +w flag and all operators on the server.</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+command.whowas=%S &amp;lt;nick&amp;gt;: Get information on a user that has logged off.</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineplus">+</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineplus">+# LOCALIZATION NOTE (message.*):</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineplus">+#    These are shown as system messages in the conversation.</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineplus">+#    %1$S is the nick and %2$S is the nick and host of the user who joined.</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+message.join=%1$S [%2$S] entered the room.</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+#    %1$S is the nick of who kicked you.</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+#    %2$S is message.kicked.reason, if a kick message was given.</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+message.kicked.you=You have been kicked by %1$S%2$S.</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+#    %1$S is the nick that is kicked, %2$S the nick of the person who kicked</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+#    %1$S. %3$S is message.kicked.reason, if a kick message was given.</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+message.kicked=%1$S has been kicked by %2$S%3$S.</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+#    %S is the kick message</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+message.kicked.reason=: %S</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineplus">+#    %1$S is the nickname of the user whose mode was changed, %2$S is the new</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineplus">+#    mode and %3$S is who set the mode.</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineplus">+message.mode=mode (%1$S %2$S) by %3$S.</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineplus">+#    %1$S is the old nick and %2$S is the new nick.</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+message.nick=%1$S is now known as %2$S.</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+#    %S is your new nick.</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+message.nick.you=You are now known as %S.</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+#    The paramter is the message.parted.reason, if a part message is given.</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+message.parted.you=You have left the room (Part%1$S).</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+#    %1$S is the user's nick, %2$S is message.parted.reason, if a part message is given.</span>
<a href="#l4.101"></a><span id="l4.101" class="difflineplus">+message.parted=%1$S has left the room (Part%2$S).</span>
<a href="#l4.102"></a><span id="l4.102" class="difflineplus">+#    %S is the part message supplied by the user.</span>
<a href="#l4.103"></a><span id="l4.103" class="difflineplus">+message.parted.reason=: %S</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineplus">+#    %1$S is the user's nick, %2$S is message.quit2 if a quit message is given.</span>
<a href="#l4.105"></a><span id="l4.105" class="difflineplus">+message.quit=%1$S has left the room (Quit%2$S).</span>
<a href="#l4.106"></a><span id="l4.106" class="difflineplus">+#    The paramter is the quit message given by the user.</span>
<a href="#l4.107"></a><span id="l4.107" class="difflineplus">+message.quit2=: %S</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineplus">+#    %1$S is the user who changed the topic, %2$S is the new topic.</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+message.topicChanged=%1$S has changed the topic to: %2$S.</span>
<a href="#l4.110"></a><span id="l4.110" class="difflineplus">+#    %1$S is the user who cleared the topic.</span>
<a href="#l4.111"></a><span id="l4.111" class="difflineplus">+message.topicCleared=%1$S has cleared the topic.</span>
<a href="#l4.112"></a><span id="l4.112" class="difflineplus">+#    %1$S is the conversation name, %2$S is the topic.</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineplus">+message.topic=The topic for %1$S is: %2$S.</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+#    %S is the conversation name.</span>
<a href="#l4.115"></a><span id="l4.115" class="difflineplus">+message.topicRemoved=The topic for %S was removed.</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineplus">+#    %1$S is the nickname of the invited user, %2$S is the conversation name</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+#    they were invited to.</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+message.invited=%1$S was successfully invited to %2$S.</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+#    %S is the nickname of the user who was summoned.</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+message.summoned=%S was summoned.</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineplus">+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineplus">+# LOCALIZATION NOTE (error.*):</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+#    These are shown as error messages in the conversation.</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+#    %S is the channel name.</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+error.noChannel=There is no channel: %S.</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+error.tooManyChannels=Cannot join %S; you've joined too many channels.</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+#    %1$S is your new nick, %2$S is the kill message from the server.</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+error.nickCollision=Nick already in use, changing nick to %1$S [%2$S].</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+error.banned=You are banned from this server.</span>
<a href="#l4.130"></a><span id="l4.130" class="difflineplus">+error.bannedSoon=You will soon be banned from this server.</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+error.mode.wrongUser=You cannot change modes for other users.</span>
<a href="#l4.132"></a><span id="l4.132" class="difflineplus">+</span>
<a href="#l4.133"></a><span id="l4.133" class="difflineplus">+# LOCALIZATION NOTE (tooltip.*):</span>
<a href="#l4.134"></a><span id="l4.134" class="difflineplus">+#    These are the descriptions given in a tooltip with information received</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineplus">+#    from a whois response.</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+#    The username is set by the user's IRC client, usually to the client's name</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineplus">+#    but the user can change it.</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+tooltip.user=Username</span>
<a href="#l4.139"></a><span id="l4.139" class="difflineplus">+#    The host name that the user connects from (usually based on the</span>
<a href="#l4.140"></a><span id="l4.140" class="difflineplus">+#    reverse DNS of the user's IP, but often mangled by the server to</span>
<a href="#l4.141"></a><span id="l4.141" class="difflineplus">+#    protect users).</span>
<a href="#l4.142"></a><span id="l4.142" class="difflineplus">+tooltip.host=Host name</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineplus">+#    The real name is a description of the user (including spaces).</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+tooltip.realname=Real name</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineplus">+# The away message of the user</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+tooltip.away=Away</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+tooltip.ircOp=IRC Operator</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+tooltip.channels=Currently on</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+tooltip.server=Server</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+#    %1$S is the server name, %2$S is the server location.</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+tooltip.serverValue=%1$S (%2$S)</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+tooltip.idleTime=Idle for</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/chat/locales/jar.mn</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/chat/locales/jar.mn</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,11 +1,12 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #filter substitution</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> @AB_CD@.jar:</span>
<a href="#l5.7"></a><span id="l5.7"> % locale chat @AB_CD@ %locale/@AB_CD@/chat/</span>
<a href="#l5.8"></a><span id="l5.8"> 	locale/@AB_CD@/chat/accounts.properties (%accounts.properties)</span>
<a href="#l5.9"></a><span id="l5.9"> 	locale/@AB_CD@/chat/commands.properties (%commands.properties)</span>
<a href="#l5.10"></a><span id="l5.10"> 	locale/@AB_CD@/chat/conversations.properties (%conversations.properties)</span>
<a href="#l5.11"></a><span id="l5.11"> 	locale/@AB_CD@/chat/facebook.properties	(%facebook.properties)</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+	locale/@AB_CD@/chat/irc.properties	(%irc.properties)</span>
<a href="#l5.13"></a><span id="l5.13"> 	locale/@AB_CD@/chat/status.properties	(%status.properties)</span>
<a href="#l5.14"></a><span id="l5.14"> 	locale/@AB_CD@/chat/twitter.properties	(%twitter.properties)</span>
<a href="#l5.15"></a><span id="l5.15"> 	locale/@AB_CD@/chat/xmpp.properties	(%xmpp.properties)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/chat/makefiles.sh</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/chat/makefiles.sh</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,13 +38,14 @@ add_makefiles &quot;</span>
<a href="#l6.4"></a><span id="l6.4"> chat/Makefile</span>
<a href="#l6.5"></a><span id="l6.5"> chat/components/public/Makefile</span>
<a href="#l6.6"></a><span id="l6.6"> chat/components/src/Makefile</span>
<a href="#l6.7"></a><span id="l6.7"> chat/content/Makefile</span>
<a href="#l6.8"></a><span id="l6.8"> chat/locales/Makefile</span>
<a href="#l6.9"></a><span id="l6.9"> chat/modules/Makefile</span>
<a href="#l6.10"></a><span id="l6.10"> chat/protocols/facebook/Makefile</span>
<a href="#l6.11"></a><span id="l6.11"> chat/protocols/gtalk/Makefile</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+chat/protocols/irc/Makefile</span>
<a href="#l6.13"></a><span id="l6.13"> chat/protocols/jsTest/Makefile</span>
<a href="#l6.14"></a><span id="l6.14"> chat/protocols/twitter/Makefile</span>
<a href="#l6.15"></a><span id="l6.15"> chat/protocols/xmpp/Makefile</span>
<a href="#l6.16"></a><span id="l6.16"> chat/themes/Makefile</span>
<a href="#l6.17"></a><span id="l6.17"> &quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/chat/modules/imXPCOMUtils.jsm</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -109,17 +109,18 @@ function setTimeout(aFunction, aDelay)</span>
<a href="#l7.4"></a><span id="l7.4">     _timer: timer,</span>
<a href="#l7.5"></a><span id="l7.5">     notify: function (aTimer) { aFunction.apply(null, args); delete this._timer; }</span>
<a href="#l7.6"></a><span id="l7.6">   };</span>
<a href="#l7.7"></a><span id="l7.7">   timer.initWithCallback(callback, aDelay, Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l7.8"></a><span id="l7.8">   return timer;</span>
<a href="#l7.9"></a><span id="l7.9"> }</span>
<a href="#l7.10"></a><span id="l7.10"> function clearTimeout(aTimer)</span>
<a href="#l7.11"></a><span id="l7.11"> {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  aTimer.cancel();</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+  if (aTimer)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+    aTimer.cancel();</span>
<a href="#l7.15"></a><span id="l7.15"> }</span>
<a href="#l7.16"></a><span id="l7.16"> </span>
<a href="#l7.17"></a><span id="l7.17"> function executeSoon(aFunction)</span>
<a href="#l7.18"></a><span id="l7.18"> {</span>
<a href="#l7.19"></a><span id="l7.19">   Services.tm.mainThread.dispatch(aFunction, Ci.nsIEventTarget.DISPATCH_NORMAL);</span>
<a href="#l7.20"></a><span id="l7.20"> }</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> // Similar to Object.hasOwnProperty, but doesn't fail if the object</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/chat/modules/jsProtoHelper.jsm</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/chat/modules/jsProtoHelper.jsm</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -96,16 +96,17 @@ const ForwardAccountPrototype = {</span>
<a href="#l8.4"></a><span id="l8.4">   get noImages() this._base.noImages,</span>
<a href="#l8.5"></a><span id="l8.5">   get maxMessageLength() this._base.maxMessageLength,</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   set proxyInfo(val) { this._base.proxyInfo = val; }</span>
<a href="#l8.8"></a><span id="l8.8"> };</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> const GenericAccountPrototype = {</span>
<a href="#l8.11"></a><span id="l8.11">   __proto__: ClassInfo(&quot;prplIAccount&quot;, &quot;generic account object&quot;),</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+  get wrappedJSObject() this,</span>
<a href="#l8.13"></a><span id="l8.13">   _init: function _init(aProtocol, aImAccount) {</span>
<a href="#l8.14"></a><span id="l8.14">     this.protocol = aProtocol;</span>
<a href="#l8.15"></a><span id="l8.15">     this.imAccount = aImAccount;</span>
<a href="#l8.16"></a><span id="l8.16">   },</span>
<a href="#l8.17"></a><span id="l8.17">   observe: function(aSubject, aTopic, aData) {},</span>
<a href="#l8.18"></a><span id="l8.18">   unInit: function() {},</span>
<a href="#l8.19"></a><span id="l8.19">   connect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l8.20"></a><span id="l8.20">   disconnect: function() { throw Cr.NS_ERROR_NOT_IMPLEMENTED; },</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineat">@@ -406,16 +407,17 @@ function Message(aWho, aMessage, aObject</span>
<a href="#l8.22"></a><span id="l8.22">   this._init(aWho, aMessage, aObject);</span>
<a href="#l8.23"></a><span id="l8.23"> }</span>
<a href="#l8.24"></a><span id="l8.24"> Message.prototype = GenericMessagePrototype;</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> const GenericConversationPrototype = {</span>
<a href="#l8.28"></a><span id="l8.28">   __proto__: ClassInfo(&quot;prplIConversation&quot;, &quot;generic conversation object&quot;),</span>
<a href="#l8.29"></a><span id="l8.29">   flags: Ci.nsIClassInfo.DOM_OBJECT,</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  get wrappedJSObject() this,</span>
<a href="#l8.31"></a><span id="l8.31"> </span>
<a href="#l8.32"></a><span id="l8.32">   _init: function(aAccount, aName) {</span>
<a href="#l8.33"></a><span id="l8.33">     this._account = aAccount;</span>
<a href="#l8.34"></a><span id="l8.34">     this._name = aName;</span>
<a href="#l8.35"></a><span id="l8.35">     this._observers = [];</span>
<a href="#l8.36"></a><span id="l8.36">     Services.conversations.addConversation(this);</span>
<a href="#l8.37"></a><span id="l8.37">   },</span>
<a href="#l8.38"></a><span id="l8.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/chat/modules/socket.jsm</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/chat/modules/socket.jsm</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -127,20 +127,16 @@ const Socket = {</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   // Set this for binary mode to split after a certain number of bytes have</span>
<a href="#l9.6"></a><span id="l9.6">   // been received.</span>
<a href="#l9.7"></a><span id="l9.7">   inputSegmentSize: 0,</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9">   // Set this for the segment size of outgoing binary streams.</span>
<a href="#l9.10"></a><span id="l9.10">   outputSegmentSize: 0,</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  // Use this to specify a URI scheme to the hostname when resolving the proxy,</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  // this may be unnecessary for some protocols.</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-  uriScheme: &quot;http://&quot;,</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-</span>
<a href="#l9.16"></a><span id="l9.16">   // Flags used by nsIProxyService when resolving a proxy.</span>
<a href="#l9.17"></a><span id="l9.17">   proxyFlags: Ci.nsIProtocolProxyService.RESOLVE_PREFER_SOCKS_PROXY,</span>
<a href="#l9.18"></a><span id="l9.18"> </span>
<a href="#l9.19"></a><span id="l9.19">   // Time (in seconds) for nsISocketTransport to continue trying before</span>
<a href="#l9.20"></a><span id="l9.20">   // reporting a failure, 0 is forever.</span>
<a href="#l9.21"></a><span id="l9.21">   connectTimeout: 0,</span>
<a href="#l9.22"></a><span id="l9.22">   readWriteTimeout: 0,</span>
<a href="#l9.23"></a><span id="l9.23"> </span>
<a href="#l9.24"></a><span id="l9.24" class="difflineat">@@ -165,19 +161,20 @@ const Socket = {</span>
<a href="#l9.25"></a><span id="l9.25">     else {</span>
<a href="#l9.26"></a><span id="l9.26">       try {</span>
<a href="#l9.27"></a><span id="l9.27">         // Attempt to get a default proxy from the proxy service.</span>
<a href="#l9.28"></a><span id="l9.28">         let proxyService = Cc[&quot;@mozilla.org/network/protocol-proxy-service;1&quot;]</span>
<a href="#l9.29"></a><span id="l9.29">                               .getService(Ci.nsIProtocolProxyService);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31">         // Add a URI scheme since, by default, some protocols (i.e. IRC) don't</span>
<a href="#l9.32"></a><span id="l9.32">         // have a URI scheme before the host.</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-        let uri = Services.io.newURI(this.uriScheme + this.host, null, null);</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineplus">+        let uri = Services.io.newURI(&quot;http://&quot; + this.host, null, null);</span>
<a href="#l9.35"></a><span id="l9.35">         this._proxyCancel = proxyService.asyncResolve(uri, this.proxyFlags, this);</span>
<a href="#l9.36"></a><span id="l9.36">       } catch(e) {</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l9.38"></a><span id="l9.38">         // We had some error getting the proxy service, just don't use one.</span>
<a href="#l9.39"></a><span id="l9.39">         this._createTransport(null);</span>
<a href="#l9.40"></a><span id="l9.40">       }</span>
<a href="#l9.41"></a><span id="l9.41">     }</span>
<a href="#l9.42"></a><span id="l9.42">   },</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44">   // Reconnect to the current settings stored in the socket.</span>
<a href="#l9.45"></a><span id="l9.45">   reconnect: function() {</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineat">@@ -224,35 +221,38 @@ const Socket = {</span>
<a href="#l9.47"></a><span id="l9.47">   // Stop listening for a connection.</span>
<a href="#l9.48"></a><span id="l9.48">   stopListening: function() {</span>
<a href="#l9.49"></a><span id="l9.49">     this.log(&quot;Stop listening&quot;);</span>
<a href="#l9.50"></a><span id="l9.50">     // Close the socket to stop listening.</span>
<a href="#l9.51"></a><span id="l9.51">     if (&quot;serverSocket&quot; in this)</span>
<a href="#l9.52"></a><span id="l9.52">       this.serverSocket.close();</span>
<a href="#l9.53"></a><span id="l9.53">   },</span>
<a href="#l9.54"></a><span id="l9.54"> </span>
<a href="#l9.55"></a><span id="l9.55" class="difflineminus">-  // Send data on the output stream.</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineminus">-  sendData: function(/* string */ aData) {</span>
<a href="#l9.57"></a><span id="l9.57" class="difflineminus">-    this.log(&quot;Sending:\n&quot; + aData + &quot;\n&quot;);</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+  // Send data on the output stream. Provide aLoggedData to log something</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+  // different than what is actually sent.</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+  sendData: function(/* string */ aData, aLoggedData) {</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+    this.log(&quot;Sending:\n&quot; + (aLoggedData || aData));</span>
<a href="#l9.62"></a><span id="l9.62"> </span>
<a href="#l9.63"></a><span id="l9.63">     try {</span>
<a href="#l9.64"></a><span id="l9.64">       this._outputStream.write(aData + this.delimiter,</span>
<a href="#l9.65"></a><span id="l9.65">                                aData.length + this.delimiter.length);</span>
<a href="#l9.66"></a><span id="l9.66">     } catch(e) {</span>
<a href="#l9.67"></a><span id="l9.67">       Cu.reportError(e);</span>
<a href="#l9.68"></a><span id="l9.68">     }</span>
<a href="#l9.69"></a><span id="l9.69">   },</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71" class="difflineminus">-  sendString: function(aString, aEncoding) {</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineminus">-    this.log(&quot;Sending:\n&quot; + aString + &quot;\n&quot;);</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+  // Send a string to the output stream after converting the encoding. Provide</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+  // aLoggedData to log something different than what is actually sent.</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  sendString: function(aString, aEncoding, aLoggedData) {</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+    this.log(&quot;Sending:\n&quot; + (aLoggedData || aString));</span>
<a href="#l9.77"></a><span id="l9.77"> </span>
<a href="#l9.78"></a><span id="l9.78">     let converter = new ScriptableUnicodeConverter();</span>
<a href="#l9.79"></a><span id="l9.79">     converter.charset = aEncoding || &quot;UTF-8&quot;;</span>
<a href="#l9.80"></a><span id="l9.80">     try {</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineminus">-      let stream = converter.convertToInputStream(aString);</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+      let stream = converter.convertToInputStream(aString + this.delimiter);</span>
<a href="#l9.83"></a><span id="l9.83">       this._outputStream.writeFrom(stream, stream.available());</span>
<a href="#l9.84"></a><span id="l9.84">     } catch(e) {</span>
<a href="#l9.85"></a><span id="l9.85">       Cu.reportError(e);</span>
<a href="#l9.86"></a><span id="l9.86">     }</span>
<a href="#l9.87"></a><span id="l9.87">   },</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">   sendBinaryData: function(/* ArrayBuffer */ aData) {</span>
<a href="#l9.90"></a><span id="l9.90">     this.log(&quot;Sending binary data data: &lt;&quot; + aData + &quot;&gt;&quot;);</span>
<a href="#l9.91"></a><span id="l9.91" class="difflineat">@@ -285,16 +285,20 @@ const Socket = {</span>
<a href="#l9.92"></a><span id="l9.92">    *****************************************************************************</span>
<a href="#l9.93"></a><span id="l9.93">    ***************************** Interface methods *****************************</span>
<a href="#l9.94"></a><span id="l9.94">    *****************************************************************************</span>
<a href="#l9.95"></a><span id="l9.95">    */</span>
<a href="#l9.96"></a><span id="l9.96">   /*</span>
<a href="#l9.97"></a><span id="l9.97">    * nsIProtocolProxyCallback methods</span>
<a href="#l9.98"></a><span id="l9.98">    */</span>
<a href="#l9.99"></a><span id="l9.99">   onProxyAvailable: function(aRequest, aURI, aProxyInfo, aStatus) {</span>
<a href="#l9.100"></a><span id="l9.100" class="difflineplus">+    if (aProxyInfo) {</span>
<a href="#l9.101"></a><span id="l9.101" class="difflineplus">+      this.log(&quot;using &quot; + aProxyInfo.type + &quot; proxy: &quot; +</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineplus">+               aProxyInfo.host + &quot;:&quot; + aProxyInfo.port);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    }</span>
<a href="#l9.104"></a><span id="l9.104">     this._createTransport(aProxyInfo);</span>
<a href="#l9.105"></a><span id="l9.105">     delete this._proxyCancel;</span>
<a href="#l9.106"></a><span id="l9.106">   },</span>
<a href="#l9.107"></a><span id="l9.107"> </span>
<a href="#l9.108"></a><span id="l9.108">   /*</span>
<a href="#l9.109"></a><span id="l9.109">    * nsIServerSocketListener methods</span>
<a href="#l9.110"></a><span id="l9.110">    */</span>
<a href="#l9.111"></a><span id="l9.111">   // Called after a client connection is accepted when we're listening for one.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">new file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- /dev/null</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ b/chat/protocols/irc/Makefile.in</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -0,0 +1,64 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineplus">+# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineplus">+# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineplus">+#</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineplus">+# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineplus">+# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+# the License. You may obtain a copy of the License at</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+# http://www.mozilla.org/MPL/</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+# for the specific language governing rights and limitations under the</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+# License.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+#</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineplus">+# The Original Code is Instantbird.</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+#</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+# The Initial Developer of the Original Code is</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+# Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+# Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineplus">+# the Initial Developer. All Rights Reserved.</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineplus">+#</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineplus">+# Contributor(s):</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+#</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineplus">+# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineplus">+# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineplus">+# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineplus">+# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineplus">+# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineplus">+# the provisions above, a recipient may use your version of this file under</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineplus">+# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+#</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineplus">+# ***** END LICENSE BLOCK *****</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+DEPTH		= ../../..</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+topsrcdir	= @top_srcdir@</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+srcdir		= @srcdir@</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineplus">+VPATH		= @srcdir@</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineplus">+</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineplus">+include $(DEPTH)/config/autoconf.mk</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineplus">+</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineplus">+EXTRA_COMPONENTS = \</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineplus">+		irc.js \</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+		irc.manifest \</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+		$(NULL)</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+EXTRA_JS_MODULES = \</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+		ircBase.jsm \</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineplus">+		ircCTCP.jsm \</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineplus">+		ircDCC.jsm \</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+		ircCommands.jsm \</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+		ircHandlers.jsm \</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineplus">+		ircISUPPORT.jsm \</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+		ircUtils.jsm \</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+		$(NULL)</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineplus">+ifdef ENABLE_TESTS</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+relativesrcdir = chat/protocols/irc</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineplus">+XPCSHELL_TESTS = test</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineplus">+endif</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineplus">+include $(topsrcdir)/config/rules.mk</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..003103914c44cf260b957fc4f8928264212ca418</span>
<a href="#l11.3"></a><span id="l11.3">GIT binary patch
literal 695
zc$@*Z0!aOdP)&lt;h;3K|Lk000e1NJLTq001BW001Be1^@s6b9#F800004b3#c}2nYxW
zd&lt;bNS00009a7bBm000R(000R(0q|s!N&amp;o-=8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H10yIfPK~z|U?Uyl&amp;8c`6(|MNVv;$}s1+y@8;se)C4l3;Cd3FJGZ
zUyp!IU=_5oyG&gt;_pC29NuqD`(60vZWiilCqbLM~yAup0MGimaDaP7n7mo5F!D-rF}b
zznS^N;}J6&gt;NE3l(-vj&amp;)00-MT7&gt;02_7K@z$IP#J2t7TcIrBdm$Zvaix-srmiOo;89
zC#8gGngYOc-vC5(D1^XdGT9nHRaFqtp?5EE4FnFbGy=mgjx|j)iRj)2pNF+t4N}Ub
zO+`_VOePVJ$NdAuVzDz_*H8QktX{7plgao80B|dTO{deX{Q}p(9$*g;IKb9-!6p+z
zAR3KctsTd~Y&amp;JtA5&amp;;oGN(pBEzB7Q)X!O%G&amp;5v$!kxHeG)9G})*=$&lt;9Uhl$joXhce
ze7Z9LBI@RHxhIQtKA(R&amp;91h&gt;ww(VrI*~i!U&gt;{J8AV)0$4(|I%)4BoFhvvU!a%jJ;}
z;&gt;EiEt0VX(rG%=gkW#|7Z77O@P$-0(-VY0b5z!s*HZ#u)g@Rn?w*+8W)+^IA52Tbw
ziA3T-CX&gt;+`jmD35yL};qU}h%wD6M|XeA(@G3jpqVLe7au0$&gt;0RfH^bIy*bHS84(eH
zFo1BSQu(AP3N;#ym(^&lt;Z!^ZO0+tdYg0L%f*0Q_R+*|i&lt;;R3!TSe*66V{B^6&lt;`U3x2
zaR5Z{rvv21AtEAnE2q`j5&gt;dzn3%d@E8^Dh(Ix6wE3v*_6t`2Mxmpc;hEncuU#n=e&amp;
dFD&amp;rO=r;q`=+rK*U1b0O002ovPDHLkV1f@IEHwZC</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..606425fabb7aa1d5e9e490ad5d74bc55c4c94262</span>
<a href="#l12.3"></a><span id="l12.3">GIT binary patch
literal 1003
zc$@+20~Gv;P)&lt;h;3K|Lk000e1NJLTq001xm001xu1^@s6R|5Hm00004b3#c}2nYxW
zd&lt;bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H1187M^K~!jg?U=t$BS#d+zi+%+yV$I+Kr(0}Aw^M&amp;6Dgw9`~gWS
znp2ukAkt7pbb!S+wu=ZX3W}Uk5k&gt;M&lt;oP?AJQV=0gQKW*TqJR@Q5nG#h5zb^iKT=&gt;5
zo9u$QTeMi(k2LaXy!)N^-Fa_Dv!u1gFvF4#;B83_Bu#1{X;K48W5g-8w6ye@VHn&gt;k
zrN-jaWsJQRLVQ^+mw&amp;kVU#tcU!+1VFKR;&amp;McAT&gt;CeSfT4tv(0v?*GP&amp;b0DRZW7{^G
z&amp;1Rgk$mjD=N;zTw4Sfxy29hQ&lt;kTjvI(89vP$JuOlg@``5k60#?LA6&gt;%)EOh6&amp;tr0O
z5~HJ|ZxCuYp$4+q?02)Xvrh|!LTm#8!1?((Ha9mhJv|+pW~c!v&lt;x|ITaB*=F+du%|
zI1cLddaRnaZe&amp;WSSO&lt;FuhQ5eX14)w_NSf3@(hR+USWjew5_RMZf&amp;iRz&lt;Z?Nfrg`1p
zYPG-^I}dv%5d)P&lt;rQNwC0MJ^)vMf0&gt;Gn2I}3q*vqwKdUhw-o?z&amp;Rar=ufntvNg*la
z6Dj2r&amp;+}~0^K7NmJB&gt;!;lhxJL=IQCFmQup^{ogs~1&lt;rZl=;&amp;yqTrR%|(@JCpT-R-d
zbpKo|7C+qB*!XE;V&amp;Z)wQm*U%b(hwoD&amp;kV9^olX|(c$6YOCiKRgFKVS4BUq6x*Wi&gt;
z#l^)&gt;2f6=I%|I`eO6A8v?t8Qb1|&gt;9w7-PN=!nQ2yx-SR&lt;1VI4PH2c=*`yhk&gt;5&amp;1+E
zmAXo6eXmngsE|^sw6d~N8Xq4I0Kha&amp;V`^$DXBY;w*4WzG;&gt;~7L5)lBP_qTi9g^0iy
z(*SUCa$&lt;7MzXp(th({8U2GHA-)&gt;=jxpr|hhb8~Z!VHocTA=t&gt;s$ctjJIC^&lt;`iS_mM
zzw7mS(eu1twAKUwjIr*9L}7j1&gt;$9`7SG&amp;8re?$cXppC1|O#@IpO#+Z%MnY$Rh%x}`
z0R9A!SzcZa4h|0F&amp;dyHr`1ttqTCMimEkWEx)Z0fV_{@#KMW-J`gqtR!a*=u(lTwQ9
z?d@Op_V&amp;Km-`{@?;LVEQZm6RzI!)thp;0~Y^buvCF9&amp;_!|E5-}ecxy_x^Lv6K36CJ
z0s7NN-H4};$QtORQMa+47Fkd+Vc;G$5NY80hASfs|4m_6{2}PRq_&lt;y%hJ~TuiBkhf
Z^Dp&gt;tY{BBgkX!%&amp;002ovPDHLkV1o1+&amp;{Y5c</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">new file mode 100644</span>
<a href="#l13.2"></a><span id="l13.2">index e69de29bb2d1d6434b8b29ae775ad8c2e48c5391..19d578deda123c41b441aef78f147fdf74bd426d</span>
<a href="#l13.3"></a><span id="l13.3">GIT binary patch
literal 454
zc$@*o0XhDOP)&lt;h;3K|Lk000e1NJLTq000mG000mO1^@s6AM^iV00004b3#c}2nYxW
zd&lt;bNS00009a7bBm000fw000fw0YWI7cmMzZ8FWQhbW?9;ba!ELWdL_~cP?peYja~^
zaAhuUa%Y?FJQ@H10YgbdK~y-6rIRsk!Y~wuf8$utFeE()ONShwW2UYgp&lt;Bm90fy94
zrb&lt;0UyHzY%A_fkS3-lDFOM;s`UI#!GkN{DC$+Dg-eeeChZNbbq)@(L=tEy^za&amp;RQ2
z)H|5@WCcOMbzSp0)pgB55U|xomr`Q2TD5j}T^9h*yENt{{TpDl1r~&lt;kK|LCc;QRh5
zpsK2|)*4dE)-FVZ$z;+D0Im;gI2=Ms2_XcC=nrtM@;o=5=k&gt;MLv|g`;Qfl4_kf!O&amp;
zVzGEC%kl=mZ5+qnoo+#E9Ti1!2Ve=n039s=K$0Y%0Pgp-1#DAx90$w{B7$Wda`%BX
z$x=#vOsCU_!C=5q6v;f#O_pVSBI3&lt;v!~6fCl$tjI1T!NHLkGZ@ZQG?W=9P$^0sH_E
w*uK_Yk|d^ag57QaEQ_Le+&lt;823a3&amp;J`0+wL8z&amp;BAwA^-pY07*qoM6N&lt;$f&gt;sE!&gt;;M1&amp;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">new file mode 100644</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineminus">--- /dev/null</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineplus">+++ b/chat/protocols/irc/irc.js</span>
<a href="#l14.4"></a><span id="l14.4" class="difflineat">@@ -0,0 +1,917 @@</span>
<a href="#l14.5"></a><span id="l14.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l14.6"></a><span id="l14.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l14.7"></a><span id="l14.7" class="difflineplus">+ *</span>
<a href="#l14.8"></a><span id="l14.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l14.9"></a><span id="l14.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l14.10"></a><span id="l14.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l14.11"></a><span id="l14.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+ *</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+ * License.</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+ *</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineplus">+ *</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2010</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+ *</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+ *</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+ *</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l14.40"></a><span id="l14.40" class="difflineplus">+</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineplus">+const {classes: Cc, interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineplus">+</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineplus">+Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineplus">+Cu.import(&quot;resource:///modules/socket.jsm&quot;);</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineplus">+</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+// Parses a raw IRC message into an object (see section 2.3 of RFC 2812).</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineplus">+function ircMessage(aData) {</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineplus">+  LOG(aData);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineplus">+  let message = {rawMessage: aData};</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineplus">+  let temp;</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineplus">+</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineplus">+  // Splits the raw string into four parts (the second is required), the command</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineplus">+  // is required. A raw string looks like:</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineplus">+  //   [&quot;:&quot; &lt;source&gt; &quot; &quot;] &lt;command&gt; [&quot; &quot; &lt;parameter&gt;]* [&quot;:&quot; &lt;last parameter&gt;]</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  //     &lt;source&gt;: :(&lt;server url&gt; | &lt;nickname&gt; [[&quot;!&quot; &lt;user&gt;] &quot;@&quot; &lt;host&gt;])</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+  //     &lt;command&gt;: /[^ ]+/</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+  //     &lt;parameter&gt;: /[^ ]+/</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  //     &lt;last parameter&gt;: /.+/</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  // See http://joshualuckers.nl/2010/01/10/regular-expression-to-match-raw-irc-messages/</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  if ((temp = aData.match(/^(?::([^ ]+) )?([^ ]+)(?: ((?:[^: ][^ ]* ?)*))?(?: ?:(.*))?$/))) {</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+    // Assume message is from the server if not specified</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+    message.source = temp[1] || this._server;</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+    message.command = temp[2];</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    // Space separated parameters</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+    message.params = temp[3] ? temp[3].trim().split(/ +/) : [];</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    if (temp[4]) // Last parameter can contain spaces</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+      message.params.push(temp[4]);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+    // The source string can be split into multiple parts as:</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+    //   :(server|nickname[[!user]@host]</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+    // If the source contains a . or a :, assume it's a server name. See RFC</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineplus">+    // 2812 Section 2.3 definition of servername vs. nickname.</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+    if (message.source &amp;&amp;</span>
<a href="#l14.78"></a><span id="l14.78" class="difflineplus">+        (temp = message.source.match(/^([^ !@\.:]+)(?:!([^ @]+))?(?:@([^ ]+))?$/))) {</span>
<a href="#l14.79"></a><span id="l14.79" class="difflineplus">+      message.nickname = temp[1];</span>
<a href="#l14.80"></a><span id="l14.80" class="difflineplus">+      message.user = temp[2] || null; // Optional</span>
<a href="#l14.81"></a><span id="l14.81" class="difflineplus">+      message.host = temp[3] || null; // Optional</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineplus">+    }</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineplus">+  }</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+</span>
<a href="#l14.85"></a><span id="l14.85" class="difflineplus">+  return message;</span>
<a href="#l14.86"></a><span id="l14.86" class="difflineplus">+}</span>
<a href="#l14.87"></a><span id="l14.87" class="difflineplus">+</span>
<a href="#l14.88"></a><span id="l14.88" class="difflineplus">+function ircChannel(aAccount, aName, aNick) {</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineplus">+  this._init(aAccount, aName, aNick);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+}</span>
<a href="#l14.91"></a><span id="l14.91" class="difflineplus">+ircChannel.prototype = {</span>
<a href="#l14.92"></a><span id="l14.92" class="difflineplus">+  __proto__: GenericConvChatPrototype,</span>
<a href="#l14.93"></a><span id="l14.93" class="difflineplus">+  sendMsg: function(aMessage) {</span>
<a href="#l14.94"></a><span id="l14.94" class="difflineplus">+    this._account.sendMessage(&quot;PRIVMSG&quot;, [this.name, aMessage]);</span>
<a href="#l14.95"></a><span id="l14.95" class="difflineplus">+</span>
<a href="#l14.96"></a><span id="l14.96" class="difflineplus">+    // Since we don't receive a message back from the server, just assume it</span>
<a href="#l14.97"></a><span id="l14.97" class="difflineplus">+    // was received and write it. An IRC bouncer will send us our message back</span>
<a href="#l14.98"></a><span id="l14.98" class="difflineplus">+    // though, try to handle that.</span>
<a href="#l14.99"></a><span id="l14.99" class="difflineplus">+    if (this.hasParticipant(this._account._nickname))</span>
<a href="#l14.100"></a><span id="l14.100" class="difflineplus">+      this.writeMessage(this.nick, aMessage, {outgoing: true});</span>
<a href="#l14.101"></a><span id="l14.101" class="difflineplus">+  },</span>
<a href="#l14.102"></a><span id="l14.102" class="difflineplus">+  // Overwrite the writeMessage function to apply CTCP formatting before</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineplus">+  // display.</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  writeMessage: function(aWho, aText, aProperties) {</span>
<a href="#l14.105"></a><span id="l14.105" class="difflineplus">+    GenericConvChatPrototype.writeMessage.call(this, aWho,</span>
<a href="#l14.106"></a><span id="l14.106" class="difflineplus">+                                               ctcpFormatToHTML(aText),</span>
<a href="#l14.107"></a><span id="l14.107" class="difflineplus">+                                               aProperties);</span>
<a href="#l14.108"></a><span id="l14.108" class="difflineplus">+  },</span>
<a href="#l14.109"></a><span id="l14.109" class="difflineplus">+</span>
<a href="#l14.110"></a><span id="l14.110" class="difflineplus">+  // Section 3.2.2 of RFC 2812.</span>
<a href="#l14.111"></a><span id="l14.111" class="difflineplus">+  part: function(aMessage) {</span>
<a href="#l14.112"></a><span id="l14.112" class="difflineplus">+    let params = [this.name];</span>
<a href="#l14.113"></a><span id="l14.113" class="difflineplus">+</span>
<a href="#l14.114"></a><span id="l14.114" class="difflineplus">+    // If a valid message was given, use it as the part message.</span>
<a href="#l14.115"></a><span id="l14.115" class="difflineplus">+    // Otherwise, fall back to the default part message, if it exists.</span>
<a href="#l14.116"></a><span id="l14.116" class="difflineplus">+    let msg = aMessage || this._account.getString(&quot;partmsg&quot;);</span>
<a href="#l14.117"></a><span id="l14.117" class="difflineplus">+    if (msg)</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineplus">+      params.push(msg);</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineplus">+</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+    this._account.sendMessage(&quot;PART&quot;, params);</span>
<a href="#l14.121"></a><span id="l14.121" class="difflineplus">+  },</span>
<a href="#l14.122"></a><span id="l14.122" class="difflineplus">+</span>
<a href="#l14.123"></a><span id="l14.123" class="difflineplus">+  unInit: function() {</span>
<a href="#l14.124"></a><span id="l14.124" class="difflineplus">+    // Tell the server about the part if connected.</span>
<a href="#l14.125"></a><span id="l14.125" class="difflineplus">+    if (this._account.connected)</span>
<a href="#l14.126"></a><span id="l14.126" class="difflineplus">+      this.part();</span>
<a href="#l14.127"></a><span id="l14.127" class="difflineplus">+</span>
<a href="#l14.128"></a><span id="l14.128" class="difflineplus">+    // Always remove the conversation.</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineplus">+    this._account.removeConversation(this.name);</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+</span>
<a href="#l14.131"></a><span id="l14.131" class="difflineplus">+    GenericConvChatPrototype.unInit.call(this);</span>
<a href="#l14.132"></a><span id="l14.132" class="difflineplus">+  },</span>
<a href="#l14.133"></a><span id="l14.133" class="difflineplus">+</span>
<a href="#l14.134"></a><span id="l14.134" class="difflineplus">+  getNormalizedChatBuddyName: function(aNick)</span>
<a href="#l14.135"></a><span id="l14.135" class="difflineplus">+    this._account.normalize(aNick, this._account.userPrefixes),</span>
<a href="#l14.136"></a><span id="l14.136" class="difflineplus">+</span>
<a href="#l14.137"></a><span id="l14.137" class="difflineplus">+  hasParticipant: function(aNick)</span>
<a href="#l14.138"></a><span id="l14.138" class="difflineplus">+    hasOwnProperty(this._participants, this.getNormalizedChatBuddyName(aNick)),</span>
<a href="#l14.139"></a><span id="l14.139" class="difflineplus">+</span>
<a href="#l14.140"></a><span id="l14.140" class="difflineplus">+  getParticipant: function(aNick, aNotifyObservers) {</span>
<a href="#l14.141"></a><span id="l14.141" class="difflineplus">+    let normalizedNick = this.getNormalizedChatBuddyName(aNick);</span>
<a href="#l14.142"></a><span id="l14.142" class="difflineplus">+    if (this.hasParticipant(aNick))</span>
<a href="#l14.143"></a><span id="l14.143" class="difflineplus">+      return this._participants[normalizedNick];</span>
<a href="#l14.144"></a><span id="l14.144" class="difflineplus">+</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineplus">+    let participant = new ircParticipant(aNick, this._account);</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+    this._participants[normalizedNick] = participant;</span>
<a href="#l14.147"></a><span id="l14.147" class="difflineplus">+    if (aNotifyObservers) {</span>
<a href="#l14.148"></a><span id="l14.148" class="difflineplus">+      this.notifyObservers(new nsSimpleEnumerator([participant]),</span>
<a href="#l14.149"></a><span id="l14.149" class="difflineplus">+                           &quot;chat-buddy-add&quot;);</span>
<a href="#l14.150"></a><span id="l14.150" class="difflineplus">+    }</span>
<a href="#l14.151"></a><span id="l14.151" class="difflineplus">+    return participant;</span>
<a href="#l14.152"></a><span id="l14.152" class="difflineplus">+  },</span>
<a href="#l14.153"></a><span id="l14.153" class="difflineplus">+  updateNick: function(aOldNick, aNewNick) {</span>
<a href="#l14.154"></a><span id="l14.154" class="difflineplus">+    if (!this.hasParticipant(aOldNick)) {</span>
<a href="#l14.155"></a><span id="l14.155" class="difflineplus">+      ERROR(&quot;Trying to rename nick that doesn't exist! &quot; + aOldNick + &quot; to &quot; +</span>
<a href="#l14.156"></a><span id="l14.156" class="difflineplus">+            aNewNick);</span>
<a href="#l14.157"></a><span id="l14.157" class="difflineplus">+      return;</span>
<a href="#l14.158"></a><span id="l14.158" class="difflineplus">+    }</span>
<a href="#l14.159"></a><span id="l14.159" class="difflineplus">+</span>
<a href="#l14.160"></a><span id="l14.160" class="difflineplus">+    // Get the original ircParticipant and then remove it.</span>
<a href="#l14.161"></a><span id="l14.161" class="difflineplus">+    let participant = this.getParticipant(aOldNick);</span>
<a href="#l14.162"></a><span id="l14.162" class="difflineplus">+    this.removeParticipant(aOldNick);</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineplus">+</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+    // Update the nickname and add it under the new nick.</span>
<a href="#l14.165"></a><span id="l14.165" class="difflineplus">+    participant._name = aNewNick;</span>
<a href="#l14.166"></a><span id="l14.166" class="difflineplus">+    this._participants[this.getNormalizedChatBuddyName(aNewNick)] = participant;</span>
<a href="#l14.167"></a><span id="l14.167" class="difflineplus">+</span>
<a href="#l14.168"></a><span id="l14.168" class="difflineplus">+    this.notifyObservers(participant, &quot;chat-buddy-update&quot;, aOldNick);</span>
<a href="#l14.169"></a><span id="l14.169" class="difflineplus">+  },</span>
<a href="#l14.170"></a><span id="l14.170" class="difflineplus">+  removeParticipant: function(aNick, aNotifyObservers) {</span>
<a href="#l14.171"></a><span id="l14.171" class="difflineplus">+    if (!this.hasParticipant(aNick))</span>
<a href="#l14.172"></a><span id="l14.172" class="difflineplus">+      return;</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineplus">+</span>
<a href="#l14.174"></a><span id="l14.174" class="difflineplus">+    if (aNotifyObservers) {</span>
<a href="#l14.175"></a><span id="l14.175" class="difflineplus">+      let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.176"></a><span id="l14.176" class="difflineplus">+                              .createInstance(Ci.nsISupportsString);</span>
<a href="#l14.177"></a><span id="l14.177" class="difflineplus">+      stringNickname.data = aNick;</span>
<a href="#l14.178"></a><span id="l14.178" class="difflineplus">+      this.notifyObservers(new nsSimpleEnumerator([stringNickname]),</span>
<a href="#l14.179"></a><span id="l14.179" class="difflineplus">+                           &quot;chat-buddy-remove&quot;);</span>
<a href="#l14.180"></a><span id="l14.180" class="difflineplus">+    }</span>
<a href="#l14.181"></a><span id="l14.181" class="difflineplus">+    delete this._participants[this.getNormalizedChatBuddyName(aNick)];</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineplus">+  },</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineplus">+  // Use this before joining to avoid errors of trying to re-add an existing</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+  // participant</span>
<a href="#l14.185"></a><span id="l14.185" class="difflineplus">+  removeAllParticipants: function() {</span>
<a href="#l14.186"></a><span id="l14.186" class="difflineplus">+    let stringNicknames = [];</span>
<a href="#l14.187"></a><span id="l14.187" class="difflineplus">+    for (let nickname in this._participants) {</span>
<a href="#l14.188"></a><span id="l14.188" class="difflineplus">+      let stringNickname = Cc[&quot;@mozilla.org/supports-string;1&quot;]</span>
<a href="#l14.189"></a><span id="l14.189" class="difflineplus">+                              .createInstance(Ci.nsISupportsString);</span>
<a href="#l14.190"></a><span id="l14.190" class="difflineplus">+      stringNickname.data = this._participants[nickname].name;</span>
<a href="#l14.191"></a><span id="l14.191" class="difflineplus">+      stringNicknames.push(stringNickname);</span>
<a href="#l14.192"></a><span id="l14.192" class="difflineplus">+    }</span>
<a href="#l14.193"></a><span id="l14.193" class="difflineplus">+    this.notifyObservers(new nsSimpleEnumerator(stringNicknames),</span>
<a href="#l14.194"></a><span id="l14.194" class="difflineplus">+                         &quot;chat-buddy-remove&quot;);</span>
<a href="#l14.195"></a><span id="l14.195" class="difflineplus">+    this._participants = {};</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineplus">+  },</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+</span>
<a href="#l14.198"></a><span id="l14.198" class="difflineplus">+  _left: false,</span>
<a href="#l14.199"></a><span id="l14.199" class="difflineplus">+  get left() this._left,</span>
<a href="#l14.200"></a><span id="l14.200" class="difflineplus">+  set left(aLeft) {</span>
<a href="#l14.201"></a><span id="l14.201" class="difflineplus">+    this._left = aLeft;</span>
<a href="#l14.202"></a><span id="l14.202" class="difflineplus">+</span>
<a href="#l14.203"></a><span id="l14.203" class="difflineplus">+    // If we've left, notify observers.</span>
<a href="#l14.204"></a><span id="l14.204" class="difflineplus">+    if (this._left)</span>
<a href="#l14.205"></a><span id="l14.205" class="difflineplus">+      this.notifyObservers(null, &quot;update-conv-chatleft&quot;);</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineplus">+  },</span>
<a href="#l14.207"></a><span id="l14.207" class="difflineplus">+  get topic() this._topic, // can't add a setter without redefining the getter</span>
<a href="#l14.208"></a><span id="l14.208" class="difflineplus">+  set topic(aTopic) {</span>
<a href="#l14.209"></a><span id="l14.209" class="difflineplus">+    this._account.sendMessage(&quot;TOPIC&quot;, [this.name, aTopic]);</span>
<a href="#l14.210"></a><span id="l14.210" class="difflineplus">+  },</span>
<a href="#l14.211"></a><span id="l14.211" class="difflineplus">+  get topicSettable() true,</span>
<a href="#l14.212"></a><span id="l14.212" class="difflineplus">+  </span>
<a href="#l14.213"></a><span id="l14.213" class="difflineplus">+  get normalizedName() this._account.normalize(this.name),</span>
<a href="#l14.214"></a><span id="l14.214" class="difflineplus">+};</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineplus">+</span>
<a href="#l14.216"></a><span id="l14.216" class="difflineplus">+function ircParticipant(aName, aAccount) {</span>
<a href="#l14.217"></a><span id="l14.217" class="difflineplus">+  this._name = aName;</span>
<a href="#l14.218"></a><span id="l14.218" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l14.219"></a><span id="l14.219" class="difflineplus">+  this._modes = [];</span>
<a href="#l14.220"></a><span id="l14.220" class="difflineplus">+</span>
<a href="#l14.221"></a><span id="l14.221" class="difflineplus">+  if (this._name[0] in this._account.userPrefixToModeMap) {</span>
<a href="#l14.222"></a><span id="l14.222" class="difflineplus">+    this._modes.push(this._account.userPrefixToModeMap[this._name[0]]);</span>
<a href="#l14.223"></a><span id="l14.223" class="difflineplus">+    this._name = this._name.slice(1);</span>
<a href="#l14.224"></a><span id="l14.224" class="difflineplus">+  }</span>
<a href="#l14.225"></a><span id="l14.225" class="difflineplus">+}</span>
<a href="#l14.226"></a><span id="l14.226" class="difflineplus">+ircParticipant.prototype = {</span>
<a href="#l14.227"></a><span id="l14.227" class="difflineplus">+  __proto__: GenericConvChatBuddyPrototype,</span>
<a href="#l14.228"></a><span id="l14.228" class="difflineplus">+</span>
<a href="#l14.229"></a><span id="l14.229" class="difflineplus">+  // This takes a mode change string and reflects it into the</span>
<a href="#l14.230"></a><span id="l14.230" class="difflineplus">+  // prplIConvChatBuddy, a mode change string is of the form:</span>
<a href="#l14.231"></a><span id="l14.231" class="difflineplus">+  //   (&quot;+&quot; | &quot;-&quot;)&lt;mode key&gt;[&lt;mode key&gt;]*</span>
<a href="#l14.232"></a><span id="l14.232" class="difflineplus">+  // e.g. +iaw or -i</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineplus">+  setMode: function(aNewMode) {</span>
<a href="#l14.234"></a><span id="l14.234" class="difflineplus">+    // Are we going to add or remove the modes?</span>
<a href="#l14.235"></a><span id="l14.235" class="difflineplus">+    if (aNewMode[0] != &quot;+&quot; &amp;&amp; aNewMode[0] != &quot;-&quot;) {</span>
<a href="#l14.236"></a><span id="l14.236" class="difflineplus">+      WARN(&quot;Invalid mode string: &quot; + aNewMode);</span>
<a href="#l14.237"></a><span id="l14.237" class="difflineplus">+      return;</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineplus">+    }</span>
<a href="#l14.239"></a><span id="l14.239" class="difflineplus">+    let addNewMode = aNewMode[0] == &quot;+&quot;;</span>
<a href="#l14.240"></a><span id="l14.240" class="difflineplus">+</span>
<a href="#l14.241"></a><span id="l14.241" class="difflineplus">+    // Check each mode being added and update the user</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineplus">+    for (let i = 1; i &lt; aNewMode.length; i++) {</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineplus">+      let index = this._modes.indexOf(aNewMode[i]);</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineplus">+      // If the mode is in the list of modes and we want to remove it.</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+      if (index != -1 &amp;&amp; !addNewMode)</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+        this._modes.splice(index, 1);</span>
<a href="#l14.247"></a><span id="l14.247" class="difflineplus">+      // If the mode is not in the list of modes and we want to add it.</span>
<a href="#l14.248"></a><span id="l14.248" class="difflineplus">+      else if (index == -1 &amp;&amp; addNewMode)</span>
<a href="#l14.249"></a><span id="l14.249" class="difflineplus">+        this._modes.push(aNewMode[i]);</span>
<a href="#l14.250"></a><span id="l14.250" class="difflineplus">+    }</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineplus">+  },</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+</span>
<a href="#l14.253"></a><span id="l14.253" class="difflineplus">+  get voiced() this._modes.indexOf(&quot;v&quot;) != -1,</span>
<a href="#l14.254"></a><span id="l14.254" class="difflineplus">+  get halfOp() this._modes.indexOf(&quot;h&quot;) != -1,</span>
<a href="#l14.255"></a><span id="l14.255" class="difflineplus">+  get op() this._modes.indexOf(&quot;o&quot;) != -1,</span>
<a href="#l14.256"></a><span id="l14.256" class="difflineplus">+  get founder() this._modes.indexOf(&quot;n&quot;) != -1,</span>
<a href="#l14.257"></a><span id="l14.257" class="difflineplus">+  get typing() false</span>
<a href="#l14.258"></a><span id="l14.258" class="difflineplus">+};</span>
<a href="#l14.259"></a><span id="l14.259" class="difflineplus">+</span>
<a href="#l14.260"></a><span id="l14.260" class="difflineplus">+function ircConversation(aAccount, aName) {</span>
<a href="#l14.261"></a><span id="l14.261" class="difflineplus">+  this._init(aAccount, aName);</span>
<a href="#l14.262"></a><span id="l14.262" class="difflineplus">+}</span>
<a href="#l14.263"></a><span id="l14.263" class="difflineplus">+ircConversation.prototype = {</span>
<a href="#l14.264"></a><span id="l14.264" class="difflineplus">+  __proto__: GenericConvIMPrototype,</span>
<a href="#l14.265"></a><span id="l14.265" class="difflineplus">+  sendMsg: function(aMessage) {</span>
<a href="#l14.266"></a><span id="l14.266" class="difflineplus">+    this._account.sendMessage(&quot;PRIVMSG&quot;, [this.name, aMessage]);</span>
<a href="#l14.267"></a><span id="l14.267" class="difflineplus">+</span>
<a href="#l14.268"></a><span id="l14.268" class="difflineplus">+    // Since the server doesn't send us a message back, just assume the message</span>
<a href="#l14.269"></a><span id="l14.269" class="difflineplus">+    // was received and immediately show it.</span>
<a href="#l14.270"></a><span id="l14.270" class="difflineplus">+    this.writeMessage(this._account._nickname, aMessage, {outgoing: true});</span>
<a href="#l14.271"></a><span id="l14.271" class="difflineplus">+  },</span>
<a href="#l14.272"></a><span id="l14.272" class="difflineplus">+</span>
<a href="#l14.273"></a><span id="l14.273" class="difflineplus">+  // Overwrite the writeMessage function to apply CTCP formatting before</span>
<a href="#l14.274"></a><span id="l14.274" class="difflineplus">+  // display.</span>
<a href="#l14.275"></a><span id="l14.275" class="difflineplus">+  writeMessage: function(aWho, aText, aProperties) {</span>
<a href="#l14.276"></a><span id="l14.276" class="difflineplus">+    GenericConvIMPrototype.writeMessage.call(this, aWho,</span>
<a href="#l14.277"></a><span id="l14.277" class="difflineplus">+                                             ctcpFormatToHTML(aText),</span>
<a href="#l14.278"></a><span id="l14.278" class="difflineplus">+                                             aProperties);</span>
<a href="#l14.279"></a><span id="l14.279" class="difflineplus">+  },</span>
<a href="#l14.280"></a><span id="l14.280" class="difflineplus">+</span>
<a href="#l14.281"></a><span id="l14.281" class="difflineplus">+  get normalizedName() this._account.normalize(this.name),</span>
<a href="#l14.282"></a><span id="l14.282" class="difflineplus">+</span>
<a href="#l14.283"></a><span id="l14.283" class="difflineplus">+  unInit: function() {</span>
<a href="#l14.284"></a><span id="l14.284" class="difflineplus">+    this._account.removeConversation(this.name);</span>
<a href="#l14.285"></a><span id="l14.285" class="difflineplus">+    GenericConvIMPrototype.unInit.call(this);</span>
<a href="#l14.286"></a><span id="l14.286" class="difflineplus">+  },</span>
<a href="#l14.287"></a><span id="l14.287" class="difflineplus">+</span>
<a href="#l14.288"></a><span id="l14.288" class="difflineplus">+  updateNick: function(aNewNick) {</span>
<a href="#l14.289"></a><span id="l14.289" class="difflineplus">+    this._name = aNewNick;</span>
<a href="#l14.290"></a><span id="l14.290" class="difflineplus">+    this.notifyObservers(null, &quot;update-conv-title&quot;);</span>
<a href="#l14.291"></a><span id="l14.291" class="difflineplus">+  }</span>
<a href="#l14.292"></a><span id="l14.292" class="difflineplus">+};</span>
<a href="#l14.293"></a><span id="l14.293" class="difflineplus">+</span>
<a href="#l14.294"></a><span id="l14.294" class="difflineplus">+function ircSocket(aAccount) {</span>
<a href="#l14.295"></a><span id="l14.295" class="difflineplus">+  this._account = aAccount;</span>
<a href="#l14.296"></a><span id="l14.296" class="difflineplus">+  this._initCharsetConverter();</span>
<a href="#l14.297"></a><span id="l14.297" class="difflineplus">+}</span>
<a href="#l14.298"></a><span id="l14.298" class="difflineplus">+ircSocket.prototype = {</span>
<a href="#l14.299"></a><span id="l14.299" class="difflineplus">+  __proto__: Socket,</span>
<a href="#l14.300"></a><span id="l14.300" class="difflineplus">+  delimiter: &quot;\r\n&quot;,</span>
<a href="#l14.301"></a><span id="l14.301" class="difflineplus">+  connectTimeout: 60, // Failure to connect after 1 minute</span>
<a href="#l14.302"></a><span id="l14.302" class="difflineplus">+  readWriteTimeout: 300, // Failure when no data for 5 minutes</span>
<a href="#l14.303"></a><span id="l14.303" class="difflineplus">+  _converter: null,</span>
<a href="#l14.304"></a><span id="l14.304" class="difflineplus">+</span>
<a href="#l14.305"></a><span id="l14.305" class="difflineplus">+  _initCharsetConverter: function() {</span>
<a href="#l14.306"></a><span id="l14.306" class="difflineplus">+    this._converter = Cc[&quot;@mozilla.org/intl/scriptableunicodeconverter&quot;]</span>
<a href="#l14.307"></a><span id="l14.307" class="difflineplus">+                        .createInstance(Ci.nsIScriptableUnicodeConverter);</span>
<a href="#l14.308"></a><span id="l14.308" class="difflineplus">+    try {</span>
<a href="#l14.309"></a><span id="l14.309" class="difflineplus">+      this._converter.charset = this._account._encoding;</span>
<a href="#l14.310"></a><span id="l14.310" class="difflineplus">+    } catch (e) {</span>
<a href="#l14.311"></a><span id="l14.311" class="difflineplus">+      delete this._converter;</span>
<a href="#l14.312"></a><span id="l14.312" class="difflineplus">+      ERROR(&quot;Failed to set character set to: &quot; + this._account._encoding + &quot; for &quot; +</span>
<a href="#l14.313"></a><span id="l14.313" class="difflineplus">+            this._account.name + &quot;.&quot;);</span>
<a href="#l14.314"></a><span id="l14.314" class="difflineplus">+    }</span>
<a href="#l14.315"></a><span id="l14.315" class="difflineplus">+  },</span>
<a href="#l14.316"></a><span id="l14.316" class="difflineplus">+</span>
<a href="#l14.317"></a><span id="l14.317" class="difflineplus">+  // Implement Section 5 of RFC 2812.</span>
<a href="#l14.318"></a><span id="l14.318" class="difflineplus">+  onDataReceived: function(aRawMessage) {</span>
<a href="#l14.319"></a><span id="l14.319" class="difflineplus">+    DEBUG(aRawMessage);</span>
<a href="#l14.320"></a><span id="l14.320" class="difflineplus">+    if (this._converter) {</span>
<a href="#l14.321"></a><span id="l14.321" class="difflineplus">+      try {</span>
<a href="#l14.322"></a><span id="l14.322" class="difflineplus">+        aRawMessage = this._converter.ConvertToUnicode(aRawMessage);</span>
<a href="#l14.323"></a><span id="l14.323" class="difflineplus">+      } catch (e) {</span>
<a href="#l14.324"></a><span id="l14.324" class="difflineplus">+        WARN(&quot;This message doesn't seem to be &quot; + this._account._encoding +</span>
<a href="#l14.325"></a><span id="l14.325" class="difflineplus">+             &quot; encoded: &quot; + aRawMessage);</span>
<a href="#l14.326"></a><span id="l14.326" class="difflineplus">+        // Unfortunately, if the unicode converter failed once,</span>
<a href="#l14.327"></a><span id="l14.327" class="difflineplus">+        // it will keep failing so we need to reinitialize it.</span>
<a href="#l14.328"></a><span id="l14.328" class="difflineplus">+        this._initCharsetConverter();</span>
<a href="#l14.329"></a><span id="l14.329" class="difflineplus">+      }</span>
<a href="#l14.330"></a><span id="l14.330" class="difflineplus">+    }</span>
<a href="#l14.331"></a><span id="l14.331" class="difflineplus">+</span>
<a href="#l14.332"></a><span id="l14.332" class="difflineplus">+    // If nothing handled the message, throw an error.</span>
<a href="#l14.333"></a><span id="l14.333" class="difflineplus">+    if (!ircHandlers.handleMessage(this._account, new ircMessage(aRawMessage)))</span>
<a href="#l14.334"></a><span id="l14.334" class="difflineplus">+      WARN(&quot;Unhandled IRC message: &quot; + aRawMessage);</span>
<a href="#l14.335"></a><span id="l14.335" class="difflineplus">+  },</span>
<a href="#l14.336"></a><span id="l14.336" class="difflineplus">+  onConnection: function() {</span>
<a href="#l14.337"></a><span id="l14.337" class="difflineplus">+    this._account._connectionRegistration.call(this._account);</span>
<a href="#l14.338"></a><span id="l14.338" class="difflineplus">+  },</span>
<a href="#l14.339"></a><span id="l14.339" class="difflineplus">+</span>
<a href="#l14.340"></a><span id="l14.340" class="difflineplus">+  // Throw errors if the socket has issues.</span>
<a href="#l14.341"></a><span id="l14.341" class="difflineplus">+  onConnectionClosed: function () {</span>
<a href="#l14.342"></a><span id="l14.342" class="difflineplus">+    if (!this._account.imAccount || this._account.disconnecting ||</span>
<a href="#l14.343"></a><span id="l14.343" class="difflineplus">+        this._account.disconnected)</span>
<a href="#l14.344"></a><span id="l14.344" class="difflineplus">+      return;</span>
<a href="#l14.345"></a><span id="l14.345" class="difflineplus">+</span>
<a href="#l14.346"></a><span id="l14.346" class="difflineplus">+    ERROR(&quot;Connection closed by server.&quot;);</span>
<a href="#l14.347"></a><span id="l14.347" class="difflineplus">+    this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l14.348"></a><span id="l14.348" class="difflineplus">+                                  _(&quot;connection.error.lost&quot;));</span>
<a href="#l14.349"></a><span id="l14.349" class="difflineplus">+  },</span>
<a href="#l14.350"></a><span id="l14.350" class="difflineplus">+  onConnectionReset: function () {</span>
<a href="#l14.351"></a><span id="l14.351" class="difflineplus">+    ERROR(&quot;Connection reset.&quot;);</span>
<a href="#l14.352"></a><span id="l14.352" class="difflineplus">+    this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l14.353"></a><span id="l14.353" class="difflineplus">+                                  _(&quot;connection.error.lost&quot;));</span>
<a href="#l14.354"></a><span id="l14.354" class="difflineplus">+  },</span>
<a href="#l14.355"></a><span id="l14.355" class="difflineplus">+  onConnectionTimedOut: function() {</span>
<a href="#l14.356"></a><span id="l14.356" class="difflineplus">+    ERROR(&quot;Connection timed out.&quot;);</span>
<a href="#l14.357"></a><span id="l14.357" class="difflineplus">+    this._account.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l14.358"></a><span id="l14.358" class="difflineplus">+                                  _(&quot;connection.error.timeOut&quot;));</span>
<a href="#l14.359"></a><span id="l14.359" class="difflineplus">+  },</span>
<a href="#l14.360"></a><span id="l14.360" class="difflineplus">+  onCertificationError: function(aSocketInfo, aStatus, aTargetSite) {</span>
<a href="#l14.361"></a><span id="l14.361" class="difflineplus">+    ERROR(&quot;Certification error.&quot;);</span>
<a href="#l14.362"></a><span id="l14.362" class="difflineplus">+    this._account.gotDisconnected(Ci.prplIAccount.ERROR_CERT_OTHER_ERROR,</span>
<a href="#l14.363"></a><span id="l14.363" class="difflineplus">+                                  _(&quot;connection.error.certError&quot;));</span>
<a href="#l14.364"></a><span id="l14.364" class="difflineplus">+  },</span>
<a href="#l14.365"></a><span id="l14.365" class="difflineplus">+  log: LOG</span>
<a href="#l14.366"></a><span id="l14.366" class="difflineplus">+};</span>
<a href="#l14.367"></a><span id="l14.367" class="difflineplus">+</span>
<a href="#l14.368"></a><span id="l14.368" class="difflineplus">+function ircAccountBuddy(aAccount, aBuddy, aTag, aUserName) {</span>
<a href="#l14.369"></a><span id="l14.369" class="difflineplus">+  this._init(aAccount, aBuddy, aTag, aUserName);</span>
<a href="#l14.370"></a><span id="l14.370" class="difflineplus">+}</span>
<a href="#l14.371"></a><span id="l14.371" class="difflineplus">+ircAccountBuddy.prototype = {</span>
<a href="#l14.372"></a><span id="l14.372" class="difflineplus">+  __proto__: GenericAccountBuddyPrototype,</span>
<a href="#l14.373"></a><span id="l14.373" class="difflineplus">+</span>
<a href="#l14.374"></a><span id="l14.374" class="difflineplus">+  // Returns a list of imITooltipInfo objects to be displayed when the user</span>
<a href="#l14.375"></a><span id="l14.375" class="difflineplus">+  // hovers over the buddy.</span>
<a href="#l14.376"></a><span id="l14.376" class="difflineplus">+  getTooltipInfo: function() this._account.getBuddyInfo(this.normalizedName),</span>
<a href="#l14.377"></a><span id="l14.377" class="difflineplus">+</span>
<a href="#l14.378"></a><span id="l14.378" class="difflineplus">+  get normalizedName() this._account.normalize(this.userName),</span>
<a href="#l14.379"></a><span id="l14.379" class="difflineplus">+</span>
<a href="#l14.380"></a><span id="l14.380" class="difflineplus">+  // Can not send messages to buddies who appear offline.</span>
<a href="#l14.381"></a><span id="l14.381" class="difflineplus">+  get canSendMessage() this.account.connected,</span>
<a href="#l14.382"></a><span id="l14.382" class="difflineplus">+</span>
<a href="#l14.383"></a><span id="l14.383" class="difflineplus">+  // Called when the user wants to chat with the buddy.</span>
<a href="#l14.384"></a><span id="l14.384" class="difflineplus">+  createConversation: function() {</span>
<a href="#l14.385"></a><span id="l14.385" class="difflineplus">+ERROR(this.userName);</span>
<a href="#l14.386"></a><span id="l14.386" class="difflineplus">+    return this._account.createConversation(this.userName);</span>
<a href="#l14.387"></a><span id="l14.387" class="difflineplus">+  }</span>
<a href="#l14.388"></a><span id="l14.388" class="difflineplus">+};</span>
<a href="#l14.389"></a><span id="l14.389" class="difflineplus">+</span>
<a href="#l14.390"></a><span id="l14.390" class="difflineplus">+function ircAccount(aProtocol, aImAccount) {</span>
<a href="#l14.391"></a><span id="l14.391" class="difflineplus">+  this._buddies = {};</span>
<a href="#l14.392"></a><span id="l14.392" class="difflineplus">+  this._init(aProtocol, aImAccount);</span>
<a href="#l14.393"></a><span id="l14.393" class="difflineplus">+  this._conversations = {};</span>
<a href="#l14.394"></a><span id="l14.394" class="difflineplus">+</span>
<a href="#l14.395"></a><span id="l14.395" class="difflineplus">+  // Split the account name into usable parts.</span>
<a href="#l14.396"></a><span id="l14.396" class="difflineplus">+  let splitter = aImAccount.name.lastIndexOf(&quot;@&quot;);</span>
<a href="#l14.397"></a><span id="l14.397" class="difflineplus">+  this._nickname = aImAccount.name.slice(0, splitter);</span>
<a href="#l14.398"></a><span id="l14.398" class="difflineplus">+  this._server = aImAccount.name.slice(splitter + 1);</span>
<a href="#l14.399"></a><span id="l14.399" class="difflineplus">+</span>
<a href="#l14.400"></a><span id="l14.400" class="difflineplus">+  // For more information, see where these are defined in the prototype below.</span>
<a href="#l14.401"></a><span id="l14.401" class="difflineplus">+  this._isOnQueue = [];</span>
<a href="#l14.402"></a><span id="l14.402" class="difflineplus">+  this.pendingIsOnQueue = [];</span>
<a href="#l14.403"></a><span id="l14.403" class="difflineplus">+  this.whoisInformation = {};</span>
<a href="#l14.404"></a><span id="l14.404" class="difflineplus">+}</span>
<a href="#l14.405"></a><span id="l14.405" class="difflineplus">+ircAccount.prototype = {</span>
<a href="#l14.406"></a><span id="l14.406" class="difflineplus">+  __proto__: GenericAccountPrototype,</span>
<a href="#l14.407"></a><span id="l14.407" class="difflineplus">+  _socket: null,</span>
<a href="#l14.408"></a><span id="l14.408" class="difflineplus">+  _MODE_WALLOPS: 1 &lt;&lt; 2, // mode 'w'</span>
<a href="#l14.409"></a><span id="l14.409" class="difflineplus">+  _MODE_INVISIBLE: 1 &lt;&lt; 3, // mode 'i'</span>
<a href="#l14.410"></a><span id="l14.410" class="difflineplus">+  get _mode() 0,</span>
<a href="#l14.411"></a><span id="l14.411" class="difflineplus">+</span>
<a href="#l14.412"></a><span id="l14.412" class="difflineplus">+  get noNewlines() true,</span>
<a href="#l14.413"></a><span id="l14.413" class="difflineplus">+</span>
<a href="#l14.414"></a><span id="l14.414" class="difflineplus">+  get normalizedName() this.normalize(this.name),</span>
<a href="#l14.415"></a><span id="l14.415" class="difflineplus">+</span>
<a href="#l14.416"></a><span id="l14.416" class="difflineplus">+  // Parts of the specification give max lengths, keep track of them since a</span>
<a href="#l14.417"></a><span id="l14.417" class="difflineplus">+  // server can overwrite them. The defaults given here are from RFC 2812.</span>
<a href="#l14.418"></a><span id="l14.418" class="difflineplus">+  maxNicknameLength: 9, // 1.2.1 Users</span>
<a href="#l14.419"></a><span id="l14.419" class="difflineplus">+  maxChannelLength: 50, // 1.3 Channels</span>
<a href="#l14.420"></a><span id="l14.420" class="difflineplus">+  maxMessageLength: 512, // 2.3 Messages</span>
<a href="#l14.421"></a><span id="l14.421" class="difflineplus">+  maxHostnameLength: 63, // 2.3.1 Message format in Augmented BNF</span>
<a href="#l14.422"></a><span id="l14.422" class="difflineplus">+</span>
<a href="#l14.423"></a><span id="l14.423" class="difflineplus">+  // The default prefixes.</span>
<a href="#l14.424"></a><span id="l14.424" class="difflineplus">+  userPrefixes: [&quot;@&quot;, &quot;!&quot;, &quot;%&quot;, &quot;+&quot;],</span>
<a href="#l14.425"></a><span id="l14.425" class="difflineplus">+  // The default prefixes to modes.</span>
<a href="#l14.426"></a><span id="l14.426" class="difflineplus">+  userPrefixToModeMap: {&quot;@&quot;: &quot;o&quot;, &quot;!&quot;: &quot;n&quot;, &quot;%&quot;: &quot;h&quot;, &quot;+&quot;: &quot;v&quot;},</span>
<a href="#l14.427"></a><span id="l14.427" class="difflineplus">+  channelPrefixes: [&quot;&amp;&quot;, &quot;#&quot;, &quot;+&quot;, &quot;!&quot;], // 1.3 Channels</span>
<a href="#l14.428"></a><span id="l14.428" class="difflineplus">+</span>
<a href="#l14.429"></a><span id="l14.429" class="difflineplus">+  // Handle Scandanavian lower case (optionally remove status indicators).</span>
<a href="#l14.430"></a><span id="l14.430" class="difflineplus">+  // See Section 2.2 of RFC 2812: the characters {}|^ are considered to be the</span>
<a href="#l14.431"></a><span id="l14.431" class="difflineplus">+  // lower case equivalents of the characters []\~, respectively.</span>
<a href="#l14.432"></a><span id="l14.432" class="difflineplus">+  normalize: function(aStr, aPrefixes) {</span>
<a href="#l14.433"></a><span id="l14.433" class="difflineplus">+    let str = aStr;</span>
<a href="#l14.434"></a><span id="l14.434" class="difflineplus">+    if (aPrefixes &amp;&amp; aPrefixes.indexOf(aStr[0]) != -1)</span>
<a href="#l14.435"></a><span id="l14.435" class="difflineplus">+      str = str.slice(1);</span>
<a href="#l14.436"></a><span id="l14.436" class="difflineplus">+</span>
<a href="#l14.437"></a><span id="l14.437" class="difflineplus">+    return str.replace(/[\x41-\x5E]/g,</span>
<a href="#l14.438"></a><span id="l14.438" class="difflineplus">+                       function(c) String.fromCharCode(c.charCodeAt(0) + 0x20));</span>
<a href="#l14.439"></a><span id="l14.439" class="difflineplus">+  },</span>
<a href="#l14.440"></a><span id="l14.440" class="difflineplus">+</span>
<a href="#l14.441"></a><span id="l14.441" class="difflineplus">+  isMUCName: function(aStr) {</span>
<a href="#l14.442"></a><span id="l14.442" class="difflineplus">+    return (this.channelPrefixes.indexOf(aStr[0]) != -1);</span>
<a href="#l14.443"></a><span id="l14.443" class="difflineplus">+  },</span>
<a href="#l14.444"></a><span id="l14.444" class="difflineplus">+</span>
<a href="#l14.445"></a><span id="l14.445" class="difflineplus">+  // When Instantbird changes status, tell the server. IRC is only away or not</span>
<a href="#l14.446"></a><span id="l14.446" class="difflineplus">+  // away; consider away, idle and unavailable to be away. This will also</span>
<a href="#l14.447"></a><span id="l14.447" class="difflineplus">+  // connect or disconnect if set to offline/available.</span>
<a href="#l14.448"></a><span id="l14.448" class="difflineplus">+  isAway: false,</span>
<a href="#l14.449"></a><span id="l14.449" class="difflineplus">+  observe: function(aSubject, aTopic, aData) {</span>
<a href="#l14.450"></a><span id="l14.450" class="difflineplus">+    if (aTopic != &quot;status-changed&quot;)</span>
<a href="#l14.451"></a><span id="l14.451" class="difflineplus">+      return;</span>
<a href="#l14.452"></a><span id="l14.452" class="difflineplus">+</span>
<a href="#l14.453"></a><span id="l14.453" class="difflineplus">+    this.updateStatus();</span>
<a href="#l14.454"></a><span id="l14.454" class="difflineplus">+  },</span>
<a href="#l14.455"></a><span id="l14.455" class="difflineplus">+  // Update the accounts status when Instantbird requests a status change and</span>
<a href="#l14.456"></a><span id="l14.456" class="difflineplus">+  // when we receive information from the server that the status has changed.</span>
<a href="#l14.457"></a><span id="l14.457" class="difflineplus">+  updateStatus: function() {</span>
<a href="#l14.458"></a><span id="l14.458" class="difflineplus">+    let {statusType: type, statusText: text} = this.imAccount.statusInfo;</span>
<a href="#l14.459"></a><span id="l14.459" class="difflineplus">+    LOG(&quot;New status received: &quot; + type + &quot;\r\n&quot; + text);</span>
<a href="#l14.460"></a><span id="l14.460" class="difflineplus">+</span>
<a href="#l14.461"></a><span id="l14.461" class="difflineplus">+    // Tell the server to mark us as away.</span>
<a href="#l14.462"></a><span id="l14.462" class="difflineplus">+    if (type &lt; Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; !this.isAway) {</span>
<a href="#l14.463"></a><span id="l14.463" class="difflineplus">+      // We have to have a string in order to set IRC as AWAY.</span>
<a href="#l14.464"></a><span id="l14.464" class="difflineplus">+      if (!text) {</span>
<a href="#l14.465"></a><span id="l14.465" class="difflineplus">+        // If no status is given, use the the default idle/away message.</span>
<a href="#l14.466"></a><span id="l14.466" class="difflineplus">+        const IDLE_PREF_BRANCH = &quot;messenger.status.&quot;;</span>
<a href="#l14.467"></a><span id="l14.467" class="difflineplus">+        const IDLE_PREF = &quot;defaultIdleAwayMessage&quot;;</span>
<a href="#l14.468"></a><span id="l14.468" class="difflineplus">+        text = Services.prefs.getComplexValue(IDLE_PREF_BRANCH + IDLE_PREF,</span>
<a href="#l14.469"></a><span id="l14.469" class="difflineplus">+                                              Ci.nsIPrefLocalizedString).data;</span>
<a href="#l14.470"></a><span id="l14.470" class="difflineplus">+</span>
<a href="#l14.471"></a><span id="l14.471" class="difflineplus">+        if (!text) {</span>
<a href="#l14.472"></a><span id="l14.472" class="difflineplus">+          // Get the default value of the localized preference.</span>
<a href="#l14.473"></a><span id="l14.473" class="difflineplus">+          text = Services.prefs.getDefaultBranch(IDLE_PREF_BRANCH)</span>
<a href="#l14.474"></a><span id="l14.474" class="difflineplus">+                         .getComplexValue(IDLE_PREF,</span>
<a href="#l14.475"></a><span id="l14.475" class="difflineplus">+                                          Ci.nsIPrefLocalizedString).data;</span>
<a href="#l14.476"></a><span id="l14.476" class="difflineplus">+        }</span>
<a href="#l14.477"></a><span id="l14.477" class="difflineplus">+        // The last resort, fallback to a non-localized string.</span>
<a href="#l14.478"></a><span id="l14.478" class="difflineplus">+        if (!text)</span>
<a href="#l14.479"></a><span id="l14.479" class="difflineplus">+          text = &quot;Away&quot;;</span>
<a href="#l14.480"></a><span id="l14.480" class="difflineplus">+      }</span>
<a href="#l14.481"></a><span id="l14.481" class="difflineplus">+      this.sendMessage(&quot;AWAY&quot;, text); // Mark as away.</span>
<a href="#l14.482"></a><span id="l14.482" class="difflineplus">+    }</span>
<a href="#l14.483"></a><span id="l14.483" class="difflineplus">+    else if (type == Ci.imIStatusInfo.STATUS_AVAILABLE &amp;&amp; this.isAway)</span>
<a href="#l14.484"></a><span id="l14.484" class="difflineplus">+      this.sendMessage(&quot;AWAY&quot;); // Mark as back.</span>
<a href="#l14.485"></a><span id="l14.485" class="difflineplus">+  },</span>
<a href="#l14.486"></a><span id="l14.486" class="difflineplus">+</span>
<a href="#l14.487"></a><span id="l14.487" class="difflineplus">+  // The whois information: nicks are used as keys and refer to a map of field</span>
<a href="#l14.488"></a><span id="l14.488" class="difflineplus">+  // to value.</span>
<a href="#l14.489"></a><span id="l14.489" class="difflineplus">+  whoisInformation: {},</span>
<a href="#l14.490"></a><span id="l14.490" class="difflineplus">+  // Request WHOIS information on a buddy when the user requests more</span>
<a href="#l14.491"></a><span id="l14.491" class="difflineplus">+  // information.</span>
<a href="#l14.492"></a><span id="l14.492" class="difflineplus">+  requestBuddyInfo: function(aBuddyName) {</span>
<a href="#l14.493"></a><span id="l14.493" class="difflineplus">+    this.sendMessage(&quot;WHOIS&quot;, aBuddyName);</span>
<a href="#l14.494"></a><span id="l14.494" class="difflineplus">+  },</span>
<a href="#l14.495"></a><span id="l14.495" class="difflineplus">+  // Return an nsISimpleEnumerator of imITooltipInfo for a given nick.</span>
<a href="#l14.496"></a><span id="l14.496" class="difflineplus">+  getBuddyInfo: function(aNick) {</span>
<a href="#l14.497"></a><span id="l14.497" class="difflineplus">+    let nick = this.normalize(aNick);</span>
<a href="#l14.498"></a><span id="l14.498" class="difflineplus">+    if (!hasOwnProperty(this.whoisInformation, nick))</span>
<a href="#l14.499"></a><span id="l14.499" class="difflineplus">+      return EmptyEnumerator;</span>
<a href="#l14.500"></a><span id="l14.500" class="difflineplus">+</span>
<a href="#l14.501"></a><span id="l14.501" class="difflineplus">+    let whoisInformation = this.whoisInformation[nick];</span>
<a href="#l14.502"></a><span id="l14.502" class="difflineplus">+    let tooltipInfo = [];</span>
<a href="#l14.503"></a><span id="l14.503" class="difflineplus">+    for (let field in whoisInformation) {</span>
<a href="#l14.504"></a><span id="l14.504" class="difflineplus">+      let value = whoisInformation[field];</span>
<a href="#l14.505"></a><span id="l14.505" class="difflineplus">+      tooltipInfo.push(new TooltipInfo(_(&quot;tooltip.&quot; + field), value));</span>
<a href="#l14.506"></a><span id="l14.506" class="difflineplus">+    }</span>
<a href="#l14.507"></a><span id="l14.507" class="difflineplus">+</span>
<a href="#l14.508"></a><span id="l14.508" class="difflineplus">+    return new nsSimpleEnumerator(tooltipInfo);</span>
<a href="#l14.509"></a><span id="l14.509" class="difflineplus">+  },</span>
<a href="#l14.510"></a><span id="l14.510" class="difflineplus">+</span>
<a href="#l14.511"></a><span id="l14.511" class="difflineplus">+  addBuddy: function(aTag, aName) {</span>
<a href="#l14.512"></a><span id="l14.512" class="difflineplus">+    let buddy = new ircAccountBuddy(this, null, aTag, aName);</span>
<a href="#l14.513"></a><span id="l14.513" class="difflineplus">+    this._buddies[buddy.normalizedName] = buddy;</span>
<a href="#l14.514"></a><span id="l14.514" class="difflineplus">+</span>
<a href="#l14.515"></a><span id="l14.515" class="difflineplus">+    // Put the username as the first to be checked on the next ISON call.</span>
<a href="#l14.516"></a><span id="l14.516" class="difflineplus">+    this._isOnQueue.unshift(buddy.userName);</span>
<a href="#l14.517"></a><span id="l14.517" class="difflineplus">+</span>
<a href="#l14.518"></a><span id="l14.518" class="difflineplus">+    Services.contacts.accountBuddyAdded(buddy);</span>
<a href="#l14.519"></a><span id="l14.519" class="difflineplus">+  },</span>
<a href="#l14.520"></a><span id="l14.520" class="difflineplus">+  // Loads a buddy from the local storage. Called for each buddy locally stored</span>
<a href="#l14.521"></a><span id="l14.521" class="difflineplus">+  // before connecting to the server.</span>
<a href="#l14.522"></a><span id="l14.522" class="difflineplus">+  loadBuddy: function(aBuddy, aTag) {</span>
<a href="#l14.523"></a><span id="l14.523" class="difflineplus">+    let buddy = new ircAccountBuddy(this, aBuddy, aTag);</span>
<a href="#l14.524"></a><span id="l14.524" class="difflineplus">+    this._buddies[buddy.normalizedName] = buddy;</span>
<a href="#l14.525"></a><span id="l14.525" class="difflineplus">+    // Put each buddy name into the ISON queue.</span>
<a href="#l14.526"></a><span id="l14.526" class="difflineplus">+    this._isOnQueue.push(buddy.userName);</span>
<a href="#l14.527"></a><span id="l14.527" class="difflineplus">+    return buddy;</span>
<a href="#l14.528"></a><span id="l14.528" class="difflineplus">+  },</span>
<a href="#l14.529"></a><span id="l14.529" class="difflineplus">+  hasBuddy: function(aName)</span>
<a href="#l14.530"></a><span id="l14.530" class="difflineplus">+    hasOwnProperty(this._buddies, this.normalize(aName, this.userPrefixes)),</span>
<a href="#l14.531"></a><span id="l14.531" class="difflineplus">+  // Return an array of buddy names.</span>
<a href="#l14.532"></a><span id="l14.532" class="difflineplus">+  getBuddyNames: function() {</span>
<a href="#l14.533"></a><span id="l14.533" class="difflineplus">+    let buddies = [];</span>
<a href="#l14.534"></a><span id="l14.534" class="difflineplus">+    for each (let buddyName in Object.keys(this._buddies))</span>
<a href="#l14.535"></a><span id="l14.535" class="difflineplus">+      buddies.push(this._buddies[buddyName].userName);</span>
<a href="#l14.536"></a><span id="l14.536" class="difflineplus">+    return buddies;</span>
<a href="#l14.537"></a><span id="l14.537" class="difflineplus">+  },</span>
<a href="#l14.538"></a><span id="l14.538" class="difflineplus">+  getBuddy: function(aName) {</span>
<a href="#l14.539"></a><span id="l14.539" class="difflineplus">+    if (this.hasBuddy(aName))</span>
<a href="#l14.540"></a><span id="l14.540" class="difflineplus">+      return this._buddies[this.normalize(aName, this.userPrefixes)];</span>
<a href="#l14.541"></a><span id="l14.541" class="difflineplus">+    return null;</span>
<a href="#l14.542"></a><span id="l14.542" class="difflineplus">+  },</span>
<a href="#l14.543"></a><span id="l14.543" class="difflineplus">+  changeBuddyNick: function(aOldNick, aNewNick) {</span>
<a href="#l14.544"></a><span id="l14.544" class="difflineplus">+    let msg;</span>
<a href="#l14.545"></a><span id="l14.545" class="difflineplus">+    // Your nickname changed!</span>
<a href="#l14.546"></a><span id="l14.546" class="difflineplus">+    if (this.normalize(aOldNick) == this.normalize(this._nickname)) {</span>
<a href="#l14.547"></a><span id="l14.547" class="difflineplus">+      this._nickname = aNewNick;</span>
<a href="#l14.548"></a><span id="l14.548" class="difflineplus">+      msg = _(&quot;message.nick.you&quot;, aNewNick);</span>
<a href="#l14.549"></a><span id="l14.549" class="difflineplus">+    }</span>
<a href="#l14.550"></a><span id="l14.550" class="difflineplus">+    else</span>
<a href="#l14.551"></a><span id="l14.551" class="difflineplus">+      msg = _(&quot;message.nick&quot;, aOldNick, aNewNick);</span>
<a href="#l14.552"></a><span id="l14.552" class="difflineplus">+</span>
<a href="#l14.553"></a><span id="l14.553" class="difflineplus">+    for each (let conversation in this._conversations) {</span>
<a href="#l14.554"></a><span id="l14.554" class="difflineplus">+      if (conversation.isChat &amp;&amp; conversation.hasParticipant(aOldNick)) {</span>
<a href="#l14.555"></a><span id="l14.555" class="difflineplus">+        // Update the nick in every chat conversation the user is in.</span>
<a href="#l14.556"></a><span id="l14.556" class="difflineplus">+        conversation.updateNick(aOldNick, aNewNick);</span>
<a href="#l14.557"></a><span id="l14.557" class="difflineplus">+        conversation.writeMessage(aOldNick, msg, {system: true});</span>
<a href="#l14.558"></a><span id="l14.558" class="difflineplus">+      }</span>
<a href="#l14.559"></a><span id="l14.559" class="difflineplus">+    }</span>
<a href="#l14.560"></a><span id="l14.560" class="difflineplus">+</span>
<a href="#l14.561"></a><span id="l14.561" class="difflineplus">+    // If a private conversation is open with that user, change its title.</span>
<a href="#l14.562"></a><span id="l14.562" class="difflineplus">+    if (this.hasConversation(aOldNick)) {</span>
<a href="#l14.563"></a><span id="l14.563" class="difflineplus">+      // Get the current conversation and rename it.</span>
<a href="#l14.564"></a><span id="l14.564" class="difflineplus">+      let conversation = this.getConversation(aOldNick);</span>
<a href="#l14.565"></a><span id="l14.565" class="difflineplus">+</span>
<a href="#l14.566"></a><span id="l14.566" class="difflineplus">+      // Remove the old reference to the conversation and create a new one.</span>
<a href="#l14.567"></a><span id="l14.567" class="difflineplus">+      this.removeConversation(aOldNick);</span>
<a href="#l14.568"></a><span id="l14.568" class="difflineplus">+      this._conversations[this.normalize(aNewNick)] = conversation;</span>
<a href="#l14.569"></a><span id="l14.569" class="difflineplus">+</span>
<a href="#l14.570"></a><span id="l14.570" class="difflineplus">+      conversation.updateNick(aNewNick);</span>
<a href="#l14.571"></a><span id="l14.571" class="difflineplus">+      conversation.writeMessage(aOldNick, msg, {system: true});</span>
<a href="#l14.572"></a><span id="l14.572" class="difflineplus">+    }</span>
<a href="#l14.573"></a><span id="l14.573" class="difflineplus">+  },</span>
<a href="#l14.574"></a><span id="l14.574" class="difflineplus">+</span>
<a href="#l14.575"></a><span id="l14.575" class="difflineplus">+  countBytes: function(aStr) {</span>
<a href="#l14.576"></a><span id="l14.576" class="difflineplus">+    // Assume that if it's not UTF-8 then each character is 1 byte.</span>
<a href="#l14.577"></a><span id="l14.577" class="difflineplus">+    if (this._encoding != &quot;UTF-8&quot;)</span>
<a href="#l14.578"></a><span id="l14.578" class="difflineplus">+      return aStr.length;</span>
<a href="#l14.579"></a><span id="l14.579" class="difflineplus">+</span>
<a href="#l14.580"></a><span id="l14.580" class="difflineplus">+    // Count the number of bytes in a UTF-8 encoded string.</span>
<a href="#l14.581"></a><span id="l14.581" class="difflineplus">+    function charCodeToByteCount(c) {</span>
<a href="#l14.582"></a><span id="l14.582" class="difflineplus">+      // Unicode characters with a code point &gt;  127 are 2 bytes long.</span>
<a href="#l14.583"></a><span id="l14.583" class="difflineplus">+      // Unicode characters with a code point &gt; 2047 are 3 bytes long.</span>
<a href="#l14.584"></a><span id="l14.584" class="difflineplus">+      return c &lt; 128 ? 1 : c &lt; 2048 ? 2 : 3;</span>
<a href="#l14.585"></a><span id="l14.585" class="difflineplus">+    }</span>
<a href="#l14.586"></a><span id="l14.586" class="difflineplus">+    let bytes = 0;</span>
<a href="#l14.587"></a><span id="l14.587" class="difflineplus">+    for (let i = 0; i &lt; aStr.length; i++)</span>
<a href="#l14.588"></a><span id="l14.588" class="difflineplus">+      bytes += charCodeToByteCount(aStr.charCodeAt(i));</span>
<a href="#l14.589"></a><span id="l14.589" class="difflineplus">+    return bytes;</span>
<a href="#l14.590"></a><span id="l14.590" class="difflineplus">+  },</span>
<a href="#l14.591"></a><span id="l14.591" class="difflineplus">+</span>
<a href="#l14.592"></a><span id="l14.592" class="difflineplus">+  // To check if users are online, we need to queue multiple messages.</span>
<a href="#l14.593"></a><span id="l14.593" class="difflineplus">+  // An internal queue of all nicks that we wish to know the status of.</span>
<a href="#l14.594"></a><span id="l14.594" class="difflineplus">+  _isOnQueue: [],</span>
<a href="#l14.595"></a><span id="l14.595" class="difflineplus">+  // The nicks that were last sent to the server that we're waiting for a</span>
<a href="#l14.596"></a><span id="l14.596" class="difflineplus">+  // response about.</span>
<a href="#l14.597"></a><span id="l14.597" class="difflineplus">+  pendingIsOnQueue: [],</span>
<a href="#l14.598"></a><span id="l14.598" class="difflineplus">+  // The time between sending isOn messages (milliseconds).</span>
<a href="#l14.599"></a><span id="l14.599" class="difflineplus">+  _isOnDelay: 60 * 1000,</span>
<a href="#l14.600"></a><span id="l14.600" class="difflineplus">+  _isOnTimer: null,</span>
<a href="#l14.601"></a><span id="l14.601" class="difflineplus">+  // The number of characters that are available to be filled with nicks for</span>
<a href="#l14.602"></a><span id="l14.602" class="difflineplus">+  // each ISON message.</span>
<a href="#l14.603"></a><span id="l14.603" class="difflineplus">+  _isOnLength: null,</span>
<a href="#l14.604"></a><span id="l14.604" class="difflineplus">+  // Generate and send an ISON message to poll for each nick's status.</span>
<a href="#l14.605"></a><span id="l14.605" class="difflineplus">+  sendIsOn: function() {</span>
<a href="#l14.606"></a><span id="l14.606" class="difflineplus">+    // If no buddies, just look again after the timeout.</span>
<a href="#l14.607"></a><span id="l14.607" class="difflineplus">+    if (this._isOnQueue.length) {</span>
<a href="#l14.608"></a><span id="l14.608" class="difflineplus">+      // Calculate the possible length of names we can send.</span>
<a href="#l14.609"></a><span id="l14.609" class="difflineplus">+      if (!this._isOnLength) {</span>
<a href="#l14.610"></a><span id="l14.610" class="difflineplus">+        let length = this.countBytes(this.buildMessage(&quot;ISON&quot;, &quot; &quot;)) + 2;</span>
<a href="#l14.611"></a><span id="l14.611" class="difflineplus">+        this._isOnLength = this.maxMessageLength - length + 1;</span>
<a href="#l14.612"></a><span id="l14.612" class="difflineplus">+      }</span>
<a href="#l14.613"></a><span id="l14.613" class="difflineplus">+</span>
<a href="#l14.614"></a><span id="l14.614" class="difflineplus">+      // Add any previously pending queue to the end of the ISON queue.</span>
<a href="#l14.615"></a><span id="l14.615" class="difflineplus">+      if (this.pendingIsOnQueue)</span>
<a href="#l14.616"></a><span id="l14.616" class="difflineplus">+        this._isOnQueue = this._isOnQueue.concat(this.pendingIsOnQueue);</span>
<a href="#l14.617"></a><span id="l14.617" class="difflineplus">+</span>
<a href="#l14.618"></a><span id="l14.618" class="difflineplus">+      // Always add the next nickname to the pending queue, this handles a silly</span>
<a href="#l14.619"></a><span id="l14.619" class="difflineplus">+      // case where the next nick is greater than or equal to the maximum</span>
<a href="#l14.620"></a><span id="l14.620" class="difflineplus">+      // message length.</span>
<a href="#l14.621"></a><span id="l14.621" class="difflineplus">+      this.pendingIsOnQueue = [this._isOnQueue.shift()];</span>
<a href="#l14.622"></a><span id="l14.622" class="difflineplus">+</span>
<a href="#l14.623"></a><span id="l14.623" class="difflineplus">+      // Attempt to maximize the characters used in each message, this may mean</span>
<a href="#l14.624"></a><span id="l14.624" class="difflineplus">+      // that a specific user gets sent very often since they have a short name!</span>
<a href="#l14.625"></a><span id="l14.625" class="difflineplus">+      let buddiesLength = this.countBytes(this.pendingIsOnQueue[0]);</span>
<a href="#l14.626"></a><span id="l14.626" class="difflineplus">+      for (let i = 0; i &lt; this._isOnQueue.length; i++) {</span>
<a href="#l14.627"></a><span id="l14.627" class="difflineplus">+        // If we can fit the nick, add it to the current buffer.</span>
<a href="#l14.628"></a><span id="l14.628" class="difflineplus">+        if ((buddiesLength + this.countBytes(this._isOnQueue[i])) &lt; this._isOnLength) {</span>
<a href="#l14.629"></a><span id="l14.629" class="difflineplus">+          // Remove the name from the list and add it to the pending queue.</span>
<a href="#l14.630"></a><span id="l14.630" class="difflineplus">+          let nick = this._isOnQueue.splice(i--, 1)[0];</span>
<a href="#l14.631"></a><span id="l14.631" class="difflineplus">+          this.pendingIsOnQueue.push(nick);</span>
<a href="#l14.632"></a><span id="l14.632" class="difflineplus">+</span>
<a href="#l14.633"></a><span id="l14.633" class="difflineplus">+          // Keep track of the length of the string, the + 1 is for the spaces.</span>
<a href="#l14.634"></a><span id="l14.634" class="difflineplus">+          buddiesLength += this.countBytes(nick) + 1;</span>
<a href="#l14.635"></a><span id="l14.635" class="difflineplus">+</span>
<a href="#l14.636"></a><span id="l14.636" class="difflineplus">+          // If we've filled up the message, stop looking for more nicks.</span>
<a href="#l14.637"></a><span id="l14.637" class="difflineplus">+          if (buddiesLength &gt;= this._isOnLength)</span>
<a href="#l14.638"></a><span id="l14.638" class="difflineplus">+            break;</span>
<a href="#l14.639"></a><span id="l14.639" class="difflineplus">+        }</span>
<a href="#l14.640"></a><span id="l14.640" class="difflineplus">+      }</span>
<a href="#l14.641"></a><span id="l14.641" class="difflineplus">+</span>
<a href="#l14.642"></a><span id="l14.642" class="difflineplus">+      // Send the message.</span>
<a href="#l14.643"></a><span id="l14.643" class="difflineplus">+      this.sendMessage(&quot;ISON&quot;, this.pendingIsOnQueue.join(&quot; &quot;));</span>
<a href="#l14.644"></a><span id="l14.644" class="difflineplus">+    }</span>
<a href="#l14.645"></a><span id="l14.645" class="difflineplus">+</span>
<a href="#l14.646"></a><span id="l14.646" class="difflineplus">+    // Call this function again in _isOnDelay seconds.</span>
<a href="#l14.647"></a><span id="l14.647" class="difflineplus">+    // This makes the assumption that this._isOnDelay &gt;&gt; the response to ISON</span>
<a href="#l14.648"></a><span id="l14.648" class="difflineplus">+    // from the server.</span>
<a href="#l14.649"></a><span id="l14.649" class="difflineplus">+    this._isOnTimer = setTimeout(this.sendIsOn.bind(this), this._isOnDelay);</span>
<a href="#l14.650"></a><span id="l14.650" class="difflineplus">+  },</span>
<a href="#l14.651"></a><span id="l14.651" class="difflineplus">+</span>
<a href="#l14.652"></a><span id="l14.652" class="difflineplus">+  connect: function() {</span>
<a href="#l14.653"></a><span id="l14.653" class="difflineplus">+    this.reportConnecting();</span>
<a href="#l14.654"></a><span id="l14.654" class="difflineplus">+</span>
<a href="#l14.655"></a><span id="l14.655" class="difflineplus">+    // Load preferences.</span>
<a href="#l14.656"></a><span id="l14.656" class="difflineplus">+    this._port = this.getInt(&quot;port&quot;);</span>
<a href="#l14.657"></a><span id="l14.657" class="difflineplus">+    this._ssl = this.getBool(&quot;ssl&quot;);</span>
<a href="#l14.658"></a><span id="l14.658" class="difflineplus">+    // Use the display name as the user's real name.</span>
<a href="#l14.659"></a><span id="l14.659" class="difflineplus">+    this._realname = this.imAccount.statusInfo.displayName;</span>
<a href="#l14.660"></a><span id="l14.660" class="difflineplus">+    this._encoding = this.getString(&quot;encoding&quot;) || &quot;UTF-8&quot;;</span>
<a href="#l14.661"></a><span id="l14.661" class="difflineplus">+    this._showServerTab = this.getBool(&quot;showServerTab&quot;);</span>
<a href="#l14.662"></a><span id="l14.662" class="difflineplus">+</span>
<a href="#l14.663"></a><span id="l14.663" class="difflineplus">+    // Open the socket connection.</span>
<a href="#l14.664"></a><span id="l14.664" class="difflineplus">+    this._socket = new ircSocket(this);</span>
<a href="#l14.665"></a><span id="l14.665" class="difflineplus">+    this._socket.connect(this._server, this._port, this._ssl ? [&quot;ssl&quot;] : []);</span>
<a href="#l14.666"></a><span id="l14.666" class="difflineplus">+  },</span>
<a href="#l14.667"></a><span id="l14.667" class="difflineplus">+</span>
<a href="#l14.668"></a><span id="l14.668" class="difflineplus">+  // Used to wait for a response from the server.</span>
<a href="#l14.669"></a><span id="l14.669" class="difflineplus">+  _quitTimer: null,</span>
<a href="#l14.670"></a><span id="l14.670" class="difflineplus">+  // RFC 2812 Section 3.1.7.</span>
<a href="#l14.671"></a><span id="l14.671" class="difflineplus">+  quit: function(aMessage) {</span>
<a href="#l14.672"></a><span id="l14.672" class="difflineplus">+    this.sendMessage(&quot;QUIT&quot;,</span>
<a href="#l14.673"></a><span id="l14.673" class="difflineplus">+                     aMessage || this.getString(&quot;quitmsg&quot;) || undefined);</span>
<a href="#l14.674"></a><span id="l14.674" class="difflineplus">+  },</span>
<a href="#l14.675"></a><span id="l14.675" class="difflineplus">+  // When the user clicks &quot;Disconnect&quot; in account manager</span>
<a href="#l14.676"></a><span id="l14.676" class="difflineplus">+  disconnect: function() {</span>
<a href="#l14.677"></a><span id="l14.677" class="difflineplus">+    if (this.disconnected || this.disconnecting)</span>
<a href="#l14.678"></a><span id="l14.678" class="difflineplus">+       return;</span>
<a href="#l14.679"></a><span id="l14.679" class="difflineplus">+</span>
<a href="#l14.680"></a><span id="l14.680" class="difflineplus">+    this.reportDisconnecting(Ci.prplIAccount.NO_ERROR,</span>
<a href="#l14.681"></a><span id="l14.681" class="difflineplus">+                             _(&quot;connection.quitting&quot;));</span>
<a href="#l14.682"></a><span id="l14.682" class="difflineplus">+</span>
<a href="#l14.683"></a><span id="l14.683" class="difflineplus">+    // Let the server know we're going to disconnect.</span>
<a href="#l14.684"></a><span id="l14.684" class="difflineplus">+    this.quit();</span>
<a href="#l14.685"></a><span id="l14.685" class="difflineplus">+</span>
<a href="#l14.686"></a><span id="l14.686" class="difflineplus">+    // Give the server 2 seconds to respond, otherwise just forcefully</span>
<a href="#l14.687"></a><span id="l14.687" class="difflineplus">+    // disconnect the socket. This will be cancelled if a response is heard from</span>
<a href="#l14.688"></a><span id="l14.688" class="difflineplus">+    // the server.</span>
<a href="#l14.689"></a><span id="l14.689" class="difflineplus">+    this._quitTimer = setTimeout(this.gotDisconnected.bind(this), 2 * 1000);</span>
<a href="#l14.690"></a><span id="l14.690" class="difflineplus">+  },</span>
<a href="#l14.691"></a><span id="l14.691" class="difflineplus">+</span>
<a href="#l14.692"></a><span id="l14.692" class="difflineplus">+  createConversation: function(aName) this.getConversation(aName),</span>
<a href="#l14.693"></a><span id="l14.693" class="difflineplus">+</span>
<a href="#l14.694"></a><span id="l14.694" class="difflineplus">+  // aComponents implements prplIChatRoomFieldValues.</span>
<a href="#l14.695"></a><span id="l14.695" class="difflineplus">+  joinChat: function(aComponents) {</span>
<a href="#l14.696"></a><span id="l14.696" class="difflineplus">+    let params = [aComponents.getValue(&quot;channel&quot;)];</span>
<a href="#l14.697"></a><span id="l14.697" class="difflineplus">+    let password = aComponents.getValue(&quot;password&quot;);</span>
<a href="#l14.698"></a><span id="l14.698" class="difflineplus">+    if (password)</span>
<a href="#l14.699"></a><span id="l14.699" class="difflineplus">+      params.push(password);</span>
<a href="#l14.700"></a><span id="l14.700" class="difflineplus">+    this.sendMessage(&quot;JOIN&quot;, params);</span>
<a href="#l14.701"></a><span id="l14.701" class="difflineplus">+  },</span>
<a href="#l14.702"></a><span id="l14.702" class="difflineplus">+</span>
<a href="#l14.703"></a><span id="l14.703" class="difflineplus">+  chatRoomFields: {</span>
<a href="#l14.704"></a><span id="l14.704" class="difflineplus">+    &quot;channel&quot;: {&quot;label&quot;: _(&quot;joinChat.channel&quot;), &quot;required&quot;: true},</span>
<a href="#l14.705"></a><span id="l14.705" class="difflineplus">+    &quot;password&quot;: {&quot;label&quot;: _(&quot;joinChat.password&quot;), &quot;isPassword&quot;: true}</span>
<a href="#l14.706"></a><span id="l14.706" class="difflineplus">+  },</span>
<a href="#l14.707"></a><span id="l14.707" class="difflineplus">+</span>
<a href="#l14.708"></a><span id="l14.708" class="difflineplus">+  parseDefaultChatName: function(aDefaultName) ({&quot;channel&quot;: aDefaultName}),</span>
<a href="#l14.709"></a><span id="l14.709" class="difflineplus">+</span>
<a href="#l14.710"></a><span id="l14.710" class="difflineplus">+  // Attributes</span>
<a href="#l14.711"></a><span id="l14.711" class="difflineplus">+  get canJoinChat() true,</span>
<a href="#l14.712"></a><span id="l14.712" class="difflineplus">+</span>
<a href="#l14.713"></a><span id="l14.713" class="difflineplus">+  hasConversation: function(aConversationName)</span>
<a href="#l14.714"></a><span id="l14.714" class="difflineplus">+    hasOwnProperty(this._conversations, this.normalize(aConversationName)),</span>
<a href="#l14.715"></a><span id="l14.715" class="difflineplus">+</span>
<a href="#l14.716"></a><span id="l14.716" class="difflineplus">+  // Returns a conversation (creates it if it doesn't exist)</span>
<a href="#l14.717"></a><span id="l14.717" class="difflineplus">+  getConversation: function(aName) {</span>
<a href="#l14.718"></a><span id="l14.718" class="difflineplus">+    let name = this.normalize(aName);</span>
<a href="#l14.719"></a><span id="l14.719" class="difflineplus">+    if (!this.hasConversation(aName)) {</span>
<a href="#l14.720"></a><span id="l14.720" class="difflineplus">+      let constructor = this.isMUCName(aName) ? ircChannel : ircConversation;</span>
<a href="#l14.721"></a><span id="l14.721" class="difflineplus">+      this._conversations[name] = new constructor(this, aName, this._nickname);</span>
<a href="#l14.722"></a><span id="l14.722" class="difflineplus">+    }</span>
<a href="#l14.723"></a><span id="l14.723" class="difflineplus">+    return this._conversations[name];</span>
<a href="#l14.724"></a><span id="l14.724" class="difflineplus">+  },</span>
<a href="#l14.725"></a><span id="l14.725" class="difflineplus">+</span>
<a href="#l14.726"></a><span id="l14.726" class="difflineplus">+  removeConversation: function(aConversationName) {</span>
<a href="#l14.727"></a><span id="l14.727" class="difflineplus">+    if (this.hasConversation(aConversationName))</span>
<a href="#l14.728"></a><span id="l14.728" class="difflineplus">+      delete this._conversations[this.normalize(aConversationName)];</span>
<a href="#l14.729"></a><span id="l14.729" class="difflineplus">+  },</span>
<a href="#l14.730"></a><span id="l14.730" class="difflineplus">+</span>
<a href="#l14.731"></a><span id="l14.731" class="difflineplus">+  // This builds the message string that will be sent to the server.</span>
<a href="#l14.732"></a><span id="l14.732" class="difflineplus">+  buildMessage: function(aCommand, aParams) {</span>
<a href="#l14.733"></a><span id="l14.733" class="difflineplus">+    if (!aCommand) {</span>
<a href="#l14.734"></a><span id="l14.734" class="difflineplus">+      ERROR(&quot;IRC messages must have a command.&quot;);</span>
<a href="#l14.735"></a><span id="l14.735" class="difflineplus">+      return null;</span>
<a href="#l14.736"></a><span id="l14.736" class="difflineplus">+    }</span>
<a href="#l14.737"></a><span id="l14.737" class="difflineplus">+</span>
<a href="#l14.738"></a><span id="l14.738" class="difflineplus">+    // Ensure a command is only characters or numbers.</span>
<a href="#l14.739"></a><span id="l14.739" class="difflineplus">+    if (!/^[A-Z0-9]+$/i.test(aCommand)) {</span>
<a href="#l14.740"></a><span id="l14.740" class="difflineplus">+      ERROR(&quot;IRC command invalid: &quot; + aCommand);</span>
<a href="#l14.741"></a><span id="l14.741" class="difflineplus">+      return null;</span>
<a href="#l14.742"></a><span id="l14.742" class="difflineplus">+    }</span>
<a href="#l14.743"></a><span id="l14.743" class="difflineplus">+</span>
<a href="#l14.744"></a><span id="l14.744" class="difflineplus">+    let message = aCommand;</span>
<a href="#l14.745"></a><span id="l14.745" class="difflineplus">+    // If aParams is empty, then use an empty array. If aParams is not an array,</span>
<a href="#l14.746"></a><span id="l14.746" class="difflineplus">+    // consider it to be a single parameter and put it into an array.</span>
<a href="#l14.747"></a><span id="l14.747" class="difflineplus">+    let params = !aParams ? [] : Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l14.748"></a><span id="l14.748" class="difflineplus">+    if (params.length) {</span>
<a href="#l14.749"></a><span id="l14.749" class="difflineplus">+      if (params.slice(0, -1).some(function(p) p.indexOf(&quot; &quot;) != -1)) {</span>
<a href="#l14.750"></a><span id="l14.750" class="difflineplus">+        ERROR(&quot;IRC parameters cannot have spaces: &quot; + params.slice(0, -1));</span>
<a href="#l14.751"></a><span id="l14.751" class="difflineplus">+        return null;</span>
<a href="#l14.752"></a><span id="l14.752" class="difflineplus">+      }</span>
<a href="#l14.753"></a><span id="l14.753" class="difflineplus">+      // Join the parameters with spaces, except the last parameter which gets</span>
<a href="#l14.754"></a><span id="l14.754" class="difflineplus">+      // joined with a &quot; :&quot; before it (and can contain spaces).</span>
<a href="#l14.755"></a><span id="l14.755" class="difflineplus">+      message += &quot; &quot; + params.concat(&quot;:&quot; + params.pop()).join(&quot; &quot;);</span>
<a href="#l14.756"></a><span id="l14.756" class="difflineplus">+    }</span>
<a href="#l14.757"></a><span id="l14.757" class="difflineplus">+</span>
<a href="#l14.758"></a><span id="l14.758" class="difflineplus">+    return message;</span>
<a href="#l14.759"></a><span id="l14.759" class="difflineplus">+  },</span>
<a href="#l14.760"></a><span id="l14.760" class="difflineplus">+</span>
<a href="#l14.761"></a><span id="l14.761" class="difflineplus">+  // Shortcut method to build &amp; send a message at once. Use aLoggedData to log</span>
<a href="#l14.762"></a><span id="l14.762" class="difflineplus">+  // something different than what is actually sent.</span>
<a href="#l14.763"></a><span id="l14.763" class="difflineplus">+  sendMessage: function(aCommand, aParams, aLoggedData) {</span>
<a href="#l14.764"></a><span id="l14.764" class="difflineplus">+    this.sendRawMessage(this.buildMessage(aCommand, aParams), aLoggedData);</span>
<a href="#l14.765"></a><span id="l14.765" class="difflineplus">+  },</span>
<a href="#l14.766"></a><span id="l14.766" class="difflineplus">+</span>
<a href="#l14.767"></a><span id="l14.767" class="difflineplus">+  // This sends a message over the socket and catches any errors. Use</span>
<a href="#l14.768"></a><span id="l14.768" class="difflineplus">+  // aLoggedData to log something different than what is actually sent.</span>
<a href="#l14.769"></a><span id="l14.769" class="difflineplus">+  sendRawMessage: function(aMessage, aLoggedData) {</span>
<a href="#l14.770"></a><span id="l14.770" class="difflineplus">+    // XXX This should escape any characters that can't be used in IRC (e.g.</span>
<a href="#l14.771"></a><span id="l14.771" class="difflineplus">+    // \001, \r\n).</span>
<a href="#l14.772"></a><span id="l14.772" class="difflineplus">+</span>
<a href="#l14.773"></a><span id="l14.773" class="difflineplus">+    let length = this.countBytes(aMessage) + 2;</span>
<a href="#l14.774"></a><span id="l14.774" class="difflineplus">+    if (length &gt; this.maxMessageLength) {</span>
<a href="#l14.775"></a><span id="l14.775" class="difflineplus">+      // Log if the message is too long, but try to send it anyway.</span>
<a href="#l14.776"></a><span id="l14.776" class="difflineplus">+      WARN(&quot;Message length too long (&quot; + length + &quot; &gt; &quot; +</span>
<a href="#l14.777"></a><span id="l14.777" class="difflineplus">+           this.maxMessageLength + &quot;\n&quot; + aMessage);</span>
<a href="#l14.778"></a><span id="l14.778" class="difflineplus">+    }</span>
<a href="#l14.779"></a><span id="l14.779" class="difflineplus">+</span>
<a href="#l14.780"></a><span id="l14.780" class="difflineplus">+    try {</span>
<a href="#l14.781"></a><span id="l14.781" class="difflineplus">+      this._socket.sendString(aMessage, this._encoding, aLoggedData);</span>
<a href="#l14.782"></a><span id="l14.782" class="difflineplus">+    } catch (e) {</span>
<a href="#l14.783"></a><span id="l14.783" class="difflineplus">+      try {</span>
<a href="#l14.784"></a><span id="l14.784" class="difflineplus">+        WARN(&quot;Failed to convert &quot; + aMessage + &quot; from Unicode to &quot; +</span>
<a href="#l14.785"></a><span id="l14.785" class="difflineplus">+             this._encoding + &quot;.&quot;);</span>
<a href="#l14.786"></a><span id="l14.786" class="difflineplus">+        this._socket.sendData(aMessage, aLoggedData);</span>
<a href="#l14.787"></a><span id="l14.787" class="difflineplus">+      } catch(e) {</span>
<a href="#l14.788"></a><span id="l14.788" class="difflineplus">+        ERROR(&quot;Socket error: &quot; + e);</span>
<a href="#l14.789"></a><span id="l14.789" class="difflineplus">+        this.gotDisconnected(Ci.prplIAccount.ERROR_NETWORK_ERROR,</span>
<a href="#l14.790"></a><span id="l14.790" class="difflineplus">+                             _(&quot;connection.error.lost&quot;));</span>
<a href="#l14.791"></a><span id="l14.791" class="difflineplus">+      }</span>
<a href="#l14.792"></a><span id="l14.792" class="difflineplus">+    }</span>
<a href="#l14.793"></a><span id="l14.793" class="difflineplus">+  },</span>
<a href="#l14.794"></a><span id="l14.794" class="difflineplus">+</span>
<a href="#l14.795"></a><span id="l14.795" class="difflineplus">+  // CTCP messages are \001&lt;COMMAND&gt; [&lt;parameters&gt;]*\001.</span>
<a href="#l14.796"></a><span id="l14.796" class="difflineplus">+  sendCTCPMessage: function(aCommand, aParams, aTarget, aIsNotice) {</span>
<a href="#l14.797"></a><span id="l14.797" class="difflineplus">+    // Combine the CTCP command and parameters into the single IRC param.</span>
<a href="#l14.798"></a><span id="l14.798" class="difflineplus">+    let ircParam = &quot;\x01&quot; + aCommand;</span>
<a href="#l14.799"></a><span id="l14.799" class="difflineplus">+    // If aParams is empty, then use an empty array. If aParams is not an array,</span>
<a href="#l14.800"></a><span id="l14.800" class="difflineplus">+    // consider it to be a single parameter and put it into an array.</span>
<a href="#l14.801"></a><span id="l14.801" class="difflineplus">+    let params = !aParams ? [] : Array.isArray(aParams) ? aParams : [aParams];</span>
<a href="#l14.802"></a><span id="l14.802" class="difflineplus">+    if (params.length)</span>
<a href="#l14.803"></a><span id="l14.803" class="difflineplus">+      ircParam += &quot; &quot; + params.join(&quot; &quot;);</span>
<a href="#l14.804"></a><span id="l14.804" class="difflineplus">+    ircParam += &quot;\x01&quot;;</span>
<a href="#l14.805"></a><span id="l14.805" class="difflineplus">+</span>
<a href="#l14.806"></a><span id="l14.806" class="difflineplus">+    // Send the IRC message as a NOTICE or PRIVMSG.</span>
<a href="#l14.807"></a><span id="l14.807" class="difflineplus">+    this.sendMessage(aIsNotice ? &quot;NOTICE&quot; : &quot;PRIVMSG&quot;, [aTarget, ircParam]);</span>
<a href="#l14.808"></a><span id="l14.808" class="difflineplus">+  },</span>
<a href="#l14.809"></a><span id="l14.809" class="difflineplus">+</span>
<a href="#l14.810"></a><span id="l14.810" class="difflineplus">+  // Implement section 3.1 of RFC 2812</span>
<a href="#l14.811"></a><span id="l14.811" class="difflineplus">+  _connectionRegistration: function() {</span>
<a href="#l14.812"></a><span id="l14.812" class="difflineplus">+    // Send the password message, if provided (section 3.1.1).</span>
<a href="#l14.813"></a><span id="l14.813" class="difflineplus">+    if (this.imAccount.password) {</span>
<a href="#l14.814"></a><span id="l14.814" class="difflineplus">+      this.sendMessage(&quot;PASS&quot;, this.imAccount.password,</span>
<a href="#l14.815"></a><span id="l14.815" class="difflineplus">+                       &quot;PASS &lt;password not logged&gt;&quot;);</span>
<a href="#l14.816"></a><span id="l14.816" class="difflineplus">+    }</span>
<a href="#l14.817"></a><span id="l14.817" class="difflineplus">+    // Send the nick message (section 3.1.2).</span>
<a href="#l14.818"></a><span id="l14.818" class="difflineplus">+    this.sendMessage(&quot;NICK&quot;, this._nickname);</span>
<a href="#l14.819"></a><span id="l14.819" class="difflineplus">+</span>
<a href="#l14.820"></a><span id="l14.820" class="difflineplus">+    // Send the user message (section 3.1.3).</span>
<a href="#l14.821"></a><span id="l14.821" class="difflineplus">+    // Use brandShortName as the username.</span>
<a href="#l14.822"></a><span id="l14.822" class="difflineplus">+    let username =</span>
<a href="#l14.823"></a><span id="l14.823" class="difflineplus">+      l10nHelper(&quot;chrome://branding/locale/brand.properties&quot;)(&quot;brandShortName&quot;);</span>
<a href="#l14.824"></a><span id="l14.824" class="difflineplus">+    this.sendMessage(&quot;USER&quot;, [username, this._mode.toString(), &quot;*&quot;,</span>
<a href="#l14.825"></a><span id="l14.825" class="difflineplus">+                              this._realname || this._nickname]);</span>
<a href="#l14.826"></a><span id="l14.826" class="difflineplus">+  },</span>
<a href="#l14.827"></a><span id="l14.827" class="difflineplus">+</span>
<a href="#l14.828"></a><span id="l14.828" class="difflineplus">+  gotDisconnected: function(aError, aErrorMessage) {</span>
<a href="#l14.829"></a><span id="l14.829" class="difflineplus">+    if (!this.imAccount || this.disconnected)</span>
<a href="#l14.830"></a><span id="l14.830" class="difflineplus">+       return;</span>
<a href="#l14.831"></a><span id="l14.831" class="difflineplus">+</span>
<a href="#l14.832"></a><span id="l14.832" class="difflineplus">+    if (aError === undefined)</span>
<a href="#l14.833"></a><span id="l14.833" class="difflineplus">+      aError = Ci.prplIAccount.NO_ERROR;</span>
<a href="#l14.834"></a><span id="l14.834" class="difflineplus">+    // If we are already disconnecting, this call to gotDisconnected</span>
<a href="#l14.835"></a><span id="l14.835" class="difflineplus">+    // is when the server acknowledges our disconnection.</span>
<a href="#l14.836"></a><span id="l14.836" class="difflineplus">+    // Otherwise it's because we lost the connection.</span>
<a href="#l14.837"></a><span id="l14.837" class="difflineplus">+    if (!this.disconnecting)</span>
<a href="#l14.838"></a><span id="l14.838" class="difflineplus">+      this.reportDisconnecting(aError, aErrorMessage);</span>
<a href="#l14.839"></a><span id="l14.839" class="difflineplus">+    this._socket.disconnect();</span>
<a href="#l14.840"></a><span id="l14.840" class="difflineplus">+    delete this._socket;</span>
<a href="#l14.841"></a><span id="l14.841" class="difflineplus">+</span>
<a href="#l14.842"></a><span id="l14.842" class="difflineplus">+    clearTimeout(this._isOnTimer);</span>
<a href="#l14.843"></a><span id="l14.843" class="difflineplus">+    delete this._isOnTimer;</span>
<a href="#l14.844"></a><span id="l14.844" class="difflineplus">+</span>
<a href="#l14.845"></a><span id="l14.845" class="difflineplus">+    // Clean up each conversation: mark as left and remove participant.</span>
<a href="#l14.846"></a><span id="l14.846" class="difflineplus">+    for (let conversation in this._conversations) {</span>
<a href="#l14.847"></a><span id="l14.847" class="difflineplus">+      if (this.isMUCName(conversation)) {</span>
<a href="#l14.848"></a><span id="l14.848" class="difflineplus">+        // Remove the user's nick and mark the conversation as left as that's</span>
<a href="#l14.849"></a><span id="l14.849" class="difflineplus">+        // the final known state of the room.</span>
<a href="#l14.850"></a><span id="l14.850" class="difflineplus">+        this._conversations[conversation].removeParticipant(this._nickname, true);</span>
<a href="#l14.851"></a><span id="l14.851" class="difflineplus">+        this._conversations[conversation].left = true;</span>
<a href="#l14.852"></a><span id="l14.852" class="difflineplus">+      }</span>
<a href="#l14.853"></a><span id="l14.853" class="difflineplus">+    }</span>
<a href="#l14.854"></a><span id="l14.854" class="difflineplus">+</span>
<a href="#l14.855"></a><span id="l14.855" class="difflineplus">+    this.reportDisconnected();</span>
<a href="#l14.856"></a><span id="l14.856" class="difflineplus">+  },</span>
<a href="#l14.857"></a><span id="l14.857" class="difflineplus">+</span>
<a href="#l14.858"></a><span id="l14.858" class="difflineplus">+  unInit: function() {</span>
<a href="#l14.859"></a><span id="l14.859" class="difflineplus">+    delete this.imAccount;</span>
<a href="#l14.860"></a><span id="l14.860" class="difflineplus">+    // Disconnect if we're online while this gets called.</span>
<a href="#l14.861"></a><span id="l14.861" class="difflineplus">+    if (this._socket)</span>
<a href="#l14.862"></a><span id="l14.862" class="difflineplus">+      this._socket.disconnect();</span>
<a href="#l14.863"></a><span id="l14.863" class="difflineplus">+    clearTimeout(this._isOnTimer);</span>
<a href="#l14.864"></a><span id="l14.864" class="difflineplus">+    clearTimeout(this._quitTimer);</span>
<a href="#l14.865"></a><span id="l14.865" class="difflineplus">+  }</span>
<a href="#l14.866"></a><span id="l14.866" class="difflineplus">+};</span>
<a href="#l14.867"></a><span id="l14.867" class="difflineplus">+</span>
<a href="#l14.868"></a><span id="l14.868" class="difflineplus">+function ircProtocol() {</span>
<a href="#l14.869"></a><span id="l14.869" class="difflineplus">+  // ircCommands.jsm exports one variable: commands. Import this directly into</span>
<a href="#l14.870"></a><span id="l14.870" class="difflineplus">+  // the protocol object.</span>
<a href="#l14.871"></a><span id="l14.871" class="difflineplus">+  Cu.import(&quot;resource:///modules/ircCommands.jsm&quot;, this);</span>
<a href="#l14.872"></a><span id="l14.872" class="difflineplus">+  this.registerCommands();</span>
<a href="#l14.873"></a><span id="l14.873" class="difflineplus">+</span>
<a href="#l14.874"></a><span id="l14.874" class="difflineplus">+  // Register the standard handlers</span>
<a href="#l14.875"></a><span id="l14.875" class="difflineplus">+  let tempScope = {};</span>
<a href="#l14.876"></a><span id="l14.876" class="difflineplus">+  Cu.import(&quot;resource:///modules/ircBase.jsm&quot;, tempScope);</span>
<a href="#l14.877"></a><span id="l14.877" class="difflineplus">+  Cu.import(&quot;resource:///modules/ircISUPPORT.jsm&quot;, tempScope);</span>
<a href="#l14.878"></a><span id="l14.878" class="difflineplus">+  Cu.import(&quot;resource:///modules/ircCTCP.jsm&quot;, tempScope);</span>
<a href="#l14.879"></a><span id="l14.879" class="difflineplus">+  Cu.import(&quot;resource:///modules/ircDCC.jsm&quot;, tempScope);</span>
<a href="#l14.880"></a><span id="l14.880" class="difflineplus">+</span>
<a href="#l14.881"></a><span id="l14.881" class="difflineplus">+  // Register default IRC handlers (IRC base, CTCP).</span>
<a href="#l14.882"></a><span id="l14.882" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircBase);</span>
<a href="#l14.883"></a><span id="l14.883" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircISUPPORT);</span>
<a href="#l14.884"></a><span id="l14.884" class="difflineplus">+  ircHandlers.registerHandler(tempScope.ircCTCP);</span>
<a href="#l14.885"></a><span id="l14.885" class="difflineplus">+  // Register default CTCP handlers (CTCP base, DCC).</span>
<a href="#l14.886"></a><span id="l14.886" class="difflineplus">+  ircHandlers.registerCTCPHandler(tempScope.ctcpBase);</span>
<a href="#l14.887"></a><span id="l14.887" class="difflineplus">+  ircHandlers.registerCTCPHandler(tempScope.ctcpDCC);</span>
<a href="#l14.888"></a><span id="l14.888" class="difflineplus">+}</span>
<a href="#l14.889"></a><span id="l14.889" class="difflineplus">+ircProtocol.prototype = {</span>
<a href="#l14.890"></a><span id="l14.890" class="difflineplus">+  __proto__: GenericProtocolPrototype,</span>
<a href="#l14.891"></a><span id="l14.891" class="difflineplus">+  get name() &quot;IRC&quot;,</span>
<a href="#l14.892"></a><span id="l14.892" class="difflineplus">+  get iconBaseURI() &quot;chrome://prpl-irc/skin/&quot;,</span>
<a href="#l14.893"></a><span id="l14.893" class="difflineplus">+  get baseId() &quot;prpl-irc&quot;,</span>
<a href="#l14.894"></a><span id="l14.894" class="difflineplus">+</span>
<a href="#l14.895"></a><span id="l14.895" class="difflineplus">+  usernameSplits: [</span>
<a href="#l14.896"></a><span id="l14.896" class="difflineplus">+    {label: _(&quot;options.server&quot;), separator: &quot;@&quot;,</span>
<a href="#l14.897"></a><span id="l14.897" class="difflineplus">+     defaultValue: &quot;chat.freenode.net&quot;, reverse: true}</span>
<a href="#l14.898"></a><span id="l14.898" class="difflineplus">+  ],</span>
<a href="#l14.899"></a><span id="l14.899" class="difflineplus">+</span>
<a href="#l14.900"></a><span id="l14.900" class="difflineplus">+  options: {</span>
<a href="#l14.901"></a><span id="l14.901" class="difflineplus">+    // Default to IRC over SSL.</span>
<a href="#l14.902"></a><span id="l14.902" class="difflineplus">+    &quot;port&quot;: {label: _(&quot;options.port&quot;), default: 6667},</span>
<a href="#l14.903"></a><span id="l14.903" class="difflineplus">+    &quot;ssl&quot;: {label: _(&quot;options.ssl&quot;), default: false},</span>
<a href="#l14.904"></a><span id="l14.904" class="difflineplus">+    // XXX We should attempt to auto-detect encoding instead.</span>
<a href="#l14.905"></a><span id="l14.905" class="difflineplus">+    &quot;encoding&quot;: {label: _(&quot;options.encoding&quot;), default: &quot;UTF-8&quot;},</span>
<a href="#l14.906"></a><span id="l14.906" class="difflineplus">+    &quot;quitmsg&quot;: {label: _(&quot;options.quitMessage&quot;),</span>
<a href="#l14.907"></a><span id="l14.907" class="difflineplus">+                get default() Services.prefs.getCharPref(&quot;chat.irc.defaultQuitMessage&quot;)},</span>
<a href="#l14.908"></a><span id="l14.908" class="difflineplus">+    &quot;partmsg&quot;: {label: _(&quot;options.partMessage&quot;), default: &quot;&quot;},</span>
<a href="#l14.909"></a><span id="l14.909" class="difflineplus">+    &quot;showServerTab&quot;: {label: _(&quot;options.showServerTab&quot;), default: false}</span>
<a href="#l14.910"></a><span id="l14.910" class="difflineplus">+  },</span>
<a href="#l14.911"></a><span id="l14.911" class="difflineplus">+</span>
<a href="#l14.912"></a><span id="l14.912" class="difflineplus">+  get chatHasTopic() true,</span>
<a href="#l14.913"></a><span id="l14.913" class="difflineplus">+  get slashCommandsNative() true,</span>
<a href="#l14.914"></a><span id="l14.914" class="difflineplus">+  //  Passwords in IRC are optional, and are needed for certain functionality.</span>
<a href="#l14.915"></a><span id="l14.915" class="difflineplus">+  get passwordOptional() true,</span>
<a href="#l14.916"></a><span id="l14.916" class="difflineplus">+</span>
<a href="#l14.917"></a><span id="l14.917" class="difflineplus">+  getAccount: function(aImAccount) new ircAccount(this, aImAccount),</span>
<a href="#l14.918"></a><span id="l14.918" class="difflineplus">+  classID: Components.ID(&quot;{607b2c0b-9504-483f-ad62-41de09238aec}&quot;)</span>
<a href="#l14.919"></a><span id="l14.919" class="difflineplus">+};</span>
<a href="#l14.920"></a><span id="l14.920" class="difflineplus">+</span>
<a href="#l14.921"></a><span id="l14.921" class="difflineplus">+const NSGetFactory = XPCOMUtils.generateNSGetFactory([ircProtocol]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/chat/protocols/irc/irc.manifest</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,3 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+component {607b2c0b-9504-483f-ad62-41de09238aec} irc.js</span>
<a href="#l15.6"></a><span id="l15.6" class="difflineplus">+contract @mozilla.org/chat/irc;1 {607b2c0b-9504-483f-ad62-41de09238aec}</span>
<a href="#l15.7"></a><span id="l15.7" class="difflineplus">+category im-protocol-plugin prpl-irc @mozilla.org/chat/irc;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">new file mode 100644</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineminus">--- /dev/null</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineplus">+++ b/chat/protocols/irc/ircBase.jsm</span>
<a href="#l16.4"></a><span id="l16.4" class="difflineat">@@ -0,0 +1,1203 @@</span>
<a href="#l16.5"></a><span id="l16.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l16.6"></a><span id="l16.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l16.7"></a><span id="l16.7" class="difflineplus">+ *</span>
<a href="#l16.8"></a><span id="l16.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l16.9"></a><span id="l16.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l16.10"></a><span id="l16.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l16.11"></a><span id="l16.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+ *</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+ * License.</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+ *</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineplus">+ *</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineplus">+ *</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineplus">+ *</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l16.37"></a><span id="l16.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l16.38"></a><span id="l16.38" class="difflineplus">+ *</span>
<a href="#l16.39"></a><span id="l16.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineplus">+</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+/*</span>
<a href="#l16.42"></a><span id="l16.42" class="difflineplus">+ * This contains the implementation for the basic Internet Relay Chat (IRC)</span>
<a href="#l16.43"></a><span id="l16.43" class="difflineplus">+ * protocol covered by RFCs 2810, 2811, 2812 and 2813 (which obsoletes RFC</span>
<a href="#l16.44"></a><span id="l16.44" class="difflineplus">+ * 1459). RFC 2812 covers the client commands and protocol.</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineplus">+ *   RFC 2810: Internet Relay Chat: Architecture</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+ *     http://tools.ietf.org/html/rfc2810</span>
<a href="#l16.47"></a><span id="l16.47" class="difflineplus">+ *   RFC 2811: Internet Relay Chat: Channel Management</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineplus">+ *     http://tools.ietf.org/html/rfc2811</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+ *   RFC 2812: Internet Relay Chat: Client Protocol</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+ *     http://tools.ietf.org/html/rfc2812</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+ *   RFC 2813: Internet Relay Chat: Server Protocol</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+ *     http://tools.ietf.org/html/rfc2813</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+ *   RFC 1459: Internet Relay Chat Protocol</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineplus">+ *     http://tools.ietf.org/html/rfc1459</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+ */</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;ircBase&quot;];</span>
<a href="#l16.57"></a><span id="l16.57" class="difflineplus">+</span>
<a href="#l16.58"></a><span id="l16.58" class="difflineplus">+const {interfaces: Ci, utils: Cu} = Components;</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineplus">+</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+Cu.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;DownloadUtils&quot;, function() {</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+  Components.utils.import(&quot;resource://gre/modules/DownloadUtils.jsm&quot;);</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+  return DownloadUtils;</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+});</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+function privmsg(aAccount, aMessage, aIsNotification) {</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+  let params = {incoming: true};</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+  if (aIsNotification)</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+    params.notification = true;</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+  aAccount.getConversation(aAccount.isMUCName(aMessage.params[0]) ?</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+                           aMessage.params[0] : aMessage.nickname)</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+          .writeMessage(aMessage.nickname || aMessage.source,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+                        aMessage.params[1], params);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+  return true;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+}</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+// Display the message and remove them from the rooms they're in.</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+function leftRoom(aAccount, aNicks, aChannels, aSource, aReason, aKicked) {</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+  let msgId = aKicked ? &quot;kicked&quot; : &quot;parted&quot;;</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+  // If a part message was included, include it.</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+  let reason = aReason ? _(&quot;message.&quot; + msgId + &quot;.reason&quot;, aReason) : &quot;&quot;;</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+  function __(aYou, aNick) {</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    // If the user is kicked, we need to say who kicked them.</span>
<a href="#l16.88"></a><span id="l16.88" class="difflineplus">+    if (aKicked)</span>
<a href="#l16.89"></a><span id="l16.89" class="difflineplus">+      return _(&quot;message.&quot; + msgId + aYou, aNick, aSource, reason);</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineplus">+    return _(&quot;message.&quot; + msgId + aYou, aNick, reason);</span>
<a href="#l16.91"></a><span id="l16.91" class="difflineplus">+  }</span>
<a href="#l16.92"></a><span id="l16.92" class="difflineplus">+</span>
<a href="#l16.93"></a><span id="l16.93" class="difflineplus">+  for each (let channelName in aChannels) {</span>
<a href="#l16.94"></a><span id="l16.94" class="difflineplus">+    for each (let nick in aNicks) {</span>
<a href="#l16.95"></a><span id="l16.95" class="difflineplus">+      if (!aAccount.hasConversation(channelName))</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineplus">+        continue; // Handle when we closed the window</span>
<a href="#l16.97"></a><span id="l16.97" class="difflineplus">+      let conversation = aAccount.getConversation(channelName);</span>
<a href="#l16.98"></a><span id="l16.98" class="difflineplus">+</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineplus">+      let msg;</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+      if (aAccount.normalize(nick) == aAccount.normalize(aAccount._nickname)) {</span>
<a href="#l16.101"></a><span id="l16.101" class="difflineplus">+        msg = __(&quot;.you&quot;, reason);</span>
<a href="#l16.102"></a><span id="l16.102" class="difflineplus">+        // If the user left, mark the conversation as no longer being active.</span>
<a href="#l16.103"></a><span id="l16.103" class="difflineplus">+        conversation.left = true;</span>
<a href="#l16.104"></a><span id="l16.104" class="difflineplus">+        conversation.notifyObservers(conversation, &quot;update-conv-chatleft&quot;);</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineplus">+      }</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+      else</span>
<a href="#l16.107"></a><span id="l16.107" class="difflineplus">+        msg = __(&quot;&quot;, nick);</span>
<a href="#l16.108"></a><span id="l16.108" class="difflineplus">+</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineplus">+      conversation.writeMessage(aSource, msg, {system: true});</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineplus">+      conversation.removeParticipant(nick, true);</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineplus">+    }</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineplus">+  }</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineplus">+  return true;</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineplus">+}</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineplus">+</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineplus">+function writeMessage(aAccount, aMessage, aString, aType) {</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineplus">+  let type = {};</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineplus">+  type[aType] = true;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+  aAccount.getConversation(aMessage.source)</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineplus">+          .writeMessage(aMessage.source, aString, type);</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineplus">+  return true;</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineplus">+}</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineplus">+</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineplus">+// If aNoLastParam is true, the last parameter is not printed out.</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+function serverMessage(aAccount, aMsg, aNoLastParam) {</span>
<a href="#l16.126"></a><span id="l16.126" class="difflineplus">+  // If we don't want to show messages from the server, just mark it as handled.</span>
<a href="#l16.127"></a><span id="l16.127" class="difflineplus">+  if (!aAccount._showServerTab)</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineplus">+    return true;</span>
<a href="#l16.129"></a><span id="l16.129" class="difflineplus">+</span>
<a href="#l16.130"></a><span id="l16.130" class="difflineplus">+  return writeMessage(aAccount, aMsg,</span>
<a href="#l16.131"></a><span id="l16.131" class="difflineplus">+                      aMsg.params.slice(1, aNoLastParam ? -1 : undefined).join(&quot; &quot;),</span>
<a href="#l16.132"></a><span id="l16.132" class="difflineplus">+                      &quot;system&quot;);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+}</span>
<a href="#l16.134"></a><span id="l16.134" class="difflineplus">+</span>
<a href="#l16.135"></a><span id="l16.135" class="difflineplus">+function errorMessage(aAccount, aMessage, aError)</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineplus">+  writeMessage(aAccount, aMessage, aError, &quot;error&quot;)</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+function setWhoIs(aAccount, aMessage, aFields) {</span>
<a href="#l16.139"></a><span id="l16.139" class="difflineplus">+  let buddyName = aAccount.normalize(aMessage.params[1], aAccount.userPrefixes);</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineplus">+  // If the buddy isn't in the list yet, add it.</span>
<a href="#l16.141"></a><span id="l16.141" class="difflineplus">+  if (!hasOwnProperty(aAccount.whoisInformation, buddyName))</span>
<a href="#l16.142"></a><span id="l16.142" class="difflineplus">+    aAccount.whoisInformation[buddyName] = {};</span>
<a href="#l16.143"></a><span id="l16.143" class="difflineplus">+</span>
<a href="#l16.144"></a><span id="l16.144" class="difflineplus">+  // Set the WHOIS fields.</span>
<a href="#l16.145"></a><span id="l16.145" class="difflineplus">+  for (let field in aFields)</span>
<a href="#l16.146"></a><span id="l16.146" class="difflineplus">+    aAccount.whoisInformation[buddyName][field] = aFields[field];</span>
<a href="#l16.147"></a><span id="l16.147" class="difflineplus">+</span>
<a href="#l16.148"></a><span id="l16.148" class="difflineplus">+  return true;</span>
<a href="#l16.149"></a><span id="l16.149" class="difflineplus">+}</span>
<a href="#l16.150"></a><span id="l16.150" class="difflineplus">+</span>
<a href="#l16.151"></a><span id="l16.151" class="difflineplus">+// Try a new nick if the previous tried nick is already in use.</span>
<a href="#l16.152"></a><span id="l16.152" class="difflineplus">+function tryNewNick(aAccount, aMessage) {</span>
<a href="#l16.153"></a><span id="l16.153" class="difflineplus">+  // Take the returned nick and increment the last character.</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineplus">+  aAccount._nickname = aMessage.params[1].slice(0, -1) +</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineplus">+    String.fromCharCode(</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineplus">+      aMessage.params[1].charCodeAt(aMessage.params[1].length - 1) + 1</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+    );</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  // Inform the user.</span>
<a href="#l16.159"></a><span id="l16.159" class="difflineplus">+  LOG(aMessage.params[1] + &quot; is already in use, trying &quot; + aAccount._nickname);</span>
<a href="#l16.160"></a><span id="l16.160" class="difflineplus">+</span>
<a href="#l16.161"></a><span id="l16.161" class="difflineplus">+  aAccount.sendMessage(&quot;NICK&quot;, aAccount._nickname); // Nick message.</span>
<a href="#l16.162"></a><span id="l16.162" class="difflineplus">+  return true;</span>
<a href="#l16.163"></a><span id="l16.163" class="difflineplus">+}</span>
<a href="#l16.164"></a><span id="l16.164" class="difflineplus">+</span>
<a href="#l16.165"></a><span id="l16.165" class="difflineplus">+// See RFCs 2811 &amp; 2812 (which obsoletes RFC 1459) for a description of these</span>
<a href="#l16.166"></a><span id="l16.166" class="difflineplus">+// commands.</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineplus">+var ircBase = {</span>
<a href="#l16.168"></a><span id="l16.168" class="difflineplus">+  // Parameters</span>
<a href="#l16.169"></a><span id="l16.169" class="difflineplus">+  name: &quot;RFC 2812&quot;, // Name identifier</span>
<a href="#l16.170"></a><span id="l16.170" class="difflineplus">+  priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l16.171"></a><span id="l16.171" class="difflineplus">+</span>
<a href="#l16.172"></a><span id="l16.172" class="difflineplus">+  // The IRC commands that can be handled.</span>
<a href="#l16.173"></a><span id="l16.173" class="difflineplus">+  commands: {</span>
<a href="#l16.174"></a><span id="l16.174" class="difflineplus">+    &quot;ERROR&quot;: function(aMessage) {</span>
<a href="#l16.175"></a><span id="l16.175" class="difflineplus">+      // ERROR &lt;error message&gt;</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineplus">+      // Client connection has been terminated.</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+      clearTimeout(this._quitTimer);</span>
<a href="#l16.178"></a><span id="l16.178" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.NO_ERROR,</span>
<a href="#l16.179"></a><span id="l16.179" class="difflineplus">+                           aMessage.params[0]); // Notify account manager.</span>
<a href="#l16.180"></a><span id="l16.180" class="difflineplus">+      return true;</span>
<a href="#l16.181"></a><span id="l16.181" class="difflineplus">+    },</span>
<a href="#l16.182"></a><span id="l16.182" class="difflineplus">+    &quot;INVITE&quot;: function(aMessage) {</span>
<a href="#l16.183"></a><span id="l16.183" class="difflineplus">+      // INVITE  &lt;nickname&gt; &lt;channel&gt;</span>
<a href="#l16.184"></a><span id="l16.184" class="difflineplus">+      // XXX prompt user to join channel</span>
<a href="#l16.185"></a><span id="l16.185" class="difflineplus">+      return false;</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineplus">+    },</span>
<a href="#l16.187"></a><span id="l16.187" class="difflineplus">+    &quot;JOIN&quot;: function(aMessage) {</span>
<a href="#l16.188"></a><span id="l16.188" class="difflineplus">+      // JOIN ( &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) [ &lt;key&gt; *( &quot;,&quot; &lt;key&gt; ) ] ) / &quot;0&quot;</span>
<a href="#l16.189"></a><span id="l16.189" class="difflineplus">+      // Add the buddy to each channel</span>
<a href="#l16.190"></a><span id="l16.190" class="difflineplus">+      for each (let channelName in aMessage.params[0].split(&quot;,&quot;)) {</span>
<a href="#l16.191"></a><span id="l16.191" class="difflineplus">+        let conversation = this.getConversation(channelName);</span>
<a href="#l16.192"></a><span id="l16.192" class="difflineplus">+        if (this.normalize(aMessage.nickname, this.userPrefixes) ==</span>
<a href="#l16.193"></a><span id="l16.193" class="difflineplus">+            this.normalize(this._nickname)) {</span>
<a href="#l16.194"></a><span id="l16.194" class="difflineplus">+          // If you join, clear the participants list to avoid errors w/</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineplus">+          // repeated participants.</span>
<a href="#l16.196"></a><span id="l16.196" class="difflineplus">+          conversation.removeAllParticipants();</span>
<a href="#l16.197"></a><span id="l16.197" class="difflineplus">+          conversation.left = false;</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineplus">+          conversation.notifyObservers(conversation, &quot;update-conv-chatleft&quot;);</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineplus">+        }</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+        else {</span>
<a href="#l16.201"></a><span id="l16.201" class="difflineplus">+          // Don't worry about adding ourself, RPL_NAMES takes care of that</span>
<a href="#l16.202"></a><span id="l16.202" class="difflineplus">+          // case.</span>
<a href="#l16.203"></a><span id="l16.203" class="difflineplus">+          conversation.getParticipant(aMessage.nickname, true);</span>
<a href="#l16.204"></a><span id="l16.204" class="difflineplus">+          let msg = _(&quot;message.join&quot;, aMessage.nickname, aMessage.source);</span>
<a href="#l16.205"></a><span id="l16.205" class="difflineplus">+          conversation.writeMessage(aMessage.nickname, msg, {system: true,</span>
<a href="#l16.206"></a><span id="l16.206" class="difflineplus">+                                                             noLinkification: true});</span>
<a href="#l16.207"></a><span id="l16.207" class="difflineplus">+        }</span>
<a href="#l16.208"></a><span id="l16.208" class="difflineplus">+      }</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineplus">+      return true;</span>
<a href="#l16.210"></a><span id="l16.210" class="difflineplus">+    },</span>
<a href="#l16.211"></a><span id="l16.211" class="difflineplus">+    &quot;KICK&quot;: function(aMessage) {</span>
<a href="#l16.212"></a><span id="l16.212" class="difflineplus">+      // KICK &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) &lt;user&gt; *( &quot;,&quot; &lt;user&gt; ) [&lt;comment&gt;]</span>
<a href="#l16.213"></a><span id="l16.213" class="difflineplus">+      return leftRoom(this, aMessage.params[1].split(&quot;,&quot;),</span>
<a href="#l16.214"></a><span id="l16.214" class="difflineplus">+                      aMessage.params[0].split(&quot;,&quot;), aMessage.nickname,</span>
<a href="#l16.215"></a><span id="l16.215" class="difflineplus">+                      aMessage.params.length == 3 ? aMessage.params[2] : null,</span>
<a href="#l16.216"></a><span id="l16.216" class="difflineplus">+                      true);</span>
<a href="#l16.217"></a><span id="l16.217" class="difflineplus">+    },</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineplus">+    &quot;MODE&quot;: function(aMessage) {</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+      // MODE &lt;nickname&gt; *( ( &quot;+&quot; / &quot;-&quot;) *( &quot;i&quot; / &quot;w&quot; / &quot;o&quot; / &quot;O&quot; / &quot;r&quot; ) )</span>
<a href="#l16.220"></a><span id="l16.220" class="difflineplus">+      // If less than 3 parameter is given, the mode is your usermode.</span>
<a href="#l16.221"></a><span id="l16.221" class="difflineplus">+      if (aMessage.params.length &gt;= 3) {</span>
<a href="#l16.222"></a><span id="l16.222" class="difflineplus">+        // Update the mode of the ConvChatBuddy.</span>
<a href="#l16.223"></a><span id="l16.223" class="difflineplus">+        let conversation = this.getConversation(aMessage.params[0]);</span>
<a href="#l16.224"></a><span id="l16.224" class="difflineplus">+        let convChatBuddy = conversation.getParticipant(aMessage.params[2]);</span>
<a href="#l16.225"></a><span id="l16.225" class="difflineplus">+        convChatBuddy.setMode(aMessage.params[1]);</span>
<a href="#l16.226"></a><span id="l16.226" class="difflineplus">+</span>
<a href="#l16.227"></a><span id="l16.227" class="difflineplus">+        // Notify the UI of changes.</span>
<a href="#l16.228"></a><span id="l16.228" class="difflineplus">+        let msg = _(&quot;message.mode&quot;, aMessage.params[1], aMessage.params[2],</span>
<a href="#l16.229"></a><span id="l16.229" class="difflineplus">+                    aMessage.nickname);</span>
<a href="#l16.230"></a><span id="l16.230" class="difflineplus">+        conversation.writeMessage(aMessage.nickname, msg, {system: true});</span>
<a href="#l16.231"></a><span id="l16.231" class="difflineplus">+        conversation.notifyObservers(convChatBuddy, &quot;chat-buddy-update&quot;);</span>
<a href="#l16.232"></a><span id="l16.232" class="difflineplus">+      }</span>
<a href="#l16.233"></a><span id="l16.233" class="difflineplus">+      return true;</span>
<a href="#l16.234"></a><span id="l16.234" class="difflineplus">+    },</span>
<a href="#l16.235"></a><span id="l16.235" class="difflineplus">+    &quot;NICK&quot;: function(aMessage) {</span>
<a href="#l16.236"></a><span id="l16.236" class="difflineplus">+      // NICK &lt;nickname&gt;</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineplus">+      this.changeBuddyNick(aMessage.nickname, aMessage.params[0]);</span>
<a href="#l16.238"></a><span id="l16.238" class="difflineplus">+      return true;</span>
<a href="#l16.239"></a><span id="l16.239" class="difflineplus">+    },</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineplus">+    &quot;NOTICE&quot;: function(aMessage) {</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineplus">+      // NOTICE &lt;msgtarget&gt; &lt;text&gt;</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+      // If the message doesn't have a nickname, it's from the server, don't</span>
<a href="#l16.243"></a><span id="l16.243" class="difflineplus">+      // show it unless the user wants to see it.</span>
<a href="#l16.244"></a><span id="l16.244" class="difflineplus">+      if (!aMessage.hasOwnProperty(&quot;nickname&quot;))</span>
<a href="#l16.245"></a><span id="l16.245" class="difflineplus">+        return serverMessage(this, aMessage);</span>
<a href="#l16.246"></a><span id="l16.246" class="difflineplus">+      return privmsg(this, aMessage, true);</span>
<a href="#l16.247"></a><span id="l16.247" class="difflineplus">+    },</span>
<a href="#l16.248"></a><span id="l16.248" class="difflineplus">+    &quot;PART&quot;: function(aMessage) {</span>
<a href="#l16.249"></a><span id="l16.249" class="difflineplus">+      // PART &lt;channel&gt; *( &quot;,&quot; &lt;channel&gt; ) [ &lt;Part Message&gt; ]</span>
<a href="#l16.250"></a><span id="l16.250" class="difflineplus">+      return leftRoom(this, [aMessage.nickname], aMessage.params[0].split(&quot;,&quot;),</span>
<a href="#l16.251"></a><span id="l16.251" class="difflineplus">+                      aMessage.source,</span>
<a href="#l16.252"></a><span id="l16.252" class="difflineplus">+                      aMessage.params.length == 2 ? aMessage.params[1] : null);</span>
<a href="#l16.253"></a><span id="l16.253" class="difflineplus">+    },</span>
<a href="#l16.254"></a><span id="l16.254" class="difflineplus">+    &quot;PING&quot;: function(aMessage) {</span>
<a href="#l16.255"></a><span id="l16.255" class="difflineplus">+      // PING &lt;server1 [ &lt;server2&gt; ]</span>
<a href="#l16.256"></a><span id="l16.256" class="difflineplus">+      // Keep the connection alive</span>
<a href="#l16.257"></a><span id="l16.257" class="difflineplus">+      this.sendMessage(&quot;PONG&quot;, aMessage.params[0]);</span>
<a href="#l16.258"></a><span id="l16.258" class="difflineplus">+      return true;</span>
<a href="#l16.259"></a><span id="l16.259" class="difflineplus">+    },</span>
<a href="#l16.260"></a><span id="l16.260" class="difflineplus">+    &quot;PRIVMSG&quot;: function(aMessage) {</span>
<a href="#l16.261"></a><span id="l16.261" class="difflineplus">+      // PRIVMSG &lt;msgtarget&gt; &lt;text to be sent&gt;</span>
<a href="#l16.262"></a><span id="l16.262" class="difflineplus">+      // Display message in conversation</span>
<a href="#l16.263"></a><span id="l16.263" class="difflineplus">+      return privmsg(this, aMessage);</span>
<a href="#l16.264"></a><span id="l16.264" class="difflineplus">+    },</span>
<a href="#l16.265"></a><span id="l16.265" class="difflineplus">+    &quot;QUIT&quot;: function(aMessage) {</span>
<a href="#l16.266"></a><span id="l16.266" class="difflineplus">+      // QUIT [ &lt; Quit Message&gt; ]</span>
<a href="#l16.267"></a><span id="l16.267" class="difflineplus">+      // If a quit message was included, show it.</span>
<a href="#l16.268"></a><span id="l16.268" class="difflineplus">+      let msg = _(&quot;message.quit&quot;, aMessage.nickname,</span>
<a href="#l16.269"></a><span id="l16.269" class="difflineplus">+                  aMessage.params.length ?</span>
<a href="#l16.270"></a><span id="l16.270" class="difflineplus">+                    _(&quot;message.quit2&quot;, aMessage.params[0]) : &quot;&quot;);</span>
<a href="#l16.271"></a><span id="l16.271" class="difflineplus">+      // Loop over every conversation with the user and display that they quit.</span>
<a href="#l16.272"></a><span id="l16.272" class="difflineplus">+      for each (let conversation in this._conversations) {</span>
<a href="#l16.273"></a><span id="l16.273" class="difflineplus">+        if (conversation.isChat &amp;&amp;</span>
<a href="#l16.274"></a><span id="l16.274" class="difflineplus">+            conversation.hasParticipant(aMessage.nickname)) {</span>
<a href="#l16.275"></a><span id="l16.275" class="difflineplus">+          conversation.writeMessage(aMessage.source, msg, {system: true});</span>
<a href="#l16.276"></a><span id="l16.276" class="difflineplus">+          conversation.removeParticipant(aMessage.nickname, true);</span>
<a href="#l16.277"></a><span id="l16.277" class="difflineplus">+        }</span>
<a href="#l16.278"></a><span id="l16.278" class="difflineplus">+      }</span>
<a href="#l16.279"></a><span id="l16.279" class="difflineplus">+      return true;</span>
<a href="#l16.280"></a><span id="l16.280" class="difflineplus">+    },</span>
<a href="#l16.281"></a><span id="l16.281" class="difflineplus">+    &quot;SQUIT&quot;: function(aMessage) {</span>
<a href="#l16.282"></a><span id="l16.282" class="difflineplus">+      // XXX do we need this?</span>
<a href="#l16.283"></a><span id="l16.283" class="difflineplus">+      return false;</span>
<a href="#l16.284"></a><span id="l16.284" class="difflineplus">+    },</span>
<a href="#l16.285"></a><span id="l16.285" class="difflineplus">+    &quot;TOPIC&quot;: function(aMessage) {</span>
<a href="#l16.286"></a><span id="l16.286" class="difflineplus">+      // TOPIC &lt;channel&gt; [ &lt;topic&gt; ]</span>
<a href="#l16.287"></a><span id="l16.287" class="difflineplus">+      // Show topic as a message.</span>
<a href="#l16.288"></a><span id="l16.288" class="difflineplus">+      let source = aMessage.nickname || aMessage.source;</span>
<a href="#l16.289"></a><span id="l16.289" class="difflineplus">+      let conversation = this.getConversation(aMessage.params[0]);</span>
<a href="#l16.290"></a><span id="l16.290" class="difflineplus">+      let topic = aMessage.params[1];</span>
<a href="#l16.291"></a><span id="l16.291" class="difflineplus">+      let message;</span>
<a href="#l16.292"></a><span id="l16.292" class="difflineplus">+      if (topic)</span>
<a href="#l16.293"></a><span id="l16.293" class="difflineplus">+        message = _(&quot;message.topicChanged&quot;, source, topic);</span>
<a href="#l16.294"></a><span id="l16.294" class="difflineplus">+      else</span>
<a href="#l16.295"></a><span id="l16.295" class="difflineplus">+        message = _(&quot;message.topicCleared&quot;, source);</span>
<a href="#l16.296"></a><span id="l16.296" class="difflineplus">+      conversation.writeMessage(source, message, {system: true});</span>
<a href="#l16.297"></a><span id="l16.297" class="difflineplus">+      // Set the topic in the conversation and update the UI.</span>
<a href="#l16.298"></a><span id="l16.298" class="difflineplus">+      conversation.setTopic(topic ? ctcpFormatToText(topic) : &quot;&quot;, source);</span>
<a href="#l16.299"></a><span id="l16.299" class="difflineplus">+      return true;</span>
<a href="#l16.300"></a><span id="l16.300" class="difflineplus">+    },</span>
<a href="#l16.301"></a><span id="l16.301" class="difflineplus">+    &quot;001&quot;: function(aMessage) { // RPL_WELCOME</span>
<a href="#l16.302"></a><span id="l16.302" class="difflineplus">+      // Welcome to the Internet Relay Network &lt;nick&gt;!&lt;user&gt;@&lt;host&gt;</span>
<a href="#l16.303"></a><span id="l16.303" class="difflineplus">+      this.reportConnected();</span>
<a href="#l16.304"></a><span id="l16.304" class="difflineplus">+      // Check if any of our buddies are online!</span>
<a href="#l16.305"></a><span id="l16.305" class="difflineplus">+      this.sendIsOn();</span>
<a href="#l16.306"></a><span id="l16.306" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.307"></a><span id="l16.307" class="difflineplus">+    },</span>
<a href="#l16.308"></a><span id="l16.308" class="difflineplus">+    &quot;002&quot;: function(aMessage) { // RPL_YOURHOST</span>
<a href="#l16.309"></a><span id="l16.309" class="difflineplus">+      // Your host is &lt;servername&gt;, running version &lt;ver&gt;</span>
<a href="#l16.310"></a><span id="l16.310" class="difflineplus">+      // XXX Use the host instead of the user for all the &quot;server&quot; messages?</span>
<a href="#l16.311"></a><span id="l16.311" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.312"></a><span id="l16.312" class="difflineplus">+    },</span>
<a href="#l16.313"></a><span id="l16.313" class="difflineplus">+    &quot;003&quot;: function(aMessage) { // RPL_CREATED</span>
<a href="#l16.314"></a><span id="l16.314" class="difflineplus">+      //This server was created &lt;date&gt;</span>
<a href="#l16.315"></a><span id="l16.315" class="difflineplus">+      // XXX parse this date and keep it for some reason? Do we care?</span>
<a href="#l16.316"></a><span id="l16.316" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.317"></a><span id="l16.317" class="difflineplus">+    },</span>
<a href="#l16.318"></a><span id="l16.318" class="difflineplus">+    &quot;004&quot;: function(aMessage) { // RPL_MYINFO</span>
<a href="#l16.319"></a><span id="l16.319" class="difflineplus">+      // &lt;servername&gt; &lt;version&gt; &lt;available user modes&gt; &lt;available channel modes&gt;</span>
<a href="#l16.320"></a><span id="l16.320" class="difflineplus">+      // XXX parse the available modes, let the UI respond and inform the user</span>
<a href="#l16.321"></a><span id="l16.321" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.322"></a><span id="l16.322" class="difflineplus">+    },</span>
<a href="#l16.323"></a><span id="l16.323" class="difflineplus">+    &quot;005&quot;: function(aMessage) { // RPL_BOUNCE</span>
<a href="#l16.324"></a><span id="l16.324" class="difflineplus">+      // Try server &lt;server name&gt;, port &lt;port number&gt;</span>
<a href="#l16.325"></a><span id="l16.325" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.326"></a><span id="l16.326" class="difflineplus">+    },</span>
<a href="#l16.327"></a><span id="l16.327" class="difflineplus">+</span>
<a href="#l16.328"></a><span id="l16.328" class="difflineplus">+    /*</span>
<a href="#l16.329"></a><span id="l16.329" class="difflineplus">+     * Handle response to TRACE message</span>
<a href="#l16.330"></a><span id="l16.330" class="difflineplus">+     */</span>
<a href="#l16.331"></a><span id="l16.331" class="difflineplus">+    &quot;200&quot;: function(aMessage) { // RPL_TRACELINK</span>
<a href="#l16.332"></a><span id="l16.332" class="difflineplus">+      // Link &lt;version &amp; debug level&gt; &lt;destination&gt; &lt;next server&gt;</span>
<a href="#l16.333"></a><span id="l16.333" class="difflineplus">+      // V&lt;protocol version&gt; &lt;link updateime in seconds&gt; &lt;backstream sendq&gt;</span>
<a href="#l16.334"></a><span id="l16.334" class="difflineplus">+      // &lt;upstream sendq&gt;</span>
<a href="#l16.335"></a><span id="l16.335" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.336"></a><span id="l16.336" class="difflineplus">+    },</span>
<a href="#l16.337"></a><span id="l16.337" class="difflineplus">+    &quot;201&quot;: function(aMessage) { // RPL_TRACECONNECTING</span>
<a href="#l16.338"></a><span id="l16.338" class="difflineplus">+      // Try. &lt;class&gt; &lt;server&gt;</span>
<a href="#l16.339"></a><span id="l16.339" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.340"></a><span id="l16.340" class="difflineplus">+    },</span>
<a href="#l16.341"></a><span id="l16.341" class="difflineplus">+    &quot;202&quot;: function(aMessage) { // RPL_TRACEHANDSHAKE</span>
<a href="#l16.342"></a><span id="l16.342" class="difflineplus">+      // H.S. &lt;class&gt; &lt;server&gt;</span>
<a href="#l16.343"></a><span id="l16.343" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.344"></a><span id="l16.344" class="difflineplus">+    },</span>
<a href="#l16.345"></a><span id="l16.345" class="difflineplus">+    &quot;203&quot;: function(aMessage) { // RPL_TRACEUNKNOWN</span>
<a href="#l16.346"></a><span id="l16.346" class="difflineplus">+      // ???? &lt;class&gt; [&lt;client IP address in dot form&gt;]</span>
<a href="#l16.347"></a><span id="l16.347" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.348"></a><span id="l16.348" class="difflineplus">+    },</span>
<a href="#l16.349"></a><span id="l16.349" class="difflineplus">+    &quot;204&quot;: function(aMessage) { // RPL_TRACEOPERATOR</span>
<a href="#l16.350"></a><span id="l16.350" class="difflineplus">+      // Oper &lt;class&gt; &lt;nick&gt;</span>
<a href="#l16.351"></a><span id="l16.351" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.352"></a><span id="l16.352" class="difflineplus">+    },</span>
<a href="#l16.353"></a><span id="l16.353" class="difflineplus">+    &quot;205&quot;: function(aMessage) { // RPL_TRACEUSER</span>
<a href="#l16.354"></a><span id="l16.354" class="difflineplus">+      // User &lt;class&gt; &lt;nick&gt;</span>
<a href="#l16.355"></a><span id="l16.355" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.356"></a><span id="l16.356" class="difflineplus">+    },</span>
<a href="#l16.357"></a><span id="l16.357" class="difflineplus">+    &quot;206&quot;: function(aMessage) { // RPL_TRACESERVER</span>
<a href="#l16.358"></a><span id="l16.358" class="difflineplus">+      // Serv &lt;class&gt; &lt;int&gt;S &lt;int&gt;C &lt;server&gt; &lt;nick!user|*!*&gt;@&lt;host|server&gt;</span>
<a href="#l16.359"></a><span id="l16.359" class="difflineplus">+      // V&lt;protocol version&gt;</span>
<a href="#l16.360"></a><span id="l16.360" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.361"></a><span id="l16.361" class="difflineplus">+    },</span>
<a href="#l16.362"></a><span id="l16.362" class="difflineplus">+    &quot;207&quot;: function(aMessage) { // RPL_TRACESERVICE</span>
<a href="#l16.363"></a><span id="l16.363" class="difflineplus">+      // Service &lt;class&gt; &lt;name&gt; &lt;type&gt; &lt;active type&gt;</span>
<a href="#l16.364"></a><span id="l16.364" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.365"></a><span id="l16.365" class="difflineplus">+    },</span>
<a href="#l16.366"></a><span id="l16.366" class="difflineplus">+    &quot;208&quot;: function(aMessage) { // RPL_TRACENEWTYPE</span>
<a href="#l16.367"></a><span id="l16.367" class="difflineplus">+      // &lt;newtype&gt; 0 &lt;client name&gt;</span>
<a href="#l16.368"></a><span id="l16.368" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.369"></a><span id="l16.369" class="difflineplus">+    },</span>
<a href="#l16.370"></a><span id="l16.370" class="difflineplus">+    &quot;209&quot;: function(aMessage) { // RPL_TRACECLASS</span>
<a href="#l16.371"></a><span id="l16.371" class="difflineplus">+      // Class &lt;class&gt; &lt;count&gt;</span>
<a href="#l16.372"></a><span id="l16.372" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.373"></a><span id="l16.373" class="difflineplus">+    },</span>
<a href="#l16.374"></a><span id="l16.374" class="difflineplus">+    &quot;210&quot;: function(aMessage) { // RPL_TRACERECONNECTION</span>
<a href="#l16.375"></a><span id="l16.375" class="difflineplus">+      // Unused.</span>
<a href="#l16.376"></a><span id="l16.376" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.377"></a><span id="l16.377" class="difflineplus">+    },</span>
<a href="#l16.378"></a><span id="l16.378" class="difflineplus">+</span>
<a href="#l16.379"></a><span id="l16.379" class="difflineplus">+    /*</span>
<a href="#l16.380"></a><span id="l16.380" class="difflineplus">+     * Handle stats messages.</span>
<a href="#l16.381"></a><span id="l16.381" class="difflineplus">+     **/</span>
<a href="#l16.382"></a><span id="l16.382" class="difflineplus">+    &quot;211&quot;: function(aMessage) { // RPL_STATSLINKINFO</span>
<a href="#l16.383"></a><span id="l16.383" class="difflineplus">+      // &lt;linkname&gt; &lt;sendq&gt; &lt;sent messages&gt; &lt;sent Kbytes&gt; &lt;received messages&gt;</span>
<a href="#l16.384"></a><span id="l16.384" class="difflineplus">+      // &lt;received Kbytes&gt; &lt;time open&gt;</span>
<a href="#l16.385"></a><span id="l16.385" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.386"></a><span id="l16.386" class="difflineplus">+    },</span>
<a href="#l16.387"></a><span id="l16.387" class="difflineplus">+    &quot;212&quot;: function(aMessage) { // RPL_STATSCOMMAND</span>
<a href="#l16.388"></a><span id="l16.388" class="difflineplus">+      // &lt;command&gt; &lt;count&gt; &lt;byte count&gt; &lt;remote count&gt;</span>
<a href="#l16.389"></a><span id="l16.389" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.390"></a><span id="l16.390" class="difflineplus">+    },</span>
<a href="#l16.391"></a><span id="l16.391" class="difflineplus">+    &quot;213&quot;: function(aMessage) { // RPL_STATSCLINE</span>
<a href="#l16.392"></a><span id="l16.392" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.393"></a><span id="l16.393" class="difflineplus">+    },</span>
<a href="#l16.394"></a><span id="l16.394" class="difflineplus">+    &quot;214&quot;: function(aMessage) { // RPL_STATSNLINE</span>
<a href="#l16.395"></a><span id="l16.395" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.396"></a><span id="l16.396" class="difflineplus">+    },</span>
<a href="#l16.397"></a><span id="l16.397" class="difflineplus">+    &quot;215&quot;: function(aMessage) { // RPL_STATSILINE</span>
<a href="#l16.398"></a><span id="l16.398" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.399"></a><span id="l16.399" class="difflineplus">+    },</span>
<a href="#l16.400"></a><span id="l16.400" class="difflineplus">+    &quot;216&quot;: function(aMessage) { // RPL_STATSKLINE</span>
<a href="#l16.401"></a><span id="l16.401" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.402"></a><span id="l16.402" class="difflineplus">+    },</span>
<a href="#l16.403"></a><span id="l16.403" class="difflineplus">+    &quot;217&quot;: function(aMessage) { // RPL_STATSQLINE</span>
<a href="#l16.404"></a><span id="l16.404" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.405"></a><span id="l16.405" class="difflineplus">+    },</span>
<a href="#l16.406"></a><span id="l16.406" class="difflineplus">+    &quot;218&quot;: function(aMessage) { // RPL_STATSYLINE</span>
<a href="#l16.407"></a><span id="l16.407" class="difflineplus">+      // Non-generic</span>
<a href="#l16.408"></a><span id="l16.408" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.409"></a><span id="l16.409" class="difflineplus">+    },</span>
<a href="#l16.410"></a><span id="l16.410" class="difflineplus">+    &quot;219&quot;: function(aMessage) { // RPL_ENDOFSTATS</span>
<a href="#l16.411"></a><span id="l16.411" class="difflineplus">+      // &lt;stats letter&gt; :End of STATS report</span>
<a href="#l16.412"></a><span id="l16.412" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.413"></a><span id="l16.413" class="difflineplus">+    },</span>
<a href="#l16.414"></a><span id="l16.414" class="difflineplus">+</span>
<a href="#l16.415"></a><span id="l16.415" class="difflineplus">+    &quot;221&quot;: function(aMessage) { // RPL_UMODEIS</span>
<a href="#l16.416"></a><span id="l16.416" class="difflineplus">+      // &lt;user mode string&gt;</span>
<a href="#l16.417"></a><span id="l16.417" class="difflineplus">+      // XXX update the UI accordingly</span>
<a href="#l16.418"></a><span id="l16.418" class="difflineplus">+      return false;</span>
<a href="#l16.419"></a><span id="l16.419" class="difflineplus">+    },</span>
<a href="#l16.420"></a><span id="l16.420" class="difflineplus">+</span>
<a href="#l16.421"></a><span id="l16.421" class="difflineplus">+    /*</span>
<a href="#l16.422"></a><span id="l16.422" class="difflineplus">+     * Services</span>
<a href="#l16.423"></a><span id="l16.423" class="difflineplus">+     */</span>
<a href="#l16.424"></a><span id="l16.424" class="difflineplus">+    &quot;231&quot;: function(aMessage) { // RPL_SERVICEINFO</span>
<a href="#l16.425"></a><span id="l16.425" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.426"></a><span id="l16.426" class="difflineplus">+    },</span>
<a href="#l16.427"></a><span id="l16.427" class="difflineplus">+    &quot;232&quot;: function(aMessage) { // RPL_ENDOFSERVICES</span>
<a href="#l16.428"></a><span id="l16.428" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.429"></a><span id="l16.429" class="difflineplus">+    },</span>
<a href="#l16.430"></a><span id="l16.430" class="difflineplus">+    &quot;233&quot;: function(aMessage) { // RPL_SERVICE</span>
<a href="#l16.431"></a><span id="l16.431" class="difflineplus">+      // Non-generic</span>
<a href="#l16.432"></a><span id="l16.432" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.433"></a><span id="l16.433" class="difflineplus">+    },</span>
<a href="#l16.434"></a><span id="l16.434" class="difflineplus">+</span>
<a href="#l16.435"></a><span id="l16.435" class="difflineplus">+    /*</span>
<a href="#l16.436"></a><span id="l16.436" class="difflineplus">+     * Server</span>
<a href="#l16.437"></a><span id="l16.437" class="difflineplus">+     */</span>
<a href="#l16.438"></a><span id="l16.438" class="difflineplus">+    &quot;234&quot;: function(aMessage) { // RPL_SERVLIST</span>
<a href="#l16.439"></a><span id="l16.439" class="difflineplus">+      // &lt;name&gt; &lt;server&gt; &lt;mask&gt; &lt;type&gt; &lt;hopcount&gt; &lt;info&gt;</span>
<a href="#l16.440"></a><span id="l16.440" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.441"></a><span id="l16.441" class="difflineplus">+    },</span>
<a href="#l16.442"></a><span id="l16.442" class="difflineplus">+    &quot;235&quot;: function(aMessage) { // RPL_SERVLISTEND</span>
<a href="#l16.443"></a><span id="l16.443" class="difflineplus">+      // &lt;mask&gt; &lt;type&gt; :End of service listing</span>
<a href="#l16.444"></a><span id="l16.444" class="difflineplus">+      return serverMessage(this, aMessage, true);</span>
<a href="#l16.445"></a><span id="l16.445" class="difflineplus">+    },</span>
<a href="#l16.446"></a><span id="l16.446" class="difflineplus">+</span>
<a href="#l16.447"></a><span id="l16.447" class="difflineplus">+    /*</span>
<a href="#l16.448"></a><span id="l16.448" class="difflineplus">+     * Stats</span>
<a href="#l16.449"></a><span id="l16.449" class="difflineplus">+     * XXX some of these have real information?</span>
<a href="#l16.450"></a><span id="l16.450" class="difflineplus">+     */</span>
<a href="#l16.451"></a><span id="l16.451" class="difflineplus">+    &quot;240&quot;: function(aMessage) { // RPL_STATSVLINE</span>
<a href="#l16.452"></a><span id="l16.452" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.453"></a><span id="l16.453" class="difflineplus">+    },</span>
<a href="#l16.454"></a><span id="l16.454" class="difflineplus">+    &quot;241&quot;: function(aMessage) { // RPL_STATSLLINE</span>
<a href="#l16.455"></a><span id="l16.455" class="difflineplus">+      // Non-generic</span>
<a href="#l16.456"></a><span id="l16.456" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.457"></a><span id="l16.457" class="difflineplus">+    },</span>
<a href="#l16.458"></a><span id="l16.458" class="difflineplus">+    &quot;242&quot;: function(aMessage) { // RPL_STATSUPTIME</span>
<a href="#l16.459"></a><span id="l16.459" class="difflineplus">+      // :Server Up %d days %d:%02d:%02d</span>
<a href="#l16.460"></a><span id="l16.460" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.461"></a><span id="l16.461" class="difflineplus">+    },</span>
<a href="#l16.462"></a><span id="l16.462" class="difflineplus">+    &quot;243&quot;: function(aMessage) { // RPL_STATSOLINE</span>
<a href="#l16.463"></a><span id="l16.463" class="difflineplus">+      // O &lt;hostmask&gt; * &lt;name&gt;</span>
<a href="#l16.464"></a><span id="l16.464" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.465"></a><span id="l16.465" class="difflineplus">+    },</span>
<a href="#l16.466"></a><span id="l16.466" class="difflineplus">+    &quot;244&quot;: function(aMessage) { // RPL_STATSHLINE</span>
<a href="#l16.467"></a><span id="l16.467" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.468"></a><span id="l16.468" class="difflineplus">+    },</span>
<a href="#l16.469"></a><span id="l16.469" class="difflineplus">+    &quot;245&quot;: function(aMessage) { // RPL_STATSSLINE</span>
<a href="#l16.470"></a><span id="l16.470" class="difflineplus">+      // Non-generic</span>
<a href="#l16.471"></a><span id="l16.471" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.472"></a><span id="l16.472" class="difflineplus">+    },</span>
<a href="#l16.473"></a><span id="l16.473" class="difflineplus">+    &quot;246&quot;: function(aMessage) { // RPL_STATSPING</span>
<a href="#l16.474"></a><span id="l16.474" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.475"></a><span id="l16.475" class="difflineplus">+    },</span>
<a href="#l16.476"></a><span id="l16.476" class="difflineplus">+    &quot;247&quot;: function(aMessage) { // RPL_STATSBLINE</span>
<a href="#l16.477"></a><span id="l16.477" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.478"></a><span id="l16.478" class="difflineplus">+    },</span>
<a href="#l16.479"></a><span id="l16.479" class="difflineplus">+    &quot;250&quot;: function(aMessage) { // RPL_STATSDLINE</span>
<a href="#l16.480"></a><span id="l16.480" class="difflineplus">+      // Non-generic</span>
<a href="#l16.481"></a><span id="l16.481" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.482"></a><span id="l16.482" class="difflineplus">+    },</span>
<a href="#l16.483"></a><span id="l16.483" class="difflineplus">+</span>
<a href="#l16.484"></a><span id="l16.484" class="difflineplus">+    /*</span>
<a href="#l16.485"></a><span id="l16.485" class="difflineplus">+     * LUSER messages</span>
<a href="#l16.486"></a><span id="l16.486" class="difflineplus">+     */</span>
<a href="#l16.487"></a><span id="l16.487" class="difflineplus">+    &quot;251&quot;: function(aMessage) { // RPL_LUSERCLIENT</span>
<a href="#l16.488"></a><span id="l16.488" class="difflineplus">+      // :There are &lt;integer&gt; users and &lt;integer&gt; services on &lt;integer&gt; servers</span>
<a href="#l16.489"></a><span id="l16.489" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.490"></a><span id="l16.490" class="difflineplus">+    },</span>
<a href="#l16.491"></a><span id="l16.491" class="difflineplus">+    &quot;252&quot;: function(aMessage) { // RPL_LUSEROP, 0 if not sent</span>
<a href="#l16.492"></a><span id="l16.492" class="difflineplus">+      // &lt;integer&gt; :operator(s) online</span>
<a href="#l16.493"></a><span id="l16.493" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.494"></a><span id="l16.494" class="difflineplus">+    },</span>
<a href="#l16.495"></a><span id="l16.495" class="difflineplus">+    &quot;253&quot;: function(aMessage) { // RPL_LUSERUNKNOWN, 0 if not sent</span>
<a href="#l16.496"></a><span id="l16.496" class="difflineplus">+      // &lt;integer&gt; :unknown connection(s)</span>
<a href="#l16.497"></a><span id="l16.497" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.498"></a><span id="l16.498" class="difflineplus">+    },</span>
<a href="#l16.499"></a><span id="l16.499" class="difflineplus">+    &quot;254&quot;: function(aMessage) { // RPL_LUSERCHANNELS, 0 if not sent</span>
<a href="#l16.500"></a><span id="l16.500" class="difflineplus">+      // &lt;integer&gt; :channels formed</span>
<a href="#l16.501"></a><span id="l16.501" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.502"></a><span id="l16.502" class="difflineplus">+    },</span>
<a href="#l16.503"></a><span id="l16.503" class="difflineplus">+    &quot;255&quot;: function(aMessage) { // RPL_LUSERME</span>
<a href="#l16.504"></a><span id="l16.504" class="difflineplus">+      // :I have &lt;integer&gt; clients and &lt;integer&gt; servers</span>
<a href="#l16.505"></a><span id="l16.505" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.506"></a><span id="l16.506" class="difflineplus">+    },</span>
<a href="#l16.507"></a><span id="l16.507" class="difflineplus">+</span>
<a href="#l16.508"></a><span id="l16.508" class="difflineplus">+    /*</span>
<a href="#l16.509"></a><span id="l16.509" class="difflineplus">+     * ADMIN messages</span>
<a href="#l16.510"></a><span id="l16.510" class="difflineplus">+     */</span>
<a href="#l16.511"></a><span id="l16.511" class="difflineplus">+    &quot;256&quot;: function(aMessage) { // RPL_ADMINME</span>
<a href="#l16.512"></a><span id="l16.512" class="difflineplus">+      // &lt;server&gt; :Administrative info</span>
<a href="#l16.513"></a><span id="l16.513" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.514"></a><span id="l16.514" class="difflineplus">+    },</span>
<a href="#l16.515"></a><span id="l16.515" class="difflineplus">+    &quot;257&quot;: function(aMessage) { // RPL_ADMINLOC1</span>
<a href="#l16.516"></a><span id="l16.516" class="difflineplus">+      // :&lt;admin info&gt;</span>
<a href="#l16.517"></a><span id="l16.517" class="difflineplus">+      // City, state &amp; country</span>
<a href="#l16.518"></a><span id="l16.518" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.519"></a><span id="l16.519" class="difflineplus">+    },</span>
<a href="#l16.520"></a><span id="l16.520" class="difflineplus">+    &quot;258&quot;: function(aMessage) { // RPL_ADMINLOC2</span>
<a href="#l16.521"></a><span id="l16.521" class="difflineplus">+      // :&lt;admin info&gt;</span>
<a href="#l16.522"></a><span id="l16.522" class="difflineplus">+      // Institution details</span>
<a href="#l16.523"></a><span id="l16.523" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.524"></a><span id="l16.524" class="difflineplus">+    },</span>
<a href="#l16.525"></a><span id="l16.525" class="difflineplus">+    &quot;259&quot;: function(aMessage) { // RPL_ADMINEMAIL</span>
<a href="#l16.526"></a><span id="l16.526" class="difflineplus">+      // :&lt;admin info&gt;</span>
<a href="#l16.527"></a><span id="l16.527" class="difflineplus">+      // XXX parse this for a contact email?</span>
<a href="#l16.528"></a><span id="l16.528" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.529"></a><span id="l16.529" class="difflineplus">+    },</span>
<a href="#l16.530"></a><span id="l16.530" class="difflineplus">+</span>
<a href="#l16.531"></a><span id="l16.531" class="difflineplus">+    /*</span>
<a href="#l16.532"></a><span id="l16.532" class="difflineplus">+     * TRACELOG</span>
<a href="#l16.533"></a><span id="l16.533" class="difflineplus">+     */</span>
<a href="#l16.534"></a><span id="l16.534" class="difflineplus">+    &quot;261&quot;: function(aMessage) { // RPL_TRACELOG</span>
<a href="#l16.535"></a><span id="l16.535" class="difflineplus">+      // File &lt;logfile&gt; &lt;debug level&gt;</span>
<a href="#l16.536"></a><span id="l16.536" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.537"></a><span id="l16.537" class="difflineplus">+    },</span>
<a href="#l16.538"></a><span id="l16.538" class="difflineplus">+    &quot;262&quot;: function(aMessage) { // RPL_TRACEEND</span>
<a href="#l16.539"></a><span id="l16.539" class="difflineplus">+      // &lt;server name&gt; &lt;version &amp; debug level&gt; :End of TRACE</span>
<a href="#l16.540"></a><span id="l16.540" class="difflineplus">+      return serverMessage(this, aMessage, true);</span>
<a href="#l16.541"></a><span id="l16.541" class="difflineplus">+    },</span>
<a href="#l16.542"></a><span id="l16.542" class="difflineplus">+</span>
<a href="#l16.543"></a><span id="l16.543" class="difflineplus">+    /*</span>
<a href="#l16.544"></a><span id="l16.544" class="difflineplus">+     * Try again.</span>
<a href="#l16.545"></a><span id="l16.545" class="difflineplus">+     */</span>
<a href="#l16.546"></a><span id="l16.546" class="difflineplus">+    &quot;263&quot;: function(aMessage) { // RPL_TRYAGAIN</span>
<a href="#l16.547"></a><span id="l16.547" class="difflineplus">+      // &lt;command&gt; :Please wait a while and try again.</span>
<a href="#l16.548"></a><span id="l16.548" class="difflineplus">+      // XXX setTimeout for a minute or so and try again?</span>
<a href="#l16.549"></a><span id="l16.549" class="difflineplus">+      return false;</span>
<a href="#l16.550"></a><span id="l16.550" class="difflineplus">+    },</span>
<a href="#l16.551"></a><span id="l16.551" class="difflineplus">+</span>
<a href="#l16.552"></a><span id="l16.552" class="difflineplus">+    &quot;265&quot;: function(aMessage) { // XXX nonstandard</span>
<a href="#l16.553"></a><span id="l16.553" class="difflineplus">+      // :Current Local Users: &lt;integer&gt;  Max: &lt;integer&gt;</span>
<a href="#l16.554"></a><span id="l16.554" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.555"></a><span id="l16.555" class="difflineplus">+    },</span>
<a href="#l16.556"></a><span id="l16.556" class="difflineplus">+    &quot;266&quot;: function(aMessage) { // XXX nonstandard</span>
<a href="#l16.557"></a><span id="l16.557" class="difflineplus">+      // :Current Global Users: &lt;integer&gt;  Max: &lt;integer&gt;</span>
<a href="#l16.558"></a><span id="l16.558" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.559"></a><span id="l16.559" class="difflineplus">+    },</span>
<a href="#l16.560"></a><span id="l16.560" class="difflineplus">+    &quot;300&quot;: function(aMessage) { // RPL_NONE</span>
<a href="#l16.561"></a><span id="l16.561" class="difflineplus">+      // XXX This is also something else, see below</span>
<a href="#l16.562"></a><span id="l16.562" class="difflineplus">+      // Non-generic</span>
<a href="#l16.563"></a><span id="l16.563" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.564"></a><span id="l16.564" class="difflineplus">+    },</span>
<a href="#l16.565"></a><span id="l16.565" class="difflineplus">+</span>
<a href="#l16.566"></a><span id="l16.566" class="difflineplus">+    /*</span>
<a href="#l16.567"></a><span id="l16.567" class="difflineplus">+     * Status messages</span>
<a href="#l16.568"></a><span id="l16.568" class="difflineplus">+     */</span>
<a href="#l16.569"></a><span id="l16.569" class="difflineplus">+    &quot;301&quot;: function(aMessage) { // RPL_AWAY</span>
<a href="#l16.570"></a><span id="l16.570" class="difflineplus">+      // &lt;nick&gt; :&lt;away message&gt;</span>
<a href="#l16.571"></a><span id="l16.571" class="difflineplus">+      // XXX set user as away on buddy list / conversation lists</span>
<a href="#l16.572"></a><span id="l16.572" class="difflineplus">+      // XXX Display an autoResponse if this is after sending a private message</span>
<a href="#l16.573"></a><span id="l16.573" class="difflineplus">+      return setWhoIs(this, aMessage, {away: aMessage.params[2]});</span>
<a href="#l16.574"></a><span id="l16.574" class="difflineplus">+    },</span>
<a href="#l16.575"></a><span id="l16.575" class="difflineplus">+    &quot;302&quot;: function(aMessage) { // RPL_USERHOST</span>
<a href="#l16.576"></a><span id="l16.576" class="difflineplus">+      // :*1&lt;reply&gt; *( &quot; &quot; &lt;reply )&quot;</span>
<a href="#l16.577"></a><span id="l16.577" class="difflineplus">+      // reply = nickname [ &quot;*&quot; ] &quot;=&quot; ( &quot;+&quot; / &quot;-&quot; ) hostname</span>
<a href="#l16.578"></a><span id="l16.578" class="difflineplus">+      // XXX Can tell op / away from this</span>
<a href="#l16.579"></a><span id="l16.579" class="difflineplus">+      return false;</span>
<a href="#l16.580"></a><span id="l16.580" class="difflineplus">+    },</span>
<a href="#l16.581"></a><span id="l16.581" class="difflineplus">+    &quot;303&quot;: function(aMessage) { // RPL_ISON</span>
<a href="#l16.582"></a><span id="l16.582" class="difflineplus">+      // :*1&lt;nick&gt; *( &quot; &quot; &lt;nick&gt; )&quot;</span>
<a href="#l16.583"></a><span id="l16.583" class="difflineplus">+      // If there are any buddies online, mark them as online, otherwise return</span>
<a href="#l16.584"></a><span id="l16.584" class="difflineplus">+      // early.</span>
<a href="#l16.585"></a><span id="l16.585" class="difflineplus">+      if (aMessage.params.length &lt;= 1)</span>
<a href="#l16.586"></a><span id="l16.586" class="difflineplus">+        return true;</span>
<a href="#l16.587"></a><span id="l16.587" class="difflineplus">+</span>
<a href="#l16.588"></a><span id="l16.588" class="difflineplus">+      // The buddy names as returned by the server.</span>
<a href="#l16.589"></a><span id="l16.589" class="difflineplus">+      let receivedBuddyNames = aMessage.params[1].trim().split(&quot; &quot;);</span>
<a href="#l16.590"></a><span id="l16.590" class="difflineplus">+      // This was received in response to the last ISON message sent.</span>
<a href="#l16.591"></a><span id="l16.591" class="difflineplus">+      for each (let buddyName in this.pendingIsOnQueue) {</span>
<a href="#l16.592"></a><span id="l16.592" class="difflineplus">+        // If the buddy name is in the list returned from the server, they're</span>
<a href="#l16.593"></a><span id="l16.593" class="difflineplus">+        // online.</span>
<a href="#l16.594"></a><span id="l16.594" class="difflineplus">+        let status = (receivedBuddyNames.indexOf(buddyName) == -1) ?</span>
<a href="#l16.595"></a><span id="l16.595" class="difflineplus">+                       Ci.imIStatusInfo.STATUS_OFFLINE :</span>
<a href="#l16.596"></a><span id="l16.596" class="difflineplus">+                       Ci.imIStatusInfo.STATUS_AVAILABLE;</span>
<a href="#l16.597"></a><span id="l16.597" class="difflineplus">+</span>
<a href="#l16.598"></a><span id="l16.598" class="difflineplus">+        // Set the status with no status message, only if the buddy actually</span>
<a href="#l16.599"></a><span id="l16.599" class="difflineplus">+        // exists in the buddy list.</span>
<a href="#l16.600"></a><span id="l16.600" class="difflineplus">+        let buddy = this.getBuddy(buddyName);</span>
<a href="#l16.601"></a><span id="l16.601" class="difflineplus">+        if (buddy)</span>
<a href="#l16.602"></a><span id="l16.602" class="difflineplus">+          buddy.setStatus(status, &quot;&quot;);</span>
<a href="#l16.603"></a><span id="l16.603" class="difflineplus">+      }</span>
<a href="#l16.604"></a><span id="l16.604" class="difflineplus">+      return true;</span>
<a href="#l16.605"></a><span id="l16.605" class="difflineplus">+    },</span>
<a href="#l16.606"></a><span id="l16.606" class="difflineplus">+    &quot;305&quot;: function(aMessage) { // RPL_UNAWAY</span>
<a href="#l16.607"></a><span id="l16.607" class="difflineplus">+      // :You are no longer marked as being away</span>
<a href="#l16.608"></a><span id="l16.608" class="difflineplus">+      this.isAway = false;</span>
<a href="#l16.609"></a><span id="l16.609" class="difflineplus">+      return true;</span>
<a href="#l16.610"></a><span id="l16.610" class="difflineplus">+    },</span>
<a href="#l16.611"></a><span id="l16.611" class="difflineplus">+    &quot;306&quot;: function(aMessage) { // RPL_NOWAWAY</span>
<a href="#l16.612"></a><span id="l16.612" class="difflineplus">+      // :You have been marked as away</span>
<a href="#l16.613"></a><span id="l16.613" class="difflineplus">+      this.isAway = true;</span>
<a href="#l16.614"></a><span id="l16.614" class="difflineplus">+      return true;</span>
<a href="#l16.615"></a><span id="l16.615" class="difflineplus">+    },</span>
<a href="#l16.616"></a><span id="l16.616" class="difflineplus">+</span>
<a href="#l16.617"></a><span id="l16.617" class="difflineplus">+    /*</span>
<a href="#l16.618"></a><span id="l16.618" class="difflineplus">+     * WHOIS</span>
<a href="#l16.619"></a><span id="l16.619" class="difflineplus">+     */</span>
<a href="#l16.620"></a><span id="l16.620" class="difflineplus">+    &quot;311&quot;: function(aMessage) { // RPL_WHOISUSER</span>
<a href="#l16.621"></a><span id="l16.621" class="difflineplus">+      // &lt;nick&gt; &lt;user&gt; &lt;host&gt; * :&lt;real name&gt;</span>
<a href="#l16.622"></a><span id="l16.622" class="difflineplus">+      return setWhoIs(this, aMessage, {user: aMessage.params[2],</span>
<a href="#l16.623"></a><span id="l16.623" class="difflineplus">+                                       host: aMessage.params[3],</span>
<a href="#l16.624"></a><span id="l16.624" class="difflineplus">+                                       realname: aMessage.params[5]});</span>
<a href="#l16.625"></a><span id="l16.625" class="difflineplus">+    },</span>
<a href="#l16.626"></a><span id="l16.626" class="difflineplus">+    &quot;312&quot;: function(aMessage) { // RPL_WHOISSERVER</span>
<a href="#l16.627"></a><span id="l16.627" class="difflineplus">+      // &lt;nick&gt; &lt;server&gt; :&lt;server info&gt;</span>
<a href="#l16.628"></a><span id="l16.628" class="difflineplus">+      return setWhoIs(this, aMessage,</span>
<a href="#l16.629"></a><span id="l16.629" class="difflineplus">+                      {server: _(&quot;tooltip.serverValue&quot;, aMessage.params[2],</span>
<a href="#l16.630"></a><span id="l16.630" class="difflineplus">+                                 aMessage.params[3])});</span>
<a href="#l16.631"></a><span id="l16.631" class="difflineplus">+    },</span>
<a href="#l16.632"></a><span id="l16.632" class="difflineplus">+    &quot;313&quot;: function(aMessage) { // RPL_WHOISOPERATOR</span>
<a href="#l16.633"></a><span id="l16.633" class="difflineplus">+      // &lt;nick&gt; :is an IRC operator</span>
<a href="#l16.634"></a><span id="l16.634" class="difflineplus">+      return setWhoIs(this, aMessage, {ircOp: true});</span>
<a href="#l16.635"></a><span id="l16.635" class="difflineplus">+    },</span>
<a href="#l16.636"></a><span id="l16.636" class="difflineplus">+    &quot;314&quot;: function(aMessage) { // RPL_WHOWASUSER</span>
<a href="#l16.637"></a><span id="l16.637" class="difflineplus">+      // &lt;nick&gt; &lt;user&gt; &lt;host&gt; * :&lt;real name&gt;</span>
<a href="#l16.638"></a><span id="l16.638" class="difflineplus">+      return setWhoIs(this, aMessage, {user: aMessage.params[2],</span>
<a href="#l16.639"></a><span id="l16.639" class="difflineplus">+                                       host: aMessage.params[3],</span>
<a href="#l16.640"></a><span id="l16.640" class="difflineplus">+                                       realname: aMessage.params[5]});</span>
<a href="#l16.641"></a><span id="l16.641" class="difflineplus">+    },</span>
<a href="#l16.642"></a><span id="l16.642" class="difflineplus">+    &quot;315&quot;: function(aMessage) { // RPL_ENDOFWHO</span>
<a href="#l16.643"></a><span id="l16.643" class="difflineplus">+      // &lt;name&gt; :End of WHO list</span>
<a href="#l16.644"></a><span id="l16.644" class="difflineplus">+      return false;</span>
<a href="#l16.645"></a><span id="l16.645" class="difflineplus">+    },</span>
<a href="#l16.646"></a><span id="l16.646" class="difflineplus">+    &quot;300&quot;: function(aMessage) { // RPL_WHOISCHANOP</span>
<a href="#l16.647"></a><span id="l16.647" class="difflineplus">+      // Non-generic</span>
<a href="#l16.648"></a><span id="l16.648" class="difflineplus">+      return false;</span>
<a href="#l16.649"></a><span id="l16.649" class="difflineplus">+    },</span>
<a href="#l16.650"></a><span id="l16.650" class="difflineplus">+    &quot;317&quot;: function(aMessage) { // RPL_WHOISIDLE</span>
<a href="#l16.651"></a><span id="l16.651" class="difflineplus">+      // &lt;nick&gt; &lt;integer&gt; :seconds idle</span>
<a href="#l16.652"></a><span id="l16.652" class="difflineplus">+      let valuesAndUnits =</span>
<a href="#l16.653"></a><span id="l16.653" class="difflineplus">+        DownloadUtils.convertTimeUnits(parseInt(aMessage.params[2]));</span>
<a href="#l16.654"></a><span id="l16.654" class="difflineplus">+      if (!valuesAndUnits[2])</span>
<a href="#l16.655"></a><span id="l16.655" class="difflineplus">+        valuesAndUnits.splice(2, 2);</span>
<a href="#l16.656"></a><span id="l16.656" class="difflineplus">+      return setWhoIs(this, aMessage, {idleTime: valuesAndUnits.join(&quot; &quot;)});</span>
<a href="#l16.657"></a><span id="l16.657" class="difflineplus">+    },</span>
<a href="#l16.658"></a><span id="l16.658" class="difflineplus">+    &quot;318&quot;: function(aMessage) { // RPL_ENDOFWHOIS</span>
<a href="#l16.659"></a><span id="l16.659" class="difflineplus">+      // &lt;nick&gt; :End of WHOIS list</span>
<a href="#l16.660"></a><span id="l16.660" class="difflineplus">+      // We've received everything about WHOIS, tell the tooltip that is waiting</span>
<a href="#l16.661"></a><span id="l16.661" class="difflineplus">+      // for this information.</span>
<a href="#l16.662"></a><span id="l16.662" class="difflineplus">+      let buddyName = this.normalize(aMessage.params[1]);</span>
<a href="#l16.663"></a><span id="l16.663" class="difflineplus">+</span>
<a href="#l16.664"></a><span id="l16.664" class="difflineplus">+      // Notify the tooltip.</span>
<a href="#l16.665"></a><span id="l16.665" class="difflineplus">+      Services.obs.notifyObservers(this.getBuddyInfo(buddyName),</span>
<a href="#l16.666"></a><span id="l16.666" class="difflineplus">+                                   &quot;user-info-received&quot;, buddyName);</span>
<a href="#l16.667"></a><span id="l16.667" class="difflineplus">+      return true;</span>
<a href="#l16.668"></a><span id="l16.668" class="difflineplus">+    },</span>
<a href="#l16.669"></a><span id="l16.669" class="difflineplus">+    &quot;319&quot;: function(aMessage) { // RPL_WHOISCHANNELS</span>
<a href="#l16.670"></a><span id="l16.670" class="difflineplus">+      // &lt;nick&gt; :*( ( &quot;@&quot; / &quot;+&quot; ) &lt;channel&gt; &quot; &quot; )</span>
<a href="#l16.671"></a><span id="l16.671" class="difflineplus">+      return setWhoIs(this, aMessage, {channels: aMessage.params[2]});</span>
<a href="#l16.672"></a><span id="l16.672" class="difflineplus">+    },</span>
<a href="#l16.673"></a><span id="l16.673" class="difflineplus">+</span>
<a href="#l16.674"></a><span id="l16.674" class="difflineplus">+    /*</span>
<a href="#l16.675"></a><span id="l16.675" class="difflineplus">+     * LIST</span>
<a href="#l16.676"></a><span id="l16.676" class="difflineplus">+     */</span>
<a href="#l16.677"></a><span id="l16.677" class="difflineplus">+    &quot;321&quot;: function(aMessage) { // RPL_LISTSTART</span>
<a href="#l16.678"></a><span id="l16.678" class="difflineplus">+      // Obsolete. Not used.</span>
<a href="#l16.679"></a><span id="l16.679" class="difflineplus">+      return false;</span>
<a href="#l16.680"></a><span id="l16.680" class="difflineplus">+    },</span>
<a href="#l16.681"></a><span id="l16.681" class="difflineplus">+    &quot;322&quot;: function(aMessage) { // RPL_LIST</span>
<a href="#l16.682"></a><span id="l16.682" class="difflineplus">+      // &lt;channel&gt; &lt;# visible&gt; :&lt;topic&gt;</span>
<a href="#l16.683"></a><span id="l16.683" class="difflineplus">+      // XXX parse this for # users &amp; topic</span>
<a href="#l16.684"></a><span id="l16.684" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.685"></a><span id="l16.685" class="difflineplus">+    },</span>
<a href="#l16.686"></a><span id="l16.686" class="difflineplus">+    &quot;323&quot;: function(aMessage) { // RPL_LISTEND</span>
<a href="#l16.687"></a><span id="l16.687" class="difflineplus">+      // :End of LIST</span>
<a href="#l16.688"></a><span id="l16.688" class="difflineplus">+      return true;</span>
<a href="#l16.689"></a><span id="l16.689" class="difflineplus">+    },</span>
<a href="#l16.690"></a><span id="l16.690" class="difflineplus">+</span>
<a href="#l16.691"></a><span id="l16.691" class="difflineplus">+    /*</span>
<a href="#l16.692"></a><span id="l16.692" class="difflineplus">+     * Channel functions</span>
<a href="#l16.693"></a><span id="l16.693" class="difflineplus">+     */</span>
<a href="#l16.694"></a><span id="l16.694" class="difflineplus">+    &quot;324&quot;: function(aMessage) { // RPL_CHANNELMODEIS</span>
<a href="#l16.695"></a><span id="l16.695" class="difflineplus">+      // &lt;channel&gt; &lt;mode&gt; &lt;mode params&gt;</span>
<a href="#l16.696"></a><span id="l16.696" class="difflineplus">+      // XXX parse this and have the UI respond accordingly</span>
<a href="#l16.697"></a><span id="l16.697" class="difflineplus">+      return false;</span>
<a href="#l16.698"></a><span id="l16.698" class="difflineplus">+    },</span>
<a href="#l16.699"></a><span id="l16.699" class="difflineplus">+    &quot;325&quot;: function(aMessage) { // RPL_UNIQOPIS</span>
<a href="#l16.700"></a><span id="l16.700" class="difflineplus">+      // &lt;channel&gt; &lt;nickname&gt;</span>
<a href="#l16.701"></a><span id="l16.701" class="difflineplus">+      // XXX parse this and have the UI respond accordingly</span>
<a href="#l16.702"></a><span id="l16.702" class="difflineplus">+      return false;</span>
<a href="#l16.703"></a><span id="l16.703" class="difflineplus">+    },</span>
<a href="#l16.704"></a><span id="l16.704" class="difflineplus">+    &quot;331&quot;: function(aMessage) { // RPL_NOTOPIC</span>
<a href="#l16.705"></a><span id="l16.705" class="difflineplus">+      // &lt;channel&gt; :No topic is set</span>
<a href="#l16.706"></a><span id="l16.706" class="difflineplus">+      let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l16.707"></a><span id="l16.707" class="difflineplus">+      conversation.setTopic(&quot;&quot;); // Clear the topic.</span>
<a href="#l16.708"></a><span id="l16.708" class="difflineplus">+      let msg = _(&quot;message.topicRemoved&quot;, conversation.name);</span>
<a href="#l16.709"></a><span id="l16.709" class="difflineplus">+      conversation.writeMessage(null, msg, {system: true});</span>
<a href="#l16.710"></a><span id="l16.710" class="difflineplus">+      return false;</span>
<a href="#l16.711"></a><span id="l16.711" class="difflineplus">+    },</span>
<a href="#l16.712"></a><span id="l16.712" class="difflineplus">+    &quot;332&quot;: function(aMessage) { // RPL_TOPIC</span>
<a href="#l16.713"></a><span id="l16.713" class="difflineplus">+      // &lt;channel&gt; :&lt;topic&gt;</span>
<a href="#l16.714"></a><span id="l16.714" class="difflineplus">+      // Update the topic UI</span>
<a href="#l16.715"></a><span id="l16.715" class="difflineplus">+      let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l16.716"></a><span id="l16.716" class="difflineplus">+      conversation.setTopic(ctcpFormatToText(aMessage.params[2]));</span>
<a href="#l16.717"></a><span id="l16.717" class="difflineplus">+      // Send the topic as a message.</span>
<a href="#l16.718"></a><span id="l16.718" class="difflineplus">+      let msg = _(&quot;message.topic&quot;, conversation.name, aMessage.params[2]);</span>
<a href="#l16.719"></a><span id="l16.719" class="difflineplus">+      conversation.writeMessage(null, msg, {system: true});</span>
<a href="#l16.720"></a><span id="l16.720" class="difflineplus">+      return true;</span>
<a href="#l16.721"></a><span id="l16.721" class="difflineplus">+    },</span>
<a href="#l16.722"></a><span id="l16.722" class="difflineplus">+    &quot;333&quot;: function(aMessage) { // XXX nonstandard</span>
<a href="#l16.723"></a><span id="l16.723" class="difflineplus">+      // &lt;channel&gt; &lt;nickname&gt; &lt;time&gt;</span>
<a href="#l16.724"></a><span id="l16.724" class="difflineplus">+      return true;</span>
<a href="#l16.725"></a><span id="l16.725" class="difflineplus">+    },</span>
<a href="#l16.726"></a><span id="l16.726" class="difflineplus">+</span>
<a href="#l16.727"></a><span id="l16.727" class="difflineplus">+    /*</span>
<a href="#l16.728"></a><span id="l16.728" class="difflineplus">+     * Invitations</span>
<a href="#l16.729"></a><span id="l16.729" class="difflineplus">+     */</span>
<a href="#l16.730"></a><span id="l16.730" class="difflineplus">+    &quot;341&quot;: function(aMessage) { // RPL_INVITING</span>
<a href="#l16.731"></a><span id="l16.731" class="difflineplus">+      // &lt;channel&gt; &lt;nick&gt;</span>
<a href="#l16.732"></a><span id="l16.732" class="difflineplus">+      // XXX invite successfully sent? Display this?</span>
<a href="#l16.733"></a><span id="l16.733" class="difflineplus">+      return serverMessage(this, aMessage,</span>
<a href="#l16.734"></a><span id="l16.734" class="difflineplus">+                           _(&quot;message.invited&quot;, aMessage.params[1],</span>
<a href="#l16.735"></a><span id="l16.735" class="difflineplus">+                             aMessage.params[0]));</span>
<a href="#l16.736"></a><span id="l16.736" class="difflineplus">+    },</span>
<a href="#l16.737"></a><span id="l16.737" class="difflineplus">+    &quot;342&quot;: function(aMessage) { // RPL_SUMMONING</span>
<a href="#l16.738"></a><span id="l16.738" class="difflineplus">+      // &lt;user&gt; :Summoning user to IRC</span>
<a href="#l16.739"></a><span id="l16.739" class="difflineplus">+      return writeMessage(this, aMessage,</span>
<a href="#l16.740"></a><span id="l16.740" class="difflineplus">+                          _(&quot;message.summoned&quot;, aMessage.params[0]));</span>
<a href="#l16.741"></a><span id="l16.741" class="difflineplus">+    },</span>
<a href="#l16.742"></a><span id="l16.742" class="difflineplus">+    &quot;346&quot;: function(aMessage) { // RPL_INVITELIST</span>
<a href="#l16.743"></a><span id="l16.743" class="difflineplus">+      // &lt;chanel&gt; &lt;invitemask&gt;</span>
<a href="#l16.744"></a><span id="l16.744" class="difflineplus">+      // XXX what do we do?</span>
<a href="#l16.745"></a><span id="l16.745" class="difflineplus">+      return false;</span>
<a href="#l16.746"></a><span id="l16.746" class="difflineplus">+    },</span>
<a href="#l16.747"></a><span id="l16.747" class="difflineplus">+    &quot;347&quot;: function(aMessage) { // RPL_ENDOFINVITELIST</span>
<a href="#l16.748"></a><span id="l16.748" class="difflineplus">+      // &lt;channel&gt; :End of channel invite list</span>
<a href="#l16.749"></a><span id="l16.749" class="difflineplus">+      // XXX what do we do?</span>
<a href="#l16.750"></a><span id="l16.750" class="difflineplus">+      return false;</span>
<a href="#l16.751"></a><span id="l16.751" class="difflineplus">+    },</span>
<a href="#l16.752"></a><span id="l16.752" class="difflineplus">+    &quot;348&quot;: function(aMessage) { // RPL_EXCEPTLIST</span>
<a href="#l16.753"></a><span id="l16.753" class="difflineplus">+      // &lt;channel&gt; &lt;exceptionmask&gt;</span>
<a href="#l16.754"></a><span id="l16.754" class="difflineplus">+      // XXX what do we do?</span>
<a href="#l16.755"></a><span id="l16.755" class="difflineplus">+      return false;</span>
<a href="#l16.756"></a><span id="l16.756" class="difflineplus">+    },</span>
<a href="#l16.757"></a><span id="l16.757" class="difflineplus">+    &quot;349&quot;: function(aMessage) { // RPL_ENDOFEXCEPTIONLIST</span>
<a href="#l16.758"></a><span id="l16.758" class="difflineplus">+      // &lt;channel&gt; :End of channel exception list</span>
<a href="#l16.759"></a><span id="l16.759" class="difflineplus">+      // XXX update UI?</span>
<a href="#l16.760"></a><span id="l16.760" class="difflineplus">+      return false;</span>
<a href="#l16.761"></a><span id="l16.761" class="difflineplus">+    },</span>
<a href="#l16.762"></a><span id="l16.762" class="difflineplus">+</span>
<a href="#l16.763"></a><span id="l16.763" class="difflineplus">+    /*</span>
<a href="#l16.764"></a><span id="l16.764" class="difflineplus">+     * Version</span>
<a href="#l16.765"></a><span id="l16.765" class="difflineplus">+     */</span>
<a href="#l16.766"></a><span id="l16.766" class="difflineplus">+    &quot;351&quot;: function(aMessage) { // RPL_VERSION</span>
<a href="#l16.767"></a><span id="l16.767" class="difflineplus">+      // &lt;version&gt;.&lt;debuglevel&gt; &lt;server&gt; :&lt;comments&gt;</span>
<a href="#l16.768"></a><span id="l16.768" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.769"></a><span id="l16.769" class="difflineplus">+    },</span>
<a href="#l16.770"></a><span id="l16.770" class="difflineplus">+</span>
<a href="#l16.771"></a><span id="l16.771" class="difflineplus">+    /*</span>
<a href="#l16.772"></a><span id="l16.772" class="difflineplus">+     * WHO</span>
<a href="#l16.773"></a><span id="l16.773" class="difflineplus">+     */</span>
<a href="#l16.774"></a><span id="l16.774" class="difflineplus">+    &quot;352&quot;: function(aMessage) { // RPL_WHOREPLY</span>
<a href="#l16.775"></a><span id="l16.775" class="difflineplus">+      // &lt;channel&gt; &lt;user&gt; &lt;host&gt; &lt;server&gt; &lt;nick&gt; ( &quot;H&quot; / &quot;G&quot; ) [&quot;*&quot;] [ (&quot;@&quot; / &quot;+&quot; ) ] :&lt;hopcount&gt; &lt;real name&gt;</span>
<a href="#l16.776"></a><span id="l16.776" class="difflineplus">+      // XXX</span>
<a href="#l16.777"></a><span id="l16.777" class="difflineplus">+      return false;</span>
<a href="#l16.778"></a><span id="l16.778" class="difflineplus">+    },</span>
<a href="#l16.779"></a><span id="l16.779" class="difflineplus">+</span>
<a href="#l16.780"></a><span id="l16.780" class="difflineplus">+    /*</span>
<a href="#l16.781"></a><span id="l16.781" class="difflineplus">+     * NAMREPLY</span>
<a href="#l16.782"></a><span id="l16.782" class="difflineplus">+     */</span>
<a href="#l16.783"></a><span id="l16.783" class="difflineplus">+    &quot;353&quot;: function(aMessage) { // RPL_NAMREPLY</span>
<a href="#l16.784"></a><span id="l16.784" class="difflineplus">+      // &lt;target&gt; ( &quot;=&quot; / &quot;*&quot; / &quot;@&quot; ) &lt;channel&gt; :[ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; *( &quot; &quot; [ &quot;@&quot; / &quot;+&quot; ] &lt;nick&gt; )</span>
<a href="#l16.785"></a><span id="l16.785" class="difflineplus">+      // XXX Keep if this is secret (@), private (*) or public (=)</span>
<a href="#l16.786"></a><span id="l16.786" class="difflineplus">+      let conversation = this.getConversation(aMessage.params[2]);</span>
<a href="#l16.787"></a><span id="l16.787" class="difflineplus">+      aMessage.params[3].trim().split(&quot; &quot;).forEach(</span>
<a href="#l16.788"></a><span id="l16.788" class="difflineplus">+        function(aNick) conversation.getParticipant(aNick, false));</span>
<a href="#l16.789"></a><span id="l16.789" class="difflineplus">+      return true;</span>
<a href="#l16.790"></a><span id="l16.790" class="difflineplus">+    },</span>
<a href="#l16.791"></a><span id="l16.791" class="difflineplus">+</span>
<a href="#l16.792"></a><span id="l16.792" class="difflineplus">+    &quot;361&quot;: function(aMessage) { // RPL_KILLDONE</span>
<a href="#l16.793"></a><span id="l16.793" class="difflineplus">+      // XXX</span>
<a href="#l16.794"></a><span id="l16.794" class="difflineplus">+      return false;</span>
<a href="#l16.795"></a><span id="l16.795" class="difflineplus">+    },</span>
<a href="#l16.796"></a><span id="l16.796" class="difflineplus">+    &quot;362&quot;: function(aMessage) { // RPL_CLOSING</span>
<a href="#l16.797"></a><span id="l16.797" class="difflineplus">+      // XXX</span>
<a href="#l16.798"></a><span id="l16.798" class="difflineplus">+      return false;</span>
<a href="#l16.799"></a><span id="l16.799" class="difflineplus">+    },</span>
<a href="#l16.800"></a><span id="l16.800" class="difflineplus">+    &quot;363&quot;: function(aMessage) { // RPL_CLOSEEND</span>
<a href="#l16.801"></a><span id="l16.801" class="difflineplus">+      // Non-generic</span>
<a href="#l16.802"></a><span id="l16.802" class="difflineplus">+      // XXX</span>
<a href="#l16.803"></a><span id="l16.803" class="difflineplus">+      return false;</span>
<a href="#l16.804"></a><span id="l16.804" class="difflineplus">+    },</span>
<a href="#l16.805"></a><span id="l16.805" class="difflineplus">+</span>
<a href="#l16.806"></a><span id="l16.806" class="difflineplus">+    /*</span>
<a href="#l16.807"></a><span id="l16.807" class="difflineplus">+     * Links.</span>
<a href="#l16.808"></a><span id="l16.808" class="difflineplus">+     */</span>
<a href="#l16.809"></a><span id="l16.809" class="difflineplus">+    &quot;364&quot;: function(aMessage) { // RPL_LINKS</span>
<a href="#l16.810"></a><span id="l16.810" class="difflineplus">+      // &lt;mask&gt; &lt;server&gt; :&lt;hopcount&gt; &lt;server info&gt;</span>
<a href="#l16.811"></a><span id="l16.811" class="difflineplus">+      // XXX</span>
<a href="#l16.812"></a><span id="l16.812" class="difflineplus">+      return false;</span>
<a href="#l16.813"></a><span id="l16.813" class="difflineplus">+    },</span>
<a href="#l16.814"></a><span id="l16.814" class="difflineplus">+    &quot;365&quot;: function(aMessage) { // RPL_ENDOFLINKS</span>
<a href="#l16.815"></a><span id="l16.815" class="difflineplus">+      // &lt;mask&gt; :End of LINKS list</span>
<a href="#l16.816"></a><span id="l16.816" class="difflineplus">+      // XXX</span>
<a href="#l16.817"></a><span id="l16.817" class="difflineplus">+      return false;</span>
<a href="#l16.818"></a><span id="l16.818" class="difflineplus">+    },</span>
<a href="#l16.819"></a><span id="l16.819" class="difflineplus">+</span>
<a href="#l16.820"></a><span id="l16.820" class="difflineplus">+    /*</span>
<a href="#l16.821"></a><span id="l16.821" class="difflineplus">+     * Names</span>
<a href="#l16.822"></a><span id="l16.822" class="difflineplus">+     */</span>
<a href="#l16.823"></a><span id="l16.823" class="difflineplus">+    &quot;366&quot;: function(aMessage) { // RPL_ENDOFNAMES</span>
<a href="#l16.824"></a><span id="l16.824" class="difflineplus">+      // &lt;target&gt; &lt;channel&gt; :End of NAMES list</span>
<a href="#l16.825"></a><span id="l16.825" class="difflineplus">+      // Notify the conversation of the added participants.</span>
<a href="#l16.826"></a><span id="l16.826" class="difflineplus">+      let conversation = this.getConversation(aMessage.params[1]);</span>
<a href="#l16.827"></a><span id="l16.827" class="difflineplus">+      conversation.notifyObservers(conversation.getParticipants(),</span>
<a href="#l16.828"></a><span id="l16.828" class="difflineplus">+                                   &quot;chat-buddy-add&quot;);</span>
<a href="#l16.829"></a><span id="l16.829" class="difflineplus">+      return true;</span>
<a href="#l16.830"></a><span id="l16.830" class="difflineplus">+    },</span>
<a href="#l16.831"></a><span id="l16.831" class="difflineplus">+</span>
<a href="#l16.832"></a><span id="l16.832" class="difflineplus">+    /*</span>
<a href="#l16.833"></a><span id="l16.833" class="difflineplus">+     * End of a bunch of lists</span>
<a href="#l16.834"></a><span id="l16.834" class="difflineplus">+     */</span>
<a href="#l16.835"></a><span id="l16.835" class="difflineplus">+    &quot;367&quot;: function(aMessage) { // RPL_BANLIST</span>
<a href="#l16.836"></a><span id="l16.836" class="difflineplus">+      // &lt;channel&gt; &lt;banmask&gt;</span>
<a href="#l16.837"></a><span id="l16.837" class="difflineplus">+      // XXX</span>
<a href="#l16.838"></a><span id="l16.838" class="difflineplus">+      return false;</span>
<a href="#l16.839"></a><span id="l16.839" class="difflineplus">+    },</span>
<a href="#l16.840"></a><span id="l16.840" class="difflineplus">+    &quot;368&quot;: function(aMessage) { // RPL_ENDOFBANLIST</span>
<a href="#l16.841"></a><span id="l16.841" class="difflineplus">+      // &lt;channel&gt; :End of channel ban list</span>
<a href="#l16.842"></a><span id="l16.842" class="difflineplus">+      // XXX</span>
<a href="#l16.843"></a><span id="l16.843" class="difflineplus">+      return false;</span>
<a href="#l16.844"></a><span id="l16.844" class="difflineplus">+    },</span>
<a href="#l16.845"></a><span id="l16.845" class="difflineplus">+    &quot;369&quot;: function(aMessage) { // RPL_ENDOFWHOWAS</span>
<a href="#l16.846"></a><span id="l16.846" class="difflineplus">+      // &lt;nick&gt; :End of WHOWAS</span>
<a href="#l16.847"></a><span id="l16.847" class="difflineplus">+      // XXX</span>
<a href="#l16.848"></a><span id="l16.848" class="difflineplus">+      return false;</span>
<a href="#l16.849"></a><span id="l16.849" class="difflineplus">+    },</span>
<a href="#l16.850"></a><span id="l16.850" class="difflineplus">+</span>
<a href="#l16.851"></a><span id="l16.851" class="difflineplus">+    /*</span>
<a href="#l16.852"></a><span id="l16.852" class="difflineplus">+     * Server info</span>
<a href="#l16.853"></a><span id="l16.853" class="difflineplus">+     */</span>
<a href="#l16.854"></a><span id="l16.854" class="difflineplus">+    &quot;371&quot;: function(aMessage) { // RPL_INFO</span>
<a href="#l16.855"></a><span id="l16.855" class="difflineplus">+      // :&lt;string&gt;</span>
<a href="#l16.856"></a><span id="l16.856" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.857"></a><span id="l16.857" class="difflineplus">+    },</span>
<a href="#l16.858"></a><span id="l16.858" class="difflineplus">+    &quot;372&quot;: function(aMessage) { // RPL_MOTD</span>
<a href="#l16.859"></a><span id="l16.859" class="difflineplus">+      // :- &lt;text&gt;</span>
<a href="#l16.860"></a><span id="l16.860" class="difflineplus">+      this._motd.push(aMessage.params[1].slice(2));</span>
<a href="#l16.861"></a><span id="l16.861" class="difflineplus">+      return true;</span>
<a href="#l16.862"></a><span id="l16.862" class="difflineplus">+    },</span>
<a href="#l16.863"></a><span id="l16.863" class="difflineplus">+    &quot;373&quot;: function(aMessage) { // RPL_INFOSTART</span>
<a href="#l16.864"></a><span id="l16.864" class="difflineplus">+      // Non-generic</span>
<a href="#l16.865"></a><span id="l16.865" class="difflineplus">+      // XXX</span>
<a href="#l16.866"></a><span id="l16.866" class="difflineplus">+      return false;</span>
<a href="#l16.867"></a><span id="l16.867" class="difflineplus">+    },</span>
<a href="#l16.868"></a><span id="l16.868" class="difflineplus">+    &quot;374&quot;: function(aMessage) { // RPL_ENDOFINFO</span>
<a href="#l16.869"></a><span id="l16.869" class="difflineplus">+      // :End of INFO list</span>
<a href="#l16.870"></a><span id="l16.870" class="difflineplus">+      // XXX</span>
<a href="#l16.871"></a><span id="l16.871" class="difflineplus">+      return false;</span>
<a href="#l16.872"></a><span id="l16.872" class="difflineplus">+    },</span>
<a href="#l16.873"></a><span id="l16.873" class="difflineplus">+    &quot;375&quot;: function(aMessage) { // RPL_MOTDSTART</span>
<a href="#l16.874"></a><span id="l16.874" class="difflineplus">+      // :- &lt;server&gt; Message of the day -</span>
<a href="#l16.875"></a><span id="l16.875" class="difflineplus">+      this._motd = [aMessage.params[1].slice(2, -2)];</span>
<a href="#l16.876"></a><span id="l16.876" class="difflineplus">+      return true;</span>
<a href="#l16.877"></a><span id="l16.877" class="difflineplus">+    },</span>
<a href="#l16.878"></a><span id="l16.878" class="difflineplus">+    &quot;376&quot;: function(aMessage) { // RPL_ENDOFMOTD</span>
<a href="#l16.879"></a><span id="l16.879" class="difflineplus">+      // :End of MOTD command</span>
<a href="#l16.880"></a><span id="l16.880" class="difflineplus">+      if (this._showServerTab)</span>
<a href="#l16.881"></a><span id="l16.881" class="difflineplus">+        writeMessage(this, aMessage, this._motd.join(&quot;\n&quot;), &quot;incoming&quot;);</span>
<a href="#l16.882"></a><span id="l16.882" class="difflineplus">+      delete this._motd;</span>
<a href="#l16.883"></a><span id="l16.883" class="difflineplus">+      return true;</span>
<a href="#l16.884"></a><span id="l16.884" class="difflineplus">+    },</span>
<a href="#l16.885"></a><span id="l16.885" class="difflineplus">+</span>
<a href="#l16.886"></a><span id="l16.886" class="difflineplus">+    /*</span>
<a href="#l16.887"></a><span id="l16.887" class="difflineplus">+     * OPER</span>
<a href="#l16.888"></a><span id="l16.888" class="difflineplus">+     */</span>
<a href="#l16.889"></a><span id="l16.889" class="difflineplus">+    &quot;381&quot;: function(aMessage) { // RPL_YOUREOPER</span>
<a href="#l16.890"></a><span id="l16.890" class="difflineplus">+      // :You are now an IRC operator</span>
<a href="#l16.891"></a><span id="l16.891" class="difflineplus">+      // XXX update UI accordingly to show oper status</span>
<a href="#l16.892"></a><span id="l16.892" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.893"></a><span id="l16.893" class="difflineplus">+    },</span>
<a href="#l16.894"></a><span id="l16.894" class="difflineplus">+    &quot;382&quot;: function(aMessage) { // RPL_REHASHING</span>
<a href="#l16.895"></a><span id="l16.895" class="difflineplus">+      // &lt;config file&gt; :Rehashing</span>
<a href="#l16.896"></a><span id="l16.896" class="difflineplus">+      return serverMessage(this, aMessage);</span>
<a href="#l16.897"></a><span id="l16.897" class="difflineplus">+    },</span>
<a href="#l16.898"></a><span id="l16.898" class="difflineplus">+    &quot;383&quot;: function(aMessage) { // RPL_YOURESERVICE</span>
<a href="#l16.899"></a><span id="l16.899" class="difflineplus">+      // You are service &lt;servicename&gt;</span>
<a href="#l16.900"></a><span id="l16.900" class="difflineplus">+      // XXX Could this ever happen?</span>
<a href="#l16.901"></a><span id="l16.901" class="difflineplus">+      return false;</span>
<a href="#l16.902"></a><span id="l16.902" class="difflineplus">+    },</span>
<a href="#l16.903"></a><span id="l16.903" class="difflineplus">+</span>
<a href="#l16.904"></a><span id="l16.904" class="difflineplus">+    /*</span>
<a href="#l16.905"></a><span id="l16.905" class="difflineplus">+     * Info</span>
<a href="#l16.906"></a><span id="l16.906" class="difflineplus">+     */</span>
<a href="#l16.907"></a><span id="l16.907" class="difflineplus">+    &quot;384&quot;: function(aMessage) { // RPL_MYPORTIS</span>
<a href="#l16.908"></a><span id="l16.908" class="difflineplus">+      // Non-generic</span>
<a href="#l16.909"></a><span id="l16.909" class="difflineplus">+      return false;</span>
<a href="#l16.910"></a><span id="l16.910" class="difflineplus">+    },</span>
<a href="#l16.911"></a><span id="l16.911" class="difflineplus">+    &quot;391&quot;: function(aMessage) { // RPL_TIME</span>
<a href="#l16.912"></a><span id="l16.912" class="difflineplus">+      // &lt;server&gt; :&lt;string showing server's local time&gt;</span>
<a href="#l16.913"></a><span id="l16.913" class="difflineplus">+      // XXX parse date string &amp; store or just show it?</span>
<a href="#l16.914"></a><span id="l16.914" class="difflineplus">+      return false;</span>
<a href="#l16.915"></a><span id="l16.915" class="difflineplus">+    },</span>
<a href="#l16.916"></a><span id="l16.916" class="difflineplus">+    &quot;392&quot;: function(aMessage) { // RPL_USERSSTART</span>
<a href="#l16.917"></a><span id="l16.917" class="difflineplus">+      // :UserID   Terminal  Host</span>
<a href="#l16.918"></a><span id="l16.918" class="difflineplus">+      // XXX</span>
<a href="#l16.919"></a><span id="l16.919" class="difflineplus">+      return false;</span>
<a href="#l16.920"></a><span id="l16.920" class="difflineplus">+    },</span>
<a href="#l16.921"></a><span id="l16.921" class="difflineplus">+    &quot;393&quot;: function(aMessage) { // RPL_USERS</span>
<a href="#l16.922"></a><span id="l16.922" class="difflineplus">+      // :&lt;username&gt; &lt;ttyline&gt; &lt;hostname&gt;</span>
<a href="#l16.923"></a><span id="l16.923" class="difflineplus">+      // XXX store into buddy list</span>
<a href="#l16.924"></a><span id="l16.924" class="difflineplus">+      return false;</span>
<a href="#l16.925"></a><span id="l16.925" class="difflineplus">+    },</span>
<a href="#l16.926"></a><span id="l16.926" class="difflineplus">+    &quot;394&quot;: function(aMessage) { // RPL_ENDOFUSERS</span>
<a href="#l16.927"></a><span id="l16.927" class="difflineplus">+      // :End of users</span>
<a href="#l16.928"></a><span id="l16.928" class="difflineplus">+      // XXX Notify observers of the buddy list</span>
<a href="#l16.929"></a><span id="l16.929" class="difflineplus">+      return false;</span>
<a href="#l16.930"></a><span id="l16.930" class="difflineplus">+    },</span>
<a href="#l16.931"></a><span id="l16.931" class="difflineplus">+    &quot;395&quot;: function(aMessage) { // RPL_NOUSERS</span>
<a href="#l16.932"></a><span id="l16.932" class="difflineplus">+      // :Nobody logged in</span>
<a href="#l16.933"></a><span id="l16.933" class="difflineplus">+      // XXX clear buddy list</span>
<a href="#l16.934"></a><span id="l16.934" class="difflineplus">+      return false;</span>
<a href="#l16.935"></a><span id="l16.935" class="difflineplus">+    },</span>
<a href="#l16.936"></a><span id="l16.936" class="difflineplus">+</span>
<a href="#l16.937"></a><span id="l16.937" class="difflineplus">+      // Error messages, Implement Section 5.2 of RFC 2812</span>
<a href="#l16.938"></a><span id="l16.938" class="difflineplus">+    &quot;401&quot;: function(aMessage) { // ERR_NOSUCHNICK</span>
<a href="#l16.939"></a><span id="l16.939" class="difflineplus">+      // &lt;nickname&gt; :No such nick/channel</span>
<a href="#l16.940"></a><span id="l16.940" class="difflineplus">+      // XXX</span>
<a href="#l16.941"></a><span id="l16.941" class="difflineplus">+      return false;</span>
<a href="#l16.942"></a><span id="l16.942" class="difflineplus">+    },</span>
<a href="#l16.943"></a><span id="l16.943" class="difflineplus">+    &quot;402&quot;: function(aMessage) { // ERR_NOSUCHSERVER</span>
<a href="#l16.944"></a><span id="l16.944" class="difflineplus">+      // &lt;server name&gt; :No such server</span>
<a href="#l16.945"></a><span id="l16.945" class="difflineplus">+      // XXX</span>
<a href="#l16.946"></a><span id="l16.946" class="difflineplus">+      return false;</span>
<a href="#l16.947"></a><span id="l16.947" class="difflineplus">+    },</span>
<a href="#l16.948"></a><span id="l16.948" class="difflineplus">+    &quot;403&quot;: function(aMessage) { // ERR_NOSUCHCHANNEL</span>
<a href="#l16.949"></a><span id="l16.949" class="difflineplus">+      // &lt;channel name&gt; :No such channel</span>
<a href="#l16.950"></a><span id="l16.950" class="difflineplus">+      return errorMessage(this, aMessage,</span>
<a href="#l16.951"></a><span id="l16.951" class="difflineplus">+                          _(&quot;error.noChannel&quot;, aMessage.params[0]));</span>
<a href="#l16.952"></a><span id="l16.952" class="difflineplus">+    },</span>
<a href="#l16.953"></a><span id="l16.953" class="difflineplus">+    &quot;404&quot;: function(aMessage) { // ERR_CANNONTSENDTOCHAN</span>
<a href="#l16.954"></a><span id="l16.954" class="difflineplus">+      // &lt;channel name&gt; :Cannot send to channel</span>
<a href="#l16.955"></a><span id="l16.955" class="difflineplus">+      // XXX handle that the channel didn't receive the message</span>
<a href="#l16.956"></a><span id="l16.956" class="difflineplus">+      return false;</span>
<a href="#l16.957"></a><span id="l16.957" class="difflineplus">+    },</span>
<a href="#l16.958"></a><span id="l16.958" class="difflineplus">+    &quot;405&quot;: function(aMessage) { // ERR_TOOMANYCHANNELS</span>
<a href="#l16.959"></a><span id="l16.959" class="difflineplus">+      // &lt;channel name&gt; :You have joined too many channels</span>
<a href="#l16.960"></a><span id="l16.960" class="difflineplus">+      return errorMessage(this, aMessage,</span>
<a href="#l16.961"></a><span id="l16.961" class="difflineplus">+                          _(&quot;error.tooManyChannels&quot;, aMessage.params[0]));</span>
<a href="#l16.962"></a><span id="l16.962" class="difflineplus">+    },</span>
<a href="#l16.963"></a><span id="l16.963" class="difflineplus">+    &quot;406&quot;: function(aMessage) { // ERR_WASNOSUCHNICK</span>
<a href="#l16.964"></a><span id="l16.964" class="difflineplus">+      // &lt;nickname&gt; :There was no such nickname</span>
<a href="#l16.965"></a><span id="l16.965" class="difflineplus">+      // XXX Error saying the nick never existed</span>
<a href="#l16.966"></a><span id="l16.966" class="difflineplus">+      return false;</span>
<a href="#l16.967"></a><span id="l16.967" class="difflineplus">+    },</span>
<a href="#l16.968"></a><span id="l16.968" class="difflineplus">+    &quot;407&quot;: function(aMessage) { // ERR_TOOMANYTARGETS</span>
<a href="#l16.969"></a><span id="l16.969" class="difflineplus">+      // &lt;target&gt; :&lt;error code&gt; recipients. &lt;abord message&gt;</span>
<a href="#l16.970"></a><span id="l16.970" class="difflineplus">+      // XXX</span>
<a href="#l16.971"></a><span id="l16.971" class="difflineplus">+      return false;</span>
<a href="#l16.972"></a><span id="l16.972" class="difflineplus">+    },</span>
<a href="#l16.973"></a><span id="l16.973" class="difflineplus">+    &quot;408&quot;: function(aMessage) { // ERR_NOSUCHSERVICE</span>
<a href="#l16.974"></a><span id="l16.974" class="difflineplus">+      // &lt;service name&gt; :No such service</span>
<a href="#l16.975"></a><span id="l16.975" class="difflineplus">+      // XXX</span>
<a href="#l16.976"></a><span id="l16.976" class="difflineplus">+      return false;</span>
<a href="#l16.977"></a><span id="l16.977" class="difflineplus">+    },</span>
<a href="#l16.978"></a><span id="l16.978" class="difflineplus">+    &quot;409&quot;: function(aMessage) { // ERR_NOORIGIN</span>
<a href="#l16.979"></a><span id="l16.979" class="difflineplus">+      // :No origin specified</span>
<a href="#l16.980"></a><span id="l16.980" class="difflineplus">+      // XXX failed PING/PONG message, this should never occur</span>
<a href="#l16.981"></a><span id="l16.981" class="difflineplus">+      return false;</span>
<a href="#l16.982"></a><span id="l16.982" class="difflineplus">+    },</span>
<a href="#l16.983"></a><span id="l16.983" class="difflineplus">+    &quot;411&quot;: function(aMessage) { // ERR_NORECIPIENT</span>
<a href="#l16.984"></a><span id="l16.984" class="difflineplus">+      // :No recipient given (&lt;command&gt;)</span>
<a href="#l16.985"></a><span id="l16.985" class="difflineplus">+      // XXX This should never happen.</span>
<a href="#l16.986"></a><span id="l16.986" class="difflineplus">+      return false;</span>
<a href="#l16.987"></a><span id="l16.987" class="difflineplus">+    },</span>
<a href="#l16.988"></a><span id="l16.988" class="difflineplus">+    &quot;412&quot;: function(aMessage) { // ERR_NOTEXTTOSEND</span>
<a href="#l16.989"></a><span id="l16.989" class="difflineplus">+      // :No text to send</span>
<a href="#l16.990"></a><span id="l16.990" class="difflineplus">+      // XXX this shouldn't happen?</span>
<a href="#l16.991"></a><span id="l16.991" class="difflineplus">+      return false;</span>
<a href="#l16.992"></a><span id="l16.992" class="difflineplus">+    },</span>
<a href="#l16.993"></a><span id="l16.993" class="difflineplus">+    &quot;413&quot;: function(aMessage) { // ERR_NOTOPLEVEL</span>
<a href="#l16.994"></a><span id="l16.994" class="difflineplus">+      // &lt;mask&gt; :No toplevel domain specified</span>
<a href="#l16.995"></a><span id="l16.995" class="difflineplus">+      // XXX</span>
<a href="#l16.996"></a><span id="l16.996" class="difflineplus">+      return false;</span>
<a href="#l16.997"></a><span id="l16.997" class="difflineplus">+    },</span>
<a href="#l16.998"></a><span id="l16.998" class="difflineplus">+    &quot;414&quot;: function(aMessage) { // ERR_WILDTOPLEVEL</span>
<a href="#l16.999"></a><span id="l16.999" class="difflineplus">+      // &lt;mask&gt; :Wildcard in toplevel domain</span>
<a href="#l16.1000"></a><span id="l16.1000" class="difflineplus">+      // XXX</span>
<a href="#l16.1001"></a><span id="l16.1001" class="difflineplus">+      return false;</span>
<a href="#l16.1002"></a><span id="l16.1002" class="difflineplus">+    },</span>
<a href="#l16.1003"></a><span id="l16.1003" class="difflineplus">+    &quot;415&quot;: function(aMessage) { // ERR_BADMASK</span>
<a href="#l16.1004"></a><span id="l16.1004" class="difflineplus">+      // &lt;mask&gt; :Bad Server/host mask</span>
<a href="#l16.1005"></a><span id="l16.1005" class="difflineplus">+      // XXX</span>
<a href="#l16.1006"></a><span id="l16.1006" class="difflineplus">+      return false;</span>
<a href="#l16.1007"></a><span id="l16.1007" class="difflineplus">+    },</span>
<a href="#l16.1008"></a><span id="l16.1008" class="difflineplus">+    &quot;421&quot;: function(aMessage) { // ERR_UNKNOWNCOMMAND</span>
<a href="#l16.1009"></a><span id="l16.1009" class="difflineplus">+      // &lt;command&gt; :Unknown command</span>
<a href="#l16.1010"></a><span id="l16.1010" class="difflineplus">+      // XXX This shouldn't occur</span>
<a href="#l16.1011"></a><span id="l16.1011" class="difflineplus">+      return false;</span>
<a href="#l16.1012"></a><span id="l16.1012" class="difflineplus">+    },</span>
<a href="#l16.1013"></a><span id="l16.1013" class="difflineplus">+    &quot;422&quot;: function(aMessage) { // ERR_NOMOTD</span>
<a href="#l16.1014"></a><span id="l16.1014" class="difflineplus">+      // :MOTD File is missing</span>
<a href="#l16.1015"></a><span id="l16.1015" class="difflineplus">+      // XXX</span>
<a href="#l16.1016"></a><span id="l16.1016" class="difflineplus">+      return false;</span>
<a href="#l16.1017"></a><span id="l16.1017" class="difflineplus">+    },</span>
<a href="#l16.1018"></a><span id="l16.1018" class="difflineplus">+    &quot;423&quot;: function(aMessage) { // ERR_NOADMININFO</span>
<a href="#l16.1019"></a><span id="l16.1019" class="difflineplus">+      // &lt;server&gt; :No administrative info available</span>
<a href="#l16.1020"></a><span id="l16.1020" class="difflineplus">+      // XXX</span>
<a href="#l16.1021"></a><span id="l16.1021" class="difflineplus">+      return false;</span>
<a href="#l16.1022"></a><span id="l16.1022" class="difflineplus">+    },</span>
<a href="#l16.1023"></a><span id="l16.1023" class="difflineplus">+    &quot;424&quot;: function(aMessage) { // ERR_FILEERROR</span>
<a href="#l16.1024"></a><span id="l16.1024" class="difflineplus">+      // :File error doing &lt;file op&gt; on &lt;file&gt;</span>
<a href="#l16.1025"></a><span id="l16.1025" class="difflineplus">+      // XXX</span>
<a href="#l16.1026"></a><span id="l16.1026" class="difflineplus">+      return false;</span>
<a href="#l16.1027"></a><span id="l16.1027" class="difflineplus">+    },</span>
<a href="#l16.1028"></a><span id="l16.1028" class="difflineplus">+    &quot;431&quot;: function(aMessage) { // ERR_NONICKNAMEGIVEN</span>
<a href="#l16.1029"></a><span id="l16.1029" class="difflineplus">+      // :No nickname given</span>
<a href="#l16.1030"></a><span id="l16.1030" class="difflineplus">+      // XXX</span>
<a href="#l16.1031"></a><span id="l16.1031" class="difflineplus">+      return false;</span>
<a href="#l16.1032"></a><span id="l16.1032" class="difflineplus">+    },</span>
<a href="#l16.1033"></a><span id="l16.1033" class="difflineplus">+    &quot;432&quot;: function(aMessage) { // ERR_ERRONEUSNICKNAME</span>
<a href="#l16.1034"></a><span id="l16.1034" class="difflineplus">+      // &lt;nick&gt; :Erroneous nickname</span>
<a href="#l16.1035"></a><span id="l16.1035" class="difflineplus">+      // XXX Prompt user for new nick? Autoclean characters?</span>
<a href="#l16.1036"></a><span id="l16.1036" class="difflineplus">+      return false;</span>
<a href="#l16.1037"></a><span id="l16.1037" class="difflineplus">+    },</span>
<a href="#l16.1038"></a><span id="l16.1038" class="difflineplus">+    &quot;433&quot;: function(aMessage) { // ERR_NICKNAMEINUSE</span>
<a href="#l16.1039"></a><span id="l16.1039" class="difflineplus">+      // &lt;nick&gt; :Nickname is already in use</span>
<a href="#l16.1040"></a><span id="l16.1040" class="difflineplus">+      return tryNewNick(this, aMessage);</span>
<a href="#l16.1041"></a><span id="l16.1041" class="difflineplus">+    },</span>
<a href="#l16.1042"></a><span id="l16.1042" class="difflineplus">+    &quot;436&quot;: function(aMessage) { // ERR_NICKCOLLISION</span>
<a href="#l16.1043"></a><span id="l16.1043" class="difflineplus">+      // &lt;nick&gt; :Nickname collision KILL from &lt;user&gt;@&lt;host&gt;</span>
<a href="#l16.1044"></a><span id="l16.1044" class="difflineplus">+      return tryNewNick(this, aMessage);</span>
<a href="#l16.1045"></a><span id="l16.1045" class="difflineplus">+    },</span>
<a href="#l16.1046"></a><span id="l16.1046" class="difflineplus">+    &quot;437&quot;: function(aMessage) { // ERR_UNAVAILRESOURCE</span>
<a href="#l16.1047"></a><span id="l16.1047" class="difflineplus">+      // &lt;nick/channel&gt; :Nick/channel is temporarily unavailable</span>
<a href="#l16.1048"></a><span id="l16.1048" class="difflineplus">+      // XXX</span>
<a href="#l16.1049"></a><span id="l16.1049" class="difflineplus">+      return false;</span>
<a href="#l16.1050"></a><span id="l16.1050" class="difflineplus">+    },</span>
<a href="#l16.1051"></a><span id="l16.1051" class="difflineplus">+    &quot;441&quot;: function(aMessage) { // ERR_USERNOTINCHANNEL</span>
<a href="#l16.1052"></a><span id="l16.1052" class="difflineplus">+      // &lt;nick&gt; &lt;channel&gt; :They aren't on that channel</span>
<a href="#l16.1053"></a><span id="l16.1053" class="difflineplus">+      // XXX</span>
<a href="#l16.1054"></a><span id="l16.1054" class="difflineplus">+      return false;</span>
<a href="#l16.1055"></a><span id="l16.1055" class="difflineplus">+    },</span>
<a href="#l16.1056"></a><span id="l16.1056" class="difflineplus">+    &quot;442&quot;: function(aMessage) { // ERR_NOTONCHANNEL</span>
<a href="#l16.1057"></a><span id="l16.1057" class="difflineplus">+      // &lt;channel&gt; :You're not on that channel</span>
<a href="#l16.1058"></a><span id="l16.1058" class="difflineplus">+      // XXX</span>
<a href="#l16.1059"></a><span id="l16.1059" class="difflineplus">+      return false;</span>
<a href="#l16.1060"></a><span id="l16.1060" class="difflineplus">+    },</span>
<a href="#l16.1061"></a><span id="l16.1061" class="difflineplus">+    &quot;443&quot;: function(aMessage) { // ERR_USERONCHANNEL</span>
<a href="#l16.1062"></a><span id="l16.1062" class="difflineplus">+      // &lt;user&gt; &lt;channel&gt; :is already on channel</span>
<a href="#l16.1063"></a><span id="l16.1063" class="difflineplus">+      // XXX</span>
<a href="#l16.1064"></a><span id="l16.1064" class="difflineplus">+      return false;</span>
<a href="#l16.1065"></a><span id="l16.1065" class="difflineplus">+    },</span>
<a href="#l16.1066"></a><span id="l16.1066" class="difflineplus">+    &quot;444&quot;: function(aMessage) { // ERR_NOLOGIN</span>
<a href="#l16.1067"></a><span id="l16.1067" class="difflineplus">+      // &lt;user&gt; :User not logged in</span>
<a href="#l16.1068"></a><span id="l16.1068" class="difflineplus">+      // XXX</span>
<a href="#l16.1069"></a><span id="l16.1069" class="difflineplus">+      return false;</span>
<a href="#l16.1070"></a><span id="l16.1070" class="difflineplus">+    },</span>
<a href="#l16.1071"></a><span id="l16.1071" class="difflineplus">+    &quot;445&quot;: function(aMessage) { // ERR_SUMMONDISABLED</span>
<a href="#l16.1072"></a><span id="l16.1072" class="difflineplus">+      // :SUMMON has been disabled</span>
<a href="#l16.1073"></a><span id="l16.1073" class="difflineplus">+      // XXX keep track of this and disable UI associated?</span>
<a href="#l16.1074"></a><span id="l16.1074" class="difflineplus">+      return false;</span>
<a href="#l16.1075"></a><span id="l16.1075" class="difflineplus">+    },</span>
<a href="#l16.1076"></a><span id="l16.1076" class="difflineplus">+    &quot;446&quot;: function(aMessage) { // ERR_USERSDISABLED</span>
<a href="#l16.1077"></a><span id="l16.1077" class="difflineplus">+      // :USERS has been disabled</span>
<a href="#l16.1078"></a><span id="l16.1078" class="difflineplus">+      // XXX Disabled all buddy list etc.</span>
<a href="#l16.1079"></a><span id="l16.1079" class="difflineplus">+      return false;</span>
<a href="#l16.1080"></a><span id="l16.1080" class="difflineplus">+    },</span>
<a href="#l16.1081"></a><span id="l16.1081" class="difflineplus">+    &quot;451&quot;: function(aMessage) { // ERR_NOTREGISTERED</span>
<a href="#l16.1082"></a><span id="l16.1082" class="difflineplus">+      // :You have not registered</span>
<a href="#l16.1083"></a><span id="l16.1083" class="difflineplus">+      // XXX We shouldn't get this?</span>
<a href="#l16.1084"></a><span id="l16.1084" class="difflineplus">+      return false;</span>
<a href="#l16.1085"></a><span id="l16.1085" class="difflineplus">+    },</span>
<a href="#l16.1086"></a><span id="l16.1086" class="difflineplus">+    &quot;461&quot;: function(aMessage) { // ERR_NEEDMOREPARAMS</span>
<a href="#l16.1087"></a><span id="l16.1087" class="difflineplus">+      // &lt;command&gt; :Not enough parameters</span>
<a href="#l16.1088"></a><span id="l16.1088" class="difflineplus">+      // XXX</span>
<a href="#l16.1089"></a><span id="l16.1089" class="difflineplus">+      return false;</span>
<a href="#l16.1090"></a><span id="l16.1090" class="difflineplus">+    },</span>
<a href="#l16.1091"></a><span id="l16.1091" class="difflineplus">+    &quot;462&quot;: function(aMessage) { // ERR_ALREADYREGISTERED</span>
<a href="#l16.1092"></a><span id="l16.1092" class="difflineplus">+      // :Unauthorized command (already registered)</span>
<a href="#l16.1093"></a><span id="l16.1093" class="difflineplus">+      // XXX</span>
<a href="#l16.1094"></a><span id="l16.1094" class="difflineplus">+      return false;</span>
<a href="#l16.1095"></a><span id="l16.1095" class="difflineplus">+    },</span>
<a href="#l16.1096"></a><span id="l16.1096" class="difflineplus">+    &quot;463&quot;: function(aMessage) { // ERR_NOPERMFORHOST</span>
<a href="#l16.1097"></a><span id="l16.1097" class="difflineplus">+      // :Your host isn't among the privileged</span>
<a href="#l16.1098"></a><span id="l16.1098" class="difflineplus">+      // XXX</span>
<a href="#l16.1099"></a><span id="l16.1099" class="difflineplus">+      return false;</span>
<a href="#l16.1100"></a><span id="l16.1100" class="difflineplus">+    },</span>
<a href="#l16.1101"></a><span id="l16.1101" class="difflineplus">+    &quot;464&quot;: function(aMessage) { // ERR_PASSWDMISMATCH</span>
<a href="#l16.1102"></a><span id="l16.1102" class="difflineplus">+      // :Password incorrect</span>
<a href="#l16.1103"></a><span id="l16.1103" class="difflineplus">+      // XXX prompt user for new password</span>
<a href="#l16.1104"></a><span id="l16.1104" class="difflineplus">+      return false;</span>
<a href="#l16.1105"></a><span id="l16.1105" class="difflineplus">+    },</span>
<a href="#l16.1106"></a><span id="l16.1106" class="difflineplus">+    &quot;465&quot;: function(aMessage) { // ERR_YOUREBANEDCREEP</span>
<a href="#l16.1107"></a><span id="l16.1107" class="difflineplus">+      // :You are banned from this server</span>
<a href="#l16.1108"></a><span id="l16.1108" class="difflineplus">+      errorMessage(this, aMessage, _(&quot;error.banned&quot;));</span>
<a href="#l16.1109"></a><span id="l16.1109" class="difflineplus">+      this.gotDisconnected(Ci.prplIAccount.ERROR_OTHER_ERROR,</span>
<a href="#l16.1110"></a><span id="l16.1110" class="difflineplus">+                           _(&quot;error.banned&quot;)); // Notify account manager.</span>
<a href="#l16.1111"></a><span id="l16.1111" class="difflineplus">+      return true;</span>
<a href="#l16.1112"></a><span id="l16.1112" class="difflineplus">+    },</span>
<a href="#l16.1113"></a><span id="l16.1113" class="difflineplus">+    &quot;466&quot;: function(aMessage) { // ERR_YOUWILLBEBANNED</span>
<a href="#l16.1114"></a><span id="l16.1114" class="difflineplus">+      return errorMessage(this, aMessage, _(&quot;error.bannedSoon&quot;));</span>
<a href="#l16.1115"></a><span id="l16.1115" class="difflineplus">+    },</span>
<a href="#l16.1116"></a><span id="l16.1116" class="difflineplus">+    &quot;467&quot;: function(aMessage) { // ERR_KEYSET</span>
<a href="#l16.1117"></a><span id="l16.1117" class="difflineplus">+      // &lt;channel&gt; :Channel key already set</span>
<a href="#l16.1118"></a><span id="l16.1118" class="difflineplus">+      // XXX</span>
<a href="#l16.1119"></a><span id="l16.1119" class="difflineplus">+      return false;</span>
<a href="#l16.1120"></a><span id="l16.1120" class="difflineplus">+    },</span>
<a href="#l16.1121"></a><span id="l16.1121" class="difflineplus">+    &quot;471&quot;: function(aMessage) { // ERR_CHANNELISFULL</span>
<a href="#l16.1122"></a><span id="l16.1122" class="difflineplus">+      // &lt;channel&gt; :Cannot join channel (+l)</span>
<a href="#l16.1123"></a><span id="l16.1123" class="difflineplus">+      // XXX</span>
<a href="#l16.1124"></a><span id="l16.1124" class="difflineplus">+      return false;</span>
<a href="#l16.1125"></a><span id="l16.1125" class="difflineplus">+    },</span>
<a href="#l16.1126"></a><span id="l16.1126" class="difflineplus">+    &quot;472&quot;: function(aMessage) { // ERR_UNKNOWNMODE</span>
<a href="#l16.1127"></a><span id="l16.1127" class="difflineplus">+      // &lt;char&gt; :is unknown mode char to me for &lt;channel&gt;</span>
<a href="#l16.1128"></a><span id="l16.1128" class="difflineplus">+      // XXX</span>
<a href="#l16.1129"></a><span id="l16.1129" class="difflineplus">+      return false;</span>
<a href="#l16.1130"></a><span id="l16.1130" class="difflineplus">+    },</span>
<a href="#l16.1131"></a><span id="l16.1131" class="difflineplus">+    &quot;473&quot;: function(aMessage) { // ERR_INVITEONLYCHAN</span>
<a href="#l16.1132"></a><span id="l16.1132" class="difflineplus">+      // &lt;channel&gt; :Cannot join channel (+i)</span>
<a href="#l16.1133"></a><span id="l16.1133" class="difflineplus">+      // XXX</span>
<a href="#l16.1134"></a><span id="l16.1134" class="difflineplus">+      return false;</span>
<a href="#l16.1135"></a><span id="l16.1135" class="difflineplus">+    },</span>
<a href="#l16.1136"></a><span id="l16.1136" class="difflineplus">+    &quot;474&quot;: function(aMessage) { // ERR_BANNEDFROMCHAN</span>
<a href="#l16.1137"></a><span id="l16.1137" class="difflineplus">+      // &lt;channel&gt; :Cannot join channel (+b)</span>
<a href="#l16.1138"></a><span id="l16.1138" class="difflineplus">+      // XXX</span>
<a href="#l16.1139"></a><span id="l16.1139" class="difflineplus">+      return false;</span>
<a href="#l16.1140"></a><span id="l16.1140" class="difflineplus">+    },</span>
<a href="#l16.1141"></a><span id="l16.1141" class="difflineplus">+    &quot;475&quot;: function(aMessage) { // ERR_BADCHANNELKEY</span>
<a href="#l16.1142"></a><span id="l16.1142" class="difflineplus">+      // &lt;channel&gt; :Cannot join channel (+k)</span>
<a href="#l16.1143"></a><span id="l16.1143" class="difflineplus">+      // XXX need to inform user</span>
<a href="#l16.1144"></a><span id="l16.1144" class="difflineplus">+      return false;</span>
<a href="#l16.1145"></a><span id="l16.1145" class="difflineplus">+    },</span>
<a href="#l16.1146"></a><span id="l16.1146" class="difflineplus">+    &quot;476&quot;: function(aMessage) { // ERR_BADCHANMASK</span>
<a href="#l16.1147"></a><span id="l16.1147" class="difflineplus">+      // &lt;channel&gt; :Bad Channel Mask</span>
<a href="#l16.1148"></a><span id="l16.1148" class="difflineplus">+      // XXX</span>
<a href="#l16.1149"></a><span id="l16.1149" class="difflineplus">+      return false;</span>
<a href="#l16.1150"></a><span id="l16.1150" class="difflineplus">+    },</span>
<a href="#l16.1151"></a><span id="l16.1151" class="difflineplus">+    &quot;477&quot;: function(aMessage) { // ERR_NOCHANMODES</span>
<a href="#l16.1152"></a><span id="l16.1152" class="difflineplus">+      // &lt;channel&gt; :Channel doesn't support modes</span>
<a href="#l16.1153"></a><span id="l16.1153" class="difflineplus">+      // XXX</span>
<a href="#l16.1154"></a><span id="l16.1154" class="difflineplus">+      return false;</span>
<a href="#l16.1155"></a><span id="l16.1155" class="difflineplus">+    },</span>
<a href="#l16.1156"></a><span id="l16.1156" class="difflineplus">+    &quot;478&quot;: function(aMessage) { // ERR_BANLISTFULL</span>
<a href="#l16.1157"></a><span id="l16.1157" class="difflineplus">+      // &lt;channel&gt; &lt;char&gt; :Channel list is full</span>
<a href="#l16.1158"></a><span id="l16.1158" class="difflineplus">+      // XXX</span>
<a href="#l16.1159"></a><span id="l16.1159" class="difflineplus">+      return false;</span>
<a href="#l16.1160"></a><span id="l16.1160" class="difflineplus">+    },</span>
<a href="#l16.1161"></a><span id="l16.1161" class="difflineplus">+    &quot;481&quot;: function(aMessage) { // ERR_NOPRIVILEGES</span>
<a href="#l16.1162"></a><span id="l16.1162" class="difflineplus">+      // :Permission Denied- You're not an IRC operator</span>
<a href="#l16.1163"></a><span id="l16.1163" class="difflineplus">+      // XXX ask to auth?</span>
<a href="#l16.1164"></a><span id="l16.1164" class="difflineplus">+      return false;</span>
<a href="#l16.1165"></a><span id="l16.1165" class="difflineplus">+    },</span>
<a href="#l16.1166"></a><span id="l16.1166" class="difflineplus">+    &quot;482&quot;: function(aMessage) { // ERR_CHANOPRIVSNEEDED</span>
<a href="#l16.1167"></a><span id="l16.1167" class="difflineplus">+      // &lt;channel&gt; :You're not channel operator</span>
<a href="#l16.1168"></a><span id="l16.1168" class="difflineplus">+      // XXX ask for auth?</span>
<a href="#l16.1169"></a><span id="l16.1169" class="difflineplus">+      return false;</span>
<a href="#l16.1170"></a><span id="l16.1170" class="difflineplus">+    },</span>
<a href="#l16.1171"></a><span id="l16.1171" class="difflineplus">+    &quot;483&quot;: function(aMessage) { // ERR_CANTKILLSERVER</span>
<a href="#l16.1172"></a><span id="l16.1172" class="difflineplus">+      // :You can't kill a server!</span>
<a href="#l16.1173"></a><span id="l16.1173" class="difflineplus">+      // XXX?</span>
<a href="#l16.1174"></a><span id="l16.1174" class="difflineplus">+      return false;</span>
<a href="#l16.1175"></a><span id="l16.1175" class="difflineplus">+    },</span>
<a href="#l16.1176"></a><span id="l16.1176" class="difflineplus">+    &quot;484&quot;: function(aMessage) { // ERR_RESTRICTED</span>
<a href="#l16.1177"></a><span id="l16.1177" class="difflineplus">+      // :Your connection is restricted!</span>
<a href="#l16.1178"></a><span id="l16.1178" class="difflineplus">+      // Indicates user mode +r</span>
<a href="#l16.1179"></a><span id="l16.1179" class="difflineplus">+      // XXX</span>
<a href="#l16.1180"></a><span id="l16.1180" class="difflineplus">+      return false;</span>
<a href="#l16.1181"></a><span id="l16.1181" class="difflineplus">+    },</span>
<a href="#l16.1182"></a><span id="l16.1182" class="difflineplus">+    &quot;485&quot;: function(aMessage) { // ERR_UNIQOPPRIVSNEEDED</span>
<a href="#l16.1183"></a><span id="l16.1183" class="difflineplus">+      // :You're not the original channel operator</span>
<a href="#l16.1184"></a><span id="l16.1184" class="difflineplus">+      // XXX ask to auth?</span>
<a href="#l16.1185"></a><span id="l16.1185" class="difflineplus">+      return false;</span>
<a href="#l16.1186"></a><span id="l16.1186" class="difflineplus">+    },</span>
<a href="#l16.1187"></a><span id="l16.1187" class="difflineplus">+    &quot;491&quot;: function(aMessage) { // ERR_NOOPERHOST</span>
<a href="#l16.1188"></a><span id="l16.1188" class="difflineplus">+      // :No O-lines for your host</span>
<a href="#l16.1189"></a><span id="l16.1189" class="difflineplus">+      // XXX</span>
<a href="#l16.1190"></a><span id="l16.1190" class="difflineplus">+      return false;</span>
<a href="#l16.1191"></a><span id="l16.1191" class="difflineplus">+    },</span>
<a href="#l16.1192"></a><span id="l16.1192" class="difflineplus">+    &quot;492&quot;: function(aMessage) { //ERR_NOSERVICEHOST</span>
<a href="#l16.1193"></a><span id="l16.1193" class="difflineplus">+      // Non-generic</span>
<a href="#l16.1194"></a><span id="l16.1194" class="difflineplus">+      // XXX</span>
<a href="#l16.1195"></a><span id="l16.1195" class="difflineplus">+      return false;</span>
<a href="#l16.1196"></a><span id="l16.1196" class="difflineplus">+    },</span>
<a href="#l16.1197"></a><span id="l16.1197" class="difflineplus">+    &quot;501&quot;: function(aMessage) { // ERR_UMODEUNKNOWNFLAGS</span>
<a href="#l16.1198"></a><span id="l16.1198" class="difflineplus">+      // :Unknown MODE flag</span>
<a href="#l16.1199"></a><span id="l16.1199" class="difflineplus">+      // XXX could this happen?</span>
<a href="#l16.1200"></a><span id="l16.1200" class="difflineplus">+      return false;</span>
<a href="#l16.1201"></a><span id="l16.1201" class="difflineplus">+    },</span>
<a href="#l16.1202"></a><span id="l16.1202" class="difflineplus">+    &quot;502&quot;: function(aMessage) { // ERR_USERSDONTMATCH</span>
<a href="#l16.1203"></a><span id="l16.1203" class="difflineplus">+      // :Cannot change mode for other users</span>
<a href="#l16.1204"></a><span id="l16.1204" class="difflineplus">+      return errorMessage(this, aMessage, _(&quot;error.mode.wrongUser&quot;));</span>
<a href="#l16.1205"></a><span id="l16.1205" class="difflineplus">+    }</span>
<a href="#l16.1206"></a><span id="l16.1206" class="difflineplus">+  }</span>
<a href="#l16.1207"></a><span id="l16.1207" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/chat/protocols/irc/ircCTCP.jsm</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,278 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l17.6"></a><span id="l17.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l17.7"></a><span id="l17.7" class="difflineplus">+ *</span>
<a href="#l17.8"></a><span id="l17.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l17.10"></a><span id="l17.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+ *</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * License.</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+ *</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineplus">+ *</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l17.24"></a><span id="l17.24" class="difflineplus">+ *</span>
<a href="#l17.25"></a><span id="l17.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l17.26"></a><span id="l17.26" class="difflineplus">+ *</span>
<a href="#l17.27"></a><span id="l17.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l17.28"></a><span id="l17.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l17.29"></a><span id="l17.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l17.31"></a><span id="l17.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l17.36"></a><span id="l17.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l17.37"></a><span id="l17.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l17.38"></a><span id="l17.38" class="difflineplus">+ *</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineplus">+/*</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+ * This implements the Client-to-Client Protocol (CTCP), a subprotocol of IRC.</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+ *   REVISED AND UPDATED CTCP SPECIFICATION</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineplus">+ *     http://www.alien.net.au/irc/ctcp.txt</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineplus">+ */</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineplus">+</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;ircCTCP&quot;, &quot;ctcpBase&quot;];</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineplus">+Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l17.54"></a><span id="l17.54" class="difflineplus">+</span>
<a href="#l17.55"></a><span id="l17.55" class="difflineplus">+function lowLevelDequote(aString) {</span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  // Dequote (low level) / Low Level Quoting</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+  // Replace quote char \020 followed by 0, n, r or \020 with a null, line</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+  // break, carriage return or \020, respectively. Any other character after</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+  // \020 is replaced with itself.</span>
<a href="#l17.60"></a><span id="l17.60" class="difflineplus">+  const replacements = {&quot;0&quot;: &quot;\0&quot;, &quot;n&quot;: &quot;\n&quot;, &quot;r&quot;: &quot;\r&quot;};</span>
<a href="#l17.61"></a><span id="l17.61" class="difflineplus">+  return aString.replace(/\x10./g, function(aStr) {</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineplus">+    return replacements[aStr[1]] || aStr[1];</span>
<a href="#l17.63"></a><span id="l17.63" class="difflineplus">+  });</span>
<a href="#l17.64"></a><span id="l17.64" class="difflineplus">+}</span>
<a href="#l17.65"></a><span id="l17.65" class="difflineplus">+</span>
<a href="#l17.66"></a><span id="l17.66" class="difflineplus">+function highLevelDequote(aString) {</span>
<a href="#l17.67"></a><span id="l17.67" class="difflineplus">+  // Dequote (high level) / CTCP Level Quoting</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineplus">+  // Replace quote char \134 followed by a or \134 with \001 or \134,</span>
<a href="#l17.69"></a><span id="l17.69" class="difflineplus">+  // respectively. Any other character after \134 is replaced with itself.</span>
<a href="#l17.70"></a><span id="l17.70" class="difflineplus">+  return aString.replace(/\x5C./g, function(aStr) {</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineplus">+    return (aStr[1] == &quot;a&quot;) ? &quot;\x01&quot; : aStr[1];</span>
<a href="#l17.72"></a><span id="l17.72" class="difflineplus">+  });</span>
<a href="#l17.73"></a><span id="l17.73" class="difflineplus">+}</span>
<a href="#l17.74"></a><span id="l17.74" class="difflineplus">+</span>
<a href="#l17.75"></a><span id="l17.75" class="difflineplus">+// Split into a CTCP message which is a single command and a single parameter:</span>
<a href="#l17.76"></a><span id="l17.76" class="difflineplus">+//   &lt;command&gt; &quot; &quot; &lt;parameter&gt;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineplus">+// The high level dequote is to unescape \001 in the message content.</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineplus">+function CTCPMessage(aMessage, aRawCTCPMessage) {</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+  let message = aMessage;</span>
<a href="#l17.80"></a><span id="l17.80" class="difflineplus">+  message.ctcp = {};</span>
<a href="#l17.81"></a><span id="l17.81" class="difflineplus">+  message.ctcp.rawMessage = aRawCTCPMessage;</span>
<a href="#l17.82"></a><span id="l17.82" class="difflineplus">+</span>
<a href="#l17.83"></a><span id="l17.83" class="difflineplus">+  let dequotedCTCPMessage = highLevelDequote(message.ctcp.rawMessage);</span>
<a href="#l17.84"></a><span id="l17.84" class="difflineplus">+</span>
<a href="#l17.85"></a><span id="l17.85" class="difflineplus">+  let separator = dequotedCTCPMessage.indexOf(&quot; &quot;);</span>
<a href="#l17.86"></a><span id="l17.86" class="difflineplus">+  // If there's no space, then only a command is given.</span>
<a href="#l17.87"></a><span id="l17.87" class="difflineplus">+  // Do not capitalize the command, case sensitive</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineplus">+  if (separator == -1) {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineplus">+    message.ctcp.command = dequotedCTCPMessage;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+    message.ctcp.param = &quot;&quot;;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  }</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  else {</span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+    message.ctcp.command = dequotedCTCPMessage.slice(0, separator);</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+    message.ctcp.param = dequotedCTCPMessage.slice(separator + 1);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  }</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  return message;</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+}</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+</span>
<a href="#l17.99"></a><span id="l17.99" class="difflineplus">+</span>
<a href="#l17.100"></a><span id="l17.100" class="difflineplus">+// This is the CTCP handler for IRC protocol, it will call each CTCP handler.</span>
<a href="#l17.101"></a><span id="l17.101" class="difflineplus">+var ircCTCP = {</span>
<a href="#l17.102"></a><span id="l17.102" class="difflineplus">+  name: &quot;CTCP&quot;,</span>
<a href="#l17.103"></a><span id="l17.103" class="difflineplus">+  // Slightly above default RFC 2812 priority.</span>
<a href="#l17.104"></a><span id="l17.104" class="difflineplus">+  priority: ircHandlers.HIGH_PRIORITY,</span>
<a href="#l17.105"></a><span id="l17.105" class="difflineplus">+</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineplus">+  // CTCP uses only PRIVMSG and NOTICE commands.</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineplus">+  commands: {</span>
<a href="#l17.108"></a><span id="l17.108" class="difflineplus">+    &quot;PRIVMSG&quot;: ctcpHandleMessage,</span>
<a href="#l17.109"></a><span id="l17.109" class="difflineplus">+    &quot;NOTICE&quot;: ctcpHandleMessage</span>
<a href="#l17.110"></a><span id="l17.110" class="difflineplus">+  }</span>
<a href="#l17.111"></a><span id="l17.111" class="difflineplus">+}</span>
<a href="#l17.112"></a><span id="l17.112" class="difflineplus">+// Parse the message and call all CTCP handlers on the message.</span>
<a href="#l17.113"></a><span id="l17.113" class="difflineplus">+function ctcpHandleMessage(aMessage) {</span>
<a href="#l17.114"></a><span id="l17.114" class="difflineplus">+  // If there are no CTCP handlers, then don't parse the CTCP message.</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineplus">+  if (!ircHandlers.hasCTCPHandlers)</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineplus">+    return false;</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+</span>
<a href="#l17.118"></a><span id="l17.118" class="difflineplus">+  // The raw CTCP message is in the last parameter of the IRC message.</span>
<a href="#l17.119"></a><span id="l17.119" class="difflineplus">+  let ctcpRawMessage = lowLevelDequote(aMessage.params.slice(-1)[0]);</span>
<a href="#l17.120"></a><span id="l17.120" class="difflineplus">+</span>
<a href="#l17.121"></a><span id="l17.121" class="difflineplus">+  // Split the raw message into the multiple CTCP messages and pull out the</span>
<a href="#l17.122"></a><span id="l17.122" class="difflineplus">+  // command and parameters.</span>
<a href="#l17.123"></a><span id="l17.123" class="difflineplus">+  let ctcpMessages = [];</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineplus">+  let otherMessage = ctcpRawMessage.replace(/\x01([^\x01]*)\x01/g,</span>
<a href="#l17.125"></a><span id="l17.125" class="difflineplus">+                                            function(aMatch, aMsg) {</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineplus">+    if (aMsg)</span>
<a href="#l17.127"></a><span id="l17.127" class="difflineplus">+      ctcpMessages.push(new CTCPMessage(aMessage, aMsg));</span>
<a href="#l17.128"></a><span id="l17.128" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l17.129"></a><span id="l17.129" class="difflineplus">+  });</span>
<a href="#l17.130"></a><span id="l17.130" class="difflineplus">+</span>
<a href="#l17.131"></a><span id="l17.131" class="difflineplus">+  // If no CTCP messages were found, return false.</span>
<a href="#l17.132"></a><span id="l17.132" class="difflineplus">+  if (!ctcpMessages.length)</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    return false;</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+  // If there's some message left, send it back through the IRC handlers after</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+  // stripping out the CTCP information. I highly doubt this will ever happen,</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+  // but just in case. ;)</span>
<a href="#l17.138"></a><span id="l17.138" class="difflineplus">+  if (otherMessage) {</span>
<a href="#l17.139"></a><span id="l17.139" class="difflineplus">+    let message = aMessage;</span>
<a href="#l17.140"></a><span id="l17.140" class="difflineplus">+    message.params.pop();</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+    message.params.push(otherMessage);</span>
<a href="#l17.142"></a><span id="l17.142" class="difflineplus">+    ircHandlers.handleMessage(message);</span>
<a href="#l17.143"></a><span id="l17.143" class="difflineplus">+  }</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineplus">+  let handled = true;</span>
<a href="#l17.146"></a><span id="l17.146" class="difflineplus">+  // Loop over each raw CTCP message.</span>
<a href="#l17.147"></a><span id="l17.147" class="difflineplus">+  for each (let message in ctcpMessages)</span>
<a href="#l17.148"></a><span id="l17.148" class="difflineplus">+    handled &amp;= ircHandlers.handleCTCPMessage(this, message);</span>
<a href="#l17.149"></a><span id="l17.149" class="difflineplus">+</span>
<a href="#l17.150"></a><span id="l17.150" class="difflineplus">+  return handled;</span>
<a href="#l17.151"></a><span id="l17.151" class="difflineplus">+}</span>
<a href="#l17.152"></a><span id="l17.152" class="difflineplus">+</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineplus">+// This is the the basic CTCP protocol.</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineplus">+var ctcpBase = {</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+  // Parameters</span>
<a href="#l17.156"></a><span id="l17.156" class="difflineplus">+  name: &quot;CTCP&quot;,</span>
<a href="#l17.157"></a><span id="l17.157" class="difflineplus">+  priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l17.158"></a><span id="l17.158" class="difflineplus">+</span>
<a href="#l17.159"></a><span id="l17.159" class="difflineplus">+  // These represent CTCP commands.</span>
<a href="#l17.160"></a><span id="l17.160" class="difflineplus">+  commands: {</span>
<a href="#l17.161"></a><span id="l17.161" class="difflineplus">+    &quot;ACTION&quot;: function(aMessage) {</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+      // ACTION &lt;text&gt;</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+      // Display message in conversation</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+      this.getConversation(this.isMUCName(aMessage.params[0]) ?</span>
<a href="#l17.165"></a><span id="l17.165" class="difflineplus">+                             aMessage.params[0] : aMessage.nickname)</span>
<a href="#l17.166"></a><span id="l17.166" class="difflineplus">+          .writeMessage(aMessage.nickname || aMessage.source,</span>
<a href="#l17.167"></a><span id="l17.167" class="difflineplus">+                        &quot;/me &quot; + aMessage.ctcp.param,</span>
<a href="#l17.168"></a><span id="l17.168" class="difflineplus">+                        {incoming: true});</span>
<a href="#l17.169"></a><span id="l17.169" class="difflineplus">+      return true;</span>
<a href="#l17.170"></a><span id="l17.170" class="difflineplus">+    },</span>
<a href="#l17.171"></a><span id="l17.171" class="difflineplus">+</span>
<a href="#l17.172"></a><span id="l17.172" class="difflineplus">+    // Used when an error needs to be replied with.</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineplus">+    &quot;ERRMSG&quot;: function(aMessage) {</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+      ERROR(aMessage);</span>
<a href="#l17.175"></a><span id="l17.175" class="difflineplus">+      return false;</span>
<a href="#l17.176"></a><span id="l17.176" class="difflineplus">+    },</span>
<a href="#l17.177"></a><span id="l17.177" class="difflineplus">+</span>
<a href="#l17.178"></a><span id="l17.178" class="difflineplus">+    // Returns the user's full name, and idle time.</span>
<a href="#l17.179"></a><span id="l17.179" class="difflineplus">+    &quot;FINGER&quot;: function(aMessage) false,</span>
<a href="#l17.180"></a><span id="l17.180" class="difflineplus">+</span>
<a href="#l17.181"></a><span id="l17.181" class="difflineplus">+    // Dynamic master index of what a client knows.</span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+    &quot;CLIENTINFO&quot;: function(aMessage) false,</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+    // Used to measure the delay of the IRC network between clients.</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+    &quot;PING&quot;: function(aMessage) {</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+      if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l17.187"></a><span id="l17.187" class="difflineplus">+        // PING timestamp</span>
<a href="#l17.188"></a><span id="l17.188" class="difflineplus">+        // Received PING request, send PING response.</span>
<a href="#l17.189"></a><span id="l17.189" class="difflineplus">+        LOG(&quot;Received PING request from &quot; + aMessage.nickname +</span>
<a href="#l17.190"></a><span id="l17.190" class="difflineplus">+            &quot;. Sending PING response: \&quot;&quot; + aMessage.ctcp.param + &quot;\&quot;.&quot;);</span>
<a href="#l17.191"></a><span id="l17.191" class="difflineplus">+        this.sendCTCPMessage(&quot;PING&quot;, aMessage.ctcp.param, aMessage.nickname,</span>
<a href="#l17.192"></a><span id="l17.192" class="difflineplus">+                              true);</span>
<a href="#l17.193"></a><span id="l17.193" class="difflineplus">+      }</span>
<a href="#l17.194"></a><span id="l17.194" class="difflineplus">+      else {</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineplus">+        // PING timestamp</span>
<a href="#l17.196"></a><span id="l17.196" class="difflineplus">+        // Received PING response, display to the user.</span>
<a href="#l17.197"></a><span id="l17.197" class="difflineplus">+        let sentTime = new Date(aMessage.ctcp.param);</span>
<a href="#l17.198"></a><span id="l17.198" class="difflineplus">+</span>
<a href="#l17.199"></a><span id="l17.199" class="difflineplus">+        // The received timestamp is invalid</span>
<a href="#l17.200"></a><span id="l17.200" class="difflineplus">+        if (isNaN(sentTime)) {</span>
<a href="#l17.201"></a><span id="l17.201" class="difflineplus">+          WARN(aMessage.nickname +</span>
<a href="#l17.202"></a><span id="l17.202" class="difflineplus">+               &quot; returned an invalid timestamp from a CTCP PING: &quot; +</span>
<a href="#l17.203"></a><span id="l17.203" class="difflineplus">+               aMessage.ctcp.param);</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineplus">+          return false;</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+        }</span>
<a href="#l17.206"></a><span id="l17.206" class="difflineplus">+</span>
<a href="#l17.207"></a><span id="l17.207" class="difflineplus">+        // Find the delay in seconds.</span>
<a href="#l17.208"></a><span id="l17.208" class="difflineplus">+        let delay = (Date.now() - sentTime) / 1000;</span>
<a href="#l17.209"></a><span id="l17.209" class="difflineplus">+</span>
<a href="#l17.210"></a><span id="l17.210" class="difflineplus">+        this.getConversation(aMessage.nickname)</span>
<a href="#l17.211"></a><span id="l17.211" class="difflineplus">+            .writeMessage(aMessage.nickname,</span>
<a href="#l17.212"></a><span id="l17.212" class="difflineplus">+                          _(&quot;ctcp.ping.response&quot;, delay, aMessage.nickname),</span>
<a href="#l17.213"></a><span id="l17.213" class="difflineplus">+                          {system: true});</span>
<a href="#l17.214"></a><span id="l17.214" class="difflineplus">+      }</span>
<a href="#l17.215"></a><span id="l17.215" class="difflineplus">+      return true;</span>
<a href="#l17.216"></a><span id="l17.216" class="difflineplus">+    },</span>
<a href="#l17.217"></a><span id="l17.217" class="difflineplus">+</span>
<a href="#l17.218"></a><span id="l17.218" class="difflineplus">+    // An encryption protocol between clients without any known reference.</span>
<a href="#l17.219"></a><span id="l17.219" class="difflineplus">+    &quot;SED&quot;: function(aMessage) false,</span>
<a href="#l17.220"></a><span id="l17.220" class="difflineplus">+</span>
<a href="#l17.221"></a><span id="l17.221" class="difflineplus">+    // Where to obtain a copy of a client.</span>
<a href="#l17.222"></a><span id="l17.222" class="difflineplus">+    &quot;SOURCE&quot;: function(aMessage) false,</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineplus">+</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+    // Gets the local date and time from other clients.</span>
<a href="#l17.225"></a><span id="l17.225" class="difflineplus">+    &quot;TIME&quot;: function(aMessage) {</span>
<a href="#l17.226"></a><span id="l17.226" class="difflineplus">+      if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l17.227"></a><span id="l17.227" class="difflineplus">+        // TIME</span>
<a href="#l17.228"></a><span id="l17.228" class="difflineplus">+        // Received a TIME request, send a human readable response.</span>
<a href="#l17.229"></a><span id="l17.229" class="difflineplus">+        let now = (new Date()).toString();</span>
<a href="#l17.230"></a><span id="l17.230" class="difflineplus">+        LOG(&quot;Received TIME request from &quot; + aMessage.nickname +</span>
<a href="#l17.231"></a><span id="l17.231" class="difflineplus">+            &quot;. Sending TIME response: \&quot;&quot; + now + &quot;\&quot;.&quot;);</span>
<a href="#l17.232"></a><span id="l17.232" class="difflineplus">+        this.sendCTCPMessage(&quot;TIME&quot;, &quot;:&quot; + now, aMessage.nickname, true);</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineplus">+      }</span>
<a href="#l17.234"></a><span id="l17.234" class="difflineplus">+      else {</span>
<a href="#l17.235"></a><span id="l17.235" class="difflineplus">+        // TIME :&lt;human-readable-time-string&gt;</span>
<a href="#l17.236"></a><span id="l17.236" class="difflineplus">+        // Received a TIME reply, display it.</span>
<a href="#l17.237"></a><span id="l17.237" class="difflineplus">+        // Remove the : prefix, if it exists.</span>
<a href="#l17.238"></a><span id="l17.238" class="difflineplus">+        let time =</span>
<a href="#l17.239"></a><span id="l17.239" class="difflineplus">+          new Date(aMessage.ctcp.param.slice(aMessage.ctcp.param[0] == &quot;:&quot;));</span>
<a href="#l17.240"></a><span id="l17.240" class="difflineplus">+</span>
<a href="#l17.241"></a><span id="l17.241" class="difflineplus">+        // The received timestamp is invalid</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineplus">+        if (isNaN(time)) {</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+          WARN(aMessage.nickname +</span>
<a href="#l17.244"></a><span id="l17.244" class="difflineplus">+               &quot; returned an invalid date format from CTCP TIME: &quot; +</span>
<a href="#l17.245"></a><span id="l17.245" class="difflineplus">+               aMessage.ctcp.param);</span>
<a href="#l17.246"></a><span id="l17.246" class="difflineplus">+          return false;</span>
<a href="#l17.247"></a><span id="l17.247" class="difflineplus">+        }</span>
<a href="#l17.248"></a><span id="l17.248" class="difflineplus">+        this.getConversation(aMessage.nickname)</span>
<a href="#l17.249"></a><span id="l17.249" class="difflineplus">+            .writeMessage(aMessage.nickname,</span>
<a href="#l17.250"></a><span id="l17.250" class="difflineplus">+                          _(&quot;ctcp.time.response&quot;, aMessage.nickname,</span>
<a href="#l17.251"></a><span id="l17.251" class="difflineplus">+                            time.toLocaleString()), {system: true});</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineplus">+      }</span>
<a href="#l17.253"></a><span id="l17.253" class="difflineplus">+      return true;</span>
<a href="#l17.254"></a><span id="l17.254" class="difflineplus">+    },</span>
<a href="#l17.255"></a><span id="l17.255" class="difflineplus">+</span>
<a href="#l17.256"></a><span id="l17.256" class="difflineplus">+    // A string set by the user (never the client coder)</span>
<a href="#l17.257"></a><span id="l17.257" class="difflineplus">+    &quot;USERINFO&quot;: function(aMessage) false,</span>
<a href="#l17.258"></a><span id="l17.258" class="difflineplus">+</span>
<a href="#l17.259"></a><span id="l17.259" class="difflineplus">+    // The version and type of the client.</span>
<a href="#l17.260"></a><span id="l17.260" class="difflineplus">+    &quot;VERSION&quot;: function(aMessage) {</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineplus">+      if (aMessage.command == &quot;PRIVMSG&quot;) {</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+        // VERSION</span>
<a href="#l17.263"></a><span id="l17.263" class="difflineplus">+        // Received VERSION request, send VERSION response.</span>
<a href="#l17.264"></a><span id="l17.264" class="difflineplus">+        // Use brandShortName as the client version.</span>
<a href="#l17.265"></a><span id="l17.265" class="difflineplus">+        let version =</span>
<a href="#l17.266"></a><span id="l17.266" class="difflineplus">+          l10nHelper(&quot;chrome://branding/locale/brand.properties&quot;)(&quot;brandShortName&quot;);</span>
<a href="#l17.267"></a><span id="l17.267" class="difflineplus">+        LOG(&quot;Received VERSION request from &quot; + aMessage.nickname +</span>
<a href="#l17.268"></a><span id="l17.268" class="difflineplus">+            &quot;. Sending VERSION response: \&quot;&quot; + version + &quot;\&quot;.&quot;);</span>
<a href="#l17.269"></a><span id="l17.269" class="difflineplus">+        this.sendCTCPMessage(&quot;VERSION&quot;, version, aMessage.nickname, true);</span>
<a href="#l17.270"></a><span id="l17.270" class="difflineplus">+      }</span>
<a href="#l17.271"></a><span id="l17.271" class="difflineplus">+      else if (aMessage.command == &quot;NOTICE&quot; &amp;&amp; aMessage.ctcp.param.length) {</span>
<a href="#l17.272"></a><span id="l17.272" class="difflineplus">+        // VERSION #:#:#</span>
<a href="#l17.273"></a><span id="l17.273" class="difflineplus">+        // Received VERSION response, display to the user.</span>
<a href="#l17.274"></a><span id="l17.274" class="difflineplus">+        let response = _(&quot;ctcp.version&quot;, aMessage.nickname,</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineplus">+                         aMessage.ctcp.param);</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+        this.getConversation(aMessage.nickname)</span>
<a href="#l17.277"></a><span id="l17.277" class="difflineplus">+            .writeMessage(aMessage.nickname, response, {system: true});</span>
<a href="#l17.278"></a><span id="l17.278" class="difflineplus">+      }</span>
<a href="#l17.279"></a><span id="l17.279" class="difflineplus">+      return true;</span>
<a href="#l17.280"></a><span id="l17.280" class="difflineplus">+    }</span>
<a href="#l17.281"></a><span id="l17.281" class="difflineplus">+  }</span>
<a href="#l17.282"></a><span id="l17.282" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/chat/protocols/irc/ircCommands.jsm</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,315 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+ *</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+ *</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+ * License.</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+ *</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+ *</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+ *</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+ *</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+ *</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+// This is to be exported directly onto the IRC prplIProtocol object, directly</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+// implementing the commands field before we register them.</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;commands&quot;];</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+Components.utils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+// Shortcut to get the JavaScript account object.</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+function getAccount(aConv) aConv.wrappedJSObject._account;</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+// Kick a user from a channel</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+// aMsg is &lt;user&gt; [comment]</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+function kickCommand(aMsg, aConv) {</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+  if (!aMsg.length)</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    return false;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+  let params = [aConv.name];</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+  let offset = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+  if (offset != -1) {</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+    params.push(aMsg.slice(0, offset));</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    params.push(aMsg.slice(offset + 1));</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+  }</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+  else</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+    params.push(aMsg);</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+  getAccount(aConv).sendMessage(&quot;KICK&quot;, params);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+  return true;</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+}</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+// Send a message directly to a user.</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+// aMsg is &lt;user&gt; &lt;message&gt;</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+function messageCommand(aMsg, aConv) {</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineplus">+  let sep = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l18.73"></a><span id="l18.73" class="difflineplus">+  // If no space in the message or the space is at the end of the message.</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineplus">+  if (sep == -1 || (sep + 1) == aMsg.length)</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+    return false;</span>
<a href="#l18.76"></a><span id="l18.76" class="difflineplus">+</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  return privateMessage(aConv, aMsg.slice(sep + 1), aMsg.slice(0, sep));</span>
<a href="#l18.78"></a><span id="l18.78" class="difflineplus">+}</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineplus">+</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineplus">+// aAdd is true to add a mode, false to remove a mode.</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+function setMode(aNickname, aConv, aMode, aAdd) {</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+  if (!aNickname.length)</span>
<a href="#l18.83"></a><span id="l18.83" class="difflineplus">+    return false;</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+  // Change the mode for each nick, as separator by spaces.</span>
<a href="#l18.86"></a><span id="l18.86" class="difflineplus">+  return aNickname.split(&quot; &quot;).every(function(aNick)</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+    simpleCommand(aConv, &quot;MODE&quot;,</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineplus">+                  [aConv.name, (aAdd ? &quot;+&quot; : &quot;-&quot;) + aMode, aNick]));</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineplus">+}</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+function actionCommand(aMsg, aConv) {</span>
<a href="#l18.92"></a><span id="l18.92" class="difflineplus">+  if (!ctcpCommand(aConv, aConv.name, &quot;ACTION&quot;, aMsg))</span>
<a href="#l18.93"></a><span id="l18.93" class="difflineplus">+    return false;</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineplus">+</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineplus">+  // Show the action on our conversation.</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+  let account = getAccount(aConv);</span>
<a href="#l18.97"></a><span id="l18.97" class="difflineplus">+  account.getConversation(aConv.name)</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineplus">+         .writeMessage(account._nickname, &quot;/me &quot; + aMsg, {outgoing: true});</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineplus">+  return true;</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+}</span>
<a href="#l18.101"></a><span id="l18.101" class="difflineplus">+</span>
<a href="#l18.102"></a><span id="l18.102" class="difflineplus">+// Helper functions</span>
<a href="#l18.103"></a><span id="l18.103" class="difflineplus">+function privateMessage(aConv, aMsg, aNickname) {</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+  if (!aMsg.length)</span>
<a href="#l18.105"></a><span id="l18.105" class="difflineplus">+    return false;</span>
<a href="#l18.106"></a><span id="l18.106" class="difflineplus">+</span>
<a href="#l18.107"></a><span id="l18.107" class="difflineplus">+  // This will open the conversation, send and display the text</span>
<a href="#l18.108"></a><span id="l18.108" class="difflineplus">+  getAccount(aConv).getConversation(aNickname).sendMsg(aMsg);</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineplus">+  return true;</span>
<a href="#l18.110"></a><span id="l18.110" class="difflineplus">+}</span>
<a href="#l18.111"></a><span id="l18.111" class="difflineplus">+</span>
<a href="#l18.112"></a><span id="l18.112" class="difflineplus">+// This will send a command to the server, if no parameters are given, it is</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineplus">+// assumed that the command takes no parameters. aParams can be either a single</span>
<a href="#l18.114"></a><span id="l18.114" class="difflineplus">+// string or an array of parameters.</span>
<a href="#l18.115"></a><span id="l18.115" class="difflineplus">+function simpleCommand(aConv, aCommand, aParams) {</span>
<a href="#l18.116"></a><span id="l18.116" class="difflineplus">+  if (!aParams || !aParams.length)</span>
<a href="#l18.117"></a><span id="l18.117" class="difflineplus">+    getAccount(aConv).sendMessage(aCommand);</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineplus">+  else</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineplus">+    getAccount(aConv).sendMessage(aCommand, aParams);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineplus">+  return true;</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+}</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+function ctcpCommand(aConv, aTarget, aCommand, aMsg) {</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+  if (!aTarget.length)</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+    return false;</span>
<a href="#l18.126"></a><span id="l18.126" class="difflineplus">+</span>
<a href="#l18.127"></a><span id="l18.127" class="difflineplus">+  getAccount(aConv).sendCTCPMessage(aCommand, aMsg, aTarget, false);</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineplus">+  return true;</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+}</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+</span>
<a href="#l18.131"></a><span id="l18.131" class="difflineplus">+var commands = [</span>
<a href="#l18.132"></a><span id="l18.132" class="difflineplus">+  {</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineplus">+    name: &quot;action&quot;,</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineplus">+    get helpString() _(&quot;command.action&quot;, &quot;action&quot;),</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+    run: actionCommand</span>
<a href="#l18.136"></a><span id="l18.136" class="difflineplus">+  },</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineplus">+  {</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineplus">+    name: &quot;ctcp&quot;,</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+    get helpString() _(&quot;command.ctcp&quot;, &quot;ctcp&quot;),</span>
<a href="#l18.140"></a><span id="l18.140" class="difflineplus">+    run: function(aMsg, aConv) {</span>
<a href="#l18.141"></a><span id="l18.141" class="difflineplus">+      let separator = aMsg.indexOf(&quot; &quot;);</span>
<a href="#l18.142"></a><span id="l18.142" class="difflineplus">+      if (separator == -1 &amp;&amp; (separator + 1) != aMsg.length)</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineplus">+        return false;</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineplus">+</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineplus">+      return ctcpCommand(aConv, aMsg.slice(0, separator),</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+                         aMsg.slice(separator + 1));</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+    }</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+  },</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+  {</span>
<a href="#l18.150"></a><span id="l18.150" class="difflineplus">+    name: &quot;chanserv&quot;,</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineplus">+    get helpString() _(&quot;command.chanserv&quot;, &quot;chanserv&quot;),</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineplus">+    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;ChanServ&quot;)</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+  },</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+  {</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+    name: &quot;deop&quot;,</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    get helpString() _(&quot;command.deop&quot;, &quot;deop&quot;),</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineplus">+    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;o&quot;, false)</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineplus">+  },</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineplus">+  {</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+    name: &quot;devoice&quot;,</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+    get helpString() _(&quot;command.devoice&quot;, &quot;devoice&quot;),</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;v&quot;, false)</span>
<a href="#l18.163"></a><span id="l18.163" class="difflineplus">+  },</span>
<a href="#l18.164"></a><span id="l18.164" class="difflineplus">+  {</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineplus">+    name: &quot;invite&quot;,</span>
<a href="#l18.166"></a><span id="l18.166" class="difflineplus">+    get helpString() _(&quot;command.invite&quot;, &quot;invite&quot;),</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;INVITE&quot;, aMsg)</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+  },</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+  {</span>
<a href="#l18.170"></a><span id="l18.170" class="difflineplus">+    name: &quot;j&quot;,</span>
<a href="#l18.171"></a><span id="l18.171" class="difflineplus">+    get helpString() _(&quot;command.join&quot;, &quot;j&quot;),</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;JOIN&quot;, aMsg)</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineplus">+  },</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+  {</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+    name: &quot;join&quot;,</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineplus">+    get helpString() _(&quot;command.join&quot;, &quot;join&quot;),</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;JOIN&quot;, aMsg)</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+  },</span>
<a href="#l18.179"></a><span id="l18.179" class="difflineplus">+  {</span>
<a href="#l18.180"></a><span id="l18.180" class="difflineplus">+    name: &quot;kick&quot;,</span>
<a href="#l18.181"></a><span id="l18.181" class="difflineplus">+    get helpString() _(&quot;command.kick&quot;, &quot;kick&quot;),</span>
<a href="#l18.182"></a><span id="l18.182" class="difflineplus">+    run: kickCommand</span>
<a href="#l18.183"></a><span id="l18.183" class="difflineplus">+  },</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineplus">+  {</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineplus">+    name: &quot;list&quot;,</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+    get helpString() _(&quot;command.list&quot;, &quot;list&quot;),</span>
<a href="#l18.187"></a><span id="l18.187" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;LIST&quot;)</span>
<a href="#l18.188"></a><span id="l18.188" class="difflineplus">+  },</span>
<a href="#l18.189"></a><span id="l18.189" class="difflineplus">+  {</span>
<a href="#l18.190"></a><span id="l18.190" class="difflineplus">+    name: &quot;me&quot;,</span>
<a href="#l18.191"></a><span id="l18.191" class="difflineplus">+    get helpString() _(&quot;command.action&quot;, &quot;me&quot;),</span>
<a href="#l18.192"></a><span id="l18.192" class="difflineplus">+    run: actionCommand</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineplus">+  },</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+  {</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+    name: &quot;memoserv&quot;,</span>
<a href="#l18.196"></a><span id="l18.196" class="difflineplus">+    get helpString() _(&quot;command.memoserv&quot;, &quot;memoserv&quot;),</span>
<a href="#l18.197"></a><span id="l18.197" class="difflineplus">+    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;MemoServ&quot;)</span>
<a href="#l18.198"></a><span id="l18.198" class="difflineplus">+  },</span>
<a href="#l18.199"></a><span id="l18.199" class="difflineplus">+  {</span>
<a href="#l18.200"></a><span id="l18.200" class="difflineplus">+    name: &quot;mode&quot;,</span>
<a href="#l18.201"></a><span id="l18.201" class="difflineplus">+    get helpString() _(&quot;command.mode&quot;, &quot;mode&quot;),</span>
<a href="#l18.202"></a><span id="l18.202" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;MODE&quot;, aMsg)</span>
<a href="#l18.203"></a><span id="l18.203" class="difflineplus">+  },</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineplus">+  {</span>
<a href="#l18.205"></a><span id="l18.205" class="difflineplus">+    name: &quot;msg&quot;,</span>
<a href="#l18.206"></a><span id="l18.206" class="difflineplus">+    get helpString() _(&quot;command.msg&quot;, &quot;msg&quot;),</span>
<a href="#l18.207"></a><span id="l18.207" class="difflineplus">+    run: messageCommand</span>
<a href="#l18.208"></a><span id="l18.208" class="difflineplus">+  },</span>
<a href="#l18.209"></a><span id="l18.209" class="difflineplus">+  {</span>
<a href="#l18.210"></a><span id="l18.210" class="difflineplus">+    name: &quot;nick&quot;,</span>
<a href="#l18.211"></a><span id="l18.211" class="difflineplus">+    get helpString() _(&quot;command.nick&quot;, &quot;nick&quot;),</span>
<a href="#l18.212"></a><span id="l18.212" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;NICK&quot;, aMsg)</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineplus">+  },</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+  {</span>
<a href="#l18.215"></a><span id="l18.215" class="difflineplus">+    name: &quot;nickserv&quot;,</span>
<a href="#l18.216"></a><span id="l18.216" class="difflineplus">+    get helpString() _(&quot;command.nickserv&quot;, &quot;nickserv&quot;),</span>
<a href="#l18.217"></a><span id="l18.217" class="difflineplus">+    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;NickServ&quot;)</span>
<a href="#l18.218"></a><span id="l18.218" class="difflineplus">+  },</span>
<a href="#l18.219"></a><span id="l18.219" class="difflineplus">+  {</span>
<a href="#l18.220"></a><span id="l18.220" class="difflineplus">+    name: &quot;notice&quot;,</span>
<a href="#l18.221"></a><span id="l18.221" class="difflineplus">+    get helpString() _(&quot;command.notice&quot;, &quot;notice&quot;),</span>
<a href="#l18.222"></a><span id="l18.222" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;NOTICE&quot;, aMsg)</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineplus">+  },</span>
<a href="#l18.224"></a><span id="l18.224" class="difflineplus">+  {</span>
<a href="#l18.225"></a><span id="l18.225" class="difflineplus">+    name: &quot;op&quot;,</span>
<a href="#l18.226"></a><span id="l18.226" class="difflineplus">+    get helpString() _(&quot;command.op&quot;, &quot;op&quot;),</span>
<a href="#l18.227"></a><span id="l18.227" class="difflineplus">+    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;o&quot;, true)</span>
<a href="#l18.228"></a><span id="l18.228" class="difflineplus">+  },</span>
<a href="#l18.229"></a><span id="l18.229" class="difflineplus">+  {</span>
<a href="#l18.230"></a><span id="l18.230" class="difflineplus">+    name: &quot;operwall&quot;,</span>
<a href="#l18.231"></a><span id="l18.231" class="difflineplus">+    get helpString() _(&quot;command.wallops&quot;, &quot;operwall&quot;),</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;WALLOPS&quot;, aMsg)</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+  },</span>
<a href="#l18.234"></a><span id="l18.234" class="difflineplus">+  {</span>
<a href="#l18.235"></a><span id="l18.235" class="difflineplus">+    name: &quot;operserv&quot;,</span>
<a href="#l18.236"></a><span id="l18.236" class="difflineplus">+    get helpString() _(&quot;command.operserv&quot;, &quot;operserv&quot;),</span>
<a href="#l18.237"></a><span id="l18.237" class="difflineplus">+    run: function(aMsg, aConv) privateMessage(aConv, aMsg, &quot;OperServ&quot;)</span>
<a href="#l18.238"></a><span id="l18.238" class="difflineplus">+  },</span>
<a href="#l18.239"></a><span id="l18.239" class="difflineplus">+  {</span>
<a href="#l18.240"></a><span id="l18.240" class="difflineplus">+    name: &quot;part&quot;,</span>
<a href="#l18.241"></a><span id="l18.241" class="difflineplus">+    get helpString() _(&quot;command.part&quot;, &quot;part&quot;),</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineplus">+    run: function (aMsg, aConv) {</span>
<a href="#l18.243"></a><span id="l18.243" class="difflineplus">+      aConv.wrappedJSObject.part(aMsg);</span>
<a href="#l18.244"></a><span id="l18.244" class="difflineplus">+      return true;</span>
<a href="#l18.245"></a><span id="l18.245" class="difflineplus">+    }</span>
<a href="#l18.246"></a><span id="l18.246" class="difflineplus">+  },</span>
<a href="#l18.247"></a><span id="l18.247" class="difflineplus">+  {</span>
<a href="#l18.248"></a><span id="l18.248" class="difflineplus">+    name: &quot;ping&quot;,</span>
<a href="#l18.249"></a><span id="l18.249" class="difflineplus">+    get helpString() _(&quot;command.ping&quot;, &quot;ping&quot;),</span>
<a href="#l18.250"></a><span id="l18.250" class="difflineplus">+    run: function(aMsg, aConv) ctcpCommand(aConv, aMsg, &quot;PING&quot;)</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineplus">+  },</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineplus">+  {</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+    name: &quot;query&quot;,</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+    get helpString() _(&quot;command.msg&quot;, &quot;query&quot;),</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+    run: messageCommand</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+  },</span>
<a href="#l18.257"></a><span id="l18.257" class="difflineplus">+  {</span>
<a href="#l18.258"></a><span id="l18.258" class="difflineplus">+    name: &quot;quit&quot;,</span>
<a href="#l18.259"></a><span id="l18.259" class="difflineplus">+    get helpString() _(&quot;command.quit&quot;, &quot;quit&quot;),</span>
<a href="#l18.260"></a><span id="l18.260" class="difflineplus">+    run: function(aMsg, aConv) {</span>
<a href="#l18.261"></a><span id="l18.261" class="difflineplus">+      getAccount(aConv).quit(aMsg);</span>
<a href="#l18.262"></a><span id="l18.262" class="difflineplus">+      return true;</span>
<a href="#l18.263"></a><span id="l18.263" class="difflineplus">+    }</span>
<a href="#l18.264"></a><span id="l18.264" class="difflineplus">+  },</span>
<a href="#l18.265"></a><span id="l18.265" class="difflineplus">+  {</span>
<a href="#l18.266"></a><span id="l18.266" class="difflineplus">+    name: &quot;quote&quot;,</span>
<a href="#l18.267"></a><span id="l18.267" class="difflineplus">+    get helpString() _(&quot;command.quote&quot;, &quot;quote&quot;),</span>
<a href="#l18.268"></a><span id="l18.268" class="difflineplus">+    run: function(aMsg, aConv) {</span>
<a href="#l18.269"></a><span id="l18.269" class="difflineplus">+      if (!aMsg.length)</span>
<a href="#l18.270"></a><span id="l18.270" class="difflineplus">+        return false;</span>
<a href="#l18.271"></a><span id="l18.271" class="difflineplus">+</span>
<a href="#l18.272"></a><span id="l18.272" class="difflineplus">+      getAccount(aConv).sendRawMessage(aMsg);</span>
<a href="#l18.273"></a><span id="l18.273" class="difflineplus">+      return true;</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineplus">+    }</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+  },</span>
<a href="#l18.276"></a><span id="l18.276" class="difflineplus">+  {</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineplus">+    name: &quot;remove&quot;,</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineplus">+    get helpString() _(&quot;command.kick&quot;, &quot;remove&quot;),</span>
<a href="#l18.279"></a><span id="l18.279" class="difflineplus">+    run: kickCommand</span>
<a href="#l18.280"></a><span id="l18.280" class="difflineplus">+  },</span>
<a href="#l18.281"></a><span id="l18.281" class="difflineplus">+  {</span>
<a href="#l18.282"></a><span id="l18.282" class="difflineplus">+    name: &quot;time&quot;,</span>
<a href="#l18.283"></a><span id="l18.283" class="difflineplus">+    get helpString() _(&quot;command.time&quot;, &quot;time&quot;),</span>
<a href="#l18.284"></a><span id="l18.284" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;TIME&quot;)</span>
<a href="#l18.285"></a><span id="l18.285" class="difflineplus">+  },</span>
<a href="#l18.286"></a><span id="l18.286" class="difflineplus">+  {</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineplus">+    name: &quot;topic&quot;,</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineplus">+    get helpString() _(&quot;command.topic&quot;, &quot;topic&quot;),</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineplus">+    run: function(aMsg, aConv) {</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+      aConv.topic = aMsg;</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+      return true;</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+    }</span>
<a href="#l18.293"></a><span id="l18.293" class="difflineplus">+  },</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineplus">+  {</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+    name: &quot;umode&quot;,</span>
<a href="#l18.296"></a><span id="l18.296" class="difflineplus">+    get helpString() _(&quot;command.umode&quot;, &quot;umode&quot;),</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;MODE&quot;, aMsg)</span>
<a href="#l18.298"></a><span id="l18.298" class="difflineplus">+  },</span>
<a href="#l18.299"></a><span id="l18.299" class="difflineplus">+  {</span>
<a href="#l18.300"></a><span id="l18.300" class="difflineplus">+    name: &quot;version&quot;,</span>
<a href="#l18.301"></a><span id="l18.301" class="difflineplus">+    get helpString() _(&quot;command.version&quot;, &quot;version&quot;),</span>
<a href="#l18.302"></a><span id="l18.302" class="difflineplus">+    run: function(aMsg, aConv) ctcpCommand(aConv, aMsg, &quot;VERSION&quot;)</span>
<a href="#l18.303"></a><span id="l18.303" class="difflineplus">+  },</span>
<a href="#l18.304"></a><span id="l18.304" class="difflineplus">+  {</span>
<a href="#l18.305"></a><span id="l18.305" class="difflineplus">+    name: &quot;voice&quot;,</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineplus">+    get helpString() _(&quot;command.voice&quot;, &quot;voice&quot;),</span>
<a href="#l18.307"></a><span id="l18.307" class="difflineplus">+    run: function(aMsg, aConv) setMode(aMsg, aConv, &quot;v&quot;, true)</span>
<a href="#l18.308"></a><span id="l18.308" class="difflineplus">+  },</span>
<a href="#l18.309"></a><span id="l18.309" class="difflineplus">+  {</span>
<a href="#l18.310"></a><span id="l18.310" class="difflineplus">+    name: &quot;wallops&quot;,</span>
<a href="#l18.311"></a><span id="l18.311" class="difflineplus">+    get helpString() _(&quot;command.wallops&quot;, &quot;wallops&quot;),</span>
<a href="#l18.312"></a><span id="l18.312" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;WALLOPS&quot;, aMsg)</span>
<a href="#l18.313"></a><span id="l18.313" class="difflineplus">+  },</span>
<a href="#l18.314"></a><span id="l18.314" class="difflineplus">+  {</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineplus">+    name: &quot;whowas&quot;,</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+    get helpString() _(&quot;command.whowas&quot;, &quot;whowas&quot;),</span>
<a href="#l18.317"></a><span id="l18.317" class="difflineplus">+    run: function(aMsg, aConv) simpleCommand(aConv, &quot;WHOWAS&quot;, aMsg)</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineplus">+  }</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">new file mode 100644</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineminus">--- /dev/null</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineplus">+++ b/chat/protocols/irc/ircDCC.jsm</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineat">@@ -0,0 +1,100 @@</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l19.6"></a><span id="l19.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l19.7"></a><span id="l19.7" class="difflineplus">+ *</span>
<a href="#l19.8"></a><span id="l19.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l19.9"></a><span id="l19.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l19.10"></a><span id="l19.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+ *</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+ * License.</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineplus">+ *</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+ *</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineplus">+ *</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l19.26"></a><span id="l19.26" class="difflineplus">+ *</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l19.29"></a><span id="l19.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l19.30"></a><span id="l19.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l19.31"></a><span id="l19.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l19.32"></a><span id="l19.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+ *</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineplus">+</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineplus">+/*</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+ * This contains an implementation of the Direct Client-to-Client (DCC)</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+ * protocol.</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+ *   A description of the DCC protocol</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+ *     http://www.irchelp.org/irchelp/rfc/dccspec.html</span>
<a href="#l19.46"></a><span id="l19.46" class="difflineplus">+ */</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineplus">+</span>
<a href="#l19.48"></a><span id="l19.48" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;ctcpDCC&quot;, &quot;dccBase&quot;];</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineplus">+</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l19.54"></a><span id="l19.54" class="difflineplus">+Cu.import(&quot;resource:///modules/jsProtoHelper.jsm&quot;);</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineplus">+</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+// Parse a CTCP message into a DCC message. A DCC message is a CTCP message of</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+// the form:</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+//   DCC &lt;type&gt; &lt;argument&gt; &lt;address&gt; &lt;port&gt; [&lt;size&gt;]</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+function DCCMessage(aMessage) {</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineplus">+  let message = aMessage;</span>
<a href="#l19.61"></a><span id="l19.61" class="difflineplus">+  let params = message.ctcp.param.split(&quot; &quot;);</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineplus">+  if (params.length &lt; 4) {</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+    ERROR(&quot;Not enough DCC parameters:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+    return null;</span>
<a href="#l19.65"></a><span id="l19.65" class="difflineplus">+  }</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineplus">+  try {</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+    // Address, port and size should be treated as unsigned long, unsigned short</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+    // and unsigned long, respectively. The protocol is designed to handle</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+    // further arguements, if necessary.</span>
<a href="#l19.71"></a><span id="l19.71" class="difflineplus">+    message.ctcp.dcc = {</span>
<a href="#l19.72"></a><span id="l19.72" class="difflineplus">+      type: params[0],</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineplus">+      argument: params[1],</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+      address: new Number(params[2]),</span>
<a href="#l19.75"></a><span id="l19.75" class="difflineplus">+      port: new Number(params[3]),</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineplus">+      size: params.length == 5 ? new Number(params[4]) : null,</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+      furtherArguments: params.length &gt; 5 ? params.slice(5) : []</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineplus">+    };</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+  } catch (e) {</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+    ERROR(&quot;Error parsing DCC parameters:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+    return null;</span>
<a href="#l19.82"></a><span id="l19.82" class="difflineplus">+  }</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineplus">+</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+  return message;</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineplus">+}</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineplus">+// This is the DCC handler for CTCP, it will call each DCC handler.</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+var ctcpDCC = {</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineplus">+  name: &quot;DCC&quot;,</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+  // Slightly above default CTCP priority.</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineplus">+  priority: ircHandlers.HIGH_PRIORITY + 10,</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+  commands: {</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+    // Handle a DCC message by parsing the message and executing any handlers.</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+    &quot;DCC&quot;: function(aMessage) {</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineplus">+      // If there are no DCC handlers, then don't parse the DCC message.</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineplus">+      if (!ircHandlers.hasDCCHandlers)</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineplus">+        return false;</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineplus">+</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+      // Parse the message and attempt to handle it.</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineplus">+      return ircHandlers.handleMessage(this, DCCMessage(aMessage));</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+    }</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+  }</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">new file mode 100644</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineminus">--- /dev/null</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineplus">+++ b/chat/protocols/irc/ircHandlers.jsm</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineat">@@ -0,0 +1,153 @@</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l20.6"></a><span id="l20.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l20.7"></a><span id="l20.7" class="difflineplus">+ *</span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+ *</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+ * License.</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+ *</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+ *</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+ *</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+ *</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+ *</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;ircHandlers&quot;];</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l20.44"></a><span id="l20.44" class="difflineplus">+</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineplus">+Cu.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l20.47"></a><span id="l20.47" class="difflineplus">+</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineplus">+var ircHandlers = {</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  /*</span>
<a href="#l20.50"></a><span id="l20.50" class="difflineplus">+   * Object to hold the IRC handlers, each handler is an object that implements:</span>
<a href="#l20.51"></a><span id="l20.51" class="difflineplus">+   *   name        The display name of the handler.</span>
<a href="#l20.52"></a><span id="l20.52" class="difflineplus">+   *   priority    The priority of the handler (0 is default, positive is</span>
<a href="#l20.53"></a><span id="l20.53" class="difflineplus">+   *               higher priority)</span>
<a href="#l20.54"></a><span id="l20.54" class="difflineplus">+   *   commands    An object of commands, each command is a function which</span>
<a href="#l20.55"></a><span id="l20.55" class="difflineplus">+   *               accepts a message object and has 'this' bound to the account</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineplus">+   *               object. It should return whether the message was successfully</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+   *               handler or not.</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineplus">+   */</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+  _ircHandlers: [],</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+  // Object to hold the ISUPPORT handlers, expects the same fields as</span>
<a href="#l20.61"></a><span id="l20.61" class="difflineplus">+  // _ircHandlers.</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineplus">+  _isupportHandlers: [],</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+  // Object to hold the CTCP handlers, expects the same fields as _ircHandlers.</span>
<a href="#l20.64"></a><span id="l20.64" class="difflineplus">+  _ctcpHandlers: [],</span>
<a href="#l20.65"></a><span id="l20.65" class="difflineplus">+  // Object to hold the DCC handlers, expects the same fields as _ircHandlers.</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+  _dccHandlers: [],</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineplus">+</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  _registerHandler: function(aArray, aHandler) {</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineplus">+    // Protect ourselves from adding broken handlers.</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+    if (!(&quot;commands&quot; in aHandler)) {</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+      ERROR(&quot;IRC handlers must have a \&quot;commands\&quot; property: &quot; + aHandler.name);</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+      return false;</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+    }</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineplus">+</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+    aArray.push(aHandler);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineplus">+    aArray.sort(function(a, b) b.priority - a.priority);</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+    return true;</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineplus">+  },</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineplus">+</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+  _unregisterHandler: function(aArray, aHandler) {</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+    aArray = aArray.filter(function(h) h.name != aHandler.name);</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+  },</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineplus">+</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+  registerHandler: function(aHandler)</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineplus">+    this._registerHandler(this._ircHandlers, aHandler),</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineplus">+  unregisterHandler: function(aHandler)</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+    this._unregisterHandler(this._ircHandlers, aHandler),</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+  registerISUPPORTHandler: function(aHandler)</span>
<a href="#l20.90"></a><span id="l20.90" class="difflineplus">+    this._registerHandler(this._isupportHandlers, aHandler),</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineplus">+  unregisterISUPPORTHandler: function(aHandler)</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineplus">+    this._unregisterHandler(this._isupportHandlers, aHandler),</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineplus">+</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+  registerCTCPHandler: function(aHandler)</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+    this._registerHandler(this._ctcpHandlers, aHandler),</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+  unregisterCTCPHandler: function(aHandler)</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+    this._unregisterHandler(this._ctcpHandlers, aHandler),</span>
<a href="#l20.98"></a><span id="l20.98" class="difflineplus">+</span>
<a href="#l20.99"></a><span id="l20.99" class="difflineplus">+  registerDCCHandler: function(aHandler)</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineplus">+    this._registerHandler(this._dccHandlers, aHandler),</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineplus">+  unregisterDCCHandler: function(aHandler)</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineplus">+    this._unregisterHandler(this._dccHandlers, aHandler),</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineplus">+</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineplus">+  // Handle a message based on a set of handlers.</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineplus">+  _handleMessage: function(aHandlers, aAccount, aMessage, aCommand) {</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+    // Loop over each handler and run the command until one handles the message.</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+    for each (let handler in aHandlers) {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+      try {</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+        // Attempt to execute the command, by checking if the handler has the</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+        // command.</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+        // Parse the command with the JavaScript account object as &quot;this&quot;.</span>
<a href="#l20.112"></a><span id="l20.112" class="difflineplus">+        if (hasOwnProperty(handler.commands, aCommand) &amp;&amp;</span>
<a href="#l20.113"></a><span id="l20.113" class="difflineplus">+            handler.commands[aCommand].call(aAccount, aMessage)) {</span>
<a href="#l20.114"></a><span id="l20.114" class="difflineplus">+          DEBUG(JSON.stringify(aMessage));</span>
<a href="#l20.115"></a><span id="l20.115" class="difflineplus">+          return true;</span>
<a href="#l20.116"></a><span id="l20.116" class="difflineplus">+        }</span>
<a href="#l20.117"></a><span id="l20.117" class="difflineplus">+      } catch (e) {</span>
<a href="#l20.118"></a><span id="l20.118" class="difflineplus">+        // We want to catch an error here because one of our handlers are broken,</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineplus">+        // if we don't catch the error, the whole IRC plug-in will die.</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineplus">+        ERROR(&quot;Error running command &quot; + aCommand + &quot; with handler &quot; +</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineplus">+              handler.name + &quot;:\n&quot; + JSON.stringify(aMessage));</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+        Cu.reportError(e);</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+      }</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+    }</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineplus">+</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineplus">+    return false;</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+  },</span>
<a href="#l20.128"></a><span id="l20.128" class="difflineplus">+</span>
<a href="#l20.129"></a><span id="l20.129" class="difflineplus">+  handleMessage: function(aAccount, aMessage)</span>
<a href="#l20.130"></a><span id="l20.130" class="difflineplus">+    this._handleMessage(this._ircHandlers, aAccount, aMessage,</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineplus">+                        aMessage.command.toUpperCase()),</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineplus">+</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineplus">+  handleISUPPORTMessage: function(aAccount, aMessage)</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+    this._handleMessage(this._isupportHandlers, aAccount, aMessage,</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+                        aMessage.isupport.parameter),</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+  // aMessage is a CTCP Message, which inherits from an IRC Message.</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+  handleCTCPMessage: function(aAccount, aMessage)</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineplus">+    this._handleMessage(this._ctcpHandlers, aAccount, aMessage,</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineplus">+                        aMessage.ctcp.command),</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineplus">+</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+  // aMessage is a DCC Message, which inherits from a CTCP Message.</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+  handleDCCPMessage: function(aAccount, aMessage)</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+    this._handleMessage(this._dccHandlers, aAccount, aMessage,</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+                        aMessage.ctcp.dcc.type),</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+  // Checking if handlers exist.</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+  get hasHandlers() this._ircHandlers.length &gt; 0,</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+  get hasISUPPORTHandlers() this._isupportHandlers.length &gt; 0,</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+  get hasCTCPHandlers() this._ctcpHandlers.length &gt; 0,</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineplus">+  get hasDCCHandlers() this._dccHandlers.length &gt; 0,</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+</span>
<a href="#l20.153"></a><span id="l20.153" class="difflineplus">+  // Some constant priorities.</span>
<a href="#l20.154"></a><span id="l20.154" class="difflineplus">+  get LOW_PRIORITY() -100,</span>
<a href="#l20.155"></a><span id="l20.155" class="difflineplus">+  get DEFAULT_PRIORITY() 0,</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineplus">+  get HIGH_PRIORITY() 100</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">new file mode 100644</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineminus">--- /dev/null</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineplus">+++ b/chat/protocols/irc/ircISUPPORT.jsm</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineat">@@ -0,0 +1,255 @@</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l21.6"></a><span id="l21.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l21.7"></a><span id="l21.7" class="difflineplus">+ *</span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+ *</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+ * License.</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+ *</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineplus">+ *</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+ *</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+ *</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+ *</span>
<a href="#l21.39"></a><span id="l21.39" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l21.40"></a><span id="l21.40" class="difflineplus">+</span>
<a href="#l21.41"></a><span id="l21.41" class="difflineplus">+/*</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineplus">+ * This implements the ISUPPORT parameters for the 005 numeric to allow a server</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+ * to notify a client of what capabilities it supports.</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+ *   The 005 numeric</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineplus">+ *     http://www.irc.org/tech_docs/005.html</span>
<a href="#l21.46"></a><span id="l21.46" class="difflineplus">+ *   RFC Drafts: IRC RPL_ISUPPORT Numeric Definition</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineplus">+ *     http://tools.ietf.org/html/draft-brocklesby-irc-isupport-03</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineplus">+ *     http://tools.ietf.org/html/draft-hardy-irc-isupport-00</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineplus">+ */</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;ircISUPPORT&quot;];</span>
<a href="#l21.52"></a><span id="l21.52" class="difflineplus">+</span>
<a href="#l21.53"></a><span id="l21.53" class="difflineplus">+const Cu = Components.utils;</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineplus">+</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+Cu.import(&quot;resource:///modules/ircHandlers.jsm&quot;);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+Cu.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+function isupportMessage(aMessage, aToken) {</span>
<a href="#l21.59"></a><span id="l21.59" class="difflineplus">+  let message = aMessage;</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineplus">+  message.isupport = {};</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+  message.isupport.useDefault = aToken[0] == &quot;-&quot;;</span>
<a href="#l21.62"></a><span id="l21.62" class="difflineplus">+</span>
<a href="#l21.63"></a><span id="l21.63" class="difflineplus">+  let token = message.isupport.useDefault ? aToken.slice(1) : aToken;</span>
<a href="#l21.64"></a><span id="l21.64" class="difflineplus">+  [message.isupport.parameter, message.isupport.value] = token.split(&quot;=&quot;);</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+</span>
<a href="#l21.66"></a><span id="l21.66" class="difflineplus">+  return message;</span>
<a href="#l21.67"></a><span id="l21.67" class="difflineplus">+}</span>
<a href="#l21.68"></a><span id="l21.68" class="difflineplus">+</span>
<a href="#l21.69"></a><span id="l21.69" class="difflineplus">+var ircISUPPORT = {</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineplus">+  name: &quot;ISUPPORT&quot;,</span>
<a href="#l21.71"></a><span id="l21.71" class="difflineplus">+  // Slightly above default RFC 2812 priority.</span>
<a href="#l21.72"></a><span id="l21.72" class="difflineplus">+  priority: ircHandlers.DEFAULT_PRIORITY + 10,</span>
<a href="#l21.73"></a><span id="l21.73" class="difflineplus">+</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineplus">+  commands: {</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+    // RPL_ISUPPORT</span>
<a href="#l21.76"></a><span id="l21.76" class="difflineplus">+    // [-]&lt;parameter&gt;[=&lt;value&gt;] :are supported by this server</span>
<a href="#l21.77"></a><span id="l21.77" class="difflineplus">+    &quot;005&quot;: function(aMessage) {</span>
<a href="#l21.78"></a><span id="l21.78" class="difflineplus">+      if (!(&quot;ISUPPORT&quot; in this))</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineplus">+        this.ISUPPORT = {};</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+</span>
<a href="#l21.81"></a><span id="l21.81" class="difflineplus">+      // Seperate the ISUPPORT parameters.</span>
<a href="#l21.82"></a><span id="l21.82" class="difflineplus">+      let tokens = aMessage.params[1].split(&quot; &quot;);</span>
<a href="#l21.83"></a><span id="l21.83" class="difflineplus">+</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+      let handled = true;</span>
<a href="#l21.85"></a><span id="l21.85" class="difflineplus">+      for (let token in tokens) {</span>
<a href="#l21.86"></a><span id="l21.86" class="difflineplus">+        let message = isupportMessage(aMessage, token);</span>
<a href="#l21.87"></a><span id="l21.87" class="difflineplus">+        handled &amp;= ircHandlers.handleISUPPORTMessage(this, message);</span>
<a href="#l21.88"></a><span id="l21.88" class="difflineplus">+      }</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineplus">+</span>
<a href="#l21.90"></a><span id="l21.90" class="difflineplus">+      return handled;</span>
<a href="#l21.91"></a><span id="l21.91" class="difflineplus">+    }</span>
<a href="#l21.92"></a><span id="l21.92" class="difflineplus">+  }</span>
<a href="#l21.93"></a><span id="l21.93" class="difflineplus">+}</span>
<a href="#l21.94"></a><span id="l21.94" class="difflineplus">+</span>
<a href="#l21.95"></a><span id="l21.95" class="difflineplus">+function setSimpleNumber(aAccount, aField, aMessage, aDefaultValue) {</span>
<a href="#l21.96"></a><span id="l21.96" class="difflineplus">+  let value =</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+    aMessage.isupport.value ? new Number(aMessage.isupport.value) : null;</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineplus">+  aAccount[aField] = (value &amp;&amp; !isNaN(value)) ? value : aDefaultValue;</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+  return true;</span>
<a href="#l21.100"></a><span id="l21.100" class="difflineplus">+}</span>
<a href="#l21.101"></a><span id="l21.101" class="difflineplus">+</span>
<a href="#l21.102"></a><span id="l21.102" class="difflineplus">+// Generates a function that will set the ASCII range of aStart-aEnd as the</span>
<a href="#l21.103"></a><span id="l21.103" class="difflineplus">+// uppercase of (aStart-aEnd) + 0x20.</span>
<a href="#l21.104"></a><span id="l21.104" class="difflineplus">+function generateNormalize(aStart, aEnd) {</span>
<a href="#l21.105"></a><span id="l21.105" class="difflineplus">+  const exp = new RegExp(&quot;[\\x&quot; + aStart.toString(16) + &quot;-\\x&quot; +</span>
<a href="#l21.106"></a><span id="l21.106" class="difflineplus">+                         aEnd.toString(16) + &quot;]&quot;, &quot;g&quot;);</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineplus">+  return function(aStr, aRemoveStatus) {</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+    let str = aStr;</span>
<a href="#l21.109"></a><span id="l21.109" class="difflineplus">+    if (aPrefixes &amp;&amp; aPrefixes.indexOf(aStr[0]) != -1)</span>
<a href="#l21.110"></a><span id="l21.110" class="difflineplus">+      str = str.slice(1);</span>
<a href="#l21.111"></a><span id="l21.111" class="difflineplus">+      return str.replace(exp,</span>
<a href="#l21.112"></a><span id="l21.112" class="difflineplus">+                         function(c) String.fromCharCode(c.charCodeAt(0) + 0x20));</span>
<a href="#l21.113"></a><span id="l21.113" class="difflineplus">+  };</span>
<a href="#l21.114"></a><span id="l21.114" class="difflineplus">+}</span>
<a href="#l21.115"></a><span id="l21.115" class="difflineplus">+</span>
<a href="#l21.116"></a><span id="l21.116" class="difflineplus">+var isupportBase = {</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineplus">+  name: &quot;ISUPPORT&quot;,</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+  description: &quot;IRC RPL_ISUPPORT Numeric Definition&quot;,</span>
<a href="#l21.119"></a><span id="l21.119" class="difflineplus">+  priority: ircHandlers.DEFAULT_PRIORITY,</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineplus">+</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  commands: {</span>
<a href="#l21.122"></a><span id="l21.122" class="difflineplus">+    &quot;CASEMAPPING&quot;: function(aMessage) {</span>
<a href="#l21.123"></a><span id="l21.123" class="difflineplus">+      // CASEMAPPING=&lt;mapping&gt;</span>
<a href="#l21.124"></a><span id="l21.124" class="difflineplus">+      // Allows the server to specify which method it uses to compare equality</span>
<a href="#l21.125"></a><span id="l21.125" class="difflineplus">+      // of case-insensitive strings.</span>
<a href="#l21.126"></a><span id="l21.126" class="difflineplus">+</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineplus">+      // By default, use rfc1459 type case mapping.</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+      let value = aMessage.isupport.useDefault ?</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+        &quot;rfc1493&quot; : aMessage.isupport.value;</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+</span>
<a href="#l21.131"></a><span id="l21.131" class="difflineplus">+      // Set the normalize function of the account to use the proper case</span>
<a href="#l21.132"></a><span id="l21.132" class="difflineplus">+      // mapping.</span>
<a href="#l21.133"></a><span id="l21.133" class="difflineplus">+      if (value == &quot;ascii&quot;) {</span>
<a href="#l21.134"></a><span id="l21.134" class="difflineplus">+        // The ASCII characters 97 to 122 (decimal) are the lower-case</span>
<a href="#l21.135"></a><span id="l21.135" class="difflineplus">+        // characters of ASCII 65 to 90 (decimal).</span>
<a href="#l21.136"></a><span id="l21.136" class="difflineplus">+        this.normalize = generateNormalize(65, 90);</span>
<a href="#l21.137"></a><span id="l21.137" class="difflineplus">+      }</span>
<a href="#l21.138"></a><span id="l21.138" class="difflineplus">+      else if (value == &quot;rfc1493&quot;) {</span>
<a href="#l21.139"></a><span id="l21.139" class="difflineplus">+        // The ASCII characters 97 to 126 (decimal) are the lower-case</span>
<a href="#l21.140"></a><span id="l21.140" class="difflineplus">+        // characters of ASCII 65 to 94 (decimal).</span>
<a href="#l21.141"></a><span id="l21.141" class="difflineplus">+        this.normalize = generateNormalize(65, 94);</span>
<a href="#l21.142"></a><span id="l21.142" class="difflineplus">+      }</span>
<a href="#l21.143"></a><span id="l21.143" class="difflineplus">+      else if (value == &quot;strict-rfc1459&quot;) {</span>
<a href="#l21.144"></a><span id="l21.144" class="difflineplus">+        // The ASCII characters 97 to 125 (decimal) are the lower-case</span>
<a href="#l21.145"></a><span id="l21.145" class="difflineplus">+        // characters of ASCII 65 to 93 (decimal).</span>
<a href="#l21.146"></a><span id="l21.146" class="difflineplus">+        this.normalize = generateNormalize(65, 93);</span>
<a href="#l21.147"></a><span id="l21.147" class="difflineplus">+      }</span>
<a href="#l21.148"></a><span id="l21.148" class="difflineplus">+      return true;</span>
<a href="#l21.149"></a><span id="l21.149" class="difflineplus">+    },</span>
<a href="#l21.150"></a><span id="l21.150" class="difflineplus">+    &quot;CHANLIMIT&quot;: function(aMessage) {</span>
<a href="#l21.151"></a><span id="l21.151" class="difflineplus">+      // CHANLIMIT=&lt;prefix&gt;:&lt;number&gt;[,&lt;prefix&gt;:&lt;number&gt;]*</span>
<a href="#l21.152"></a><span id="l21.152" class="difflineplus">+      // Note that each &lt;prefix&gt; can actually contain multiple prefixes, this</span>
<a href="#l21.153"></a><span id="l21.153" class="difflineplus">+      // means the sum of those prefixes is given.</span>
<a href="#l21.154"></a><span id="l21.154" class="difflineplus">+      this.maxChannels = {};</span>
<a href="#l21.155"></a><span id="l21.155" class="difflineplus">+</span>
<a href="#l21.156"></a><span id="l21.156" class="difflineplus">+      let pairs = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l21.157"></a><span id="l21.157" class="difflineplus">+      for each (let pair in pairs) {</span>
<a href="#l21.158"></a><span id="l21.158" class="difflineplus">+        let [prefixes, num] = pair.split(&quot;:&quot;);</span>
<a href="#l21.159"></a><span id="l21.159" class="difflineplus">+        this.maxChannels[prefix] = num;</span>
<a href="#l21.160"></a><span id="l21.160" class="difflineplus">+      }</span>
<a href="#l21.161"></a><span id="l21.161" class="difflineplus">+      return true;</span>
<a href="#l21.162"></a><span id="l21.162" class="difflineplus">+    },</span>
<a href="#l21.163"></a><span id="l21.163" class="difflineplus">+    &quot;CHANMODES&quot;: function(aMessage) false,</span>
<a href="#l21.164"></a><span id="l21.164" class="difflineplus">+    &quot;CHANNELLEN&quot;: function(aMessage) {</span>
<a href="#l21.165"></a><span id="l21.165" class="difflineplus">+      // CHANNELLEN=&lt;number&gt;</span>
<a href="#l21.166"></a><span id="l21.166" class="difflineplus">+      // Default is from RFC 1493.</span>
<a href="#l21.167"></a><span id="l21.167" class="difflineplus">+      return setSimpleNumber(this, &quot;maxChannelLength&quot;, aMessage, 200);</span>
<a href="#l21.168"></a><span id="l21.168" class="difflineplus">+    },</span>
<a href="#l21.169"></a><span id="l21.169" class="difflineplus">+    &quot;CHANTYPES&quot;: function(aMessage) {</span>
<a href="#l21.170"></a><span id="l21.170" class="difflineplus">+      // CHANTYPES=[&lt;channel prefix&gt;]*</span>
<a href="#l21.171"></a><span id="l21.171" class="difflineplus">+      let value = aMessage.isupport.useDefault ? &quot;#&amp;&quot; : aMessage.isupport.value;</span>
<a href="#l21.172"></a><span id="l21.172" class="difflineplus">+      this.channelPrefixes = value.split(&quot;&quot;);</span>
<a href="#l21.173"></a><span id="l21.173" class="difflineplus">+      return true;</span>
<a href="#l21.174"></a><span id="l21.174" class="difflineplus">+    },</span>
<a href="#l21.175"></a><span id="l21.175" class="difflineplus">+    &quot;EXCEPTS&quot;: function(aMessage) false,</span>
<a href="#l21.176"></a><span id="l21.176" class="difflineplus">+    &quot;IDCHAN&quot;: function(aMessage) false,</span>
<a href="#l21.177"></a><span id="l21.177" class="difflineplus">+    &quot;INVEX&quot;: function(aMessage) false,</span>
<a href="#l21.178"></a><span id="l21.178" class="difflineplus">+    &quot;KICKLEN&quot;: function(aMessage) {</span>
<a href="#l21.179"></a><span id="l21.179" class="difflineplus">+      // KICKLEN=&lt;number&gt;</span>
<a href="#l21.180"></a><span id="l21.180" class="difflineplus">+      // Default value is Infinity.</span>
<a href="#l21.181"></a><span id="l21.181" class="difflineplus">+      return setSimpleNumber(this, &quot;maxKickLength&quot;, aMessage, Infinity);</span>
<a href="#l21.182"></a><span id="l21.182" class="difflineplus">+    },</span>
<a href="#l21.183"></a><span id="l21.183" class="difflineplus">+    &quot;MAXLIST&quot;: function(aMessage) false,</span>
<a href="#l21.184"></a><span id="l21.184" class="difflineplus">+    &quot;MODES&quot;: function(aMessage) false,</span>
<a href="#l21.185"></a><span id="l21.185" class="difflineplus">+    &quot;NETWORK&quot;: function(aMessage) false,</span>
<a href="#l21.186"></a><span id="l21.186" class="difflineplus">+    &quot;NICKLEN&quot;: function(aMessage) {</span>
<a href="#l21.187"></a><span id="l21.187" class="difflineplus">+      // NICKLEN=&lt;number&gt;</span>
<a href="#l21.188"></a><span id="l21.188" class="difflineplus">+      // Default value is from RFC 1493.</span>
<a href="#l21.189"></a><span id="l21.189" class="difflineplus">+      return setSimpleNumber(this, &quot;maxNicknameLength&quot;, aMessage, 9);</span>
<a href="#l21.190"></a><span id="l21.190" class="difflineplus">+    },</span>
<a href="#l21.191"></a><span id="l21.191" class="difflineplus">+    &quot;PREFIX&quot;: function(aMessage) {</span>
<a href="#l21.192"></a><span id="l21.192" class="difflineplus">+      // PREFIX=[(&lt;mode character&gt;*)&lt;prefix&gt;*]</span>
<a href="#l21.193"></a><span id="l21.193" class="difflineplus">+      let value =</span>
<a href="#l21.194"></a><span id="l21.194" class="difflineplus">+        aMessage.isupport.useDefault ? &quot;(ov)@+&quot; : aMessage.isupport.value;</span>
<a href="#l21.195"></a><span id="l21.195" class="difflineplus">+</span>
<a href="#l21.196"></a><span id="l21.196" class="difflineplus">+      this.userPrefixToModeMap = {};</span>
<a href="#l21.197"></a><span id="l21.197" class="difflineplus">+      // A null value specifier indicates that no prefixes are supported.</span>
<a href="#l21.198"></a><span id="l21.198" class="difflineplus">+      if (!value.length)</span>
<a href="#l21.199"></a><span id="l21.199" class="difflineplus">+        return true;</span>
<a href="#l21.200"></a><span id="l21.200" class="difflineplus">+</span>
<a href="#l21.201"></a><span id="l21.201" class="difflineplus">+      let matches = /\(([a-z]*)\)(.*)/i.exec(value);</span>
<a href="#l21.202"></a><span id="l21.202" class="difflineplus">+      if (!matches) {</span>
<a href="#l21.203"></a><span id="l21.203" class="difflineplus">+        // The pattern doesn't match.</span>
<a href="#l21.204"></a><span id="l21.204" class="difflineplus">+        WARN(&quot;Invalid PREFIX value: &quot; + value);</span>
<a href="#l21.205"></a><span id="l21.205" class="difflineplus">+        return false;</span>
<a href="#l21.206"></a><span id="l21.206" class="difflineplus">+      }</span>
<a href="#l21.207"></a><span id="l21.207" class="difflineplus">+      if (matches[1].length != matches[2].length) {</span>
<a href="#l21.208"></a><span id="l21.208" class="difflineplus">+        WARN(&quot;Invalid PREFIX value, does not provide one-to-one mapping:&quot; +</span>
<a href="#l21.209"></a><span id="l21.209" class="difflineplus">+             value);</span>
<a href="#l21.210"></a><span id="l21.210" class="difflineplus">+        return false;</span>
<a href="#l21.211"></a><span id="l21.211" class="difflineplus">+      }</span>
<a href="#l21.212"></a><span id="l21.212" class="difflineplus">+</span>
<a href="#l21.213"></a><span id="l21.213" class="difflineplus">+      for (let i = 0; i &lt; matches[2].length; i++)</span>
<a href="#l21.214"></a><span id="l21.214" class="difflineplus">+        this.userPrefixToModeMap[matches[2][i]] = matches[1][i];</span>
<a href="#l21.215"></a><span id="l21.215" class="difflineplus">+      return true;</span>
<a href="#l21.216"></a><span id="l21.216" class="difflineplus">+    },</span>
<a href="#l21.217"></a><span id="l21.217" class="difflineplus">+    &quot;SAFELIST&quot;: function(aMessage) false,</span>
<a href="#l21.218"></a><span id="l21.218" class="difflineplus">+    &quot;STATUSMSG&quot;: function(aMessage) false,</span>
<a href="#l21.219"></a><span id="l21.219" class="difflineplus">+    &quot;STD&quot;: function(aMessage) {</span>
<a href="#l21.220"></a><span id="l21.220" class="difflineplus">+      // This was never updated as the RFC was never formalized.</span>
<a href="#l21.221"></a><span id="l21.221" class="difflineplus">+      if (aMessage.isupport.value != &quot;rfcnnnn&quot;)</span>
<a href="#l21.222"></a><span id="l21.222" class="difflineplus">+        WARN(&quot;Unknown ISUPPORT numeric form: &quot; + aMessage.isupport.value);</span>
<a href="#l21.223"></a><span id="l21.223" class="difflineplus">+      return true;</span>
<a href="#l21.224"></a><span id="l21.224" class="difflineplus">+    },</span>
<a href="#l21.225"></a><span id="l21.225" class="difflineplus">+    &quot;TARGMAX&quot;: function(aMessage) {</span>
<a href="#l21.226"></a><span id="l21.226" class="difflineplus">+      // TARGMAX=&lt;command&gt;:&lt;max targets&gt;[,&lt;command&gt;:&lt;max targets&gt;]*</span>
<a href="#l21.227"></a><span id="l21.227" class="difflineplus">+      if (aMessage.isupport.useDefault) {</span>
<a href="#l21.228"></a><span id="l21.228" class="difflineplus">+        this.maxTargets = 1;</span>
<a href="#l21.229"></a><span id="l21.229" class="difflineplus">+        return true;</span>
<a href="#l21.230"></a><span id="l21.230" class="difflineplus">+      }</span>
<a href="#l21.231"></a><span id="l21.231" class="difflineplus">+</span>
<a href="#l21.232"></a><span id="l21.232" class="difflineplus">+      this.maxTargets = {};</span>
<a href="#l21.233"></a><span id="l21.233" class="difflineplus">+      let commands = aMessage.isupport.value.split(&quot;,&quot;);</span>
<a href="#l21.234"></a><span id="l21.234" class="difflineplus">+      for (let i = 0; i &lt; commands.length; i++) {</span>
<a href="#l21.235"></a><span id="l21.235" class="difflineplus">+        let [command, limitStr] = commands[i].split(&quot;=&quot;);</span>
<a href="#l21.236"></a><span id="l21.236" class="difflineplus">+        let limit = limitStr ? new Number(limit) : Infinity;</span>
<a href="#l21.237"></a><span id="l21.237" class="difflineplus">+        if (isNaN(limit)) {</span>
<a href="#l21.238"></a><span id="l21.238" class="difflineplus">+          WARN(&quot;Invalid maximum number of targets: &quot; + limitStr);</span>
<a href="#l21.239"></a><span id="l21.239" class="difflineplus">+          continue;</span>
<a href="#l21.240"></a><span id="l21.240" class="difflineplus">+        }</span>
<a href="#l21.241"></a><span id="l21.241" class="difflineplus">+        this.maxTargets[command] = limit;</span>
<a href="#l21.242"></a><span id="l21.242" class="difflineplus">+      }</span>
<a href="#l21.243"></a><span id="l21.243" class="difflineplus">+      return true;</span>
<a href="#l21.244"></a><span id="l21.244" class="difflineplus">+    },</span>
<a href="#l21.245"></a><span id="l21.245" class="difflineplus">+    &quot;TOPICLEN&quot;: function(aMessage) {</span>
<a href="#l21.246"></a><span id="l21.246" class="difflineplus">+      // TOPICLEN=&lt;number&gt;</span>
<a href="#l21.247"></a><span id="l21.247" class="difflineplus">+      // Default value is Infinity.</span>
<a href="#l21.248"></a><span id="l21.248" class="difflineplus">+      return setSimpleNumber(this, &quot;maxTopicLength&quot;, aMessage, Infinity);</span>
<a href="#l21.249"></a><span id="l21.249" class="difflineplus">+    },</span>
<a href="#l21.250"></a><span id="l21.250" class="difflineplus">+</span>
<a href="#l21.251"></a><span id="l21.251" class="difflineplus">+    // The following are considered &quot;obsolete&quot; by the RFC, but are still in use.</span>
<a href="#l21.252"></a><span id="l21.252" class="difflineplus">+    &quot;CHARSET&quot;: function(aMessage) false,</span>
<a href="#l21.253"></a><span id="l21.253" class="difflineplus">+    &quot;MAXBANS&quot;: function(aMessage) false,</span>
<a href="#l21.254"></a><span id="l21.254" class="difflineplus">+    &quot;MAXCHANNELS&quot;: function(aMessage) false,</span>
<a href="#l21.255"></a><span id="l21.255" class="difflineplus">+    &quot;MAXTARGETS&quot;: function(aMessage) {</span>
<a href="#l21.256"></a><span id="l21.256" class="difflineplus">+      return setSimpleNumber(this, &quot;maxTargets&quot;, aMessage, 1);</span>
<a href="#l21.257"></a><span id="l21.257" class="difflineplus">+    }</span>
<a href="#l21.258"></a><span id="l21.258" class="difflineplus">+  }</span>
<a href="#l21.259"></a><span id="l21.259" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/chat/protocols/irc/ircUtils.jsm</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,207 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+ *</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+ *</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+ * License.</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+ *</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+ * The Original Code is Instantbird.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+ *</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+ * Patrick Cloke &lt;clokep@gmail.com&gt;.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineplus">+ *</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineplus">+ *   Mark &quot;Mook&quot; Yen &lt;Mook.moz+Instantbird.code@gmail.com&gt;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineplus">+ *</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+ *</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineplus">+</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+const EXPORTED_SYMBOLS = [&quot;DEBUG&quot;, &quot;LOG&quot;, &quot;WARN&quot;, &quot;ERROR&quot;, &quot;_&quot;,</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineplus">+                          &quot;ctcpFormatToText&quot;, &quot;ctcpFormatToHTML&quot;];</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineplus">+const {classes: Cc, interfaces: Ci} = Components;</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineplus">+</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineplus">+Components.utils.import(&quot;resource:///modules/imXPCOMUtils.jsm&quot;);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+initLogModule(&quot;irc&quot;, this);</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineplus">+</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;_&quot;, function()</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineplus">+  l10nHelper(&quot;chrome://chat/locale/irc.properties&quot;)</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineplus">+);</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+XPCOMUtils.defineLazyGetter(this, &quot;TXTToHTML&quot;, function() {</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineplus">+  let cs = Cc[&quot;@mozilla.org/txttohtmlconv;1&quot;].getService(Ci.mozITXTToHTMLConv);</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineplus">+  return function(aTXT) cs.scanTXT(aTXT, cs.kEntities);</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineplus">+});</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineplus">+</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineplus">+// The supported formatting control characters, as described as deprecated in</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineplus">+// http://www.invlogic.com/irc/ctcp.html#3.11</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineplus">+const CTCP_TAGS = {&quot;\x02&quot;: &quot;b&quot;, // \002, ^B, Bold</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineplus">+                   &quot;\x16&quot;: &quot;i&quot;, // \026, ^V, Reverse or Inverse (Italics)</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineplus">+                   &quot;\x1F&quot;: &quot;u&quot;, // \037, ^_, Underline</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+                   &quot;\x03&quot;: mIRCColoring, // \003, ^C, Coloring</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+                   &quot;\x0F&quot;: null}; // \017, ^O, Clear all formatting</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+// Generate an expression that will search for any of the control characters.</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+const CTCP_TAGS_STRING = &quot;[&quot; + Object.keys(CTCP_TAGS).join(&quot;&quot;) + &quot;]&quot;;</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+const CTCP_TAGS_EXP = new RegExp(CTCP_TAGS_STRING);</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineplus">+const CTCP_TAGS_EXP_GLOBAL = new RegExp(CTCP_TAGS_STRING, &quot;g&quot;);</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineplus">+// Remove all CTCP formatting characters.</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+function ctcpFormatToText(aString) aString.replace(CTCP_TAGS_EXP_GLOBAL, &quot;&quot;)</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineplus">+</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineplus">+// Close the tags in the opposite order they were opened.</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineplus">+function closeStack(aStack)</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+  aStack.reverse().map(function(aTag) &quot;&lt;/&quot; + aTag.split(&quot; &quot;, 1) + &quot;&gt;&quot;).join(&quot;&quot;)</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineplus">+/**</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineplus">+ * Convert a string from CTCP escaped formatting to HTML markup.</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+ * @param aString the string with CTCP formatting to parse</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineplus">+ * @return The HTML output string</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineplus">+ */</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineplus">+function ctcpFormatToHTML(aString) {</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineplus">+  let next,</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineplus">+      stack = [],</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineplus">+      input = TXTToHTML(aString),</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineplus">+      output = &quot;&quot;,</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineplus">+      length;</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineplus">+</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineplus">+  while ((next = CTCP_TAGS_EXP.exec(input))) {</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+    if (next.index &gt; 0)</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineplus">+      output += input.substr(0, next.index);</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineplus">+    length = 1;</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineplus">+    let tag = CTCP_TAGS[input[next.index]];</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+    if (tag === null) {</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineplus">+      // Clear all formatting.</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineplus">+      output += closeStack(stack);</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineplus">+      stack = [];</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineplus">+    }</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+    else if (typeof tag == &quot;function&quot;) {</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineplus">+      [stack, output, length] = tag(stack, input.substr(next.index), output);</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+    }</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineplus">+    else {</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+      let offset = stack.indexOf(tag);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+      if (offset == -1) {</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+        // Tag not found; open new tag.</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineplus">+        output += &quot;&lt;&quot; + tag + &quot;&gt;&quot;;</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineplus">+        stack.push(tag);</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineplus">+      }</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+      else {</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineplus">+        // Tag found; close existing tag (and all tags after it).</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+        output += closeStack(stack.slice(offset));</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineplus">+        // Reopen the tags that came after it.</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineplus">+        stack.slice(offset + 1)</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+             .forEach(function(aTag) output += &quot;&lt;&quot; + aTag + &quot;&gt;&quot;);</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineplus">+        // Remove the tag from the stack.</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineplus">+        stack.splice(offset, 1);</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+      }</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineplus">+    }</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+    // Avoid infinite loops, if.</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineplus">+    length = (length &lt;= 0) ? 1 : length;</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineplus">+    // Skip to after the last match.</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+    input = input.substr(next.index + length);</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineplus">+  }</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineplus">+  // Return unmatched bits and close any open tags at the end.</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineplus">+  return output + input + closeStack(stack);</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineplus">+}</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineplus">+// mIRC colors are defined at http://www.mirc.com/colors.html.</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineplus">+// This expression matches \003&lt;one or two digits&gt;[,&lt;one or two digits&gt;].</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+const M_IRC_COLORS_EXP = /^\x03(?:(\d\d?)(?:,(\d\d?))?)?/;</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+const M_IRC_COLOR_MAP = {</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+  &quot;0&quot;: &quot;white&quot;,</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+  &quot;1&quot;: &quot;black&quot;,</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineplus">+  &quot;2&quot;: &quot;navy&quot;, // blue (navy)</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineplus">+  &quot;3&quot;: &quot;green&quot;,</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineplus">+  &quot;4&quot;: &quot;red&quot;,</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineplus">+  &quot;5&quot;: &quot;maroon&quot;, // brown (maroon)</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineplus">+  &quot;6&quot;: &quot;purple&quot;,</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineplus">+  &quot;7&quot;: &quot;orange&quot;, // orange (olive)</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+  &quot;8&quot;: &quot;yellow&quot;,</span>
<a href="#l22.144"></a><span id="l22.144" class="difflineplus">+  &quot;9&quot;: &quot;lime&quot;, // light green (lime)</span>
<a href="#l22.145"></a><span id="l22.145" class="difflineplus">+  &quot;10&quot;: &quot;teal&quot;, // teal (a green/blue cyan)</span>
<a href="#l22.146"></a><span id="l22.146" class="difflineplus">+  &quot;11&quot;: &quot;aqua&quot;, // light cyan (cyan) (aqua)</span>
<a href="#l22.147"></a><span id="l22.147" class="difflineplus">+  &quot;12&quot;: &quot;blue&quot;, // light blue (royal)&quot;,</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineplus">+  &quot;13&quot;: &quot;fuchsia&quot;, // pink (light purple) (fuchsia)</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+  &quot;14&quot;: &quot;grey&quot;,</span>
<a href="#l22.150"></a><span id="l22.150" class="difflineplus">+  &quot;15&quot;: &quot;silver&quot;, // light grey (silver)</span>
<a href="#l22.151"></a><span id="l22.151" class="difflineplus">+  &quot;99&quot;: &quot;transparent&quot;</span>
<a href="#l22.152"></a><span id="l22.152" class="difflineplus">+};</span>
<a href="#l22.153"></a><span id="l22.153" class="difflineplus">+</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineplus">+function mIRCColoring(aStack, aInput, aOutput) {</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+  function getColor(aKey) {</span>
<a href="#l22.156"></a><span id="l22.156" class="difflineplus">+    let key = aKey;</span>
<a href="#l22.157"></a><span id="l22.157" class="difflineplus">+    // Single digit numbers can (must?) be prefixed by a zero.</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineplus">+    if (key.length == 2 &amp;&amp; key[0] == &quot;0&quot;)</span>
<a href="#l22.159"></a><span id="l22.159" class="difflineplus">+      key = key[1];</span>
<a href="#l22.160"></a><span id="l22.160" class="difflineplus">+</span>
<a href="#l22.161"></a><span id="l22.161" class="difflineplus">+    if (M_IRC_COLOR_MAP.hasOwnProperty(key))</span>
<a href="#l22.162"></a><span id="l22.162" class="difflineplus">+      return M_IRC_COLOR_MAP[key];</span>
<a href="#l22.163"></a><span id="l22.163" class="difflineplus">+</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineplus">+    return null;</span>
<a href="#l22.165"></a><span id="l22.165" class="difflineplus">+  }</span>
<a href="#l22.166"></a><span id="l22.166" class="difflineplus">+</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineplus">+  let matches,</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+      stack = aStack,</span>
<a href="#l22.169"></a><span id="l22.169" class="difflineplus">+      input = aInput,</span>
<a href="#l22.170"></a><span id="l22.170" class="difflineplus">+      output = aOutput,</span>
<a href="#l22.171"></a><span id="l22.171" class="difflineplus">+      length = 1;</span>
<a href="#l22.172"></a><span id="l22.172" class="difflineplus">+</span>
<a href="#l22.173"></a><span id="l22.173" class="difflineplus">+  if ((matches = M_IRC_COLORS_EXP.exec(input))) {</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineplus">+    let format = [&quot;font&quot;];</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+</span>
<a href="#l22.176"></a><span id="l22.176" class="difflineplus">+    if (!matches[1]) {</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineplus">+      // Find the first font tag.</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+      let offset = stack.map(function(aTag) aTag.indexOf(&quot;font&quot;) == 0)</span>
<a href="#l22.179"></a><span id="l22.179" class="difflineplus">+                        .indexOf(true);</span>
<a href="#l22.180"></a><span id="l22.180" class="difflineplus">+</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineplus">+      // Close all tags after the first font tag.</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+      output += closeStack(stack.slice(offset));</span>
<a href="#l22.183"></a><span id="l22.183" class="difflineplus">+      // Remove the font tags from the stack.</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineplus">+      stack = stack.filter(function(aTag) aTag.indexOf(&quot;font&quot;));</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+      // Reopen the other tags.</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineplus">+      stack.slice(offset)</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+           .forEach(function(aTag) output += &quot;&lt;&quot; + aTag + &quot;&gt;&quot;);</span>
<a href="#l22.188"></a><span id="l22.188" class="difflineplus">+    }</span>
<a href="#l22.189"></a><span id="l22.189" class="difflineplus">+    else {</span>
<a href="#l22.190"></a><span id="l22.190" class="difflineplus">+      // The foreground color.</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineplus">+      let color = getColor(matches[1]);</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+      if (color)</span>
<a href="#l22.193"></a><span id="l22.193" class="difflineplus">+        format.push(&quot;color=\&quot;&quot; + color + &quot;\&quot;&quot;);</span>
<a href="#l22.194"></a><span id="l22.194" class="difflineplus">+</span>
<a href="#l22.195"></a><span id="l22.195" class="difflineplus">+      // The background color.</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineplus">+      if (matches[2]) {</span>
<a href="#l22.197"></a><span id="l22.197" class="difflineplus">+        let color = getColor(matches[2]);</span>
<a href="#l22.198"></a><span id="l22.198" class="difflineplus">+        if (color)</span>
<a href="#l22.199"></a><span id="l22.199" class="difflineplus">+          format.push(&quot;background=\&quot;&quot; + color + &quot;\&quot;&quot;);</span>
<a href="#l22.200"></a><span id="l22.200" class="difflineplus">+      }</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineplus">+</span>
<a href="#l22.202"></a><span id="l22.202" class="difflineplus">+      if (format.length &gt; 1) {</span>
<a href="#l22.203"></a><span id="l22.203" class="difflineplus">+        output += &quot;&lt;&quot; + format.join(&quot; &quot;) + &quot;&gt;&quot;;</span>
<a href="#l22.204"></a><span id="l22.204" class="difflineplus">+        stack.push(format.join(&quot; &quot;));</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineplus">+        length = matches[0].length;</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+      }</span>
<a href="#l22.207"></a><span id="l22.207" class="difflineplus">+    }</span>
<a href="#l22.208"></a><span id="l22.208" class="difflineplus">+  }</span>
<a href="#l22.209"></a><span id="l22.209" class="difflineplus">+</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineplus">+  return [stack, output, length];</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/chat/protocols/irc/jar.mn</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,5 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+chat.jar:</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+% skin prpl-irc classic/1.0 %skin/classic/prpl/irc/</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+	skin/classic/prpl/irc/icon32.png	(icons/prpl-irc-32.png)</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+	skin/classic/prpl/irc/icon48.png	(icons/prpl-irc-48.png)</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+	skin/classic/prpl/irc/icon.png	(icons/prpl-irc.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpColoring.js</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,70 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+Components.utils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+const input = [</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+  // From http://www.mirc.com/colors.html</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  &quot;\x035,12colored text and background\x03&quot;,</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  &quot;\x035colored text\x03&quot;,</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+  &quot;\x033colored text \x035,2more colored text and background\x03&quot;,</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+  &quot;\x033,5colored text and background \x038other colored text but same background\x03&quot;,</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+  &quot;\x033,5colored text and background \x038,7other colored text and different background\x03&quot;,</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+  // Based on above, but more complicated.</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+  &quot;\x02\x035,12colored \x1Ftext and background\x03. You sure about this?&quot;,</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineplus">+</span>
<a href="#l24.21"></a><span id="l24.21" class="difflineplus">+  // Implied by above.</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineplus">+  &quot;So a \x03,8 attribute is not valid and thus ignored.&quot;,</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineplus">+</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineplus">+  // Try some of the above with two digits.</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+  &quot;\x0303,5colored text and background \x0308other colored text but same background\x03&quot;,</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineplus">+  &quot;\x0303,05colored text and background \x038,7other colored text and different background\x03&quot;,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineplus">+];</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+function run_test() {</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+  add_test(test_mIRCColoring);</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+  //add_test(test_ctcpFormatToText);</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+  run_next_test();</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+}</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+</span>
<a href="#l24.36"></a><span id="l24.36" class="difflineplus">+function test_mIRCColoring() {</span>
<a href="#l24.37"></a><span id="l24.37" class="difflineplus">+  let expectedOutput = [</span>
<a href="#l24.38"></a><span id="l24.38" class="difflineplus">+    &quot;&lt;font color=\&quot;maroon\&quot; background=\&quot;blue\&quot;&gt;colored text and background&lt;/font&gt;&quot;,</span>
<a href="#l24.39"></a><span id="l24.39" class="difflineplus">+    &quot;&lt;font color=\&quot;maroon\&quot;&gt;colored text&lt;/font&gt;&quot;,</span>
<a href="#l24.40"></a><span id="l24.40" class="difflineplus">+    &quot;&lt;font color=\&quot;green\&quot;&gt;colored text &lt;font color=\&quot;maroon\&quot; background=\&quot;navy\&quot;&gt;more colored text and background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l24.41"></a><span id="l24.41" class="difflineplus">+    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l24.42"></a><span id="l24.42" class="difflineplus">+    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot; background=\&quot;orange\&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l24.43"></a><span id="l24.43" class="difflineplus">+    &quot;&lt;b&gt;&lt;font color=\&quot;maroon\&quot; background=\&quot;blue\&quot;&gt;colored &lt;u&gt;text and background&lt;/u&gt;&lt;/font&gt;&lt;u&gt;. You sure about this?&lt;/u&gt;&lt;/b&gt;&quot;,</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineplus">+    &quot;So a ,8 attribute is not valid and thus ignored.&quot;,</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineplus">+    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot;&gt;other colored text but same background&lt;/font&gt;&lt;/font&gt;&quot;,</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineplus">+    &quot;&lt;font color=\&quot;green\&quot; background=\&quot;maroon\&quot;&gt;colored text and background &lt;font color=\&quot;yellow\&quot; background=\&quot;orange\&quot;&gt;other colored text and different background&lt;/font&gt;&lt;/font&gt;&quot;</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineplus">+  ];</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineplus">+</span>
<a href="#l24.49"></a><span id="l24.49" class="difflineplus">+  let output = input.map(ctcpFormatToHTML);</span>
<a href="#l24.50"></a><span id="l24.50" class="difflineplus">+  for (let i = 0; i &lt; output.length; i++)</span>
<a href="#l24.51"></a><span id="l24.51" class="difflineplus">+    do_check_eq(expectedOutput[i], output[i]);</span>
<a href="#l24.52"></a><span id="l24.52" class="difflineplus">+</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineplus">+  run_next_test();</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+}</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+function test_ctcpFormatToText() {</span>
<a href="#l24.57"></a><span id="l24.57" class="difflineplus">+  let expectedOutput = &quot;The quick brown fox jumps over the lazy dog.&quot;;</span>
<a href="#l24.58"></a><span id="l24.58" class="difflineplus">+</span>
<a href="#l24.59"></a><span id="l24.59" class="difflineplus">+  let output = input.map(ctcpFormatToText);</span>
<a href="#l24.60"></a><span id="l24.60" class="difflineplus">+  for (let i = 0; i &lt; output.length; i++)</span>
<a href="#l24.61"></a><span id="l24.61" class="difflineplus">+    do_check_eq(expectedOutput, output[i]);</span>
<a href="#l24.62"></a><span id="l24.62" class="difflineplus">+</span>
<a href="#l24.63"></a><span id="l24.63" class="difflineplus">+  run_next_test();</span>
<a href="#l24.64"></a><span id="l24.64" class="difflineplus">+}</span>
<a href="#l24.65"></a><span id="l24.65" class="difflineplus">+</span>
<a href="#l24.66"></a><span id="l24.66" class="difflineplus">+function test_mIRCColor() {</span>
<a href="#l24.67"></a><span id="l24.67" class="difflineplus">+  let expectedOutput = &quot;The quick brown fox jumps over the lazy dog.&quot;;</span>
<a href="#l24.68"></a><span id="l24.68" class="difflineplus">+</span>
<a href="#l24.69"></a><span id="l24.69" class="difflineplus">+  let output = input.map(ctcpFormatToText);</span>
<a href="#l24.70"></a><span id="l24.70" class="difflineplus">+  for (let i = 0; i &lt; output.length; i++)</span>
<a href="#l24.71"></a><span id="l24.71" class="difflineplus">+    do_check_eq(expectedOutput, output[i]);</span>
<a href="#l24.72"></a><span id="l24.72" class="difflineplus">+</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineplus">+  run_next_test();</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/chat/protocols/irc/test/test_ctcpFormatting.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,57 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* Any copyright is dedicated to the Public Domain.</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+ * http://creativecommons.org/publicdomain/zero/1.0/ */</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+Components.utils.import(&quot;resource:///modules/ircUtils.jsm&quot;);</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+//TODO add a test for special JS characters (|, etc...)</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+const input = [</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+  &quot;The quick brown fox \x02jumps\x02 over the lazy dog.&quot;,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+  &quot;The quick brown fox \x02jumps\x0F over the lazy dog.&quot;,</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+  &quot;The quick brown \x16fox jumps\x16 over the lazy dog.&quot;,</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+  &quot;The quick brown \x16fox jumps\x0F over the lazy dog.&quot;,</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+  &quot;The quick \x1Fbrown fox jumps over the lazy\x1F dog.&quot;,</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+  &quot;The quick \x1Fbrown fox jumps over the lazy\x0F dog.&quot;,</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+  &quot;The quick \x1Fbrown fox \x02jumps over the lazy\x1F dog.&quot;,</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+  &quot;The quick \x1Fbrown fox \x02jumps\x1F over the lazy\x02 dog.&quot;,</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+  &quot;The quick \x1Fbrown \x16fox \x02jumps\x1F over\x16 the lazy\x02 dog.&quot;,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+  &quot;The quick \x1Fbrown \x16fox \x02jumps\x0F over \x16the lazy \x02dog.&quot;</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+];</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+function run_test() {</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+  add_test(test_ctcpFormatToHTML);</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+  add_test(test_ctcpFormatToText);</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  run_next_test();</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+}</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+function test_ctcpFormatToHTML() {</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+  let expectedOutput = [</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+    &quot;The quick brown fox &lt;b&gt;jumps&lt;/b&gt; over the lazy dog.&quot;,</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+    &quot;The quick brown fox &lt;b&gt;jumps&lt;/b&gt; over the lazy dog.&quot;,</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+    &quot;The quick brown &lt;i&gt;fox jumps&lt;/i&gt; over the lazy dog.&quot;,</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+    &quot;The quick brown &lt;i&gt;fox jumps&lt;/i&gt; over the lazy dog.&quot;,</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    &quot;The quick &lt;u&gt;brown fox jumps over the lazy&lt;/u&gt; dog.&quot;,</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+    &quot;The quick &lt;u&gt;brown fox jumps over the lazy&lt;/u&gt; dog.&quot;,</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+    &quot;The quick &lt;u&gt;brown fox &lt;b&gt;jumps over the lazy&lt;/b&gt;&lt;/u&gt;&lt;b&gt; dog.&lt;/b&gt;&quot;,</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+    &quot;The quick &lt;u&gt;brown fox &lt;b&gt;jumps&lt;/b&gt;&lt;/u&gt;&lt;b&gt; over the lazy&lt;/b&gt; dog.&quot;,</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+    &quot;The quick &lt;u&gt;brown &lt;i&gt;fox &lt;b&gt;jumps&lt;/b&gt;&lt;/i&gt;&lt;/u&gt;&lt;i&gt;&lt;b&gt; over&lt;/b&gt;&lt;/i&gt;&lt;b&gt; the lazy&lt;/b&gt; dog.&quot;,</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+    &quot;The quick &lt;u&gt;brown &lt;i&gt;fox &lt;b&gt;jumps&lt;/b&gt;&lt;/i&gt;&lt;/u&gt; over &lt;i&gt;the lazy &lt;b&gt;dog.&lt;/b&gt;&lt;/i&gt;&quot;</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  ];</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+  let output = input.map(ctcpFormatToHTML);</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+  for (let i = 0; i &lt; output.length; i++)</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+    do_check_eq(expectedOutput[i], output[i]);</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+  run_next_test();</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+}</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+function test_ctcpFormatToText() {</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+  let expectedOutput = &quot;The quick brown fox jumps over the lazy dog.&quot;;</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  let output = input.map(ctcpFormatToText);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+  for (let i = 0; i &lt; output.length; i++)</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+    do_check_eq(expectedOutput, output[i]);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+  run_next_test();</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/chat/protocols/irc/test/xpcshell.ini</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,6 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+head =</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+tail =</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+[test_ctcpFormatting.js]</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+[test_ctcpColoring.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/im/app/profile/all-instantbird.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/im/app/profile/all-instantbird.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -282,8 +282,10 @@ pref(&quot;browser.tabs.tabMaxWidth&quot;, 250);</span>
<a href="#l27.4"></a><span id="l27.4"> pref(&quot;browser.tabs.tabClipWidth&quot;, 140);</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> // Where to show tab close buttons:</span>
<a href="#l27.7"></a><span id="l27.7"> // 0  on active tab only</span>
<a href="#l27.8"></a><span id="l27.8"> // 1  on all tabs until tabClipWidth is reached, then active tab only</span>
<a href="#l27.9"></a><span id="l27.9"> // 2  no close buttons at all</span>
<a href="#l27.10"></a><span id="l27.10"> // 3  at the end of the tabstrip</span>
<a href="#l27.11"></a><span id="l27.11"> pref(&quot;browser.tabs.closeButtons&quot;, 1);</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+pref(&quot;chat.irc.defaultQuitMessage&quot;, &quot;Instantbird -- http://www.instantbird.com&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/im/content/conversation.xml</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/im/content/conversation.xml</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -287,21 +287,17 @@</span>
<a href="#l28.4"></a><span id="l28.4">           }</span>
<a href="#l28.5"></a><span id="l28.5">         }</span>
<a href="#l28.6"></a><span id="l28.6"> </span>
<a href="#l28.7"></a><span id="l28.7">         let msg = Components.classes[&quot;@mozilla.org/txttohtmlconv;1&quot;]</span>
<a href="#l28.8"></a><span id="l28.8">                             .getService(Ci.mozITXTToHTMLConv)</span>
<a href="#l28.9"></a><span id="l28.9">                             .scanTXT(aMsg, 0);</span>
<a href="#l28.10"></a><span id="l28.10"> </span>
<a href="#l28.11"></a><span id="l28.11">         var account = this._conv.account;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-        if (account.noNewlines)</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-          // 'Illegal operation on WrappedNative prototype object' if the this</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineminus">-          // object is not specified (since nsIClassInfo was added to this._conv)</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineminus">-          msg.split(&quot;\n&quot;).forEach(this._conv.sendMsg, this._conv);</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineminus">-        else if (account.HTMLEnabled) {</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+        if (account.HTMLEnabled) {</span>
<a href="#l28.18"></a><span id="l28.18">           msg = msg.replace(/\n/g, &quot;&lt;br/&gt;&quot;);</span>
<a href="#l28.19"></a><span id="l28.19">           if (Services.prefs.getBoolPref(&quot;messenger.conversations.sendFormat&quot;)) {</span>
<a href="#l28.20"></a><span id="l28.20">             let style = MessageFormat.getMessageStyle();</span>
<a href="#l28.21"></a><span id="l28.21">             let proto = this._conv.account.protocol.id;</span>
<a href="#l28.22"></a><span id="l28.22">             if (proto == &quot;prpl-msn&quot;) {</span>
<a href="#l28.23"></a><span id="l28.23">               if (&quot;color&quot; in style)</span>
<a href="#l28.24"></a><span id="l28.24">                 msg = &quot;&lt;font color=\&quot;&quot; + style.color + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/font&gt;&quot;;</span>
<a href="#l28.25"></a><span id="l28.25">               if (&quot;fontFamily&quot; in style)</span>
<a href="#l28.26"></a><span id="l28.26" class="difflineat">@@ -347,18 +343,27 @@</span>
<a href="#l28.27"></a><span id="l28.27">                 styleProperties.push(&quot;font-size: &quot; + style.fontSize + &quot;px&quot;);</span>
<a href="#l28.28"></a><span id="l28.28">               style = styleProperties.join(&quot;; &quot;);</span>
<a href="#l28.29"></a><span id="l28.29">               if (style)</span>
<a href="#l28.30"></a><span id="l28.30">                 msg = &quot;&lt;span style=\&quot;&quot; + style + &quot;\&quot;&gt;&quot; + msg + &quot;&lt;/span&gt;&quot;;</span>
<a href="#l28.31"></a><span id="l28.31">             }</span>
<a href="#l28.32"></a><span id="l28.32">           }</span>
<a href="#l28.33"></a><span id="l28.33">           this._conv.sendMsg(msg);</span>
<a href="#l28.34"></a><span id="l28.34">         }</span>
<a href="#l28.35"></a><span id="l28.35" class="difflineminus">-        else</span>
<a href="#l28.36"></a><span id="l28.36" class="difflineminus">-          this._conv.sendMsg(account.HTMLEscapePlainText ? msg : aMsg);</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineplus">+        else {</span>
<a href="#l28.38"></a><span id="l28.38" class="difflineplus">+          msg = account.HTMLEscapePlainText ? msg : aMsg;</span>
<a href="#l28.39"></a><span id="l28.39" class="difflineplus">+</span>
<a href="#l28.40"></a><span id="l28.40" class="difflineplus">+          if (account.noNewlines) {</span>
<a href="#l28.41"></a><span id="l28.41" class="difflineplus">+            // 'Illegal operation on WrappedNative prototype object' if the this</span>
<a href="#l28.42"></a><span id="l28.42" class="difflineplus">+            // object is not specified (since this._conv implements nsIClassInfo)</span>
<a href="#l28.43"></a><span id="l28.43" class="difflineplus">+            msg.split(&quot;\n&quot;).forEach(this._conv.sendMsg, this._conv);</span>
<a href="#l28.44"></a><span id="l28.44" class="difflineplus">+          }</span>
<a href="#l28.45"></a><span id="l28.45" class="difflineplus">+          else</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineplus">+            this._conv.sendMsg(msg);</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineplus">+        }</span>
<a href="#l28.48"></a><span id="l28.48">         // reset the textbox to its original size</span>
<a href="#l28.49"></a><span id="l28.49">         this.resetInput();</span>
<a href="#l28.50"></a><span id="l28.50">       ]]&gt;</span>
<a href="#l28.51"></a><span id="l28.51">       &lt;/body&gt;</span>
<a href="#l28.52"></a><span id="l28.52">      &lt;/method&gt;</span>
<a href="#l28.53"></a><span id="l28.53"> </span>
<a href="#l28.54"></a><span id="l28.54">      &lt;method name=&quot;_onSplitterChange&quot;&gt;</span>
<a href="#l28.55"></a><span id="l28.55">       &lt;parameter name=&quot;aEvent&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/im/installer/package-manifest.in</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/im/installer/package-manifest.in</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -427,16 +427,18 @@</span>
<a href="#l29.4"></a><span id="l29.4"> @BINPATH@/components/profileMigrator.manifest</span>
<a href="#l29.5"></a><span id="l29.5"> #endif</span>
<a href="#l29.6"></a><span id="l29.6"> @BINPATH@/components/contentHandler.js</span>
<a href="#l29.7"></a><span id="l29.7"> @BINPATH@/components/contentHandler.manifest</span>
<a href="#l29.8"></a><span id="l29.8"> @BINPATH@/components/ibCommandLineHandler.js</span>
<a href="#l29.9"></a><span id="l29.9"> @BINPATH@/components/ibCommandLineHandler.manifest</span>
<a href="#l29.10"></a><span id="l29.10"> @BINPATH@/components/ibStatusCommandLineHandler.js</span>
<a href="#l29.11"></a><span id="l29.11"> @BINPATH@/components/ibStatusCommandLineHandler.manifest</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+@BINPATH@/components/irc.js</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineplus">+@BINPATH@/components/irc.manifest</span>
<a href="#l29.14"></a><span id="l29.14"> @BINPATH@/components/facebook.js</span>
<a href="#l29.15"></a><span id="l29.15"> @BINPATH@/components/facebook.manifest</span>
<a href="#l29.16"></a><span id="l29.16"> @BINPATH@/components/gtalk.js</span>
<a href="#l29.17"></a><span id="l29.17"> @BINPATH@/components/gtalk.manifest</span>
<a href="#l29.18"></a><span id="l29.18"> @BINPATH@/components/twitter.js</span>
<a href="#l29.19"></a><span id="l29.19"> @BINPATH@/components/twitter.manifest</span>
<a href="#l29.20"></a><span id="l29.20"> @BINPATH@/components/xmpp.js</span>
<a href="#l29.21"></a><span id="l29.21"> @BINPATH@/components/xmpp.manifest</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineat">@@ -455,17 +457,17 @@</span>
<a href="#l29.23"></a><span id="l29.23"> @BINPATH@/@PREF_DIR@/services-sync.js</span>
<a href="#l29.24"></a><span id="l29.24"> #endif</span>
<a href="#l29.25"></a><span id="l29.25"> @BINPATH@/greprefs.js</span>
<a href="#l29.26"></a><span id="l29.26"> @BINPATH@/defaults/autoconfig/platform.js</span>
<a href="#l29.27"></a><span id="l29.27"> @BINPATH@/defaults/autoconfig/prefcalls.js</span>
<a href="#l29.28"></a><span id="l29.28"> @BINPATH@/defaults/profile/prefs.js</span>
<a href="#l29.29"></a><span id="l29.29"> </span>
<a href="#l29.30"></a><span id="l29.30"> ; [Layout Engine Resources]</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineminus">-; Style Sheets, Graphics and other Resources used by the layout engine. </span>
<a href="#l29.32"></a><span id="l29.32" class="difflineplus">+; Style Sheets, Graphics and other Resources used by the layout engine.</span>
<a href="#l29.33"></a><span id="l29.33"> @BINPATH@/res/EditorOverride.css</span>
<a href="#l29.34"></a><span id="l29.34"> @BINPATH@/res/contenteditable.css</span>
<a href="#l29.35"></a><span id="l29.35"> @BINPATH@/res/designmode.css</span>
<a href="#l29.36"></a><span id="l29.36"> @BINPATH@/res/table-add-column-after-active.gif</span>
<a href="#l29.37"></a><span id="l29.37"> @BINPATH@/res/table-add-column-after-hover.gif</span>
<a href="#l29.38"></a><span id="l29.38"> @BINPATH@/res/table-add-column-after.gif</span>
<a href="#l29.39"></a><span id="l29.39"> @BINPATH@/res/table-add-column-before-active.gif</span>
<a href="#l29.40"></a><span id="l29.40"> @BINPATH@/res/table-add-column-before-hover.gif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/im/test/xpcshell.ini</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/im/test/xpcshell.ini</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,1 +1,2 @@</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineplus">+[include:chat/protocols/irc/test/xpcshell.ini]</span>
<a href="#l30.5"></a><span id="l30.5"> [include:purple/purplexpcom/src/test/xpcshell.ini]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

